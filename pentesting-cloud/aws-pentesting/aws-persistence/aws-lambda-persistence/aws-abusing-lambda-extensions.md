# AWS - Abusing Lambda Extensions

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Lambda Extensions

Οι επεκτάσεις Lambda ενισχύουν τις λειτουργίες ενσωματώνοντας διάφορα **εργαλεία παρακολούθησης, παρατηρησιμότητας, ασφάλειας και διακυβέρνησης**. Αυτές οι επεκτάσεις, που προστίθενται μέσω [.zip αρχείων χρησιμοποιώντας Lambda layers](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ή περιλαμβάνονται σε [αναπτύξεις εικόνων container](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), λειτουργούν σε δύο τρόπους: **εσωτερικό** και **εξωτερικό**.

* **Εσωτερικές επεκτάσεις** συγχωνεύονται με τη διαδικασία εκτέλεσης, χειραγωγώντας την εκκίνηση της χρησιμοποιώντας **μεταβλητές περιβάλλοντος συγκεκριμένες για τη γλώσσα** και **σενάρια περιτυλίγματος**. Αυτή η προσαρμογή εφαρμόζεται σε μια σειρά από εκτελέσεις, συμπεριλαμβανομένων των **Java Correto 8 και 11, Node.js 10 και 12, και .NET Core 3.1**.
* **Εξωτερικές επεκτάσεις** λειτουργούν ως ξεχωριστές διαδικασίες, διατηρώντας την ευθυγράμμιση λειτουργίας με τον κύκλο ζωής της λειτουργίας Lambda. Είναι συμβατές με διάφορες εκτελέσεις όπως **Node.js 10 και 12, Python 3.7 και 3.8, Ruby 2.5 και 2.7, Java Corretto 8 και 11, .NET Core 3.1**, και **προσαρμοσμένες εκτελέσεις**.

Για περισσότερες πληροφορίες σχετικά με [**πώς λειτουργούν οι επεκτάσεις lambda ελέγξτε τα docs**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Εξωτερική Επέκταση για Εμμονή, Κλοπή Αιτημάτων & Τροποποίηση Αιτημάτων

Αυτό είναι μια σύνοψη της τεχνικής που προτείνεται σε αυτήν την ανάρτηση: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Διαπιστώθηκε ότι ο προεπιλεγμένος πυρήνας Linux στο περιβάλλον εκτέλεσης Lambda είναι μεταγλωττισμένος με τις κλήσεις συστήματος “**process\_vm\_readv**” και “**process\_vm\_writev**”. Και όλες οι διαδικασίες εκτελούνται με το ίδιο αναγνωριστικό χρήστη, ακόμη και η νέα διαδικασία που δημιουργείται για την εξωτερική επέκταση. **Αυτό σημαίνει ότι μια εξωτερική επέκταση έχει πλήρη πρόσβαση ανάγνωσης και εγγραφής στη μνήμη heap του Rapid, από σχεδιασμό.**

Επιπλέον, ενώ οι επεκτάσεις Lambda έχουν τη δυνατότητα να **εγγραφούν σε συμβάντα κλήσης**, η AWS δεν αποκαλύπτει τα ακατέργαστα δεδομένα σε αυτές τις επεκτάσεις. Αυτό διασφαλίζει ότι **οι επεκτάσεις δεν μπορούν να έχουν πρόσβαση σε ευαίσθητες πληροφορίες** που μεταδίδονται μέσω του αιτήματος HTTP.

Η διαδικασία Init (Rapid) παρακολουθεί όλα τα αιτήματα API στο [http://127.0.0.1:9001](http://127.0.0.1:9001/) ενώ οι επεκτάσεις Lambda αρχικοποιούνται και εκτελούνται πριν από την εκτέλεση οποιουδήποτε κώδικα εκτέλεσης, αλλά μετά το Rapid.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

Η μεταβλητή **`AWS_LAMBDA_RUNTIME_API`** υποδεικνύει τη **διεύθυνση IP** και τον **αριθμό θύρας** του Rapid API στις **παιδικές διαδικασίες εκτέλεσης** και πρόσθετες επεκτάσεις.

{% hint style="warning" %}
Αλλάζοντας τη μεταβλητή περιβάλλοντος **`AWS_LAMBDA_RUNTIME_API`** σε μια **`θύρα`** στην οποία έχουμε πρόσβαση, είναι δυνατό να αναχαιτίσουμε όλες τις ενέργειες εντός του περιβάλλοντος εκτέλεσης Lambda (**man-in-the-middle**). Αυτό είναι δυνατό επειδή η επέκταση εκτελείται με τα ίδια προνόμια με το Rapid Init, και ο πυρήνας του συστήματος επιτρέπει την **τροποποίηση της μνήμης της διαδικασίας**, επιτρέποντας την αλλαγή του αριθμού θύρας.
{% endhint %}

Επειδή **οι επεκτάσεις εκτελούνται πριν από οποιονδήποτε κώδικα εκτέλεσης**, η τροποποίηση της μεταβλητής περιβάλλοντος θα επηρεάσει τη διαδικασία εκτέλεσης (π.χ., Python, Java, Node, Ruby) καθώς ξεκινά. Επιπλέον, **οι επεκτάσεις που φορτώνονται μετά** τη δική μας, οι οποίες βασίζονται σε αυτήν τη μεταβλητή, θα δρομολογηθούν επίσης μέσω της επέκτασής μας. Αυτή η ρύθμιση θα μπορούσε να επιτρέψει στο κακόβουλο λογισμικό να παρακάμψει εντελώς τα μέτρα ασφαλείας ή τις επεκτάσεις καταγραφής απευθείας στο περιβάλλον εκτέλεσης.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

Το εργαλείο [**lambda-spy**](https://github.com/clearvector/lambda-spy) δημιουργήθηκε για να εκτελεί αυτήν την **εγγραφή μνήμης** και να **κλέβει ευαίσθητες πληροφορίες** από αιτήματα lambda, άλλες **επεκτάσεις** **αιτήματα** και ακόμη και **να τα τροποποιεί**.

## Αναφορές

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
