# AWS - Abusing Lambda Extensions

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Lambda Extensions

Lambda extensionsは、さまざまな**監視、可観測性、セキュリティ、およびガバナンスツール**と統合することで関数を強化します。これらの拡張機能は、[.zipアーカイブを使用してLambdaレイヤーに追加](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)するか、[コンテナイメージのデプロイに含める](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)ことで追加され、**内部**および**外部**の2つのモードで動作します。

* **内部拡張機能**は、**言語固有の環境変数**および**ラッパースクリプト**を使用して起動を操作し、ランタイムプロセスと統合します。このカスタマイズは、**Java Correto 8および11、Node.js 10および12、.NET Core 3.1**などのさまざまなランタイムに適用されます。
* **外部拡張機能**は、別個のプロセスとして実行され、Lambda関数のライフサイクルと整合性を保ちながら動作します。これらは、**Node.js 10および12、Python 3.7および3.8、Ruby 2.5および2.7、Java Corretto 8および11、.NET Core 3.1**、および**カスタムランタイム**などのさまざまなランタイムと互換性があります。

[**lambda拡張機能の動作についての詳細はこちらのドキュメントを参照してください**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html)。

### External Extension for Persistence, Stealing Requests & modifying Requests

これは、この投稿で提案された技術の概要です: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Lambdaランタイム環境のデフォルトのLinuxカーネルは、「**process\_vm\_readv**」および「**process\_vm\_writev**」システムコールでコンパイルされていることが判明しました。そして、すべてのプロセスは同じユーザーIDで実行され、外部拡張機能のために作成された新しいプロセスも同様です。**これは、外部拡張機能が設計上、Rapidのヒープメモリに完全な読み取りおよび書き込みアクセス権を持つことを意味します。**

さらに、Lambda拡張機能は**呼び出しイベントにサブスクライブする**機能を持っていますが、AWSはこれらの拡張機能に生データを公開しません。これにより、**拡張機能がHTTPリクエストを介して送信される機密情報にアクセスできない**ようにしています。

Init (Rapid)プロセスは、[http://127.0.0.1:9001](http://127.0.0.1:9001/)でのすべてのAPIリクエストを監視し、Lambda拡張機能は、ランタイムコードの実行前に初期化および実行されますが、Rapidの後に行われます。

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

変数**`AWS_LAMBDA_RUNTIME_API`**は、**子ランタイムプロセス**および追加の拡張機能に対してRapid APIの**IP**アドレスと**ポート**番号を示します。

{% hint style="warning" %}
**`AWS_LAMBDA_RUNTIME_API`**環境変数をアクセス可能な**`port`**に変更することで、Lambdaランタイム内のすべてのアクションをインターセプトすることが可能です（**man-in-the-middle**）。これは、拡張機能がRapid Initと同じ権限で実行され、システムのカーネルが**プロセスメモリの変更**を許可しているため、ポート番号の変更が可能になるためです。
{% endhint %}

**拡張機能はランタイムコードの前に実行される**ため、環境変数を変更すると、ランタイムプロセス（例：Python、Java、Node、Ruby）の起動時に影響を与えます。さらに、**私たちの拡張機能の後に読み込まれる拡張機能**もこの変数に依存しているため、私たちの拡張機能を経由してルーティングされます。このセットアップにより、マルウェアがランタイム環境内でセキュリティ対策やログ拡張機能を完全に回避することが可能になります。

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

ツール[**lambda-spy**](https://github.com/clearvector/lambda-spy)は、その**メモリ書き込み**を実行し、lambdaリクエスト、他の**拡張機能**の**リクエスト**から機密情報を**盗み**、さらには**それらを変更**するために作成されました。

## References

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
