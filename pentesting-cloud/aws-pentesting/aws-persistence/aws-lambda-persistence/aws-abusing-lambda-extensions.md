# AWS - Abusing Lambda Extensions

{% hint style="success" %}
学习和实践 AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和实践 GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交 PRs 分享黑客技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库。

</details>
{% endhint %}

## Lambda Extensions

Lambda extensions 通过集成各种 **监控、可观察性、安全和治理工具** 来增强功能。这些扩展通过 [.zip archives using Lambda layers](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) 或包含在 [container image deployments](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/) 中添加，运行在两种模式下：**internal** 和 **external**。

* **Internal extensions** 与运行时进程合并，使用 **language-specific environment variables** 和 **wrapper scripts** 操作其启动。这种自定义适用于多种运行时，包括 **Java Correto 8 和 11, Node.js 10 和 12, 以及 .NET Core 3.1**。
* **External extensions** 作为独立进程运行，与 Lambda 函数的生命周期保持操作一致。它们兼容多种运行时，如 **Node.js 10 和 12, Python 3.7 和 3.8, Ruby 2.5 和 2.7, Java Corretto 8 和 11, .NET Core 3.1**，以及 **custom runtimes**。

更多关于 [**lambda extensions 工作原理的文档**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html)。

### External Extension for Persistence, Stealing Requests & modifying Requests

这是该文章中提出的技术摘要：[https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

发现 Lambda 运行时环境中的默认 Linux 内核是用 “**process\_vm\_readv**” 和 “**process\_vm\_writev**” 系统调用编译的。所有进程都以相同的用户 ID 运行，即使是为 external extension 创建的新进程也是如此。**这意味着 external extension 设计上对 Rapid 的堆内存具有完全的读写访问权限。**

此外，虽然 Lambda extensions 具有 **订阅调用事件** 的能力，但 AWS 不会向这些 extensions 透露原始数据。这确保了 **extensions 无法访问通过 HTTP 请求传输的敏感信息**。

Init (Rapid) 进程在 [http://127.0.0.1:9001](http://127.0.0.1:9001/) 监控所有 API 请求，而 Lambda extensions 在执行任何运行时代码之前初始化并运行，但在 Rapid 之后。

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

变量 **`AWS_LAMBDA_RUNTIME_API`** 指示 **IP** 地址和 **port** 号给 **child runtime processes** 和其他 extensions。

{% hint style="warning" %}
通过将 **`AWS_LAMBDA_RUNTIME_API`** 环境变量更改为我们有访问权限的 **`port`**，可以拦截 Lambda 运行时中的所有操作（**man-in-the-middle**）。这是可能的，因为 extension 以与 Rapid Init 相同的权限运行，并且系统的内核允许 **修改进程内存**，从而可以更改端口号。
{% endhint %}

因为 **extensions 在任何运行时代码之前运行**，修改环境变量将影响运行时进程（例如 Python, Java, Node, Ruby）在启动时。此外，**在我们之后加载的 extensions**，依赖于此变量的，也将通过我们的 extension 路由。此设置可能使恶意软件能够完全绕过安全措施或直接在运行时环境中记录扩展。

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

工具 [**lambda-spy**](https://github.com/clearvector/lambda-spy) 被创建来执行 **内存写入** 并 **窃取 lambda 请求中的敏感信息**，其他 **extensions 请求** 甚至 **修改它们**。

## 参考资料

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

{% hint style="success" %}
学习和实践 AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和实践 GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交 PRs 分享黑客技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库。

</details>
{% endhint %}
