# AWS - Abusing Lambda Extensions

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Lambda Extensions

Lambda ekstenzije poboljšavaju funkcije integracijom sa raznim **alatima za monitoring, observabilnost, sigurnost i upravljanje**. Ove ekstenzije, dodate putem [.zip arhiva koristeći Lambda slojeve](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ili uključene u [container image deployments](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), rade u dva režima: **interni** i **eksterni**.

* **Interni ekstenzije** se spajaju sa runtime procesom, manipulišući njegovim pokretanjem koristeći **jezičke specifične promenljive okruženja** i **wrapper skripte**. Ova prilagođavanja se primenjuju na različite runtime-ove, uključujući **Java Correto 8 i 11, Node.js 10 i 12, i .NET Core 3.1**.
* **Eksterni ekstenzije** rade kao zasebni procesi, održavajući operativnu usklađenost sa životnim ciklusom Lambda funkcije. Kompatibilni su sa raznim runtime-ovima kao što su **Node.js 10 i 12, Python 3.7 i 3.8, Ruby 2.5 i 2.7, Java Corretto 8 i 11, .NET Core 3.1**, i **custom runtimes**.

Za više informacija o [**kako lambda ekstenzije rade, pogledajte dokumentaciju**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Eksterni Ekstenzija za Persistenciju, Krađu Zahteva i Modifikaciju Zahteva

Ovo je sažetak tehnike predložene u ovom postu: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Otkriveno je da je podrazumevani Linux kernel u Lambda runtime okruženju kompajliran sa “**process\_vm\_readv**” i “**process\_vm\_writev**” sistemskim pozivima. I svi procesi rade sa istim korisničkim ID-om, čak i novi proces kreiran za eksterni ekstenziju. **Ovo znači da eksterni ekstenzija ima pun pristup za čitanje i pisanje Rapid-ove heap memorije, po dizajnu.**

Štaviše, dok Lambda ekstenzije imaju mogućnost da se **pretplate na događaje poziva**, AWS ne otkriva sirove podatke ovim ekstenzijama. Ovo osigurava da **ekstenzije ne mogu pristupiti osetljivim informacijama** prenetim putem HTTP zahteva.

Init (Rapid) proces prati sve API zahteve na [http://127.0.0.1:9001](http://127.0.0.1:9001/) dok se Lambda ekstenzije inicijalizuju i rade pre izvršenja bilo kog runtime koda, ali nakon Rapid-a.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

Promenljiva **`AWS_LAMBDA_RUNTIME_API`** označava **IP** adresu i **port** broj Rapid API-ja za **child runtime procese** i dodatne ekstenzije.

{% hint style="warning" %}
Promenom **`AWS_LAMBDA_RUNTIME_API`** promenljive okruženja na **`port`** kojem imamo pristup, moguće je presresti sve akcije unutar Lambda runtime-a (**man-in-the-middle**). Ovo je moguće jer ekstenzija radi sa istim privilegijama kao Rapid Init, a kernel sistema omogućava **modifikaciju memorije procesa**, omogućavajući promenu broja porta.
{% endhint %}

Pošto **ekstenzije rade pre bilo kog runtime koda**, modifikacija promenljive okruženja će uticati na runtime proces (npr. Python, Java, Node, Ruby) dok se pokreće. Štaviše, **ekstenzije učitane nakon** naše, koje se oslanjaju na ovu promenljivu, takođe će se usmeravati kroz našu ekstenziju. Ova postavka bi mogla omogućiti malveru da potpuno zaobiđe sigurnosne mere ili ekstenzije za logovanje direktno unutar runtime okruženja.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

Alat [**lambda-spy**](https://github.com/clearvector/lambda-spy) je kreiran da izvrši tu **memorijsku pisanje** i **ukrade osetljive informacije** iz lambda zahteva, drugih **ekstenzija** **zahteva** i čak **modifikuje ih**.

## Reference

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
