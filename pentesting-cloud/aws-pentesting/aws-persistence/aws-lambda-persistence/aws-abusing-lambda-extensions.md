# AWS - Abusing Lambda Extensions

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## Lambda Extensions

Les extensions Lambda am√©liorent les fonctions en s'int√©grant √† divers outils de **surveillance, observabilit√©, s√©curit√© et gouvernance**. Ces extensions, ajout√©es via des [.zip archives utilisant les couches Lambda](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ou incluses dans les [d√©ploiements d'images de conteneurs](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), fonctionnent en deux modes : **interne** et **externe**.

* Les **extensions internes** se fusionnent avec le processus d'ex√©cution, manipulant son d√©marrage en utilisant des **variables d'environnement sp√©cifiques au langage** et des **scripts de wrapper**. Cette personnalisation s'applique √† une gamme de runtimes, y compris **Java Correto 8 et 11, Node.js 10 et 12, et .NET Core 3.1**.
* Les **extensions externes** fonctionnent comme des processus s√©par√©s, maintenant l'alignement op√©rationnel avec le cycle de vie de la fonction Lambda. Elles sont compatibles avec divers runtimes comme **Node.js 10 et 12, Python 3.7 et 3.8, Ruby 2.5 et 2.7, Java Corretto 8 et 11, .NET Core 3.1**, et **runtimes personnalis√©s**.

Pour plus d'informations sur [**comment fonctionnent les extensions lambda, consultez la documentation**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Extension Externe pour la Persistance, le Vol de Requ√™tes et la Modification de Requ√™tes

Voici un r√©sum√© de la technique propos√©e dans cet article : [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Il a √©t√© constat√© que le noyau Linux par d√©faut dans l'environnement d'ex√©cution Lambda est compil√© avec les appels syst√®me ‚Äú**process\_vm\_readv**‚Äù et ‚Äú**process\_vm\_writev**‚Äù. Et tous les processus s'ex√©cutent avec le m√™me ID utilisateur, m√™me le nouveau processus cr√©√© pour l'extension externe. **Cela signifie qu'une extension externe a un acc√®s complet en lecture et √©criture √† la m√©moire heap de Rapid, par conception.**

De plus, bien que les extensions Lambda aient la capacit√© de **s'abonner aux √©v√©nements d'invocation**, AWS ne r√©v√®le pas les donn√©es brutes √† ces extensions. Cela garantit que **les extensions ne peuvent pas acc√©der aux informations sensibles** transmises via la requ√™te HTTP.

Le processus Init (Rapid) surveille toutes les requ√™tes API √† [http://127.0.0.1:9001](http://127.0.0.1:9001/) tandis que les extensions Lambda sont initialis√©es et ex√©cut√©es avant l'ex√©cution de tout code runtime, mais apr√®s Rapid.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

La variable **`AWS_LAMBDA_RUNTIME_API`** indique l'**adresse IP** et le **num√©ro de port** de l'API Rapid aux **processus runtime enfants** et aux extensions suppl√©mentaires.

{% hint style="warning" %}
En changeant la variable d'environnement **`AWS_LAMBDA_RUNTIME_API`** √† un **`port`** auquel nous avons acc√®s, il est possible d'intercepter toutes les actions au sein du runtime Lambda (**man-in-the-middle**). Cela est possible car l'extension s'ex√©cute avec les m√™mes privil√®ges que Rapid Init, et le noyau du syst√®me permet la **modification de la m√©moire des processus**, permettant ainsi l'alt√©ration du num√©ro de port.
{% endhint %}

Parce que **les extensions s'ex√©cutent avant tout code runtime**, la modification de la variable d'environnement influencera le processus runtime (par exemple, Python, Java, Node, Ruby) √† son d√©marrage. De plus, **les extensions charg√©es apr√®s** la n√¥tre, qui d√©pendent de cette variable, passeront √©galement par notre extension. Cette configuration pourrait permettre √† un malware de contourner enti√®rement les mesures de s√©curit√© ou les extensions de journalisation directement dans l'environnement runtime.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

L'outil [**lambda-spy**](https://github.com/clearvector/lambda-spy) a √©t√© cr√©√© pour effectuer cette **√©criture en m√©moire** et **voler des informations sensibles** des requ√™tes lambda, des **requ√™tes d'autres extensions** et m√™me **les modifier**.

## R√©f√©rences

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}
