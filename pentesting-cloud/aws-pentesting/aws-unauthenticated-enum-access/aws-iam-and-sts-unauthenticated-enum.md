# AWS - IAM & STS Kimlik Doğrulamasız Enum

{% hint style="success" %}
AWS Hacking öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **HackTricks** ve **HackTricks Cloud** github depolarına PR göndererek hacking püf noktalarını paylaşın.

</details>
{% endhint %}

## Hesapta Roller ve Kullanıcı Adlarını Sıralama

### ~~Rolü Zorla Tahmin Etme~~

{% hint style="danger" %}
**Bu teknik artık çalışmıyor** çünkü rol var olup olmadığına bakılmaksızın her zaman bu hatayı alırsınız:

`An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::947247140022:user/testenv is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::429217632764:role/account-balanceasdas`

Bu testi çalıştırarak **deneyebilirsiniz**:

`aws sts assume-role --role-arn arn:aws:iam::412345678909:role/superadmin --role-session-name s3-access-example`
{% endhint %}

Gerekli izinlere sahip olmadan **bir rolü varsayma** girişimi bir AWS hata mesajını tetikler. Örneğin, yetkisiz olduğunda, AWS şunu döndürebilir:
```ruby
An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::012345678901:user/MyUser is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::111111111111:role/aws-service-role/rds.amazonaws.com/AWSServiceRoleForRDS
```
Bu mesaj, rolün varlığını doğrular ancak assume role politikasının sizin assumption yapmanıza izin vermediğini belirtir. Buna karşılık, **var olmayan bir rolü assume etmeye çalışmak farklı bir hata ile sonuçlanır**:
```less
An error occurred (AccessDenied) when calling the AssumeRole operation: Not authorized to perform sts:AssumeRole
```
Ilginç bir şekilde, mevcut ve mevcut olmayan roller arasındaki ayrımı yapma yöntemi, farklı AWS hesapları arasında bile uygulanabilir. Geçerli bir AWS hesap kimliği ve hedeflenen bir kelime listesi ile, hesaptaki rolleri varsayılan sınırlamalar olmadan sıralayabilirsiniz.

Bu [betiği (script) kullanarak potansiyel prensipleri sıralayabilirsiniz](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/assume\_role\_enum) ve bu sorunu kötüye kullanabilirsiniz.

### Güven Politikaları: Zorla Çapraz Hesap rolleri ve kullanıcıları

Bir IAM rolünün güven politikasını yapılandırma veya güncelleme, o rolü alabilecek ve geçici kimlik bilgilerini alabilecek AWS kaynaklarını veya hizmetlerini tanımlamayı içerir. Politikadaki belirtilen kaynak **varsa**, güven politikası **başarılı bir şekilde** kaydedilir. Ancak, kaynak **mevcut değilse**, geçersiz bir prensip sağlandığını belirten bir **hata oluşturulur**.

{% hint style="warning" %}
Bu kaynakta çapraz hesap rolü veya kullanıcı belirtebilirsiniz:

* `arn:aws:iam::acc_id:role/role_name`
* `arn:aws:iam::acc_id:user/user_name`
{% endhint %}

Bu bir politika örneğidir:
```json
{
"Version":"2012-10-17",
"Statement":[
{
"Effect":"Allow",
"Principal":
{
"AWS":"arn:aws:iam::216825089941:role\/Test"
},
"Action":"sts:AssumeRole"
}
]
}
```
#### GUI

Bu, **var olmayan bir rol** kullandığınızda karşılaşacağınız **hata**dır. Rol **varsa**, politika **hata olmadan** kaydedilecektir. (Hata güncelleme için, ancak oluşturulurken de çalışır)

![](<../../../.gitbook/assets/image (68).png>)

#### CLI
```bash
### You could also use: aws iam update-assume-role-policy
# When it works
aws iam create-role --role-name Test-Role --assume-role-policy-document file://a.json
{
"Role": {
"Path": "/",
"RoleName": "Test-Role",
"RoleId": "AROA5ZDCUJS3DVEIYOB73",
"Arn": "arn:aws:iam::947247140022:role/Test-Role",
"CreateDate": "2022-05-03T20:50:04Z",
"AssumeRolePolicyDocument": {
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::316584767888:role/account-balance"
},
"Action": [
"sts:AssumeRole"
]
}
]
}
}
}

# When it doesn't work
aws iam create-role --role-name Test-Role2 --assume-role-policy-document file://a.json
An error occurred (MalformedPolicyDocument) when calling the CreateRole operation: Invalid principal in policy: "AWS":"arn:aws:iam::316584767888:role/account-balanceefd23f2"
```
Automasyon sürecini [https://github.com/carlospolop/aws\_tools](https://github.com/carlospolop/aws\_tools) ile gerçekleştirebilirsiniz.

* `bash unauth_iam.sh -t user -i 316584767888 -r TestRole -w ./unauth_wordlist.txt`

[Pacu](https://github.com/RhinoSecurityLabs/pacu) kullanarak:

* `run iam__enum_users --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* `run iam__enum_roles --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* Örnekte kullanılan `admin` rolü, pacu tarafından oluşturulması gereken politikaları oluşturmak için **hesabınızda kimlik hırsızlığı yapılacak bir rol** dur.

### Yükseltme

Rol yanlış yapılandırılmış ve herhangi birinin bunu üstlenmesine izin veriyorsa:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
## Üçüncü Taraf OIDC Federasyonu

Hayal edin ki bir **Github Actions iş akışı** okumayı başarıyorsunuz ve bu iş akışı **AWS** içinde bir **rol**e erişiyor.\
Bu güven, aşağıdaki **güven politikasına** sahip bir role erişim sağlayabilir:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::<acc_id>:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
Bu güven politikası doğru olabilir, ancak **daha fazla koşulun eksik olması** size güvenmemeniz gerektiğini göstermelidir.\
Bu, önceki rolün **Github Actions'tan HERHANGİ BİRİ** tarafından varsayılabileceği anlamına gelir! Koşullarda org adı, repo adı, env, branch gibi diğer şeyleri de belirtmelisiniz...

Başka bir potansiyel yan yapılandırma ise aşağıdaki gibi bir koşul **eklemektir:**
```json
"StringLike": {
"token.actions.githubusercontent.com:sub": "repo:org_name*:*"
}
```
Not: **iki yıldız** (\*) **üst üste** **iki nokta üst üste** (:). **org\_name1** gibi bir org oluşturabilir ve bir Github Eyleminden **rolü varsayabilirsiniz**.

## Referanslar

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/](https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/)

{% hint style="success" %}
AWS Hacking öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Destek HackTricks</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin**.
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks) github depolarına PR göndererek hacking püf noktalarını paylaşın.

</details>
{% endhint %}
