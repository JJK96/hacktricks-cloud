# AWS - IAM & STS Unauthenticated Enum

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τεχνικές χάκερ καταθέτοντας PRs** στα [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
{% endhint %}

## Απαρίθμηση Ρόλων & Ονομάτων Χρηστών σε ένα λογαριασμό

### ~~Υποθέστε τον Ρόλο Brute-Force~~

{% hint style="danger" %}
**Αυτή η τεχνική δεν λειτουργεί** πλέον καθώς είτε ο ρόλος υπάρχει είτε όχι, πάντα λαμβάνετε αυτό το σφάλμα:

`An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::947247140022:user/testenv is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::429217632764:role/account-balanceasdas`

Μπορείτε **να δοκιμάσετε αυτό τρέχοντας**:

`aws sts assume-role --role-arn arn:aws:iam::412345678909:role/superadmin --role-session-name s3-access-example`
{% endhint %}

Η προσπάθεια **υποθέσεως ενός ρόλου χωρίς τις απαραίτητες άδειες** ενεργοποιεί ένα μήνυμα σφάλματος AWS. Για παράδειγμα, αν δεν είστε εξουσιοδοτημένοι, το AWS μπορεί να επιστρέψει:
```ruby
An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::012345678901:user/MyUser is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::111111111111:role/aws-service-role/rds.amazonaws.com/AWSServiceRoleForRDS
```
Αυτό το μήνυμα επιβεβαιώνει την ύπαρξη του ρόλου, αλλά υποδηλώνει ότι η πολιτική assume role του δεν επιτρέπει την υπόθεσή σας. Αντίθετα, η προσπάθεια να **υποθέσετε ένα μη υπαρκτό ρόλο οδηγεί σε διαφορετικό σφάλμα**:
```less
An error occurred (AccessDenied) when calling the AssumeRole operation: Not authorized to perform sts:AssumeRole
```
Ενδιαφέροντα, αυτή η μέθοδος **διάκρισης μεταξύ υπαρχόντων και μη υπαρχόντων ρόλων** είναι εφαρμόσιμη ακόμα και σε διαφορετικούς λογαριασμούς AWS. Με ένα έγκυρο αναγνωριστικό λογαριασμού AWS και μια στοχευμένη λίστα λέξεων, μπορεί κανείς να απαριθμήσει τους ρόλους που υπάρχουν στον λογαριασμό χωρίς να αντιμετωπίζει κάποιου είδους περιορισμούς.

Μπορείτε να χρησιμοποιήσετε αυτό το [σενάριο για την απαρίθμηση πιθανών αρχών](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/assume\_role\_enum) καταχρώντας αυτό το θέμα.

### Πολιτικές Εμπιστοσύνης: Επίθεση Brute-Force σε ρόλους και χρήστες διαφορετικών λογαριασμών

Η ρύθμιση ή ενημέρωση της **πολιτικής εμπιστοσύνης ενός ρόλου IAM περιλαμβάνει τον καθορισμό ποιοι πόροι ή υπηρεσίες AWS επιτρέπεται να υιοθετήσουν αυτόν τον ρόλο** και να λάβουν προσωρινές διαπιστεύσεις. Εάν ο καθορισμένος πόρος στην πολιτική **υπάρχει**, η πολιτική εμπιστοσύνης αποθηκεύεται **με επιτυχία**. Ωστόσο, εάν ο πόρος **δεν υπάρχει**, δημιουργείται ένα **σφάλμα**, υποδεικνύοντας ότι δόθηκε μη έγκυρος αρχέγονος.

{% hint style="warning" %}
Σημειώστε ότι σε αυτόν τον πόρο μπορείτε να καθορίσετε έναν ρόλο ή χρήστη διαφορετικού λογαριασμού:

* `arn:aws:iam::acc_id:role/role_name`
* `arn:aws:iam::acc_id:user/user_name`
{% endhint %}

Αυτό είναι ένα παράδειγμα πολιτικής:
```json
{
"Version":"2012-10-17",
"Statement":[
{
"Effect":"Allow",
"Principal":
{
"AWS":"arn:aws:iam::216825089941:role\/Test"
},
"Action":"sts:AssumeRole"
}
]
}
```
#### Γραφικό Περιβάλλον Χρήστη (GUI)

Αυτό είναι το **σφάλμα** που θα βρείτε εάν χρησιμοποιήσετε έναν **ρόλο που δεν υπάρχει**. Εάν ο ρόλος **υπάρχει**, η πολιτική θα **αποθηκευτεί** χωρίς κανένα σφάλμα. (Το σφάλμα είναι για ενημέρωση, αλλά λειτουργεί επίσης κατά τη δημιουργία)

![](<../../../.gitbook/assets/image (68).png>)

#### Εντολική Γραμμή (CLI)
```bash
### You could also use: aws iam update-assume-role-policy
# When it works
aws iam create-role --role-name Test-Role --assume-role-policy-document file://a.json
{
"Role": {
"Path": "/",
"RoleName": "Test-Role",
"RoleId": "AROA5ZDCUJS3DVEIYOB73",
"Arn": "arn:aws:iam::947247140022:role/Test-Role",
"CreateDate": "2022-05-03T20:50:04Z",
"AssumeRolePolicyDocument": {
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::316584767888:role/account-balance"
},
"Action": [
"sts:AssumeRole"
]
}
]
}
}
}

# When it doesn't work
aws iam create-role --role-name Test-Role2 --assume-role-policy-document file://a.json
An error occurred (MalformedPolicyDocument) when calling the CreateRole operation: Invalid principal in policy: "AWS":"arn:aws:iam::316584767888:role/account-balanceefd23f2"
```
Μπορείτε να αυτοματοποιήσετε αυτή τη διαδικασία με [https://github.com/carlospolop/aws\_tools](https://github.com/carlospolop/aws\_tools)

* `bash unauth_iam.sh -t user -i 316584767888 -r TestRole -w ./unauth_wordlist.txt`

Χρησιμοποιώντας το [Pacu](https://github.com/RhinoSecurityLabs/pacu):

* `run iam__enum_users --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* `run iam__enum_roles --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* Ο ρόλος `admin` που χρησιμοποιείται στο παράδειγμα είναι ένας **ρόλος στο λογαριασμό σας που θα πρέπει να υποδυθείτε** από το pacu για να δημιουργήσει τις πολιτικές που χρειάζεται για την απαρίθμηση

### Privesc

Στην περίπτωση που ο ρόλος ήταν κακά διαμορφωμένος και επιτρέπει σε οποιονδήποτε να τον υποθέσει:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
## Φιλοξενία τρίτου κόμβου OIDC

Φανταστείτε ότι καταφέρνετε να διαβάσετε ένα **ροή ενεργειών του Github** που έχει πρόσβαση σε ένα **ρόλο** μέσα στο **AWS**.\
Αυτή η εμπιστοσύνη μπορεί να δώσει πρόσβαση σε ένα ρόλο με την ακόλουθη **πολιτική εμπιστοσύνης**:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::<acc_id>:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
Αυτή η πολιτική εμπιστοσύνης μπορεί να είναι σωστή, αλλά η **έλλειψη περισσότερων συνθηκών** θα πρέπει να σας κάνει να την αμφισβητήσετε.\
Αυτό συμβαίνει επειδή ο προηγούμενος ρόλος μπορεί να υποθέσει **ΟΠΟΙΟΣΔΗΠΟΤΕ από τις ενέργειες του Github**! Θα πρέπει να καθορίσετε στις συνθήκες και άλλα πράγματα όπως το όνομα του οργανισμού, το όνομα του αποθετηρίου, το περιβάλλον, το όνομα του κλαδιού...

Μια άλλη πιθανή λανθασμένη ρύθμιση είναι να **προστεθεί μια συνθήκη** όπως η ακόλουθη:
```json
"StringLike": {
"token.actions.githubusercontent.com:sub": "repo:org_name*:*"
}
```
Σημείωση ότι το **wildcard** (\*) πριν το **colon** (:). Μπορείτε να δημιουργήσετε μια οργάνωση όπως **org\_name1** και **να υιοθετήσετε τον ρόλο** από ένα Github Action.

## Αναφορές

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/](https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκινγκ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
{% endhint %}
