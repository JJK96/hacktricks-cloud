# AWS - STS 권한 상승

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 **제로**부터 **히어로**로 AWS 해킹을 배우세요!</summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고**하거나 **HackTricks를 PDF로 다운로드**하고 싶다면 [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구매하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)를 **팔로우**하세요.
* **HackTricks** 및 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## STS

### `sts:AssumeRole`

모든 역할은 **역할 신뢰 정책**과 함께 생성됩니다. 이 정책은 **누가 생성된 역할을 가정할 수 있는지**를 나타냅니다. **동일한 계정**의 역할이 해당 계정이 가정할 수 있다고 말하면 해당 계정이 역할에 액세스할 수 있게 됩니다(그리고 잠재적으로 **권한 상승**이 가능할 수 있음).

예를 들어, 다음 역할 신뢰 정책은 누구나 가정할 수 있다고 나타내므로 **어떤 사용자든지 해당 역할과 관련된 권한으로 권한 상승**할 수 있습니다.
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
당신은 다음을 실행하여 역할을 위장할 수 있습니다:
```bash
aws sts assume-role --role-arn $ROLE_ARN --role-session-name sessionname
```
**잠재적 영향:** 역할로의 권한 상승.

{% hint style="danger" %}
이 경우에는 권한 `sts:AssumeRole`이 **악용할 역할에 표시**되어 있어야 하며, 공격자에게 속한 정책이 아니어야 함을 유의하십시오.\
한 가지 예외를 제외하고, **다른 계정에서 역할을 가정**하기 위해서는 공격자 계정도 역할에 대한 **`sts:AssumeRole`**을 가져야 합니다.
{% endhint %}

### **`sts:GetFederationToken`**

이 권한을 사용하면 어떤 사용자든지 흉내를 내어 자격 증명을 생성할 수 있습니다:
```bash
aws sts get-federation-token --name <username>
```
다음은 다른 사용자를 표현할 수 있는 권한을 부여하지 않고 안전하게 이 권한을 부여하는 방법입니다:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "VisualEditor0",
"Effect": "Allow",
"Action": "sts:GetFederationToken",
"Resource": "arn:aws:sts::947247140022:federated-user/${aws:username}"
}
]
}
```
### `sts:AssumeRoleWithSAML`

이 역할을 가진 신뢰 정책은 **SAML을 통해 인증된 사용자에게 역할을 표시할 수있는 액세스를 부여합니다.**

이 권한을 가진 신뢰 정책의 예는 다음과 같습니다:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "OneLogin",
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::290594632123:saml-provider/OneLogin"
},
"Action": "sts:AssumeRoleWithSAML",
"Condition": {
"StringEquals": {
"SAML:aud": "https://signin.aws.amazon.com/saml"
}
}
}
]
}
```
역할을 표절하기 위한 자격 증명을 생성하려면 일반적으로 다음과 같은 방법을 사용할 수 있습니다:
```bash
aws sts  assume-role-with-saml --role-arn <value> --principal-arn <value>
```
하지만 **공급업체**는 [onelogin-aws-assume-role](https://github.com/onelogin/onelogin-python-aws-assume-role)와 같은 **자체 도구**를 사용하여이를 더 쉽게 만들 수 있습니다:

{% code overflow="wrap" %}
```bash
onelogin-aws-assume-role --onelogin-subdomain mettle --onelogin-app-id 283740 --aws-region eu-west-1 -z 3600
```
{% endcode %}

**잠재적인 영향:** 역할에 대한 권한 상승.

### `sts:AssumeRoleWithWebIdentity`

이 권한은 웹 신원 제공자를 통해 인증된 사용자들을 위해 일시적 보안 자격 증명 세트를 얻을 수 있는 권한을 부여합니다. [여기에서 자세히 알아보기.](https://docs.aws.amazon.com/STS/latest/APIReference/API\_AssumeRoleWithWebIdentity.html)

예를 들어, **EKS 서비스 계정**이 **IAM 역할을 표시**할 수 있어야 하는 경우, **`/var/run/secrets/eks.amazonaws.com/serviceaccount/token`**에 토큰이 있고 다음과 같이 역할을 가정하고 자격 증명을 얻을 수 있습니다:

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/<role_name> --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
# The role name can be found in the metadata of the configuration of the pod
```
{% endcode %}

### 연맹 남용

{% content-ref url="../aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로부터 영웅이 될 때까지 AWS 해킹을 배우세요!</summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 PDF로 다운로드하고 싶다면** [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구매하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)를 **팔로우**하세요.
* **HackTricks** 및 **HackTricks Cloud** github 저장소에 PR을 제출하여 해킹 트릭을 공유하세요.

</details>
