# AWS - KMS Enum

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## KMS - Key Management Service

Το AWS Key Management Service (AWS KMS) παρουσιάζεται ως μια διαχειριζόμενη υπηρεσία, απλοποιώντας τη διαδικασία για τους χρήστες να **δημιουργούν και να διαχειρίζονται customer master keys** (CMKs). Αυτά τα CMKs είναι αναπόσπαστα στην κρυπτογράφηση των δεδομένων των χρηστών. Ένα αξιοσημείωτο χαρακτηριστικό του AWS KMS είναι ότι τα CMKs είναι κυρίως **ασφαλισμένα από hardware security modules** (HSMs), ενισχύοντας την προστασία των κλειδιών κρυπτογράφησης.

Το KMS χρησιμοποιεί **συμμετρική κρυπτογραφία**. Αυτό χρησιμοποιείται για να **κρυπτογραφεί πληροφορίες σε κατάσταση ηρεμίας** (για παράδειγμα, μέσα σε ένα S3). Αν χρειάζεστε να **κρυπτογραφείτε πληροφορίες σε μεταφορά** πρέπει να χρησιμοποιήσετε κάτι σαν **TLS**.

Το KMS είναι μια **υπηρεσία συγκεκριμένης περιοχής**.

**Οι διαχειριστές της Amazon δεν έχουν πρόσβαση στα κλειδιά σας**. Δεν μπορούν να ανακτήσουν τα κλειδιά σας και δεν σας βοηθούν με την κρυπτογράφηση των κλειδιών σας. Η AWS απλώς διαχειρίζεται το λειτουργικό σύστημα και την υποκείμενη εφαρμογή, ενώ εμείς πρέπει να διαχειριζόμαστε τα κλειδιά κρυπτογράφησης και πώς αυτά τα κλειδιά χρησιμοποιούνται.

**Customer Master Keys** (CMK): Μπορούν να κρυπτογραφούν δεδομένα έως 4KB σε μέγεθος. Συνήθως χρησιμοποιούνται για τη δημιουργία, κρυπτογράφηση και αποκρυπτογράφηση των DEKs (Data Encryption Keys). Στη συνέχεια, τα DEKs χρησιμοποιούνται για την κρυπτογράφηση των δεδομένων.

Ένα customer master key (CMK) είναι μια λογική αναπαράσταση ενός master key στο AWS KMS. Εκτός από τους αναγνωριστικούς και άλλα μεταδεδομένα του master key, συμπεριλαμβανομένης της ημερομηνίας δημιουργίας, της περιγραφής και της κατάστασης του κλειδιού, ένα **CMK περιέχει το υλικό κλειδιού που χρησιμοποιείται για την κρυπτογράφηση και αποκρυπτογράφηση δεδομένων**. Όταν δημιουργείτε ένα CMK, από προεπιλογή, το AWS KMS δημιουργεί το υλικό κλειδιού για αυτό το CMK. Ωστόσο, μπορείτε να επιλέξετε να δημιουργήσετε ένα CMK χωρίς υλικό κλειδιού και στη συνέχεια να εισάγετε το δικό σας υλικό κλειδιού σε αυτό το CMK.

Υπάρχουν 2 τύποι master keys:

* **AWS managed CMKs: Χρησιμοποιούνται από άλλες υπηρεσίες για την κρυπτογράφηση δεδομένων**. Χρησιμοποιείται από την υπηρεσία που το δημιούργησε σε μια περιοχή. Δημιουργούνται την πρώτη φορά που εφαρμόζετε την κρυπτογράφηση σε αυτή την υπηρεσία. Περιστρέφονται κάθε 3 χρόνια και δεν είναι δυνατό να αλλάξουν.
* **Customer manager CMKs**: Ευελιξία, περιστροφή, διαμορφώσιμη πρόσβαση και πολιτική κλειδιού. Ενεργοποίηση και απενεργοποίηση κλειδιών.

**Envelope Encryption** στο πλαίσιο του Key Management Service (KMS): Σύστημα ιεραρχίας δύο επιπέδων για **κρυπτογράφηση δεδομένων με data key και στη συνέχεια κρυπτογράφηση του data key με master key**.

### Key Policies

Αυτά ορίζουν **ποιος μπορεί να χρησιμοποιήσει και να έχει πρόσβαση σε ένα κλειδί στο KMS**.

Από **προεπιλογή:**

*   Δίνει στον **λογαριασμό AWS που κατέχει το κλειδί KMS πλήρη πρόσβαση** στο κλειδί KMS.

Σε αντίθεση με άλλες πολιτικές πόρων AWS, μια **πολιτική κλειδιού KMS AWS δεν δίνει αυτόματα άδεια στον λογαριασμό ή σε οποιονδήποτε από τους χρήστες του**. Για να δώσετε άδεια στους διαχειριστές του λογαριασμού, η **πολιτική κλειδιού πρέπει να περιλαμβάνει μια ρητή δήλωση** που παρέχει αυτή την άδεια, όπως αυτή.

* Χωρίς να επιτρέπεται στον λογαριασμό(`"AWS": "arn:aws:iam::111122223333:root"`) οι άδειες IAM δεν θα λειτουργούν.
*   Επιτρέπει στον λογαριασμό να χρησιμοποιεί πολιτικές IAM για να επιτρέπει την πρόσβαση στο κλειδί KMS, εκτός από την πολιτική κλειδιού.

**Χωρίς αυτή την άδεια, οι πολιτικές IAM που επιτρέπουν την πρόσβαση στο κλειδί είναι αναποτελεσματικές**, αν και οι πολιτικές IAM που αρνούνται την πρόσβαση στο κλειδί είναι ακόμα αποτελεσματικές.
* Μειώνει τον κίνδυνο το κλειδί να γίνει μη διαχειρίσιμο δίνοντας άδεια ελέγχου πρόσβασης στους διαχειριστές του λογαριασμού, συμπεριλαμβανομένου του root χρήστη του λογαριασμού, ο οποίος δεν μπορεί να διαγραφεί.

**Παράδειγμα προεπιλεγμένης πολιτικής**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Αν ο **λογαριασμός επιτρέπεται** (`"arn:aws:iam::111122223333:root"`) ένας **principal** από τον λογαριασμό **θα χρειαστεί ακόμα IAM permissions** για να χρησιμοποιήσει το KMS key. Ωστόσο, αν το **ARN** ενός ρόλου για παράδειγμα είναι **συγκεκριμένα επιτρεπτό** στην **Key Policy**, αυτός ο ρόλος **δεν χρειάζεται IAM permissions**.
{% endhint %}

<details>

<summary>Λεπτομέρειες Πολιτικής</summary>

Ιδιότητες μιας πολιτικής:

* Έγγραφο βασισμένο σε JSON
* Resource --> Επηρεαζόμενοι πόροι (μπορεί να είναι "\*")
* Action --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (permissions)
* Effect --> Allow/Deny
* Principal --> arn επηρεαζόμενο
* Conditions (προαιρετικό) --> Συνθήκη για την παροχή των permissions

Grants:

* Επιτρέπουν την ανάθεση των permissions σας σε άλλον AWS principal εντός του AWS λογαριασμού σας. Πρέπει να τα δημιουργήσετε χρησιμοποιώντας τα AWS KMS APIs. Μπορεί να υποδειχθεί το CMK identifier, ο grantee principal και το απαιτούμενο επίπεδο λειτουργίας (Decrypt, Encrypt, GenerateDataKey...)
* Μετά τη δημιουργία του grant εκδίδονται ένα GrantToken και ένα GrantID

**Πρόσβαση**:

* Μέσω **key policy** -- Αν αυτό υπάρχει, αυτό έχει **προτεραιότητα** έναντι της IAM policy
* Μέσω **IAM policy**
* Μέσω **grants**

</details>

### Key Administrators

Key administrator από προεπιλογή:

* Έχουν πρόσβαση για τη διαχείριση του KMS αλλά όχι για την κρυπτογράφηση ή αποκρυπτογράφηση δεδομένων
* Μόνο IAM users και roles μπορούν να προστεθούν στη λίστα Key Administrators (όχι groups)
* Αν χρησιμοποιείται εξωτερικό CMK, οι Key Administrators έχουν την άδεια να εισάγουν key material

### Περιστροφή των CMKs

* Όσο περισσότερο παραμένει το ίδιο κλειδί, τόσο περισσότερα δεδομένα κρυπτογραφούνται με αυτό το κλειδί, και αν αυτό το κλειδί παραβιαστεί, τότε η ευρύτερη περιοχή δεδομένων είναι σε κίνδυνο. Επιπλέον, όσο περισσότερο είναι ενεργό το κλειδί, αυξάνεται η πιθανότητα παραβίασής του.
* **Το KMS περιστρέφει τα customer keys κάθε 365 ημέρες** (ή μπορείτε να εκτελέσετε τη διαδικασία χειροκίνητα όποτε θέλετε) και **τα keys που διαχειρίζεται το AWS κάθε 3 χρόνια** και αυτή η περίοδος δεν μπορεί να αλλάξει.
* **Τα παλαιότερα κλειδιά διατηρούνται** για την αποκρυπτογράφηση δεδομένων που κρυπτογραφήθηκαν πριν από την περιστροφή
* Σε περίπτωση παραβίασης, η περιστροφή του κλειδιού δεν θα αφαιρέσει την απειλή καθώς θα είναι δυνατή η αποκρυπτογράφηση όλων των δεδομένων που κρυπτογραφήθηκαν με το παραβιασμένο κλειδί. Ωστόσο, τα **νέα δεδομένα θα κρυπτογραφηθούν με το νέο κλειδί**.
* Αν το **CMK** είναι σε κατάσταση **disabled** ή **pending** **deletion**, το KMS **δεν θα εκτελέσει περιστροφή κλειδιού** μέχρι να επανενεργοποιηθεί το CMK ή να ακυρωθεί η διαγραφή.

#### Χειροκίνητη περιστροφή

* Πρέπει να **δημιουργηθεί ένα νέο CMK**, τότε δημιουργείται ένα νέο CMK-ID, οπότε θα χρειαστεί να **ενημερώσετε** οποιαδήποτε **εφαρμογή** να **αναφέρεται** στο νέο CMK-ID.
* Για να γίνει αυτή η διαδικασία ευκολότερη μπορείτε να **χρησιμοποιήσετε aliases για να αναφέρεστε σε ένα key-id** και στη συνέχεια απλά να ενημερώσετε το key στο οποίο αναφέρεται το alias.
* Πρέπει να **διατηρήσετε τα παλιά κλειδιά για να αποκρυπτογραφήσετε τα παλιά αρχεία** που κρυπτογραφήθηκαν με αυτά.

Μπορείτε να εισάγετε κλειδιά από την on-premises key infrastructure σας.

### Άλλες σχετικές πληροφορίες για το KMS

Το KMS χρεώνεται ανά αριθμό αιτημάτων κρυπτογράφησης/αποκρυπτογράφησης που λαμβάνονται από όλες τις υπηρεσίες ανά μήνα.

Το KMS έχει πλήρη ενσωμάτωση audit και compliance με το **CloudTrail**; εδώ μπορείτε να ελέγξετε όλες τις αλλαγές που πραγματοποιούνται στο KMS.

Με την πολιτική KMS μπορείτε να κάνετε τα εξής:

* Να περιορίσετε ποιος μπορεί να δημιουργήσει data keys και ποιες υπηρεσίες έχουν πρόσβαση να χρησιμοποιούν αυτά τα κλειδιά
* Να περιορίσετε την πρόσβαση των συστημάτων μόνο για κρυπτογράφηση, μόνο για αποκρυπτογράφηση ή και τα δύο
* Να ορίσετε να επιτρέπεται στα συστήματα να έχουν πρόσβαση σε κλειδιά μεταξύ περιοχών (αν και δεν συνιστάται καθώς μια αποτυχία στην περιοχή που φιλοξενεί το KMS θα επηρεάσει τη διαθεσιμότητα των συστημάτων σε άλλες περιοχές).

Δεν μπορείτε να συγχρονίσετε ή να μετακινήσετε/αντιγράψετε κλειδιά μεταξύ περιοχών; μπορείτε μόνο να ορίσετε κανόνες για να επιτρέψετε την πρόσβαση μεταξύ περιοχών.

### Enumeration
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Αναφορές

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Δείτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
