# AWS - KMS Enum

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## KMS - Key Management Service

AWS Key Management Service (AWS KMS) est pr√©sent√© comme un service g√©r√©, simplifiant le processus pour les utilisateurs de **cr√©er et g√©rer des cl√©s ma√Ætresses client** (CMKs). Ces CMKs sont essentielles dans le chiffrement des donn√©es utilisateur. Une caract√©ristique notable d'AWS KMS est que les CMKs sont principalement **s√©curis√©es par des modules de s√©curit√© mat√©riels** (HSMs), renfor√ßant la protection des cl√©s de chiffrement.

KMS utilise la **cryptographie sym√©trique**. Cela est utilis√© pour **chiffrer les informations au repos** (par exemple, √† l'int√©rieur d'un S3). Si vous avez besoin de **chiffrer des informations en transit**, vous devez utiliser quelque chose comme **TLS**.

KMS est un **service sp√©cifique √† une r√©gion**.

**Les administrateurs d'Amazon n'ont pas acc√®s √† vos cl√©s**. Ils ne peuvent pas r√©cup√©rer vos cl√©s et ne vous aident pas √† chiffrer vos cl√©s. AWS administre simplement le syst√®me d'exploitation et l'application sous-jacente, c'est √† nous d'administrer nos cl√©s de chiffrement et de g√©rer comment ces cl√©s sont utilis√©es.

**Customer Master Keys** (CMK) : Peuvent chiffrer des donn√©es jusqu'√† 4KB. Elles sont g√©n√©ralement utilis√©es pour cr√©er, chiffrer et d√©chiffrer les DEKs (Data Encryption Keys). Ensuite, les DEKs sont utilis√©s pour chiffrer les donn√©es.

Une cl√© ma√Ætresse client (CMK) est une repr√©sentation logique d'une cl√© ma√Ætresse dans AWS KMS. En plus des identifiants de la cl√© ma√Ætresse et d'autres m√©tadonn√©es, y compris sa date de cr√©ation, sa description et son √©tat, une **CMK contient le mat√©riel de cl√© utilis√© pour chiffrer et d√©chiffrer les donn√©es**. Lorsque vous cr√©ez une CMK, par d√©faut, AWS KMS g√©n√®re le mat√©riel de cl√© pour cette CMK. Cependant, vous pouvez choisir de cr√©er une CMK sans mat√©riel de cl√© et ensuite importer votre propre mat√©riel de cl√© dans cette CMK.

Il existe 2 types de cl√©s ma√Ætresses :

* **CMKs g√©r√©es par AWS : Utilis√©es par d'autres services pour chiffrer des donn√©es**. Elles sont utilis√©es par le service qui les a cr√©√©es dans une r√©gion. Elles sont cr√©√©es la premi√®re fois que vous impl√©mentez le chiffrement dans ce service. Elles tournent tous les 3 ans et il n'est pas possible de les changer.
* **CMKs g√©r√©es par le client** : Flexibilit√©, rotation, acc√®s configurable et politique de cl√©. Activer et d√©sactiver les cl√©s.

**Chiffrement par enveloppe** dans le contexte du Key Management Service (KMS) : Syst√®me hi√©rarchique √† deux niveaux pour **chiffrer les donn√©es avec une cl√© de donn√©es puis chiffrer la cl√© de donn√©es avec une cl√© ma√Ætresse**.

### Politiques de Cl√©

Ces politiques d√©finissent **qui peut utiliser et acc√©der √† une cl√© dans KMS**.

Par **d√©faut :**

*   Elles donnent **un acc√®s complet √† la cl√© KMS au compte AWS qui poss√®de la cl√© KMS**.

Contrairement √† d'autres politiques de ressources AWS, une **politique de cl√© KMS AWS ne donne pas automatiquement la permission au compte ou √† l'un de ses utilisateurs**. Pour donner la permission aux administrateurs de compte, la **politique de cl√© doit inclure une d√©claration explicite** qui fournit cette permission, comme celle-ci.

* Sans autoriser le compte (`"AWS": "arn:aws:iam::111122223333:root"`) les permissions IAM ne fonctionneront pas.
*   Elles **permettent au compte d'utiliser des politiques IAM** pour autoriser l'acc√®s √† la cl√© KMS, en plus de la politique de cl√©.

**Sans cette permission, les politiques IAM qui autorisent l'acc√®s √† la cl√© sont inefficaces**, bien que les politiques IAM qui refusent l'acc√®s √† la cl√© soient toujours efficaces.
* Elles **r√©duisent le risque que la cl√© devienne ing√©rable** en donnant la permission de contr√¥le d'acc√®s aux administrateurs de compte, y compris l'utilisateur root du compte, qui ne peut pas √™tre supprim√©.

**Exemple de politique par d√©faut** :
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Si le **compte est autoris√©** (`"arn:aws:iam::111122223333:root"`), un **principal** du compte **aura toujours besoin des permissions IAM** pour utiliser la cl√© KMS. Cependant, si l'**ARN** d'un r√¥le par exemple est **sp√©cifiquement autoris√©** dans la **Key Policy**, ce r√¥le **n'a pas besoin de permissions IAM**.
{% endhint %}

<details>

<summary>D√©tails de la politique</summary>

Propri√©t√©s d'une politique :

* Document bas√© sur JSON
* Resource --> Ressources affect√©es (peut √™tre "\*")
* Action --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (permissions)
* Effect --> Allow/Deny
* Principal --> arn affect√©
* Conditions (optionnel) --> Condition pour donner les permissions

Grants :

* Permet de d√©l√©guer vos permissions √† un autre principal AWS au sein de votre compte AWS. Vous devez les cr√©er en utilisant les API AWS KMS. Il peut √™tre indiqu√© l'identifiant CMK, le principal b√©n√©ficiaire et le niveau d'op√©ration requis (Decrypt, Encrypt, GenerateDataKey...)
* Apr√®s la cr√©ation du grant, un GrantToken et un GrantID sont √©mis

**Acc√®s** :

* Via **key policy** -- Si cela existe, cela prend **pr√©c√©dence** sur la politique IAM
* Via **politique IAM**
* Via **grants**

</details>

### Administrateurs de cl√©s

Administrateur de cl√© par d√©faut :

* Ont acc√®s √† la gestion de KMS mais pas pour chiffrer ou d√©chiffrer des donn√©es
* Seuls les utilisateurs et r√¥les IAM peuvent √™tre ajout√©s √† la liste des administrateurs de cl√©s (pas les groupes)
* Si un CMK externe est utilis√©, les administrateurs de cl√©s ont la permission d'importer le mat√©riel de cl√©

### Rotation des CMK

* Plus une cl√© reste en place longtemps, plus de donn√©es sont chiffr√©es avec cette cl√©, et si cette cl√© est compromise, alors la zone d'impact des donn√©es √† risque est plus large. De plus, plus la cl√© est active longtemps, plus la probabilit√© qu'elle soit compromise augmente.
* **KMS fait tourner les cl√©s client tous les 365 jours** (ou vous pouvez effectuer le processus manuellement quand vous le souhaitez) et **les cl√©s g√©r√©es par AWS tous les 3 ans** et ce d√©lai ne peut pas √™tre modifi√©.
* **Les anciennes cl√©s sont conserv√©es** pour d√©chiffrer les donn√©es chiffr√©es avant la rotation
* En cas de compromission, faire tourner la cl√© ne supprimera pas la menace car il sera possible de d√©chiffrer toutes les donn√©es chiffr√©es avec la cl√© compromise. Cependant, les **nouvelles donn√©es seront chiffr√©es avec la nouvelle cl√©**.
* Si le **CMK** est en √©tat de **d√©sactiv√©** ou **en attente** de **suppression**, KMS **ne fera pas de rotation de cl√©** jusqu'√† ce que le CMK soit r√©activ√© ou que la suppression soit annul√©e.

#### Rotation manuelle

* Un **nouveau CMK doit √™tre cr√©√©**, puis, un nouvel identifiant CMK est cr√©√©, vous devrez donc **mettre √† jour** toute **application** pour **r√©f√©rencer** le nouvel identifiant CMK.
* Pour rendre ce processus plus facile, vous pouvez **utiliser des alias pour r√©f√©rencer un identifiant de cl√©** et ensuite simplement mettre √† jour la cl√© √† laquelle l'alias fait r√©f√©rence.
* Vous devez **conserver les anciennes cl√©s pour d√©chiffrer les anciens fichiers** chiffr√©s avec elles.

Vous pouvez importer des cl√©s depuis votre infrastructure de cl√©s sur site.

### Autres informations pertinentes sur KMS

KMS est factur√© par nombre de requ√™tes de chiffrement/d√©chiffrement re√ßues de tous les services par mois.

KMS a une int√©gration compl√®te d'audit et de conformit√© avec **CloudTrail** ; c'est l√† que vous pouvez auditer tous les changements effectu√©s sur KMS.

Avec la politique KMS, vous pouvez faire ce qui suit :

* Limiter qui peut cr√©er des cl√©s de donn√©es et quels services ont acc√®s √† utiliser ces cl√©s
* Limiter l'acc√®s des syst√®mes √† chiffrer uniquement, d√©chiffrer uniquement ou les deux
* D√©finir pour permettre aux syst√®mes d'acc√©der aux cl√©s √† travers les r√©gions (bien que cela ne soit pas recommand√© car une d√©faillance dans la r√©gion h√©bergeant KMS affectera la disponibilit√© des syst√®mes dans d'autres r√©gions).

Vous ne pouvez pas synchroniser ou d√©placer/copier des cl√©s √† travers les r√©gions ; vous pouvez seulement d√©finir des r√®gles pour permettre l'acc√®s √† travers les r√©gions.

### √ânum√©ration
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
