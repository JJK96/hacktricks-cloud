# AWS - KMS Enum

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## KMS - Key Management Service

AWS Key Management Service (AWS KMS) je predstavljen kao upravljana usluga, pojednostavljujući proces za korisnike da **kreiraju i upravljaju customer master keys** (CMKs). Ovi CMKs su integralni u enkripciji korisničkih podataka. Značajna karakteristika AWS KMS je da su CMKs pretežno **osigurani hardverskim sigurnosnim modulima** (HSMs), poboljšavajući zaštitu enkripcijskih ključeva.

KMS koristi **simetričnu kriptografiju**. Ovo se koristi za **enkripciju informacija u mirovanju** (na primer, unutar S3). Ako vam je potrebno da **enkriptujete informacije u tranzitu** morate koristiti nešto poput **TLS**.

KMS je **usluga specifična za region**.

**Administratori u Amazonu nemaju pristup vašim ključevima**. Oni ne mogu povratiti vaše ključeve i ne pomažu vam sa enkripcijom vaših ključeva. AWS samo upravlja operativnim sistemom i osnovnom aplikacijom, a na nama je da upravljamo našim enkripcijskim ključevima i kako se ti ključevi koriste.

**Customer Master Keys** (CMK): Mogu enkriptovati podatke do 4KB veličine. Obično se koriste za kreiranje, enkripciju i dekripciju DEKs (Data Encryption Keys). Zatim se DEKs koriste za enkripciju podataka.

Customer master key (CMK) je logička reprezentacija master ključa u AWS KMS. Pored identifikatora master ključa i drugih metapodataka, uključujući datum kreiranja, opis i stanje ključa, **CMK sadrži materijal ključa koji se koristi za enkripciju i dekripciju podataka**. Kada kreirate CMK, po defaultu, AWS KMS generiše materijal ključa za taj CMK. Međutim, možete odabrati da kreirate CMK bez materijala ključa i zatim uvezete svoj materijal ključa u taj CMK.

Postoje 2 tipa master ključeva:

* **AWS managed CMKs: Koriste ih druge usluge za enkripciju podataka**. Koristi ih usluga koja ih je kreirala u regionu. Kreiraju se prvi put kada implementirate enkripciju u toj usluzi. Rotiraju se svakih 3 godine i nije moguće promeniti ih.
* **Customer manager CMKs**: Fleksibilnost, rotacija, konfigurisani pristup i politika ključa. Omogućava i onemogućava ključeve.

**Envelope Encryption** u kontekstu Key Management Service (KMS): Dvostepeni hijerarhijski sistem za **enkripciju podataka sa data key i zatim enkripciju data key sa master key**.

### Key Policies

Ovo definiše **ko može koristiti i pristupiti ključu u KMS**.

Po **defaultu:**

*   Daje **AWS nalogu koji poseduje KMS ključ pun pristup** KMS ključu.

Za razliku od drugih AWS resursnih politika, AWS **KMS key policy automatski ne daje dozvolu nalogu ili bilo kojem od njegovih korisnika**. Da bi se dozvolila dozvola administratorima naloga, **politika ključa mora uključivati eksplicitnu izjavu** koja pruža ovu dozvolu, kao ova.

* Bez dozvole za nalog(`"AWS": "arn:aws:iam::111122223333:root"`) IAM dozvole neće raditi.
*   Omogućava nalogu da koristi IAM politike za dozvolu pristupa KMS ključu, pored politike ključa.

**Bez ove dozvole, IAM politike koje dozvoljavaju pristup ključu su neefikasne**, iako su IAM politike koje zabranjuju pristup ključu i dalje efikasne.
* Smanjuje rizik da ključ postane neupotrebljiv dajući dozvolu za kontrolu pristupa administratorima naloga, uključujući root korisnika naloga, koji ne može biti obrisan.

**Default policy** primer:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Ako je **nalog dozvoljen** (`"arn:aws:iam::111122223333:root"`) **principal** iz naloga **će i dalje trebati IAM dozvole** da koristi KMS ključ. Međutim, ako je **ARN** uloge na primer **specifično dozvoljen** u **Key Policy**, ta uloga **ne treba IAM dozvole**.
{% endhint %}

<details>

<summary>Detalji Politike</summary>

Svojstva politike:

* JSON baziran dokument
* Resource --> Pogođeni resursi (može biti "\*")
* Action --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (dozvole)
* Effect --> Allow/Deny
* Principal --> pogođeni arn
* Conditions (opciono) --> Uslov za davanje dozvola

Grants:

* Dozvoljava delegiranje vaših dozvola drugom AWS principalu unutar vašeg AWS naloga. Morate ih kreirati koristeći AWS KMS API-je. Može se navesti CMK identifikator, principal kome se daje dozvola i potreban nivo operacije (Decrypt, Encrypt, GenerateDataKey...)
* Nakon kreiranja granta, izdaju se GrantToken i GrantID

**Pristup**:

* Preko **key policy** -- Ako ovo postoji, ima **prednost** nad IAM politikom
* Preko **IAM politike**
* Preko **grants**

</details>

### Key Administrators

Key administrator po defaultu:

* Ima pristup za upravljanje KMS-om, ali ne i za šifrovanje ili dešifrovanje podataka
* Samo IAM korisnici i uloge mogu biti dodati na listu Key Administrators (ne grupe)
* Ako se koristi eksterni CMK, Key Administrators imaju dozvolu da uvezu ključni materijal

### Rotacija CMKs

* Što duže isti ključ ostaje na mestu, više podataka se šifruje tim ključem, i ako taj ključ bude ugrožen, šira oblast podataka je u riziku. Pored toga, što je ključ duže aktivan, veća je verovatnoća da će biti ugrožen.
* **KMS rotira korisničke ključeve svakih 365 dana** (ili možete ručno izvršiti proces kad god želite) i **ključeve kojima upravlja AWS svakih 3 godine** i ovo vreme se ne može promeniti.
* **Stariji ključevi se zadržavaju** za dešifrovanje podataka koji su šifrovani pre rotacije
* U slučaju proboja, rotacija ključa neće ukloniti pretnju jer će biti moguće dešifrovati sve podatke šifrovane ugroženim ključem. Međutim, **novi podaci će biti šifrovani novim ključem**.
* Ako je **CMK** u stanju **disabled** ili **pending** **deletion**, KMS **neće izvršiti rotaciju ključa** dok se CMK ne ponovo omogući ili dok se brisanje ne otkaže.

#### Ručna rotacija

* Potreban je **novi CMK**, zatim se kreira novi CMK-ID, tako da ćete morati **ažurirati** svaku **aplikaciju** da **referencira** novi CMK-ID.
* Da bi ovaj proces bio lakši, možete **koristiti alias-e za referenciranje key-id** i zatim samo ažurirati ključ na koji alias referencira.
* Potrebno je **zadržati stare ključeve za dešifrovanje starih fajlova** šifrovanih njima.

Možete uvesti ključeve iz vaše on-premises ključne infrastrukture.

### Ostale relevantne informacije o KMS-u

KMS se naplaćuje po broju zahteva za šifrovanje/dešifrovanje primljenih od svih servisa mesečno.

KMS ima punu reviziju i usklađenost **integrisanu sa CloudTrail**; ovde možete revidirati sve promene izvršene na KMS-u.

Sa KMS politikom možete uraditi sledeće:

* Ograničiti ko može kreirati data keys i koji servisi imaju pristup da koriste te ključeve
* Ograničiti pristup sistemima samo za šifrovanje, samo za dešifrovanje ili oba
* Definisati omogućavanje sistemima da pristupaju ključevima preko regiona (iako se ne preporučuje jer će kvar u regionu koji hostuje KMS uticati na dostupnost sistema u drugim regionima).

Ne možete sinhronizovati ili premestiti/kopirati ključeve preko regiona; možete samo definisati pravila za omogućavanje pristupa preko regiona.

### Enumeration
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Reference

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hacking trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
