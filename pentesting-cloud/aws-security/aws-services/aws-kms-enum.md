# AWS - KMS Enum

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## KMS - Key Management Service

AWS Key Management Service (AWS KMS), kullanıcıların **müşteri anahtarlarını (CMK) oluşturma ve yönetme** sürecini basitleştiren yönetilen bir hizmet olarak sunulmaktadır. Bu CMK'lar, kullanıcı verilerinin şifrelenmesinde önemli bir rol oynar. AWS KMS'nin dikkat çeken bir özelliği, CMK'ların büyük ölçüde **donanım güvenlik modülleri (HSM) tarafından güvence altına alınmasıdır**, bu da şifreleme anahtarlarının korunmasını artırır.

KMS, **simetrik kriptografi** kullanır. Bu, **dinlenme halindeki bilgileri şifrelemek** için kullanılır (örneğin, bir S3 içinde). **Aktarım halindeki bilgileri şifrelemeniz gerekiyorsa** **TLS** gibi bir şey kullanmanız gerekir.

KMS, **bölgeye özgü bir hizmettir**.

**Amazon'daki yöneticiler anahtarlarınıza erişemez**. Anahtarlarınızı kurtaramazlar ve anahtarlarınızın şifrelenmesine yardımcı olmazlar. AWS sadece işletim sistemini ve temel uygulamayı yönetir, şifreleme anahtarlarımızı yönetmek ve bu anahtarların nasıl kullanılacağını yönetmek bize kalmıştır.

**Müşteri Anahtarları (CMK)**: 4KB boyutuna kadar verileri şifreleyebilir. Genellikle DEK'leri (Veri Şifreleme Anahtarları) oluşturmak, şifrelemek ve şifresini çözmek için kullanılırlar. Daha sonra DEK'ler veriyi şifrelemek için kullanılır.

Bir müşteri anahtarı (CMK), AWS KMS'de bir anahtarın mantıksal bir temsilidir. Anahtarın tanımlayıcıları ve diğer meta verilerinin yanı sıra, oluşturulma tarihi, açıklaması ve anahtar durumu dahil olmak üzere, bir **CMK, verileri şifrelemek ve şifresini çözmek için kullanılan anahtar materyalini içerir**. Bir CMK oluşturduğunuzda, varsayılan olarak, AWS KMS bu CMK için anahtar materyalini oluşturur. Ancak, anahtar materyali olmadan bir CMK oluşturmayı seçebilir ve ardından kendi anahtar materyalinizi bu CMK'ya aktarabilirsiniz.

2 tür anahtar vardır:

* **AWS yönetilen CMK'lar: Diğer hizmetler tarafından veri şifrelemek için kullanılır**. Bir bölgede oluşturulduğu hizmet tarafından kullanılır. Bu hizmette şifrelemeyi ilk kez uyguladığınızda oluşturulurlar. Her 3 yılda bir döner ve değiştirilmesi mümkün değildir.
* **Müşteri yönetici CMK'lar**: Esneklik, döndürme, yapılandırılabilir erişim ve anahtar politikası. Anahtarları etkinleştirme ve devre dışı bırakma.

**Zarf Şifreleme** KMS bağlamında: **Veri anahtarı ile veriyi şifrelemek ve ardından veri anahtarını anahtar ile şifrelemek** için iki katmanlı hiyerarşi sistemi.

### Anahtar Politikaları

Bu, **KMS'de bir anahtarı kimlerin kullanabileceğini ve erişebileceğini** tanımlar.

**Varsayılan olarak:**

*   **KMS anahtarına tam erişim sağlayan AWS hesabına** KMS anahtarına tam erişim sağlar.

Diğer AWS kaynak politikalarından farklı olarak, bir AWS **KMS anahtar politikası, otomatik olarak hesaba veya herhangi bir kullanıcısına izin vermez**. Hesap yöneticilerine izin vermek için, **anahtar politikası bu izni sağlayan açık bir ifade içermelidir**, bu gibi.

* Hesaba izin vermeden (`"AWS": "arn:aws:iam::111122223333:root"`) IAM izinleri çalışmaz.
*   Bu, **anahtar politikasına ek olarak IAM politikalarını kullanarak KMS anahtarına erişime izin verir**.

**Bu izin olmadan, anahtara erişime izin veren IAM politikaları etkisizdir**, ancak anahtara erişimi reddeden IAM politikaları hala etkilidir.
* Bu, **anahtarın yönetilemez hale gelme riskini azaltır** ve hesap kök kullanıcısı da dahil olmak üzere hesap yöneticilerine erişim kontrol izni verir, bu kullanıcı silinemez.

**Varsayılan politika** örneği:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Eğer **hesaba izin verilmişse** (`"arn:aws:iam::111122223333:root"`) hesaptan bir **principal** KMS anahtarını kullanmak için **IAM izinlerine ihtiyaç duyacaktır**. Ancak, örneğin bir rolün **ARN'si** **Anahtar Politikasında** **özellikle izin verilmişse**, o rol **IAM izinlerine ihtiyaç duymaz**.
{% endhint %}

<details>

<summary>Politika Detayları</summary>

Bir politikanın özellikleri:

* JSON tabanlı belge
* Resource --> Etkilenen kaynaklar ( "\*" olabilir)
* Action --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (izinler)
* Effect --> Allow/Deny
* Principal --> etkilenen arn
* Koşullar (isteğe bağlı) --> İzinleri vermek için koşul

Grants:

* İzinlerinizi AWS hesabınızdaki başka bir AWS principal'ına devretmenize izin verir. AWS KMS API'lerini kullanarak bunları oluşturmanız gerekir. CMK tanımlayıcısı, grantee principal ve gerekli operasyon seviyesi (Decrypt, Encrypt, GenerateDataKey...) belirtilebilir.
* Grant oluşturulduktan sonra bir GrantToken ve GrantID verilir.

**Erişim**:

* **anahtar politikası** aracılığıyla -- Bu mevcutsa, IAM politikasına **öncelik** tanır
* **IAM politikası** aracılığıyla
* **grants** aracılığıyla

</details>

### Anahtar Yöneticileri

Varsayılan olarak anahtar yöneticisi:

* KMS'yi yönetme erişimine sahiptir ancak veri şifreleme veya şifre çözme yetkisine sahip değildir
* Yalnızca IAM kullanıcıları ve roller Anahtar Yöneticileri listesine eklenebilir (gruplar değil)
* Harici CMK kullanılıyorsa, Anahtar Yöneticileri anahtar materyalini içe aktarma iznine sahiptir

### CMK'ların Döndürülmesi

* Aynı anahtar ne kadar uzun süre yerinde kalırsa, o anahtarla daha fazla veri şifrelenir ve eğer o anahtar ihlal edilirse, risk altındaki veri alanı o kadar geniş olur. Buna ek olarak, anahtar ne kadar uzun süre aktif olursa, ihlal edilme olasılığı da artar.
* **KMS müşteri anahtarlarını her 365 günde bir döndürür** (veya istediğiniz zaman manuel olarak bu işlemi gerçekleştirebilirsiniz) ve **AWS tarafından yönetilen anahtarlar her 3 yılda bir** döndürülür ve bu süre değiştirilemez.
* **Eski anahtarlar** döndürme öncesinde şifrelenmiş verileri çözmek için saklanır.
* Bir ihlal durumunda, anahtarın döndürülmesi tehdidi ortadan kaldırmaz çünkü ihlal edilen anahtarla şifrelenmiş tüm verileri çözmek mümkün olacaktır. Ancak, **yeni veriler yeni anahtarla şifrelenecektir**.
* Eğer **CMK** **devre dışı** veya **silinmeyi bekliyor** durumundaysa, KMS **anahtar döndürme işlemi gerçekleştirmez** CMK yeniden etkinleştirilene veya silme iptal edilene kadar.

#### Manuel döndürme

* **Yeni bir CMK oluşturulması gerekir**, ardından yeni bir CMK-ID oluşturulur, bu nedenle **herhangi bir uygulamayı** yeni CMK-ID'yi **referans alacak şekilde güncellemeniz** gerekecektir.
* Bu işlemi kolaylaştırmak için **bir anahtar-id'ye atıfta bulunmak için takma adlar kullanabilirsiniz** ve ardından takma adın atıfta bulunduğu anahtarı güncelleyebilirsiniz.
* **Eski dosyaları şifrelemek için eski anahtarları saklamanız** gerekir.

Anahtarları yerel anahtar altyapınızdan içe aktarabilirsiniz.

### Diğer ilgili KMS bilgileri

KMS, ayda alınan şifreleme/şifre çözme isteklerinin sayısına göre fiyatlandırılır.

KMS, **CloudTrail ile tam denetim ve uyum entegrasyonuna** sahiptir; burada KMS üzerinde gerçekleştirilen tüm değişiklikleri denetleyebilirsiniz.

KMS politikası ile şunları yapabilirsiniz:

* Veri anahtarlarını kimlerin oluşturabileceğini ve bu anahtarları kullanma erişimine sahip hizmetleri sınırlayın
* Sistemlerin yalnızca şifreleme, yalnızca şifre çözme veya her ikisine erişimini sınırlayın
* Sistemlerin anahtarlara bölgeler arası erişimini etkinleştirmek için tanımlayın (bölgede KMS'yi barındıran bir arızanın diğer bölgelerdeki sistemlerin kullanılabilirliğini etkileyeceği için önerilmez).

Anahtarları bölgeler arasında senkronize edemez veya taşıyamaz/kopyalayamazsınız; yalnızca bölgeler arası erişime izin veren kurallar tanımlayabilirsiniz.

### Enumeration
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Discord grubuna** 💬 [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) **bizi takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}
