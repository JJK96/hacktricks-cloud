# AWS - KMS Enum

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## KMS - Key Management Service

AWS Key Management Service (AWS KMS) se presenta como un servicio gestionado, simplificando el proceso para que los usuarios **creen y gestionen claves maestras de cliente** (CMKs). Estas CMKs son fundamentales en la encriptaci칩n de datos de usuario. Una caracter칤stica notable de AWS KMS es que las CMKs est치n predominantemente **aseguradas por m칩dulos de seguridad de hardware** (HSMs), mejorando la protecci칩n de las claves de encriptaci칩n.

KMS utiliza **criptograf칤a sim칠trica**. Esto se usa para **encriptar informaci칩n en reposo** (por ejemplo, dentro de un S3). Si necesitas **encriptar informaci칩n en tr치nsito** debes usar algo como **TLS**.

KMS es un **servicio espec칤fico de regi칩n**.

**Los administradores de Amazon no tienen acceso a tus claves**. No pueden recuperar tus claves y no te ayudan con la encriptaci칩n de tus claves. AWS simplemente administra el sistema operativo y la aplicaci칩n subyacente, depende de nosotros administrar nuestras claves de encriptaci칩n y c칩mo se usan esas claves.

**Customer Master Keys** (CMK): Pueden encriptar datos de hasta 4KB de tama침o. Se utilizan t칤picamente para crear, encriptar y desencriptar las DEKs (Data Encryption Keys). Luego, las DEKs se usan para encriptar los datos.

Una clave maestra de cliente (CMK) es una representaci칩n l칩gica de una clave maestra en AWS KMS. Adem치s de los identificadores de la clave maestra y otros metadatos, incluyendo su fecha de creaci칩n, descripci칩n y estado de la clave, una **CMK contiene el material de la clave que se usa para encriptar y desencriptar datos**. Cuando creas una CMK, por defecto, AWS KMS genera el material de la clave para esa CMK. Sin embargo, puedes optar por crear una CMK sin material de clave y luego importar tu propio material de clave en esa CMK.

Hay 2 tipos de claves maestras:

* **AWS managed CMKs: Usadas por otros servicios para encriptar datos**. Es usada por el servicio que la cre칩 en una regi칩n. Se crean la primera vez que implementas la encriptaci칩n en ese servicio. Se rota cada 3 a침os y no es posible cambiarlo.
* **Customer manager CMKs**: Flexibilidad, rotaci칩n, acceso configurable y pol칤tica de claves. Habilitar y deshabilitar claves.

**Envelope Encryption** en el contexto de Key Management Service (KMS): Sistema de jerarqu칤a de dos niveles para **encriptar datos con una clave de datos y luego encriptar la clave de datos con una clave maestra**.

### Key Policies

Estas definen **qui칠n puede usar y acceder a una clave en KMS**.

Por **defecto:**

*   Da **acceso completo a la clave KMS a la cuenta de AWS que posee la clave KMS**.

A diferencia de otras pol칤ticas de recursos de AWS, una **pol칤tica de clave KMS de AWS no otorga autom치ticamente permiso a la cuenta ni a ninguno de sus usuarios**. Para dar permiso a los administradores de la cuenta, la **pol칤tica de clave debe incluir una declaraci칩n expl칤cita** que proporcione este permiso, como esta.

* Sin permitir la cuenta (`"AWS": "arn:aws:iam::111122223333:root"`) los permisos de IAM no funcionar치n.
*   Permite que la cuenta **use pol칤ticas de IAM** para permitir el acceso a la clave KMS, adem치s de la pol칤tica de clave.

**Sin este permiso, las pol칤ticas de IAM que permiten el acceso a la clave son ineficaces**, aunque las pol칤ticas de IAM que niegan el acceso a la clave siguen siendo efectivas.
* Reduce el **riesgo de que la clave se vuelva inmanejable** al dar permiso de control de acceso a los administradores de la cuenta, incluyendo al usuario root de la cuenta, que no puede ser eliminado.

**Ejemplo de pol칤tica por defecto**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Si la **cuenta est치 permitida** (`"arn:aws:iam::111122223333:root"`) un **principal** de la cuenta **a칰n necesitar치 permisos IAM** para usar la clave KMS. Sin embargo, si el **ARN** de un rol, por ejemplo, est치 **espec칤ficamente permitido** en la **Pol칤tica de Clave**, ese rol **no necesita permisos IAM**.
{% endhint %}

<details>

<summary>Detalles de la Pol칤tica</summary>

Propiedades de una pol칤tica:

* Documento basado en JSON
* Recurso --> Recursos afectados (puede ser "\*")
* Acci칩n --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (permisos)
* Efecto --> Allow/Deny
* Principal --> arn afectado
* Condiciones (opcional) --> Condici칩n para otorgar los permisos

Grants:

* Permiten delegar tus permisos a otro principal de AWS dentro de tu cuenta de AWS. Necesitas crearlos usando las APIs de AWS KMS. Se puede indicar el identificador de CMK, el principal beneficiario y el nivel requerido de operaci칩n (Decrypt, Encrypt, GenerateDataKey...)
* Despu칠s de crear el grant, se emiten un GrantToken y un GrantID

**Acceso**:

* V칤a **pol칤tica de clave** -- Si esto existe, toma **precedencia** sobre la pol칤tica IAM
* V칤a **pol칤tica IAM**
* V칤a **grants**

</details>

### Administradores de Claves

Administrador de claves por defecto:

* Tienen acceso para gestionar KMS pero no para cifrar o descifrar datos
* Solo usuarios y roles IAM pueden ser a침adidos a la lista de Administradores de Claves (no grupos)
* Si se usa un CMK externo, los Administradores de Claves tienen el permiso para importar material de clave

### Rotaci칩n de CMKs

* Cuanto m치s tiempo se deja la misma clave en su lugar, m치s datos se cifran con esa clave, y si esa clave se ve comprometida, entonces el 치rea de impacto de los datos en riesgo es mayor. Adem치s, cuanto m치s tiempo est칠 activa la clave, aumenta la probabilidad de que se vea comprometida.
* **KMS rota las claves de cliente cada 365 d칤as** (o puedes realizar el proceso manualmente cuando quieras) y **las claves gestionadas por AWS cada 3 a침os** y este tiempo no se puede cambiar.
* **Las claves antiguas se retienen** para descifrar datos que fueron cifrados antes de la rotaci칩n
* En una brecha, rotar la clave no eliminar치 la amenaza ya que ser치 posible descifrar todos los datos cifrados con la clave comprometida. Sin embargo, los **nuevos datos se cifrar치n con la nueva clave**.
* Si el **CMK** est치 en estado de **deshabilitado** o **pendiente** de **eliminaci칩n**, KMS **no realizar치 una rotaci칩n de clave** hasta que el CMK sea reactivado o se cancele la eliminaci칩n.

#### Rotaci칩n manual

* Se necesita **crear un nuevo CMK**, luego, se crea un nuevo CMK-ID, por lo que necesitar치s **actualizar** cualquier **aplicaci칩n** para **referenciar** el nuevo CMK-ID.
* Para hacer este proceso m치s f치cil, puedes **usar alias para referenciar un key-id** y luego solo actualizar la clave a la que se refiere el alias.
* Necesitas **mantener las claves antiguas para descifrar los archivos antiguos** cifrados con ellas.

Puedes importar claves desde tu infraestructura de claves on-premises.

### Otra informaci칩n relevante de KMS

KMS se cobra por el n칰mero de solicitudes de cifrado/descifrado recibidas de todos los servicios por mes.

KMS tiene integraci칩n completa de auditor칤a y cumplimiento con **CloudTrail**; aqu칤 es donde puedes auditar todos los cambios realizados en KMS.

Con la pol칤tica de KMS puedes hacer lo siguiente:

* Limitar qui칠n puede crear claves de datos y qu칠 servicios tienen acceso para usar estas claves
* Limitar el acceso de los sistemas solo para cifrar, solo para descifrar o ambos
* Definir para habilitar el acceso de los sistemas a claves a trav칠s de regiones (aunque no se recomienda ya que una falla en la regi칩n que aloja KMS afectar치 la disponibilidad de los sistemas en otras regiones).

No puedes sincronizar ni mover/copiar claves entre regiones; solo puedes definir reglas para permitir el acceso entre regiones.

### Enumeraci칩n
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Referencias

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
