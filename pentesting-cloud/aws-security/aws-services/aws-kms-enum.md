# AWS - KMS Enum

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## KMS - Key Management Service

AWS Key Management Service (AWS KMS) wird als verwalteter Dienst pr√§sentiert, der den Prozess f√ºr Benutzer vereinfacht, **Customer Master Keys** (CMKs) zu erstellen und zu verwalten. Diese CMKs sind integraler Bestandteil der Verschl√ºsselung von Benutzerdaten. Ein bemerkenswertes Merkmal von AWS KMS ist, dass CMKs √ºberwiegend durch **Hardware-Sicherheitsmodule** (HSMs) gesichert werden, was den Schutz der Verschl√ºsselungsschl√ºssel verbessert.

KMS verwendet **symmetrische Kryptographie**. Dies wird verwendet, um **Informationen im Ruhezustand zu verschl√ºsseln** (zum Beispiel in einem S3). Wenn du **Informationen w√§hrend der √úbertragung verschl√ºsseln** musst, musst du etwas wie **TLS** verwenden.

KMS ist ein **regionsspezifischer Dienst**.

**Administratoren bei Amazon haben keinen Zugriff auf deine Schl√ºssel**. Sie k√∂nnen deine Schl√ºssel nicht wiederherstellen und helfen dir nicht bei der Verschl√ºsselung deiner Schl√ºssel. AWS verwaltet lediglich das Betriebssystem und die zugrunde liegende Anwendung, es liegt an uns, unsere Verschl√ºsselungsschl√ºssel zu verwalten und zu steuern, wie diese Schl√ºssel verwendet werden.

**Customer Master Keys** (CMK): K√∂nnen Daten bis zu einer Gr√∂√üe von 4KB verschl√ºsseln. Sie werden typischerweise verwendet, um die DEKs (Data Encryption Keys) zu erstellen, zu verschl√ºsseln und zu entschl√ºsseln. Dann werden die DEKs verwendet, um die Daten zu verschl√ºsseln.

Ein Customer Master Key (CMK) ist eine logische Darstellung eines Master-Schl√ºssels in AWS KMS. Zus√§tzlich zu den Identifikatoren und anderen Metadaten des Master-Schl√ºssels, einschlie√ülich seines Erstellungsdatums, seiner Beschreibung und seines Schl√ºsselzustands, enth√§lt ein **CMK das Schl√ºsselmaterial, das zur Verschl√ºsselung und Entschl√ºsselung von Daten verwendet wird**. Wenn du einen CMK erstellst, generiert AWS KMS standardm√§√üig das Schl√ºsselmaterial f√ºr diesen CMK. Du kannst jedoch auch w√§hlen, einen CMK ohne Schl√ºsselmaterial zu erstellen und dann dein eigenes Schl√ºsselmaterial in diesen CMK zu importieren.

Es gibt 2 Arten von Master-Schl√ºsseln:

* **AWS verwaltete CMKs: Werden von anderen Diensten zur Verschl√ºsselung von Daten verwendet**. Sie werden von dem Dienst verwendet, der sie in einer Region erstellt hat. Sie werden das erste Mal erstellt, wenn du die Verschl√ºsselung in diesem Dienst implementierst. Sie rotieren alle 3 Jahre und es ist nicht m√∂glich, dies zu √§ndern.
* **Customer Manager CMKs**: Flexibilit√§t, Rotation, konfigurierbarer Zugriff und Schl√ºsselrichtlinie. Aktivieren und Deaktivieren von Schl√ºsseln.

**Envelope Encryption** im Kontext des Key Management Service (KMS): Zwei-Ebenen-Hierarchiesystem zur **Verschl√ºsselung von Daten mit einem Datenschl√ºssel und anschlie√üender Verschl√ºsselung des Datenschl√ºssels mit einem Master-Schl√ºssel**.

### Key Policies

Diese definieren, **wer einen Schl√ºssel in KMS verwenden und darauf zugreifen kann**.

Standardm√§√üig:

*   Es gibt dem **AWS-Konto, dem der KMS-Schl√ºssel geh√∂rt, vollen Zugriff** auf den KMS-Schl√ºssel.

Im Gegensatz zu anderen AWS-Ressourcenrichtlinien gew√§hrt eine AWS **KMS-Schl√ºsselrichtlinie nicht automatisch dem Konto oder einem seiner Benutzer Berechtigungen**. Um dem Konto-Administrator Berechtigungen zu erteilen, muss die **Schl√ºsselrichtlinie eine explizite Anweisung** enthalten, die diese Berechtigung erteilt, wie diese hier.

* Ohne die Erlaubnis des Kontos (`"AWS": "arn:aws:iam::111122223333:root"`) funktionieren IAM-Berechtigungen nicht.
*   Es **erm√∂glicht dem Konto, IAM-Richtlinien zu verwenden**, um zus√§tzlich zur Schl√ºsselrichtlinie Zugriff auf den KMS-Schl√ºssel zu gew√§hren.

**Ohne diese Berechtigung sind IAM-Richtlinien, die den Zugriff auf den Schl√ºssel erlauben, unwirksam**, obwohl IAM-Richtlinien, die den Zugriff auf den Schl√ºssel verweigern, weiterhin wirksam sind.
* Es **reduziert das Risiko, dass der Schl√ºssel unverwaltbar wird**, indem es den Kontoadministratoren, einschlie√ülich des Root-Benutzers des Kontos, der nicht gel√∂scht werden kann, Zugriffssteuerungsberechtigungen erteilt.

**Standardrichtlinie** Beispiel:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Wenn das **Konto erlaubt ist** (`"arn:aws:iam::111122223333:root"`), ben√∂tigt ein **Principal** aus dem Konto **trotzdem IAM-Berechtigungen**, um den KMS-Schl√ºssel zu verwenden. Wenn jedoch die **ARN** einer Rolle beispielsweise **speziell in der** **Schl√ºsselrichtlinie** **erlaubt** ist, ben√∂tigt diese Rolle **keine IAM-Berechtigungen**.
{% endhint %}

<details>

<summary>Richtliniendetails</summary>

Eigenschaften einer Richtlinie:

* JSON-basiertes Dokument
* Resource --> Betroffene Ressourcen (kann "\*" sein)
* Action --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (Berechtigungen)
* Effect --> Allow/Deny
* Principal --> betroffene arn
* Conditions (optional) --> Bedingung zur Erteilung der Berechtigungen

Grants:

* Erlaubt es, Ihre Berechtigungen an einen anderen AWS-Principal innerhalb Ihres AWS-Kontos zu delegieren. Sie m√ºssen diese mit den AWS KMS APIs erstellen. Es kann der CMK-Identifier, der beg√ºnstigte Principal und das erforderliche Betriebsniveau (Decrypt, Encrypt, GenerateDataKey...) angegeben werden.
* Nach der Erstellung des Grants werden ein GrantToken und eine GrantID ausgegeben.

**Zugriff**:

* √úber **Schl√ºsselrichtlinie** -- Wenn diese existiert, hat sie **Vorrang** vor der IAM-Richtlinie
* √úber **IAM-Richtlinie**
* √úber **Grants**

</details>

### Schl√ºsseladministratoren

Standardm√§√üig haben Schl√ºsseladministratoren:

* Zugriff auf die Verwaltung von KMS, aber nicht auf das Verschl√ºsseln oder Entschl√ºsseln von Daten
* Nur IAM-Benutzer und -Rollen k√∂nnen zur Liste der Schl√ºsseladministratoren hinzugef√ºgt werden (keine Gruppen)
* Wenn ein externer CMK verwendet wird, haben Schl√ºsseladministratoren die Berechtigung, Schl√ºsselmaterial zu importieren

### Rotation von CMKs

* Je l√§nger derselbe Schl√ºssel verwendet wird, desto mehr Daten werden mit diesem Schl√ºssel verschl√ºsselt, und wenn dieser Schl√ºssel kompromittiert wird, desto gr√∂√üer ist der betroffene Datenbereich. Dar√ºber hinaus steigt die Wahrscheinlichkeit, dass der Schl√ºssel kompromittiert wird, je l√§nger er aktiv ist.
* **KMS rotiert Kundenschl√ºssel alle 365 Tage** (oder Sie k√∂nnen den Prozess manuell durchf√ºhren, wann immer Sie m√∂chten) und **von AWS verwaltete Schl√ºssel alle 3 Jahre**, und diese Zeit kann nicht ge√§ndert werden.
* **√Ñltere Schl√ºssel werden beibehalten**, um Daten zu entschl√ºsseln, die vor der Rotation verschl√ºsselt wurden.
* Im Falle eines Bruchs wird durch die Rotation des Schl√ºssels die Bedrohung nicht beseitigt, da es m√∂glich sein wird, alle mit dem kompromittierten Schl√ºssel verschl√ºsselten Daten zu entschl√ºsseln. Allerdings werden die **neuen Daten mit dem neuen Schl√ºssel verschl√ºsselt**.
* Wenn **CMK** im Zustand **deaktiviert** oder **zur L√∂schung anstehend** ist, wird KMS **keine Schl√ºsselrotation durchf√ºhren**, bis der CMK wieder aktiviert oder die L√∂schung abgebrochen wird.

#### Manuelle Rotation

* Ein **neuer CMK muss erstellt werden**, dann wird eine neue CMK-ID erstellt, sodass Sie **jede Anwendung aktualisieren** m√ºssen, um auf die neue CMK-ID zu verweisen.
* Um diesen Prozess zu erleichtern, k√∂nnen Sie **Aliase verwenden, um auf eine Schl√ºssel-ID zu verweisen** und dann einfach den Schl√ºssel aktualisieren, auf den der Alias verweist.
* Sie m√ºssen **alte Schl√ºssel behalten, um alte Dateien zu entschl√ºsseln**, die damit verschl√ºsselt wurden.

Sie k√∂nnen Schl√ºssel aus Ihrer lokalen Schl√ºsselinfrastruktur importieren.

### Weitere relevante KMS-Informationen

KMS wird pro Anzahl der Verschl√ºsselungs-/Entschl√ºsselungsanforderungen berechnet, die von allen Diensten pro Monat empfangen werden.

KMS hat eine vollst√§ndige Audit- und Compliance-**Integration mit CloudTrail**; hier k√∂nnen Sie alle √Ñnderungen an KMS √ºberpr√ºfen.

Mit der KMS-Richtlinie k√∂nnen Sie Folgendes tun:

* Begrenzen, wer Datenschl√ºssel erstellen kann und welche Dienste Zugriff auf diese Schl√ºssel haben
* Systemzugriff nur auf Verschl√ºsselung, nur auf Entschl√ºsselung oder beides beschr√§nken
* Definieren, um Systemen den Zugriff auf Schl√ºssel √ºber Regionen hinweg zu erm√∂glichen (obwohl dies nicht empfohlen wird, da ein Ausfall in der Region, die KMS hostet, die Verf√ºgbarkeit von Systemen in anderen Regionen beeintr√§chtigen wird).

Sie k√∂nnen Schl√ºssel nicht √ºber Regionen hinweg synchronisieren oder verschieben/kopieren; Sie k√∂nnen nur Regeln definieren, um den Zugriff √ºber Regionen hinweg zu erm√∂glichen.

### Enumeration
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Referenzen

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
