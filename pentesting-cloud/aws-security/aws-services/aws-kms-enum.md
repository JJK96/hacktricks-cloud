# AWS - KMS Enum

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporte HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios no github.

</details>
{% endhint %}

## KMS - Key Management Service

AWS Key Management Service (AWS KMS) √© apresentado como um servi√ßo gerenciado, simplificando o processo para os usu√°rios **criarem e gerenciarem chaves mestras de cliente** (CMKs). Essas CMKs s√£o essenciais na criptografia de dados do usu√°rio. Uma caracter√≠stica not√°vel do AWS KMS √© que as CMKs s√£o predominantemente **protegidas por m√≥dulos de seguran√ßa de hardware** (HSMs), aumentando a prote√ß√£o das chaves de criptografia.

KMS usa **criptografia sim√©trica**. Isso √© usado para **criptografar informa√ß√µes em repouso** (por exemplo, dentro de um S3). Se voc√™ precisar **criptografar informa√ß√µes em tr√¢nsito**, voc√™ precisa usar algo como **TLS**.

KMS √© um **servi√ßo espec√≠fico de regi√£o**.

**Administradores da Amazon n√£o t√™m acesso √†s suas chaves**. Eles n√£o podem recuperar suas chaves e n√£o ajudam voc√™ com a criptografia de suas chaves. A AWS simplesmente administra o sistema operacional e a aplica√ß√£o subjacente, cabe a n√≥s administrar nossas chaves de criptografia e administrar como essas chaves s√£o usadas.

**Customer Master Keys** (CMK): Podem criptografar dados de at√© 4KB de tamanho. Elas s√£o tipicamente usadas para criar, criptografar e descriptografar as DEKs (Data Encryption Keys). Ent√£o as DEKs s√£o usadas para criptografar os dados.

Uma chave mestra de cliente (CMK) √© uma representa√ß√£o l√≥gica de uma chave mestra no AWS KMS. Al√©m dos identificadores da chave mestra e outros metadados, incluindo sua data de cria√ß√£o, descri√ß√£o e estado da chave, uma **CMK cont√©m o material da chave que √© usado para criptografar e descriptografar dados**. Quando voc√™ cria uma CMK, por padr√£o, o AWS KMS gera o material da chave para essa CMK. No entanto, voc√™ pode optar por criar uma CMK sem material de chave e, em seguida, importar seu pr√≥prio material de chave para essa CMK.

Existem 2 tipos de chaves mestras:

* **AWS managed CMKs: Usadas por outros servi√ßos para criptografar dados**. √â usada pelo servi√ßo que a criou em uma regi√£o. Elas s√£o criadas na primeira vez que voc√™ implementa a criptografia nesse servi√ßo. Rotaciona a cada 3 anos e n√£o √© poss√≠vel alter√°-la.
* **Customer manager CMKs**: Flexibilidade, rota√ß√£o, acesso configur√°vel e pol√≠tica de chave. Habilitar e desabilitar chaves.

**Envelope Encryption** no contexto do Key Management Service (KMS): Sistema de hierarquia de dois n√≠veis para **criptografar dados com chave de dados e depois criptografar a chave de dados com chave mestra**.

### Key Policies

Estas definem **quem pode usar e acessar uma chave no KMS**.

Por **padr√£o:**

*   D√° √† **conta AWS que possui a chave KMS acesso total** √† chave KMS.

Ao contr√°rio de outras pol√≠ticas de recursos da AWS, uma **pol√≠tica de chave KMS da AWS n√£o concede automaticamente permiss√£o √† conta ou a qualquer um de seus usu√°rios**. Para conceder permiss√£o aos administradores da conta, a **pol√≠tica de chave deve incluir uma declara√ß√£o expl√≠cita** que forne√ßa essa permiss√£o, como esta.

* Sem permitir a conta(`"AWS": "arn:aws:iam::111122223333:root"`) permiss√µes IAM n√£o funcionar√£o.
*   Permite que a **conta use pol√≠ticas IAM** para permitir acesso √† chave KMS, al√©m da pol√≠tica de chave.

**Sem essa permiss√£o, as pol√≠ticas IAM que permitem acesso √† chave s√£o ineficazes**, embora as pol√≠ticas IAM que negam acesso √† chave ainda sejam eficazes.
* Reduz o **risco de a chave se tornar inadministr√°vel** ao conceder permiss√£o de controle de acesso aos administradores da conta, incluindo o usu√°rio root da conta, que n√£o pode ser exclu√≠do.

**Exemplo de pol√≠tica padr√£o**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Se a **conta for permitida** (`"arn:aws:iam::111122223333:root"`) um **principal** da conta **ainda precisar√° de permiss√µes IAM** para usar a chave KMS. No entanto, se o **ARN** de uma fun√ß√£o, por exemplo, for **especificamente permitido** na **Pol√≠tica de Chave**, essa fun√ß√£o **n√£o precisa de permiss√µes IAM**.
{% endhint %}

<details>

<summary>Detalhes da Pol√≠tica</summary>

Propriedades de uma pol√≠tica:

* Documento baseado em JSON
* Recurso --> Recursos afetados (pode ser "\*")
* A√ß√£o --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (permiss√µes)
* Efeito --> Allow/Deny
* Principal --> arn afetado
* Condi√ß√µes (opcional) --> Condi√ß√£o para conceder as permiss√µes

Grants:

* Permite delegar suas permiss√µes a outro principal AWS dentro da sua conta AWS. Voc√™ precisa cri√°-los usando as APIs AWS KMS. Pode ser indicado o identificador CMK, o principal benefici√°rio e o n√≠vel de opera√ß√£o necess√°rio (Decrypt, Encrypt, GenerateDataKey...)
* Ap√≥s a cria√ß√£o do grant, um GrantToken e um GrantID s√£o emitidos

**Acesso**:

* Via **pol√≠tica de chave** -- Se isso existir, tem **preced√™ncia** sobre a pol√≠tica IAM
* Via **pol√≠tica IAM**
* Via **grants**

</details>

### Administradores de Chave

Administrador de chave por padr√£o:

* Tem acesso para gerenciar KMS, mas n√£o para criptografar ou descriptografar dados
* Somente usu√°rios e fun√ß√µes IAM podem ser adicionados √† lista de Administradores de Chave (n√£o grupos)
* Se CMK externo for usado, os Administradores de Chave t√™m permiss√£o para importar material de chave

### Rota√ß√£o de CMKs

* Quanto mais tempo a mesma chave √© mantida, mais dados s√£o criptografados com essa chave, e se essa chave for comprometida, maior ser√° a √°rea de impacto dos dados em risco. Al√©m disso, quanto mais tempo a chave estiver ativa, maior ser√° a probabilidade de ser comprometida.
* **KMS rotaciona chaves de clientes a cada 365 dias** (ou voc√™ pode realizar o processo manualmente sempre que quiser) e **chaves gerenciadas pela AWS a cada 3 anos** e esse tempo n√£o pode ser alterado.
* **Chaves antigas s√£o mantidas** para descriptografar dados que foram criptografados antes da rota√ß√£o
* Em caso de viola√ß√£o, rotacionar a chave n√£o remover√° a amea√ßa, pois ser√° poss√≠vel descriptografar todos os dados criptografados com a chave comprometida. No entanto, os **novos dados ser√£o criptografados com a nova chave**.
* Se o **CMK** estiver no estado de **desativado** ou **pendente** de **exclus√£o**, o KMS **n√£o realizar√° uma rota√ß√£o de chave** at√© que o CMK seja reativado ou a exclus√£o seja cancelada.

#### Rota√ß√£o manual

* Um **novo CMK precisa ser criado**, ent√£o, um novo CMK-ID √© criado, portanto, voc√™ precisar√° **atualizar** qualquer **aplica√ß√£o** para **referenciar** o novo CMK-ID.
* Para facilitar esse processo, voc√™ pode **usar aliases para se referir a um key-id** e ent√£o apenas atualizar a chave √† qual o alias se refere.
* Voc√™ precisa **manter as chaves antigas para descriptografar arquivos antigos** criptografados com elas.

Voc√™ pode importar chaves da sua infraestrutura de chaves on-premises.

### Outras informa√ß√µes relevantes do KMS

O KMS √© cobrado pelo n√∫mero de solicita√ß√µes de criptografia/descriptografia recebidas de todos os servi√ßos por m√™s.

O KMS tem integra√ß√£o completa de auditoria e conformidade com o **CloudTrail**; √© aqui que voc√™ pode auditar todas as mudan√ßas realizadas no KMS.

Com a pol√≠tica do KMS, voc√™ pode fazer o seguinte:

* Limitar quem pode criar chaves de dados e quais servi√ßos t√™m acesso para usar essas chaves
* Limitar o acesso dos sistemas apenas para criptografar, apenas para descriptografar ou ambos
* Definir para permitir que os sistemas acessem chaves entre regi√µes (embora n√£o seja recomendado, pois uma falha na regi√£o que hospeda o KMS afetar√° a disponibilidade dos sistemas em outras regi√µes).

Voc√™ n√£o pode sincronizar ou mover/copiar chaves entre regi√µes; voc√™ s√≥ pode definir regras para permitir o acesso entre regi√µes.

### Enumera√ß√£o
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### P√≥s-Explota√ß√£o

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persist√™ncia

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
