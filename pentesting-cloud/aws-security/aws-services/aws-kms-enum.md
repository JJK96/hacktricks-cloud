# AWS - KMS Enum

{% hint style="success" %}
Leer en oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer en oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## KMS - Sleutelbestuurdiens

AWS Key Management Service (AWS KMS) word aangebied as 'n bestuurde diens, wat die proses vir gebruikers vereenvoudig om **klantmeestersleutels** (CMKs) te skep en te bestuur. Hierdie CMKs is integraal in die enkripsie van gebruikersdata. 'n Opvallende kenmerk van AWS KMS is dat CMKs hoofsaaklik **beveilig word deur hardeware-sekuriteitsmodules** (HSMs), wat die beskerming van die enkripsiesleutels verbeter.

KMS gebruik **simmetriese kriptografie**. Dit word gebruik om **inligting in rus te enkripteer** (byvoorbeeld, binne 'n S3). As jy **inligting in transito moet enkripteer** moet jy iets soos **TLS** gebruik.

KMS is 'n **streekspesifieke diens**.

**Administrateurs by Amazon het nie toegang tot jou sleutels nie**. Hulle kan nie jou sleutels herstel nie en hulle help jou nie met die enkripsie van jou sleutels nie. AWS administreer eenvoudig die bedryfstelsel en die onderliggende toepassing; dit is ons verantwoordelikheid om ons enkripsiesleutels te administreer en te beheer hoe daardie sleutels gebruik word.

**Klantmeestersleutels** (CMK): Kan data tot 4KB in grootte enkripteer. Hulle word tipies gebruik om die DEKs (Data Encryption Keys) te skep, te enkripteer en te dekripteer. Dan word die DEKs gebruik om die data te enkripteer.

'n Klantmeestersleutel (CMK) is 'n logiese voorstelling van 'n meestersleutel in AWS KMS. Benewens die meestersleutel se identifiseerders en ander metadata, insluitend die skeppingsdatum, beskrywing en sleuteltoestand, bevat 'n **CMK die sleutelmateriaal wat gebruik word om data te enkripteer en te dekripteer**. Wanneer jy 'n CMK skep, genereer AWS KMS standaard die sleutelmateriaal vir daardie CMK. Jy kan egter kies om 'n CMK sonder sleutelmateriaal te skep en dan jou eie sleutelmateriaal in daardie CMK in te voer.

Daar is 2 tipes meestersleutels:

* **AWS bestuurde CMKs: Gebruik deur ander dienste om data te enkripteer**. Dit word gebruik deur die diens wat dit in 'n streek geskep het. Hulle word geskep die eerste keer wat jy die enkripsie in daardie diens implementeer. Roteer elke 3 jaar en dit is nie moontlik om dit te verander nie.
* **Klantbestuurder CMKs**: Buigsaamheid, rotasie, konfigureerbare toegang en sleutelbeleid. Aktiveer en deaktiveer sleutels.

**Omslag-enkripsie** in die konteks van Sleutelbestuurdiens (KMS): Twee-vlak hi√´rargie-stelsel om **data met 'n datasleutel te enkripteer en dan die datasleutel met 'n meestersleutel te enkripteer**.

### Sleutelbeleide

Hierdie definieer **wie 'n sleutel in KMS kan gebruik en toegang daartoe het**.

Deur **standaard:**

* Dit gee die **AWS-rekening wat die KMS-sleutel besit volle toegang** tot die KMS-sleutel.

Anders as ander AWS-hulpbronbeleide, gee 'n AWS **KMS-sleutelbeleid nie outomaties toestemming aan die rekening of enige van sy gebruikers nie**. Om toestemming aan rekeningadministrateurs te gee, moet die **sleutelbeleid 'n eksplisiete verklaring insluit** wat hierdie toestemming verskaf, soos hierdie een.

* Sonder om die rekening toe te laat (`"AWS": "arn:aws:iam::111122223333:root"`) sal IAM-toestemmings nie werk nie.
* Dit **laat die rekening toe om IAM-beleide te gebruik** om toegang tot die KMS-sleutel toe te laat, benewens die sleutelbeleid.

**Sonder hierdie toestemming is IAM-beleide wat toegang tot die sleutel toelaat, ondoeltreffend**, alhoewel IAM-beleide wat toegang tot die sleutel weier steeds effektief is.
* Dit **verminder die risiko dat die sleutel onbeheerbaar raak** deur toegangbeheer-toestemming aan die rekeningadministrateurs te gee, insluitend die rekeningwortelgebruiker, wat nie uitgevee kan word nie.

**Standaardbeleid** voorbeeld:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
As die **rekening toegelaat word** (`"arn:aws:iam::111122223333:root"`) sal 'n **hoof** van die rekening **nog steeds IAM-permissies nodig h√™** om die KMS-sleutel te gebruik. As die **ARN** van 'n rol byvoorbeeld **spesifiek toegelaat word** in die **Sleutelbeleid**, het daardie rol **nie IAM-permissies nodig nie**.
{% endhint %}

<details>

<summary>Beleidsbesonderhede</summary>

Eienskappe van 'n beleid:

* JSON-gebaseerde dokument
* Hulpbron --> Betrokke hulpbronne (kan "\*" wees)
* Aksie --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (permissies)
* Effek --> Toelaat/Weier
* Hoof --> betrokke arn
* Voorwaardes (opsioneel) --> Voorwaarde om die permissies te gee

Toekennings:

* Laat toe om jou permissies aan 'n ander AWS-hoof binne jou AWS-rekening te delegeer. Jy moet dit skep deur die AWS KMS APIs te gebruik. Dit kan die CMK-identifiseerder, die begunstigde hoof en die vereiste vlak van operasie (Decrypt, Encrypt, GenerateDataKey...) aandui.
* Nadat die toekenning geskep is, word 'n GrantToken en 'n GrantID uitgereik.

**Toegang**:

* Via **sleutelbeleid** -- As dit bestaan, neem dit **voorrang** bo die IAM-beleid
* Via **IAM-beleid**
* Via **toekennings**

</details>

### Sleuteladministrateurs

Sleuteladministrateur standaard:

* Het toegang om KMS te bestuur, maar nie om data te enkripteer of dekripteer nie
* Slegs IAM-gebruikers en -rolle kan by die Sleuteladministrateurslys gevoeg word (nie groepe nie)
* As eksterne CMK gebruik word, het Sleuteladministrateurs die toestemming om sleutelmateriaal in te voer

### Rotasie van CMKs

* Hoe langer dieselfde sleutel in plek gelaat word, hoe meer data word met daardie sleutel ge√´nkripteer, en as daardie sleutel gekompromitteer word, is die groter die risiko-area van data. Daarbenewens, hoe langer die sleutel aktief is, hoe groter is die waarskynlikheid dat dit gekompromitteer word.
* **KMS roteer klant-sleutels elke 365 dae** (of jy kan die proses handmatig uitvoer wanneer jy wil) en **sleutels wat deur AWS bestuur word elke 3 jaar** en hierdie tyd kan nie verander word nie.
* **Ouer sleutels word behou** om data te dekripteer wat voor die rotasie ge√´nkripteer is.
* In 'n breuk, sal die rotasie van die sleutel nie die bedreiging verwyder nie, aangesien dit moontlik sal wees om al die data wat met die gekompromitteerde sleutel ge√´nkripteer is, te dekripteer. Die **nuwe data sal egter met die nuwe sleutel ge√´nkripteer word**.
* As **CMK** in 'n toestand van **gedeaktiveer** of **hangende** **verwydering** is, sal KMS **nie 'n sleutelrotasie uitvoer nie** totdat die CMK heraktiveer of verwydering gekanselleer is.

#### Handmatige rotasie

* 'n **Nuwe CMK moet geskep word**, dan word 'n nuwe CMK-ID geskep, so jy sal enige **toepassing** moet **opdateer** om na die nuwe CMK-ID te **verwys**.
* Om hierdie proses makliker te maak, kan jy **aliasse gebruik om na 'n sleutel-ID te verwys** en dan net die sleutel opdateer waarna die alias verwys.
* Jy moet **ou sleutels behou om ou l√™ers te dekripteer** wat daarmee ge√´nkripteer is.

Jy kan sleutels van jou plaaslike sleutelinfrastruktuur invoer.

### Ander relevante KMS-inligting

KMS word geprys per aantal enkripsie-/dekripsieversoeke wat van alle dienste per maand ontvang word.

KMS het volledige oudit- en nakomingsintegrasie **met CloudTrail**; dit is waar jy alle veranderinge wat op KMS uitgevoer is, kan oudit.

Met KMS-beleid kan jy die volgende doen:

* Beperk wie data-sleutels kan skep en watter dienste toegang het om hierdie sleutels te gebruik
* Beperk stelsels se toegang tot slegs enkripteer, slegs dekripteer of beide
* Definieer om stelsels in staat te stel om toegang tot sleutels oor streke heen te h√™ (alhoewel dit nie aanbeveel word nie, aangesien 'n mislukking in die streek wat KMS huisves, die beskikbaarheid van stelsels in ander streke sal be√Ønvloed).

Jy kan nie sleutels oor streke sinchroniseer of skuif/kopieer nie; jy kan slegs re√´ls definieer om toegang oor streke toe te laat.

### Enumerasie
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Verwysings

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
