# AWS - KMS Enum

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository github.

</details>
{% endhint %}

## KMS - Key Management Service

AWS Key Management Service (AWS KMS) √® presentato come un servizio gestito, semplificando il processo per gli utenti di **creare e gestire chiavi master dei clienti** (CMK). Queste CMK sono fondamentali per la crittografia dei dati degli utenti. Una caratteristica notevole di AWS KMS √® che le CMK sono prevalentemente **protette da moduli di sicurezza hardware** (HSM), migliorando la protezione delle chiavi di crittografia.

KMS utilizza la **crittografia simmetrica**. Questa viene utilizzata per **crittografare le informazioni a riposo** (ad esempio, all'interno di un S3). Se hai bisogno di **crittografare le informazioni in transito** devi usare qualcosa come **TLS**.

KMS √® un **servizio specifico per regione**.

**Gli amministratori di Amazon non hanno accesso alle tue chiavi**. Non possono recuperare le tue chiavi e non ti aiutano con la crittografia delle tue chiavi. AWS si limita ad amministrare il sistema operativo e l'applicazione sottostante, sta a noi amministrare le nostre chiavi di crittografia e amministrare come vengono utilizzate quelle chiavi.

**Customer Master Keys** (CMK): Possono crittografare dati fino a 4KB di dimensione. Sono tipicamente utilizzate per creare, crittografare e decrittografare le DEK (Data Encryption Keys). Poi le DEK vengono utilizzate per crittografare i dati.

Una customer master key (CMK) √® una rappresentazione logica di una chiave master in AWS KMS. Oltre agli identificatori della chiave master e ad altri metadati, inclusi la data di creazione, la descrizione e lo stato della chiave, una **CMK contiene il materiale della chiave utilizzato per crittografare e decrittografare i dati**. Quando crei una CMK, per impostazione predefinita, AWS KMS genera il materiale della chiave per quella CMK. Tuttavia, puoi scegliere di creare una CMK senza materiale della chiave e poi importare il tuo materiale della chiave in quella CMK.

Ci sono 2 tipi di chiavi master:

* **AWS managed CMKs: Utilizzate da altri servizi per crittografare i dati**. Viene utilizzata dal servizio che l'ha creata in una regione. Vengono create la prima volta che implementi la crittografia in quel servizio. Ruotano ogni 3 anni e non √® possibile cambiarle.
* **Customer manager CMKs**: Flessibilit√†, rotazione, accesso configurabile e politica delle chiavi. Abilita e disabilita le chiavi.

**Envelope Encryption** nel contesto del Key Management Service (KMS): Sistema gerarchico a due livelli per **crittografare i dati con la chiave dei dati e poi crittografare la chiave dei dati con la chiave master**.

### Key Policies

Queste definiscono **chi pu√≤ utilizzare e accedere a una chiave in KMS**.

Per **impostazione predefinita:**

*   D√† al **conto AWS che possiede la chiave KMS pieno accesso** alla chiave KMS.

A differenza di altre politiche delle risorse AWS, una **politica delle chiavi KMS di AWS non concede automaticamente il permesso al conto o a uno qualsiasi dei suoi utenti**. Per concedere il permesso agli amministratori del conto, la **politica delle chiavi deve includere una dichiarazione esplicita** che fornisca questo permesso, come questa.

* Senza consentire al conto (`"AWS": "arn:aws:iam::111122223333:root"`) i permessi IAM non funzioneranno.
*   Consente al conto di **utilizzare le politiche IAM** per consentire l'accesso alla chiave KMS, oltre alla politica delle chiavi.

**Senza questo permesso, le politiche IAM che consentono l'accesso alla chiave sono inefficaci**, sebbene le politiche IAM che negano l'accesso alla chiave siano ancora efficaci.
* Riduce il **rischio che la chiave diventi ingovernabile** concedendo il permesso di controllo dell'accesso agli amministratori del conto, incluso l'utente root del conto, che non pu√≤ essere eliminato.

**Esempio di politica predefinita**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Se l'**account √® consentito** (`"arn:aws:iam::111122223333:root"`) un **principale** dell'account **avr√† comunque bisogno di permessi IAM** per utilizzare la chiave KMS. Tuttavia, se l'**ARN** di un ruolo, ad esempio, √® **specificamente consentito** nella **Key Policy**, quel ruolo **non ha bisogno di permessi IAM**.
{% endhint %}

<details>

<summary>Dettagli della Policy</summary>

Propriet√† di una policy:

* Documento basato su JSON
* Resource --> Risorse interessate (pu√≤ essere "\*")
* Action --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (permessi)
* Effect --> Allow/Deny
* Principal --> arn interessato
* Conditions (opzionale) --> Condizione per concedere i permessi

Grants:

* Permettono di delegare i tuoi permessi a un altro principale AWS all'interno del tuo account AWS. √à necessario crearli utilizzando le API AWS KMS. Pu√≤ essere indicato l'identificatore CMK, il principale beneficiario e il livello di operazione richiesto (Decrypt, Encrypt, GenerateDataKey...)
* Dopo la creazione del grant, vengono emessi un GrantToken e un GrantID

**Accesso**:

* Tramite **key policy** -- Se esiste, questa ha **precedenza** sulla policy IAM
* Tramite **policy IAM**
* Tramite **grants**

</details>

### Amministratori delle Chiavi

Amministratore delle chiavi per impostazione predefinita:

* Ha accesso per gestire KMS ma non per criptare o decriptare dati
* Solo utenti IAM e ruoli possono essere aggiunti alla lista degli Amministratori delle Chiavi (non gruppi)
* Se viene utilizzato un CMK esterno, gli Amministratori delle Chiavi hanno il permesso di importare il materiale della chiave

### Rotazione dei CMK

* Pi√π a lungo la stessa chiave rimane in uso, pi√π dati vengono criptati con quella chiave, e se quella chiave viene compromessa, allora l'area di rischio dei dati √® pi√π ampia. Inoltre, pi√π a lungo la chiave √® attiva, maggiore √® la probabilit√† che venga compromessa.
* **KMS ruota le chiavi dei clienti ogni 365 giorni** (o puoi eseguire il processo manualmente quando vuoi) e **le chiavi gestite da AWS ogni 3 anni** e questo tempo non pu√≤ essere modificato.
* **Le chiavi pi√π vecchie vengono mantenute** per decriptare i dati criptati prima della rotazione
* In caso di compromissione, ruotare la chiave non eliminer√† la minaccia poich√© sar√† possibile decriptare tutti i dati criptati con la chiave compromessa. Tuttavia, i **nuovi dati saranno criptati con la nuova chiave**.
* Se il **CMK** √® in stato di **disabilitato** o **in attesa** di **cancellazione**, KMS **non eseguir√† una rotazione della chiave** fino a quando il CMK non verr√† riabilitato o la cancellazione annullata.

#### Rotazione manuale

* √à necessario **creare un nuovo CMK**, quindi viene creato un nuovo CMK-ID, quindi sar√† necessario **aggiornare** qualsiasi **applicazione** per **fare riferimento** al nuovo CMK-ID.
* Per rendere questo processo pi√π semplice, puoi **usare alias per fare riferimento a un key-id** e poi aggiornare semplicemente la chiave a cui l'alias fa riferimento.
* √à necessario **mantenere le vecchie chiavi per decriptare i vecchi file** criptati con esse.

Puoi importare chiavi dalla tua infrastruttura di chiavi on-premises.

### Altre informazioni rilevanti su KMS

KMS √® tariffato per numero di richieste di criptazione/decriptazione ricevute da tutti i servizi al mese.

KMS ha piena integrazione di audit e conformit√† con **CloudTrail**; qui puoi auditare tutte le modifiche eseguite su KMS.

Con la policy KMS puoi fare quanto segue:

* Limitare chi pu√≤ creare chiavi di dati e quali servizi hanno accesso per utilizzare queste chiavi
* Limitare l'accesso dei sistemi solo a criptare, solo a decriptare o entrambi
* Definire per abilitare i sistemi ad accedere alle chiavi tra regioni (anche se non √® raccomandato poich√© un fallimento nella regione che ospita KMS influenzer√† la disponibilit√† dei sistemi in altre regioni).

Non puoi sincronizzare o spostare/copiare chiavi tra regioni; puoi solo definire regole per consentire l'accesso tra regioni.

### Enumerazione
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Riferimenti

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}
