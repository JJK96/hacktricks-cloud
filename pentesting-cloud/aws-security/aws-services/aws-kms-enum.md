# AWS - KMS Enum

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –ø–æ–¥–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}

## KMS - Key Management Service

AWS Key Management Service (AWS KMS) –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π —è–∫ –∫–µ—Ä–æ–≤–∞–Ω–∞ —Å–ª—É–∂–±–∞, —â–æ —Å–ø—Ä–æ—â—É—î –ø—Ä–æ—Ü–µ—Å –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ **—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–ª—é—á–∞–º–∏ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞** (CMKs). –¶—ñ CMKs —î –Ω–µ–≤—ñ–¥'—î–º–Ω–æ—é —á–∞—Å—Ç–∏–Ω–æ—é —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤. –í–∞–∂–ª–∏–≤–æ—é –æ—Å–æ–±–ª–∏–≤—ñ—Å—Ç—é AWS KMS —î —Ç–µ, —â–æ CMKs –ø–µ—Ä–µ–≤–∞–∂–Ω–æ **–∑–∞—Ö–∏—â–µ–Ω—ñ –∞–ø–∞—Ä–∞—Ç–Ω–∏–º–∏ –º–æ–¥—É–ª—è–º–∏ –±–µ–∑–ø–µ–∫–∏** (HSMs), —â–æ –ø—ñ–¥–≤–∏—â—É—î –∑–∞—Ö–∏—Å—Ç –∫–ª—é—á—ñ–≤ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è.

KMS –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **—Å–∏–º–µ—Ç—Ä–∏—á–Ω—É –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—ñ—é**. –¶–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è **—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –≤ —Å—Ç–∞–Ω—ñ —Å–ø–æ–∫–æ—é** (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ S3). –Ø–∫—â–æ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ **—à–∏—Ñ—Ä—É–≤–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—ñ–¥ —á–∞—Å –ø–µ—Ä–µ–¥–∞—á—ñ**, –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —â–æ—Å—å –Ω–∞ –∫—à—Ç–∞–ª—Ç **TLS**.

KMS —î **—Ä–µ–≥—ñ–æ–Ω–∞–ª—å–Ω–æ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–æ—é —Å–ª—É–∂–±–æ—é**.

**–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ Amazon –Ω–µ –º–∞—é—Ç—å –¥–æ—Å—Ç—É–ø—É –¥–æ –≤–∞—à–∏—Ö –∫–ª—é—á—ñ–≤**. –í–æ–Ω–∏ –Ω–µ –º–æ–∂—É—Ç—å –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –≤–∞—à—ñ –∫–ª—é—á—ñ —ñ –Ω–µ –¥–æ–ø–æ–º–∞–≥–∞—é—Ç—å –≤–∞–º –∑ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è–º –≤–∞—à–∏—Ö –∫–ª—é—á—ñ–≤. AWS –ø—Ä–æ—Å—Ç–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É—î –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω—É —Å–∏—Å—Ç–µ–º—É —Ç–∞ –ø—ñ–¥–ª–µ–≥–ª–∏–π –¥–æ–¥–∞—Ç–æ–∫, –∞ –Ω–∞–º –Ω–∞–ª–µ–∂–∏—Ç—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞—Ç–∏ –Ω–∞—à—ñ –∫–ª—é—á—ñ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ç–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞—Ç–∏, —è–∫ —Ü—ñ –∫–ª—é—á—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è.

**Customer Master Keys** (CMK): –ú–æ–∂—É—Ç—å —à–∏—Ñ—Ä—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ –¥–æ 4KB —Ä–æ–∑–º—ñ—Ä–æ–º. –í–æ–Ω–∏ –∑–∞–∑–≤–∏—á–∞–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è, —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ç–∞ –¥–µ—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è DEKs (Data Encryption Keys). –ü–æ—Ç—ñ–º DEKs –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö.

–ö–ª—é—á –≥–æ–ª–æ–≤–Ω–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞ (CMK) —î –ª–æ–≥—ñ—á–Ω–∏–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è–º –≥–æ–ª–æ–≤–Ω–æ–≥–æ –∫–ª—é—á–∞ –≤ AWS KMS. –û–∫—Ä—ñ–º —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä—ñ–≤ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –∫–ª—é—á–∞ —Ç–∞ —ñ–Ω—à–∏—Ö –º–µ—Ç–∞–¥–∞–Ω–∏—Ö, –≤–∫–ª—é—á–∞—é—á–∏ –¥–∞—Ç—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è, –æ–ø–∏—Å —Ç–∞ —Å—Ç–∞–Ω –∫–ª—é—á–∞, **CMK –º—ñ—Å—Ç–∏—Ç—å –º–∞—Ç–µ—Ä—ñ–∞–ª –∫–ª—é—á–∞, —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ç–∞ –¥–µ—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö**. –ö–æ–ª–∏ –≤–∏ —Å—Ç–≤–æ—Ä—é—î—Ç–µ CMK, –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º AWS KMS –≥–µ–Ω–µ—Ä—É—î –º–∞—Ç–µ—Ä—ñ–∞–ª –∫–ª—é—á–∞ –¥–ª—è —Ü—å–æ–≥–æ CMK. –û–¥–Ω–∞–∫ –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–±—Ä–∞—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è CMK –±–µ–∑ –º–∞—Ç–µ—Ä—ñ–∞–ª—É –∫–ª—é—á–∞, –∞ –ø–æ—Ç—ñ–º —ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —Å–≤—ñ–π –≤–ª–∞—Å–Ω–∏–π –º–∞—Ç–µ—Ä—ñ–∞–ª –∫–ª—é—á–∞ –≤ —Ü–µ–π CMK.

–Ü—Å–Ω—É—î 2 —Ç–∏–ø–∏ –≥–æ–ª–æ–≤–Ω–∏—Ö –∫–ª—é—á—ñ–≤:

* **AWS managed CMKs: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è —ñ–Ω—à–∏–º–∏ —Å–ª—É–∂–±–∞–º–∏ –¥–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö**. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Å–ª—É–∂–±–æ—é, —è–∫–∞ —Å—Ç–≤–æ—Ä–∏–ª–∞ –π–æ–≥–æ –≤ —Ä–µ–≥—ñ–æ–Ω—ñ. –í–æ–Ω–∏ —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è –≤–ø–µ—Ä—à–µ, –∫–æ–ª–∏ –≤–∏ –≤–ø—Ä–æ–≤–∞–¥–∂—É—î—Ç–µ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –≤ —Ü—ñ–π —Å–ª—É–∂–±—ñ. –û–±–µ—Ä—Ç–∞—î—Ç—å—Å—è –∫–æ–∂–Ω—ñ 3 —Ä–æ–∫–∏ —ñ –π–æ–≥–æ –Ω–µ–º–æ–∂–ª–∏–≤–æ –∑–º—ñ–Ω–∏—Ç–∏.
* **Customer manager CMKs**: –ì–Ω—É—á–∫—ñ—Å—Ç—å, –æ–±–µ—Ä—Ç–∞–Ω–Ω—è, –Ω–∞–ª–∞—à—Ç–æ–≤—É–≤–∞–Ω–∏–π –¥–æ—Å—Ç—É–ø —Ç–∞ –ø–æ–ª—ñ—Ç–∏–∫–∞ –∫–ª—é—á—ñ–≤. –£–≤—ñ–º–∫–Ω–µ–Ω–Ω—è —Ç–∞ –≤–∏–º–∫–Ω–µ–Ω–Ω—è –∫–ª—é—á—ñ–≤.

**Envelope Encryption** –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ Key Management Service (KMS): –î–≤–æ—Ä—ñ–≤–Ω–µ–≤–∞ —ñ—î—Ä–∞—Ä—Ö—ñ—á–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è **—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–ª—é—á–∞ –¥–∞–Ω–∏—Ö, –∞ –ø–æ—Ç—ñ–º —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –∫–ª—é—á–∞ –¥–∞–Ω–∏—Ö –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –≥–æ–ª–æ–≤–Ω–æ–≥–æ –∫–ª—é—á–∞**.

### Key Policies

–¶–µ –≤–∏–∑–Ω–∞—á–∞—î **—Ö—Ç–æ –º–æ–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ç–∞ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∫–ª—é—á–∞ –≤ KMS**.

–ó–∞ **–∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º:**

* –¶–µ –Ω–∞–¥–∞—î **–æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—É AWS, —è–∫–∏–π –≤–æ–ª–æ–¥—ñ—î –∫–ª—é—á–µ–º KMS, –ø–æ–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø** –¥–æ –∫–ª—é—á–∞ KMS.

–ù–∞ –≤—ñ–¥–º—ñ–Ω—É –≤—ñ–¥ —ñ–Ω—à–∏—Ö –ø–æ–ª—ñ—Ç–∏–∫ —Ä–µ—Å—É—Ä—Å—ñ–≤ AWS, **–ø–æ–ª—ñ—Ç–∏–∫–∞ –∫–ª—é—á–∞ AWS KMS –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–µ –Ω–∞–¥–∞—î –¥–æ–∑–≤–æ–ª—É –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—É –∞–±–æ –±—É–¥—å-—è–∫–æ–º—É –∑ –π–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤**. –©–æ–± –Ω–∞–¥–∞—Ç–∏ –¥–æ–∑–≤—ñ–ª –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É, **–ø–æ–ª—ñ—Ç–∏–∫–∞ –∫–ª—é—á–∞ –ø–æ–≤–∏–Ω–Ω–∞ –≤–∫–ª—é—á–∞—Ç–∏ —è–≤–Ω—É –∑–∞—è–≤—É**, —è–∫–∞ –Ω–∞–¥–∞—î —Ü–µ–π –¥–æ–∑–≤—ñ–ª, —è–∫ —Ü—è.

* –ë–µ–∑ –¥–æ–∑–≤–æ–ª—É –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É (`"AWS": "arn:aws:iam::111122223333:root"`) –¥–æ–∑–≤–æ–ª–∏ IAM –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º—É—Ç—å.
* –¶–µ **–¥–æ–∑–≤–æ–ª—è—î –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø–æ–ª—ñ—Ç–∏–∫–∏ IAM** –¥–ª—è –Ω–∞–¥–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–ª—é—á–∞ KMS, –Ω–∞ –¥–æ–¥–∞—Ç–æ–∫ –¥–æ –ø–æ–ª—ñ—Ç–∏–∫–∏ –∫–ª—é—á–∞.

**–ë–µ–∑ —Ü—å–æ–≥–æ –¥–æ–∑–≤–æ–ª—É –ø–æ–ª—ñ—Ç–∏–∫–∏ IAM, —è–∫—ñ –¥–æ–∑–≤–æ–ª—è—é—Ç—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–ª—é—á–∞, –Ω–µ–µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ**, —Ö–æ—á–∞ –ø–æ–ª—ñ—Ç–∏–∫–∏ IAM, —è–∫—ñ –∑–∞–±–æ—Ä–æ–Ω—è—é—Ç—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–ª—é—á–∞, –≤—Å–µ —â–µ –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ.
* –¶–µ **–∑–º–µ–Ω—à—É—î —Ä–∏–∑–∏–∫ —Ç–æ–≥–æ, —â–æ –∫–ª—é—á —Å—Ç–∞–Ω–µ –Ω–µ–∫–µ—Ä–æ–≤–∞–Ω–∏–º**, –Ω–∞–¥–∞—é—á–∏ –¥–æ–∑–≤—ñ–ª –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø—É –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É, –≤–∫–ª—é—á–∞—é—á–∏ –∫–æ—Ä–µ–Ω–µ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É, —è–∫–æ–≥–æ –Ω–µ –º–æ–∂–Ω–∞ –≤–∏–¥–∞–ª–∏—Ç–∏.

**–ü—Ä–∏–∫–ª–∞–¥ –ø–æ–ª—ñ—Ç–∏–∫–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
–Ø–∫—â–æ **–∞–∫–∞—É–Ω—Ç –¥–æ–∑–≤–æ–ª–µ–Ω–æ** (`"arn:aws:iam::111122223333:root"`), **–ø—Ä–∏–Ω—Ü–∏–ø–∞–ª** –∑ –∞–∫–∞—É–Ω—Ç—É **–≤—Å–µ –æ–¥–Ω–æ –ø–æ—Ç—Ä–µ–±—É–≤–∞—Ç–∏–º–µ IAM –¥–æ–∑–≤–æ–ª—ñ–≤** –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è KMS –∫–ª—é—á–∞. –û–¥–Ω–∞–∫, —è–∫—â–æ **ARN** —Ä–æ–ª—ñ, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, **—Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ –¥–æ–∑–≤–æ–ª–µ–Ω–æ** –≤ **Key Policy**, —Ü—è —Ä–æ–ª—å **–Ω–µ –ø–æ—Ç—Ä–µ–±—É—î IAM –¥–æ–∑–≤–æ–ª—ñ–≤**.
{% endhint %}

<details>

<summary>Policy Details</summary>

–í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ –ø–æ–ª—ñ—Ç–∏–∫–∏:

* –î–æ–∫—É–º–µ–Ω—Ç –Ω–∞ –æ—Å–Ω–æ–≤—ñ JSON
* Resource --> –ó–∞—á–µ–ø–ª–µ–Ω—ñ —Ä–µ—Å—É—Ä—Å–∏ (–º–æ–∂–µ –±—É—Ç–∏ "\*")
* Action --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (–¥–æ–∑–≤–æ–ª–∏)
* Effect --> Allow/Deny
* Principal --> –∑–∞—á–µ–ø–ª–µ–Ω–∏–π arn
* Conditions (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ) --> –£–º–æ–≤–∞ –¥–ª—è –Ω–∞–¥–∞–Ω–Ω—è –¥–æ–∑–≤–æ–ª—ñ–≤

Grants:

* –î–æ–∑–≤–æ–ª—è—î –¥–µ–ª–µ–≥—É–≤–∞—Ç–∏ –≤–∞—à—ñ –¥–æ–∑–≤–æ–ª–∏ —ñ–Ω—à–æ–º—É AWS –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª—É –≤ –º–µ–∂–∞—Ö –≤–∞—à–æ–≥–æ AWS –∞–∫–∞—É–Ω—Ç—É. –í–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —ó—Ö –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é AWS KMS APIs. –ú–æ–∂–µ –±—É—Ç–∏ –≤–∫–∞–∑–∞–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä CMK, –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª-–æ—Ç—Ä–∏–º—É–≤–∞—á —Ç–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –æ–ø–µ—Ä–∞—Ü—ñ—ó (Decrypt, Encrypt, GenerateDataKey...)
* –ü—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≥—Ä–∞–Ω—Ç—É –≤–∏–¥–∞—é—Ç—å—Å—è GrantToken —Ç–∞ GrantID

**–î–æ—Å—Ç—É–ø**:

* –ß–µ—Ä–µ–∑ **key policy** -- –Ø–∫—â–æ —Ü–µ —ñ—Å–Ω—É—î, —Ü–µ –º–∞—î **–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç** –Ω–∞–¥ IAM –ø–æ–ª—ñ—Ç–∏–∫–æ—é
* –ß–µ—Ä–µ–∑ **IAM –ø–æ–ª—ñ—Ç–∏–∫—É**
* –ß–µ—Ä–µ–∑ **grants**

</details>

### Key Administrators

–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –∫–ª—é—á—ñ–≤ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º:

* –ú–∞—î –¥–æ—Å—Ç—É–ø –¥–æ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è KMS, –∞–ª–µ –Ω–µ –¥–æ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –∞–±–æ –¥–µ—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
* –¢—ñ–ª—å–∫–∏ IAM –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ —Ç–∞ —Ä–æ–ª—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –¥–æ–¥–∞–Ω—ñ –¥–æ —Å–ø–∏—Å–∫—É –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤ –∫–ª—é—á—ñ–≤ (–Ω–µ –≥—Ä—É–ø–∏)
* –Ø–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –∑–æ–≤–Ω—ñ—à–Ω—ñ–π CMK, –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –∫–ª—é—á—ñ–≤ –º–∞—é—Ç—å –¥–æ–∑–≤—ñ–ª –Ω–∞ —ñ–º–ø–æ—Ä—Ç –º–∞—Ç–µ—Ä—ñ–∞–ª—É –∫–ª—é—á–∞

### Rotation of CMKs

* –ß–∏–º –¥–æ–≤—à–µ —Ç–æ–π —Å–∞–º–∏–π –∫–ª—é—á –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –Ω–∞ –º—ñ—Å—Ü—ñ, —Ç–∏–º –±—ñ–ª—å—à–µ –¥–∞–Ω–∏—Ö —à–∏—Ñ—Ä—É—î—Ç—å—Å—è —Ü–∏–º –∫–ª—é—á–µ–º, —ñ —è–∫—â–æ —Ü–µ–π –∫–ª—é—á –±—É–¥–µ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–æ, —Ç–æ —à–∏—Ä—à–∞ –æ–±–ª–∞—Å—Ç—å —Ä–∏–∑–∏–∫—É –¥–∞–Ω–∏—Ö. –ö—Ä—ñ–º —Ç–æ–≥–æ, —á–∏–º –¥–æ–≤—à–µ –∫–ª—é—á –∞–∫—Ç–∏–≤–Ω–∏–π, —Ç–∏–º –±—ñ–ª—å—à–∞ –π–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å –π–æ–≥–æ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü—ñ—ó.
* **KMS –æ–±–µ—Ä—Ç–∞—î –∫–ª—ñ—î–Ω—Ç—Å—å–∫—ñ –∫–ª—é—á—ñ –∫–æ–∂–Ω—ñ 365 –¥–Ω—ñ–≤** (–∞–±–æ –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ –ø—Ä–æ—Ü–µ—Å –≤—Ä—É—á–Ω—É –∫–æ–ª–∏ –∑–∞–≤–≥–æ–¥–Ω–æ) —ñ **–∫–ª—é—á—ñ, –∫–µ—Ä–æ–≤–∞–Ω—ñ AWS –∫–æ–∂–Ω—ñ 3 —Ä–æ–∫–∏**, —ñ —Ü–µ–π —á–∞—Å –Ω–µ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏.
* **–°—Ç–∞—Ä—ñ –∫–ª—é—á—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è** –¥–ª—è –¥–µ—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö, –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—Ö –¥–æ –æ–±–µ—Ä—Ç–∞–Ω–Ω—è
* –£ —Ä–∞–∑—ñ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü—ñ—ó, –æ–±–µ—Ä—Ç–∞–Ω–Ω—è –∫–ª—é—á–∞ –Ω–µ —É—Å—É–Ω–µ –∑–∞–≥—Ä–æ–∑—É, –æ—Å–∫—ñ–ª—å–∫–∏ –±—É–¥–µ –º–æ–∂–ª–∏–≤–æ –¥–µ—à–∏—Ñ—Ä—É–≤–∞—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ, –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∏–º –∫–ª—é—á–µ–º. –û–¥–Ω–∞–∫, **–Ω–æ–≤—ñ –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ –Ω–æ–≤–∏–º –∫–ª—é—á–µ–º**.
* –Ø–∫—â–æ **CMK** –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ —Å—Ç–∞–Ω—ñ **disabled** –∞–±–æ **pending** **deletion**, KMS **–Ω–µ –±—É–¥–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –æ–±–µ—Ä—Ç–∞–Ω–Ω—è –∫–ª—é—á–∞** –¥–æ —Ç–∏—Ö –ø—ñ—Ä, –ø–æ–∫–∏ CMK –Ω–µ –±—É–¥–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ –∞–±–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –Ω–µ –±—É–¥–µ —Å–∫–∞—Å–æ–≤–∞–Ω–æ.

#### Manual rotation

* –ü–æ—Ç—Ä—ñ–±–Ω–æ **—Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π CMK**, —Ç–æ–¥—ñ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –Ω–æ–≤–∏–π CMK-ID, —Ç–æ–º—É –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –±—É–¥–µ **–æ–Ω–æ–≤–∏—Ç–∏** –±—É–¥—å-—è–∫–∏–π **–¥–æ–¥–∞—Ç–æ–∫**, —â–æ–± **–ø–æ—Å–∏–ª–∞—Ç–∏—Å—è** –Ω–∞ –Ω–æ–≤–∏–π CMK-ID.
* –©–æ–± –∑—Ä–æ–±–∏—Ç–∏ —Ü–µ–π –ø—Ä–æ—Ü–µ—Å –ª–µ–≥—à–∏–º, –≤–∏ –º–æ–∂–µ—Ç–µ **–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø—Å–µ–≤–¥–æ–Ω—ñ–º–∏ –¥–ª—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ key-id** —ñ –ø–æ—Ç—ñ–º –ø—Ä–æ—Å—Ç–æ –æ–Ω–æ–≤–∏—Ç–∏ –∫–ª—é—á, –Ω–∞ —è–∫–∏–π –ø–æ—Å–∏–ª–∞—î—Ç—å—Å—è –ø—Å–µ–≤–¥–æ–Ω—ñ–º.
* –í–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ **–∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —Å—Ç–∞—Ä—ñ –∫–ª—é—á—ñ –¥–ª—è –¥–µ—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Å—Ç–∞—Ä–∏—Ö —Ñ–∞–π–ª—ñ–≤**, –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—Ö –Ω–∏–º–∏.

–í–∏ –º–æ–∂–µ—Ç–µ —ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –∫–ª—é—á—ñ –∑ –≤–∞—à–æ—ó –ª–æ–∫–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –∫–ª—é—á—ñ–≤.

### –Ü–Ω—à–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ KMS

KMS —Ç–∞—Ä–∏—Ñ—ñ–∫—É—î—Ç—å—Å—è –∑–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Ç—ñ–≤ –Ω–∞ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è/–¥–µ—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è, –æ—Ç—Ä–∏–º–∞–Ω–∏—Ö –≤—ñ–¥ —É—Å—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤ –∑–∞ –º—ñ—Å—è—Ü—å.

KMS –º–∞—î –ø–æ–≤–Ω—É —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é –∞—É–¥–∏—Ç—É —Ç–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ –∑ **CloudTrail**; —Ç—É—Ç –≤–∏ –º–æ–∂–µ—Ç–µ –∞—É–¥—ñ—é–≤–∞—Ç–∏ –≤—Å—ñ –∑–º—ñ–Ω–∏, –≤–∏–∫–æ–Ω–∞–Ω—ñ –Ω–∞ KMS.

–ó –ø–æ–ª—ñ—Ç–∏–∫–æ—é KMS –≤–∏ –º–æ–∂–µ—Ç–µ –∑—Ä–æ–±–∏—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–µ:

* –û–±–º–µ–∂–∏—Ç–∏, —Ö—Ç–æ –º–æ–∂–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∫–ª—é—á—ñ –¥–∞–Ω–∏—Ö —ñ —è–∫—ñ —Å–µ—Ä–≤—ñ—Å–∏ –º–∞—é—Ç—å –¥–æ—Å—Ç—É–ø –¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ü–∏—Ö –∫–ª—é—á—ñ–≤
* –û–±–º–µ–∂–∏—Ç–∏ –¥–æ—Å—Ç—É–ø —Å–∏—Å—Ç–µ–º –¥–æ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ç—ñ–ª—å–∫–∏, –¥–µ—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ –∞–±–æ –æ–±–æ—Ö
* –í–∏–∑–Ω–∞—á–∏—Ç–∏, —â–æ–± –¥–æ–∑–≤–æ–ª–∏—Ç–∏ —Å–∏—Å—Ç–µ–º–∞–º –¥–æ—Å—Ç—É–ø –¥–æ –∫–ª—é—á—ñ–≤ —á–µ—Ä–µ–∑ —Ä–µ–≥—ñ–æ–Ω–∏ (—Ö–æ—á–∞ —Ü–µ –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è, –æ—Å–∫—ñ–ª—å–∫–∏ –∑–±—ñ–π —É —Ä–µ–≥—ñ–æ–Ω—ñ, –¥–µ —Ä–æ–∑–º—ñ—â–µ–Ω–æ KMS, –≤–ø–ª–∏–Ω–µ –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å —Å–∏—Å—Ç–µ–º –≤ —ñ–Ω—à–∏—Ö —Ä–µ–≥—ñ–æ–Ω–∞—Ö).

–í–∏ –Ω–µ –º–æ–∂–µ—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –∞–±–æ –ø–µ—Ä–µ–º—ñ—â—É–≤–∞—Ç–∏/–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∫–ª—é—á—ñ —á–µ—Ä–µ–∑ —Ä–µ–≥—ñ–æ–Ω–∏; –≤–∏ –º–æ–∂–µ—Ç–µ –ª–∏—à–µ –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –¥–æ–∑–≤–æ–ª—É –¥–æ—Å—Ç—É–ø—É —á–µ—Ä–µ–∑ —Ä–µ–≥—ñ–æ–Ω–∏.

### Enumeration
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### –ü–æ—Å—Ç–µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ –∑–∞ –Ω–∞–º–∏** —É **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –ø–æ–¥–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
