# AWS - S3, Athena & Glacier Enum

{% hint style="success" %}
Lernen Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys einreichen.

</details>
{% endhint %}

## S3

Amazon S3 ist ein Dienst, der es Ihnen erm√∂glicht, **gro√üe Datenmengen zu speichern**.

Amazon S3 bietet mehrere Optionen zum Schutz von Daten im Ruhezustand. Die Optionen umfassen **Berechtigungen** (Richtlinie), **Verschl√ºsselung** (Client- und Serverseite), **Bucket-Versionierung** und **MFA-basiertes L√∂schen**. Der **Benutzer kann** eine dieser Optionen aktivieren, um den Datenschutz zu gew√§hrleisten. **Die Datenreplikation** ist eine interne Einrichtung von AWS, bei der **S3 automatisch jedes Objekt √ºber alle Verf√ºgbarkeitszonen repliziert** und die Organisation muss dies in diesem Fall nicht aktivieren.

Mit ressourcenbasierten Berechtigungen k√∂nnen Berechtigungen f√ºr Unterverzeichnisse Ihres Buckets separat definiert werden.

### Bucket-Versionierung und MFA-basiertes L√∂schen

Wenn die Bucket-Versionierung aktiviert ist, wird jede Aktion, die versucht, eine Datei innerhalb einer Datei zu √§ndern, eine neue Version der Datei generieren, wobei auch der vorherige Inhalt derselben beibehalten wird. Daher wird der Inhalt nicht √ºberschrieben.

Dar√ºber hinaus verhindert das MFA-basierte L√∂schen, dass Versionen von Dateien im S3-Bucket gel√∂scht werden und auch die Deaktivierung der Bucket-Versionierung, sodass ein Angreifer diese Dateien nicht √§ndern kann.

### S3-Zugriffsprotokolle

Es ist m√∂glich, **S3-Zugriffsprotokolle zu aktivieren** (die standardm√§√üig deaktiviert sind) und die Protokolle in einem anderen Bucket zu speichern, um zu erfahren, wer auf den Bucket zugreift (beide Buckets m√ºssen sich in derselben Region befinden).

### Vorab signierte URLs f√ºr S3

Es ist m√∂glich, eine vorab signierte URL zu generieren, die normalerweise verwendet werden kann, um auf die angegebene Datei im Bucket zuzugreifen. Eine **vorab signierte URL sieht so aus**:
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
Ein vorab signierter URL kann **√ºber die Befehlszeile mithilfe der Anmeldeinformationen eines Prinzipals mit Zugriff auf das Objekt erstellt werden** (wenn das Konto, das Sie verwenden, keinen Zugriff hat, wird ein k√ºrzerer vorab signierter URL erstellt, der jedoch nutzlos ist)
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
{% hint style="info" %}
Die einzige erforderliche Berechtigung zum Generieren einer vorab signierten URL ist die Berechtigung, die erteilt wird. F√ºr den vorherigen Befehl ist die einzige vom Prinzipal ben√∂tigte Berechtigung `s3:GetObject`.
{% endhint %}

Es ist auch m√∂glich, vorab signierte URLs mit **anderen Berechtigungen** zu erstellen:
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### S3-Verschl√ºsselungsmechanismen

**DEK bedeutet Datenverschl√ºsselungsschl√ºssel** und ist der Schl√ºssel, der immer generiert und zur Verschl√ºsselung von Daten verwendet wird.

<details>

<summary><strong>Serverseitige Verschl√ºsselung mit von S3 verwalteten Schl√ºsseln, SSE-S3</strong></summary>

Diese Option erfordert minimale Konfiguration und alle Verwaltungsvorg√§nge der verwendeten Verschl√ºsselungsschl√ºssel werden von AWS verwaltet. Alles, was Sie tun m√ºssen, ist, **Ihre Daten hochzuladen und S3 wird sich um alle anderen Aspekte k√ºmmern**. Jeder Eimer in einem S3-Konto erh√§lt einen Eimer-Schl√ºssel.

* Verschl√ºsselung:
* Objektdaten + erstellter Klartext-DEK --> Verschl√ºsselte Daten (gespeichert in S3)
* Erstellter Klartext-DEK + S3-Meisterschl√ºssel --> Verschl√ºsselter DEK (gespeichert in S3) und Klartext wird aus dem Speicher gel√∂scht
* Entschl√ºsselung:
* Verschl√ºsselter DEK + S3-Meisterschl√ºssel --> Klartext-DEK
* Klartext-DEK + Verschl√ºsselte Daten --> Objektdaten

Bitte beachten Sie, dass in diesem Fall **der Schl√ºssel von AWS verwaltet wird** (Rotation nur alle 3 Jahre). Wenn Sie Ihren eigenen Schl√ºssel verwenden, k√∂nnen Sie die Rotation, Deaktivierung und Anwendung von Zugriffskontrollen durchf√ºhren.

</details>

<details>

<summary><strong>Serverseitige Verschl√ºsselung mit von KMS verwalteten Schl√ºsseln, SSE-KMS</strong></summary>

Diese Methode erm√∂glicht es S3, den Schl√ºsselverwaltungsdienst zu verwenden, um Ihre Datenverschl√ºsselungsschl√ºssel zu generieren. KMS bietet Ihnen eine weit gr√∂√üere Flexibilit√§t, wie Ihre Schl√ºssel verwaltet werden. Beispielsweise k√∂nnen Sie den CMK deaktivieren, rotieren und Zugriffskontrollen anwenden und deren Verwendung mit AWS Cloud Trail √ºberwachen.

* Verschl√ºsselung:
* S3 fordert Daten von KMS CMK an
* KMS verwendet einen CMK, um das Paar DEK-Klartext und DEK-verschl√ºsselt zu generieren und sendet sie an S3
* S3 verwendet den Klartextschl√ºssel zur Verschl√ºsselung der Daten, speichert die verschl√ºsselten Daten und den verschl√ºsselten Schl√ºssel und l√∂scht den Klartextschl√ºssel aus dem Speicher
* Entschl√ºsselung:
* S3 fordert KMS auf, den verschl√ºsselten Datenkey des Objekts zu entschl√ºsseln
* KMS entschl√ºsselt den Datenkey mit dem CMK und sendet ihn zur√ºck an S3
* S3 entschl√ºsselt die Objektdaten

</details>

<details>

<summary><strong>Serverseitige Verschl√ºsselung mit benutzerbereitgestellten Schl√ºsseln, SSE-C</strong></summary>

Diese Option bietet Ihnen die M√∂glichkeit, Ihren eigenen Hauptschl√ºssel bereitzustellen, den Sie m√∂glicherweise au√üerhalb von AWS bereits verwenden. Ihr benutzerbereitgestellter Schl√ºssel wird dann zusammen mit Ihren Daten an S3 gesendet, wo S3 dann die Verschl√ºsselung f√ºr Sie durchf√ºhrt.

* Verschl√ºsselung:
* Der Benutzer sendet die Objektdaten + Kunden-Schl√ºssel an S3
* Der Kunden-Schl√ºssel wird verwendet, um die Daten zu verschl√ºsseln, und die verschl√ºsselten Daten werden gespeichert
* Ein gesalzener HMAC-Wert des Kunden-Schl√ºssels wird ebenfalls zur zuk√ºnftigen Schl√ºsselvalidierung gespeichert
* Der Kunden-Schl√ºssel wird aus dem Speicher gel√∂scht
* Entschl√ºsselung:
* Der Benutzer sendet den Kunden-Schl√ºssel
* Der Schl√ºssel wird gegen den gespeicherten HMAC-Wert validiert
* Der vom Kunden bereitgestellte Schl√ºssel wird dann verwendet, um die Daten zu entschl√ºsseln

</details>

<details>

<summary><strong>Clientseitige Verschl√ºsselung mit KMS, CSE-KMS</strong></summary>

√Ñhnlich wie bei SSE-KMS verwendet auch dies den Schl√ºsselverwaltungsdienst zur Generierung Ihrer Datenverschl√ºsselungsschl√ºssel. Diesmal wird jedoch KMS √ºber den Client und nicht √ºber S3 aufgerufen. Die Verschl√ºsselung erfolgt dann clientseitig und die verschl√ºsselten Daten werden dann an S3 gesendet, um gespeichert zu werden.

* Verschl√ºsselung:
* Client fordert einen Datenkey von KMS an
* KMS gibt den Klartext-DEK und den verschl√ºsselten DEK mit dem CMK zur√ºck
* Beide Schl√ºssel werden zur√ºckgesendet
* Der Client verschl√ºsselt dann die Daten mit dem Klartext-DEK und sendet die verschl√ºsselten Daten an S3 + den verschl√ºsselten DEK (der als Metadaten der verschl√ºsselten Daten in S3 gespeichert wird)
* Entschl√ºsselung:
* Die verschl√ºsselten Daten mit dem verschl√ºsselten DEK werden an den Client gesendet
* Der Client fordert KMS auf, den verschl√ºsselten Schl√ºssel mit dem CMK zu entschl√ºsseln, und KMS sendet den Klartext-DEK zur√ºck
* Der Client kann nun die verschl√ºsselten Daten entschl√ºsseln

</details>

<details>

<summary><strong>Clientseitige Verschl√ºsselung mit benutzerbereitgestellten Schl√ºsseln, CSE-C</strong></summary>

Mit diesem Mechanismus k√∂nnen Sie Ihre eigenen bereitgestellten Schl√ºssel nutzen und einen AWS-SDK-Client verwenden, um Ihre Daten zu verschl√ºsseln, bevor Sie sie zur Speicherung an S3 senden.

* Verschl√ºsselung:
* Der Client generiert einen DEK und verschl√ºsselt die Klartextdaten
* Anschlie√üend verschl√ºsselt er mit seinem eigenen benutzerdefinierten CMK den DEK
* reicht die verschl√ºsselten Daten + verschl√ºsselten DEK an S3 weiter, wo sie gespeichert werden
* Entschl√ºsselung:
* S3 sendet die verschl√ºsselten Daten und den DEK
* Da der Client bereits den CMK hat, der zum Verschl√ºsseln des DEK verwendet wurde, entschl√ºsselt er den DEK und verwendet dann den Klartext-DEK, um die Daten zu entschl√ºsseln

</details>

### **Enumeration**

Einer der traditionellen Hauptwege, um AWS-Organisationen zu kompromittieren, besteht darin, √∂ffentlich zug√§ngliche Eimer zu kompromittieren. **Sie k√∂nnen** [**√∂ffentliche Eimer-Enumeratoren auf dieser Seite finden**](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**.**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name ‚Äì-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Owner‚Äôs displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### Dual-Stack <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

Sie k√∂nnen auf einen S3-Bucket √ºber einen Dual-Stack-Endpunkt zugreifen, indem Sie einen virtuellen Host- oder Pfad-Endpunktnamen verwenden. Diese sind n√ºtzlich, um auf S3 √ºber IPv6 zuzugreifen.

Dual-Stack-Endpunkte verwenden die folgende Syntax:

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privilege Escalation

Auf der folgenden Seite k√∂nnen Sie nachlesen, wie Sie **S3-Berechtigungen missbrauchen, um Privilegien zu eskalieren**:

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### Nicht authentifizierter Zugriff

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### S3 Post-Exploitation

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### Persistenz

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## Andere S3-Schwachstellen

### S3 HTTP-Cache-Vergiftungsproblem <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[Laut dieser Forschung](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue) war es m√∂glich, die Antwort eines beliebigen Buckets zu zwischenspeichern, als ob sie zu einem anderen geh√∂ren w√ºrde. Dies h√§tte missbraucht werden k√∂nnen, um beispielsweise JavaScript-Datei-Antworten zu √§ndern und beliebige Seiten zu kompromittieren, die S3 verwenden, um statischen Code zu speichern.

## Amazon Athena

Amazon Athena ist ein interaktiver Abfragedienst, der es einfach macht, **Daten direkt in Amazon Simple Storage Service (Amazon **S3**) **mit** Standard-**SQL** zu **analysieren**.

Sie m√ºssen eine relationale DB-Tabelle mit dem Format der Inhalte vorbereiten, die in den √ºberwachten S3-Buckets erscheinen werden. Anschlie√üend kann Amazon Athena die DB aus den Protokollen bev√∂lkern, sodass Sie Abfragen durchf√ºhren k√∂nnen.

Amazon Athena unterst√ºtzt die **M√∂glichkeit, bereits verschl√ºsselte S3-Daten abzufragen** und kann, wenn entsprechend konfiguriert, **auch die Ergebnisse der Abfrage verschl√ºsseln, die dann in S3 gespeichert werden k√∂nnen**.

**Diese Verschl√ºsselung der Ergebnisse ist unabh√§ngig von den abgefragten S3-Daten**, was bedeutet, dass selbst wenn die S3-Daten nicht verschl√ºsselt sind, die abgefragten Ergebnisse verschl√ºsselt werden k√∂nnen. Ein paar Punkte, die beachtet werden m√ºssen, sind, dass Amazon Athena nur Daten unterst√ºtzt, die mit den **folgenden S3-Verschl√ºsselungsmethoden** verschl√ºsselt wurden, **SSE-S3, SSE-KMS und CSE-KMS**.

SSE-C und CSE-E werden nicht unterst√ºtzt. Dar√ºber hinaus ist es wichtig zu verstehen, dass Amazon Athena nur Abfragen gegen **verschl√ºsselte Objekte ausf√ºhrt, die sich in derselben Region wie die Abfrage selbst befinden**. Wenn Sie S3-Daten abfragen m√ºssen, die mit KMS verschl√ºsselt wurden, sind spezifische Berechtigungen des Athena-Benutzers erforderlich, um die Abfrage durchf√ºhren zu k√∂nnen.

### Enumeration
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## Referenzen

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

{% hint style="success" %}
Lernen Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys einreichen.

</details>
{% endhint %}
