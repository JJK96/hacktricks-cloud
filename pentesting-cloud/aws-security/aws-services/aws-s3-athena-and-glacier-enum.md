# AWS - S3, Athena & Glacier Enum

{% hint style="success" %}
Öğren ve AWS Hacking pratiği yap:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Öğren ve GCP Hacking pratiği yap: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Destek HackTricks</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol et!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katıl veya [**telegram grubuna**](https://t.me/peass) katıl veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip et.**
* **Hacking püf noktalarını paylaşmak için PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulun.

</details>
{% endhint %}

## S3

Amazon S3, **büyük miktarda veri depolamanıza izin veren bir hizmettir**.

Amazon S3, verilerin **dinlenme sırasında korunmasını** sağlamak için birden fazla seçenek sunar. Seçenekler arasında **İzin** (Politika), **Şifreleme** (İstemci ve Sunucu Tarafı), **Kova Sürümleme** ve **MFA'ya dayalı silme** bulunmaktadır. Kullanıcı, veri korumasını sağlamak için bu seçeneklerden herhangi birini etkinleştirebilir. **Veri replikasyonu**, AWS tarafından sağlanan bir iç tesis olup **S3 otomatik olarak her nesneyi tüm Kullanılabilirlik Bölgeleri arasında replike eder** ve organizasyonun bunu etkinleştirmesi gerekmez.

Kaynak tabanlı izinlerle, kovadaki alt dizinler için ayrı ayrı izinler tanımlayabilirsiniz.

### Kova Sürümleme ve MFA'ya dayalı silme

Kova sürümleme etkinleştirildiğinde, bir dosyayı değiştirmeye çalışan herhangi bir işlem, dosyanın yeni bir sürümünü oluşturacak ve aynı zamanda önceki içeriği de saklayacaktır. Bu nedenle, içeriğini üzerine yazmayacaktır.

Ayrıca, MFA'ya dayalı silme, S3 kovasındaki dosyaların sürümlerinin silinmesini ve aynı zamanda Kova Sürümleme'nin devre dışı bırakılmasını engelleyecektir, böylece bir saldırgan bu dosyaları değiştiremeyecektir.

### S3 Erişim günlükleri

Bir kovaya **erişim günlüğünü etkinleştirmek mümkündür** (varsayılan olarak devre dışıdır) ve günlükleri farklı bir kovada kaydederek kovaya kimin eriştiğini bilmek mümkündür (her iki kova da aynı bölgede olmalıdır).

### S3 Ön İmzalı URL'ler

Genellikle bir kovadaki belirli bir dosyaya **erişmek için kullanılabilecek ön imzalı bir URL oluşturmak mümkündür**. **Ön imzalı bir URL şuna benzerdir**:
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
Bir önceden imzalanmış URL, nesneye erişimi olan bir anahtar sahibinin kimlik bilgileri kullanılarak **cli'dan oluşturulabilir** (kullandığınız hesap erişime sahip değilse, daha kısa bir önceden imzalanmış URL oluşturulur ancak işe yaramaz)
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
{% hint style="info" %}
Presigned URL oluşturmak için gereken tek izin, verilen izindir, bu nedenle önceki komut için asıl tarafından gereken tek izin `s3:GetObject` iznidir.
{% endhint %}

Ayrıca **diğer izinlerle** presigned URL'ler oluşturmak da mümkündür:
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### S3 Şifreleme Mekanizmaları

**DEK, Veri Şifreleme Anahtarı anlamına gelir** ve her zaman verileri şifrelemek için oluşturulan ve kullanılan anahtardır.

<details>

<summary><strong>Sunucu taraflı şifreleme ile S3 yönetilen anahtarlar, SSE-S3</strong></summary>

Bu seçenek minimum yapılandırma gerektirir ve kullanılan şifreleme anahtarlarının tüm yönetimi AWS tarafından yönetilir. Yapmanız gereken tek şey **verilerinizi yüklemek ve S3'ün diğer tüm yönlerini ele almasına izin vermek**. Bir S3 hesabındaki her kova bir kova anahtarı atanmıştır.

* Şifreleme:
* Nesne Verisi + oluşturulan açık metin DEK --> Şifrelenmiş veri (S3 içinde depolanır)
* Oluşturulan açık metin DEK + S3 Anahtar Anahtarı --> Şifrelenmiş DEK (S3 içinde depolanır) ve açık metin bellekten silinir
* Şifre çözme:
* Şifrelenmiş DEK + S3 Anahtar Anahtarı --> Açık metin DEK
* Açık metin DEK + Şifrelenmiş veri --> Nesne Verisi

Lütfen, bu durumda **anahtar AWS tarafından yönetilmektedir** (sadece her 3 yılda bir döndürülür). Kendi anahtarınızı kullanırsanız, döndürebilir, devre dışı bırakabilir ve erişim kontrolü uygulayabilirsiniz.

</details>

<details>

<summary><strong>Sunucu taraflı şifreleme ile KMS yönetilen anahtarlar, SSE-KMS</strong></summary>

Bu yöntem, S3'ün veri şifreleme anahtarlarını oluşturmak için anahtar yönetim servisini kullanmasına izin verir. KMS, anahtarlarınızın nasıl yönetileceği konusunda size çok daha fazla esneklik sağlar. Örneğin, CMK'ya erişimi devre dışı bırakabilir, döndürebilir ve uygulayabilir ve kullanımlarına karşı AWS Cloud Trail'i kullanabilirsiniz.

* Şifreleme:
* S3, veri anahtarlarını KMS CMK'dan talep eder
* KMS, bir CMK kullanarak DEK açık metin ve DEK şifreli çiftini oluşturur ve bunları S3'e gönderir
* S3, verileri şifrelemek için açık metin anahtarı kullanır, şifrelenmiş veriyi ve şifreli anahtarı depolar ve açık metin anahtarını bellekten siler
* Şifre çözme:
* S3, nesnenin şifreli veri anahtarını çözmesi için KMS'ten talepte bulunur
* KMS, veri anahtarını CMK ile şifreler ve S3'e geri gönderir
* S3, nesne verisini şifreler

</details>

<details>

<summary><strong>Sunucu taraflı şifreleme ile müşteri tarafından sağlanan anahtarlar, SSE-C</strong></summary>

Bu seçenek, AWS dışında zaten kullandığınız kendi anahtarınızı sağlama olanağı tanır. Müşteri tarafından sağlanan anahtarınız daha sonra verilerinizle birlikte S3'e gönderilir, burada S3 sizin için şifreleme işlemini gerçekleştirir.

* Şifreleme:
* Kullanıcı nesne verisini + Müşteri anahtarını S3'e gönderir
* Müşteri anahtarı veriyi şifrelemek için kullanılır ve şifrelenmiş veri depolanır
* müşteri anahtarının gelecekteki anahtar doğrulaması için tuzlanmış bir HMAC değeri de depolanır
* müşteri anahtarı bellekten silinir
* Şifre çözme:
* Kullanıcı müşteri anahtarını gönderir
* Anahtar, depolanan HMAC değerine karşı doğrulanır
* Müşteri tarafından sağlanan anahtar daha sonra veriyi şifrelemek için kullanılır

</details>

<details>

<summary><strong>İstemci taraflı şifreleme ile KMS, CSE-KMS</strong></summary>

SSE-KMS ile benzer şekilde, bu da veri şifreleme anahtarlarını oluşturmak için anahtar yönetim servisini kullanır. Ancak bu sefer KMS, istemci tarafından S3 yerine çağrılır. Şifreleme daha sonra istemci tarafında gerçekleşir ve şifrelenmiş veri daha sonra depolanmak üzere S3'e gönderilir.

* Şifreleme:
* İstemci, bir veri anahtarı için KMS'ten talep eder
* KMS, açık metin DEK ve şifreli DEK'yi CMK ile geri döndürür
* Her iki anahtar da geri gönderilir
* İstemci daha sonra veriyi açık metin DEK ile şifreler ve şifrelenmiş veriyi S3'e gönderir + şifrelenmiş DEK (S3 içinde şifreli verinin meta verisi olarak kaydedilir)
* Şifre çözme:
* Şifrelenmiş DEK ile şifrelenmiş veri istemciye gönderilir
* İstemci, CMK'yı kullanarak şifreli anahtarı çözmesi için KMS'ten talep eder ve KMS, açık metin DEK'yi geri gönderir
* İstemci şimdi şifreli veriyi çözebilir

</details>

<details>

<summary><strong>İstemci taraflı şifreleme ile müşteri tarafından sağlanan anahtarlar, CSE-C</strong></summary>

Bu mekanizmayı kullanarak, kendi sağladığınız anahtarları kullanabilir ve verilerinizi depolamadan önce şifrelemek için AWS-SDK istemcisini kullanabilirsiniz.

* Şifreleme:
* İstemci bir DEK oluşturur ve açık metin veriyi şifreler
* Ardından, kendi özel CMK'sını kullanarak DEK'yi şifreler
* şifrelenmiş veriyi + şifrelenmiş DEK'yi S3'e gönderir ve depolar
* Şifre çözme:
* S3, şifrelenmiş veriyi ve DEK'yi gönderir
* İstemci, DEK'yi şifrelemek için kullanılan CMK'ye zaten sahip olduğundan, DEK'i çözer ve ardından veriyi çözmek için açık metin DEK'i kullanır

</details>

### **Numaralandırma**

AWS organizasyonlarını tehlikeye atan geleneksel ana yollardan biri genellikle halka açık erişilebilir kovaları tehlikeye atmaktan başlar. **[Bu sayfada halka açık kovaların numaralandırıcılarını bulabilirsiniz](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**.
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name –-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Owner’s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### çift yığın <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

Bir S3 kovasına, sanal barındırma tarzı veya yol tarzı uç nokta adını kullanarak çift yığın uç noktası aracılığıyla erişebilirsiniz. Bunlar, IPv6 üzerinden S3'e erişmek için kullanışlıdır.

Çift yığın uç noktaları aşağıdaki sözdizimini kullanır:

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

Aşağıdaki sayfada, **izinleri kötüye kullanarak ayrıcalıkları yükseltmek** için S3 izinlerini nasıl kullanabileceğinizi kontrol edebilirsiniz:

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### Kimlik Doğrulamasız Erişim

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### S3 Saldırı Sonrası İşlemler

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### Kalıcılık

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## Diğer S3 zafiyetleri

### S3 HTTP Önbellek Zehirlenme Sorunu <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**Bu araştırmaya göre**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue) bir başka kovaya ait yanıtı farklı bir kovaya aitmiş gibi önbelleğe almak mümkün olmuştur. Bu, örneğin javascript dosyası yanıtlarını değiştirerek ve S3'ü kullanarak statik kod depolayan herhangi bir sayfayı tehlikeye atarak kötüye kullanılabilirdi.

## Amazon Athena

Amazon Athena, Amazon Simple Storage Service (Amazon **S3**) içindeki verileri standart **SQL** kullanarak doğrudan **analiz etmeyi kolaylaştıran** etkileşimli bir sorgu hizmetidir.

İzlenen S3 kovalarında görünecek içeriğin formatında bir ilişkisel DB tablosu **hazırlamanız gerekmektedir**. Sonrasında Amazon Athena, günlüklerden DB'yi doldurabilecek ve ardından sorgulama yapabileceksiniz.

Amazon Athena, **zaten şifrelenmiş S3 verilerini sorgulama yeteneğini destekler** ve yapılandırılmışsa, **Athena ayrıca sorgunun sonuçlarını şifreleyebilir ve ardından S3'te depolanabilir**.

**Bu sonuçların şifrelenmesi, temelde sorgulanan S3 verilerinden bağımsızdır**, yani S3 verileri şifrelenmemiş olsa bile, sorgulanan sonuçlar şifrelenebilir. Amazon Athena'nın yalnızca **şu S3 şifreleme yöntemleriyle şifrelenmiş verileri desteklediğine** dikkat etmek önemlidir, **SSE-S3, SSE-KMS ve CSE-KMS**.

SSE-C ve CSE-E desteklenmez. Buna ek olarak, Amazon Athena'nın yalnızca sorgunun kendisiyle aynı bölgede bulunan **şifrelenmiş nesneler üzerinde sorguları çalıştıracağını anlamak önemlidir**. KMS kullanarak şifrelenmiş S3 verilerini sorgulamanız gerekiyorsa, Athena kullanıcısının sorguyu gerçekleştirmek için belirli izinlere sahip olması gerekmektedir.

### Numaralandırma
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## Referanslar

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
