# Cognito User Pools

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Grundlegende Informationen

Ein User Pool ist ein Benutzerverzeichnis in Amazon Cognito. Mit einem User Pool k√∂nnen sich Ihre Benutzer **in Ihre Web- oder mobile App einloggen** √ºber Amazon Cognito, **oder sich √ºber einen** **Drittanbieter**-Identit√§tsanbieter (IdP) anmelden. Egal, ob sich Ihre Benutzer direkt oder √ºber einen Drittanbieter anmelden, alle Mitglieder des User Pools haben ein Verzeichnisprofil, auf das Sie √ºber ein SDK zugreifen k√∂nnen.

User Pools bieten:

* Registrierungs- und Anmeldedienste.
* Eine integrierte, anpassbare Web-UI zur Anmeldung von Benutzern.
* Soziale Anmeldung mit Facebook, Google, Login mit Amazon und Anmeldung mit Apple sowie √ºber SAML- und OIDC-Identit√§tsanbieter aus Ihrem User Pool.
* Benutzerverzeichnisverwaltung und Benutzerprofile.
* Sicherheitsfunktionen wie Multi-Faktor-Authentifizierung (MFA), √úberpr√ºfung auf kompromittierte Anmeldeinformationen, Schutz vor Konto√ºbernahmen und Telefon- und E-Mail-Verifizierung.
* Angepasste Workflows und Benutzermigration durch AWS Lambda-Triggers.

**Quellcode** von Anwendungen enth√§lt normalerweise auch die **User Pool ID** und die **Client Application ID** (und manchmal das **Application Secret**?), die f√ºr einen **Benutzer zum Einloggen** in einen Cognito User Pool ben√∂tigt werden.

### Potenzielle Angriffe

* **Registrierung**: Standardm√§√üig kann sich ein Benutzer selbst registrieren, sodass er einen Benutzer f√ºr sich selbst erstellen k√∂nnte.
* **Benutzeraufz√§hlung**: Die Registrierungsfunktionalit√§t kann verwendet werden, um Benutzernamen zu finden, die bereits existieren. Diese Informationen k√∂nnen f√ºr den Brute-Force-Angriff n√ºtzlich sein.
* **Login-Brute-Force**: Im Abschnitt [**Authentifizierung**](cognito-user-pools.md#authentication) finden Sie alle **Methoden**, die ein Benutzer zum **Einloggen** hat. Sie k√∂nnten versuchen, diese zu brute-forcen, um **g√ºltige Anmeldeinformationen** zu finden.

### Werkzeuge f√ºr Pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), das AWS-Exploitation-Framework, enth√§lt jetzt die Module "cognito\_\_enum" und "cognito\_\_attack", die die Aufz√§hlung aller Cognito-Assets in einem Konto automatisieren und schwache Konfigurationen, f√ºr den Zugriff verwendete Benutzerattribute usw. kennzeichnen. Au√üerdem automatisieren sie die Benutzererstellung (einschlie√ülich MFA-Unterst√ºtzung) und die Privilegieneskalation basierend auf √§nderbaren benutzerdefinierten Attributen, verwendbaren Identity Pool-Anmeldeinformationen, annehmbaren Rollen in ID-Tokens usw.

F√ºr eine Beschreibung der Funktionen der Module siehe Teil 2 des [Blogbeitrags](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). F√ºr Installationsanweisungen siehe die Hauptseite von [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Verwendung

Beispiel f√ºr die Verwendung von cognito\_\_attack, um die Benutzererstellung und alle Privesc-Vektoren gegen einen bestimmten Identity Pool und User Pool Client zu versuchen:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Beispiel f√ºr die Verwendung von cognito\_\_enum, um alle Benutzerpools, Benutzerpool-Clients, Identit√§tspools, Benutzer usw. im aktuellen AWS-Konto anzuzeigen:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) ist ein CLI-Tool in Python, das verschiedene Angriffe auf Cognito implementiert, einschlie√ülich unerw√ºnschter Kontoerstellung und Konto-Oracle.

#### Installation
```bash
$ pip install cognito-scanner
```
#### Verwendung
```bash
$ cognito-scanner --help
```
For more information check https://github.com/padok-team/cognito-scanner

## Registrierung

User Pools erlaubt **standardm√§√üig** die **Registrierung neuer Benutzer**.
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### Wenn sich jeder registrieren kann

Sie k√∂nnten einen Fehler finden, der Ihnen anzeigt, dass Sie **mehr Details** √ºber den Benutzer angeben m√ºssen:
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
Du kannst die ben√∂tigten Details mit einem JSON wie folgt angeben:
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
Du k√∂nntest diese Funktionalit√§t auch nutzen, um **vorhandene Benutzer zu enumerieren.** Dies ist die Fehlermeldung, wenn bereits ein Benutzer mit diesem Namen existiert:
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
Beachten Sie im vorherigen Befehl, wie die **benutzerdefinierten Attribute mit "custom:" beginnen**.\
Wissen Sie auch, dass Sie beim Registrieren **keine neuen benutzerdefinierten Attribute f√ºr den Benutzer erstellen k√∂nnen**. Sie k√∂nnen nur **Standardattribute** (auch wenn sie nicht erforderlich sind) und **angegebene benutzerdefinierte Attribute** mit Werten versehen.
{% endhint %}

Oder einfach nur testen, ob eine client id existiert. Dies ist der Fehler, wenn die client-id nicht existiert:
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### Wenn nur der Admin Benutzer registrieren kann

Du wirst diesen Fehler finden und du wirst nicht in der Lage sein, Benutzer zu registrieren oder zu enumerieren:
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### Verifying Registration

Cognito erm√∂glicht es, **einen neuen Benutzer zu verifizieren, indem seine E-Mail oder Telefonnummer √ºberpr√ºft wird**. Daher werden bei der Erstellung eines Benutzers normalerweise mindestens der Benutzername und das Passwort sowie die **E-Mail und/oder Telefonnummer** ben√∂tigt. Geben Sie einfach eine **ein, die Sie kontrollieren**, damit Sie den Code erhalten, um **Ihr** neu erstelltes Benutzer**konto** wie folgt zu verifizieren:
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
Auch wenn es **so aussieht, als k√∂nnten Sie dieselbe E-Mail** und Telefonnummer verwenden, wird Cognito beim Verifizieren des erstellten Benutzers dar√ºber klagen, dass dieselben Informationen verwendet werden, und **l√§sst Sie das Konto nicht verifizieren**.
{% endhint %}

### Privilegieneskalation / Attribute aktualisieren

Standardm√§√üig kann ein Benutzer **den Wert seiner Attribute √§ndern** mit etwas wie:
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### Custom attribute privesc

{% hint style="danger" %}
Es k√∂nnte sein, dass **benutzerdefinierte Attribute** verwendet werden (wie `isAdmin`), da Sie standardm√§√üig **die Werte Ihrer eigenen Attribute √§ndern** k√∂nnen, k√∂nnten Sie m√∂glicherweise **Privilegien eskalieren**, indem Sie den Wert selbst √§ndern!
{% endhint %}

#### Email/username modification privesc

Sie k√∂nnen dies verwenden, um **die E-Mail und Telefonnummer eines Benutzers zu √§ndern**, aber dann, selbst wenn das Konto als verifiziert bleibt, werden diese Attribute **auf den Status "nicht verifiziert" gesetzt** (Sie m√ºssen sie erneut verifizieren).

{% hint style="warning" %}
Sie **k√∂nnen sich nicht mit E-Mail oder Telefonnummer anmelden**, bis Sie diese verifizieren, aber Sie k√∂nnen sich **mit dem Benutzernamen anmelden**.\
Beachten Sie, dass selbst wenn die E-Mail ge√§ndert und nicht verifiziert wurde, sie im ID-Token im **`email`**-**Feld** erscheint und das Feld **`email_verified`** **false** sein wird, aber wenn die App **das nicht √ºberpr√ºft, k√∂nnten Sie andere Benutzer imitieren**.

Dar√ºber hinaus beachten Sie, dass Sie alles in das **`name`**-Feld einf√ºgen k√∂nnen, indem Sie das **name-Attribut** √§ndern. Wenn eine App **dieses** Feld aus irgendeinem Grund **anstatt der `email`** (oder eines anderen Attributs) √ºberpr√ºft, k√∂nnten Sie m√∂glicherweise **andere Benutzer imitieren**.
{% endhint %}

Wenn Sie aus irgendeinem Grund Ihre E-Mail beispielsweise in eine neue √§ndern, auf die Sie zugreifen k√∂nnen, k√∂nnen Sie **die E-Mail mit dem Code best√§tigen, den Sie an diese E-Mail-Adresse erhalten haben**:
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
Verwenden Sie **`phone_number`** anstelle von **`email`**, um eine **neue Telefonnummer** zu √§ndern/zu verifizieren.

{% hint style="info" %}
Der Administrator k√∂nnte auch die Option aktivieren, **mit einem benutzerdefinierten Benutzernamen einzuloggen**. Beachten Sie, dass Sie diesen Wert nicht auf **einen bereits verwendeten Benutzernamen oder bevorzugten\_Benutzernamen √§ndern k√∂nnen**, um einen anderen Benutzer zu imitieren.
{% endhint %}

### Passwort Wiederherstellen/√Ñndern

Es ist m√∂glich, ein Passwort wiederherzustellen, indem man einfach **den Benutzernamen kennt** (oder E-Mail oder Telefon wird akzeptiert) und darauf zugreifen kann, da ein Code dorthin gesendet wird:
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
Die Antwort des Servers wird immer positiv sein, als ob der Benutzername existierte. Sie k√∂nnen diese Methode nicht verwenden, um Benutzer aufzulisten.
{% endhint %}

Mit dem Code k√∂nnen Sie das Passwort √§ndern mit:
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
Um das Passwort zu √§ndern, m√ºssen Sie **das vorherige Passwort kennen**:
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## Authentifizierung

Ein User-Pool unterst√ºtzt **verschiedene Wege zur Authentifizierung**. Wenn Sie einen **Benutzernamen und ein Passwort** haben, gibt es auch **verschiedene Methoden**, um sich anzumelden.\
Dar√ºber hinaus werden, wenn ein Benutzer im Pool authentifiziert ist, **3 Arten von Tokens ausgegeben**: Das **ID-Token**, das **Access-Token** und das **Refresh-Token**.

* [**ID-Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Es enth√§lt Anspr√ºche √ºber die **Identit√§t des authentifizierten Benutzers**, wie `name`, `email` und `phone_number`. Das ID-Token kann auch verwendet werden, um **Benutzer zu Ihren Ressourcenservern oder Serveranwendungen zu authentifizieren**. Sie m√ºssen die **Signatur** des ID-Tokens **√ºberpr√ºfen**, bevor Sie irgendwelchen Anspr√ºchen im ID-Token vertrauen, wenn Sie es in externen Anwendungen verwenden.
* Das ID-Token ist das Token, das **die Attributwerte des Benutzers** enth√§lt, auch die benutzerdefinierten.
* [**Access-Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Es enth√§lt Anspr√ºche √ºber den authentifizierten Benutzer, eine Liste der **Gruppen des Benutzers und eine Liste der Berechtigungen**. Der Zweck des Access-Tokens ist es, **API-Operationen im Kontext des Benutzers im User-Pool zu autorisieren**. Zum Beispiel k√∂nnen Sie das Access-Token verwenden, um Ihrem Benutzer **Zugriff zu gew√§hren**, um Benutzerattribute hinzuzuf√ºgen, zu √§ndern oder zu l√∂schen.
* [**Refresh-Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Mit Refresh-Tokens k√∂nnen Sie **neue ID-Tokens und Access-Tokens** f√ºr den Benutzer erhalten, bis das **Refresh-Token ung√ºltig** ist. **Standardm√§√üig** l√§uft das Refresh-Token **30 Tage nach** der Anmeldung Ihres Anwendungsbenutzers in Ihrem User-Pool ab. Wenn Sie eine Anwendung f√ºr Ihren User-Pool erstellen, k√∂nnen Sie das Ablaufdatum des Refresh-Tokens auf **einen Wert zwischen 60 Minuten und 10 Jahren** festlegen.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Dies ist der serverseitige Authentifizierungsablauf:

* Die serverseitige App ruft die **`AdminInitiateAuth` API-Operation** auf (anstatt `InitiateAuth`). Diese Operation erfordert AWS-Anmeldeinformationen mit Berechtigungen, die **`cognito-idp:AdminInitiateAuth`** und **`cognito-idp:AdminRespondToAuthChallenge`** umfassen. Die Operation gibt die erforderlichen Authentifizierungsparameter zur√ºck.
* Nachdem die serverseitige App die **Authentifizierungsparameter** hat, ruft sie die **`AdminRespondToAuthChallenge` API-Operation** auf. Die `AdminRespondToAuthChallenge` API-Operation ist nur erfolgreich, wenn Sie AWS-Anmeldeinformationen bereitstellen.

Diese **Methode ist standardm√§√üig NICHT aktiviert**.

Um sich **anzumelden**, m√ºssen Sie wissen:

* User-Pool-ID
* Client-ID
* Benutzername
* Passwort
* Client-Secret (nur wenn die App so konfiguriert ist, dass ein Secret verwendet wird)

{% hint style="info" %}
Um sich **mit dieser Methode anmelden zu k√∂nnen**, muss die Anwendung die Anmeldung mit `ALLOW_ADMIN_USER_PASSWORD_AUTH` erlauben.\
Dar√ºber hinaus ben√∂tigen Sie Anmeldeinformationen mit den Berechtigungen **`cognito-idp:AdminInitiateAuth`** und **`cognito-idp:AdminRespondToAuthChallenge`**.
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>Code zum Einloggen</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

Diese Methode ist eine weitere einfache und **traditionelle Benutzer- & Passwort-Authentifizierungs**-Methode. Es wird empfohlen, eine **traditionelle** Authentifizierungsmethode **zu Cognito zu migrieren** und dann zu **deaktivieren** und stattdessen die **ALLOW\_USER\_SRP\_AUTH**-Methode zu verwenden (da diese das Passwort niemals √ºber das Netzwerk sendet).\
Diese **Methode ist standardm√§√üig NICHT aktiviert**.

Der Haupt**unterschied** zur **vorherigen Auth-Methode** im Code besteht darin, dass Sie **die Benutzerpool-ID nicht kennen m√ºssen** und dass Sie **keine zus√§tzlichen Berechtigungen** im Cognito User Pool ben√∂tigen.

Zum **Login** ben√∂tigen Sie:

* client id
* username
* password
* client secret (nur wenn die App so konfiguriert ist, dass sie ein Geheimnis verwendet)

{% hint style="info" %}
Um sich **mit dieser Methode anmelden zu k√∂nnen**, muss die Anwendung die Anmeldung mit ALLOW\_USER\_PASSWORD\_AUTH erlauben.
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>Python-Code zum Einloggen</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

Dieses Szenario ist √§hnlich wie das vorherige, aber **anstatt das Passwort** √ºber das Netzwerk zu senden, wird eine **Challenge-Authentifizierung durchgef√ºhrt** (also kein Passwort, das selbst verschl√ºsselt durch das Netz navigiert).\
Diese **Methode ist standardm√§√üig aktiviert**.

Zum **Login** ben√∂tigen Sie:

* user pool id
* client id
* username
* password
* client secret (nur wenn die App so konfiguriert ist, dass ein Secret verwendet wird)

<details>

<summary>Code zum Login</summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

Diese **Methode wird immer g√ºltig sein** (sie kann nicht deaktiviert werden), aber Sie m√ºssen ein g√ºltiges Refresh-Token haben.
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>Code zum Aktualisieren</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

In diesem Fall wird die **Authentifizierung** durch die **Ausf√ºhrung einer Lambda-Funktion** durchgef√ºhrt.

## Zus√§tzliche Sicherheit

### Erweiterte Sicherheit

Standardm√§√üig ist sie deaktiviert, aber wenn sie aktiviert ist, k√∂nnte Cognito in der Lage sein, **Konten√ºbernahmen zu erkennen**. Um die Wahrscheinlichkeit zu minimieren, sollten Sie sich von einem **Netzwerk innerhalb derselben Stadt mit demselben User-Agent** (und wenn m√∂glich derselben IP) anmelden.

### **MFA Ger√§t merken**

Wenn sich der Benutzer vom selben Ger√§t anmeldet, k√∂nnte die MFA umgangen werden. Versuchen Sie daher, sich vom selben Browser mit denselben Metadaten (IP?) anzumelden, um den MFA-Schutz zu umgehen.

## User Pool Gruppen IAM Rollen

Es ist m√∂glich, **Benutzer zu User Pool** Gruppen hinzuzuf√ºgen, die mit einer **IAM-Rolle** verbunden sind.\
Dar√ºber hinaus k√∂nnen **Benutzer** **mehr als einer Gruppe mit verschiedenen IAM-Rollen** zugewiesen werden.

Beachten Sie, dass selbst wenn eine Gruppe in einer Gruppe mit einer IAM-Rolle enthalten ist, um auf die IAM-Anmeldeinformationen dieser Gruppe zugreifen zu k√∂nnen, der **User Pool von einem Identity Pool vertraut werden muss** (und die Details dieses Identity Pools kennen muss).

Eine weitere Voraussetzung, um die **IAM-Rolle, die im IdToken angegeben ist**, zu erhalten, wenn ein Benutzer im User Pool authentifiziert wird (`aws cognito-idp initiate-auth...`), ist, dass der **Identity Provider Authentication Provider** angeben muss, dass die **Rolle aus dem Token ausgew√§hlt werden muss.**

<figure><img src="../../../../.gitbook/assets/image (250).png" alt=""><figcaption></figcaption></figure>

Die **Rollen**, auf die ein Benutzer Zugriff hat, befinden sich **im `IdToken`**, und ein Benutzer kann **ausw√§hlen, f√ºr welche Rolle er Anmeldeinformationen m√∂chte** mit dem **`--custom-role-arn`** von `aws cognito-identity get-credentials-for-identity`.\
Wenn jedoch die **Standardoption** die **konfigurierte** ist (`use default role`), und Sie versuchen, auf eine Rolle aus dem IdToken zuzugreifen, erhalten Sie einen **Fehler** (deshalb ist die vorherige Konfiguration erforderlich):

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
Beachten Sie, dass die Rolle, die einer **User Pool Group** zugewiesen ist, **zug√§nglich durch den Identity Provider** sein muss, der **dem User Pool vertraut** (da die **IAM-Rollensitzungsanmeldeinformationen daraus bezogen werden**).
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
