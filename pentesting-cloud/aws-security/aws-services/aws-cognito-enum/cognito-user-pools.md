# Cognito User Pools

{% hint style="success" %}
Jifunze na kufanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na kufanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Taarifa za Msingi

User pool ni saraka ya watumiaji katika Amazon Cognito. Kwa user pool, watumiaji wako wanaweza **kuingia kwenye programu yako ya wavuti au simu** kupitia Amazon Cognito, **au kuunganisha** kupitia **mtoa huduma wa utambulisho wa tatu (IdP)**. Iwe watumiaji wako wanaingia moja kwa moja au kupitia mtoa huduma wa tatu, wanachama wote wa user pool wana wasifu wa saraka ambao unaweza kufikiwa kupitia SDK.

User pools hutoa:

* Huduma za kujisajili na kuingia.
* UI ya wavuti iliyojengwa ndani, inayoweza kubadilishwa ili kuingia watumiaji.
* Kuingia kijamii na Facebook, Google, Login with Amazon, na Sign in with Apple, na kupitia watoa huduma wa utambulisho wa SAML na OIDC kutoka kwa user pool yako.
* Usimamizi wa saraka ya watumiaji na wasifu wa watumiaji.
* Vipengele vya usalama kama uthibitishaji wa vipengele vingi (MFA), ukaguzi wa sifa zilizovunjwa, ulinzi wa kuchukua akaunti, na uthibitishaji wa simu na barua pepe.
* Mifumo maalum na uhamiaji wa watumiaji kupitia AWS Lambda triggers.

**Msimbo wa chanzo** wa programu kawaida pia utakuwa na **user pool ID** na **client application ID**, (na wakati mwingine **siri ya programu**?) ambazo zinahitajika kwa **mtumiaji kuingia** kwenye Cognito User Pool.

### Mashambulizi Yanayowezekana

* **Usajili**: Kwa default mtumiaji anaweza kujisajili mwenyewe, hivyo anaweza kuunda mtumiaji kwa ajili yake mwenyewe.
* **User enumeration**: Kazi ya usajili inaweza kutumika kupata majina ya watumiaji ambayo tayari yapo. Taarifa hii inaweza kuwa muhimu kwa shambulio la brute-force.
* **Login brute-force**: Katika sehemu ya [**Authentication**](cognito-user-pools.md#authentication) una **mbinu** zote ambazo mtumiaji anaweza kutumia **kuingia**, unaweza kujaribu brute-force **kupata sifa halali**.

### Zana za pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), mfumo wa unyonyaji wa AWS, sasa unajumuisha moduli za "cognito\_\_enum" na "cognito\_\_attack" ambazo zinaboresha uorodheshaji wa mali zote za Cognito katika akaunti na kuashiria mipangilio dhaifu, sifa za watumiaji zinazotumika kwa udhibiti wa ufikiaji, nk., na pia kuboresha uundaji wa watumiaji (ikiwa ni pamoja na msaada wa MFA) na kupandisha haki kulingana na sifa maalum zinazoweza kubadilishwa, sifa za pool za utambulisho zinazoweza kutumika, majukumu yanayoweza kudhaniwa katika id tokens, nk.

Kwa maelezo ya kazi za moduli angalia sehemu ya 2 ya [blog post](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Kwa maelekezo ya usakinishaji angalia ukurasa kuu wa [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Matumizi

Mfano wa matumizi ya cognito\_\_attack kujaribu uundaji wa watumiaji na vektori zote za privesc dhidi ya pool ya utambulisho na mteja wa user pool uliyopewa:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Sampuli ya matumizi ya cognito\_\_enum kukusanya mabwawa yote ya watumiaji, wateja wa bwawa la watumiaji, mabwawa ya utambulisho, watumiaji, nk. yanayoonekana katika akaunti ya sasa ya AWS:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) ni zana ya CLI katika python inayotekeleza mashambulizi tofauti kwenye Cognito ikijumuisha uundaji wa akaunti usiotakiwa na akaunti ya oracle.

#### Ufungaji
```bash
$ pip install cognito-scanner
```
#### Matumizi
```bash
$ cognito-scanner --help
```
Kwa maelezo zaidi angalia https://github.com/padok-team/cognito-scanner

## Usajili

User Pools inaruhusu kwa **chaguo-msingi** **kusajili watumiaji wapya**.
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### Ikiwa mtu yeyote anaweza kujiandikisha

Unaweza kupata hitilafu ikikuonyesha kwamba unahitaji **kutoa maelezo zaidi** kuhusu mtumiaji:
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
Unaweza kutoa maelezo yanayohitajika kwa JSON kama ifuatavyo:
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
Unaweza kutumia utendakazi huu pia **kuorodhesha watumiaji waliopo.** Huu ndio ujumbe wa kosa wakati mtumiaji tayari yupo na jina hilo:
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
Kumbuka katika amri iliyopita jinsi **sifa maalum zinaanza na "custom:"**.\
Pia fahamu kwamba wakati wa kusajili huwezi kuunda sifa mpya maalum kwa mtumiaji. Unaweza tu kutoa thamani kwa **sifa za kawaida** (hata kama hazihitajiki) na **sifa maalum zilizobainishwa**.
{% endhint %}

Au tu kujaribu kama client id ipo. Hii ndiyo hitilafu ikiwa client-id haipo:
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### Ikiwa ni admin pekee anayeweza kusajili watumiaji

Utapata hitilafu hii na hutaweza kusajili au kuorodhesha watumiaji:
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### Verifying Registration

Cognito inaruhusu **kuthibitisha mtumiaji mpya kwa kuthibitisha barua pepe yake au namba ya simu**. Kwa hivyo, wakati wa kuunda mtumiaji kawaida utahitajika angalau jina la mtumiaji na nenosiri na **barua pepe na/au namba ya simu**. Weka tu moja **unayoidhibiti** ili upokee msimbo wa **kuthibitisha akaunti yako** mpya iliyoundwa kama hii:
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
Hata kama **inaonekana unaweza kutumia barua pepe sawa** na nambari ya simu, wakati unahitaji kuthibitisha mtumiaji aliyeundwa Cognito itapinga kutumia taarifa sawa na **haitakuruhusu kuthibitisha akaunti**.
{% endhint %}

### Kuongezeka kwa Haki / Kusasisha Sifa

Kwa kawaida mtumiaji anaweza **kubadilisha thamani ya sifa zake** na kitu kama:
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### Custom attribute privesc

{% hint style="danger" %}
Unaweza kupata **custom attributes** zikitumika (kama `isAdmin`), kwa kuwa kwa default unaweza **kubadilisha thamani za attributes zako mwenyewe** unaweza **kuongeza haki** kwa kubadilisha thamani mwenyewe!
{% endhint %}

#### Email/username modification privesc

Unaweza kutumia hii **kubadilisha barua pepe na namba ya simu** ya mtumiaji, lakini basi, hata kama akaunti inabaki kama imethibitishwa, attributes hizo **zinawekwa katika hali ya kutothibitishwa** (unahitaji kuzithibitisha tena).

{% hint style="warning" %}
Hutaweza **kuingia na barua pepe au namba ya simu** mpaka uzithibitishe, lakini utaweza **kuingia na jina la mtumiaji**.\
Kumbuka kwamba hata kama barua pepe ilibadilishwa na haijathibitishwa itaonekana katika ID Token ndani ya **`email`** **field** na filed **`email_verified`** itakuwa **false**, lakini kama app **haikagui hilo unaweza kujifanya mtumiaji mwingine**.

Zaidi ya hayo, kumbuka kwamba unaweza kuweka chochote ndani ya **`name`** field kwa kubadilisha tu **name attribute**. Kama app **inakagua** **hilo** field kwa sababu fulani **badala ya `email`** (au attribute nyingine yoyote) unaweza kujifanya **mtumiaji mwingine**.
{% endhint %}

Hata hivyo, kama kwa sababu fulani ulibadilisha barua pepe yako kwa mfano kwa mpya unayoweza kufikia unaweza **kuthibitisha barua pepe na nambari uliyopokea katika anwani hiyo ya barua pepe**:
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
Tumia **`phone_number`** badala ya **`email`** kubadilisha/kuthibitisha **namba mpya ya simu**.

{% hint style="info" %}
Msimamizi anaweza pia kuwezesha chaguo la **kuingia na jina la mtumiaji linalopendekezwa na mtumiaji**. Kumbuka kuwa hutaweza kubadilisha thamani hii kuwa **jina lolote la mtumiaji au preferred\_username ambalo tayari linatumika** kuiga mtumiaji tofauti.
{% endhint %}

### Rejesha/Badilisha Nenosiri

Inawezekana kurejesha nenosiri kwa **kujua jina la mtumiaji** (au email au simu inakubalika) na kuwa na ufikiaji wake kwani msimbo utatumwa huko:
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
Jibu la seva litakuwa chanya kila wakati, kama vile jina la mtumiaji lilikuwepo. Huwezi kutumia njia hii kuorodhesha watumiaji
{% endhint %}

Kwa kutumia msimbo unaweza kubadilisha nenosiri na:
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
Kubadilisha nenosiri unahitaji **kujua nenosiri la awali**:
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## Authentication

Kundi la watumiaji linaunga mkono **njia tofauti za kuthibitisha** kwake. Ikiwa una **jina la mtumiaji na nenosiri** kuna pia **njia tofauti** zinazoungwa mkono kuingia.\
Zaidi ya hayo, wakati mtumiaji anathibitishwa katika Kundi **aina 3 za tokeni zinatolewa**: **ID Token**, **Access token** na **Refresh token**.

* [**ID Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Inayo madai kuhusu **utambulisho wa mtumiaji aliyethibitishwa**, kama vile `name`, `email`, na `phone_number`. ID token inaweza pia kutumika **kuthibitisha watumiaji kwa seva za rasilimali zako au programu za seva**. Lazima **uthibitishe** **sahihi** ya ID token kabla ya kuamini madai yoyote ndani ya ID token ikiwa unaitumia katika programu za nje.
* ID Token ni tokeni ambayo **ina maadili ya sifa za mtumiaji**, hata zile za kawaida.
* [**Access Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Inayo madai kuhusu mtumiaji aliyethibitishwa, orodha ya **vikundi vya mtumiaji, na orodha ya upeo**. Madhumuni ya access token ni **kuidhinisha shughuli za API** katika muktadha wa mtumiaji katika kundi la watumiaji. Kwa mfano, unaweza kutumia access token **kumpa mtumiaji wako ruhusa** ya kuongeza, kubadilisha, au kufuta sifa za mtumiaji.
* [**Refresh Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Kwa kutumia refresh tokens unaweza **kupata ID Tokens mpya na Access Tokens** kwa mtumiaji hadi **refresh token itakapokuwa batili**. Kwa **chaguo-msingi**, refresh token **inaisha baada ya siku 30** baada ya mtumiaji wa programu yako kuingia kwenye kundi la watumiaji wako. Unapounda programu kwa kundi la watumiaji wako, unaweza kuweka muda wa kuisha kwa refresh token kuwa **thamani yoyote kati ya dakika 60 na miaka 10**.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Hii ni mtiririko wa uthibitishaji wa upande wa seva:

* Programu ya upande wa seva inaita **`AdminInitiateAuth` API operation** (badala ya `InitiateAuth`). Operesheni hii inahitaji hati za AWS zenye ruhusa zinazojumuisha **`cognito-idp:AdminInitiateAuth`** na **`cognito-idp:AdminRespondToAuthChallenge`**. Operesheni inarudisha vigezo vya uthibitishaji vinavyohitajika.
* Baada ya programu ya upande wa seva kuwa na **vigezo vya uthibitishaji**, inaita **`AdminRespondToAuthChallenge` API operation**. Operesheni ya `AdminRespondToAuthChallenge` inafanikiwa tu unapotoa hati za AWS.

**Njia hii haijawezeshwa** kwa chaguo-msingi.

Ili **kuingia** unahitaji kujua:

* id ya kundi la watumiaji
* id ya mteja
* jina la mtumiaji
* nenosiri
* siri ya mteja (ikiwa tu programu imewekwa kutumia siri)

{% hint style="info" %}
Ili **kuweza kuingia kwa njia hii** programu hiyo lazima iruhusu kuingia kwa `ALLOW_ADMIN_USER_PASSWORD_AUTH`.\
Zaidi ya hayo, kufanya hatua hii unahitaji hati zenye ruhusa\*\*`cognito-idp:AdminInitiateAuth`\*\*na **`cognito-idp:AdminRespondToAuthChallenge`**
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>Code ya Kuingia</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

Njia hii ni rahisi na **ya jadi ya uthibitishaji wa mtumiaji na nenosiri**. Inapendekezwa **kuhamisha njia ya jadi** ya uthibitishaji **kwenda Cognito** na **inapendekezwa** kisha **kuzima** na **kutumia** njia ya **ALLOW\_USER\_SRP\_AUTH** badala yake (kwa kuwa hiyo haitumi nenosiri kwenye mtandao).\
Njia hii **HAIWEZI kuwezeshwa** kwa default.

**Tofauti kuu** na **njia ya uthibitishaji ya awali** ndani ya msimbo ni kwamba **huna haja ya kujua kitambulisho cha user pool** na kwamba **huna haja ya ruhusa za ziada** katika Cognito User Pool.

Ili **kuingia** unahitaji kujua:

* client id
* username
* password
* client secret (ikiwa tu programu imewekwa kutumia siri)

{% hint style="info" %}
Ili **uweze kuingia kwa njia hii** programu hiyo lazima iruhusu kuingia kwa ALLOW\_USER\_PASSWORD\_AUTH.
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>Python code to Login</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

Hali hii ni sawa na ile ya awali lakini **badala ya kutuma nenosiri** kupitia mtandao kuingia, **uthibitisho wa changamoto unafanywa** (kwa hivyo hakuna nenosiri linalosafiri hata likiwa limefichwa kupitia mtandao).\
**Njia hii imewezeshwa** kwa chaguo-msingi.

Ili **kuingia** unahitaji kujua:

* kitambulisho cha user pool
* kitambulisho cha mteja
* jina la mtumiaji
* nenosiri
* siri ya mteja (ikiwa tu programu imewekwa kutumia siri)

<details>

<summary>Code to login</summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

Njia hii **itakuwa halali kila wakati** (haiwezi kuzimwa) lakini unahitaji kuwa na refresh token halali.
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>Code ya kusasisha</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

Katika kesi hii, **uthibitishaji** utafanywa kupitia **utekelezaji wa lambda function**.

## Usalama wa Ziada

### Usalama wa Juu

Kwa chaguo-msingi imezimwa, lakini ikiwa imewezeshwa, Cognito inaweza kuwa na uwezo wa **kupata akaunti zilizochukuliwa**. Ili kupunguza uwezekano unapaswa kuingia kutoka kwa **mtandao ndani ya mji huo huo, ukitumia user agent sawa** (na IP ikiwa inawezekana)**.**

### **MFA Kumbuka kifaa**

Ikiwa mtumiaji anaingia kutoka kwa kifaa kile kile, MFA inaweza kupitishwa, kwa hivyo jaribu kuingia kutoka kwa kivinjari kile kile na metadata sawa (IP?) ili kujaribu kupitisha ulinzi wa MFA.

## User Pool Groups IAM Roles

Inawezekana kuongeza **watumiaji kwenye User Pool** vikundi vinavyohusiana na **IAM roles**.\
Zaidi ya hayo, **watumiaji** wanaweza kupewa **zaidi ya kikundi 1 na IAM roles tofauti** zilizounganishwa.

Kumbuka kwamba hata kama kikundi kiko ndani ya kikundi na IAM role imeunganishwa, ili kuweza kufikia IAM credentials za kikundi hicho inahitajika kwamba **User Pool iaminike na Identity Pool** (na kujua maelezo ya Identity Pool hiyo).

Sharti jingine la kupata **IAM role iliyoonyeshwa kwenye IdToken** wakati mtumiaji anathibitishwa kwenye User Pool (`aws cognito-idp initiate-auth...`) ni kwamba **Identity Provider Authentication provider** inahitaji kuonyesha kwamba **role lazima ichaguliwe kutoka kwenye token.**

<figure><img src="../../../../.gitbook/assets/image (250).png" alt=""><figcaption></figcaption></figure>

**Roles** ambazo mtumiaji anaweza kufikia ziko **ndani ya `IdToken`**, na mtumiaji anaweza **kuchagua role anayotaka kupata credentials zake** kwa kutumia **`--custom-role-arn`** kutoka `aws cognito-identity get-credentials-for-identity`.\
Hata hivyo, ikiwa **chaguo-msingi** ndicho **kilichosanidiwa** (`use default role`), na unajaribu kufikia role kutoka IdToken, utapata **error** (ndiyo maana usanidi wa awali unahitajika):

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
Kumbuka kwamba jukumu lililowekwa kwa **User Pool Group** linahitaji kuwa **linapatikana na Identity Provider** ambayo **inaamini User Pool** (kwa kuwa **session credentials za IAM role zitapatikana kutoka kwake**).
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
{% hint style="success" %}
Jifunze na kufanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na kufanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
