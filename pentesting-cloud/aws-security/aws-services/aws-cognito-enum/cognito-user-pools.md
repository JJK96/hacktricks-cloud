# Cognito User Pools

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## Temel Bilgiler

Bir user pool, Amazon Cognito'da bir kullanıcı dizinidir. Bir user pool ile kullanıcılarınız Amazon Cognito aracılığıyla **web veya mobil uygulamanıza giriş yapabilir** veya **üçüncü taraf** bir kimlik sağlayıcı (IdP) aracılığıyla federasyon yapabilir. Kullanıcılarınız doğrudan veya üçüncü taraf aracılığıyla giriş yapsa da, user pool'un tüm üyelerinin bir SDK aracılığıyla erişebileceğiniz bir dizin profili vardır.

User pool'lar şunları sağlar:

* Kayıt ve giriş hizmetleri.
* Kullanıcıları giriş yaptırmak için yerleşik, özelleştirilebilir bir web UI.
* Facebook, Google, Amazon ile Giriş ve Apple ile Giriş gibi sosyal girişler ve user pool'unuzdan SAML ve OIDC kimlik sağlayıcıları.
* Kullanıcı dizini yönetimi ve kullanıcı profilleri.
* Çok faktörlü kimlik doğrulama (MFA), tehlikeye atılmış kimlik bilgileri kontrolü, hesap ele geçirme koruması ve telefon ve e-posta doğrulaması gibi güvenlik özellikleri.
* AWS Lambda tetikleyicileri aracılığıyla özelleştirilmiş iş akışları ve kullanıcı geçişi.

Uygulamaların **kaynak kodu** genellikle **user pool ID** ve **client application ID** (ve bazen **application secret**?) içerir, bu da bir kullanıcının Cognito User Pool'a **giriş yapması** için gereklidir.

### Potansiyel saldırılar

* **Kayıt**: Varsayılan olarak bir kullanıcı kendini kaydedebilir, bu yüzden kendisi için bir kullanıcı oluşturabilir.
* **Kullanıcı enumarasyonu**: Kayıt işlevi, zaten var olan kullanıcı adlarını bulmak için kullanılabilir. Bu bilgi brute-force saldırısı için yararlı olabilir.
* **Giriş brute-force**: [**Authentication**](cognito-user-pools.md#authentication) bölümünde bir kullanıcının **giriş yapması** için tüm **yöntemler** bulunmaktadır, bunları brute-force ile **geçerli kimlik bilgilerini bulmak** için deneyebilirsiniz.

### Pentesting için Araçlar

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), AWS exploitation framework'ü, artık bir hesaptaki tüm Cognito varlıklarının enumarasyonunu otomatikleştiren ve zayıf yapılandırmaları, erişim kontrolü için kullanılan kullanıcı özniteliklerini vb. işaretleyen "cognito\_\_enum" ve "cognito\_\_attack" modüllerini içerir ve ayrıca kullanıcı oluşturmayı (MFA desteği dahil) ve değiştirilebilir özel özniteliklere, kullanılabilir kimlik havuzu kimlik bilgilerine, id token'larında devralınabilir rollere dayalı ayrıcalık yükseltmeyi otomatikleştirir.

Modüllerin işlevlerinin açıklaması için [blog yazısının](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2) 2. bölümüne bakın. Kurulum talimatları için ana [Pacu](https://github.com/RhinoSecurityLabs/pacu) sayfasına bakın.

#### Kullanım

Belirli bir kimlik havuzu ve user pool client'a karşı kullanıcı oluşturma ve tüm privesc vektörlerini denemek için örnek cognito\_\_attack kullanımı:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
AWS hesabında görünen tüm user pools, user pool clients, identity pools, users vb. toplamak için cognito\_\_enum kullanım örneği:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) is a CLI tool in python that implements different attacks on Cognito including unwanted account creation and account oracle.

#### Kurulum
```bash
$ pip install cognito-scanner
```
#### Kullanım
```bash
$ cognito-scanner --help
```
Daha fazla bilgi için https://github.com/padok-team/cognito-scanner adresine bakın.

## Registration

User Pools, **varsayılan** olarak **yeni kullanıcıların kaydolmasına** izin verir.
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### Herkes kayıt olabilir

Kullanıcı hakkında **daha fazla bilgi sağlamanız** gerektiğini belirten bir hata ile karşılaşabilirsiniz:
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
Gerekli detayları şu şekilde bir JSON ile sağlayabilirsiniz:
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
Bu işlevi ayrıca **mevcut kullanıcıları listelemek** için de kullanabilirsiniz. Bu, o isimle zaten bir kullanıcı mevcut olduğunda alınan hata mesajıdır:
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
Önceki komutta **özel özniteliklerin "custom:" ile başladığına** dikkat edin.\
Ayrıca, kayıt olurken kullanıcı için **yeni özel öznitelikler oluşturamayacağınızı** bilin. Sadece **varsayılan özniteliklere** (gerekli olmasalar bile) ve **belirtilen özel özniteliklere** değer verebilirsiniz.
{% endhint %}

Veya sadece bir client id'nin var olup olmadığını test etmek için. İşte client-id yoksa alınacak hata:
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### Eğer sadece admin kullanıcı kaydedebiliyorsa

Bu hatayı alacaksınız ve kullanıcı kaydedemeyecek veya listeleyemeyeceksiniz:
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### Verifying Registration

Cognito, **yeni bir kullanıcıyı e-posta veya telefon numarasını doğrulayarak doğrulamaya** olanak tanır. Bu nedenle, bir kullanıcı oluştururken genellikle en azından kullanıcı adı ve şifre ile **e-posta ve/veya telefon numarası** gerekecektir. **Kontrol ettiğiniz** birini ayarlayın, böylece **yeni oluşturulan kullanıcı hesabınızı** doğrulamak için kodu alırsınız, bu şekilde:
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
**Aynı e-posta** ve telefon numarasını kullanabiliyormuşsunuz gibi görünse de, oluşturulan kullanıcıyı doğrulamanız gerektiğinde Cognito aynı bilgileri kullanmanızdan şikayet edecek ve **hesabı doğrulamanıza izin vermeyecek**.
{% endhint %}

### Ayrıcalık Yükseltme / Özellikleri Güncelleme

Varsayılan olarak bir kullanıcı, **özelliklerinin değerini** şu şekilde değiştirebilir:
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### Özel öznitelik privesc

{% hint style="danger" %}
**Özel özniteliklerin** kullanıldığını görebilirsiniz (örneğin `isAdmin`), varsayılan olarak **kendi özniteliklerinizin değerlerini değiştirebildiğiniz** için, değeri kendiniz değiştirerek **ayrıcalıkları yükseltebilirsiniz**!
{% endhint %}

#### E-posta/kullanıcı adı değiştirme privesc

Bir kullanıcının **e-posta ve telefon numarasını değiştirmek** için bunu kullanabilirsiniz, ancak hesap doğrulanmış olarak kalsa bile, bu öznitelikler **doğrulanmamış durumda** ayarlanır (tekrar doğrulamanız gerekir).

{% hint style="warning" %}
**E-posta veya telefon numarası ile giriş yapamayacaksınız** doğrulayana kadar, ancak **kullanıcı adı ile giriş yapabileceksiniz**.\
E-posta değiştirilmiş ve doğrulanmamış olsa bile, ID Token içinde **`email`** **alanında** görünecek ve **`email_verified`** alanı **false** olacak, ancak uygulama **bunu kontrol etmiyorsa diğer kullanıcıları taklit edebilirsiniz**.

Ayrıca, **`name`** alanına sadece **isim özniteliğini** değiştirerek herhangi bir şey koyabileceğinizi unutmayın. Bir uygulama **herhangi bir nedenle** bu alanı **`email`** (veya başka bir öznitelik) yerine **kontrol ediyorsa** diğer kullanıcıları **taklit edebilirsiniz**.
{% endhint %}

Her neyse, eğer bir nedenle e-postanızı yeni bir e-posta adresine değiştirdiyseniz, o e-posta adresine aldığınız kod ile e-postayı **doğrulayabilirsiniz**:
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
**`phone_number`** yerine **`email`** kullanarak **yeni bir telefon numarasını** değiştirin/doğrulayın.

{% hint style="info" %}
Admin ayrıca **kullanıcı tercihli kullanıcı adı ile giriş yapma** seçeneğini de etkinleştirebilir. Bu değeri **zaten kullanılan herhangi bir kullanıcı adı veya preferred\_username** olarak değiştiremeyeceğinizi unutmayın.
{% endhint %}

### Şifre Kurtarma/Değiştirme

Sadece **kullanıcı adını bilerek** (veya email veya telefon kabul edilir) ve erişime sahip olarak bir şifreyi kurtarmak mümkündür, çünkü bir kod oraya gönderilecektir:
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
Sunucunun yanıtı her zaman olumlu olacaktır, sanki kullanıcı adı varmış gibi. Bu yöntemi kullanıcıları numaralandırmak için kullanamazsınız.
{% endhint %}

Şifreyi şu kodla değiştirebilirsiniz:
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
Şifreyi değiştirmek için **önceki şifreyi bilmeniz** gerekir:
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## Authentication

Bir kullanıcı havuzu, ona **kimlik doğrulamak için farklı yolları** destekler. Eğer bir **kullanıcı adı ve şifre** varsa, giriş yapmak için de **farklı yöntemler** desteklenir.\
Ayrıca, bir kullanıcı havuzunda kimlik doğrulandıktan sonra **3 tür token verilir**: **ID Token**, **Access token** ve **Refresh token**.

* [**ID Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Kimliği doğrulanmış kullanıcı hakkında `name`, `email` ve `phone_number` gibi iddialar içerir. ID token, **kullanıcıları kaynak sunucularınıza veya sunucu uygulamalarınıza kimlik doğrulamak** için de kullanılabilir. ID token'ı harici uygulamalarda kullanıyorsanız, içindeki iddialara güvenmeden önce **imzasını doğrulamanız** gerekir.
* ID Token, **kullanıcının nitelik değerlerini** içeren token'dır, hatta özel olanları bile.
* [**Access Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Kimliği doğrulanmış kullanıcı hakkında iddialar, **kullanıcının gruplarının bir listesi ve kapsamların bir listesi** içerir. Access token'ın amacı, kullanıcı havuzundaki kullanıcı bağlamında **API işlemlerini yetkilendirmektir**. Örneğin, access token'ı kullanarak kullanıcınıza kullanıcı niteliklerini ekleme, değiştirme veya silme izni verebilirsiniz.
* [**Refresh Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Refresh token'lar ile kullanıcı için **yeni ID Token ve Access Token** alabilirsiniz, refresh token **geçersiz olana kadar**. **Varsayılan olarak**, refresh token, uygulama kullanıcınız kullanıcı havuzunuza giriş yaptıktan **30 gün sonra** sona erer. Kullanıcı havuzunuz için bir uygulama oluşturduğunuzda, uygulamanın refresh token süresini **60 dakika ile 10 yıl arasında herhangi bir değere** ayarlayabilirsiniz.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Bu, sunucu tarafı kimlik doğrulama akışıdır:

* Sunucu tarafı uygulama, **`AdminInitiateAuth` API işlemini** (`InitiateAuth` yerine) çağırır. Bu işlem, **`cognito-idp:AdminInitiateAuth`** ve **`cognito-idp:AdminRespondToAuthChallenge`** izinlerini içeren AWS kimlik bilgilerini gerektirir. İşlem, gerekli kimlik doğrulama parametrelerini döndürür.
* Sunucu tarafı uygulama **kimlik doğrulama parametrelerine** sahip olduktan sonra, **`AdminRespondToAuthChallenge` API işlemini** çağırır. `AdminRespondToAuthChallenge` API işlemi, yalnızca AWS kimlik bilgilerini sağladığınızda başarılı olur.

Bu **yöntem varsayılan olarak etkin değildir**.

**Giriş yapmak** için **bilmeniz gerekenler**:

* user pool id
* client id
* username
* password
* client secret (yalnızca uygulama bir secret kullanacak şekilde yapılandırılmışsa)

{% hint style="info" %}
Bu yöntemle **giriş yapabilmek** için uygulamanın `ALLOW_ADMIN_USER_PASSWORD_AUTH` ile girişe izin vermesi gerekir.\
Ayrıca, bu işlemi gerçekleştirmek için **`cognito-idp:AdminInitiateAuth`** ve **`cognito-idp:AdminRespondToAuthChallenge`** izinlerine sahip kimlik bilgilerine ihtiyacınız var.
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>Giriş Kodu</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

Bu yöntem, başka bir basit ve **geleneksel kullanıcı & şifre doğrulama** akışıdır. Geleneksel bir doğrulama yöntemini **Cognito'ya taşımak** ve ardından bunu **devre dışı bırakmak** ve **ALLOW\_USER\_SRP\_AUTH** yöntemini kullanmak **önerilir** (çünkü bu yöntem şifreyi ağ üzerinden asla göndermez).\
Bu **yöntem varsayılan olarak etkin değildir**.

Kod içindeki **önceki doğrulama yöntemiyle** olan **ana fark**, **kullanıcı havuzu kimliğini bilmenize gerek olmaması** ve Cognito Kullanıcı Havuzunda **ek izinlere ihtiyacınız olmamasıdır**.

**Giriş yapmak** için bilmeniz gerekenler:

* client id
* username
* password
* client secret (yalnızca uygulama bir secret kullanacak şekilde yapılandırılmışsa)

{% hint style="info" %}
Bu yöntemle **giriş yapabilmek** için uygulamanın ALLOW\_USER\_PASSWORD\_AUTH ile girişe izin vermesi gerekir.
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>Giriş için Python kodu</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

Bu senaryo önceki senaryoya benzer, ancak **şifreyi** ağ üzerinden göndererek giriş yapmak yerine **bir challenge authentication gerçekleştirilir** (yani şifre ağ üzerinden şifrelenmiş bile olsa dolaşmaz).\
Bu **yöntem varsayılan olarak etkindir**.

**Giriş yapmak** için **bilmeniz gerekenler**:

* user pool id
* client id
* username
* password
* client secret (yalnızca uygulama bir secret kullanacak şekilde yapılandırılmışsa)

<details>

<summary>Giriş yapmak için kod</summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

Bu **yöntem her zaman geçerli olacak** (devre dışı bırakılamaz) ancak geçerli bir refresh token'a sahip olmanız gerekir.
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>Yenilemek için kod</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

Bu durumda **kimlik doğrulama**, **bir lambda fonksiyonunun yürütülmesi** yoluyla gerçekleştirilecektir.

## Ekstra Güvenlik

### Gelişmiş Güvenlik

Varsayılan olarak devre dışıdır, ancak etkinleştirilirse, Cognito **hesap ele geçirmelerini bulabilir**. Olasılığı en aza indirmek için **aynı şehirdeki bir ağdan, aynı kullanıcı aracısını kullanarak** (ve mümkünse aynı IP ile) giriş yapmalısınız.

### **MFA Cihazı Hatırla**

Kullanıcı aynı cihazdan giriş yaparsa, MFA atlanabilir, bu nedenle MFA korumasını atlamak için aynı tarayıcıdan aynı metadata (IP?) ile giriş yapmayı deneyin.

## User Pool Grupları IAM Rolleri

**IAM rolleri** ile ilişkili **User Pool** gruplarına **kullanıcılar** eklemek mümkündür.\
Ayrıca, **kullanıcılar** farklı IAM rolleri eklenmiş **birden fazla gruba atanabilir**.

Bir grup, IAM rolü eklenmiş bir grubun içinde olsa bile, o grubun IAM kimlik bilgilerine erişebilmek için **User Pool'un bir Identity Pool tarafından güvenilir olması** (ve o Identity Pool'un detaylarını bilmesi) gerekmektedir.

Bir kullanıcının User Pool'da kimlik doğrulaması yapıldığında (`aws cognito-idp initiate-auth...`) **IdToken'da belirtilen IAM rolünü** alabilmesi için, **Identity Provider Authentication provider**'ın **rolün token'dan seçilmesi gerektiğini** belirtmesi gerekmektedir.

<figure><img src="../../../../.gitbook/assets/image (250).png" alt=""><figcaption></figcaption></figure>

Bir kullanıcının erişebileceği **roller** **`IdToken`** içinde yer alır ve kullanıcı **`aws cognito-identity get-credentials-for-identity`** komutundaki **`--custom-role-arn`** ile **hangi rol için kimlik bilgileri istediğini seçebilir**.\
Ancak, **varsayılan seçenek** **yapılandırılmış** ise (`use default role`), ve IdToken'dan bir role erişmeye çalışırsanız, **hata** alırsınız (bu yüzden önceki yapılandırma gereklidir):

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
**User Pool Group**'a atanan rolün, **User Pool'a güvenen** **Kimlik Sağlayıcı** tarafından **erişilebilir** olması gerektiğini unutmayın (çünkü IAM rolü **oturum kimlik bilgileri buradan elde edilecektir**).
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek hacking ipuçlarını paylaşın.

</details>
{% endhint %}
