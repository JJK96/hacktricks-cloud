# AWS - Redshift Enum

{% hint style="success" %}
Učite i vežbajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Učite i vežbajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Amazon Redshift

Redshift je potpuno upravljana usluga koja može da se skalira do preko petabajta, koja se koristi kao **data warehouse za rešenja velikih podataka**. Korišćenjem Redshift klastera, možete izvršavati analitiku nad vašim skupovima podataka koristeći brze, SQL bazirane alate za upite i aplikacije za poslovnu inteligenciju kako biste stekli veće razumevanje vizije za vaš posao.

**Redshift nudi šifrovanje u mirovanju koristeći četvorostepenu hijerarhiju šifarskih ključeva koristeći ili KMS ili CloudHSM za upravljanje najvišim nivoom ključeva**. **Kada je šifrovanje omogućeno za vaš klaster, ne može se onemogućiti i obrnuto**. Kada imate nešifrovan klaster, ne može se šifrovati.

Šifrovanje za vaš klaster može se desiti samo tokom njegovog kreiranja, i jednom kada je šifrovan, podaci, metapodaci i bilo kakvi snimci su takođe šifrovani. Nivoi hijerarhije šifarskih ključeva su sledeći, **nivo jedan je glavni ključ, nivo dva je ključ za šifrovanje klastera, CEK, nivo tri, ključ za šifrovanje baze podataka, DEK, i na kraju nivo četiri, sami ključevi za šifrovanje podataka**.

### KMS

Tokom kreiranja vašeg klastera, možete odabrati ili **podrazumevani KMS ključ** za Redshift ili odabrati **sopstveni CMK**, što vam pruža veću fleksibilnost nad kontrolom ključa, posebno sa auditorske tačke gledišta.

Podrazumevani KMS ključ za Redshift automatski se kreira od strane Redshift-a prvi put kada je opcija ključa odabrana i korišćena, i potpuno je upravljan od strane AWS-a.

Ovaj KMS ključ se zatim šifruje sa CMK glavnim ključem, nivo jedan. Ovaj šifrovani KMS podatkovni ključ se zatim koristi kao ključ za šifrovanje klastera, CEK, nivo dva. Ovaj CEK se zatim šalje od strane KMS-a Redshift-u gde je odvojeno od klastera. Redshift zatim šalje ovaj šifrovani CEK klasteru preko sigurnog kanala gde je smešten u memoriji.

Redshift zatim zahteva od KMS-a da dešifruje CEK, nivo dva. Ovaj dešifrovani CEK se zatim takođe čuva u memoriji. Redshift zatim kreira nasumični ključ za šifrovanje baze podataka, DEK, nivo tri, i učitava ga u memoriju klastera. Dešifrovani CEK u memoriji zatim šifruje DEK, koji je takođe smešten u memoriji.

Ovaj šifrovani DEK se zatim šalje preko sigurnog kanala i smešten je u Redshift-u odvojeno od klastera. I CEK i DEK sada su smešteni u memoriji klastera kako u šifrovanom tako i u dešifrovanom obliku. Dešifrovani DEK se zatim koristi za šifrovanje ključeva podataka, nivo četiri, koji su nasumično generisani od strane Redshift-a za svaki blok podataka u bazi podataka.

Možete koristiti AWS Trusted Advisor da pratite konfiguraciju vaših Amazon S3 kanti i osigurate da je vođenje evidencije kanti omogućeno, što može biti korisno za sprovođenje sigurnosnih revizija i praćenje obrazaca korišćenja u S3.

### CloudHSM

<details>

<summary>Korišćenje Redshift-a sa CloudHSM-om</summary>

Kada radite sa CloudHSM-om za obavljanje vašeg šifrovanja, prvo morate uspostaviti poverljivu vezu između vašeg HSM klijenta i Redshift-a koristeći klijentske i serverske sertifikate.

Ova veza je potrebna kako bi se obezbedile sigurne komunikacije, omogućavajući da šifarski ključevi budu poslati između vašeg HSM klijenta i vaših Redshift klastera. Koristeći nasumično generisan privatni i javni ključ par, Redshift kreira javni klijentski sertifikat, koji je šifrovan i smešten od strane Redshift-a. Ovaj sertifikat mora biti preuzet i registrovan na vašem HSM klijentu, i dodeljen odgovarajućoj HSM particiji.

Zatim morate konfigurisati Redshift sa sledećim detaljima vašeg HSM klijenta: IP adresa HSM-a, ime HSM particije, lozinka HSM particije, i javni HSM serverski sertifikat, koji je šifrovan od strane CloudHSM-a koristeći interni glavni ključ. Kada su ove informacije obezbeđene, Redshift će potvrditi i verifikovati da može da se poveže i pristupi razvojnoj particiji.

Ako vaše interne sigurnosne politike ili upravljačke kontrole diktiraju da morate primeniti rotaciju ključeva, onda je to moguće sa Redshift-om omogućavajući vam rotaciju šifarskih ključeva za šifrovane klastera, međutim, morate biti svesni da tokom procesa rotacije ključeva, klaster će biti nedostupan vrlo kratko vreme, pa je najbolje rotirati ključeve samo kada je to potrebno, ili ako osećate da su možda kompromitovani.

Tokom rotacije, Redshift će rotirati CEK za vaš klaster i za sve rezervne kopije tog klastera. Rotiraće DEK za klaster ali nije moguće rotirati DEK za snimke smeštene u S3 koji su šifrovani korišćenjem DEK. Staviće klaster u stanje 'rotiranje ključeva' dok se proces ne završi kada će status ponovo biti 'dostupan'.

</details>

### Enumeracija
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Upornost

Sledeće radnje omogućavaju dodeljivanje pristupa drugim AWS nalozima klasteru:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
Naučite i vežbajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
