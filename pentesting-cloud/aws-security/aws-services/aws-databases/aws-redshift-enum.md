# AWS - Redshift Enum

{% hint style="success" %}
AWS Hacking öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## Amazon Redshift

Redshift, **büyük veri çözümleri için veri ambarı** olarak kullanılan, **bir petabaytın üzerine ölçeklenebilen tamamen yönetilen bir hizmettir**. Redshift kümeleme kullanarak, veri kümeleriniz üzerinde hızlı, SQL tabanlı sorgu araçları ve iş zekası uygulamaları kullanarak analiz çalıştırabilir ve işletmeniz için daha iyi bir anlayış elde edebilirsiniz.

**Redshift, dinlenme sırasında şifreleme sunar ve üst düzey anahtarları yönetmek için KMS veya CloudHSM kullanarak dört katmanlı bir şifreleme anahtarları hiyerarşisi kullanır**. **Kümeniz için şifreleme etkinleştirildiğinde devre dışı bırakılamaz ve tam tersi de geçerlidir**. Şifrelenmemiş bir kümeniz olduğunda şifrelenemez.

Kümeniz için şifreleme yalnızca oluşturulurken gerçekleştirilebilir ve bir kez şifrelenirse, veriler, meta veriler ve herhangi bir anlık görüntü de şifrelenir. Şifreleme anahtarlarının katman seviyesi şu şekildedir, **birinci katman anahtar, ikinci katman küme şifreleme anahtarı (CEK), üçüncü katman veritabanı şifreleme anahtarı (DEK) ve son olarak dördüncü katman veri şifreleme anahtarlarıdır**.

### KMS

Kümenizin oluşturulması sırasında, Redshift için **varsayılan KMS anahtarını** seçebilir veya **kendi CMK'nızı** seçebilirsiniz, bu da anahtarı denetleme açısından daha fazla esneklik sağlar.

Redshift için varsayılan KMS anahtarı, ilk kez seçildiğinde ve kullanıldığında Redshift tarafından otomatik olarak oluşturulur ve AWS tarafından tamamen yönetilir.

Bu KMS anahtarı daha sonra CMK anahtarını, yani birinci katmanı şifreler. Bu şifrelenmiş KMS veri anahtarı daha sonra küme şifreleme anahtarı (CEK), yani ikinci katman olarak kullanılır. Bu CEK daha sonra KMS tarafından Redshift'e gönderilir ve kümeden ayrı bir şekilde depolanır. Redshift daha sonra bu şifrelenmiş CEK'i güvenli bir kanal üzerinden kümelere gönderir ve bellekte depolar.

Redshift daha sonra KMS'ten CEK'i, yani ikinci katmanı şifrelemesini ister. Bu şifrelenmiş CEK daha sonra bellekte de depolanır. Redshift daha sonra rastgele bir veritabanı şifreleme anahtarı (DEK), yani üçüncü katman oluşturur ve bunu kümenin belleğine yükler. Bellekteki şifrelenmiş CEK, DEK'i şifreler ve bu da bellekte depolanır.

Bu şifrelenmiş DEK daha sonra güvenli bir kanal üzerinden gönderilir ve kümeden ayrı bir şekilde Redshift'te depolanır. Hem CEK hem de DEK artık kümenin belleğinde hem şifrelenmiş hem de şifresiz olarak depolanır. Şifresiz DEK, veritabanındaki her veri bloğu için Redshift tarafından rastgele oluşturulan veri anahtarlarını şifrelemek için kullanılır.

Amazon S3 kovalarınızın yapılandırmasını izlemek ve kovaların günlüğünün etkinleştirilip etkinleştirilmediğinden emin olmak için AWS Trusted Advisor'ı kullanabilirsiniz, bu, güvenlik denetimleri gerçekleştirmek ve S3'te kullanım modellerini izlemek için faydalı olabilir.

### CloudHSM

<details>

<summary>CloudHSM ile Redshift Kullanımı</summary>

Şifrelemenizi gerçekleştirmek için CloudHSM ile çalışırken, öncelikle HSM istemciniz ile Redshift arasında güvenilir bir bağlantı kurmanız gerekmektedir ve istemci ve sunucu sertifikalarını kullanmanız gerekmektedir.

Bu bağlantı, şifreleme anahtarlarının HSM istemciniz ile Redshift kümeniz arasında gönderilmesine izin veren güvenli iletişimi sağlamak için gereklidir. Rastgele oluşturulan özel ve genel anahtar çifti kullanarak, Redshift, şifrelenmiş ve depolanan bir genel istemci sertifikası oluşturur. Bu indirilip HSM istemcinize kaydedilmeli ve doğru HSM bölümüne atanmalıdır.

Daha sonra Redshift'i HSM istemcinizin aşağıdaki detaylarla yapılandırmanız gerekmektedir: HSM IP adresi, HSM bölüm adı, HSM bölüm şifresi ve CloudHSM tarafından içsel bir anahtar kullanılarak şifrelenen genel HSM sunucu sertifikası. Bu bilgiler sağlandıktan sonra, Redshift bağlantıyı doğrular ve geliştirme bölümüne erişebileceğini onaylar.

Dahili güvenlik politikalarınız veya yönetişim kontrolleriniz, şifreleme anahtarlarını döndürmeniz gerektiğini belirtiyorsa, bu, şifrelenmiş kümeler için şifreleme anahtarlarını döndürmenizi sağlar, ancak dikkat etmeniz gereken bir nokta, anahtar döndürme süreci sırasında kümenin çok kısa bir süre için kullanılamaz hale gelmesidir, bu nedenle anahtarları sadece ihtiyaç duyduğunuzda veya bunların tehlikeye girdiğini düşündüğünüzde döndürmek en iyisidir.

Döndürme sırasında, Redshift kümeniz için CEK'i ve o kümenin yedeklerini döndürecektir. Küme için bir DEK döndürecektir ancak DEK kullanılarak şifrelenmiş S3'de depolanan anlık görüntüler için bir DEK döndürmek mümkün değildir. İşlem tamamlandığında durum 'kullanılabilir' olarak geri dönecektir.

</details>

### Numaralandırma
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## İst Privileges

{% content-ref url="../../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Kalıcılık

Aşağıdaki eylemler kümelere diğer AWS hesaplarına erişim izni vermek için kullanılabilir:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* Hacking püf noktalarını paylaşarak PR'ler göndererek [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
