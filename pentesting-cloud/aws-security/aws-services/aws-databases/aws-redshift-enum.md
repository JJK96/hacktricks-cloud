# AWS - Redshift Enum

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Amazon Redshift

Redshift √© um servi√ßo totalmente gerenciado que pode escalar para mais de um petabyte de tamanho, usado como um **data warehouse para solu√ß√µes de big data**. Usando clusters Redshift, voc√™ pode executar an√°lises em seus conjuntos de dados usando ferramentas de consulta r√°pidas baseadas em SQL e aplicativos de intelig√™ncia de neg√≥cios para obter uma compreens√£o maior da vis√£o para o seu neg√≥cio.

**Redshift oferece criptografia em repouso usando uma hierarquia de quatro n√≠veis de chaves de criptografia usando KMS ou CloudHSM para gerenciar o n√≠vel superior de chaves**. **Quando a criptografia √© habilitada para o seu cluster, ela n√£o pode ser desabilitada e vice-versa**. Quando voc√™ tem um cluster n√£o criptografado, ele n√£o pode ser criptografado.

A criptografia para o seu cluster s√≥ pode ocorrer durante a sua cria√ß√£o e, uma vez criptografado, os dados, metadados e quaisquer snapshots tamb√©m s√£o criptografados. Os n√≠veis de hierarquia das chaves de criptografia s√£o os seguintes, **o n√≠vel um √© a chave mestra, o n√≠vel dois √© a chave de criptografia do cluster, o CEK, o n√≠vel tr√™s, a chave de criptografia do banco de dados, o DEK, e finalmente o n√≠vel quatro, as pr√≥prias chaves de criptografia dos dados**.

### KMS

Durante a cria√ß√£o do seu cluster, voc√™ pode selecionar a **chave KMS padr√£o** para Redshift ou selecionar sua **pr√≥pria CMK**, o que lhe d√° mais flexibilidade sobre o controle da chave, especificamente do ponto de vista audit√°vel.

A chave KMS padr√£o para Redshift √© criada automaticamente pelo Redshift na primeira vez que a op√ß√£o de chave √© selecionada e usada, e √© totalmente gerenciada pela AWS.

Esta chave KMS √© ent√£o criptografada com a chave mestra CMK, n√≠vel um. Esta chave de dados KMS criptografada √© ent√£o usada como a chave de criptografia do cluster, o CEK, n√≠vel dois. Este CEK √© ent√£o enviado pelo KMS para o Redshift, onde √© armazenado separadamente do cluster. O Redshift ent√£o envia este CEK criptografado para o cluster por um canal seguro onde √© armazenado na mem√≥ria.

O Redshift ent√£o solicita ao KMS para descriptografar o CEK, n√≠vel dois. Este CEK descriptografado tamb√©m √© armazenado na mem√≥ria. O Redshift ent√£o cria uma chave de criptografia de banco de dados aleat√≥ria, o DEK, n√≠vel tr√™s, e carrega isso na mem√≥ria do cluster. O CEK descriptografado na mem√≥ria criptografa o DEK, que tamb√©m √© armazenado na mem√≥ria.

Este DEK criptografado √© ent√£o enviado por um canal seguro e armazenado no Redshift separadamente do cluster. Tanto o CEK quanto o DEK agora est√£o armazenados na mem√≥ria do cluster, tanto em forma criptografada quanto descriptografada. O DEK descriptografado √© ent√£o usado para criptografar chaves de dados, n√≠vel quatro, que s√£o geradas aleatoriamente pelo Redshift para cada bloco de dados no banco de dados.

Voc√™ pode usar o AWS Trusted Advisor para monitorar a configura√ß√£o dos seus buckets do Amazon S3 e garantir que o log do bucket esteja habilitado, o que pode ser √∫til para realizar auditorias de seguran√ßa e rastrear padr√µes de uso no S3.

### CloudHSM

<details>

<summary>Usando Redshift com CloudHSM</summary>

Ao trabalhar com CloudHSM para realizar sua criptografia, primeiro voc√™ deve configurar uma conex√£o confi√°vel entre seu cliente HSM e o Redshift enquanto usa certificados de cliente e servidor.

Essa conex√£o √© necess√°ria para fornecer comunica√ß√µes seguras, permitindo que chaves de criptografia sejam enviadas entre seu cliente HSM e seus clusters Redshift. Usando um par de chaves privada e p√∫blica geradas aleatoriamente, o Redshift cria um certificado de cliente p√∫blico, que √© criptografado e armazenado pelo Redshift. Isso deve ser baixado e registrado em seu cliente HSM e atribu√≠do √† parti√ß√£o HSM correta.

Voc√™ deve ent√£o configurar o Redshift com os seguintes detalhes do seu cliente HSM: o endere√ßo IP do HSM, o nome da parti√ß√£o HSM, a senha da parti√ß√£o HSM e o certificado p√∫blico do servidor HSM, que √© criptografado pelo CloudHSM usando uma chave mestra interna. Uma vez que essas informa√ß√µes tenham sido fornecidas, o Redshift confirmar√° e verificar√° que pode se conectar e acessar a parti√ß√£o de desenvolvimento.

Se suas pol√≠ticas de seguran√ßa internas ou controles de governan√ßa ditarem que voc√™ deve aplicar a rota√ß√£o de chaves, ent√£o isso √© poss√≠vel com o Redshift, permitindo que voc√™ rotacione chaves de criptografia para clusters criptografados, no entanto, voc√™ precisa estar ciente de que durante o processo de rota√ß√£o de chaves, ele tornar√° um cluster indispon√≠vel por um per√≠odo muito curto de tempo, ent√£o √© melhor apenas rotacionar chaves conforme necess√°rio, ou se voc√™ sentir que elas podem ter sido comprometidas.

Durante a rota√ß√£o, o Redshift ir√° rotacionar o CEK para o seu cluster e para quaisquer backups desse cluster. Ele ir√° rotacionar um DEK para o cluster, mas n√£o √© poss√≠vel rotacionar um DEK para os snapshots armazenados no S3 que foram criptografados usando o DEK. Ele colocar√° o cluster em um estado de 'rotating keys' at√© que o processo seja conclu√≠do, quando o status retornar√° para 'available'.

</details>

### Enumera√ß√£o
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Eleva√ß√£o de Privil√©gios

{% content-ref url="../../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persist√™ncia

As seguintes a√ß√µes permitem conceder acesso a outras contas da AWS ao cluster:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
Aprenda e pratique Hacking na AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking no GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
