# AWS - Απαρίθμηση Redshift

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Κοινοποιήστε κόλπα χάκερ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
{% endhint %}

## Amazon Redshift

Το Redshift είναι ένα πλήρως διαχειριζόμενο υπηρεσία που μπορεί να κλιμακωθεί έως και ένα petabyte σε μέγεθος, το οποίο χρησιμοποιείται ως **αποθήκη δεδομένων για λύσεις μεγάλων δεδομένων**. Χρησιμοποιώντας συστάδες Redshift, μπορείτε να εκτελέσετε αναλύσεις εναντίον των συνόλων δεδομένων σας χρησιμοποιώντας γρήγορα εργαλεία ερωτημάτων βασισμένα σε SQL και εφαρμογές ευφυούς επιχειρηματικής νοημοσύνης για να αποκτήσετε μεγαλύτερη κατανόηση της εικόνας για την επιχείρησή σας.

**Το Redshift προσφέρει κρυπτογράφηση στην ανάπαυση χρησιμοποιώντας μια ιεραρχία τεσσάρων επιπέδων κρυπτογράφησης κλειδιών χρησιμοποιώντας είτε το KMS είτε το CloudHSM για τη διαχείριση του υψηλότερου επιπέδου κλειδιών**. **Όταν η κρυπτογράφηση είναι ενεργοποιημένη για τη συστάδα σας, δεν μπορεί να απενεργοποιηθεί και αντίστροφα**. Όταν έχετε μια μη κρυπτογραφημένη συστάδα, δεν μπορεί να κρυπτογραφηθεί.

Η κρυπτογράφηση για τη συστάδα σας μπορεί να συμβεί μόνο κατά τη δημιουργία της, και μόλις κρυπτογραφηθεί, τα δεδομένα, τα μεταδεδομένα και οποιαδήποτε αντίγραφα ασφαλίζονται επίσης. Τα επίπεδα ιεραρχίας των κλειδιών κρυπτογράφησης είναι τα εξής, **το πρώτο επίπεδο είναι το κύριο κλειδί, το δεύτερο επίπεδο είναι το κλειδί κρυπτογράφησης συστάδας, το CEK, το τρίτο επίπεδο είναι το κλειδί κρυπτογράφησης βάσης δεδομένων, το DEK, και τέλος το τέταρτο επίπεδο είναι τα ίδια τα κλειδιά κρυπτογράφησης δεδομένων**.

### KMS

Κατά τη δημιουργία της συστάδας σας, μπορείτε είτε να επιλέξετε το **προεπιλεγμένο KMS κλειδί** για το Redshift είτε να επιλέξετε το **δικό σας CMK**, το οποίο σας παρέχει μεγαλύτερη ευελιξία όσον αφορά τον έλεγχο του κλειδιού, ειδικά από μια ελεγξιμότητας σκοπιά.

Το προεπιλεγμένο KMS κλειδί για το Redshift δημιουργείται αυτόματα από το Redshift την πρώτη φορά που επιλέγεται και χρησιμοποιείται η επιλογή του κλειδιού, και διαχειρίζεται πλήρως από το AWS.

Αυτό το KMS κλειδί κρυπτογραφείται στη συνέχεια με το κύριο κλειδί CMK, το πρώτο επίπεδο. Αυτό το κρυπτογραφημένο KMS κλειδί δεδομένων χρησιμοποιείται στη συνέχεια ως κλειδί κρυπτογράφησης συστάδας, το CEK, το δεύτερο επίπεδο. Αυτό το CEK στέλνεται στο Redshift από το KMS όπου αποθηκεύεται ξεχωριστά από τη συστάδα. Στη συνέχεια, το Redshift στέλνει αυτό το κρυπτογραφημένο CEK στη συστάδα μέσω ενός ασφαλούς καναλιού όπου αποθηκεύεται στη μνήμη.

Στη συνέχεια, το Redshift ζητά από το KMS να αποκρυπτογραφήσει το CEK, το δεύτερο επίπεδο. Αυτό το αποκρυπτογραφημένο CEK αποθηκεύεται επίσης στη μνήμη. Στη συνέχεια, το Redshift δημιουργεί ένα τυχαίο κλειδί κρυπτογράφησης βάσης δεδομένων, το DEK, το τρίτο επίπεδο, και το φορτώνει στη μνήμη της συστάδας. Το αποκρυπτογραφημένο CEK στη μνήμη κρυπτογραφεί το DEK, το οποίο επίσης αποθηκεύεται στη μνήμη.

Αυτό το κρυπτογραφημένο DEK στέλνεται στη συνέχεια μέσω ενός ασφαλούς καναλιού και αποθηκεύεται στο Redshift ξεχωριστά από τη συστάδα. Και το CEK και το DEK αποθηκεύονται τώρα στη μνήμη της συστάδας τόσο σε κρυπτογραφημένη όσο και σε αποκρυπτογραφημένη μορφή. Το αποκρυπτογραφημένο DEK χρησιμοποιείται στη συνέχεια για την κρυπτογράφηση των κλειδιών δεδομένων, το τέταρτο επίπεδο, που δημιουργούνται τυχαία από το Redshift για κάθε τμήμα δεδομένων στη βάση δεδομένων.

Μπορείτε να χρησιμοποιήσετε τον AWS Trusted Advisor για την παρακολούθηση της διαμόρφωσης των κάδων Amazon S3 σας και να εξασφαλίσετε ότι η καταγραφή κάδου είναι ενεργοποιημένη, η οποία μπορεί να είναι χρήσιμη για την εκτέλεση ελέγχων ασφαλείας και την παρακολούθηση μοτίβων χρήσης στο S3.

### CloudHSM

<details>

<summary>Χρήση του Redshift με το CloudHSM</summary>

Όταν εργάζεστε με το CloudHSM για να πραγματοποιήσετε την κρυπτογράφησή σας, πρώτα πρέπει να δημιουργήσετε μια αξιόπιστη σύνδεση μεταξύ του πελάτη HSM σας και του Redshift χρησιμοποιώντας πιστοποιητικά πελάτη και διακομιστή.

Αυτή η σύνδεση απαιτείται για να παρέχει ασφαλείς επικοινωνίες, επιτρέποντας την αποστολή κλειδιών κρυπτογράφησης μεταξύ του πελάτη HSM σας και των συστάδων Redshift σας. Χρησιμοποιώντας ένα τυχαία δημιουργημένο ζεύγος ιδιωτικού και δημόσιου κλειδιού, το Redshift δημιουργεί ένα δημόσιο πιστοποιητικό πελάτη, το οποίο κρυπτογραφείται και αποθηκεύεται από το Redshift. Αυτό πρέπει να ληφθεί και να καταχωρηθεί στον πελάτη HSM σας και να ανατεθεί στο σωστό τμήμα HSM.

Στη συνέχεια πρέπει να διαμορφώσετε το Redshift με τις ακόλουθες λεπτομέρειες του πελάτη
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Ανύψωση δικαιωμάτων

{% content-ref url="../../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Διατήρηση

Οι παρακάτω ενέργειες επιτρέπουν τη χορήγηση πρόσβασης σε άλλους λογαριασμούς AWS στο cluster:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκινγκ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
{% endhint %}
