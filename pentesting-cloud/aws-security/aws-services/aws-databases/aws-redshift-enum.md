# AWS - Redshift Enum

{% hint style="success" %}
学习并练习AWS黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks培训AWS红队专家（ARTE）**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习GCP黑客技术：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks培训GCP红队专家（GRTE）**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持HackTricks</summary>

* 检查[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享黑客技巧。**

</details>
{% endhint %}

## Amazon Redshift

Redshift是一个完全托管的服务，可以扩展到超过PB的大小，用作大数据解决方案的数据仓库。使用Redshift集群，您可以使用快速的基于SQL的查询工具和商业智能应用程序对数据集运行分析，以更好地了解您的业务愿景。

**Redshift提供了在静止状态下使用四层加密密钥层次结构的加密，使用KMS或CloudHSM来管理顶层密钥**。**当为您的集群启用加密时，无法禁用加密，反之亦然**。当您有一个未加密的集群时，无法对其进行加密。

集群的加密只能在创建期间进行，一旦加密，数据、元数据和任何快照也将被加密。加密密钥的分层级别如下，**第一层是主密钥，第二层是集群加密密钥（CEK），第三层是数据库加密密钥（DEK），最后一层是数据加密密钥本身**。

### KMS

在创建集群时，您可以选择Redshift的**默认KMS密钥**或选择**自己的CMK**，这使您在审计角度上对密钥的控制更加灵活。

Redshift的默认KMS密钥是由Redshift在首次选择并使用密钥选项时自动创建的，并由AWS完全管理。

然后，此KMS密钥使用CMK主密钥（第一层）进行加密。加密的KMS数据密钥然后用作集群加密密钥（CEK，第二层）。然后，KMS将此CEK发送到Redshift，在那里它与集群分开存储。然后，Redshift将此加密的CEK通过安全通道发送到集群，存储在内存中。

然后，Redshift请求KMS解密CEK（第二层）。解密的CEK然后也存储在内存中。然后，Redshift创建一个随机的数据库加密密钥（DEK，第三层），并将其加载到集群的内存中。内存中的解密CEK然后加密DEK，DEK也存储在内存中。

然后，此加密的DEK通过安全通道发送并存储在Redshift中，与集群分开存储。CEK和DEK现在都以加密和解密形式存储在集群的内存中。解密的DEK然后用于加密数据密钥（第四层），这些数据密钥由Redshift为数据库中的每个数据块随机生成。

您可以使用AWS Trusted Advisor监视Amazon S3存储桶的配置，并确保启用了存储桶日志记录，这对执行安全审计和跟踪S3中的使用模式很有用。

### CloudHSM

<details>

<summary>使用CloudHSM与Redshift</summary>

在使用CloudHSM执行加密时，首先必须在HSM客户端和Redshift之间建立一个受信任的连接，同时使用客户端和服务器证书。

此连接需要提供安全通信，允许加密密钥在HSM客户端和Redshift集群之间发送。使用随机生成的私钥和公钥对，Redshift创建一个公共客户端证书，该证书经过加密并由Redshift存储。必须下载此证书并注册到您的HSM客户端，并分配给正确的HSM分区。

然后，您必须配置Redshift的HSM客户端以下详细信息：HSM IP地址、HSM分区名称、HSM分区密码和由CloudHSM使用内部主密钥加密的公共HSM服务器证书。提供了这些信息后，Redshift将确认并验证其是否可以连接并访问开发分区。

如果您的内部安全政策或治理控制要求您必须应用密钥轮换，则可以通过Redshift实现此目的，使您能够为加密的集群轮换加密密钥，但是您需要意识到在密钥轮换过程中，集群将在短时间内变为不可用状态，因此最好仅在需要时或者如果您认为密钥可能已被泄露时才轮换密钥。

在轮换期间，Redshift将为您的集群和该集群的任何备份轮换CEK。它将为集群轮换DEK，但无法为使用DEK加密的存储在S3中的快照轮换DEK。它将使集群处于“轮换密钥”状态，直到过程完成时，状态将返回“可用”。

</details>

### 枚举
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## 提权

{% content-ref url="../../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## 持久性

以下操作允许授予其他 AWS 帐户访问集群的权限：

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
学习并实践 AWS 黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并实践 GCP 黑客技术：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}
