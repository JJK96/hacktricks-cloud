# AWS - Verzeichnisdienste / WorkDocs Enum

{% hint style="success" %}
Lernen Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys senden.

</details>
{% endhint %}

## Verzeichnisdienste

AWS Directory Service f√ºr Microsoft Active Directory ist ein verwalteter Dienst, der es einfach macht, ein **Verzeichnis in der AWS-Cloud einzurichten, zu betreiben und zu skalieren**. Es basiert auf dem tats√§chlichen **Microsoft Active Directory** und integriert sich eng mit anderen AWS-Diensten, was es einfach macht, Ihre verzeichnisbewussten Workloads und AWS-Ressourcen zu verwalten. Mit AWS Managed Microsoft AD k√∂nnen Sie **Ihre vorhandenen** Active Directory-Benutzer, Gruppen und Richtlinien verwenden, um den Zugriff auf Ihre AWS-Ressourcen zu verwalten. Dies kann die Identit√§tsverwaltung vereinfachen und den Bedarf an zus√§tzlichen Identit√§tsl√∂sungen reduzieren. AWS Managed Microsoft AD bietet auch automatische Backups und Disaster-Recovery-Funktionen, um die Verf√ºgbarkeit und Haltbarkeit Ihres Verzeichnisses sicherzustellen. Insgesamt kann Ihnen der AWS Directory Service f√ºr Microsoft Active Directory Zeit und Ressourcen sparen, indem er einen verwalteten, hochverf√ºgbaren und skalierbaren Active Directory-Dienst in der AWS-Cloud bereitstellt.

### Optionen

Verzeichnisdienste erm√∂glichen die Erstellung von 5 Arten von Verzeichnissen:

* **AWS Managed Microsoft AD**: Hier wird ein neues **Microsoft AD in AWS** ausgef√ºhrt. Sie k√∂nnen das Admin-Passwort festlegen und auf die DCs in einem VPC zugreifen.
* **Simple AD**: Dies wird ein **Linux-Samba** Active Directory-kompatibler Server sein. Sie k√∂nnen das Admin-Passwort festlegen und auf die DCs in einem VPC zugreifen.
* **AD Connector**: Ein Proxy zum **Umleiten von Verzeichnisanfragen an Ihr vorhandenes Microsoft Active Directory**, ohne Informationen in der Cloud zu zwischenspeichern. Er wird in einem **VPC** lauschen und Sie m√ºssen **Anmeldeinformationen bereitstellen, um auf das vorhandene AD zuzugreifen**.
* **Amazon Cognito-Benutzerpools**: Dies entspricht den Cognito-Benutzerpools.
* **Cloud Directory**: Dies ist das **einfachste**. Ein **serverloses** Verzeichnis, bei dem Sie das **Schema** angeben und entsprechend der Nutzung **abgerechnet werden**.

AWS Directory Services erm√∂glicht es, mit Ihrem vorhandenen **lokalen** Microsoft AD zu **synchronisieren**, Ihr eigenes in AWS zu betreiben oder mit **anderen Verzeichnistypen zu synchronisieren**.

### Labor

Hier finden Sie ein sch√∂nes Tutorial, um Ihr eigenes Microsoft AD in AWS zu erstellen: [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html)

### Enumeration
```bash
# Get directories and DCs
aws ds describe-directories
aws ds describe-domain-controllers --directory-id <id>
# Get directory settings
aws ds describe-trusts
aws ds describe-ldaps-settings --directory-id <id>
aws ds describe-shared-directories --owner-directory-id <id>
aws ds get-directory-limits
aws ds list-certificates --directory-id <id>
aws ds describe-certificate --directory-id <id> --certificate-id <id>
```
### Anmeldung

Beachten Sie, dass, wenn die **Beschreibung** des Verzeichnisses ein **Domain** im Feld **`AccessUrl`** enthielt, es daran liegt, dass sich ein **Benutzer** wahrscheinlich mit seinen **AD-Anmeldeinformationen** bei einigen **AWS-Diensten anmelden kann:**

* `<name>.awsapps.com/connect` (Amazon Connect)
* `<name>.awsapps.com/workdocs` (Amazon WorkDocs)
* `<name>.awsapps.com/workmail` (Amazon WorkMail)
* `<name>.awsapps.com/console` (Amazon Management Console)
* `<name>.awsapps.com/start` (IAM Identity Center)

### Privilege Escalation

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md" %}
[aws-directory-services-privesc.md](../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md)
{% endcontent-ref %}

## Persistenz

### Verwendung eines AD-Benutzers

Ein **AD-Benutzer** kann √ºber eine Rolle Zugriff auf die AWS-Managementkonsole erhalten. Der **Standardbenutzername ist Admin** und es ist m√∂glich, **sein Passwort von der AWS-Konsole aus zu √§ndern**.

Daher ist es m√∂glich, **das Passwort von Admin zu √§ndern**, **einen neuen Benutzer zu erstellen** oder **das Passwort eines Benutzers zu √§ndern** und diesem Benutzer eine Rolle zu gew√§hren, um den Zugriff aufrechtzuerhalten.\
Es ist auch m√∂glich, **einen Benutzer einer Gruppe innerhalb von AD hinzuzuf√ºgen** und **dieser AD-Gruppe Zugriff auf eine Rolle zu gew√§hren** (um diese Persistenz unauff√§lliger zu gestalten).

### Teilen von AD (vom Opfer zum Angreifer)

Es ist m√∂glich, eine AD-Umgebung vom Opfer auf den Angreifer zu √ºbertragen. Auf diese Weise kann der Angreifer weiterhin auf die AD-Umgebung zugreifen.\
Dies impliziert jedoch das Teilen der verwalteten AD und das Erstellen einer VPC-Peering-Verbindung.

Eine Anleitung finden Sie hier: [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html)

### ~~Teilen von AD (vom Angreifer zum Opfer)~~

Es scheint nicht m√∂glich zu sein, Benutzern aus einer anderen AD-Umgebung Zugriff auf ein AWS-Konto zu gew√§hren.

## WorkDocs

Amazon Web Services (AWS) WorkDocs ist ein cloudbasierter **Dateispeicher- und Freigabedienst**. Es ist Teil der AWS-Suite cloudbasierter Computing-Services und soll eine sichere und skalierbare L√∂sung f√ºr Organisationen bieten, um Dateien und Dokumente zu speichern, zu teilen und zusammenzuarbeiten.

AWS WorkDocs bietet eine webbasierte Benutzeroberfl√§che, √ºber die Benutzer ihre Dateien und Dokumente hochladen, darauf zugreifen und verwalten k√∂nnen. Es bietet auch Funktionen wie Versionskontrolle, Echtzeit-Zusammenarbeit und Integration mit anderen AWS-Diensten und Tools von Drittanbietern.

### Enumeration

{% code overflow="wrap" %}
```bash
# Get AD users (Admin not included)
aws workdocs describe-users --organization-id <directory-id>
# Get AD groups (containing "a")
aws workdocs describe-groups --organization-id d-9067a0285c --search-query a

# Create user (created inside the AD)
aws workdocs create-user --username testingasd --given-name testingasd --surname testingasd --password <password> --email-address name@directory.domain --organization-id <directory-id>

# Get what each user has created
aws workdocs describe-activities --user-id "S-1-5-21-377..."

# Get what was created in the directory
aws workdocs describe-activities --organization-id <directory-id>

# Get folder content
aws workdocs describe-folder-contents --folder-id <fold-id>

# Get file (a url to access with the content will be retreived)
aws workdocs get-document --document-id <doc-id>

# Get resource permissions if any
aws workdocs describe-resource-permissions --resource-id <value>

# Add permission so anyway can see the file
aws workdocs add-resource-permissions --resource-id <id> --principals Id=anonymous,Type=ANONYMOUS,Role=VIEWER
## This will give an id, the file will be acesible in: https://<name>.awsapps.com/workdocs/index.html#/share/document/<id>
```
{% endcode %}

### Privesc

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md" %}
[aws-workdocs-privesc.md](../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
Lernen Sie & √ºben Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie & √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github Repositories einreichen.

</details>
{% endhint %}
