# AWS - Servicios de Directorio / Enumeraci칩n de WorkDocs

{% hint style="success" %}
Aprende y practica Hacking en AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* 춰Consulta los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}

## Servicios de Directorio

El Servicio de Directorio de AWS para Microsoft Active Directory es un servicio gestionado que facilita **configurar, operar y escalar un directorio** en la Nube de AWS. Est치 construido sobre **Microsoft Active Directory** real e integra estrechamente con otros servicios de AWS, lo que facilita la gesti칩n de sus cargas de trabajo conscientes del directorio y recursos de AWS. Con AWS Managed Microsoft AD, puede **utilizar sus usuarios, grupos y pol칤ticas de Active Directory existentes** para gestionar el acceso a sus recursos de AWS. Esto puede ayudar a simplificar la gesti칩n de identidades y reducir la necesidad de soluciones de identidad adicionales. AWS Managed Microsoft AD tambi칠n proporciona copias de seguridad autom치ticas y capacidades de recuperaci칩n ante desastres, lo que ayuda a garantizar la disponibilidad y durabilidad de su directorio. En general, el Servicio de Directorio de AWS para Microsoft Active Directory puede ayudarle a ahorrar tiempo y recursos al proporcionar un servicio de Active Directory gestionado, altamente disponible y escalable en la Nube de AWS.

### Opciones

Los Servicios de Directorio permiten crear 5 tipos de directorios:

* **AWS Managed Microsoft AD**: Que ejecutar치 un nuevo **Microsoft AD en AWS**. Podr치 establecer la contrase침a de administrador y acceder a los DC en una VPC.
* **Simple AD**: Que ser치 un servidor compatible con Active Directory de **Linux-Samba**. Podr치 establecer la contrase침a de administrador y acceder a los DC en una VPC.
* **AD Connector**: Un proxy para **redirigir solicitudes de directorio a su Microsoft Active Directory existente** sin almacenar en cach칠 ninguna informaci칩n en la nube. Estar치 escuchando en una **VPC** y necesitar치 dar **credenciales para acceder al AD existente**.
* **Amazon Cognito User Pools**: Esto es lo mismo que Cognito User Pools.
* **Cloud Directory**: Este es el **m치s simple**. Un directorio **serverless** donde indica el **esquema** a utilizar y se le **factura seg칰n el uso**.

Los servicios de directorio de AWS permiten **sincronizar** con su **Microsoft AD local existente**, **ejecutar el suyo propio** en AWS o sincronizar con **otros tipos de directorios**.

### Laboratorio

Aqu칤 puedes encontrar un buen tutorial para crear tu propio Microsoft AD en AWS: [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html)

### Enumeraci칩n
```bash
# Get directories and DCs
aws ds describe-directories
aws ds describe-domain-controllers --directory-id <id>
# Get directory settings
aws ds describe-trusts
aws ds describe-ldaps-settings --directory-id <id>
aws ds describe-shared-directories --owner-directory-id <id>
aws ds get-directory-limits
aws ds list-certificates --directory-id <id>
aws ds describe-certificate --directory-id <id> --certificate-id <id>
```
### Inicio de sesi칩n

Tenga en cuenta que si la **descripci칩n** del directorio contiene un **dominio** en el campo **`AccessUrl`** es porque un **usuario** probablemente pueda **iniciar sesi칩n** con sus **credenciales de AD** en algunos **servicios de AWS:**

* `<name>.awsapps.com/connect` (Amazon Connect)
* `<name>.awsapps.com/workdocs` (Amazon WorkDocs)
* `<name>.awsapps.com/workmail` (Amazon WorkMail)
* `<name>.awsapps.com/console` (Consola de administraci칩n de Amazon)
* `<name>.awsapps.com/start` (Centro de identidad IAM)

### Escalada de privilegios

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md" %}
[aws-directory-services-privesc.md](../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md)
{% endcontent-ref %}

## Persistencia

### Usando un usuario de AD

Un **usuario de AD** puede recibir **acceso a la consola de administraci칩n de AWS** a trav칠s de un Rol para asumir. El **nombre de usuario predeterminado es Admin** y es posible **cambiar su contrase침a** desde la consola de AWS.

Por lo tanto, es posible **cambiar la contrase침a de Admin**, **crear un nuevo usuario** o **cambiar la contrase침a** de un usuario y otorgarle un Rol para mantener el acceso.\
Tambi칠n es posible **agregar un usuario a un grupo dentro de AD** y **darle a ese grupo de AD acceso a un Rol** (para hacer esta persistencia m치s sigilosa).

### Compartir AD (de la v칤ctima al atacante)

Es posible compartir un entorno de AD de una v칤ctima a un atacante. De esta manera, el atacante podr치 seguir accediendo al entorno de AD.\
Sin embargo, esto implica compartir el AD administrado y tambi칠n crear una conexi칩n de emparejamiento de VPC.

Puede encontrar una gu칤a aqu칤: [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html)

### ~~Compartir AD (del atacante a la v칤ctima)~~

No parece posible otorgar acceso de AWS a usuarios de un entorno de AD diferente a una cuenta de AWS.

## WorkDocs

Amazon Web Services (AWS) WorkDocs es un servicio de **almacenamiento y compartici칩n de archivos** basado en la nube. Forma parte de la suite de servicios de computaci칩n en la nube de AWS y est치 dise침ado para proporcionar una soluci칩n segura y escalable para que las organizaciones almacenen, compartan y colaboren en archivos y documentos.

AWS WorkDocs proporciona una interfaz basada en web para que los usuarios suban, accedan y gestionen sus archivos y documentos. Tambi칠n ofrece funciones como control de versiones, colaboraci칩n en tiempo real e integraci칩n con otros servicios de AWS y herramientas de terceros.

### Enumeraci칩n

{% code overflow="wrap" %}
```bash
# Get AD users (Admin not included)
aws workdocs describe-users --organization-id <directory-id>
# Get AD groups (containing "a")
aws workdocs describe-groups --organization-id d-9067a0285c --search-query a

# Create user (created inside the AD)
aws workdocs create-user --username testingasd --given-name testingasd --surname testingasd --password <password> --email-address name@directory.domain --organization-id <directory-id>

# Get what each user has created
aws workdocs describe-activities --user-id "S-1-5-21-377..."

# Get what was created in the directory
aws workdocs describe-activities --organization-id <directory-id>

# Get folder content
aws workdocs describe-folder-contents --folder-id <fold-id>

# Get file (a url to access with the content will be retreived)
aws workdocs get-document --document-id <doc-id>

# Get resource permissions if any
aws workdocs describe-resource-permissions --resource-id <value>

# Add permission so anyway can see the file
aws workdocs add-resource-permissions --resource-id <id> --principals Id=anonymous,Type=ANONYMOUS,Role=VIEWER
## This will give an id, the file will be acesible in: https://<name>.awsapps.com/workdocs/index.html#/share/document/<id>
```
{% endcode %}

### Escalada de privilegios

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md" %}
[aws-workdocs-privesc.md](../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
Aprende y practica Hacking en AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos en** **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
