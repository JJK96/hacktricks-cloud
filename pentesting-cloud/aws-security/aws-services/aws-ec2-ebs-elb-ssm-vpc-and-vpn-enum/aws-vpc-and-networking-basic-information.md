# AWS - VPC & Networking Basic Information

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## R√©seau AWS en Bref

Un **VPC** contient un **CIDR r√©seau** comme 10.0.0.0/16 (avec sa **table de routage** et son **ACL r√©seau**).

Ce r√©seau VPC est divis√© en **sous-r√©seaux**, donc un **sous-r√©seau** est directement **li√©** au **VPC**, √† la **table de routage** et √† l'**ACL r√©seau**.

Ensuite, les **Interfaces R√©seau** attach√©es aux services (comme les instances EC2) sont **connect√©es** aux **sous-r√©seaux** avec des **groupes de s√©curit√©**.

Ainsi, un **groupe de s√©curit√©** limitera les ports expos√©s des **interfaces r√©seau qui l'utilisent**, **ind√©pendamment du sous-r√©seau**. Et un **ACL r√©seau** **limitera** les ports expos√©s √† l'**ensemble du r√©seau**.

De plus, pour **acc√©der √† Internet**, il y a quelques configurations int√©ressantes √† v√©rifier :

* Un **sous-r√©seau** peut **attribuer automatiquement des adresses IPv4 publiques**
* Une **instance** cr√©√©e dans le r√©seau qui **attribue automatiquement des adresses IPv4 peut en obtenir une**
* Une **passerelle Internet** doit √™tre **attach√©e** au **VPC**
* Vous pouvez √©galement utiliser des **passerelles Internet uniquement sortantes**
* Vous pouvez √©galement avoir une **passerelle NAT** dans un **sous-r√©seau priv√©** afin qu'il soit possible de **se connecter √† des services externes** depuis ce sous-r√©seau priv√©, mais il est **impossible de les atteindre de l'ext√©rieur**.
* La passerelle NAT peut √™tre **publique** (acc√®s √† Internet) ou **priv√©e** (acc√®s √† d'autres VPC)

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) vous permet de **lancer des ressources AWS dans un r√©seau virtuel** que vous avez d√©fini. Ce r√©seau virtuel aura plusieurs sous-r√©seaux, des passerelles Internet pour acc√©der √† Internet, des ACL, des groupes de s√©curit√©, des IP...

### Sous-r√©seaux

Les sous-r√©seaux aident √† renforcer un niveau de s√©curit√© plus √©lev√©. **Le regroupement logique de ressources similaires** vous aide √©galement √† maintenir une **facilit√© de gestion** de votre infrastructure.

* Les CIDR valides vont d'un masque de r√©seau /16 √† un masque de r√©seau /28.
* Un sous-r√©seau ne peut pas √™tre dans diff√©rentes zones de disponibilit√© en m√™me temps.
* **AWS r√©serve les trois premi√®res adresses IP d'h√¥te** de chaque sous-r√©seau **pour** **l'utilisation interne d'AWS** : la premi√®re adresse d'h√¥te utilis√©e est pour le routeur VPC. La deuxi√®me adresse est r√©serv√©e pour AWS DNS et la troisi√®me adresse est r√©serv√©e pour une utilisation future.
* On appelle **sous-r√©seaux publics** ceux qui ont un **acc√®s direct √† Internet, tandis que les sous-r√©seaux priv√©s n'en ont pas.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tables de Routage

Les tables de routage d√©terminent le routage du trafic pour un sous-r√©seau au sein d'un VPC. Elles d√©terminent quel trafic r√©seau est achemin√© vers Internet ou vers une connexion VPN. Vous trouverez g√©n√©ralement l'acc√®s √† :

* VPC local
* NAT
* Passerelles Internet / Passerelles Internet uniquement sortantes (n√©cessaires pour donner √† un VPC l'acc√®s √† Internet).
* Pour rendre un sous-r√©seau public, vous devez **cr√©er** et **attacher** une **passerelle Internet** √† votre VPC.
* Points de terminaison VPC (pour acc√©der √† S3 depuis des r√©seaux priv√©s)

Dans les images suivantes, vous pouvez v√©rifier les diff√©rences entre un r√©seau public par d√©faut et un r√©seau priv√© :

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Network Access Control Lists (ACLs)** : Les ACL r√©seau sont des r√®gles de pare-feu qui contr√¥lent le trafic r√©seau entrant et sortant vers un sous-r√©seau. Elles peuvent √™tre utilis√©es pour autoriser ou refuser le trafic vers des adresses IP ou des plages sp√©cifiques.

* Il est plus fr√©quent d'autoriser/refuser l'acc√®s en utilisant des groupes de s√©curit√©, mais c'est le seul moyen de couper compl√®tement les shells invers√©s √©tablis. Une r√®gle modifi√©e dans un groupe de s√©curit√© n'arr√™te pas les connexions d√©j√† √©tablies.
* Cependant, cela s'applique √† l'ensemble du sous-r√©seau, soyez prudent lorsque vous interdisez des choses car des fonctionnalit√©s n√©cessaires pourraient √™tre perturb√©es.

### Groupes de S√©curit√©

Les groupes de s√©curit√© sont un **pare-feu virtuel** qui contr√¥le le trafic r√©seau entrant et sortant **vers les instances** dans un VPC. Relation 1 SG √† M instances (g√©n√©ralement 1 √† 1).\
Cela est g√©n√©ralement utilis√© pour ouvrir des ports dangereux dans les instances, comme le port 22 par exemple :

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Adresses IP √âlastiques

Une _adresse IP √©lastique_ est une **adresse IPv4 statique** con√ßue pour l'informatique en nuage dynamique. Une adresse IP √©lastique est allou√©e √† votre compte AWS et vous appartient jusqu'√† ce que vous la lib√©riez. En utilisant une adresse IP √©lastique, vous pouvez masquer la d√©faillance d'une instance ou d'un logiciel en remappant rapidement l'adresse √† une autre instance de votre compte.

### Connexion entre sous-r√©seaux

Par d√©faut, tous les sous-r√©seaux ont **l'attribution automatique des adresses IP publiques d√©sactiv√©e**, mais cela peut √™tre activ√©.

**Une route locale dans une table de routage permet la communication entre les sous-r√©seaux VPC.**

Si vous **connectez un sous-r√©seau √† un autre sous-r√©seau, vous ne pouvez pas acc√©der aux sous-r√©seaux connect√©s** avec l'autre sous-r√©seau, vous devez cr√©er une connexion avec eux directement. **Cela s'applique √©galement aux passerelles Internet**. Vous ne pouvez pas passer par une connexion de sous-r√©seau pour acc√©der √† Internet, vous devez attribuer la passerelle Internet √† votre sous-r√©seau.

### VPC Peering

Le VPC peering vous permet de **connecter deux ou plusieurs VPC ensemble**, en utilisant IPV4 ou IPV6, comme s'ils faisaient partie du m√™me r√©seau.

Une fois la connectivit√© de pair √©tablie, **les ressources dans un VPC peuvent acc√©der aux ressources dans l'autre**. La connectivit√© entre les VPC est mise en ≈ìuvre via l'infrastructure r√©seau AWS existante, elle est donc hautement disponible sans goulot d'√©tranglement de bande passante. Comme **les connexions de pair fonctionnent comme si elles faisaient partie du m√™me r√©seau**, il y a des restrictions concernant les plages de blocs CIDR qui peuvent √™tre utilis√©es.\
Si vous avez des **plages CIDR qui se chevauchent ou sont en double** pour votre VPC, alors **vous ne pourrez pas mettre en pair les VPC** ensemble.\
Chaque VPC AWS **ne communiquera qu'avec son pair**. Par exemple, si vous avez une connexion de pair entre VPC 1 et VPC 2, et une autre connexion entre VPC 2 et VPC 3 comme indiqu√©, alors VPC 1 et 2 pourraient communiquer directement, tout comme VPC 2 et VPC 3, cependant, VPC 1 et VPC 3 ne pourraient pas. **Vous ne pouvez pas router √† travers un VPC pour acc√©der √† un autre.**

### **VPC Flow Logs**

Dans votre VPC, vous pourriez potentiellement avoir des centaines voire des milliers de ressources communiquant entre diff√©rents sous-r√©seaux, √† la fois publics et priv√©s, et √©galement entre diff√©rents VPC via des connexions de pair VPC. **Les VPC Flow Logs vous permettent de capturer les informations de trafic IP qui circulent entre vos interfaces r√©seau de vos ressources au sein de votre VPC**.

Contrairement aux journaux d'acc√®s S3 et aux journaux d'acc√®s CloudFront, les **donn√©es de journal g√©n√©r√©es par les VPC Flow Logs ne sont pas stock√©es dans S3. Au lieu de cela, les donn√©es de journal captur√©es sont envoy√©es aux journaux CloudWatch**.

Limitations :

* Si vous ex√©cutez une connexion de pair VPC, vous ne pourrez voir que les journaux de flux des VPC de pair qui sont dans le m√™me compte.
* Si vous ex√©cutez encore des ressources dans l'environnement EC2-Classic, vous ne pourrez malheureusement pas r√©cup√©rer d'informations de leurs interfaces.
* Une fois qu'un VPC Flow Log a √©t√© cr√©√©, il ne peut pas √™tre modifi√©. Pour modifier la configuration du VPC Flow Log, vous devez le supprimer puis en recr√©er un nouveau.
* Le trafic suivant n'est pas surveill√© et captur√© par les journaux. Le trafic DHCP au sein du VPC, le trafic des instances destin√© au serveur DNS Amazon.
* Tout trafic destin√© √† l'adresse IP du routeur par d√©faut du VPC et le trafic vers et depuis les adresses suivantes, 169.254.169.254 qui est utilis√© pour recueillir les m√©tadonn√©es des instances, et 169.254.169.123 qui est utilis√© pour le service de synchronisation de l'heure Amazon.
* Trafic li√© √† une licence d'activation Windows Amazon √† partir d'une instance Windows.
* Trafic entre une interface de chargeur de r√©seau et une interface de point de terminaison.

Pour chaque interface r√©seau qui publie des donn√©es dans le groupe de journaux CloudWatch, elle utilisera un flux de journaux diff√©rent. Et dans chacun de ces flux, il y aura les donn√©es d'√©v√©nements de journaux de flux qui montrent le contenu des entr√©es de journal. Chacun de ces **journaux capture des donn√©es pendant une fen√™tre d'environ 10 √† 15 minutes**.

## VPN

### Composants de base du VPN AWS

1. **Customer Gateway** :
* Une Customer Gateway est une ressource que vous cr√©ez dans AWS pour repr√©senter votre c√¥t√© d'une connexion VPN.
* C'est essentiellement un appareil physique ou une application logicielle de votre c√¥t√© de la connexion VPN Site-to-Site.
* Vous fournissez des informations de routage et l'adresse IP publique de votre appareil r√©seau (comme un routeur ou un pare-feu) √† AWS pour cr√©er une Customer Gateway.
* Elle sert de point de r√©f√©rence pour configurer la connexion VPN et n'entra√Æne pas de frais suppl√©mentaires.
2. **Virtual Private Gateway** :
* Une Virtual Private Gateway (VPG) est le concentrateur VPN du c√¥t√© Amazon de la connexion VPN Site-to-Site.
* Elle est attach√©e √† votre VPC et sert de cible pour votre connexion VPN.
* VPG est le point de terminaison c√¥t√© AWS pour la connexion VPN.
* Elle g√®re la communication s√©curis√©e entre votre VPC et votre r√©seau sur site.
3. **Site-to-Site VPN Connection** :
* Une connexion VPN Site-to-Site connecte votre r√©seau sur site √† un VPC via un tunnel VPN s√©curis√© IPsec.
* Ce type de connexion n√©cessite une Customer Gateway et une Virtual Private Gateway.
* Elle est utilis√©e pour une communication s√©curis√©e, stable et coh√©rente entre votre centre de donn√©es ou r√©seau et votre environnement AWS.
* Typiquement utilis√©e pour des connexions r√©guli√®res et √† long terme et est factur√©e en fonction de la quantit√© de donn√©es transf√©r√©es sur la connexion.
4. **Client VPN Endpoint** :
* Un point de terminaison Client VPN est une ressource que vous cr√©ez dans AWS pour activer et g√©rer les sessions VPN client.
* Il est utilis√© pour permettre √† des appareils individuels (comme des ordinateurs portables, des smartphones, etc.) de se connecter en toute s√©curit√© aux ressources AWS ou √† votre r√©seau sur site.
* Il diff√®re du VPN Site-to-Site en ce qu'il est con√ßu pour des clients individuels plut√¥t que pour connecter des r√©seaux entiers.
* Avec Client VPN, chaque appareil client utilise un logiciel client VPN pour √©tablir une connexion s√©curis√©e.

### Site-to-Site VPN

**Connectez votre r√©seau sur site √† votre VPC.**

* **Connexion VPN** : Une connexion s√©curis√©e entre votre √©quipement sur site et vos VPC.
* **Tunnel VPN** : Un lien crypt√© o√π les donn√©es peuvent passer du r√©seau client vers ou depuis AWS.

Chaque connexion VPN comprend deux tunnels VPN que vous pouvez utiliser simultan√©ment pour une haute disponibilit√©.
* **Customer gateway** : Une ressource AWS qui fournit des informations √† AWS sur votre appareil de passerelle client.
* **Appareil de passerelle client** : Un appareil physique ou une application logicielle de votre c√¥t√© de la connexion VPN Site-to-Site.
* **Virtual private gateway** : Le concentrateur VPN du c√¥t√© Amazon de la connexion VPN Site-to-Site. Vous utilisez une passerelle priv√©e virtuelle ou une passerelle de transit comme passerelle pour le c√¥t√© Amazon de la connexion VPN Site-to-Site.
* **Transit gateway** : Un hub de transit qui peut √™tre utilis√© pour interconnecter vos VPC et r√©seaux sur site. Vous utilisez une passerelle de transit ou une passerelle priv√©e virtuelle comme passerelle pour le c√¥t√© Amazon de la connexion VPN Site-to-Site.

#### Limitations

* Le trafic IPv6 n'est pas pris en charge pour les connexions VPN sur une passerelle priv√©e virtuelle.
* Une connexion VPN AWS ne prend pas en charge la d√©couverte de MTU de chemin.

De plus, prenez en consid√©ration les √©l√©ments suivants lorsque vous utilisez Site-to-Site VPN.

* Lors de la connexion de vos VPC √† un r√©seau sur site commun, nous vous recommandons d'utiliser des blocs CIDR non chevauchants pour vos r√©seaux.

### Client VPN <a href="#what-is-components" id="what-is-components"></a>

**Connectez-vous depuis votre machine √† votre VPC**

#### Concepts

* **Client VPN endpoint** : La ressource que vous cr√©ez et configurez pour activer et g√©rer les sessions VPN client. C'est la ressource o√π toutes les sessions VPN client sont termin√©es.
* **R√©seau cible** : Un r√©seau cible est le r√©seau que vous associez √† un point de terminaison Client VPN. **Un sous-r√©seau d'un VPC est un r√©seau cible**. Associer un sous-r√©seau √† un point de terminaison Client VPN vous permet d'√©tablir des sessions VPN. Vous pouvez associer plusieurs sous-r√©seaux √† un point de terminaison Client VPN pour une haute disponibilit√©. Tous les sous-r√©seaux doivent
