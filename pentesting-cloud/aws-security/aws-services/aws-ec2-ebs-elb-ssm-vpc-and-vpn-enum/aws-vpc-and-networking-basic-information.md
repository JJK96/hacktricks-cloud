# AWS - VPC & Networking Basic Information

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Discord grubuna** 💬 [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub depolarına.

</details>
{% endhint %}

## AWS Networking Kısaca

Bir **VPC**, 10.0.0.0/16 gibi bir **ağ CIDR** içerir (kendi **yönlendirme tablosu** ve **ağ ACL** ile birlikte).

Bu VPC ağı, **alt ağlara** bölünmüştür, bu nedenle bir **alt ağ** doğrudan **VPC**, **yönlendirme tablosu** ve **ağ ACL** ile **ilişkilidir**.

Daha sonra, hizmetlere (örneğin EC2 örnekleri gibi) eklenen **Ağ Arayüzleri**, **güvenlik grubu/grupları** ile **alt ağlara** **bağlanır**.

Bu nedenle, bir **güvenlik grubu**, **alt ağdan bağımsız olarak** onu kullanan ağ **arayüzlerinin** açık portlarını sınırlar. Ve bir **ağ ACL** tüm ağa açık portları **sınırlar**.

Ayrıca, **İnternet'e erişmek** için kontrol edilmesi gereken bazı ilginç yapılandırmalar vardır:

* Bir **alt ağ** **otomatik olarak genel IPv4 adresleri atayabilir**
* Ağda oluşturulan bir **örnek**, otomatik olarak IPv4 adresleri atayan bir ağda oluşturulmuşsa bir tane alabilir
* Bir **İnternet geçidi** **VPC'ye eklenmelidir**
* **Sadece çıkış internet geçitleri** de kullanabilirsiniz
* **Özel bir alt ağda** bir **NAT geçidi** de olabilir, böylece bu özel alt ağdan **dış hizmetlere bağlanmak** mümkün olur, ancak dışarıdan onlara ulaşmak **mümkün olmaz**.
* NAT geçidi **genel** (internete erişim) veya **özel** (diğer VPC'lere erişim) olabilir

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC), **AWS kaynaklarını tanımladığınız sanal bir ağa başlatmanıza** olanak tanır. Bu sanal ağ, İnternet'e erişim için birkaç alt ağ, İnternet Geçitleri, ACL'ler, Güvenlik grupları, IP'ler... içerecektir.

### Alt Ağlar

Alt ağlar, daha yüksek bir güvenlik seviyesi sağlamaya yardımcı olur. **Benzer kaynakların mantıksal gruplandırılması**, altyapınız genelinde **yönetim kolaylığı** sağlamaya da yardımcı olur.

* Geçerli CIDR, /16 ağ maskesinden /28 ağ maskesine kadardır.
* Bir alt ağ aynı anda farklı kullanılabilirlik bölgelerinde olamaz.
* **AWS, her alt ağın ilk üç ana bilgisayar IP adresini** **iç kullanım için** **ayırır**: İlk ana bilgisayar adresi VPC yönlendiricisi için kullanılır. İkinci adres AWS DNS için ayrılmıştır ve üçüncü adres gelecekteki kullanım için ayrılmıştır.
* **Doğrudan İnternet'e erişimi olan alt ağlara** **genel alt ağlar** denir, özel alt ağlar ise doğrudan İnternet'e erişemez.

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Yönlendirme Tabloları

Yönlendirme tabloları, bir VPC içindeki bir alt ağ için trafik yönlendirmesini belirler. İnternete veya bir VPN bağlantısına hangi ağ trafiğinin yönlendirileceğini belirlerler. Genellikle erişimi bulacaksınız:

* Yerel VPC
* NAT
* İnternet Geçitleri / Sadece Çıkış İnternet Geçitleri (bir VPC'ye İnternet'e erişim sağlamak için gereklidir).
* Bir alt ağı genel yapmak için, **VPC'nize bir İnternet geçidi oluşturmanız ve eklemeniz** gerekir.
* VPC uç noktaları (özel ağlardan S3'e erişmek için)

Aşağıdaki resimlerde, varsayılan bir genel ağ ile özel bir ağ arasındaki farkları kontrol edebilirsiniz:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACL'ler

**Ağ Erişim Kontrol Listeleri (ACL'ler)**: Ağ ACL'leri, bir alt ağa gelen ve giden ağ trafiğini kontrol eden güvenlik duvarı kurallarıdır. Belirli IP adreslerine veya aralıklarına trafiği izin vermek veya engellemek için kullanılabilirler.

* Erişimi güvenlik gruplarını kullanarak izin vermek/engellemek en yaygın olanıdır, ancak bu, zaten kurulmuş ters kabukları tamamen kesmenin tek yoludur. Bir güvenlik grubundaki değiştirilmiş bir kural, zaten kurulmuş bağlantıları durdurmaz
* Ancak, bu tüm alt ağa uygulanır, işlevselliği engellerken dikkatli olun çünkü gerekli işlevsellik bozulabilir

### Güvenlik Grupları

Güvenlik grupları, bir VPC'deki örneklere gelen ve giden ağ **trafiğini kontrol eden sanal bir** **güvenlik duvarıdır**. 1 SG'den M örneğe ilişki (genellikle 1'e 1).\
Genellikle bu, örneklerde tehlikeli portları açmak için kullanılır, örneğin port 22:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastic IP Adresleri

Bir _Elastic IP adresi_, dinamik bulut bilişim için tasarlanmış **statik bir IPv4 adresidir**. Bir Elastic IP adresi AWS hesabınıza tahsis edilir ve serbest bırakana kadar sizindir. Bir Elastic IP adresi kullanarak, bir örneğin veya yazılımın arızasını hızla başka bir örneğe yeniden eşleyerek maskeleyebilirsiniz.

### Alt Ağlar Arası Bağlantı

Varsayılan olarak, tüm alt ağlar **otomatik olarak genel IP adreslerinin atanmasını kapalı** olarak gelir, ancak açılabilir.

**Bir yönlendirme tablosundaki yerel bir rota, VPC alt ağları arasında iletişimi sağlar.**

Farklı bir alt ağı **bağlıyorsanız, diğer alt ağlarla bağlantılı alt ağlara erişemezsiniz**, onlarla doğrudan bağlantı oluşturmanız gerekir. **Bu aynı zamanda internet geçitleri için de geçerlidir**. İnternete erişmek için bir alt ağ bağlantısından geçemezsiniz, internet geçidini alt ağınıza atamanız gerekir.

### VPC Peering

VPC peering, **iki veya daha fazla VPC'yi birbirine bağlamanızı** sağlar, IPV4 veya IPV6 kullanarak, sanki aynı ağın bir parçasıymış gibi.

Peer bağlantısı kurulduktan sonra, **bir VPC'deki kaynaklar diğer VPC'deki kaynaklara erişebilir**. VPC'ler arasındaki bağlantı mevcut AWS ağ altyapısı üzerinden gerçekleştirilir, bu nedenle yüksek kullanılabilirliklidir ve bant genişliği darboğazı yoktur. **Peer bağlantıları aynı ağın bir parçasıymış gibi çalıştığından**, kullanılabilecek CIDR blok aralıkları konusunda kısıtlamalar vardır.\
**Çakışan veya yinelenen CIDR** aralıklarına sahip VPC'leriniz varsa, **VPC'leri birbirine peer yapamazsınız**.\
Her AWS VPC **yalnızca kendi peer'i ile iletişim kurar**. Örneğin, VPC 1 ve VPC 2 arasında bir peering bağlantınız varsa ve VPC 2 ve VPC 3 arasında başka bir bağlantı varsa, VPC 1 ve 2 doğrudan birbirleriyle iletişim kurabilir, VPC 2 ve VPC 3 de doğrudan iletişim kurabilir, ancak VPC 1 ve VPC 3 doğrudan iletişim kuramaz. **Bir VPC'den diğerine yönlendirme yapamazsınız.**

### **VPC Flow Logs**

VPC'nizde, hem genel hem de özel alt ağlar arasında ve ayrıca VPC peering bağlantıları aracılığıyla farklı alt ağlar arasında iletişim kuran yüzlerce veya hatta binlerce kaynak olabilir. **VPC Flow Logs, VPC'nizdeki kaynaklarınızın ağ arayüzleri arasında akan IP trafiği bilgilerini yakalamanıza olanak tanır**.

S3 erişim günlükleri ve CloudFront erişim günlüklerinden farklı olarak, **VPC Flow Logs tarafından üretilen günlük verileri S3'te saklanmaz. Bunun yerine, yakalanan günlük verileri CloudWatch günlüklerine gönderilir**.

Sınırlamalar:

* Bir VPC peering bağlantısı çalıştırıyorsanız, yalnızca aynı hesap içindeki peered VPC'lerin akış günlüklerini görebilirsiniz.
* EC2-Classic ortamında hala kaynak çalıştırıyorsanız, maalesef arayüzlerinden bilgi alamazsınız
* Bir VPC Flow Log oluşturulduktan sonra değiştirilemez. VPC Flow Log yapılandırmasını değiştirmek için onu silip yeni bir tane oluşturmanız gerekir.
* Aşağıdaki trafik günlükler tarafından izlenmez ve yakalanmaz. VPC içindeki DHCP trafiği, Amazon DNS Sunucusuna yönelik örneklerden gelen trafik.
* VPC varsayılan yönlendiricisinin IP adresine yönelik trafik ve aşağıdaki adreslere yönelik trafik, 169.254.169.254 örnek meta verilerini toplamak için kullanılır ve 169.254.169.123 Amazon Zaman Senkronizasyon Hizmeti için kullanılır.
* Bir Amazon Windows etkinleştirme lisansı ile ilgili trafik bir Windows örneğinden
* Bir ağ yük dengeleyici arayüzü ile bir uç nokta ağ arayüzü arasındaki trafik

CloudWatch günlük grubuna veri yayınlayan her ağ arayüzü için farklı bir günlük akışı kullanılır. Ve bu akışların her birinde, günlük girişlerinin içeriğini gösteren akış günlük olay verileri olacaktır. Bu **günlüklerin her biri yaklaşık 10 ila 15 dakikalık bir pencere sırasında verileri yakalar**.

## VPN

### Temel AWS VPN Bileşenleri

1. **Customer Gateway**:
* Customer Gateway, bir VPN bağlantısının sizin tarafınızı temsil etmek için AWS'de oluşturduğunuz bir kaynaktır.
* Site-to-Site VPN bağlantısının sizin tarafınızdaki fiziksel bir cihaz veya yazılım uygulamasıdır.
* AWS'ye yönlendirme bilgilerini ve ağ cihazınızın (örneğin bir yönlendirici veya güvenlik duvarı) genel IP adresini sağlarsınız.
* VPN bağlantısını kurmak için bir referans noktası olarak hizmet eder ve ek ücret gerektirmez.
2. **Virtual Private Gateway**:
* Virtual Private Gateway (VPG), Site-to-Site VPN bağlantısının Amazon tarafındaki VPN yoğunlaştırıcısıdır.
* VPC'nize eklenir ve VPN bağlantınızın hedefi olarak hizmet eder.
* VPG, VPN bağlantısının AWS tarafındaki uç noktasıdır.
* VPC'niz ile yerel ağınız arasındaki güvenli iletişimi sağlar.
3. **Site-to-Site VPN Connection**:
* Site-to-Site VPN bağlantısı, yerel ağınızı güvenli bir IPsec VPN tüneli aracılığıyla bir VPC'ye bağlar.
* Bu tür bir bağlantı, bir Customer Gateway ve bir Virtual Private Gateway gerektirir.
* Verilerinizi AWS ortamınıza güvenli, istikrarlı ve tutarlı bir şekilde iletmek için kullanılır.
* Genellikle düzenli, uzun vadeli bağlantılar için kullanılır ve bağlantı üzerinden aktarılan veri miktarına göre faturalandırılır.
4. **Client VPN Endpoint**:
* Client VPN endpoint, AWS'de oluşturduğunuz ve client VPN oturumlarını yönetmek için kullandığınız bir kaynaktır.
* Bireysel cihazların (dizüstü bilgisayarlar, akıllı telefonlar vb.) AWS kaynaklarına veya yerel ağınıza güvenli bir şekilde bağlanmasını sağlar.
* Site-to-Site VPN'den farklı olarak, tüm ağları bağlamak yerine bireysel istemciler için tasarlanmıştır.
* Client VPN ile her istemci cihazı, güvenli bir bağlantı kurmak için bir VPN istemci yazılımı kullanır.

### Site-to-Site VPN

**Yerel ağınızı VPC'nizle bağlayın.**

* **VPN bağlantısı**: Yerel ekipmanınız ile VPC'leriniz arasında güvenli bir bağlantı.
* **VPN tüneli**: Müşteri ağından AWS'ye veya AWS'den veri geçişi için şifrelenmiş bir bağlantı.

Her VPN bağlantısı, yüksek kullanılabilirlik için aynı anda kullanabileceğiniz iki VPN tüneli içerir.
* **Customer gateway**: AWS'ye müşteri ağ geçidi cihazınız hakkında bilgi sağlayan bir AWS kaynağı.
* **Customer gateway cihazı**: Site-to-Site VPN bağlantısının sizin tarafınızdaki fiziksel bir cihaz veya yazılım uygulaması.
* **Virtual private gateway**: Site-to-Site VPN bağlantısının Amazon tarafındaki VPN yoğunlaştırıcısı. Amazon tarafındaki Site-to-Site VPN bağlantısı için bir sanal özel ağ geçidi veya transit ağ geçidi kullanırsınız.
* **Transit gateway**: VPC'lerinizi ve yerel ağlarınızı birbirine bağlamak için kullanılabilecek bir transit hub. Amazon tarafındaki Site-to-Site VPN bağlantısı için bir transit ağ geçidi veya sanal özel ağ geçidi kullanırsınız.

#### Sınırlamalar

* IPv6 trafiği, sanal özel ağ geçidindeki VPN bağlantıları için desteklenmez.
* Bir AWS VPN bağlantısı Path MTU Discovery'yi desteklemez.

Ayrıca, Site-to-Site VPN kullanırken aşağıdakileri göz önünde bulundurun.

* VPC'lerinizi ortak bir yerel ağa bağlarken, ağlarınız için örtüşmeyen CIDR blokları kullanmanızı öneririz.

### Client VPN <a href="#what-is-components" id="what-is-components"></a>

**Makinenizden VPC'nize bağlanın**

#### Kavramlar

* **
