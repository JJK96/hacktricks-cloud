# AWS - VPC & Networking Basic Information

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## AWS Networking en Resumen

Un **VPC** contiene un **network CIDR** como 10.0.0.0/16 (con su **tabla de enrutamiento** y **ACL de red**).

Esta red VPC se divide en **subredes**, por lo que una **subred** est치 directamente **relacionada** con la **VPC**, **tabla de enrutamiento** y **ACL de red**.

Luego, las **Network Interface**s adjuntas a servicios (como instancias EC2) est치n **conectadas** a las **subredes** con **grupo(s) de seguridad**.

Por lo tanto, un **grupo de seguridad** limitar치 los puertos expuestos de las **interfaces de red que lo usan**, **independientemente de la subred**. Y una **ACL de red** **limitar치** los puertos expuestos a toda la **red**.

Adem치s, para **acceder a Internet**, hay algunas configuraciones interesantes a verificar:

* Una **subred** puede **asignar autom치ticamente direcciones IPv4 p칰blicas**
* Una **instancia** creada en la red que **asigna autom치ticamente direcciones IPv4 puede obtener una**
* Un **Internet gateway** necesita estar **adjunto** a la **VPC**
* Tambi칠n podr칤as usar **Egress-only internet gateways**
* Tambi칠n podr칤as tener un **NAT gateway** en una **subred privada** para que sea posible **conectarse a servicios externos** desde esa subred privada, pero **no es posible alcanzarlos desde el exterior**.
* El NAT gateway puede ser **p칰blico** (acceso a internet) o **privado** (acceso a otras VPCs)

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) te permite **lanzar recursos de AWS en una red virtual** que has definido. Esta red virtual tendr치 varias subredes, Internet Gateways para acceder a Internet, ACLs, grupos de seguridad, IPs...

### Subnets

Las subredes ayudan a imponer un mayor nivel de seguridad. **La agrupaci칩n l칩gica de recursos similares** tambi칠n te ayuda a mantener una **facilidad de gesti칩n** en toda tu infraestructura.

* Los CIDR v치lidos son desde una m치scara de red /16 hasta una m치scara de red /28.
* Una subred no puede estar en diferentes zonas de disponibilidad al mismo tiempo.
* **AWS reserva las tres primeras direcciones IP de host** de cada subred **para** **uso interno de AWS**: la primera direcci칩n de host utilizada es para el enrutador VPC. La segunda direcci칩n est치 reservada para AWS DNS y la tercera direcci칩n est치 reservada para uso futuro.
* Se llama **subredes p칰blicas** a aquellas que tienen **acceso directo a Internet, mientras que las subredes privadas no lo tienen.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Route Tables

Las tablas de enrutamiento determinan el enrutamiento del tr치fico para una subred dentro de una VPC. Determinan qu칠 tr치fico de red se reenv칤a a Internet o a una conexi칩n VPN. Normalmente encontrar치s acceso a:

* VPC local
* NAT
* Internet Gateways / Egress-only Internet gateways (necesarios para dar acceso a Internet a una VPC).
* Para hacer una subred p칰blica necesitas **crear** y **adjuntar** un **Internet gateway** a tu VPC.
* VPC endpoints (para acceder a S3 desde redes privadas)

En las siguientes im치genes puedes ver las diferencias en una red p칰blica predeterminada y una privada:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Network Access Control Lists (ACLs)**: Las ACLs de red son reglas de firewall que controlan el tr치fico de red entrante y saliente a una subred. Pueden usarse para permitir o denegar tr치fico a direcciones IP espec칤ficas o rangos.

* Es m치s frecuente permitir/denegar acceso usando grupos de seguridad, pero esta es la 칰nica forma de cortar completamente shells inversos establecidos. Una regla modificada en un grupo de seguridad no detiene conexiones ya establecidas.
* Sin embargo, esto se aplica a toda la subred, ten cuidado al prohibir cosas porque la funcionalidad necesaria podr칤a verse afectada.

### Security Groups

Los grupos de seguridad son un **firewall** virtual que controla el tr치fico de red entrante y saliente **a instancias** en una VPC. Relaci칩n 1 SG a M instancias (usualmente 1 a 1).\
Usualmente se usa para abrir puertos peligrosos en instancias, como el puerto 22 por ejemplo:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastic IP Addresses

Una _Elastic IP address_ es una **direcci칩n IPv4 est치tica** dise침ada para la computaci칩n en la nube din치mica. Una direcci칩n IP el치stica se asigna a tu cuenta de AWS y es tuya hasta que la liberes. Al usar una direcci칩n IP el치stica, puedes enmascarar la falla de una instancia o software reasignando r치pidamente la direcci칩n a otra instancia en tu cuenta.

### Conexi칩n entre subredes

Por defecto, todas las subredes tienen **la asignaci칩n autom치tica de direcciones IP p칰blicas desactivada** pero se puede activar.

**Una ruta local dentro de una tabla de enrutamiento permite la comunicaci칩n entre subredes de VPC.**

Si est치s **conectando una subred con una subred diferente no puedes acceder a las subredes conectadas** con la otra subred, necesitas crear una conexi칩n con ellas directamente. **Esto tambi칠n se aplica a los internet gateways**. No puedes pasar por una conexi칩n de subred para acceder a Internet, necesitas asignar el internet gateway a tu subred.

### VPC Peering

VPC peering te permite **conectar dos o m치s VPCs juntas**, usando IPV4 o IPV6, como si fueran parte de la misma red.

Una vez establecida la conectividad de pares, **los recursos en una VPC pueden acceder a los recursos en la otra**. La conectividad entre las VPCs se implementa a trav칠s de la infraestructura de red existente de AWS, por lo que es altamente disponible sin cuellos de botella de ancho de banda. Como **las conexiones de pares operan como si fueran parte de la misma red**, hay restricciones en cuanto a los rangos de bloques CIDR que se pueden usar.\
Si tienes **rangos CIDR superpuestos o duplicados** para tu VPC, entonces **no podr치s conectar las VPCs** juntas.\
Cada VPC de AWS **solo se comunicar치 con su par**. Por ejemplo, si tienes una conexi칩n de pares entre VPC 1 y VPC 2, y otra conexi칩n entre VPC 2 y VPC 3 como se muestra, entonces VPC 1 y 2 podr칤an comunicarse entre s칤 directamente, al igual que VPC 2 y VPC 3, sin embargo, VPC 1 y VPC 3 no podr칤an. **No puedes enrutar a trav칠s de una VPC para llegar a otra.**

### **VPC Flow Logs**

Dentro de tu VPC, podr칤as tener potencialmente cientos o incluso miles de recursos comunic치ndose entre diferentes subredes tanto p칰blicas como privadas y tambi칠n entre diferentes VPCs a trav칠s de conexiones de pares de VPC. **VPC Flow Logs te permiten capturar informaci칩n de tr치fico IP que fluye entre tus interfaces de red de tus recursos dentro de tu VPC**.

A diferencia de los registros de acceso de S3 y los registros de acceso de CloudFront, los **datos de registro generados por VPC Flow Logs no se almacenan en S3. En su lugar, los datos de registro capturados se env칤an a los registros de CloudWatch**.

Limitaciones:

* Si est치s ejecutando una conexi칩n de pares de VPC, solo podr치s ver los registros de flujo de las VPCs de pares que est치n dentro de la misma cuenta.
* Si a칰n est치s ejecutando recursos dentro del entorno EC2-Classic, desafortunadamente no puedes recuperar informaci칩n de sus interfaces.
* Una vez que se ha creado un VPC Flow Log, no se puede cambiar. Para alterar la configuraci칩n del VPC Flow Log, necesitas eliminarlo y luego recrear uno nuevo.
* El siguiente tr치fico no es monitoreado ni capturado por los registros. Tr치fico DHCP dentro de la VPC, tr치fico de instancias destinado al servidor DNS de Amazon.
* Cualquier tr치fico destinado a la direcci칩n IP del enrutador predeterminado de la VPC y tr치fico hacia y desde las siguientes direcciones, 169.254.169.254 que se usa para recopilar metadatos de instancias, y 169.254.169.123 que se usa para el servicio de sincronizaci칩n de tiempo de Amazon.
* Tr치fico relacionado con una licencia de activaci칩n de Windows de Amazon desde una instancia de Windows.
* Tr치fico entre una interfaz de balanceador de carga de red y una interfaz de punto final.

Para cada interfaz de red que publica datos en el grupo de registros de CloudWatch, usar치 un flujo de registros diferente. Y dentro de cada uno de estos flujos, habr치 los datos de eventos de registro de flujo que muestran el contenido de las entradas de registro. Cada uno de estos **registros captura datos durante una ventana de aproximadamente 10 a 15 minutos**.

## VPN

### Componentes B치sicos de AWS VPN

1. **Customer Gateway**:
* Un Customer Gateway es un recurso que creas en AWS para representar tu lado de una conexi칩n VPN.
* Es esencialmente un dispositivo f칤sico o una aplicaci칩n de software en tu lado de la conexi칩n VPN Site-to-Site.
* Proporcionas informaci칩n de enrutamiento y la direcci칩n IP p칰blica de tu dispositivo de red (como un enrutador o un firewall) a AWS para crear un Customer Gateway.
* Sirve como punto de referencia para configurar la conexi칩n VPN y no incurre en cargos adicionales.
2. **Virtual Private Gateway**:
* Un Virtual Private Gateway (VPG) es el concentrador VPN en el lado de Amazon de la conexi칩n VPN Site-to-Site.
* Est치 adjunto a tu VPC y sirve como el objetivo para tu conexi칩n VPN.
* VPG es el punto final del lado de AWS para la conexi칩n VPN.
* Maneja la comunicaci칩n segura entre tu VPC y tu red local.
3. **Site-to-Site VPN Connection**:
* Una conexi칩n VPN Site-to-Site conecta tu red local a una VPC a trav칠s de un t칰nel VPN seguro IPsec.
* Este tipo de conexi칩n requiere un Customer Gateway y un Virtual Private Gateway.
* Se utiliza para una comunicaci칩n segura, estable y consistente entre tu centro de datos o red y tu entorno de AWS.
* Normalmente se utiliza para conexiones regulares y a largo plazo y se factura seg칰n la cantidad de datos transferidos a trav칠s de la conexi칩n.
4. **Client VPN Endpoint**:
* Un Client VPN endpoint es un recurso que creas en AWS para habilitar y gestionar sesiones VPN de clientes.
* Se utiliza para permitir que dispositivos individuales (como laptops, smartphones, etc.) se conecten de forma segura a recursos de AWS o a tu red local.
* Se diferencia de Site-to-Site VPN en que est치 dise침ado para clientes individuales en lugar de conectar redes enteras.
* Con Client VPN, cada dispositivo cliente utiliza un software cliente VPN para establecer una conexi칩n segura.

### Site-to-Site VPN

**Conecta tu red local con tu VPC.**

* **VPN connection**: Una conexi칩n segura entre tu equipo local y tus VPCs.
* **VPN tunnel**: Un enlace cifrado donde los datos pueden pasar desde la red del cliente hacia o desde AWS.

Cada conexi칩n VPN incluye dos t칰neles VPN que puedes usar simult치neamente para alta disponibilidad.
* **Customer gateway**: Un recurso de AWS que proporciona informaci칩n a AWS sobre tu dispositivo de gateway del cliente.
* **Customer gateway device**: Un dispositivo f칤sico o una aplicaci칩n de software en tu lado de la conexi칩n VPN Site-to-Site.
* **Virtual private gateway**: El concentrador VPN en el lado de Amazon de la conexi칩n VPN Site-to-Site. Usas un virtual private gateway o un transit gateway como el gateway para el lado de Amazon de la conexi칩n VPN Site-to-Site.
* **Transit gateway**: Un concentrador de tr치nsito que puede usarse para interconectar tus VPCs y redes locales. Usas un transit gateway o un virtual private gateway como el gateway para el lado de Amazon de la conexi칩n VPN Site-to-Site.

#### Limitaciones

* El tr치fico IPv6 no es compatible con las conexiones VPN en un virtual private gateway.
* Una conexi칩n VPN de AWS no admite Path MTU Discovery.

Adem치s, ten en cuenta lo siguiente cuando uses Site-to-Site VPN.

* Al conectar tus VPCs a una red local com칰n, recomendamos que uses bloques CIDR no superpuestos para tus redes.

### Client VPN <a href="#what-is-components" id="what-is-components"></a>

**Con칠ctate desde tu m치quina a tu VPC**

#### Conceptos

* **Client VPN endpoint:** El recurso que creas y configuras para habilitar y gestionar sesiones VPN de clientes. Es el recurso donde se terminan todas las sesiones VPN de clientes.
* **Target network:** Una red objetivo es la red que asocias con un Client VPN endpoint. **Una subred de una VPC es una red objetivo**. Asociar una subred con un Client VPN endpoint te permite establecer sesiones VPN. Puedes asociar m칰ltiples subredes con un Client VPN endpoint para alta disponibilidad. Todas las subredes deben ser de la misma VPC. Cada subred debe pertenecer a una zona de disponibilidad diferente.
* **Route**: Cada Client VPN endpoint tiene una tabla de rutas que describe las rutas de red de destino disponibles. Cada ruta en la tabla de rutas especifica el camino para el tr치fico hacia recursos o redes espec칤ficas.
* **Authorization rules:** Una regla de autorizaci칩n **restringe los usuarios que pueden acceder a una red**. Para una red especificada, configuras el grupo de Active Directory o proveedor de identidad (IdP) que tiene permitido el acceso. Solo los usuarios que pertenecen a este grupo pueden acceder a la red especificada. **Por defecto, no hay reglas de autorizaci칩n** y debes configurar reglas de autorizaci칩n para permitir que los usuarios accedan a recursos y redes.
* **Client:** El usuario final que se conecta al Client VPN endpoint para establecer una sesi칩n VPN. Los usuarios finales necesitan descargar un cliente OpenVPN y usar el archivo de configuraci칩n del Client VPN que creaste para establecer una sesi칩n VPN.
* **Client CIDR range:** Un rango de direcciones IP desde el cual asignar direcciones IP de clientes. Cada conexi칩n al Client VPN endpoint se asigna una direcci칩n IP 칰nica del rango CIDR del cliente
