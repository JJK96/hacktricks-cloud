# AWS - VPC & Networking Basic Information

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository github.

</details>
{% endhint %}

## AWS Networking in a Nutshell

Un **VPC** contiene un **network CIDR** come 10.0.0.0/16 (con la sua **tabella di routing** e **network ACL**).

Questa rete VPC √® divisa in **sottoreti**, quindi una **sottorete** √® direttamente **relazionata** con il **VPC**, **tabella di routing** e **network ACL**.

Poi, le **Network Interface** collegate ai servizi (come le istanze EC2) sono **connesse** alle **sottoreti** con **security group(s)**.

Pertanto, un **security group** limiter√† le porte esposte delle **interfacce di rete che lo utilizzano**, **indipendentemente dalla sottorete**. E un **network ACL** **limiter√†** le porte esposte all'**intera rete**.

Inoltre, per **accedere a Internet**, ci sono alcune configurazioni interessanti da controllare:

* Una **sottorete** pu√≤ **assegnare automaticamente indirizzi IPv4 pubblici**
* Un'**istanza** creata nella rete che **assegna automaticamente indirizzi IPv4 pu√≤ ottenerne uno**
* Un **Internet gateway** deve essere **collegato** al **VPC**
* Potresti anche usare **Egress-only internet gateways**
* Potresti anche avere un **NAT gateway** in una **sottorete privata** cos√¨ √® possibile **connettersi a servizi esterni** da quella sottorete privata, ma **non √® possibile raggiungerli dall'esterno**.
* Il NAT gateway pu√≤ essere **pubblico** (accesso a internet) o **privato** (accesso ad altri VPC)

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) ti consente di **lanciare risorse AWS in una rete virtuale** che hai definito. Questa rete virtuale avr√† diverse sottoreti, Internet Gateways per accedere a Internet, ACL, Security groups, IP...

### Subnets

Le sottoreti aiutano a imporre un livello maggiore di sicurezza. **Raggruppare logicamente risorse simili** ti aiuta anche a mantenere una **facilit√† di gestione** della tua infrastruttura.

* CIDR validi vanno da una netmask /16 a una netmask /28.
* Una sottorete non pu√≤ essere in diverse zone di disponibilit√† contemporaneamente.
* **AWS riserva i primi tre indirizzi IP host** di ogni sottorete **per** **uso interno AWS**: il primo indirizzo host utilizzato √® per il router VPC. Il secondo indirizzo √® riservato per AWS DNS e il terzo indirizzo √® riservato per usi futuri.
* Si chiamano **sottoreti pubbliche** quelle che hanno **accesso diretto a Internet, mentre le sottoreti private no.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Route Tables

Le tabelle di routing determinano il routing del traffico per una sottorete all'interno di un VPC. Determinano quale traffico di rete viene inoltrato a Internet o a una connessione VPN. Di solito troverai accesso a:

* VPC locale
* NAT
* Internet Gateways / Egress-only Internet gateways (necessari per dare a un VPC accesso a Internet).
* Per rendere una sottorete pubblica √® necessario **creare** e **collegare** un **Internet gateway** al tuo VPC.
* VPC endpoints (per accedere a S3 da reti private)

Nelle immagini seguenti puoi controllare le differenze in una rete pubblica predefinita e una privata:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Network Access Control Lists (ACLs)**: Le Network ACLs sono regole firewall che controllano il traffico di rete in entrata e in uscita verso una sottorete. Possono essere utilizzate per consentire o negare il traffico a indirizzi IP specifici o intervalli.

* √à pi√π frequente consentire/negare l'accesso utilizzando i security groups, ma questo √® l'unico modo per interrompere completamente le reverse shells stabilite. Una regola modificata in un security group non interrompe le connessioni gi√† stabilite.
* Tuttavia, questo si applica all'intera sottorete, fai attenzione quando vieti qualcosa perch√© la funzionalit√† necessaria potrebbe essere disturbata.

### Security Groups

I security groups sono un **firewall virtuale** che controlla il traffico di rete in entrata e in uscita **verso le istanze** in un VPC. Relazione 1 SG a M istanze (di solito 1 a 1).\
Di solito questo viene utilizzato per aprire porte pericolose nelle istanze, come la porta 22 per esempio:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastic IP Addresses

Un _Elastic IP address_ √® un **indirizzo IPv4 statico** progettato per il cloud computing dinamico. Un Elastic IP address √® allocato al tuo account AWS, ed √® tuo fino a quando non lo rilasci. Utilizzando un Elastic IP address, puoi mascherare il fallimento di un'istanza o di un software rimappando rapidamente l'indirizzo a un'altra istanza nel tuo account.

### Connessione tra sottoreti

Per impostazione predefinita, tutte le sottoreti hanno **l'assegnazione automatica degli indirizzi IP pubblici disattivata**, ma pu√≤ essere attivata.

**Una rotta locale all'interno di una tabella di routing consente la comunicazione tra le sottoreti VPC.**

Se stai **collegando una sottorete con una sottorete diversa, non puoi accedere alle sottoreti collegate** con l'altra sottorete, devi creare una connessione con loro direttamente. **Questo vale anche per gli internet gateways**. Non puoi passare attraverso una connessione di sottorete per accedere a Internet, devi assegnare l'internet gateway alla tua sottorete.

### VPC Peering

Il VPC peering ti consente di **collegare due o pi√π VPC insieme**, utilizzando IPV4 o IPV6, come se fossero parte della stessa rete.

Una volta stabilita la connettivit√† peer, **le risorse in un VPC possono accedere alle risorse nell'altro**. La connettivit√† tra i VPC √® implementata attraverso l'infrastruttura di rete AWS esistente, quindi √® altamente disponibile senza colli di bottiglia di larghezza di banda. Poich√© **le connessioni peer operano come se fossero parte della stessa rete**, ci sono restrizioni quando si tratta di intervalli di blocchi CIDR che possono essere utilizzati.\
Se hai **intervalli CIDR sovrapposti o duplicati** per il tuo VPC, allora **non sarai in grado di collegare i VPC** insieme.\
Ogni VPC AWS **comunicher√† solo con il suo peer**. Ad esempio, se hai una connessione peer tra VPC 1 e VPC 2, e un'altra connessione tra VPC 2 e VPC 3 come mostrato, allora VPC 1 e 2 potrebbero comunicare tra loro direttamente, cos√¨ come VPC 2 e VPC 3, tuttavia, VPC 1 e VPC 3 non potrebbero. **Non puoi instradare attraverso un VPC per raggiungere un altro.**

### **VPC Flow Logs**

All'interno del tuo VPC, potresti potenzialmente avere centinaia o addirittura migliaia di risorse che comunicano tra diverse sottoreti sia pubbliche che private e anche tra diversi VPC attraverso connessioni VPC peering. **I VPC Flow Logs ti consentono di catturare informazioni sul traffico IP che fluisce tra le interfacce di rete delle tue risorse all'interno del tuo VPC**.

A differenza dei log di accesso S3 e dei log di accesso CloudFront, i **dati di log generati dai VPC Flow Logs non sono memorizzati in S3. Invece, i dati di log catturati sono inviati ai log di CloudWatch**.

Limitazioni:

* Se stai eseguendo una connessione VPC peered, allora sarai in grado di vedere solo i flow logs dei VPC peered che sono all'interno dello stesso account.
* Se stai ancora eseguendo risorse all'interno dell'ambiente EC2-Classic, purtroppo non sei in grado di recuperare informazioni dalle loro interfacce.
* Una volta creato un VPC Flow Log, non pu√≤ essere modificato. Per alterare la configurazione del VPC Flow Log, devi eliminarlo e poi ricrearne uno nuovo.
* Il seguente traffico non √® monitorato e catturato dai log. Traffico DHCP all'interno del VPC, traffico dalle istanze destinato al server DNS Amazon.
* Qualsiasi traffico destinato all'indirizzo IP per il router predefinito del VPC e traffico da e verso i seguenti indirizzi, 169.254.169.254 che √® utilizzato per raccogliere i metadati delle istanze, e 169.254.169.123 che √® utilizzato per il servizio di sincronizzazione dell'ora di Amazon.
* Traffico relativo a una licenza di attivazione di Windows Amazon da un'istanza Windows.
* Traffico tra un'interfaccia di bilanciamento del carico di rete e un'interfaccia di endpoint.

Per ogni interfaccia di rete che pubblica dati al gruppo di log di CloudWatch, utilizzer√† un flusso di log diverso. E all'interno di ciascuno di questi flussi, ci saranno i dati degli eventi del flow log che mostrano il contenuto delle voci di log. Ciascuno di questi **log cattura dati durante una finestra di circa 10-15 minuti**.

## VPN

### Componenti di base della VPN AWS

1. **Customer Gateway**:
* Un Customer Gateway √® una risorsa che crei in AWS per rappresentare il tuo lato di una connessione VPN.
* √à essenzialmente un dispositivo fisico o un'applicazione software sul tuo lato della connessione VPN Site-to-Site.
* Fornisci informazioni di routing e l'indirizzo IP pubblico del tuo dispositivo di rete (come un router o un firewall) ad AWS per creare un Customer Gateway.
* Serve come punto di riferimento per configurare la connessione VPN e non comporta costi aggiuntivi.
2. **Virtual Private Gateway**:
* Un Virtual Private Gateway (VPG) √® il concentratore VPN sul lato Amazon della connessione VPN Site-to-Site.
* √à collegato al tuo VPC e serve come obiettivo per la tua connessione VPN.
* VPG √® il punto finale lato AWS per la connessione VPN.
* Gestisce la comunicazione sicura tra il tuo VPC e la tua rete on-premises.
3. **Site-to-Site VPN Connection**:
* Una connessione VPN Site-to-Site collega la tua rete on-premises a un VPC tramite un tunnel VPN sicuro IPsec.
* Questo tipo di connessione richiede un Customer Gateway e un Virtual Private Gateway.
* √à utilizzato per una comunicazione sicura, stabile e coerente tra il tuo data center o rete e il tuo ambiente AWS.
* Tipicamente utilizzato per connessioni regolari e a lungo termine ed √® fatturato in base alla quantit√† di dati trasferiti sulla connessione.
4. **Client VPN Endpoint**:
* Un Client VPN endpoint √® una risorsa che crei in AWS per abilitare e gestire le sessioni VPN client.
* √à utilizzato per consentire ai singoli dispositivi (come laptop, smartphone, ecc.) di connettersi in modo sicuro alle risorse AWS o alla tua rete on-premises.
* Differisce dalla VPN Site-to-Site in quanto √® progettato per singoli client piuttosto che per collegare intere reti.
* Con Client VPN, ogni dispositivo client utilizza un software client VPN per stabilire una connessione sicura.

### Site-to-Site VPN

**Collega la tua rete on-premises con il tuo VPC.**

* **VPN connection**: Una connessione sicura tra le tue apparecchiature on-premises e i tuoi VPC.
* **VPN tunnel**: Un collegamento crittografato attraverso il quale i dati possono passare dalla rete del cliente a o da AWS.

Ogni connessione VPN include due tunnel VPN che puoi utilizzare simultaneamente per alta disponibilit√†.
* **Customer gateway**: Una risorsa AWS che fornisce informazioni ad AWS sul tuo dispositivo customer gateway.
* **Customer gateway device**: Un dispositivo fisico o un'applicazione software sul tuo lato della connessione VPN Site-to-Site.
* **Virtual private gateway**: Il concentratore VPN sul lato Amazon della connessione VPN Site-to-Site. Utilizzi un virtual private gateway o un transit gateway come gateway per il lato Amazon della connessione VPN Site-to-Site.
* **Transit gateway**: Un hub di transito che pu√≤ essere utilizzato per interconnettere i tuoi VPC e le reti on-premises. Utilizzi un transit gateway o un virtual private gateway come gateway per il lato Amazon della connessione VPN Site-to-Site.

#### Limitazioni

* Il traffico IPv6 non √® supportato per le connessioni VPN su un virtual private gateway.
* Una connessione VPN AWS non supporta Path MTU Discovery.

Inoltre, prendi in considerazione quanto segue quando utilizzi Site-to-Site VPN.

* Quando colleghi i tuoi VPC a una rete on-premises comune, ti consigliamo di utilizzare blocchi CIDR non sovrapposti per le tue reti.

### Client VPN <a href="#what-is-components" id="what-is-components"></a>

**Connettiti dalla tua macchina al tuo VPC**

#### Concetti

* **Client VPN endpoint:** La risorsa che crei e configuri per abilitare e gestire le sessioni VPN client. √à la risorsa in cui tutte le sessioni VPN client sono terminate.
* **Target network:** Una target network √®
