# AWS - VPC & Podstawowe informacje o sieci

{% hint style="success" %}
Ucz się i ćwicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz się i ćwicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się sztuczkami hackingowymi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów github.

</details>
{% endhint %}

## AWS Networking w skrócie

**VPC** zawiera **CIDR sieci** jak 10.0.0.0/16 (z jego **tablicą routingu** i **ACL sieciowym**).

Ta sieć VPC jest podzielona na **podsieci**, więc **podsieć** jest bezpośrednio **powiązana** z **VPC**, **tablicą routingu** i **ACL sieciowym**.

Następnie, **Interfejsy sieciowe** przypisane do usług (jak instancje EC2) są **połączone** z **podsieciami** za pomocą **grup zabezpieczeń**.

Dlatego **grupa zabezpieczeń** ograniczy wystawione porty interfejsów sieciowych, które jej używają, **niezależnie od podsieci**. A **ACL sieciowy** **ograniczy** wystawione porty do **całej sieci**.

Ponadto, aby **uzyskać dostęp do Internetu**, istnieją interesujące konfiguracje do sprawdzenia:

* **Podsieć** może **automatycznie przypisywać publiczne adresy IPv4**
* **Instancja** utworzona w sieci, która **automatycznie przypisuje adresy IPv4, może go uzyskać**
* **Brama internetowa** musi być **przypisana** do **VPC**
* Możesz również użyć **bram internetowych tylko do wyjścia**
* Możesz również mieć **bramę NAT** w **prywatnej podsieci**, aby możliwe było **połączenie z zewnętrznymi usługami** z tej prywatnej podsieci, ale **nie jest możliwe, aby dotrzeć do nich z zewnątrz**.
* Brama NAT może być **publiczna** (dostęp do internetu) lub **prywatna** (dostęp do innych VPC)

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Amazon **Wirtualna Chmura Prywatna** (Amazon VPC) umożliwia uruchamianie zasobów AWS w wirtualnej sieci, którą zdefiniowałeś. Ta wirtualna sieć będzie miała kilka podsieci, bramy internetowe do uzyskania dostępu do Internetu, ACL, grupy zabezpieczeń, IP...

### Podsieci

Podsieci pomagają w egzekwowaniu wyższego poziomu bezpieczeństwa. **Logiczne grupowanie podobnych zasobów** również pomaga w utrzymaniu **łatwości zarządzania** w całej infrastrukturze.

* Ważne CIDR to od maski /16 do maski /28.
* Podsiec nie może znajdować się w różnych strefach dostępności w tym samym czasie.
* **AWS rezerwuje pierwsze trzy adresy IP hostów** każdej podsieci **do** **wewnętrznego użytku AWS**: pierwszy adres hosta jest używany dla routera VPC. Drugi adres jest zarezerwowany dla DNS AWS, a trzeci adres jest zarezerwowany do przyszłego użytku.
* Nazywa się **publicznymi podsieciami** te, które mają **bezpośredni dostęp do Internetu, podczas gdy prywatne podsieci go nie mają.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tablice routingu

Tablice routingu określają trasowanie ruchu dla podsieci w VPC. Określają, który ruch sieciowy jest przesyłany do internetu lub do połączenia VPN. Zwykle znajdziesz dostęp do:

* Lokalnego VPC
* NAT
* Bram internetowych / Bram internetowych tylko do wyjścia (potrzebnych do zapewnienia VPC dostępu do Internetu).
* Aby uczynić podsieć publiczną, musisz **utworzyć** i **przypisać** **bramę internetową** do swojego VPC.
* Punkty końcowe VPC (do uzyskania dostępu do S3 z prywatnych sieci)

Na poniższych obrazach możesz sprawdzić różnice między domyślną publiczną siecią a prywatną:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACL

**Listy Kontroli Dostępu do Sieci (ACL)**: ACL sieciowe to zasady zapory, które kontrolują przychodzący i wychodzący ruch sieciowy do podsieci. Mogą być używane do zezwalania lub odmawiania ruchu do określonych adresów IP lub zakresów.

* Najczęściej zezwala się/odmawia dostępu za pomocą grup zabezpieczeń, ale to jedyny sposób na całkowite przerwanie ustanowionych odwrotnych powłok. Zmodyfikowana zasada w grupach zabezpieczeń nie zatrzymuje już ustanowionych połączeń.
* Jednak to dotyczy całej podsieci, bądź ostrożny przy zabranianiu rzeczy, ponieważ potrzebna funkcjonalność może być zakłócona.

### Grupy zabezpieczeń

Grupy zabezpieczeń to wirtualna **zapora**, która kontroluje przychodzący i wychodzący ruch sieciowy **do instancji** w VPC. Relacja 1 SG do M instancji (zwykle 1 do 1).\
Zwykle używa się ich do otwierania niebezpiecznych portów w instancjach, takich jak port 22 na przykład:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Adresy IP Elastic

_Adres IP Elastic_ to **statyczny adres IPv4** zaprojektowany do dynamicznego przetwarzania w chmurze. Adres IP Elastic jest przypisany do twojego konta AWS i jest twój, dopóki go nie zwolnisz. Używając adresu IP Elastic, możesz zamaskować awarię instancji lub oprogramowania, szybko przemapowując adres na inną instancję w swoim koncie.

### Połączenie między podsieciami

Domyślnie wszystkie podsieci mają **automatyczne przypisanie publicznych adresów IP wyłączone**, ale można je włączyć.

**Lokalna trasa w tablicy routingu umożliwia komunikację między podsieciami VPC.**

Jeśli **łączysz podsieć z inną podsiecią, nie możesz uzyskać dostępu do podsieci połączonych** z inną podsiecią, musisz stworzyć połączenie z nimi bezpośrednio. **To również dotyczy bram internetowych**. Nie możesz przejść przez połączenie podsieci, aby uzyskać dostęp do internetu, musisz przypisać bramę internetową do swojej podsieci.

### Peering VPC

Peering VPC pozwala na **połączenie dwóch lub więcej VPC**, używając IPV4 lub IPV6, tak jakby były częścią tej samej sieci.

Gdy połączenie peer jest ustanowione, **zasoby w jednym VPC mogą uzyskiwać dostęp do zasobów w drugim**. Połączenie między VPC jest realizowane przez istniejącą infrastrukturę sieciową AWS, więc jest wysoce dostępne bez wąskich gardeł przepustowości. Ponieważ **połączenia peer działają tak, jakby były częścią tej samej sieci**, istnieją ograniczenia dotyczące zakresów bloków CIDR, które mogą być używane.\
Jeśli masz **nakładające się lub duplikujące się zakresy CIDR** dla swojego VPC, to **nie będziesz mógł połączyć VPC** razem.\
Każde VPC AWS **będzie komunikować się tylko ze swoim peerem**. Na przykład, jeśli masz połączenie peeringowe między VPC 1 a VPC 2, oraz inne połączenie między VPC 2 a VPC 3, jak pokazano, to VPC 1 i 2 mogą komunikować się ze sobą bezpośrednio, tak samo jak VPC 2 i VPC 3, jednak VPC 1 i VPC 3 nie mogą. **Nie możesz routować przez jedno VPC, aby dotrzeć do drugiego.**

### **Logi przepływu VPC**

W ramach swojego VPC możesz mieć potencjalnie setki lub nawet tysiące zasobów, które komunikują się między różnymi podsieciami, zarówno publicznymi, jak i prywatnymi, a także między różnymi VPC za pomocą połączeń peeringowych VPC. **Logi przepływu VPC pozwalają na uchwycenie informacji o ruchu IP, który przepływa między interfejsami sieciowymi twoich zasobów w ramach twojego VPC**.

W przeciwieństwie do logów dostępu S3 i logów dostępu CloudFront, **dane logów generowane przez logi przepływu VPC nie są przechowywane w S3. Zamiast tego, dane logów są wysyłane do logów CloudWatch**.

Ograniczenia:

* Jeśli uruchamiasz połączenie peeringowe VPC, to będziesz mógł zobaczyć tylko logi przepływu peeringowych VPC, które są w tym samym koncie.
* Jeśli nadal uruchamiasz zasoby w środowisku EC2-Classic, to niestety nie możesz uzyskać informacji z ich interfejsów.
* Gdy log przepływu VPC został utworzony, nie można go zmienić. Aby zmienić konfigurację logu przepływu VPC, musisz go usunąć, a następnie utworzyć nowy.
* Następujący ruch nie jest monitorowany i rejestrowany przez logi. Ruch DHCP w VPC, ruch z instancji przeznaczony dla serwera DNS Amazon.
* Wszelki ruch przeznaczony do adresu IP domyślnego routera VPC oraz ruch do i z następujących adresów, 169.254.169.254, który jest używany do zbierania metadanych instancji, oraz 169.254.169.123, który jest używany do usługi synchronizacji czasu Amazon.
* Ruch związany z licencją aktywacyjną systemu Windows Amazon z instancji Windows.
* Ruch między interfejsem równoważnika obciążenia sieciowego a interfejsem punktu końcowego sieci.

Dla każdego interfejsu sieciowego, który publikuje dane do grupy logów CloudWatch, będzie używany inny strumień logów. A w ramach każdego z tych strumieni będą dane zdarzeń logów przepływu, które pokazują zawartość wpisów logów. Każdy z tych **logów rejestruje dane w oknie czasowym wynoszącym około 10 do 15 minut**.

## VPN

### Podstawowe komponenty AWS VPN

1. **Brama Klienta**:
* Brama Klienta to zasób, który tworzysz w AWS, aby reprezentować swoją stronę połączenia VPN.
* Jest to zasadniczo fizyczne urządzenie lub aplikacja programowa po twojej stronie połączenia VPN Site-to-Site.
* Podajesz informacje o routingu i publiczny adres IP swojego urządzenia sieciowego (takiego jak router lub zapora) do AWS, aby utworzyć Bramę Klienta.
* Służy jako punkt odniesienia do skonfigurowania połączenia VPN i nie generuje dodatkowych opłat.
2. **Wirtualna Brama Prywatna**:
* Wirtualna Brama Prywatna (VPG) to koncentrator VPN po stronie Amazon w połączeniu VPN Site-to-Site.
* Jest przypisana do twojego VPC i służy jako cel dla twojego połączenia VPN.
* VPG jest punktem końcowym po stronie AWS dla połączenia VPN.
* Obsługuje bezpieczną komunikację między twoim VPC a twoją siecią lokalną.
3. **Połączenie VPN Site-to-Site**:
* Połączenie VPN Site-to-Site łączy twoją lokalną sieć z VPC przez bezpieczny tunel VPN IPsec.
* Ten typ połączenia wymaga Bramy Klienta i Wirtualnej Bramy Prywatnej.
* Jest używany do bezpiecznej, stabilnej i spójnej komunikacji między twoim centrum danych lub siecią a twoim środowiskiem AWS.
* Zwykle używany do regularnych, długoterminowych połączeń i jest rozliczany na podstawie ilości danych przesyłanych przez połączenie.
4. **Punkt końcowy VPN Klienta**:
* Punkt końcowy VPN Klienta to zasób, który tworzysz w AWS, aby umożliwić i zarządzać sesjami VPN klientów.
* Jest używany do umożliwienia indywidualnym urządzeniom (takim jak laptopy, smartfony itp.) bezpiecznego łączenia się z zasobami AWS lub twoją lokalną siecią.
* Różni się od VPN Site-to-Site tym, że jest zaprojektowany dla indywidualnych klientów, a nie do łączenia całych sieci.
* Z VPN Klienta każde urządzenie klienckie używa oprogramowania klienta VPN do nawiązania bezpiecznego połączenia.

### VPN Site-to-Site

**Połącz swoją lokalną sieć z twoim VPC.**

* **Połączenie VPN**: Bezpieczne połączenie między twoim sprzętem lokalnym a twoimi VPC.
* **Tunel VPN**: Szyfrowane połączenie, przez które dane mogą przechodzić z sieci klienta do AWS lub odwrotnie.

Każde połączenie VPN zawiera dwa tunele VPN, które możesz jednocześnie używać dla wysokiej dostępności.
* **Brama klienta**: Zasób AWS, który dostarcza informacji do AWS o twoim urządzeniu bramy klienta.
* **Urządzenie bramy klienta**: Fizyczne urządzenie lub aplikacja programowa po twojej stronie połączenia VPN Site-to-Site.
* **Wirtualna brama prywatna**: Koncentrator VPN po stronie Amazon w połączeniu VPN Site-to-Site. Używasz wirtualnej bramy prywatnej lub bramy tranzytowej jako bramy po stronie Amazon w połączeniu VPN Site-to-Site.
* **Brama tranzytowa**: Hub tranzytowy, który może być używany do łączenia twoich VPC i lokalnych sieci. Używasz bramy tranzytowej lub wirtualnej bramy prywatnej jako bramy po stronie Amazon w połączeniu VPN Site-to-Site.

#### Ograniczenia

* Ruch IPv6 nie jest obsługiwany dla połączeń VPN na wirtualnej bramie prywatnej.
* Połączenie VPN AWS nie obsługuje Odkrywania MTU ścieżki.

Ponadto, weź pod uwagę następujące kwestie, gdy używasz VPN Site-to-Site.

* Podczas łączenia swoich VPC z wspólną lokalną siecią, zalecamy użycie nie nakładających się bloków CIDR dla twoich sieci.

### VPN Klienta <a href="#what-is-components" id="what-is-components"></a>

**Połącz się z twojego urządzenia z twoim VPC**

#### Koncepcje

* **Punkt końcowy VPN Klienta:** Zasób, który tworzysz i konfigurujesz, aby umożliwić i zarządzać sesjami VPN klientów. To zasób, w którym kończą się wszystkie sesje VPN klientów.
* **Sieć docelowa:** Sieć docelowa to sieć, którą kojarzysz z punktem końcowym VPN Klienta. **Podsieć z VPC jest siecią docelową**. Powiązanie podsieci z punktem końcowym VPN Klienta umożliwia nawiązanie sesji VPN. Możesz powiązać wiele podsieci z punktem końcowym VPN Klienta dla wysokiej dostępności. Wszystkie podsieci muszą pochodzić z tego samego VPC. Każda podsieć musi należeć do innej strefy dostępności.
* **Trasa**: Każdy punkt końcowy VPN Klienta ma tablicę tras, która opisuje dostępne trasy sieciowe. Każda trasa w tablicy tras określa ścieżkę dla ruchu do określonych zasobów lub sieci.
* **Zasady autoryzacji:** Zasada autoryzacji **ogranicza użytkowników, którzy mogą uzyskać dostęp do sieci**. Dla określonej sieci konfigurujesz grupę Active Directory lub dostawcy tożsamości (IdP), która ma dostęp. Tylko użytkownicy należący do tej grupy mogą uzyskać dostęp do określonej sieci. **Domyślnie nie ma zasad autoryzacji** i musisz skonfigurować zasady autoryzacji, aby umożliwić użytkownikom dostęp do zasobów i sieci.
* **Klient:** Użytkownik końcowy łączący się z punktem końcowym VPN Klienta, aby nawiązać sesję VPN. Użytkownicy końcowi muszą pobrać klienta OpenVPN i użyć pliku konfiguracyjnego punktu końcowego VPN Klienta, który utworzyłeś, aby nawiązać sesję VPN.
* **Zakres CIDR klienta:** Zakres adresów IP, z którego przypisywane są adresy IP klientów. Każde połączenie z punktem końcowym VPN Klienta otrzymuje unikalny adres IP z zakresu CIDR klienta. Wybierasz zakres CIDR klienta, na przykład `10.2.0.0/16`.
* **Porty VPN Klienta:** AWS Client VPN obsługuje porty 443 i 1194 zarówno dla TCP, jak i UDP. Domyślnie jest to port 443.
* **Interfejsy sieciowe VPN Klienta:** Gdy powiążesz podsieć z punktem końcowym VPN Klienta, tworzymy interfejsy sieciowe VPN Klienta w tej podsieci. **Ruch, który jest wysyłany do VPC z punktu końcowego VPN Klienta, jest wysyłany przez interfejs sieciowy VPN Klienta**. Następnie stosuje się translację adresu źródłowego (SNAT), gdzie adres IP źródłowy z zakresu CIDR klienta jest tłumaczony na adres IP interfejsu sieciowego VPN Klienta.
* **Rejestrowanie połączeń:** Możesz włączyć rejestrowanie połączeń dla swojego punktu końcowego VPN Klienta, aby rejestrować zdarzenia połączeń. Możesz użyć tych informacji do przeprowadzania analizy, analizowania, jak twój punkt końcowy VPN Klienta jest używany, lub debugowania problemów z połączeniem.
* **Portal samoobsługowy:** Możesz włączyć portal samoobsługowy dla swojego punktu końcowego VPN Klienta. Klienci mogą zalogować się do portalu internetowego, używając swoich danych uwierzytelniających, i pobrać najnowszą wersję pliku konfiguracyjnego punktu końcowego VPN Klienta lub najnowszą wersję klienta dostarczonego przez AWS.

#### Ograniczenia

* **Zakresy CIDR klienta nie mogą nakładać się na lokalny CIDR** VPC, w którym znajduje się powiązana podsieć, ani na jakiekolwiek trasy ręcznie dodane do tablicy tras punktu końcowego VPN Klienta.
* Zakresy CIDR klienta muszą mieć rozmiar bloku **co najmniej /22** i **nie mogą być większe niż /12.**
* **Część adresów** w zakresie CIDR klienta jest używana do **wsparcia modelu dostępności** punktu końcowego VPN Klienta i nie może być przypisana do klientów. Dlatego zalecamy, abyś **przypisał blok CIDR, który zawiera dwukrotność liczby adresów IP, które są wymagane** do umożliwienia maksymalnej liczby jednoczesnych połączeń, które planujesz obsługiwać na punkcie końcowym VPN Klienta.
* **Zakres CIDR klienta nie może być zmieniony** po utworzeniu punktu końcowego VPN Klienta.
* **Podsieci** powiązane z punktem końcowym VPN Klienta **muszą znajdować się w tym samym VPC**.
* **Nie możesz powiązać wielu podsieci z tej samej strefy dostępności z punktem końcowym VPN Klienta**.
* Punkt końcowy VPN Klienta **nie obsługuje powiązań podsieci w dedykowanym VPC**.
* VPN Klienta obsługuje **tylko** ruch IPv4.
* VPN Klienta **nie jest** zgodny z Federalnymi Standardami Przetwarzania Informacji (**FIPS**).
* Jeśli uwierzytelnianie wieloskładnikowe (MFA) jest wyłączone dla twojej Active Directory, hasło użytkownika nie może być w następującym formacie.

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* Portal samoobsługowy **nie jest dostępny dla klientów, którzy uwierzytelniają się za pomocą uwierzytelniania wzajemnego**.

{% hint style="success" %}
Ucz się i ćwicz Hacking AWS:<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz się i ćwicz Hacking GCP: <img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się sztuczkami hackingowymi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów github.

</details>
{% endhint %}
