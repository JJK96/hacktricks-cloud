# AWS - VPC & Networking Basic Information

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## AWS Networking em Resumo

Uma **VPC** cont√©m um **CIDR de rede** como 10.0.0.0/16 (com sua **tabela de roteamento** e **ACL de rede**).

Essa rede VPC √© dividida em **sub-redes**, ent√£o uma **sub-rede** est√° diretamente **relacionada** com a **VPC**, **tabela de roteamento** e **ACL de rede**.

Ent√£o, **Interfaces de Rede** anexadas a servi√ßos (como inst√¢ncias EC2) s√£o **conectadas** √†s **sub-redes** com **grupo(s) de seguran√ßa**.

Portanto, um **grupo de seguran√ßa** limitar√° as portas expostas das **interfaces de rede que o utilizam**, **independentemente da sub-rede**. E uma **ACL de rede** **limitar√°** as portas expostas para toda a **rede**.

Al√©m disso, para **acessar a Internet**, h√° algumas configura√ß√µes interessantes a verificar:

* Uma **sub-rede** pode **atribuir automaticamente endere√ßos IPv4 p√∫blicos**
* Uma **inst√¢ncia** criada na rede que **atribui automaticamente endere√ßos IPv4 pode obter um**
* Um **gateway de Internet** precisa ser **anexado** √† **VPC**
* Voc√™ tamb√©m pode usar **gateways de Internet somente de sa√≠da**
* Voc√™ tamb√©m pode ter um **gateway NAT** em uma **sub-rede privada** para que seja poss√≠vel **conectar-se a servi√ßos externos** a partir dessa sub-rede privada, mas **n√£o √© poss√≠vel alcan√ß√°-los de fora**.
* O gateway NAT pode ser **p√∫blico** (acesso √† internet) ou **privado** (acesso a outras VPCs)

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) permite que voc√™ **inicie recursos AWS em uma rede virtual** que voc√™ definiu. Esta rede virtual ter√° v√°rias sub-redes, Gateways de Internet para acessar a Internet, ACLs, Grupos de Seguran√ßa, IPs...

### Sub-redes

Sub-redes ajudam a impor um n√≠vel maior de seguran√ßa. **Agrupamento l√≥gico de recursos semelhantes** tamb√©m ajuda a manter uma **facilidade de gerenciamento** em toda a sua infraestrutura.

* CIDR v√°lidos s√£o de uma m√°scara de rede /16 a uma m√°scara de rede /28.
* Uma sub-rede n√£o pode estar em diferentes zonas de disponibilidade ao mesmo tempo.
* **AWS reserva os tr√™s primeiros endere√ßos IP de host** de cada sub-rede **para uso interno da AWS**: o primeiro endere√ßo de host usado √© para o roteador da VPC. O segundo endere√ßo √© reservado para o DNS da AWS e o terceiro endere√ßo √© reservado para uso futuro.
* S√£o chamadas de **sub-redes p√∫blicas** aquelas que t√™m **acesso direto √† Internet, enquanto sub-redes privadas n√£o t√™m.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tabelas de Roteamento

Tabelas de roteamento determinam o roteamento de tr√°fego para uma sub-rede dentro de uma VPC. Elas determinam qual tr√°fego de rede √© encaminhado para a internet ou para uma conex√£o VPN. Voc√™ geralmente encontrar√° acesso ao:

* VPC Local
* NAT
* Gateways de Internet / Gateways de Internet somente de sa√≠da (necess√°rios para dar acesso √† Internet a uma VPC).
* Para tornar uma sub-rede p√∫blica, voc√™ precisa **criar** e **anexar** um **gateway de Internet** √† sua VPC.
* Endpoints de VPC (para acessar S3 a partir de redes privadas)

Nas imagens a seguir, voc√™ pode verificar as diferen√ßas em uma rede p√∫blica padr√£o e uma privada:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Network Access Control Lists (ACLs)**: ACLs de rede s√£o regras de firewall que controlam o tr√°fego de rede de entrada e sa√≠da para uma sub-rede. Elas podem ser usadas para permitir ou negar tr√°fego para endere√ßos IP ou intervalos espec√≠ficos.

* √â mais frequente permitir/denegar acesso usando grupos de seguran√ßa, mas esta √© a √∫nica maneira de cortar completamente shells reversos estabelecidos. Uma regra modificada em um grupo de seguran√ßa n√£o interrompe conex√µes j√° estabelecidas.
* No entanto, isso se aplica a toda a sub-rede, tenha cuidado ao proibir coisas porque a funcionalidade necess√°ria pode ser perturbada.

### Grupos de Seguran√ßa

Grupos de seguran√ßa s√£o um **firewall virtual** que controla o tr√°fego de rede de entrada e sa√≠da para **inst√¢ncias** em uma VPC. Rela√ß√£o 1 SG para M inst√¢ncias (geralmente 1 para 1).\
Geralmente, isso √© usado para abrir portas perigosas em inst√¢ncias, como a porta 22, por exemplo:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Endere√ßos IP El√°sticos

Um _endere√ßo IP El√°stico_ √© um **endere√ßo IPv4 est√°tico** projetado para computa√ß√£o em nuvem din√¢mica. Um endere√ßo IP El√°stico √© alocado para sua conta AWS e √© seu at√© que voc√™ o libere. Usando um endere√ßo IP El√°stico, voc√™ pode mascarar a falha de uma inst√¢ncia ou software remapeando rapidamente o endere√ßo para outra inst√¢ncia em sua conta.

### Conex√£o entre sub-redes

Por padr√£o, todas as sub-redes t√™m a **atribui√ß√£o autom√°tica de endere√ßos IP p√∫blicos desativada**, mas pode ser ativada.

**Uma rota local dentro de uma tabela de roteamento permite a comunica√ß√£o entre sub-redes da VPC.**

Se voc√™ estiver **conectando uma sub-rede com uma sub-rede diferente, voc√™ n√£o pode acessar as sub-redes conectadas** com a outra sub-rede, voc√™ precisa criar uma conex√£o com elas diretamente. **Isso tamb√©m se aplica a gateways de internet**. Voc√™ n√£o pode passar por uma conex√£o de sub-rede para acessar a internet, voc√™ precisa atribuir o gateway de internet √† sua sub-rede.

### VPC Peering

VPC peering permite que voc√™ **conecte duas ou mais VPCs juntas**, usando IPV4 ou IPV6, como se fossem parte da mesma rede.

Uma vez estabelecida a conectividade peer, **recursos em uma VPC podem acessar recursos na outra**. A conectividade entre as VPCs √© implementada atrav√©s da infraestrutura de rede existente da AWS, e por isso √© altamente dispon√≠vel sem gargalos de largura de banda. Como **conex√µes peer operam como se fossem parte da mesma rede**, h√° restri√ß√µes quanto aos intervalos de blocos CIDR que podem ser usados.\
Se voc√™ tiver **intervalos CIDR sobrepostos ou duplicados** para sua VPC, ent√£o **voc√™ n√£o poder√° fazer peering das VPCs** juntas.\
Cada VPC AWS **s√≥ se comunicar√° com seu peer**. Por exemplo, se voc√™ tiver uma conex√£o de peering entre a VPC 1 e a VPC 2, e outra conex√£o entre a VPC 2 e a VPC 3, conforme mostrado, ent√£o a VPC 1 e a VPC 2 poderiam se comunicar diretamente, assim como a VPC 2 e a VPC 3, no entanto, a VPC 1 e a VPC 3 n√£o poderiam. **Voc√™ n√£o pode rotear atrav√©s de uma VPC para chegar a outra.**

### **VPC Flow Logs**

Dentro da sua VPC, voc√™ pode potencialmente ter centenas ou at√© milhares de recursos, todos se comunicando entre diferentes sub-redes, tanto p√∫blicas quanto privadas, e tamb√©m entre diferentes VPCs atrav√©s de conex√µes de peering de VPC. **VPC Flow Logs permitem capturar informa√ß√µes de tr√°fego IP que fluem entre suas interfaces de rede de seus recursos dentro de sua VPC**.

Ao contr√°rio dos logs de acesso do S3 e dos logs de acesso do CloudFront, os **dados de log gerados pelos VPC Flow Logs n√£o s√£o armazenados no S3. Em vez disso, os dados de log capturados s√£o enviados para os logs do CloudWatch**.

Limita√ß√µes:

* Se voc√™ estiver executando uma conex√£o de peering de VPC, ent√£o voc√™ s√≥ poder√° ver os logs de fluxo das VPCs peer que est√£o dentro da mesma conta.
* Se voc√™ ainda estiver executando recursos dentro do ambiente EC2-Classic, ent√£o infelizmente voc√™ n√£o poder√° recuperar informa√ß√µes de suas interfaces.
* Uma vez que um VPC Flow Log foi criado, ele n√£o pode ser alterado. Para alterar a configura√ß√£o do VPC Flow Log, voc√™ precisa exclu√≠-lo e recriar um novo.
* O seguinte tr√°fego n√£o √© monitorado e capturado pelos logs. Tr√°fego DHCP dentro da VPC, tr√°fego de inst√¢ncias destinado ao servidor DNS da Amazon.
* Qualquer tr√°fego destinado ao endere√ßo IP do roteador padr√£o da VPC e tr√°fego de e para os seguintes endere√ßos, 169.254.169.254, que √© usado para coletar metadados da inst√¢ncia, e 169.254.169.123, que √© usado para o Amazon Time Sync Service.
* Tr√°fego relacionado a uma licen√ßa de ativa√ß√£o do Windows da Amazon a partir de uma inst√¢ncia do Windows.
* Tr√°fego entre uma interface de balanceador de carga de rede e uma interface de endpoint de rede.

Para cada interface de rede que publica dados para o grupo de logs do CloudWatch, ser√° usado um fluxo de log diferente. E dentro de cada um desses fluxos, haver√° os dados de eventos de log de fluxo que mostram o conte√∫do das entradas de log. Cada um desses **logs captura dados durante uma janela de aproximadamente 10 a 15 minutos**.

## VPN

### Componentes B√°sicos da VPN AWS

1. **Customer Gateway**:
* Um Customer Gateway √© um recurso que voc√™ cria na AWS para representar seu lado de uma conex√£o VPN.
* √â essencialmente um dispositivo f√≠sico ou aplicativo de software do seu lado da conex√£o VPN Site-to-Site.
* Voc√™ fornece informa√ß√µes de roteamento e o endere√ßo IP p√∫blico do seu dispositivo de rede (como um roteador ou firewall) para a AWS para criar um Customer Gateway.
* Ele serve como um ponto de refer√™ncia para configurar a conex√£o VPN e n√£o gera custos adicionais.
2. **Virtual Private Gateway**:
* Um Virtual Private Gateway (VPG) √© o concentrador VPN no lado da Amazon da conex√£o VPN Site-to-Site.
* Ele √© anexado √† sua VPC e serve como o alvo para sua conex√£o VPN.
* VPG √© o endpoint do lado da AWS para a conex√£o VPN.
* Ele lida com a comunica√ß√£o segura entre sua VPC e sua rede on-premises.
3. **Site-to-Site VPN Connection**:
* Uma conex√£o VPN Site-to-Site conecta sua rede on-premises a uma VPC atrav√©s de um t√∫nel VPN seguro IPsec.
* Esse tipo de conex√£o requer um Customer Gateway e um Virtual Private Gateway.
* √â usado para comunica√ß√£o segura, est√°vel e consistente entre seu data center ou rede e seu ambiente AWS.
* Normalmente usado para conex√µes regulares e de longo prazo e √© cobrado com base na quantidade de dados transferidos pela conex√£o.
4. **Client VPN Endpoint**:
* Um Client VPN endpoint √© um recurso que voc√™ cria na AWS para habilitar e gerenciar sess√µes VPN de clientes.
* √â usado para permitir que dispositivos individuais (como laptops, smartphones, etc.) se conectem com seguran√ßa a recursos da AWS ou √† sua rede on-premises.
* Difere da VPN Site-to-Site, pois √© projetado para clientes individuais em vez de conectar redes inteiras.
* Com o Client VPN, cada dispositivo cliente usa um software cliente VPN para estabelecer uma conex√£o segura.

### Site-to-Site VPN

**Conecte sua rede on-premises com sua VPC.**

* **Conex√£o VPN**: Uma conex√£o segura entre seu equipamento on-premises e suas VPCs.
* **T√∫nel VPN**: Um link criptografado onde os dados podem passar da rede do cliente para ou da AWS.

Cada conex√£o VPN inclui dois t√∫neis VPN que voc√™ pode usar simultaneamente para alta disponibilidade.
* **Customer gateway**: Um recurso AWS que fornece informa√ß√µes √† AWS sobre seu dispositivo de gateway do cliente.
* **Dispositivo de gateway do cliente**: Um dispositivo f√≠sico ou aplicativo de software do seu lado da conex√£o VPN Site-to-Site.
* **Virtual private gateway**: O concentrador VPN no lado da Amazon da conex√£o VPN Site-to-Site. Voc√™ usa um virtual private gateway ou um transit gateway como o gateway para o lado da Amazon da conex√£o VPN Site-to-Site.
* **Transit gateway**: Um hub de tr√¢nsito que pode ser usado para interconectar suas VPCs e redes on-premises. Voc√™ usa um transit gateway ou virtual private gateway como o gateway para o lado da Amazon da conex√£o VPN Site-to-Site.

#### Limita√ß√µes

* Tr√°fego IPv6 n√£o √© suportado para conex√µes VPN em um virtual private gateway.
* Uma conex√£o VPN AWS n√£o suporta Path MTU Discovery.

Al√©m disso, leve em considera√ß√£o o seguinte ao usar a VPN Site-to-Site.

* Ao conectar suas VPCs a uma rede on-premises comum, recomendamos que voc√™ use blocos CIDR n√£o sobrepostos para suas redes.

### Client VPN <a href="#what-is-components" id="what-is-components"></a>

**Conecte-se da sua m√°quina √† sua VPC**

#### Conceitos

* **Client VPN endpoint:** O recurso que voc√™ cria e configura para habilitar e gerenciar sess√µes VPN de clientes. √â o recurso onde todas as sess√µes VPN de clientes s√£o terminadas.
* **Rede alvo:** Uma rede alvo √© a rede que voc√™ associa a um Client VPN endpoint. **Uma sub-rede de uma VPC √© uma rede alvo**. Associar uma sub-rede a um Client VPN endpoint permite que voc√™ estabele√ßa sess√µes VPN. Voc√™ pode associar v√°rias sub-redes a um Client VPN endpoint para alta disponibilidade. Todas as sub-redes devem ser da mesma VPC. Cada sub-rede deve pertencer a uma Zona de Disponibilidade diferente.
* **Rota**: Cada Client VPN endpoint tem uma tabela de rotas que descreve as rotas de rede de destino dispon√≠veis. Cada rota na tabela de rotas especifica o caminho para o tr√°fego para recursos ou redes espec√≠ficas.
* **Regras de autoriza√ß√£o:** Uma regra de autoriza√ß√£o **restringe os usu√°rios que podem acessar uma rede**. Para uma rede especificada, voc√™ configura o Active Directory ou o grupo de provedor de identidade (IdP) que tem permiss√£o de acesso. Somente usu√°rios pertencentes a esse grupo podem acessar a rede especificada. **Por padr√£o, n√£o h√° regras de autoriza√ß√£o** e voc√™ deve configurar regras de autoriza√ß√£o para permitir que os usu√°rios acessem recursos e redes.
* **Cliente:** O
