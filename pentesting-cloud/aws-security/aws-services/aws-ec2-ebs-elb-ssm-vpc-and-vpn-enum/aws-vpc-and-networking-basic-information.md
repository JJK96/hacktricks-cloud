# AWS - VPC & Networking Basic Information

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## AWS Networking in a Nutshell

Ein **VPC** enth√§lt ein **Netzwerk-CIDR** wie 10.0.0.0/16 (mit seiner **Routing-Tabelle** und **Netzwerk-ACL**).

Dieses VPC-Netzwerk ist in **Subnetze** unterteilt, sodass ein **Subnetz** direkt mit der **VPC**, der **Routing-Tabelle** und der **Netzwerk-ACL** **verbunden** ist.

Dann sind **Netzwerkschnittstellen**, die an Dienste (wie EC2-Instanzen) angeh√§ngt sind, mit den **Subnetzen** mit **Sicherheitsgruppen** **verbunden**.

Daher wird eine **Sicherheitsgruppe** die exponierten Ports der **Netzwerkschnittstellen, die sie verwenden**, **unabh√§ngig vom Subnetz** begrenzen. Und eine **Netzwerk-ACL** wird die exponierten Ports f√ºr das **gesamte Netzwerk** **begrenzen**.

Dar√ºber hinaus gibt es einige interessante Konfigurationen, um auf das **Internet zuzugreifen**:

* Ein **Subnetz** kann **√∂ffentliche IPv4-Adressen automatisch zuweisen**
* Eine **Instanz**, die im Netzwerk erstellt wurde, das **IPv4-Adressen automatisch zuweist, kann eine erhalten**
* Ein **Internet-Gateway** muss an die **VPC** **angeh√§ngt** werden
* Sie k√∂nnten auch **nur ausgehende Internet-Gateways** verwenden
* Sie k√∂nnten auch ein **NAT-Gateway** in einem **privaten Subnetz** haben, sodass es m√∂glich ist, von diesem privaten Subnetz aus **auf externe Dienste zuzugreifen**, aber es ist **nicht m√∂glich, von au√üen darauf zuzugreifen**.
* Das NAT-Gateway kann **√∂ffentlich** (Zugang zum Internet) oder **privat** (Zugang zu anderen VPCs) sein

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) erm√∂glicht es Ihnen, **AWS-Ressourcen in ein von Ihnen definiertes virtuelles Netzwerk zu starten**. Dieses virtuelle Netzwerk wird mehrere Subnetze, Internet-Gateways f√ºr den Internetzugang, ACLs, Sicherheitsgruppen, IPs usw. haben.

### Subnetze

Subnetze helfen, ein h√∂heres Ma√ü an Sicherheit durchzusetzen. **Logische Gruppierung √§hnlicher Ressourcen** hilft Ihnen auch, eine **einfache Verwaltung** Ihrer Infrastruktur zu gew√§hrleisten.

* G√ºltige CIDR sind von einer /16-Netzmaske bis zu einer /28-Netzmaske.
* Ein Subnetz kann nicht gleichzeitig in verschiedenen Verf√ºgbarkeitszonen sein.
* **AWS reserviert die ersten drei Host-IP-Adressen** jedes Subnetzes **f√ºr** **interne AWS-Nutzung**: Die erste Host-Adresse wird f√ºr den VPC-Router verwendet. Die zweite Adresse ist f√ºr AWS DNS reserviert und die dritte Adresse ist f√ºr zuk√ºnftige Verwendung reserviert.
* Es wird von **√∂ffentlichen Subnetzen** gesprochen, die **direkten Zugang zum Internet haben, w√§hrend private Subnetze dies nicht tun.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Routing-Tabellen

Routing-Tabellen bestimmen das Traffic-Routing f√ºr ein Subnetz innerhalb einer VPC. Sie bestimmen, welcher Netzwerkverkehr ins Internet oder zu einer VPN-Verbindung weitergeleitet wird. Sie finden normalerweise Zugang zu:

* Lokale VPC
* NAT
* Internet-Gateways / Nur ausgehende Internet-Gateways (erforderlich, um einer VPC Zugang zum Internet zu geben).
* Um ein Subnetz √∂ffentlich zu machen, m√ºssen Sie ein **Internet-Gateway erstellen** und **an Ihre VPC anh√§ngen**.
* VPC-Endpunkte (um von privaten Netzwerken auf S3 zuzugreifen)

In den folgenden Bildern k√∂nnen Sie die Unterschiede in einem standardm√§√üigen √∂ffentlichen Netzwerk und einem privaten Netzwerk √ºberpr√ºfen:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Network Access Control Lists (ACLs)**: Netzwerk-ACLs sind Firewall-Regeln, die den eingehenden und ausgehenden Netzwerkverkehr zu einem Subnetz steuern. Sie k√∂nnen verwendet werden, um den Verkehr zu bestimmten IP-Adressen oder Bereichen zuzulassen oder zu verweigern.

* Es ist am h√§ufigsten, den Zugriff mit Sicherheitsgruppen zu erlauben/zu verweigern, aber dies ist der einzige Weg, um vollst√§ndig etablierte Reverse Shells zu unterbrechen. Eine ge√§nderte Regel in einer Sicherheitsgruppe stoppt keine bereits etablierten Verbindungen
* Dies gilt jedoch f√ºr das gesamte Subnetz. Seien Sie vorsichtig, wenn Sie Dinge verbieten, da ben√∂tigte Funktionen gest√∂rt werden k√∂nnten

### Sicherheitsgruppen

Sicherheitsgruppen sind eine virtuelle **Firewall**, die den eingehenden und ausgehenden Netzwerkverkehr zu **Instanzen** in einer VPC steuert. Verh√§ltnis 1 SG zu M Instanzen (normalerweise 1 zu 1).\
Normalerweise wird dies verwendet, um gef√§hrliche Ports in Instanzen zu √∂ffnen, wie zum Beispiel Port 22:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastic IP-Adressen

Eine _Elastic IP-Adresse_ ist eine **statische IPv4-Adresse**, die f√ºr dynamisches Cloud-Computing entwickelt wurde. Eine Elastic IP-Adresse wird Ihrem AWS-Konto zugewiesen und geh√∂rt Ihnen, bis Sie sie freigeben. Durch die Verwendung einer Elastic IP-Adresse k√∂nnen Sie den Ausfall einer Instanz oder Software maskieren, indem Sie die Adresse schnell auf eine andere Instanz in Ihrem Konto umleiten.

### Verbindung zwischen Subnetzen

Standardm√§√üig haben alle Subnetze die **automatische Zuweisung √∂ffentlicher IP-Adressen deaktiviert**, aber sie kann aktiviert werden.

**Eine lokale Route innerhalb einer Routing-Tabelle erm√∂glicht die Kommunikation zwischen VPC-Subnetzen.**

Wenn Sie ein **Subnetz mit einem anderen Subnetz verbinden, k√∂nnen Sie nicht auf die mit dem anderen Subnetz verbundenen Subnetze zugreifen**, Sie m√ºssen eine direkte Verbindung zu ihnen herstellen. **Dies gilt auch f√ºr Internet-Gateways**. Sie k√∂nnen nicht √ºber eine Subnetzverbindung auf das Internet zugreifen, Sie m√ºssen das Internet-Gateway Ihrem Subnetz zuweisen.

### VPC Peering

VPC Peering erm√∂glicht es Ihnen, **zwei oder mehr VPCs miteinander zu verbinden**, unter Verwendung von IPV4 oder IPV6, als ob sie Teil desselben Netzwerks w√§ren.

Sobald die Peer-Konnektivit√§t hergestellt ist, k√∂nnen **Ressourcen in einer VPC auf Ressourcen in der anderen zugreifen**. Die Konnektivit√§t zwischen den VPCs wird durch die bestehende AWS-Netzwerkinfrastruktur implementiert und ist daher hochverf√ºgbar ohne Bandbreitenengp√§sse. Da **gepaarte Verbindungen so funktionieren, als ob sie Teil desselben Netzwerks w√§ren**, gibt es Einschr√§nkungen hinsichtlich der verwendbaren CIDR-Blockbereiche.\
Wenn Sie **√ºberlappende oder doppelte CIDR**-Bereiche f√ºr Ihre VPC haben, k√∂nnen Sie die VPCs **nicht miteinander peeren**.\
Jede AWS VPC wird **nur mit ihrem Peer kommunizieren**. Zum Beispiel, wenn Sie eine Peering-Verbindung zwischen VPC 1 und VPC 2 haben und eine weitere Verbindung zwischen VPC 2 und VPC 3, wie gezeigt, dann k√∂nnten VPC 1 und 2 direkt miteinander kommunizieren, ebenso wie VPC 2 und VPC 3, jedoch k√∂nnten VPC 1 und VPC 3 nicht miteinander kommunizieren. **Sie k√∂nnen nicht durch eine VPC routen, um zu einer anderen zu gelangen.**

### **VPC Flow Logs**

Innerhalb Ihrer VPC k√∂nnten Sie potenziell Hunderte oder sogar Tausende von Ressourcen haben, die zwischen verschiedenen Subnetzen sowohl √∂ffentlich als auch privat und auch zwischen verschiedenen VPCs durch VPC-Peering-Verbindungen kommunizieren. **VPC Flow Logs erm√∂glichen es Ihnen, IP-Verkehrsinformationen zu erfassen, die zwischen Ihren Netzwerkschnittstellen Ihrer Ressourcen innerhalb Ihrer VPC flie√üen**.

Im Gegensatz zu S3-Zugriffsprotokollen und CloudFront-Zugriffsprotokollen werden die **von VPC Flow Logs generierten Protokolldaten nicht in S3 gespeichert. Stattdessen werden die erfassten Protokolldaten an CloudWatch-Protokolle gesendet**.

Einschr√§nkungen:

* Wenn Sie eine VPC-Peering-Verbindung betreiben, k√∂nnen Sie nur Flow-Logs von gepeerten VPCs sehen, die sich im selben Konto befinden.
* Wenn Sie noch Ressourcen in der EC2-Classic-Umgebung betreiben, k√∂nnen Sie leider keine Informationen von deren Schnittstellen abrufen.
* Sobald ein VPC Flow Log erstellt wurde, kann es nicht mehr ge√§ndert werden. Um die Konfiguration des VPC Flow Logs zu √§ndern, m√ºssen Sie es l√∂schen und dann ein neues erstellen.
* Der folgende Verkehr wird nicht √ºberwacht und von den Protokollen erfasst: DHCP-Verkehr innerhalb der VPC, Verkehr von Instanzen, die f√ºr den Amazon DNS-Server bestimmt sind.
* Jeglicher Verkehr, der an die IP-Adresse des VPC-Standardrouters und Verkehr zu und von den folgenden Adressen gerichtet ist: 169.254.169.254, die f√ºr das Sammeln von Instanz-Metadaten verwendet wird, und 169.254.169.123, die f√ºr den Amazon Time Sync Service verwendet wird.
* Verkehr im Zusammenhang mit einer Amazon Windows-Aktivierungslizenz von einer Windows-Instanz
* Verkehr zwischen einer Netzwerklastenausgleichsschnittstelle und einer Endpunktschnittstelle

F√ºr jede Netzwerkschnittstelle, die Daten an die CloudWatch-Protokollgruppe ver√∂ffentlicht, wird ein anderer Protokollstream verwendet. Und innerhalb jedes dieser Streams werden die Flow-Log-Ereignisdaten angezeigt, die den Inhalt der Protokolleintr√§ge zeigen. Jedes dieser **Protokolle erfasst Daten w√§hrend eines Fensters von etwa 10 bis 15 Minuten**.

## VPN

### Grundlegende AWS VPN-Komponenten

1. **Customer Gateway**:
* Ein Customer Gateway ist eine Ressource, die Sie in AWS erstellen, um Ihre Seite einer VPN-Verbindung darzustellen.
* Es ist im Wesentlichen ein physisches Ger√§t oder eine Softwareanwendung auf Ihrer Seite der Site-to-Site-VPN-Verbindung.
* Sie stellen AWS Routing-Informationen und die √∂ffentliche IP-Adresse Ihres Netzwerkger√§ts (wie ein Router oder eine Firewall) zur Verf√ºgung, um ein Customer Gateway zu erstellen.
* Es dient als Referenzpunkt f√ºr die Einrichtung der VPN-Verbindung und verursacht keine zus√§tzlichen Kosten.
2. **Virtual Private Gateway**:
* Ein Virtual Private Gateway (VPG) ist der VPN-Konzentrator auf der Amazon-Seite der Site-to-Site-VPN-Verbindung.
* Es ist an Ihre VPC angeh√§ngt und dient als Ziel f√ºr Ihre VPN-Verbindung.
* VPG ist der AWS-seitige Endpunkt f√ºr die VPN-Verbindung.
* Es handhabt die sichere Kommunikation zwischen Ihrer VPC und Ihrem lokalen Netzwerk.
3. **Site-to-Site VPN-Verbindung**:
* Eine Site-to-Site-VPN-Verbindung verbindet Ihr lokales Netzwerk √ºber einen sicheren IPsec-VPN-Tunnel mit einer VPC.
* Diese Art der Verbindung erfordert ein Customer Gateway und ein Virtual Private Gateway.
* Es wird f√ºr sichere, stabile und konsistente Kommunikation zwischen Ihrem Rechenzentrum oder Netzwerk und Ihrer AWS-Umgebung verwendet.
* Typischerweise f√ºr regelm√§√üige, langfristige Verbindungen verwendet und wird basierend auf der Menge der √ºber die Verbindung √ºbertragenen Daten abgerechnet.
4. **Client VPN Endpoint**:
* Ein Client VPN Endpoint ist eine Ressource, die Sie in AWS erstellen, um Client-VPN-Sitzungen zu erm√∂glichen und zu verwalten.
* Es wird verwendet, um einzelnen Ger√§ten (wie Laptops, Smartphones usw.) zu erm√∂glichen, sicher auf AWS-Ressourcen oder Ihr lokales Netzwerk zuzugreifen.
* Es unterscheidet sich von Site-to-Site-VPN dadurch, dass es f√ºr einzelne Clients und nicht f√ºr die Verbindung ganzer Netzwerke konzipiert ist.
* Mit Client VPN verwendet jedes Client-Ger√§t eine VPN-Client-Software, um eine sichere Verbindung herzustellen.

### Site-to-Site VPN

**Verbinden Sie Ihr lokales Netzwerk mit Ihrer VPC.**

* **VPN-Verbindung**: Eine sichere Verbindung zwischen Ihrer lokalen Ausr√ºstung und Ihren VPCs.
* **VPN-Tunnel**: Ein verschl√ºsselter Link, √ºber den Daten vom Kundennetzwerk zu oder von AWS √ºbertragen werden k√∂nnen.

Jede VPN-Verbindung umfasst zwei VPN-Tunnel, die Sie gleichzeitig f√ºr hohe Verf√ºgbarkeit nutzen k√∂nnen.
* **Customer Gateway**: Eine AWS-Ressource, die AWS Informationen √ºber Ihr Customer Gateway-Ger√§t bereitstellt.
* **Customer Gateway-Ger√§t**: Ein physisches Ger√§t oder eine Softwareanwendung auf Ihrer Seite der Site-to-Site-VPN-Verbindung.
* **Virtual Private Gateway**: Der VPN-Konzentrator auf der Amazon-Seite der Site-to-Site-VPN-Verbindung. Sie verwenden ein Virtual Private Gateway oder ein Transit Gateway als Gateway f√ºr die Amazon-Seite der Site-to-Site-VPN-Verbindung.
* **Transit Gateway**: Ein Transithub, das verwendet werden kann, um Ihre VPCs und lokalen Netzwerke zu verbinden. Sie verwenden ein Transit Gateway oder ein Virtual Private Gateway als Gateway f√ºr die Amazon-Seite der Site-to-Site-VPN-Verbindung.

#### Einschr√§nkungen

* IPv6-Verkehr wird f√ºr VPN-Verbindungen auf einem Virtual Private Gateway nicht unterst√ºtzt.
* Eine AWS-VPN-Verbindung unterst√ºtzt keine Path-MTU-Erkennung.

Dar√ºber hinaus sollten Sie Folgendes ber√ºcksichtigen, wenn Sie Site-to-Site-VPN verwenden.

* Wenn Sie Ihre VPCs mit einem gemeinsamen lokalen Netzwerk verbinden, empfehlen wir, dass Sie nicht √ºberlappende CIDR-Bl√∂cke f√ºr Ihre Netzwerke verwenden.

### Client VPN <a href="#what-is-components" id="what-is-components"></a>

**Verbinden Sie sich von Ihrem Ger√§t mit Ihrer VPC**

#### Konzepte

* **Client VPN Endpoint:** Die Ressource, die Sie erstellen und konfigurieren, um Client-VPN-Sitzungen zu erm√∂glichen und zu verwalten. Es ist die Ressource, bei der alle Client-VPN-Sitzungen beendet werden.
* **Zielnetzwerk:** Ein Zielnetzwerk ist das Netzwerk, das Sie mit einem Client VPN Endpoint verkn√ºpfen. **Ein Subnetz aus einer VPC ist ein Zielnetzwerk**. Die Verkn√ºpfung eines Subnetzes mit einem Client VPN Endpoint erm√∂glicht es Ihnen, VPN-Sitzungen zu erstellen. Sie k√∂nnen mehrere Subnetze mit einem Client VPN Endpoint f√ºr hohe Verf√ºgbarkeit verkn√ºpfen. Alle Subnetze
