# AWS - VPC & Networking Basic Information

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## AWS Networking u Kratkim Crtama

**VPC** sadrži **network CIDR** kao što je 10.0.0.0/16 (sa svojom **routing tabelom** i **network ACL**).

Ova VPC mreža je podeljena na **podmreže**, tako da je **podmreža** direktno **povezana** sa **VPC**, **routing** **tabelom** i **network ACL**.

Zatim, **Network Interface**-i povezani sa servisima (kao što su EC2 instance) su **povezani** sa **podmrežama** sa **security group(s)**.

Dakle, **security group** će ograničiti izložene portove mrežnih **interfejsa koji ga koriste**, **nezavisno od podmreže**. A **network ACL** će **ograničiti** izložene portove za **celu mrežu**.

Pored toga, da biste **pristupili Internetu**, postoje neke zanimljive konfiguracije koje treba proveriti:

* **Podmreža** može **automatski dodeliti javne IPv4 adrese**
* **Instanca** kreirana u mreži koja **automatski dodeljuje IPv4 adrese može dobiti jednu**
* **Internet gateway** mora biti **povezan** sa **VPC**
* Takođe možete koristiti **Egress-only internet gateways**
* Takođe možete imati **NAT gateway** u **privatnoj podmreži** tako da je moguće **povezati se sa spoljnim servisima** iz te privatne podmreže, ali **nije moguće doći do njih spolja**.
* NAT gateway može biti **javni** (pristup internetu) ili **privatni** (pristup drugim VPC-ovima)

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) omogućava vam da **pokrenete AWS resurse u virtuelnoj mreži** koju ste definisali. Ova virtuelna mreža će imati nekoliko podmreža, Internet Gateway-e za pristup Internetu, ACL-ove, Security grupe, IP adrese...

### Podmreže

Podmreže pomažu u sprovođenju višeg nivoa sigurnosti. **Logičko grupisanje sličnih resursa** takođe vam pomaže da održavate **lakše upravljanje** vašom infrastrukturom.

* Validni CIDR su od /16 netmask do /28 netmask.
* Podmreža ne može biti u različitim zonama dostupnosti u isto vreme.
* **AWS rezerviše prve tri IP adrese hosta** svake podmreže **za** **internu AWS upotrebu**: prva adresa hosta se koristi za VPC ruter. Druga adresa je rezervisana za AWS DNS, a treća adresa je rezervisana za buduću upotrebu.
* Nazivaju se **javne podmreže** one koje imaju **direktan pristup Internetu, dok privatne podmreže nemaju.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Route Tables

Route tables određuju rutiranje saobraćaja za podmrežu unutar VPC-a. One određuju koji mrežni saobraćaj se prosleđuje na internet ili na VPN vezu. Obično ćete naći pristup:

* Lokalni VPC
* NAT
* Internet Gateway-e / Egress-only Internet gateway-e (potrebni za davanje VPC-u pristupa Internetu).
* Da biste učinili podmrežu javnom, potrebno je **kreirati** i **povezati** **Internet gateway** sa vašim VPC-om.
* VPC endpoints (za pristup S3 iz privatnih mreža)

Na sledećim slikama možete proveriti razlike u podrazumevanoj javnoj mreži i privatnoj:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Network Access Control Lists (ACLs)**: Network ACLs su firewall pravila koja kontrolišu dolazni i odlazni mrežni saobraćaj ka podmreži. Mogu se koristiti za dozvolu ili zabranu saobraćaja ka specifičnim IP adresama ili opsezima.

* Najčešće se koristi za dozvolu/zabranu pristupa koristeći security groups, ali ovo je jedini način da se potpuno prekinu uspostavljene reverse shells. Izmenjeno pravilo u security groups ne zaustavlja već uspostavljene veze.
* Međutim, ovo se primenjuje na celu podmrežu, budite pažljivi kada zabranjujete stvari jer potrebna funkcionalnost može biti poremećena.

### Security Groups

Security groups su virtuelni **firewall** koji kontroliše dolazni i odlazni mrežni **saobraćaj ka instancama** u VPC-u. Odnos 1 SG prema M instancama (obično 1 prema 1).\
Obično se koristi za otvaranje opasnih portova na instancama, kao što je port 22 na primer:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastic IP Addresses

_Elastic IP address_ je **staticka IPv4 adresa** dizajnirana za dinamičko cloud računarstvo. Elastic IP adresa je dodeljena vašem AWS nalogu i vaša je dok je ne oslobodite. Korišćenjem Elastic IP adrese, možete maskirati kvar instance ili softvera brzim premapiranjem adrese na drugu instancu u vašem nalogu.

### Povezivanje između podmreža

Podrazumevano, sve podmreže imaju **automatsko dodeljivanje javnih IP adresa isključeno**, ali se može uključiti.

**Lokalna ruta unutar route tabele omogućava komunikaciju između VPC podmreža.**

Ako **povezujete podmrežu sa drugom podmrežom, ne možete pristupiti podmrežama povezanim** sa drugom podmrežom, morate kreirati vezu sa njima direktno. **Ovo se takođe odnosi na internet gateway-e.** Ne možete proći kroz vezu podmreže da biste pristupili internetu, morate dodeliti internet gateway vašoj podmreži.

### VPC Peering

VPC peering vam omogućava da **povežete dva ili više VPC-a zajedno**, koristeći IPV4 ili IPV6, kao da su deo iste mreže.

Kada se uspostavi peer konektivnost, **resursi u jednom VPC-u mogu pristupiti resursima u drugom**. Konektivnost između VPC-ova se implementira kroz postojeću AWS mrežnu infrastrukturu, tako da je visoko dostupna bez uskih grla u propusnom opsegu. Kako **peered konekcije funkcionišu kao da su deo iste mreže**, postoje ograničenja kada je reč o opsezima CIDR blokova koji se mogu koristiti.\
Ako imate **preklapajuće ili duplirane CIDR** opsege za vaš VPC, tada **nećete moći da peer-ujete VPC-ove** zajedno.\
Svaki AWS VPC će **komunicirati samo sa svojim peer-om**. Na primer, ako imate peering konekciju između VPC 1 i VPC 2, i drugu konekciju između VPC 2 i VPC 3 kao što je prikazano, tada VPC 1 i 2 mogu direktno komunicirati jedan sa drugim, kao i VPC 2 i VPC 3, međutim, VPC 1 i VPC 3 ne mogu. **Ne možete rutirati kroz jedan VPC da biste došli do drugog.**

### **VPC Flow Logs**

Unutar vašeg VPC-a, potencijalno možete imati stotine ili čak hiljade resursa koji svi komuniciraju između različitih podmreža, kako javnih tako i privatnih, kao i između različitih VPC-ova kroz VPC peering konekcije. **VPC Flow Logs vam omogućavaju da zabeležite IP saobraćaj koji prolazi između vaših mrežnih interfejsa resursa unutar vašeg VPC-a**.

Za razliku od S3 access logs i CloudFront access logs, **log podaci generisani od strane VPC Flow Logs nisu skladišteni u S3. Umesto toga, log podaci se šalju u CloudWatch logs**.

Ograničenja:

* Ako imate VPC peered konekciju, moći ćete da vidite flow logs samo za peered VPC-ove koji su unutar istog naloga.
* Ako još uvek koristite resurse unutar EC2-Classic okruženja, nažalost ne možete dobiti informacije sa njihovih interfejsa.
* Kada se kreira VPC Flow Log, ne može se menjati. Da biste promenili konfiguraciju VPC Flow Log-a, morate ga obrisati i zatim kreirati novi.
* Sledeći saobraćaj nije nadgledan i zabeležen u logovima. DHCP saobraćaj unutar VPC-a, saobraćaj sa instanci namenjen Amazon DNS serveru.
* Bilo koji saobraćaj namenjen IP adresi za VPC podrazumevani ruter i saobraćaj ka i od sledećih adresa, 169.254.169.254 koja se koristi za prikupljanje instance metadata, i 169.254.169.123 koja se koristi za Amazon Time Sync Service.
* Saobraćaj vezan za Amazon Windows aktivacionu licencu sa Windows instance.
* Saobraćaj između network load balancer interfejsa i endpoint network interfejsa.

Za svaki mrežni interfejs koji objavljuje podatke u CloudWatch log grupu, koristiće se različit log stream. I unutar svakog od ovih stream-ova, biće flow log event podaci koji prikazuju sadržaj log unosa. Svaki od ovih **logova beleži podatke tokom prozora od približno 10 do 15 minuta**.

## VPN

### Osnovne AWS VPN Komponente

1. **Customer Gateway**:
* Customer Gateway je resurs koji kreirate u AWS-u da predstavlja vašu stranu VPN konekcije.
* To je u suštini fizički uređaj ili softverska aplikacija na vašoj strani Site-to-Site VPN konekcije.
* Pružate informacije o rutiranju i javnu IP adresu vašeg mrežnog uređaja (kao što je ruter ili firewall) AWS-u da biste kreirali Customer Gateway.
* Služi kao referentna tačka za postavljanje VPN konekcije i ne izaziva dodatne troškove.
2. **Virtual Private Gateway**:
* Virtual Private Gateway (VPG) je VPN koncentrator na Amazon strani Site-to-Site VPN konekcije.
* Povezan je sa vašim VPC-om i služi kao cilj za vašu VPN konekciju.
* VPG je AWS strana krajnja tačka za VPN konekciju.
* Rukuje sigurnom komunikacijom između vašeg VPC-a i vaše on-premises mreže.
3. **Site-to-Site VPN Connection**:
* Site-to-Site VPN konekcija povezuje vašu on-premises mrežu sa VPC-om kroz siguran, IPsec VPN tunel.
* Ova vrsta konekcije zahteva Customer Gateway i Virtual Private Gateway.
* Koristi se za sigurnu, stabilnu i konzistentnu komunikaciju između vašeg data centra ili mreže i vašeg AWS okruženja.
* Obično se koristi za redovne, dugoročne konekcije i naplaćuje se na osnovu količine podataka prenetih preko konekcije.
4. **Client VPN Endpoint**:
* Client VPN endpoint je resurs koji kreirate u AWS-u da omogućite i upravljate client VPN sesijama.
* Koristi se za omogućavanje pojedinačnim uređajima (kao što su laptopovi, pametni telefoni, itd.) da se sigurno povežu sa AWS resursima ili vašom on-premises mrežom.
* Razlikuje se od Site-to-Site VPN po tome što je dizajniran za pojedinačne klijente, a ne za povezivanje celih mreža.
* Sa Client VPN, svaki klijentski uređaj koristi VPN klijentski softver da uspostavi sigurnu vezu.

### Site-to-Site VPN

**Povežite vašu on-premises mrežu sa vašim VPC-om.**

* **VPN konekcija**: Sigurna veza između vaše on-premises opreme i vaših VPC-ova.
* **VPN tunel**: Enkriptovana veza kroz koju podaci mogu prolaziti iz mreže korisnika ka ili od AWS-a.

Svaka VPN konekcija uključuje dva VPN tunela koja možete istovremeno koristiti za visoku dostupnost.
* **Customer gateway**: AWS resurs koji pruža informacije AWS-u o vašem customer gateway uređaju.
* **Customer gateway uređaj**: Fizički uređaj ili softverska aplikacija na vašoj strani Site-to-Site VPN konekcije.
* **Virtual private gateway**: VPN koncentrator na Amazon strani Site-to-Site VPN konekcije. Koristite virtual private gateway ili transit gateway kao gateway za Amazon stranu Site-to-Site VPN konekcije.
* **Transit gateway**: Transit hub koji se može koristiti za međusobno povezivanje vaših VPC-ova i on-premises mreža. Koristite transit gateway ili virtual private gateway kao gateway za Amazon stranu Site-to-Site VPN konekcije.

#### Ograničenja

* IPv6 saobraćaj nije podržan za VPN konekcije na virtual private gateway-u.
* AWS VPN konekcija ne podržava
