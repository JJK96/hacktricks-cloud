# AWS - VPC & Networking Basic Information

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## AWS Networking σε λίγες γραμμές

Ένα **VPC** περιέχει ένα **network CIDR** όπως 10.0.0.0/16 (με τον **πίνακα δρομολόγησης** και το **network ACL** του).

Αυτό το δίκτυο VPC χωρίζεται σε **υποδίκτυα**, έτσι ένα **υποδίκτυο** είναι άμεσα **σχετιζόμενο** με το **VPC**, τον **πίνακα δρομολόγησης** και το **network ACL**.

Στη συνέχεια, οι **Network Interface**s που συνδέονται με υπηρεσίες (όπως οι EC2 instances) είναι **συνδεδεμένες** με τα **υποδίκτυα** με **security group(s)**.

Επομένως, ένα **security group** θα περιορίσει τις εκτεθειμένες θύρες των **network interfaces που το χρησιμοποιούν**, **ανεξάρτητα από το υποδίκτυο**. Και ένα **network ACL** θα **περιορίσει** τις εκτεθειμένες θύρες σε ολόκληρο το **δίκτυο**.

Επιπλέον, για να **πρόσβαση στο Internet**, υπάρχουν μερικές ενδιαφέρουσες ρυθμίσεις που πρέπει να ελέγξετε:

* Ένα **υποδίκτυο** μπορεί να **αναθέτει αυτόματα δημόσιες διευθύνσεις IPv4**
* Μια **instance** που δημιουργείται στο δίκτυο που **αναθέτει αυτόματα διευθύνσεις IPv4 μπορεί να πάρει μία**
* Ένα **Internet gateway** πρέπει να είναι **συνδεδεμένο** με το **VPC**
* Μπορείτε επίσης να χρησιμοποιήσετε **Egress-only internet gateways**
* Μπορείτε επίσης να έχετε ένα **NAT gateway** σε ένα **ιδιωτικό υποδίκτυο** ώστε να είναι δυνατό να **συνδεθείτε με εξωτερικές υπηρεσίες** από αυτό το ιδιωτικό υποδίκτυο, αλλά δεν είναι **δυνατό να τις προσεγγίσετε από το εξωτερικό**.
* Το NAT gateway μπορεί να είναι **δημόσιο** (πρόσβαση στο internet) ή **ιδιωτικό** (πρόσβαση σε άλλα VPCs)

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Το Amazon **Virtual Private Cloud** (Amazon VPC) σας επιτρέπει να **εκκινήσετε πόρους AWS σε ένα εικονικό δίκτυο** που έχετε ορίσει. Αυτό το εικονικό δίκτυο θα έχει διάφορα υποδίκτυα, Internet Gateways για πρόσβαση στο Internet, ACLs, Security groups, IPs...

### Subnets

Τα υποδίκτυα βοηθούν στην επιβολή ενός μεγαλύτερου επιπέδου ασφάλειας. **Λογική ομαδοποίηση παρόμοιων πόρων** βοηθά επίσης στη διατήρηση της **ευκολίας διαχείρισης** σε όλη την υποδομή σας.

* Έγκυρα CIDR είναι από ένα /16 netmask έως ένα /28 netmask.
* Ένα υποδίκτυο δεν μπορεί να βρίσκεται σε διαφορετικές ζώνες διαθεσιμότητας ταυτόχρονα.
* **AWS διατηρεί τις πρώτες τρεις διευθύνσεις IP host** κάθε υποδικτύου **για** **εσωτερική χρήση AWS**: η πρώτη διεύθυνση host χρησιμοποιείται για τον δρομολογητή VPC. Η δεύτερη διεύθυνση είναι κρατημένη για το AWS DNS και η τρίτη διεύθυνση είναι κρατημένη για μελλοντική χρήση.
* Ονομάζεται **δημόσια υποδίκτυα** αυτά που έχουν **άμεση πρόσβαση στο Internet, ενώ τα ιδιωτικά υποδίκτυα δεν έχουν.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Route Tables

Οι πίνακες δρομολόγησης καθορίζουν τη δρομολόγηση της κυκλοφορίας για ένα υποδίκτυο μέσα σε ένα VPC. Καθορίζουν ποια δικτυακή κυκλοφορία προωθείται στο internet ή σε μια σύνδεση VPN. Συνήθως θα βρείτε πρόσβαση στο:

* Τοπικό VPC
* NAT
* Internet Gateways / Egress-only Internet gateways (απαραίτητα για να δώσετε σε ένα VPC πρόσβαση στο Internet).
* Για να κάνετε ένα υποδίκτυο δημόσιο, πρέπει να **δημιουργήσετε** και να **συνδέσετε** ένα **Internet gateway** στο VPC σας.
* VPC endpoints (για πρόσβαση στο S3 από ιδιωτικά δίκτυα)

Στις παρακάτω εικόνες μπορείτε να δείτε τις διαφορές σε ένα προεπιλεγμένο δημόσιο δίκτυο και ένα ιδιωτικό:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Network Access Control Lists (ACLs)**: Τα Network ACLs είναι κανόνες firewall που ελέγχουν την εισερχόμενη και εξερχόμενη δικτυακή κυκλοφορία σε ένα υποδίκτυο. Μπορούν να χρησιμοποιηθούν για να επιτρέψουν ή να αρνηθούν την κυκλοφορία σε συγκεκριμένες διευθύνσεις IP ή εύρη.

* Είναι πιο συχνό να επιτρέπεται/απαγορεύεται η πρόσβαση χρησιμοποιώντας security groups, αλλά αυτός είναι ο μόνος τρόπος να διακοπούν εντελώς οι καθιερωμένες reverse shells. Ένας τροποποιημένος κανόνας σε ένα security group δεν σταματά ήδη καθιερωμένες συνδέσεις.
* Ωστόσο, αυτό ισχύει για ολόκληρο το υποδίκτυο, προσέξτε όταν απαγορεύετε πράγματα γιατί μπορεί να διαταραχθεί η απαραίτητη λειτουργικότητα.

### Security Groups

Τα security groups είναι ένα εικονικό **firewall** που ελέγχει την εισερχόμενη και εξερχόμενη δικτυακή **κυκλοφορία σε instances** σε ένα VPC. Σχέση 1 SG προς M instances (συνήθως 1 προς 1).\
Συνήθως αυτό χρησιμοποιείται για να ανοίξει επικίνδυνες θύρες σε instances, όπως η θύρα 22 για παράδειγμα:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastic IP Addresses

Μια _Elastic IP address_ είναι μια **στατική διεύθυνση IPv4** σχεδιασμένη για δυναμικό cloud computing. Μια Elastic IP address εκχωρείται στον λογαριασμό σας AWS και είναι δική σας μέχρι να την απελευθερώσετε. Χρησιμοποιώντας μια Elastic IP address, μπορείτε να καλύψετε την αποτυχία μιας instance ή λογισμικού ανακατευθύνοντας γρήγορα τη διεύθυνση σε μια άλλη instance στον λογαριασμό σας.

### Σύνδεση μεταξύ υποδικτύων

Από προεπιλογή, όλα τα υποδίκτυα έχουν **αυτόματα απενεργοποιημένη την ανάθεση δημόσιων διευθύνσεων IP**, αλλά μπορεί να ενεργοποιηθεί.

**Μια τοπική διαδρομή μέσα σε έναν πίνακα δρομολόγησης επιτρέπει την επικοινωνία μεταξύ υποδικτύων VPC.**

Εάν **συνδέετε ένα υποδίκτυο με ένα διαφορετικό υποδίκτυο, δεν μπορείτε να έχετε πρόσβαση στα υποδίκτυα που είναι συνδεδεμένα** με το άλλο υποδίκτυο, πρέπει να δημιουργήσετε σύνδεση με αυτά απευθείας. **Αυτό ισχύει επίσης για τα internet gateways**. Δεν μπορείτε να περάσετε μέσω μιας σύνδεσης υποδικτύου για να έχετε πρόσβαση στο internet, πρέπει να αναθέσετε το internet gateway στο υποδίκτυό σας.

### VPC Peering

Το VPC peering σας επιτρέπει να **συνδέσετε δύο ή περισσότερα VPCs μαζί**, χρησιμοποιώντας IPV4 ή IPV6, σαν να ήταν μέρος του ίδιου δικτύου.

Μόλις καθιερωθεί η σύνδεση peer, **οι πόροι σε ένα VPC μπορούν να έχουν πρόσβαση στους πόρους στο άλλο**. Η συνδεσιμότητα μεταξύ των VPCs υλοποιείται μέσω της υπάρχουσας υποδομής δικτύου AWS, και έτσι είναι εξαιρετικά διαθέσιμη χωρίς περιορισμούς εύρους ζώνης. Καθώς **οι συνδέσεις peer λειτουργούν σαν να ήταν μέρος του ίδιου δικτύου**, υπάρχουν περιορισμοί όσον αφορά τα εύρη CIDR block που μπορούν να χρησιμοποιηθούν.\
Εάν έχετε **επικαλυπτόμενα ή διπλάσια CIDR** εύρη για το VPC σας, τότε **δεν θα μπορείτε να συνδέσετε τα VPCs** μαζί.\
Κάθε AWS VPC θα **επικοινωνεί μόνο με το peer του**. Για παράδειγμα, εάν έχετε μια σύνδεση peer μεταξύ VPC 1 και VPC 2, και μια άλλη σύνδεση μεταξύ VPC 2 και VPC 3 όπως φαίνεται, τότε το VPC 1 και το VPC 2 θα μπορούσαν να επικοινωνούν μεταξύ τους απευθείας, όπως και το VPC 2 και το VPC 3, ωστόσο, το VPC 1 και το VPC 3 δεν θα μπορούσαν. **Δεν μπορείτε να δρομολογήσετε μέσω ενός VPC για να φτάσετε σε ένα άλλο.**

### **VPC Flow Logs**

Μέσα στο VPC σας, θα μπορούσατε ενδεχομένως να έχετε εκατοντάδες ή ακόμα και χιλιάδες πόρους που επικοινωνούν μεταξύ διαφορετικών υποδικτύων, τόσο δημόσιων όσο και ιδιωτικών, και επίσης μεταξύ διαφορετικών VPCs μέσω συνδέσεων VPC peering. **Τα VPC Flow Logs σας επιτρέπουν να καταγράφετε πληροφορίες IP κυκλοφορίας που ρέουν μεταξύ των δικτυακών διεπαφών των πόρων σας μέσα στο VPC σας**.

Σε αντίθεση με τα S3 access logs και τα CloudFront access logs, τα **δεδομένα καταγραφής που δημιουργούνται από τα VPC Flow Logs δεν αποθηκεύονται στο S3. Αντίθετα, τα δεδομένα καταγραφής που καταγράφονται αποστέλλονται στα CloudWatch logs**.

Περιορισμοί:

* Εάν εκτελείτε μια σύνδεση VPC peered, τότε θα μπορείτε να δείτε μόνο τα flow logs των peered VPCs που βρίσκονται στον ίδιο λογαριασμό.
* Εάν εξακολουθείτε να εκτελείτε πόρους στο περιβάλλον EC2-Classic, τότε δυστυχώς δεν μπορείτε να ανακτήσετε πληροφορίες από τις διεπαφές τους.
* Μόλις δημιουργηθεί ένα VPC Flow Log, δεν μπορεί να αλλάξει. Για να αλλάξετε τη διαμόρφωση του VPC Flow Log, πρέπει να το διαγράψετε και στη συνέχεια να δημιουργήσετε ένα νέο.
* Η ακόλουθη κυκλοφορία δεν παρακολουθείται και δεν καταγράφεται από τα logs. Κυκλοφορία DHCP μέσα στο VPC, κυκλοφορία από instances που προορίζονται για τον Amazon DNS Server.
* Οποιαδήποτε κυκλοφορία που προορίζεται για τη διεύθυνση IP του προεπιλεγμένου δρομολογητή VPC και κυκλοφορία προς και από τις ακόλουθες διευθύνσεις, 169.254.169.254 που χρησιμοποιείται για τη συλλογή μεταδεδομένων instance, και 169.254.169.123 που χρησιμοποιείται για την υπηρεσία συγχρονισμού χρόνου Amazon.
* Κυκλοφορία που σχετίζεται με μια άδεια ενεργοποίησης Amazon Windows από μια instance Windows.
* Κυκλοφορία μεταξύ μιας διεπαφής network load balancer και μιας διεπαφής endpoint network.

Για κάθε δικτυακή διεπαφή που δημοσιεύει δεδομένα στην ομάδα καταγραφής CloudWatch, θα χρησιμοποιηθεί διαφορετικό ρεύμα καταγραφής. Και μέσα σε κάθε ένα από αυτά τα ρεύματα, θα υπάρχουν τα δεδομένα συμβάντων flow log που δείχνουν το περιεχόμενο των καταχωρήσεων καταγραφής. Κάθε ένα από αυτά τα **logs καταγράφει δεδομένα κατά τη διάρκεια ενός παραθύρου περίπου 10 έως 15 λεπτών**.

## VPN

### Βασικά Συστατικά AWS VPN

1. **Customer Gateway**:
* Ένα Customer Gateway είναι ένας πόρος που δημιουργείτε στο AWS για να αντιπροσωπεύει την πλευρά σας μιας σύνδεσης VPN.
* Είναι ουσιαστικά μια φυσική συσκευή ή εφαρμογή λογισμικού στην πλευρά σας της σύνδεσης Site-to-Site VPN.
* Παρέχετε πληροφορίες δρομολόγησης και τη δημόσια διεύθυνση IP της δικτυακής σας συσκευής (όπως ένας δρομολογητής ή ένα firewall) στο AWS για να δημιουργήσετε ένα Customer Gateway.
* Λειτουργεί ως σημείο αναφοράς για τη ρύθμιση της σύνδεσης VPN και δεν επιφέρει επιπλέον χρεώσεις.
2. **Virtual Private Gateway**:
* Ένα Virtual Private Gateway (VPG) είναι ο συγκεντρωτής VPN στην πλευρά του Amazon της σύνδεσης Site-to-Site VPN.
* Είναι συνδεδεμένο με το VPC σας και λειτουργεί ως στόχος για τη σύνδεση VPN σας.
* Το VPG είναι το endpoint της πλευ
