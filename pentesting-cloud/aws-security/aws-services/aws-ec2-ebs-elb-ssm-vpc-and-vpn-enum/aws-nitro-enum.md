# AWS - Nitro Enum

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repo's.

</details>
{% endhint %}

## Basiese Inligting

AWS Nitro is 'n reeks **innoverende tegnologie√´** wat die onderliggende platform vir AWS EC2-instanse vorm. Ingevoer deur Amazon om **sekuriteit, prestasie en betroubaarheid te verbeter**, gebruik Nitro pasgemaakte **hardewarekomponente en 'n liggewig hipervisor**. Dit abstraheer baie van die tradisionele virtualiseringsfunksionaliteit na toegewyde hardeware en sagteware, **verminder die aanvaloppervlak** en verbeter hulpbron-doeltreffendheid. Deur virtualiseringsfunksies oor te dra, laat Nitro EC2-instanse **byna naakte metaalprestasie** lewer, wat dit besonder voordelig maak vir hulpbron-intensiewe toepassings. Daarbenewens verseker die Nitro Security Chip spesifiek die **sekuriteit van die hardeware en firmware**, wat sy robuuste argitektuur verder versterk.

### Nitro Enclaves

**AWS Nitro Enclaves** bied 'n veilige, **ge√Øsoleerde rekenkomgewing binne Amazon EC2-instanse**, spesifiek ontwerp vir die verwerking van hoogs sensitiewe data. Deur gebruik te maak van die AWS Nitro-stelsel, verseker hierdie enclaves robuuste **isolering en sekuriteit**, ideaal vir die **hantering van vertroulike inligting** soos PII of finansi√´le rekords. Hulle het 'n minimalistiese omgewing, wat die risiko van data-blootstelling aansienlik verminder. Daarbenewens ondersteun Nitro Enclaves kriptografiese attestasie, wat gebruikers in staat stel om te verifieer dat slegs gemagtigde kode loop, wat noodsaaklik is vir die handhawing van streng nakomings- en databeskermingsstandaarde.

{% hint style="danger" %}
Nitro Enclave-beelde word **van binne EC2-instanse uitgevoer** en jy kan nie vanaf die AWS-webkonsole sien of 'n EC2-instanse beelde in Nitro Enclave uitvoer of nie.
{% endhint %}

## Nitro Enclave CLI installasie

Volg al die instruksies [**uit die dokumentasie**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave). Dit is egter die belangrikste:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave Beelde

Die beelde wat jy in Nitro Enclave kan laat loop, is gebaseer op docker beelde, so jy kan jou Nitro Enclave beelde skep van docker beelde soos:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Soos jy kan sien, gebruik die Nitro Enclave-beelde die uitbreiding **`eif`** (Enclave Image File).

Die uitset sal soortgelyk lyk aan:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Run 'n Beeld

Soos per [**die dokumentasie**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave), om 'n enclave-beeld te laat loop, moet jy dit geheue toewys van **ten minste 4 keer die grootte van die `eif`-l√™er**. Dit is moontlik om die verstekhulpbronne wat daaraan gegee word, te konfigureer in die l√™er
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
Onthou altyd dat jy **'n paar hulpbronne vir die ouer EC2** instansie moet reserveer!
{% endhint %}

Nadat jy weet watter hulpbronne om aan 'n beeld te gee en selfs die konfigurasiel√™er aangepas het, is dit moontlik om 'n enclave-beeld te laat loop met:

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Enumerate Enclaves

As jy 'n EC2-gasheer kompromitteer, is dit moontlik om 'n lys van lopende enclave-beelde te kry met:
```bash
nitro-cli describe-enclaves
```
Dit is **nie moontlik om 'n dop** binne 'n lopende enclave-beeld te kry nie, want dit is die hoofdoel van enclave, maar as jy die parameter **`--debug-mode`** gebruik het, is dit moontlik om die **stdout** daarvan te kry met:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Be√´indig Enclaves

As 'n aanvaller 'n EC2-instansie kompromitteer, sal hy standaard nie 'n dop binne hulle kan kry nie, maar hy sal in staat wees om hulle te **be√´indig** met:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsocks

Die enigste manier om met 'n **enclave**-lopende beeld te kommunikeer, is deur **vsocks** te gebruik.

**Virtual Socket (vsock)** is 'n sokfamilie in Linux wat spesifiek ontwerp is om **kommunikasie** tussen virtuele masjiene (**VMs**) en hul **hipervisors**, of tussen VMs **self**, te fasiliteer. Vsock stel doeltreffende, **bi-rigting kommunikasie** in staat sonder om op die gasheer se netwerkstapel staat te maak. Dit maak dit moontlik vir VMs om te kommunikeer selfs sonder netwerk konfigurasies, **deur 'n 32-bis Konteks ID (CID) en poortnommers** te gebruik om verbindings te identifiseer en te bestuur. Die vsock API ondersteun beide stroom- en datagram-soksoorte, soortgelyk aan TCP en UDP, wat 'n veelsydige hulpmiddel vir gebruikersvlaktoepassings in virtuele omgewings bied.

{% hint style="success" %}
Dus, 'n vsock-adres lyk so: `<CID>:<Port>`
{% endhint %}

Om **CIDs** van die enclave-lopende beelde te vind, kan jy net die volgende opdrag uitvoer en die **`EnclaveCID`** kry:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
Let daarop dat daar vanaf die gasheer geen manier is om te weet of 'n CID enige poort blootstel nie! Tensy jy 'n **vsock-poortskandeerder soos** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner) gebruik.
{% endhint %}

### Vsock Server/Listener

Vind hier 'n paar voorbeelde:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Eenvoudige Python Listener</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>

## AWS Nitro Enum

### Oorsig

AWS Nitro is 'n stel tegnologie√´ wat die basis vorm van die volgende generasie van Amazon EC2 instances. Dit bied verbeterde sekuriteit, werkverrigting, en doeltreffendheid. Hierdie afdeling dek die verskillende aspekte van AWS Nitro en hoe om dit te ondersoek tydens pentesting.

### Nitro Enclaves

Nitro Enclaves is 'n funksie van AWS Nitro wat veilige, ge√Øsoleerde rekenomgewings binne EC2 instances skep. Dit is nuttig vir die beskerming van sensitiewe data en die uitvoering van sekuriteitskritieke toepassings.

### Nitro Security Chip

Die Nitro Security Chip is 'n hardeware-gebaseerde sekuriteitsmeganisme wat help om die integriteit van die Nitro-stelsel te verseker. Dit beheer toegang tot geheue en stoor, en help om die risiko van sekuriteitsbreuke te verminder.

### Nitro Hypervisor

Die Nitro Hypervisor is 'n liggewig hypervisor wat die bestuur van rekenhulpbronne in EC2 instances hanteer. Dit bied verbeterde werkverrigting en sekuriteit deur die gebruik van hardeware-ondersteunde virtualisasie.

### Enum Tegnieke

1. **Identifiseer Nitro Instances**: Gebruik AWS CLI of SDK's om te bepaal of 'n EC2 instance Nitro-tegnologie gebruik.
2. **Toegang tot Nitro Enclaves**: Verken die beskikbare Nitro Enclaves en hul konfigurasies.
3. **Beveiligingskontroles**: Evalueer die sekuriteitsmaatre√´ls wat deur die Nitro Security Chip en Nitro Hypervisor ge√Ømplementeer is.

### Gevolgtrekking

AWS Nitro bied 'n robuuste stel sekuriteits- en werkverrigtingverbeterings vir EC2 instances. Deur die begrip en ondersoek van hierdie tegnologie√´, kan pentesters beter insig kry in die sekuriteitsposisie van AWS-omgewings.
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock Client

Voorbeelde:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>Eenvoudige Python Kli√´nt</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>

## AWS Nitro Enum

### Oorsig

AWS Nitro is 'n stel sekuriteits- en virtualiseringstegnologie√´ wat gebruik word in AWS EC2. Dit is belangrik om te verstaan hoe om inligting oor Nitro-gebaseerde instansies te versamel tydens pentesting.

### Nitro Enums

1. **Instansie Metadata**: Nitro instansies het 'n spesifieke stel metadata eindpunte. Gebruik die volgende opdrag om metadata te verkry:
    ```bash
    curl http://169.254.169.254/latest/meta-data/
    ```

2. **Nitro Enklaves**: Nitro Enklaves bied 'n veilige omgewing vir sensitiewe data verwerking. Om te sien of 'n instansie Nitro Enklaves ondersteun, gebruik:
    ```bash
    aws ec2 describe-instances --instance-ids <instance-id> --query "Reservations[].Instances[].EnclaveOptions"
    ```

3. **Nitro Hypervisor**: Nitro gebruik 'n liggewig hypervisor. Om te bevestig of 'n instansie die Nitro hypervisor gebruik, kan jy die volgende opdrag uitvoer:
    ```bash
    dmesg | grep -i nitro
    ```

### Belangrike Punte

- Nitro instansies het verbeterde sekuriteitskenmerke.
- Nitro Enklaves is ideaal vir sensitiewe data verwerking.
- Kennis van Nitro se werking kan help om sekuriteitsgapings te identifiseer.

### Gevolgtrekking

Die begrip van AWS Nitro en die vermo√´ om relevante inligting te versamel, is noodsaaklik vir effektiewe pentesting in 'n AWS-omgewing.
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

Die hulpmiddel vsock-proxy laat toe om 'n vsock-proxy met 'n ander adres te proxy, byvoorbeeld:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
Dit sal die **lokale poort 8001 in vsock** stuur na `ip-ranges.amazonaws.com:443` en die l√™er **`your-vsock-proxy.yaml`** mag hierdie inhoud h√™ wat toegang tot `ip-ranges.amazonaws.com:443` toelaat:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
Dit is moontlik om die vsock-adresse (**`<CID>:<Port>`**) wat deur die EC2-gasheer gebruik word, te sien met (let op die `3:8001`, 3 is die CID en 8001 die poort):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Nitro Enclave Atestasie & KMS

Die Nitro Enclaves SDK laat 'n enclave toe om 'n **kriptografies ondertekende atestasiedokument** van die Nitro **Hypervisor** aan te vra, wat **unieke metings** spesifiek aan daardie enclave insluit. Hierdie metings, wat **hashes en platformkonfigurasie registers (PCRs)** insluit, word tydens die atestasieproses gebruik om **die enclave se identiteit te bewys** en **vertroue met eksterne dienste te bou**. Die atestasiedokument bevat tipies waardes soos PCR0, PCR1, en PCR2, wat jy voorheen te√´gekom het wanneer jy 'n enclave EIF bou en stoor.

Van die [**dokumentasie**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves), hier is die PCR waardes:

<table><thead><tr><th width="97">PCR</th><th width="221">Hash van ...</th><th>Beskrywing</th></tr></thead><tbody><tr><td>PCR0</td><td>Enclave beeldl√™er</td><td>'n Aaneenlopende meting van die inhoud van die beeldl√™er, sonder die seksiedata.</td></tr><tr><td>PCR1</td><td>Linux kernel en bootstrap</td><td>'n Aaneenlopende meting van die kernel en boot ramfs data.</td></tr><tr><td>PCR2</td><td>Aansoek</td><td>'n Aaneenlopende, in-volgorde meting van die gebruikersaansoeke, sonder die boot ramfs.</td></tr><tr><td>PCR3</td><td>IAM rol toegeken aan die ouer instansie</td><td>'n Aaneenlopende meting van die IAM rol toegeken aan die ouer instansie. Verseker dat die atestasieproses slegs slaag wanneer die ouer instansie die korrekte IAM rol het.</td></tr><tr><td>PCR4</td><td>Instansie ID van die ouer instansie</td><td>'n Aaneenlopende meting van die ID van die ouer instansie. Verseker dat die atestasieproses slegs slaag wanneer die ouer instansie 'n spesifieke instansie ID het.</td></tr><tr><td>PCR8</td><td>Enclave beeldl√™er ondertekeningssertifikaat</td><td>'n Meting van die ondertekeningssertifikaat gespesifiseer vir die enclave beeldl√™er. Verseker dat die atestasieproses slegs slaag wanneer die enclave vanaf 'n enclave beeldl√™er wat deur 'n spesifieke sertifikaat onderteken is, geboot is.</td></tr></tbody></table>

Jy kan **kriptografiese atestasie** in jou toepassings integreer en voorafgeboude integrasies met dienste soos **AWS KMS** benut. AWS KMS kan **enclave atestasies valideer** en bied atestasie-gebaseerde kondisie sleutels (`kms:RecipientAttestation:ImageSha384` en `kms:RecipientAttestation:PCR`) in sy sleutelsbeleide. Hierdie beleide verseker dat AWS KMS slegs operasies met die KMS sleutel toelaat **as die enclave se atestasiedokument geldig is** en aan die **gespesifiseerde voorwaardes** voldoen.

{% hint style="success" %}
Let daarop dat Enclaves in debug (--debug) modus atestasiedokumente genereer met PCRs wat uit nulle bestaan (`000000000000000000000000000000000000000000000000`). Daarom sal KMS beleide wat hierdie waardes nagaan, misluk.
{% endhint %}

### PCR Omseiling

Van 'n aanvaller se perspektief, let op dat sommige PCRs toelaat om sommige dele of die hele enclave beeld te verander en steeds geldig te wees (byvoorbeeld PCR4 kyk net na die ID van die ouer instansie, so om enige enclave beeld in daardie EC2 te laat loop, sal toelaat om aan hierdie potensi√´le PCR vereiste te voldoen).

Daarom, 'n aanvaller wat die EC2 instansie kompromitteer, mag in staat wees om ander enclave beelde te laat loop om hierdie beskermings te omseil.

Die navorsing oor hoe om nuwe beelde te verander/skep om elke beskerming te omseil (veral die nie so voor die hand liggende nie) is nog TE DOEN.

## Verwysings

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* Al die dele van die Nitro tutoriaal van AWS: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
