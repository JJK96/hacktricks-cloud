# AWS - Nitro Enum

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## Temel Bilgiler

AWS Nitro, AWS EC2 instance'larının temel platformunu oluşturan **yenilikçi teknolojiler** dizisidir. Amazon tarafından **güvenliği, performansı ve güvenilirliği artırmak** amacıyla tanıtılmıştır. Nitro, özel **donanım bileşenleri ve hafif bir hypervisor** kullanır. Geleneksel sanallaştırma işlevselliğinin çoğunu özel donanım ve yazılıma soyutlayarak, **saldırı yüzeyini en aza indirir** ve kaynak verimliliğini artırır. Sanallaştırma işlevlerini devrederek, Nitro EC2 instance'larının **neredeyse çıplak metal performansı** sunmasını sağlar, bu da özellikle kaynak yoğun uygulamalar için faydalıdır. Ayrıca, Nitro Güvenlik Çipi, **donanım ve yazılımın güvenliğini** özel olarak sağlar ve sağlam mimarisini daha da pekiştirir.

### Nitro Enclaves

**AWS Nitro Enclaves**, Amazon EC2 instance'ları içinde güvenli, **izole bir hesaplama ortamı** sağlar ve özellikle son derece hassas verilerin işlenmesi için tasarlanmıştır. AWS Nitro Sistemi'ni kullanarak, bu enclaves'ler güçlü **izolasyon ve güvenlik** sağlar, **PII veya finansal kayıtlar** gibi gizli bilgilerin işlenmesi için idealdir. Minimalist bir ortam sunarak, veri sızıntısı riskini önemli ölçüde azaltır. Ayrıca, Nitro Enclaves kriptografik doğrulama destekler, kullanıcıların yalnızca yetkili kodun çalıştığını doğrulamasına olanak tanır, bu da sıkı uyumluluk ve veri koruma standartlarını sürdürmek için önemlidir.

{% hint style="danger" %}
Nitro Enclave görüntüleri **EC2 instance'larının içinden çalıştırılır** ve AWS web konsolundan bir EC2 instance'ının Nitro Enclave'de görüntü çalıştırıp çalıştırmadığını göremezsiniz.
{% endhint %}

## Nitro Enclave CLI kurulumu

Tüm talimatları [**belgeden**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave) takip edin. Ancak, en önemli olanlar şunlardır:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave Images

Nitro Enclave'de çalıştırabileceğiniz görüntüler docker görüntülerine dayanmaktadır, bu nedenle Nitro Enclave görüntülerinizi aşağıdaki gibi docker görüntülerinden oluşturabilirsiniz:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Gördüğünüz gibi Nitro Enclave görüntüleri **`eif`** (Enclave Image File) uzantısını kullanır.

Çıktı şu şekilde görünecektir:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Bir Görüntü Çalıştırın

[**Dokümana**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave) göre, bir enclave görüntüsü çalıştırmak için ona **`eif` dosyasının boyutunun en az 4 katı kadar bellek** atamanız gerekir. Ona verilecek varsayılan kaynakları dosyada yapılandırmak mümkündür.
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
Her zaman **ana EC2** instance'ı için de bazı kaynakları ayırmanız gerektiğini unutmayın!
{% endhint %}

Bir imaja verilecek kaynakları bilip, yapılandırma dosyasını bile değiştirdikten sonra bir enclave imajını çalıştırmak mümkündür:

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Enclaves'i Numaralandırma

Bir EC2 ana bilgisayarını ele geçirirseniz, çalışan enclave görüntülerinin bir listesini şu şekilde alabilirsiniz:
```bash
nitro-cli describe-enclaves
```
İçinde çalışan bir enclave imajına **shell almak mümkün değildir** çünkü bu enclave'in ana amacıdır, ancak, **`--debug-mode`** parametresini kullandıysanız, bunun **stdout** çıktısını şu şekilde almak mümkündür:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Enclaves Sonlandırma

Bir saldırgan varsayılan olarak bir EC2 instance'ını ele geçirirse, içinde bir shell elde edemeyecektir, ancak onları **sonlandırabilir**:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsocks

Bir **enclave** çalıştıran görüntü ile iletişim kurmanın tek yolu **vsocks** kullanmaktır.

**Virtual Socket (vsock)**, sanal makineler (**VM'ler**) ile **hypervisor'ları** veya VM'ler **arasında** iletişimi kolaylaştırmak için özel olarak tasarlanmış bir Linux soket ailesidir. Vsock, ana bilgisayarın ağ yığınına güvenmeden verimli, **çift yönlü iletişim** sağlar. Bu, ağ yapılandırmaları olmadan bile VM'lerin iletişim kurmasını mümkün kılar, **bağlantıları tanımlamak ve yönetmek için 32-bit Context ID (CID) ve port numaraları** kullanır. Vsock API, TCP ve UDP'ye benzer şekilde hem akış hem de datagram soket türlerini destekler, sanal ortamlarda kullanıcı düzeyindeki uygulamalar için çok yönlü bir araç sunar.

{% hint style="success" %}
Bu nedenle, bir vsock adresi şu şekilde görünür: `<CID>:<Port>`
{% endhint %}

Çalışan görüntülerin **CID'lerini** bulmak için aşağıdaki komutu çalıştırabilir ve **`EnclaveCID`**'yi alabilirsiniz:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
Ana bilgisayardan bir CID'nin herhangi bir portu açıp açmadığını bilmenin bir yolu olmadığını unutmayın! Ancak, [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner) gibi bir **vsock port tarayıcı** kullanarak öğrenebilirsiniz.
{% endhint %}

### Vsock Server/Listener

Burada birkaç örnek bulabilirsiniz:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Basit Python Listener</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock Client

Örnekler:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>Basit Python Client</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

Vsock-proxy aracı, bir vsock proxy'sini başka bir adresle proxy'lemeye olanak tanır, örneğin:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
Bu, **yerel port 8001'i vsock** içinde `ip-ranges.amazonaws.com:443` adresine yönlendirecek ve **`your-vsock-proxy.yaml`** dosyası, `ip-ranges.amazonaws.com:443` adresine erişime izin veren şu içeriğe sahip olabilir:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
EC2 ana bilgisayarı tarafından kullanılan vsock adreslerini (**`<CID>:<Port>`**) görmek mümkündür (not: `3:8001`, 3 CID ve 8001 port):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Nitro Enclave Doğrulama & KMS

Nitro Enclaves SDK, bir enclave'in Nitro **Hypervisor**'dan **kriptografik olarak imzalanmış bir doğrulama belgesi** talep etmesine olanak tanır. Bu belge, o enclave'e özgü **benzersiz ölçümleri** içerir. Bu ölçümler, **hashler ve platform yapılandırma kayıtlarını (PCR'ler)** içerir ve doğrulama sürecinde **enclave'in kimliğini kanıtlamak** ve **dış hizmetlerle güven oluşturmak** için kullanılır. Doğrulama belgesi genellikle PCR0, PCR1 ve PCR2 gibi değerleri içerir; bu değerlerle bir enclave EIF oluştururken ve kaydederken karşılaşmış olabilirsiniz.

[**Belgelerden**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves) alınan PCR değerleri şunlardır:

<table><thead><tr><th width="97">PCR</th><th width="221">Hash of ...</th><th>Description</th></tr></thead><tbody><tr><td>PCR0</td><td>Enclave image file</td><td>Görüntü dosyasının içeriğinin kesintisiz bir ölçümü, bölüm verisi olmadan.</td></tr><tr><td>PCR1</td><td>Linux kernel and bootstrap</td><td>Çekirdek ve boot ramfs verilerinin kesintisiz bir ölçümü.</td></tr><tr><td>PCR2</td><td>Application</td><td>Kullanıcı uygulamalarının kesintisiz, sıralı bir ölçümü, boot ramfs olmadan.</td></tr><tr><td>PCR3</td><td>IAM role assigned to the parent instance</td><td>Parent instance'a atanan IAM rolünün kesintisiz bir ölçümü. Doğrulama sürecinin yalnızca parent instance doğru IAM rolüne sahip olduğunda başarılı olmasını sağlar.</td></tr><tr><td>PCR4</td><td>Instance ID of the parent instance</td><td>Parent instance'ın ID'sinin kesintisiz bir ölçümü. Doğrulama sürecinin yalnızca parent instance belirli bir instance ID'ye sahip olduğunda başarılı olmasını sağlar.</td></tr><tr><td>PCR8</td><td>Enclave image file signing certificate</td><td>Enclave image file için belirtilen imzalama sertifikasının bir ölçümü. Doğrulama sürecinin yalnızca enclave belirli bir sertifika ile imzalanmış bir enclave image file'dan başlatıldığında başarılı olmasını sağlar.</td></tr></tbody></table>

**Kriptografik doğrulamayı** uygulamalarınıza entegre edebilir ve **AWS KMS** gibi hizmetlerle önceden oluşturulmuş entegrasyonlardan yararlanabilirsiniz. AWS KMS, **enclave doğrulamalarını doğrulayabilir** ve anahtar politikalarında (`kms:RecipientAttestation:ImageSha384` ve `kms:RecipientAttestation:PCR`) doğrulamaya dayalı koşul anahtarları sunar. Bu politikalar, AWS KMS'nin KMS anahtarını kullanarak işlemleri **yalnızca enclave'in doğrulama belgesi geçerli ve belirtilen koşulları karşıladığında** izin vermesini sağlar.

{% hint style="success" %}
Debug (--debug) modundaki Enclaves, PCR'leri sıfırlardan (`000000000000000000000000000000000000000000000000`) oluşan doğrulama belgeleri oluşturur. Bu nedenle, bu değerleri kontrol eden KMS politikaları başarısız olacaktır.
{% endhint %}

### PCR Atlatma

Bir saldırganın bakış açısından, bazı PCR'lerin bazı bölümleri veya tüm enclave image'ını değiştirmeye izin vereceğini ve yine de geçerli olacağını fark edin (örneğin, PCR4 sadece parent instance'ın ID'sini kontrol eder, bu nedenle herhangi bir enclave image'ını o EC2'de çalıştırmak bu potansiyel PCR gereksinimini karşılayacaktır).

Bu nedenle, EC2 instance'ını ele geçiren bir saldırgan, bu korumaları atlatmak için başka enclave image'larını çalıştırabilir.

Her korumayı atlatmak için yeni image'ları nasıl değiştireceğinizi/oluşturacağınızı araştırmak (özellikle bariz olmayanları) hala YAPILACAK.

## Referanslar

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* AWS'den Nitro eğitiminin tüm bölümleri: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) bizi takip edin.
* **HackTricks** ve **HackTricks Cloud** github depolarına PR göndererek hacking ipuçlarını paylaşın.

</details>
{% endhint %}
