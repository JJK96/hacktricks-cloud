# AWS - Nitro Enum

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Βασικές Πληροφορίες

Το AWS Nitro είναι μια σουίτα από **καινοτόμες τεχνολογίες** που αποτελούν την υποκείμενη πλατφόρμα για τις EC2 instances του AWS. Εισήχθη από την Amazon για να **ενισχύσει την ασφάλεια, την απόδοση και την αξιοπιστία**, το Nitro χρησιμοποιεί προσαρμοσμένα **υλικά εξαρτήματα και έναν ελαφρύ hypervisor**. Αφαιρεί μεγάλο μέρος της παραδοσιακής λειτουργικότητας εικονικοποίησης σε ειδικό υλικό και λογισμικό, **ελαχιστοποιώντας την επιφάνεια επίθεσης** και βελτιώνοντας την αποδοτικότητα των πόρων. Με την εκφόρτωση των λειτουργιών εικονικοποίησης, το Nitro επιτρέπει στις EC2 instances να παρέχουν **σχεδόν απόδοση γυμνού μετάλλου**, καθιστώντας το ιδιαίτερα επωφελές για εφαρμογές που απαιτούν πολλούς πόρους. Επιπλέον, το Nitro Security Chip διασφαλίζει ειδικά την **ασφάλεια του υλικού και του firmware**, ενισχύοντας περαιτέρω την ισχυρή αρχιτεκτονική του.

### Nitro Enclaves

Το **AWS Nitro Enclaves** παρέχει ένα ασφαλές, **απομονωμένο περιβάλλον υπολογισμού εντός των Amazon EC2 instances**, ειδικά σχεδιασμένο για την επεξεργασία εξαιρετικά ευαίσθητων δεδομένων. Χρησιμοποιώντας το AWS Nitro System, αυτά τα enclaves διασφαλίζουν ισχυρή **απομόνωση και ασφάλεια**, ιδανικά για **χειρισμό εμπιστευτικών πληροφοριών** όπως PII ή οικονομικά αρχεία. Διαθέτουν ένα μινιμαλιστικό περιβάλλον, μειώνοντας σημαντικά τον κίνδυνο διαρροής δεδομένων. Επιπλέον, τα Nitro Enclaves υποστηρίζουν κρυπτογραφική πιστοποίηση, επιτρέποντας στους χρήστες να επαληθεύουν ότι εκτελείται μόνο εξουσιοδοτημένος κώδικας, κρίσιμο για τη διατήρηση αυστηρών προτύπων συμμόρφωσης και προστασίας δεδομένων.

{% hint style="danger" %}
Οι εικόνες Nitro Enclave **εκτελούνται από μέσα στις EC2 instances** και δεν μπορείτε να δείτε από την κονσόλα web του AWS αν μια EC2 instance εκτελεί εικόνες σε Nitro Enclave ή όχι.
{% endhint %}

## Εγκατάσταση Nitro Enclave CLI

Ακολουθήστε όλες τις οδηγίες [**από την τεκμηρίωση**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave). Ωστόσο, αυτές είναι οι πιο σημαντικές:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave Images

Οι εικόνες που μπορείτε να εκτελέσετε στο Nitro Enclave βασίζονται σε εικόνες docker, οπότε μπορείτε να δημιουργήσετε τις εικόνες Nitro Enclave από εικόνες docker όπως:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Όπως μπορείτε να δείτε, οι εικόνες Nitro Enclave χρησιμοποιούν την επέκταση **`eif`** (Enclave Image File).

Η έξοδος θα μοιάζει με:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Εκτέλεση μιας Εικόνας

Σύμφωνα με [**την τεκμηρίωση**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave), για να εκτελέσετε μια εικόνα enclave πρέπει να της εκχωρήσετε μνήμη **τουλάχιστον 4 φορές το μέγεθος του αρχείου `eif`**. Είναι δυνατόν να διαμορφώσετε τους προεπιλεγμένους πόρους που θα της δοθούν στο αρχείο
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
Πάντα να θυμάστε ότι πρέπει να **κρατήσετε κάποιους πόρους για το γονικό EC2** instance επίσης!
{% endhint %}

Αφού γνωρίζετε τους πόρους που θα δώσετε σε μια εικόνα και έχοντας τροποποιήσει το αρχείο ρυθμίσεων, είναι δυνατό να εκτελέσετε μια εικόνα enclave με:

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Καταμέτρηση Enclaves

Εάν παραβιάσετε έναν EC2 host, είναι δυνατό να λάβετε μια λίστα με τις τρέχουσες εικόνες enclave με:
```bash
nitro-cli describe-enclaves
```
Είναι **αδύνατο να αποκτήσετε ένα shell** μέσα σε μια τρέχουσα εικόνα enclave γιατί αυτός είναι ο κύριος σκοπός του enclave, ωστόσο, αν χρησιμοποιήσετε την παράμετρο **`--debug-mode`**, είναι δυνατό να αποκτήσετε το **stdout** του με:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Terminate Enclaves

Αν ένας επιτιθέμενος παραβιάσει ένα EC2 instance από προεπιλογή δεν θα μπορέσει να αποκτήσει ένα shell μέσα σε αυτά, αλλά θα μπορέσει να τα **τερματίσει** με:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsocks

Ο μόνος τρόπος επικοινωνίας με μια εικόνα που εκτελείται σε **enclave** είναι χρησιμοποιώντας **vsocks**.

**Virtual Socket (vsock)** είναι μια οικογένεια socket στο Linux που έχει σχεδιαστεί ειδικά για να διευκολύνει την **επικοινωνία** μεταξύ εικονικών μηχανών (**VMs**) και των **hypervisors** τους, ή μεταξύ των ίδιων των VMs. Το Vsock επιτρέπει αποδοτική, **αμφίδρομη επικοινωνία** χωρίς να βασίζεται στο δίκτυο του host. Αυτό καθιστά δυνατή την επικοινωνία των VMs ακόμη και χωρίς ρυθμίσεις δικτύου, **χρησιμοποιώντας ένα 32-bit Context ID (CID) και αριθμούς θυρών** για την αναγνώριση και διαχείριση των συνδέσεων. Το vsock API υποστηρίζει τόσο τύπους socket ροής όσο και datagram, παρόμοια με τα TCP και UDP, παρέχοντας ένα ευέλικτο εργαλείο για εφαρμογές επιπέδου χρήστη σε εικονικά περιβάλλοντα.

{% hint style="success" %}
Επομένως, μια διεύθυνση vsock μοιάζει με αυτή: `<CID>:<Port>`
{% endhint %}

Για να βρείτε τα **CIDs** των εικόνων που εκτελούνται σε enclave, μπορείτε απλά να εκτελέσετε την ακόλουθη εντολή και να πάρετε το **`EnclaveCID`**:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
Σημειώστε ότι από τον host δεν υπάρχει τρόπος να γνωρίζετε αν ένα CID εκθέτει οποιαδήποτε θύρα! Εκτός αν χρησιμοποιήσετε κάποιο **vsock port scanner όπως** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner).
{% endhint %}

### Vsock Server/Listener

Βρείτε εδώ μερικά παραδείγματα:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Απλός Python Listener</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock Client

Παραδείγματα:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>Απλός Python Client</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

Το εργαλείο vsock-proxy επιτρέπει την προώθηση ενός vsock proxy με άλλη διεύθυνση, για παράδειγμα:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
Αυτό θα προωθήσει την **τοπική θύρα 8001 στο vsock** στο `ip-ranges.amazonaws.com:443` και το αρχείο **`your-vsock-proxy.yaml`** μπορεί να έχει αυτό το περιεχόμενο επιτρέποντας την πρόσβαση στο `ip-ranges.amazonaws.com:443`:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
Είναι δυνατό να δείτε τις διευθύνσεις vsock (**`<CID>:<Port>`**) που χρησιμοποιούνται από τον EC2 host με (σημειώστε το `3:8001`, 3 είναι το CID και 8001 το port):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Nitro Enclave Atestation & KMS

Το Nitro Enclaves SDK επιτρέπει σε ένα enclave να ζητήσει ένα **κρυπτογραφικά υπογεγραμμένο έγγραφο πιστοποίησης** από το Nitro **Hypervisor**, το οποίο περιλαμβάνει **μοναδικές μετρήσεις** συγκεκριμένες για αυτό το enclave. Αυτές οι μετρήσεις, που περιλαμβάνουν **hashes και platform configuration registers (PCRs)**, χρησιμοποιούνται κατά τη διαδικασία πιστοποίησης για να **αποδείξουν την ταυτότητα του enclave** και να **δημιουργήσουν εμπιστοσύνη με εξωτερικές υπηρεσίες**. Το έγγραφο πιστοποίησης συνήθως περιέχει τιμές όπως PCR0, PCR1 και PCR2, τις οποίες έχετε συναντήσει προηγουμένως κατά την κατασκευή και αποθήκευση ενός enclave EIF.

Από τα [**docs**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves), αυτές είναι οι τιμές PCR:

<table><thead><tr><th width="97">PCR</th><th width="221">Hash of ...</th><th>Description</th></tr></thead><tbody><tr><td>PCR0</td><td>Enclave image file</td><td>A contiguous measure of the contents of the image file, without the section data.</td></tr><tr><td>PCR1</td><td>Linux kernel and bootstrap</td><td>A contiguous measurement of the kernel and boot ramfs data.</td></tr><tr><td>PCR2</td><td>Application</td><td>A contiguous, in-order measurement of the user applications, without the boot ramfs.</td></tr><tr><td>PCR3</td><td>IAM role assigned to the parent instance</td><td>A contiguous measurement of the IAM role assigned to the parent instance. Ensures that the attestation process succeeds only when the parent instance has the correct IAM role.</td></tr><tr><td>PCR4</td><td>Instance ID of the parent instance</td><td>A contiguous measurement of the ID of the parent instance. Ensures that the attestation process succeeds only when the parent instance has a specific instance ID.</td></tr><tr><td>PCR8</td><td>Enclave image file signing certificate</td><td>A measure of the signing certificate specified for the enclave image file. Ensures that the attestation process succeeds only when the enclave was booted from an enclave image file signed by a specific certificate.</td></tr></tbody></table>

Μπορείτε να ενσωματώσετε την **κρυπτογραφική πιστοποίηση** στις εφαρμογές σας και να αξιοποιήσετε τις προ-ενσωματωμένες ενσωματώσεις με υπηρεσίες όπως το **AWS KMS**. Το AWS KMS μπορεί να **επαληθεύσει τις πιστοποιήσεις των enclaves** και προσφέρει κλειδιά συνθηκών βασισμένα στην πιστοποίηση (`kms:RecipientAttestation:ImageSha384` και `kms:RecipientAttestation:PCR`) στις πολιτικές κλειδιών του. Αυτές οι πολιτικές διασφαλίζουν ότι το AWS KMS επιτρέπει λειτουργίες χρησιμοποιώντας το κλειδί KMS **μόνο εάν το έγγραφο πιστοποίησης του enclave είναι έγκυρο** και πληροί τις **καθορισμένες συνθήκες**.

{% hint style="success" %}
Σημειώστε ότι τα Enclaves σε λειτουργία debug (--debug) δημιουργούν έγγραφα πιστοποίησης με PCRs που αποτελούνται από μηδενικά (`000000000000000000000000000000000000000000000000`). Επομένως, οι πολιτικές KMS που ελέγχουν αυτές τις τιμές θα αποτύχουν.
{% endhint %}

### PCR Bypass

Από την προοπτική ενός επιτιθέμενου, παρατηρήστε ότι ορισμένα PCRs θα επέτρεπαν την τροποποίηση ορισμένων μερών ή ολόκληρου του αρχείου εικόνας του enclave και θα εξακολουθούσαν να είναι έγκυρα (για παράδειγμα, το PCR4 ελέγχει μόνο το ID του γονικού instance, οπότε η εκτέλεση οποιουδήποτε αρχείου εικόνας enclave σε αυτό το EC2 θα επιτρέψει την εκπλήρωση αυτής της πιθανής απαίτησης PCR).

Επομένως, ένας επιτιθέμενος που θα παραβιάσει το EC2 instance μπορεί να είναι σε θέση να εκτελέσει άλλες εικόνες enclave για να παρακάμψει αυτές τις προστασίες.

Η έρευνα για το πώς να τροποποιήσετε/δημιουργήσετε νέες εικόνες για να παρακάμψετε κάθε προστασία (ειδικά τις όχι τόσο προφανείς) είναι ακόμα σε εξέλιξη.

## References

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* Όλα τα μέρη του Nitro tutorial από το AWS: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Ελέγξτε τα [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
