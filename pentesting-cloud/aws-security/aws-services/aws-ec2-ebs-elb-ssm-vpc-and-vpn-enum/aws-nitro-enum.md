# AWS - Nitro Enum

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

AWS Nitro √© um conjunto de **tecnologias inovadoras** que formam a plataforma subjacente para inst√¢ncias AWS EC2. Introduzido pela Amazon para **aumentar a seguran√ßa, desempenho e confiabilidade**, Nitro utiliza componentes de **hardware personalizados e um hipervisor leve**. Ele abstrai grande parte da funcionalidade de virtualiza√ß√£o tradicional para hardware e software dedicados, **minimizando a superf√≠cie de ataque** e melhorando a efici√™ncia dos recursos. Ao descarregar fun√ß√µes de virtualiza√ß√£o, Nitro permite que as inst√¢ncias EC2 ofere√ßam **desempenho pr√≥ximo ao bare-metal**, sendo particularmente ben√©fico para aplica√ß√µes que exigem muitos recursos. Al√©m disso, o Nitro Security Chip garante especificamente a **seguran√ßa do hardware e firmware**, solidificando ainda mais sua arquitetura robusta.

### Nitro Enclaves

**AWS Nitro Enclaves** fornece um ambiente de computa√ß√£o seguro e **isolado dentro das inst√¢ncias Amazon EC2**, projetado especificamente para processar dados altamente sens√≠veis. Aproveitando o AWS Nitro System, esses enclaves garantem **isolamento e seguran√ßa robustos**, ideais para **manipular informa√ß√µes confidenciais** como PII ou registros financeiros. Eles apresentam um ambiente minimalista, reduzindo significativamente o risco de exposi√ß√£o de dados. Al√©m disso, Nitro Enclaves suporta atesta√ß√£o criptogr√°fica, permitindo que os usu√°rios verifiquem que apenas c√≥digo autorizado est√° em execu√ß√£o, crucial para manter padr√µes rigorosos de conformidade e prote√ß√£o de dados.

{% hint style="danger" %}
Imagens Nitro Enclave s√£o **executadas de dentro das inst√¢ncias EC2** e voc√™ n√£o pode ver pelo console web da AWS se uma inst√¢ncia EC2 est√° executando imagens no Nitro Enclave ou n√£o.
{% endhint %}

## Instala√ß√£o do Nitro Enclave CLI

Siga todas as instru√ß√µes [**da documenta√ß√£o**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave). No entanto, estas s√£o as mais importantes:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave Images

As imagens que voc√™ pode executar no Nitro Enclave s√£o baseadas em imagens docker, ent√£o voc√™ pode criar suas imagens Nitro Enclave a partir de imagens docker como:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Como voc√™ pode ver, as imagens Nitro Enclave usam a extens√£o **`eif`** (Enclave Image File).

A sa√≠da ser√° semelhante a:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Executar uma Imagem

Conforme [**a documenta√ß√£o**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave), para executar uma imagem de enclave, voc√™ precisa atribuir a ela uma mem√≥ria de **pelo menos 4 vezes o tamanho do arquivo `eif`**. √â poss√≠vel configurar os recursos padr√£o a serem atribu√≠dos no arquivo&#x20;
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
Sempre lembre-se de que voc√™ precisa **reservar alguns recursos para a inst√¢ncia EC2** principal tamb√©m!
{% endhint %}

Depois de conhecer os recursos a serem atribu√≠dos a uma imagem e at√© mesmo ter modificado o arquivo de configura√ß√£o, √© poss√≠vel executar uma imagem enclave com:

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Enumerar Enclaves

Se voc√™ comprometer um host EC2, √© poss√≠vel obter uma lista de imagens de enclave em execu√ß√£o com:
```bash
nitro-cli describe-enclaves
```
√â **imposs√≠vel obter um shell** dentro de uma imagem de enclave em execu√ß√£o porque esse √© o principal prop√≥sito do enclave, no entanto, se voc√™ usar o par√¢metro **`--debug-mode`**, √© poss√≠vel obter o **stdout** com:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Terminate Enclaves

Se um atacante comprometer uma inst√¢ncia EC2, por padr√£o ele n√£o conseguir√° obter um shell dentro dela, mas ele poder√° **termin√°-la** com:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsocks

A √∫nica maneira de se comunicar com uma **enclave** em execu√ß√£o √© usando **vsocks**.

**Virtual Socket (vsock)** √© uma fam√≠lia de sockets no Linux especificamente projetada para facilitar a **comunica√ß√£o** entre m√°quinas virtuais (**VMs**) e seus **hipervisores**, ou entre as pr√≥prias VMs. Vsock permite uma comunica√ß√£o eficiente e **bidirecional** sem depender da pilha de rede do host. Isso possibilita que as VMs se comuniquem mesmo sem configura√ß√µes de rede, **usando um ID de Contexto (CID) de 32 bits e n√∫meros de porta** para identificar e gerenciar conex√µes. A API vsock suporta tipos de socket de fluxo e datagrama, semelhantes ao TCP e UDP, fornecendo uma ferramenta vers√°til para aplica√ß√µes em n√≠vel de usu√°rio em ambientes virtuais.

{% hint style="success" %}
Portanto, um endere√ßo vsock se parece com isto: `<CID>:<Port>`
{% endhint %}

Para encontrar os **CIDs** das imagens em execu√ß√£o no enclave, voc√™ pode simplesmente executar o seguinte comando e obter o **`EnclaveCID`**:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
Note que, a partir do host, n√£o h√° nenhuma maneira de saber se um CID est√° expondo alguma porta! A menos que use algum **scanner de porta vsock como** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner).
{% endhint %}

### Vsock Server/Listener

Encontre aqui alguns exemplos:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Listener Simples em Python</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
```markdown
</details>
```
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock Client

Exemplos:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>Cliente Python Simples</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
```markdown
# Enumera√ß√£o do AWS Nitro

A enumera√ß√£o do AWS Nitro envolve a coleta de informa√ß√µes sobre a infraestrutura subjacente do Nitro System da AWS. O Nitro System √© uma cole√ß√£o de componentes de hardware e software que fornecem isolamento de recursos, seguran√ßa e desempenho para inst√¢ncias EC2.

## Passos para Enumera√ß√£o

1. **Identificar Inst√¢ncias Nitro**: Verifique se as inst√¢ncias EC2 est√£o usando o Nitro System. Isso pode ser feito inspecionando os tipos de inst√¢ncia e suas caracter√≠sticas.

2. **Coletar Metadados**: Utilize a URL de metadados da inst√¢ncia para coletar informa√ß√µes detalhadas sobre a inst√¢ncia Nitro. Isso pode incluir detalhes como o ID da inst√¢ncia, tipo de inst√¢ncia, e outras configura√ß√µes espec√≠ficas.

3. **Verificar Logs do Nitro**: Analise os logs do Nitro para identificar poss√≠veis vulnerabilidades ou configura√ß√µes incorretas. Os logs podem fornecer insights sobre o comportamento e a seguran√ßa da inst√¢ncia.

4. **Explorar Recursos Nitro**: Investigue os recursos espec√≠ficos do Nitro, como o Nitro Enclaves e o Nitro Hypervisor, para entender melhor como eles est√£o configurados e se h√° poss√≠veis pontos de explora√ß√£o.

## Ferramentas √öteis

- **AWS CLI**: A AWS Command Line Interface pode ser usada para interagir com a API da AWS e coletar informa√ß√µes sobre as inst√¢ncias Nitro.
- **EC2 Instance Metadata Service**: Um servi√ßo que fornece metadados sobre a inst√¢ncia EC2, √∫til para a enumera√ß√£o de inst√¢ncias Nitro.
- **CloudTrail**: Um servi√ßo que registra todas as chamadas de API feitas na sua conta AWS, √∫til para auditoria e monitoramento.

## Considera√ß√µes de Seguran√ßa

- **Isolamento de Recursos**: O Nitro System oferece isolamento de recursos, o que pode dificultar a explora√ß√£o de vulnerabilidades. Certifique-se de entender como esse isolamento funciona.
- **Atualiza√ß√µes de Seguran√ßa**: Mantenha as inst√¢ncias Nitro atualizadas com os patches de seguran√ßa mais recentes para minimizar o risco de explora√ß√£o.
- **Monitoramento Cont√≠nuo**: Implemente monitoramento cont√≠nuo para detectar atividades suspeitas ou an√¥malas nas inst√¢ncias Nitro.

A enumera√ß√£o eficaz do AWS Nitro pode ajudar a identificar potenciais vulnerabilidades e melhorar a postura de seguran√ßa da sua infraestrutura na nuvem.
```
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

A ferramenta vsock-proxy permite fazer proxy de um vsock proxy com outro endere√ßo, por exemplo:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
Isso ir√° encaminhar a **porta local 8001 em vsock** para `ip-ranges.amazonaws.com:443` e o arquivo **`your-vsock-proxy.yaml`** pode ter este conte√∫do permitindo acessar `ip-ranges.amazonaws.com:443`:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
√â poss√≠vel ver os endere√ßos vsock (**`<CID>:<Port>`**) usados pelo host EC2 com (note o `3:8001`, 3 √© o CID e 8001 a porta):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Nitro Enclave Atesta√ß√£o & KMS

O SDK do Nitro Enclaves permite que um enclave solicite um **documento de atesta√ß√£o criptograficamente assinado** do **Hypervisor** Nitro, que inclui **medi√ß√µes √∫nicas** espec√≠ficas para aquele enclave. Essas medi√ß√µes, que incluem **hashes e registros de configura√ß√£o da plataforma (PCRs)**, s√£o usadas durante o processo de atesta√ß√£o para **provar a identidade do enclave** e **construir confian√ßa com servi√ßos externos**. O documento de atesta√ß√£o normalmente cont√©m valores como PCR0, PCR1 e PCR2, que voc√™ j√° encontrou antes ao construir e salvar um EIF de enclave.

Dos [**docs**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves), estes s√£o os valores PCR:

<table><thead><tr><th width="97">PCR</th><th width="221">Hash de ...</th><th>Descri√ß√£o</th></tr></thead><tbody><tr><td>PCR0</td><td>Arquivo de imagem do enclave</td><td>Uma medida cont√≠gua do conte√∫do do arquivo de imagem, sem os dados da se√ß√£o.</td></tr><tr><td>PCR1</td><td>Kernel Linux e bootstrap</td><td>Uma medida cont√≠gua do kernel e dos dados do boot ramfs.</td></tr><tr><td>PCR2</td><td>Aplica√ß√£o</td><td>Uma medida cont√≠gua e em ordem das aplica√ß√µes do usu√°rio, sem o boot ramfs.</td></tr><tr><td>PCR3</td><td>Fun√ß√£o IAM atribu√≠da √† inst√¢ncia pai</td><td>Uma medida cont√≠gua da fun√ß√£o IAM atribu√≠da √† inst√¢ncia pai. Garante que o processo de atesta√ß√£o seja bem-sucedido apenas quando a inst√¢ncia pai tiver a fun√ß√£o IAM correta.</td></tr><tr><td>PCR4</td><td>ID da inst√¢ncia pai</td><td>Uma medida cont√≠gua do ID da inst√¢ncia pai. Garante que o processo de atesta√ß√£o seja bem-sucedido apenas quando a inst√¢ncia pai tiver um ID de inst√¢ncia espec√≠fico.</td></tr><tr><td>PCR8</td><td>Certificado de assinatura do arquivo de imagem do enclave</td><td>Uma medida do certificado de assinatura especificado para o arquivo de imagem do enclave. Garante que o processo de atesta√ß√£o seja bem-sucedido apenas quando o enclave foi inicializado a partir de um arquivo de imagem do enclave assinado por um certificado espec√≠fico.</td></tr></tbody></table>

Voc√™ pode integrar a **atesta√ß√£o criptogr√°fica** em suas aplica√ß√µes e aproveitar integra√ß√µes pr√©-constru√≠das com servi√ßos como **AWS KMS**. O AWS KMS pode **validar atesta√ß√µes de enclave** e oferece chaves de condi√ß√£o baseadas em atesta√ß√£o (`kms:RecipientAttestation:ImageSha384` e `kms:RecipientAttestation:PCR`) em suas pol√≠ticas de chave. Essas pol√≠ticas garantem que o AWS KMS permita opera√ß√µes usando a chave KMS **apenas se o documento de atesta√ß√£o do enclave for v√°lido** e atender √†s **condi√ß√µes especificadas**.

{% hint style="success" %}
Note que Enclaves em modo debug (--debug) geram documentos de atesta√ß√£o com PCRs que s√£o compostos por zeros (`000000000000000000000000000000000000000000000000`). Portanto, pol√≠ticas do KMS que verificam esses valores falhar√£o.
{% endhint %}

### Bypass de PCR

Do ponto de vista de um atacante, observe que alguns PCRs permitiriam modificar algumas partes ou toda a imagem do enclave e ainda seriam v√°lidos (por exemplo, PCR4 apenas verifica o ID da inst√¢ncia pai, ent√£o executar qualquer imagem de enclave naquela EC2 permitir√° cumprir esse requisito potencial de PCR).

Portanto, um atacante que comprometer a inst√¢ncia EC2 pode ser capaz de executar outras imagens de enclave para contornar essas prote√ß√µes.

A pesquisa sobre como modificar/criar novas imagens para contornar cada prote√ß√£o (especialmente as n√£o t√£o √≥bvias) ainda est√° PENDENTE.

## Refer√™ncias

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* Todas as partes do tutorial Nitro da AWS: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
