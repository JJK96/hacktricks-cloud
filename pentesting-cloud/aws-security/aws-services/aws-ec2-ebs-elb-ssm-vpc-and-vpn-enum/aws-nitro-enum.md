# AWS - Nitro Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## 基本情報

AWS Nitroは、AWS EC2インスタンスの基盤となる**革新的な技術**のスイートです。Amazonによって導入され、**セキュリティ、パフォーマンス、および信頼性を向上**させるために、Nitroはカスタム**ハードウェアコンポーネントと軽量ハイパーバイザー**を活用しています。従来の仮想化機能の多くを専用のハードウェアとソフトウェアに抽象化し、**攻撃面を最小化**し、リソース効率を向上させます。仮想化機能をオフロードすることで、NitroはEC2インスタンスが**ほぼベアメタルのパフォーマンス**を提供できるようにし、特にリソース集約型アプリケーションに有益です。さらに、Nitro Security Chipは**ハードウェアとファームウェアのセキュリティ**を確保し、その堅牢なアーキテクチャをさらに強化します。

### Nitro Enclaves

**AWS Nitro Enclaves**は、Amazon EC2インスタンス内で**高度に機密性の高いデータを処理するために設計された**、安全で**隔離されたコンピュート環境**を提供します。AWS Nitro Systemを活用することで、これらのエンクレーブは強力な**隔離とセキュリティ**を確保し、**PIIや財務記録などの機密情報**を扱うのに理想的です。ミニマリスト環境を特徴とし、データ漏洩のリスクを大幅に低減します。さらに、Nitro Enclavesは暗号化認証をサポートしており、ユーザーが許可されたコードのみが実行されていることを確認できるため、厳格なコンプライアンスとデータ保護基準を維持するのに重要です。

{% hint style="danger" %}
Nitro Enclaveイメージは**EC2インスタンス内から実行**され、AWSウェブコンソールからEC2インスタンスがNitro Enclaveでイメージを実行しているかどうかを確認することはできません。
{% endhint %}

## Nitro Enclave CLIのインストール

[**ドキュメント**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave)のすべての指示に従ってください。ただし、以下が最も重要なものです:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave Images

Nitro Enclaveで実行できるイメージはdockerイメージに基づいているため、次のようなdockerイメージからNitro Enclaveイメージを作成できます:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Nitro Enclaveイメージは**`eif`**（Enclave Image File）拡張子を使用していることがわかります。

出力は次のようになります:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Run an Image

[**ドキュメント**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave)によると、enclaveイメージを実行するには、**`eif`ファイルのサイズの少なくとも4倍のメモリ**を割り当てる必要があります。デフォルトのリソースをファイルで設定することが可能です。
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
常に**親EC2インスタンスのためにいくつかのリソースを予約する**必要があることを忘れないでください！
{% endhint %}

イメージに与えるリソースを知り、設定ファイルを変更した後でも、enclaveイメージを実行することが可能です：

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Enclavesの列挙

EC2ホストを侵害した場合、次のコマンドで実行中のenclaveイメージのリストを取得することができます:
```bash
nitro-cli describe-enclaves
```
実行中のenclaveイメージ内でシェルを取得することは**できません**。これはenclaveの主な目的だからです。しかし、パラメータ**`--debug-mode`**を使用した場合、次のコマンドで**stdout**を取得することが可能です:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Terminate Enclaves

攻撃者がEC2インスタンスをデフォルトで侵害した場合、内部にシェルを取得することはできませんが、次のコマンドで**terminate**することは可能です:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsocks

**enclave** 実行イメージと通信する唯一の方法は **vsocks** を使用することです。

**Virtual Socket (vsock)** は、仮想マシン (**VMs**) とその **ハイパーバイザー**、または VMs 同士の間の **通信** を容易にするために特別に設計された Linux のソケットファミリーです。Vsock はホストのネットワーキングスタックに依存せずに効率的な **双方向通信** を可能にします。これにより、ネットワーク設定がなくても VMs が通信できるようになり、接続を識別および管理するために **32ビットの Context ID (CID) とポート番号** を使用します。Vsock API は、TCP と UDP に似たストリームおよびデータグラムソケットタイプの両方をサポートし、仮想環境でのユーザーレベルのアプリケーションに対して多用途のツールを提供します。

{% hint style="success" %}
したがって、vsock アドレスは次のようになります: `<CID>:<Port>`
{% endhint %}

実行中の **enclave** イメージの **CIDs** を見つけるには、次のコマンドを実行して **`EnclaveCID`** を取得します:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
ホストからは、CID がポートを公開しているかどうかを知る方法はありません！ **vsock port scanner** のようなツールを使用しない限り、[**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner) を使用してください。
{% endhint %}

### Vsock Server/Listener

いくつかの例を以下に示します:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Simple Python Listener</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock Client

例:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>シンプルなPythonクライアント</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
```markdown
</details>
```
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

vsock-proxyツールは、別のアドレスでvsockプロキシをプロキシすることができます。例えば:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
これは**vsockのローカルポート8001**を`ip-ranges.amazonaws.com:443`に転送し、ファイル**`your-vsock-proxy.yaml`**には`ip-ranges.amazonaws.com:443`にアクセスするための以下の内容が含まれているかもしれません:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
EC2ホストで使用されているvsockアドレス（**`<CID>:<Port>`**）を確認することが可能です（`3:8001`に注目、3はCID、8001はポート）：

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Nitro Enclave Atestation & KMS

Nitro Enclaves SDKは、エンクレーブがNitro **Hypervisor**から**暗号署名された認証ドキュメント**を要求することを可能にします。このドキュメントには、そのエンクレーブに特有の**ユニークな測定値**が含まれています。これらの測定値には、**ハッシュやプラットフォーム構成レジスタ（PCR）**が含まれ、認証プロセス中に**エンクレーブのアイデンティティを証明**し、**外部サービスとの信頼を構築**するために使用されます。認証ドキュメントには通常、PCR0、PCR1、PCR2などの値が含まれており、エンクレーブEIFを構築および保存する際にこれらの値に遭遇します。

[**docs**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves)から、これらはPCRの値です：

<table><thead><tr><th width="97">PCR</th><th width="221">ハッシュの対象</th><th>説明</th></tr></thead><tbody><tr><td>PCR0</td><td>エンクレーブイメージファイル</td><td>セクションデータを除いたイメージファイルの内容の連続的な測定。</td></tr><tr><td>PCR1</td><td>Linuxカーネルとブートストラップ</td><td>カーネルとブートramfsデータの連続的な測定。</td></tr><tr><td>PCR2</td><td>アプリケーション</td><td>ブートramfsを除いたユーザーアプリケーションの連続的かつ順序通りの測定。</td></tr><tr><td>PCR3</td><td>親インスタンスに割り当てられたIAMロール</td><td>親インスタンスに割り当てられたIAMロールの連続的な測定。親インスタンスが正しいIAMロールを持っている場合にのみ認証プロセスが成功することを保証します。</td></tr><tr><td>PCR4</td><td>親インスタンスのインスタンスID</td><td>親インスタンスのIDの連続的な測定。親インスタンスが特定のインスタンスIDを持っている場合にのみ認証プロセスが成功することを保証します。</td></tr><tr><td>PCR8</td><td>エンクレーブイメージファイル署名証明書</td><td>エンクレーブイメージファイルに指定された署名証明書の測定。特定の証明書で署名されたエンクレーブイメージファイルからブートされた場合にのみ認証プロセスが成功することを保証します。</td></tr></tbody></table>

**暗号認証**をアプリケーションに統合し、**AWS KMS**などのサービスとの事前構築された統合を活用できます。AWS KMSは**エンクレーブ認証を検証**し、キーのポリシーにおいて認証ベースの条件キー（`kms:RecipientAttestation:ImageSha384`および`kms:RecipientAttestation:PCR`）を提供します。これらのポリシーは、エンクレーブの認証ドキュメントが有効であり、**指定された条件を満たす場合にのみ**、AWS KMSがKMSキーを使用した操作を許可することを保証します。

{% hint style="success" %}
デバッグモード（--debug）のエンクレーブは、PCRがゼロ（`000000000000000000000000000000000000000000000000`）で構成された認証ドキュメントを生成することに注意してください。したがって、これらの値をチェックするKMSポリシーは失敗します。
{% endhint %}

### PCR Bypass

攻撃者の視点から見ると、いくつかのPCRはエンクレーブイメージの一部または全体を変更しても有効であることがわかります（例えば、PCR4は親インスタンスのIDのみをチェックするため、そのEC2で任意のエンクレーブイメージを実行することでこのPCR要件を満たすことができます）。

したがって、EC2インスタンスを侵害した攻撃者は、これらの保護を回避するために他のエンクレーブイメージを実行できる可能性があります。

各保護を回避するための新しいイメージの変更/作成方法に関する研究（特に明らかでないもの）はまだTODOです。

## References

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* AWSのNitroチュートリアルのすべての部分：[https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

{% hint style="success" %}
AWS Hackingを学び、練習する：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingを学び、練習する：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローしてください。
* **ハッキングトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出してください。

</details>
{% endhint %}
