# AWS - Nitro Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

AWS Nitro рдПрдХ **рдирд╡реАрдирддрдо рддрдХрдиреАрдХреЛрдВ** рдХрд╛ рд╕рдореВрд╣ рд╣реИ рдЬреЛ AWS EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рд▓рд┐рдП рдЖрдзрд╛рд░рднреВрдд рдкреНрд▓реЗрдЯрдлрд╛рд░реНрдо рдмрдирд╛рддрд╛ рд╣реИред Amazon рджреНрд╡рд╛рд░рд╛ **рд╕реБрд░рдХреНрд╖рд╛, рдкреНрд░рджрд░реНрд╢рди, рдФрд░ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдпрддрд╛** рдХреЛ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдкреЗрд╢ рдХрд┐рдпрд╛ рдЧрдпрд╛, Nitro рдХрд╕реНрдЯрдо **рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдШрдЯрдХреЛрдВ рдФрд░ рдПрдХ рд╣рд▓реНрдХреЗ рд╣рд╛рдЗрдкрд░рд╡рд╛рдЗрдЬрд░** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред рдпрд╣ рдкрд╛рд░рдВрдкрд░рд┐рдХ рд╡рд░реНрдЪреБрдЕрд▓рд╛рдЗрдЬреЗрд╢рди рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЛ рд╕рдорд░реНрдкрд┐рдд рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдФрд░ рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рдореЗрдВ рд╕рд╛рд░рдЧрд░реНрднрд┐рдд рдХрд░рддрд╛ рд╣реИ, **рд╣рдорд▓реЗ рдХреА рд╕рддрд╣ рдХреЛ рдХрдо рдХрд░рддрд╛ рд╣реИ** рдФрд░ рд╕рдВрд╕рд╛рдзрди рджрдХреНрд╖рддрд╛ рдореЗрдВ рд╕реБрдзрд╛рд░ рдХрд░рддрд╛ рд╣реИред рд╡рд░реНрдЪреБрдЕрд▓рд╛рдЗрдЬреЗрд╢рди рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдСрдлрд▓реЛрдб рдХрд░рдХреЗ, Nitro EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ **рд▓рдЧрднрдЧ рдмрд░реЗ-рдореЗрдЯрд▓ рдкреНрд░рджрд░реНрд╢рди** рджреЗрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬреЛ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд╕рдВрд╕рд╛рдзрди-рдЧрд╣рди рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рд▓рд╛рднрдХрд╛рд░реА рд╣реИред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, Nitro рд╕реБрд░рдХреНрд╖рд╛ рдЪрд┐рдк рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ **рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдФрд░ рдлрд░реНрдорд╡реЗрдпрд░ рдХреА рд╕реБрд░рдХреНрд╖рд╛** рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЗрд╕рдХреА рдордЬрдмреВрдд рд╕рдВрд░рдЪрдирд╛ рдФрд░ рднреА рдордЬрдмреВрдд рд╣реЛ рдЬрд╛рддреА рд╣реИред

### Nitro Enclaves

**AWS Nitro Enclaves** рдПрдХ рд╕реБрд░рдХреНрд╖рд┐рдд, **рдЕрд▓рдЧ рдХрдВрдкреНрдпреВрдЯ рд╡рд╛рддрд╛рд╡рд░рдг** рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдЬреЛ Amazon EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рднреАрддрд░ рд╣реЛрддрд╛ рд╣реИ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЕрддреНрдпрдзрд┐рдХ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдбреЗрдЯрд╛ рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред AWS Nitro рд╕рд┐рд╕реНрдЯрдо рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП, рдпреЗ enclaves рдордЬрдмреВрдд **рдЕрд▓рдЧрд╛рд╡ рдФрд░ рд╕реБрд░рдХреНрд╖рд╛** рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рдЬреЛ **рдЧреЛрдкрдиреАрдп рдЬрд╛рдирдХрд╛рд░реА** рдЬреИрд╕реЗ PII рдпрд╛ рд╡рд┐рддреНрддреАрдп рд░рд┐рдХреЙрд░реНрдб рдХреЛ рд╕рдВрднрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрджрд░реНрд╢ рд╣реИрдВред рд╡реЗ рдПрдХ рдиреНрдпреВрдирддрдо рд╡рд╛рддрд╛рд╡рд░рдг рдХреА рд╕реБрд╡рд┐рдзрд╛ рджреЗрддреЗ рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ рдбреЗрдЯрд╛ рдПрдХреНрд╕рдкреЛрдЬрд░ рдХрд╛ рдЬреЛрдЦрд┐рдо рдХрд╛рдлреА рдХрдо рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, Nitro Enclaves рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлрд┐рдХ рдПрдЯреЗрд╕реНрдЯреЗрд╢рди рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреЗ рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдпрд╣ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреЗрд╡рд▓ рдЕрдзрд┐рдХреГрдд рдХреЛрдб рд╣реА рдЪрд▓ рд░рд╣рд╛ рд╣реИ, рдЬреЛ рд╕рдЦреНрдд рдЕрдиреБрдкрд╛рд▓рди рдФрд░ рдбреЗрдЯрд╛ рд╕реБрд░рдХреНрд╖рд╛ рдорд╛рдирдХреЛрдВ рдХреЛ рдмрдирд╛рдП рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред

{% hint style="danger" %}
Nitro Enclave рдЫрд╡рд┐рдпрд╛рдБ **EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдЕрдВрджрд░ рд╕реЗ рдЪрд▓рддреА рд╣реИрдВ** рдФрд░ рдЖрдк AWS рд╡реЗрдм рдХрдВрд╕реЛрд▓ рд╕реЗ рдирд╣реАрдВ рджреЗрдЦ рд╕рдХрддреЗ рдХрд┐ рдХреЛрдИ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ Nitro Enclave рдореЗрдВ рдЫрд╡рд┐рдпрд╛рдБ рдЪрд▓рд╛ рд░рд╣рд╛ рд╣реИ рдпрд╛ рдирд╣реАрдВред
{% endhint %}

## Nitro Enclave CLI installation

рд╕рднреА рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ [**рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рд╕реЗ**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave)ред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпреЗ рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИрдВ:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave Images

Nitro Enclave рдореЗрдВ рдЪрд▓рдиреЗ рд╡рд╛рд▓реА images docker images рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реЛрддреА рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдЖрдк docker images рд╕реЗ рдЕрдкрдиреА Nitro Enclave images рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреИрд╕реЗ:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, Nitro Enclave рдЗрдореЗрдЬреЗрдЬрд╝ **`eif`** (Enclave Image File) рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреА рд╣реИрдВред

рдЖрдЙрдЯрдкреБрдЯ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рджрд┐рдЦреЗрдЧрд╛:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### рдПрдХ рдЗрдореЗрдЬ рдЪрд▓рд╛рдПрдВ

[**рджрд╕реНрддрд╛рд╡реЗрдЬрд╝**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave) рдХреЗ рдЕрдиреБрд╕рд╛рд░, рдПрдХ enclave рдЗрдореЗрдЬ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдЗрд╕реЗ **`eif` рдлрд╛рдЗрд▓ рдХреЗ рдЖрдХрд╛рд░ рдХрд╛ рдХрдо рд╕реЗ рдХрдо 4 рдЧреБрдирд╛ рдореЗрдореЛрд░реА** рдЕрд╕рд╛рдЗрди рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред рдЗрд╕реЗ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ рдлрд╛рдЗрд▓ рдореЗрдВ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
рд╣рдореЗрд╢рд╛ рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ рдЖрдкрдХреЛ **рдореВрд▓ EC2** instance рдХреЗ рд▓рд┐рдП рднреА рдХреБрдЫ рд╕рдВрд╕рд╛рдзрди рдЖрд░рдХреНрд╖рд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ!
{% endhint %}

рдПрдХ image рдХреЛ рд╕рдВрд╕рд╛рдзрди рджреЗрдиреЗ рдХреЗ рдмрд╛рдж рдФрд░ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рднреА, рдПрдХ enclave image рдХреЛ рдЪрд▓рд╛рдирд╛ рд╕рдВрднрд╡ рд╣реИ:

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Enclaves рдХреА рд╕реВрдЪреА рдмрдирд╛рдПрдВ

рдпрджрд┐ рдЖрдк рдПрдХ EC2 рд╣реЛрд╕реНрдЯ рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЪрд▓ рд░рд╣реЗ enclave images рдХреА рд╕реВрдЪреА рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ:
```bash
nitro-cli describe-enclaves
```
рдпрд╣ **рд╕рдВрднрд╡ рдирд╣реАрдВ рд╣реИ рдХрд┐ рдПрдХ рдЪрд▓ рд░рд╣реЗ enclave image рдХреЗ рдЕрдВрджрд░ рдПрдХ shell рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛рдП** рдХреНрдпреЛрдВрдХрд┐ рдпрд╣реА enclave рдХрд╛ рдореБрдЦреНрдп рдЙрджреНрджреЗрд╢реНрдп рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ рдЖрдкрдиреЗ рдкреИрд░рд╛рдореАрдЯрд░ **`--debug-mode`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рд╣реИ, рддреЛ рдЗрд╕рдХрд╛ **stdout** рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Enclaves рд╕рдорд╛рдкреНрдд рдХрд░реЗрдВ

рдпрджрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдПрдХ EC2 instance рд╕реЗ рд╕рдордЭреМрддрд╛ рдХрд░рддрд╛ рд╣реИ, рддреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд╡рд╣ рдЙрдирдХреЗ рдЕрдВрджрд░ рдПрдХ рд╢реЗрд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рд╣реЛрдЧрд╛, рд▓реЗрдХрд┐рди рд╡рд╣ рдЙрдиреНрд╣реЗрдВ **рд╕рдорд╛рдкреНрдд** рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsocks

**Enclave** рдЪрд▓рд╛рдиреЗ рд╡рд╛рд▓реА рдЗрдореЗрдЬ рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд░рдиреЗ рдХрд╛ рдПрдХрдорд╛рддреНрд░ рддрд░реАрдХрд╛ **vsocks** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реИред

**Virtual Socket (vsock)** Linux рдореЗрдВ рдПрдХ рд╕реЙрдХреЗрдЯ рдлреИрдорд┐рд▓реА рд╣реИ рдЬрд┐рд╕реЗ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд╡рд░реНрдЪреБрдЕрд▓ рдорд╢реАрдиреЛрдВ (**VMs**) рдФрд░ рдЙрдирдХреЗ **рд╣рд╛рдЗрдкрд░рд╡рд╛рдЗрдЬрд░** рдХреЗ рдмреАрдЪ рдпрд╛ VMs рдХреЗ **рдЖрдкрд╕ рдореЗрдВ** рд╕рдВрд╡рд╛рдж рдХреЛ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред Vsock рд╣реЛрд╕реНрдЯ рдХреЗ рдиреЗрдЯрд╡рд░реНрдХрд┐рдВрдЧ рд╕реНрдЯреИрдХ рдкрд░ рдирд┐рд░реНрднрд░ рд╣реБрдП рдмрд┐рдирд╛ рдХреБрд╢рд▓, **рджреНрд╡рд┐рджрд┐рд╢ рд╕рдВрдЪрд╛рд░** рдХреЛ рд╕рдХреНрд╖рдо рдмрдирд╛рддрд╛ рд╣реИред рдпрд╣ VMs рдХреЛ рдиреЗрдЯрд╡рд░реНрдХ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рдмрд┐рдирд╛ рднреА рд╕рдВрд╡рд╛рдж рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, **рдХрдиреЗрдХреНрд╢рдиреЛрдВ рдХреА рдкрд╣рдЪрд╛рди рдФрд░ рдкреНрд░рдмрдВрдзрди рдХреЗ рд▓рд┐рдП 32-рдмрд┐рдЯ Context ID (CID) рдФрд░ рдкреЛрд░реНрдЯ рдирдВрдмрд░реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рддрд╛ рд╣реИред vsock API рд╕реНрдЯреНрд░реАрдо рдФрд░ рдбреЗрдЯрд╛рдЧреНрд░рд╛рдо рд╕реЙрдХреЗрдЯ рдкреНрд░рдХрд╛рд░реЛрдВ рджреЛрдиреЛрдВ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ, TCP рдФрд░ UDP рдХреЗ рд╕рдорд╛рди, рдЬреЛ рд╡рд░реНрдЪреБрдЕрд▓ рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛-рд╕реНрддрд░реАрдп рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рдмрд╣реБрдореБрдЦреА рдЙрдкрдХрд░рдг рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред

{% hint style="success" %}
рдЗрд╕рд▓рд┐рдП, рдПрдХ vsock рдкрддрд╛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рджрд┐рдЦрддрд╛ рд╣реИ: `<CID>:<Port>`
{% endhint %}

**Enclave** рдЪрд▓рд╛рдиреЗ рд╡рд╛рд▓реА рдЗрдореЗрдЬ рдХреЗ **CIDs** рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд cmd рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **`EnclaveCID`** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╣реЛрд╕реНрдЯ рд╕реЗ рдпрд╣ рдЬрд╛рдирдиреЗ рдХрд╛ рдХреЛрдИ рддрд░реАрдХрд╛ рдирд╣реАрдВ рд╣реИ рдХрд┐ рдХреЛрдИ CID рдХреЛрдИ рдкреЛрд░реНрдЯ рдПрдХреНрд╕рдкреЛрдЬрд╝ рдХрд░ рд░рд╣рд╛ рд╣реИ рдпрд╛ рдирд╣реАрдВ! рдЬрдм рддрдХ рдХрд┐ рдХрд┐рд╕реА **vsock рдкреЛрд░реНрдЯ рд╕реНрдХреИрдирд░ рдЬреИрд╕реЗ** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner) рдХрд╛ рдЙрдкрдпреЛрдЧ рди рдХрд░реЗрдВред
{% endhint %}

### Vsock Server/Listener

рдпрд╣рд╛рдВ рдХреБрдЫ рдЙрджрд╛рд╣рд░рдг рджреЗрдЦреЗрдВ:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Simple Python Listener</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock Client

рдЙрджрд╛рд╣рд░рдг:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>рд╕рд░рд▓ Python Client</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

рдЯреВрд▓ vsock-proxy рдПрдХ vsock proxy рдХреЛ рджреВрд╕рд░реЗ рдкрддреЗ рдХреЗ рд╕рд╛рде рдкреНрд░реЙрдХреНрд╕реА рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
рдпрд╣ **local port 8001 in vsock** рдХреЛ `ip-ranges.amazonaws.com:443` рдкрд░ рдлреЙрд░рд╡рд░реНрдб рдХрд░реЗрдЧрд╛ рдФрд░ рдлрд╛рдЗрд▓ **`your-vsock-proxy.yaml`** рдореЗрдВ рдпрд╣ рд╕рд╛рдордЧреНрд░реА рд╣реЛ рд╕рдХрддреА рд╣реИ рдЬрд┐рд╕рд╕реЗ `ip-ranges.amazonaws.com:443` рддрдХ рдкрд╣реБрдВрдЪрд╛ рдЬрд╛ рд╕рдХреЗ:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
EC2 рд╣реЛрд╕реНрдЯ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЧрдП vsock рдкрддреЗ (**`<CID>:<Port>`**) рдХреЛ рджреЗрдЦрдирд╛ рд╕рдВрднрд╡ рд╣реИ (рдзреНрдпрд╛рди рджреЗрдВ `3:8001`, 3 CID рд╣реИ рдФрд░ 8001 рдкреЛрд░реНрдЯ рд╣реИ):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Nitro Enclave Atestation & KMS

Nitro Enclaves SDK рдПрдХ enclave рдХреЛ Nitro **Hypervisor** рд╕реЗ рдПрдХ **cryptographically signed attestation document** рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдЙрд╕ enclave рдХреЗ рд▓рд┐рдП **unique measurements** рд╢рд╛рдорд┐рд▓ рд╣реЛрддреЗ рд╣реИрдВред рдпреЗ measurements, рдЬрд┐рдирдореЗрдВ **hashes рдФрд░ platform configuration registers (PCRs)** рд╢рд╛рдорд┐рд▓ рд╣реИрдВ, attestation рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рджреМрд░рд╛рди **enclave рдХреА рдкрд╣рдЪрд╛рди рд╕рд╛рдмрд┐рдд рдХрд░рдиреЗ** рдФрд░ **рдмрд╛рд╣рд░реА рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рд╕рд╛рде рд╡рд┐рд╢реНрд╡рд╛рд╕ рдмрдирд╛рдиреЗ** рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред Attestation document рдореЗрдВ рдЖрдорддреМрд░ рдкрд░ PCR0, PCR1, рдФрд░ PCR2 рдЬреИрд╕реЗ рдорд╛рди рд╣реЛрддреЗ рд╣реИрдВ, рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдкрдиреЗ рдкрд╣рд▓реЗ рдПрдХ enclave EIF рдмрдирд╛рддреЗ рдФрд░ рд╕рд╣реЗрдЬрддреЗ рд╕рдордп рджреЗрдЦрд╛ рд╣реЛрдЧрд╛ред

[**docs**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves) рд╕реЗ, рдпреЗ рд╣реИрдВ PCR рдорд╛рди:

<table><thead><tr><th width="97">PCR</th><th width="221">Hash of ...</th><th>Description</th></tr></thead><tbody><tr><td>PCR0</td><td>Enclave image file</td><td>Image file рдХреА рд╕рд╛рдордЧреНрд░реА рдХрд╛ рдПрдХ рдирд┐рд░рдВрддрд░ рдорд╛рдк, рдмрд┐рдирд╛ section data рдХреЗред</td></tr><tr><td>PCR1</td><td>Linux kernel рдФрд░ bootstrap</td><td>Kernel рдФрд░ boot ramfs data рдХрд╛ рдПрдХ рдирд┐рд░рдВрддрд░ рдорд╛рдкред</td></tr><tr><td>PCR2</td><td>Application</td><td>User applications рдХрд╛ рдПрдХ рдирд┐рд░рдВрддрд░, рдХреНрд░рдордмрджреНрдз рдорд╛рдк, рдмрд┐рдирд╛ boot ramfs рдХреЗред</td></tr><tr><td>PCR3</td><td>Parent instance рдХреЛ рд╕реМрдВрдкрд╛ рдЧрдпрд╛ IAM role</td><td>Parent instance рдХреЛ рд╕реМрдВрдкреЗ рдЧрдП IAM role рдХрд╛ рдПрдХ рдирд┐рд░рдВрддрд░ рдорд╛рдкред рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ attestation рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗрд╡рд▓ рддрднреА рд╕рдлрд▓ рд╣реЛ рдЬрдм parent instance рдХреЗ рдкрд╛рд╕ рд╕рд╣реА IAM role рд╣реЛред</td></tr><tr><td>PCR4</td><td>Parent instance рдХрд╛ Instance ID</td><td>Parent instance рдХреЗ ID рдХрд╛ рдПрдХ рдирд┐рд░рдВрддрд░ рдорд╛рдкред рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ attestation рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗрд╡рд▓ рддрднреА рд╕рдлрд▓ рд╣реЛ рдЬрдм parent instance рдХрд╛ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ instance ID рд╣реЛред</td></tr><tr><td>PCR8</td><td>Enclave image file signing certificate</td><td>Enclave image file рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрджрд┐рд╖реНрдЯ signing certificate рдХрд╛ рдПрдХ рдорд╛рдкред рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ attestation рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗрд╡рд▓ рддрднреА рд╕рдлрд▓ рд╣реЛ рдЬрдм enclave рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ certificate рджреНрд╡рд╛рд░рд╛ signed enclave image file рд╕реЗ рдмреВрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛред</td></tr></tbody></table>

рдЖрдк рдЕрдкрдиреЗ applications рдореЗрдВ **cryptographic attestation** рдХреЛ рдПрдХреАрдХреГрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **AWS KMS** рдЬреИрд╕реА рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рд╕рд╛рде pre-built integrations рдХрд╛ рд▓рд╛рдн рдЙрдард╛ рд╕рдХрддреЗ рд╣реИрдВред AWS KMS **enclave attestations** рдХреЛ validate рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЕрдкрдиреА key policies рдореЗрдВ attestation-based condition keys (`kms:RecipientAttestation:ImageSha384` рдФрд░ `kms:RecipientAttestation:PCR`) рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред рдпреЗ policies рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреА рд╣реИрдВ рдХрд┐ AWS KMS рдХреЗрд╡рд▓ рддрднреА KMS key рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ **рдЬрдм enclave рдХрд╛ attestation document рдорд╛рдиреНрдп рд╣реЛ** рдФрд░ **рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╢рд░реНрддреЛрдВ** рдХреЛ рдкреВрд░рд╛ рдХрд░рддрд╛ рд╣реЛред

{% hint style="success" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ debug (--debug) рдореЛрдб рдореЗрдВ Enclaves рдРрд╕реЗ attestation documents рдЙрддреНрдкрдиреНрди рдХрд░рддреЗ рд╣реИрдВ рдЬрд┐рдирдХреЗ PCR рд╢реВрдиреНрдп (`000000000000000000000000000000000000000000000000`) рд╕реЗ рдмрдиреЗ рд╣реЛрддреЗ рд╣реИрдВред рдЗрд╕рд▓рд┐рдП, рдЗрди рдорд╛рдиреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рд╡рд╛рд▓реА KMS policies рд╡рд┐рдлрд▓ рд╣реЛ рдЬрд╛рдПрдВрдЧреАред
{% endhint %}

### PCR Bypass

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдХреБрдЫ PCRs рдХреБрдЫ рд╣рд┐рд╕реНрд╕реЛрдВ рдпрд╛ рдкреВрд░реЗ enclave image рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдВрдЧреЗ рдФрд░ рдлрд┐рд░ рднреА рдорд╛рдиреНрдп рд╣реЛрдВрдЧреЗ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП PCR4 рдХреЗрд╡рд▓ parent instance рдХреЗ ID рдХреА рдЬрд╛рдВрдЪ рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЙрд╕ EC2 рдореЗрдВ рдХреЛрдИ рднреА enclave image рдЪрд▓рд╛рдирд╛ рдЗрд╕ рд╕рдВрднрд╛рд╡рд┐рдд PCR рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЛ рдкреВрд░рд╛ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛)ред

рдЗрд╕рд▓рд┐рдП, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЬреЛ EC2 instance рд╕реЗ рд╕рдордЭреМрддрд╛ рдХрд░рддрд╛ рд╣реИ, рдЕрдиреНрдп enclave images рдЪрд▓рд╛рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдЗрди рд╕реБрд░рдХреНрд╖рд╛ рдЙрдкрд╛рдпреЛрдВ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

рдкреНрд░рддреНрдпреЗрдХ рд╕реБрд░рдХреНрд╖рд╛ рдЙрдкрд╛рдп рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирдП images рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд/рдмрдирд╛рдиреЗ рдкрд░ рд╢реЛрдз (рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЬреЛ рд╕реНрдкрд╖реНрдЯ рдирд╣реАрдВ рд╣реИрдВ) рдЕрднреА рднреА TODO рд╣реИред

## References

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* AWS рд╕реЗ Nitro tutorial рдХреЗ рд╕рднреА рднрд╛рдЧ: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

{% hint style="success" %}
AWS Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХреЛ рд╕рдорд░реНрдерди рджреЗрдВ</summary>

* [**subscription plans**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рд╣рдореЗрдВ **Twitter** ЁЯРж рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>
{% endhint %}
