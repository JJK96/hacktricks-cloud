# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository github.

</details>
{% endhint %}

## VPC & Networking

Scopri cos'√® un VPC e i suoi componenti in:

{% content-ref url="aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2 √® utilizzato per avviare **server virtuali**. Consente la configurazione della **sicurezza** e della **rete** e la gestione dello **storage**. La flessibilit√† di Amazon EC2 √® evidente nella sua capacit√† di scalare le risorse sia verso l'alto che verso il basso, adattandosi efficacemente ai cambiamenti delle esigenze o agli aumenti di popolarit√†. Questa caratteristica riduce la necessit√† di previsioni precise del traffico.

Cose interessanti da enumerare in EC2:

* Macchine Virtuali
* Chiavi SSH
* Dati Utente
* EC2/AMIs/Snapshot esistenti
* Networking
* Reti
* Sottoreti
* IP Pubblici
* Porte aperte
* Connessioni integrate con altre reti al di fuori di AWS

### Instance Profiles

Utilizzare i **ruoli** per concedere permessi alle applicazioni che girano su **istanze EC2** richiede una configurazione aggiuntiva. Un'applicazione che gira su un'istanza EC2 √® astratta da AWS dal sistema operativo virtualizzato. A causa di questa separazione aggiuntiva, √® necessario un passaggio aggiuntivo per assegnare un ruolo AWS e i relativi permessi a un'istanza EC2 e renderli disponibili alle sue applicazioni.

Questo passaggio aggiuntivo √® la **creazione di un** [_**instance profile**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html) collegato all'istanza. Il **instance profile contiene il ruolo e** pu√≤ fornire le credenziali temporanee del ruolo a un'applicazione che gira sull'istanza. Queste credenziali temporanee possono quindi essere utilizzate nelle chiamate API dell'applicazione per accedere alle risorse e limitare l'accesso solo a quelle risorse specificate dal ruolo. Nota che **solo un ruolo pu√≤ essere assegnato a un'istanza EC2** alla volta, e tutte le applicazioni sull'istanza condividono lo stesso ruolo e permessi.

### Metadata Endpoint

I metadati di AWS EC2 sono informazioni su un'istanza Amazon Elastic Compute Cloud (EC2) disponibili all'istanza in fase di runtime. Questi metadati sono utilizzati per fornire informazioni sull'istanza, come il suo ID, la zona di disponibilit√† in cui √® in esecuzione, il ruolo IAM associato all'istanza e il nome host dell'istanza.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Enumeration
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Accesso Non Autenticato

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Privesc

Nella seguente pagina puoi vedere come **abusare dei permessi EC2 per scalare i privilegi**:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Post-Exploitation

{% content-ref url="../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Gli **EBS** (Elastic Block Store) **snapshots** di Amazon sono fondamentalmente **backup** statici dei volumi EBS di AWS. In altre parole, sono **copie** dei **dischi** collegati a un'istanza **EC2** in un momento specifico. Gli snapshot EBS possono essere copiati tra regioni e account, o persino scaricati ed eseguiti localmente.

Gli snapshot possono contenere **informazioni sensibili** come **codice sorgente o chiavi API**, quindi, se ne hai la possibilit√†, √® consigliato controllarli.

### Differenza AMI & EBS

Un'**AMI** viene utilizzata per **avviare un'istanza EC2**, mentre uno **Snapshot** EC2 viene utilizzato per **eseguire il backup e il recupero dei dati memorizzati su un volume EBS**. Sebbene uno Snapshot EC2 possa essere utilizzato per creare una nuova AMI, non √® la stessa cosa di un'AMI e non include informazioni sul sistema operativo, server applicativo o altro software necessario per eseguire un'applicazione.

### Privesc

Nella seguente pagina puoi vedere come **abusare dei permessi EBS per scalare i privilegi**:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** consente di gestire da remoto flotte di istanze EC2 per rendere la loro amministrazione molto pi√π semplice. Ciascuna di queste istanze deve eseguire il **servizio SSM Agent poich√© sar√† il servizio a ricevere le azioni e ad eseguirle** dall'API AWS.

**SSM Agent** rende possibile per Systems Manager aggiornare, gestire e configurare queste risorse. L'agente **elabora le richieste dal servizio Systems Manager nel cloud AWS**, e poi le esegue come specificato nella richiesta.

L'**SSM Agent viene**[ **preinstallato in alcune AMI**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) oppure √® necessario [**installarlo manualmente**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) sulle istanze. Inoltre, il ruolo IAM utilizzato all'interno dell'istanza deve avere la policy **AmazonEC2RoleforSSM** allegata per poter comunicare.

### Enumerazione
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Puoi verificare se Systems Manager √® in esecuzione in un'istanza EC2 semplicemente eseguendo:
```bash
ps aux | grep amazon-ssm
```
### Privesc

Nella seguente pagina puoi vedere come **abusare dei permessi SSM per scalare i privilegi**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB) √® un **servizio di bilanciamento del carico per le distribuzioni Amazon Web Services** (AWS). ELB distribuisce automaticamente **il traffico delle applicazioni in entrata** e scala le risorse per soddisfare le richieste di traffico.

### Enumeration
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Launch Templates & Autoscaling Groups

### Enumerazione

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## Nitro

AWS Nitro √® una suite di **tecnologie innovative** che costituiscono la piattaforma sottostante per le istanze AWS EC2. Introdotto da Amazon per **migliorare la sicurezza, le prestazioni e l'affidabilit√†**, Nitro sfrutta **componenti hardware personalizzati e un hypervisor leggero**. Astrae gran parte della funzionalit√† di virtualizzazione tradizionale su hardware e software dedicati, **minimizzando la superficie di attacco** e migliorando l'efficienza delle risorse. Delegando le funzioni di virtualizzazione, Nitro consente alle istanze EC2 di offrire **prestazioni quasi a livello di metallo nudo**, rendendolo particolarmente vantaggioso per applicazioni ad alta intensit√† di risorse. Inoltre, il Nitro Security Chip garantisce specificamente la **sicurezza dell'hardware e del firmware**, consolidando ulteriormente la sua robusta architettura.

Ottieni maggiori informazioni e come enumerarlo da:

{% content-ref url="aws-nitro-enum.md" %}
[aws-nitro-enum.md](aws-nitro-enum.md)
{% endcontent-ref %}

## VPN

Una VPN consente di connettere la tua **rete on-premise (site-to-site VPN)** o i **laptop dei lavoratori (Client VPN)** con un **AWS VPC** in modo che i servizi possano essere accessibili senza doverli esporre a internet.

#### Componenti di base della VPN AWS

1. **Customer Gateway**:
* Un Customer Gateway √® una risorsa che crei in AWS per rappresentare il tuo lato di una connessione VPN.
* √à essenzialmente un dispositivo fisico o un'applicazione software sul tuo lato della connessione Site-to-Site VPN.
* Fornisci informazioni di routing e l'indirizzo IP pubblico del tuo dispositivo di rete (come un router o un firewall) ad AWS per creare un Customer Gateway.
* Serve come punto di riferimento per configurare la connessione VPN e non comporta costi aggiuntivi.
2. **Virtual Private Gateway**:
* Un Virtual Private Gateway (VPG) √® il concentratore VPN sul lato Amazon della connessione Site-to-Site VPN.
* √à collegato al tuo VPC e serve come obiettivo per la tua connessione VPN.
* VPG √® il punto finale lato AWS per la connessione VPN.
* Gestisce la comunicazione sicura tra il tuo VPC e la tua rete on-premises.
3. **Site-to-Site VPN Connection**:
* Una connessione Site-to-Site VPN collega la tua rete on-premises a un VPC tramite un tunnel VPN sicuro IPsec.
* Questo tipo di connessione richiede un Customer Gateway e un Virtual Private Gateway.
* √à utilizzato per una comunicazione sicura, stabile e coerente tra il tuo data center o rete e il tuo ambiente AWS.
* Tipicamente utilizzato per connessioni regolari e a lungo termine ed √® fatturato in base alla quantit√† di dati trasferiti sulla connessione.
4. **Client VPN Endpoint**:
* Un Client VPN endpoint √® una risorsa che crei in AWS per abilitare e gestire le sessioni VPN client.
* √à utilizzato per consentire ai singoli dispositivi (come laptop, smartphone, ecc.) di connettersi in modo sicuro alle risorse AWS o alla tua rete on-premises.
* Differisce dalla Site-to-Site VPN in quanto √® progettato per singoli client piuttosto che per connettere intere reti.
* Con Client VPN, ogni dispositivo client utilizza un software client VPN per stabilire una connessione sicura.

Puoi [**trovare maggiori informazioni sui vantaggi e componenti delle VPN AWS qui**](aws-vpc-and-networking-basic-information.md#vpn).

### Enumerazione
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Local Enumeration

**Local Temporary Credentials**

Quando AWS VPN Client viene utilizzato per connettersi a una VPN, l'utente di solito **accede ad AWS** per ottenere l'accesso alla VPN. Successivamente, alcune **credenziali AWS vengono create e memorizzate** localmente per stabilire la connessione VPN. Queste credenziali sono **memorizzate in** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` e contengono un **AccessKey**, un **SecretKey** e un **Token**.

Le credenziali appartengono all'utente `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO: fare ulteriori ricerche sui permessi di queste credenziali).

**opvn config files**

Se una **connessione VPN √® stata stabilita** dovresti cercare i file di configurazione **`.opvn`** nel sistema. Inoltre, un luogo dove potresti trovare le **configurazioni** √® in **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**

#### **Post Exploitaiton**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}
