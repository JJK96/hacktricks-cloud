# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## VPC & R√©seautage

Apprenez ce qu'est un VPC et ses composants dans :

{% content-ref url="aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2 est utilis√© pour lancer des **serveurs virtuels**. Il permet de configurer la **s√©curit√©** et le **r√©seautage** et de g√©rer le **stockage**. La flexibilit√© d'Amazon EC2 se manifeste par sa capacit√© √† faire √©voluer les ressources √† la hausse et √† la baisse, s'adaptant efficacement aux changements de besoins ou aux pics de popularit√©. Cette fonctionnalit√© r√©duit la n√©cessit√© de pr√©dictions pr√©cises du trafic.

Choses int√©ressantes √† √©num√©rer dans EC2 :

* Machines Virtuelles
* Cl√©s SSH
* Donn√©es Utilisateur
* EC2/AMIs/Snapshots existants
* R√©seautage
* R√©seaux
* Sous-r√©seaux
* IPs Publiques
* Ports ouverts
* Connexions int√©gr√©es avec d'autres r√©seaux en dehors d'AWS

### Profils d'Instance

Utiliser des **r√¥les** pour accorder des permissions aux applications qui s'ex√©cutent sur des **instances EC2** n√©cessite une configuration suppl√©mentaire. Une application s'ex√©cutant sur une instance EC2 est abstraite d'AWS par le syst√®me d'exploitation virtualis√©. En raison de cette s√©paration suppl√©mentaire, une √©tape suppl√©mentaire est n√©cessaire pour attribuer un r√¥le AWS et ses permissions associ√©es √† une instance EC2 et les rendre disponibles pour ses applications.

Cette √©tape suppl√©mentaire est la **cr√©ation d'un** [_**profil d'instance**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html) attach√© √† l'instance. Le **profil d'instance contient le r√¥le et** peut fournir les identifiants temporaires du r√¥le √† une application qui s'ex√©cute sur l'instance. Ces identifiants temporaires peuvent ensuite √™tre utilis√©s dans les appels API de l'application pour acc√©der aux ressources et limiter l'acc√®s uniquement √† celles sp√©cifi√©es par le r√¥le. Notez qu'**un seul r√¥le peut √™tre attribu√© √† une instance EC2** √† la fois, et toutes les applications sur l'instance partagent le m√™me r√¥le et les m√™mes permissions.

### Endpoint de M√©tadonn√©es

Les m√©tadonn√©es AWS EC2 sont des informations sur une instance Amazon Elastic Compute Cloud (EC2) disponibles pour l'instance √† l'ex√©cution. Ces m√©tadonn√©es sont utilis√©es pour fournir des informations sur l'instance, telles que son ID d'instance, la zone de disponibilit√© dans laquelle elle s'ex√©cute, le r√¥le IAM associ√© √† l'instance et le nom d'h√¥te de l'instance.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### √ânum√©ration
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Acc√®s non authentifi√©

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Privesc

Sur la page suivante, vous pouvez voir comment **abuser des permissions EC2 pour escalader les privil√®ges** :

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Post-Exploitation

{% content-ref url="../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Les **snapshots** Amazon **EBS** (Elastic Block Store) sont essentiellement des **sauvegardes** statiques des volumes AWS EBS. En d'autres termes, ce sont des **copies** des **disques** attach√©s √† une instance **EC2** √† un moment pr√©cis. Les snapshots EBS peuvent √™tre copi√©s entre r√©gions et comptes, ou m√™me t√©l√©charg√©s et ex√©cut√©s localement.

Les snapshots peuvent contenir des **informations sensibles** telles que des **codes sources ou des cl√©s API**, donc, si vous en avez l'occasion, il est recommand√© de les v√©rifier.

### Diff√©rence AMI & EBS

Une **AMI** est utilis√©e pour **lancer une instance EC2**, tandis qu'un **Snapshot** EC2 est utilis√© pour **sauvegarder et r√©cup√©rer les donn√©es stock√©es sur un volume EBS**. Bien qu'un Snapshot EC2 puisse √™tre utilis√© pour cr√©er une nouvelle AMI, ce n'est pas la m√™me chose qu'une AMI, et il n'inclut pas les informations sur le syst√®me d'exploitation, le serveur d'applications ou d'autres logiciels n√©cessaires pour ex√©cuter une application.

### Privesc

Sur la page suivante, vous pouvez voir comment **abuser des permissions EBS pour escalader les privil√®ges** :

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** permet de g√©rer √† distance des flottes d'instances EC2 pour faciliter leur administration. Chacune de ces instances doit ex√©cuter le **service SSM Agent car c'est ce service qui recevra les actions et les ex√©cutera** √† partir de l'API AWS.

**SSM Agent** permet √† Systems Manager de mettre √† jour, g√©rer et configurer ces ressources. L'agent **traite les demandes du service Systems Manager dans le cloud AWS**, puis les ex√©cute comme sp√©cifi√© dans la demande.

Le **SSM Agent est**[ **pr√©install√© dans certaines AMIs**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) ou vous devez [**les installer manuellement**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) sur les instances. De plus, le r√¥le IAM utilis√© √† l'int√©rieur de l'instance doit avoir la politique **AmazonEC2RoleforSSM** attach√©e pour pouvoir communiquer.

### √ânum√©ration
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Vous pouvez v√©rifier si Systems Manager est en cours d'ex√©cution sur une instance EC2 simplement en ex√©cutant :
```bash
ps aux | grep amazon-ssm
```
### Privesc

Sur la page suivante, vous pouvez voir comment **abuser des permissions SSM pour escalader les privil√®ges** :

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB) est un **service de r√©partition de charge pour les d√©ploiements Amazon Web Services** (AWS). ELB **distribue automatiquement le trafic entrant des applications** et ajuste les ressources pour r√©pondre aux demandes de trafic.

### Enumeration
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Mod√®les de lancement et groupes d'autoscaling

### √ânum√©ration

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## Nitro

AWS Nitro est une suite de **technologies innovantes** qui forment la plateforme sous-jacente pour les instances AWS EC2. Introduit par Amazon pour **am√©liorer la s√©curit√©, la performance et la fiabilit√©**, Nitro utilise des **composants mat√©riels personnalis√©s et un hyperviseur l√©ger**. Il abstrait une grande partie des fonctionnalit√©s de virtualisation traditionnelles vers du mat√©riel et des logiciels d√©di√©s, **minimisant la surface d'attaque** et am√©liorant l'efficacit√© des ressources. En d√©chargeant les fonctions de virtualisation, Nitro permet aux instances EC2 de fournir des **performances proches du bare-metal**, ce qui est particuli√®rement b√©n√©fique pour les applications gourmandes en ressources. De plus, la puce de s√©curit√© Nitro assure sp√©cifiquement la **s√©curit√© du mat√©riel et du firmware**, renfor√ßant ainsi son architecture robuste.

Obtenez plus d'informations et comment l'√©num√©rer √† partir de :

{% content-ref url="aws-nitro-enum.md" %}
[aws-nitro-enum.md](aws-nitro-enum.md)
{% endcontent-ref %}

## VPN

Un VPN permet de connecter votre **r√©seau sur site (site-to-site VPN)** ou les **ordinateurs portables des travailleurs (Client VPN)** avec un **AWS VPC** afin que les services puissent √™tre accessibles sans avoir besoin de les exposer √† Internet.

#### Composants de base du VPN AWS

1. **Customer Gateway** :
* Un Customer Gateway est une ressource que vous cr√©ez dans AWS pour repr√©senter votre c√¥t√© d'une connexion VPN.
* C'est essentiellement un dispositif physique ou une application logicielle de votre c√¥t√© de la connexion Site-to-Site VPN.
* Vous fournissez des informations de routage et l'adresse IP publique de votre dispositif r√©seau (comme un routeur ou un pare-feu) √† AWS pour cr√©er un Customer Gateway.
* Il sert de point de r√©f√©rence pour configurer la connexion VPN et n'entra√Æne pas de frais suppl√©mentaires.
2. **Virtual Private Gateway** :
* Un Virtual Private Gateway (VPG) est le concentrateur VPN du c√¥t√© Amazon de la connexion Site-to-Site VPN.
* Il est attach√© √† votre VPC et sert de cible pour votre connexion VPN.
* VPG est le point d'extr√©mit√© c√¥t√© AWS pour la connexion VPN.
* Il g√®re la communication s√©curis√©e entre votre VPC et votre r√©seau sur site.
3. **Site-to-Site VPN Connection** :
* Une connexion Site-to-Site VPN connecte votre r√©seau sur site √† un VPC via un tunnel VPN s√©curis√© IPsec.
* Ce type de connexion n√©cessite un Customer Gateway et un Virtual Private Gateway.
* Il est utilis√© pour une communication s√©curis√©e, stable et coh√©rente entre votre centre de donn√©es ou r√©seau et votre environnement AWS.
* Typiquement utilis√© pour des connexions r√©guli√®res et √† long terme et est factur√© en fonction de la quantit√© de donn√©es transf√©r√©es sur la connexion.
4. **Client VPN Endpoint** :
* Un Client VPN endpoint est une ressource que vous cr√©ez dans AWS pour activer et g√©rer les sessions VPN client.
* Il est utilis√© pour permettre aux appareils individuels (comme les ordinateurs portables, les smartphones, etc.) de se connecter en toute s√©curit√© aux ressources AWS ou √† votre r√©seau sur site.
* Il diff√®re du Site-to-Site VPN en ce qu'il est con√ßu pour des clients individuels plut√¥t que pour connecter des r√©seaux entiers.
* Avec Client VPN, chaque appareil client utilise un logiciel client VPN pour √©tablir une connexion s√©curis√©e.

Vous pouvez [**trouver plus d'informations sur les avantages et les composants des VPN AWS ici**](aws-vpc-and-networking-basic-information.md#vpn).

### √ânum√©ration
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Local Enumeration

**Local Temporary Credentials**

Lorsque le client AWS VPN est utilis√© pour se connecter √† un VPN, l'utilisateur se connecte g√©n√©ralement √† AWS pour acc√©der au VPN. Ensuite, des **identifiants AWS sont cr√©√©s et stock√©s** localement pour √©tablir la connexion VPN. Ces identifiants sont **stock√©s dans** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` et contiennent une **AccessKey**, une **SecretKey** et un **Token**.

Les identifiants appartiennent √† l'utilisateur `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO : rechercher plus d'informations sur les permissions de ces identifiants).

**fichiers de configuration opvn**

Si une **connexion VPN a √©t√© √©tablie**, vous devriez rechercher des fichiers de configuration **`.opvn`** dans le syst√®me. De plus, un endroit o√π vous pourriez trouver les **configurations** est **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**.

#### **Post Exploitation**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PRs aux d√©p√¥ts GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
