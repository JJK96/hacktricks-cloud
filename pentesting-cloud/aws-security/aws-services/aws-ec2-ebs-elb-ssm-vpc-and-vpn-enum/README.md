# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

{% hint style="success" %}
Nauƒçite i ve≈æbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nauƒçite i ve≈æbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hacking trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## VPC & Networking

Nauƒçite ≈°ta je VPC i o njegovim komponentama u:

{% content-ref url="aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2 se koristi za pokretanje **virtuelnih servera**. Omoguƒáava konfiguraciju **bezbednosti** i **mre≈æe** i upravljanje **skladi≈°tem**. Fleksibilnost Amazon EC2 je oƒçigledna u njegovoj sposobnosti da skalira resurse i prema gore i prema dole, efikasno se prilagoƒëavajuƒái promenama zahteva ili naglim porastima popularnosti. Ova funkcija smanjuje potrebu za preciznim predviƒëanjem saobraƒáaja.

Zanimljive stvari za enumeraciju u EC2:

* Virtuelne ma≈°ine
* SSH kljuƒçevi
* Korisniƒçki podaci
* Postojeƒái EC2/AMIs/Snapshotovi
* Mre≈æe
* Podmre≈æe
* Javni IP-ovi
* Otvoreni portovi
* Integrisane veze sa drugim mre≈æama van AWS-a

### Instance Profiles

Kori≈°ƒáenje **uloga** za dodeljivanje dozvola aplikacijama koje rade na **EC2 instancama** zahteva malo dodatne konfiguracije. Aplikacija koja radi na EC2 instanci je apstrahovana od AWS-a putem virtualizovanog operativnog sistema. Zbog ove dodatne separacije, potreban je dodatni korak da se dodeli AWS uloga i njene pridru≈æene dozvole EC2 instanci i uƒçine dostupnim njenim aplikacijama.

Ovaj dodatni korak je **kreiranje** [_**instance profile**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html) pridru≈æenog instanci. **Instance profile sadr≈æi ulogu i** mo≈æe pru≈æiti privremene kredencijale uloge aplikaciji koja radi na instanci. Ti privremeni kredencijali se zatim mogu koristiti u API pozivima aplikacije za pristup resursima i ograniƒçavanje pristupa samo onim resursima koje uloga specificira. Napomena da **samo jedna uloga mo≈æe biti dodeljena EC2 instanci** u isto vreme, i sve aplikacije na instanci dele istu ulogu i dozvole.

### Metadata Endpoint

AWS EC2 metapodaci su informacije o Amazon Elastic Compute Cloud (EC2) instanci koje su dostupne instanci u runtime-u. Ovi metapodaci se koriste za pru≈æanje informacija o instanci, kao ≈°to su njen ID instance, zona dostupnosti u kojoj radi, IAM uloga pridru≈æena instanci i hostname instance.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Enumeration
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Neautentifikovani Pristup

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Privesc

Na sledeƒáoj stranici mo≈æete proveriti kako da **zloupotrebite EC2 dozvole za eskalaciju privilegija**:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Post-Eksploatacija

{% content-ref url="../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Amazon **EBS** (Elastic Block Store) **snapshots** su u osnovi statiƒçki **bekapi** AWS EBS volumena. Drugim reƒçima, to su **kopije** **diskova** povezanih sa **EC2** instancom u odreƒëenom trenutku. EBS snapshots mogu biti kopirani izmeƒëu regiona i naloga, ili ƒçak preuzeti i pokrenuti lokalno.

Snapshots mogu sadr≈æati **osetljive informacije** kao ≈°to su **izvorni kod ili API kljuƒçevi**, stoga, ako imate priliku, preporuƒçuje se da ih proverite.

### Razlika AMI & EBS

**AMI** se koristi za **pokretanje EC2 instance**, dok se EC2 **Snapshot** koristi za **bekap i oporavak podataka saƒçuvanih na EBS volumenu**. Iako se EC2 Snapshot mo≈æe koristiti za kreiranje novog AMI-ja, to nije isto ≈°to i AMI, i ne ukljuƒçuje informacije o operativnom sistemu, aplikacionom serveru ili drugom softveru potrebnom za pokretanje aplikacije.

### Privesc

Na sledeƒáoj stranici mo≈æete proveriti kako da **zloupotrebite EBS dozvole za eskalaciju privilegija**:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** omoguƒáava daljinsko upravljanje flotama EC2 instanci kako bi njihova administracija bila mnogo lak≈°a. Svaka od ovih instanci mora imati pokrenut **SSM Agent servis jer ƒáe on preuzimati akcije i izvr≈°avati ih** sa AWS API-ja.

**SSM Agent** omoguƒáava Systems Manager-u da a≈æurira, upravlja i konfiguri≈°e ove resurse. Agent **obraƒëuje zahteve od Systems Manager servisa u AWS Cloud-u**, a zatim ih izvr≈°ava kako je navedeno u zahtevu.

**SSM Agent dolazi**[ **preinstaliran u nekim AMI-jima**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) ili ga morate [**ruƒçno instalirati**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) na instancama. Takoƒëe, IAM Role kori≈°ƒáena unutar instance mora imati politiku **AmazonEC2RoleforSSM** pridru≈æenu kako bi mogla da komunicira.

### Enumeracija
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Mo≈æete proveriti u EC2 instanci da li je Systems Manager pokrenut jednostavno izvr≈°avanjem:
```bash
ps aux | grep amazon-ssm
```
### Privesc

Na sledeƒáoj stranici mo≈æete proveriti kako da **zloupotrebite SSM dozvole za eskalaciju privilegija**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB) je **servis za balansiranje optereƒáenja za Amazon Web Services** (AWS) implementacije. ELB automatski **distribuira dolazni saobraƒáaj aplikacija** i skalira resurse kako bi zadovoljio zahteve saobraƒáaja.

### Enumeration
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Launch Templates & Autoscaling Groups

### Enumeracija

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## Nitro

AWS Nitro je skup **inovativnih tehnologija** koje ƒçine osnovnu platformu za AWS EC2 instance. Amazon ga je uveo da **pobolj≈°a sigurnost, performanse i pouzdanost**, Nitro koristi prilagoƒëene **hardverske komponente i lagani hipervizor**. Apstrahuje mnogo tradicionalne funkcionalnosti virtualizacije na posveƒáeni hardver i softver, **minimizirajuƒái povr≈°inu napada** i pobolj≈°avajuƒái efikasnost resursa. Prebacivanjem funkcija virtualizacije, Nitro omoguƒáava EC2 instancama da isporuƒçe **gotovo performanse kao na fiziƒçkom hardveru**, ≈°to je posebno korisno za aplikacije koje zahtevaju mnogo resursa. Pored toga, Nitro Security Chip posebno osigurava **sigurnost hardvera i firmvera**, dodatno uƒçvr≈°ƒáujuƒái njegovu robusnu arhitekturu.

Vi≈°e informacija i kako da ga enumeri≈°ete mo≈æete pronaƒái na:

{% content-ref url="aws-nitro-enum.md" %}
[aws-nitro-enum.md](aws-nitro-enum.md)
{% endcontent-ref %}

## VPN

VPN omoguƒáava povezivanje va≈°e **on-premise mre≈æe (site-to-site VPN)** ili **radnih laptopova (Client VPN)** sa **AWS VPC** tako da se usluge mogu pristupiti bez potrebe da ih izla≈æete internetu.

#### Osnovne komponente AWS VPN-a

1. **Customer Gateway**:
* Customer Gateway je resurs koji kreirate u AWS-u da predstavlja va≈°u stranu VPN konekcije.
* U su≈°tini, to je fiziƒçki ureƒëaj ili softverska aplikacija na va≈°oj strani Site-to-Site VPN konekcije.
* Pru≈æate informacije o rutiranju i javnu IP adresu va≈°eg mre≈ænog ureƒëaja (kao ≈°to je ruter ili firewall) AWS-u da biste kreirali Customer Gateway.
* Slu≈æi kao referentna taƒçka za postavljanje VPN konekcije i ne izaziva dodatne tro≈°kove.
2. **Virtual Private Gateway**:
* Virtual Private Gateway (VPG) je VPN koncentrator na Amazon strani Site-to-Site VPN konekcije.
* Povezan je sa va≈°im VPC-om i slu≈æi kao cilj za va≈°u VPN konekciju.
* VPG je AWS strana krajnje taƒçke za VPN konekciju.
* Rukuje sigurnom komunikacijom izmeƒëu va≈°eg VPC-a i va≈°e on-premises mre≈æe.
3. **Site-to-Site VPN Connection**:
* Site-to-Site VPN konekcija povezuje va≈°u on-premises mre≈æu sa VPC-om putem sigurnog, IPsec VPN tunela.
* Ova vrsta konekcije zahteva Customer Gateway i Virtual Private Gateway.
* Koristi se za sigurnu, stabilnu i konzistentnu komunikaciju izmeƒëu va≈°eg data centra ili mre≈æe i va≈°eg AWS okru≈æenja.
* Tipiƒçno se koristi za redovne, dugoroƒçne konekcije i naplaƒáuje se na osnovu koliƒçine podataka prenetih preko konekcije.
4. **Client VPN Endpoint**:
* Client VPN endpoint je resurs koji kreirate u AWS-u da omoguƒáite i upravljate klijentskim VPN sesijama.
* Koristi se za omoguƒáavanje pojedinaƒçnim ureƒëajima (kao ≈°to su laptopovi, pametni telefoni, itd.) da se sigurno pove≈æu sa AWS resursima ili va≈°om on-premises mre≈æom.
* Razlikuje se od Site-to-Site VPN-a po tome ≈°to je dizajniran za pojedinaƒçne klijente, a ne za povezivanje celih mre≈æa.
* Sa Client VPN-om, svaki klijentski ureƒëaj koristi VPN klijent softver da uspostavi sigurnu konekciju.

Mo≈æete [**pronaƒái vi≈°e informacija o prednostima i komponentama AWS VPN-a ovde**](aws-vpc-and-networking-basic-information.md#vpn).

### Enumeracija
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Lokalna Enumeracija

**Lokalni Privremeni Kredencijali**

Kada se koristi AWS VPN Klijent za povezivanje na VPN, korisnik ƒáe obiƒçno **prijaviti se u AWS** da bi dobio pristup VPN-u. Zatim se neki **AWS kredencijali kreiraju i ƒçuvaju** lokalno kako bi se uspostavila VPN veza. Ovi kredencijali su **saƒçuvani u** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` i sadr≈æe **AccessKey**, **SecretKey** i **Token**.

Kredencijali pripadaju korisniku `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO: istra≈æiti vi≈°e o dozvolama ovih kredencijala).

**opvn config fajlovi**

Ako je **VPN veza uspostavljena** treba da tra≈æite **`.opvn`** config fajlove u sistemu. Pored toga, jedno mesto gde mo≈æete pronaƒái **konfiguracije** je u **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**

#### **Post Eksploatacija**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## Reference

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

{% hint style="success" %}
Nauƒçite i ve≈æbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nauƒçite i ve≈æbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repoe.

</details>
{% endhint %}
