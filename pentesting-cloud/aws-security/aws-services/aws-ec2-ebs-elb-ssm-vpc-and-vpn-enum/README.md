# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

{% hint style="success" %}
Leer en oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer en oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repo's.

</details>
{% endhint %}

## VPC & Netwerking

Leer wat 'n VPC is en oor sy komponente in:

{% content-ref url="aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2 word gebruik vir die aanvang van **virtuele bedieners**. Dit laat die konfigurasie van **sekuriteit** en **netwerking** toe en die bestuur van **stoorplek**. Die buigsaamheid van Amazon EC2 is duidelik in sy vermo√´ om hulpbronne opwaarts en afwaarts te skaal, wat effektief aanpas by verskillende vereiste veranderinge of oplewings in gewildheid. Hierdie kenmerk verminder die noodsaaklikheid vir presiese verkeersvoorspellings.

Interessante dinge om in EC2 te lys:

* Virtuele Masjiene
* SSH Sleutels
* Gebruikersdata
* Bestaande EC2s/AMIs/Snapshots
* Netwerking
* Netwerke
* Subnetwerke
* Publieke IP's
* Oop poorte
* Ge√Øntegreerde verbindings met ander netwerke buite AWS

### Instansieprofiele

Om **rolle** te gebruik om toestemmings aan toepassings wat op **EC2-instansies** loop te gee, vereis 'n bietjie ekstra konfigurasie. 'n Toepassing wat op 'n EC2-instansie loop, word deur die gevirtualiseerde bedryfstelsel van AWS geabstraheer. As gevolg van hierdie ekstra skeiding, benodig jy 'n bykomende stap om 'n AWS-rol en sy geassosieerde toestemmings aan 'n EC2-instansie toe te ken en dit beskikbaar te maak vir sy toepassings.

Hierdie ekstra stap is die **skepping van 'n** [_**instansieprofiel**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html) wat aan die instansie geheg is. Die **instansieprofiel bevat die rol en** kan die rol se tydelike geloofsbriewe aan 'n toepassing wat op die instansie loop, verskaf. Daardie tydelike geloofsbriewe kan dan in die toepassing se API-oproepe gebruik word om toegang tot hulpbronne te verkry en toegang te beperk tot slegs daardie hulpbronne wat die rol spesifiseer. Let daarop dat **slegs een rol aan 'n EC2-instansie** op 'n slag toegeken kan word, en alle toepassings op die instansie deel dieselfde rol en toestemmings.

### Metadata Eindpunt

AWS EC2-metadata is inligting oor 'n Amazon Elastic Compute Cloud (EC2)-instansie wat tydens looptyd aan die instansie beskikbaar is. Hierdie metadata word gebruik om inligting oor die instansie te verskaf, soos sy instansie-ID, die beskikbaarheidssone waarin dit loop, die IAM-rol wat met die instansie geassosieer word, en die instansie se gasheernaam.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Enumerasie
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Onauthentiseerde Toegang

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Privesc

Op die volgende bladsy kan jy sien hoe om **EC2-permissies te misbruik om voorregte te verhoog**:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Post-Exploitation

{% content-ref url="../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Amazon **EBS** (Elastic Block Store) **snapshots** is basies statiese **rugsteun** van AWS EBS volumes. Met ander woorde, dit is **kopie√´** van die **skywe** wat aan 'n **EC2** Instansie gekoppel is op 'n spesifieke tydstip. EBS snapshots kan oor streke en rekeninge gekopieer word, of selfs afgelaai en plaaslik uitgevoer word.

Snapshots kan **sensitiewe inligting** bevat soos **bronkode of API sleutels**, daarom, as jy die kans het, word dit aanbeveel om dit na te gaan.

### Verskil AMI & EBS

'n **AMI** word gebruik om 'n **EC2 instansie te begin**, terwyl 'n EC2 **Snapshot** gebruik word om **data wat op 'n EBS volume gestoor is te rugsteun en te herstel**. Terwyl 'n EC2 Snapshot gebruik kan word om 'n nuwe AMI te skep, is dit nie dieselfde ding as 'n AMI nie, en dit sluit nie inligting in oor die bedryfstelsel, toepassingsbediener, of ander sagteware wat nodig is om 'n toepassing te laat loop nie.

### Privesc

Op die volgende bladsy kan jy sien hoe om **EBS-permissies te misbruik om voorregte te verhoog**:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** laat toe om EC2 instansies op afstand te bestuur om hul administrasie baie makliker te maak. Elk van hierdie instansies moet die **SSM Agent diens laat loop aangesien die diens die een sal wees wat die aksies kry en uitvoer** vanaf die AWS API.

**SSM Agent** maak dit moontlik vir Systems Manager om hierdie hulpbronne op te dateer, te bestuur en te konfigureer. Die agent **verwerk versoeke van die Systems Manager diens in die AWS Cloud**, en voer dit dan uit soos gespesifiseer in die versoek.

Die **SSM Agent kom**[ **vooraf ge√Ønstalleer in sommige AMIs**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) of jy moet dit [**handmatig installeer**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) op die instansies. Ook, die IAM Rol wat binne die instansie gebruik word moet die beleid **AmazonEC2RoleforSSM** aangeheg h√™ om te kan kommunikeer.

### Enumerasie
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Jy kan in 'n EC2-instansie kyk of Systems Manager loop deur net die volgende uit te voer:
```bash
ps aux | grep amazon-ssm
```
### Privesc

Op die volgende bladsy kan jy kyk hoe om **SSM-permissies te misbruik om voorregte te verhoog**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB) is 'n **lasbalanseringsdiens vir Amazon Web Services** (AWS) ontplooiings. ELB versprei outomaties **inkomende toepassingsverkeer** en skaal hulpbronne om aan verkeersvereistes te voldoen.

### Enumerasie
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Launch Templates & Autoscaling Groups

### Enumeration

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## Nitro

AWS Nitro is 'n reeks **innoverende tegnologie√´** wat die onderliggende platform vir AWS EC2-instanse vorm. Dit is deur Amazon bekendgestel om **sekuriteit, werkverrigting en betroubaarheid te verbeter**. Nitro gebruik pasgemaakte **hardewarekomponente en 'n liggewig hipervisor**. Dit abstraheer baie van die tradisionele virtualisasie-funksionaliteit na toegewyde hardeware en sagteware, wat die **aanvalsoppervlak minimaliseer** en hulpbron-doeltreffendheid verbeter. Deur virtualisasie-funksies oor te dra, laat Nitro EC2-instanse toe om **byna naakte-metaal werkverrigting** te lewer, wat dit besonder voordelig maak vir hulpbron-intensiewe toepassings. Daarbenewens verseker die Nitro Sekuriteitskyfie spesifiek die **sekuriteit van die hardeware en firmware**, wat sy robuuste argitektuur verder versterk.

Kry meer inligting en hoe om dit te enumereer vanaf:

{% content-ref url="aws-nitro-enum.md" %}
[aws-nitro-enum.md](aws-nitro-enum.md)
{% endcontent-ref %}

## VPN

'n VPN laat jou toe om jou **aan-premisse netwerk (site-to-site VPN)** of die **werkers se skootrekenaars (Client VPN)** met 'n **AWS VPC** te verbind sodat dienste verkry kan word sonder om dit aan die internet bloot te stel.

#### Basiese AWS VPN Komponente

1. **Customer Gateway**:
* 'n Customer Gateway is 'n hulpbron wat jy in AWS skep om jou kant van 'n VPN-verbinding te verteenwoordig.
* Dit is in wese 'n fisiese toestel of sagtewaretoepassing aan jou kant van die Site-to-Site VPN-verbinding.
* Jy verskaf roeteringsinligting en die publieke IP-adres van jou netwerktoestel (soos 'n roeteerder of 'n firewall) aan AWS om 'n Customer Gateway te skep.
* Dit dien as 'n verwysingspunt vir die opstel van die VPN-verbinding en bring geen bykomende koste mee nie.
2. **Virtual Private Gateway**:
* 'n Virtual Private Gateway (VPG) is die VPN-konsentrator aan die Amazon-kant van die Site-to-Site VPN-verbinding.
* Dit is aan jou VPC gekoppel en dien as die teiken vir jou VPN-verbinding.
* VPG is die AWS-kant eindpunt vir die VPN-verbinding.
* Dit hanteer die veilige kommunikasie tussen jou VPC en jou aan-premisse netwerk.
3. **Site-to-Site VPN Connection**:
* 'n Site-to-Site VPN-verbinding verbind jou aan-premisse netwerk met 'n VPC deur 'n veilige, IPsec VPN-tonnel.
* Hierdie tipe verbinding vereis 'n Customer Gateway en 'n Virtual Private Gateway.
* Dit word gebruik vir veilige, stabiele en konsekwente kommunikasie tussen jou datacentrum of netwerk en jou AWS-omgewing.
* Tipies gebruik vir gereelde, langtermyn verbindings en word gefaktureer gebaseer op die hoeveelheid data wat oor die verbinding oorgedra word.
4. **Client VPN Endpoint**:
* 'n Client VPN-eindpunt is 'n hulpbron wat jy in AWS skep om kli√´nt VPN-sessies moontlik te maak en te bestuur.
* Dit word gebruik om individuele toestelle (soos skootrekenaars, slimfone, ens.) toe te laat om veilig aan AWS-hulpbronne of jou aan-premisse netwerk te koppel.
* Dit verskil van Site-to-Site VPN deurdat dit ontwerp is vir individuele kli√´nte eerder as om hele netwerke te verbind.
* Met Client VPN gebruik elke kli√´nttoestel 'n VPN-kli√´ntsagteware om 'n veilige verbinding te vestig.

Jy kan [**meer inligting oor die voordele en komponente van AWS VPNs hier vind**](aws-vpc-and-networking-basic-information.md#vpn).

### Enumeration
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Lokale Enumerasie

**Lokale Tydelike Geloofsbriewe**

Wanneer AWS VPN Client gebruik word om aan 'n VPN te koppel, sal die gebruiker gewoonlik **aanmeld in AWS** om toegang tot die VPN te kry. Dan word sommige **AWS geloofsbriewe geskep en plaaslik gestoor** om die VPN-verbinding te vestig. Hierdie geloofsbriewe word **gestoor in** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` en bevat 'n **AccessKey**, 'n **SecretKey** en 'n **Token**.

Die geloofsbriewe behoort aan die gebruiker `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO: navors meer oor die toestemmings van hierdie geloofsbriewe).

**opvn konfigurasie l√™ers**

As 'n **VPN-verbinding gevestig is**, moet jy soek na **`.opvn`** konfigurasie l√™ers in die stelsel. Verder, een plek waar jy die **konfigurasies** kan vind, is in **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**

#### **Post Eksploitasie**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## Verwysings

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
