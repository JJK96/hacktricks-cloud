# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## VPC & Networking

Bir VPC'nin ne olduğunu ve bileşenlerini öğrenin:

{% content-ref url="aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2, **sanal sunucular** başlatmak için kullanılır. **Güvenlik** ve **ağ yapılandırması** ile **depolama yönetimi** sağlar. Amazon EC2'nin esnekliği, kaynakları hem yukarı hem de aşağı ölçeklendirme yeteneğinde belirgindir, bu da değişen gereksinimlere veya popülerlik artışlarına etkili bir şekilde uyum sağlar. Bu özellik, kesin trafik tahminlerine olan ihtiyacı azaltır.

EC2'de enumerate edilecek ilginç şeyler:

* Sanal Makineler
* SSH Anahtarları
* Kullanıcı Verileri
* Mevcut EC2'ler/AMIs/Snapshotlar
* Ağ
* Ağlar
* Alt ağlar
* Genel IP'ler
* Açık portlar
* AWS dışındaki diğer ağlarla entegre bağlantılar

### Instance Profiles

**EC2 instance'larında** çalışan uygulamalara izin vermek için **rolleri** kullanmak biraz ekstra yapılandırma gerektirir. Bir EC2 instance'ında çalışan bir uygulama, sanallaştırılmış işletim sistemi tarafından AWS'den soyutlanmıştır. Bu ekstra ayrım nedeniyle, bir AWS rolünü ve ilgili izinlerini bir EC2 instance'ına atamak ve bunları uygulamalarına sunmak için ek bir adım gereklidir.

Bu ekstra adım, instance'a eklenen bir [_**instance profile**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html) oluşturulmasıdır. **Instance profile, rolü içerir ve** instance'da çalışan bir uygulamaya rolün geçici kimlik bilgilerini sağlayabilir. Bu geçici kimlik bilgileri, uygulamanın API çağrılarında kaynaklara erişmek ve yalnızca rolün belirttiği kaynaklara erişimi sınırlamak için kullanılabilir. **Bir EC2 instance'ına aynı anda yalnızca bir rol atanabilir** ve instance'daki tüm uygulamalar aynı rol ve izinleri paylaşır.

### Metadata Endpoint

AWS EC2 metadata, bir Amazon Elastic Compute Cloud (EC2) instance'ı hakkında, instance'ın çalışma zamanında erişebileceği bilgilerdir. Bu metadata, instance kimliği, çalıştığı kullanılabilirlik bölgesi, instance'a atanan IAM rolü ve instance'ın ana bilgisayar adı gibi bilgileri sağlamak için kullanılır.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Enumeration
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Kimlik Doğrulaması Olmayan Erişim

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Ayrıcalık Yükseltme

Aşağıdaki sayfada **EC2 izinlerini kötüye kullanarak ayrıcalıkları nasıl yükseltebileceğinizi** kontrol edebilirsiniz:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### İstismar Sonrası

{% content-ref url="../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Amazon **EBS** (Elastic Block Store) **anlık görüntüleri**, temelde AWS EBS hacimlerinin statik **yedekleridir**. Başka bir deyişle, belirli bir zamanda bir **EC2** örneğine bağlı **disklerin** **kopyalarıdır**. EBS anlık görüntüleri bölgeler ve hesaplar arasında kopyalanabilir veya hatta indirilebilir ve yerel olarak çalıştırılabilir.

Anlık görüntüler, **kaynak kodu veya API anahtarları** gibi **hassas bilgiler** içerebilir, bu nedenle, fırsatınız varsa, kontrol etmeniz önerilir.

### AMI ve EBS Arasındaki Fark

Bir **AMI**, bir **EC2 örneği başlatmak** için kullanılırken, bir EC2 **Anlık Görüntüsü**, bir EBS hacminde depolanan verileri **yedeklemek ve geri yüklemek** için kullanılır. Bir EC2 Anlık Görüntüsü yeni bir AMI oluşturmak için kullanılabilirken, bir AMI ile aynı şey değildir ve işletim sistemi, uygulama sunucusu veya bir uygulamayı çalıştırmak için gereken diğer yazılımlar hakkında bilgi içermez.

### Ayrıcalık Yükseltme

Aşağıdaki sayfada **EBS izinlerini kötüye kullanarak ayrıcalıkları nasıl yükseltebileceğinizi** kontrol edebilirsiniz:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)**, EC2 örneklerinin yönetimini uzaktan yapmayı ve yönetimlerini çok daha kolay hale getirmeyi sağlar. Bu örneklerin her birinin **SSM Agent hizmetini çalıştırması gerekir, çünkü hizmet AWS API'sinden gelen eylemleri alacak ve gerçekleştirecektir**.

**SSM Agent**, Systems Manager'ın bu kaynakları güncellemesini, yönetmesini ve yapılandırmasını mümkün kılar. Agent, **AWS Cloud'daki Systems Manager hizmetinden gelen istekleri işler** ve ardından istekte belirtilen şekilde çalıştırır.

**SSM Agent**, bazı AMI'lerde [**önceden yüklenmiş olarak gelir**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) veya örneklerde [**manuel olarak yüklemeniz**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) gerekir. Ayrıca, örnek içinde kullanılan IAM Rolünün iletişim kurabilmesi için **AmazonEC2RoleforSSM** politikasına sahip olması gerekir.

### Numaralandırma
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
EC2 instance'da Systems Manager'ın çalışıp çalışmadığını sadece şu komutu çalıştırarak kontrol edebilirsiniz:
```bash
ps aux | grep amazon-ssm
```
### Privesc

Aşağıdaki sayfada **SSM izinlerini kötüye kullanarak ayrıcalıkları nasıl yükseltebileceğinizi** kontrol edebilirsiniz:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB), **Amazon Web Services** (AWS) dağıtımları için bir **yük dengeleme hizmetidir**. ELB, gelen uygulama trafiğini **otomatik olarak dağıtır** ve trafik taleplerini karşılamak için kaynakları ölçeklendirir.

### Enumeration
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Launch Templates & Autoscaling Groups

### Enumeration

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## Nitro

AWS Nitro, AWS EC2 instance'larının temel platformunu oluşturan bir dizi **yenilikçi teknolojidir**. Amazon tarafından **güvenliği, performansı ve güvenilirliği artırmak** amacıyla tanıtılmıştır. Nitro, özel **donanım bileşenleri ve hafif bir hypervisor** kullanır. Geleneksel sanallaştırma işlevselliğinin çoğunu özel donanım ve yazılıma soyutlayarak, **saldırı yüzeyini en aza indirir** ve kaynak verimliliğini artırır. Sanallaştırma işlevlerini devrederek, Nitro EC2 instance'larının **neredeyse çıplak metal performansı** sunmasını sağlar, bu da özellikle kaynak yoğun uygulamalar için faydalıdır. Ayrıca, Nitro Güvenlik Çipi, **donanım ve firmware güvenliğini** özel olarak sağlar ve sağlam mimarisini daha da pekiştirir.

Daha fazla bilgi ve nasıl enumerate edileceği hakkında bilgi almak için:

{% content-ref url="aws-nitro-enum.md" %}
[aws-nitro-enum.md](aws-nitro-enum.md)
{% endcontent-ref %}

## VPN

Bir VPN, **on-premise ağınızı (site-to-site VPN)** veya **çalışanların dizüstü bilgisayarlarını (Client VPN)** bir **AWS VPC** ile bağlamanızı sağlar, böylece hizmetlere interneti açmadan erişilebilir.

#### Temel AWS VPN Bileşenleri

1. **Customer Gateway**:
* Customer Gateway, VPN bağlantınızın sizin tarafınızı temsil etmek için AWS'de oluşturduğunuz bir kaynaktır.
* Site-to-Site VPN bağlantınızın sizin tarafını temsil eden fiziksel bir cihaz veya yazılım uygulamasıdır.
* AWS'ye yönlendirme bilgilerini ve ağ cihazınızın (örneğin bir yönlendirici veya güvenlik duvarı) genel IP adresini sağlayarak bir Customer Gateway oluşturursunuz.
* VPN bağlantısını kurmak için bir referans noktası olarak hizmet eder ve ek ücret gerektirmez.
2. **Virtual Private Gateway**:
* Virtual Private Gateway (VPG), Site-to-Site VPN bağlantısının Amazon tarafındaki VPN konsantratörüdür.
* VPC'nize eklenir ve VPN bağlantınızın hedefi olarak hizmet eder.
* VPG, VPN bağlantısının AWS tarafındaki uç noktasıdır.
* VPC'niz ile on-premises ağınız arasındaki güvenli iletişimi sağlar.
3. **Site-to-Site VPN Connection**:
* Site-to-Site VPN bağlantısı, on-premises ağınızı güvenli bir IPsec VPN tüneli aracılığıyla bir VPC'ye bağlar.
* Bu tür bir bağlantı, bir Customer Gateway ve bir Virtual Private Gateway gerektirir.
* Veri merkeziniz veya ağınız ile AWS ortamınız arasında güvenli, istikrarlı ve tutarlı iletişim için kullanılır.
* Genellikle düzenli, uzun vadeli bağlantılar için kullanılır ve bağlantı üzerinden aktarılan veri miktarına göre faturalandırılır.
4. **Client VPN Endpoint**:
* Client VPN endpoint, client VPN oturumlarını etkinleştirmek ve yönetmek için AWS'de oluşturduğunuz bir kaynaktır.
* Bireysel cihazların (dizüstü bilgisayarlar, akıllı telefonlar vb.) AWS kaynaklarına veya on-premises ağınıza güvenli bir şekilde bağlanmasını sağlamak için kullanılır.
* Site-to-Site VPN'den farklı olarak, tüm ağları bağlamak yerine bireysel istemciler için tasarlanmıştır.
* Client VPN ile her istemci cihazı, güvenli bir bağlantı kurmak için bir VPN istemci yazılımı kullanır.

AWS VPN'lerin faydaları ve bileşenleri hakkında daha fazla bilgiyi [**buradan bulabilirsiniz**](aws-vpc-and-networking-basic-information.md#vpn).

### Enumeration
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Yerel Numaralandırma

**Yerel Geçici Kimlik Bilgileri**

AWS VPN Client bir VPN'e bağlanmak için kullanıldığında, kullanıcı genellikle **VPN'e erişim sağlamak için AWS'de oturum açar**. Daha sonra, VPN bağlantısını kurmak için bazı **AWS kimlik bilgileri oluşturulur ve yerel olarak saklanır**. Bu kimlik bilgileri `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` dosyasında saklanır ve bir **AccessKey**, bir **SecretKey** ve bir **Token** içerir.

Kimlik bilgileri `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` kullanıcısına aittir (TODO: bu kimlik bilgilerinin izinleri hakkında daha fazla araştırma yapın).

**opvn yapılandırma dosyaları**

Eğer bir **VPN bağlantısı kurulmuşsa**, sistemde **`.opvn`** yapılandırma dosyalarını aramalısınız. Ayrıca, **yapılandırmaları** bulabileceğiniz bir yer **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`** dizinidir.

#### **Post Exploitation**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## Referanslar

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) **bizi takip edin**.
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}
