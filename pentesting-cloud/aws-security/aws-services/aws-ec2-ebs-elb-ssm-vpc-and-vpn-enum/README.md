# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## VPC & Δικτύωση

Μάθετε τι είναι ένα VPC και για τα συστατικά του στο:

{% content-ref url="aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Το Amazon EC2 χρησιμοποιείται για την εκκίνηση **εικονικών διακομιστών**. Επιτρέπει τη διαμόρφωση της **ασφάλειας** και της **δικτύωσης** και τη διαχείριση της **αποθήκευσης**. Η ευελιξία του Amazon EC2 είναι εμφανής στην ικανότητά του να κλιμακώνει πόρους τόσο προς τα πάνω όσο και προς τα κάτω, προσαρμοζόμενη αποτελεσματικά σε μεταβαλλόμενες απαιτήσεις ή αυξήσεις δημοτικότητας. Αυτό το χαρακτηριστικό μειώνει την ανάγκη για ακριβείς προβλέψεις κίνησης.

Ενδιαφέροντα πράγματα για απαρίθμηση στο EC2:

* Εικονικές Μηχανές
* SSH Keys
* User Data
* Υπάρχοντα EC2s/AMIs/Snapshots
* Δικτύωση
* Δίκτυα
* Υποδίκτυα
* Δημόσιες IPs
* Ανοιχτές θύρες
* Ενσωματωμένες συνδέσεις με άλλα δίκτυα εκτός AWS

### Instance Profiles

Η χρήση **ρόλων** για την παροχή δικαιωμάτων σε εφαρμογές που εκτελούνται σε **EC2 instances** απαιτεί λίγη επιπλέον διαμόρφωση. Μια εφαρμογή που εκτελείται σε ένα EC2 instance είναι απομονωμένη από το AWS από το εικονικοποιημένο λειτουργικό σύστημα. Λόγω αυτής της επιπλέον απομόνωσης, χρειάζεστε ένα επιπλέον βήμα για να αναθέσετε έναν AWS ρόλο και τα συνδεδεμένα δικαιώματά του σε ένα EC2 instance και να τα κάνετε διαθέσιμα στις εφαρμογές του.

Αυτό το επιπλέον βήμα είναι η **δημιουργία ενός** [_**instance profile**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html) που συνδέεται με το instance. Το **instance profile περιέχει τον ρόλο και** μπορεί να παρέχει τα προσωρινά διαπιστευτήρια του ρόλου σε μια εφαρμογή που εκτελείται στο instance. Αυτά τα προσωρινά διαπιστευτήρια μπορούν στη συνέχεια να χρησιμοποιηθούν στις κλήσεις API της εφαρμογής για πρόσβαση σε πόρους και για περιορισμό της πρόσβασης μόνο σε αυτούς τους πόρους που καθορίζει ο ρόλος. Σημειώστε ότι **μόνο ένας ρόλος μπορεί να ανατεθεί σε ένα EC2 instance** κάθε φορά, και όλες οι εφαρμογές στο instance μοιράζονται τον ίδιο ρόλο και δικαιώματα.

### Metadata Endpoint

Το AWS EC2 metadata είναι πληροφορίες για ένα Amazon Elastic Compute Cloud (EC2) instance που είναι διαθέσιμες στο instance κατά την εκτέλεση. Αυτά τα metadata χρησιμοποιούνται για την παροχή πληροφοριών για το instance, όπως το instance ID, η ζώνη διαθεσιμότητας στην οποία εκτελείται, ο IAM ρόλος που συνδέεται με το instance και το hostname του instance.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Enumeration
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Μη Εξουσιοδοτημένη Πρόσβαση

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Αύξηση Προνομίων

Στην ακόλουθη σελίδα μπορείτε να δείτε πώς να **εκμεταλλευτείτε τα δικαιώματα EC2 για να αυξήσετε τα προνόμια**:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Μετα-Εκμετάλλευση

{% content-ref url="../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Τα **snapshots** του Amazon **EBS** (Elastic Block Store) είναι βασικά στατικά **αντίγραφα ασφαλείας** των όγκων EBS του AWS. Με άλλα λόγια, είναι **αντίγραφα** των **δίσκων** που είναι συνδεδεμένοι σε μια **EC2** Instance σε μια συγκεκριμένη χρονική στιγμή. Τα snapshots του EBS μπορούν να αντιγραφούν μεταξύ περιοχών και λογαριασμών, ή ακόμα και να κατεβούν και να εκτελεστούν τοπικά.

Τα Snapshots μπορεί να περιέχουν **ευαίσθητες πληροφορίες** όπως **πηγαίο κώδικα ή κλειδιά API**, επομένως, αν έχετε την ευκαιρία, συνιστάται να τα ελέγξετε.

### Διαφορά AMI & EBS

Ένα **AMI** χρησιμοποιείται για να **εκκινήσει μια EC2 instance**, ενώ ένα **Snapshot** EC2 χρησιμοποιείται για να **δημιουργήσει αντίγραφα ασφαλείας και να ανακτήσει δεδομένα αποθηκευμένα σε έναν όγκο EBS**. Ενώ ένα Snapshot EC2 μπορεί να χρησιμοποιηθεί για να δημιουργήσει ένα νέο AMI, δεν είναι το ίδιο πράγμα με ένα AMI και δεν περιλαμβάνει πληροφορίες για το λειτουργικό σύστημα, τον διακομιστή εφαρμογών ή άλλο λογισμικό που απαιτείται για την εκτέλεση μιας εφαρμογής.

### Αύξηση Προνομίων

Στην ακόλουθη σελίδα μπορείτε να δείτε πώς να **εκμεταλλευτείτε τα δικαιώματα EBS για να αυξήσετε τα προνόμια**:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

Το **Amazon Simple Systems Manager (SSM)** επιτρέπει την απομακρυσμένη διαχείριση στόλων EC2 instances για να κάνει τη διαχείρισή τους πολύ πιο εύκολη. Κάθε μία από αυτές τις instances πρέπει να εκτελεί την **υπηρεσία SSM Agent καθώς η υπηρεσία θα είναι αυτή που θα λαμβάνει τις ενέργειες και θα τις εκτελεί** από το AWS API.

Ο **SSM Agent** καθιστά δυνατή την ενημέρωση, διαχείριση και διαμόρφωση αυτών των πόρων από το Systems Manager. Ο agent **επεξεργάζεται αιτήματα από την υπηρεσία Systems Manager στο AWS Cloud**, και στη συνέχεια τα εκτελεί όπως καθορίζεται στο αίτημα.

Ο **SSM Agent έρχεται**[ **προεγκατεστημένος σε ορισμένα AMIs**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) ή πρέπει να τον [**εγκαταστήσετε χειροκίνητα**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) στις instances. Επίσης, ο IAM Role που χρησιμοποιείται μέσα στην instance πρέπει να έχει την πολιτική **AmazonEC2RoleforSSM** συνδεδεμένη για να μπορεί να επικοινωνεί.

### Καταμέτρηση
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Μπορείτε να ελέγξετε σε ένα EC2 instance αν το Systems Manager εκτελείται απλά εκτελώντας:
```bash
ps aux | grep amazon-ssm
```
### Privesc

Στην ακόλουθη σελίδα μπορείτε να δείτε πώς να **εκμεταλλευτείτε τα δικαιώματα SSM για να κλιμακώσετε προνόμια**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB) είναι μια **υπηρεσία εξισορρόπησης φορτίου για αναπτύξεις Amazon Web Services** (AWS). Το ELB αυτόματα **διανέμει την εισερχόμενη κίνηση εφαρμογών** και κλιμακώνει τους πόρους για να ανταποκριθεί στις απαιτήσεις της κίνησης.

### Enumeration
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Launch Templates & Autoscaling Groups

### Καταμέτρηση

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## Nitro

Το AWS Nitro είναι μια σουίτα από **καινοτόμες τεχνολογίες** που αποτελούν την υποκείμενη πλατφόρμα για τις AWS EC2 instances. Εισήχθη από την Amazon για να **ενισχύσει την ασφάλεια, την απόδοση και την αξιοπιστία**, το Nitro αξιοποιεί προσαρμοσμένα **υλικά εξαρτήματα και έναν ελαφρύ hypervisor**. Αφαιρεί μεγάλο μέρος της παραδοσιακής λειτουργικότητας εικονικοποίησης σε ειδικό υλικό και λογισμικό, **ελαχιστοποιώντας την επιφάνεια επίθεσης** και βελτιώνοντας την αποδοτικότητα των πόρων. Με την εκφόρτωση των λειτουργιών εικονικοποίησης, το Nitro επιτρέπει στις EC2 instances να παρέχουν **σχεδόν απόδοση γυμνού μετάλλου**, καθιστώντας το ιδιαίτερα επωφελές για εφαρμογές που απαιτούν πολλούς πόρους. Επιπλέον, το Nitro Security Chip διασφαλίζει ειδικά την **ασφάλεια του υλικού και του firmware**, ενισχύοντας περαιτέρω την ισχυρή αρχιτεκτονική του.

Περισσότερες πληροφορίες και πώς να το απαριθμήσετε από:

{% content-ref url="aws-nitro-enum.md" %}
[aws-nitro-enum.md](aws-nitro-enum.md)
{% endcontent-ref %}

## VPN

Ένα VPN επιτρέπει τη σύνδεση του **δικτύου σας στις εγκαταστάσεις (site-to-site VPN)** ή των **φορητών υπολογιστών των εργαζομένων (Client VPN)** με ένα **AWS VPC** ώστε οι υπηρεσίες να μπορούν να προσπελαστούν χωρίς να χρειάζεται να εκτεθούν στο διαδίκτυο.

#### Βασικά Συστατικά του AWS VPN

1. **Customer Gateway**:
* Ένα Customer Gateway είναι ένας πόρος που δημιουργείτε στο AWS για να αντιπροσωπεύει την πλευρά σας μιας σύνδεσης VPN.
* Είναι ουσιαστικά μια φυσική συσκευή ή εφαρμογή λογισμικού στην πλευρά σας της σύνδεσης Site-to-Site VPN.
* Παρέχετε πληροφορίες δρομολόγησης και τη δημόσια διεύθυνση IP της δικτυακής σας συσκευής (όπως ένας δρομολογητής ή ένα firewall) στο AWS για να δημιουργήσετε ένα Customer Gateway.
* Λειτουργεί ως σημείο αναφοράς για τη ρύθμιση της σύνδεσης VPN και δεν επιφέρει επιπλέον χρεώσεις.
2. **Virtual Private Gateway**:
* Ένα Virtual Private Gateway (VPG) είναι ο συγκεντρωτής VPN στην πλευρά της Amazon της σύνδεσης Site-to-Site VPN.
* Είναι συνδεδεμένο με το VPC σας και λειτουργεί ως στόχος για τη σύνδεση VPN σας.
* Το VPG είναι το σημείο τερματισμού της πλευράς του AWS για τη σύνδεση VPN.
* Διαχειρίζεται την ασφαλή επικοινωνία μεταξύ του VPC σας και του δικτύου σας στις εγκαταστάσεις.
3. **Site-to-Site VPN Connection**:
* Μια σύνδεση Site-to-Site VPN συνδέει το δίκτυό σας στις εγκαταστάσεις με ένα VPC μέσω ενός ασφαλούς, IPsec VPN τούνελ.
* Αυτός ο τύπος σύνδεσης απαιτεί ένα Customer Gateway και ένα Virtual Private Gateway.
* Χρησιμοποιείται για ασφαλή, σταθερή και συνεπή επικοινωνία μεταξύ του κέντρου δεδομένων ή του δικτύου σας και του περιβάλλοντος AWS σας.
* Συνήθως χρησιμοποιείται για τακτικές, μακροχρόνιες συνδέσεις και χρεώνεται με βάση την ποσότητα των δεδομένων που μεταφέρονται μέσω της σύνδεσης.
4. **Client VPN Endpoint**:
* Ένα Client VPN endpoint είναι ένας πόρος που δημιουργείτε στο AWS για να επιτρέψετε και να διαχειριστείτε τις συνεδρίες VPN πελατών.
* Χρησιμοποιείται για να επιτρέπει σε μεμονωμένες συσκευές (όπως φορητούς υπολογιστές, smartphones, κ.λπ.) να συνδέονται με ασφάλεια με πόρους του AWS ή το δίκτυό σας στις εγκαταστάσεις.
* Διαφέρει από το Site-to-Site VPN στο ότι είναι σχεδιασμένο για μεμονωμένους πελάτες και όχι για τη σύνδεση ολόκληρων δικτύων.
* Με το Client VPN, κάθε συσκευή πελάτη χρησιμοποιεί λογισμικό VPN πελάτη για να δημιουργήσει μια ασφαλή σύνδεση.

Μπορείτε να [**βρείτε περισσότερες πληροφορίες σχετικά με τα οφέλη και τα συστατικά των AWS VPNs εδώ**](aws-vpc-and-networking-basic-information.md#vpn).

### Enumeration
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Τοπική Απαρίθμηση

**Τοπικά Προσωρινά Διαπιστευτήρια**

Όταν χρησιμοποιείται ο AWS VPN Client για σύνδεση σε VPN, ο χρήστης συνήθως **συνδέεται στο AWS** για να αποκτήσει πρόσβαση στο VPN. Στη συνέχεια, κάποια **AWS διαπιστευτήρια δημιουργούνται και αποθηκεύονται** τοπικά για να καθιερωθεί η σύνδεση VPN. Αυτά τα διαπιστευτήρια **αποθηκεύονται στο** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` και περιέχουν ένα **AccessKey**, ένα **SecretKey** και ένα **Token**.

Τα διαπιστευτήρια ανήκουν στον χρήστη `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO: έρευνα περισσότερα για τα δικαιώματα αυτών των διαπιστευτηρίων).

**opvn config files**

Εάν μια **σύνδεση VPN έχει καθιερωθεί** θα πρέπει να αναζητήσετε **`.opvn`** αρχεία ρυθμίσεων στο σύστημα. Επιπλέον, ένα μέρος όπου θα μπορούσατε να βρείτε τις **ρυθμίσεις** είναι στο **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**

#### **Μετά την Εκμετάλλευση**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## Αναφορές

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Συμμετάσχετε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή την [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
