# AWS - Enumerate Step Functions

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Hatua za Kazi

AWS Step Functions ni huduma ya mfumo wa kazi ambayo inakuwezesha kusawazisha na kusimamia huduma nyingi za AWS katika mifumo ya kazi isiyo na seva. Kwa kutumia AWS Step Functions, unaweza kubuni na kuendesha mifumo ya kazi inayounganisha huduma mbalimbali za AWS kama vile AWS Lambda, Amazon S3, Amazon DynamoDB, na zingine nyingi, katika mfululizo wa hatua. Huduma hii ya usawazishaji hutoa kiolesura cha mifumo ya kazi na inatoa uwezo wa **mashine ya hali**, kuruhusu kufafanua kila hatua ya mfumo wa kazi kwa njia ya kielelezo kwa kutumia **Lugha ya Amazon States** (ASL) iliyojengwa kwa JSON.

AWS Step Functions inasimplisha mchakato wa kujenga programu zenye nguvu na zinazoweza kupanuliwa kwa kusimamia miundombinu ya msingi, kushughulikia upya, makosa, na usindikaji wa mara kwa mara kiotomatiki. Ni muhimu hasa kwa kuunda mifumo ya kazi yenye hatua nyingi na maamuzi, kwani inaweza kusimamia kwa urahisi mtiririko wa data na hali ya utekelezaji kati ya huduma. Matumizi makuu yanayoweza kufanywa na huduma hii ni haya yafuatayo:

- **Usindikaji wa Data**: Usindikaji wa faili, video na picha; uchimbaji, uongofu na mzigo wa kazi (ETL); na usindikaji wa kundi na mzigo wa Kuhesabu Kazi wa Juu (HPC).
- **Ujifunzaji wa Mashine**: Uchunguzi wa udanganyifu, ubinafsishaji, mapendekezo na utajiri wa data.
- **Usawazishaji wa Huduma Ndogo**: Mifumo ya kazi ya moja kwa moja au ya wakati halisi na usawazishaji wa kontena.
- **IT na Usanidi wa Usalama**: Kurekebisha kiotomatiki, kupeleka na kujibu; na idhini ya binadamu na kuongezeka.

## Dhana Kuu

### Mifumo ya Kazi ya Kawaida dhidi ya Mifumo ya Kazi ya Haraka

AWS Step Functions inatoa aina mbili za **mifumo ya mashine ya hali**: Kawaida na Haraka.

- **Mfumo wa Kazi wa Kawaida**: Aina hii ya mfumo wa kazi ya msingi imeundwa kwa ajili ya michakato ndefu, imara, na inayoweza kufuatiliwa. Inasaidia **utekelezaji mara moja tu**, ikihakikisha kazi zinatekelezwa mara moja tu isipokuwa kurudia kwa makusudi. Ni bora kwa mifumo ya kazi inayohitaji historia kamili ya utekelezaji na inaweza kuendesha hadi mwaka mmoja.
- **Mfumo wa Kazi wa Haraka**: Aina hii ni bora kwa kazi zenye kiasi kikubwa, za muda mfupi, zinazoendesha hadi dakika tano. Zinasaidia **utekelezaji angalau mara moja**, zinazofaa kwa kazi zenye idempotent kama usindikaji wa data. Mifumo hii ya kazi imeboreshwa kwa gharama na utendaji, ikilipisha kulingana na utekelezaji, muda, na matumizi ya kumbukumbu.

### Hali

Hali ni vitengo muhimu vya mifumo ya mashine ya hali. Hizi hufafanua hatua binafsi ndani ya mfumo wa kazi, zikiweza kutekeleza aina mbalimbali ya kazi kulingana na aina yake:

- **Kazi:** Inatekeleza kazi, mara nyingi kwa kutumia huduma ya AWS kama Lambda.
- **Chaguo:** Hufanya maamuzi kulingana na matokeo.
- **Kushindwa/Kufanikiwa:** Inamaliza utekelezaji kwa kushindwa au mafanikio.
- **Pita:** Inapitisha kuingia kwa pato au kuingiza data.
- **Subiri:** Kuchelewesha utekelezaji kwa muda uliowekwa.
- **Paraleli:** Inaanzisha matawi ya mara kwa mara.
- **Ramani:** Inarudia hatua kwa vitu kwa njia ya kudumu.

### Kazi

Hali ya **Kazi** inawakilisha kitengo kimoja cha kazi kinachotekelezwa na mfumo wa hali. Kazi zinaweza kuita rasilimali mbalimbali, ikiwa ni pamoja na shughuli, kazi za Lambda, huduma za AWS, au APIs za watu wa tatu.

- **Shughuli**: Wafanyikazi wa desturi unaoendesha, inayofaa kwa michakato inayodumu muda mrefu.
- Rasilimali: **`arn:aws:states:eneo:akaunti:shughuli:jina`**.
- **Kazi za Lambda**: Inatekeleza kazi za Lambda za AWS.
- Rasilimali: **`arn:aws:lambda:eneo:akaunti:kazi:jina-la-kazi`**.
- **Huduma za AWS**: Inashirikiana moja kwa moja na huduma zingine za AWS, kama vile DynamoDB au S3.
- Rasilimali: **`arn:partition:states:eneo:akaunti:jina-la-huduma:APIname`**.
- **Kazi ya HTTP**: Inaita APIs za watu wa tatu.
- Uga wa rasilimali: **`arn:aws:states:::http:itikia`**. Kisha, unapaswa kutoa maelezo ya usanidi wa mwisho wa API, kama vile URL ya API, njia, na maelezo ya uthibitishaji.

Mfano ufuatao unaonyesha ufafanuzi wa hali ya Kazi inayoitisha kazi ya Lambda iliyoitwa HelloWorld:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Chaguo

Hali ya **Chaguo** inaongeza mantiki ya masharti kwenye mchakato, ikiruhusu maamuzi kulingana na data ya kuingiza. Inachambua masharti yaliyotajwa na kugeukia hali inayofanana kulingana na matokeo.

- **Ulinganifu**: Kila sheria ya chaguo inajumuisha operator wa kulinganisha (k.m., **`NumericEquals`**, **`StringEquals`**) ambayo inalinganisha kipengee cha kuingiza na thamani iliyotajwa au kipengee kingine.
- **Uwanja Ufuatao**: Hali za Chaguo hazisaidii uwanja wa **`End`**, badala yake, zinatambua hali ya **`Next`** ya kugeukia ikiwa kulinganisha ni kweli.

Mfano wa hali ya **Chaguo**:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Kufeli/Kufanikiwa

Hali ya **`Kufeli`** inasitisha utekelezaji wa mashine ya hali na kuifanya iwe kushindwa. Hutumiwa kutaja jina la kosa na sababu, ikitoa maelezo kuhusu kushindwa. Hali hii ni ya mwisho, maana yake inamaliza mtiririko wa utekelezaji.

Hali ya **`Kufanikiwa`** inasitisha utekelezaji kwa mafanikio. Kawaida hutumiwa kumaliza mchakato wa kazi wakati unakamilika kwa mafanikio. Hali hii haitaji uga wa **`Next`**. 

{% tabs %}

{% tab title="Mfano wa Kufeli" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Mfano wa Kufanikiwa" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Kupita

Hali ya **Kupita** inapitisha matokeo yake kwa matokeo yake bila kufanya kazi yoyote au kubadilisha kuingia kwa kutumia vichujio, na kisha kupitisha data iliyobadilishwa kwa hali inayofuata. Ni muhimu kwa ajili ya majaribio na ujenzi wa mashine za hali, kuruhusu wewe kuingiza data ya tuli au kuibadilisha.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Subiri

Hali ya **Subiri** inachelewesha utekelezaji wa mashine ya hali kwa muda uliowekwa. Kuna njia tatu kuu za configure muda wa kusubiri:

- **X Sekunde**: Idadi ya sekunde iliyowekwa kusubiri.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "HaliInayofuata"
}
```

- **Muda Halisi**: Muda kamili wa kusubiri hadi wakati fulani.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "HaliInayofuata"
}
```

- **Subiri ya Kudumu**: Kulingana na matokeo kutumia **`SecondsPath`** au **`TimestampPath`**.

```json
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.tareheyaumalizowakati",
"Next": "HaliInayofuata"
}
```


### Paralelo

Hali ya **Paralelo** inakuruhusu kutekeleza matawi mengi ya kazi kwa wakati mmoja ndani ya mchakato wako. Kila tawi hufanya kazi kivyake na kusindika mfululizo wake wa hali. Utekelezaji unasubiri hadi matawi yote yamalize kabla ya kuendelea kwenye hali inayofuata. Vipengele muhimu ni:

- **Matawi**: Mfululizo unaoeleza njia za utekelezaji wa paralelo. Kila tawi ni mashine ya hali tofauti.
- **ResultPath**: Inaeleza wapi (katika matokeo) kuweka matokeo yaliyochanganywa ya matawi.
- **Jaribu na Kukamata**: Mipangilio ya kushughulikia makosa kwa hali ya paralelo.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Ramani

Hali ya **Ramani** inawezesha utekelezaji wa seti ya hatua kwa kila kipengee katika seti ya data. Inatumika kwa usindikaji wa data kwa namna ya wima. Kulingana na jinsi unavyotaka kusindika vitu vya seti ya data, Step Functions hutoa njia zifuatazo:

- **Njia ya Ndani**: Inatekeleza sehemu ya hali kwa kila kipengee cha safu ya JSON. Inafaa kwa kazi za kiwango kidogo zenye zaidi ya mizunguko 40 ya wima, ikitekeleza kila moja katika muktadha wa kazi inayojumuisha hali ya¬†**`Ramani`**.

```json
"HaliYaRamani": {
"Aina": "Ramani",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "NDANI"
},
"StartAt": "HaliYaKuongeza",
"States": {
"HaliYaKuongeza": {
"Aina": "Kazi",
"Rasilimali": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameta": {
"JinaLaFungua": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"Mwisho": kweli
}
}
},
"Mwisho": kweli
"MatokeoPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Njia ya Usambazaji**: Imetengenezwa kwa usindikaji wa wima wa kiwango kikubwa na ushirikiano mkubwa. Inasaidia usindikaji wa seti kubwa za data, kama vile zile zilizohifadhiwa kwenye Amazon S3, ikiruhusu ushirikiano mkubwa wa mizunguko 10,000 ya wima ya utekelezaji wa kazi za watoto, ikitekeleza hizi kama utekelezaji tofauti wa watoto.

```json
"HaliYaRamaniIsiyosambazwa": {
"Aina": "Ramani",
"MsomajiWaKipengee": {
"Rasilimali": "arn:aws:states:::s3:getObject",
"Parameta": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "USAMBAZAJI",
"ExecutionType": "EXPRESS"
},
"StartAt": "SindikaKipengee",
"States": {
"SindikaKipengee": {
"Aina": "Kazi",
"Rasilimali": "arn:aws:lambda:region:account-id:function:my-function",
"Mwisho": kweli
}
}
},
"Mwisho": kweli
"MwandishiWaMatokeo": {
"Rasilimali": "arn:aws:states:::s3:putObject",
"Parameta": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Toleo na majina ya utani

Step Functions pia inakuruhusu kusimamia uanzishaji wa kazi kupitia **matoleo** na **majina ya utani** ya mashine za hali. Toleo linawakilisha picha ya hali ya mashine ambayo inaweza kutekelezwa. Majina ya utani hufanya kama pointi kwa hadi matoleo mawili ya mashine ya hali.

- **Matoleo**: Picha hizi zisizobadilika za hali ya mashine zinaundwa kutoka kwa marekebisho ya hivi karibuni zaidi ya hali hiyo ya mashine. Kila toleo linatambuliwa na ARN ya kipekee inayounganisha ARN ya mashine ya hali na nambari ya toleo, zilizotenganishwa na mkato (**`arn:aws:states:region:account-id:stateMachine:JinaLaStateMachine:nambari-ya-toleo`**). Matoleo hayawezi kuhaririwa, lakini unaweza kusasisha mashine ya hali na kuchapisha toleo jipya, au kutumia toleo la mashine ya hali inayotakiwa.
- **Majina ya Utani**: Pointi hizi zinaweza kurejelea hadi matoleo mawili ya mashine hiyo hiyo ya hali. Majina ya utani yanawezesha mwelekeo wa trafiki kati ya moja ya matoleo mawili ya mashine ya hali. Vinginevyo, jina la utani linaweza kuelekeza kwa toleo moja maalum la mashine ya hali, lakini sio kwa majina mengine ya utani. Wanaweza kusasishwa kuelekeza kwa toleo tofauti la mashine ya hali kama inavyohitajika, ikirahisisha uanzishaji wa kudhibitiwa na usimamizi wa kazi.

Kwa habari zaidi kuhusu **ASL**, angalia:¬†[**Lugha ya Amazon States**](https://states-language.net/spec.html).



## Majukumu ya IAM kwa Mashine za Hali

AWS Step Functions hutumia majukumu ya Kitambulisho na Ufikiaji wa AWS (IAM) kudhibiti upatikanaji wa rasilimali na hatua ndani ya mashine za hali. Hapa kuna mambo muhimu yanayohusiana na usalama na majukumu ya IAM katika AWS Step Functions:

- **Jukumu la Utekelezaji**: Kila mashine ya hali katika AWS Step Functions inahusishwa na jukumu la utekelezaji wa IAM. Jukumu hili linafafanua hatua gani mashine ya hali inaweza kutekeleza kwa niaba yako. Wakati mashine ya hali inabadilika kati ya hali zinazoshirikiana na huduma za AWS (kama kuita kazi za Lambda, kufikia DynamoDB, n.k.), inachukua jukumu hili la utekelezaji kutekeleza hatua hizo.
- **Ruhusa**: Jukumu la utekelezaji la IAM lazima liwe limewekwa ruhusa zinazoruhusu hatua muhimu kwenye huduma zingine za AWS. Kwa mfano, ikiwa mashine ya hali yako inahitaji kuita kazi za AWS Lambda, jukumu la IAM lazima liwe na ruhusa za **`lambda:InvokeFunction`**. Vivyo hivyo, ikiwa inahitaji kuandika kwenye DynamoDB, ruhusa sahihi (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, n.k.) lazima zipewe.
- **Haki za Chini**: Inapendekezwa kufuata kanuni ya haki za chini unapoweka majukumu ya IAM kwa Step Functions. Hii inamaanisha kutoa ruhusa tu zinazohitajika kwa mashine ya hali kutekeleza hatua zake maalum, na sio zaidi. Sera za IAM zinapaswa kuwa zilizoelekezwa kwa rasilimali na hatua maalum, kupunguza hatari ya kupata upatikanaji usiokusudiwa.

## Uorodheshaji

Sera ya KusomaPekee inatosha kwa vitendo vyote vya uorodheshaji vifuatavyo.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

Kwenye ukurasa ufuatao, unaweza kuangalia jinsi ya **kutumia ruhusa za Step Functions kwa kujiongezea mamlaka**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Baada ya Kudukua

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# Marejeo

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
