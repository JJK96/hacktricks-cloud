# AWS - Step Functions Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> から <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>でAWSハッキングをゼロからヒーローまで学びましょう！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい** または **HackTricks をPDFでダウンロードしたい** 場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)** に参加するか、[telegramグループ](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** をフォローする**
* **ハッキングトリックを共有するために** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリにPRを提出する

</details>

## Step Functions

AWS Step Functions は、複数のAWSサービスをサーバーレスワークフローに調整およびオーケストレーションすることを可能にするワークフローサービスです。AWS Step Functions を使用することで、AWS Lambda、Amazon S3、Amazon DynamoDBなどのさまざまなAWSサービスを接続するワークフローを設計および実行できます。このオーケストレーションサービスは、視覚的なワークフローインターフェースを提供し、JSONベースの **Amazon States Language** (ASL) を使用してワークフローの各ステップを宣言的に定義できる **ステートマシン** 機能を提供します。

AWS Step Functions は、基礎となるインフラストラクチャの管理、リトライ、エラー処理、および並列処理を自動的に処理することで、弾力性のあるスケーラブルなアプリケーションの構築プロセスを簡素化します。複数のステップと意思決定ポイントを含む複雑なワークフローを作成する際に特に役立ち、データと実行状態のフローを簡単に管理できます。このサービスによって実行される主なユースケースは次のとおりです:

- **データ処理**: ファイル、ビデオ、画像処理; 抽出、変換、ロード (ETL) ジョブ; バッチ処理およびハイパフォーマンスコンピューティング (HPC) ワークロード。
- **機械学習**: 不正検出、カスタマイズ、推奨、データの充実。
- **マイクロサービスのオーケストレーション**: 同期またはリアルタイムのワークフローおよびコンテナのオーケストレーション。
- **ITおよびセキュリティの自動化**: 自動修復、展開および応答; 人間の承認およびエスカレーション。

## キーコンセプト

### 標準ワークフローとエクスプレスワークフロー

AWS Step Functions は、2種類の **ステートマシンワークフロー** を提供しています: 標準およびエクスプレス。

- **標準ワークフロー**: このデフォルトのワークフロータイプは、長時間実行される、耐久性があり監査可能なプロセスに適しています。 **一度だけ実行** をサポートし、リトライが指定されていない限り、タスクは1回だけ実行されます。詳細な実行履歴が必要なワークフローに最適であり、最大1年間実行できます。
- **エクスプレスワークフロー**: このタイプは、高ボリュームで短時間のタスクに適しており、最大5分間実行できます。 **少なくとも一度の実行** をサポートし、データ処理などの冪等なタスクに適しています。これらのワークフローは、実行、期間、およびメモリ使用量に基づいて料金が設定され、コストとパフォーマンスが最適化されています。

### ステート

ステートはステートマシンの基本単位です。ステートは、そのタイプに応じてさまざまな機能を実行できるワークフロー内の個々のステップを定義します:

- **Task:** 入力に基づいて決定を行います。
- **Choice:** 入力に基づいて決定を行います。
- **Fail/Succeed:** 失敗または成功で実行を終了します。
- **Pass:** 入力を出力に渡すか、データを挿入します。
- **Wait:** 実行を一定時間遅延させます。
- **Parallel:** 並列ブランチを開始します。
- **Map:** アイテムを対象にステップを動的に繰り返します。

### Task

**Task** ステートは、ステートマシンによって実行される単一の作業単位を表します。タスクは、アクティビティ、Lambda関数、AWSサービス、またはサードパーティAPIなど、さまざまなリソースを呼び出すことができます。

- **アクティビティ**: 長時間実行されるプロセスに適した、管理するカスタムワーカー。
- リソース: **`arn:aws:states:region:account:activity:name`**。
- **Lambda関数**: AWS Lambda関数を実行します。
- リソース: **`arn:aws:lambda:region:account:function:function-name`**。
- **AWSサービス**: DynamoDBやS3などの他のAWSサービスと直接統合します。
- リソース: **`arn:partition:states:region:account:servicename:APIname`**。
- **HTTPタスク**: サードパーティAPIを呼び出します。
- リソースフィールド: **`arn:aws:states:::http:invoke`**。次に、APIのURL、メソッド、および認証の詳細など、APIエンドポイントの構成詳細を提供する必要があります。

以下の例は、Lambda関数 HelloWorld を呼び出すTaskステートの定義を示しています:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### 選択肢

**Choice**ステートは、ワークフローに条件付きロジックを追加し、入力データに基づいて決定を可能にします。指定された条件を評価し、結果に基づいて対応するステートに遷移します。

- **比較**: 各選択ルールには比較演算子（例: **`NumericEquals`**, **`StringEquals`**）が含まれ、入力変数を指定値や他の変数と比較します。
- **Next フィールド**: 選択ステートは**`End`**フィールドをサポートしません。代わりに、比較が真の場合に遷移する**`Next`**ステートを定義します。

**Choice**ステートの例:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### 失敗/成功

**`Fail`** ステートはステートマシンの実行を停止し、失敗とマークします。エラー名と原因を指定して、失敗に関する詳細を提供するために使用されます。このステートは終端であり、実行フローを終了します。

**`Succeed`** ステートは実行を成功裏に停止します。通常、ワークフローが正常に完了したときに終了するために使用されます。このステートには **`Next`** フィールドは必要ありません。

{% tabs %}

{% tab title="Fail example" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="成功例" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### パス

**パス**ステートは、入力をそのまま出力に渡すか、フィルタを使用してJSONステート入力を変換し、変換されたデータを次のステートに渡すことで、作業を行わずに入力を出力に渡します。テストやステートマシンの構築に役立ち、静的データを挿入したり変換したりすることができます。
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### 待機

**待機**状態は、指定された期間だけステートマシンの実行を遅らせます。待機時間を設定するための主な方法は3つあります:

- **X 秒**: 待機する固定の秒数。

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **絶対タイムスタンプ**: 待機する正確な時刻。

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **動的待機**: **`SecondsPath`** または **`TimestampPath`** を使用した入力に基づく待機。

```json
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### 並列

**並列**状態では、ワークフロー内で複数のタスクの枝を同時に実行できます。各枝は独立して実行され、独自のステートシーケンスを処理します。実行は、すべての枝が完了するまで待機し、次の状態に進みます。主なフィールドは以下です:

- **Branches**: 並列実行パスを定義する配列。各枝は別々のステートマシンです。
- **ResultPath**: 枝の結合出力を配置する場所（入力内）を定義します。
- **Retry および Catch**: 並列状態のエラー処理構成。
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### マップ

**マップ**ステートは、データセット内の各アイテムに対して一連のステップを実行します。データの並列処理に使用されます。データセットのアイテムをどのように処理するかに応じて、Step Functionsは次のモードを提供します：

- **インラインモード**：各JSON配列アイテムに対して一部のステートを実行します。40回未満の並列イテレーションを持つ小規模なタスクに適しており、それぞれを**`Map`**ステートを含むワークフローのコンテキストで実行します。

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **分散モード**：高い並列処理を持つ大規模な並列処理向けに設計されています。Amazon S3に保存されているような大規模なデータセットの処理をサポートし、最大10,000の並列子ワークフロー実行を可能にし、これらの子ワークフローを別々の子実行として実行します。

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### バージョンとエイリアス

Step Functionsでは、ステートマシンの**バージョン**と**エイリアス**を介してワークフローの展開を管理できます。バージョンは実行可能なステートマシンのスナップショットを表し、エイリアスはステートマシンの最大2つのバージョンへのポインタとして機能します。

- **バージョン**：これらの変更不可能なステートマシンのスナップショットは、そのステートマシンの最新リビジョンから作成されます。各バージョンは、ステートマシンARNとバージョン番号をコロンで区切って組み合わせた一意のARNによって識別されます（**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**）。バージョンは編集できませんが、ステートマシンを更新して新しいバージョンを公開したり、必要なステートマシンバージョンを使用することができます。
- **エイリアス**：これらのポインタは、同じステートマシンの最大2つのバージョンを参照できます。1つのステートマシンに複数のエイリアスを作成でき、それぞれはステートマシンARNとエイリアス名をコロンで区切って組み合わせた一意のARNによって識別されます（**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**）。エイリアスは、ステートマシンの2つのバージョンのいずれかにトラフィックをルーティングすることができます。代替として、エイリアスはステートマシンの特定のバージョンを指すことができますが、他のエイリアスを指すことはできません。必要に応じて異なるバージョンのステートマシンにリダイレクトするように更新でき、制御された展開とワークフロー管理を容易にします。

**ASL**の詳細については、[**Amazon States Language**](https://states-language.net/spec.html)を参照してください。



## ステートマシン用IAMロール

AWS Step Functionsは、AWS Identity and Access Management（IAM）ロールを使用してステートマシン内のリソースとアクションへのアクセスを制御します。AWS Step Functionsに関連するセキュリティとIAMロールに関連する主要な側面は次のとおりです：

- **実行ロール**：AWS Step Functionsの各ステートマシンはIAM実行ロールと関連付けられています。このロールは、ステートマシンが代わりに実行できるアクションを定義します。ステートマシンがAWSサービスとやり取りするステート間を移行する際（Lambda関数の呼び出し、DynamoDBへのアクセスなど）、これらのアクションを実行するためにこの実行ロールを仮定します。
- **権限**：IAM実行ロールは、他のAWSサービスで必要なアクションを許可する権限で構成する必要があります。たとえば、ステートマシンがAWS Lambda関数を呼び出す必要がある場合、IAMロールには**`lambda:InvokeFunction`**権限が必要です。同様に、DynamoDBに書き込む必要がある場合は、適切な権限（**`dynamodb:PutItem`**、**`dynamodb:UpdateItem`**など）を付与する必要があります。
- **最小特権**：Step FunctionsのIAMロールを構成する際には、最小特権の原則に従うことが推奨されます。つまり、ステートマシンが特定のアクションを実行するために必要な権限のみを付与し、それ以上の権限は与えないようにすることです。IAMポリシーは特定のリソースとアクションにスコープを絞り、意図しないアクセスのリスクを軽減します。

## 列挙

ReadOnlyAccessポリシーは、以下の列挙アクションには十分です。
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## 特権昇格

次のページでは、**Step Functionsの権限を悪用して特権を昇格する方法**を確認できます：

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## ポストエクスプロイテーション

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# 参考文献

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする**
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks)のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有する

</details>
