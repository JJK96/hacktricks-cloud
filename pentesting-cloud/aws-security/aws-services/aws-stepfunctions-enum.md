# AWS - Step Functions Enum

{% hint style="success" %}
Jifunze na kufanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na kufanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Step Functions

AWS Step Functions ni huduma ya mtiririko wa kazi inayokuwezesha kuratibu na kupanga huduma nyingi za AWS katika mtiririko wa kazi usio na seva. Kwa kutumia AWS Step Functions, unaweza kubuni na kuendesha mtiririko wa kazi unaounganisha huduma mbalimbali za AWS kama AWS Lambda, Amazon S3, Amazon DynamoDB, na nyingine nyingi, kwa mfululizo wa hatua. Huduma hii ya upangaji inatoa kiolesura cha mtiririko wa kazi wa kuona na inatoa uwezo wa **state machine**, ikikuruhusu kufafanua kila hatua ya mtiririko wa kazi kwa njia ya tamko kwa kutumia **Amazon States Language** (ASL) inayotegemea JSON.

AWS Step Functions inarahisisha mchakato wa kujenga programu zinazostahimili na zinazoweza kupanuka kwa kusimamia miundombinu ya msingi, kushughulikia majaribio tena, makosa, na usindikaji wa sambamba kiotomatiki. Inafaa sana kwa kuunda mtiririko wa kazi mgumu unaohusisha hatua nyingi na sehemu za maamuzi, kwani inaweza kudhibiti kwa urahisi mtiririko wa data na hali ya utekelezaji kati ya huduma. Matumizi makuu ya huduma hii ni yafuatayo:

- **Usindikaji wa data**: Usindikaji wa faili, video na picha; uchimbaji, mabadiliko na upakiaji (ETL) wa kazi; na usindikaji wa kundi na mizigo ya Kompyuta ya Utendaji wa Juu (HPC).
- **Ujifunzaji wa mashine**: Kugundua udanganyifu, ubinafsishaji, mapendekezo na uboreshaji wa data.
- **Upangaji wa huduma ndogo**: Mtiririko wa kazi wa wakati halisi au wa wakati halisi na upangaji wa kontena.
- **Uendeshaji wa IT na usalama**: Urekebishaji wa kiotomatiki, upelekaji na majibu; na idhini ya kibinadamu na kupandishwa cheo.

## Dhana Muhimu

### Standard vs. Express Workflows

AWS Step Functions inatoa aina mbili za **state machine workflows**: Standard na Express.

- **Standard Workflow**: Aina hii ya mtiririko wa kazi chaguo-msingi imeundwa kwa michakato ya muda mrefu, inayodumu, na inayoweza kukaguliwa. Inasaidia **utekelezaji wa mara moja tu**, kuhakikisha kazi zinaendeshwa mara moja tu isipokuwa majaribio tena yameainishwa. Inafaa kwa mtiririko wa kazi unaohitaji historia ya utekelezaji wa kina na inaweza kuendeshwa kwa hadi mwaka mmoja.
- **Express Workflow**: Aina hii inafaa kwa kazi za muda mfupi, za kiwango cha juu, zinazoendeshwa hadi dakika tano. Zinasaidia **utekelezaji wa angalau mara moja**, zinazofaa kwa kazi za idempotent kama usindikaji wa data. Mtiririko huu wa kazi umeboreshwa kwa gharama na utendaji, ukitoza kulingana na utekelezaji, muda, na matumizi ya kumbukumbu.

### States

States ni vitengo muhimu vya state machines. Zinabainisha hatua za kibinafsi ndani ya mtiririko wa kazi, zikiwa na uwezo wa kutekeleza kazi mbalimbali kulingana na aina yake:

- **Task:** Inatekeleza kazi, mara nyingi kwa kutumia huduma ya AWS kama Lambda.
- **Choice:** Hufanya maamuzi kulingana na pembejeo.
- **Fail/Succeed:** Inaisha utekelezaji kwa kushindwa au kufanikiwa.
- **Pass:** Inapitisha pembejeo kwa pato au kuingiza data.
- **Wait:** Inachelewesha utekelezaji kwa muda uliowekwa.
- **Parallel:** Inaanzisha matawi ya sambamba.
- **Map:** Inarudia hatua kwa vitu.

### Task

Hali ya **Task** inawakilisha kitengo kimoja cha kazi kinachotekelezwa na state machine. Tasks zinaweza kuita rasilimali mbalimbali, ikiwa ni pamoja na shughuli, Lambda functions, huduma za AWS, au APIs za wahusika wa tatu.

- **Activities**: Wafanyakazi maalum unaosimamia, wanaofaa kwa michakato ya muda mrefu.
- Resource: **`arn:aws:states:region:account:activity:name`**.
- **Lambda Functions**: Inatekeleza AWS Lambda functions.
- Resource: **`arn:aws:lambda:region:account:function:function-name`**.
- **AWS Services**: Inaunganisha moja kwa moja na huduma nyingine za AWS, kama DynamoDB au S3.
- Resource: **`arn:partition:states:region:account:servicename:APIname`**.
- **HTTP Task**: Inaita APIs za wahusika wa tatu.
- Resource field: **`arn:aws:states:::http:invoke`**. Kisha, unapaswa kutoa maelezo ya usanidi wa mwisho wa API, kama vile URL ya API, njia, na maelezo ya uthibitishaji.

Mfano ufuatao unaonyesha ufafanuzi wa hali ya Task inayoweka Lambda function inayoitwa HelloWorld:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Choice

**Choice** state inaongeza mantiki ya masharti kwenye mtiririko wa kazi, kuwezesha maamuzi kulingana na data ya pembejeo. Inatathmini masharti maalum na kubadilisha hali kulingana na matokeo.

- **Comparison**: Kila sheria ya chaguo inajumuisha operator wa kulinganisha (mfano, **`NumericEquals`**, **`StringEquals`**) inayolinganishwa na thamani maalum au kigezo kingine.
- **Next Field**: Hali za chaguo hazisapoti **`End`** field, badala yake, zinaelezea hali ya **`Next`** ya kubadilisha ikiwa kulinganisha ni kweli.

Mfano wa hali ya **Choice**:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Fail/Succeed

Hali ya **`Fail`** inasimamisha utekelezaji wa mashine ya hali na kuashiria kama imeshindwa. Inatumika kubainisha jina la kosa na sababu, ikitoa maelezo kuhusu kushindwa. Hali hii ni ya mwisho, ikimaanisha inamaliza mtiririko wa utekelezaji.

Hali ya **`Succeed`** inasimamisha utekelezaji kwa mafanikio. Kwa kawaida inatumika kumaliza mtiririko wa kazi unapokamilika kwa mafanikio. Hali hii haihitaji uwanja wa **`Next`**.

{% tabs %}

{% tab title="Fail example" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Succeed example" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
{% endtab %}

{% endtabs %}

### Pass

Hali ya **Pass** hupitisha ingizo lake hadi pato lake bila kufanya kazi yoyote au kubadilisha ingizo la hali ya JSON kwa kutumia vichujio, na kisha kupitisha data iliyobadilishwa hadi hali inayofuata. Inafaa kwa kupima na kujenga mashine za hali, ikikuruhusu kuingiza data tuli au kuibadilisha.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Subiri

Hali ya **Subiri** inachelewesha utekelezaji wa mashine ya hali kwa muda uliowekwa. Kuna njia tatu kuu za kusanidi muda wa kusubiri:

- **X Sekunde**: Idadi maalum ya sekunde za kusubiri.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **Muda Halisi**: Muda maalum wa kusubiri hadi.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **Subiri ya Kiadinamikia**: Kulingana na pembejeo kwa kutumia **`SecondsPath`** au **`TimestampPath`**.

```json
jsonCopiar c√≥digo
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### Sambamba

Hali ya **Sambamba** inakuruhusu kutekeleza matawi mengi ya kazi kwa wakati mmoja ndani ya mtiririko wako wa kazi. Kila tawi linaendesha kwa kujitegemea na kushughulikia mlolongo wake wa hali. Utekelezaji unasubiri hadi matawi yote yakamilike kabla ya kuendelea na hali inayofuata. Sehemu zake kuu ni:

- **Matawi**: Safu inayofafanua njia za utekelezaji sambamba. Kila tawi ni mashine ya hali tofauti.
- **ResultPath**: Inafafanua wapi (katika pembejeo) pa kuweka matokeo ya pamoja ya matawi.
- **Retry na Catch**: Mipangilio ya kushughulikia makosa kwa hali ya sambamba.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

**Map** state inawezesha utekelezaji wa seti ya hatua kwa kila kipengee katika dataset. Inatumika kwa usindikaji sambamba wa data. Kulingana na jinsi unavyotaka kusindika vipengee vya dataset, Step Functions inatoa njia zifuatazo:

- **Inline Mode**: Inatekeleza subset ya states kwa kila kipengee cha array ya JSON. Inafaa kwa kazi ndogo na chini ya iterations 40 sambamba, ikitekeleza kila moja katika muktadha wa workflow inayojumuisha **`Map`** state.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Distributed Mode**: Imeundwa kwa usindikaji sambamba wa kiwango kikubwa na concurrency ya juu. Inasaidia usindikaji wa datasets kubwa, kama zile zilizohifadhiwa katika Amazon S3, ikiruhusu concurrency ya juu hadi executions 10,000 sambamba za workflow za watoto, ikitekeleza hizi kama executions za watoto tofauti.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Versions and aliases

Step Functions pia inakuruhusu kudhibiti deployments za workflow kupitia **versions** na **aliases** za state machines. Version inawakilisha snapshot ya state machine inayoweza kutekelezwa. Aliases hutumika kama pointers kwa hadi versions mbili za state machine.

- **Versions**: Hizi snapshots zisizobadilika za state machine zinaundwa kutoka kwa revision ya hivi karibuni ya state machine hiyo. Kila version inatambulishwa na ARN ya kipekee inayochanganya state machine ARN na namba ya version, ikitenganishwa na colon (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Versions haziwezi kuhaririwa, lakini unaweza kusasisha state machine na kuchapisha version mpya, au kutumia version ya state machine inayotakiwa.
- **Aliases**: Hizi pointers zinaweza kurejelea hadi versions mbili za state machine ile ile. Aliases nyingi zinaweza kuundwa kwa state machine moja, kila moja ikitambulishwa na ARN ya kipekee inayochanganya state machine ARN na jina la alias, ikitenganishwa na colon (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Aliases zinawezesha routing ya trafiki kati ya moja ya versions mbili za state machine. Vinginevyo, alias inaweza kuelekeza kwa version moja maalum ya state machine, lakini si kwa aliases nyingine. Zinaweza kusasishwa kuelekeza kwa version tofauti ya state machine kama inavyohitajika, kuwezesha deployments zilizodhibitiwa na usimamizi wa workflow.

Kwa maelezo zaidi kuhusu **ASL**, angalia: [**Amazon States Language**](https://states-language.net/spec.html).



## IAM Roles for State machines

AWS Step Functions hutumia AWS Identity and Access Management (IAM) roles kudhibiti upatikanaji wa rasilimali na vitendo ndani ya state machines. Hapa kuna vipengele muhimu vinavyohusiana na usalama na IAM roles katika AWS Step Functions:

- **Execution Role**: Kila state machine katika AWS Step Functions inahusishwa na IAM execution role. Hii role inafafanua vitendo gani state machine inaweza kufanya kwa niaba yako. Wakati state machine inapohama kati ya states zinazoshirikiana na huduma za AWS (kama vile kuanzisha Lambda functions, kufikia DynamoDB, nk.), inachukua execution role hii kutekeleza vitendo hivyo.
- **Permissions**: IAM execution role lazima iwe imeundwa na ruhusa zinazowezesha vitendo muhimu kwenye huduma nyingine za AWS. Kwa mfano, ikiwa state machine yako inahitaji kuanzisha AWS Lambda functions, IAM role lazima iwe na ruhusa za **`lambda:InvokeFunction`**. Vivyo hivyo, ikiwa inahitaji kuandika kwenye DynamoDB, ruhusa zinazofaa (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, nk.) lazima zitolewe.
- **Least Privilege**: Inapendekezwa kufuata kanuni ya least privilege wakati wa kusanidi IAM roles kwa Step Functions. Hii inamaanisha kutoa tu ruhusa zinazohitajika kwa state machine kutekeleza vitendo vyake maalum, na si zaidi. Sera za IAM zinapaswa kuwa na wigo kwa rasilimali na vitendo maalum, kupunguza hatari ya upatikanaji usiohitajika.

## Enumeration

ReadOnlyAccess policy inatosha kwa vitendo vyote vifuatavyo vya enumeration.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

Katika ukurasa ufuatao, unaweza kuangalia jinsi ya **kutumia vibaya ruhusa za Step Functions ili kuongeza marupurupu**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# Marejeo

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

{% hint style="success" %}
Jifunze & fanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & fanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
