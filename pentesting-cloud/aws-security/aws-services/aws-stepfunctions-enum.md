# AWS - Step Functions Enum

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Step Functions

AWS Step Functions √© um servi√ßo de workflow que permite coordenar e orquestrar v√°rios servi√ßos AWS em workflows serverless. Usando AWS Step Functions, voc√™ pode projetar e executar workflows que conectam v√°rios servi√ßos AWS, como AWS Lambda, Amazon S3, Amazon DynamoDB e muitos outros, em uma sequ√™ncia de etapas. Este servi√ßo de orquestra√ß√£o fornece uma interface visual de workflow e oferece capacidades de **state machine**, permitindo que voc√™ defina cada etapa do workflow de maneira declarativa usando **Amazon States Language** (ASL) baseada em JSON.

AWS Step Functions simplifica o processo de constru√ß√£o de aplica√ß√µes resilientes e escal√°veis, gerenciando a infraestrutura subjacente, lidando automaticamente com tentativas, erros e processamento paralelo. √â particularmente √∫til para criar workflows complexos envolvendo v√°rias etapas e pontos de decis√£o, pois pode gerenciar facilmente o fluxo de dados e o estado de execu√ß√£o entre servi√ßos. Os principais casos de uso para este servi√ßo s√£o os seguintes:

- **Processamento de dados**: Processamento de arquivos, v√≠deos e imagens; extra√ß√£o, transforma√ß√£o e carga (ETL) de trabalhos; e processamento em lote e cargas de trabalho de Computa√ß√£o de Alto Desempenho (HPC).
- **Machine learning**: Detec√ß√£o de fraude, personaliza√ß√£o, recomenda√ß√£o e enriquecimento de dados.
- **Orquestra√ß√£o de microsservi√ßos**: Workflows s√≠ncronos ou em tempo real e orquestra√ß√£o de cont√™ineres.
- **Automa√ß√£o de TI e seguran√ßa**: Auto-remedia√ß√£o, implanta√ß√£o e resposta; e aprova√ß√£o humana e escalonamento.

## Conceitos chave

### Workflows Padr√£o vs. Express

AWS Step Functions oferece dois tipos de **workflows de state machine**: Padr√£o e Express.

- **Workflow Padr√£o**: Este tipo de workflow padr√£o √© projetado para processos de longa dura√ß√£o, dur√°veis e audit√°veis. Ele suporta **execu√ß√£o exatamente uma vez**, garantindo que as tarefas sejam executadas apenas uma vez, a menos que tentativas sejam especificadas. √â ideal para workflows que precisam de um hist√≥rico de execu√ß√£o detalhado e podem ser executados por at√© um ano.
- **Workflow Express**: Este tipo √© ideal para tarefas de alta volume e curta dura√ß√£o, com execu√ß√£o de at√© cinco minutos. Eles suportam **execu√ß√£o pelo menos uma vez**, adequado para tarefas idempotentes como processamento de dados. Esses workflows s√£o otimizados para custo e desempenho, cobrando com base em execu√ß√µes, dura√ß√£o e uso de mem√≥ria.

### Estados

Estados s√£o as unidades essenciais das state machines. Eles definem as etapas individuais dentro de um workflow, podendo realizar uma variedade de fun√ß√µes dependendo do seu tipo:

- **Task:** Executa um trabalho, frequentemente usando um servi√ßo AWS como Lambda.
- **Choice:** Toma decis√µes com base na entrada.
- **Fail/Succeed:** Termina a execu√ß√£o com falha ou sucesso.
- **Pass:** Passa a entrada para a sa√≠da ou injeta dados.
- **Wait:** Atrasa a execu√ß√£o por um tempo definido.
- **Parallel:** Inicia ramifica√ß√µes paralelas.
- **Map:** Itera dinamicamente etapas sobre itens.

### Task

Um estado **Task** representa uma unidade √∫nica de trabalho executada por uma state machine. Tasks podem invocar v√°rios recursos, incluindo atividades, fun√ß√µes Lambda, servi√ßos AWS ou APIs de terceiros.

- **Activities**: Trabalhadores personalizados que voc√™ gerencia, adequados para processos de longa dura√ß√£o.
- Recurso: **`arn:aws:states:region:account:activity:name`**.
- **Lambda Functions**: Executa fun√ß√µes AWS Lambda.
- Recurso: **`arn:aws:lambda:region:account:function:function-name`**.
- **AWS Services**: Integra diretamente com outros servi√ßos AWS, como DynamoDB ou S3.
- Recurso: **`arn:partition:states:region:account:servicename:APIname`**.
- **HTTP Task**: Chama APIs de terceiros.
- Campo de recurso: **`arn:aws:states:::http:invoke`**. Em seguida, voc√™ deve fornecer os detalhes de configura√ß√£o do endpoint da API, como a URL da API, m√©todo e detalhes de autentica√ß√£o.

O exemplo a seguir mostra uma defini√ß√£o de estado Task que invoca uma fun√ß√£o Lambda chamada HelloWorld:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Choice

Um estado **Choice** adiciona l√≥gica condicional a um fluxo de trabalho, permitindo decis√µes baseadas em dados de entrada. Ele avalia as condi√ß√µes especificadas e transita para o estado correspondente com base nos resultados.

- **Comparison**: Cada regra de escolha inclui um operador de compara√ß√£o (por exemplo, **`NumericEquals`**, **`StringEquals`**) que compara uma vari√°vel de entrada a um valor especificado ou outra vari√°vel.
- **Next Field**: Estados de escolha n√£o suportam o campo **`End`**, em vez disso, definem o estado **`Next`** para transitar se a compara√ß√£o for verdadeira.

Exemplo de estado **Choice**:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Fail/Succeed

Um estado **`Fail`** interrompe a execu√ß√£o de uma m√°quina de estados e a marca como uma falha. Ele √© usado para especificar um nome de erro e uma causa, fornecendo detalhes sobre a falha. Este estado √© terminal, o que significa que ele encerra o fluxo de execu√ß√£o.

Um estado **`Succeed`** interrompe a execu√ß√£o com sucesso. Ele √© tipicamente usado para terminar o fluxo de trabalho quando ele √© conclu√≠do com sucesso. Este estado n√£o requer um campo **`Next`**.

{% tabs %}

{% tab title="Fail example" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Exemplo de Sucesso" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
{% endtab %}

{% endtabs %}

### Pass

Um estado **Pass** passa sua entrada para sua sa√≠da sem realizar nenhum trabalho ou transformando a entrada do estado JSON usando filtros, e ent√£o passando os dados transformados para o pr√≥ximo estado. √â √∫til para testar e construir m√°quinas de estado, permitindo injetar dados est√°ticos ou transform√°-los.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Wait

Um estado **Wait** atrasa a execu√ß√£o da m√°quina de estados por uma dura√ß√£o especificada. Existem tr√™s m√©todos principais para configurar o tempo de espera:

- **X Seconds**: Um n√∫mero fixo de segundos para esperar.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **Absolute Timestamp**: Um tempo exato para esperar at√©.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **Dynamic Wait**: Baseado na entrada usando **`SecondsPath`** ou **`TimestampPath`**.

```json
jsonCopiar c√≥digo
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### Parallel

Um estado **Parallel** permite que voc√™ execute m√∫ltiplos ramos de tarefas simultaneamente dentro do seu fluxo de trabalho. Cada ramo funciona de forma independente e processa sua pr√≥pria sequ√™ncia de estados. A execu√ß√£o espera at√© que todos os ramos sejam conclu√≠dos antes de prosseguir para o pr√≥ximo estado. Seus campos principais s√£o:

- **Branches**: Um array definindo os caminhos de execu√ß√£o paralela. Cada ramo √© uma m√°quina de estados separada.
- **ResultPath**: Define onde (na entrada) colocar a sa√≠da combinada dos ramos.
- **Retry and Catch**: Configura√ß√µes de tratamento de erros para o estado paralelo.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

Um estado **Map** permite a execu√ß√£o de um conjunto de etapas para cada item em um conjunto de dados. √â usado para processamento paralelo de dados. Dependendo de como voc√™ deseja processar os itens do conjunto de dados, o Step Functions fornece os seguintes modos:

- **Inline Mode**: Executa um subconjunto de estados para cada item de matriz JSON. Adequado para tarefas de pequena escala com menos de 40 itera√ß√µes paralelas, executando cada uma delas no contexto do fluxo de trabalho que cont√©m o estado **`Map`**.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Distributed Mode**: Projetado para processamento paralelo em larga escala com alta concorr√™ncia. Suporta o processamento de grandes conjuntos de dados, como aqueles armazenados no Amazon S3, permitindo uma alta concorr√™ncia de at√© 10.000 execu√ß√µes de fluxo de trabalho filho paralelas, executando esses filhos como uma execu√ß√£o filho separada.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Versions and aliases

Step Functions tamb√©m permite gerenciar implanta√ß√µes de fluxo de trabalho por meio de **versions** e **aliases** de m√°quinas de estado. Uma vers√£o representa um instant√¢neo de uma m√°quina de estado que pode ser executada. Aliases servem como ponteiros para at√© duas vers√µes de uma m√°quina de estado.

- **Versions**: Esses instant√¢neos imut√°veis de uma m√°quina de estado s√£o criados a partir da revis√£o mais recente dessa m√°quina de estado. Cada vers√£o √© identificada por um ARN √∫nico que combina o ARN da m√°quina de estado com o n√∫mero da vers√£o, separado por dois pontos (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). As vers√µes n√£o podem ser editadas, mas voc√™ pode atualizar a m√°quina de estado e publicar uma nova vers√£o, ou usar a vers√£o desejada da m√°quina de estado.
- **Aliases**: Esses ponteiros podem referenciar at√© duas vers√µes da mesma m√°quina de estado. V√°rios aliases podem ser criados para uma √∫nica m√°quina de estado, cada um identificado por um ARN √∫nico constru√≠do combinando o ARN da m√°quina de estado com o nome do alias, separado por dois pontos (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Aliases permitem o roteamento de tr√°fego entre uma das duas vers√µes de uma m√°quina de estado. Alternativamente, um alias pode apontar para uma vers√£o espec√≠fica da m√°quina de estado, mas n√£o para outros aliases. Eles podem ser atualizados para redirecionar para uma vers√£o diferente da m√°quina de estado conforme necess√°rio, facilitando implanta√ß√µes controladas e gerenciamento de fluxo de trabalho.

Para mais informa√ß√µes detalhadas sobre **ASL**, consulte: [**Amazon States Language**](https://states-language.net/spec.html).



## IAM Roles for State machines

AWS Step Functions utiliza AWS Identity and Access Management (IAM) roles para controlar o acesso a recursos e a√ß√µes dentro das m√°quinas de estado. Aqui est√£o os principais aspectos relacionados √† seguran√ßa e IAM roles no AWS Step Functions:

- **Execution Role**: Cada m√°quina de estado no AWS Step Functions est√° associada a um IAM execution role. Este role define quais a√ß√µes a m√°quina de estado pode realizar em seu nome. Quando uma m√°quina de estado transita entre estados que interagem com servi√ßos AWS (como invocar fun√ß√µes Lambda, acessar DynamoDB, etc.), ela assume este execution role para realizar essas a√ß√µes.
- **Permissions**: O IAM execution role deve ser configurado com permiss√µes que permitam as a√ß√µes necess√°rias em outros servi√ßos AWS. Por exemplo, se sua m√°quina de estado precisa invocar fun√ß√µes AWS Lambda, o IAM role deve ter permiss√µes **`lambda:InvokeFunction`**. Da mesma forma, se precisar escrever no DynamoDB, permiss√µes apropriadas (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, etc.) devem ser concedidas.
- **Least Privilege**: Recomenda-se seguir o princ√≠pio do menor privil√©gio ao configurar IAM roles para Step Functions. Isso significa conceder apenas as permiss√µes necess√°rias para que a m√°quina de estado execute suas a√ß√µes espec√≠ficas, e nada mais. As pol√≠ticas IAM devem ser limitadas a recursos e a√ß√µes espec√≠ficos, reduzindo o risco de acesso n√£o intencional.

## Enumeration

A pol√≠tica ReadOnlyAccess √© suficiente para todas as seguintes a√ß√µes de enumera√ß√£o.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

Na p√°gina a seguir, voc√™ pode verificar como **abusar das permiss√µes do Step Functions para escalar privil√©gios**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## P√≥s-Explota√ß√£o

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# Refer√™ncias

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no Telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios no GitHub.

</details>
{% endhint %}
