# AWS - Step Functions Enum

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## Step Functions

AWS Step Functions ist ein Workflow-Service, der es Ihnen erm√∂glicht, mehrere AWS-Services in serverlose Workflows zu koordinieren und zu orchestrieren. Durch die Verwendung von AWS Step Functions k√∂nnen Sie Workflows entwerfen und ausf√ºhren, die verschiedene AWS-Services wie AWS Lambda, Amazon S3, Amazon DynamoDB und viele mehr in einer Sequenz von Schritten verbinden. Dieser Orchestrierungsservice bietet eine visuelle Workflow-Benutzeroberfl√§che und bietet **State Machine**-F√§higkeiten, mit denen Sie jeden Schritt des Workflows auf deklarative Weise mithilfe der auf JSON basierenden **Amazon States Language** (ASL) definieren k√∂nnen.

AWS Step Functions vereinfacht den Prozess des Aufbaus robuster und skalierbarer Anwendungen, indem es die zugrunde liegende Infrastruktur verwaltet, Wiederholungen, Fehler und parallele Verarbeitung automatisch behandelt. Es ist besonders n√ºtzlich f√ºr die Erstellung komplexer Workflows, die mehrere Schritte und Entscheidungspunkte umfassen, da es den Datenfluss und den Ausf√ºhrungszustand √ºber die Services hinweg einfach verwalten kann. Die Hauptanwendungsf√§lle, die von diesem Service ausgef√ºhrt werden sollen, sind die folgenden:

- **Datenverarbeitung**: Datei-, Video- und Bildverarbeitung; Extraktion, Transformation und Laden (ETL) von Jobs; und Batch-Verarbeitung und Workloads f√ºr High Performance Computing (HPC).
- **Maschinelles Lernen**: Betrugserkennung, Anpassung, Empfehlung und Datenanreicherung.
- **Microservice-Orchestrierung**: Synchrone oder Echtzeit-Workflows und Container-Orchestrierung.
- **IT- und Sicherheitsautomatisierung**: Auto-Remediation, Bereitstellung und Reaktion; und menschliche Genehmigung und Eskalation.

## Schl√ºsselkonzepte

### Standard- vs. Express-Workflows

AWS Step Functions bietet zwei Arten von **State Machine-Workflows**: Standard und Express.

- **Standard-Workflow**: Dieser Standard-Workflow-Typ ist f√ºr langlaufende, dauerhafte und √ºberpr√ºfbare Prozesse konzipiert. Er unterst√ºtzt **genau einmalige Ausf√ºhrung**, wodurch Aufgaben nur einmal ausgef√ºhrt werden, es sei denn, Wiederholungen sind spezifiziert. Er eignet sich f√ºr Workflows, die eine detaillierte Ausf√ºhrungshistorie ben√∂tigen und bis zu einem Jahr laufen k√∂nnen.
- **Express-Workflow**: Dieser Typ ist ideal f√ºr Aufgaben mit hohem Volumen und kurzer Dauer, die bis zu f√ºnf Minuten dauern. Sie unterst√ºtzen **mindestens einmalige Ausf√ºhrung**, geeignet f√ºr idempotente Aufgaben wie die Datenverarbeitung. Diese Workflows sind auf Kosten und Leistung optimiert und berechnen basierend auf Ausf√ºhrungen, Dauer und Speicherverbrauch.

### Zust√§nde

Zust√§nde sind die wesentlichen Einheiten von State Machines. Sie definieren die einzelnen Schritte innerhalb eines Workflows und k√∂nnen je nach Typ verschiedene Funktionen ausf√ºhren:

- **Task:** F√ºhrt einen Job aus, oft unter Verwendung eines AWS-Dienstes wie Lambda.
- **Choice:** Trifft Entscheidungen basierend auf Eingaben.
- **Fail/Succeed:** Beendet die Ausf√ºhrung mit einem Fehler oder Erfolg.
- **Pass:** Gibt Eingabe an Ausgabe weiter oder f√ºgt Daten ein.
- **Wait:** Verz√∂gert die Ausf√ºhrung f√ºr eine festgelegte Zeit.
- **Parallel:** Initiiert parallele Zweige.
- **Map:** Iteriert dynamisch √ºber Elemente.

### Task

Ein **Task**-Zustand repr√§sentiert eine einzelne Arbeitseinheit, die von einer State Machine ausgef√ºhrt wird. Tasks k√∂nnen verschiedene Ressourcen aufrufen, einschlie√ülich Aktivit√§ten, Lambda-Funktionen, AWS-Services oder APIs von Drittanbietern.

- **Aktivit√§ten**: Benutzerdefinierte Worker, die Sie verwalten, geeignet f√ºr langlaufende Prozesse.
- Ressource: **`arn:aws:states:region:account:activity:name`**.
- **Lambda-Funktionen**: F√ºhrt AWS Lambda-Funktionen aus.
- Ressource: **`arn:aws:lambda:region:account:function:function-name`**.
- **AWS-Services**: Integriert sich direkt mit anderen AWS-Services wie DynamoDB oder S3.
- Ressource: **`arn:partition:states:region:account:servicename:APIname`**.
- **HTTP-Aufgabe**: Ruft APIs von Drittanbietern auf.
- Feld Ressource: **`arn:aws:states:::http:invoke`**. Anschlie√üend sollten Sie die Konfigurationsdetails des API-Endpunkts angeben, wie die API-URL, Methode und¬†Authentifizierungsdetails.

Das folgende Beispiel zeigt eine Task-Zustandsdefinition, die eine Lambda-Funktion namens HelloWorld aufruft:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Auswahl

Ein **Choice**-Zustand f√ºgt einem Workflow bedingte Logik hinzu, die Entscheidungen basierend auf Eingabedaten erm√∂glicht. Er bewertet die angegebenen Bedingungen und wechselt basierend auf den Ergebnissen in den entsprechenden Zustand.

- **Vergleich**: Jede Auswahregel enth√§lt einen Vergleichsoperator (z. B. **`NumericEquals`**, **`StringEquals`**), der eine Eingabegr√∂√üe mit einem angegebenen Wert oder einer anderen Gr√∂√üe vergleicht.
- **N√§chstes Feld**: Choice-Zust√§nde unterst√ºtzen nicht das Feld **`End`**, stattdessen definieren sie den **`Next`**-Zustand, zu dem gewechselt wird, wenn der Vergleich wahr ist.

Beispiel des **Choice**-Zustands:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Scheitern/Erfolg

Ein **`Fail`**-Zustand stoppt die Ausf√ºhrung einer State Machine und kennzeichnet sie als fehlgeschlagen. Er wird verwendet, um einen Fehlername und eine Ursache anzugeben und Details √ºber das Versagen bereitzustellen. Dieser Zustand ist terminal, was bedeutet, dass er den Ausf√ºhrungsfluss beendet.

Ein **`Succeed`**-Zustand stoppt die Ausf√ºhrung erfolgreich. Er wird typischerweise verwendet, um den Workflow zu beenden, wenn er erfolgreich abgeschlossen wurde. Dieser Zustand erfordert kein **`Next`**-Feld.

{% tabs %}

{% tab title="Fail-Beispiel" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Erfolgsbeispiel" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Pass

Ein **Pass**-Zustand gibt seine Eingabe entweder ohne Durchf√ºhrung von Arbeiten oder durch Transformation der JSON-Zustandseingabe mithilfe von Filtern an seine Ausgabe weiter und leitet dann die transformierten Daten an den n√§chsten Zustand weiter. Es ist n√ºtzlich f√ºr Tests und zum Erstellen von Zustandsmaschinen, da es Ihnen erm√∂glicht, statische Daten einzuf√ºgen oder zu transformieren.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Warten

Ein **Warte**-Zustand verz√∂gert die Ausf√ºhrung der State Machine f√ºr eine bestimmte Dauer. Es gibt drei Hauptmethoden, um die Wartezeit zu konfigurieren:

- **X Sekunden**: Eine feste Anzahl von Sekunden zum Warten.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **Absoluter Zeitstempel**: Eine genaue Zeit, bis zu der gewartet werden soll.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **Dynamisches Warten**: Basierend auf Eingaben mit **`SecondsPath`** oder **`TimestampPath`**.

```json
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### Parallel

Ein **Parallel**-Zustand erm√∂glicht es Ihnen, mehrere Zweige von Aufgaben gleichzeitig in Ihrem Workflow auszuf√ºhren. Jeder Zweig l√§uft unabh√§ngig und verarbeitet seine eigene Sequenz von Zust√§nden. Die Ausf√ºhrung wartet, bis alle Zweige abgeschlossen sind, bevor sie zum n√§chsten Zustand √ºbergeht. Seine Schl√ºsselfelder sind:

- **Zweige**: Ein Array, das die parallelen Ausf√ºhrungspfade definiert. Jeder Zweig ist eine separate State Machine.
- **ResultPath**: Definiert, wo (im Eingang) die kombinierte Ausgabe der Zweige platziert werden soll.
- **Retry und Catch**: Fehlerbehandlungskonfigurationen f√ºr den parallelen Zustand.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Karte

Ein **Map**-Zustand erm√∂glicht die Ausf√ºhrung einer Reihe von Schritten f√ºr jedes Element in einem Datensatz. Es wird f√ºr die parallele Verarbeitung von Daten verwendet. Abh√§ngig davon, wie Sie die Elemente des Datensatzes verarbeiten m√∂chten, bietet Step Functions die folgenden Modi:

- **Inline-Modus**: F√ºhrt eine Teilmenge von Zust√§nden f√ºr jedes JSON-Array-Element aus. Geeignet f√ºr Aufgaben im kleinen Ma√üstab mit weniger als 40 parallelen Iterationen, wobei jedes von ihnen im Kontext des Workflows ausgef√ºhrt wird, der den **`Map`**-Zustand enth√§lt.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Verteilter Modus**: Entwickelt f√ºr die parallele Verarbeitung im gro√üen Ma√üstab mit hoher Konkurrenz. Unterst√ºtzt die Verarbeitung gro√üer Datens√§tze, wie sie in Amazon S3 gespeichert sind, und erm√∂glicht eine hohe Konkurrenz von bis zu 10.000 parallelen Kind-Workflow-Ausf√ºhrungen, wobei diese als separate Kindausf√ºhrung ausgef√ºhrt werden.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Versionen und Aliase

Step Functions erm√∂glicht es auch, Workflow-Bereitstellungen durch **Versionen** und **Aliase** von Zustandsmaschinen zu verwalten. Eine Version stellt eine Momentaufnahme einer Zustandsmaschine dar, die ausgef√ºhrt werden kann. Aliase dienen als Zeiger auf bis zu zwei Versionen einer Zustandsmaschine.

- **Versionen**: Diese unver√§nderlichen Momentaufnahmen einer Zustandsmaschine werden aus der neuesten √úberarbeitung dieser Zustandsmaschine erstellt. Jede Version wird durch eine eindeutige ARN identifiziert, die die ARN der Zustandsmaschine mit der Versionsnummer kombiniert, getrennt durch einen Doppelpunkt (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Versionen k√∂nnen nicht bearbeitet werden, aber Sie k√∂nnen die Zustandsmaschine aktualisieren und eine neue Version ver√∂ffentlichen oder die gew√ºnschte Zustandsmaschinenversion verwenden.
- **Aliase**: Diese Zeiger k√∂nnen auf bis zu zwei Versionen derselben Zustandsmaschine verweisen. Es k√∂nnen mehrere Aliase f√ºr eine einzelne Zustandsmaschine erstellt werden, die jeweils durch eine eindeutige ARN identifiziert werden, die die ARN der Zustandsmaschine mit dem Aliasnamen kombiniert, getrennt durch einen Doppelpunkt (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Aliase erm√∂glichen die Weiterleitung des Datenverkehrs zwischen einer der beiden Versionen einer Zustandsmaschine. Alternativ kann ein Alias auf eine bestimmte Version der Zustandsmaschine verweisen, jedoch nicht auf andere Aliase. Sie k√∂nnen aktualisiert werden, um bei Bedarf auf eine andere Version der Zustandsmaschine umzuleiten und kontrollierte Bereitstellungen und Workflow-Management zu erleichtern.

F√ºr weitere detaillierte Informationen zu **ASL**, siehe:¬†[**Amazon States Language**](https://states-language.net/spec.html).



## IAM-Rollen f√ºr Zustandsmaschinen

AWS Step Functions nutzt AWS Identity and Access Management (IAM)-Rollen, um den Zugriff auf Ressourcen und Aktionen innerhalb von Zustandsmaschinen zu steuern. Hier sind die wichtigsten Aspekte in Bezug auf Sicherheit und IAM-Rollen in AWS Step Functions:

- **Ausf√ºhrungsrolle**: Jede Zustandsmaschine in AWS Step Functions ist mit einer IAM-Ausf√ºhrungsrolle verbunden. Diese Rolle definiert, welche Aktionen die Zustandsmaschine in Ihrem Namen ausf√ºhren kann. Wenn eine Zustandsmaschine zwischen Zust√§nden wechselt, die mit AWS-Diensten interagieren (wie das Aufrufen von Lambda-Funktionen, Zugriff auf DynamoDB usw.), √ºbernimmt sie diese Ausf√ºhrungsrolle, um diese Aktionen auszuf√ºhren.
- **Berechtigungen**: Die IAM-Ausf√ºhrungsrolle muss mit Berechtigungen konfiguriert sein, die die erforderlichen Aktionen auf anderen AWS-Diensten erm√∂glichen. Wenn Ihre Zustandsmaschine beispielsweise AWS Lambda-Funktionen aufrufen muss, muss die IAM-Rolle die Berechtigungen **`lambda:InvokeFunction`** haben. Ebenso m√ºssen bei Schreibzugriff auf DynamoDB entsprechende Berechtigungen (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, usw.) gew√§hrt werden.
- **Prinzip des geringsten Privilegs**: Es wird empfohlen, dem Prinzip des geringsten Privilegs zu folgen, wenn IAM-Rollen f√ºr Step Functions konfiguriert werden. Dies bedeutet, nur die f√ºr die spezifischen Aktionen der Zustandsmaschine erforderlichen Berechtigungen zu gew√§hren und nicht mehr. IAM-Richtlinien sollten auf bestimmte Ressourcen und Aktionen beschr√§nkt sein, um das Risiko unbeabsichtigten Zugriffs zu verringern.

## Enumeration

Die ReadOnlyAccess-Richtlinie reicht f√ºr alle folgenden Enumerationsaktionen aus.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Berechtigungserh√∂hung

Auf der folgenden Seite k√∂nnen Sie √ºberpr√ºfen, wie Sie **Step Functions-Berechtigungen missbrauchen, um Berechtigungen zu eskalieren**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Nach der Ausnutzung

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# Referenzen

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Heldenniveau mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
