# AWS - Step Functions Enum

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## Step Functions

AWS Step Functions, birden fazla AWS hizmetini sunucusuz iş akışlarına koordine etmenizi ve düzenlemenizi sağlayan bir iş akışı hizmetidir. AWS Step Functions kullanarak, AWS Lambda, Amazon S3, Amazon DynamoDB ve daha birçok hizmeti adım adım bağlayan iş akışları tasarlayabilir ve çalıştırabilirsiniz. Bu orkestrasyon hizmeti, görsel bir iş akışı arayüzü sağlar ve **durum makinesi** yetenekleri sunar, iş akışının her adımını JSON tabanlı **Amazon States Language** (ASL) kullanarak deklaratif bir şekilde tanımlamanıza olanak tanır.

AWS Step Functions, temel altyapıyı yöneterek, yeniden denemeleri, hataları ve paralel işlemleri otomatik olarak ele alarak dayanıklı ve ölçeklenebilir uygulamalar oluşturma sürecini basitleştirir. Birden fazla adım ve karar noktası içeren karmaşık iş akışları oluşturmak için özellikle kullanışlıdır, çünkü hizmetler arasında veri akışını ve yürütme durumunu kolayca yönetebilir. Bu hizmetin gerçekleştireceği ana kullanım durumları şunlardır:

- **Veri işleme**: Dosya, video ve görüntü işleme; işlerin çıkarılması, dönüştürülmesi ve yüklenmesi (ETL); ve toplu işleme ve yüksek performanslı hesaplama (HPC) iş yükleri.
- **Makine öğrenimi**: Dolandırıcılık tespiti, özelleştirme, öneri ve veri zenginleştirme.
- **Mikro hizmet orkestrasyonu**: Senkron veya gerçek zamanlı iş akışları ve konteyner orkestrasyonu.
- **BT ve güvenlik otomasyonu**: Otomatik düzeltme, dağıtım ve yanıt; ve insan onayı ve yükseltme.

## Anahtar kavramlar

### Standart ve Express İş Akışları

AWS Step Functions, iki tür **durum makinesi iş akışı** sunar: Standart ve Express.

- **Standart İş Akışı**: Bu varsayılan iş akışı türü, uzun süreli, dayanıklı ve denetlenebilir süreçler için tasarlanmıştır. **Tam olarak bir kez yürütme** desteği sunar, görevlerin yalnızca bir kez çalışmasını sağlar, aksi takdirde yeniden denemeler belirtilir. Ayrıntılı yürütme geçmişine ihtiyaç duyan iş akışları için idealdir ve bir yıla kadar çalışabilir.
- **Express İş Akışı**: Bu tür, yüksek hacimli, kısa süreli görevler için idealdir ve beş dakikaya kadar çalışır. **En az bir kez yürütme** desteği sunar, veri işleme gibi idempotent görevler için uygundur. Bu iş akışları, yürütmeler, süre ve bellek kullanımı temelinde ücretlendirilerek maliyet ve performans için optimize edilmiştir.

### Durumlar

Durumlar, durum makinelerinin temel birimleridir. Bir iş akışındaki bireysel adımları tanımlarlar ve türüne bağlı olarak çeşitli işlevler gerçekleştirebilirler:

- **Görev:** Genellikle Lambda gibi bir AWS hizmeti kullanarak bir işi yürütür.
- **Seçim:** Girdiğe dayalı kararlar alır.
- **Başarısız/Başarılı:** Yürütmeyi bir başarısızlık veya başarı ile sonlandırır.
- **Geçiş:** Girdiyi çıktıya geçirir veya veri ekler.
- **Bekleme:** Yürütmeyi belirli bir süre geciktirir.
- **Paralel:** Paralel dallar başlatır.
- **Harita:** Adımları öğeler üzerinde dinamik olarak yinelemeler.

### Görev

Bir **Görev** durumu, bir durum makinesi tarafından yürütülen tek bir iş birimini temsil eder. Görevler, aktiviteler, Lambda işlevleri, AWS hizmetleri veya üçüncü taraf API'ler gibi çeşitli kaynakları çağırabilir.

- **Aktiviteler**: Uzun süreli işlemler için uygun, sizin yönettiğiniz özel işçiler.
- Kaynak: **`arn:aws:states:region:account:activity:name`**.
- **Lambda İşlevleri**: AWS Lambda işlevlerini yürütür.
- Kaynak: **`arn:aws:lambda:region:account:function:function-name`**.
- **AWS Hizmetleri**: DynamoDB veya S3 gibi diğer AWS hizmetleriyle doğrudan entegre olur.
- Kaynak: **`arn:partition:states:region:account:servicename:APIname`**.
- **HTTP Görevi**: Üçüncü taraf API'leri çağırır.
- Kaynak alanı: **`arn:aws:states:::http:invoke`**. Daha sonra, API URL'si, yöntemi ve kimlik doğrulama detayları gibi API uç noktası yapılandırma ayrıntılarını sağlamalısınız.

Aşağıdaki örnek, HelloWorld adlı bir Lambda işlevini çağıran bir Görev durumu tanımını gösterir:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Choice

Bir **Choice** durumu, bir iş akışına koşullu mantık ekler ve girdi verilerine dayalı kararlar alınmasını sağlar. Belirtilen koşulları değerlendirir ve sonuçlara göre ilgili duruma geçiş yapar.

- **Comparison**: Her seçim kuralı, bir girdi değişkenini belirtilen bir değerle veya başka bir değişkenle karşılaştıran bir karşılaştırma operatörü (örneğin, **`NumericEquals`**, **`StringEquals`**) içerir.
- **Next Field**: Choice durumları **`End`** alanını desteklemez, bunun yerine karşılaştırma doğruysa geçiş yapılacak **`Next`** durumunu tanımlar.

**Choice** durumu örneği:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Fail/Succeed

**`Fail`** durumu, bir durum makinesinin yürütülmesini durdurur ve bunu bir hata olarak işaretler. Hata adı ve nedeni belirterek hatanın ayrıntılarını sağlar. Bu durum terminaldir, yani yürütme akışını sonlandırır.

**`Succeed`** durumu, yürütmeyi başarıyla durdurur. Genellikle iş akışı başarıyla tamamlandığında sonlandırmak için kullanılır. Bu durum **`Next`** alanı gerektirmez.

{% tabs %}

{% tab title="Fail example" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Succeed example" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Pass

Bir **Pass** durumu, girişini çıktısına ya herhangi bir iş yapmadan ya da JSON durum girişini filtreler kullanarak dönüştürerek geçirir ve ardından dönüştürülen veriyi bir sonraki duruma iletir. Bu, durum makinelerini test etmek ve oluşturmak için kullanışlıdır, statik veri enjekte etmenize veya veriyi dönüştürmenize olanak tanır.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Wait

**Wait** durumu, durum makinesinin yürütülmesini belirli bir süre geciktirir. Bekleme süresini yapılandırmak için üç ana yöntem vardır:

- **X Seconds**: Beklenecek sabit saniye sayısı.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **Absolute Timestamp**: Beklenecek kesin zaman.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **Dynamic Wait**: **`SecondsPath`** veya **`TimestampPath`** kullanarak girdiye dayalı.

```json
jsonCopiar código
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### Parallel

**Parallel** durumu, iş akışınızda birden fazla görev dalını aynı anda yürütmenize olanak tanır. Her dal bağımsız olarak çalışır ve kendi durum dizisini işler. Yürütme, tüm dallar tamamlanana kadar bekler ve ardından bir sonraki duruma geçer. Anahtar alanları şunlardır:

- **Branches**: Paralel yürütme yollarını tanımlayan bir dizi. Her dal ayrı bir durum makinesidir.
- **ResultPath**: Dalların birleşik çıktısını girdide nereye yerleştireceğini tanımlar.
- **Retry and Catch**: Paralel durum için hata işleme yapılandırmaları.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

**Map** durumu, bir veri kümesindeki her öğe için bir dizi adımın yürütülmesini sağlar. Verilerin paralel işlenmesi için kullanılır. Veri kümesinin öğelerini nasıl işlemek istediğinize bağlı olarak, Step Functions aşağıdaki modları sağlar:

- **Inline Mode**: Her JSON dizi öğesi için bir alt durum kümesini yürütür. 40'tan az paralel yinelemeye sahip küçük ölçekli görevler için uygundur ve her birini **`Map`** durumunu içeren iş akışının bağlamında çalıştırır.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Distributed Mode**: Yüksek eşzamanlılık ile büyük ölçekli paralel işlem için tasarlanmıştır. Amazon S3'te depolananlar gibi büyük veri kümelerini işleme desteği sağlar ve 10.000'e kadar paralel alt iş akışı yürütmesini yüksek eşzamanlılıkla çalıştırır, bu alt yürütmeleri ayrı bir alt yürütme olarak çalıştırır.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Versions and aliases

Step Functions ayrıca durum makinelerinin **versiyonları** ve **takma adları** aracılığıyla iş akışı dağıtımlarını yönetmenizi sağlar. Bir versiyon, yürütülebilen bir durum makinesinin anlık görüntüsünü temsil eder. Takma adlar, bir durum makinesinin iki versiyonuna kadar işaretçi olarak hizmet eder.

- **Versions**: Bu değiştirilemez durum makinesi anlık görüntüleri, o durum makinesinin en son revizyonundan oluşturulur. Her versiyon, durum makinesi ARN'si ile versiyon numarasını iki nokta üst üste ile birleştiren benzersiz bir ARN ile tanımlanır (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Versiyonlar düzenlenemez, ancak durum makinesini güncelleyebilir ve yeni bir versiyon yayınlayabilir veya istenen durum makinesi versiyonunu kullanabilirsiniz.
- **Aliases**: Bu işaretçiler, aynı durum makinesinin iki versiyonuna kadar referans verebilir. Tek bir durum makinesi için birden fazla takma ad oluşturulabilir, her biri durum makinesi ARN'si ile takma ad adını iki nokta üst üste ile birleştirerek oluşturulan benzersiz bir ARN ile tanımlanır (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Takma adlar, bir durum makinesinin iki versiyonundan birine trafik yönlendirmeyi sağlar. Alternatif olarak, bir takma ad, durum makinesinin belirli bir versiyonuna işaret edebilir, ancak diğer takma adlara işaret edemez. Gerektiğinde farklı bir durum makinesi versiyonuna yönlendirmek için güncellenebilirler, kontrollü dağıtımlar ve iş akışı yönetimi sağlarlar.

**ASL** hakkında daha ayrıntılı bilgi için: [**Amazon States Language**](https://states-language.net/spec.html).



## IAM Roles for State machines

AWS Step Functions, durum makineleri içindeki kaynaklara ve eylemlere erişimi kontrol etmek için AWS Identity and Access Management (IAM) rollerini kullanır. AWS Step Functions'da güvenlik ve IAM rolleri ile ilgili temel noktalar şunlardır:

- **Execution Role**: AWS Step Functions'daki her durum makinesi bir IAM yürütme rolü ile ilişkilidir. Bu rol, durum makinesinin sizin adınıza hangi eylemleri gerçekleştirebileceğini tanımlar. Bir durum makinesi, AWS hizmetleriyle etkileşime giren durumlar arasında geçiş yaptığında (Lambda işlevlerini çağırmak, DynamoDB'ye erişmek gibi), bu eylemleri gerçekleştirmek için bu yürütme rolünü üstlenir.
- **Permissions**: IAM yürütme rolü, diğer AWS hizmetlerinde gerekli eylemleri gerçekleştirmeye izin veren izinlerle yapılandırılmalıdır. Örneğin, durum makinenizin AWS Lambda işlevlerini çağırması gerekiyorsa, IAM rolünün **`lambda:InvokeFunction`** izinlerine sahip olması gerekir. Benzer şekilde, DynamoDB'ye yazması gerekiyorsa, uygun izinler (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, vb.) verilmelidir.
- **Least Privilege**: Step Functions için IAM rolleri yapılandırılırken en az ayrıcalık ilkesine uymak önerilir. Bu, durum makinesinin belirli eylemlerini gerçekleştirmesi için gerekli olan izinlerin verilmesi ve daha fazlasının verilmemesi anlamına gelir. IAM politikaları, istenmeyen erişim riskini azaltarak belirli kaynaklara ve eylemlere yönelik olmalıdır.

## Enumeration

Aşağıdaki tüm enumeration eylemleri için ReadOnlyAccess politikası yeterlidir.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

Aşağıdaki sayfada, **Step Functions izinlerini kötüye kullanarak ayrıcalıkları nasıl yükseltebileceğinizi** kontrol edebilirsiniz:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# References

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) **bizi takip edin.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek hacking ipuçlarını paylaşın.

</details>
{% endhint %}
