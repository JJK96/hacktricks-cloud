# AWS - Step Functions Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Step Functions

AWS Step Functions는 여러 AWS 서비스를 서버리스 워크플로로 조정하고 오케스트레이션할 수 있는 워크플로 서비스입니다. AWS Step Functions를 사용하면 AWS Lambda, Amazon S3, Amazon DynamoDB 등 다양한 AWS 서비스를 연결하는 워크플로를 설계하고 실행할 수 있습니다. 이 오케스트레이션 서비스는 시각적 워크플로 인터페이스를 제공하며, JSON 기반의 **Amazon States Language** (ASL)를 사용하여 워크플로의 각 단계를 선언적으로 정의할 수 있는 **상태 기계** 기능을 제공합니다.

AWS Step Functions는 기본 인프라를 관리하고, 재시도, 오류 처리 및 병렬 처리를 자동으로 처리하여 복원력 있고 확장 가능한 애플리케이션을 구축하는 과정을 단순화합니다. 여러 단계와 의사 결정 지점을 포함하는 복잡한 워크플로를 생성하는 데 특히 유용하며, 서비스 간 데이터 흐름과 실행 상태를 쉽게 관리할 수 있습니다. 이 서비스가 수행할 주요 사용 사례는 다음과 같습니다:

- **데이터 처리**: 파일, 비디오 및 이미지 처리; 작업의 추출, 변환 및 로드 (ETL); 배치 처리 및 고성능 컴퓨팅 (HPC) 워크로드.
- **머신 러닝**: 사기 탐지, 맞춤화, 추천 및 데이터 강화.
- **마이크로서비스 오케스트레이션**: 동기식 또는 실시간 워크플로 및 컨테이너 오케스트레이션.
- **IT 및 보안 자동화**: 자동 복구, 배포 및 응답; 인간 승인 및 에스컬레이션.

## 주요 개념

### Standard vs. Express Workflows

AWS Step Functions는 두 가지 유형의 **상태 기계 워크플로**를 제공합니다: Standard와 Express.

- **Standard Workflow**: 이 기본 워크플로 유형은 장기 실행, 내구성 및 감사 가능한 프로세스를 위해 설계되었습니다. **정확히 한 번 실행**을 지원하여 재시도가 지정되지 않는 한 작업이 한 번만 실행되도록 보장합니다. 자세한 실행 기록이 필요한 워크플로에 이상적이며 최대 1년 동안 실행될 수 있습니다.
- **Express Workflow**: 이 유형은 최대 5분 동안 실행되는 고용량, 단기 작업에 이상적입니다. **최소 한 번 실행**을 지원하여 데이터 처리와 같은 멱등 작업에 적합합니다. 이러한 워크플로는 실행, 지속 시간 및 메모리 사용량을 기준으로 비용과 성능을 최적화합니다.

### States

States는 상태 기계의 기본 단위입니다. 워크플로 내의 개별 단계를 정의하며, 유형에 따라 다양한 기능을 수행할 수 있습니다:

- **Task:** 주로 AWS 서비스(Lambda 등)를 사용하여 작업을 실행합니다.
- **Choice:** 입력에 따라 결정을 내립니다.
- **Fail/Succeed:** 실패 또는 성공으로 실행을 종료합니다.
- **Pass:** 입력을 출력으로 전달하거나 데이터를 주입합니다.
- **Wait:** 설정된 시간 동안 실행을 지연시킵니다.
- **Parallel:** 병렬 분기를 시작합니다.
- **Map:** 항목을 통해 단계를 동적으로 반복합니다.

### Task

**Task** 상태는 상태 기계에 의해 실행되는 단일 작업 단위를 나타냅니다. Tasks는 활동, Lambda 함수, AWS 서비스 또는 타사 API를 포함한 다양한 리소스를 호출할 수 있습니다.

- **Activities**: 장기 실행 프로세스에 적합한 사용자 관리 작업자.
- Resource: **`arn:aws:states:region:account:activity:name`**.
- **Lambda Functions**: AWS Lambda 함수를 실행합니다.
- Resource: **`arn:aws:lambda:region:account:function:function-name`**.
- **AWS Services**: DynamoDB 또는 S3와 같은 다른 AWS 서비스와 직접 통합합니다.
- Resource: **`arn:partition:states:region:account:servicename:APIname`**.
- **HTTP Task**: 타사 API를 호출합니다.
- Resource field: **`arn:aws:states:::http:invoke`**. 그런 다음 API URL, 메서드 및 인증 세부 정보와 같은 API 엔드포인트 구성 세부 정보를 제공해야 합니다.

다음 예제는 HelloWorld라는 Lambda 함수를 호출하는 Task 상태 정의를 보여줍니다:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Choice

**Choice** 상태는 입력 데이터에 기반한 결정을 가능하게 하여 워크플로에 조건부 논리를 추가합니다. 지정된 조건을 평가하고 결과에 따라 해당 상태로 전환합니다.

- **Comparison**: 각 선택 규칙에는 입력 변수를 지정된 값 또는 다른 변수와 비교하는 비교 연산자(예: **`NumericEquals`**, **`StringEquals`**)가 포함됩니다.
- **Next Field**: Choice 상태는 **`End`** 필드를 지원하지 않으며, 대신 비교가 참일 경우 전환할 **`Next`** 상태를 정의합니다.

**Choice** 상태의 예:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Fail/Succeed

**`Fail`** 상태는 상태 머신의 실행을 중지하고 실패로 표시합니다. 이는 오류 이름과 원인을 지정하여 실패에 대한 세부 정보를 제공합니다. 이 상태는 종료 상태로, 실행 흐름을 끝냅니다.

**`Succeed`** 상태는 실행을 성공적으로 중지합니다. 일반적으로 워크플로가 성공적으로 완료될 때 종료하는 데 사용됩니다. 이 상태는 **`Next`** 필드를 필요로 하지 않습니다.

{% tabs %}

{% tab title="Fail example" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Succeed example" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
{% endtab %}

{% endtabs %}

### Pass

**Pass** 상태는 작업을 수행하지 않거나 JSON 상태 입력을 필터를 사용하여 변환한 후 입력을 출력으로 전달합니다. 그런 다음 변환된 데이터를 다음 상태로 전달합니다. 이는 상태 머신을 테스트하고 구성하는 데 유용하며, 정적 데이터를 주입하거나 변환할 수 있게 해줍니다.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Wait

**Wait** 상태는 상태 머신의 실행을 지정된 기간 동안 지연시킵니다. 대기 시간을 구성하는 주요 방법은 세 가지가 있습니다:

- **X Seconds**: 고정된 초 단위 대기 시간.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **Absolute Timestamp**: 정확한 대기 시간.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **Dynamic Wait**: **`SecondsPath`** 또는 **`TimestampPath`**를 사용하여 입력에 기반한 대기 시간.

```json
jsonCopiar código
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### Parallel

**Parallel** 상태는 워크플로 내에서 여러 작업 분기를 동시에 실행할 수 있게 합니다. 각 분기는 독립적으로 실행되며 자체 상태 시퀀스를 처리합니다. 모든 분기가 완료될 때까지 실행이 대기한 후 다음 상태로 진행합니다. 주요 필드는 다음과 같습니다:

- **Branches**: 병렬 실행 경로를 정의하는 배열. 각 분기는 별도의 상태 머신입니다.
- **ResultPath**: 분기의 결합된 출력을 입력의 어디에 배치할지 정의합니다.
- **Retry and Catch**: 병렬 상태에 대한 오류 처리 구성.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

**Map** 상태는 데이터셋의 각 항목에 대해 일련의 단계를 실행할 수 있게 합니다. 이는 데이터의 병렬 처리를 위해 사용됩니다. 데이터셋의 항목을 처리하는 방법에 따라 Step Functions는 다음 모드를 제공합니다:

- **Inline Mode**: 각 JSON 배열 항목에 대해 상태의 하위 집합을 실행합니다. 40개 미만의 병렬 반복이 있는 소규모 작업에 적합하며, **`Map`** 상태를 포함하는 워크플로의 컨텍스트에서 각각을 실행합니다.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Distributed Mode**: 높은 동시성을 가진 대규모 병렬 처리를 위해 설계되었습니다. Amazon S3에 저장된 대규모 데이터셋을 처리할 수 있으며, 최대 10,000개의 병렬 자식 워크플로 실행을 지원하여 이 자식을 별도의 자식 실행으로 실행합니다.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Versions and aliases

Step Functions는 상태 머신의 **버전** 및 **별칭**을 통해 워크플로 배포를 관리할 수 있습니다. 버전은 실행할 수 있는 상태 머신의 스냅샷을 나타냅니다. 별칭은 상태 머신의 최대 두 개 버전에 대한 포인터 역할을 합니다.

- **Versions**: 상태 머신의 최신 수정본에서 생성된 불변의 스냅샷입니다. 각 버전은 고유한 ARN으로 식별되며, 상태 머신 ARN과 버전 번호가 콜론(**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**)으로 구분됩니다. 버전은 편집할 수 없지만 상태 머신을 업데이트하고 새 버전을 게시하거나 원하는 상태 머신 버전을 사용할 수 있습니다.
- **Aliases**: 동일한 상태 머신의 최대 두 개 버전을 참조할 수 있는 포인터입니다. 단일 상태 머신에 대해 여러 별칭을 생성할 수 있으며, 각 별칭은 상태 머신 ARN과 별칭 이름이 콜론(**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**)으로 구분된 고유한 ARN으로 식별됩니다. 별칭은 상태 머신의 두 버전 중 하나로 트래픽을 라우팅할 수 있게 합니다. 또는 별칭은 상태 머신의 특정 버전 하나를 가리킬 수 있지만 다른 별칭을 가리킬 수는 없습니다. 필요에 따라 다른 상태 머신 버전으로 리디렉션하도록 업데이트할 수 있어, 제어된 배포 및 워크플로 관리를 용이하게 합니다.

**ASL**에 대한 자세한 정보는 다음을 참조하십시오: [**Amazon States Language**](https://states-language.net/spec.html).



## IAM Roles for State machines

AWS Step Functions는 AWS Identity and Access Management (IAM) 역할을 사용하여 상태 머신 내 리소스 및 작업에 대한 액세스를 제어합니다. AWS Step Functions의 보안 및 IAM 역할과 관련된 주요 측면은 다음과 같습니다:

- **Execution Role**: AWS Step Functions의 각 상태 머신은 IAM 실행 역할과 연결됩니다. 이 역할은 상태 머신이 사용자를 대신하여 수행할 수 있는 작업을 정의합니다. 상태 머신이 AWS 서비스와 상호 작용하는 상태로 전환할 때(예: Lambda 함수 호출, DynamoDB 액세스 등), 이 실행 역할을 가정하여 해당 작업을 수행합니다.
- **Permissions**: IAM 실행 역할은 다른 AWS 서비스에 필요한 작업을 허용하는 권한으로 구성되어야 합니다. 예를 들어, 상태 머신이 AWS Lambda 함수를 호출해야 하는 경우, IAM 역할은 **`lambda:InvokeFunction`** 권한을 가져야 합니다. 마찬가지로, DynamoDB에 쓰기 위해서는 적절한 권한(**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`** 등)이 부여되어야 합니다.
- **Least Privilege**: Step Functions에 대한 IAM 역할을 구성할 때 최소 권한 원칙을 따르는 것이 좋습니다. 이는 상태 머신이 특정 작업을 수행하는 데 필요한 권한만 부여하고 그 이상은 부여하지 않는 것을 의미합니다. IAM 정책은 특정 리소스 및 작업에 범위가 지정되어야 하며, 의도하지 않은 액세스의 위험을 줄입니다.

## Enumeration

다음 나열 작업에 대해 ReadOnlyAccess 정책만으로 충분합니다.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

다음 페이지에서 **Step Functions 권한을 악용하여 권한을 상승시키는 방법**을 확인할 수 있습니다:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# References

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

{% hint style="success" %}
AWS Hacking 배우기 및 연습하기:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking 배우기 및 연습하기: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원하기</summary>

* [**구독 플랜**](https://github.com/sponsors/carlospolop)을 확인하세요!
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**telegram 그룹**](https://t.me/peass)에 가입하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)을 팔로우하세요.
* **PR을 제출하여** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 해킹 트릭을 공유하세요.

</details>
{% endhint %}
