# AWS - Enumerazione Step Functions

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>

## Step Functions

AWS Step Functions √® un servizio di flusso di lavoro che ti consente di coordinare e orchestrare pi√π servizi AWS in flussi di lavoro serverless. Utilizzando AWS Step Functions, puoi progettare ed eseguire flussi di lavoro che collegano vari servizi AWS come AWS Lambda, Amazon S3, Amazon DynamoDB e molti altri, in una sequenza di passaggi. Questo servizio di orchestratura fornisce un'interfaccia visiva per i flussi di lavoro e offre capacit√† di **state machine**, consentendoti di definire ogni passaggio del flusso di lavoro in modo dichiarativo utilizzando il **Amazon States Language** (ASL) basato su JSON.

AWS Step Functions semplifica il processo di costruzione di applicazioni resilienti e scalabili gestendo l'infrastruttura sottostante, gestendo automaticamente i tentativi, gli errori e l'elaborazione parallela. √à particolarmente utile per creare flussi di lavoro complessi che coinvolgono pi√π passaggi e punti decisionali, poich√© pu√≤ gestire facilmente il flusso di dati e lo stato di esecuzione tra i servizi. I principali casi d'uso da eseguire con questo servizio sono i seguenti:

- **Elaborazione dati**: Elaborazione di file, video e immagini; estrazione, trasformazione e caricamento (ETL) di lavori; e lavori di elaborazione batch e di calcolo ad alte prestazioni (HPC).
- **Apprendimento automatico**: Rilevamento frodi, personalizzazione, raccomandazione e arricchimento dati.
- **Orchestrazione di microservizi**: Flussi di lavoro sincroni o in tempo reale e orchestrazione di container.
- **Automazione IT e della sicurezza**: Auto-rimedio, distribuzione e risposta; e approvazione umana e escalation.

## Concetti chiave

### Flussi di lavoro Standard vs. Express

AWS Step Functions offre due tipi di **flussi di lavoro state machine**: Standard ed Express.

- **Flusso di lavoro Standard**: Questo tipo di flusso di lavoro predefinito √® progettato per processi di lunga durata, durevoli e verificabili. Supporta l'**esecuzione esattamente una volta**, garantendo che i compiti vengano eseguiti solo una volta a meno che non siano specificati i tentativi di ripetizione. √à ideale per flussi di lavoro che necessitano di una cronologia dettagliata dell'esecuzione e pu√≤ durare fino a un anno.
- **Flusso di lavoro Express**: Questo tipo √® ideale per attivit√† ad alta frequenza e di breve durata, con una durata massima di cinque minuti. Supportano l'**esecuzione almeno una volta**, adatti per compiti idempotenti come l'elaborazione dati. Questi flussi di lavoro sono ottimizzati per costo e prestazioni, addebitando in base alle esecuzioni, alla durata e all'uso della memoria.

### Stati

Gli Stati sono le unit√† essenziali delle state machine. Definiscono i singoli passaggi all'interno di un flusso di lavoro, potendo svolgere una variet√† di funzioni a seconda del tipo:

- **Task:** Esegue un lavoro, spesso utilizzando un servizio AWS come Lambda.
- **Choice:** Prende decisioni in base all'input.
- **Fail/Succeed:** Conclude l'esecuzione con un fallimento o un successo.
- **Pass:** Passa l'input all'output o inietta dati.
- **Wait:** Ritarda l'esecuzione per un tempo impostato.
- **Parallel:** Avvia rami paralleli.
- **Map:** Itera dinamicamente i passaggi su elementi.

### Task

Uno stato **Task** rappresenta un'unit√† di lavoro singola eseguita da una state machine. I Task possono invocare vari tipi di risorse, inclusi attivit√†, funzioni Lambda, servizi AWS o API di terze parti.

- **Attivit√†**: Lavoratori personalizzati che gestisci, adatti per processi a lunga durata.
- Risorsa: **`arn:aws:states:region:account:activity:name`**.
- **Funzioni Lambda**: Esegue funzioni Lambda di AWS.
- Risorsa: **`arn:aws:lambda:region:account:function:function-name`**.
- **Servizi AWS**: Si integra direttamente con altri servizi AWS, come DynamoDB o S3.
- Risorsa: **`arn:partition:states:region:account:servicename:APIname`**.
- **Task HTTP**: Chiama API di terze parti.
- Campo risorsa: **`arn:aws:states:::http:invoke`**. Successivamente, √® necessario fornire i dettagli di configurazione dell'endpoint API, come l'URL dell'API, il metodo e i dettagli di autenticazione.

Nell'esempio seguente viene mostrata la definizione di uno stato Task che invoca una funzione Lambda chiamata HelloWorld:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Scelta

Uno stato di **Scelta** aggiunge logica condizionale a un flusso di lavoro, consentendo decisioni basate sui dati in ingresso. Valuta le condizioni specificate e transita allo stato corrispondente in base ai risultati.

- **Confronto**: Ogni regola di scelta include un operatore di confronto (ad esempio, **`NumericEquals`**, **`StringEquals`**) che confronta una variabile di input con un valore specificato o un'altra variabile.
- **Campo Successivo**: Gli stati di scelta non supportano il campo **`End`**, invece definiscono lo stato **`Next`** a cui transire se il confronto √® vero.

Esempio di stato di **Scelta**:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Fallimento/Successo

Uno stato **`Fallimento`** interrompe l'esecuzione di una macchina a stati e la contrassegna come fallita. Viene utilizzato per specificare un nome di errore e una causa, fornendo dettagli sul fallimento. Questo stato √® terminale, il che significa che interrompe il flusso di esecuzione.

Uno stato **`Successo`** interrompe l'esecuzione con successo. Viene tipicamente utilizzato per terminare il flusso di lavoro quando viene completato con successo. Questo stato non richiede un campo **`Successivo`**.

{% tabs %}

{% tab title="Esempio di fallimento" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Esempio di successo" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Pass

Uno stato **Pass** passa il suo input al suo output senza eseguire alcun lavoro o trasformare l'input dello stato JSON utilizzando filtri, e quindi passando i dati trasformati allo stato successivo. √à utile per testare e costruire macchine a stati, consentendoti di iniettare dati statici o trasformarli.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Attesa

Uno stato di **Attesa** ritarda l'esecuzione della macchina a stati per una durata specificata. Ci sono tre metodi principali per configurare il tempo di attesa:

- **X Secondi**: Un numero fisso di secondi da attendere.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "ProssimoStato"
}
```

- **Timestamp Assoluto**: Un momento esatto in cui attendere.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "ProssimoStato"
}
```

- **Attesa Dinamica**: Basata sull'input utilizzando **`SecondsPath`** o **`TimestampPath`**.

```json
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "ProssimoStato"
}
```


### Parallelo

Uno stato **Parallelo** ti consente di eseguire pi√π rami di attivit√† contemporaneamente all'interno del tuo flusso di lavoro. Ogni ramo viene eseguito indipendentemente e elabora la propria sequenza di stati. L'esecuzione attende fino al completamento di tutti i rami prima di procedere allo stato successivo. I suoi campi chiave sono:

- **Rami**: Un array che definisce i percorsi di esecuzione parallela. Ogni ramo √® una macchina a stati separata.
- **ResultPath**: Definisce dove (nell'input) inserire l'output combinato dei rami.
- **Riprova e Cattura**: Configurazioni di gestione degli errori per lo stato parallelo.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Mappa

Uno stato **Mappa** consente l'esecuzione di un insieme di passaggi per ciascun elemento in un insieme di dati. Viene utilizzato per il processamento parallelo dei dati. A seconda di come si desidera elaborare gli elementi dell'insieme di dati, Step Functions fornisce le seguenti modalit√†:

- **Modalit√† Inline**: Esegue un sottoinsieme di stati per ciascun elemento dell'array JSON. Adatto per attivit√† su piccola scala con meno di 40 iterazioni parallele, eseguendo ciascuna di esse nel contesto del flusso di lavoro che contiene lo stato¬†**`Map`**.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Modalit√† Distribuita**: Progettata per il processamento parallelo su larga scala con un'elevata concorrenza. Supporta l'elaborazione di grandi set di dati, come quelli memorizzati in Amazon S3, consentendo un'elevata concorrenza fino a 10.000 esecuzioni parallele di flussi di lavoro figlio, eseguendo questi figli come esecuzione figlio separata.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Versioni e alias

Step Functions consente anche di gestire le distribuzioni dei flussi di lavoro tramite **versioni** e **alias** delle macchine a stati. Una versione rappresenta uno snapshot di una macchina a stati che pu√≤ essere eseguita. Gli alias fungono da puntatori per un massimo di due versioni di una macchina a stati.

- **Versioni**: Questi snapshot immutabili di una macchina a stati vengono creati dalla revisione pi√π recente di quella macchina a stati. Ogni versione √® identificata da un ARN univoco che combina l'ARN della macchina a stati con il numero di versione, separati da due punti (**`arn:aws:states:region:account-id:stateMachine:NomeMacchinaStati:numeroversione`**). Le versioni non possono essere modificate, ma √® possibile aggiornare la macchina a stati e pubblicare una nuova versione, o utilizzare la versione desiderata della macchina a stati.
- **Alias**: Questi puntatori possono fare riferimento a un massimo di due versioni della stessa macchina a stati. Possono essere creati pi√π alias per una singola macchina a stati, ciascuno identificato da un ARN univoco costruito combinando l'ARN della macchina a stati con il nome dell'alias, separati da due punti (**`arn:aws:states:region:account-id:stateMachine:NomeMacchinaStati:nomealias`**). Gli alias consentono il routing del traffico tra una delle due versioni di una macchina a stati. In alternativa, un alias pu√≤ puntare a una specifica versione della macchina a stati, ma non ad altri alias. Possono essere aggiornati per reindirizzare verso una diversa versione della macchina a stati secondo necessit√†, facilitando le distribuzioni controllate e la gestione dei flussi di lavoro.

Per ulteriori informazioni dettagliate su **ASL**, controlla:¬†[**Amazon States Language**](https://states-language.net/spec.html).



## Ruoli IAM per le macchine a stati

AWS Step Functions utilizza i ruoli di Identity and Access Management (IAM) di AWS per controllare l'accesso alle risorse e alle azioni all'interno delle macchine a stati. Ecco gli aspetti chiave relativi alla sicurezza e ai ruoli IAM in AWS Step Functions:

- **Ruolo di esecuzione**: Ogni macchina a stati in AWS Step Functions √® associata a un ruolo di esecuzione IAM. Questo ruolo definisce quali azioni la macchina a stati pu√≤ eseguire per conto tuo. Quando una macchina a stati transita tra stati che interagiscono con i servizi AWS (come l'invocazione di funzioni Lambda, l'accesso a DynamoDB, ecc.), assume questo ruolo di esecuzione per effettuare tali azioni.
- **Autorizzazioni**: Il ruolo di esecuzione IAM deve essere configurato con le autorizzazioni che consentono le azioni necessarie su altri servizi AWS. Ad esempio, se la tua macchina a stati deve invocare funzioni Lambda di AWS, il ruolo IAM deve avere le autorizzazioni **`lambda:InvokeFunction`**. Allo stesso modo, se deve scrivere su DynamoDB, devono essere concesse le autorizzazioni appropriate (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, ecc.).
- **Principio del privilegio minimo**: Si consiglia di seguire il principio del privilegio minimo nella configurazione dei ruoli IAM per Step Functions. Ci√≤ significa concedere solo le autorizzazioni necessarie affinch√© la macchina a stati possa eseguire le sue azioni specifiche, e non di pi√π. Le policy IAM dovrebbero essere limitate a risorse e azioni specifiche, riducendo il rischio di accessi non intenzionali.

## Enumerazione

La policy ReadOnlyAccess √® sufficiente per tutte le seguenti azioni di enumerazione.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

Nella seguente pagina, puoi controllare come **abusare delle autorizzazioni delle Step Functions per escalare i privilegi**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# References

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
