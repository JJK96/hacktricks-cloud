# AWS - Step Functions Enum

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Step Functions

AWS Step Functions je usluga za radne tokove koja vam omogućava koordinaciju i orkestraciju više AWS usluga u serverless radne tokove. Korišćenjem AWS Step Functions, možete dizajnirati i pokretati radne tokove koji povezuju različite AWS usluge kao što su AWS Lambda, Amazon S3, Amazon DynamoDB i mnoge druge, u nizu koraka. Ova orkestraciona usluga pruža vizuelni interfejs za radne tokove i nudi **state machine** mogućnosti, omogućavajući vam da definišete svaki korak radnog toka na deklarativan način koristeći JSON-bazirani **Amazon States Language** (ASL).

AWS Step Functions pojednostavljuje proces izgradnje otpornih i skalabilnih aplikacija upravljanjem osnovnom infrastrukturom, automatskim rukovanjem ponovnim pokušajima, greškama i paralelnom obradom. Posebno je korisna za kreiranje složenih radnih tokova koji uključuju više koraka i tačaka odluke, jer lako može upravljati tokom podataka i stanjem izvršenja između usluga. Glavni slučajevi upotrebe ove usluge su sledeći:

- **Obrada podataka**: Obrada fajlova, video i slika; ekstrakcija, transformacija i učitavanje (ETL) poslova; i Batch obrada i radna opterećenja visokih performansi (HPC).
- **Mašinsko učenje**: Otkrivanje prevara, prilagođavanje, preporuke i obogaćivanje podataka.
- **Orkestracija mikroservisa**: Sinhroni ili real-time radni tokovi i orkestracija kontejnera.
- **IT i sigurnosna automatizacija**: Auto-remedijacija, implementacija i odgovor; i ljudsko odobrenje i eskalacija.

## Ključni koncepti

### Standardni vs. Express Workflows

AWS Step Functions nudi dve vrste **state machine workflows**: Standard i Express.

- **Standard Workflow**: Ova podrazumevana vrsta radnog toka je dizajnirana za dugotrajne, trajne i revizorske procese. Podržava **tačno-jednom izvršenje**, osiguravajući da se zadaci izvršavaju samo jednom osim ako nisu specificirani ponovni pokušaji. Idealna je za radne tokove kojima je potrebna detaljna istorija izvršenja i može trajati do jedne godine.
- **Express Workflow**: Ova vrsta je idealna za zadatke visokog obima i kratkog trajanja, koji traju do pet minuta. Podržavaju **najmanje-jednom izvršenje**, pogodno za idempotentne zadatke kao što je obrada podataka. Ovi radni tokovi su optimizovani za troškove i performanse, naplaćujući se na osnovu izvršenja, trajanja i korišćenja memorije.

### States

States su osnovne jedinice state machines. Definišu pojedinačne korake unutar radnog toka, i mogu obavljati razne funkcije u zavisnosti od tipa:

- **Task:** Izvršava posao, često koristeći AWS uslugu kao što je Lambda.
- **Choice:** Donosi odluke na osnovu ulaza.
- **Fail/Succeed:** Završava izvršenje sa greškom ili uspehom.
- **Pass:** Prosleđuje ulaz na izlaz ili ubacuje podatke.
- **Wait:** Odlaže izvršenje na određeno vreme.
- **Parallel:** Pokreće paralelne grane.
- **Map:** Dinamički iterira korake preko stavki.

### Task

**Task** state predstavlja jednu jedinicu rada koju izvršava state machine. Zadaci mogu pozivati različite resurse, uključujući aktivnosti, Lambda funkcije, AWS usluge ili treće strane API-je.

- **Activities**: Prilagođeni radnici koje vi upravljate, pogodni za dugotrajne procese.
- Resource: **`arn:aws:states:region:account:activity:name`**.
- **Lambda Functions**: Izvršava AWS Lambda funkcije.
- Resource: **`arn:aws:lambda:region:account:function:function-name`**.
- **AWS Services**: Direktno se integriše sa drugim AWS uslugama, kao što su DynamoDB ili S3.
- Resource: **`arn:partition:states:region:account:servicename:APIname`**.
- **HTTP Task**: Poziva API-je trećih strana.
- Resource field: **`arn:aws:states:::http:invoke`**. Zatim, treba da obezbedite detalje konfiguracije API endpoint-a, kao što su API URL, metoda i detalji autentifikacije.

Sledeći primer prikazuje definiciju Task state-a koja poziva Lambda funkciju pod nazivom HelloWorld:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Choice

**Choice** stanje dodaje uslovnu logiku u workflow, omogućavajući odluke zasnovane na ulaznim podacima. Evaluira specificirane uslove i prelazi u odgovarajuće stanje na osnovu rezultata.

- **Poređenje**: Svako pravilo izbora uključuje operator poređenja (npr. **`NumericEquals`**, **`StringEquals`**) koji poredi ulaznu varijablu sa specificiranom vrednošću ili drugom varijablom.
- **Next Field**: Choice stanja ne podržavaju **`End`** polje, umesto toga definišu **`Next`** stanje u koje prelaze ako je poređenje tačno.

Primer **Choice** stanja:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Fail/Succeed

**`Fail`** stanje zaustavlja izvršavanje state machine-a i označava ga kao neuspeh. Koristi se za specificiranje imena greške i uzroka, pružajući detalje o neuspehu. Ovo stanje je terminalno, što znači da završava tok izvršavanja.

**`Succeed`** stanje zaustavlja izvršavanje uspešno. Obično se koristi za završavanje workflow-a kada se uspešno završi. Ovo stanje ne zahteva **`Next`** polje.

{% tabs %}

{% tab title="Fail example" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Succeed example" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Pass

**Pass** stanje prosleđuje svoj ulaz svom izlazu bilo bez obavljanja bilo kakvog posla ili transformišući JSON stanje ulaza koristeći filtere, a zatim prosleđuje transformisane podatke sledećem stanju. Korisno je za testiranje i konstruisanje mašina stanja, omogućavajući vam da ubacite statičke podatke ili ih transformišete.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Wait

**Wait** stanje odlaže izvršenje mašine stanja za određeno trajanje. Postoje tri glavna načina za podešavanje vremena čekanja:

- **X Sekundi**: Fiksni broj sekundi za čekanje.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **Apsolutna Vremenska Oznaka**: Tačno vreme do kojeg se čeka.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **Dinamičko Čekanje**: Na osnovu ulaza koristeći **`SecondsPath`** ili **`TimestampPath`**.

```json
jsonCopiar código
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### Parallel

**Parallel** stanje omogućava izvršavanje više grana zadataka istovremeno unutar vašeg workflow-a. Svaka grana radi nezavisno i obrađuje svoj sopstveni niz stanja. Izvršenje čeka dok sve grane ne završe pre nego što pređe na sledeće stanje. Njegova ključna polja su:

- **Branches**: Niz koji definiše paralelne putanje izvršenja. Svaka grana je zasebna mašina stanja.
- **ResultPath**: Definiše gde (u ulazu) da se postavi kombinovani izlaz grana.
- **Retry and Catch**: Konfiguracije za rukovanje greškama za paralelno stanje.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

**Map** stanje omogućava izvršavanje skupa koraka za svaki element u dataset-u. Koristi se za paralelnu obradu podataka. U zavisnosti od načina na koji želite da obradite stavke dataset-a, Step Functions pruža sledeće režime:

- **Inline Mode**: Izvršava podskup stanja za svaki JSON niz element. Pogodan za zadatke malog obima sa manje od 40 paralelnih iteracija, pri čemu se svaka od njih izvršava u kontekstu workflow-a koji sadrži **`Map`** stanje.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Distributed Mode**: Dizajniran za paralelnu obradu velikog obima sa visokom konkurentnošću. Podržava obradu velikih dataset-ova, kao što su oni skladišteni u Amazon S3, omogućavajući visoku konkurentnost do 10,000 paralelnih child workflow izvršenja, pri čemu se ova child izvršenja pokreću kao zasebna child izvršenja.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Versions and aliases

Step Functions takođe omogućava upravljanje workflow deployment-ima kroz **versions** i **aliases** state mašina. Verzija predstavlja snapshot state mašine koji može biti izvršen. Alias-i služe kao pokazivači na do dve verzije state mašine.

- **Versions**: Ove nepromenljive snapshot-e state mašine kreiraju se iz najnovije revizije te state mašine. Svaka verzija je identifikovana jedinstvenim ARN-om koji kombinuje ARN state mašine sa brojem verzije, odvojenim dvotačkom (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Verzije ne mogu biti uređivane, ali možete ažurirati state mašinu i objaviti novu verziju, ili koristiti željenu verziju state mašine.
- **Aliases**: Ovi pokazivači mogu referencirati do dve verzije iste state mašine. Više alias-a može biti kreirano za jednu state mašinu, svaki identifikovan jedinstvenim ARN-om konstruisanim kombinovanjem ARN-a state mašine sa imenom alias-a, odvojenim dvotačkom (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Alias-i omogućavaju usmeravanje saobraćaja između jedne od dve verzije state mašine. Alternativno, alias može pokazivati na jednu specifičnu verziju state mašine, ali ne i na druge alias-e. Mogu se ažurirati da preusmere na drugu verziju state mašine po potrebi, olakšavajući kontrolisane deployment-e i upravljanje workflow-om.

Za detaljnije informacije o **ASL**, pogledajte: [**Amazon States Language**](https://states-language.net/spec.html).



## IAM Roles for State machines

AWS Step Functions koristi AWS Identity and Access Management (IAM) role za kontrolu pristupa resursima i akcijama unutar state mašina. Evo ključnih aspekata vezanih za sigurnost i IAM role u AWS Step Functions:

- **Execution Role**: Svaka state mašina u AWS Step Functions je povezana sa IAM execution rolom. Ova rola definiše koje akcije state mašina može izvršavati u vaše ime. Kada state mašina prelazi između stanja koja interaguju sa AWS servisima (kao što je pozivanje Lambda funkcija, pristupanje DynamoDB, itd.), ona preuzima ovu execution rolu da bi izvršila te akcije.
- **Permissions**: IAM execution rola mora biti konfigurisana sa dozvolama koje omogućavaju potrebne akcije na drugim AWS servisima. Na primer, ako vaša state mašina treba da pozove AWS Lambda funkcije, IAM rola mora imati **`lambda:InvokeFunction`** dozvole. Slično, ako treba da piše u DynamoDB, odgovarajuće dozvole (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, itd.) moraju biti dodeljene.
- **Least Privilege**: Preporučuje se da se prati princip najmanjih privilegija prilikom konfigurisanja IAM rola za Step Functions. To znači dodeljivanje samo onih dozvola koje su neophodne za specifične akcije state mašine, i ništa više. IAM politike treba da budu ograničene na specifične resurse i akcije, smanjujući rizik od neplaniranog pristupa.

## Enumeration

ReadOnlyAccess policy je dovoljna za sve sledeće enumeration akcije.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

Na sledećoj stranici možete proveriti kako **zloupotrebiti Step Functions dozvole za eskalaciju privilegija**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# References

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove podnošenjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
