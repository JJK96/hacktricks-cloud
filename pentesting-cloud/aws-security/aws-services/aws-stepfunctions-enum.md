# AWS - Enumeracija koraka

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Koraci

AWS Step Functions je servis za radne tokove koji vam omogućava da koordinirate i orkestrirate više AWS servisa u serverless radne tokove. Korišćenjem AWS Step Functions-a, možete dizajnirati i pokretati radne tokove koji povezuju različite AWS servise poput AWS Lambda, Amazon S3, Amazon DynamoDB i mnoge druge, u nizu koraka. Ovaj servis za orkestraciju pruža vizuelni interfejs radnog toka i nudi mogućnosti **state machine**-a, omogućavajući vam da definišete svaki korak radnog toka na deklarativan način korišćenjem JSON baziranog **Amazon States Language** (ASL).

AWS Step Functions pojednostavljuje proces izgradnje otpornih i skalabilnih aplikacija upravljajući osnovnom infrastrukturom, rukovanjem ponovnim pokušajima, greškama i paralelnom obradom automatski. Posebno je koristan za kreiranje složenih radnih tokova koji uključuju više koraka i tačaka odlučivanja, jer može lako upravljati protokom podataka i stanjem izvršenja preko servisa. Glavni slučajevi upotrebe koji se mogu izvršiti ovim servisom su sledeći:

- **Obrada podataka**: Obrada fajlova, video i slika; ekstrakcija, transformacija i učitavanje (ETL) poslova; i obrada u serijama i radni tereti visokih performansi (HPC).
- **Mašinsko učenje**: Detekcija prevare, prilagođavanje, preporuke i obogaćivanje podataka.
- **Orkestracija mikroservisa**: Sinkroni ili realno-vremenski radni tokovi i orkestracija kontejnera.
- **IT i automatizacija bezbednosti**: Auto-popravka, implementacija i odgovor; i ljudska odobrenja i eskalacija.

## Ključni koncepti

### Standardni vs. Ekspres radni tokovi

AWS Step Functions nudi dva tipa **state machine radnih tokova**: Standardne i Ekspres.

- **Standardni radni tok**: Ovaj podrazumevani tip radnog toka je dizajniran za dugotrajne, trajne i proverljive procese. Podržava **tačno jednom izvršenje**, obezbeđujući da zadaci budu izvršeni samo jednom osim ako nisu navedeni ponovni pokušaji. Idealno je za radne tokove koji zahtevaju detaljnu istoriju izvršenja i mogu se izvršavati do jedne godine.
- **Ekspres radni tok**: Ovaj tip je idealan za zadatke visokog obima i kratkog trajanja, koji se izvršavaju do pet minuta. Podržavaju **barem jednom izvršenje**, pogodni za idempotentne zadatke poput obrade podataka. Ovi radni tokovi su optimizovani za troškove i performanse, naplaćujući se na osnovu izvršenja, trajanja i korišćenja memorije.

### Stanja

Stanja su osnovne jedinice state machine-ova. Definišu pojedinačne korake unutar radnog toka, mogući su da obavljaju različite funkcije u zavisnosti od njihovog tipa:

- **Zadatak:** Izvršava posao, često koristeći AWS servis poput Lambda.
- **Izbor:** Donosi odluke na osnovu ulaza.
- **Neuspeh/Uspelo:** Završava izvršenje sa neuspehom ili uspehom.
- **Prođi:** Prosleđuje ulaz na izlaz ili ubacuje podatke.
- **Čekanje:** Odlaže izvršenje za određeno vreme.
- **Paralelno:** Pokreće paralelne grane.
- **Mapiranje:** Dinamički iterira korake preko stavki.

### Zadatak

Stanje **Zadatak** predstavlja jedinicu posla izvršenu od strane state machine-a. Zadaci mogu pozivati različite resurse, uključujući aktivnosti, Lambda funkcije, AWS servise ili API-je trećih strana.

- **Aktivnosti**: Prilagođeni radnici koje upravljate, pogodni za dugotrajne procese.
- Resurs: **`arn:aws:states:region:account:activity:name`**.
- **Lambda funkcije**: Izvršava AWS Lambda funkcije.
- Resurs: **`arn:aws:lambda:region:account:function:function-name`**.
- **AWS Servisi**: Integrira se direktno sa drugim AWS servisima, poput DynamoDB ili S3.
- Resurs: **`arn:partition:states:region:account:servicename:APIname`**.
- **HTTP Zadatak**: Poziva API-je trećih strana.
- Polje resursa: **`arn:aws:states:::http:invoke`**. Zatim, treba obezbediti detalje konfiguracije API endpointa, kao što su URL API-ja, metoda i detalji za autentifikaciju.

Sledeći primer prikazuje definiciju stanja Zadatak koji poziva Lambda funkciju nazvanu HelloWorld:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Izbor

Stanje **Izbor** dodaje uslovnu logiku u radni tok, omogućavajući odluke zasnovane na ulaznim podacima. Vrednuje navedene uslove i prelazi na odgovarajuće stanje na osnovu rezultata.

- **Poređenje**: Svako pravilo izbora uključuje operator poređenja (npr. **`NumericEquals`**, **`StringEquals`**) koji upoređuje ulaznu promenljivu sa navedenom vrednošću ili drugom promenljivom.
- **Sledeće polje**: Stanja izbora ne podržavaju polje **`End`**, umesto toga, definišu stanje **`Next`** na koje će preći ako je poređenje tačno.

Primer stanja **Izbor**:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Neuspeh/Uspešno

Stanje **`Fail`** zaustavlja izvršavanje mašine stanja i označava ga kao neuspeh. Koristi se za specificiranje imena greške i uzroka, pružajući detalje o neuspehu. Ovo stanje je terminalno, što znači da završava tok izvršavanja.

Stanje **`Succeed`** zaustavlja izvršavanje uspešno. Obično se koristi za završetak radnog toka kada se uspešno završi. Ovo stanje ne zahteva polje **`Next`**.

{% tabs %}

{% tab title="Primer neuspeha" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Primer uspeha" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Prođi

**Prođi** stanje prosleđuje svoj ulaz na izlaz ili bez obavljanja bilo kakvog posla ili transformacije JSON stanja ulaza koristeći filtere, a zatim prosleđuje transformisane podatke sledećem stanju. Korisno je za testiranje i konstruisanje mašina stanja, omogućavajući vam da ubacite statične podatke ili ih transformišete.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Čekaj

**Čekaj** stanje odlaže izvršenje mašine stanja na određeno vreme. Postoje tri osnovna načina za konfigurisanje vremena čekanja:

- **X Sekundi**: Fiksni broj sekundi čekanja.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "SledeceStanje"
}
```

- **Apsolutna Oznaka Vremena**: Tačno vreme čekanja.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "SledeceStanje"
}
```

- **Dinamičko Čekanje**: Bazirano na ulazu korišćenjem **`SecondsPath`** ili **`TimestampPath`**.

```json
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.datumisteka",
"Next": "SledeceStanje"
}
```


### Paralelno

**Paralelno** stanje vam omogućava da izvršite više grana zadataka istovremeno unutar vašeg radnog toka. Svaka grana se izvršava nezavisno i obrađuje svoj sopstveni niz stanja. Izvršenje čeka dok sve grane ne završe pre nego što pređe na sledeće stanje. Ključna polja su:

- **Grane**: Niz koji definiše paralelne izvršne putanje. Svaka grana je zasebna mašina stanja.
- **ResultPath**: Definiše gde (u ulazu) postaviti kombinovani izlaz grana.
- **Retry i Catch**: Konfiguracije za rukovanje greškama za paralelno stanje.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

**Map** stan omogućava izvršavanje skupa koraka za svaku stavku u skupu podataka. Koristi se za paralelno procesiranje podataka. Zavisno od toga kako želite da obradite stavke skupa podataka, Step Functions pruža sledeće režime:

- **Inline Mode**: Izvršava podskup stanja za svaku stavku JSON niza. Pogodno za male zadatke sa manje od 40 paralelnih iteracija, izvršavajući svaku od njih u kontekstu radnog toka koji sadrži **`Map`** stanje.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Distributed Mode**: Namijenjen za paralelno procesiranje velikih razmera sa visokom konkurancijom. Podržava obradu velikih skupova podataka, poput onih smeštenih u Amazon S3, omogućavajući visoku konkuranciju do 10.000 paralelnih izvršavanja podradnih radnih tokova, izvršavajući ove podradne kao zasebno izvršavanje.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Verzije i aliasi

Step Functions takođe omogućavaju upravljanje implementacijama radnih tokova putem **verzija** i **aliasa** stanja mašina. Verzija predstavlja snimak stanja mašine koji se može izvršiti. Alias služi kao pokazivač na do dve verzije stanja mašine.

- **Verzije**: Ovi nepromenljivi snimci stanja mašine kreiraju se iz najnovije revizije te stanja mašine. Svaka verzija identifikovana je jedinstvenim ARN-om koji kombinuje ARN stanja mašine sa brojem verzije, razdvojenih dvotačkom (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Verzije se ne mogu uređivati, ali možete ažurirati stanje mašine i objaviti novu verziju, ili koristiti željenu verziju stanja mašine.
- **Alias**: Ovi pokazivači mogu referencirati do dve verzije iste stanja mašine. Može se kreirati više aliasa za jednu stanje mašine, svaki identifikovan jedinstvenim ARN-om konstruisanim kombinovanjem ARN stanja mašine sa imenom aliasa, razdvojenih dvotačkom (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Alias omogućava usmeravanje saobraćaja između jedne od dve verzije stanja mašine. Alternativno, alias može pokazivati na određenu verziju stanja mašine, ali ne i na druge aliase. Mogu se ažurirati da preusmere na drugu verziju stanja mašine po potrebi, olakšavajući kontrolisane implementacije i upravljanje radnim tokovima.

Za detaljnije informacije o **ASL**, proverite: [**Amazon States Language**](https://states-language.net/spec.html).



## IAM Uloge za Stanje mašina

AWS Step Functions koristi AWS Identity and Access Management (IAM) uloge za kontrolu pristupa resursima i akcijama unutar stanja mašina. Evo ključnih aspekata vezanih za bezbednost i IAM uloge u AWS Step Functions:

- **Izvršna uloga**: Svaka stanje mašine u AWS Step Functions je povezana sa IAM izvršnom ulogom. Ova uloga definiše koje akcije stanje mašine može izvršiti u vaše ime. Kada stanje mašine prelazi između stanja koja interaguju sa AWS uslugama (poput pozivanja Lambda funkcija, pristupanja DynamoDB-u, itd.), preuzima ovu izvršnu ulogu da sprovede te akcije.
- **Dozvole**: IAM izvršna uloga mora biti konfigurisana sa dozvolama koje omogućavaju neophodne akcije na drugim AWS uslugama. Na primer, ako vaša stanje mašina treba da pozove AWS Lambda funkcije, IAM uloga mora imati dozvole **`lambda:InvokeFunction`**. Slično tome, ako treba da piše u DynamoDB, odgovarajuće dozvole (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, itd.) moraju biti dodeljene.
- **Najmanje privilegije**: Preporučuje se da pratite princip najmanjih privilegija prilikom konfigurisanja IAM uloga za Step Functions. To znači dodeljivanje samo dozvola neophodnih za stanje mašine da izvrši svoje specifične akcije, i ništa više. IAM politike treba da budu ograničene na specifične resurse i akcije, smanjujući rizik neželjenog pristupa.

## Enumeracija

ReadOnlyAccess politika je dovoljna za sve navedene akcije enumeracije.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Povišenje privilegija

Na sledećoj stranici možete proveriti kako **zloupotrebiti dozvole Step Functions-a za povišenje privilegija**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post eksploatacija

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# Reference

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
