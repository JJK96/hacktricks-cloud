# AWS - Enumera√ß√£o de Step Functions

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Step Functions

O AWS Step Functions √© um servi√ßo de fluxo de trabalho que permite coordenar e orquestrar v√°rios servi√ßos da AWS em fluxos de trabalho sem servidor. Ao usar o AWS Step Functions, voc√™ pode projetar e executar fluxos de trabalho que conectam v√°rios servi√ßos da AWS, como AWS Lambda, Amazon S3, Amazon DynamoDB e muitos outros, em uma sequ√™ncia de etapas. Este servi√ßo de orquestra√ß√£o fornece uma interface visual de fluxo de trabalho e oferece capacidades de **m√°quina de estados**, permitindo que voc√™ defina cada etapa do fluxo de trabalho de forma declarativa usando a **Linguagem de Estados da Amazon** (ASL) baseada em JSON.

O AWS Step Functions simplifica o processo de constru√ß√£o de aplicativos resilientes e escal√°veis, gerenciando a infraestrutura subjacente, lidando com tentativas, erros e processamento paralelo automaticamente. √â particularmente √∫til para criar fluxos de trabalho complexos envolvendo v√°rias etapas e pontos de decis√£o, pois pode gerenciar facilmente o fluxo de dados e o estado de execu√ß√£o entre os servi√ßos. Os principais casos de uso a serem realizados por este servi√ßo s√£o os seguintes:

- **Processamento de dados**: Processamento de arquivos, v√≠deos e imagens; extra√ß√£o, transforma√ß√£o e carga (ETL) de trabalhos; e processamento em lote e cargas de trabalho de Computa√ß√£o de Alto Desempenho (HPC).
- **Aprendizado de m√°quina**: Detec√ß√£o de fraudes, personaliza√ß√£o, recomenda√ß√£o e enriquecimento de dados.
- **Orquestra√ß√£o de microsservi√ßos**: Fluxos de trabalho s√≠ncronos ou em tempo real e orquestra√ß√£o de cont√™ineres.
- **Automa√ß√£o de TI e seguran√ßa**: Auto-remedia√ß√£o, implanta√ß√£o e resposta; e aprova√ß√£o e escalonamento humanos.

## Conceitos-chave

### Fluxos de Trabalho Padr√£o vs. Expresso

O AWS Step Functions oferece dois tipos de **fluxos de trabalho de m√°quina de estados**: Padr√£o e Expresso.

- **Fluxo de Trabalho Padr√£o**: Este tipo de fluxo de trabalho padr√£o √© projetado para processos duradouros, audit√°veis e de longa dura√ß√£o. Ele suporta **execu√ß√£o exatamente uma vez**, garantindo que as tarefas sejam executadas apenas uma vez, a menos que as tentativas sejam especificadas. √â ideal para fluxos de trabalho que precisam de um hist√≥rico de execu√ß√£o detalhado e pode ser executado por at√© um ano.
- **Fluxo de Trabalho Expresso**: Este tipo √© ideal para tarefas de curta dura√ß√£o e alto volume, com dura√ß√£o de at√© cinco minutos. Eles suportam **execu√ß√£o pelo menos uma vez**, adequado para tarefas idempotentes como processamento de dados. Esses fluxos de trabalho s√£o otimizados para custo e desempenho, cobrando com base em execu√ß√µes, dura√ß√£o e uso de mem√≥ria.

### Estados

Estados s√£o as unidades essenciais das m√°quinas de estados. Eles definem as etapas individuais dentro de um fluxo de trabalho, podendo executar uma variedade de fun√ß√µes dependendo de seu tipo:

- **Tarefa:** Executa um trabalho, frequentemente usando um servi√ßo da AWS como Lambda.
- **Escolha:** Toma decis√µes com base na entrada.
- **Falha/Sucesso:** Encerra a execu√ß√£o com falha ou sucesso.
- **Passagem:** Passa a entrada para a sa√≠da ou injeta dados.
- **Aguardar:** Atrasa a execu√ß√£o por um tempo determinado.
- **Paralelo:** Inicia ramos paralelos.
- **Mapa:** Itera dinamicamente etapas sobre itens.

### Tarefa

Um estado de **Tarefa** representa uma √∫nica unidade de trabalho executada por uma m√°quina de estados. As tarefas podem invocar v√°rios recursos, incluindo atividades, fun√ß√µes Lambda, servi√ßos da AWS ou APIs de terceiros.

- **Atividades**: Trabalhadores personalizados que voc√™ gerencia, adequados para processos de longa dura√ß√£o.
- Recurso: **`arn:aws:states:regi√£o:conta:atividade:nome`**.
- **Fun√ß√µes Lambda**: Executa fun√ß√µes Lambda da AWS.
- Recurso: **`arn:aws:lambda:regi√£o:conta:fun√ß√£o:nome-da-fun√ß√£o`**.
- **Servi√ßos da AWS**: Integra-se diretamente com outros servi√ßos da AWS, como DynamoDB ou S3.
- Recurso: **`arn:parti√ß√£o:estados:regi√£o:conta:nomedoservi√ßo:nomedaAPI`**.
- **Tarefa HTTP**: Chama APIs de terceiros.
- Campo de recurso: **`arn:aws:states:::http:invoke`**. Em seguida, voc√™ deve fornecer os detalhes de configura√ß√£o do endpoint da API, como a URL da API, m√©todo e detalhes de autentica√ß√£o.

O exemplo a seguir mostra uma defini√ß√£o de estado de Tarefa que invoca uma fun√ß√£o Lambda chamada HelloWorld:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Escolha

Um estado de **Escolha** adiciona l√≥gica condicional a um fluxo de trabalho, permitindo decis√µes com base em dados de entrada. Ele avalia as condi√ß√µes especificadas e transita para o estado correspondente com base nos resultados.

- **Compara√ß√£o**: Cada regra de escolha inclui um operador de compara√ß√£o (por exemplo, **`NumericEquals`**, **`StringEquals`**) que compara uma vari√°vel de entrada com um valor especificado ou outra vari√°vel.
- **Campo Pr√≥ximo**: Os estados de escolha n√£o suportam o campo **`End`**, em vez disso, eles definem o estado **`Next`** para transitar se a compara√ß√£o for verdadeira.

Exemplo de estado de **Escolha**:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Falha/Sucesso

Um estado de **`Falha`** interrompe a execu√ß√£o de uma m√°quina de estados e a marca como falha. √â usado para especificar um nome de erro e uma causa, fornecendo detalhes sobre a falha. Este estado √© terminal, o que significa que ele encerra o fluxo de execu√ß√£o.

Um estado de **`Sucesso`** interrompe a execu√ß√£o com sucesso. Geralmente √© usado para encerrar o fluxo de trabalho quando ele √© conclu√≠do com sucesso. Este estado n√£o requer um campo **`Pr√≥ximo`**.

{% tabs %}

{% tab title="Exemplo de Falha" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Exemplo de sucesso" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Pass

Um estado **Pass** passa sua entrada para sua sa√≠da sem realizar nenhum trabalho ou transformar a entrada do estado JSON usando filtros e, em seguida, passando os dados transformados para o pr√≥ximo estado. √â √∫til para testar e construir m√°quinas de estado, permitindo que voc√™ injete dados est√°ticos ou os transforme.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Espera

Um estado de **Espera** atrasa a execu√ß√£o da m√°quina de estados por uma dura√ß√£o especificada. Existem tr√™s m√©todos principais para configurar o tempo de espera:

- **X Segundos**: Um n√∫mero fixo de segundos para esperar.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **Carimbo de Data/Hora Absoluto**: Um momento exato para esperar at√©.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **Espera Din√¢mica**: Com base na entrada usando **`SecondsPath`** ou **`TimestampPath`**.

```json
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### Paralelo

Um estado **Paralelo** permite que voc√™ execute v√°rias ramifica√ß√µes de tarefas simultaneamente dentro do seu fluxo de trabalho. Cada ramifica√ß√£o √© executada de forma independente e processa sua pr√≥pria sequ√™ncia de estados. A execu√ß√£o aguarda at√© que todas as ramifica√ß√µes sejam conclu√≠das antes de prosseguir para o pr√≥ximo estado. Seus principais campos s√£o:

- **Ramos**: Uma matriz que define os caminhos de execu√ß√£o paralela. Cada ramifica√ß√£o √© uma m√°quina de estados separada.
- **ResultPath**: Define onde (na entrada) colocar a sa√≠da combinada das ramifica√ß√µes.
- **Retry e Catch**: Configura√ß√µes de tratamento de erros para o estado paralelo.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

Um estado **Map** permite a execu√ß√£o de um conjunto de etapas para cada item em um conjunto de dados. √â usado para processamento paralelo de dados. Dependendo de como voc√™ deseja processar os itens do conjunto de dados, o Step Functions fornece os seguintes modos:

- **Modo Inline**: Executa um subconjunto de estados para cada item de matriz JSON. Adequado para tarefas em pequena escala com menos de 40 itera√ß√µes paralelas, executando cada uma no contexto do fluxo de trabalho que cont√©m o estado¬†**`Map`**.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Modo Distribu√≠do**: Projetado para processamento paralelo em grande escala com alta concorr√™ncia. Suporta o processamento de grandes conjuntos de dados, como os armazenados no Amazon S3, permitindo uma alta concorr√™ncia de at√© 10.000 execu√ß√µes de fluxo de trabalho filho em paralelo, executando esses filhos como uma execu√ß√£o de filho separada.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Vers√µes e aliases

O Step Functions tamb√©m permite gerenciar implanta√ß√µes de fluxo de trabalho por meio de **vers√µes** e **aliases** de m√°quinas de estado. Uma vers√£o representa um instant√¢neo de uma m√°quina de estado que pode ser executado. Os aliases servem como ponteiros para at√© duas vers√µes de uma m√°quina de estado.

- **Vers√µes**: Esses instant√¢neos imut√°veis de uma m√°quina de estado s√£o criados a partir da revis√£o mais recente dessa m√°quina de estado. Cada vers√£o √© identificada por um ARN √∫nico que combina o ARN da m√°quina de estado com o n√∫mero da vers√£o, separados por dois pontos (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). As vers√µes n√£o podem ser editadas, mas voc√™ pode atualizar a m√°quina de estado e publicar uma nova vers√£o, ou usar a vers√£o desejada da m√°quina de estado.
- **Aliases**: Esses ponteiros podem fazer refer√™ncia a at√© duas vers√µes da mesma m√°quina de estado. M√∫ltiplos aliases podem ser criados para uma √∫nica m√°quina de estado, cada um identificado por um ARN √∫nico constru√≠do combinando o ARN da m√°quina de estado com o nome do alias, separados por dois pontos (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Os aliases permitem o roteamento de tr√°fego entre uma das duas vers√µes de uma m√°quina de estado. Alternativamente, um alias pode apontar para uma vers√£o espec√≠fica da m√°quina de estado, mas n√£o para outros aliases. Eles podem ser atualizados para redirecionar para uma vers√£o diferente da m√°quina de estado conforme necess√°rio, facilitando implanta√ß√µes controladas e gerenciamento de fluxo de trabalho.

Para obter informa√ß√µes mais detalhadas sobre **ASL**, consulte:¬†[**Amazon States Language**](https://states-language.net/spec.html).



## Fun√ß√µes IAM para m√°quinas de estado

O Step Functions da AWS utiliza fun√ß√µes de Identidade e Acesso √† AWS (IAM) para controlar o acesso a recursos e a√ß√µes dentro de m√°quinas de estado. Aqui est√£o os principais aspectos relacionados √† seguran√ßa e fun√ß√µes IAM no Step Functions da AWS:

- **Fun√ß√£o de Execu√ß√£o**: Cada m√°quina de estado no Step Functions da AWS est√° associada a uma fun√ß√£o de execu√ß√£o IAM. Essa fun√ß√£o define quais a√ß√µes a m√°quina de estado pode executar em seu nome. Quando uma m√°quina de estado transita entre estados que interagem com servi√ßos da AWS (como invocar fun√ß√µes Lambda, acessar o DynamoDB, etc.), ela assume essa fun√ß√£o de execu√ß√£o para realizar essas a√ß√µes.
- **Permiss√µes**: A fun√ß√£o de execu√ß√£o IAM deve ser configurada com permiss√µes que permitam as a√ß√µes necess√°rias em outros servi√ßos da AWS. Por exemplo, se sua m√°quina de estado precisa invocar fun√ß√µes Lambda da AWS, a fun√ß√£o IAM deve ter permiss√µes de **`lambda:InvokeFunction`**. Da mesma forma, se ela precisa escrever no DynamoDB, permiss√µes apropriadas (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, etc.) devem ser concedidas.
- **Princ√≠pio do Menor Privil√©gio**: √â recomend√°vel seguir o princ√≠pio do menor privil√©gio ao configurar fun√ß√µes IAM para o Step Functions. Isso significa conceder apenas as permiss√µes necess√°rias para a m√°quina de estado realizar suas a√ß√µes espec√≠ficas e nada mais. As pol√≠ticas IAM devem ser limitadas a recursos e a√ß√µes espec√≠ficas, reduzindo o risco de acesso n√£o intencional.

## Enumera√ß√£o

A pol√≠tica ReadOnlyAccess √© suficiente para todas as seguintes a√ß√µes de enumera√ß√£o.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

Na p√°gina a seguir, voc√™ pode verificar como **abusar das permiss√µes do Step Functions para escalar privil√©gios**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## P√≥s-Explora√ß√£o

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# Refer√™ncias

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
