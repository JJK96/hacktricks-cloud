# AWS - Step Functions Enum

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## Step Functions

AWS Step Functions是一项工作流服务，可让您协调和编排多个AWS服务以构建无服务器工作流。通过使用AWS Step Functions，您可以设计和运行连接各种AWS服务（如AWS Lambda、Amazon S3、Amazon DynamoDB等）的工作流，以一系列步骤的方式进行。这种编排服务提供了可视化工作流界面，并提供**状态机**功能，允许您使用基于JSON的**Amazon States Language**（ASL）以声明性方式定义工作流的每个步骤。

AWS Step Functions通过自动管理基础架构、处理重试、错误和并行处理，简化了构建具有弹性和可伸缩性的应用程序的过程。它特别适用于创建涉及多个步骤和决策点的复杂工作流，因为它可以轻松管理数据流和执行状态跨服务的流动。通过该服务执行的主要用例如下：

- **数据处理**：文件、视频和图像处理；抽取、转换和加载（ETL）作业；批处理和高性能计算（HPC）工作负载。
- **机器学习**：欺诈检测、定制、推荐和数据增强。
- **微服务编排**：同步或实时工作流和容器编排。
- **IT和安全自动化**：自动修复、部署和响应；人工批准和升级。

## 关键概念

### 标准工作流与快速工作流

AWS Step Functions提供两种**状态机工作流**类型：标准和快速。

- **标准工作流**：这种默认工作流类型适用于长时间运行、耐用且可审计的流程。它支持**仅执行一次**，确保任务仅运行一次，除非指定了重试。适用于需要详细执行历史记录且可运行长达一年的工作流。
- **快速工作流**：这种类型适用于高容量、短时间任务，运行时间长达五分钟。它支持**至少执行一次**，适用于幂等任务（如数据处理）。这些工作流针对成本和性能进行了优化，根据执行次数、持续时间和内存使用量收费。

### 状态

状态是状态机的基本单元。它们定义工作流中的各个步骤，可以根据其类型执行各种功能：

- **任务**：执行作业，通常使用AWS服务（如Lambda）。
- **选择**：根据输入进行决策。
- **失败/成功**：以失败或成功结束执行。
- **传递**：将输入传递给输出或注入数据。
- **等待**：延迟执行一段时间。
- **并行**：启动并行分支。
- **映射**：动态迭代项目上的步骤。

### 任务

**任务**状态表示状态机执行的单个工作单元。任务可以调用各种资源，包括活动、Lambda函数、AWS服务或第三方API。

- **活动**：您管理的自定义工作程序，适用于长时间运行的进程。
- 资源：**`arn:aws:states:region:account:activity:name`**。
- **Lambda函数**：执行AWS Lambda函数。
- 资源：**`arn:aws:lambda:region:account:function:function-name`**。
- **AWS服务**：直接与其他AWS服务集成，如DynamoDB或S3。
- 资源：**`arn:partition:states:region:account:servicename:APIname`**。
- **HTTP任务**：调用第三方API。
- 资源字段：**`arn:aws:states:::http:invoke`**。然后，您应提供API端点配置详细信息，如API URL、方法和身份验证详细信息。

以下示例显示了调用名为HelloWorld的Lambda函数的任务状态定义：
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### 选择

**选择**状态为工作流添加了条件逻辑，根据输入数据进行决策。它评估指定的条件，并根据结果转移到相应的状态。

- **比较**：每个选择规则都包括一个比较运算符（例如，**`NumericEquals`**，**`StringEquals`**），用于将输入变量与指定值或另一个变量进行比较。
- **下一个字段**：选择状态不支持**`End`**字段，而是定义了如果比较为真则转移到的**`Next`**状态。

**选择**状态示例：
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### 失败/成功

**`Fail`** 状态会停止状态机的执行并将其标记为失败。它用于指定错误名称和原因，提供有关失败的详细信息。此状态是终端状态，意味着它结束执行流程。

**`Succeed`** 状态会成功地停止执行。通常用于在工作流成功完成时终止工作流程。此状态不需要 **`Next`** 字段。

{% tabs %}

{% tab title="失败示例" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="成功示例" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### 通过

一个**Pass**状态将其输入传递到输出，可以是不执行任何工作，也可以是使用过滤器转换JSON状态输入，然后将转换后的数据传递给下一个状态。它对于测试和构建状态机非常有用，允许您注入静态数据或对其进行转换。
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### 等待

**等待** 状态延迟状态机的执行一段指定的时间。有三种主要方法来配置等待时间：

- **X 秒**: 等待的固定秒数。

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **绝对时间戳**: 等待直到指定的确切时间。

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **动态等待**: 基于输入使用 **`SecondsPath`** 或 **`TimestampPath`**。

```json
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### 并行

**并行** 状态允许您在工作流程中同时执行多个任务分支。每个分支都独立运行并处理自己的状态序列。执行将等待直到所有分支完成后再继续到下一个状态。其关键字段包括：

- **分支**: 定义并行执行路径的数组。每个分支是一个单独的状态机。
- **ResultPath**: 定义将分支的组合输出放置在输入中的位置。
- **重试和捕获**: 并行状态的错误处理配置。
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### 映射

**映射**状态使得可以针对数据集中的每个项目执行一组步骤。它用于数据的并行处理。根据您想要如何处理数据集的项目，Step Functions提供以下模式：

- **内联模式**：为每个JSON数组项目执行一部分状态。适用于具有少于40个并行迭代的小规模任务，每个迭代在包含**`Map`**状态的工作流上下文中运行。

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **分布式模式**：设计用于具有高并发的大规模并行处理。支持处理大型数据集，例如存储在Amazon S3中的数据，实现高达10,000个并行子工作流执行，将这些子工作流作为单独的子执行运行。

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### 版本和别名

Step Functions还允许通过状态机的**版本**和**别名**管理工作流部署。版本表示可以执行的状态机的快照。别名用作指向状态机最多两个版本的指针。

- **版本**：这些不可变的状态机快照是从该状态机的最新修订版创建的。每个版本由唯一的ARN标识，该ARN将状态机ARN与版本号结合在一起，用冒号分隔（**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**）。版本不可编辑，但可以更新状态机并发布新版本，或使用所需的状态机版本。
- **别名**：这些指针可以引用同一状态机的最多两个版本。可以为单个状态机创建多个别名，每个别名由将状态机ARN与别名名称结合在一起构成的唯一ARN标识，用冒号分隔（**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**）。别名使得可以在两个状态机版本中的一个之间路由流量。或者，别名可以指向状态机的特定版本，但不能指向其他别名。可以更新它们以根据需要重定向到状态机的不同版本，促进受控部署和工作流管理。

有关**ASL**的更详细信息，请查看：[**Amazon States Language**](https://states-language.net/spec.html)。



## 用于状态机的IAM角色

AWS Step Functions利用AWS身份和访问管理（IAM）角色来控制状态机内资源和操作的访问。以下是与AWS Step Functions中的安全性和IAM角色相关的关键方面：

- **执行角色**：AWS Step Functions中的每个状态机都与一个IAM执行角色相关联。此角色定义了状态机可以代表您执行的操作。当状态机在与AWS服务交互的状态之间转换时（如调用Lambda函数、访问DynamoDB等），它会假定此执行角色来执行这些操作。
- **权限**：IAM执行角色必须配置具有允许在其他AWS服务上执行必要操作的权限。例如，如果您的状态机需要调用AWS Lambda函数，则IAM角色必须具有**`lambda:InvokeFunction`**权限。同样，如果需要写入DynamoDB，则必须授予适当的权限（**`dynamodb:PutItem`**、**`dynamodb:UpdateItem`**等）。
- **最小权限原则**：建议在为Step Functions配置IAM角色时遵循最小权限原则。这意味着仅授予状态机执行其特定操作所需的权限，而不多余。IAM策略应限定于特定资源和操作，减少意外访问的风险。

## 枚举

ReadOnlyAccess策略足以执行以下所有枚举操作。
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## 提权

在下面的页面中，您可以查看如何**滥用 Step Functions 权限以提升特权**：

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## 后渗透

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# 参考资料

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想看到您的**公司在 HackTricks 中做广告**或**下载 PDF 版本的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** 上关注我们。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
