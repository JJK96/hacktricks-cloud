# AWS - Enumeracja funkcji kroków

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów na GitHubie.

</details>

## Funkcje kroków

AWS Step Functions to usługa przepływu pracy, która umożliwia koordynację i orkiestrację wielu usług AWS w bezserwerowych przepływach pracy. Korzystając z AWS Step Functions, możesz projektować i uruchamiać przepływy pracy łączące różne usługi AWS, takie jak AWS Lambda, Amazon S3, Amazon DynamoDB i wiele innych, w sekwencji kroków. Ta usługa orkiestracji zapewnia wizualny interfejs przepływu pracy i oferuje możliwości **maszyny stanów**, pozwalając zdefiniować każdy krok przepływu pracy w deklaratywny sposób, korzystając z opartego na JSONie **Amazon States Language** (ASL).

AWS Step Functions upraszcza proces budowania odpornych i skalowalnych aplikacji poprzez zarządzanie infrastrukturą, obsługę ponownych prób, błędów i przetwarzanie równoległe automatycznie. Jest szczególnie przydatny do tworzenia złożonych przepływów pracy obejmujących wiele kroków i punktów decyzyjnych, ponieważ łatwo zarządza przepływem danych i stanem wykonania między usługami. Główne przypadki użycia do wykonania przez tę usługę to:

- **Przetwarzanie danych**: Przetwarzanie plików, wideo i obrazów; ekstrakcja, transformacja i ładowanie (ETL) zadań; oraz przetwarzanie wsadowe i obciążenia obliczeniowe o wysokiej wydajności (HPC).
- **Uczenie maszynowe**: Wykrywanie oszustw, dostosowywanie, rekomendacje i wzbogacanie danych.
- **Orkiestracja mikrousług**: Przepływy pracy synchroniczne lub czasu rzeczywistego i orkiestracja kontenerów.
- **Automatyzacja IT i bezpieczeństwa**: Autonaprawa, wdrożenie i reakcja; oraz zatwierdzanie przez człowieka i eskalacja.

## Kluczowe koncepcje

### Przepływy standardowe kontra ekspresowe

AWS Step Functions oferuje dwa rodzaje **przepływów maszyn stanów**: Standardowe i Ekspresowe.

- **Przepływ standardowy**: Ten domyślny typ przepływu pracy jest przeznaczony do długotrwałych, trwałych i audytowalnych procesów. Obsługuje **wykonywanie dokładnie raz**, zapewniając, że zadania są uruchamiane tylko raz, chyba że określono ponowne próby. Jest idealny do przepływów pracy wymagających szczegółowej historii wykonania i może działać przez maksymalnie rok.
- **Przepływ ekspresowy**: Ten typ jest idealny do zadań o dużej objętości i krótkim czasie trwania, działających do pięciu minut. Obsługują **wykonywanie co najmniej raz**, odpowiednie dla zadań idempotentnych, takich jak przetwarzanie danych. Te przepływy pracy są zoptymalizowane pod kątem kosztów i wydajności, naliczając opłaty na podstawie wykonania, czasu trwania i użycia pamięci.

### Stany

Stany są podstawowymi jednostkami maszyn stanów. Definiują one poszczególne kroki w ramach przepływu pracy, mogąc wykonywać różnorodne funkcje w zależności od swojego typu:

- **Zadanie:** Wykonuje zadanie, często korzystając z usługi AWS, takiej jak Lambda.
- **Wybór:** Podejmuje decyzje na podstawie danych wejściowych.
- **Niepowodzenie/Sukces:** Kończy wykonanie z niepowodzeniem lub sukcesem.
- **Przekazanie:** Przekazuje dane wejściowe na dane wyjściowe lub wstrzykuje dane.
- **Oczekiwanie:** Opoznia wykonanie przez określony czas.
- **Równoległe:** Inicjuje równoległe gałęzie.
- **Mapa:** Dynamicznie iteruje kroki nad elementami.

### Zadanie

Stan **Zadanie** reprezentuje pojedynczą jednostkę pracy wykonywaną przez maszynę stanów. Zadania mogą wywoływać różne zasoby, w tym działania, funkcje Lambda, usługi AWS lub interfejsy API stron trzecich.

- **Działania**: Niestandardowe pracowniki, którymi zarządzasz, odpowiednie do procesów długotrwałych.
- Zasób: **`arn:aws:states:region:account:activity:name`**.
- **Funkcje Lambda**: Wykonuje funkcje AWS Lambda.
- Zasób: **`arn:aws:lambda:region:account:function:function-name`**.
- **Usługi AWS**: Integracja bezpośrednia z innymi usługami AWS, takimi jak DynamoDB lub S3.
- Zasób: **`arn:partition:states:region:account:servicename:APIname`**.
- **Zadanie HTTP**: Wywołuje interfejsy API stron trzecich.
- Pole zasobu: **`arn:aws:states:::http:invoke`**. Następnie należy podać szczegóły konfiguracji punktu końcowego API, takie jak URL API, metoda i szczegóły uwierzytelniania.

Poniższy przykład pokazuje definicję stanu Zadania, które wywołuje funkcję Lambda o nazwie HelloWorld:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Wybór

Stan **Wybór** dodaje logikę warunkową do przepływu pracy, umożliwiając podejmowanie decyzji na podstawie danych wejściowych. Ocenia określone warunki i przechodzi do odpowiadającego stanu na podstawie wyników.

- **Porównanie**: Każda reguła wyboru zawiera operator porównania (np. **`NumericEquals`**, **`StringEquals`**), który porównuje zmienną wejściową z określoną wartością lub inną zmienną.
- **Pole Następny**: Stany wyboru nie obsługują pola **`End`**, zamiast tego definiują stan **`Next`**, do którego mają przejść, jeśli porównanie jest prawdziwe.

Przykład stanu **Wybór**:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Niepowodzenie/Sukces

Stan **`Fail`** zatrzymuje wykonywanie maszyny stanów i oznacza ją jako nieudaną. Służy do określenia nazwy błędu i przyczyny, dostarczając szczegółów dotyczących niepowodzenia. Ten stan jest terminalny, co oznacza, że kończy przepływ wykonania.

Stan **`Succeed`** zatrzymuje wykonanie pomyślnie. Zazwyczaj jest używany do zakończenia przepływu pracy, gdy zakończy się pomyślnie. Ten stan nie wymaga pola **`Next`**.

{% tabs %}

{% tab title="Przykład niepowodzenia" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Przykład sukcesu" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Przejście

Stan **Pass** przekazuje swoje wejście na wyjście bez wykonywania żadnej pracy lub transformacji wejścia stanu JSON za pomocą filtrów, a następnie przekazuje przekształcone dane do następnego stanu. Jest przydatny do testowania i konstruowania maszyn stanu, pozwalając wstrzyknąć statyczne dane lub je przekształcić.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Czekaj

Stan **Czekaj** opóźnia wykonanie maszyny stanów przez określony czas. Istnieją trzy podstawowe metody konfiguracji czasu oczekiwania:

- **X Sekund**: Stała liczba sekund oczekiwania.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **Dokładny znacznik czasu**: Dokładny czas oczekiwania.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **Dynamiczne oczekiwanie**: Na podstawie danych wejściowych za pomocą **`SecondsPath`** lub **`TimestampPath`**.

```json
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### Równoległy

Stan **Równoległy** pozwala na jednoczesne wykonywanie wielu gałęzi zadań w ramach twojego przepływu pracy. Każda gałąź działa niezależnie i przetwarza swoją własną sekwencję stanów. Wykonanie czeka, aż wszystkie gałęzie zostaną zakończone, zanim przejdzie do następnego stanu. Jego kluczowe pola to:

- **Gałęzie**: Tablica definiująca równoległe ścieżki wykonania. Każda gałąź to osobna maszyna stanów.
- **ResultPath**: Określa, gdzie (w danych wejściowych) umieścić połączony wynik gałęzi.
- **Ponów i Złap**: Konfiguracje obsługi błędów dla stanu równoległego.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

Stan **Map** umożliwia wykonanie zestawu kroków dla każdego elementu w zbiorze danych. Jest używany do równoległej obróbki danych. W zależności od tego, jak chcesz przetwarzać elementy zbioru danych, Step Functions udostępnia następujące tryby:

- **Tryb wbudowany**: Wykonuje podzbiór stanów dla każdego elementu tablicy JSON. Nadaje się do zadań małej skali z mniej niż 40 równoległymi iteracjami, uruchamiając każdą z nich w kontekście przepływu pracy zawierającego stan **`Map`**.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Tryb rozproszony**: Przeznaczony do równoległej obróbki na dużą skalę z wysoką współbieżnością. Obsługuje przetwarzanie dużych zbiorów danych, takich jak te przechowywane w Amazon S3, umożliwiając wysoką współbieżność do 10 000 równoległych wykonań podrzędnych przepływów pracy, uruchamiając te podrzędne jako osobne wykonania podrzędne.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Wersje i aliasy

Step Functions pozwala również zarządzać wdrożeniami przepływów pracy za pomocą **wersji** i **aliasów** maszyn stanowych. Wersja reprezentuje migawkę maszyny stanowej, która może być wykonana. Aliasy służą jako wskaźniki do maksymalnie dwóch wersji maszyny stanowej.

- **Wersje**: Te niemutowalne migawki maszyny stanowej są tworzone na podstawie najnowszej rewizji tej maszyny stanowej. Każda wersja jest identyfikowana za pomocą unikalnego ARN, który łączy ARN maszyny stanowej z numerem wersji, oddzielonych dwukropkiem (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Wersje nie mogą być edytowane, ale można zaktualizować maszynę stanową i opublikować nową wersję lub użyć żądanej wersji maszyny stanowej.
- **Aliasy**: Te wskaźniki mogą odnosić się do maksymalnie dwóch wersji tej samej maszyny stanowej. Można utworzyć wiele aliasów dla pojedynczej maszyny stanowej, z których każdy jest identyfikowany za pomocą unikalnego ARN skonstruowanego poprzez połączenie ARN maszyny stanowej z nazwą aliasu, oddzielonych dwukropkiem (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Aliasy umożliwiają kierowanie ruchu między jedną z dwóch wersji maszyny stanowej. Alternatywnie, alias może wskazywać na konkretną wersję maszyny stanowej, ale nie na inne aliasy. Mogą być zaktualizowane, aby przekierować do innej wersji maszyny stanowej w razie potrzeby, ułatwiając kontrolowane wdrożenia i zarządzanie przepływami pracy.

Aby uzyskać bardziej szczegółowe informacje na temat **ASL**, sprawdź: [**Amazon States Language**](https://states-language.net/spec.html).



## Role IAM dla maszyn stanowych

AWS Step Functions wykorzystuje role IAM (Identity and Access Management) AWS do kontrolowania dostępu do zasobów i działań w obrębie maszyn stanowych. Oto kluczowe aspekty związane z bezpieczeństwem i rolami IAM w AWS Step Functions:

- **Rola wykonawcza**: Każda maszyna stanowa w AWS Step Functions jest powiązana z rolą wykonawczą IAM. Ta rola definiuje, jakie działania maszyna stanowa może wykonywać w Twoim imieniu. Gdy maszyna stanowa przechodzi między stanami, które oddziałują z usługami AWS (takimi jak wywoływanie funkcji Lambda, dostęp do DynamoDB, itp.), przyjmuje tę rolę wykonawczą, aby wykonać te działania.
- **Uprawnienia**: Rola wykonawcza IAM musi być skonfigurowana z uprawnieniami, które pozwalają na niezbędne działania w innych usługach AWS. Na przykład, jeśli Twoja maszyna stanowa musi wywoływać funkcje AWS Lambda, rola IAM musi mieć uprawnienia **`lambda:InvokeFunction`**. Podobnie, jeśli musi zapisywać w DynamoDB, odpowiednie uprawnienia (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, itp.) muszą być udzielone.
- **Najmniejsze uprawnienia**: Zaleca się stosowanie zasady najmniejszych uprawnień podczas konfigurowania ról IAM dla Step Functions. Oznacza to przyznawanie tylko tych uprawnień, które są niezbędne do wykonania określonych działań przez maszynę stanową, i nie więcej. Polityki IAM powinny być ograniczone do konkretnych zasobów i działań, zmniejszając ryzyko niezamierzonego dostępu.

## Wyliczanie

Polityka ReadOnlyAccess jest wystarczająca do wszystkich poniższych działań wyliczania.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Eskalacja uprawnień

Na następnej stronie możesz sprawdzić, jak **nadużyć uprawnienia Step Functions do eskalacji uprawnień**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Po eksploatacji

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# Odnośniki

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

<details>

<summary><strong>Zdobądź wiedzę na temat hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
