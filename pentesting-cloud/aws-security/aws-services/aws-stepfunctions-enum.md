# AWS - Step Functions Enum

{% hint style="success" %}
Leer en oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer en oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repo's.

</details>
{% endhint %}

## Step Functions

AWS Step Functions is 'n werkvloeidiens wat jou in staat stel om verskeie AWS-dienste te ko√∂rdineer en te orkestreer in bedienerlose werkvloeie. Deur AWS Step Functions te gebruik, kan jy werkvloeie ontwerp en uitvoer wat verskeie AWS-dienste soos AWS Lambda, Amazon S3, Amazon DynamoDB, en vele meer verbind in 'n reeks stappe. Hierdie orkestreringsdiens bied 'n visuele werkvloeikoppelvlak en bied **toestandmasjien**-vermo√´ns, wat jou toelaat om elke stap van die werkvloeie op 'n deklaratiewe wyse te definieer deur JSON-gebaseerde **Amazon States Language** (ASL) te gebruik.

AWS Step Functions vereenvoudig die proses van die bou van veerkragtige en skaalbare toepassings deur die onderliggende infrastruktuur te bestuur, herprobeer, foute en parallelle verwerking outomaties te hanteer. Dit is veral nuttig vir die skep van komplekse werkvloeie wat verskeie stappe en besluitspunte behels, aangesien dit maklik die vloei van data en uitvoeringsstatus oor dienste kan bestuur. Die hoofgebruikgevalle wat deur hierdie diens uitgevoer moet word, is die volgende:

- **Dataverwerking**: L√™er-, video- en beeldverwerking; ekstraksie, transformasie en laai (ETL) van take; en bondelverwerking en ho√´prestasie-rekenaar (HPC) werklading.
- **Masjienleer**: Bedrogopsporing, aanpassing, aanbeveling en data-verryking.
- **Mikrodiens-orkestrasie**: Sinchrone of regstreekse werkvloeie en houer-orkestrasie.
- **IT- en sekuriteitsoutomatisering**: Outomatiese herstel, ontplooiing en reaksie; en menslike goedkeuring en eskalasie.

## Sleutelkonsepte

### Standaard vs. Express Werkvloeie

AWS Step Functions bied twee tipes **toestandmasjien-werkvloeie**: Standaard en Express.

- **Standaard Werkvloeie**: Hierdie standaard werkvloeitipe is ontwerp vir langlopende, duursame en ouditbare prosesse. Dit ondersteun **presies-eenkeer-uitvoering**, wat verseker dat take slegs een keer uitgevoer word, tensy herprobeer gespesifiseer word. Dit is ideaal vir werkvloeie wat gedetailleerde uitvoeringsgeskiedenis benodig en kan tot een jaar duur.
- **Express Werkvloeie**: Hierdie tipe is ideaal vir ho√´volume, kortduur take, wat tot vyf minute duur. Hulle ondersteun **ten minste een keer uitvoering**, geskik vir idempotente take soos dataverwerking. Hierdie werkvloeie is geoptimaliseer vir koste en prestasie, en hef fooie gebaseer op uitvoerings, duur en geheuegebruik.

### Toestande

Toestande is die essensi√´le eenhede van toestandmasjiene. Hulle definieer die individuele stappe binne 'n werkvloeie, wat 'n verskeidenheid funksies kan uitvoer, afhangende van die tipe:

- **Taak:** Voer 'n taak uit, dikwels met 'n AWS-diens soos Lambda.
- **Keuse:** Maak besluite gebaseer op invoer.
- **Misluk/Slaag:** Eindig die uitvoering met 'n mislukking of sukses.
- **Deurgang:** Gee invoer na uitvoer of voeg data in.
- **Wag:** Vertraag uitvoering vir 'n vasgestelde tyd.
- **Parallel:** Begin parallelle takke.
- **Kaart:** Herhaal dinamies stappe oor items.

### Taak

'n **Taak**-toestand verteenwoordig 'n enkele eenheid van werk wat deur 'n toestandmasjien uitgevoer word. Take kan verskeie hulpbronne aanroep, insluitend aktiwiteite, Lambda-funksies, AWS-dienste, of derdeparty-API's.

- **Aktiwiteite**: Pasgemaakte werkers wat jy bestuur, geskik vir langlopende prosesse.
- Hulpbron: **`arn:aws:states:region:account:activity:name`**.
- **Lambda-funksies**: Voer AWS Lambda-funksies uit.
- Hulpbron: **`arn:aws:lambda:region:account:function:function-name`**.
- **AWS-dienste**: Integreer direk met ander AWS-dienste, soos DynamoDB of S3.
- Hulpbron: **`arn:partition:states:region:account:servicename:APIname`**.
- **HTTP Taak**: Roep derdeparty-API's aan.
- Hulpbronveld: **`arn:aws:states:::http:invoke`**. Dan moet jy die API-eindpuntkonfigurasiebesonderhede verskaf, soos die API-URL, metode, en outentikasiebesonderhede.

Die volgende voorbeeld toon 'n Taak-toestanddefinisie wat 'n Lambda-funksie genaamd HelloWorld aanroep:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Choice

'n **Choice**-toestand voeg voorwaardelike logika by 'n werkvloei, wat besluite moontlik maak gebaseer op invoerdata. Dit evalueer die gespesifiseerde voorwaardes en beweeg na die ooreenstemmende toestand gebaseer op die resultate.

- **Vergelyking**: Elke keusere√´l sluit 'n vergelykingsoperateur in (bv. **`NumericEquals`**, **`StringEquals`**) wat 'n invoerveranderlike vergelyk met 'n gespesifiseerde waarde of 'n ander veranderlike.
- **Next Field**: Keusetoestande ondersteun nie die **`End`**-veld nie, in plaas daarvan definieer hulle die **`Next`**-toestand om na oor te gaan as die vergelyking waar is.

Voorbeeld van **Choice**-toestand:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Fail/Succeed

'n **`Fail`** toestand stop die uitvoering van 'n toestandmasjien en merk dit as 'n mislukking. Dit word gebruik om 'n foutnaam en 'n oorsaak te spesifiseer, wat besonderhede oor die mislukking verskaf. Hierdie toestand is terminaal, wat beteken dit be√´indig die uitvoeringsvloei.

'n **`Succeed`** toestand stop die uitvoering suksesvol. Dit word tipies gebruik om die werkvloei te be√´indig wanneer dit suksesvol voltooi. Hierdie toestand vereis nie 'n **`Next`** veld nie.

{% tabs %}

{% tab title="Fail example" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Succeed example" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Pass

'n **Pass**-toestand gee sy invoer deur na sy uitvoer sonder om enige werk te verrig of JSON-toestand-invoer te transformeer met behulp van filters, en gee dan die getransformeerde data deur na die volgende toestand. Dit is nuttig vir toetsing en die konstruksie van toestandmasjiene, wat jou toelaat om statiese data in te voeg of dit te transformeer.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Wag

'n **Wag**-toestand vertraag die uitvoering van die toestandmasjien vir 'n gespesifiseerde duur. Daar is drie prim√™re metodes om die wagtyd te konfigureer:

- **X Sekondes**: 'n Vaste aantal sekondes om te wag.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **Absolute Tydstempel**: 'n Presiese tyd om te wag tot.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **Dinamiese Wag**: Gebaseer op invoer met behulp van **`SecondsPath`** of **`TimestampPath`**.

```json
jsonCopiar c√≥digo
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### Parallel

'n **Parallel**-toestand laat jou toe om verskeie takke van take gelyktydig binne jou werkvloei uit te voer. Elke tak loop onafhanklik en verwerk sy eie reeks toestande. Die uitvoering wag totdat alle takke voltooi is voordat dit na die volgende toestand gaan. Die sleutelvelde is:

- **Branches**: 'n Reeks wat die parallelle uitvoeringpaaie definieer. Elke tak is 'n aparte toestandmasjien.
- **ResultPath**: Definieer waar (in die invoer) om die gekombineerde uitset van die takke te plaas.
- **Retry and Catch**: Foutafhandelingskonfigurasies vir die parallelle toestand.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

'n **Map**-toestand stel die uitvoering van 'n stel stappe vir elke item in 'n datastel in staat. Dit word gebruik vir parallelle verwerking van data. Afhangend van hoe jy die items van die datastel wil verwerk, bied Step Functions die volgende modusse:

- **Inline Mode**: Voer 'n substel van toestande uit vir elke JSON-array-item. Geskik vir kleinskaalse take met minder as 40 parallelle iterasies, wat elk in die konteks van die werkvloei wat die **`Map`**-toestand bevat, uitgevoer word.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Distributed Mode**: Ontwerp vir grootskaalse parallelle verwerking met ho√´ gelyktydigheid. Ondersteun die verwerking van groot datastelle, soos di√© wat in Amazon S3 gestoor word, wat 'n ho√´ gelyktydigheid van tot 10,000 parallelle kind-werkvloei-uitvoerings moontlik maak, wat hierdie kinders as 'n aparte kind-uitvoering laat loop.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Weergawes en aliasse

Step Functions laat jou ook toe om werkvloei-ontplooiings te bestuur deur **weergawes** en **aliasse** van toestandmasjiene. 'n Weergawe verteenwoordig 'n momentopname van 'n toestandmasjien wat uitgevoer kan word. Aliasse dien as wysers na tot twee weergawes van 'n toestandmasjien.

- **Weergawes**: Hierdie onveranderlike momentopnames van 'n toestandmasjien word geskep vanaf die mees onlangse hersiening van daardie toestandmasjien. Elke weergawe word ge√Ødentifiseer deur 'n unieke ARN wat die toestandmasjien-ARN kombineer met die weergawe-nommer, geskei deur 'n dubbelpunt (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Weergawes kan nie geredigeer word nie, maar jy kan die toestandmasjien opdateer en 'n nuwe weergawe publiseer, of die gewenste toestandmasjien-weergawe gebruik.
- **Aliasse**: Hierdie wysers kan tot twee weergawes van dieselfde toestandmasjien verwys. Meerdere aliasse kan vir 'n enkele toestandmasjien geskep word, elk ge√Ødentifiseer deur 'n unieke ARN wat die toestandmasjien-ARN kombineer met die aliasnaam, geskei deur 'n dubbelpunt (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Aliasse stel die roetering van verkeer tussen een van die twee weergawes van 'n toestandmasjien in staat. Alternatiewelik kan 'n alias na 'n enkele spesifieke weergawe van die toestandmasjien wys, maar nie na ander aliasse nie. Hulle kan opdateer word om na 'n ander weergawe van die toestandmasjien te herlei soos nodig, wat beheerde ontplooiings en werkvloeibestuur fasiliteer.

Vir meer gedetailleerde inligting oor **ASL**, kyk: [**Amazon States Language**](https://states-language.net/spec.html).



## IAM-rolle vir toestandmasjiene

AWS Step Functions gebruik AWS Identity and Access Management (IAM)-rolle om toegang tot hulpbronne en aksies binne toestandmasjiene te beheer. Hier is die sleutel aspekte wat verband hou met sekuriteit en IAM-rolle in AWS Step Functions:

- **Uitvoeringsrol**: Elke toestandmasjien in AWS Step Functions word geassosieer met 'n IAM-uitvoeringsrol. Hierdie rol definieer watter aksies die toestandmasjien namens jou kan uitvoer. Wanneer 'n toestandmasjien oorgaan tussen toestande wat met AWS-dienste interaksie het (soos die aanroep van Lambda-funksies, toegang tot DynamoDB, ens.), neem dit hierdie uitvoeringsrol aan om daardie aksies uit te voer.
- **Toestemmings**: Die IAM-uitvoeringsrol moet gekonfigureer word met toestemmings wat die nodige aksies op ander AWS-dienste toelaat. Byvoorbeeld, as jou toestandmasjien AWS Lambda-funksies moet aanroep, moet die IAM-rol **`lambda:InvokeFunction`**-toestemmings h√™. Net so, as dit nodig is om na DynamoDB te skryf, moet toepaslike toestemmings (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, ens.) verleen word.
- **Minste voorreg**: Dit word aanbeveel om die beginsel van minste voorreg te volg wanneer IAM-rolle vir Step Functions gekonfigureer word. Dit beteken om slegs die toestemmings te verleen wat nodig is vir die toestandmasjien om sy spesifieke aksies uit te voer, en nie meer nie. IAM-beleide moet geskoei wees op spesifieke hulpbronne en aksies, wat die risiko van onbedoelde toegang verminder.

## Enumerasie

ReadOnlyAccess-beleid is genoeg vir al die volgende enumerasie-aksies.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

Op die volgende bladsy kan jy sien hoe om **Step Functions-permissies te misbruik om voorregte te verhoog**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# Verwysings

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
