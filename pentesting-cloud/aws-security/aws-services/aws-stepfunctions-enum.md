# AWS - Step Functions Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team 전문가)</strong>에서 <strong>제로부터 영웅까지 AWS 해킹 배우기</strong>!</summary>

다른 HackTricks 지원 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하고 싶다면 [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구입하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* **💬 [Discord 그룹](https://discord.gg/hRep4RUj7f)** 또는 [텔레그램 그룹](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* **HackTricks** 및 **HackTricks Cloud** github 저장소에 PR을 제출하여 해킹 트릭을 공유하세요.

</details>

## Step Functions

AWS Step Functions은 여러 AWS 서비스를 서버리스 워크플로우로 조정하고 조율할 수 있는 워크플로우 서비스입니다. AWS Step Functions을 사용하면 AWS Lambda, Amazon S3, Amazon DynamoDB 등 다양한 AWS 서비스를 연결하는 워크플로우를 설계하고 실행할 수 있습니다. 이 조율 서비스는 시각적 워크플로우 인터페이스를 제공하며 JSON 기반 **Amazon States Language** (ASL)을 사용하여 워크플로우의 각 단계를 선언적으로 정의할 수 있는 **상태 기계** 기능을 제공합니다.

AWS Step Functions는 기본 인프라 관리, 재시도, 오류 처리 및 병렬 처리를 자동으로 처리함으로써 탄력적이고 확장 가능한 애플리케이션을 구축하는 프로세스를 간소화합니다. 이 서비스는 여러 단계와 의사 결정 지점을 포함하는 복잡한 워크플로우를 만드는 데 특히 유용하며 데이터 및 실행 상태의 흐름을 쉽게 관리할 수 있습니다. 이 서비스에서 수행할 주요 사용 사례는 다음과 같습니다:

- **데이터 처리**: 파일, 비디오 및 이미지 처리; 추출, 변환 및 로드 (ETL) 작업; 및 일괄 처리 및 고성능 컴퓨팅 (HPC) 워크로드.
- **머신 러닝**: 사기 탐지, 맞춤화, 추천 및 데이터 풍부화.
- **마이크로서비스 조율**: 동기식 또는 실시간 워크플로우 및 컨테이너 조율.
- **IT 및 보안 자동화**: 자동 복구, 배포 및 응답; 그리고 인간 승인 및 승격.

## 주요 개념

### 표준 vs. Express 워크플로우

AWS Step Functions은 두 가지 유형의 **상태 기계 워크플로우**를 제공합니다: 표준 및 Express.

- **표준 워크플로우**: 이 기본 워크플로우 유형은 장기 실행, 내구성 및 감사 가능한 프로세스를 위해 설계되었습니다. **정확히 한 번 실행**을 지원하여 재시도가 지정되지 않는 한 작업이 한 번만 실행되도록 보장합니다. 자세한 실행 이력이 필요한 워크플로우에 이상적이며 최대 1년 동안 실행할 수 있습니다.
- **Express 워크플로우**: 이 유형은 고용량, 단기 작업에 이상적이며 최대 5분까지 실행할 수 있습니다. **적어도 한 번 실행**을 지원하며 데이터 처리와 같은 멱등 작업에 적합합니다. 이러한 워크플로우는 실행, 지속 시간 및 메모리 사용에 따라 비용을 최적화하며 성능을 향상시킵니다.

### 상태

상태는 상태 기계의 필수 단위입니다. 상태는 유형에 따라 다양한 기능을 수행할 수 있으며 워크플로우 내에서 개별 단계를 정의합니다.

- **작업(Task)**: 입력에 따라 결정을 내립니다.
- **선택(Choice)**: 작업을 실행하는 상태 기계에서 실행되는 단일 작업을 나타냅니다.
- **실패/성공(Fail/Succeed)**: 실패 또는 성공으로 실행을 종료합니다.
- **통과(Pass)**: 입력을 출력으로 전달하거나 데이터를 삽입합니다.
- **대기(Wait)**: 일정 시간 동안 실행을 지연시킵니다.
- **병렬(Parallel)**: 병렬 분기를 시작합니다.
- **맵(Map)**: 항목을 통해 단계를 동적으로 반복합니다.

### 작업

**작업(Task)** 상태는 상태 기계에 의해 실행되는 단일 작업 단위를 나타냅니다. 작업은 활동, 람다 함수, AWS 서비스 또는 타사 API를 포함한 다양한 리소스를 호출할 수 있습니다.

- **활동(Activities)**: 장기 실행 프로세스에 적합한 사용자가 관리하는 사용자 지정 워커입니다.
- 리소스: **`arn:aws:states:region:account:activity:name`**.
- **Lambda 함수**: AWS Lambda 함수를 실행합니다.
- 리소스: **`arn:aws:lambda:region:account:function:function-name`**.
- **AWS 서비스**: 다른 AWS 서비스(예: DynamoDB 또는 S3)와 직접 통합합니다.
- 리소스: **`arn:partition:states:region:account:servicename:APIname`**.
- **HTTP 작업**: 타사 API를 호출합니다.
- 리소스 필드: **`arn:aws:states:::http:invoke`**. 그런 다음 API URL, 메서드 및 인증 세부 정보와 같은 API 엔드포인트 구성 세부 정보를 제공해야 합니다.

다음 예제는 HelloWorld라는 람다 함수를 호출하는 작업 상태 정의를 보여줍니다:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### 선택

**선택(Choice)** 상태는 입력 데이터를 기반으로 한 결정을 가능하게 하는 조건부 논리를 워크플로에 추가합니다. 지정된 조건을 평가하고 결과에 따라 해당 상태로 전환합니다.

- **비교(Comparison)**: 각 선택 규칙에는 입력 변수를 지정된 값이나 다른 변수와 비교하는 비교 연산자(예: **`NumericEquals`**, **`StringEquals`**)가 포함됩니다.
- **다음 필드(Next Field)**: 선택 상태는 **`End`** 필드를 지원하지 않으며 대신, 비교가 참일 경우 전환할 **`Next`** 상태를 정의합니다.

**선택(Choice)** 상태의 예시:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### 실패/성공

**`Fail`** 상태는 상태 머신의 실행을 중지하고 실패로 표시합니다. 오류 이름과 원인을 지정하여 실패에 대한 세부 정보를 제공하는 데 사용됩니다. 이 상태는 종단 상태이며 실행 흐름을 종료합니다.

**`Succeed`** 상태는 실행을 성공적으로 중지합니다. 일반적으로 워크플로가 성공적으로 완료될 때 종료하는 데 사용됩니다. 이 상태는 **`Next`** 필드를 필요로하지 않습니다.

{% tabs %}

{% tab title="실패 예시" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="성공 예시" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### 통과

**통과** 상태는 입력을 출력으로 전달하거나 작업을 수행하지 않고 JSON 상태 입력을 필터를 사용하여 변환한 다음 변환된 데이터를 다음 상태로 전달합니다. 이는 테스트 및 상태 머신 구성에 유용하며 정적 데이터를 삽입하거나 변환할 수 있도록 합니다.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### 대기

**대기** 상태는 상태 머신의 실행을 지정된 기간 동안 지연시킵니다. 대기 시간을 구성하는 주요 방법은 세 가지가 있습니다:

- **X 초**: 기다릴 고정된 초 단위의 시간.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **절대 타임스탬프**: 기다릴 정확한 시간.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **동적 대기**: **`SecondsPath`** 또는 **`TimestampPath`**를 사용하여 입력을 기반으로 합니다.

```json
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### 병렬

**병렬** 상태는 워크플로 내에서 여러 가지 작업 브랜치를 동시에 실행할 수 있게 합니다. 각 브랜치는 독립적으로 실행되며 자체 상태 시퀀스를 처리합니다. 실행은 모든 브랜치가 완료될 때까지 기다린 후 다음 상태로 진행합니다. 주요 필드는 다음과 같습니다:

- **Branches**: 병렬 실행 경로를 정의하는 배열입니다. 각 브랜치는 별도의 상태 머신입니다.
- **ResultPath**: 브랜치의 결합된 출력을 입력에서 어디에 배치할지 정의합니다.
- **Retry 및 Catch**: 병렬 상태의 오류 처리 구성입니다.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### 맵

**맵(Map)** 상태는 데이터 세트의 각 항목에 대해 일련의 단계를 실행할 수 있게 합니다. 데이터의 병렬 처리에 사용됩니다. 데이터 세트의 항목을 어떻게 처리하고 싶은지에 따라 Step Functions은 다음 모드를 제공합니다:

- **인라인 모드(Inline Mode)**: 각 JSON 배열 항목에 대해 일부 상태를 실행합니다. 40개 이하의 병렬 반복 작업에 적합하며, 각각을 **`Map`** 상태를 포함하는 워크플로우의 컨텍스트에서 실행합니다.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **분산 모드(Distributed Mode)**: 높은 동시성을 갖는 대규모 병렬 처리를 위해 설계되었습니다. Amazon S3에 저장된 데이터와 같은 대규모 데이터 세트를 처리하는 데 사용되며, 최대 10,000개의 병렬 자식 워크플로우 실행을 지원하며, 이러한 자식을 별도의 자식 실행으로 실행합니다.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### 버전 및 별칭

Step Functions은 상태 머신의 **버전(versions)** 및 **별칭(aliases)**을 통해 워크플로우 배포를 관리할 수 있습니다. 버전은 실행할 수 있는 상태 머신의 스냅샷을 나타내며, 별칭은 최대 두 개의 상태 머신 버전을 가리킵니다.

- **버전(Versions)**: 상태 머신의 변경 불가능한 스냅샷으로, 해당 상태 머신의 가장 최근 수정에서 생성됩니다. 각 버전은 상태 머신 ARN과 버전 번호를 콜론으로 구분하여 결합한 고유 ARN으로 식별됩니다(**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). 버전은 편집할 수 없지만, 상태 머신을 업데이트하고 새 버전을 게시하거나 원하는 상태 머신 버전을 사용할 수 있습니다.
- **별칭(Aliases)**: 이러한 포인터는 동일한 상태 머신의 최대 두 개 버전을 참조할 수 있습니다. 단일 상태 머신에 대해 여러 별칭을 생성할 수 있으며, 각각은 상태 머신 ARN과 별칭 이름을 콜론으로 구분하여 결합한 고유 ARN으로 식별됩니다(**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). 별칭은 상태 머신의 두 버전 중 하나로의 트래픽 라우팅을 가능하게 합니다. 또는 별칭은 상태 머신의 특정 버전을 가리킬 수 있지만, 다른 별칭을 가리킬 수는 없습니다. 필요에 따라 상태 머신의 다른 버전으로 리디렉션하도록 업데이트할 수 있어서 제어된 배포와 워크플로우 관리를 용이하게 합니다.

**ASL**에 대한 자세한 정보는 여기를 확인하세요: [**Amazon States Language**](https://states-language.net/spec.html).



## 상태 머신용 IAM 역할

AWS Step Functions은 AWS Identity and Access Management (IAM) 역할을 활용하여 상태 머신 내의 리소스 및 작업에 대한 액세스를 제어합니다. AWS Step Functions의 보안 및 IAM 역할과 관련된 주요 측면은 다음과 같습니다:

- **실행 역할(Execution Role)**: AWS Step Functions의 각 상태 머신은 IAM 실행 역할과 관련되어 있습니다. 이 역할은 상태 머신이 사용자를 대신하여 수행할 수 있는 작업을 정의합니다. 상태 머신이 AWS 서비스와 상호 작용하는 상태 간 전환 시 (예: Lambda 함수 호출, DynamoDB 액세스 등) 이 실행 역할을 가정하여 해당 작업을 수행합니다.
- **권한(Permissions)**: IAM 실행 역할은 다른 AWS 서비스에서 필요한 작업을 수행할 수 있는 권한으로 구성되어야 합니다. 예를 들어, 상태 머신이 AWS Lambda 함수를 호출해야 하는 경우 IAM 역할은 **`lambda:InvokeFunction`** 권한을 가져야 합니다. 마찬가지로 DynamoDB에 쓰기 작업이 필요한 경우 적절한 권한(**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`** 등)이 부여되어야 합니다.
- **최소 권한(Least Privilege)**: Step Functions에 대한 IAM 역할을 구성할 때 최소 권한의 원칙을 따르는 것이 좋습니다. 이는 상태 머신이 특정 작업을 수행하는 데 필요한 권한만 부여하고, 그 이상은 부여하지 않는 것을 의미합니다. IAM 정책은 특정 리소스 및 작업으로 범위를 좁혀 의도하지 않은 액세스의 위험을 줄입니다.

## 열거(Enumeration)

모든 다음 열거 작업에 대해 ReadOnlyAccess 정책이 충분합니다.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## 권한 상승

다음 페이지에서 **Step Functions 권한을 남용하여 권한 상승**하는 방법을 확인할 수 있습니다:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## 사후 공격

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# 참고 자료

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 **제로부터 영웅이 되는 AWS 해킹 배우기**!</summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 홍보**하거나 **PDF 형식의 HackTricks 다운로드**를 원하시면 [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 굿즈**](https://peass.creator-spring.com)를 구매하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* 💬 [**디스코드 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)를 **팔로우**하세요.
* **HackTricks** 및 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>
