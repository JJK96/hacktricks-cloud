# AWS - Enum√©ration des fonctions d'√©tape

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Fonctions d'√©tape

AWS Step Functions est un service de workflow qui vous permet de coordonner et d'orchestrer plusieurs services AWS dans des workflows sans serveur. En utilisant AWS Step Functions, vous pouvez concevoir et ex√©cuter des workflows qui connectent divers services AWS tels que AWS Lambda, Amazon S3, Amazon DynamoDB, et bien d'autres, dans une s√©quence d'√©tapes. Ce service d'orchestration fournit une interface de workflow visuelle et offre des capacit√©s de **machine √† √©tats**, vous permettant de d√©finir chaque √©tape du workflow de mani√®re d√©clarative en utilisant le **Langage d'√âtats Amazon** (ASL) bas√© sur JSON.

AWS Step Functions simplifie le processus de construction d'applications r√©silientes et √©volutives en g√©rant l'infrastructure sous-jacente, en traitant automatiquement les tentatives, les erreurs et le traitement parall√®le. Il est particuli√®rement utile pour cr√©er des workflows complexes impliquant plusieurs √©tapes et points de d√©cision, car il peut facilement g√©rer le flux de donn√©es et l'√©tat d'ex√©cution √† travers les services. Les principaux cas d'utilisation √† effectuer par ce service sont les suivants :

- **Traitement des donn√©es** : Traitement de fichiers, de vid√©os et d'images ; extraction, transformation et chargement (ETL) de t√¢ches ; et traitement par lots et charges de travail de calcul haute performance (HPC).
- **Apprentissage automatique** : D√©tection de fraude, personnalisation, recommandation et enrichissement des donn√©es.
- **Orchestration de microservices** : Workflows synchrones ou en temps r√©el et orchestration de conteneurs.
- **Automatisation IT et s√©curit√©** : Auto-r√©solution, d√©ploiement et r√©ponse ; et approbation et escalade humaines.

## Concepts cl√©s

### Workflows Standard vs Express

AWS Step Functions propose deux types de **workflows de machine √† √©tats** : Standard et Express.

- **Workflow Standard** : Ce type de workflow par d√©faut est con√ßu pour des processus longs, durables et v√©rifiables. Il prend en charge une **ex√©cution exactement une fois**, garantissant que les t√¢ches s'ex√©cutent une seule fois sauf si des r√©essais sont sp√©cifi√©s. Il est id√©al pour les workflows n√©cessitant un historique d'ex√©cution d√©taill√© et peut s'ex√©cuter jusqu'√† un an.
- **Workflow Express** : Ce type est id√©al pour les t√¢ches √† volume √©lev√© et de courte dur√©e, s'ex√©cutant jusqu'√† cinq minutes. Ils prennent en charge une **ex√©cution au moins une fois**, adapt√©e aux t√¢ches idempotentes comme le traitement des donn√©es. Ces workflows sont optimis√©s pour le co√ªt et les performances, facturant en fonction des ex√©cutions, de la dur√©e et de l'utilisation de la m√©moire.

### √âtats

Les √©tats sont les unit√©s essentielles des machines √† √©tats. Ils d√©finissent les √©tapes individuelles au sein d'un workflow, pouvant effectuer diverses fonctions en fonction de leur type :

- **T√¢che** : Ex√©cute une t√¢che, utilisant souvent un service AWS comme Lambda.
- **Choix** : Prend des d√©cisions en fonction de l'entr√©e.
- **√âchec/R√©ussite** : Termine l'ex√©cution par un √©chec ou un succ√®s.
- **Passer** : Passe l'entr√©e √† la sortie ou injecte des donn√©es.
- **Attendre** : Retarde l'ex√©cution pendant un temps d√©fini.
- **Parall√®le** : Initie des branches parall√®les.
- **Carte** : It√®re dynamiquement sur des √©l√©ments.

### T√¢che

Un √©tat de **T√¢che** repr√©sente une unit√© de travail unique ex√©cut√©e par une machine √† √©tats. Les t√¢ches peuvent invoquer diverses ressources, y compris des activit√©s, des fonctions Lambda, des services AWS ou des API tierces.

- **Activit√©s** : Travailleurs personnalis√©s que vous g√©rez, adapt√©s aux processus longs.
- Ressource : **`arn:aws:states:region:account:activity:name`**.
- **Fonctions Lambda** : Ex√©cute des fonctions Lambda AWS.
- Ressource : **`arn:aws:lambda:region:account:function:function-name`**.
- **Services AWS** : S'int√®gre directement avec d'autres services AWS, comme DynamoDB ou S3.
- Ressource : **`arn:partition:states:region:account:servicename:APIname`**.
- **T√¢che HTTP** : Appelle des API tierces.
- Champ de ressource : **`arn:aws:states:::http:invoke`**. Ensuite, vous devez fournir les d√©tails de configuration de l'endpoint API, tels que l'URL de l'API, la m√©thode et les d√©tails d'authentification.

L'exemple suivant montre une d√©finition d'√©tat de t√¢che qui invoque une fonction Lambda appel√©e HelloWorld :
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Choix

Un √©tat de **Choix** ajoute une logique conditionnelle √† un flux de travail, permettant de prendre des d√©cisions bas√©es sur les donn√©es d'entr√©e. Il √©value les conditions sp√©cifi√©es et se d√©place vers l'√©tat correspondant en fonction des r√©sultats.

- **Comparaison** : Chaque r√®gle de choix inclut un op√©rateur de comparaison (par exemple, **`NumericEquals`**, **`StringEquals`**) qui compare une variable d'entr√©e √† une valeur sp√©cifi√©e ou √† une autre variable.
- **Champ Suivant** : Les √©tats de choix ne prennent pas en charge le champ **`End`**, √† la place, ils d√©finissent l'√©tat **`Next`** vers lequel effectuer la transition si la comparaison est vraie.

Exemple d'√©tat de **Choix** :
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### √âchec/R√©ussite

Un √©tat **`Fail`** arr√™te l'ex√©cution d'une machine √† √©tats et la marque comme un √©chec. Il est utilis√© pour sp√©cifier un nom d'erreur et une cause, fournissant des d√©tails sur l'√©chec. Cet √©tat est terminal, ce qui signifie qu'il met fin au flux d'ex√©cution.

Un √©tat **`Succeed`** arr√™te l'ex√©cution avec succ√®s. Il est g√©n√©ralement utilis√© pour terminer le flux de travail lorsqu'il est ex√©cut√© avec succ√®s. Cet √©tat ne n√©cessite pas de champ **`Next`**.

{% tabs %}

{% tab title="Exemple d'√©chec" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Exemple de r√©ussite" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Pass

Un √©tat **Pass** transmet son entr√©e √† sa sortie soit sans effectuer aucun travail, soit en transformant l'entr√©e de l'√©tat JSON √† l'aide de filtres, puis en transmettant les donn√©es transform√©es √† l'√©tat suivant. Il est utile pour tester et construire des machines √† √©tats, vous permettant d'injecter des donn√©es statiques ou de les transformer.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Attendre

Un √©tat **Attendre** retarde l'ex√©cution de la machine √† √©tats pendant une dur√©e sp√©cifi√©e. Il existe trois m√©thodes principales pour configurer le temps d'attente :

- **X Secondes** : Un nombre fixe de secondes √† attendre.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **Horodatage Absolu** : Un moment pr√©cis pour attendre.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **Attente Dynamique** : Bas√©e sur l'entr√©e en utilisant **`SecondsPath`** ou **`TimestampPath`**.

```json
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### Parall√®le

Un √©tat **Parall√®le** vous permet d'ex√©cuter plusieurs branches de t√¢ches simultan√©ment dans votre flux de travail. Chaque branche s'ex√©cute ind√©pendamment et traite sa propre s√©quence d'√©tats. L'ex√©cution attend que toutes les branches soient termin√©es avant de passer √† l'√©tat suivant. Ses champs cl√©s sont :

- **Branches** : Un tableau d√©finissant les chemins d'ex√©cution parall√®les. Chaque branche est une machine √† √©tats distincte.
- **ResultPath** : D√©finit o√π (dans l'entr√©e) placer la sortie combin√©e des branches.
- **R√©essayer et Attraper** : Configurations de gestion des erreurs pour l'√©tat parall√®le.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Carte

Un √©tat **Carte** permet l'ex√©cution d'un ensemble d'√©tapes pour chaque √©l√©ment dans un ensemble de donn√©es. Il est utilis√© pour le traitement parall√®le des donn√©es. Selon la fa√ßon dont vous souhaitez traiter les √©l√©ments de l'ensemble de donn√©es, Step Functions propose les modes suivants :

- **Mode en ligne** : Ex√©cute un sous-ensemble d'√©tats pour chaque √©l√©ment du tableau JSON. Convient pour les t√¢ches √† petite √©chelle avec moins de 40 it√©rations parall√®les, en ex√©cutant chacune d'entre elles dans le contexte du flux de travail contenant l'√©tat¬†**`Carte`**.

```json
"√âtatCarte": {
"Type": "Carte",
"CheminItems": "$.√©l√©mentsTableau",
"ProcesseurItem": {
"ConfigurationProcesseur": {
"Mode": "EN LIGNE"
},
"D√©marrer√Ä": "√âtatAjout",
"√âtats": {
"√âtatAjout": {
"Type": "T√¢che",
"Ressource": "arn:aws:states:::lambda:invoquer",
"CheminSortie": "$.ChargeUtile",
"Param√®tres": {
"NomFonction": "arn:aws:lambda:<r√©gion>:<identifiant-compte>:fonction:fonction-ajout"
},
"Fin": true
}
}
},
"Fin": true
"CheminR√©sultat": "$.d√©tail.ajout√©",
"CheminItems": "$.ajout√©"
}
```

- **Mode distribu√©** : Con√ßu pour le traitement parall√®le √† grande √©chelle avec une forte concurrence. Prend en charge le traitement de grands ensembles de donn√©es, tels que ceux stock√©s dans Amazon S3, permettant une haute concurrence allant jusqu'√† 10 000 ex√©cutions de flux de travail enfants parall√®les, ex√©cutant ces enfants comme une ex√©cution enfant s√©par√©e.

```json
"√âtatCarteDistribu√©": {
"Type": "Carte",
"LecteurItem": {
"Ressource": "arn:aws:states:::s3:getObject",
"Param√®tres": {
"Seau": "mon-seau",
"Cl√©": "donnees.csv"
}
},
"ProcesseurItem": {
"ConfigurationProcesseur": {
"Mode": "DISTRIBU√â",
"TypeEx√©cution": "EXPRESS"
},
"D√©marrer√Ä": "Traiter√âl√©ment",
"√âtats": {
"Traiter√âl√©ment": {
"Type": "T√¢che",
"Ressource": "arn:aws:lambda:r√©gion:identifiant-compte:fonction:ma-fonction",
"Fin": true
}
}
},
"Fin": true
"√âcrivainR√©sultat": {
"Ressource": "arn:aws:states:::s3:putObject",
"Param√®tres": {
"Seau": "monSeauDeSortie",
"Pr√©fixe": "travauxTraitementCsv"
}
}
}
```


### Versions et alias

Step Functions vous permet √©galement de g√©rer les d√©ploiements de flux de travail via des **versions** et des **alias** de machines √† √©tats. Une version repr√©sente un instantan√© d'une machine √† √©tats qui peut √™tre ex√©cut√©. Les alias servent de pointeurs vers deux versions d'une machine √† √©tats au maximum.

- **Versions** : Ces instantan√©s immuables d'une machine √† √©tats sont cr√©√©s √† partir de la r√©vision la plus r√©cente de cette machine √† √©tats. Chaque version est identifi√©e par un ARN unique qui combine l'ARN de la machine √† √©tats avec le num√©ro de version, s√©par√©s par deux-points (**`arn:aws:states:r√©gion:identifiant-compte:machineEtats:NomMachineEtats:num√©ro-version`**). Les versions ne peuvent pas √™tre modifi√©es, mais vous pouvez mettre √† jour la machine √† √©tats et publier une nouvelle version, ou utiliser la version de machine √† √©tats souhait√©e.
- **Alias** : Ces pointeurs peuvent r√©f√©rencer jusqu'√† deux versions de la m√™me machine √† √©tats. Plusieurs alias peuvent √™tre cr√©√©s pour une seule machine √† √©tats, chacun identifi√© par un ARN unique construit en combinant l'ARN de la machine √† √©tats avec le nom de l'alias, s√©par√©s par deux-points (**`arn:aws:states:r√©gion:identifiant-compte:machineEtats:NomMachineEtats:nomAlias`**). Les alias permettent le routage du trafic entre l'une des deux versions d'une machine √† √©tats. Alternativement, un alias peut pointer vers une version sp√©cifique de la machine √† √©tats, mais pas vers d'autres alias. Ils peuvent √™tre mis √† jour pour rediriger vers une version diff√©rente de la machine √† √©tats selon les besoins, facilitant les d√©ploiements contr√¥l√©s et la gestion des flux de travail.

Pour des informations plus d√©taill√©es sur **ASL**, consultez : [**Langage d'√âtats Amazon**](https://states-language.net/spec.html).



## R√¥les IAM pour les machines √† √©tats

AWS Step Functions utilise des r√¥les IAM (Identity and Access Management) pour contr√¥ler l'acc√®s aux ressources et aux actions au sein des machines √† √©tats. Voici les principaux aspects li√©s √† la s√©curit√© et aux r√¥les IAM dans AWS Step Functions :

- **R√¥le d'ex√©cution** : Chaque machine √† √©tats dans AWS Step Functions est associ√©e √† un r√¥le d'ex√©cution IAM. Ce r√¥le d√©finit les actions que la machine √† √©tats peut effectuer en votre nom. Lorsqu'une machine √† √©tats passe d'un √©tat √† un autre qui interagit avec les services AWS (comme l'invocation de fonctions Lambda, l'acc√®s √† DynamoDB, etc.), elle assume ce r√¥le d'ex√©cution pour effectuer ces actions.
- **Autorisations** : Le r√¥le d'ex√©cution IAM doit √™tre configur√© avec des autorisations permettant les actions n√©cessaires sur d'autres services AWS. Par exemple, si votre machine √† √©tats doit invoquer des fonctions Lambda AWS, le r√¥le IAM doit disposer des autorisations **`lambda:InvokeFunction`**. De m√™me, s'il doit √©crire dans DynamoDB, des autorisations appropri√©es (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, etc.) doivent √™tre accord√©es.
- **Principe du moindre privil√®ge** : Il est recommand√© de suivre le principe du moindre privil√®ge lors de la configuration des r√¥les IAM pour Step Functions. Cela signifie accorder uniquement les autorisations n√©cessaires √† la machine √† √©tats pour effectuer ses actions sp√©cifiques, et pas plus. Les strat√©gies IAM doivent √™tre limit√©es √† des ressources et des actions sp√©cifiques, r√©duisant ainsi le risque d'acc√®s non intentionnel.

## √ânum√©ration

La politique ReadOnlyAccess est suffisante pour toutes les actions d'√©num√©ration suivantes.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## √âl√©vation de privil√®ges

Sur la page suivante, vous pouvez v√©rifier comment **abuser des autorisations Step Functions pour escalader les privil√®ges**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post-exploitation

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# R√©f√©rences

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
