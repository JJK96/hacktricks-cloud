# AWS - Adım Fonksiyonları Enum

<details>

<summary><strong>Sıfırdan kahraman olmak için AWS hackleme öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**]'na (https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünleri**]'ni alın (https://peass.creator-spring.com)
* [**PEASS Ailesi**]'ni keşfedin (https://opensea.io/collection/the-peass-family), özel [**NFT'ler**]'imiz koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.** takip edin
* **Hacking püf noktalarınızı paylaşarak PR'lar göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

## Adım Fonksiyonları

AWS Adım Fonksiyonları, birden fazla AWS hizmetini sunucu olmayan iş akışlarına koordine etmenizi ve orkestre etmenizi sağlayan bir iş akışı hizmetidir. AWS Adım Fonksiyonları kullanarak, AWS Lambda, Amazon S3, Amazon DynamoDB ve daha birçok AWS hizmetini bağlayan iş akışlarını tasarlayabilir ve çalıştırabilirsiniz. Bu orkestrasyon hizmeti, her adımı JSON tabanlı **Amazon States Language** (ASL) kullanarak bildiren deklaratif bir şekilde iş akışının her adımını tanımlamanıza olanak tanıyan **durum makinesi** yetenekleri sunar.

AWS Adım Fonksiyonları, altta yatan altyapıyı yöneterek, hataları, yeniden denemeleri ve paralel işlemeyi otomatik olarak ele alarak dirençli ve ölçeklenebilir uygulamalar oluşturma sürecini basitleştirir. Birden fazla adım ve karar noktası içeren karmaşık iş akışları oluşturmak için özellikle yararlıdır, çünkü veri akışını ve hizmetler arasındaki yürütme durumunu kolayca yönetebilir. Bu hizmet tarafından gerçekleştirilmesi gereken ana kullanım durumları şunlardır:

- **Veri işleme**: Dosya, video ve görüntü işleme; çıkarma, dönüştürme ve yükleme (ETL) işleri; ve Toplu işleme ve Yüksek Performanslı Hesaplama (HPC) iş yükleri.
- **Makine öğrenimi**: Dolandırıcılık tespiti, özelleştirme, öneri ve veri zenginleştirme.
- **Mikroservis orkestrasyonu**: Senkron veya gerçek zamanlı iş akışları ve konteyner orkestrasyonu.
- **BT ve güvenlik otomasyonu**: Otomatik iyileştirme, dağıtım ve yanıt; ve insan onayı ve yükseltme.

## Ana kavramlar

### Standart vs. Express İş Akışları

AWS Adım Fonksiyonları iki tür **durum makinesi iş akışı** sunar: Standart ve Express.

- **Standart İş Akışı**: Bu varsayılan iş akışı türü, uzun süreli, dayanıklı ve denetlenebilir süreçler için tasarlanmıştır. **Yalnızca bir kez yürütme**yi destekler, görevlerin yalnızca belirtilen yeniden denemeler olmadıkça yalnızca bir kez çalışmasını sağlar. Ayrıntılı yürütme geçmişi gerektiren iş akışları için idealdir ve en fazla bir yıl çalışabilir.
- **Express İş Akışı**: Bu tür, yüksek hacimli, kısa süreli görevler için idealdir ve beş dakikaya kadar çalışabilir. **En az bir kez yürütme**yi destekler, veri işleme gibi idempotent görevler için uygundur. Bu iş akışları, maliyet ve performans açısından optimize edilmiştir, yürütmelere, süreye ve bellek kullanımına göre ücretlendirme yapar.

### Durumlar

Durumlar, durum makinelerinin temel birimleridir. Bir iş akışı içindeki bireysel adımları tanımlarlar ve türüne bağlı olarak çeşitli işlevleri gerçekleştirebilirler:

- **Görev:** Genellikle Lambda gibi bir AWS hizmetini kullanarak bir işi yürütür.
- **Seçim:** Girişe dayalı kararlar alır.
- **Başarısız/ Başarılı:** Başarısızlık veya başarı ile yürütümü sonlandırır.
- **Geçiş:** Girişi çıktıya geçirir veya veri enjekte eder.
- **Bekleme:** Belirli bir süre için yürütümü geciktirir.
- **Paralel:** Paralel dallar başlatır.
- **Harita:** Öğeler üzerinde adımları dinamik olarak yineler.

### Görev

Bir **Görev** durumu, bir durum makinesi tarafından yürütülen tek bir iş birimini temsil eder. Görevler, Lambda işlevleri, AWS hizmetleri veya üçüncü taraf API'ları gibi çeşitli kaynakları çağırabilir.

- **Aktiviteler**: Uzun süren işlemler için uygun olan, yönettiğiniz özel işçiler.
- Kaynak: **`arn:aws:states:region:account:activity:name`**.
- **Lambda İşlevleri**: AWS Lambda işlevlerini yürütür.
- Kaynak: **`arn:aws:lambda:region:account:function:function-name`**.
- **AWS Hizmetleri**: DynamoDB veya S3 gibi diğer AWS hizmetleriyle doğrudan entegre olur.
- Kaynak: **`arn:partition:states:region:account:servicename:APIname`**.
- **HTTP Görevi**: Üçüncü taraf API'larına çağrı yapar.
- Kaynak alanı: **`arn:aws:states:::http:invoke`**. Daha sonra, API URL'si, yöntem ve kimlik doğrulama ayrıntıları gibi API uç noktası yapılandırma ayrıntılarını sağlamalısınız.

Aşağıdaki örnek, HelloWorld adlı bir Lambda işlevini çağıran bir Görev durumu tanımını göstermektedir:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Seçenek

Bir **Seçenek** durumu, giriş verilerine dayalı kararlar vererek bir iş akışına koşullu mantık ekler. Belirtilen koşulları değerlendirir ve sonuçlara bağlı olarak ilgili duruma geçiş yapar.

- **Karşılaştırma**: Her seçenek kuralı, bir giriş değişkenini belirtilen bir değerle veya başka bir değişkenle karşılaştıran bir karşılaştırma operatörü içerir (örneğin, **`NumericEquals`**, **`StringEquals`**).
- **Sonraki Alan**: Seçenek durumları **`End`** alanını desteklemez, bunun yerine, karşılaştırma doğruysa geçiş yapılacak **`Next`** durumunu tanımlar.

**Seçenek** durumunun örneği:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Başarısız/Olumlu

Bir **`Fail`** durumu, bir durum makinesinin yürütülmesini durdurur ve başarısızlık olarak işaretler. Bir hata adı ve neden belirtmek için kullanılır, başarısızlık hakkında ayrıntılar sağlar. Bu durum terminaldir, yani yürütme akışını sonlandırır.

Bir **`Succeed`** durumu, yürütümü başarılı bir şekilde durdurur. Genellikle işlem başarıyla tamamlandığında iş akışını sonlandırmak için kullanılır. Bu durumda **`Next`** alanı gerekli değildir.

{% tabs %}

{% tab title="Fail örneği" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Başarılı örnek" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Geç

Bir **Geç** durumu, girişini ya hiçbir işlem yapmadan veya JSON durum girişini filtreler kullanarak dönüştürerek ve dönüştürülmüş verileri bir sonraki duruma ileterek çıktısına ileten bir durumdur. Durum makineleri oluşturmak ve test etmek için kullanışlıdır, statik veri enjekte etmenize veya dönüştürmenize olanak tanır.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Bekle

Bir **Bekleme** durumu, belirtilen bir süre boyunca durum makinesinin yürütülmesini geciktirir. Bekleme süresini yapılandırmak için üç temel yöntem vardır:

- **X Saniye**: Beklemek için sabit bir saniye sayısı.

```json
"BeklemeDurumu": {
"Tür": "Bekle",
"Saniye": 10,
"Sonraki": "SonrakiDurum"
}
```

- **Mutlak Zaman Damgası**: Beklenecek kesin bir zaman.

```json
"BeklemeDurumu": {
"Tür": "Bekle",
"ZamanDamgası": "2024-03-14T01:59:00Z",
"Sonraki": "SonrakiDurum"
}
```

- **Dinamik Bekleme**: **`SecondsPath`** veya **`TimestampPath`** kullanarak girişe dayalı.

```json
"BeklemeDurumu": {
"Tür": "Bekle",
"ZamanDamgasıYolu": "$.sonkullanimtarihi",
"Sonraki": "SonrakiDurum"
}
```


### Paralel

Bir **Paralel** durumu, iş akışınız içinde aynı anda birden fazla görev dalını eşzamanlı olarak yürütmenizi sağlar. Her dal bağımsız olarak çalışır ve kendi durum dizisini işler. Yürütme, tüm dalların tamamlanmasını bekler ve ardından bir sonraki duruma geçer. Anahtar alanları şunlardır:

- **Dallar**: Paralel yürütme yollarını tanımlayan bir dizi. Her dal ayrı bir durum makinesidir.
- **SonuçYolu**: Dalların birleştirilmiş çıktısını yerleştirmek için (girişte) nerede tanımlanacağını belirler.
- **Tekrar Dene ve Hata Yakala**: Paralel durum için hata işleme yapılandırmaları.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Harita

Bir **Harita** durumu, bir veri kümesindeki her öğe için bir dizi adımın yürütülmesini sağlar. Verilerin paralel işlenmesi için kullanılır. Veri kümesinin öğelerini nasıl işlemek istediğinize bağlı olarak, Adım Fonksiyonları aşağıdaki modları sağlar:

- **İç Mod**: Her JSON dizisi öğesi için bir alt küme durumunu yürütür. Her birini içeren iş akışı bağlamında çalıştırılan 40'tan az paralel tekrar için uygundur.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Dağıtılmış Mod**: Yüksek eş zamanlılıkla büyük ölçekli paralel işleme için tasarlanmıştır. Amazon S3'te depolanan gibi büyük veri kümelerinin işlenmesini destekler, 10.000'e kadar paralel çocuk iş akışı yürütme, bu çocukları ayrı bir çocuk yürütme olarak çalıştırma.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Sürümler ve takma adlar

Adım Fonksiyonları ayrıca durum makinelerinin **sürümlerini** ve **takma adlarını** yönetmenize olanak tanır. Bir sürüm, yürütülebilen bir durum makinesinin anlık görüntüsünü temsil eder. Takma adlar, aynı durum makinesinin en fazla iki sürümüne işaretçi olarak hizmet eder.

- **Sürümler**: Bu değişmez durum makinesi anlık görüntüleri, o durum makinesinin en son revizyonundan oluşturulur. Her sürüm, durum makinesi ARN'sini ve sürüm numarasını iki nokta ile ayırarak benzersiz bir ARN ile tanımlanır. Sürümler düzenlenemez, ancak durum makinesini güncelleyebilir ve yeni bir sürüm yayınlayabilir veya istenen durum makinesi sürümünü kullanabilirsiniz.
- **Takma Adları**: Bu işaretçiler aynı durum makinesinin en fazla iki sürümüne işaret edebilir. Bir durum makinesi için birden fazla takma ad oluşturulabilir, her biri durum makinesi ARN'sini ve takma adı arasına iki nokta koyarak benzersiz bir ARN ile tanımlanır. Takma adlar, bir durum makinesinin iki sürümünden birine yönlendirme yapmayı sağlar. Ayrıca, bir takma ad belirli bir durum makinesi sürümüne işaret edebilir, ancak diğer takma adlara işaret edemez. İhtiyaç duyulduğunda farklı bir sürüme yönlendirmek için güncellenebilirler, kontrollü dağıtımları ve iş akışı yönetimini kolaylaştırır.

Daha detaylı bilgi için **ASL** hakkında şu bağlantıya bakabilirsiniz: [**Amazon States Language**](https://states-language.net/spec.html).



## Durum makineleri için IAM Roller

AWS Step Functions, kaynaklara ve eylemlere erişimi kontrol etmek için AWS Kimlik ve Erişim Yönetimi (IAM) rollerini kullanır. AWS Step Functions ile ilgili güvenlik ve IAM rolleri ile ilgili ana konular şunlardır:

- **Yürütme Rolü**: AWS Step Functions'taki her durum makinesi bir IAM yürütme rolü ile ilişkilidir. Bu rol, durum makinesinin sizin adınıza hangi eylemleri gerçekleştirebileceğini tanımlar. Bir durum makinesi, AWS hizmetleriyle etkileşimde bulunan durumlar arasında geçiş yaptığında (örneğin Lambda işlevlerini çağırma, DynamoDB'ye erişme vb.), bu yürütme rolünü bu eylemleri gerçekleştirmek için devralır.
- **İzinler**: IAM yürütme rolü, diğer AWS hizmetlerinde gerekli eylemlere izin veren izinlerle yapılandırılmalıdır. Örneğin, durum makinenizin AWS Lambda işlevlerini çağırması gerekiyorsa, IAM rolünün **`lambda:InvokeFunction`** izinlerine sahip olması gerekir. Benzer şekilde, DynamoDB'ye yazma ihtiyacı varsa, uygun izinler (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, vb.) verilmelidir.
- **En Az İzin İlkesi**: Step Functions için IAM rollerini yapılandırırken en az ayrıcalığı prensibini takip etmek önerilir. Bu, durum makinesinin belirli eylemlerini gerçekleştirmek için gerekli olan izinleri vermek ve fazlasını vermemek anlamına gelir. IAM politikaları belirli kaynaklara ve eylemlere kapsamlı olmalı, yanlış erişim riskini azaltmalıdır.

## Numaralandırma

ReadOnlyAccess politikası, tüm aşağıdaki numaralandırma eylemleri için yeterlidir.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## İst Privileges

Aşağıdaki sayfada, **yetkileri yükseltmek için Step Functions izinlerini kötüye kullanma** yöntemlerini kontrol edebilirsiniz:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Sonrası Sızma

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# Referanslar

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

<details>

<summary><strong>Sıfırdan kahraman olmak için AWS hacklemeyi öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
