# AWS - Step Functions Enum

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Step Functions

AWS Step Functions est un service de workflow qui vous permet de coordonner et d'orchestrer plusieurs services AWS en workflows sans serveur. En utilisant AWS Step Functions, vous pouvez concevoir et ex√©cuter des workflows qui connectent divers services AWS tels que AWS Lambda, Amazon S3, Amazon DynamoDB, et bien d'autres, dans une s√©quence d'√©tapes. Ce service d'orchestration fournit une interface de workflow visuelle et offre des capacit√©s de **state machine**, vous permettant de d√©finir chaque √©tape du workflow de mani√®re d√©clarative en utilisant le **Amazon States Language** (ASL) bas√© sur JSON.

AWS Step Functions simplifie le processus de cr√©ation d'applications r√©silientes et √©volutives en g√©rant l'infrastructure sous-jacente, en traitant les reprises, les erreurs et le traitement parall√®le automatiquement. Il est particuli√®rement utile pour cr√©er des workflows complexes impliquant plusieurs √©tapes et points de d√©cision, car il peut facilement g√©rer le flux de donn√©es et l'√©tat d'ex√©cution entre les services. Les principaux cas d'utilisation de ce service sont les suivants :

- **Traitement des donn√©es** : Traitement de fichiers, vid√©os et images ; extraction, transformation et chargement (ETL) de travaux ; et traitement par lots et charges de travail de calcul haute performance (HPC).
- **Apprentissage automatique** : D√©tection de fraude, personnalisation, recommandation et enrichissement des donn√©es.
- **Orchestration de microservices** : Workflows synchrones ou en temps r√©el et orchestration de conteneurs.
- **Automatisation informatique et de la s√©curit√©** : Auto-rem√©diation, d√©ploiement et r√©ponse ; et approbation humaine et escalade.

## Concepts cl√©s

### Workflows Standard vs. Express

AWS Step Functions propose deux types de **workflows de state machine** : Standard et Express.

- **Workflow Standard** : Ce type de workflow par d√©faut est con√ßu pour des processus de longue dur√©e, durables et auditables. Il prend en charge l'**ex√©cution une seule fois**, garantissant que les t√¢ches s'ex√©cutent une seule fois sauf si des reprises sont sp√©cifi√©es. Il est id√©al pour les workflows n√©cessitant un historique d'ex√©cution d√©taill√© et peut fonctionner jusqu'√† un an.
- **Workflow Express** : Ce type est id√©al pour les t√¢ches de courte dur√©e √† volume √©lev√©, fonctionnant jusqu'√† cinq minutes. Ils prennent en charge l'**ex√©cution au moins une fois**, convenant aux t√¢ches idempotentes comme le traitement des donn√©es. Ces workflows sont optimis√©s pour le co√ªt et la performance, facturant en fonction des ex√©cutions, de la dur√©e et de l'utilisation de la m√©moire.

### √âtats

Les √©tats sont les unit√©s essentielles des state machines. Ils d√©finissent les √©tapes individuelles au sein d'un workflow, pouvant effectuer une vari√©t√© de fonctions selon leur type :

- **Task:** Ex√©cute un travail, souvent en utilisant un service AWS comme Lambda.
- **Choice:** Prend des d√©cisions bas√©es sur l'entr√©e.
- **Fail/Succeed:** Termine l'ex√©cution par un √©chec ou un succ√®s.
- **Pass:** Transmet l'entr√©e √† la sortie ou injecte des donn√©es.
- **Wait:** Retarde l'ex√©cution pendant un temps d√©fini.
- **Parallel:** Initie des branches parall√®les.
- **Map:** It√®re dynamiquement les √©tapes sur des √©l√©ments.

### Task

Un √©tat **Task** repr√©sente une unit√© de travail unique ex√©cut√©e par une state machine. Les t√¢ches peuvent invoquer diverses ressources, y compris des activit√©s, des fonctions Lambda, des services AWS ou des API tierces.

- **Activities**: Travailleurs personnalis√©s que vous g√©rez, adapt√©s aux processus de longue dur√©e.
- Resource: **`arn:aws:states:region:account:activity:name`**.
- **Lambda Functions**: Ex√©cute des fonctions AWS Lambda.
- Resource: **`arn:aws:lambda:region:account:function:function-name`**.
- **AWS Services**: S'int√®gre directement avec d'autres services AWS, comme DynamoDB ou S3.
- Resource: **`arn:partition:states:region:account:servicename:APIname`**.
- **HTTP Task**: Appelle des API tierces.
- Resource field: **`arn:aws:states:::http:invoke`**. Ensuite, vous devez fournir les d√©tails de configuration de l'endpoint API, tels que l'URL de l'API, la m√©thode et les d√©tails d'authentification.

L'exemple suivant montre une d√©finition d'√©tat Task qui invoque une fonction Lambda appel√©e HelloWorld :
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Choice

Un √©tat **Choice** ajoute une logique conditionnelle √† un workflow, permettant des d√©cisions bas√©es sur les donn√©es d'entr√©e. Il √©value les conditions sp√©cifi√©es et passe √† l'√©tat correspondant en fonction des r√©sultats.

- **Comparison**: Chaque r√®gle de choix inclut un op√©rateur de comparaison (par exemple, **`NumericEquals`**, **`StringEquals`**) qui compare une variable d'entr√©e √† une valeur sp√©cifi√©e ou √† une autre variable.
- **Next Field**: Les √©tats de choix ne supportent pas le champ **`End`**, ils d√©finissent plut√¥t l'√©tat **`Next`** vers lequel passer si la comparaison est vraie.

Exemple d'√©tat **Choice** :
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Fail/Succeed

Un √©tat **`Fail`** arr√™te l'ex√©cution d'une machine d'√©tat et la marque comme un √©chec. Il est utilis√© pour sp√©cifier un nom d'erreur et une cause, fournissant des d√©tails sur l'√©chec. Cet √©tat est terminal, ce qui signifie qu'il met fin au flux d'ex√©cution.

Un √©tat **`Succeed`** arr√™te l'ex√©cution avec succ√®s. Il est g√©n√©ralement utilis√© pour terminer le flux de travail lorsqu'il se termine avec succ√®s. Cet √©tat ne n√©cessite pas de champ **`Next`**.

{% tabs %}

{% tab title="Fail example" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Exemple de r√©ussite" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
{% endtab %}

{% endtabs %}

### Pass

Un √©tat **Pass** passe son entr√©e √† sa sortie soit sans effectuer de travail, soit en transformant l'entr√©e d'√©tat JSON √† l'aide de filtres, puis en passant les donn√©es transform√©es √† l'√©tat suivant. Il est utile pour tester et construire des machines d'√©tat, vous permettant d'injecter des donn√©es statiques ou de les transformer.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Attendre

Un √©tat **Wait** retarde l'ex√©cution de la machine d'√©tat pour une dur√©e sp√©cifi√©e. Il existe trois m√©thodes principales pour configurer le temps d'attente :

- **X Seconds**: Un nombre fixe de secondes √† attendre.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **Absolute Timestamp**: Un moment exact jusqu'auquel attendre.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **Dynamic Wait**: Bas√© sur l'entr√©e en utilisant **`SecondsPath`** ou **`TimestampPath`**.

```json
jsonCopiar c√≥digo
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### Parall√®le

Un √©tat **Parallel** vous permet d'ex√©cuter plusieurs branches de t√¢ches simultan√©ment dans votre flux de travail. Chaque branche fonctionne ind√©pendamment et traite sa propre s√©quence d'√©tats. L'ex√©cution attend que toutes les branches soient termin√©es avant de passer √† l'√©tat suivant. Ses champs cl√©s sont :

- **Branches**: Un tableau d√©finissant les chemins d'ex√©cution parall√®les. Chaque branche est une machine d'√©tat distincte.
- **ResultPath**: D√©finit o√π (dans l'entr√©e) placer la sortie combin√©e des branches.
- **Retry and Catch**: Configurations de gestion des erreurs pour l'√©tat parall√®le.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

Un √©tat **Map** permet l'ex√©cution d'un ensemble d'√©tapes pour chaque √©l√©ment d'un ensemble de donn√©es. Il est utilis√© pour le traitement parall√®le des donn√©es. Selon la mani√®re dont vous souhaitez traiter les √©l√©ments de l'ensemble de donn√©es, Step Functions propose les modes suivants :

- **Mode Inline** : Ex√©cute un sous-ensemble d'√©tats pour chaque √©l√©ment de tableau JSON. Convient aux t√¢ches de petite envergure avec moins de 40 it√©rations parall√®les, chacune √©tant ex√©cut√©e dans le contexte du workflow contenant l'√©tat **`Map`**.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Mode Distribu√©** : Con√ßu pour le traitement parall√®le √† grande √©chelle avec une haute concurrence. Prend en charge le traitement de grands ensembles de donn√©es, tels que ceux stock√©s dans Amazon S3, permettant une haute concurrence de jusqu'√† 10 000 ex√©cutions de workflow enfant parall√®les, chacune √©tant ex√©cut√©e comme une ex√©cution enfant distincte.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Versions et alias

Step Functions vous permet √©galement de g√©rer les d√©ploiements de workflow via les **versions** et **alias** des machines d'√©tat. Une version repr√©sente un instantan√© d'une machine d'√©tat qui peut √™tre ex√©cut√©. Les alias servent de pointeurs vers jusqu'√† deux versions d'une machine d'√©tat.

- **Versions** : Ces instantan√©s immuables d'une machine d'√©tat sont cr√©√©s √† partir de la r√©vision la plus r√©cente de cette machine d'√©tat. Chaque version est identifi√©e par un ARN unique qui combine l'ARN de la machine d'√©tat avec le num√©ro de version, s√©par√©s par un deux-points (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Les versions ne peuvent pas √™tre modifi√©es, mais vous pouvez mettre √† jour la machine d'√©tat et publier une nouvelle version, ou utiliser la version souhait√©e de la machine d'√©tat.
- **Alias** : Ces pointeurs peuvent r√©f√©rencer jusqu'√† deux versions de la m√™me machine d'√©tat. Plusieurs alias peuvent √™tre cr√©√©s pour une seule machine d'√©tat, chacun √©tant identifi√© par un ARN unique construit en combinant l'ARN de la machine d'√©tat avec le nom de l'alias, s√©par√©s par un deux-points (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Les alias permettent de diriger le trafic entre l'une des deux versions d'une machine d'√©tat. Alternativement, un alias peut pointer vers une version sp√©cifique unique de la machine d'√©tat, mais pas vers d'autres alias. Ils peuvent √™tre mis √† jour pour rediriger vers une version diff√©rente de la machine d'√©tat selon les besoins, facilitant les d√©ploiements contr√¥l√©s et la gestion des workflows.

Pour plus d'informations d√©taill√©es sur **ASL**, consultez : [**Amazon States Language**](https://states-language.net/spec.html).



## R√¥les IAM pour les machines d'√©tat

AWS Step Functions utilise AWS Identity and Access Management (IAM) pour contr√¥ler l'acc√®s aux ressources et actions au sein des machines d'√©tat. Voici les aspects cl√©s li√©s √† la s√©curit√© et aux r√¥les IAM dans AWS Step Functions :

- **R√¥le d'ex√©cution** : Chaque machine d'√©tat dans AWS Step Functions est associ√©e √† un r√¥le d'ex√©cution IAM. Ce r√¥le d√©finit les actions que la machine d'√©tat peut effectuer en votre nom. Lorsqu'une machine d'√©tat passe d'un √©tat √† un autre qui interagit avec les services AWS (comme l'invocation de fonctions Lambda, l'acc√®s √† DynamoDB, etc.), elle assume ce r√¥le d'ex√©cution pour effectuer ces actions.
- **Permissions** : Le r√¥le d'ex√©cution IAM doit √™tre configur√© avec des permissions permettant les actions n√©cessaires sur d'autres services AWS. Par exemple, si votre machine d'√©tat doit invoquer des fonctions AWS Lambda, le r√¥le IAM doit avoir les permissions **`lambda:InvokeFunction`**. De m√™me, s'il doit √©crire dans DynamoDB, les permissions appropri√©es (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, etc.) doivent √™tre accord√©es.
- **Moindre privil√®ge** : Il est recommand√© de suivre le principe du moindre privil√®ge lors de la configuration des r√¥les IAM pour Step Functions. Cela signifie accorder uniquement les permissions n√©cessaires pour que la machine d'√©tat effectue ses actions sp√©cifiques, et rien de plus. Les politiques IAM doivent √™tre limit√©es √† des ressources et actions sp√©cifiques, r√©duisant ainsi le risque d'acc√®s non intentionnel.

## √ânum√©ration

La politique ReadOnlyAccess est suffisante pour toutes les actions d'√©num√©ration suivantes.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

Sur la page suivante, vous pouvez voir comment **abuser des permissions Step Functions pour escalader les privil√®ges** :

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# R√©f√©rences

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
