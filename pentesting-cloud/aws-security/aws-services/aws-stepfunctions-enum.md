# AWS - Enumeración de Step Functions

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Step Functions

AWS Step Functions es un servicio de flujo de trabajo que te permite coordinar y orquestar múltiples servicios de AWS en flujos de trabajo sin servidor. Al utilizar AWS Step Functions, puedes diseñar y ejecutar flujos de trabajo que conectan varios servicios de AWS como AWS Lambda, Amazon S3, Amazon DynamoDB y muchos más, en una secuencia de pasos. Este servicio de orquestación proporciona una interfaz visual de flujo de trabajo y ofrece capacidades de **máquina de estados**, lo que te permite definir cada paso del flujo de trabajo de manera declarativa utilizando el **Lenguaje de Estados de Amazon** (ASL) basado en JSON.

AWS Step Functions simplifica el proceso de construir aplicaciones resilientes y escalables al gestionar la infraestructura subyacente, manejar reintentos, errores y procesamiento paralelo automáticamente. Es particularmente útil para crear flujos de trabajo complejos que involucran múltiples pasos y puntos de decisión, ya que puede gestionar fácilmente el flujo de datos y el estado de ejecución entre servicios. Los principales casos de uso que se pueden realizar con este servicio son los siguientes:

- **Procesamiento de datos**: Procesamiento de archivos, videos e imágenes; extracción, transformación y carga (ETL) de trabajos; y procesamiento por lotes y cargas de trabajo de computación de alto rendimiento (HPC).
- **Aprendizaje automático**: Detección de fraudes, personalización, recomendación y enriquecimiento de datos.
- **Orquestación de microservicios**: Flujos de trabajo síncronos o en tiempo real y orquestación de contenedores.
- **Automatización de TI y seguridad**: Auto-remediación, implementación y respuesta; y aprobación y escalada humana.

## Conceptos clave

### Flujos de trabajo estándar vs. Express

AWS Step Functions ofrece dos tipos de **flujos de trabajo de máquina de estados**: Estándar y Express.

- **Flujo de trabajo estándar**: Este tipo de flujo de trabajo predeterminado está diseñado para procesos duraderos, auditables y de larga duración. Admite **ejecución exactamente una vez**, asegurando que las tareas se ejecuten solo una vez a menos que se especifiquen reintentos. Es ideal para flujos de trabajo que necesitan un historial de ejecución detallado y puede ejecutarse hasta por un año.
- **Flujo de trabajo Express**: Este tipo es ideal para tareas de alta volumen y corta duración, que se ejecutan hasta cinco minutos. Admiten **ejecución al menos una vez**, adecuadas para tareas idempotentes como el procesamiento de datos. Estos flujos de trabajo están optimizados para costos y rendimiento, cobrando en función de las ejecuciones, la duración y el uso de memoria.

### Estados

Los estados son las unidades esenciales de las máquinas de estados. Definen los pasos individuales dentro de un flujo de trabajo, pudiendo realizar una variedad de funciones según su tipo:

- **Tarea:** Ejecuta un trabajo, a menudo utilizando un servicio de AWS como Lambda.
- **Elección:** Toma decisiones basadas en la entrada.
- **Fallo/Éxito:** Finaliza la ejecución con un fallo o éxito.
- **Pasar:** Pasa la entrada a la salida o inyecta datos.
- **Esperar:** Retrasa la ejecución durante un tiempo establecido.
- **Paralelo:** Inicia ramas paralelas.
- **Mapa:** Itera dinámicamente pasos sobre elementos.

### Tarea

Un estado de **Tarea** representa una unidad de trabajo única ejecutada por una máquina de estados. Las tareas pueden invocar varios recursos, incluidas actividades, funciones Lambda, servicios de AWS o APIs de terceros.

- **Actividades**: Trabajadores personalizados que gestionas, adecuados para procesos de larga duración.
- Recurso: **`arn:aws:states:región:cuenta:actividad:nombre`**.
- **Funciones Lambda**: Ejecuta funciones Lambda de AWS.
- Recurso: **`arn:aws:lambda:región:cuenta:función:nombre-función`**.
- **Servicios de AWS**: Se integra directamente con otros servicios de AWS, como DynamoDB o S3.
- Recurso: **`arn:partición:states:región:cuenta:nombreservicio:nombreAPI`**.
- **Tarea HTTP**: Llama a APIs de terceros.
- Campo de recurso: **`arn:aws:states:::http:invoke`**. Luego, debes proporcionar los detalles de configuración del punto final de la API, como la URL de la API, el método y los detalles de autenticación.

El siguiente ejemplo muestra la definición de un estado de Tarea que invoca una función Lambda llamada HelloWorld:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Elección

Un estado de **Elección** agrega lógica condicional a un flujo de trabajo, permitiendo tomar decisiones basadas en datos de entrada. Evalúa las condiciones especificadas y transiciona al estado correspondiente basado en los resultados.

- **Comparación**: Cada regla de elección incluye un operador de comparación (por ejemplo, **`NumericEquals`**, **`StringEquals`**) que compara una variable de entrada con un valor especificado u otra variable.
- **Campo Siguiente**: Los estados de elección no admiten el campo **`End`**, en su lugar, definen el estado **`Next`** al que se transicionará si la comparación es verdadera.

Ejemplo de estado de **Elección**:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Fallar/Éxito

Un estado de **`Fallar`** detiene la ejecución de una máquina de estados y la marca como fallida. Se utiliza para especificar un nombre de error y una causa, proporcionando detalles sobre el fallo. Este estado es terminal, lo que significa que termina el flujo de ejecución.

Un estado de **`Éxito`** detiene la ejecución exitosamente. Se utiliza típicamente para terminar el flujo de trabajo cuando se completa con éxito. Este estado no requiere un campo **`Siguiente`**.

{% tabs %}

{% tab title="Ejemplo de Fallar" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Ejemplo de éxito" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Paso

Un estado de **Paso** pasa su entrada a su salida ya sea sin realizar ningún trabajo o transformando la entrada de estado JSON usando filtros, y luego pasando los datos transformados al siguiente estado. Es útil para probar y construir máquinas de estado, lo que le permite inyectar datos estáticos o transformarlos.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Espera

Un estado de **Espera** retrasa la ejecución de la máquina de estados por una duración especificada. Hay tres métodos principales para configurar el tiempo de espera:

- **X Segundos**: Un número fijo de segundos para esperar.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **Marca de tiempo Absoluta**: Un momento exacto para esperar hasta.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **Espera Dinámica**: Basada en la entrada utilizando **`SecondsPath`** o **`TimestampPath`**.

```json
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### Paralelo

Un estado **Paralelo** te permite ejecutar múltiples ramas de tareas de forma concurrente dentro de tu flujo de trabajo. Cada rama se ejecuta de forma independiente y procesa su propia secuencia de estados. La ejecución espera hasta que todas las ramas se completen antes de proceder al siguiente estado. Sus campos clave son:

- **Ramas**: Un array que define los caminos de ejecución paralela. Cada rama es una máquina de estados separada.
- **ResultPath**: Define dónde (en la entrada) colocar la salida combinada de las ramas.
- **Reintentar y Capturar**: Configuraciones de manejo de errores para el estado paralelo.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

Un estado **Map** permite la ejecución de un conjunto de pasos para cada elemento en un conjunto de datos. Se utiliza para el procesamiento paralelo de datos. Dependiendo de cómo desee procesar los elementos del conjunto de datos, Step Functions proporciona los siguientes modos:

- **Modo en línea**: Ejecuta un subconjunto de estados para cada elemento de un array JSON. Adecuado para tareas a pequeña escala con menos de 40 iteraciones paralelas, ejecutando cada una de ellas en el contexto del flujo de trabajo que contiene el estado **`Map`**.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Modo distribuido**: Diseñado para procesamiento paralelo a gran escala con alta concurrencia. Admite el procesamiento de conjuntos de datos grandes, como los almacenados en Amazon S3, permitiendo una alta concurrencia de hasta 10,000 ejecuciones de flujos de trabajo paralelos, ejecutando estos hijos como una ejecución de hijo separada.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Versiones y alias

Step Functions también le permite gestionar despliegues de flujos de trabajo a través de **versiones** y **alias** de máquinas de estados. Una versión representa una instantánea de una máquina de estados que puede ser ejecutada. Los alias sirven como punteros a hasta dos versiones de una máquina de estados.

- **Versiones**: Estas instantáneas inmutables de una máquina de estados se crean a partir de la revisión más reciente de esa máquina de estados. Cada versión se identifica con un ARN único que combina el ARN de la máquina de estados con el número de versión, separados por dos puntos (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Las versiones no se pueden editar, pero se puede actualizar la máquina de estados y publicar una nueva versión, o utilizar la versión de la máquina de estados deseada.
- **Alias**: Estos punteros pueden hacer referencia a hasta dos versiones de la misma máquina de estados. Se pueden crear múltiples alias para una sola máquina de estados, cada uno identificado con un ARN único construido combinando el ARN de la máquina de estados con el nombre del alias, separados por dos puntos (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Los alias permiten el enrutamiento de tráfico entre una de las dos versiones de una máquina de estados. Alternativamente, un alias puede apuntar a una versión específica de la máquina de estados, pero no a otros alias. Se pueden actualizar para redirigir a una versión diferente de la máquina de estados según sea necesario, facilitando despliegues controlados y gestión de flujos de trabajo.

Para obtener información más detallada sobre **ASL**, consulte: [**Amazon States Language**](https://states-language.net/spec.html).



## Roles de IAM para máquinas de estados

AWS Step Functions utiliza roles de IAM (Identidad y Acceso de AWS) para controlar el acceso a recursos y acciones dentro de las máquinas de estados. Aquí se presentan los aspectos clave relacionados con la seguridad y los roles de IAM en AWS Step Functions:

- **Rol de ejecución**: Cada máquina de estados en AWS Step Functions está asociada con un rol de ejecución de IAM. Este rol define qué acciones puede realizar la máquina de estados en su nombre. Cuando una máquina de estados transita entre estados que interactúan con servicios de AWS (como invocar funciones Lambda, acceder a DynamoDB, etc.), asume este rol de ejecución para llevar a cabo esas acciones.
- **Permisos**: El rol de ejecución de IAM debe estar configurado con permisos que permitan las acciones necesarias en otros servicios de AWS. Por ejemplo, si su máquina de estados necesita invocar funciones Lambda de AWS, el rol de IAM debe tener permisos de **`lambda:InvokeFunction`**. De manera similar, si necesita escribir en DynamoDB, se deben otorgar los permisos adecuados (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, etc.).
- **Principio de privilegio mínimo**: Se recomienda seguir el principio de privilegio mínimo al configurar roles de IAM para Step Functions. Esto significa otorgar solo los permisos necesarios para que la máquina de estados realice sus acciones específicas, y no más. Las políticas de IAM deben estar limitadas a recursos y acciones específicas, reduciendo el riesgo de acceso no deseado.

## Enumeración

La política ReadOnlyAccess es suficiente para todas las siguientes acciones de enumeración.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Escalada de privilegios

En la siguiente página, puedes verificar cómo **abusar de los permisos de Step Functions para escalar privilegios**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post Explotación

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# Referencias

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
