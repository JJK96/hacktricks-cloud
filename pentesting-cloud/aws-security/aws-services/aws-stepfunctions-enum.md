# AWS - Step Functions Enum

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}

## Step Functions

AWS Step Functions √® un servizio di workflow che ti consente di coordinare e orchestrare pi√π servizi AWS in workflow serverless. Utilizzando AWS Step Functions, puoi progettare ed eseguire workflow che collegano vari servizi AWS come AWS Lambda, Amazon S3, Amazon DynamoDB e molti altri, in una sequenza di passaggi. Questo servizio di orchestrazione fornisce un'interfaccia visiva per i workflow e offre capacit√† di **state machine**, permettendoti di definire ogni passaggio del workflow in modo dichiarativo utilizzando il **Amazon States Language** (ASL) basato su JSON.

AWS Step Functions semplifica il processo di costruzione di applicazioni resilienti e scalabili gestendo l'infrastruttura sottostante, gestendo automaticamente i retry, gli errori e l'elaborazione parallela. √à particolarmente utile per creare workflow complessi che coinvolgono pi√π passaggi e punti decisionali, poich√© pu√≤ gestire facilmente il flusso di dati e lo stato di esecuzione tra i servizi. I principali casi d'uso per questo servizio sono i seguenti:

- **Elaborazione dei dati**: Elaborazione di file, video e immagini; estrazione, trasformazione e caricamento (ETL) di lavori; e elaborazione batch e carichi di lavoro di High Performance Computing (HPC).
- **Machine learning**: Rilevamento delle frodi, personalizzazione, raccomandazione e arricchimento dei dati.
- **Orchestrazione di microservizi**: Workflow sincroni o in tempo reale e orchestrazione di container.
- **Automazione IT e sicurezza**: Auto-remediation, deployment e risposta; e approvazione umana ed escalation.

## Concetti chiave

### Standard vs. Express Workflows

AWS Step Functions offre due tipi di **state machine workflows**: Standard e Express.

- **Standard Workflow**: Questo tipo di workflow predefinito √® progettato per processi di lunga durata, durevoli e auditabili. Supporta l'**esecuzione esattamente una volta**, garantendo che i task vengano eseguiti solo una volta a meno che non siano specificati retry. √à ideale per workflow che necessitano di una cronologia di esecuzione dettagliata e pu√≤ durare fino a un anno.
- **Express Workflow**: Questo tipo √® ideale per task di breve durata e ad alto volume, con una durata massima di cinque minuti. Supportano l'**esecuzione almeno una volta**, adatti per task idempotenti come l'elaborazione dei dati. Questi workflow sono ottimizzati per costi e prestazioni, addebitando in base alle esecuzioni, alla durata e all'uso della memoria.

### Stati

Gli stati sono le unit√† essenziali delle state machines. Definiscono i singoli passaggi all'interno di un workflow, essendo in grado di eseguire una variet√† di funzioni a seconda del tipo:

- **Task:** Esegue un lavoro, spesso utilizzando un servizio AWS come Lambda.
- **Choice:** Prende decisioni basate sull'input.
- **Fail/Succeed:** Termina l'esecuzione con un fallimento o un successo.
- **Pass:** Passa l'input all'output o inietta dati.
- **Wait:** Ritarda l'esecuzione per un tempo impostato.
- **Parallel:** Inizia rami paralleli.
- **Map:** Itera dinamicamente i passaggi sugli elementi.

### Task

Uno stato **Task** rappresenta una singola unit√† di lavoro eseguita da una state machine. I task possono invocare varie risorse, inclusi attivit√†, funzioni Lambda, servizi AWS o API di terze parti.

- **Activities**: Worker personalizzati che gestisci, adatti per processi di lunga durata.
- Resource: **`arn:aws:states:region:account:activity:name`**.
- **Lambda Functions**: Esegue funzioni AWS Lambda.
- Resource: **`arn:aws:lambda:region:account:function:function-name`**.
- **AWS Services**: Si integra direttamente con altri servizi AWS, come DynamoDB o S3.
- Resource: **`arn:partition:states:region:account:servicename:APIname`**.
- **HTTP Task**: Chiama API di terze parti.
- Resource field: **`arn:aws:states:::http:invoke`**. Poi, dovresti fornire i dettagli di configurazione dell'endpoint API, come l'URL dell'API, il metodo e i dettagli di autenticazione.

Il seguente esempio mostra una definizione di stato Task che invoca una funzione Lambda chiamata HelloWorld:
```json
"HelloWorld": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"Payload.$": "$",
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:HelloWorld"
},
"End": true
}
```
### Choice

Uno stato **Choice** aggiunge logica condizionale a un workflow, consentendo decisioni basate sui dati di input. Valuta le condizioni specificate e transita allo stato corrispondente in base ai risultati.

- **Comparison**: Ogni regola di scelta include un operatore di confronto (ad esempio, **`NumericEquals`**, **`StringEquals`**) che confronta una variabile di input con un valore specificato o un'altra variabile.
- **Next Field**: Gli stati di scelta non supportano il campo **`End`**, invece, definiscono lo stato **`Next`** a cui transitare se il confronto √® vero.

Esempio di stato **Choice**:
```json
{
"Variable": "$.timeStamp",
"TimestampEquals": "2000-01-01T00:00:00Z",
"Next": "TimeState"
}
```
### Fail/Succeed

Uno stato **`Fail`** interrompe l'esecuzione di una state machine e la segna come un fallimento. Viene utilizzato per specificare un nome di errore e una causa, fornendo dettagli sul fallimento. Questo stato √® terminale, il che significa che termina il flusso di esecuzione.

Uno stato **`Succeed`** interrompe l'esecuzione con successo. Viene tipicamente utilizzato per terminare il workflow quando si completa con successo. Questo stato non richiede un campo **`Next`**.

{% tabs %}

{% tab title="Fail example" %}
```json
"FailState": {
"Type": "Fail",
"Error": "ErrorName",
"Cause": "Error details"
}
```
{% endtab %}

{% tab title="Esempio di successo" %}
```json
"SuccessState": {
"Type": "Succeed"
}
```
### Pass

Uno stato **Pass** passa il suo input al suo output senza eseguire alcun lavoro o trasformando l'input dello stato JSON utilizzando filtri, e poi passando i dati trasformati allo stato successivo. √à utile per testare e costruire macchine a stati, permettendoti di iniettare dati statici o trasformarli.
```json
"PassState": {
"Type": "Pass",
"Result": {"key": "value"},
"ResultPath": "$.newField",
"Next": "NextState"
}
```
### Wait

Uno stato **Wait** ritarda l'esecuzione della state machine per una durata specificata. Ci sono tre metodi principali per configurare il tempo di attesa:

- **X Seconds**: Un numero fisso di secondi di attesa.

```json
"WaitState": {
"Type": "Wait",
"Seconds": 10,
"Next": "NextState"
}
```

- **Absolute Timestamp**: Un tempo esatto fino al quale attendere.

```json
"WaitState": {
"Type": "Wait",
"Timestamp": "2024-03-14T01:59:00Z",
"Next": "NextState"
}
```

- **Dynamic Wait**: Basato sull'input utilizzando **`SecondsPath`** o **`TimestampPath`**.

```json
jsonCopiar c√≥digo
"WaitState": {
"Type": "Wait",
"TimestampPath": "$.expirydate",
"Next": "NextState"
}
```


### Parallel

Uno stato **Parallel** consente di eseguire pi√π rami di compiti contemporaneamente all'interno del tuo workflow. Ogni ramo funziona in modo indipendente e processa la propria sequenza di stati. L'esecuzione attende fino a quando tutti i rami non sono completati prima di procedere allo stato successivo. I suoi campi chiave sono:

- **Branches**: Un array che definisce i percorsi di esecuzione parallela. Ogni ramo √® una state machine separata.
- **ResultPath**: Definisce dove (nell'input) posizionare l'output combinato dei rami.
- **Retry and Catch**: Configurazioni di gestione degli errori per lo stato parallelo.
```json
"ParallelState": {
"Type": "Parallel",
"Branches": [
{
"StartAt": "Task1",
"States": { ... }
},
{
"StartAt": "Task2",
"States": { ... }
}
],
"Next": "NextState"
}
```
### Map

Uno stato **Map** consente l'esecuzione di una serie di passaggi per ciascun elemento in un dataset. √à utilizzato per l'elaborazione parallela dei dati. A seconda di come si desidera elaborare gli elementi del dataset, Step Functions fornisce le seguenti modalit√†:

- **Modalit√† Inline**: Esegue un sottoinsieme di stati per ciascun elemento dell'array JSON. Adatto per attivit√† su piccola scala con meno di 40 iterazioni parallele, eseguendo ciascuna di esse nel contesto del workflow che contiene lo stato **`Map`**.

```json
"MapState": {
"Type": "Map",
"ItemsPath": "$.arrayItems",
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "INLINE"
},
"StartAt": "AddState",
"States": {
"AddState": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"OutputPath": "$.Payload",
"Parameters": {
"FunctionName": "arn:aws:lambda:<region>:<account-id>:function:add-function"
},
"End": true
}
}
},
"End": true
"ResultPath": "$.detail.added",
"ItemsPath": "$.added"
}
```

- **Modalit√† Distribuita**: Progettata per l'elaborazione parallela su larga scala con alta concorrenza. Supporta l'elaborazione di grandi dataset, come quelli archiviati in Amazon S3, consentendo un'alta concorrenza fino a 10.000 esecuzioni parallele di workflow figli, eseguendo questi figli come esecuzioni separate.

```json
"DistributedMapState": {
"Type": "Map",
"ItemReader": {
"Resource": "arn:aws:states:::s3:getObject",
"Parameters": {
"Bucket": "my-bucket",
"Key": "data.csv"
}
},
"ItemProcessor": {
"ProcessorConfig": {
"Mode": "DISTRIBUTED",
"ExecutionType": "EXPRESS"
},
"StartAt": "ProcessItem",
"States": {
"ProcessItem": {
"Type": "Task",
"Resource": "arn:aws:lambda:region:account-id:function:my-function",
"End": true
}
}
},
"End": true
"ResultWriter": {
"Resource": "arn:aws:states:::s3:putObject",
"Parameters": {
"Bucket": "myOutputBucket",
"Prefix": "csvProcessJobs"
}
}
}
```


### Versioni e alias

Step Functions consente anche di gestire le distribuzioni dei workflow tramite **versioni** e **alias** delle macchine a stati. Una versione rappresenta un'istantanea di una macchina a stati che pu√≤ essere eseguita. Gli alias fungono da puntatori a un massimo di due versioni di una macchina a stati.

- **Versioni**: Queste istantanee immutabili di una macchina a stati sono create dall'ultima revisione di quella macchina a stati. Ogni versione √® identificata da un ARN univoco che combina l'ARN della macchina a stati con il numero di versione, separati da due punti (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:version-number`**). Le versioni non possono essere modificate, ma √® possibile aggiornare la macchina a stati e pubblicare una nuova versione, o utilizzare la versione desiderata della macchina a stati.
- **Alias**: Questi puntatori possono fare riferimento a un massimo di due versioni della stessa macchina a stati. Possono essere creati pi√π alias per una singola macchina a stati, ciascuno identificato da un ARN univoco costruito combinando l'ARN della macchina a stati con il nome dell'alias, separati da due punti (**`arn:aws:states:region:account-id:stateMachine:StateMachineName:aliasName`**). Gli alias consentono di instradare il traffico tra una delle due versioni di una macchina a stati. In alternativa, un alias pu√≤ puntare a una singola versione specifica della macchina a stati, ma non ad altri alias. Possono essere aggiornati per reindirizzare a una versione diversa della macchina a stati secondo necessit√†, facilitando distribuzioni controllate e gestione dei workflow.

Per informazioni pi√π dettagliate su **ASL**, consulta: [**Amazon States Language**](https://states-language.net/spec.html).



## Ruoli IAM per le macchine a stati

AWS Step Functions utilizza AWS Identity and Access Management (IAM) ruoli per controllare l'accesso alle risorse e alle azioni all'interno delle macchine a stati. Ecco gli aspetti chiave relativi alla sicurezza e ai ruoli IAM in AWS Step Functions:

- **Ruolo di Esecuzione**: Ogni macchina a stati in AWS Step Functions √® associata a un ruolo di esecuzione IAM. Questo ruolo definisce quali azioni la macchina a stati pu√≤ eseguire per conto dell'utente. Quando una macchina a stati passa tra stati che interagiscono con i servizi AWS (come l'invocazione di funzioni Lambda, l'accesso a DynamoDB, ecc.), assume questo ruolo di esecuzione per eseguire tali azioni.
- **Permessi**: Il ruolo di esecuzione IAM deve essere configurato con permessi che consentano le azioni necessarie su altri servizi AWS. Ad esempio, se la tua macchina a stati deve invocare funzioni AWS Lambda, il ruolo IAM deve avere permessi **`lambda:InvokeFunction`**. Allo stesso modo, se deve scrivere su DynamoDB, devono essere concessi i permessi appropriati (**`dynamodb:PutItem`**, **`dynamodb:UpdateItem`**, ecc.).
- **Minimo Privilegio**: Si raccomanda di seguire il principio del minimo privilegio quando si configurano i ruoli IAM per Step Functions. Ci√≤ significa concedere solo i permessi necessari affinch√© la macchina a stati possa eseguire le sue azioni specifiche, e niente di pi√π. Le politiche IAM dovrebbero essere limitate a risorse e azioni specifiche, riducendo il rischio di accessi non intenzionali.

## Enumerazione

La policy ReadOnlyAccess √® sufficiente per tutte le seguenti azioni di enumerazione.
```bash
# State machines #

## List state machines
aws stepfunctions list-state-machines
## Retrieve informatio about the specified state machine
aws stepfunctions describe-state-machine --state-machine-arn <value>

## List verions for the specified state machine
aws stepfunctions list-state-machine-versions --state-machine-arn <value>
## List aliases for the specified state machine
aws stepfunctions list-state-machine-aliases --state-machine-arn <value>
## Retrieve informatio about the specified state machine alias
aws stepfunctions describe-state-machine-alias --state-machine-alias-arn <value>

## List executions of a state machine
aws stepfunctions list-executions --state-machine-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
## Retrieve information and relevant metadata about a state machine execution
aws stepfunctions describe-execution --execution-arn <value>
## Retrieve information about the state machine associated to the specified execution
aws stepfunctions describe-state-machine-for-execution --execution-arn <value>
## Retrieve the history of the specified execution as a list of events
aws stepfunctions get-execution-history --execution-arn <value> [--reverse-order | --no-reverse-order] [--include-execution-data | --no-include-execution-data]

## List tags for the specified Ste Functions resource
aws stepfunctions list-tags-for-resource --resource-arn <value>

## Validate the definition of a state machine without creating the resource
aws stepfunctions validate-state-machine-definition --definition <value> [--type <STANDARD | EXPRESS>]

# Activities #

## List existing activities
aws stepfunctions list-activities
## Retrieve information about the specified activity
aws stepfunctions describe-activity --activity-arn <value>

# Map Runs #

## List map runs of an execution
aws stepfunctions list-map-runs --execution-arn <value>
## Provide information about the configuration, progress and results of a Map Run
aws stepfunctions describe-map-run --map-run-arn <value>
## Lists executions of a Map Run
aws stepfunctions list-executions --map-run-arn <value> [--status-filter <RUNNING | SUCCEEDED | FAILED | TIMED_OUT | ABORTED | PENDING_REDRIVE>] [--redrive-filter <REDRIVEN | NOT_REDRIVEN>]
```
## Privesc

Nella seguente pagina, puoi vedere come **abusare dei permessi di Step Functions per scalare i privilegi**:

{% content-ref url="../aws-privilege-escalation/aws-stepfunctions-privesc.md" %}
[aws-stepfunctions-privesc.md](../aws-privilege-escalation/aws-stepfunctions-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-stepfunctions-post-exploitation/" %}
[aws-stepfunctions-post-exploitation](../aws-post-exploitation/aws-stepfunctions-post-exploitation/)
{% endcontent-ref %}

# Riferimenti

* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsstepfunctions.html)
* [https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)
* [https://states-language.net/spec.html](https://states-language.net/spec.html)

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository su github.

</details>
{% endhint %}
