# AWS - STS Enum

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Δείτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## STS

**AWS Security Token Service (STS)** έχει σχεδιαστεί κυρίως για την έκδοση **προσωρινών, περιορισμένων προνομίων διαπιστευτηρίων**. Αυτά τα διαπιστευτήρια μπορούν να ζητηθούν για **AWS Identity and Access Management (IAM)** χρήστες ή για αυθεντικοποιημένους χρήστες (ομοσπονδιακούς χρήστες).

Δεδομένου ότι ο σκοπός του STS είναι να **εκδίδει διαπιστευτήρια για την προσωποποίηση ταυτότητας**, η υπηρεσία είναι εξαιρετικά πολύτιμη για **κλιμάκωση προνομίων και διατήρηση της επιμονής**, παρόλο που μπορεί να μην έχει μια ευρεία γκάμα επιλογών.

### Assume Role Impersonation

Η ενέργεια [AssumeRole](https://docs.aws.amazon.com/STS/latest/APIReference/API\_AssumeRole.html) που παρέχεται από το AWS STS είναι κρίσιμη καθώς επιτρέπει σε έναν principal να αποκτήσει διαπιστευτήρια για έναν άλλο principal, ουσιαστικά προσωποποιώντας τον. Κατά την κλήση, απαντά με ένα access key ID, ένα secret key και ένα session token που αντιστοιχούν στο καθορισμένο ARN.

Για τους Penetration Testers ή τα μέλη της Red Team, αυτή η τεχνική είναι καθοριστική για την κλιμάκωση προνομίων (όπως αναλύεται [**εδώ**](../aws-privilege-escalation/aws-sts-privesc.md#sts-assumerole)). Ωστόσο, αξίζει να σημειωθεί ότι αυτή η τεχνική είναι αρκετά εμφανής και μπορεί να μην πιάσει έναν επιτιθέμενο απροετοίμαστο.

#### Assume Role Logic

Για να αναλάβετε έναν ρόλο στον ίδιο λογαριασμό αν ο **ρόλος που θα αναλάβετε επιτρέπει συγκεκριμένα ένα role ARN** όπως στο:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:role/priv-role"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
Ο ρόλος **`priv-role`** σε αυτή την περίπτωση, **δεν χρειάζεται να επιτραπεί συγκεκριμένα** να αναλάβει αυτόν τον ρόλο (με αυτή την άδεια είναι αρκετό).

Ωστόσο, αν ένας ρόλος επιτρέπει σε έναν λογαριασμό να τον αναλάβει, όπως στο:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:root"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
Ο ρόλος που προσπαθεί να τον αναλάβει θα χρειαστεί μια **συγκεκριμένη άδεια `sts:AssumeRole`** πάνω σε αυτόν τον ρόλο **για να τον αναλάβει**.

Αν προσπαθήσετε να αναλάβετε έναν **ρόλο** **από διαφορετικό λογαριασμό**, ο **αναληφθείς ρόλος πρέπει να το επιτρέπει** (υποδεικνύοντας το **ARN** του ρόλου ή τον **εξωτερικό λογαριασμό**), και ο **ρόλος που προσπαθεί να αναλάβει** τον άλλον **ΠΡΕΠΕΙ** να **έχει άδειες να τον αναλάβει** (σε αυτή την περίπτωση αυτό δεν είναι προαιρετικό ακόμα και αν ο αναληφθείς ρόλος καθορίζει ένα ARN).

### Enumeration
```bash
# Get basic info of the creds
aws sts get-caller-identity
aws sts get-access-key-info --access-key-id <AccessKeyID>

# Get CLI a session token with current creds
## Using CLI creds
## You cannot get session creds using session creds
aws sts get-session-token
## MFA
aws sts get-session-token --serial-number <arn_device> --token-code <otp_code>
```
### Privesc

Στην ακόλουθη σελίδα μπορείτε να δείτε πώς να **εκμεταλλευτείτε τα δικαιώματα STS για να κλιμακώσετε προνόμια**:

{% content-ref url="../aws-privilege-escalation/aws-sts-privesc.md" %}
[aws-sts-privesc.md](../aws-privilege-escalation/aws-sts-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-sts-post-exploitation.md" %}
[aws-sts-post-exploitation.md](../aws-post-exploitation/aws-sts-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-sts-persistence.md" %}
[aws-sts-persistence.md](../aws-persistence/aws-sts-persistence.md)
{% endcontent-ref %}

## References

* [https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Δείτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
