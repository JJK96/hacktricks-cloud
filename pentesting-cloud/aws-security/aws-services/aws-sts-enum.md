# AWS - STS Enum

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## STS

**AWS Security Token Service (STS)** öncelikle **geçici, sınırlı ayrıcalıklı kimlik bilgileri** sağlamak için tasarlanmıştır. Bu kimlik bilgileri, **AWS Identity and Access Management (IAM)** kullanıcıları veya kimliği doğrulanmış kullanıcılar (federasyon kullanıcıları) için talep edilebilir.

STS'nin amacı **kimlik taklidi için kimlik bilgileri sağlamak** olduğundan, hizmet **ayrıcalıkların yükseltilmesi ve kalıcılığın sağlanması** için son derece değerlidir, ancak çok geniş bir seçenek yelpazesine sahip olmayabilir.

### Assume Role Taklidi

AWS STS tarafından sağlanan [AssumeRole](https://docs.aws.amazon.com/STS/latest/APIReference/API\_AssumeRole.html) eylemi, bir prensipin başka bir prensip için kimlik bilgileri edinmesine izin verdiği için kritik öneme sahiptir, esasen onları taklit eder. Çağrıldığında, belirtilen ARN'ye karşılık gelen bir erişim anahtarı kimliği, bir gizli anahtar ve bir oturum belirteci ile yanıt verir.

Penetrasyon Testçileri veya Red Team üyeleri için, bu teknik ayrıcalıkların yükseltilmesi için (daha fazla bilgi [**burada**](../aws-privilege-escalation/aws-sts-privesc.md#sts-assumerole)) çok önemlidir. Ancak, bu tekniğin oldukça belirgin olduğunu ve bir saldırganı şaşırtmayabileceğini belirtmek gerekir.

#### Assume Role Mantığı

**Rol ARN'sini özel olarak izin veren bir rolü** aynı hesapta üstlenmek için:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:role/priv-role"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
Rol **`priv-role`** bu durumda, **özellikle izin verilmesine gerek yoktur** o rolü üstlenmek için (bu izin yeterlidir).

Ancak, bir rol bir hesabın onu üstlenmesine izin veriyorsa, şu şekilde:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:root"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
Rolü üstlenmeye çalışan rolün, o rolü **üstlenmek için belirli bir `sts:AssumeRole` iznine** sahip olması gerekecektir.

**Farklı bir hesaptan** bir **rolü üstlenmeye** çalışırsanız, **üstlenilen rol bunu izin vermelidir** (rol **ARN**'ini veya **harici hesabı** belirterek) ve diğerini **üstlenmeye çalışan rolün** onu **üstlenmek için izinlere sahip olması GEREKİR** (bu durumda, üstlenilen rol bir ARN belirtiyor olsa bile bu isteğe bağlı değildir).

### Enumeration
```bash
# Get basic info of the creds
aws sts get-caller-identity
aws sts get-access-key-info --access-key-id <AccessKeyID>

# Get CLI a session token with current creds
## Using CLI creds
## You cannot get session creds using session creds
aws sts get-session-token
## MFA
aws sts get-session-token --serial-number <arn_device> --token-code <otp_code>
```
### Privesc

Aşağıdaki sayfada **STS izinlerini kötüye kullanarak ayrıcalıkları nasıl yükseltebileceğinizi** kontrol edebilirsiniz:

{% content-ref url="../aws-privilege-escalation/aws-sts-privesc.md" %}
[aws-sts-privesc.md](../aws-privilege-escalation/aws-sts-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-sts-post-exploitation.md" %}
[aws-sts-post-exploitation.md](../aws-post-exploitation/aws-sts-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-sts-persistence.md" %}
[aws-sts-persistence.md](../aws-persistence/aws-sts-persistence.md)
{% endcontent-ref %}

## References

* [https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) bizi takip edin.
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek hacking ipuçlarını paylaşın.

</details>
{% endhint %}
