# AWS - STS Enum

{% hint style="success" %}
AWSハッキングを学び、練習する:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングを学び、練習する: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする。
* PRを提出して[**HackTricks**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリでハッキングトリックを共有する。

</details>
{% endhint %}

## STS

**AWS Security Token Service (STS)**は主に**一時的で限定的な特権を持つ資格情報**を発行するために設計されています。これらの資格情報は、**AWS Identity and Access Management (IAM)**ユーザーや認証済みユーザー（フェデレーテッドユーザー）のためにリクエストすることができます。

STSの目的が**アイデンティティの偽装のための資格情報を発行する**ことであるため、このサービスは**特権の昇格や持続性の維持**に非常に価値がありますが、オプションの幅は広くないかもしれません。

### Assume Role Impersonation

AWS STSが提供する[AssumeRole](https://docs.aws.amazon.com/STS/latest/APIReference/API\_AssumeRole.html)アクションは、プリンシパルが他のプリンシパルの資格情報を取得し、実質的にそれを偽装することを許可するため、非常に重要です。呼び出されると、指定されたARNに対応するアクセスキーID、シークレットキー、およびセッショントークンを返します。

ペネトレーションテスターやRed Teamメンバーにとって、この技術は特権の昇格に役立ちます（詳細は[**こちら**](../aws-privilege-escalation/aws-sts-privesc.md#sts-assumerole)）。ただし、この技術は非常に目立ちやすく、攻撃者を驚かせることはないかもしれません。

#### Assume Role Logic

**特定のロールARNを許可しているロール**のように、同じアカウント内でロールを引き受ける場合:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:role/priv-role"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
ロール **`priv-role`** はこの場合、**特に許可されていなくても** そのロールを引き受けることができます（その許可があれば十分です）。

しかし、ロールがアカウントに対してそれを引き受けることを許可している場合、次のようになります:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:root"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
そのロールを引き受けようとするロールは、それを引き受けるための**特定の `sts:AssumeRole` 権限**が必要です。

**異なるアカウントからロールを引き受けようとする場合**、**引き受けられるロールがそれを許可する必要があります**（ロールの**ARN**または**外部アカウント**を指定する）、そして他のロールを引き受けようとするロールはそれを引き受ける**権限を持っている必要があります**（この場合、引き受けられるロールがARNを指定している場合でもこれは必須です）。

### Enumeration
```bash
# Get basic info of the creds
aws sts get-caller-identity
aws sts get-access-key-info --access-key-id <AccessKeyID>

# Get CLI a session token with current creds
## Using CLI creds
## You cannot get session creds using session creds
aws sts get-session-token
## MFA
aws sts get-session-token --serial-number <arn_device> --token-code <otp_code>
```
### Privesc

以下のページで**STS権限を悪用して権限を昇格させる**方法を確認できます：

{% content-ref url="../aws-privilege-escalation/aws-sts-privesc.md" %}
[aws-sts-privesc.md](../aws-privilege-escalation/aws-sts-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-sts-post-exploitation.md" %}
[aws-sts-post-exploitation.md](../aws-post-exploitation/aws-sts-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-sts-persistence.md" %}
[aws-sts-persistence.md](../aws-persistence/aws-sts-persistence.md)
{% endcontent-ref %}

## References

* [https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist)

{% hint style="success" %}
AWS Hackingを学び、練習する:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingを学び、練習する: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする。
* **ハッキングトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出してください。

</details>
{% endhint %}
