# AWS - Lambda Enum

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Lambda

Amazon Web Services (AWS) Lambda περιγράφεται ως μια **υπηρεσία υπολογισμού** που επιτρέπει την εκτέλεση κώδικα χωρίς την ανάγκη για παροχή ή διαχείριση διακομιστών. Χαρακτηρίζεται από την ικανότητά της να **χειρίζεται αυτόματα την κατανομή πόρων** που απαιτούνται για την εκτέλεση του κώδικα, εξασφαλίζοντας χαρακτηριστικά όπως υψηλή διαθεσιμότητα, κλιμακωσιμότητα και ασφάλεια. Ένα σημαντικό χαρακτηριστικό του Lambda είναι το μοντέλο τιμολόγησής του, όπου **οι χρεώσεις βασίζονται αποκλειστικά στον χρόνο υπολογισμού που χρησιμοποιείται**, εξαλείφοντας την ανάγκη για αρχικές επενδύσεις ή μακροπρόθεσμες υποχρεώσεις.

Για να καλέσετε ένα lambda είναι δυνατό να το καλέσετε **όσο συχνά θέλετε** (με Cloudwatch), **να εκθέσετε** ένα **URL** endpoint και να το καλέσετε, να το καλέσετε μέσω **API Gateway** ή ακόμα και με βάση **γεγονότα** όπως **αλλαγές** σε δεδομένα σε έναν **S3** bucket ή ενημερώσεις σε έναν **DynamoDB** πίνακα.

Ο **κώδικας** ενός lambda αποθηκεύεται στο **`/var/task`**.

### Lambda Aliases Weights

Ένα Lambda μπορεί να έχει **πολλές εκδόσεις**.\
Και μπορεί να έχει **περισσότερες από 1** εκδόσεις εκτεθειμένες μέσω **aliases**. Τα **weights** των **κάθε** εκδόσεων που εκτίθενται μέσα σε ένα alias θα αποφασίσουν **ποιο alias θα λάβει την κλήση** (μπορεί να είναι 90%-10% για παράδειγμα).\
Αν ο κώδικας **ενός** από τα aliases είναι **ευάλωτος** μπορείτε να στείλετε **αιτήματα μέχρι η ευάλωτη** έκδοση να λάβει την εκμετάλλευση.

![](<../../../.gitbook/assets/image (223).png>)

### Resource Policies

Οι πολιτικές πόρων του Lambda επιτρέπουν να **δώσετε πρόσβαση σε άλλες υπηρεσίες/λογαριασμούς για να καλέσουν** το lambda για παράδειγμα.\
Για παράδειγμα αυτή είναι η πολιτική για να επιτρέψετε **σε οποιονδήποτε να έχει πρόσβαση σε ένα lambda εκτεθειμένο μέσω URL**:

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

Ή αυτή για να επιτρέψετε σε ένα API Gateway να το καλέσει:

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Lambda Database Proxies

Όταν υπάρχουν **εκατοντάδες** **ταυτόχρονες αιτήσεις lambda**, αν κάθε μία από αυτές χρειάζεται να **συνδεθεί και να κλείσει μια σύνδεση με μια βάση δεδομένων**, απλά δεν θα λειτουργήσει (τα lambdas είναι stateless, δεν μπορούν να διατηρήσουν ανοιχτές συνδέσεις).\
Τότε, αν οι **λειτουργίες Lambda σας αλληλεπιδρούν με το RDS Proxy αντί** για την βάση δεδομένων σας. Χειρίζεται την συγκέντρωση συνδέσεων που είναι απαραίτητη για την κλιμάκωση πολλών ταυτόχρονων συνδέσεων που δημιουργούνται από ταυτόχρονες λειτουργίες Lambda. Αυτό επιτρέπει στις εφαρμογές Lambda σας να **επανχρησιμοποιούν υπάρχουσες συνδέσεις**, αντί να δημιουργούν νέες συνδέσεις για κάθε κλήση λειτουργίας.

### Lambda EFS Filesystems

Για να διατηρήσουν και ακόμη και να μοιραστούν δεδομένα **τα Lambdas μπορούν να έχουν πρόσβαση στο EFS και να τα προσαρτήσουν**, έτσι το Lambda θα μπορεί να διαβάζει και να γράφει από αυτό.

### Lambda Layers

Ένα Lambda _layer_ είναι ένα αρχείο .zip που **μπορεί να περιέχει επιπλέον κώδικα** ή άλλο περιεχόμενο. Ένα layer μπορεί να περιέχει βιβλιοθήκες, ένα [custom runtime](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), δεδομένα ή αρχεία διαμόρφωσης.

Είναι δυνατό να συμπεριλάβετε έως **πέντε layers ανά λειτουργία**. Όταν συμπεριλαμβάνετε ένα layer σε μια λειτουργία, τα **περιεχόμενα εξάγονται στον κατάλογο `/opt`** στο περιβάλλον εκτέλεσης.

Από **προεπιλογή**, τα **layers** που δημιουργείτε είναι **ιδιωτικά** για τον λογαριασμό σας στο AWS. Μπορείτε να επιλέξετε να **μοιραστείτε** ένα layer με άλλους λογαριασμούς ή να **κάνετε** το layer **δημόσιο**. Αν οι λειτουργίες σας καταναλώνουν ένα layer που δημοσίευσε ένας άλλος λογαριασμός, οι λειτουργίες σας μπορούν **να συνεχίσουν να χρησιμοποιούν την έκδοση του layer μετά την διαγραφή του, ή μετά την ανάκληση της άδειάς σας για πρόσβαση στο layer**. Ωστόσο, δεν μπορείτε να δημιουργήσετε μια νέα λειτουργία ή να ενημερώσετε λειτουργίες χρησιμοποιώντας μια διαγραμμένη έκδοση layer.

Οι λειτουργίες που αναπτύσσονται ως εικόνα κοντέινερ δεν χρησιμοποιούν layers. Αντίθετα, πακετάρετε το προτιμώμενο runtime, τις βιβλιοθήκες και άλλες εξαρτήσεις στην εικόνα κοντέινερ όταν δημιουργείτε την εικόνα.

### Lambda Extensions

Οι επεκτάσεις Lambda ενισχύουν τις λειτουργίες ενσωματώνοντας διάφορα **εργαλεία παρακολούθησης, παρατηρησιμότητας, ασφάλειας και διακυβέρνησης**. Αυτές οι επεκτάσεις, που προστίθενται μέσω [.zip αρχείων χρησιμοποιώντας Lambda layers](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ή περιλαμβάνονται σε [αναπτύξεις εικόνας κοντέινερ](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), λειτουργούν σε δύο τρόπους: **εσωτερικό** και **εξωτερικό**.

* **Εσωτερικές επεκτάσεις** συγχωνεύονται με τη διαδικασία runtime, χειριζόμενες την εκκίνησή της χρησιμοποιώντας **μεταβλητές περιβάλλοντος ειδικές για τη γλώσσα** και **σενάρια περιτυλίγματος**. Αυτή η προσαρμογή εφαρμόζεται σε μια σειρά από runtimes, συμπεριλαμβανομένων των **Java Correto 8 και 11, Node.js 10 και 12, και .NET Core 3.1**.
* **Εξωτερικές επεκτάσεις** λειτουργούν ως ξεχωριστές διαδικασίες, διατηρώντας την ευθυγράμμιση λειτουργίας με τον κύκλο ζωής της λειτουργίας Lambda. Είναι συμβατές με διάφορα runtimes όπως **Node.js 10 και 12, Python 3.7 και 3.8, Ruby 2.5 και 2.7, Java Corretto 8 και 11, .NET Core 3.1**, και **custom runtimes**.

### Enumeration
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### Εκτέλεση μιας lambda

#### Χειροκίνητα
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### Via exposed URL

Μπορούμε να καλέσουμε τη λειτουργία Lambda μέσω του URL που εκτίθεται. Αυτό μπορεί να μας επιτρέψει να εκτελέσουμε τη λειτουργία και να δούμε την έξοδο της.

#### Via AWS CLI

Μπορούμε να χρησιμοποιήσουμε το AWS CLI για να καλέσουμε τη λειτουργία Lambda και να δούμε την έξοδο της. Για παράδειγμα:

```bash
aws lambda invoke --function-name <function_name> output.txt
cat output.txt
```

#### Via AWS SDK

Μπορούμε να χρησιμοποιήσουμε το AWS SDK για να καλέσουμε τη λειτουργία Lambda και να δούμε την έξοδο της. Για παράδειγμα, χρησιμοποιώντας το boto3 SDK για Python:

```python
import boto3

client = boto3.client('lambda')
response = client.invoke(
    FunctionName='<function_name>'
)

print(response['Payload'].read().decode('utf-8'))
```

#### Via AWS Management Console

Μπορούμε να καλέσουμε τη λειτουργία Lambda μέσω του AWS Management Console και να δούμε την έξοδο της.
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### Κλήση Lambda function μέσω URL

Τώρα είναι η ώρα να βρούμε πιθανές lambda functions για εκτέλεση:
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (262).png>)

Μια συνάρτηση lambda που ονομάζεται "Level6" είναι διαθέσιμη. Ας δούμε πώς να την καλέσουμε:
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
![](<../../../.gitbook/assets/image (102).png>)

Τώρα, που ξέρετε το όνομα και το ID μπορείτε να πάρετε το Όνομα:
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (237).png>)

And finally call the function accessing (notice that the ID, Name and function-name appears in the URL): [https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### Άλλες Ενεργοποιήσεις

Υπάρχουν πολλές άλλες πηγές που μπορούν να ενεργοποιήσουν μια lambda

<figure><img src="../../../.gitbook/assets/image (167).png" alt=""><figcaption></figcaption></figure>

### Privesc

Στην ακόλουθη σελίδα μπορείτε να δείτε πώς να **εκμεταλλευτείτε τα δικαιώματα Lambda για να κλιμακώσετε προνόμια**:

{% content-ref url="../aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### Μη Εξουσιοδοτημένη Πρόσβαση

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### Μετα-Εκμετάλλευση

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### Εμμονή

{% content-ref url="../aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## Αναφορές

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
