# AWS - Lambda Enum

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no Telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Lambda

Amazon Web Services (AWS) Lambda √© descrito como um **servi√ßo de computa√ß√£o** que permite a execu√ß√£o de c√≥digo sem a necessidade de provisionamento ou gerenciamento de servidores. √â caracterizado por sua capacidade de **gerenciar automaticamente a aloca√ß√£o de recursos** necess√°ria para a execu√ß√£o do c√≥digo, garantindo recursos como alta disponibilidade, escalabilidade e seguran√ßa. Um aspecto significativo do Lambda √© seu modelo de precifica√ß√£o, onde **as cobran√ßas s√£o baseadas apenas no tempo de computa√ß√£o utilizado**, eliminando a necessidade de investimentos iniciais ou obriga√ß√µes de longo prazo.

Para chamar uma lambda √© poss√≠vel cham√°-la **com a frequ√™ncia que desejar** (com Cloudwatch), **expor** um **endpoint URL** e cham√°-lo, cham√°-lo via **API Gateway** ou at√© mesmo com base em **eventos** como **mudan√ßas** em dados em um bucket **S3** ou atualiza√ß√µes em uma tabela **DynamoDB**.

O **c√≥digo** de uma lambda √© armazenado em **`/var/task`**.

### Lambda Aliases Weights

Uma Lambda pode ter **v√°rias vers√µes**.\
E pode ter **mais de uma** vers√£o exposta via **aliases**. Os **pesos** de **cada** uma das **vers√µes** expostas dentro de um alias decidir√£o **qual alias receber√° a invoca√ß√£o** (pode ser 90%-10%, por exemplo).\
Se o c√≥digo de **um** dos aliases for **vulner√°vel**, voc√™ pode enviar **requisi√ß√µes at√© que a vers√£o vulner√°vel** receba o exploit.

![](<../../../.gitbook/assets/image (223).png>)

### Resource Policies

As pol√≠ticas de recursos do Lambda permitem **dar acesso a outros servi√ßos/contas para invocar** a lambda, por exemplo.\
Por exemplo, esta √© a pol√≠tica para permitir que **qualquer pessoa acesse uma lambda exposta via URL**:

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

Ou esta para permitir que um API Gateway a invoque:

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Lambda Database Proxies

Quando h√° **centenas** de **requisi√ß√µes lambda concorrentes**, se cada uma delas precisar **conectar e fechar uma conex√£o com um banco de dados**, simplesmente n√£o vai funcionar (lambdas s√£o stateless, n√£o podem manter conex√µes abertas).\
Ent√£o, se suas **fun√ß√µes Lambda interagirem com o RDS Proxy em vez** da inst√¢ncia do banco de dados, ele gerencia o pool de conex√µes necess√°rio para escalar muitas conex√µes simult√¢neas criadas por fun√ß√µes Lambda concorrentes. Isso permite que suas aplica√ß√µes Lambda **reutilizem conex√µes existentes**, em vez de criar novas conex√µes para cada invoca√ß√£o de fun√ß√£o.

### Lambda EFS Filesystems

Para preservar e at√© mesmo compartilhar dados, **Lambdas podem acessar EFS e mont√°-los**, permitindo que a Lambda leia e escreva a partir dele.

### Lambda Layers

Uma _camada_ Lambda √© um arquivo de arquivo .zip que **pode conter c√≥digo adicional** ou outro conte√∫do. Uma camada pode conter bibliotecas, um [runtime personalizado](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), dados ou arquivos de configura√ß√£o.

√â poss√≠vel incluir at√© **cinco camadas por fun√ß√£o**. Quando voc√™ inclui uma camada em uma fun√ß√£o, o **conte√∫do √© extra√≠do para o diret√≥rio `/opt`** no ambiente de execu√ß√£o.

Por **padr√£o**, as **camadas** que voc√™ cria s√£o **privadas** para sua conta AWS. Voc√™ pode optar por **compartilhar** uma camada com outras contas ou **tornar** a camada **p√∫blica**. Se suas fun√ß√µes consumirem uma camada publicada por uma conta diferente, suas fun√ß√µes podem **continuar a usar a vers√£o da camada ap√≥s ela ter sido exclu√≠da, ou ap√≥s sua permiss√£o para acessar a camada ser revogada**. No entanto, voc√™ n√£o pode criar uma nova fun√ß√£o ou atualizar fun√ß√µes usando uma vers√£o de camada exclu√≠da.

Fun√ß√µes implantadas como uma imagem de cont√™iner n√£o usam camadas. Em vez disso, voc√™ empacota seu runtime preferido, bibliotecas e outras depend√™ncias na imagem do cont√™iner ao construir a imagem.

### Lambda Extensions

As extens√µes Lambda aprimoram as fun√ß√µes integrando-se com v√°rias **ferramentas de monitoramento, observabilidade, seguran√ßa e governan√ßa**. Essas extens√µes, adicionadas via [arquivos .zip usando camadas Lambda](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ou inclu√≠das em [implanta√ß√µes de imagens de cont√™iner](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), operam em dois modos: **interno** e **externo**.

* **Extens√µes internas** se mesclam com o processo de runtime, manipulando seu in√≠cio usando **vari√°veis de ambiente espec√≠ficas da linguagem** e **scripts de wrapper**. Essa personaliza√ß√£o se aplica a uma variedade de runtimes, incluindo **Java Correto 8 e 11, Node.js 10 e 12, e .NET Core 3.1**.
* **Extens√µes externas** funcionam como processos separados, mantendo a opera√ß√£o alinhada com o ciclo de vida da fun√ß√£o Lambda. Elas s√£o compat√≠veis com v√°rios runtimes como **Node.js 10 e 12, Python 3.7 e 3.8, Ruby 2.5 e 2.7, Java Corretto 8 e 11, .NET Core 3.1**, e **runtimes personalizados**.

### Enumeration
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### Invocar uma lambda

#### Manual
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### Via exposed URL

Se a fun√ß√£o Lambda estiver exposta a um URL, voc√™ pode enumerar as fun√ß√µes Lambda enviando solicita√ß√µes HTTP para o endpoint exposto. Isso pode ser feito usando ferramentas como o `curl` ou bibliotecas como `requests` em Python.

```bash
curl -X GET https://<lambda-url>
```

#### Via AWS CLI

Voc√™ pode usar a AWS CLI para enumerar fun√ß√µes Lambda. Primeiro, configure suas credenciais AWS usando `aws configure`. Em seguida, execute o seguinte comando para listar todas as fun√ß√µes Lambda em uma regi√£o espec√≠fica:

```bash
aws lambda list-functions --region <region>
```

#### Via boto3

O boto3 √© a biblioteca SDK da AWS para Python. Voc√™ pode us√°-lo para enumerar fun√ß√µes Lambda programaticamente. Aqui est√° um exemplo de como fazer isso:

```python
import boto3

client = boto3.client('lambda', region_name='<region>')

response = client.list_functions()

for function in response['Functions']:
    print(function['FunctionName'])
```

#### Via pacotes NPM

Existem pacotes NPM que podem ser usados para interagir com a AWS e enumerar fun√ß√µes Lambda. Um exemplo √© o `aws-sdk` para Node.js. Aqui est√° um exemplo de como listar fun√ß√µes Lambda usando o `aws-sdk`:

```javascript
const AWS = require('aws-sdk');
const lambda = new AWS.Lambda({ region: '<region>' });

lambda.listFunctions((err, data) => {
  if (err) console.log(err, err.stack);
  else console.log(data.Functions);
});
```

#### Via Terraform

Se voc√™ estiver usando o Terraform para gerenciar sua infraestrutura, pode usar o Terraform para enumerar fun√ß√µes Lambda. Aqui est√° um exemplo de como fazer isso:

```hcl
provider "aws" {
  region = "<region>"
}

data "aws_lambda_functions" "all" {}

output "lambda_function_names" {
  value = data.aws_lambda_functions.all.names
}
```
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### Call Lambda function via URL

Agora √© hora de descobrir poss√≠veis fun√ß√µes lambda para executar:
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (262).png>)

Uma fun√ß√£o lambda chamada "Level6" est√° dispon√≠vel. Vamos descobrir como cham√°-la:
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
![](<../../../.gitbook/assets/image (102).png>)

Agora, que voc√™ sabe o nome e o ID, voc√™ pode obter o Nome:
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (237).png>)

E finalmente chame a fun√ß√£o acessando (note que o ID, Nome e function-name aparecem na URL): [https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### Outros Triggers

Existem muitas outras fontes que podem acionar uma lambda

<figure><img src="../../../.gitbook/assets/image (167).png" alt=""><figcaption></figcaption></figure>

### Privesc

Na p√°gina a seguir, voc√™ pode verificar como **abusar das permiss√µes do Lambda para escalar privil√©gios**:

{% content-ref url="../aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### Acesso N√£o Autenticado

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### P√≥s-Explota√ß√£o

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### Persist√™ncia

{% content-ref url="../aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## Refer√™ncias

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no Telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>
{% endhint %}
