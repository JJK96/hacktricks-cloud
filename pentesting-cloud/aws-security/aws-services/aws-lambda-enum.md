# AWS - Lambda Enum

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter**'da takip edin 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## Lambda

Amazon Web Services (AWS) Lambda, **sunucu sağlama veya yönetme gereksinimi olmadan kod çalıştırmayı** sağlayan bir **hesaplama hizmeti** olarak tanımlanır. Kod çalıştırmak için gereken kaynak tahsisini **otomatik olarak yönetme** yeteneği ile karakterize edilir ve yüksek kullanılabilirlik, ölçeklenebilirlik ve güvenlik gibi özellikleri sağlar. Lambda'nın önemli bir yönü, **yalnızca kullanılan hesaplama süresine göre ücretlendirilmesi**, başlangıç yatırımları veya uzun vadeli taahhütler gerektirmemesidir.

Bir lambda'yı çağırmak için **istediğiniz sıklıkta** (Cloudwatch ile) çağırabilir, bir **URL** uç noktası açabilir ve çağırabilir, **API Gateway** üzerinden çağırabilir veya **S3** kovasında veri değişiklikleri veya **DynamoDB** tablosundaki güncellemeler gibi **olaylara** dayalı olarak çağırabilirsiniz.

Bir lambda'nın **kodu** **`/var/task`** içinde saklanır.

### Lambda Aliases Weights

Bir Lambda'nın **birden fazla versiyonu** olabilir.\
Ve **birden fazla** versiyon **aliases** aracılığıyla açığa çıkabilir. **Aliases** içindeki **her** bir versiyonun **ağırlıkları**, **hangi alias'ın çağrıyı alacağını** belirler (örneğin %90-%10 olabilir).\
**Aliases**'lardan birinin kodu **savunmasız** ise, **savunmasız** versiyonun **exploit** alana kadar **istekler gönderebilirsiniz**.

![](<../../../.gitbook/assets/image (223).png>)

### Resource Policies

Lambda kaynak politikaları, örneğin **diğer hizmetlerin/hesapların lambda'yı çağırmasına izin vermek** için kullanılır.\
Örneğin, **URL üzerinden açığa çıkan bir lambda'ya herkesin erişmesine izin veren** politika şu şekildedir:

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

Veya bir API Gateway'in çağırmasına izin vermek için şu şekildedir:

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Lambda Database Proxies

**Yüzlerce** **eşzamanlı lambda isteği** olduğunda, her birinin **bir veritabanına bağlanması ve bağlantıyı kapatması** gerekiyorsa, bu işe yaramaz (lambdalar durumsuzdur, açık bağlantıları sürdüremez).\
Bu durumda, **Lambda fonksiyonlarınız veritabanı örneğiniz yerine RDS Proxy ile etkileşime girerse**. Bu, eşzamanlı Lambda fonksiyonları tarafından oluşturulan birçok eşzamanlı bağlantıyı ölçeklendirmek için gerekli bağlantı havuzlamasını yönetir. Bu, Lambda uygulamalarınızın **mevcut bağlantıları yeniden kullanmasına** olanak tanır, her fonksiyon çağrısı için yeni bağlantılar oluşturmaktan ziyade.

### Lambda EFS Filesystems

Verileri korumak ve hatta paylaşmak için **Lambdalar EFS'ye erişebilir ve onları monte edebilir**, böylece Lambda ondan okuyabilir ve yazabilir.

### Lambda Layers

Bir Lambda _katmanı_, **ek kod** veya başka içerik içerebilen bir .zip dosya arşividir. Bir katman, kütüphaneler, bir [özel çalışma zamanı](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), veri veya yapılandırma dosyaları içerebilir.

Bir fonksiyon başına **beş katmana kadar** dahil etmek mümkündür. Bir fonksiyona bir katman eklediğinizde, **içerikler çalışma ortamındaki `/opt`** dizinine çıkarılır.

**Varsayılan olarak**, oluşturduğunuz **katmanlar** AWS hesabınıza **özeldir**. Bir katmanı diğer hesaplarla **paylaşmayı** veya katmanı **genel** yapmayı seçebilirsiniz. Fonksiyonlarınız, farklı bir hesabın yayınladığı bir katmanı tüketiyorsa, katman sürümü silindikten veya katmana erişim izniniz iptal edildikten sonra bile fonksiyonlarınız katman sürümünü **kullanmaya devam edebilir**. Ancak, silinmiş bir katman sürümünü kullanarak yeni bir fonksiyon oluşturamaz veya fonksiyonları güncelleyemezsiniz.

Bir konteyner görüntüsü olarak dağıtılan fonksiyonlar katmanları kullanmaz. Bunun yerine, tercih ettiğiniz çalışma zamanını, kütüphaneleri ve diğer bağımlılıkları konteyner görüntüsünü oluştururken paketlersiniz.

### Lambda Extensions

Lambda uzantıları, fonksiyonları çeşitli **izleme, gözlemlenebilirlik, güvenlik ve yönetim araçlarıyla** entegre ederek geliştirir. Bu uzantılar, [.zip arşivleri kullanarak Lambda katmanları](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) veya [konteyner görüntü dağıtımları](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/) aracılığıyla eklenir ve iki modda çalışır: **dahili** ve **harici**.

* **Dahili uzantılar**, çalışma zamanı sürecine birleşir, **dil-spesifik ortam değişkenleri** ve **sarmalayıcı betikler** kullanarak başlatma sürecini manipüle eder. Bu özelleştirme, **Java Correto 8 ve 11, Node.js 10 ve 12, ve .NET Core 3.1** gibi çeşitli çalışma zamanlarına uygulanır.
* **Harici uzantılar**, Lambda fonksiyonunun yaşam döngüsü ile uyumlu olarak ayrı süreçler olarak çalışır. **Node.js 10 ve 12, Python 3.7 ve 3.8, Ruby 2.5 ve 2.7, Java Corretto 8 ve 11, .NET Core 3.1** ve **özel çalışma zamanları** gibi çeşitli çalışma zamanlarıyla uyumludur.

### Enumeration
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### Bir lambda çağır

#### Manuel
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### Exposed URL Üzerinden

AWS Lambda işlevleri, genellikle bir URL aracılığıyla tetiklenir. Bu URL'ler, işlevin tetiklenmesi için kullanılabilir ve bazen yanlış yapılandırılmış olabilir. Bu URL'leri keşfetmek ve test etmek için aşağıdaki adımları izleyebilirsiniz:

1. **URL'yi Keşfetme**: AWS Lambda işlevlerinin URL'lerini keşfetmek için çeşitli araçlar ve teknikler kullanabilirsiniz. Bu URL'ler genellikle API Gateway veya başka bir hizmet aracılığıyla sunulur.
2. **URL'yi Test Etme**: Keşfettiğiniz URL'leri test ederek, işlevin nasıl çalıştığını ve hangi verileri döndürdüğünü anlayabilirsiniz. Bu, işlevin güvenliğini değerlendirmek için önemlidir.
3. **Yanıtları Analiz Etme**: İşlevin yanıtlarını analiz ederek, potansiyel güvenlik açıklarını ve yanlış yapılandırmaları tespit edebilirsiniz.

Bu adımları izleyerek, AWS Lambda işlevlerinin güvenliğini değerlendirebilir ve potansiyel güvenlik açıklarını tespit edebilirsiniz.
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### URL ile Lambda fonksiyonunu çağırma

Şimdi çalıştırılabilecek olası lambda fonksiyonlarını bulma zamanı:
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (262).png>)

"Level6" adlı bir lambda fonksiyonu mevcut. Nasıl çağrılacağını bulalım:
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
![](<../../../.gitbook/assets/image (102).png>)

Artık adı ve kimliği bildiğinize göre, Adı alabilirsiniz:
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (237).png>)

Ve son olarak fonksiyonu çağırarak erişin (URL'de ID, Name ve function-name'in göründüğüne dikkat edin): [https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### Diğer Tetikleyiciler

Bir lambda'yı tetikleyebilecek birçok başka kaynak vardır

<figure><img src="../../../.gitbook/assets/image (167).png" alt=""><figcaption></figcaption></figure>

### Privesc

Aşağıdaki sayfada **Lambda izinlerini kötüye kullanarak ayrıcalıkları yükseltme** yöntemlerini kontrol edebilirsiniz:

{% content-ref url="../aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### Kimlik Doğrulaması Olmayan Erişim

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### Sömürü Sonrası

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### Kalıcılık

{% content-ref url="../aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## Referanslar

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live) **bizi takip edin.**
* **HackTricks'e** [**PR göndererek**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunarak **hacking ipuçlarını paylaşın.**

</details>
{% endhint %}
