# AWS - Lambda Enum

{% hint style="success" %}
Jifunze na kufanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na kufanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Lambda

Amazon Web Services (AWS) Lambda inaelezewa kama **huduma ya kompyuta** inayowezesha utekelezaji wa msimbo bila hitaji la kutoa au kusimamia seva. Inajulikana kwa uwezo wake wa **kushughulikia ugawaji wa rasilimali kiotomatiki** unaohitajika kwa utekelezaji wa msimbo, kuhakikisha vipengele kama upatikanaji wa juu, upanuzi, na usalama. Kipengele muhimu cha Lambda ni mfano wake wa bei, ambapo **malipo yanategemea tu muda wa kompyuta uliotumika**, kuondoa hitaji la uwekezaji wa awali au ahadi za muda mrefu.

Kuita lambda inawezekana kuipigia simu **mara nyingi unavyotaka** (na Cloudwatch), **kufichua** **URL** endpoint na kuipigia simu, kuipigia simu kupitia **API Gateway** au hata kwa msingi wa **matukio** kama **mabadiliko** ya data katika **S3** bucket au masasisho kwenye **DynamoDB** meza.

**Msimbo** wa lambda umehifadhiwa katika **`/var/task`**.

### Lambda Aliases Weights

Lambda inaweza kuwa na **matoleo kadhaa**.\
Na inaweza kuwa na **zaidi ya 1** toleo lililofichuliwa kupitia **aliases**. **Uzito** wa **kila** moja ya **matoleo** yaliyofichuliwa ndani ya alias utaamua **ni alias gani itapokea mwito** (inaweza kuwa 90%-10% kwa mfano).\
Ikiwa msimbo wa **moja** ya aliases ni **dhaifu** unaweza kutuma **maombi hadi toleo dhaifu** lipokee shambulio.

![](<../../../.gitbook/assets/image (223).png>)

### Resource Policies

Sera za rasilimali za Lambda huruhusu **kutoa ufikiaji kwa huduma/akaunti nyingine kuamsha** lambda kwa mfano.\
Kwa mfano hii ni sera ya kuruhusu **mtu yeyote kufikia lambda iliyofichuliwa kupitia URL**:

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

Au hii kuruhusu API Gateway kuamsha:

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Lambda Database Proxies

Wakati kuna **mamia** ya **maombi ya lambda yanayofanyika kwa wakati mmoja**, ikiwa kila moja inahitaji **kuunganisha na kufunga muunganisho na hifadhidata**, haitafanya kazi (lambdas hazina hali, haziwezi kudumisha miunganisho wazi).\
Kisha, ikiwa **Lambda functions zako zinashirikiana na RDS Proxy badala ya** mfano wa hifadhidata yako. Inashughulikia kuunganisha kwa pamoja kunakohitajika kwa kupanua miunganisho mingi inayoundwa na Lambda functions zinazofanyika kwa wakati mmoja. Hii inaruhusu programu zako za Lambda **kutumia miunganisho iliyopo**, badala ya kuunda miunganisho mipya kwa kila mwito wa kazi.

### Lambda EFS Filesystems

Ili kuhifadhi na hata kushiriki data **Lambdas zinaweza kufikia EFS na kuzipandisha**, hivyo Lambda itaweza kusoma na kuandika kutoka kwake.

### Lambda Layers

Layer ya Lambda ni faili ya .zip ambayo **inaweza kuwa na msimbo wa ziada** au maudhui mengine. Layer inaweza kuwa na maktaba, [custom runtime](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), data, au faili za usanidi.

Inawezekana kujumuisha hadi **tabaka tano kwa kazi**. Unapojumuisha layer katika kazi, **maudhui yanatolewa kwenye saraka ya `/opt`** katika mazingira ya utekelezaji.

Kwa **chaguo-msingi**, **tabaka** unazounda ni **binafsi** kwa akaunti yako ya AWS. Unaweza kuchagua **kushiriki** layer na akaunti nyingine au **kufanya** layer **kuwa ya umma**. Ikiwa kazi zako zinatumia layer iliyochapishwa na akaunti tofauti, kazi zako zinaweza **kuendelea kutumia toleo la layer baada ya kufutwa, au baada ya ruhusa yako ya kufikia layer kufutwa**. Hata hivyo, huwezi kuunda kazi mpya au kusasisha kazi kwa kutumia toleo la layer lililofutwa.

Kazi zilizowekwa kama picha ya kontena hazitumii tabaka. Badala yake, unafunga runtime unayopendelea, maktaba, na utegemezi mwingine kwenye picha ya kontena unapoijenga.

### Lambda Extensions

Lambda extensions huongeza kazi kwa kuunganisha na **vifaa mbalimbali vya ufuatiliaji, uangalizi, usalama, na utawala**. Extensions hizi, zilizoongezwa kupitia [mashine za .zip kwa kutumia tabaka za Lambda](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) au kujumuishwa katika [maendeleo ya picha za kontena](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), hufanya kazi katika njia mbili: **ndani** na **nje**.

* **Extensions za ndani** huunganishwa na mchakato wa runtime, kubadilisha kuanzishwa kwake kwa kutumia **mabadiliko maalum ya mazingira ya lugha** na **scripts za wrapper**. Urekebishaji huu unatumika kwa aina mbalimbali za runtime, ikiwa ni pamoja na **Java Correto 8 na 11, Node.js 10 na 12, na .NET Core 3.1**.
* **Extensions za nje** hufanya kazi kama michakato tofauti, kudumisha ulinganifu wa operesheni na mzunguko wa maisha wa kazi ya Lambda. Zinapatana na runtime mbalimbali kama **Node.js 10 na 12, Python 3.7 na 3.8, Ruby 2.5 na 2.7, Java Corretto 8 na 11, .NET Core 3.1**, na **runtime maalum**.

### Enumeration
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### Kuita lambda

#### Mwongozo
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### Kupitia URL iliyo wazi

```python
import requests

url = "https://example.com/my-lambda-function"
response = requests.get(url)

if response.status_code == 200:
    print("Lambda function is accessible")
else:
    print("Failed to access Lambda function")
```

#### Kupitia AWS CLI

```bash
aws lambda list-functions --region us-east-1
```

#### Kupitia SDK

```python
import boto3

client = boto3.client('lambda', region_name='us-east-1')
response = client.list_functions()

for function in response['Functions']:
    print(function['FunctionName'])
```

#### Kupitia CloudFormation

```yaml
Resources:
  MyLambdaFunction:
    Type: 'AWS::Lambda::Function'
    Properties:
      FunctionName: 'my-lambda-function'
      Handler: 'index.handler'
      Role: 'arn:aws:iam::123456789012:role/execution_role'
      Code:
        S3Bucket: 'my-bucket'
        S3Key: 'my-function.zip'
      Runtime: 'python3.8'
```

#### Kupitia Terraform

```hcl
resource "aws_lambda_function" "my_lambda_function" {
  function_name = "my_lambda_function"
  handler       = "index.handler"
  role          = aws_iam_role.lambda_exec.arn
  s3_bucket     = "my-bucket"
  s3_key        = "my-function.zip"
  runtime       = "python3.8"
}
```

#### Kupitia Serverless Framework

```yaml
service: my-service
provider:
  name: aws
  runtime: python3.8

functions:
  myFunction:
    handler: handler.hello
```

#### Kupitia eks

```bash
kubectl get pods -n kube-system
```

#### Kupitia eksctl

```bash
eksctl get cluster
```

#### Kupitia eks kubectl

```bash
kubectl get svc
```

#### Kupitia eks eksctl

```bash
eksctl get nodegroup --cluster my-cluster
```
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### Call Lambda function via URL

Sasa ni wakati wa kugundua kazi za lambda zinazowezekana kutekeleza:
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (262).png>)

Kuna lambda function inayoitwa "Level6" inapatikana. Hebu tuone jinsi ya kuiita:
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
![](<../../../.gitbook/assets/image (102).png>)

Sasa, kwa kuwa unajua jina na ID unaweza kupata Jina:
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (237).png>)

Na hatimaye piga simu kwa kazi kwa kufikia (kumbuka kwamba ID, Jina na jina la kazi vinaonekana kwenye URL): [https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### Vichochezi Vingine

Kuna vyanzo vingi vingine ambavyo vinaweza kuchochea lambda

<figure><img src="../../../.gitbook/assets/image (167).png" alt=""><figcaption></figcaption></figure>

### Privesc

Katika ukurasa ufuatao unaweza kuangalia jinsi ya **kutumia vibaya ruhusa za Lambda ili kuongeza marupurupu**:

{% content-ref url="../aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### Ufikiaji Bila Uthibitisho

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### Unyonyaji Baada ya Shambulio

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### Uendelevu

{% content-ref url="../aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## Marejeleo

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

{% hint style="success" %}
Jifunze & fanya mazoezi ya Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & fanya mazoezi ya Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
