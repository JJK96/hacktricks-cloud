# AWS - Καταγραφή Κατηγοριών MSK

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τεχνικές χάκινγκ υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Amazon MSK

**Το Amazon Managed Streaming for Apache Kafka (Amazon MSK)** είναι ένα υπηρεσία πλήρως διαχειριζόμενη, που διευκολύνει την ανάπτυξη και εκτέλεση εφαρμογών επεξεργασίας ροής δεδομένων μέσω **Apache Kafka**. Οι λειτουργίες ελέγχου του επιπέδου ελέγχου, συμπεριλαμβανομένης της δημιουργίας, ενημέρωσης και διαγραφής **συστημάτων**, προσφέρονται από το Amazon MSK.
Η υπηρεσία επιτρέπει τη χρήση των λειτουργιών επεξεργασίας δεδομένων του Apache Kafka, περιλαμβάνοντας την παραγωγή και κατανάλωση δεδομένων. Λειτουργεί με **ανοικτούς κώδικα εκδόσεις του Apache Kafka**, εξασφαλίζοντας συμβατότητα με υπάρχουσες εφαρμογές, εργαλεία και πρόσθετα από τους συνεργάτες και τη **κοινότητα του Apache Kafka**, εξαλείφοντας την ανάγκη για τροποποιήσεις στον κώδικα της εφαρμογής.

Όσον αφορά την αξιοπιστία, το Amazon MSK σχεδιάστηκε για να **ανιχνεύει αυτόματα και να ανακτά από κοινού τις συνηθισμένες περιπτώσεις αποτυχίας συστήματος**, εξασφαλίζοντας ότι οι εφαρμογές παραγωγού και καταναλωτή θα συνεχίσουν τις δραστηριότητές τους εγγραφής και ανάγνωσης δεδομένων με ελάχιστες διακοπές. Επιπλέον, στοχεύει στη βελτιστοποίηση των διαδικασιών αντιγραφής δεδομένων προσπαθώντας να **επαναχρησιμοποιήσει την αποθήκευση των αντικατασταθέντων brokers**, μειώνοντας έτσι τον όγκο των δεδομένων που πρέπει να αντιγραφοώνται από το Apache Kafka.

### **Τύποι**

Υπάρχουν 2 τύποι συστημάτων Kafka που επιτρέπει η AWS να δημιουργήσετε: Προμηθευμένα και Χωρίς Διακομιστή.

Από την άποψη ενός επιτιθέμενου πρέπει να γνωρίζετε ότι:

* **Το Χωρίς Διακομιστή δεν μπορεί να είναι απευθείας δημόσιο** (μπορεί να λειτουργεί μόνο σε ένα VPN χωρίς καμία δημόσια διευθυνση IP). Ωστόσο, τα **Προμηθευμένα** μπορούν να ρυθμιστούν για να λάβουν μια **δημόσια διεύθυνση IP** (από προεπιλογή δεν το κάνουν) και να ρυθμίσουν το **ομάδα ασφαλείας** για να **εκθέσουν** τις σχετικές θύρες.
* **Το Χωρίς Διακομιστή υποστηρίζει μόνο το IAM** ως μέθοδος πιστοποίησης. Τα **Προμηθευμένα** υποστηρίζουν την πιστοποίηση SASL/SCRAM (**κωδικός πρόσβασης**), την πιστοποίηση **IAM**, τον διαχειριστή πιστοποιητικών AWS (ACM) και την **Μη Πιστοποιημένη** πρόσβαση.
* Σημειώστε ότι δεν είναι δυνατή η δημόσια εκθεση ενός Προμηθευμένου Kafka εάν είναι ενεργοποιημένη η μη πιστοποιημένη πρόσβαση.
```bash
#Get clusters
aws kafka list-clusters
aws kafka list-clusters-v2

# Check the supported authentication
aws kafka list-clusters |  jq -r ".ClusterInfoList[].ClientAuthentication"

# Get Zookeeper endpoints
aws kafka list-clusters | jq -r ".ClusterInfoList[].ZookeeperConnectString, .ClusterInfoList[].ZookeeperConnectStringTls"

# Get nodes and node enspoints
aws kafka kafka list-nodes --cluster-arn <cluster-arn>
aws kafka kafka list-nodes --cluster-arn <cluster-arn> | jq -r ".NodeInfoList[].BrokerNodeInfo.Endpoints" # Get endpoints

# Get used kafka configs
aws kafka list-configurations #Get Kafka config file
aws kafka describe-configuration --arn <config-arn> # Get version of config
aws kafka describe-configuration-revision --arn <config-arn> --revision <version> # Get content of config version

# If using SCRAN authentication, get used AWS secret name (not secret value)
aws kafka list-scram-secrets --cluster-arn <cluster-arn>
```
### Πρόσβαση IAM Kafka (σε λειτουργία serverless)
```bash
# Guide from https://docs.aws.amazon.com/msk/latest/developerguide/create-serverless-cluster.html
# Download Kafka
wget https://archive.apache.org/dist/kafka/2.8.1/kafka_2.12-2.8.1.tgz
tar -xzf kafka_2.12-2.8.1.tgz

# In kafka_2.12-2.8.1/libs download the MSK IAM JAR file.
cd kafka_2.12-2.8.1/libs
wget https://github.com/aws/aws-msk-iam-auth/releases/download/v1.1.1/aws-msk-iam-auth-1.1.1-all.jar

# Create file client.properties in kafka_2.12-2.8.1/bin
security.protocol=SASL_SSL
sasl.mechanism=AWS_MSK_IAM
sasl.jaas.config=software.amazon.msk.auth.iam.IAMLoginModule required;
sasl.client.callback.handler.class=software.amazon.msk.auth.iam.IAMClientCallbackHandler

# Export endpoints address
export BS=boot-ok2ngypz.c2.kafka-serverless.us-east-1.amazonaws.com:9098
## Make sure you will be able to access the port 9098 from the EC2 instance (check VPS, subnets and SG)

# Create a topic called msk-serverless-tutorial
kafka_2.12-2.8.1/bin/kafka-topics.sh --bootstrap-server $BS --command-config client.properties --create --topic msk-serverless-tutorial --partitions 6

# Send message of every new line
kafka_2.12-2.8.1/bin/kafka-console-producer.sh --broker-list $BS --producer.config client.properties --topic msk-serverless-tutorial

# Read messages
kafka_2.12-2.8.1/bin/kafka-console-consumer.sh --bootstrap-server $BS --consumer.config client.properties --topic msk-serverless-tutorial --from-beginning
```
### Ανύψωση Δικαιωμάτων

{% content-ref url="../aws-privilege-escalation/aws-msk-privesc.md" %}
[aws-msk-privesc.md](../aws-privilege-escalation/aws-msk-privesc.md)
{% endcontent-ref %}

### Μη Ταυτοποιημένη Πρόσβαση

{% content-ref url="../aws-unauthenticated-enum-access/aws-msk-unauthenticated-enum.md" %}
[aws-msk-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-msk-unauthenticated-enum.md)
{% endcontent-ref %}

### Διατήρηση

Εάν έχετε πρόσβαση στο VPC όπου βρίσκεται ένα Provisioned Kafka, μπορείτε να ενεργοποιήσετε την μη εξουσιοδοτημένη πρόσβαση, να διαβάσετε τον κωδικό από το μυστικό, να δώσετε ορισμένες άλλες ελεγχόμενες δικαιώματα IAM σε άλλο χρήστη (εάν χρησιμοποιείται IAM ή serverless) ή να διατηρήσετε με πιστοποιητικά.

## Αναφορές

* [https://docs.aws.amazon.com/msk/latest/developerguide/what-is-msk.html](https://docs.aws.amazon.com/msk/latest/developerguide/what-is-msk.html)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκινγκ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
{% endhint %}
