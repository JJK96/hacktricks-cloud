# AWS - MSK Enum

{% hint style="success" %}
AWS Hacking'ı öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## Amazon MSK

**Amazon Managed Streaming for Apache Kafka (Amazon MSK)**, **Apache Kafka** üzerinden akış verilerini işleyen uygulamaların geliştirilmesini ve yürütülmesini kolaylaştıran tamamen yönetilen bir hizmettir. Amazon MSK, **kümelerin** oluşturulması, güncellenmesi ve silinmesi gibi kontrol düzlemi işlemlerini sunar. Hizmet, Apache Kafka **veri düzlemi işlemlerinin** kullanımına izin verir; veri üretimi ve tüketimini içerir. Ayrıca, **Apache Kafka topluluğu** ve ortaklardan gelen uygulamalar, araçlar ve eklentilerle uyumluluğu sağlayarak, mevcut uygulamaların değiştirilmesine gerek kalmadan çalışır.

Güvenilirlik açısından, Amazon MSK, üretici ve tüketici uygulamalarının veri yazma ve okuma faaliyetlerine kesintisiz devam etmelerini sağlayarak yaygın kümelerin başarısızlık senaryolarını **otomatik olarak tespit eder ve kurtarır**. Ayrıca, Apache Kafka tarafından replike edilmesi gereken veri miktarını azaltarak, **değiştirilen broker'ların depolama alanını yeniden kullanmaya çalışarak** veri replikasyon süreçlerini optimize etmeyi amaçlar.

### **Türler**

AWS'nin oluşturmanıza izin verdiği 2 tür Kafka kümesi vardır: Tahsis Edilmiş ve Sunucusuz.

Saldırganın bakış açısından bilmeniz gerekenler:

* **Sunucusuz doğrudan genel olamaz** (yalnızca herhangi bir şekilde genel olarak açık IP'si olmayan bir VPN'de çalışabilir). Ancak, **Tahsis Edilmiş** bir **genel IP** alacak şekilde yapılandırılabilir (varsayılan olarak yapmaz) ve **güvenlik grubunu** ilgili bağlantı noktalarını **açacak şekilde yapılandırabilirsiniz**.
* **Sunucusuz** yalnızca IAM'ı desteklerken, **Tahsis Edilmiş** SASL/SCRAM (**şifre**) kimlik doğrulamasını, **IAM** kimlik doğrulamasını, AWS **Sertifika** Yöneticisi (ACM) kimlik doğrulamasını ve **Kimliksiz** erişimi destekler.
* Unauthenticated erişim etkinleştirilmişse Tahsis Edilmiş Kafka'yı genel olarak açık hale getirmek mümkün değildir.
```bash
#Get clusters
aws kafka list-clusters
aws kafka list-clusters-v2

# Check the supported authentication
aws kafka list-clusters |  jq -r ".ClusterInfoList[].ClientAuthentication"

# Get Zookeeper endpoints
aws kafka list-clusters | jq -r ".ClusterInfoList[].ZookeeperConnectString, .ClusterInfoList[].ZookeeperConnectStringTls"

# Get nodes and node enspoints
aws kafka kafka list-nodes --cluster-arn <cluster-arn>
aws kafka kafka list-nodes --cluster-arn <cluster-arn> | jq -r ".NodeInfoList[].BrokerNodeInfo.Endpoints" # Get endpoints

# Get used kafka configs
aws kafka list-configurations #Get Kafka config file
aws kafka describe-configuration --arn <config-arn> # Get version of config
aws kafka describe-configuration-revision --arn <config-arn> --revision <version> # Get content of config version

# If using SCRAN authentication, get used AWS secret name (not secret value)
aws kafka list-scram-secrets --cluster-arn <cluster-arn>
```
### Kafka IAM Erişimi (sunucusuz)
```bash
# Guide from https://docs.aws.amazon.com/msk/latest/developerguide/create-serverless-cluster.html
# Download Kafka
wget https://archive.apache.org/dist/kafka/2.8.1/kafka_2.12-2.8.1.tgz
tar -xzf kafka_2.12-2.8.1.tgz

# In kafka_2.12-2.8.1/libs download the MSK IAM JAR file.
cd kafka_2.12-2.8.1/libs
wget https://github.com/aws/aws-msk-iam-auth/releases/download/v1.1.1/aws-msk-iam-auth-1.1.1-all.jar

# Create file client.properties in kafka_2.12-2.8.1/bin
security.protocol=SASL_SSL
sasl.mechanism=AWS_MSK_IAM
sasl.jaas.config=software.amazon.msk.auth.iam.IAMLoginModule required;
sasl.client.callback.handler.class=software.amazon.msk.auth.iam.IAMClientCallbackHandler

# Export endpoints address
export BS=boot-ok2ngypz.c2.kafka-serverless.us-east-1.amazonaws.com:9098
## Make sure you will be able to access the port 9098 from the EC2 instance (check VPS, subnets and SG)

# Create a topic called msk-serverless-tutorial
kafka_2.12-2.8.1/bin/kafka-topics.sh --bootstrap-server $BS --command-config client.properties --create --topic msk-serverless-tutorial --partitions 6

# Send message of every new line
kafka_2.12-2.8.1/bin/kafka-console-producer.sh --broker-list $BS --producer.config client.properties --topic msk-serverless-tutorial

# Read messages
kafka_2.12-2.8.1/bin/kafka-console-consumer.sh --bootstrap-server $BS --consumer.config client.properties --topic msk-serverless-tutorial --from-beginning
```
### İst Privilegesi

{% content-ref url="../aws-privilege-escalation/aws-msk-privesc.md" %}
[aws-msk-privesc.md](../aws-privilege-escalation/aws-msk-privesc.md)
{% endcontent-ref %}

### Kimlik Doğrulamasız Erişim

{% content-ref url="../aws-unauthenticated-enum-access/aws-msk-unauthenticated-enum.md" %}
[aws-msk-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-msk-unauthenticated-enum.md)
{% endcontent-ref %}

### Kalıcılık

Eğer bir **Provisioned Kafka**'ya erişiminiz varsa, **VPC'ye erişiminiz varsa**, **kimlik doğrulamasız erişimi etkinleştirebilirsiniz**, **SASL/SCRAM kimlik doğrulaması** kullanılıyorsa, şifreyi secret'ten **okuyabilir**, **diğer kontrol edilen kullanıcıya IAM izinleri verebilirsiniz** (eğer IAM veya serverless kullanılıyorsa) veya **sertifikalarla kalıcı olabilirsiniz**.

## Referanslar

* [https://docs.aws.amazon.com/msk/latest/developerguide/what-is-msk.html](https://docs.aws.amazon.com/msk/latest/developerguide/what-is-msk.html)

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR göndererek HackTricks ve HackTricks Cloud github depolarına katkıda bulunun.**

</details>
{% endhint %}
