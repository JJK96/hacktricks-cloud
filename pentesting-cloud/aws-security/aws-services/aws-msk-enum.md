# AWS - MSK Enum

{% hint style="success" %}
Lernen Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys senden.

</details>
{% endhint %}

## Amazon MSK

**Amazon Managed Streaming for Apache Kafka (Amazon MSK)** ist ein vollst√§ndig verwalteter Dienst, der die Entwicklung und Ausf√ºhrung von Anwendungen zur Verarbeitung von Streaming-Daten √ºber **Apache Kafka** erleichtert. Amazon MSK bietet Control-Plane-Operationen, einschlie√ülich Erstellung, Aktualisierung und L√∂schung von **Clustern**.
Der Dienst erm√∂glicht die Nutzung von Apache Kafka **Data-Plane-Operationen**, einschlie√ülich Datenproduktion und -konsumption. Er arbeitet mit **Open-Source-Versionen von Apache Kafka**, die die Kompatibilit√§t mit vorhandenen Anwendungen, Tools und Plugins sowohl von Partnern als auch von der **Apache Kafka-Community** sicherstellen und so die Notwendigkeit von √Ñnderungen im Anwendungscode beseitigen.

In Bezug auf die Zuverl√§ssigkeit ist Amazon MSK darauf ausgelegt, **automatisch h√§ufig auftretende Cluster-Ausfallszenarien zu erkennen und wiederherzustellen**, um sicherzustellen, dass Produzenten- und Konsumentenanwendungen ihre Daten schreib- und leseaktivit√§ten mit minimalen Unterbrechungen fortsetzen k√∂nnen. Dar√ºber hinaus zielt es darauf ab, die Datenreplikationsprozesse zu optimieren, indem es versucht, den Speicher der ersetzten Broker wiederzuverwenden, um so das Volumen der von Apache Kafka replizierten Daten zu minimieren.

### **Typen**

Es gibt 2 Arten von Kafka-Clustern, die AWS erstellen kann: Bereitgestellt und Serverless.

Aus der Sicht eines Angreifers m√ºssen Sie wissen, dass:

* **Serverless kann nicht direkt √∂ffentlich zug√§nglich sein** (es kann nur in einem VPN ohne √∂ffentlich zug√§ngliche IP-Adresse ausgef√ºhrt werden). **Bereitgestellt** kann jedoch so konfiguriert werden, dass es eine **√∂ffentliche IP-Adresse** erh√§lt (standardm√§√üig nicht) und das **Sicherheitsgruppe** konfigurieren, um die relevanten Ports **freizugeben**.
* **Serverless** unterst√ºtzt nur IAM als Authentifizierungsmethode. **Bereitgestellt** unterst√ºtzt SASL/SCRAM (**Passwort**) Authentifizierung, **IAM**-Authentifizierung, AWS **Certificate** Manager (ACM) Authentifizierung und **Unauthentifizierten** Zugriff.
* Beachten Sie, dass es nicht m√∂glich ist, einen bereitgestellten Kafka √∂ffentlich zug√§nglich zu machen, wenn der unauthentifizierte Zugriff aktiviert ist.

### Enumeration
```bash
#Get clusters
aws kafka list-clusters
aws kafka list-clusters-v2

# Check the supported authentication
aws kafka list-clusters |  jq -r ".ClusterInfoList[].ClientAuthentication"

# Get Zookeeper endpoints
aws kafka list-clusters | jq -r ".ClusterInfoList[].ZookeeperConnectString, .ClusterInfoList[].ZookeeperConnectStringTls"

# Get nodes and node enspoints
aws kafka kafka list-nodes --cluster-arn <cluster-arn>
aws kafka kafka list-nodes --cluster-arn <cluster-arn> | jq -r ".NodeInfoList[].BrokerNodeInfo.Endpoints" # Get endpoints

# Get used kafka configs
aws kafka list-configurations #Get Kafka config file
aws kafka describe-configuration --arn <config-arn> # Get version of config
aws kafka describe-configuration-revision --arn <config-arn> --revision <version> # Get content of config version

# If using SCRAN authentication, get used AWS secret name (not secret value)
aws kafka list-scram-secrets --cluster-arn <cluster-arn>
```
### Kafka IAM-Zugriff (in serverless)
```bash
# Guide from https://docs.aws.amazon.com/msk/latest/developerguide/create-serverless-cluster.html
# Download Kafka
wget https://archive.apache.org/dist/kafka/2.8.1/kafka_2.12-2.8.1.tgz
tar -xzf kafka_2.12-2.8.1.tgz

# In kafka_2.12-2.8.1/libs download the MSK IAM JAR file.
cd kafka_2.12-2.8.1/libs
wget https://github.com/aws/aws-msk-iam-auth/releases/download/v1.1.1/aws-msk-iam-auth-1.1.1-all.jar

# Create file client.properties in kafka_2.12-2.8.1/bin
security.protocol=SASL_SSL
sasl.mechanism=AWS_MSK_IAM
sasl.jaas.config=software.amazon.msk.auth.iam.IAMLoginModule required;
sasl.client.callback.handler.class=software.amazon.msk.auth.iam.IAMClientCallbackHandler

# Export endpoints address
export BS=boot-ok2ngypz.c2.kafka-serverless.us-east-1.amazonaws.com:9098
## Make sure you will be able to access the port 9098 from the EC2 instance (check VPS, subnets and SG)

# Create a topic called msk-serverless-tutorial
kafka_2.12-2.8.1/bin/kafka-topics.sh --bootstrap-server $BS --command-config client.properties --create --topic msk-serverless-tutorial --partitions 6

# Send message of every new line
kafka_2.12-2.8.1/bin/kafka-console-producer.sh --broker-list $BS --producer.config client.properties --topic msk-serverless-tutorial

# Read messages
kafka_2.12-2.8.1/bin/kafka-console-consumer.sh --bootstrap-server $BS --consumer.config client.properties --topic msk-serverless-tutorial --from-beginning
```
### Privilege Escalation

{% content-ref url="../aws-privilege-escalation/aws-msk-privesc.md" %}
[aws-msk-privesc.md](../aws-privilege-escalation/aws-msk-privesc.md)
{% endcontent-ref %}

### Nicht authentifizierter Zugriff

{% content-ref url="../aws-unauthenticated-enum-access/aws-msk-unauthenticated-enum.md" %}
[aws-msk-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-msk-unauthenticated-enum.md)
{% endcontent-ref %}

### Persistenz

Wenn Sie **Zugriff auf das VPC haben**, in dem ein bereitgestelltes Kafka ist, k√∂nnten Sie **unberechtigten Zugriff aktivieren**, wenn **SASL/SCRAM-Authentifizierung**, das **Passwort aus dem Geheimnis lesen**, einigen **anderen gesteuerten Benutzern IAM-Berechtigungen geben** (falls IAM oder serverless verwendet wird) oder mit **Zertifikaten bestehen bleiben**.

## Referenzen

* [https://docs.aws.amazon.com/msk/latest/developerguide/what-is-msk.html](https://docs.aws.amazon.com/msk/latest/developerguide/what-is-msk.html)

{% hint style="success" %}
Lernen und √ºben Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen und √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>
{% endhint %}
