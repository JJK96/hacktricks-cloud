# AWS - WAF Enum

<details>

<summary><strong>Sıfırdan kahraman olacak şekilde AWS hackleme öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünleri**](https://peass.creator-spring.com)'ni edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR'lar göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

# AWS WAF

AWS WAF, web uygulamalarını veya API'leri çeşitli web saldırılarına karşı korumak amacıyla tasarlanmış bir **web uygulaması güvenlik duvarıdır**. Kullanıcıların gelen trafiği kontrol etmelerini sağlar ve SQL enjeksiyonu veya cross-site scripting gibi tipik saldırı vektörlerini hafifleten **güvenlik kuralları** oluşturarak özelleştirilmiş filtreleme kuralları tanımlayarak çalışır.

## Ana kavramlar

### Web ACL (Erişim Kontrol Listesi)

Web ACL, web uygulamalarınız veya API'lerinize uygulayabileceğiniz kurallar koleksiyonudur. Bir Web ACL'yi bir kaynakla ilişkilendirdiğinizde, AWS WAF, Web ACL'de tanımlanan kurallara göre gelen istekleri denetler ve belirtilen işlemleri gerçekleştirir.

### Kural Grubu

Kural Grubu, birden fazla Web ACL'sine uygulayabileceğiniz yeniden kullanılabilir bir kural koleksiyonudur. Kural grupları, farklı web uygulamaları veya API'ler arasında tutarlı kural setlerini yönetmeye ve sürdürmeye yardımcı olur.

Her kural grubunun ilişkili **kapasitesi** vardır ve bu, kurallarınızı, kural gruplarınızı ve web ACL'lerinizi çalıştırmak için kullanılan işletim kaynaklarını hesaplamaya ve kontrol etmeye yardımcı olur. Oluşturulurken değeri belirlendikten sonra değiştirilemez.

### Kural

Bir kural, AWS WAF'ın gelen web isteklerini denetlemek için kullandığı koşullar kümesini tanımlar. İki ana kural türü vardır:

1. **Normal Kural**: Bu kural türü, web isteklerini izin vermek, engellemek veya saymak için belirli koşulları kullanır.
2. **Oran Tabanlı Kural**: Belirli bir IP adresinden gelen istekleri beş dakikalık bir süre içinde sayar. Kullanıcılar burada bir eşik belirler ve IP'den gelen istek sayısı bu sınıra ulaşırsa, IP'den gelen sonraki istekler eşik altına düşene kadar engellenir. Oran tabanlı kurallar için minimum eşik **2000 istek**tir.

### Yönetilen Kurallar

AWS WAF, AWS ve AWS Marketplace satıcıları tarafından sürdürülen önceden yapılandırılmış, yönetilen kural setleri sunar. Bu kural setleri, yaygın tehditlere karşı koruma sağlar ve yeni güvenlik açıklarını ele almak için düzenli olarak güncellenir.

### IP Kümesi

Bir IP Kümesi, izin vermek veya engellemek istediğiniz IP adreslerinin veya IP adresi aralıklarının bir listesidir. IP kümeleri, IP tabanlı kuralları yönetmeyi basitleştirir.

### Regex Deseni Kümesi

Bir Regex Deseni Kümesi, web isteklerinde aranacak desenleri tanımlayan bir veya daha fazla düzenli ifade (regex) içerir. Bu, belirli karakter dizilerini filtrelemek gibi daha karmaşık eşleme senaryoları için kullanışlıdır.

### Kilit Belirteci

Kilit Belirteci, WAF kaynaklarına güncelleme yaparken eş zamanlılık kontrolü için kullanılır. Değişikliklerin aynı anda aynı kaynağı güncellemeye çalışan birden fazla kullanıcı veya işlem tarafından yanlışlıkla üzerine yazılmamasını sağlar.

### API Anahtarları

AWS WAF'daki API Anahtarları, belirli API işlemlerine kimlik doğrulaması yapmak için kullanılır. Bu anahtarlar şifrelenir ve güvenli bir şekilde yönetilir, erişimi kontrol etmek ve yalnızca yetkili kullanıcıların WAF yapılandırmalarını değiştirebilmesini sağlamak için.

- **Örnek**: CAPTCHA API'sinin entegrasyonu.

### İzin Politikası

Bir İzin Politikası, AWS WAF kaynaklarında hangi işlemleri gerçekleştirebileceğini belirten bir IAM politikasıdır. İzinleri tanımlayarak, WAF kaynaklarına erişimi kontrol edebilir ve yalnızca yetkili kullanıcıların yapılandırmalar oluşturmasına, güncelleştirmesine veya silmesine izin verebilirsiniz.

### Kapsam

AWS WAF'daki kapsam parametresi, WAF kurallarının ve yapılandırmalarının bölgesel bir uygulamaya mı yoksa Amazon CloudFront dağıtımına mı uygulandığını belirtir.

- **BÖLGESEL**: Uygulamaların olduğu AWS bölgesini belirttiğiniz bölgesel hizmetlere uygulanır, örneğin Uygulama Yük Dengeleyicileri (ALB), Amazon API Gateway REST API, AWS AppSync GraphQL API, Amazon Cognito kullanıcı havuzu, AWS App Runner hizmeti ve AWS Onaylı Erişim örneği. Bu kaynakların bulunduğu AWS bölgesini belirtirsiniz.
- **CLOUDFRONT**: Küresel olan Amazon CloudFront dağıtımlarına uygulanır. CloudFront için WAF yapılandırmaları, içeriğin sunulduğu yere bakılmaksızın `us-east-1` bölgesi üzerinden yönetilir.

## Ana özellikler

### İzleme Kriterleri (Koşullar)

**Koşullar**, AWS WAF'ın izlediği gelen HTTP/HTTPS isteklerinin unsurlarını belirtir; XSS, coğrafi konum (GEO), IP adresleri, Boyut kısıtlamaları, SQL Enjeksiyonu ve desenler (diziler ve regex eşleşmesi) gibi. **Ülkeye göre CloudFront seviyesinde kısıtlanan isteklerin WAF'a ulaşmayacağını** unutmak önemlidir.

Her AWS hesabı şunları yapılandırabilir:

- Her tür için **100 koşul** (yalnızca Regex için sadece **10 koşul** izin verilir, ancak bu sınırlama artırılabilir).
- **100 kural** ve **50 Web ACL**.
- Maksimum **5 oran tabanlı kural**.
- Bir uygulama yük dengeleyici ile uygulandığında **saniyede 10.000 istek** geçişi.

### Kural işlemleri

Her kurala atanan işlemler şunlardır:

- **İzin Ver**: İstek uygun CloudFront dağıtımına veya Uygulama Yük Dengeleyicisine iletilir.
- **Engelle**: İstek hemen sonlandırılır.
- **Say**: Kuralın koşullarını karşılayan istekleri sayar. Bu, kuralı İzin Ver veya Engelle olarak ayarlamadan önce kuralın doğruluğunu test etmek için yararlıdır.
- **CAPTCHA ve Zorluk**: İstekin bir bot tarafından gelmediğinden emin olmak için CAPTCHA bulmacaları ve sessiz zorluklar kullanılır.

Bir istek, Web ACL içindeki herhangi bir kurala uymazsa, **varsayılan işlem** (İzin Ver veya Engelle) uygulanır. Bir Web ACL içinde tanımlanan kuralın yürütme sırası önemlidir ve genellikle şu sırayı takip eder:

1. Beyaz Listelenen IP'ler İzin Ver.
2. Kara Listelenen IP'ler Engelle.
3. Zararlı imzaları eşleştiren istekleri Engelle.

### CloudWatch Entegrasyonu

AWS WAF, izleme için CloudWatch ile entegre olur ve İzin Verilen İstekler, Engellenen İstekler, Sayılan İstekler ve Geçen İstekler gibi metrikler sunar. Bu metrikler varsayılan olarak her dakika raporlanır ve iki hafta boyunca saklanır.

## Numaralandırma

CloudFront dağıtımlarıyla etkileşime geçmek için, Bölgeyi US East (Kuzey Virginia) olarak belirtmelisiniz:

- CLI - CloudFront kapsamını kullanırken Bölgeyi US East olarak belirtin: `--scope CLOUDFRONT --region=us-east-1` .
- API ve SDK'lar - Tüm çağrılar için, Bölge uç noktasını us-east-1 olarak kullanın.

Bölgesel hizmetlerle etkileşime geçmek için bölgeyi belirtmelisiniz:

- Örnek olarak Avrupa (İspanya) bölgesi: `--scope REGIONAL --region=eu-south-2`
```bash
# Web ACLs #

## Retrieve a list of web access control lists (Web ACLs) available in your AWS account
aws wafv2 list-web-acls --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve details about the specified Web ACL
aws wafv2 get-web-acl --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

## Retrieve a list of resources associated with a specific web access control list (Web ACL)
aws wafv2 list-resources-for-web-acl --web-acl-arn <value> # Additional permissions needed depending on the protected resource type: cognito-idp:ListResourcesForWebACL, ec2:DescribeVerifiedAccessInstanceWebAclAssociations or apprunner:ListAssociatedServicesForWebAcl
## Retrieve the Web ACL associated with the specified AWS resource
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Additional permissions needed depending on the protected resource type: cognito-idp:GetWebACLForResource, ec2:GetVerifiedAccessInstanceWebAcl, wafv2:GetWebACL or apprunner:DescribeWebAclForService

# Rule groups #

## List of the rule groups available in your AWS account
aws wafv2 list-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the details of a specific rule group
aws wafv2 get-rule-group [--name <value>] [--id <value>] [--arn <value>] [--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>]
## Retrieve the IAM policy attached to the specified rule group
aws wafv2 get-permission-policy --resource-arn <rule-group-arn> # Just the owner of the Rule Group can do this operation

# Managed rule groups (by AWS or by a third-party) #

## List the managed rule groups that are available
aws wafv2 list-available-managed-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## List the available versions of the specified managed rule group
aws wafv2 list-available-managed-rule-group-versions --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about a specific managed rule group
aws wafv2 describe-managed-rule-group --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--version-name <value>]
## Retrieve high-level information about all managed rule groups
aws wafv2 describe-all-managed-products --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about all managed rule groups from a specific vendor
aws wafv2 describe-managed-products-by-vendor --vendor-name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# IP sets #

## List the IP sets that are available in your AWS account
aws wafv2 list-ip-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the specific IP set
aws wafv2 get-ip-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the keys that are currently being managed by a rate-based rule.
aws wafv2 get-rate-based-statement-managed-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>\
--web-acl-name <value> --web-acl-id <value> --rule-name <value> [--rule-group-rule-name <value>]

# Regex pattern sets #

## List all the regex pattern sets that you manage
aws wafv2 list-regex-pattern-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieves the specified regex pattern sets
aws wafv2 get-regex-pattern-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# API Keys #

## List API keys for the specified scope
aws wafv2 list-api-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve decrypted API key
aws wafv2 get-decrypted-api-key --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --api-key <value>

# Logs #

## List of logging configurations (storage location of the logs)
aws wafv2 list-logging-configurations --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--log-scope <value>]
## Retrieve the logging configuration settings associated with a specific web ACL
aws wafv2 get-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]

# Miscelaneous #

## Retrieve a list of the tags associated to the specified resource
aws wafv2 list-tags-for-resource resource-arn <value>

## Retrieve a sample of web requests that match a specified rule within a WebACL during a specified time range
aws wafv2 get-sampled-requests --web-acl-arn <value> --rule-metric-name <value> --time-window <value> --max-items <1-500> --scope <value>

## Obtains the web ACL capacity unit (WCU) requirements for a specified scope and ruleset
aws wafv2 check-capacity --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --rules <value>

## List of available releases for the AWS WAFv2 mobile SDK
aws wafv2 list-mobile-sdk-releases --platform <IOS | ANDROID>
## Retrieves information for the specified mobile SDK release
aws wafv2 get-mobile-sdk-release --platform <value> --release-version <value>

```
## Sonraki Saldırı / Atlatma

{% hint style="success" %}
Saldırganın bakış açısından, bu hizmet saldırganın WAF korumalarını ve ağ maruziyetlerini belirlemesine yardımcı olabilir, bu da ona diğer web sitelerini tehlikeye atmasına yardımcı olabilir.

Ancak, bir saldırgan bu hizmeti de engellemek isteyebilir, böylece web siteleri WAF tarafından korunmaz.
{% endhint %}

Çoğu Silme ve Güncelleme işleminde **kilit belirteci** sağlamak gerekebilir. Bu belirteç, kaynaklar üzerinde eş zamanlı olarak güncelleme yapmaya çalışan birden fazla kullanıcı veya işlem tarafından değişikliklerin kazara üzerine yazılmasını önlemek için kullanılır. Bu belirteci elde etmek için ilgili kaynak üzerinde ilgili **listeleme** veya **alma** işlemlerini gerçekleştirebilirsiniz.

### **`wafv2:CreateRuleGroup`, `wafv2:UpdateRuleGroup`, `wafv2:DeleteRuleGroup`**

Bir saldırgan, etkilenen kaynağın güvenliğini tehlikeye atabilir:

- Örneğin, meşru IP adreslerinden gelen meşru trafiği engelleyebilecek kural grupları oluşturmak ve bu durumda hizmet dışı bırakma oluşturabilir.
- Kural gruplarını güncelleyerek, örneğin **Engelle**'den **İzin Ver**'e gibi eylemlerini değiştirebilir.
- Kritik güvenlik önlemleri sağlayan kural gruplarını silerek.
```bash
# Create Rule Group
aws wafv2 create-rule-group --name <value> --capacity <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Update Rule Group
aws wafv2 update-rule-group --name <value> --id <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Delete Rule Group
aws wafv2 delete-rule-group --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Aşağıdaki örnekler, belirli IP adreslerinden gelen meşru trafiği engelleyecek bir kural grubunu göstermektedir:
```bash
aws wafv2 create-rule-group --name BlockLegitimateIPsRuleGroup --capacity 1 --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=BlockLegitimateIPsRuleGroup --scope CLOUDFRONT --region us-east-1 --rules file://rule.json
```
**rule.json** dosyası şu şekilde görünecektir:
```json
[
{
"Name":"BlockLegitimateIPsRule",
"Priority":0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:global/ipset/legitIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action":{
"Block":{}
},
"VisibilityConfig":{
"SampledRequestsEnabled":false,
"CloudWatchMetricsEnabled":false,
"MetricName":"BlockLegitimateIPsRule"
}
}
]
```
**Potansiyel Etki**: Yetkisiz erişim, veri sızıntıları ve potansiyel DoS saldırıları.

### **`wafv2:CreateWebACL`, `wafv2:UpdateWebACL`, `wafv2:DeleteWebACL`**

Bu izinlerle, bir saldırgan şunları yapabilir:

- Yeni bir Web ACL oluşturabilir, ya kötü niyetli trafiğin geçmesine izin veren kurallar ekler ya da meşru trafiği engeller, bu da WAF'ı etkisiz hale getirir veya hizmet reddine neden olur.
- Mevcut Web ACL'leri güncelleyebilir, önceden engellenen SQL enjeksiyonu veya cross-site scripting gibi saldırılara izin vermek için kuralları değiştirebilir veya geçerli istekleri engelleyerek normal trafik akışını bozabilir.
- Bir Web ACL'sini silebilir, etkilenen kaynakları tamamen korumasız bırakarak geniş bir web saldırıları yelpazesine maruz bırakabilir.

{% hint style="info" %}

Belirtilen **WebACL**'yi yalnızca **ManagedByFirewallManager** false ise silebilirsiniz.

{% endhint %}
```bash
# Create Web ACL
aws wafv2 create-web-acl --name <value> --default-action <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Update Web ACL
aws wafv2 update-web-acl --name <value> --id <value> --default-action <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Delete Web ACL
aws wafv2 delete-web-acl --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
**Orijinal Web ACL**:
```json
{
"WebACL": {
"Name": "AllowLegitimateIPsWebACL",
"Id": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/webacl/AllowLegitimateIPsWebACL/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"DefaultAction": {
"Allow": {}
},
"Description": "",
"Rules": [
{
"Name": "AllowLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Allow": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsRule"
}
}
],
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsWebACL"
},
"Capacity": 1,
"ManagedByFirewallManager": false,
"LabelNamespace": "awswaf:123456789012:webacl:AllowLegitimateIPsWebACL:"
},
"LockToken": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}

```
Web ACL'yi güncelleme komutu:

```bash
aws waf update-web-acl --web-acl-id <value> --updates <value>
```
```json
aws wafv2 update-web-acl --name AllowLegitimateIPsWebACL --scope REGIONAL --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --default-action Block={} --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=AllowLegitimateIPsWebACL --rules file://rule.json --region us-east-1
```
Dosya **rule.json** şu şekilde görünecektir:
```json
[
{
"Name": "BlockLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Block": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "BlockLegitimateIPRule"
}
}
]
```
**Potansiyel Etki**: Yetkisiz erişim, veri sızıntıları ve potansiyel DoS saldırıları.

### **`wafv2:AssociateWebACL`, `wafv2:DisassociateWebACL`**

**`wafv2:AssociateWebACL`** izni, bir saldırganın web ACL'leri (Erişim Kontrol Listeleri) kaynaklarla ilişkilendirmesine izin verir, güvenlik kontrollerini atlayarak yetkisiz trafiğin uygulamaya ulaşmasına olanak tanır, bu da SQL enjeksiyonu veya cross-site scripting (XSS) gibi istismarlara yol açabilir. Benzer şekilde, **`wafv2:DisassociateWebACL`** izni ile saldırgan geçici olarak güvenlik önlemlerini devre dışı bırakabilir, kaynakları algılanmadan zafiyetlere maruz bırakabilir.

Korunan kaynak türüne bağlı olarak ek izinlere ihtiyaç duyulacaktır:

- **İlişkilendirme**
- apigateway:SetWebACL
- apprunner:AssociateWebAcl
- appsync:SetWebACL
- cognito-idp:AssociateWebACL
- ec2:AssociateVerifiedAccessInstanceWebAcl
- elasticloadbalancing:SetWebAcl
- **İlişkilendirmeyi Kaldırma**
- apigateway:SetWebACL
- apprunner:DisassociateWebAcl
- appsync:SetWebACL
- cognito-idp:DisassociateWebACL
- ec2:DisassociateVerifiedAccessInstanceWebAcl
- elasticloadbalancing:SetWebAcl
```bash
# Associate
aws wafv2 associate-web-acl --web-acl-arn <value> --resource-arn <value>
# Disassociate
aws wafv2 disassociate-web-acl --resource-arn <value>
```
**Potansiyel Etki**: AWS WAF tarafından korunan AWS ortamlarında güvenlik ihlali, artan istismar riski ve potansiyel hizmet kesintileri.

### **`wafv2:CreateIPSet`, `wafv2:UpdateIPSet`, `wafv2:DeleteIPSet`**

Bir saldırgan, AWS WAF tarafından yönetilen IP setlerini oluşturabilir, güncelleştirebilir ve silebilir. Bu tehlikeli olabilir çünkü kötü niyetli trafiği izin vermek için yeni IP setleri oluşturabilir, meşru trafiği engellemek için IP setlerini değiştirebilir, mevcut IP setlerini kötü niyetli IP adreslerini içerecek şekilde güncelleştirebilir, güvenilir IP adreslerini kaldırabilir veya kritik kaynakları korumak amacıyla oluşturulan kritik IP setlerini silebilir.
```bash
# Create IP set
aws wafv2 create-ip-set --name <value> --ip-address-version <IPV4 | IPV6> --addresses <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Update IP set
aws wafv2 update-ip-set --name <value> --id <value> --addresses <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete IP set
aws wafv2 delete-ip-set --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Aşağıdaki örnek, mevcut IP kümesini istenen IP kümesiyle **üzerine yazmanın** nasıl yapıldığını gösterir:
```bash
aws wafv2 update-ip-set --name LegitimateIPv4Set --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --addresses 99.99.99.99/32 --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --scope CLOUDFRONT --region us-east-1
```
**Potansiyel Etki**: Yetkisiz erişim ve meşru trafiğin engellenmesi.

### **`wafv2:CreateRegexPatternSet`**, **`wafv2:UpdateRegexPatternSet`**, **`wafv2:DeleteRegexPatternSet`**

Bu izinlere sahip bir saldırgan, AWS WAF tarafından belirli desenlere dayalı gelen trafiği kontrol etmek ve filtrelemek için kullanılan düzenli ifade desen setlerini manipüle edebilir.

- Yeni regex desenlerinin oluşturulması, bir saldırganın zararlı içeriğe izin vermesine yardımcı olabilir
- Mevcut desenleri güncellemek, bir saldırganın güvenlik kurallarını atlamasına olanak tanır
- Kötü amaçlı faaliyetleri engellemek için tasarlanmış desenleri silmek, bir saldırganın kötü amaçlı yükleri göndermesine ve güvenlik önlemlerini atlamasına neden olabilir.
```bash
# Create regex pattern set
aws wafv2 create-regex-pattern-set --name <value> --regular-expression-list <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--description <value>]
# Update regex pattern set
aws wafv2 update-regex-pattern-set --name <value> --id <value> --regular-expression-list <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete regex pattern set
aws wafv2 delete-regex-pattern-set --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --id <value> --lock-token <value>
```
**Potansiyel Etki**: AWS WAF tarafından korunan hizmetler ve kaynaklar üzerindeki hassas verilerin ifşa edilmesi veya hizmetlerin kesintiye uğraması gibi kötü niyetli içeriklerin geçmesine izin vererek güvenlik kontrollerini atlamak.

### **(`wavf2:PutLoggingConfiguration` &** `iam:CreateServiceLinkedRole`), **`wafv2:DeleteLoggingConfiguration`**

Bir saldırgan **`wafv2:DeleteLoggingConfiguration`** iznine sahipse belirtilen Web ACL'den günlüğe kayıt konfigürasyonunu kaldırabilir. Daha sonra, **`wavf2:PutLoggingConfiguration`** ve **`iam:CreateServiceLinkedRole`** izinleriyle, saldırgan, günlüğe kayıt konfigürasyonu oluşturabilir veya değiştirebilir (bunu sildikten sonra) ve ya günlüğü hiç kaydetmemek veya yetkisiz hedeflere yönlendirmek için, örneğin Amazon S3 kovaları, Amazon CloudWatch Logs günlük grubu veya Amazon Kinesis Data Firehose.

Oluşturma sürecinde, hizmet otomatik olarak belirtilen günlükleme hedefine kayıtların yazılmasına izin vermek için gerekli izinleri kurar:

- **Amazon CloudWatch Logs:** AWS WAF, belirlenen CloudWatch Logs günlük grubunda bir kaynak politikası oluşturur. Bu politika, AWS WAF'ın günlükleri günlük grubuna yazmak için gereken izinlere sahip olduğundan emin olur.
- **Amazon S3 Kova:** AWS WAF, belirlenen S3 kovasında bir kova politikası oluşturur. Bu politika, AWS WAF'a belirtilen kovaya günlükleri yüklemek için gerekli izinleri verir.
- **Amazon Kinesis Data Firehose:** AWS WAF, Kinesis Data Firehose ile etkileşim için özel bir hizmet bağlantılı rol oluşturur. Bu rol, AWS WAF'ın yapılandırılmış Firehose akışına günlükleri iletebilmesine izin verir.

{% hint style="info" %}

Her web ACL için yalnızca bir günlükleme hedefi tanımlamak mümkündür.

{% endhint %}
```bash
# Put logging configuration
aws wafv2 put-logging-configuration --logging-configuration <value>
# Delete logging configuration
aws wafv2 delete-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]
```
**Potansiyel Etki:** Güvenlik olaylarına dair görünürlüğü zorlaştırabilir, olay yanıt sürecini engelleyebilir ve AWS WAF korumalı ortamlarda gizli kötü niyetli faaliyetleri kolaylaştırabilir.

### **`wafv2:DeleteAPIKey`**

Bu izinlere sahip bir saldırgan, mevcut API anahtarlarını silebilir, CAPTCHA'yı etkisiz hale getirebilir ve form gönderimleri ve erişim kontrolleri gibi ona bağlı işlevselliği bozabilir. Bu CAPTCHA'nın uygulanmasına bağlı olarak, bu ya bir CAPTCHA atlatma ya da kaynakta hata yönetiminin düzgün şekilde ayarlanmamış olması durumunda bir DoS'a yol açabilir.
```bash
# Delete API key
aws wafv2 delete-api-key --api-key <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
**Potansiyel Etki**: CAPTCHA korumalarını devre dışı bırakma veya uygulama işlevselliğini bozma, güvenlik ihlallerine ve potansiyel veri hırsızlığına yol açabilir.

### **`wafv2:TagResource`, `wafv2:UntagResource`**

Saldırgan, Web ACL'leri, kural grupları, IP setleri, regex desen setleri ve günlükleme yapılandırmaları gibi AWS WAFv2 kaynaklarından etiket ekleyebilir, değiştirebilir veya kaldırabilir.
```bash
# Tag
aws wafv2 tag-resource --resource-arn <value> --tags <value>
# Untag
aws wafv2 untag-resource --resource-arn <value> --tag-keys <value>
```
**Potansiyel Etki**: Kaynak değiştirme, bilgi sızdırma, maliyet manipülasyonu ve operasyonel kesinti.

# Referanslar
* [https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application](https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awswafv2.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awswafv2.html)

<details>

<summary><strong>Sıfırdan kahraman olacak şekilde AWS hacklemeyi öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**]'na göz atın(https://github.com/sponsors/carlospolop)!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)** adresinden takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR'lar göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
