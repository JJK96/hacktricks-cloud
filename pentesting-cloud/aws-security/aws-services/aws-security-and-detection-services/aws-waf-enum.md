# AWS - WAF Enum

{% hint style="success" %}
Lernen Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys einreichen.

</details>
{% endhint %}

# AWS WAF

AWS WAF ist eine **Web Application Firewall**, die entwickelt wurde, um **Webanwendungen oder APIs** vor verschiedenen Web-Exploits zu sch√ºtzen, die sich auf deren Verf√ºgbarkeit, Sicherheit oder Ressourcenverbrauch auswirken k√∂nnen. Benutzer k√∂nnen eingehenden Datenverkehr kontrollieren, indem sie **Sicherheitsregeln** festlegen, die typische Angriffsvektoren wie SQL-Injektion oder Cross-Site-Scripting abwehren, und auch benutzerdefinierte Filterregeln definieren.

## Schl√ºsselkonzepte

### Web ACL (Access Control List)

Ein Web ACL ist eine Sammlung von Regeln, die auf Ihre Webanwendungen oder APIs angewendet werden k√∂nnen. Wenn Sie ein Web ACL mit einer Ressource verkn√ºpfen, √ºberpr√ºft AWS WAF eingehende Anfragen basierend auf den in dem Web ACL definierten Regeln und f√ºhrt die angegebenen Aktionen aus.

### Regelgruppe

Eine Regelgruppe ist eine wiederverwendbare Sammlung von Regeln, die auf mehrere Web ACLs angewendet werden k√∂nnen. Regelgruppen helfen dabei, konsistente Regelsets √ºber verschiedene Webanwendungen oder APIs hinweg zu verwalten und aufrechtzuerhalten.

Jede Regelgruppe hat ihre zugeh√∂rige **Kapazit√§t**, die hilft, die Betriebsressourcen zu berechnen und zu kontrollieren, die zum Ausf√ºhren Ihrer Regeln, Regelgruppen und Web ACLs verwendet werden. Sobald ihr Wert bei der Erstellung festgelegt ist, kann er nicht mehr ge√§ndert werden.

### Regel

Eine Regel definiert eine Reihe von Bedingungen, die AWS WAF verwendet, um eingehende Webanfragen zu √ºberpr√ºfen. Es gibt zwei Hauptarten von Regeln:

1. **Regul√§re Regel**: Dieser Regeltyp verwendet spezifizierte Bedingungen, um zu bestimmen, ob Webanfragen zugelassen, blockiert oder gez√§hlt werden sollen.
2. **Rate-Based Rule**: Z√§hlt Anfragen von einer bestimmten IP-Adresse √ºber einen Zeitraum von f√ºnf Minuten. Hier definieren Benutzer einen Schwellenwert, und wenn die Anzahl der Anfragen von einer IP-Adresse innerhalb von f√ºnf Minuten diesen Grenzwert √ºberschreitet, werden nachfolgende Anfragen von dieser IP-Adresse blockiert, bis die Anfrageh√§ufigkeit unter den Schwellenwert f√§llt. Der Mindestschwellenwert f√ºr rate-basierte Regeln betr√§gt **2000 Anfragen**.

### Managed Rules

AWS WAF bietet vordefinierte, verwaltete Regelsets, die von AWS und AWS Marketplace-Verk√§ufern gepflegt werden. Diese Regelsets bieten Schutz vor g√§ngigen Bedrohungen und werden regelm√§√üig aktualisiert, um neue Schwachstellen zu beheben.

### IP-Set

Ein IP-Set ist eine Liste von IP-Adressen oder IP-Adressbereichen, die Sie zulassen oder blockieren m√∂chten. IP-Sets vereinfachen die Verwaltung von IP-basierten Regeln.

### Regex Pattern Set

Ein Regex Pattern Set enth√§lt eine oder mehrere regul√§re Ausdr√ºcke (Regex), die Muster definieren, nach denen in Webanfragen gesucht werden soll. Dies ist n√ºtzlich f√ºr komplexere √úbereinstimmungsszenarien, wie das Filtern spezifischer Zeichenfolgen.

### Sperrtoken

Ein Sperrtoken wird zur Nebenl√§ufigkeitskontrolle verwendet, wenn Updates an WAF-Ressourcen vorgenommen werden. Es stellt sicher, dass √Ñnderungen nicht versehentlich von mehreren Benutzern oder Prozessen √ºberschrieben werden, die gleichzeitig versuchen, dieselbe Ressource zu aktualisieren.

### API-Schl√ºssel

API-Schl√ºssel in AWS WAF werden verwendet, um Anfragen an bestimmte API-Operationen zu authentifizieren. Diese Schl√ºssel sind verschl√ºsselt und sicher verwaltet, um den Zugriff zu kontrollieren und sicherzustellen, dass nur autorisierte Benutzer √Ñnderungen an WAF-Konfigurationen vornehmen k√∂nnen.

- **Beispiel**: Integration der CAPTCHA-API.

### Berechtigungsrichtlinie

Eine Berechtigungsrichtlinie ist eine IAM-Richtlinie, die angibt, wer Aktionen auf AWS WAF-Ressourcen ausf√ºhren kann. Durch die Definition von Berechtigungen k√∂nnen Sie den Zugriff auf WAF-Ressourcen steuern und sicherstellen, dass nur autorisierte Benutzer Konfigurationen erstellen, aktualisieren oder l√∂schen k√∂nnen.

### Bereich

Der Bereichsparameter in AWS WAF gibt an, ob die WAF-Regeln und -Konfigurationen auf eine regionale Anwendung oder eine Amazon CloudFront-Verteilung angewendet werden.

- **REGIONAL**: Gilt f√ºr regionale Dienste wie Application Load Balancers (ALB), Amazon API Gateway REST API, AWS AppSync GraphQL API, Amazon Cognito-Benutzerpool, AWS App Runner-Dienst und AWS Verified Access-Instanz. Sie geben die AWS-Region an, in der sich diese Ressourcen befinden.
- **CLOUDFRONT**: Gilt f√ºr Amazon CloudFront-Verteilungen, die global sind. WAF-Konfigurationen f√ºr CloudFront werden unabh√§ngig davon, wo der Inhalt bereitgestellt wird, √ºber die Region `us-east-1` verwaltet.

## Hauptfunktionen

### √úberwachungskriterien (Bedingungen)

**Bedingungen** geben die Elemente von eingehenden HTTP/HTTPS-Anfragen an, die von AWS WAF √ºberwacht werden, darunter XSS, geografischer Standort (GEO), IP-Adressen, Gr√∂√üenbeschr√§nkungen, SQL-Injektion und Muster (Zeichenfolgen und Regex-√úbereinstimmung). Es ist wichtig zu beachten, dass **Anfragen, die auf CloudFront-Ebene basierend auf L√§ndern eingeschr√§nkt sind, WAF nicht erreichen**.

Jedes AWS-Konto kann konfigurieren:

- **100 Bedingungen** f√ºr jeden Typ (au√üer f√ºr Regex, wo nur **10 Bedingungen** erlaubt sind, aber dieses Limit erh√∂ht werden kann).
- **100 Regeln** und **50 Web ACLs**.
- Maximal **5 rate-basierte Regeln**.
- Eine Durchsatzrate von **10.000 Anfragen pro Sekunde**, wenn WAF mit einem Application Load Balancer implementiert wird.

### Regelaktionen

Aktionen werden jeder Regel zugewiesen, mit den Optionen:

- **Zulassen**: Die Anfrage wird an die entsprechende CloudFront-Verteilung oder den Application Load Balancer weitergeleitet.
- **Blockieren**: Die Anfrage wird sofort beendet.
- **Z√§hlen**: Z√§hlt die Bedingungen der Regel erf√ºllenden Anfragen. Dies ist n√ºtzlich f√ºr die Regelpr√ºfung, um die Genauigkeit der Regel vor der Einstellung auf Zulassen oder Blockieren zu best√§tigen.
- **CAPTCHA und Challenge:** Es wird √ºberpr√ºft, dass die Anfrage nicht von einem Bot stammt, indem CAPTCHA-R√§tsel und stille Herausforderungen verwendet werden.

Wenn eine Anfrage keiner Regel innerhalb des Web ACL entspricht, wird die **Standardaktion** (Zulassen oder Blockieren) ausgef√ºhrt. Die Reihenfolge der Regelausf√ºhrung, die innerhalb eines Web ACL definiert ist, ist entscheidend und folgt in der Regel dieser Sequenz:

1. Zulassen von IP-Adressen in der Whitelist.
2. Blockieren von IP-Adressen in der Blacklist.
3. Blockieren von Anfragen, die mit sch√§dlichen Signaturen √ºbereinstimmen.

### CloudWatch-Integration

AWS WAF integriert sich mit CloudWatch zur √úberwachung und bietet Metriken wie AllowedRequests, BlockedRequests, CountedRequests und PassedRequests. Diese Metriken werden standardm√§√üig alle Minute gemeldet und f√ºr einen Zeitraum von zwei Wochen gespeichert.

## Enumeration

Um mit CloudFront-Verteilungen zu interagieren, m√ºssen Sie die Region US East (N. Virginia) angeben:

- CLI - Geben Sie die Region US East an, wenn Sie den CloudFront-Bereich verwenden:¬†`--scope CLOUDFRONT --region=us-east-1`¬†.
- API und SDKs - Verwenden Sie f√ºr alle Aufrufe den Regionsendpunkt us-east-1.

Um mit regionalen Diensten zu interagieren, sollten Sie die Region angeben:

- Beispiel mit der Region Europa (Spanien): `--scope REGIONAL --region=eu-south-2`
```bash
# Web ACLs #

## Retrieve a list of web access control lists (Web ACLs) available in your AWS account
aws wafv2 list-web-acls --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve details about the specified Web ACL
aws wafv2 get-web-acl --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

## Retrieve a list of resources associated with a specific web access control list (Web ACL)
aws wafv2 list-resources-for-web-acl --web-acl-arn <value> # Additional permissions needed depending on the protected resource type: cognito-idp:ListResourcesForWebACL, ec2:DescribeVerifiedAccessInstanceWebAclAssociations or apprunner:ListAssociatedServicesForWebAcl
## Retrieve the Web ACL associated with the specified AWS resource
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Additional permissions needed depending on the protected resource type: cognito-idp:GetWebACLForResource, ec2:GetVerifiedAccessInstanceWebAcl, wafv2:GetWebACL or apprunner:DescribeWebAclForService

# Rule groups #

## List of the rule groups available in your AWS account
aws wafv2 list-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the details of a specific rule group
aws wafv2 get-rule-group [--name <value>] [--id <value>] [--arn <value>] [--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>]
## Retrieve the IAM policy attached to the specified rule group
aws wafv2 get-permission-policy --resource-arn <rule-group-arn> # Just the owner of the Rule Group can do this operation

# Managed rule groups (by AWS or by a third-party) #

## List the managed rule groups that are available
aws wafv2 list-available-managed-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## List the available versions of the specified managed rule group
aws wafv2 list-available-managed-rule-group-versions --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about a specific managed rule group
aws wafv2 describe-managed-rule-group --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--version-name <value>]
## Retrieve high-level information about all managed rule groups
aws wafv2 describe-all-managed-products --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about all managed rule groups from a specific vendor
aws wafv2 describe-managed-products-by-vendor --vendor-name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# IP sets #

## List the IP sets that are available in your AWS account
aws wafv2 list-ip-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the specific IP set
aws wafv2 get-ip-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the keys that are currently being managed by a rate-based rule.
aws wafv2 get-rate-based-statement-managed-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>\
--web-acl-name <value> --web-acl-id <value> --rule-name <value> [--rule-group-rule-name <value>]

# Regex pattern sets #

## List all the regex pattern sets that you manage
aws wafv2 list-regex-pattern-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieves the specified regex pattern sets
aws wafv2 get-regex-pattern-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# API Keys #

## List API keys for the specified scope
aws wafv2 list-api-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve decrypted API key
aws wafv2 get-decrypted-api-key --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --api-key <value>

# Logs #

## List of logging configurations (storage location of the logs)
aws wafv2 list-logging-configurations --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--log-scope <value>]
## Retrieve the logging configuration settings associated with a specific web ACL
aws wafv2 get-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]

# Miscelaneous #

## Retrieve a list of the tags associated to the specified resource
aws wafv2 list-tags-for-resource resource-arn <value>

## Retrieve a sample of web requests that match a specified rule within a WebACL during a specified time range
aws wafv2 get-sampled-requests --web-acl-arn <value> --rule-metric-name <value> --time-window <value> --max-items <1-500> --scope <value>

## Obtains the web ACL capacity unit (WCU) requirements for a specified scope and ruleset
aws wafv2 check-capacity --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --rules <value>

## List of available releases for the AWS WAFv2 mobile SDK
aws wafv2 list-mobile-sdk-releases --platform <IOS | ANDROID>
## Retrieves information for the specified mobile SDK release
aws wafv2 get-mobile-sdk-release --platform <value> --release-version <value>

```
## Post-Exploitation / Umgehung

{% hint style="success" %}
Aus der Perspektive eines Angreifers kann dieser Dienst dem Angreifer helfen, WAF-Schutzma√ünahmen und Netzwerkexpositionen zu identifizieren, die ihm helfen k√∂nnten, andere Websites zu kompromittieren.

Ein Angreifer k√∂nnte jedoch auch daran interessiert sein, diesen Dienst zu st√∂ren, damit die Websites nicht durch die WAF gesch√ºtzt sind.
{% endhint %}

Bei vielen der L√∂sch- und Aktualisierungsvorg√§nge w√§re es notwendig, das **Sperrtoken** bereitzustellen. Dieses Token wird zur Nebenl√§ufigkeitskontrolle √ºber die Ressourcen verwendet, um sicherzustellen, dass √Ñnderungen nicht versehentlich von mehreren Benutzern oder Prozessen √ºberschrieben werden, die gleichzeitig versuchen, dieselbe Ressource zu aktualisieren. Um dieses Token zu erhalten, k√∂nnten Sie die entsprechenden **List**- oder **Get**-Operationen √ºber die spezifische Ressource durchf√ºhren.

### **`wafv2:CreateRuleGroup`, `wafv2:UpdateRuleGroup`, `wafv2:DeleteRuleGroup`**

Ein Angreifer k√∂nnte die Sicherheit der betroffenen Ressource kompromittieren, indem er:

- Regelgruppen erstellt, die beispielsweise legitimen Datenverkehr von legitimen IP-Adressen blockieren k√∂nnten, was zu einem Denial-of-Service f√ºhren w√ºrde.
- Regelgruppen aktualisiert, um beispielsweise ihre Aktionen von **Block** auf **Allow** zu √§ndern.
- Regelgruppen l√∂scht, die wichtige Sicherheitsma√ünahmen bieten.
```bash
# Create Rule Group
aws wafv2 create-rule-group --name <value> --capacity <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Update Rule Group
aws wafv2 update-rule-group --name <value> --id <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Delete Rule Group
aws wafv2 delete-rule-group --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Die folgenden Beispiele zeigen eine Regelgruppe, die legitimen Datenverkehr von bestimmten IP-Adressen blockieren w√ºrde:
```bash
aws wafv2 create-rule-group --name BlockLegitimateIPsRuleGroup --capacity 1 --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=BlockLegitimateIPsRuleGroup --scope CLOUDFRONT --region us-east-1 --rules file://rule.json
```
Die **rule.json** Datei w√ºrde wie folgt aussehen:
```json
[
{
"Name":"BlockLegitimateIPsRule",
"Priority":0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:global/ipset/legitIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action":{
"Block":{}
},
"VisibilityConfig":{
"SampledRequestsEnabled":false,
"CloudWatchMetricsEnabled":false,
"MetricName":"BlockLegitimateIPsRule"
}
}
]
```
**Potenzielle Auswirkungen**: Unbefugter Zugriff, Datenlecks und potenzielle DoS-Angriffe.

### **`wafv2:CreateWebACL`, `wafv2:UpdateWebACL`, `wafv2:DeleteWebACL`**

Mit diesen Berechtigungen k√∂nnte ein Angreifer:

- Ein neues Web-ACL erstellen, Regeln einf√ºhren, die b√∂sartigen Datenverkehr durchlassen oder legitimen Datenverkehr blockieren, wodurch die WAF wirkungslos wird oder einen Denial-of-Service verursachen.
- Bestehende Web-ACLs aktualisieren, Regeln √§ndern, um Angriffe wie SQL-Injektion oder Cross-Site-Scripting zu erm√∂glichen, die zuvor blockiert wurden, oder den normalen Datenverkehrsfluss st√∂ren, indem g√ºltige Anfragen blockiert werden.
- Ein Web-ACL l√∂schen, wodurch die betroffenen Ressourcen vollst√§ndig ungesch√ºtzt bleiben und einer breiten Palette von Webangriffen ausgesetzt sind.

{% hint style="info" %}

Sie k√∂nnen das angegebene¬†**WebACL** nur l√∂schen, wenn¬†**ManagedByFirewallManager**¬†falsch ist.

{% endhint %}
```bash
# Create Web ACL
aws wafv2 create-web-acl --name <value> --default-action <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Update Web ACL
aws wafv2 update-web-acl --name <value> --id <value> --default-action <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Delete Web ACL
aws wafv2 delete-web-acl --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Das folgende Beispiel zeigt, wie man eine Web-ACL aktualisiert, um den legitimen Datenverkehr aus einem bestimmten IP-Set zu blockieren. Wenn die Ursprungs-IP nicht mit einer dieser IPs √ºbereinstimmt, w√ºrde die Standardaktion es ebenfalls blockieren und so eine DoS verursachen.

**Urspr√ºngliche Web-ACL**:
```json
{
"WebACL": {
"Name": "AllowLegitimateIPsWebACL",
"Id": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/webacl/AllowLegitimateIPsWebACL/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"DefaultAction": {
"Allow": {}
},
"Description": "",
"Rules": [
{
"Name": "AllowLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Allow": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsRule"
}
}
],
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsWebACL"
},
"Capacity": 1,
"ManagedByFirewallManager": false,
"LabelNamespace": "awswaf:123456789012:webacl:AllowLegitimateIPsWebACL:"
},
"LockToken": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}

```
Befehl zum Aktualisieren des Web-ACL:
```json
aws wafv2 update-web-acl --name AllowLegitimateIPsWebACL --scope REGIONAL --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --default-action Block={} --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=AllowLegitimateIPsWebACL --rules file://rule.json --region us-east-1
```
Die **rule.json** Datei w√ºrde wie folgt aussehen:
```json
[
{
"Name": "BlockLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Block": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "BlockLegitimateIPRule"
}
}
]
```
**Potenzielle Auswirkungen**: Nicht autorisierter Zugriff, Datenlecks und potenzielle DoS-Angriffe.

### **`wafv2:AssociateWebACL`, `wafv2:DisassociateWebACL`**

Die Berechtigung **`wafv2:AssociateWebACL`** w√ºrde einem Angreifer erm√∂glichen, Web-ACLs (Zugriffskontrolllisten) mit Ressourcen zu verkn√ºpfen, wodurch Sicherheitskontrollen umgangen werden k√∂nnten. Dies w√ºrde nicht autorisierten Datenverkehr zur Anwendung durchlassen und potenziell zu Exploits wie SQL-Injektionen oder Cross-Site-Scripting (XSS) f√ºhren. Im Gegensatz dazu k√∂nnte der Angreifer mit der Berechtigung **`wafv2:DisassociateWebACL`** vor√ºbergehend Sicherheitsschutzma√ünahmen deaktivieren und die Ressourcen so anf√§llig machen, ohne entdeckt zu werden.

Die zus√§tzlichen Berechtigungen w√§ren je nach gesch√ºtztem Ressourcentyp erforderlich:

- **Verkn√ºpfen**
- apigateway:SetWebACL
- apprunner:AssociateWebAcl
- appsync:SetWebACL
- cognito-idp:AssociateWebACL
- ec2:AssociateVerifiedAccessInstanceWebAcl
- elasticloadbalancing:SetWebAcl
- **Trennen**
- apigateway:SetWebACL
- apprunner:DisassociateWebAcl
- appsync:SetWebACL
- cognito-idp:DisassociateWebACL
- ec2:DisassociateVerifiedAccessInstanceWebAcl
- elasticloadbalancing:SetWebAcl
```bash
# Associate
aws wafv2 associate-web-acl --web-acl-arn <value> --resource-arn <value>
# Disassociate
aws wafv2 disassociate-web-acl --resource-arn <value>
```
**Potenzielle Auswirkungen**: Kompromittierte Ressourcensicherheit, erh√∂htes Risiko f√ºr Ausnutzung und potenzielle Serviceunterbrechungen in AWS-Umgebungen, die von AWS WAF gesch√ºtzt werden.

### **`wafv2:CreateIPSet`, `wafv2:UpdateIPSet`, `wafv2:DeleteIPSet`**

Ein Angreifer k√∂nnte in der Lage sein, die IP-Sets zu erstellen, zu aktualisieren und zu l√∂schen, die von AWS WAF verwaltet werden. Dies k√∂nnte gef√§hrlich sein, da neue IP-Sets erstellt werden k√∂nnten, um b√∂sartigen Datenverkehr zuzulassen, IP-Sets modifiziert werden k√∂nnten, um legitimen Datenverkehr zu blockieren, bestehende IP-Sets aktualisiert werden k√∂nnten, um b√∂sartige IP-Adressen einzuschlie√üen, vertrauensw√ºrdige IP-Adressen entfernt oder wichtige IP-Sets gel√∂scht werden k√∂nnten, die dazu bestimmt sind, wichtige Ressourcen zu sch√ºtzen.
```bash
# Create IP set
aws wafv2 create-ip-set --name <value> --ip-address-version <IPV4 | IPV6> --addresses <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Update IP set
aws wafv2 update-ip-set --name <value> --id <value> --addresses <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete IP set
aws wafv2 delete-ip-set --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Das folgende Beispiel zeigt, wie das vorhandene IP-Set durch das gew√ºnschte IP-Set **√ºberschrieben wird**:
```bash
aws wafv2 update-ip-set --name LegitimateIPv4Set --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --addresses 99.99.99.99/32 --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --scope CLOUDFRONT --region us-east-1
```
**Potenzielle Auswirkungen**: Unbefugter Zugriff und Blockierung legitimen Datenverkehrs.

### **`wafv2:CreateRegexPatternSet`**, **`wafv2:UpdateRegexPatternSet`**, **`wafv2:DeleteRegexPatternSet`**

Ein Angreifer mit diesen Berechtigungen k√∂nnte die regul√§ren Ausdrucksmuster-Sets manipulieren, die von AWS WAF verwendet werden, um den eingehenden Datenverkehr basierend auf spezifischen Mustern zu kontrollieren und zu filtern.

- Durch das Erstellen neuer Regex-Muster k√∂nnte ein Angreifer sch√§dliche Inhalte zulassen.
- Durch das Aktualisieren der vorhandenen Muster k√∂nnte ein Angreifer Sicherheitsregeln umgehen.
- Das L√∂schen von Mustern, die dazu bestimmt sind, b√∂sartige Aktivit√§ten zu blockieren, k√∂nnte einen Angreifer dazu verleiten, b√∂sartige Payloads zu senden und die Sicherheitsma√ünahmen zu umgehen.
```bash
# Create regex pattern set
aws wafv2 create-regex-pattern-set --name <value> --regular-expression-list <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--description <value>]
# Update regex pattern set
aws wafv2 update-regex-pattern-set --name <value> --id <value> --regular-expression-list <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete regex pattern set
aws wafv2 delete-regex-pattern-set --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --id <value> --lock-token <value>
```
**Potenzielle Auswirkungen**: Umgehung von Sicherheitskontrollen, die b√∂sartige Inhalte zulassen und m√∂glicherweise sensible Daten offenlegen oder Dienste und Ressourcen gef√§hrden, die von AWS WAF gesch√ºtzt werden.

### **(`wavf2:PutLoggingConfiguration` &** `iam:CreateServiceLinkedRole`), **`wafv2:DeleteLoggingConfiguration`**

Ein Angreifer mit den Berechtigungen **`wafv2:DeleteLoggingConfiguration`** k√∂nnte die Protokollierungskonfiguration aus dem angegebenen Web ACL entfernen. Anschlie√üend k√∂nnte ein Angreifer mit den Berechtigungen **`wavf2:PutLoggingConfiguration`** und **`iam:CreateServiceLinkedRole`** Protokollierungskonfigurationen erstellen oder ersetzen (nachdem sie gel√∂scht wurden), um entweder die Protokollierung vollst√§ndig zu verhindern oder Protokolle an nicht autorisierte Ziele umzuleiten, wie z. B. Amazon S3-Buckets, Amazon CloudWatch Logs-Log-Gruppen oder einen Amazon Kinesis Data Firehose unter Kontrolle.

W√§hrend des Erstellungsprozesses richtet der Dienst automatisch die erforderlichen Berechtigungen ein, um das Schreiben von Protokollen an das angegebene Protokollziel zu erm√∂glichen:

- **Amazon CloudWatch Logs:** AWS WAF erstellt eine Ressourcenrichtlinie in der zugewiesenen CloudWatch Logs-Log-Gruppe. Diese Richtlinie stellt sicher, dass AWS WAF √ºber die erforderlichen Berechtigungen zum Schreiben von Protokollen in die Log-Gruppe verf√ºgt.
- **Amazon S3-Bucket:** AWS WAF erstellt eine Bucket-Richtlinie im zugewiesenen S3-Bucket. Diese Richtlinie gew√§hrt AWS WAF die erforderlichen Berechtigungen zum Hochladen von Protokollen in den angegebenen Bucket.
- **Amazon Kinesis Data Firehose:** AWS WAF erstellt eine servicebezogene Rolle speziell f√ºr die Interaktion mit Kinesis Data Firehose. Diese Rolle erm√∂glicht es AWS WAF, Protokolle an den konfigurierten Firehose-Stream zu √ºbermitteln.

{% hint style="info" %}

Es ist nur m√∂glich, ein Protokollziel pro Web ACL zu definieren.

{% endhint %}
```bash
# Put logging configuration
aws wafv2 put-logging-configuration --logging-configuration <value>
# Delete logging configuration
aws wafv2 delete-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]
```
**Potenzielle Auswirkungen:** Beeintr√§chtigung der Sichtbarkeit von Sicherheitsereignissen, Erschwerung des Incident-Response-Prozesses und Unterst√ºtzung verdeckter b√∂sartiger Aktivit√§ten innerhalb von AWS WAF-gesch√ºtzten Umgebungen.

### **`wafv2:DeleteAPIKey`**

Ein Angreifer mit diesen Berechtigungen k√∂nnte bestehende API-Schl√ºssel l√∂schen, was die CAPTCHA unwirksam macht und die Funktionalit√§t beeintr√§chtigt, die darauf angewiesen ist, wie z. B. Formulareinreichungen und Zugriffssteuerungen. Abh√§ngig von der Implementierung dieser CAPTCHA k√∂nnte dies entweder zu einem CAPTCHA-Bypass oder zu einem DoS f√ºhren, wenn das Fehlermanagement nicht ordnungsgem√§√ü im Ressourcenbereich festgelegt ist.
```bash
# Delete API key
aws wafv2 delete-api-key --api-key <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
**Potenzielle Auswirkungen**: Deaktivierung von CAPTCHA-Schutzma√ünahmen oder St√∂rung der Anwendungs‚Äã‚Äãfunktionalit√§t, was zu Sicherheitsverletzungen und potenziellem Datenraub f√ºhren kann.

### **`wafv2:TagResource`,¬†`wafv2:UntagResource`**

Ein Angreifer k√∂nnte Tags zu AWS WAFv2-Ressourcen hinzuf√ºgen, √§ndern oder entfernen, wie z. B. Web-ACLs, Regelgruppen, IP-Sets, Regex-Muster-Sets und Protokollierungskonfigurationen.
```bash
# Tag
aws wafv2 tag-resource --resource-arn <value> --tags <value>
# Untag
aws wafv2 untag-resource --resource-arn <value> --tag-keys <value>
```
**Potenzielle Auswirkungen**: Ressourcenmanipulation, Informationsleckage, Kostenmanipulation und Betriebsunterbrechung.

# Referenzen
* [https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application](https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awswafv2.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awswafv2.html)

{% hint style="success" %}
Lernen Sie & √ºben Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie & √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github Repositories einreichen.

</details>
{% endhint %}
