# AWS - WAF Enum

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

# AWS WAF

Το AWS WAF είναι ένας **τοίχος προστασίας εφαρμογών web** σχεδιασμένος για να **προστατεύει εφαρμογές web ή APIs** από διάφορες επιθέσεις που μπορεί να επηρεάσουν τη διαθεσιμότητά τους, την ασφάλεια ή την κατανάλωση πόρων. Δίνει τη δυνατότητα στους χρήστες να ελέγχουν την εισερχόμενη κίνηση μέσω της δημιουργίας **κανόνων ασφαλείας** που αντιμετωπίζουν τυπικούς διανυσματικούς επιθέσεις όπως είναι η εισχώρηση SQL ή το cross-site scripting και επίσης μέσω του καθορισμού προσαρμοσμένων κανόνων φιλτραρίσματος.

## Βασικές έννοιες

### Web ACL (Λίστα Ελέγχου Πρόσβασης)

Μια Web ACL είναι μια συλλογή κανόνων που μπορείτε να εφαρμόσετε στις εφαρμογές web ή στις APIs σας. Όταν συσχετίζετε μια Web ACL με ένα πόρο, το AWS WAF ελέγχει τις εισερχόμενες αιτήσεις βασιζόμενο στους κανόνες που έχουν οριστεί στη Web ACL και λαμβάνει τις καθορισμένες ενέργειες.

### Ομάδα Κανόνων

Μια Ομάδα Κανόνων είναι μια επαναχρησιμοποιήσιμη συλλογή κανόνων που μπορείτε να εφαρμόσετε σε πολλές Web ACLs. Οι ομάδες κανόνων βοηθούν στη διαχείριση και στη διατήρηση συνεπών συνόλων κανόνων σε διαφορετικές εφαρμογές web ή APIs.

Κάθε ομάδα κανόνων έχει τη σχετιζόμενη **χωρητικότητα**, η οποία βοηθά στον υπολογισμό και τον έλεγχο των λειτουργικών πόρων που χρησιμοποιούνται για την εκτέλεση των κανόνων, των ομάδων κανόνων και των Web ACLs. Μόλις οριστεί η τιμή της κατά τη δημιουργία, δεν είναι δυνατή η τροποποίησή της.

### Κανόνας

Ένας κανόνας ορίζει ένα σύνολο συνθηκών που το AWS WAF χρησιμοποιεί για να ελέγξει τις εισερχόμενες αιτήσεις web. Υπάρχουν δύο κύριοι τύποι κανόνων:

1. **Κανόνας Κανονικός**: Αυτός ο τύπος κανόνα χρησιμοποιεί συγκεκριμένες συνθήκες για να καθορίσει εάν θα επιτραπεί, αποκλειστεί ή καταμετρηθούν οι αιτήσεις web.
2. **Κανόνας Βασισμένος στο Ρυθμό**: Καταμετρά τις αιτήσεις από μια συγκεκριμένη διεύθυνση IP για ένα πεντάλεπτο διάστημα. Εδώ, οι χρήστες ορίζουν ένα κατώτατο όριο, και εάν ο αριθμός των αιτήσεων από μια IP υπερβεί αυτό το όριο εντός πέντε λεπτών, οι επόμενες αιτήσεις από αυτήν την IP αποκλείονται μέχρι ο ρυθμός των αιτήσεων να πέσει κάτω από το όριο. Το ελάχιστο όριο για τους κανόνες βασισμένους στο ρυθμό είναι **2000 αιτήσεις**.

### Διαχειριζόμενοι Κανόνες

Το AWS WAF προσφέρει προεπιλεγμένα, διαχειριζόμενα σύνολα κανόνων που διατηρούνται από το AWS και από πωλητές της AWS Marketplace. Αυτά τα σύνολα κανόνων παρέχουν προστασία ενάντια σε κοινές απειλές και ενημερώνονται τακτικά για να αντιμετωπίσουν νέες ευπάθειες.

### Σύνολο IP

Ένα Σύνολο IP είναι μια λίστα διευθύνσεων IP ή εύρους διευθύνσεων IP που θέλετε να επιτρέψετε ή να αποκλείσετε. Τα σύνολα IP απλοποιούν τη διαδικασία διαχείρισης κανόνων βασισμένων σε IP.

### Σύνολο Προτύπων Regex

Ένα Σύνολο Προτύπων Regex περιέχει ένα ή περισσότερα κανονικά εκφράσεων (regex) που ορίζουν πρότυπα για αναζήτηση σε αιτήσεις web. Αυτό είναι χρήσιμο για πιο πολύπλοκα σενάρια αντιστοίχισης, όπως η φιλτράριση συγκεκριμένων ακολουθιών χαρακτήρων.

### Διακλείδωμα Κωδικού

Ένα Διακλείδωμα Κωδικού χρησιμοποιείται για τον έλεγχο ταυτόχρονης ενημέρωσης κατά την τροποποίηση των πόρων του WAF. Βεβαιώνει ότι οι αλλαγές δεν αντικαθίστανται κατά λάθος από πολλούς χρήστες ή διαδικασίες που προσπαθούν να ενημερώσουν τον ίδιο πόρο ταυτόχρονα.

### Κλειδιά API

Τα Κλειδιά API στο AWS WAF χρησιμοποιούνται για την πιστοποίηση αιτήσεων σε συγκεκριμένες λειτουργίες του API. Αυτά τα κλειδιά είναι κρυπτογραφημένα και διαχειρίζονται με ασφάλεια για να ελέγχουν την πρόσβαση και να διασφαλίσουν ότι μόνο εξουσιοδοτημένοι χρήστες μπορούν να κάνουν αλλαγές στις ρυθμίσεις του WAF.

- **Παράδειγμα**: Ενσωμάτωση του API CAPTCHA.

### Πολιτική Άδειας

Μια Πολιτική Άδειας είναι μια πολιτική IAM που καθορίζει ποιος μπορεί να εκτελέσει ενέργειες στους πόρους του AWS WAF. Με τον καθορισμό δικαιωμάτων, μπορείτε να ελέγξετε την πρόσβαση στους πόρους του WAF και να διασφαλίσετε ότι μόνο εξουσιοδοτημένοι χρήστες μπορούν να δημιουργήσουν, να ενημερώσουν ή να διαγράψουν ρυθμίσεις.

### Εύρος

Η παράμετρος εύρος στο AWS WAF καθορίζει εάν οι κανόνες και οι ρυθμίσεις WAF ισχύουν για μια περιφερειακή εφαρμογή ή για μια διανομή Amazon CloudFront.

- **ΠΕΡΙΦΕΡΕΙΑΚΟ**: Ισχύει για περιφερειακές υπηρεσίες όπως Ισορροπητές Φορτίου Εφαρμογών (ALB), Πύλη Αναπαράστασης REST API της Amazon, Υπηρεσία GraphQL AWS AppSync, Πισίνα Χρηστών Amazon C
```bash
# Web ACLs #

## Retrieve a list of web access control lists (Web ACLs) available in your AWS account
aws wafv2 list-web-acls --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve details about the specified Web ACL
aws wafv2 get-web-acl --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

## Retrieve a list of resources associated with a specific web access control list (Web ACL)
aws wafv2 list-resources-for-web-acl --web-acl-arn <value> # Additional permissions needed depending on the protected resource type: cognito-idp:ListResourcesForWebACL, ec2:DescribeVerifiedAccessInstanceWebAclAssociations or apprunner:ListAssociatedServicesForWebAcl
## Retrieve the Web ACL associated with the specified AWS resource
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Additional permissions needed depending on the protected resource type: cognito-idp:GetWebACLForResource, ec2:GetVerifiedAccessInstanceWebAcl, wafv2:GetWebACL or apprunner:DescribeWebAclForService

# Rule groups #

## List of the rule groups available in your AWS account
aws wafv2 list-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the details of a specific rule group
aws wafv2 get-rule-group [--name <value>] [--id <value>] [--arn <value>] [--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>]
## Retrieve the IAM policy attached to the specified rule group
aws wafv2 get-permission-policy --resource-arn <rule-group-arn> # Just the owner of the Rule Group can do this operation

# Managed rule groups (by AWS or by a third-party) #

## List the managed rule groups that are available
aws wafv2 list-available-managed-rule-groups --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## List the available versions of the specified managed rule group
aws wafv2 list-available-managed-rule-group-versions --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about a specific managed rule group
aws wafv2 describe-managed-rule-group --vendor-name <value> --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--version-name <value>]
## Retrieve high-level information about all managed rule groups
aws wafv2 describe-all-managed-products --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve high-level information about all managed rule groups from a specific vendor
aws wafv2 describe-managed-products-by-vendor --vendor-name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# IP sets #

## List the IP sets that are available in your AWS account
aws wafv2 list-ip-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the specific IP set
aws wafv2 get-ip-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve the keys that are currently being managed by a rate-based rule.
aws wafv2 get-rate-based-statement-managed-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>\
--web-acl-name <value> --web-acl-id <value> --rule-name <value> [--rule-group-rule-name <value>]

# Regex pattern sets #

## List all the regex pattern sets that you manage
aws wafv2 list-regex-pattern-sets --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieves the specified regex pattern sets
aws wafv2 get-regex-pattern-set --name <value> --id <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>

# API Keys #

## List API keys for the specified scope
aws wafv2 list-api-keys --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
## Retrieve decrypted API key
aws wafv2 get-decrypted-api-key --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --api-key <value>

# Logs #

## List of logging configurations (storage location of the logs)
aws wafv2 list-logging-configurations --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--log-scope <value>]
## Retrieve the logging configuration settings associated with a specific web ACL
aws wafv2 get-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]

# Miscelaneous #

## Retrieve a list of the tags associated to the specified resource
aws wafv2 list-tags-for-resource resource-arn <value>

## Retrieve a sample of web requests that match a specified rule within a WebACL during a specified time range
aws wafv2 get-sampled-requests --web-acl-arn <value> --rule-metric-name <value> --time-window <value> --max-items <1-500> --scope <value>

## Obtains the web ACL capacity unit (WCU) requirements for a specified scope and ruleset
aws wafv2 check-capacity --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --rules <value>

## List of available releases for the AWS WAFv2 mobile SDK
aws wafv2 list-mobile-sdk-releases --platform <IOS | ANDROID>
## Retrieves information for the specified mobile SDK release
aws wafv2 get-mobile-sdk-release --platform <value> --release-version <value>

```
## Post Exploitation / Bypass

{% hint style="success" %}
Από την οπτική γωνία ενός εισβολέα, αυτή η υπηρεσία μπορεί να βοηθήσει τον εισβολέα να αναγνωρίσει τις προστασίες WAF και τις εκθέσεις δικτύου που θα μπορούσαν να τον βοηθήσουν να διακινδυνεύσει άλλες ιστοσελίδες.

Ωστόσο, ένας εισβολέας θα μπορούσε επίσης να ενδιαφερθεί να διαταράξει αυτήν την υπηρεσία έτσι ώστε οι ιστοσελίδες να μην προστατεύονται από το WAF.
{% endhint %}

Σε πολλές από τις λειτουργίες Διαγραφής και Ενημέρωσης θα ήταν απαραίτητο να παρέχετε το **κλειδί κλειδώματος**. Αυτό το κλειδί χρησιμοποιείται για τον έλεγχο ταυτόχρονης εκτέλεσης πάνω στους πόρους, εξασφαλίζοντας ότι οι αλλαγές δεν θα αντικατασταθούν κατά λάθος από πολλούς χρήστες ή διεργασίες που προσπαθούν να ενημερώσουν τον ίδιο πόρο ταυτόχρονα. Για να λάβετε αυτό το κλειδί, μπορείτε να εκτελέσετε τις αντίστοιχες λειτουργίες **list** ή **get** πάνω στον συγκεκριμένο πόρο.

### **`wafv2:CreateRuleGroup`, `wafv2:UpdateRuleGroup`, `wafv2:DeleteRuleGroup`**

Ένας εισβολέας θα μπορούσε να διακινδυνεύσει την ασφάλεια του επηρεαζόμενου πόρου με τους εξής τρόπους:

- Δημιουργώντας ομάδες κανόνων που θα μπορούσαν, για παράδειγμα, να μπλοκάρουν νόμιμη κίνηση από νόμιμες διευθύνσεις IP, προκαλώντας έναν αρνητικό απολογισμό υπηρεσιών.
- Ενημερώνοντας ομάδες κανόνων, έχοντας τη δυνατότητα να τροποποιήσει τις ενέργειές του για παράδειγμα από **Αποκλεισμός** σε **Επιτρέπεται**.
- Διαγράφοντας ομάδες κανόνων που παρέχουν κρίσιμα μέτρα ασφαλείας.
```bash
# Create Rule Group
aws wafv2 create-rule-group --name <value> --capacity <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Update Rule Group
aws wafv2 update-rule-group --name <value> --id <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--description <value>]
# Delete Rule Group
aws wafv2 delete-rule-group --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Τα παρακάτω παραδείγματα δείχνουν έναν κανόνα ομάδας που θα μπλοκάρει νόμιμη κίνηση από συγκεκριμένες διευθύνσεις IP:
```bash
aws wafv2 create-rule-group --name BlockLegitimateIPsRuleGroup --capacity 1 --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=BlockLegitimateIPsRuleGroup --scope CLOUDFRONT --region us-east-1 --rules file://rule.json
```
Το αρχείο **rule.json** θα μοιάζει με:
```json
[
{
"Name":"BlockLegitimateIPsRule",
"Priority":0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:global/ipset/legitIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action":{
"Block":{}
},
"VisibilityConfig":{
"SampledRequestsEnabled":false,
"CloudWatchMetricsEnabled":false,
"MetricName":"BlockLegitimateIPsRule"
}
}
]
```
**Πιθανή Επίπτωση**: Μη εξουσιοδοτημένη πρόσβαση, διαρροές δεδομένων και πιθανές επιθέσεις DoS.

### **`wafv2:CreateWebACL`, `wafv2:UpdateWebACL`, `wafv2:DeleteWebACL`**

Με αυτές τις άδειες, ένας επιτιθέμενος θα μπορούσε να:

- Δημιουργήσει ένα νέο Web ACL, εισάγοντας κανόνες που είτε επιτρέπουν τη διείσδυση κακόβουλης κίνησης είτε αποκλείουν την νόμιμη κίνηση, καθιστώντας το WAF αναποτελεσματικό ή προκαλώντας έναν αρνητικό έλεγχο υπηρεσιών.
- Ενημερώσει υπάρχοντα Web ACLs, μπορώντας να τροποποιήσει κανόνες για να επιτρέψει επιθέσεις όπως εισαγωγή SQL ή cross-site scripting, οι οποίες προηγουμένως είχαν αποκλειστεί, ή να διαταράξει τη ροή της κανονικής κίνησης μπλοκάροντας έγκυρα αιτήματα.
- Διαγράψει ένα Web ACL, αφήνοντας τους επηρεαζόμενους πόρους εντελώς απροστατευμένους, εκθέτοντάς τους σε μια ευρεία γκάμα επιθέσεων στο web.

{% hint style="info" %}

Μπορείτε να διαγράψετε το συγκεκριμένο **WebACL** μόνο αν το **ManagedByFirewallManager** είναι false.

{% endhint %}
```bash
# Create Web ACL
aws wafv2 create-web-acl --name <value> --default-action <value> --visibility-config <value> \
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Update Web ACL
aws wafv2 update-web-acl --name <value> --id <value> --default-action <value> --visibility-config <value> --lock-token <value>\
--scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--rules <value>] [--captcha-config <value>] [--description <value>]
# Delete Web ACL
aws wafv2 delete-web-acl --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
**Αρχικό Web ACL**:
```json
{
"WebACL": {
"Name": "AllowLegitimateIPsWebACL",
"Id": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/webacl/AllowLegitimateIPsWebACL/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"DefaultAction": {
"Allow": {}
},
"Description": "",
"Rules": [
{
"Name": "AllowLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Allow": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsRule"
}
}
],
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "AllowLegitimateIPsWebACL"
},
"Capacity": 1,
"ManagedByFirewallManager": false,
"LabelNamespace": "awswaf:123456789012:webacl:AllowLegitimateIPsWebACL:"
},
"LockToken": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}

```
Εντολή για ενημέρωση του Web ACL:
```json
aws wafv2 update-web-acl --name AllowLegitimateIPsWebACL --scope REGIONAL --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --default-action Block={} --visibility-config SampledRequestsEnabled=false,CloudWatchMetricsEnabled=false,MetricName=AllowLegitimateIPsWebACL --rules file://rule.json --region us-east-1
```
Το αρχείο **rule.json** θα φαίνεται όπως:
```json
[
{
"Name": "BlockLegitimateIPsRule",
"Priority": 0,
"Statement": {
"IPSetReferenceStatement": {
"ARN": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/LegitimateIPv4/1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
},
"Action": {
"Block": {}
},
"VisibilityConfig": {
"SampledRequestsEnabled": false,
"CloudWatchMetricsEnabled": false,
"MetricName": "BlockLegitimateIPRule"
}
}
]
```
**Πιθανή Επίπτωση**: Μη εξουσιοδοτημένη πρόσβαση, διαρροές δεδομένων και πιθανές επιθέσεις DoS.

### **`wafv2:AssociateWebACL`, `wafv2:DisassociateWebACL`**

Η άδεια **`wafv2:AssociateWebACL`** θα επιτρέπει σε έναν εισβολέα να συσχετίσει τα web ACLs (Λίστες Ελέγχου Πρόσβασης) με πόρους, μπορώντας να παρακάμψει τους ελέγχους ασφαλείας, επιτρέποντας σε μη εξουσιοδοτημένη κίνηση να φτάσει στην εφαρμογή, με πιθανή εκμετάλλευση όπως ενσωμάτωση SQL ή cross-site scripting (XSS). Αντίστοιχα, με την άδεια **`wafv2:DisassociateWebACL`**, ο εισβολέας θα μπορούσε να απενεργοποιήσει προσωρινά τις προστασίες ασφαλείας, εκθέτοντας τους πόρους σε ευπαθείς σημεία χωρίς ανίχνευση.

Οι επιπλέον άδειες θα χρειαζόταν ανάλογα με τον τύπο του προστατευόμενου πόρου:

- **Συσχέτιση**
- apigateway:SetWebACL
- apprunner:AssociateWebAcl
- appsync:SetWebACL
- cognito-idp:AssociateWebACL
- ec2:AssociateVerifiedAccessInstanceWebAcl
- elasticloadbalancing:SetWebAcl
- **Αποσυσχέτιση**
- apigateway:SetWebACL
- apprunner:DisassociateWebAcl
- appsync:SetWebACL
- cognito-idp:DisassociateWebACL
- ec2:DisassociateVerifiedAccessInstanceWebAcl
- elasticloadbalancing:SetWebAcl
```bash
# Associate
aws wafv2 associate-web-acl --web-acl-arn <value> --resource-arn <value>
# Disassociate
aws wafv2 disassociate-web-acl --resource-arn <value>
```
**Πιθανή Επίπτωση**: Παραβίαση της ασφάλειας των πόρων, αύξηση του κινδύνου εκμετάλλευσης και πιθανές διακοπές υπηρεσιών εντός των περιβαλλόντων AWS που προστατεύονται από το AWS WAF.

### **`wafv2:CreateIPSet` , `wafv2:UpdateIPSet`, `wafv2:DeleteIPSet`**

Ένας επιτιθέμενος θα μπορούσε να δημιουργήσει, να ενημερώσει και να διαγράψει τα σύνολα IP που διαχειρίζεται το AWS WAF. Αυτό θα μπορούσε να είναι επικίνδυνο αφού θα μπορούσε να δημιουργήσει νέα σύνολα IP για να επιτρέψει κακόβουλη κίνηση, να τροποποιήσει τα σύνολα IP προκειμένου να αποκλείσει νόμιμη κίνηση, να ενημερώσει υπάρχοντα σύνολα IP για να περιλαμβάνουν κακόβουλες διευθύνσεις IP, να αφαιρέσει αξιόπιστες διευθύνσεις IP ή να διαγράψει κρίσιμα σύνολα IP που προορίζονται να προστατεύουν κρίσιμους πόρους.
```bash
# Create IP set
aws wafv2 create-ip-set --name <value> --ip-address-version <IPV4 | IPV6> --addresses <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Update IP set
aws wafv2 update-ip-set --name <value> --id <value> --addresses <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete IP set
aws wafv2 delete-ip-set --name <value> --id <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
Το παρακάτω παράδειγμα δείχνει πώς να **αντικαταστήσετε το υπάρχον σύνολο IP με το επιθυμητό σύνολο IP**:
```bash
aws wafv2 update-ip-set --name LegitimateIPv4Set --id 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --addresses 99.99.99.99/32 --lock-token 1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f --scope CLOUDFRONT --region us-east-1
```
**Πιθανή Επίπτωση**: Μη εξουσιοδοτημένη πρόσβαση και αποκλεισμός νόμιμης κίνησης.

### **`wafv2:CreateRegexPatternSet`**, **`wafv2:UpdateRegexPatternSet`**, **`wafv2:DeleteRegexPatternSet`**

Ένας επιτιθέμενος με αυτές τις άδειες θα μπορούσε να χειριστεί τα σύνολα προτύπων κανονικών εκφράσεων που χρησιμοποιεί το AWS WAF για τον έλεγχο και το φιλτράρισμα της εισερχόμενης κίνησης με βάση συγκεκριμένα πρότυπα.

- Η δημιουργία νέων προτύπων regex θα βοηθούσε έναν επιτιθέμενο να επιτρέψει επιβλαβές περιεχόμενο
- Με την ενημέρωση των υπαρχόντων προτύπων, ένας επιτιθέμενος θα μπορούσε να παρακάμψει τους κανόνες ασφαλείας
- Η διαγραφή προτύπων που σχεδιάστηκαν για τον αποκλεισμό κακόβουλων δραστηριοτήτων θα μπορούσε να οδηγήσει έναν επιτιθέμενο στην αποστολή κακόβουλων φορτίων και στην παράκαμψη των μέτρων ασφαλείας.
```bash
# Create regex pattern set
aws wafv2 create-regex-pattern-set --name <value> --regular-expression-list <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> [--description <value>]
# Update regex pattern set
aws wafv2 update-regex-pattern-set --name <value> --id <value> --regular-expression-list <value> --lock-token <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
# Delete regex pattern set
aws wafv2 delete-regex-pattern-set --name <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1> --id <value> --lock-token <value>
```
**Πιθανή Επίπτωση**: Παράκαμψη ελέγχων ασφαλείας, επιτρέποντας το κακόβουλο περιεχόμενο και ενδεχομένως την αποκάλυψη ευαίσθητων δεδομένων ή τη διατάραξη υπηρεσιών και πόρων που προστατεύονται από το AWS WAF.

### **(`wavf2:PutLoggingConfiguration` &** `iam:CreateServiceLinkedRole`), **`wafv2:DeleteLoggingConfiguration`**

Ένας επιτιθέμενος με το **`wafv2:DeleteLoggingConfiguration`** θα μπορούσε να αφαιρέσει τη διαμόρφωση καταγραφής από το συγκεκριμένο Web ACL. Στη συνέχεια, με τις άδειες **`wavf2:PutLoggingConfiguration`** και **`iam:CreateServiceLinkedRole`**, ένας επιτιθέμενος θα μπορούσε να δημιουργήσει ή να αντικαταστήσει διαμορφώσεις καταγραφής (μετά τη διαγραφή τους) για να εμποδίσει εντελώς την καταγραφή ή να ανακατευθύνει τα logs σε μη εξουσιοδοτημένους προορισμούς, όπως Amazon S3 buckets, Amazon CloudWatch Logs log group ή ένα Amazon Kinesis Data Firehose υπό έλεγχο.

Κατά τη διάρκεια της διαδικασίας δημιουργίας, η υπηρεσία ρυθμίζει αυτόματα τις απαραίτητες άδειες για να επιτρέψει την εγγραφή logs στον καθορισμένο προορισμό καταγραφής:

- **Amazon CloudWatch Logs:** Το AWS WAF δημιουργεί μια πολιτική πόρων στην καθορισμένη ομάδα καταγραφής CloudWatch Logs. Αυτή η πολιτική εξασφαλίζει ότι το AWS WAF έχει τις απαραίτητες άδειες για να εγγράφει logs στην ομάδα καταγραφής.
- **Amazon S3 Bucket:** Το AWS WAF δημιουργεί μια πολιτική κάδου στον καθορισμένο κάδο S3. Αυτή η πολιτική χορηγεί στο AWS WAF τις απαραίτητες άδειες για τη μεταφόρτωση logs στον καθορισμένο κάδο.
- **Amazon Kinesis Data Firehose:** Το AWS WAF δημιουργεί ένα ρόλο συνδεδεμένης υπηρεσίας ειδικά για την αλληλεπίδραση με το Kinesis Data Firehose. Αυτός ο ρόλος επιτρέπει στο AWS WAF να παραδίδει logs στη διαμορφωμένη ροή Firehose.

{% hint style="info" %}

Είναι δυνατόν να οριστεί μόνο ένας προορισμός καταγραφής ανά web ACL.

{% endhint %}
```bash
# Put logging configuration
aws wafv2 put-logging-configuration --logging-configuration <value>
# Delete logging configuration
aws wafv2 delete-logging-configuration --resource-arn <value> [--log-scope <CUSTOMER | SECURITY_LAKE>] [--log-type <value>]
```
**Πιθανή Επίδραση:** Αμαυρώνει την ορατότητα στα συμβάντα ασφάλειας, δυσκολεύει τη διαδικασία ανταπόκρισης σε περιστατικά και διευκολύνει τις κρυφές κακόβουλες δραστηριότητες εντός των περιβαλλόντων που προστατεύονται από το AWS WAF.

### **`wafv2:DeleteAPIKey`**

Ένας επιτιθέμενος με αυτές τις άδειες θα μπορούσε να διαγράψει υπάρχοντα κλειδιά API, καθιστώντας το CAPTCHA ανενεργό και διαταράσσοντας τη λειτουργικότητα που εξαρτάται από αυτό, όπως οι υποβολές φόρμας και οι ελέγχοι πρόσβασης. Ανάλογα με την υλοποίηση αυτού του CAPTCHA, αυτό θα μπορούσε να οδηγήσει είτε σε παράκαμψη του CAPTCHA είτε σε DoS εάν η διαχείριση σφαλμάτων δεν έχει οριστεί σωστά στον πόρο.
```bash
# Delete API key
aws wafv2 delete-api-key --api-key <value> --scope <REGIONAL --region=<value> | CLOUDFRONT --region=us-east-1>
```
**Πιθανή Επίδραση**: Απενεργοποίηση προστασίας CAPTCHA ή διαταραχή λειτουργικότητας εφαρμογής, οδηγώντας σε παραβιάσεις ασφάλειας και πιθανή κλοπή δεδομένων.

### **`wafv2:TagResource`, `wafv2:UntagResource`**

Ένας επιτιθέμενος θα μπορούσε να προσθέσει, να τροποποιήσει ή να αφαιρέσει ετικέτες από πόρους AWS WAFv2, όπως Web ACLs, ομάδες κανόνων, σύνολα IP, σύνολα μοτίβων regex και ρυθμίσεις καταγραφής.
```bash
# Tag
aws wafv2 tag-resource --resource-arn <value> --tags <value>
# Untag
aws wafv2 untag-resource --resource-arn <value> --tag-keys <value>
```
**Πιθανή Επίπτωση**: Διατάραξη πόρων, διαρροή πληροφοριών, χειρισμός κόστους και λειτουργική διακοπή.

# Αναφορές
* [https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application](https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awswafv2.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awswafv2.html)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Συμμετέχετε** 💬 στην [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Κοινοποιήστε κόλπα χάκινγκ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
{% endhint %}
