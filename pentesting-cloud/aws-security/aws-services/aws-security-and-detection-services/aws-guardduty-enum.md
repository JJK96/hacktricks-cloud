# AWS - GuardDuty Enum

{% hint style="success" %}
AWSハッキングの学習と実践:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と実践: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、ハッキングトリックを共有してください。

</details>
{% endhint %}

## GuardDuty

[**ドキュメント**](https://aws.amazon.com/guardduty/features/)によると、GuardDutyは**機械学習、異常検知、ネットワーク監視、および悪意のあるファイルの発見**を組み合わせ、AWSおよび業界をリードするサードパーティソースを使用して、AWS上のワークロードとデータを保護するのに役立ちます。 GuardDutyは、AWS CloudTrailイベントログ、Amazon Virtual Private Cloud（VPC）Flow Logs、Amazon Elastic Kubernetes Service（EKS）監査およびシステムレベルログ、およびDNSクエリログなど、複数のAWSデータソース全体で数十億のイベントを分析できます。

Amazon GuardDutyは、アカウント内での**異常なアクティビティを特定**し、そのアクティビティの**セキュリティの関連性**を分析し、それが呼び出された**コンテキスト**を提供します。これにより、対応者はさらなる調査に時間を費やす必要があるかどうかを判断できます。

アラートは**GuardDutyコンソール（90日間）**とCloudWatch Eventsに表示されます。

{% hint style="warning" %}
ユーザーが**GuardDutyを無効にする**と、AWS環境の監視が停止され、新しい調査結果は生成されず、**既存の調査結果が失われます**。\
単に停止すると、既存の調査結果は残ります。
{% endhint %}

### 調査結果の例

* **偵察**: 攻撃者による偵察を示唆するアクティビティ、例えば**異常なAPIアクティビティ**、疑わしいデータベースの**ログイン**試行、VPC内部の**ポートスキャン**、異常な失敗したログインリクエストパターン、または既知の悪意のあるIPからのポートプロービングのブロック解除など。
* **インスタンスの侵害**: インスタンスの侵害を示すアクティビティ、例えば**暗号通貨の採掘、バックドアのコマンド制御（C\&C）**アクティビティ、ドメイン生成アルゴリズム（DGA）を使用したマルウェア、外部からのサービス拒否アクティビティ、異常に**高いネットワーク**トラフィック量、異常なネットワークプロトコル、既知の悪意のあるIPとのアウトバウンドインスタンス通信、外部IPアドレスが使用する一時的なAmazon EC2資格情報、およびDNSを使用したデータの外部への持ち出し。
* **アカウントの侵害**: アカウントの侵害を示す一般的なパターンには、異常な地理的位置情報や匿名化プロキシからのAPI呼び出し、AWS CloudTrailロギングの無効化を試みる、アカウントパスワードポリシーを弱体化する変更、異常なインスタンスまたはインフラストラクチャの起動、異常な地域でのインフラストラクチャ展開、資格情報の盗難、疑わしいデータベースログインアクティビティ、既知の悪意のあるIPアドレスからのAPI呼び出しなどが含まれます。
* **バケットの侵害**: バケットの侵害を示すアクティビティ、例えば資格情報の誤用を示す疑わしいデータアクセスパターン、リモートホストからの異常なAmazon S3 APIアクティビティ、既知の悪意のあるIPアドレスからの不正なS3アクセス、およびバケットにアクセスしたことのないユーザーからのS3バケット内のデータを取得するAPI呼び出しや異常な場所から呼び出されたAPI呼び出しなど。 Amazon GuardDutyは、すべてのAmazon S3バケットで疑わしいアクティビティを検出するためにAWS CloudTrail S3データイベント（例：GetObject、ListObjects、DeleteObject）を継続的に監視および分析します。

<details>

<summary>調査結果情報</summary>

調査結果の要約:

* 調査結果のタイプ
* 重要度: 7-8.9 高、4-6.9 中、01-3.9 低
* リージョン
* アカウントID
* リソースID
* 検出時刻
* 使用された脅威リスト

本文には次の情報が含まれています:

* 影響を受けるリソース
* アクション
* アクター: IPアドレス、ポート、ドメイン
* 追加情報

</details>

### すべての調査結果

GuardDutyのすべての調査結果のリストにアクセス: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### 複数アカウント

#### 招待による

他のアカウントを異なるAWS GuardDutyアカウントに**招待**して、**すべてのアカウントが同じGuardDutyから監視**されるようにすることができます。マスターアカウントはメンバーアカウントを招待し、その後、メンバーアカウントの代表者が招待を受け入れる必要があります。

#### 組織を通じて

組織内の任意のアカウントを**GuardDuty委任管理者**に指定できます。組織管理アカウントのみが委任管理者を指定できます。

委任管理者として指定されたアカウントは、GuardDuty管理者アカウントとなり、指定されたAWSリージョンでGuardDutyが自動的に有効になり、そのリージョン内のすべてのアカウントのGuardDutyを有効にしたり管理したりする権限を持ちます。組織内の他のアカウントは、この委任管理者アカウントに関連付けられたGuardDutyメンバーアカウントとして表示および追加できます。

## 列挙

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDuty バイパス

### 一般的なガイダンス

使用する資格情報の挙動について可能な限り多くの情報を収集しよう：

* 使用されるタイミング
* 場所
* ユーザーエージェント / サービス（awscli、webconsole、lambdaなどから使用される可能性があります）
* 定期的に使用される権限

この情報を元に、アクセスを利用するために可能な限り同じシナリオを再現しよう：

* **ユーザーまたはユーザーによってアクセスされるロール**の場合、同じ時間帯に、同じ地理的位置（可能であれば同じISPおよびIP）から使用しよう
* **サービスによって使用されるロール**の場合、同じリージョンで同じサービスを作成し、同じ時間帯にそこから使用しよう
* 常にこの主体が使用した**同じ権限**を使用しよう
* **他の権限を使用する必要がある場合や権限を濫用する必要がある場合**（たとえば、100万個のcloudtrailログファイルをダウンロードする場合）は、AWSとの**最小限のやり取り**で**ゆっくり**行うようにしよう（awscliは書き込みAPIの前に複数の読み取りAPIを呼び出すことがある）

### GuardDuty の回避

#### `guardduty:UpdateDetector`

この権限を使用すると、アラートをトリガーさせるのを避けるためにGuardDutyを無効にすることができます。
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
#### `guardduty:CreateFilter`

この権限を持つ攻撃者は、**調査結果の自動アーカイブ用のフィルターを作成**する能力を持ちます：
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

前述の権限を持つ攻撃者は、自分のIPアドレスを追加してGuardDutyの[**信頼されたIPリスト**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)を変更し、アラートを生成しないようにすることができます。
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
{% endcode %}

#### `guardduty:DeletePublishingDestination`

攻撃者は、アラートを防ぐために宛先を削除する可能性があります：

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
この公開先を削除しても、GuardDutyコンソール内の調査結果の生成や表示には影響しません。GuardDutyは引き続きAWS環境でイベントを分析し、疑わしいまたは予期しない動作を特定し、調査結果を生成します。
{% endhint %}

### 特定の調査結果の回避例

GuardDutyには数十の調査結果がありますが、**Red Teamerとしてはすべてが影響を受けるわけではありません**。さらに、それぞれの詳細なドキュメントがありますので、[https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html) を参照して、何らかのアクションを実行する前に確認してください。

以下に、特定のGuardDuty調査結果の回避例をいくつか示します:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDutyは一般的なペネトレーションテストツールからのAWS APIリクエストを検出し、[PenTest Finding](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) をトリガーします。\
APIリクエストで渡される**ユーザーエージェント名**によって検出されます。\
したがって、攻撃を検出されないようにするには、**ユーザーエージェントを変更**することが可能です。

これを防ぐためには、`botocore`パッケージ内の`session.py`スクリプトを検索してユーザーエージェントを変更するか、Burp SuiteをAWS CLIプロキシとして設定してユーザーエージェントをMitMで変更するか、Ubuntu、Mac、WindowsなどのOSを使用してこのアラートがトリガーされないようにすることができます。

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

メタデータサービスからEC2資格情報を抽出し、AWS環境外でそれらを利用すると、[**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws) アラートが発生します。逆に、EC2インスタンスからこれらの資格情報を利用すると、[**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws) アラートがトリガーされます。しかし、**同じアカウント内の別の侵害されたEC2インスタンスで資格情報を使用すると検出されず、アラートが発生しません**。

{% hint style="success" %}
したがって、見つけたマシン内から**抽出された資格情報を使用して**このアラートをトリガーしないようにしてください。
{% endhint %}

## 参考文献

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

{% hint style="success" %}
AWSハッキングの学習と実践:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と実践: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f) に参加するか、[**telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** をフォローする。**
* ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリにPRを提出する。

</details>
{% endhint %}
