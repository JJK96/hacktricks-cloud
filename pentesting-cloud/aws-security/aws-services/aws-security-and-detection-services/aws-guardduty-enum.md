# AWS - Απαρίθμηση GuardDuty

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Συμμετέχετε** 💬 στην [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Κοινοποιήστε κόλπα χάκερ υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## GuardDuty

Σύμφωνα με τα [**έγγραφα**](https://aws.amazon.com/guardduty/features/): Το GuardDuty συνδυάζει **μηχανική μάθηση, ανίχνευση ανωμαλιών, παρακολούθηση δικτύου και ανακάλυψη κακόβουλων αρχείων**, χρησιμοποιώντας τόσο πηγές AWS όσο και κορυφαίους τρίτους φορείς για να βοηθήσει στην προστασία φορτίων εργασίας και δεδομένων στο AWS. Το GuardDuty είναι ικανό να αναλύει δισεκατομμύρια συμβάντα από πολλές πηγές δεδομένων AWS, όπως τα αρχεία καταγραφής συμβάντων AWS CloudTrail, τα αρχεία καταγραφής ροής Amazon Virtual Private Cloud (VPC), τα αρχεία ελέγχου ελαστικών υπηρεσιών Kubernetes (EKS) της Amazon και τα αρχεία καταγραφής συστηματικού επιπέδου και ερωτήσεων DNS.

Το Amazon GuardDuty **αναγνωρίζει ασυνήθιστη δραστηριότητα εντός των λογαριασμών σας**, αναλύει τη **σχετικότητα ασφάλειας** της δραστηριότητας και δίνει το **πλαίσιο** στο οποίο ενεργοποιήθηκε. Αυτό επιτρέπει σε έναν ανταποκριτή να καθορίσει εάν πρέπει να αφιερώσει χρόνο σε περαιτέρω έρευνα.

Οι ειδοποιήσεις **εμφανίζονται στην κονσόλα GuardDuty (90 ημέρες)** και στα CloudWatch Events.

{% hint style="warning" %}
Όταν ένας χρήστης **απενεργοποιεί το GuardDuty**, σταματά να παρακολουθεί το περιβάλλον AWS σας και δεν θα δημιουργήσει καθόλου νέες ευρήματα, και τα **υπάρχοντα ευρήματα θα χαθούν**.\
Αν απλώς το σταματήσετε, τα υπάρχοντα ευρήματα θα παραμείνουν.
{% endhint %}

### Παράδειγμα Ευρημάτων

* **Αναγνώριση**: Δραστηριότητα που υποδηλώνει αναγνώριση από έναν εισβολέα, όπως **ασυνήθιστη δραστηριότητα API**, ύποπτες προσπάθειες σύνδεσης σε βάση δεδομένων, εσωτερικός σάρωση θυρών VPC, ασυνήθιστα μοτίβα αποτυχημένων αιτημάτων σύνδεσης ή αποτυπώσεις θύρας από γνωστή κακή IP.
* **Κατάκτηση παραδείσου**: Δραστηριότητα που υποδηλώνει κατάκτηση παραδείσου, όπως **εξόρυξη κρυπτονομισμάτων, εντολές ελέγχου πίσω πόρτας (C\&C)**, κακόβουλο λογισμικό που χρησιμοποιεί αλγόριθμους γεννήτριας τομέων (DGA), εξερχόμενη δραστηριότητα αρνητικής υπηρεσίας, ασυνήθιστος όγκος κυκλοφορίας δικτύου, ασυνήθιστα πρωτόκολλα δικτύου, εξερχόμενη επικοινωνία πόρτας με μια γνωστή κακόβουλη IP, προσωρινές διαπιστεύσεις Amazon EC2 που χρησιμοποιούνται από μια εξωτερική διεύθυνση IP και εξυπορεύεται δεδομένων χρησιμοποιώντας το DNS.
* **Κατάκτηση λογαριασμού**: Συνήθεις μοτίβα που υποδηλώνουν κατάκτηση λογαριασμού περιλαμβάνουν κλήσεις API από μια ασυνήθιστη γεωγραφική τοποθεσία ή ανώνυμο προξενητικό, προσπάθειες απενεργοποίησης καταγραφής AWS CloudTrail, αλλαγές που αποδυναμώνουν την πολιτική κωδικού πρόσβασης του λογαριασμού, ασυνήθιστες εκκινήσεις περιπτώσεων ή υποδομών, αναπτύξεις υποδομών σε μια ασυνήθιστη περιοχή, κλοπή διαπιστεύσεων, ύποπτη δραστηριότητα σύνδεσης σε βάση δεδομένων και κλήσεις API από γνωστές κακόβουλες διευθύνσεις IP.
* **Κατάκτηση κάδου**: Δραστηριότητα που υποδηλώνει κατάκτηση κάδου, όπως ύποπτα μοτίβα πρόσβασης δεδομένων που υποδηλώνουν κατάχρηση διαπιστεύσεων, ασυνήθιστη δραστηριότητα API Amazon S3 από απομακρυσμένο υπολογιστή, μη εξουσιοδοτημένη πρόσβαση S3 από γνωστές κακόβουλες διευθύνσεις IP και κλήσεις API για ανάκτηση δεδομένων σε κάδους S3 από έναν χρήστη χωρίς προηγούμενο ιστορικό πρόσβασης στον κάδο ή ενεργοποιημένο από μια ασυνήθιστη τοποθεσία. Το Amazon GuardDuty παρακολουθεί συνεχώς και αναλύει τα συμβάντα δεδομένων S3 AWS CloudTrail (π.χ. GetObject, ListObjects, DeleteObject) για να ανιχνεύσει ύποπτη δραστηριότητα σε όλους τους κάδους S3 σας.

<details>

<summary>Πληροφορίες Ευρήματος</summary>

Σύνοψη ευρήματος:

* Τύπος ευρήματος
* Σοβαρότητα: 7-8.9 Υψηλή, 4-6.9 Μέτρια, 01-3.9 Χαμηλή
* Περιοχή
* Αναγνωριστικό λογαριασμού
* Αναγνωριστικό πόρου
* Ώρα ανίχνευσης
* Ποια λίστα απειλών χρησιμοποιήθηκε

Το σώμα έχει αυτές τις πληροφορίες:

* Επηρεασμένος πόρος
* Δράση
* Ενεργός: Διεύθυνση IP, θύρα και τομέας
* Επιπλέον Πληροφορίες

</details>

### Όλα τα Ευρήματα

Αποκτήστε πρόσβαση σε μια λίστα με όλα τα ευρήματα του GuardDuty στο: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Πολλαπλοί Λογαριασμοί

#### Με Πρόσκληση

Μπορείτε να **προσκαλέσετε άλλους λογαριασμούς** σε ένα διαφορετικό λογαριασμό AWS GuardDuty ώστε **κάθε λογαριασμός να παρακολουθείται από τον ίδιο GuardDuty**. Ο κύριος λογαριασμός πρέπει να προσκαλέσει τους λογαριασμούς μέλη και στη συνέχεια ο εκπρόσωπος του λογαριασμού μέλους πρέπει να αποδεχτεί την πρόσκληση.

#### Μέσω Οργάνωσης

Μπορείτε να ορίσετε οποιονδήποτε λογαριασμό εντ
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## Παράκαμψη του GuardDuty

### Γενικές Οδηγίες

Προσπαθήστε να μάθετε όσο το δυνατόν περισσότερα για τη συμπεριφορά των διαπιστεύσεων που πρόκειται να χρησιμοποιήσετε:

* Χρόνοι που χρησιμοποιούνται
* Τοποθεσίες
* User Agents / Υπηρεσίες (Μπορεί να χρησιμοποιείται από awscli, webconsole, lambda...)
* Δικαιώματα που χρησιμοποιούνται τακτικά

Με αυτές τις πληροφορίες, αναπαράγετε όσο το δυνατόν περισσότερο τον ίδιο σενάριο για να χρησιμοποιήσετε την πρόσβαση:

* Αν είναι **χρήστης ή ρόλος προσβάσιμος από έναν χρήστη**, προσπαθήστε να το χρησιμοποιήσετε τις ίδιες ώρες, από την ίδια γεωγραφική τοποθεσία (ακόμα και τον ίδιο ISP και IP αν είναι δυνατόν)
* Αν είναι **ρόλος που χρησιμοποιείται από μια υπηρεσία**, δημιουργήστε την ίδια υπηρεσία στην ίδια περιοχή και χρησιμοποιήστε την από εκεί στα ίδια χρονικά διαστήματα
* Πάντα προσπαθήστε να χρησιμοποιήσετε τα **ίδια δικαιώματα** που έχει χρησιμοποιήσει αυτό το υποκείμενο
* Αν χρειάζεται να **χρησιμοποιήσετε άλλα δικαιώματα ή να καταχραστείτε ένα δικαίωμα** (για παράδειγμα, να κατεβάσετε 1.000.000 αρχεία καταγραφής cloudtrail) κάντε το **αργά** και με το **ελάχιστο ποσό αλληλεπίδρασης** με το AWS (το awscli κάποιες φορές καλεί αρκετές read APIs πριν το write) 

### Κατάρριψη του GuardDuty

#### `guardduty:UpdateDetector`

Με αυτό το δικαίωμα μπορείτε να απενεργοποιήσετε το GuardDuty για να αποφύγετε την ενεργοποίηση ειδοποιήσεων. 

{% code overflow="wrap" %}
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
{% endcode %}

#### `guardduty:CreateFilter`

Οι επιτιθέμενοι με αυτήν την άδεια έχουν τη δυνατότητα να **χρησιμοποιούν φίλτρα για την αυτόματη** αρχειοθέτηση ευρημάτων: 

{% code overflow="wrap" %}
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
{% endcode %}

#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Οι επιτιθέμενοι με τα προηγούμενα προνόμια θα μπορούσαν να τροποποιήσουν τη [**Λίστα Εμπιστευμένων IP**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) του GuardDuty προσθέτοντας τη διεύθυνση IP τους και αποφεύγοντας τη δημιουργία ειδοποιήσεων.

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
{% endcode %}

#### `guardduty:DeletePublishingDestination`

Οι επιτιθέμενοι θα μπορούσαν να αφαιρέσουν τον προορισμό για να αποτρέψουν την ειδοποίηση:

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
Η διαγραφή αυτού του προορισμού δημοσίευσης **δεν θα επηρεάσει τη δημιουργία ή την ορατότητα των ευρημάτων μέσα στον πίνακα ελέγχου του GuardDuty**. Το GuardDuty θα συνεχίσει να αναλύει τα συμβάντα στο περιβάλλον AWS σας, να ανιχνεύει ύποπτη ή απροσδόκητη συμπεριφορά και να δημιουργεί ευρήματα.
{% endhint %}

### Συγκεκριμένα Παραδείγματα Παράκαμψης Ευρημάτων

Σημειώστε ότι υπάρχουν δεκάδες ευρήματα του GuardDuty, ωστόσο, **ως Red Teamer όχι όλα θα σας επηρεάσουν**, και τι είναι ακόμα καλύτερο, έχετε τη **πλήρη τεκμηρίωση κάθε ενός από αυτά** στο [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html) οπότε ρίξτε μια ματιά πριν προβείτε σε οποιαδήποτε ενέργεια για να μην εντοπιστείτε.

Εδώ έχετε μερικά παραδείγματα παράκαμψης συγκεκριμένων ευρημάτων του GuardDuty:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

Το GuardDuty ανιχνεύει αιτήσεις API του AWS από κοινά εργαλεία δοκιμών διείσδυσης και ενεργοποιεί ένα [εύρημα PenTest](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
Ανιχνεύεται από το **όνομα του πράκτορα χρήστη** που περνά στο αίτημα API.\
Συνεπώς, **τροποποιώντας τον πράκτορα χρήστη** είναι δυνατόν να αποτραπεί το GuardDuty από το να ανιχνεύσει την επίθεση.

Για να αποτρέψετε αυτό μπορείτε να αναζητήσετε από το σενάριο `session.py` στο πακέτο `botocore` και να τροποποιήσετε τον πράκτορα χρήστη, ή να ορίσετε το Burp Suite ως πρόσθετο AWS CLI και να αλλάξετε τον πράκτορα χρήστη με το MitM ή απλά να χρησιμοποιήσετε ένα λειτουργικό σύστημα όπως Ubuntu, Mac ή Windows για να αποτρέψετε αυτήν την ειδοποίηση από το να ενεργοποιηθεί.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

Η εξαγωγή διαπιστευτηρίων EC2 από την υπηρεσία μεταδεδομένων και η **χρήση τους έξω** από το περιβάλλον AWS ενεργοποιεί την ειδοποίηση [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws). Αντίστοιχα, η χρήση αυτών των διαπιστευτηρίων από την ιδία σας την EC2 ενεργοποιεί την ειδοποίηση [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws). Ωστόσο, **η χρήση των διαπιστευτηρίων σε μια άλλη υποβαθμισμένη EC2 στον ίδιο λογαριασμό παραμένει ανεντοπίστη**, μην ενεργοποιώντας καμία ειδοποίηση.

{% hint style="success" %}
Συνεπώς, **χρησιμοποιήστε τα εξαχθέντα διαπιστευτήρια από μέσα στη μηχανή** όπου τα βρήκατε για να μην ενεργοποιηθεί αυτή η ειδοποίηση.
{% endhint %}

## Αναφορές

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα τηλεγραφήματος**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
{% endhint %}
