# AWS - Enumerazione di GuardDuty

{% hint style="success" %}
Impara e pratica l'Hacking AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di Github.

</details>
{% endhint %}

## GuardDuty

Secondo la [**documentazione**](https://aws.amazon.com/guardduty/features/): GuardDuty combina **apprendimento automatico, rilevamento delle anomalie, monitoraggio della rete e scoperta di file dannosi**, utilizzando sia fonti AWS che di terze parti leader nel settore per aiutare a proteggere carichi di lavoro e dati su AWS. GuardDuty √® in grado di analizzare decine di miliardi di eventi provenienti da diverse fonti di dati AWS, come i log degli eventi di AWS CloudTrail, i log del flusso di Amazon Virtual Private Cloud (VPC), gli audit di Amazon Elastic Kubernetes Service (EKS) e i log di livello di sistema e di query DNS.

Amazon GuardDuty **identifica attivit√† insolite all'interno dei tuoi account**, analizza la **rilevanza della sicurezza** dell'attivit√† e fornisce il **contesto** in cui √® stata invocata. Ci√≤ consente a un risponditore di determinare se dovrebbe dedicare tempo a ulteriori indagini.

Gli avvisi **appaiono nella console di GuardDuty (90 giorni)** e negli eventi di CloudWatch.

{% hint style="warning" %}
Quando un utente **disabilita GuardDuty**, smetter√† di monitorare il tuo ambiente AWS e non generer√† pi√π nuove scoperte, e le **scoperte esistenti andranno perse**.\
Se lo si ferma semplicemente, le scoperte esistenti rimarranno.
{% endhint %}

### Esempio di Scoperte

* **Ricognizione**: Attivit√† che suggerisce una ricognizione da parte di un attaccante, come **attivit√† API insolite**, tentativi di **accesso** al database sospetti, scansione delle porte intra-VPC, modelli insoliti di richieste di accesso fallite, o sondaggi delle porte non bloccate da un IP noto come dannoso.
* **Compromissione dell'istanza**: Attivit√† che indica una compromissione dell'istanza, come **mining di criptovalute, attivit√† di backdoor command and control (C\&C)**, malware che utilizza algoritmi di generazione di domini (DGA), attivit√† di denial of service in uscita, volume di traffico di rete insolitamente **elevato**, protocolli di rete insoliti, comunicazione dell'istanza in uscita con un IP dannoso noto, credenziali temporanee di Amazon EC2 utilizzate da un indirizzo IP esterno, ed esfiltrazione di dati tramite DNS.
* **Compromissione dell'account**: I modelli comuni indicativi di una compromissione dell'account includono chiamate API da una geolocalizzazione insolita o da un proxy anonimizzante, tentativi di disattivare il logging di AWS CloudTrail, modifiche che indeboliscono la politica della password dell'account, lanci di istanze o infrastrutture insolite, distribuzioni di infrastrutture in una regione insolita, furto di credenziali, attivit√† sospette di accesso al database, e chiamate API da indirizzi IP noti come dannosi.
* **Compromissione del bucket**: Attivit√† che indica una compromissione del bucket, come modelli di accesso ai dati sospetti che indicano un uso improprio delle credenziali, attivit√† insolite dell'API di Amazon S3 da un host remoto, accesso non autorizzato a S3 da indirizzi IP noti come dannosi, e chiamate API per recuperare dati nei bucket S3 da un utente senza precedenti di accesso al bucket o invocato da una posizione insolita. Amazon GuardDuty monitora e analizza continuamente gli eventi dei dati S3 di AWS CloudTrail (ad es. GetObject, ListObjects, DeleteObject) per rilevare attivit√† sospette in tutti i tuoi bucket Amazon S3.

<details>

<summary>Informazioni sulla Scoperta</summary>

Sommario della scoperta:

* Tipo di scoperta
* Severit√†: 7-8.9 Alta, 4-6.9 Media, 01-3.9 Bassa
* Regione
* ID dell'account
* ID della risorsa
* Ora della rilevazione
* Quale lista delle minacce √® stata utilizzata

Il corpo contiene queste informazioni:

* Risorsa interessata
* Azione
* Attore: Indirizzo IP, porta e dominio
* Informazioni aggiuntive

</details>

### Tutte le Scoperte

Accedi a un elenco di tutte le scoperte di GuardDuty in: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Multi Account

#### Per Invito

Puoi **invitare altri account** a un diverso account AWS GuardDuty in modo che **ogni account sia monitorato dallo stesso GuardDuty**. L'account principale deve invitare gli account membri e quindi il rappresentante dell'account membro deve accettare l'invito.

#### Tramite Organizzazione

Puoi designare qualsiasi account all'interno dell'organizzazione come **amministratore delegato di GuardDuty**. Solo l'account di gestione dell'organizzazione pu√≤ designare un amministratore delegato.

Un account designato come amministratore delegato diventa un account amministratore di GuardDuty, ha GuardDuty abilitato automaticamente nella Regione AWS designata, e ha anche il **permesso di abilitare e gestire GuardDuty per tutti gli account nell'organizzazione in quella Regione**. Gli altri account nell'organizzazione possono essere visualizzati e aggiunti come account membri di GuardDuty associati a questo account amministratore delegato.

## Enumerazione

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## Bypass di GuardDuty

### Guida Generale

Cerca di scoprire il pi√π possibile sul comportamento delle credenziali che stai per utilizzare:

* Orari in cui vengono utilizzate
* Posizioni
* User Agents / Servizi (Potrebbe essere utilizzato da awscli, webconsole, lambda...)
* Autorizzazioni utilizzate regolarmente

Con queste informazioni, ricrea il pi√π possibile lo stesso scenario per utilizzare l'accesso:

* Se si tratta di un **utente o di un ruolo utilizzato da un utente**, cerca di utilizzarlo nelle stesse ore, dalla stessa geolocalizzazione (anche lo stesso ISP e IP se possibile)
* Se si tratta di un **ruolo utilizzato da un servizio**, crea lo stesso servizio nella stessa regione e utilizzalo da l√¨ negli stessi intervalli di tempo
* Cerca sempre di utilizzare le **stesse autorizzazioni** che questo principale ha utilizzato
* Se hai bisogno di **utilizzare altre autorizzazioni o abusare di un'autorizzazione** (ad esempio, scaricare 1.000.000 di file di log di cloudtrail) fallo **lentamente** e con il **minimo numero di interazioni** con AWS (awscli a volte chiama diverse API di lettura prima di quella di scrittura)

### Violare GuardDuty

#### `guardduty:UpdateDetector`

Con questa autorizzazione potresti disabilitare GuardDuty per evitare di attivare gli allarmi.
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
{% endcode %}

#### `guardduty:CreateFilter`

Gli attaccanti con questa autorizzazione hanno la capacit√† di **utilizzare filtri per l'archiviazione automatica** delle scoperte: 

{% code overflow="wrap" %}
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
{% endcode %}

#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Gli attaccanti con i privilegi precedenti potrebbero modificare l'elenco degli [**IP attendibili di GuardDuty**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) aggiungendo il proprio indirizzo IP e evitando cos√¨ di generare allarmi.

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
{% endcode %}

#### `guardduty:DeletePublishingDestination`

Gli attaccanti potrebbero rimuovere la destinazione per evitare l'allerta:

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
L'eliminazione di questa destinazione di pubblicazione **non influir√† sulla generazione o visibilit√† delle rilevazioni all'interno della console GuardDuty**. GuardDuty continuer√† ad analizzare gli eventi nel tuo ambiente AWS, identificare comportamenti sospetti o inaspettati e generare rilevazioni.
{% endhint %}

### Esempi di Bypass di Specifiche Rilevazioni

Nota che ci sono decine di rilevazioni di GuardDuty, tuttavia, **come Red Teamer non tutte ti riguarderanno**, e cosa ancora migliore, hai la **documentazione completa di ognuna di esse** in [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html) quindi dai un'occhiata prima di agire per non farti beccare.

Ecco un paio di esempi di bypass delle specifiche rilevazioni di GuardDuty:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty rileva le richieste API AWS da comuni strumenti di penetration testing e attiva una [Rilevazione PenTest](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
Viene rilevato dal **nome dell'agente utente** passato nella richiesta API.\
Pertanto, **modificando l'agente utente** √® possibile impedire a GuardDuty di rilevare l'attacco.

Per prevenire ci√≤, puoi cercare nello script `session.py` nel pacchetto `botocore` e modificare l'agente utente, oppure impostare Burp Suite come proxy AWS CLI e cambiare l'user-agent con il MitM o semplicemente utilizzare un sistema operativo come Ubuntu, Mac o Windows per evitare che questa alert scatti.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

Estrarre le credenziali EC2 dal servizio di metadati e **utilizzarle al di fuori** dell'ambiente AWS attiva l'allerta [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws). Al contrario, utilizzare queste credenziali dal tuo istanza EC2 attiva l'allerta [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws). Tuttavia, **utilizzare le credenziali su un'altra istanza EC2 compromessa nello stesso account non viene rilevato**, non generando alcuna alert.

{% hint style="success" %}
Pertanto, **utilizza le credenziali esfiltrate dall'interno della macchina** dove le hai trovate per non attivare questa alert.
{% endhint %}

## Riferimenti

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

{% hint style="success" %}
Impara e pratica l'Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}
