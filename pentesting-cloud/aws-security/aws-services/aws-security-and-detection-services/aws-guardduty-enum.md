# AWS - GuardDuty Enum

{% hint style="success" %}
AWS Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin**.
* **Hacking püf noktalarını paylaşarak PR'ler göndererek HackTricks ve HackTricks Cloud github depolarına katkıda bulunun.**

</details>
{% endhint %}

## GuardDuty

[**Belgelere**](https://aws.amazon.com/guardduty/features/) göre: GuardDuty, AWS'deki iş yüklerini ve verileri korumaya yardımcı olmak için hem AWS hem de sektör lideri üçüncü taraf kaynaklarını kullanarak **makine öğrenimi, anormallik tespiti, ağ izleme ve kötü amaçlı dosya keşfi**ni birleştirir. GuardDuty, AWS CloudTrail etkinlik günlükleri, Amazon Virtual Private Cloud (VPC) Akış Günlükleri, Amazon Elastic Kubernetes Service (EKS) denetim ve sistem düzeyi günlükleri ve DNS sorgu günlükleri gibi birden fazla AWS veri kaynağında on milyarlarca olayı analiz edebilme yeteneğine sahiptir.

Amazon GuardDuty, hesaplarınızda **olağandışı faaliyetleri tanımlar**, faaliyetin **güvenlikle ilgisini** analiz eder ve bu faaliyetin **bağlamını** verir. Bu, bir yanıtlayıcının daha fazla araştırmaya zaman harcaması gerekip gerekmediğini belirlemesine olanak tanır.

Uyarılar **GuardDuty konsolunda (90 gün)** ve CloudWatch Olaylarında görünür.

{% hint style="warning" %}
Bir kullanıcı **GuardDuty'yi devre dışı bıraktığında**, AWS ortamınızı izlemeyi durduracak ve hiçbir yeni bulgu oluşturmayacak ve **mevcut bulgular kaybolacaktır**.\
Sadece durdurursanız, mevcut bulgular kalır.
{% endhint %}

### Bulgular Örneği

* **Keşif**: Bir saldırgan tarafından keşif gösteren etkinlikler, örneğin **olağandışı API etkinliği**, şüpheli veritabanı **giriş** denemeleri, intra-VPC **port taraması**, olağandışı başarısız giriş isteği desenleri veya bilinen kötü bir IP'den açılmamış port taraması gibi etkinlikler.
* **Örnek kompromis**: Bir örnek kompromisini gösteren etkinlikler, örneğin **kripto para madenciliği, arka kapı komut ve kontrol (C\&C)** etkinliği, alan adı oluşturma algoritmalarını kullanan kötü amaçlı yazılım (DGA), dışa doğru hizmet reddi etkinliği, olağandışı **yüksek ağ** trafiği hacmi, olağandışı ağ protokolleri, bilinen kötü amaçlı bir IP ile dışa doğru örnek iletişimi, harici bir IP adresi tarafından kullanılan geçici Amazon EC2 kimlik bilgileri ve DNS kullanarak veri dışa aktarma.
* **Hesap kompromis**: Hesap kompromisini gösteren yaygın desenler arasında olağandışı bir coğrafi konumdan veya anonimleştirme proxy'sinden API çağrıları, AWS CloudTrail günlüğünü devre dışı bırakma girişimleri, hesap şifre politikasını zayıflatan değişiklikler, olağandışı örnek veya altyapı başlatmaları, olağandışı bir bölgede altyapı dağıtımları, kimlik hırsızlığı, şüpheli veritabanı giriş etkinliği ve bilinen kötü amaçlı IP adreslerinden API çağrıları bulunmaktadır.
* **Kova kompromis**: Bir kova kompromisini gösteren etkinlikler, örneğin kimlik kötüye kullanımını gösteren şüpheli veri erişim desenleri, uzaktan bir ana bilgisayardan olağandışı Amazon S3 API etkinliği, bilinen kötü amaçlı IP adreslerinden izinsiz S3 erişimi ve daha önce kovaya erişim geçmişi olmayan bir kullanıcıdan S3 kovalarındaki verileri almak için yapılan API çağrıları veya olağandışı bir konumdan başlatılan API çağrıları gibi etkinlikler. Amazon GuardDuty, tüm Amazon S3 kovalarında şüpheli etkinlikleri tespit etmek için AWS CloudTrail S3 veri olaylarını (örneğin GetObject, ListObjects, DeleteObject) sürekli olarak izler ve analiz eder.

<details>

<summary>Bulgu Bilgisi</summary>

Bulgu özeti:

* Bulgu türü
* Önem: 7-8.9 Yüksek, 4-6.9 Orta, 01-3.9 Düşük
* Bölge
* Hesap Kimliği
* Kaynak Kimliği
* Algılama zamanı
* Hangi tehdit listesi kullanıldı

Gövdede bu bilgiler bulunmaktadır:

* Etkilenen kaynak
* Eylem
* Eylemci: IP adresi, bağlantı noktası ve etki alanı
* Ek Bilgiler

</details>

### Tüm Bulgular

GuardDuty bulgularının listesine [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html) adresinden erişilebilir.

### Çoklu Hesaplar

#### Davet Yoluyla

Farklı bir AWS GuardDuty hesabına **diğer hesapları davet edebilirsiniz**, böylece **her hesap aynı GuardDuty'den izlenir**. Ana hesap, üye hesapları davet etmeli ve ardından üye hesabın temsilcisi daveti kabul etmelidir.

#### Kuruluş Aracılığıyla

Kuruluş içindeki herhangi bir hesabı **GuardDuty'ye yetkilendirilmiş yönetici** olarak belirleyebilirsiniz. Yalnızca kuruluş yönetim hesabı bir yetkilendirilmiş yönetici belirleyebilir.

Yetkilendirilmiş yönetici olarak belirlenen bir hesap, GuardDuty yönetici hesabı haline gelir, belirlenen AWS Bölgesinde GuardDuty otomatik olarak etkinleştirilir ve aynı Bölgedeki tüm hesaplar için GuardDuty'yi etkinleştirme ve yönetme iznine sahip olur. Kuruluş içindeki diğer hesaplar, bu yetkilendirilmiş yönetici hesabıyla ilişkilendirilen GuardDuty üye hesapları olarak görüntülenebilir ve eklenir.

## Numaralandırma

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDuty Atlatma

### Genel Rehberlik

Kullanacağınız kimlik bilgilerinin davranışı hakkında mümkün olduğunca çok bilgi edinmeye çalışın:

* Kullanılan zamanlar
* Konumlar
* Kullanıcı Ajanları / Hizmetler (awscli, web konsolu, lambda tarafından kullanılabilir)
* Düzenli olarak kullanılan izinler

Bu bilgilerle, erişimi kullanmak için mümkün olduğunca aynı senaryoyu yeniden oluşturun:

* Eğer bir **kullanıcı veya bir kullanıcı tarafından erişilen bir rolse**, aynı saatlerde, aynı coğrafi konumdan (mümkünse aynı ISS ve IP'den) kullanmaya çalışın
* Eğer bir **hizmet tarafından kullanılan bir rolse**, aynı bölgede aynı hizmeti oluşturun ve aynı zaman aralıklarında oradan kullanın
* Her zaman bu anahtarın kullandığı **aynı izinleri** kullanmaya çalışın
* Eğer **başka izinlere ihtiyacınız varsa veya bir izni kötüye kullanmanız gerekiyorsa** (örneğin, 1.000.000 cloudtrail log dosyasını indirmek) bunu **yavaşça** ve **AWS ile minimum etkileşim** ile yapın (awscli bazen yazma işleminden önce birkaç okuma API'sını çağırabilir)

### GuardDuty'yi Kırma

#### `guardduty:UpdateDetector`

Bu izinle, uyarıları tetiklemekten kaçınmak için GuardDuty'yi devre dışı bırakabilirsiniz.
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
{% endcode %}

#### `guardduty:CreateFilter`

Bu izne sahip saldırganlar, bulguların otomatik olarak arşivlenmesi için filtreler kullanma yeteneğine sahiptir:
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
{% endcode %}

#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Önceki ayrıcalıklara sahip saldırganlar, IP adreslerini ekleyerek GuardDuty'nin [**Güvenilen IP listesini**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) değiştirebilir ve uyarılar oluşturmadan kaçınabilir. 

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
{% endcode %}

#### `guardduty:DeletePublishingDestination`

Saldırganlar uyarıyı engellemek için hedefi kaldırabilir:
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
Bu yayın hedefini silmek, **GuardDuty konsolundaki bulguların oluşturulmasını veya görünürlüğünü etkilemeyecektir**. GuardDuty, AWS ortamınızda olayları analiz etmeye devam edecek, şüpheli veya beklenmedik davranışları tanımlayacak ve bulgular oluşturacaktır.
{% endhint %}

### Belirli Bulguları Atlatma Örnekleri

GuardDuty bulgularının onlarca olduğunu unutmayın, ancak **Kırmızı Takım olarak hepsi sizi etkilemeyecek**, ve daha da iyisi, her birinin **tam belgelerine** [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html) sahipsiniz, bu yüzden yakalanmamak için herhangi bir eylem yapmadan önce bir göz atın.

İşte belirli GuardDuty bulgularını atlatma örneklerinden birkaçı:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty, yaygın penetrasyon testi araçlarından AWS API isteklerini algılar ve bir [PenTest Bulgusu](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) tetikler.\
API isteğinde iletilen **kullanıcı ajan adı** tarafından algılanır.\
Bu nedenle, saldırının algılanmasını önlemek için **kullanıcı ajanını değiştirmek** mümkündür.

Bunu önlemek için `botocore` paketindeki `session.py` betiğinde arama yapabilir ve kullanıcı ajanını değiştirebilirsiniz, veya AWS CLI proxy olarak Burp Suite'i ayarlayabilir ve kullanıcı ajanını MitM ile değiştirebilir veya Ubuntu, Mac veya Windows gibi bir işletim sistemi kullanarak bu uyarının tetiklenmesini önleyebilirsiniz.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

EC2 kimlik bilgilerini meta veri servisinden çıkararak ve bunları AWS ortamının dışında **kullanarak**, [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws) uyarısını etkinleştirir. Tersine, bu kimlik bilgilerini EC2 örneğinizden kullanmak, [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws) uyarısını tetikler. Ancak, **aynı hesap içindeki başka bir tehlikeye maruz kalmış EC2 örneğinde kimlik bilgilerini kullanmak algılanmaz**, hiçbir uyarı oluşturmaz.

{% hint style="success" %}
Bu nedenle, bulduğunuz makineden **içeriden çıkarılan kimlik bilgilerini kullanın** ve bu uyarının tetiklenmemesini sağlayın.
{% endhint %}

## Referanslar

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını göndererek HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek paylaşın.

</details>
{% endhint %}
