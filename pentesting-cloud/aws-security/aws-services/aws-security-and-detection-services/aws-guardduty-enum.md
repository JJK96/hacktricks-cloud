# AWS - GuardDuty Enum

{% hint style="success" %}
Naučite i vežbajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## GuardDuty

Prema [**dokumentaciji**](https://aws.amazon.com/guardduty/features/): GuardDuty kombinuje **mašinsko učenje, detekciju anomalija, nadgledanje mreže i otkrivanje zlonamernih fajlova**, koristeći kako AWS tako i vodeće izvore trećih strana kako bi pomogao u zaštiti radnih opterećenja i podataka na AWS-u. GuardDuty je sposoban da analizira desetine milijardi događaja sa više AWS izvora podataka, kao što su AWS CloudTrail evidencije događaja, Amazon Virtual Private Cloud (VPC) Flow Logs, Amazon Elastic Kubernetes Service (EKS) revizije i sistemske evidencije, i DNS upiti.

Amazon GuardDuty **identifikuje neobičnu aktivnost unutar vaših naloga**, analizira **bezbednosnu relevantnost** aktivnosti i pruža **kontekst** u kojem je pozvana. To omogućava odgovornom licu da odredi da li treba da potroši vreme na dalje istraživanje.

Upozorenja **se pojavljuju u GuardDuty konzoli (90 dana)** i CloudWatch događajima.

{% hint style="warning" %}
Kada korisnik **onemogući GuardDuty**, prestaje da nadgleda vaše AWS okruženje i neće generisati nove nalaze uopšte, a **postojeći nalazi će biti izgubljeni**.\
Ako ga samo zaustavite, postojeći nalazi će ostati.
{% endhint %}

### Primeri Nalaza

* **Rekognosciranje**: Aktivnost koja sugeriše rekognosciranje od strane napadača, poput **neobične API aktivnosti**, sumnjivih pokušaja **prijavljivanja** na bazu podataka, intra-VPC **skeniranja portova**, neobičnih obrazaca neuspelih zahteva za prijavljivanje ili probiranja otvorenih portova sa poznate loše IP adrese.
* **Kompromitovanje instance**: Aktivnost koja ukazuje na kompromitovanje instance, poput **rudarenja kriptovaluta, komande za daljinsko upravljanje (C\&C)** aktivnosti, malvera koji koristi algoritme za generisanje domena (DGA), odlazne aktivnosti odbijanja usluge, neuobičajeno **visokog saobraćaja na mreži**, neobičnih mrežnih protokola, odlazne komunikacije instance sa poznatom zlonamernom IP adresom, privremeno korišćenje Amazon EC2 akreditiva od strane spoljne IP adrese i eksfiltracija podataka korišćenjem DNS-a.
* **Kompromitovanje naloga**: Uobičajeni obrasci koji ukazuju na kompromitovanje naloga uključuju API pozive sa neobične geolokacije ili anonimizujućeg proksija, pokušaje onemogućavanja AWS CloudTrail logovanja, promene koje oslabljuju politiku lozinke naloga, neuobičajene instance ili lansiranja infrastrukture, implementacije infrastrukture u neuobičajenoj regiji, krađu akreditiva, sumnjivu aktivnost prijavljivanja na bazu podataka i API pozive sa poznatih zlonamernih IP adresa.
* **Kompromitovanje kante**: Aktivnost koja ukazuje na kompromitovanje kante, poput sumnjivih obrazaca pristupa podacima koji ukazuju na zloupotrebu akreditiva, neobične Amazon S3 API aktivnosti sa udaljenog hosta, neovlašćenog pristupa S3 sa poznatih zlonamernih IP adresa i API poziva za povlačenje podataka iz S3 kanti od strane korisnika bez prethodne istorije pristupa kanti ili pozvanih sa neuobičajene lokacije. Amazon GuardDuty kontinuirano nadgleda i analizira AWS CloudTrail S3 događaje (npr. GetObject, ListObjects, DeleteObject) kako bi otkrio sumnjivu aktivnost širom svih vaših Amazon S3 kanti.

<details>

<summary>Informacije o Nalazima</summary>

Sažetak nalaza:

* Tip nalaza
* Ozbiljnost: 7-8.9 Visoka, 4-6.9 Srednja, 01-3.9 Niska
* Region
* ID naloga
* ID resursa
* Vreme otkrivanja
* Koja lista pretnji je korišćena

Telo sadrži ove informacije:

* Pogođeni resurs
* Akcija
* Akter: IP adresa, port i domen
* Dodatne informacije

</details>

### Svi Nalazi

Pristupite listi svih nalaza GuardDuty-a na: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Višestruki Nalozi

#### Pozivom

Možete **pozvati druge naloge** u drugi AWS GuardDuty nalog tako da **svaki nalog bude nadgledan iz istog GuardDuty-a**. Glavni nalog mora pozvati naloge članove, a zatim predstavnik naloga člana mora prihvatiti poziv.

#### Preko Organizacije

Možete odrediti bilo koji nalog unutar organizacije da bude **delegirani administrator GuardDuty-a**. Samo glavni nalog organizacije može odrediti delegiranog administratora.

Nalog koji bude određen kao delegirani administrator postaje administratorski nalog GuardDuty-a, automatski ima omogućen GuardDuty u određenom AWS regionu, i takođe ima **dozvolu da omogući i upravlja GuardDuty-om za sve naloge u organizaciji unutar tog regiona**. Ostali nalozi u organizaciji mogu biti pregledani i dodati kao članski nalozi GuardDuty-a povezani sa ovim delegiranim administratorskim nalogom.

## Enumeracija

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## Bypass GuardDuty-a

### Opšte smernice

Pokušajte da saznate što više informacija o ponašanju akreditacija koje ćete koristiti:

* Vremena kada se koristi
* Lokacije
* Korisnički agenti / Servisi (Može se koristiti iz awscli, web konzole, lambda...)
* Dozvole koje se redovno koriste

Sa ovim informacijama, rekreirajte što je više moguće isti scenario za korišćenje pristupa:

* Ako je to **korisnik ili uloga kojoj pristupa korisnik**, pokušajte da je koristite u istim satima, sa iste geolokacije (čak i isti ISP i IP ako je moguće)
* Ako je to **uloga koju koristi servis**, kreirajte isti servis u istom regionu i koristite ga odande u istim vremenskim intervalima
* Uvek pokušajte da koristite **iste dozvole** koje je ovaj princip koristio
* Ako trebate da **koristite druge dozvole ili zloupotrebite dozvolu** (na primer, preuzmite 1.000.000 cloudtrail datoteka sa logovima) uradite to **sporo** i sa **minimalnom količinom interakcija** sa AWS-om (awscli ponekad poziva nekoliko čitanja API-ja pre pisanja)

### Obilaženje GuardDuty-a

#### `guardduty:UpdateDetector`

Sa ovom dozvolom možete onemogućiti GuardDuty kako biste izbegli pokretanje alarma.
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
#### `guardduty:CreateFilter`

Napadači sa ovlašćenjem imaju mogućnost da **koriste filtere za automatsko** arhiviranje nalaza:
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
{% endcode %}

#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Napadači sa prethodnim privilegijama mogu da modifikuju GuardDuty-ovu [**listu pouzdanih IP adresa**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) dodavanjem svoje IP adrese i izbegavanjem generisanja upozorenja.

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
{% endcode %}

#### `guardduty:DeletePublishingDestination`

Napadači bi mogli ukloniti odredište kako bi sprečili upozorenja:

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
Brisanje ovog odredišta objavljivanja **neće uticati na generisanje ili vidljivost nalaza unutar GuardDuty konzole**. GuardDuty će nastaviti da analizira događaje u vašem AWS okruženju, identifikuje sumnjivo ili neočekivano ponašanje i generiše nalaze.
{% endhint %}

### Primeri zaobilaženja specifičnih nalaza

Imajte na umu da postoji desetine nalaza GuardDuty-a, međutim, **kao Red Teamer neće vas sve to pogoditi**, a što je još bolje, imate **potpunu dokumentaciju za svaki od njih** na [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html) pa pogledajte pre nego što preduzmete bilo kakvu akciju da ne biste bili uhvaćeni.

Evo nekoliko primera zaobilaženja specifičnih nalaza GuardDuty-a:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty detektuje AWS API zahteve iz uobičajenih alata za testiranje proboja i pokreće [PenTest nalaz](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
Detektuje se po **imeni korisničkog agenta** koji se prosleđuje u API zahtevu.\
Stoga, **modifikovanjem korisničkog agenta** moguće je sprečiti GuardDuty da detektuje napad.

Da biste to sprečili, možete pretražiti skriptu `session.py` u paketu `botocore` i modifikovati korisničkog agenta, ili postaviti Burp Suite kao AWS CLI proxy i promeniti korisnički agent pomoću MitM-a ili jednostavno koristiti OS poput Ubuntu-a, Mac-a ili Windows-a da biste sprečili da se ovaj alarm aktivira.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

Izvlačenje EC2 akreditiva iz usluge metapodataka i **njihovo korišćenje van** AWS okruženja aktivira upozorenje [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws). Nasuprot tome, korišćenje ovih akreditiva sa vaše EC2 instance pokreće upozorenje [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws). Ipak, **korišćenje akreditiva na drugoj kompromitovanoj EC2 instanci unutar istog naloga ostaje neprimećeno**, ne izazivajući nikakvo upozorenje.

{% hint style="success" %}
Stoga, **koristite izvađene akreditive unutar mašine** gde ste ih pronašli kako ne biste aktivirali ovaj alarm.
{% endhint %}

## Reference

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

{% hint style="success" %}
Naučite i vežbajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
