# AWS - GuardDuty Enum

{% hint style="success" %}
Leer & oefen AWS Hack: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Controleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

## GuardDuty

Volgens die [**dokumente**](https://aws.amazon.com/guardduty/features/): GuardDuty kombineer **masjienleer, anomaliedeteksie, netwerkmonitoring, en skadelike l√™ervind**, deur beide AWS en toonaangewende derdeparty-bronne te gebruik om werklaste en data op AWS te beskerm. GuardDuty is in staat om tientalle miljarde gebeure oor verskeie AWS-data-bronne te analiseer, soos AWS CloudTrail-gebeurtenislogs, Amazon Virtual Private Cloud (VPC) Flow Logs, Amazon Elastic Kubernetes Service (EKS) oudit- en stelselvlaklogs, en DNS-navraaglogs.

Amazon GuardDuty **identifiseer ongewone aktiwiteit binne jou rekeninge**, analiseer die **sekuriteitsrelevansie** van die aktiwiteit, en gee die **konteks** waarin dit opgeroep is. Dit stel 'n reageerder in staat om te bepaal of hulle tyd moet spandeer aan verdere ondersoek.

Waarskuwings **verskyn in die GuardDuty-konsole (90 dae)** en CloudWatch-gebeure.

{% hint style="warning" %}
Wanneer 'n gebruiker **GuardDuty uitskakel**, sal dit ophou om jou AWS-omgewing te monitor en dit sal glad nie enige nuwe bevindinge genereer nie, en die **bestaande bevindinge sal verlore gaan**.\
As jy dit net stop, sal die bestaande bevindinge bly.
{% endhint %}

### Voorbeeld van Bevindinge

* **Verkenning**: Aktiwiteit wat dui op verkenning deur 'n aanvaller, soos **ongewone API-aktiwiteit**, verdagte databasis **aanmeldingspogings**, intra-VPC **poortskandering**, ongewone mislukte aanmeldingsversoekpatrone, of ongeblokkeerde poortondersoek vanaf 'n bekende slegte IP.
* **Instansie-oormatigheid**: Aktiwiteit wat dui op 'n instansie-oormatigheid, soos **kriptogeldmynbou, agterdeur bevel en beheer (C\&C)**-aktiwiteit, malware wat domein-generasie-algoritmes (DGA) gebruik, uitgaande ontkenning van diensaktiwiteit, ongewoon **ho√´ netwerk**-verkeersvolume, ongewone netwerkprotokolle, uitgaande instansiekommunikasie met 'n bekende skadelike IP, tydelike Amazon EC2-legitimasie gebruik deur 'n eksterne IP-adres, en data-eksfiltrering deur DNS.
* **Rekening-oormatigheid**: Algemene patrone wat dui op rekening-oormatigheid sluit API-oproepe vanaf 'n ongewone geolokalisering of anonimiserende proksi, pogings om AWS CloudTrail-logging uit te skakel, veranderinge wat die rekeningwagwoordbeleid verswak, ongewone instansie- of infrastruktuurlanserings, infrastruktuurimplementasies in 'n ongewone streek, legitimasiediefstal, verdagte databasisaanmeldingsaktiwiteit, en API-oproepe vanaf bekende skadelike IP-adresse in.
* **Emmer-oormatigheid**: Aktiwiteit wat dui op 'n emmer-oormatigheid, soos verdagte data-toegangspatrone wat dui op legitimasie-misbruik, ongewone Amazon S3 API-aktiwiteit vanaf 'n afgele√´ gasheer, ongemagtigde S3-toegang vanaf bekende skadelike IP-adresse, en API-oproepe om data in S3-emmers te herwin vanaf 'n gebruiker met geen vorige geskiedenis van toegang tot die emmer of opgeroep vanaf 'n ongewone plek. Amazon GuardDuty monitor en analiseer voortdurend AWS CloudTrail S3-data-gebeure (bv. GetObject, ListObjects, DeleteObject) om verdagte aktiwiteit oor al jou Amazon S3-emmers op te spoor.

<details>

<summary>Bevindinginligting</summary>

Opsomming van bevindinge:

* Tipe bevinding
* Ernstigheid: 7-8.9 Ho√´, 4-6.9 Medium, 01-3.9 Laag
* Streek
* Rekening-ID
* Hulpbron-ID
* Tyd van opsporing
* Watter dreigingslys is gebruik

Die liggaam bevat hierdie inligting:

* Geraakte hulpbron
* Aksie
* Akteur: IP-adres, poort en domein
* Addisionele inligting

</details>

### Alle Bevindinge

Toegang tot 'n lys van al die GuardDuty-bevindinge by: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Multi-rekeninge

#### Per Uitnodiging

Jy kan **ander rekeninge uitnooi** na 'n ander AWS GuardDuty-rekening sodat **elke rekening van dieselfde GuardDuty gemonitor word**. Die hoofrekening moet die lidrekeninge uitnooi en dan moet die verteenwoordiger van die lidrekening die uitnodiging aanvaar.

#### Via Organisasie

Jy kan enige rekening binne die organisasie aanwys as die **GuardDuty gedelegeerde administrateur**. Slegs die organisasiebestuursrekening kan 'n gedelegeerde administrateur aanwys.

'n Rekening wat aangewys word as 'n gedelegeerde administrateur word 'n GuardDuty-administrateursrekening, het GuardDuty outomaties in die aangewese AWS-streek geaktiveer, en het ook die **toestemming om GuardDuty vir al die rekeninge in die organisasie binne daardie streek te aktiveer en te bestuur**. Die ander rekeninge in die organisasie kan besigtig en bygevoeg word as GuardDuty-lidrekeninge wat met hierdie gedelegeerde administrateursrekening verband hou.

## Enumerasie

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDuty Omgang

### Algemene Leiding

Probeer om so veel as moontlik uit te vind oor die gedrag van die geloofsbriewe wat jy gaan gebruik:

* Tye waarop dit gebruik word
* Liggings
* Gebruikeragents / Dienste (Dit kan gebruik word vanaf awscli, webkonsol, lambda...)
* Toestemmings wat gereeld gebruik word

Met hierdie inligting, herskep so veel as moontlik dieselfde scenario om die toegang te gebruik:

* As dit 'n **gebruiker of 'n rol wat deur 'n gebruiker benader word** is, probeer om dit in dieselfde ure te gebruik, van dieselfde geolokasie (selfs dieselfde ISP en IP indien moontlik)
* As dit 'n **rol is wat deur 'n diens gebruik word**, skep dieselfde diens in dieselfde streek en gebruik dit van daar af in dieselfde tydperke
* Probeer altyd om dieselfde toestemmings te gebruik wat hierdie hoof gebruik het
* As jy ander toestemmings moet gebruik of 'n toestemming moet misbruik (byvoorbeeld, 1.000.000 cloudtrail-logl√™ers aflaai), doen dit **stadig** en met die **minimum hoeveelheid interaksies** met AWS (awscli roep soms verskeie lees-API's aan voordat die skryf een)

### Oortree GuardDuty

#### `guardduty:UpdateDetector`

Met hierdie toestemming kan jy GuardDuty deaktiveer om te verhoed dat waarskuwings geaktiveer word.

{% code overflow="wrap" %}
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
#### `guardduty:SkepFilter`

Aanvallers met hierdie toestemming het die vermo√´ om **filters te gebruik vir die outomatiese** argivering van bevindinge:
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
{% endcode %}

#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Aanvallers met die vorige voorregte kon GuardDuty se [**Vertroude IP-lys**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) wysig deur hul IP-adres daaraan toe te voeg en sodoende waarskuwings te vermy.

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
#### `guardduty:DeletePublishingDestination`

Aanvallers kan die bestemming verwyder om waarskuwings te voorkom:
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
Die verwydering van hierdie publikasie-bestemming sal **nie die generering of sigbaarheid van bevindinge binne die GuardDuty-konsole be√Ønvloed nie**. GuardDuty sal voortgaan om gebeure in jou AWS-omgewing te analiseer, verdagte of onverwagte gedrag te identifiseer, en bevindinge te genereer.
{% endhint %}

### Spesifieke Bevinding Verbygaan Voorbeelde

Let daarop dat daar tientalle GuardDuty-bevindinge is, maar **as 'n Rooi Span-lid sal nie almal van hulle jou affekteer nie**, en wat nog beter is, jy het die **volledige dokumentasie van elkeen van hulle** in [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html) so kyk daarna voordat jy enige aksie onderneem om nie gevang te word nie.

Hier het jy 'n paar voorbeelde van spesifieke GuardDuty-bevinding omseilings:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty identifiseer AWS API-aanvrae van algemene penetrasietoetsgereedskap en aktiveer 'n [PenTest Bevinding](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
Dit word ge√Ødentifiseer deur die **gebruiker-agentnaam** wat in die API-aanvraag oorgedra word.\
Daarom is dit moontlik om GuardDuty te verhoed om die aanval op te spoor deur **die gebruiker-agent te wysig**.

Om dit te voorkom, kan jy soek na die skriffie `session.py` in die `botocore`-pakket en die gebruiker-agent wysig, of stel Burp Suite as die AWS CLI-proksi in en verander die gebruiker-agent met die MitM of gebruik 'n OS soos Ubuntu, Mac of Windows sal voorkom dat hierdie waarskuwing geaktiveer word.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

Die onttrekking van EC2-legitimasie van die metadata-diens en **die gebruik daarvan buite** die AWS-omgewing aktiveer die [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws) waarskuwing. Omgekeerd, die gebruik van hierdie legitimasie vanaf jou EC2-instantie aktiveer die [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws) waarskuwing. Tog, **die gebruik van die legitimasie op 'n ander gekompromitteerde EC2-instantie binne dieselfde rekening word nie opgespoor nie**, en veroorsaak geen waarskuwing nie.

{% hint style="success" %}
Gebruik dus die onttrekte legitimasie van binne die masjien** waar jy dit gevind het om hierdie waarskuwing nie te aktiveer nie.
{% endhint %}

## Verwysings

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

{% hint style="success" %}
Leer & oefen AWS Hack: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Rooi Span Kenner (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Rooi Span Kenner (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
