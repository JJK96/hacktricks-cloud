# AWS - Enumeraci√≥n de CloudWatch

{% hint style="success" %}
Aprende y practica Hacking en AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

- Consulta los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
- **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
- **Comparte trucos de hacking enviando PRs a** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}

## CloudWatch

**CloudWatch** **recopila** datos de monitoreo y operativos en forma de registros/m√©tricas/eventos proporcionando una **vista unificada de los recursos de AWS**, aplicaciones y servicios.\
Los eventos de registro de CloudWatch tienen una **limitaci√≥n de tama√±o de 256KB en cada l√≠nea de registro**.\
Puede configurar **alarmas de alta resoluci√≥n**, visualizar **registros** y **m√©tricas** lado a lado, tomar acciones automatizadas, solucionar problemas y descubrir informaci√≥n para optimizar aplicaciones.

Puede monitorear, por ejemplo, registros de CloudTrail. Eventos que se monitorean:

- Cambios en Grupos de Seguridad y NACLs
- Inicio, detenci√≥n, reinicio y terminaci√≥n de instancias EC2
- Cambios en Pol√≠ticas de Seguridad dentro de IAM y S3
- Intentos de inicio de sesi√≥n fallidos en la Consola de Administraci√≥n de AWS
- Llamadas a la API que resultaron en autorizaci√≥n fallida
- Filtros para buscar en CloudWatch: [https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

## Conceptos clave

### Espacios de nombres

Un espacio de nombres es un contenedor para m√©tricas de CloudWatch. Ayuda a categorizar y aislar m√©tricas, facilitando su gesti√≥n y an√°lisis.

- **Ejemplos**: AWS/EC2 para m√©tricas relacionadas con EC2, AWS/RDS para m√©tricas de RDS.

### M√©tricas

Las m√©tricas son puntos de datos recopilados con el tiempo que representan el rendimiento o la utilizaci√≥n de recursos de AWS. Las m√©tricas pueden recopilarse de servicios de AWS, aplicaciones personalizadas o integraciones de terceros.

- **Ejemplo**: CPUUtilization, NetworkIn, DiskReadOps.

### Dimensiones

Las dimensiones son pares clave-valor que forman parte de las m√©tricas. Ayudan a identificar de forma √∫nica una m√©trica y proporcionan contexto adicional, pudiendo asociarse hasta 30 dimensiones con una m√©trica. Las dimensiones tambi√©n permiten filtrar y agregar m√©tricas en funci√≥n de atributos espec√≠ficos.

- **Ejemplo**: Para las instancias de EC2, las dimensiones pueden incluir InstanceId, InstanceType y AvailabilityZone.

### Estad√≠sticas

Las estad√≠sticas son c√°lculos matem√°ticos realizados en datos de m√©tricas para resumirlos con el tiempo. Las estad√≠sticas comunes incluyen Promedio, Suma, M√≠nimo, M√°ximo y Recuento de muestras.

- **Ejemplo**: Calcular la utilizaci√≥n promedio de la CPU durante un per√≠odo de una hora.

### Unidades

Las unidades son el tipo de medida asociado con una m√©trica. Las unidades ayudan a proporcionar contexto y significado a los datos de la m√©trica. Las unidades comunes incluyen Porcentaje, Bytes, Segundos, Cuenta.

- **Ejemplo**: La CPUUtilization podr√≠a medirse en Porcentaje, mientras que NetworkIn podr√≠a medirse en Bytes.

## Funcionalidades de CloudWatch

### Tablero

Los **Tableros de CloudWatch** proporcionan vistas personalizables de las **m√©tricas de AWS CloudWatch**. Es posible crear y configurar tableros para visualizar datos y monitorear recursos en una sola vista, combinando diferentes m√©tricas de varios servicios de AWS.

**Caracter√≠sticas clave**:

- **Widgets**: Bloques de construcci√≥n de los tableros, incluyendo gr√°ficos, texto, alarmas y m√°s.
- **Personalizaci√≥n**: El dise√±o y el contenido pueden personalizarse para adaptarse a necesidades de monitoreo espec√≠ficas.

**Ejemplo de caso de uso**:

- Un √∫nico tablero que muestra m√©tricas clave para todo su entorno de AWS, incluidas instancias EC2, bases de datos RDS y buckets S3.

### Flujo de M√©tricas y Datos de M√©tricas

Los **Flujos de M√©tricas** en AWS CloudWatch te permiten transmitir continuamente m√©tricas de CloudWatch a un destino de tu elecci√≥n en tiempo casi real. Esto es particularmente √∫til para monitoreo avanzado, an√°lisis y tableros personalizados utilizando herramientas fuera de AWS.

Los **Datos de M√©tricas** dentro de los Flujos de M√©tricas se refieren a las mediciones reales o puntos de datos que se est√°n transmitiendo. Estos puntos de datos representan varias m√©tricas como utilizaci√≥n de CPU, uso de memoria, etc., para recursos de AWS.

**Ejemplo de caso de uso**:

- Enviar m√©tricas en tiempo real a un servicio de monitoreo de terceros para un an√°lisis avanzado.
- Archivar m√©tricas en un bucket de Amazon S3 para almacenamiento a largo plazo y cumplimiento.

### Alarma

Las **Alarmas de CloudWatch** monitorean tus m√©tricas y realizan acciones basadas en umbrales predefinidos. Cuando una m√©trica supera un umbral, la alarma puede realizar una o m√°s acciones como enviar notificaciones a trav√©s de SNS, activar una pol√≠tica de escalado autom√°tico o ejecutar una funci√≥n de AWS Lambda.

**Componentes clave**:

- **Umbral**: El valor en el que se activa la alarma.
- **Per√≠odos de evaluaci√≥n**: El n√∫mero de per√≠odos durante los cuales se eval√∫an los datos.
- **Puntos de datos para la alarma**: El n√∫mero de per√≠odos con un umbral alcanzado necesario para activar la alarma.
- **Acciones**: Lo que sucede cuando se activa un estado de alarma (por ejemplo, notificar a trav√©s de SNS).

**Ejemplo de caso de uso**:

- Monitorear la utilizaci√≥n de la CPU de una instancia EC2 y enviar una notificaci√≥n a trav√©s de SNS si supera el 80% durante 5 minutos consecutivos.

### Detectores de Anomal√≠as

Los **Detectores de Anomal√≠as** utilizan aprendizaje autom√°tico para detectar autom√°ticamente anomal√≠as en tus m√©tricas. Puedes aplicar la detecci√≥n de anomal√≠as a cualquier m√©trica de CloudWatch para identificar desviaciones de patrones normales que podr√≠an indicar problemas.

**Componentes clave**:

- **Entrenamiento del Modelo**: CloudWatch utiliza datos hist√≥ricos para entrenar un modelo y establecer c√≥mo se ve el comportamiento normal.
- **Banda de Detecci√≥n de Anomal√≠as**: Una representaci√≥n visual del rango esperado de valores para una m√©trica.

**Ejemplo de caso de uso**:

- Detectar patrones inusuales de utilizaci√≥n de CPU en una instancia EC2 que podr√≠an indicar una brecha de seguridad o un problema de aplicaci√≥n.

### Reglas de Insight y Reglas de Insight Administradas

Las **Reglas de Insight** te permiten identificar tendencias, detectar picos u otros patrones de inter√©s en tus datos de m√©tricas utilizando **expresiones matem√°ticas potentes** para definir las condiciones bajo las cuales se deben tomar acciones. Estas reglas pueden ayudarte a identificar anomal√≠as o comportamientos inusuales en el rendimiento y la utilizaci√≥n de tus recursos.

Las **Reglas de Insight Administradas** son **reglas de insight preconfiguradas proporcionadas por AWS**. Est√°n dise√±adas para monitorear servicios espec√≠ficos de AWS o casos de uso comunes y se pueden habilitar sin necesidad de una configuraci√≥n detallada.

**Ejemplo de caso de uso**:

- Monitoreo del rendimiento de RDS: Habilitar una regla de insight administrada para Amazon RDS que monitorea indicadores clave de rendimiento como la utilizaci√≥n de CPU, el uso de memoria y la E/S de disco. Si alguna de estas m√©tricas supera los umbrales operativos seguros, la regla puede activar una alerta o una acci√≥n de mitigaci√≥n automatizada.

### Registros de CloudWatch <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

Permite **agregar y monitorear registros de aplicaciones** y sistemas de **servicios de AWS** (incluido CloudTrail) y **de aplicaciones/sistemas** (**el Agente de CloudWatch** se puede instalar en un host). Los registros pueden **almacenarse indefinidamente** (seg√∫n la configuraci√≥n del Grupo de Registros) y pueden exportarse.

**Elementos**:

| **Grupo de Registros**  | Una **colecci√≥n de secuencias de registros** que comparten la misma configuraci√≥n de retenci√≥n, monitoreo y control de acceso                                                     |
| ----------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Secuencia de Registros** | Una secuencia de **eventos de registro** que comparten la **misma fuente**                                                                                                |
| **Filtros de Suscripci√≥n** | Definen un **patr√≥n de filtro que coincide con eventos** en un grupo de registros espec√≠fico, los env√≠an a un flujo de Kinesis Data Firehose, un flujo de Kinesis o una funci√≥n de Lambda |
### Monitoreo y Eventos de CloudWatch

CloudWatch **b√°sico** agrega datos **cada 5 min** (el **detallado** lo hace **cada 1 min**). Despu√©s de la agregaci√≥n, **verifica los umbrales de las alarmas** en caso de que necesite activar una.\
En ese caso, CloudWatch puede estar preparado para enviar un evento y realizar algunas acciones autom√°ticas (funciones AWS Lambda, temas SNS, colas SQS, flujos de Kinesis)

### Instalaci√≥n del Agente

Puedes instalar agentes dentro de tus m√°quinas/contenedores para enviar autom√°ticamente los registros de vuelta a CloudWatch.

* **Crear** un **rol** y **adjuntarlo** a la **instancia** con permisos que permitan a CloudWatch recopilar datos de las instancias adem√°s de interactuar con el administrador de sistemas de AWS SSM (CloudWatchAgentAdminPolicy y AmazonEC2RoleforSSM)
* **Descargar** e **instalar** el **agente** en la instancia EC2 ([https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)). Puedes descargarlo desde dentro de la EC2 o instalarlo autom√°ticamente usando AWS System Manager seleccionando el paquete AWS-ConfigureAWSPackage
* **Configurar** y **iniciar** el Agente de CloudWatch

Un grupo de registros tiene muchos flujos. Un flujo tiene muchos eventos. Y dentro de cada flujo, los eventos est√°n garantizados de estar en orden.

## Enumeraci√≥n
```bash
# Dashboards #

## Returns a list of the dashboards of your account
aws cloudwatch list-dashboards

## Retrieves the details of the specified dashboard
aws cloudwatch get-dashboard --dashboard-name <value>

# Metrics #

## Returns a list of the specified metric
aws cloudwatch list-metrics [--namespace <value>] [--metric-name <value>] [--dimensions <value>] [--include-linked-accounts | --no-include-linked-accounts]

## Retrieves metric data (this operation can include a CloudWatch Metrics Insights query, and one or more metric math functions)
aws cloudwatch get-metric-data --metric-data-queries <value> --start-time <value> --end-time <value>

## Retrieves statistics for the specified metric and namespace over a range of time
aws cloudwatch get-metric-statistics --namespace <value> --metric-name <value> [--dimensions <value>] --start-time <value> --end-time <value> --period <value>

## Returns a list of the metric streams of your account
aws cloudwatch list-metric-streams

## Retrieves information about the specified metric stream
aws cloudwatch get-metric-stream --name <value>

## Retrieve snapshots of the specified metric widgets
aws cloudwatch get-metric-widget-image --metric-widget <value>

# Alarms #

## Retrieves the specified alarm
aws cloudwatch describe-alarms [--alarm-names <value>] [--alarm-name-prefix <value>] [--alarm-types <value>] [--state-value <value>]

## Retrieves the alarms history, even for deleted alarms
aws cloudwatch describe-alarm-history [--alarm-name <value>] [--alarm-types <value>] [--history-item-type <ConfigurationUpdate | StateUpdate | Action>] [--start-date <value>] [--end-date <value>]

## Retrieves standard alarms based on the specified metric
aws cloudwatch escribe-alarms-for-metric --metric-name <value> --namespace <value> [--dimensions <value>]

# Anomaly Detections #

## Lists the anomaly detection models that you have created in your account
aws cloudwatch describe-anomaly-detectors [--namespace <value>] [--metric-name <value>] [--dimensions <value>]

## Lists all the Contributor Insight rules in your account
aws cloudwatch describe-insight-rules

## Retrieves the data collected over a time range for a given Contributor Insight rule
aws cloudwatch get-insight-rule-report --rule-name <value> --start-time <value> --end-time <value> --period <value>

## Lists managed Contributor Insights rules in your account for a specified resource
aws cloudwatch list-managed-insight-rules --resource-arn <value>

# Tags #

## Lists the tags associated with the specified CloudWatch resources
aws cloudwatch list-tags-for-resource --resource-arn <value>

# CloudWatch Logs #
aws logs tail "<log_group_name>" --followaws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# CloudWatch Events #
aws events list-rules
aws events describe-rule --name <name>aws events list-targets-by-rule --rule <name>aws events list-archives
aws events describe-archive --archive-name <name>aws events list-connections
aws events describe-connection --name <name>aws events list-endpoints
aws events describe-endpoint --name <name>aws events list-event-sources
aws events describe-event-source --name <name>aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## Post-Explotaci√≥n / Eludir

### **`cloudwatch:DeleteAlarms`,`cloudwatch:PutMetricAlarm` ,¬†`cloudwatch:PutCompositeAlarm`**

Un atacante con estos permisos podr√≠a socavar significativamente la infraestructura de monitoreo y alerta de una organizaci√≥n. Al eliminar alarmas existentes, un atacante podr√≠a desactivar alertas cruciales que notifican a los administradores sobre problemas cr√≠ticos de rendimiento, violaciones de seguridad o fallas operativas. Adem√°s, al crear o modificar alarmas m√©tricas, el atacante tambi√©n podr√≠a confundir a los administradores con alertas falsas o silenciar alarmas leg√≠timas, enmascarando efectivamente actividades maliciosas y evitando respuestas oportunas a incidentes reales.

Adem√°s, con el permiso **`cloudwatch:PutCompositeAlarm`**, un atacante podr√≠a crear un bucle o ciclo de alarmas compuestas, donde la alarma compuesta A depende de la alarma compuesta B, y la alarma compuesta B tambi√©n depende de la alarma compuesta A. En este escenario, no es posible eliminar ninguna alarma compuesta que sea parte del ciclo porque siempre hay una alarma compuesta que depende de esa alarma que se desea eliminar.
```bash
aws cloudwatch put-metric-alarm --cli-input-json <value> | --alarm-name <value> --comparison-operator <value> --evaluation-periods <value> [--datapoints-to-alarm <value>] [--threshold <value>] [--alarm-description <value>] [--alarm-actions <value>] [--metric-name <value>] [--namespace <value>] [--statistic <value>] [--dimensions <value>] [--period <value>]
aws cloudwatch delete-alarms --alarm-names <value>
aws cloudwatch put-composite-alarm --alarm-name <value> --alarm-rule <value> [--no-actions-enabled | --actions-enabled [--alarm-actions <value>] [--insufficient-data-actions <value>] [--ok-actions <value>] ]
```
El siguiente ejemplo muestra c√≥mo hacer que una alarma de m√©tricas sea ineficaz:

- Esta alarma de m√©tricas monitorea la utilizaci√≥n promedio de la CPU de una instancia EC2 espec√≠fica, eval√∫a la m√©trica cada 300 segundos y requiere 6 per√≠odos de evaluaci√≥n (30 minutos en total). Si la utilizaci√≥n promedio de la CPU supera el 60% durante al menos 4 de estos per√≠odos, la alarma se activar√° y enviar√° una notificaci√≥n al tema SNS especificado.
- Al modificar el Umbral para que sea superior al 99%, establecer el Per√≠odo en 10 segundos, los Per√≠odos de Evaluaci√≥n en 8640 (ya que 8640 per√≠odos de 10 segundos equivalen a 1 d√≠a), y los Puntos de Datos a Alarmar tambi√©n en 8640, ser√≠a necesario que la utilizaci√≥n de la CPU est√© por encima del 99% cada 10 segundos durante todo el per√≠odo de 24 horas para activar una alarma.

{% tabs %}
{% tab title="Alarma de M√©trica Original" %}
```json
{
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-01234567890123456"
}
],
"AlarmActions": [
"arn:aws:sns:us-east-1:123456789012:example_sns"
],
"ComparisonOperator": "GreaterThanThreshold",
"DatapointsToAlarm": 4,
"EvaluationPeriods": 6,
"Period": 300,
"Statistic": "Average",
"Threshold": 60,
"AlarmDescription": "CPU Utilization of i-01234567890123456 over 60%",
"AlarmName": "EC2 instance i-01234567890123456 CPU Utilization"
}
```
{% endtab %}
{% tab title="Alarma de M√©trica Modificada" %}
```json
{
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0645d6d414dadf9f8"
}
],
"AlarmActions": [],
"ComparisonOperator": "GreaterThanThreshold",
"DatapointsToAlarm": 8640,
"EvaluationPeriods": 8640,
"Period": 10,
"Statistic": "Average",
"Threshold": 99,
"AlarmDescription": "CPU Utilization of i-01234567890123456 with 60% as threshold",
"AlarmName": "Instance i-0645d6d414dadf9f8 CPU Utilization"
}

```
{% endtab %}
{% endtabs %}
**Impacto Potencial**: Falta de notificaciones para eventos cr√≠ticos, posibles problemas no detectados, alertas falsas, supresi√≥n de alertas genuinas y posiblemente detecci√≥n perdida de incidentes reales.

### **`cloudwatch:DeleteAlarmActions`,¬†`cloudwatch:EnableAlarmActions` , `cloudwatch:SetAlarmState`**

Al eliminar acciones de alarma, el atacante podr√≠a evitar que se activen alertas cr√≠ticas y respuestas automatizadas cuando se alcance un estado de alarma, como notificar a los administradores o activar actividades de escalado autom√°tico. Habilitar o volver a habilitar acciones de alarma de manera inapropiada tambi√©n podr√≠a provocar comportamientos inesperados, ya sea reactivando acciones previamente deshabilitadas o modificando qu√© acciones se activan, lo que podr√≠a causar confusi√≥n y desorientaci√≥n en la respuesta a incidentes.

Adem√°s, un atacante con los permisos adecuados podr√≠a manipular estados de alarma, pudiendo crear alarmas falsas para distraer y confundir a los administradores, o silenciar alarmas genuinas para ocultar actividades maliciosas en curso o fallas cr√≠ticas del sistema.

- Si utilizas **`SetAlarmState`** en una alarma compuesta, no se garantiza que la alarma compuesta vuelva a su estado real. Vuelve a su estado real solo una vez que alguna de sus alarmas secundarias cambie de estado. Tambi√©n se reeval√∫a si actualizas su configuraci√≥n.
```bash
aws cloudwatch disable-alarm-actions --alarm-names <value>
aws cloudwatch enable-alarm-actions --alarm-names <value>
aws cloudwatch set-alarm-state --alarm-name <value> --state-value <OK | ALARM | INSUFFICIENT_DATA> --state-reason <value> [--state-reason-data <value>]
```
**Impacto Potencial**: Falta de notificaciones para eventos cr√≠ticos, posibles problemas no detectados, alertas falsas, supresi√≥n de alertas genuinas y posiblemente detecci√≥n perdida de incidentes reales.

### **`cloudwatch:DeleteAnomalyDetector`,¬†`cloudwatch:PutAnomalyDetector`**

Un atacante podr√≠a comprometer la capacidad de detecci√≥n y respuesta a patrones inusuales o anomal√≠as en los datos m√©tricos. Al eliminar detectores de anomal√≠as existentes, un atacante podr√≠a deshabilitar mecanismos cr√≠ticos de alerta; y al crear o modificarlos, podr√≠a mal configurarlos o crear falsos positivos para distraer o abrumar el monitoreo.
```bash
aws cloudwatch delete-anomaly-detector [--cli-input-json <value> | --namespace <value> --metric-name <value> --dimensions <value> --stat <value>]
aws cloudwatch put-anomaly-detector [--cli-input-json <value> | --namespace <value> --metric-name <value> --dimensions <value> --stat <value> --configuration <value> --metric-characteristics <value>]
```
El siguiente ejemplo muestra c√≥mo hacer que un detector de anomal√≠as de m√©tricas sea ineficaz. Este detector de anomal√≠as de m√©tricas monitorea la utilizaci√≥n promedio de la CPU de una instancia EC2 espec√≠fica, y simplemente agregando el par√°metro "ExcludedTimeRanges" con el rango de tiempo deseado, ser√≠a suficiente para asegurar que el detector de anomal√≠as no analice ni alerte sobre ning√∫n dato relevante durante ese per√≠odo. 

{% tabs %}
{% tab title="Detector de Anomal√≠as de M√©tricas Original" %}
```json
{
"SingleMetricAnomalyDetector": {
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Stat": "Average",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0123456789abcdefg"
}
]
}
}
```
{% endtab %}
{% tab title="Detector de Anomal√≠as de M√©tricas Modificado" %}
```json
{
"SingleMetricAnomalyDetector": {
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Stat": "Average",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0123456789abcdefg"
}
]
},
"Configuration": {
"ExcludedTimeRanges": [
{
"StartTime": "2023-01-01T00:00:00Z",
"EndTime": "2053-01-01T23:59:59Z"
}
],
"Timezone": "Europe/Madrid"
}
}
```
{% endtab %}
{% endtabs %}
**Impacto Potencial**: Efecto directo en la detecci√≥n de patrones inusuales o amenazas de seguridad.

### **`cloudwatch:DeleteDashboards`,¬†`cloudwatch:PutDashboard`**

Un atacante podr√≠a comprometer las capacidades de monitoreo y visualizaci√≥n de una organizaci√≥n al crear, modificar o eliminar sus paneles de control. Estos permisos podr√≠an ser aprovechados para eliminar la visibilidad cr√≠tica sobre el rendimiento y la salud de los sistemas, alterar los paneles de control para mostrar datos incorrectos u ocultar actividades maliciosas.
```bash
aws cloudwatch delete-dashboards --dashboard-names <value>
aws cloudwatch put-dashboard --dashboard-name <value> --dashboard-body <value>
```
**Impacto potencial**: P√©rdida de visibilidad de monitoreo e informaci√≥n enga√±osa.

### **`cloudwatch:DeleteInsightRules`,¬†`cloudwatch:PutInsightRule` ,`cloudwatch:PutManagedInsightRule`**

Las reglas de Insight se utilizan para detectar anomal√≠as, optimizar el rendimiento y gestionar recursos de manera efectiva. Al eliminar reglas de Insight existentes, un atacante podr√≠a eliminar capacidades cr√≠ticas de monitoreo, dejando el sistema ciego ante problemas de rendimiento y amenazas de seguridad. Adem√°s, un atacante podr√≠a crear o modificar reglas de Insight para generar datos enga√±osos u ocultar actividades maliciosas, lo que llevar√≠a a diagn√≥sticos incorrectos y respuestas inapropiadas por parte del equipo de operaciones.
```bash
aws cloudwatch delete-insight-rules --rule-names <value>
aws cloudwatch put-insight-rule --rule-name <value> --rule-definition <value> [--rule-state <value>]
aws cloudwatch put-managed-insight-rules --managed-rules <value>
```
**Impacto Potencial**: Dificultad para detectar y responder a problemas de rendimiento y anomal√≠as, toma de decisiones err√≥nea y posiblemente ocultar actividades maliciosas o fallos del sistema.

### **`cloudwatch:DisableInsightRules`,¬†`cloudwatch:EnableInsightRules`**

Al deshabilitar reglas cr√≠ticas de insight, un atacante podr√≠a dejar ciega a la organizaci√≥n respecto a m√©tricas clave de rendimiento y seguridad. Por otro lado, al habilitar o configurar reglas enga√±osas, podr√≠a ser posible generar datos falsos, crear ruido u ocultar actividades maliciosas.
```bash
aws cloudwatch disable-insight-rules --rule-names <value>
aws cloudwatch enable-insight-rules --rule-names <value>
```
**Impacto Potencial**: Confusi√≥n entre el equipo de operaciones, lo que lleva a respuestas tard√≠as a problemas reales y acciones innecesarias basadas en alertas falsas.

### **`cloudwatch:DeleteMetricStream`, `cloudwatch:PutMetricStream`, `cloudwatch:PutMetricData`**

Un atacante con los permisos **`cloudwatch:DeleteMetricStream`**, **`cloudwatch:PutMetricStream`** ser√≠a capaz de crear y eliminar flujos de datos m√©tricos, comprometiendo la seguridad, monitorizaci√≥n e integridad de los datos:

- **Crear flujos maliciosos**: Crear flujos m√©tricos para enviar datos sensibles a destinos no autorizados.
- **Manipulaci√≥n de recursos**: La creaci√≥n de nuevos flujos m√©tricos con datos excesivos podr√≠a generar mucho ruido, causando alertas incorrectas y enmascarando problemas reales.
- **Disrupci√≥n de la monitorizaci√≥n**: Al eliminar flujos m√©tricos, los atacantes interrumpir√≠an el flujo continuo de datos de monitorizaci√≥n. De esta manera, sus actividades maliciosas estar√≠an efectivamente ocultas.

De manera similar, con el permiso **`cloudwatch:PutMetricData`**, ser√≠a posible agregar datos a un flujo m√©trico. Esto podr√≠a llevar a un DoS debido a la cantidad de datos incorrectos agregados, volvi√©ndolo completamente in√∫til.
```bash
aws cloudwatch delete-metric-stream --name <value>
aws cloudwatch put-metric-stream --name <value> [--include-filters <value>] [--exclude-filters <value>] --firehose-arn <value> --role-arn <value> --output-format <value>
aws cloudwatch put-metric-data --namespace <value> [--metric-data <value>] [--metric-name <value>] [--timestamp <value>] [--unit <value>] [--value <value>] [--dimensions <value>]
```
Ejemplo de agregar datos correspondientes a un 70% de utilizaci√≥n de CPU en una instancia EC2 dada:
```bash
aws cloudwatch put-metric-data --namespace "AWS/EC2" --metric-name "CPUUtilization" --value 70 --unit "Percent" --dimensions "InstanceId=i-0123456789abcdefg"
```
**Impacto Potencial**: Disrupci√≥n en el flujo de datos de monitoreo, afectando la detecci√≥n de anomal√≠as e incidentes, manipulaci√≥n de recursos y aumento de costos debido a la creaci√≥n de flujos m√©tricos excesivos.

### **`cloudwatch:StopMetricStreams`,¬†`cloudwatch:StartMetricStreams`**

Un atacante podr√≠a controlar el flujo de los flujos de datos m√©tricos afectados (cada flujo de datos si no hay restricci√≥n de recursos). Con el permiso **`cloudwatch:StopMetricStreams`**, los atacantes podr√≠an ocultar sus actividades maliciosas deteniendo flujos m√©tricos cr√≠ticos.
```bash
aws cloudwatch stop-metric-streams --names <value>
aws cloudwatch start-metric-streams --names <value>
```
**Impacto Potencial**: Interrupci√≥n en el flujo de datos de monitoreo, afectando la detecci√≥n de anomal√≠as e incidentes.

### **`cloudwatch:TagResource`,¬†`cloudwatch:UntagResource`**

Un atacante podr√≠a agregar, modificar o eliminar etiquetas de los recursos de CloudWatch (actualmente solo alarmas y reglas de Contributor Insights). Esto podr√≠a interrumpir las pol√≠ticas de control de acceso de su organizaci√≥n basadas en etiquetas.
```bash
aws cloudwatch tag-resource --resource-arn <value> --tags <value>
aws cloudwatch untag-resource --resource-arn <value> --tag-keys <value>
```
**Impacto Potencial**: Disrupci√≥n de pol√≠ticas de control de acceso basadas en etiquetas.

## Referencias

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazoncloudwatch.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazoncloudwatch.html)
* [https://docs.aws.amazon.com/es_es/AmazonCloudWatch/latest/monitoring/cloudwatch_concepts.html#Metric](https://docs.aws.amazon.com/es_es/AmazonCloudWatch/latest/monitoring/cloudwatch_concepts.html#Metric)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
