# AWS - Enumera√ß√£o do CloudWatch

{% hint style="success" %}
Aprenda e pratique Hacking AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

- Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
- **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
- **Compartilhe truques de hacking enviando PRs para** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## CloudWatch

**CloudWatch** **coleta** dados de monitoramento e operacionais na forma de logs/m√©tricas/eventos, fornecendo uma **vis√£o unificada dos recursos**, aplicativos e servi√ßos da AWS.\
Os Eventos de Log do CloudWatch t√™m uma **limita√ß√£o de tamanho de 256KB em cada linha de log**.\
√â poss√≠vel configurar **alarmes de alta resolu√ß√£o**, visualizar **logs** e **m√©tricas** lado a lado, tomar a√ß√µes automatizadas, solucionar problemas e descobrir insights para otimizar aplicativos.

√â poss√≠vel monitorar, por exemplo, logs do CloudTrail. Eventos que s√£o monitorados:

- Altera√ß√µes em Grupos de Seguran√ßa e NACLs
- Inicializa√ß√£o, Parada, reinicializa√ß√£o e termina√ß√£o de inst√¢ncias EC2
- Altera√ß√µes em Pol√≠ticas de Seguran√ßa dentro do IAM e S3
- Tentativas de login malsucedidas no Console de Gerenciamento da AWS
- Chamadas de API que resultaram em autoriza√ß√£o falhada
- Filtros para pesquisa no cloudwatch: [https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

## Conceitos Chave

### Espa√ßos de Nomes

Um espa√ßo de nomes √© um cont√™iner para m√©tricas do CloudWatch. Ajuda a categorizar e isolar m√©tricas, facilitando sua gest√£o e an√°lise.

- **Exemplos**: AWS/EC2 para m√©tricas relacionadas ao EC2, AWS/RDS para m√©tricas do RDS.

### M√©tricas

M√©tricas s√£o pontos de dados coletados ao longo do tempo que representam o desempenho ou utiliza√ß√£o de recursos da AWS. As m√©tricas podem ser coletadas de servi√ßos da AWS, aplicativos personalizados ou integra√ß√µes de terceiros.

- **Exemplo**: CPUUtilization, NetworkIn, DiskReadOps.

### Dimens√µes

Dimens√µes s√£o pares de chave-valor que fazem parte das m√©tricas. Elas ajudam a identificar de forma √∫nica uma m√©trica e fornecem contexto adicional, sendo 30 o n√∫mero m√°ximo de dimens√µes que podem ser associadas a uma m√©trica. As dimens√µes tamb√©m permitem filtrar e agregar m√©tricas com base em atributos espec√≠ficos.

- **Exemplo**: Para inst√¢ncias EC2, as dimens√µes podem incluir InstanceId, InstanceType e AvailabilityZone.

### Estat√≠sticas

Estat√≠sticas s√£o c√°lculos matem√°ticos realizados em dados de m√©tricas para resumi-los ao longo do tempo. As estat√≠sticas comuns incluem M√©dia, Soma, M√≠nimo, M√°ximo e Contagem de Amostras.

- **Exemplo**: Calcular a utiliza√ß√£o m√©dia da CPU ao longo de um per√≠odo de uma hora.

### Unidades

Unidades s√£o o tipo de medida associado a uma m√©trica. As unidades ajudam a fornecer contexto e significado aos dados da m√©trica. Unidades comuns incluem Percentual, Bytes, Segundos, Contagem.

- **Exemplo**: CPUUtilization pode ser medida em Percentual, enquanto NetworkIn pode ser medida em Bytes.

## Recursos do CloudWatch

### Painel de Controle

Os **Pain√©is de Controle do CloudWatch** fornecem **visualiza√ß√µes personaliz√°veis de suas m√©tricas do AWS CloudWatch**. √â poss√≠vel criar e configurar pain√©is para visualizar dados e monitorar recursos em uma √∫nica visualiza√ß√£o, combinando diferentes m√©tricas de v√°rios servi√ßos da AWS.

**Recursos Principais**:

- **Widgets**: Blocos de constru√ß√£o de pain√©is, incluindo gr√°ficos, texto, alarmes e muito mais.
- **Personaliza√ß√£o**: O layout e o conte√∫do podem ser personalizados para atender √†s necessidades espec√≠ficas de monitoramento.

**Exemplo de Caso de Uso**:

- Um √∫nico painel mostrando m√©tricas-chave para todo o seu ambiente AWS, incluindo inst√¢ncias EC2, bancos de dados RDS e buckets S3.

### Fluxo de M√©tricas e Dados de M√©tricas

Os **Fluxos de M√©tricas** no AWS CloudWatch permitem que voc√™ transmita continuamente m√©tricas do CloudWatch para um destino de sua escolha em tempo quase real. Isso √© particularmente √∫til para monitoramento avan√ßado, an√°lises e pain√©is personalizados usando ferramentas fora da AWS.

Os **Dados de M√©tricas** dentro dos Fluxos de M√©tricas referem-se √†s medi√ß√µes reais ou pontos de dados que est√£o sendo transmitidos. Esses pontos de dados representam v√°rias m√©tricas como utiliza√ß√£o da CPU, uso de mem√≥ria, etc., para recursos da AWS.

**Exemplo de Caso de Uso**:

- Enviando m√©tricas em tempo real para um servi√ßo de monitoramento de terceiros para an√°lise avan√ßada.
- Arquivando m√©tricas em um bucket Amazon S3 para armazenamento e conformidade de longo prazo.

### Alarme

Os **Alarmes do CloudWatch** monitoram suas m√©tricas e executam a√ß√µes com base em limites predefinidos. Quando uma m√©trica ultrapassa um limite, o alarme pode executar uma ou mais a√ß√µes, como enviar notifica√ß√µes via SNS, acionar uma pol√≠tica de dimensionamento autom√°tico ou executar uma fun√ß√£o AWS Lambda.

**Componentes Principais**:

- **Limite**: O valor no qual o alarme √© acionado.
- **Per√≠odos de Avalia√ß√£o**: O n√∫mero de per√≠odos ao longo dos quais os dados s√£o avaliados.
- **Pontos de Dados para Alarme**: O n√∫mero de per√≠odos com um limite atingido necess√°rio para acionar o alarme.
- **A√ß√µes**: O que acontece quando um estado de alarme √© acionado (por exemplo, notificar via SNS).

**Exemplo de Caso de Uso**:

- Monitorar a utiliza√ß√£o da CPU da inst√¢ncia EC2 e enviar uma notifica√ß√£o via SNS se ela exceder 80% por 5 minutos consecutivos.

### Detectores de Anomalias

Os **Detectores de Anomalias** usam aprendizado de m√°quina para detectar automaticamente anomalias em suas m√©tricas. √â poss√≠vel aplicar a detec√ß√£o de anomalias a qualquer m√©trica do CloudWatch para identificar desvios de padr√µes normais que possam indicar problemas.

**Componentes Principais**:

- **Treinamento do Modelo**: O CloudWatch usa dados hist√≥ricos para treinar um modelo e estabelecer como se parece o comportamento normal.
- **Faixa de Detec√ß√£o de Anomalias**: Uma representa√ß√£o visual da faixa esperada de valores para uma m√©trica.

**Exemplo de Caso de Uso**:

- Detectar padr√µes incomuns de utiliza√ß√£o da CPU em uma inst√¢ncia EC2 que possam indicar uma viola√ß√£o de seguran√ßa ou um problema de aplicativo.

### Regras de Insight e Regras de Insight Gerenciadas

As **Regras de Insight** permitem identificar tend√™ncias, detectar picos ou outros padr√µes de interesse em seus dados de m√©tricas usando **express√µes matem√°ticas poderosas** para definir as condi√ß√µes sob as quais as a√ß√µes devem ser tomadas. Essas regras podem ajudar a identificar anomalias ou comportamentos incomuns no desempenho e utiliza√ß√£o de seus recursos.

As **Regras de Insight Gerenciadas** s√£o **regras de insight pr√©-configuradas fornecidas pela AWS**. Elas s√£o projetadas para monitorar servi√ßos espec√≠ficos da AWS ou casos de uso comuns e podem ser habilitadas sem a necessidade de configura√ß√£o detalhada.

**Exemplo de Caso de Uso**:

- Monitorando o Desempenho do RDS: Habilitar uma regra de insight gerenciada para o Amazon RDS que monitora indicadores-chave de desempenho como utiliza√ß√£o da CPU, uso de mem√≥ria e E/S de disco. Se alguma dessas m√©tricas exceder os limites operacionais seguros, a regra pode acionar um alerta ou uma a√ß√£o de mitiga√ß√£o automatizada.

### Logs do CloudWatch <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

Permite **agregar e monitorar logs de aplicativos** e sistemas de **servi√ßos da AWS** (incluindo CloudTrail) e **de aplicativos/sistemas** (**o Agente CloudWatch** pode ser instalado em um host). Os logs podem ser **armazenados indefinidamente** (dependendo das configura√ß√µes do Grupo de Logs) e podem ser exportados.

**Elementos**:

| **Grupo de Logs**       | Uma **cole√ß√£o de fluxos de log** que compartilham as mesmas configura√ß√µes de reten√ß√£o, monitoramento e controle de acesso |
| ----------------------- | --------------------------------------------------------------------------------------------------------------------------- |
| **Fluxo de Logs**       | Uma sequ√™ncia de **eventos de log** que compartilham a **mesma origem**                                                        |
| **Filtros de Assinatura** | Definem um **padr√£o de filtro que corresponde a eventos** em um determinado grupo de logs, enviando-os para um fluxo Kinesis Data Firehose, fluxo Kinesis ou uma fun√ß√£o Lambda |
### Monitoramento e Eventos do CloudWatch

O CloudWatch **b√°sico** agrega dados **a cada 5 minutos** (o **detalhado** faz isso **a cada 1 minuto**). Ap√≥s a agrega√ß√£o, ele **verifica os limites dos alarmes** no caso de precisar acionar um.\
Nesse caso, o CloudWatch pode estar preparado para enviar um evento e realizar algumas a√ß√µes autom√°ticas (fun√ß√µes AWS lambda, t√≥picos SNS, filas SQS, fluxos Kinesis)

### Instala√ß√£o do Agente

Voc√™ pode instalar agentes dentro de suas m√°quinas/containers para enviar automaticamente os logs de volta para o CloudWatch.

* **Criar** uma **fun√ß√£o** e **anex√°-la** √† **inst√¢ncia** com permiss√µes que permitam ao CloudWatch coletar dados das inst√¢ncias, al√©m de interagir com o AWS Systems Manager SSM (CloudWatchAgentAdminPolicy & AmazonEC2RoleforSSM)
* **Baixar** e **instalar** o **agente** na inst√¢ncia EC2 ([https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)). Voc√™ pode baix√°-lo de dentro da EC2 ou instal√°-lo automaticamente usando o AWS System Manager selecionando o pacote AWS-ConfigureAWSPackage
* **Configurar** e **iniciar** o Agente do CloudWatch

Um grupo de logs tem muitos fluxos. Um fluxo tem muitos eventos. E dentro de cada fluxo, os eventos s√£o garantidos de estar em ordem.

## Enumera√ß√£o
```bash
# Dashboards #

## Returns a list of the dashboards of your account
aws cloudwatch list-dashboards

## Retrieves the details of the specified dashboard
aws cloudwatch get-dashboard --dashboard-name <value>

# Metrics #

## Returns a list of the specified metric
aws cloudwatch list-metrics [--namespace <value>] [--metric-name <value>] [--dimensions <value>] [--include-linked-accounts | --no-include-linked-accounts]

## Retrieves metric data (this operation can include a CloudWatch Metrics Insights query, and one or more metric math functions)
aws cloudwatch get-metric-data --metric-data-queries <value> --start-time <value> --end-time <value>

## Retrieves statistics for the specified metric and namespace over a range of time
aws cloudwatch get-metric-statistics --namespace <value> --metric-name <value> [--dimensions <value>] --start-time <value> --end-time <value> --period <value>

## Returns a list of the metric streams of your account
aws cloudwatch list-metric-streams

## Retrieves information about the specified metric stream
aws cloudwatch get-metric-stream --name <value>

## Retrieve snapshots of the specified metric widgets
aws cloudwatch get-metric-widget-image --metric-widget <value>

# Alarms #

## Retrieves the specified alarm
aws cloudwatch describe-alarms [--alarm-names <value>] [--alarm-name-prefix <value>] [--alarm-types <value>] [--state-value <value>]

## Retrieves the alarms history, even for deleted alarms
aws cloudwatch describe-alarm-history [--alarm-name <value>] [--alarm-types <value>] [--history-item-type <ConfigurationUpdate | StateUpdate | Action>] [--start-date <value>] [--end-date <value>]

## Retrieves standard alarms based on the specified metric
aws cloudwatch escribe-alarms-for-metric --metric-name <value> --namespace <value> [--dimensions <value>]

# Anomaly Detections #

## Lists the anomaly detection models that you have created in your account
aws cloudwatch describe-anomaly-detectors [--namespace <value>] [--metric-name <value>] [--dimensions <value>]

## Lists all the Contributor Insight rules in your account
aws cloudwatch describe-insight-rules

## Retrieves the data collected over a time range for a given Contributor Insight rule
aws cloudwatch get-insight-rule-report --rule-name <value> --start-time <value> --end-time <value> --period <value>

## Lists managed Contributor Insights rules in your account for a specified resource
aws cloudwatch list-managed-insight-rules --resource-arn <value>

# Tags #

## Lists the tags associated with the specified CloudWatch resources
aws cloudwatch list-tags-for-resource --resource-arn <value>

# CloudWatch Logs #
aws logs tail "<log_group_name>" --followaws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# CloudWatch Events #
aws events list-rules
aws events describe-rule --name <name>aws events list-targets-by-rule --rule <name>aws events list-archives
aws events describe-archive --archive-name <name>aws events list-connections
aws events describe-connection --name <name>aws events list-endpoints
aws events describe-endpoint --name <name>aws events list-event-sources
aws events describe-event-source --name <name>aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## P√≥s-Explora√ß√£o / Desvio

### **`cloudwatch:DeleteAlarms`,`cloudwatch:PutMetricAlarm` ,¬†`cloudwatch:PutCompositeAlarm`**

Um atacante com essas permiss√µes poderia minar significativamente a infraestrutura de monitoramento e alerta de uma organiza√ß√£o. Ao excluir alarmes existentes, um atacante poderia desativar alertas cruciais que notificam os administradores sobre problemas cr√≠ticos de desempenho, viola√ß√µes de seguran√ßa ou falhas operacionais. Al√©m disso, ao criar ou modificar alarmes m√©tricos, o atacante tamb√©m poderia enganar os administradores com alertas falsos ou silenciar alarmes leg√≠timos, mascarando efetivamente atividades maliciosas e impedindo respostas oportunas a incidentes reais.

Al√©m disso, com a permiss√£o **`cloudwatch:PutCompositeAlarm`**, um atacante seria capaz de criar um loop ou ciclo de alarmes compostos, onde o alarme composto A depende do alarme composto B, e o alarme composto B tamb√©m depende do alarme composto A. Nesse cen√°rio, n√£o √© poss√≠vel excluir nenhum alarme composto que fa√ßa parte do ciclo porque sempre haver√° um alarme composto que depende desse alarme que voc√™ deseja excluir.
```bash
aws cloudwatch put-metric-alarm --cli-input-json <value> | --alarm-name <value> --comparison-operator <value> --evaluation-periods <value> [--datapoints-to-alarm <value>] [--threshold <value>] [--alarm-description <value>] [--alarm-actions <value>] [--metric-name <value>] [--namespace <value>] [--statistic <value>] [--dimensions <value>] [--period <value>]
aws cloudwatch delete-alarms --alarm-names <value>
aws cloudwatch put-composite-alarm --alarm-name <value> --alarm-rule <value> [--no-actions-enabled | --actions-enabled [--alarm-actions <value>] [--insufficient-data-actions <value>] [--ok-actions <value>] ]
```
O exemplo a seguir mostra como tornar um alarme de m√©trica ineficaz:

- Este alarme de m√©trica monitora a utiliza√ß√£o m√©dia da CPU de uma inst√¢ncia EC2 espec√≠fica, avalia a m√©trica a cada 300 segundos e requer 6 per√≠odos de avalia√ß√£o (total de 30 minutos). Se a utiliza√ß√£o m√©dia da CPU exceder 60% por pelo menos 4 desses per√≠odos, o alarme ser√° acionado e enviar√° uma notifica√ß√£o para o t√≥pico SNS especificado.
- Ao modificar o Limiar para ser superior a 99%, definir o Per√≠odo para 10 segundos, os Per√≠odos de Avalia√ß√£o para 8640 (j√° que 8640 per√≠odos de 10 segundos equivalem a 1 dia) e os Pontos de Dados para Alarme para 8640 tamb√©m, seria necess√°rio que a utiliza√ß√£o da CPU fosse superior a 99% a cada 10 segundos ao longo de todo o per√≠odo de 24 horas para acionar um alarme.

{% tabs %}
{% tab title="Alarme de M√©trica Original" %}
```json
{
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-01234567890123456"
}
],
"AlarmActions": [
"arn:aws:sns:us-east-1:123456789012:example_sns"
],
"ComparisonOperator": "GreaterThanThreshold",
"DatapointsToAlarm": 4,
"EvaluationPeriods": 6,
"Period": 300,
"Statistic": "Average",
"Threshold": 60,
"AlarmDescription": "CPU Utilization of i-01234567890123456 over 60%",
"AlarmName": "EC2 instance i-01234567890123456 CPU Utilization"
}
```
{% endtab %}
{% tab title="Alarme de M√©trica Modificado" %}
```json
{
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0645d6d414dadf9f8"
}
],
"AlarmActions": [],
"ComparisonOperator": "GreaterThanThreshold",
"DatapointsToAlarm": 8640,
"EvaluationPeriods": 8640,
"Period": 10,
"Statistic": "Average",
"Threshold": 99,
"AlarmDescription": "CPU Utilization of i-01234567890123456 with 60% as threshold",
"AlarmName": "Instance i-0645d6d414dadf9f8 CPU Utilization"
}

```
{% endtab %}
{% endtabs %}
**Impacto Potencial**: Falta de notifica√ß√µes para eventos cr√≠ticos, poss√≠veis problemas n√£o detectados, alertas falsos, supress√£o de alertas genu√≠nos e possivelmente detec√ß√µes perdidas de incidentes reais.

### **`cloudwatch:DeleteAlarmActions`,¬†`cloudwatch:EnableAlarmActions` , `cloudwatch:SetAlarmState`**

Ao excluir a√ß√µes de alarme, o atacante poderia impedir alertas cr√≠ticos e respostas automatizadas de serem acionadas quando um estado de alarme √© atingido, como notificar administradores ou acionar atividades de dimensionamento autom√°tico. Habilitar ou reabilitar a√ß√µes de alarme de forma inadequada tamb√©m poderia levar a comportamentos inesperados, seja reativando a√ß√µes previamente desativadas ou modificando quais a√ß√µes s√£o acionadas, potencialmente causando confus√£o e desvio na resposta a incidentes.

Al√©m disso, um atacante com permiss√£o poderia manipular estados de alarme, sendo capaz de criar alarmes falsos para distrair e confundir administradores, ou silenciar alarmes genu√≠nos para ocultar atividades maliciosas em andamento ou falhas cr√≠ticas no sistema.

- Se voc√™ usar o¬†**`SetAlarmState`**¬†em um alarme composto, n√£o √© garantido que o alarme composto retorne ao seu estado real. Ele retorna ao seu estado real apenas quando qualquer um de seus alarmes filhos muda de estado. Ele tamb√©m √© reavaliado se voc√™ atualizar sua configura√ß√£o.
```bash
aws cloudwatch disable-alarm-actions --alarm-names <value>
aws cloudwatch enable-alarm-actions --alarm-names <value>
aws cloudwatch set-alarm-state --alarm-name <value> --state-value <OK | ALARM | INSUFFICIENT_DATA> --state-reason <value> [--state-reason-data <value>]
```
**Impacto Potencial**: Falta de notifica√ß√µes para eventos cr√≠ticos, poss√≠veis problemas n√£o detectados, alertas falsos, supress√£o de alertas leg√≠timos e possivelmente detec√ß√µes perdidas de incidentes reais.

### **`cloudwatch:DeleteAnomalyDetector`,¬†`cloudwatch:PutAnomalyDetector`**

Um atacante seria capaz de comprometer a capacidade de detec√ß√£o e resposta a padr√µes ou anomalias incomuns em dados m√©tricos. Ao excluir detectores de anomalias existentes, um atacante poderia desativar mecanismos cr√≠ticos de alerta; e ao cri√°-los ou modific√°-los, seria capaz de configurar incorretamente ou criar falsos positivos para distrair ou sobrecarregar a monitoriza√ß√£o.
```bash
aws cloudwatch delete-anomaly-detector [--cli-input-json <value> | --namespace <value> --metric-name <value> --dimensions <value> --stat <value>]
aws cloudwatch put-anomaly-detector [--cli-input-json <value> | --namespace <value> --metric-name <value> --dimensions <value> --stat <value> --configuration <value> --metric-characteristics <value>]
```
O exemplo a seguir mostra como tornar um detector de anomalias de m√©tricas ineficaz. Este detector de anomalias de m√©tricas monitora a utiliza√ß√£o m√©dia da CPU de uma inst√¢ncia EC2 espec√≠fica e, apenas adicionando o par√¢metro "ExcludedTimeRanges" com o intervalo de tempo desejado, seria suficiente para garantir que o detector de anomalias n√£o analise ou emita alertas sobre quaisquer dados relevantes durante esse per√≠odo.
```json
{
"SingleMetricAnomalyDetector": {
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Stat": "Average",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0123456789abcdefg"
}
]
}
}
```
{% endtab %}
{% tab title="Detector de Anomalias de M√©tricas Modificado" %}
```json
{
"SingleMetricAnomalyDetector": {
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Stat": "Average",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0123456789abcdefg"
}
]
},
"Configuration": {
"ExcludedTimeRanges": [
{
"StartTime": "2023-01-01T00:00:00Z",
"EndTime": "2053-01-01T23:59:59Z"
}
],
"Timezone": "Europe/Madrid"
}
}
```
{% endtab %}
{% endtabs %}
**Impacto Potencial**: Efeito direto na detec√ß√£o de padr√µes incomuns ou amea√ßas de seguran√ßa.

### **`cloudwatch:DeleteDashboards`,¬†`cloudwatch:PutDashboard`**

Um atacante seria capaz de comprometer as capacidades de monitoramento e visualiza√ß√£o de uma organiza√ß√£o criando, modificando ou excluindo seus pain√©is. Essas permiss√µes poderiam ser aproveitadas para remover a visibilidade cr√≠tica sobre o desempenho e a sa√∫de dos sistemas, alterar pain√©is para exibir dados incorretos ou ocultar atividades maliciosas.
```bash
aws cloudwatch delete-dashboards --dashboard-names <value>
aws cloudwatch put-dashboard --dashboard-name <value> --dashboard-body <value>
```
**Impacto Potencial**: Perda de visibilidade de monitoramento e informa√ß√µes enganosas.

### **`cloudwatch:DeleteInsightRules`, `cloudwatch:PutInsightRule`, `cloudwatch:PutManagedInsightRule`**

As regras de insight s√£o usadas para detectar anomalias, otimizar o desempenho e gerenciar recursos de forma eficaz. Ao excluir regras de insight existentes, um atacante poderia remover capacidades cr√≠ticas de monitoramento, deixando o sistema cego para problemas de desempenho e amea√ßas de seguran√ßa. Al√©m disso, um atacante poderia criar ou modificar regras de insight para gerar dados enganosos ou ocultar atividades maliciosas, levando a diagn√≥sticos incorretos e respostas inadequadas da equipe de opera√ß√µes.
```bash
aws cloudwatch delete-insight-rules --rule-names <value>
aws cloudwatch put-insight-rule --rule-name <value> --rule-definition <value> [--rule-state <value>]
aws cloudwatch put-managed-insight-rules --managed-rules <value>
```
**Impacto Potencial**: Dificuldade em detectar e responder a problemas de desempenho e anomalias, tomada de decis√µes equivocadas e possivelmente oculta√ß√£o de atividades maliciosas ou falhas no sistema.

### **`cloudwatch:DisableInsightRules`,¬†`cloudwatch:EnableInsightRules`**

Ao desativar regras cr√≠ticas de insight, um atacante poderia efetivamente deixar a organiza√ß√£o cega em rela√ß√£o a m√©tricas importantes de desempenho e seguran√ßa. Por outro lado, ao habilitar ou configurar regras enganosas, poderia ser poss√≠vel gerar dados falsos, criar ru√≠do ou ocultar atividades maliciosas.
```bash
aws cloudwatch disable-insight-rules --rule-names <value>
aws cloudwatch enable-insight-rules --rule-names <value>
```
**Impacto Potencial**: Confus√£o entre a equipe de opera√ß√µes, levando a respostas atrasadas para problemas reais e a√ß√µes desnecess√°rias com base em alertas falsos.

### **`cloudwatch:DeleteMetricStream`, `cloudwatch:PutMetricStream`, `cloudwatch:PutMetricData`**

Um atacante com as permiss√µes **`cloudwatch:DeleteMetricStream`, `cloudwatch:PutMetricStream`** seria capaz de criar e excluir fluxos de dados m√©tricos, comprometendo a seguran√ßa, monitoramento e integridade dos dados:

- **Criar fluxos maliciosos**: Criar fluxos m√©tricos para enviar dados sens√≠veis para destinos n√£o autorizados.
- **Manipula√ß√£o de recursos**: A cria√ß√£o de novos fluxos m√©tricos com dados excessivos poderia gerar muito ru√≠do, causando alertas incorretos e mascarando problemas reais.
- **Disrup√ß√£o do monitoramento**: Ao excluir fluxos m√©tricos, os atacantes interromperiam o fluxo cont√≠nuo de dados de monitoramento. Dessa forma, suas atividades maliciosas seriam efetivamente ocultadas.

Da mesma forma, com a permiss√£o **`cloudwatch:PutMetricData`**, seria poss√≠vel adicionar dados a um fluxo m√©trico. Isso poderia levar a um DoS devido √† quantidade de dados impr√≥prios adicionados, tornando-o completamente in√∫til.
```bash
aws cloudwatch delete-metric-stream --name <value>
aws cloudwatch put-metric-stream --name <value> [--include-filters <value>] [--exclude-filters <value>] --firehose-arn <value> --role-arn <value> --output-format <value>
aws cloudwatch put-metric-data --namespace <value> [--metric-data <value>] [--metric-name <value>] [--timestamp <value>] [--unit <value>] [--value <value>] [--dimensions <value>]
```
Exemplo de adicionar dados correspondentes a 70% de utiliza√ß√£o da CPU em uma inst√¢ncia EC2 espec√≠fica:
```bash
aws cloudwatch put-metric-data --namespace "AWS/EC2" --metric-name "CPUUtilization" --value 70 --unit "Percent" --dimensions "InstanceId=i-0123456789abcdefg"
```
**Impacto Potencial**: Disrup√ß√£o no fluxo de dados de monitoramento, impactando a detec√ß√£o de anomalias e incidentes, manipula√ß√£o de recursos e aumento de custos devido √† cria√ß√£o de fluxos de m√©tricas excessivos.

### **`cloudwatch:StopMetricStreams`,¬†`cloudwatch:StartMetricStreams`**

Um atacante poderia controlar o fluxo dos fluxos de dados de m√©tricas afetados (cada fluxo de dados se n√£o houver restri√ß√£o de recursos). Com a permiss√£o **`cloudwatch:StopMetricStreams`**, os atacantes poderiam ocultar suas atividades maliciosas interrompendo fluxos de m√©tricas cr√≠ticas.
```bash
aws cloudwatch stop-metric-streams --names <value>
aws cloudwatch start-metric-streams --names <value>
```
**Impacto Potencial**: Disrup√ß√£o no fluxo de dados de monitoramento, impactando a detec√ß√£o de anomalias e incidentes.

### **`cloudwatch:TagResource`,¬†`cloudwatch:UntagResource`**

Um atacante seria capaz de adicionar, modificar ou remover tags de recursos do CloudWatch (atualmente apenas alarmes e regras de Contributor Insights). Isso poderia interromper as pol√≠ticas de controle de acesso da sua organiza√ß√£o com base em tags.
```bash
aws cloudwatch tag-resource --resource-arn <value> --tags <value>
aws cloudwatch untag-resource --resource-arn <value> --tag-keys <value>
```
**Impacto Potencial**: Disrup√ß√£o de pol√≠ticas de controle de acesso baseadas em tags.

## Refer√™ncias

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazoncloudwatch.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazoncloudwatch.html)
* [https://docs.aws.amazon.com/es_es/AmazonCloudWatch/latest/monitoring/cloudwatch_concepts.html#Metric](https://docs.aws.amazon.com/es_es/AmazonCloudWatch/latest/monitoring/cloudwatch_concepts.html#Metric)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Treinamento AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Treinamento GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
