# AWS - Enum√©ration CloudWatch

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert Red Team AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## CloudWatch

**CloudWatch** **collecte** des donn√©es de surveillance et op√©rationnelles sous forme de journaux/m√©triques/√©v√©nements fournissant une **vue unifi√©e des ressources AWS**, des applications et des services.\
Les √©v√©nements de journalisation CloudWatch ont une **limite de taille de 256 Ko sur chaque ligne de journal**.\
Il peut d√©finir des **alarmes √† haute r√©solution**, visualiser des **journaux** et des **m√©triques** c√¥te √† c√¥te, prendre des mesures automatis√©es, r√©soudre les probl√®mes et d√©couvrir des informations pour optimiser les applications.

Vous pouvez surveiller par exemple les journaux de CloudTrail. √âv√©nements surveill√©s :

* Modifications des groupes de s√©curit√© et des NACL
* D√©marrage, arr√™t, red√©marrage et terminaison des instances EC2
* Modifications des politiques de s√©curit√© dans IAM et S3
* Tentatives de connexion √©chou√©es √† la console de gestion AWS
* Appels API ayant entra√Æn√© une autorisation √©chou√©e
* Filtres de recherche dans CloudWatch : [https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

## Concepts cl√©s

### Espaces de noms

Un espace de noms est un conteneur pour les m√©triques CloudWatch. Il aide √† cat√©goriser et isoler les m√©triques, facilitant ainsi leur gestion et leur analyse.

- **Exemples** : AWS/EC2 pour les m√©triques li√©es √† EC2, AWS/RDS pour les m√©triques RDS.

### M√©triques

Les m√©triques sont des points de donn√©es collect√©s au fil du temps qui repr√©sentent les performances ou l'utilisation des ressources AWS. Les m√©triques peuvent √™tre collect√©es √† partir de services AWS, d'applications personnalis√©es ou d'int√©grations tierces.

- **Exemple** : CPUUtilization, NetworkIn, DiskReadOps.

### Dimensions

Les dimensions sont des paires cl√©-valeur qui font partie des m√©triques. Elles aident √† identifier de mani√®re unique une m√©trique et fournissent un contexte suppl√©mentaire, 30 √©tant le nombre maximum de dimensions pouvant √™tre associ√©es √† une m√©trique. Les dimensions permettent √©galement de filtrer et d'agr√©ger les m√©triques en fonction d'attributs sp√©cifiques.

- **Exemple** : Pour les instances EC2, les dimensions peuvent inclure InstanceId, InstanceType et AvailabilityZone.

### Statistiques

Les statistiques sont des calculs math√©matiques effectu√©s sur les donn√©es de m√©triques pour les r√©sumer dans le temps. Les statistiques courantes incluent la Moyenne, la Somme, le Minimum, le Maximum et le Nombre d'√©chantillons.

- **Exemple** : Calculer l'utilisation moyenne du CPU sur une p√©riode d'une heure.

### Unit√©s

Les unit√©s sont le type de mesure associ√© √† une m√©trique. Les unit√©s aident √† fournir un contexte et une signification aux donn√©es de la m√©trique. Les unit√©s courantes incluent le Pourcentage, les Octets, les Secondes, le Comptage.

- **Exemple** : CPUUtilization peut √™tre mesur√© en Pourcentage, tandis que NetworkIn peut √™tre mesur√© en Octets.

## Fonctionnalit√©s de CloudWatch

### Tableau de bord

Les **tableaux de bord CloudWatch** fournissent des **vues personnalisables de vos m√©triques AWS CloudWatch**. Il est possible de cr√©er et de configurer des tableaux de bord pour visualiser les donn√©es et surveiller les ressources dans une seule vue, en combinant diff√©rentes m√©triques de divers services AWS.

**Fonctionnalit√©s cl√©s** :

- **Widgets** : Blocs de construction des tableaux de bord, comprenant des graphiques, du texte, des alarmes, et plus encore.
- **Personnalisation** : La disposition et le contenu peuvent √™tre personnalis√©s pour r√©pondre √† des besoins de surveillance sp√©cifiques.

**Exemple d'utilisation** :

- Un tableau de bord unique montrant les principales m√©triques de tout votre environnement AWS, y compris les instances EC2, les bases de donn√©es RDS et les compartiments S3.

### Flux de m√©triques et donn√©es de m√©triques

Les **flux de m√©triques** dans AWS CloudWatch vous permettent de diffuser en continu des m√©triques CloudWatch vers une destination de votre choix en quasi temps r√©el. Cela est particuli√®rement utile pour la surveillance avanc√©e, l'analyse et les tableaux de bord personnalis√©s √† l'aide d'outils en dehors d'AWS.

Les **donn√©es de m√©triques** √† l'int√©rieur des flux de m√©triques font r√©f√©rence aux mesures r√©elles ou aux points de donn√©es qui sont diffus√©s. Ces points de donn√©es repr√©sentent diverses m√©triques telles que l'utilisation du CPU, l'utilisation de la m√©moire, etc., pour les ressources AWS.

**Exemple d'utilisation** :

- Envoi de m√©triques en temps r√©el √† un service de surveillance tiers pour une analyse avanc√©e.
- Archivage de m√©triques dans un compartiment Amazon S3 pour un stockage √† long terme et la conformit√©.

### Alarme

Les **alarmes CloudWatch** surveillent vos m√©triques et effectuent des actions en fonction de seuils pr√©d√©finis. Lorsqu'une m√©trique d√©passe un seuil, l'alarme peut effectuer une ou plusieurs actions telles que l'envoi de notifications via SNS, le d√©clenchement d'une strat√©gie de mise √† l'√©chelle automatique ou l'ex√©cution d'une fonction AWS Lambda.

**Composants cl√©s** :

- **Seuil** : La valeur √† laquelle l'alarme se d√©clenche.
- **P√©riodes d'√©valuation** : Le nombre de p√©riodes sur lesquelles les donn√©es sont √©valu√©es.
- **Points de donn√©es pour l'alarme** : Le nombre de p√©riodes avec un seuil atteint n√©cessaire pour d√©clencher l'alarme.
- **Actions** : Ce qui se passe lorsque l'√©tat d'une alarme est d√©clench√© (par exemple, notification via SNS).

**Exemple d'utilisation** :

- Surveillance de l'utilisation du CPU d'une instance EC2 et envoi d'une notification via SNS si elle d√©passe 80 % pendant 5 minutes cons√©cutives.

### D√©tecteurs d'anomalies

Les **d√©tecteurs d'anomalies** utilisent l'apprentissage automatique pour d√©tecter automatiquement les anomalies dans vos m√©triques. Vous pouvez appliquer la d√©tection d'anomalies √† n'importe quelle m√©trique CloudWatch pour identifier les √©carts par rapport aux mod√®les normaux qui pourraient indiquer des probl√®mes.

**Composants cl√©s** :

- **Entra√Ænement du mod√®le** : CloudWatch utilise des donn√©es historiques pour entra√Æner un mod√®le et √©tablir √† quoi ressemble un comportement normal.
- **Bande de d√©tection d'anomalies** : Une repr√©sentation visuelle de la plage de valeurs attendue pour une m√©trique.

**Exemple d'utilisation** :

- D√©tection de mod√®les inhabituels d'utilisation du CPU dans une instance EC2 qui pourraient indiquer une violation de s√©curit√© ou un probl√®me d'application.

### R√®gles Insight et R√®gles Insight g√©r√©es

Les **r√®gles Insight** vous permettent d'identifier des tendances, de d√©tecter des pics ou d'autres mod√®les d'int√©r√™t dans vos donn√©es de m√©triques en utilisant des **expressions math√©matiques puissantes** pour d√©finir les conditions dans lesquelles des actions doivent √™tre prises. Ces r√®gles peuvent vous aider √† identifier des anomalies ou des comportements inhabituels dans les performances et l'utilisation de vos ressources.

Les **r√®gles Insight g√©r√©es** sont des **r√®gles Insight pr√©configur√©es fournies par AWS**. Elles sont con√ßues pour surveiller des services AWS sp√©cifiques ou des cas d'utilisation courants et peuvent √™tre activ√©es sans n√©cessiter de configuration d√©taill√©e.

**Exemple d'utilisation** :

- Surveillance des performances de RDS : Activer une r√®gle Insight g√©r√©e pour Amazon RDS qui surveille des indicateurs cl√©s de performance tels que l'utilisation du CPU, l'utilisation de la m√©moire et les E/S disque. Si l'une de ces m√©triques d√©passe des seuils op√©rationnels s√ªrs, la r√®gle peut d√©clencher une alerte ou une action d'att√©nuation automatis√©e.

### Journaux CloudWatch <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

Permet d'**agr√©ger et de surveiller les journaux des applications** et des syst√®mes des **services AWS** (y compris CloudTrail) et des **applications/syst√®mes** (**l'agent CloudWatch** peut √™tre install√© sur un h√¥te). Les journaux peuvent √™tre **stock√©s ind√©finiment** (selon les param√®tres du groupe de journaux) et peuvent √™tre export√©s.

**√âl√©ments** :

| **Groupe de journaux**   | Une **collection de flux de journaux** partageant les m√™mes param√®tres de r√©tention, de surveillance et de contr√¥le d'acc√®s                                      |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Flux de journaux**     | Une s√©quence d'**√©v√©nements de journal** partageant la **m√™me source**                                                                                       |
| **Filtres d'abonnement** | D√©finir un **motif de filtre qui correspond aux √©v√©nements** dans un groupe de journaux particulier, les envoyer vers un flux Kinesis Data Firehose, un flux Kinesis ou une fonction Lambda |
### Surveillance et √©v√©nements CloudWatch

CloudWatch **de base** agr√®ge les donn√©es **toutes les 5 minutes** (celui **d√©taill√©** le fait **toutes les 1 minute**). Apr√®s l'agr√©gation, il **v√©rifie les seuils des alarmes** au cas o√π il devrait en d√©clencher une.\
Dans ce cas, CloudWatch peut √™tre configur√© pour envoyer un √©v√©nement et effectuer des actions automatiques (fonctions AWS Lambda, sujets SNS, files SQS, flux Kinesis)

### Installation de l'agent

Vous pouvez installer des agents √† l'int√©rieur de vos machines/containers pour envoyer automatiquement les journaux √† CloudWatch.

* **Cr√©ez** un **r√¥le** et **attachez**-le √† l'**instance** avec des autorisations permettant √† CloudWatch de collecter des donn√©es des instances en plus d'interagir avec le gestionnaire de syst√®mes AWS SSM (CloudWatchAgentAdminPolicy & AmazonEC2RoleforSSM)
* **T√©l√©chargez** et **installez** l'**agent** sur l'instance EC2 ([https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)). Vous pouvez le t√©l√©charger depuis l'int√©rieur de l'EC2 ou l'installer automatiquement en utilisant AWS System Manager en s√©lectionnant le package AWS-ConfigureAWSPackage
* **Configurez** et **d√©marrez** l'agent CloudWatch

Un groupe de journaux a de nombreux flux. Un flux a de nombreux √©v√©nements. Et √† l'int√©rieur de chaque flux, les √©v√©nements sont garantis d'√™tre dans l'ordre.

## √ânum√©ration
```bash
# Dashboards #

## Returns a list of the dashboards of your account
aws cloudwatch list-dashboards

## Retrieves the details of the specified dashboard
aws cloudwatch get-dashboard --dashboard-name <value>

# Metrics #

## Returns a list of the specified metric
aws cloudwatch list-metrics [--namespace <value>] [--metric-name <value>] [--dimensions <value>] [--include-linked-accounts | --no-include-linked-accounts]

## Retrieves metric data (this operation can include a CloudWatch Metrics Insights query, and one or more metric math functions)
aws cloudwatch get-metric-data --metric-data-queries <value> --start-time <value> --end-time <value>

## Retrieves statistics for the specified metric and namespace over a range of time
aws cloudwatch get-metric-statistics --namespace <value> --metric-name <value> [--dimensions <value>] --start-time <value> --end-time <value> --period <value>

## Returns a list of the metric streams of your account
aws cloudwatch list-metric-streams

## Retrieves information about the specified metric stream
aws cloudwatch get-metric-stream --name <value>

## Retrieve snapshots of the specified metric widgets
aws cloudwatch get-metric-widget-image --metric-widget <value>

# Alarms #

## Retrieves the specified alarm
aws cloudwatch describe-alarms [--alarm-names <value>] [--alarm-name-prefix <value>] [--alarm-types <value>] [--state-value <value>]

## Retrieves the alarms history, even for deleted alarms
aws cloudwatch describe-alarm-history [--alarm-name <value>] [--alarm-types <value>] [--history-item-type <ConfigurationUpdate | StateUpdate | Action>] [--start-date <value>] [--end-date <value>]

## Retrieves standard alarms based on the specified metric
aws cloudwatch escribe-alarms-for-metric --metric-name <value> --namespace <value> [--dimensions <value>]

# Anomaly Detections #

## Lists the anomaly detection models that you have created in your account
aws cloudwatch describe-anomaly-detectors [--namespace <value>] [--metric-name <value>] [--dimensions <value>]

## Lists all the Contributor Insight rules in your account
aws cloudwatch describe-insight-rules

## Retrieves the data collected over a time range for a given Contributor Insight rule
aws cloudwatch get-insight-rule-report --rule-name <value> --start-time <value> --end-time <value> --period <value>

## Lists managed Contributor Insights rules in your account for a specified resource
aws cloudwatch list-managed-insight-rules --resource-arn <value>

# Tags #

## Lists the tags associated with the specified CloudWatch resources
aws cloudwatch list-tags-for-resource --resource-arn <value>

# CloudWatch Logs #
aws logs tail "<log_group_name>" --followaws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# CloudWatch Events #
aws events list-rules
aws events describe-rule --name <name>aws events list-targets-by-rule --rule <name>aws events list-archives
aws events describe-archive --archive-name <name>aws events list-connections
aws events describe-connection --name <name>aws events list-endpoints
aws events describe-endpoint --name <name>aws events list-event-sources
aws events describe-event-source --name <name>aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## Post-Exploitation / Contournement

### **`cloudwatch:DeleteAlarms`,`cloudwatch:PutMetricAlarm` ,¬†`cloudwatch:PutCompositeAlarm`**

Un attaquant avec ces autorisations pourrait s√©rieusement compromettre l'infrastructure de surveillance et d'alerte d'une organisation. En supprimant des alarmes existantes, un attaquant pourrait d√©sactiver des alertes cruciales qui informent les administrateurs des probl√®mes de performance critiques, des violations de s√©curit√© ou des d√©faillances op√©rationnelles. De plus, en cr√©ant ou en modifiant des alarmes m√©triques, l'attaquant pourrait √©galement induire en erreur les administrateurs avec de fausses alertes ou silencier des alarmes l√©gitimes, masquant ainsi les activit√©s malveillantes et emp√™chant des r√©ponses rapides aux incidents r√©els.

De plus, avec l'autorisation **`cloudwatch:PutCompositeAlarm`**, un attaquant serait capable de cr√©er une boucle ou un cycle d'alarmes composites, o√π l'alarme composite A d√©pend de l'alarme composite B, et l'alarme composite B d√©pend √©galement de l'alarme composite A. Dans ce sc√©nario, il n'est pas possible de supprimer une alarme composite qui fait partie du cycle car il y a toujours une alarme composite qui d√©pend de cette alarme que vous souhaitez supprimer.
```bash
aws cloudwatch put-metric-alarm --cli-input-json <value> | --alarm-name <value> --comparison-operator <value> --evaluation-periods <value> [--datapoints-to-alarm <value>] [--threshold <value>] [--alarm-description <value>] [--alarm-actions <value>] [--metric-name <value>] [--namespace <value>] [--statistic <value>] [--dimensions <value>] [--period <value>]
aws cloudwatch delete-alarms --alarm-names <value>
aws cloudwatch put-composite-alarm --alarm-name <value> --alarm-rule <value> [--no-actions-enabled | --actions-enabled [--alarm-actions <value>] [--insufficient-data-actions <value>] [--ok-actions <value>] ]
```
Le suivant exemple montre comment rendre une alarme m√©trique inefficace :

- Cette alarme m√©trique surveille l'utilisation moyenne du processeur d'une instance EC2 sp√©cifique, √©value la m√©trique toutes les 300 secondes et n√©cessite 6 p√©riodes d'√©valuation (total de 30 minutes). Si l'utilisation moyenne du processeur d√©passe 60 % pendant au moins 4 de ces p√©riodes, l'alarme se d√©clenchera et enverra une notification au sujet SNS sp√©cifi√©.
- En modifiant le Seuil pour √™tre sup√©rieur √† 99 %, en d√©finissant la P√©riode √† 10 secondes, les P√©riodes d'√©valuation √† 8640 (puisque 8640 p√©riodes de 10 secondes √©quivalent √† 1 jour), et les Points de donn√©es √† Alarmer √† 8640 √©galement, il serait n√©cessaire que l'utilisation du processeur soit sup√©rieure √† 99 % toutes les 10 secondes pendant toute la p√©riode de 24 heures pour d√©clencher une alarme.

{% tabs %}
{% tab title="Alarme M√©trique Originale" %}
```json
{
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-01234567890123456"
}
],
"AlarmActions": [
"arn:aws:sns:us-east-1:123456789012:example_sns"
],
"ComparisonOperator": "GreaterThanThreshold",
"DatapointsToAlarm": 4,
"EvaluationPeriods": 6,
"Period": 300,
"Statistic": "Average",
"Threshold": 60,
"AlarmDescription": "CPU Utilization of i-01234567890123456 over 60%",
"AlarmName": "EC2 instance i-01234567890123456 CPU Utilization"
}
```
{% endtab %}
{% tab title="Alarme de m√©trique modifi√©e" %}
```json
{
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0645d6d414dadf9f8"
}
],
"AlarmActions": [],
"ComparisonOperator": "GreaterThanThreshold",
"DatapointsToAlarm": 8640,
"EvaluationPeriods": 8640,
"Period": 10,
"Statistic": "Average",
"Threshold": 99,
"AlarmDescription": "CPU Utilization of i-01234567890123456 with 60% as threshold",
"AlarmName": "Instance i-0645d6d414dadf9f8 CPU Utilization"
}

```
{% endtab %}
{% endtabs %}
**Impact potentiel**: Absence de notifications pour les √©v√©nements critiques, probl√®mes non d√©tect√©s potentiellement, fausses alertes, suppression d'alertes l√©gitimes et d√©tection potentiellement manqu√©e des incidents r√©els.

### **`cloudwatch:DeleteAlarmActions`, `cloudwatch:EnableAlarmActions`, `cloudwatch:SetAlarmState`**

En supprimant les actions d'alarme, l'attaquant pourrait emp√™cher les alertes critiques et les r√©ponses automatis√©es d'√™tre d√©clench√©es lorsqu'un √©tat d'alarme est atteint, telles que la notification des administrateurs ou le d√©clenchement d'activit√©s de mise √† l'√©chelle automatique. Activer ou r√©activer de mani√®re inappropri√©e les actions d'alarme pourrait √©galement entra√Æner des comportements inattendus, soit en r√©activant des actions pr√©c√©demment d√©sactiv√©es, soit en modifiant les actions d√©clench√©es, causant potentiellement de la confusion et de la d√©sorientation dans la r√©ponse aux incidents.

De plus, un attaquant ayant la permission pourrait manipuler les √©tats d'alarme, en cr√©ant de fausses alarmes pour distraire et d√©sorienter les administrateurs, ou en silence les alarmes l√©gitimes pour masquer les activit√©s malveillantes en cours ou les d√©faillances critiques du syst√®me.

- Si vous utilisez **`SetAlarmState`** sur une alarme composite, l'alarme composite n'est pas garantie de revenir √† son √©tat r√©el. Elle revient √† son √©tat r√©el uniquement une fois que l'une de ses alarmes enfants change d'√©tat. Elle est √©galement r√©√©valu√©e si vous mettez √† jour sa configuration.
```bash
aws cloudwatch disable-alarm-actions --alarm-names <value>
aws cloudwatch enable-alarm-actions --alarm-names <value>
aws cloudwatch set-alarm-state --alarm-name <value> --state-value <OK | ALARM | INSUFFICIENT_DATA> --state-reason <value> [--state-reason-data <value>]
```
**Impact potentiel** : Absence de notifications pour les √©v√©nements critiques, risque de probl√®mes non d√©tect√©s, fausses alertes, suppression d'alertes l√©gitimes et potentiellement des d√©tections manqu√©es d'incidents r√©els.

### **`cloudwatch:DeleteAnomalyDetector`, `cloudwatch:PutAnomalyDetector`**

Un attaquant pourrait compromettre la capacit√© de d√©tection et de r√©ponse aux mod√®les ou anomalies inhabituels dans les donn√©es m√©triques. En supprimant les d√©tecteurs d'anomalies existants, un attaquant pourrait d√©sactiver des m√©canismes d'alerte critiques ; et en les cr√©ant ou les modifiant, il pourrait soit mal les configurer, soit cr√©er de faux positifs afin de distraire ou submerger la surveillance.
```bash
aws cloudwatch delete-anomaly-detector [--cli-input-json <value> | --namespace <value> --metric-name <value> --dimensions <value> --stat <value>]
aws cloudwatch put-anomaly-detector [--cli-input-json <value> | --namespace <value> --metric-name <value> --dimensions <value> --stat <value> --configuration <value> --metric-characteristics <value>]
```
L'exemple suivant montre comment rendre un d√©tecteur d'anomalies de m√©triques inefficace. Ce d√©tecteur d'anomalies de m√©triques surveille l'utilisation moyenne du processeur d'une instance EC2 sp√©cifique, et il suffirait d'ajouter le param√®tre "ExcludedTimeRanges" avec la plage horaire souhait√©e pour garantir que le d√©tecteur d'anomalies n'analyse ni n'alerte sur des donn√©es pertinentes pendant cette p√©riode.

{% tabs %}
{% tab title="D√©tecteur d'anomalies de m√©triques original" %}
```json
{
"SingleMetricAnomalyDetector": {
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Stat": "Average",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0123456789abcdefg"
}
]
}
}
```
{% endtab %}
{% tab title="D√©tecteur d'anomalies de m√©triques modifi√©" %}
```json
{
"SingleMetricAnomalyDetector": {
"Namespace": "AWS/EC2",
"MetricName": "CPUUtilization",
"Stat": "Average",
"Dimensions": [
{
"Name": "InstanceId",
"Value": "i-0123456789abcdefg"
}
]
},
"Configuration": {
"ExcludedTimeRanges": [
{
"StartTime": "2023-01-01T00:00:00Z",
"EndTime": "2053-01-01T23:59:59Z"
}
],
"Timezone": "Europe/Madrid"
}
}
```
{% endtab %}
{% endtabs %}
**Impact potentiel** : Effet direct dans la d√©tection de sch√©mas inhabituels ou de menaces de s√©curit√©.

### **`cloudwatch:DeleteDashboards`,¬†`cloudwatch:PutDashboard`**

Un attaquant pourrait compromettre les capacit√©s de surveillance et de visualisation d'une organisation en cr√©ant, modifiant ou supprimant ses tableaux de bord. Ces autorisations pourraient √™tre exploit√©es pour supprimer une visibilit√© critique sur les performances et la sant√© des syst√®mes, modifier les tableaux de bord pour afficher des donn√©es incorrectes ou masquer des activit√©s malveillantes.
```bash
aws cloudwatch delete-dashboards --dashboard-names <value>
aws cloudwatch put-dashboard --dashboard-name <value> --dashboard-body <value>
```
**Impact potentiel** : Perte de visibilit√© de la surveillance et d'informations trompeuses.

### **`cloudwatch:DeleteInsightRules`, `cloudwatch:PutInsightRule`, `cloudwatch:PutManagedInsightRule`**

Les r√®gles d'analyse sont utilis√©es pour d√©tecter les anomalies, optimiser les performances et g√©rer les ressources de mani√®re efficace. En supprimant les r√®gles d'analyse existantes, un attaquant pourrait supprimer des capacit√©s de surveillance critiques, laissant le syst√®me aveugle aux probl√®mes de performance et aux menaces de s√©curit√©. De plus, un attaquant pourrait cr√©er ou modifier des r√®gles d'analyse pour g√©n√©rer des donn√©es trompeuses ou masquer des activit√©s malveillantes, entra√Ænant des diagnostics incorrects et des r√©ponses inappropri√©es de l'√©quipe des op√©rations.
```bash
aws cloudwatch delete-insight-rules --rule-names <value>
aws cloudwatch put-insight-rule --rule-name <value> --rule-definition <value> [--rule-state <value>]
aws cloudwatch put-managed-insight-rules --managed-rules <value>
```
**Impact potentiel** : Difficult√© √† d√©tecter et √† r√©pondre aux probl√®mes de performance et aux anomalies, prise de d√©cisions erron√©es et dissimulation potentielle d'activit√©s malveillantes ou de d√©faillances syst√®me.

### **`cloudwatch:DisableInsightRules`, `cloudwatch:EnableInsightRules`**

En d√©sactivant des r√®gles d'analyse critiques, un attaquant pourrait effectivement rendre l'organisation aveugle aux principales m√©triques de performance et de s√©curit√©. En revanche, en activant ou en configurant des r√®gles trompeuses, il pourrait √™tre possible de g√©n√©rer de fausses donn√©es, cr√©er du bruit ou dissimuler une activit√© malveillante.
```bash
aws cloudwatch disable-insight-rules --rule-names <value>
aws cloudwatch enable-insight-rules --rule-names <value>
```
**Impact potentiel** : Confusion parmi l'√©quipe des op√©rations, entra√Ænant des r√©ponses retard√©es aux probl√®mes r√©els et des actions inutiles bas√©es sur de fausses alertes.

### **`cloudwatch:DeleteMetricStream` ,¬†`cloudwatch:PutMetricStream` , `cloudwatch:PutMetricData`**

Un attaquant avec les autorisations **`cloudwatch:DeleteMetricStream`** ,¬†**`cloudwatch:PutMetricStream`** serait capable de cr√©er et supprimer des flux de donn√©es m√©triques, compromettant la s√©curit√©, la surveillance et l'int√©grit√© des donn√©es :

- **Cr√©er des flux malveillants** : Cr√©er des flux m√©triques pour envoyer des donn√©es sensibles vers des destinations non autoris√©es.
- **Manipulation des ressources** : La cr√©ation de nouveaux flux m√©triques avec des donn√©es excessives pourrait g√©n√©rer beaucoup de bruit, provoquant des alertes incorrectes, masquant les probl√®mes r√©els.
- **Perturbation de la surveillance** : En supprimant des flux m√©triques, les attaquants perturberaient le flux continu de donn√©es de surveillance. De cette mani√®re, leurs activit√©s malveillantes seraient efficacement dissimul√©es.

De m√™me, avec l'autorisation **`cloudwatch:PutMetricData`**, il serait possible d'ajouter des donn√©es √† un flux m√©trique. Cela pourrait entra√Æner un d√©ni de service en raison de la quantit√© de donn√©es inappropri√©es ajout√©es, le rendant compl√®tement inutile.
```bash
aws cloudwatch delete-metric-stream --name <value>
aws cloudwatch put-metric-stream --name <value> [--include-filters <value>] [--exclude-filters <value>] --firehose-arn <value> --role-arn <value> --output-format <value>
aws cloudwatch put-metric-data --namespace <value> [--metric-data <value>] [--metric-name <value>] [--timestamp <value>] [--unit <value>] [--value <value>] [--dimensions <value>]
```
Exemple d'ajout de donn√©es correspondant √† une utilisation de 70 % du CPU sur une instance EC2 donn√©e :
```bash
aws cloudwatch put-metric-data --namespace "AWS/EC2" --metric-name "CPUUtilization" --value 70 --unit "Percent" --dimensions "InstanceId=i-0123456789abcdefg"
```
**Impact potentiel** : Perturbation dans le flux des donn√©es de surveillance, impactant la d√©tection des anomalies et des incidents, la manipulation des ressources et l'augmentation des co√ªts dus √† la cr√©ation excessive de flux de m√©triques.

### **`cloudwatch:StopMetricStreams`, `cloudwatch:StartMetricStreams`**

Un attaquant pourrait contr√¥ler le flux des flux de donn√©es de m√©triques affect√©s (chaque flux de donn√©es s'il n'y a pas de restriction de ressources). Avec l'autorisation **`cloudwatch:StopMetricStreams`**, les attaquants pourraient masquer leurs activit√©s malveillantes en arr√™tant les flux de m√©triques critiques.
```bash
aws cloudwatch stop-metric-streams --names <value>
aws cloudwatch start-metric-streams --names <value>
```
**Impact potentiel** : Perturbation dans le flux des donn√©es de surveillance, impactant la d√©tection des anomalies et des incidents.

### **`cloudwatch:TagResource`,¬†`cloudwatch:UntagResource`**

Un attaquant pourrait ajouter, modifier ou supprimer des tags des ressources CloudWatch (actuellement uniquement des alarmes et des r√®gles Contributor Insights). Cela pourrait perturber les politiques de contr√¥le d'acc√®s de votre organisation bas√©es sur les tags.
```bash
aws cloudwatch tag-resource --resource-arn <value> --tags <value>
aws cloudwatch untag-resource --resource-arn <value> --tag-keys <value>
```
**Impact potentiel**: Perturbation des politiques de contr√¥le d'acc√®s bas√©es sur les tags.

## R√©f√©rences

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazoncloudwatch.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazoncloudwatch.html)
* [https://docs.aws.amazon.com/es_es/AmazonCloudWatch/latest/monitoring/cloudwatch_concepts.html#Metric](https://docs.aws.amazon.com/es_es/AmazonCloudWatch/latest/monitoring/cloudwatch_concepts.html#Metric)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
