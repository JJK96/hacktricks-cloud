# AWS - API Gateway Enum

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Lango la API

### Taarifa Msingi

AWS API Gateway ni huduma kamili inayotolewa na Amazon Web Services (AWS) iliyoundwa kwa watengenezaji ili **kuunda, kuchapisha, na kusimamia APIs kwa kiwango kikubwa**. Inafanya kazi kama lango la kuingilia kwenye programu, kuruhusu watengenezaji kuweka mfumo wa sheria na taratibu. Mfumo huu unatawala upatikanaji wa watumiaji wa nje wanavyo data fulani au utendaji ndani ya programu.

API Gateway inakuwezesha kufafanua **jinsi maombi kwenye APIs yako yanapaswa kushughulikiwa**, na inaweza kuunda vituo vya API vya desturi na njia maalum (k.m., GET, POST, PUT, DELETE) na rasilimali. Pia inaweza kuzalisha SDK za wateja (Vifurushi vya Maendeleo ya Programu) ili kuifanya iwe rahisi kwa watengenezaji kuita APIs yako kutoka kwenye programu zao.

### Aina za Malango ya API

* **API ya HTTP**: Jenga APIs za REST zenye kuchelewesha kidogo na gharama nafuu na vipengele vilivyojengwa kama OIDC na OAuth2, na msaada wa asili wa CORS. Inafanya kazi na yafuatayo: Lambda, nyuma za HTTP.
* **API ya WebSocket**: Jenga API ya WebSocket kwa kutumia mawasiliano ya kudumu kwa matumizi ya wakati halisi kama vile programu za mazungumzo au dashibodi. Inafanya kazi na yafuatayo: Lambda, HTTP, Huduma za AWS.
* **API ya REST**: Endeleza API ya REST ambapo unapata udhibiti kamili juu ya ombi na jibu pamoja na uwezo wa usimamizi wa API. Inafanya kazi na yafuatayo: Lambda, HTTP, Huduma za AWS.
* **API ya REST ya Kibinafsi**: Unda API ya REST ambayo inaweza kufikiwa tu kutoka ndani ya VPC.

### Vipengele Vikuu vya Lango la API

1. **Rasilimali**: Katika API Gateway, rasilimali ni vipengele vinavyounda muundo wa API yako. Vinawakilisha **njia au vituo tofauti** vya API yako na vinalingana na vitendo mbalimbali ambavyo API yako inasaidia. Rasilimali ni kila njia (k.m., GET, POST, PUT, DELETE) **ndani ya kila njia** (/, au /watumiaji, au /mtumiaji/{id}.
2. **Hatua**: Hatua katika API Gateway inawakilisha **toleo au mazingira tofauti** ya API yako, kama vile maendeleo, hatua ya majaribio, au uzalishaji. Unaweza kutumia hatua kusimamia na kusambaza **matoleo mengi ya API yako kwa wakati mmoja**, kuruhusu kupima vipengele vipya au marekebisho ya kasoro bila kuathiri mazingira ya uzalishaji. Hatua pia **inaweza kusaidia mazingira ya hatua**, ambayo ni jozi za funguo-na-thamani zinazoweza kutumika kusanidi tabia ya API yako kulingana na hatua ya sasa. Kwa mfano, unaweza kutumia mazingira ya hatua kuongoza maombi ya API kwa Lambda tofauti au huduma zingine za nyuma kulingana na hatua.
* Hatua inaonyeshwa mwanzoni mwa URL ya kiungo cha lango la API.
3. **Wahakiki**: Wahakiki katika API Gateway wanahusika na **kudhibiti upatikanaji wa API yako** kwa kuthibitisha utambulisho wa mpigaji simu kabla ya kuruhusu ombi kuendelea. Unaweza kutumia **kazi za AWS Lambda** kama wahakiki wa desturi, ambayo inakuruhusu kutekeleza mantiki yako ya uthibitishaji na idhini. Wakati ombi inapoingia, API Gateway hupitisha tokeni ya idhini ya ombi kwa wahakiki wa Lambda, ambao huprocess tokeni na kurudisha sera ya IAM inayodhibiti ni vitendo gani mpigaji simu anaruhusiwa kufanya. API Gateway pia inasaidia **wahakiki wa kujengwa**, kama vile **Utambulisho na Usimamizi wa Upatikanaji wa AWS (IAM)** na **Amazon Cognito**.
4. **Sera ya Rasilimali**: Sera ya rasilimali katika API Gateway ni hati ya JSON ambayo **inadefini ruhusa za kupata API yako**. Inafanana na sera ya IAM lakini imebuniwa mahsusi kwa API Gateway. Unaweza kutumia sera ya rasilimali kudhibiti ni nani anaweza kupata API yako, ni njia zipi wanaweza kuita, na kutoka kwa anwani za IP au VPC wanaweza kuunganisha. **Sera za rasilimali zinaweza kutumika pamoja na wahakiki** kutoa udhibiti wa upatikanaji wa kina kwa API yako.
* Ili sera ya rasilimali ifanye kazi API inahitaji **kusambazwa tena baada ya** sera ya rasilimali kubadilishwa.

### Kuingiza

Kwa chaguo-msingi, **Kumbukumbu za CloudWatch** ziko **zimezimwa**, **Kuingiza Kufikia** kimezimwa, na **Ufuatiliaji wa X-Ray** pia **umekuwa zimezimwa**.

### Uorodheshaji

{% hint style="success" %}
Tambua kwamba katika APIs zote mbili za AWS za kuorodhesha rasilimali (**`apigateway`** na **`apigatewayv2`**) ruhusa pekee unayohitaji na ruhusa pekee inayoweza kutolewa ni **`apigateway:GET`**, kwa hiyo unaweza **kuorodhesha kila kitu.**
{% endhint %}

{% tabs %}
{% tab title="apigateway" %}
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
{% endtab %}

{% tab title="apigatewayv2" %}  
### Kuchunguza API Gateway v2

#### Orodha ya vitu vya kuchunguza:
1. Vipengele vilivyopo vya API
2. Mbinu zilizowezeshwa za uhalalishaji
3. Mazingira ya uendeshaji
4. Mipangilio ya usalama
5. Mipangilio ya upimaji
6. Mipangilio ya kufuatilia
7. Mipangilio ya kumbukumbu
8. Mipangilio ya kufikia
9. Mipangilio ya kikomo cha kiwango
10. Mipangilio ya kikomo cha kipindi
11. Mipangilio ya kikomo cha kipimo
12. Mipangilio ya kikomo cha ukubwa wa mwili
13. Mipangilio ya kikomo cha kina
14. Mipangilio ya kikomo cha kina cha kipindi
15. Mipangilio ya kikomo cha kina cha kipimo
16. Mipangilio ya kikomo cha kina cha ukubwa wa mwili
17. Mipangilio ya kikomo cha kina cha kina
18. Mipangilio ya kikomo cha kina cha kina cha kipindi
19. Mipangilio ya kikomo cha kina cha kina cha kipimo
20. Mipangilio ya kikomo cha kina cha kina cha ukubwa wa mwili
21. Mipangilio ya kikomo cha kina cha kina cha kina
22. Mipangilio ya kikomo cha kina cha kina cha kina cha kipindi
23. Mipangilio ya kikomo cha kina cha kina cha kina cha kipimo
24. Mipangilio ya kikomo cha kina cha kina cha kina cha ukubwa wa mwili
25. Mipangilio ya kikomo cha kina cha kina cha kina cha kina
26. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha kipindi
27. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha kipimo
28. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha ukubwa wa mwili
29. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha kina
30. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha kina cha kipindi
31. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha kina cha kipimo
32. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha kina cha ukubwa wa mwili
33. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha kina cha kina
34. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha kina cha kina cha kipindi
35. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha kina cha kina cha kipimo
36. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha kina cha kina cha ukubwa wa mwili
37. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha kina cha kina cha kina
38. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha kina cha kina cha kina cha kipindi
39. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha kina cha kina cha kina cha kipimo
40. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha kina cha kina cha kina cha ukubwa wa mwili
41. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha kina cha kina cha kina cha kina
42. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha kina cha kina cha kina cha kina cha kipindi
43. Mipangilio ya kikomo cha kina cha kina cha kina cha kina cha kina cha kina cha kina cha kina cha kipimo
44. Mipangilio ya kikomo cha kina cha kina cha k
```bash
# Generic info
aws apigatewayv2 get-account --
aws apigatewayv2 get-domain-names
aws apigatewayv2 get-domain-name --domain-name <name>
aws apigatewayv2 get-usage-plans --
aws apigatewayv2 get-vpc-links
aws apigatewayv2 get-client-certificates --

# Enumerate APIs
aws apigatewayv2 get-apis # This will also show the resource policy (if any)
aws apigatewayv2 get-api --api-id <id>

## Get all the info from an api at once
aws apigatewayv2 export-api --api-id <id> --output-type YAML --specification OAS30 /tmp/api.yaml

## Get stages
aws apigatewayv2 get-stages --api-id <id>

## Get routes
aws apigatewayv2 get-routes --api-id <id>
aws apigatewayv2 get-route --api-id <id> --route-id <route-id>

## Get deployments
aws apigatewayv2 get-deployments --api-id <id>
aws apigatewayv2 get-deployment --api-id <id> --deployment-id <dep-id>

## Get integrations
aws apigatewayv2 get-integrations --api-id <id>

## Get authorizers
aws apigatewayv2 get-authorizers --api-id <id>
aws apigatewayv2 get-authorizer --api-id <id> --authorizer-id <uth-id>

## Get domain mappings
aws apigatewayv2 get-api-mappings --api-id <id> --domain-name <dom-name>
aws apigatewayv2 get-api-mapping --api-id <id> --api-mapping-id <map-id> --domain-name <dom-name>

## Get models
aws apigatewayv2 get-models --api-id <id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
```
## Mbinu Tofauti za Kupata Mamlaka ya Kufikia Ncha za API Gateway

### Sera ya Rasilmali

Inawezekana kutumia sera za rasilmali kufafanua ni nani anaweza kupiga simu kwa ncha za API.\
Katika mfano ufuatao unaweza kuona kwamba **IP iliyotajwa haiwezi kupiga simu** kwa ncha ya `/sera_ya_rasilmali` kupitia GET.

<figure><img src="../../../.gitbook/assets/image (256).png" alt=""><figcaption></figcaption></figure>

### Mthibitishaji wa IAM

Inawezekana kuweka kwamba njia ndani ya njia (rasilmali) inahitaji uwakilishi wa IAM ili kupiga simu.

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

Wakati hii inawekwa utapokea kosa `{"uajiri":"Kitambulisho cha Uthibitishaji Kimepotea"}` unapojaribu kufikia ncha bila idhini yoyote.

Njia moja rahisi ya kuzalisha kitambulisho kinachotarajiwa na programu ni kutumia aina ya **`Uthibitishaji`** ya **`Sahihi ya AWS`** ndani ya **Postman**.

<figure><img src="../../../.gitbook/assets/image (168).png" alt=""><figcaption></figcaption></figure>

Wekeza ufikiaji na Siri ya Akaunti unayotaka kutumia na unaweza kujithibitisha dhidi ya ncha ya API.

Itazalisha **kichwa cha Uthibitishaji** kama vile:
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
Tafadhali elewa kwamba katika visa vingine **Mwandishi** anaweza kuwa ameandika **mbaya** na kutuma **kitu chochote** ndani ya **kichwa cha Uthibitisho** kutaruhusu kuona **maudhui yaliyofichwa**.

### Kutia Saini Ombi Kwa Kutumia Python
```python

pip install requests
pip install requests-aws4auth
pip install boto3

import boto3
import requests
from requests_aws4auth import AWS4Auth

region = 'us-east-1'  # Region
service = 'execute-api'
access_key = 'YOUR_ACCESS_KEY'
secret_key = 'YOUR_SECRET_KEY'

url = 'https://<apiid>.execute-api.us-east-1.amazonaws.com/<stage>/<resource>'

session = boto3.Session(aws_access_key_id=access_key, aws_secret_access_key=secret_key)
credentials = session.get_credentials()
awsauth = AWS4Auth(credentials.access_key, credentials.secret_key, region, service, session_token=credentials.token)

response = requests.get(url, auth=awsauth)

print(response.text)

```
### Msimamizi wa Lambda ya Kipekee

Inawezekana kutumia lambda ambayo kulingana na ishara iliyotolewa itarudisha sera ya IAM ikionyesha ikiwa mtumiaji ana **idhini ya kuita mwisho wa API**.\
Unaweza kuweka kila njia ya rasilimali itakayotumia msimamizi. 

<details>

<summary>Mfano wa Msimamizi wa Lambda</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

Piga na kitu kama hiki:

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
Kulingana na nambari ya Lambda, hii idhini inaweza kuwa na udhaifu
{% endhint %}

Tafadhali kumbuka kwamba ikiwa **sera ya kukataa inazalishwa na kurudishwa** kosa linalorudishwa na API Gateway ni: `{"Message":"User is not authorized to access this resource with an explicit deny"}`

Hivi ndivyo unaweza **kutambua idhini hii** ikiwa mahali pake.

### Kitufe cha API Kinachohitajika

Inawezekana kuweka vituo vya API ambavyo vinahitaji **kitufe halali cha API** kuwasiliana nayo.

<figure><img src="../../../.gitbook/assets/image (88).png" alt=""><figcaption></figcaption></figure>

Inawezekana kuzalisha vitufe vya API kwenye lango la API na hata kuweka ni mara ngapi inaweza kutumika (kwa maombi kwa sekunde na kwa maombi kwa mwezi).

Ili kufanya kitufe cha API kifanye kazi, unahitaji kuongeza kwenye **Mpango wa Matumizi**, mpango huu wa matumizi unapaswa kuongezwa kwenye **Hatua ya API** na hatua ya API inayohusiana inahitaji kuwa na **kupunguza kasi kwa njia** iliyowekwa kwa **hitimisho** linalohitaji kitufe cha API:

<figure><img src="../../../.gitbook/assets/image (198).png" alt=""><figcaption></figcaption></figure>

## Upatikanaji Usiothibitishwa

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## Baada ya Kuvamia

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

## Uthabiti

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Jifunze kuhusu kuvamia AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **fuata** sisi kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kuvamia kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
