# AWS - API Gateway Enum

<details>

<summary><strong>Sıfırdan kahraman olacak şekilde AWS hacklemeyi öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR'lar göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

## API Gateway

### Temel Bilgiler

AWS API Gateway, geliştiricilerin **büyük ölçekte API'lar oluşturmasına, yayınlamasına ve denetlemesine olanak tanıyan** Amazon Web Services (AWS) tarafından sunulan kapsamlı bir hizmettir. Bir uygulamanın giriş noktası olarak işlev görerek, geliştiricilere belirli verilere veya işlevselliklere dış kullanıcıların erişimini düzenlemelerine olanak tanır.

API Gateway, **API'larınıza gelen isteklerin nasıl ele alınması gerektiğini tanımlamanıza olanak tanır** ve belirli yöntemlere (örneğin, GET, POST, PUT, DELETE) ve kaynaklara sahip özel API uç noktaları oluşturabilir. Ayrıca, geliştiricilerin uygulamalarından API'larını çağırmayı kolaylaştırmak için istemci SDK'ları (Yazılım Geliştirme Kiti) oluşturabilir.

### API Gateway Türleri

* **HTTP API**: Dahili özelliklere sahip düşük gecikmeli ve maliyet etkin REST API'ları oluşturun, OIDC ve OAuth2 gibi özelliklerle birlikte ve yerleşik CORS desteğiyle çalışır. Aşağıdakilerle çalışır: Lambda, HTTP arka uçlar.
* **WebSocket API**: Sohbet uygulamaları veya panolar gibi gerçek zamanlı kullanım durumları için kalıcı bağlantılar kullanarak bir WebSocket API'sı oluşturun. Aşağıdakilerle çalışır: Lambda, HTTP, AWS Hizmetleri.
* **REST API**: Talep ve yanıt üzerinde tam kontrol sağladığınız bir REST API geliştirin ve API yönetimi yeteneklerine sahip olun. Aşağıdakilerle çalışır: Lambda, HTTP, AWS Hizmetleri.
* **REST API Private**: Yalnızca bir VPC içinden erişilebilen bir REST API oluşturun.

### API Gateway Ana Bileşenler

1. **Kaynaklar**: API Gateway'de kaynaklar, API'nızın yapısını oluşturan bileşenlerdir. API'nızın farklı yollarını veya uç noktalarını temsil eder ve API'nızın desteklediği çeşitli eylemlere karşılık gelir. Bir kaynak, API'nızın içindeki her yöntem (örneğin, GET, POST, PUT, DELETE) **her yolun içinde** (/, veya /kullanıcılar, veya /kullanıcı/{id}).
2. **Aşamalar**: API Gateway'deki aşamalar, geliştirme, aşama veya üretim gibi API'nızın **farklı sürümlerini veya ortamlarını** temsil eder. Aşamaları kullanarak API'nızın **çoklu sürümlerini aynı anda yönetebilir ve dağıtabilirsiniz**, yeni özellikleri veya hata düzeltmelerini test etmenize olanak tanırken üretim ortamını etkilemeden. Aşamalar ayrıca, API'nızın davranışını mevcut aşamaya bağlı olarak yapılandırmak için kullanılabilecek anahtar-değer çiftleri olan **aşama değişkenlerini destekler**. Örneğin, aşama değişkenlerini kullanarak API isteklerini farklı Lambda işlevlerine veya diğer arka uç hizmetlerine yönlendirebilirsiniz.
* Aşama, API Gateway uç noktasının URL'sinin başında belirtilir.
3. **Yetkilendiriciler**: API Gateway'deki yetkilendiriciler, isteğin devam etmesine izin vermeden önce **çağrıyı yapanın kimliğini doğrulayarak API'nıza erişimi kontrol eden** bileşenlerdir. **AWS Lambda işlevlerini** özel yetkilendiriciler olarak kullanabilirsiniz, bu da kendi kimlik doğrulama ve yetkilendirme mantığınızı uygulamanıza olanak tanır. Bir istek geldiğinde, API Gateway isteğin yetkilendirme belirtecinin Lambda yetkilendiricisine iletilir, belirteci işler ve arayanın hangi işlemleri gerçekleştirmesine izin verildiğini belirleyen bir IAM politikası döndürür. API Gateway ayrıca, **AWS Kimlik ve Erişim Yönetimi (IAM)** ve **Amazon Cognito** gibi **yerleşik yetkilendiricileri** destekler.
4. **Kaynak Politikası**: API Gateway'deki bir kaynak politikası, API'nıza erişim izinlerini tanımlayan bir JSON belgesidir. Bir IAM politikası gibi ancak özel olarak API Gateway için uyarlanmıştır. Bir kaynak politikasını kullanarak API'nıza kimlerin erişebileceğini, hangi yöntemleri çağırabileceğini ve hangi IP adreslerinden veya VPC'lerden bağlanabileceğini kontrol edebilirsiniz. **Kaynak politikaları, yetkilendiricilerle birlikte kullanılarak** API'nıza yönelik ayrıntılı erişim kontrolü sağlayabilir.
* Kaynak politikası değiştirildikten sonra API'nın etkili olması için **yeniden dağıtılması gerekir**.

### Günlükleme

Varsayılan olarak, **CloudWatch Günlükleri** kapalı, **Erişim Günlüğü** kapalı ve **X-Ray izleme** de ayrıca **kapalı**.

### Numaralandırma

{% hint style="success" %}
Her iki AWS API'sında da kaynakları numaralandırmak için (**`apigateway`** ve **`apigatewayv2`**) ihtiyacınız olan tek izin ve verilebilecek tek okuma izni **`apigateway:GET`**'dir, bu sayede **her şeyi numaralandırabilirsiniz.**
{% endhint %}

{% tabs %}
{% tab title="apigateway" %}
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
{% endtab %}

{% tab title="apigatewayv2" %} 

AWS API Gateway v2, a newer version of AWS API Gateway, provides WebSocket APIs in addition to HTTP APIs. WebSocket APIs enable real-time two-way communication applications. When enumerating AWS API Gateway v2, look for misconfigurations such as open access policies, excessive permissions, and insecure API configurations. Also, check for any sensitive data exposure through the APIs. 

Common enumeration techniques for AWS API Gateway v2 include:
- Identifying API endpoints
- Enumerating API methods and resources
- Checking for CORS misconfigurations
- Analyzing API Gateway settings and configurations
- Reviewing access control policies
- Testing for server-side request forgery (SSRF) vulnerabilities

{% endtab %}
```bash
# Generic info
aws apigatewayv2 get-account --
aws apigatewayv2 get-domain-names
aws apigatewayv2 get-domain-name --domain-name <name>
aws apigatewayv2 get-usage-plans --
aws apigatewayv2 get-vpc-links
aws apigatewayv2 get-client-certificates --

# Enumerate APIs
aws apigatewayv2 get-apis # This will also show the resource policy (if any)
aws apigatewayv2 get-api --api-id <id>

## Get all the info from an api at once
aws apigatewayv2 export-api --api-id <id> --output-type YAML --specification OAS30 /tmp/api.yaml

## Get stages
aws apigatewayv2 get-stages --api-id <id>

## Get routes
aws apigatewayv2 get-routes --api-id <id>
aws apigatewayv2 get-route --api-id <id> --route-id <route-id>

## Get deployments
aws apigatewayv2 get-deployments --api-id <id>
aws apigatewayv2 get-deployment --api-id <id> --deployment-id <dep-id>

## Get integrations
aws apigatewayv2 get-integrations --api-id <id>

## Get authorizers
aws apigatewayv2 get-authorizers --api-id <id>
aws apigatewayv2 get-authorizer --api-id <id> --authorizer-id <uth-id>

## Get domain mappings
aws apigatewayv2 get-api-mappings --api-id <id> --domain-name <dom-name>
aws apigatewayv2 get-api-mapping --api-id <id> --api-mapping-id <map-id> --domain-name <dom-name>

## Get models
aws apigatewayv2 get-models --api-id <id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
```
## API Gateway uç noktalarına erişmek için farklı Yetkilendirmeler

### Kaynak Politikası

API uç noktalarını kimin çağırabileceğini tanımlamak için kaynak politikalarını kullanmak mümkündür.\
Aşağıdaki örnekte, **belirtilen IP'nin** GET üzerinden `/resource_policy` uç noktasını arayamayacağını görebilirsiniz.

<figure><img src="../../../.gitbook/assets/image (256).png" alt=""><figcaption></figcaption></figure>

### IAM Yetkilendirici

Bir yol içindeki (bir kaynak) yöntemlerin, onu çağırmak için IAM kimlik doğrulaması gerektirdiği şekilde ayarlamak mümkündür.

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

Bu ayarlandığında, yetkilendirme olmadan uç noktaya ulaşmaya çalıştığınızda `{"message":"Missing Authentication Token"}` hatasını alırsınız.

Beklenen belirteci uygulama tarafından oluşturmanın kolay bir yolu, **Postman** içinde **`AWS Signature`** türündeki **`Authorization`**'ı kullanmaktır.

<figure><img src="../../../.gitbook/assets/image (168).png" alt=""><figcaption></figcaption></figure>

Kullanmak istediğiniz hesabın accessKey ve SecretKey'ini ayarlayın ve API uç noktasına karşı kimlik doğrulaması yapabilirsiniz.

Aşağıdaki gibi bir **Yetkilendirme** **başlığı** oluşturacaktır:
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
Dikkat edilmesi gereken bir diğer durumda **Yetkilendirici** kötü bir şekilde kodlanmış olabilir ve **Yetkilendirme başlığı** içine herhangi bir şey göndermek **gizli içeriği görmeye izin verebilir**.

### Python Kullanarak İstek İmzalama
```python

pip install requests
pip install requests-aws4auth
pip install boto3

import boto3
import requests
from requests_aws4auth import AWS4Auth

region = 'us-east-1'  # Region
service = 'execute-api'
access_key = 'YOUR_ACCESS_KEY'
secret_key = 'YOUR_SECRET_KEY'

url = 'https://<apiid>.execute-api.us-east-1.amazonaws.com/<stage>/<resource>'

session = boto3.Session(aws_access_key_id=access_key, aws_secret_access_key=secret_key)
credentials = session.get_credentials()
awsauth = AWS4Auth(credentials.access_key, credentials.secret_key, region, service, session_token=credentials.token)

response = requests.get(url, auth=awsauth)

print(response.text)

```
### Özel Lambda Yetkilendirme

Verilen bir belirteç temelinde bir lambda kullanarak, kullanıcının API uç noktasını aramaya yetkili olup olmadığını belirten bir IAM politikası **döndürebilirsiniz**.\
Yetkilendirmeyi kullanacak olan her kaynak yöntemini ayarlayabilirsiniz.

<details>

<summary>Lambda Yetkilendirme Kod Örneği</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

Bunu şu şekilde çağırın:

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
Lambda koduna bağlı olarak, bu yetkilendirme zayıf olabilir
{% endhint %}

**Reddetme politikası oluşturulursa ve geri döndürülürse**, API Gateway tarafından döndürülen hata: `{"Message":"User is not authorized to access this resource with an explicit deny"}`

Bu şekilde **bu yetkilendirmeyi** tespit edebilirsiniz.

### Gerekli API Anahtarı

Bir API uç noktasını **geçerli bir API anahtarı gerektirecek şekilde ayarlamak mümkündür**.

<figure><img src="../../../.gitbook/assets/image (88).png" alt=""><figcaption></figcaption></figure>

API anahtarları API Gateway portalında oluşturulabilir ve hatta ne kadar kullanılabileceği belirlenebilir (saniyede kaç istek ve aylık kaç istek).

Bir API anahtarını çalıştırmak için, bunu bir **Kullanım Planı**'na eklemeniz gerekir, bu kullanım planı **API Aşaması**'na eklenmeli ve ilişkili API aşamasının, API anahtarını gerektiren bir **uç noktaya** yönelik olarak yapılandırılmış bir **yöntem sınırlaması** olması gerekir:

<figure><img src="../../../.gitbook/assets/image (198).png" alt=""><figcaption></figcaption></figure>

## Kimlik Doğrulamasız Erişim

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## Ayrıcalık Yükseltme

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## Saldırı Sonrası

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

## Kalıcılık

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Sıfırdan kahraman olmak için AWS hackleme öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**]'na göz atın(https://github.com/sponsors/carlospolop)!
* [**Resmi PEASS & HackTricks ürünlerini alın**](https://peass.creator-spring.com)
* [**The PEASS Family**]'yi keşfedin(https://opensea.io/collection/the-peass-family), özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarınızı paylaşarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek.

</details>
