# AWS - API Gateway Enum

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

- 如果您想看到您的**公司在HackTricks中被广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
- 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
- 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
- **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
- 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## API Gateway

### 基本信息

AWS API Gateway是亚马逊网络服务（AWS）提供的一项全面服务，旨在供开发人员**大规模创建、发布和监控API**。它作为应用程序的入口点，允许开发人员建立一套规则和流程框架。该框架管理外部用户访问应用程序中特定数据或功能的权限。

API Gateway使您能够定义**如何处理对API的请求**，并且可以创建具有特定方法（例如GET、POST、PUT、DELETE）和资源的自定义API端点。它还可以生成客户端SDK（软件开发工具包），以便开发人员可以更轻松地从其应用程序调用您的API。

### API网关类型

- **HTTP API**：使用内置功能（如OIDC和OAuth2）和本机CORS支持构建低延迟和成本效益的REST API。适用于以下内容：Lambda、HTTP后端。
- **WebSocket API**：使用持久连接构建WebSocket API，用于实时用例，如聊天应用程序或仪表板。适用于以下内容：Lambda、HTTP、AWS服务。
- **REST API**：开发REST API，您可以完全控制请求和响应，以及API管理功能。适用于以下内容：Lambda、HTTP、AWS服务。
- **REST API Private**：创建仅可从VPC内部访问的REST API。

### API Gateway主要组件

1. **资源**：在API Gateway中，资源是**构成API结构的组件**。它们代表API的**不同路径或端点**，对应于API支持的各种操作。资源是每个路径（/，或/users，或/user/{id}）**内的每个方法**（例如GET、POST、PUT、DELETE）。
2. **阶段**：API Gateway中的阶段代表您的API的**不同版本或环境**，例如开发、暂存或生产。您可以使用阶段来管理和部署**多个版本的API**，从而可以在不影响生产环境的情况下测试新功能或错误修复。阶段还支持**阶段变量**，这些变量是可用于根据当前阶段配置API行为的键值对。例如，您可以使用阶段变量根据阶段将API请求定向到不同的Lambda函数或其他后端服务。
- 阶段在API Gateway端点的URL开头指示。
3. **授权者**：API Gateway中的授权者负责通过在允许请求继续之前验证调用者的身份来**控制对API的访问**。您可以使用**AWS Lambda函数**作为自定义授权者，这使您可以实现自己的身份验证和授权逻辑。当请求到达时，API Gateway将请求的授权令牌传递给Lambda授权者，后者处理令牌并返回确定调用者允许执行哪些操作的IAM策略。API Gateway还支持**内置授权者**，如**AWS身份和访问管理（IAM）**和**Amazon Cognito**。
4. **资源策略**：API Gateway中的资源策略是一个JSON文档，**定义访问您的API的权限**。它类似于IAM策略，但专门为API Gateway定制。您可以使用资源策略来控制谁可以访问您的API，他们可以调用哪些方法，以及可以从哪些IP地址或VPC连接。**资源策略可以与授权者结合使用**，为您的API提供细粒度的访问控制。
- 为了使资源策略生效，需要在修改资源策略后**重新部署API**。

### 日志记录

默认情况下，**CloudWatch日志**处于**关闭**状态，**访问日志记录**也处于**关闭**状态，**X-Ray跟踪**也是**关闭**状态。

### 枚举

{% hint style="success" %}
请注意，在AWS两个用于枚举资源的API（**`apigateway`**和**`apigatewayv2`**）中，您唯一需要的权限和唯一可授予的读取权限是**`apigateway:GET`**，有了这个权限，您可以**枚举所有内容**。
{% endhint %}

{% tabs %}
{% tab title="apigateway" %}
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
{% endtab %}

{% tab title="apigatewayv2" %} 

AWS API Gateway v2 枚举

### 服务发现

1. **GetApis** - 列出所有API。
2. **GetApi** - 获取单个API的详细信息。
3. **GetApiMappings** - 列出所有API映射。
4. **GetApiMapping** - 获取单个API映射的详细信息。
5. **GetAuthorizers** - 列出所有授权者。
6. **GetAuthorizer** - 获取单个授权者的详细信息。
7. **GetDeployments** - 列出所有部署。
8. **GetDeployment** - 获取单个部署的详终信息。
9. **GetDomainNames** - 列出所有域名。
10. **GetDomainName** - 获取单个域名的详细信息。
11. **GetIntegrations** - 列出所有集成。
12. **GetIntegration** - 获取单个集成的详细信息。
13. **GetIntegrationResponses** - 列出所有集成响应。
14. **GetIntegrationResponse** - 获取单个集成响应的详细信息。
15. **GetModels** - 列出所有模型。
16. **GetModel** - 获取单个模型的详细信息。
17. **GetRoutes** - 列出所有路由。
18. **GetRoute** - 获取单个路由的详细信息。
19. **GetRouteResponses** - 列出所有路由响应。
20. **GetRouteResponse** - 获取单个路由响应的详细信息。
21. **GetStage** - 获取阶段的详细信息。
22. **GetStages** - 列出所有阶段。
23. **GetTags** - 获取资源的标签。
24. **GetVpcLinks** - 列出所有VPC链接。
25. **GetVpcLink** - 获取单个VPC链接的详细信息。

### 配置

1. **CreateApi** - 创建一个新的API。
2. **CreateApiMapping** - 创建一个新的API映射。
3. **CreateAuthorizer** - 创建一个新的授权者。
4. **CreateDeployment** - 创建一个新的部署。
5. **CreateDomainName** - 创建一个新的域名。
6. **CreateIntegration** - 创建一个新的集成。
7. **CreateIntegrationResponse** - 创建一个新的集成响应。
8. **CreateModel** - 创建一个新的模型。
9. **CreateRoute** - 创建一个新的路由。
10. **CreateRouteResponse** - 创建一个新的路由响应。
11. **CreateStage** - 创建一个新的阶段。
12. **CreateVpcLink** - 创建一个新的VPC链接。

### 更新

1. **UpdateApi** - 更新现有的API。
2. **UpdateApiMapping** - 更新现有的API映射。
3. **UpdateAuthorizer** - 更新现有的授权者。
4. **UpdateDeployment** - 更新现有的部署。
5. **UpdateDomainName** - 更新现有的域名。
6. **UpdateIntegration** - 更新现有的集成。
7. **UpdateIntegrationResponse** - 更新现有的集成响应。
8. **UpdateModel** - 更新现有的模型。
9. **UpdateRoute** - 更新现有的路由。
10. **UpdateRouteResponse** - 更新现有的路由响应。
11. **UpdateStage** - 更新现有的阶段。
12. **UpdateVpcLink** - 更新现有的VPC链接。

### 删除

1. **DeleteApi** - 删除指定的API。
2. **DeleteApiMapping** - 删除指定的API映射。
3. **DeleteAuthorizer** - 删除指定的授权者。
4. **DeleteDeployment** - 删除指定的部署。
5. **DeleteDomainName** - 删除指定的域名。
6. **DeleteIntegration** - 删除指定的集成。
7. **DeleteIntegrationResponse** - 删除指定的集成响应。
8. **DeleteModel** - 删除指定的模型。
9. **DeleteRoute** - 删除指定的路由。
10. **DeleteRouteResponse** - 删除指定的路由响应。
11. **DeleteStage** - 删除指定的阶段。
12. **DeleteVpcLink** - 删除指定的VPC链接。

{% endtab %}
```bash
# Generic info
aws apigatewayv2 get-account --
aws apigatewayv2 get-domain-names
aws apigatewayv2 get-domain-name --domain-name <name>
aws apigatewayv2 get-usage-plans --
aws apigatewayv2 get-vpc-links
aws apigatewayv2 get-client-certificates --

# Enumerate APIs
aws apigatewayv2 get-apis # This will also show the resource policy (if any)
aws apigatewayv2 get-api --api-id <id>

## Get all the info from an api at once
aws apigatewayv2 export-api --api-id <id> --output-type YAML --specification OAS30 /tmp/api.yaml

## Get stages
aws apigatewayv2 get-stages --api-id <id>

## Get routes
aws apigatewayv2 get-routes --api-id <id>
aws apigatewayv2 get-route --api-id <id> --route-id <route-id>

## Get deployments
aws apigatewayv2 get-deployments --api-id <id>
aws apigatewayv2 get-deployment --api-id <id> --deployment-id <dep-id>

## Get integrations
aws apigatewayv2 get-integrations --api-id <id>

## Get authorizers
aws apigatewayv2 get-authorizers --api-id <id>
aws apigatewayv2 get-authorizer --api-id <id> --authorizer-id <uth-id>

## Get domain mappings
aws apigatewayv2 get-api-mappings --api-id <id> --domain-name <dom-name>
aws apigatewayv2 get-api-mapping --api-id <id> --api-mapping-id <map-id> --domain-name <dom-name>

## Get models
aws apigatewayv2 get-models --api-id <id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
```
## 访问 API Gateway 端点的不同授权方式

### 资源策略

可以使用资源策略来定义谁可以调用 API 端点。\
在下面的示例中，您可以看到**指定的 IP 无法**通过 GET 调用端点 `/resource_policy`。

<figure><img src="../../../.gitbook/assets/image (256).png" alt=""><figcaption></figcaption></figure>

### IAM 授权者

可以设置路径中的方法（资源）需要 IAM 认证才能调用。

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

设置后，当您尝试在没有任何授权的情况下访问端点时，将收到错误 `{"message":"Missing Authentication Token"}`。

生成应用程序期望的令牌的一种简单方法是在 **Postman** 中使用 **`Authorization`** 类型 **`AWS Signature`**。

<figure><img src="../../../.gitbook/assets/image (168).png" alt=""><figcaption></figcaption></figure>

设置要使用的帐户的 accessKey 和 SecretKey，然后您就可以对 API 端点进行身份验证。

它将生成一个类似于以下内容的 **Authorization** **头部**：
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
请注意，在其他情况下，**授权者**可能已经**编写不良代码**，只需在**授权标头**中发送**任何内容**即可**查看隐藏内容**。

### 使用Python进行请求签名
```python

pip install requests
pip install requests-aws4auth
pip install boto3

import boto3
import requests
from requests_aws4auth import AWS4Auth

region = 'us-east-1'  # Region
service = 'execute-api'
access_key = 'YOUR_ACCESS_KEY'
secret_key = 'YOUR_SECRET_KEY'

url = 'https://<apiid>.execute-api.us-east-1.amazonaws.com/<stage>/<resource>'

session = boto3.Session(aws_access_key_id=access_key, aws_secret_access_key=secret_key)
credentials = session.get_credentials()
awsauth = AWS4Auth(credentials.access_key, credentials.secret_key, region, service, session_token=credentials.token)

response = requests.get(url, auth=awsauth)

print(response.text)

```
### 自定义 Lambda 授权者

可以使用一个基于给定令牌的 Lambda 函数，**返回一个 IAM 策略**，指示用户是否**被授权调用 API 端点**。\
您可以设置将使用授权者的每个资源方法。

<details>

<summary>Lambda 授权者代码示例</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

调用方式如下：

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
根据Lambda代码的不同，此授权可能存在漏洞
{% endhint %}

请注意，如果生成并返回了**拒绝策略**，API Gateway返回的错误为：`{"Message":"User is not authorized to access this resource with an explicit deny"}`

这样你就可以**识别**这种授权是否已经生效。

### 需要 API 密钥

可以设置需要**有效 API 密钥**才能访问的 API 端点。

<figure><img src="../../../.gitbook/assets/image (88).png" alt=""><figcaption></figcaption></figure>

可以在 API Gateway 门户中生成 API 密钥，甚至设置其可用次数（每秒请求次数和每月请求次数）。

要使 API 密钥起作用，需要将其添加到**使用计划**中，此使用计划必须添加到**API 阶段**，并且相关的 API 阶段需要将**方法限制**配置到需要 API 密钥的**端点**上：

<figure><img src="../../../.gitbook/assets/image (198).png" alt=""><figcaption></figcaption></figure>

## 未经身份验证的访问

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## 提权

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## 后渗透

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

## 持久化

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 PDF 版本的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[NFT](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** 上关注我们**。
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
