# AWS - Redshift Enum

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da bizi **Twitter**'da takip edin 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## Amazon Redshift

Redshift, **büyük veri çözümleri için bir veri ambarı** olarak kullanılan, tamamen yönetilen ve petabayt boyutuna kadar ölçeklenebilen bir hizmettir. Redshift kümelerini kullanarak, veri kümelerinize karşı hızlı, SQL tabanlı sorgu araçları ve iş zekası uygulamaları kullanarak analizler yapabilir ve işiniz için daha büyük bir vizyon anlayışı elde edebilirsiniz.

**Redshift, KMS veya CloudHSM kullanarak şifreleme anahtarlarının dört katmanlı bir hiyerarşisini kullanarak dinlenme sırasında şifreleme sunar**. **Kümeniz için şifreleme etkinleştirildiğinde, devre dışı bırakılamaz ve tersi de geçerlidir**. Şifresiz bir kümeye sahipseniz, şifrelenemez.

Kümeniz için şifreleme yalnızca oluşturulması sırasında gerçekleşebilir ve bir kez şifrelendiğinde, veri, meta veri ve herhangi bir anlık görüntü de şifrelenir. Şifreleme anahtarlarının katmanlama seviyesi şu şekildedir: **birinci katman ana anahtar, ikinci katman küme şifreleme anahtarı, CEK, üçüncü katman veritabanı şifreleme anahtarı, DEK ve son olarak dördüncü katman veri şifreleme anahtarları**.

### KMS

Kümenizi oluştururken, Redshift için **varsayılan KMS anahtarını** seçebilir veya **kendi CMK'nızı** seçebilirsiniz, bu da anahtarın kontrolü üzerinde daha fazla esneklik sağlar, özellikle denetlenebilir bir perspektiften.

Redshift için varsayılan KMS anahtarı, anahtar seçeneği ilk kez seçildiğinde ve kullanıldığında Redshift tarafından otomatik olarak oluşturulur ve tamamen AWS tarafından yönetilir.

Bu KMS anahtarı daha sonra CMK ana anahtarı, birinci katman ile şifrelenir. Bu şifrelenmiş KMS veri anahtarı daha sonra küme şifreleme anahtarı, CEK, ikinci katman olarak kullanılır. Bu CEK daha sonra KMS tarafından Redshift'e gönderilir ve kümeden ayrı olarak saklanır. Redshift daha sonra bu şifrelenmiş CEK'i güvenli bir kanal üzerinden kümeye gönderir ve bellekte saklanır.

Redshift daha sonra KMS'den CEK'i, ikinci katman, şifre çözmesini ister. Bu şifre çözülmüş CEK de bellekte saklanır. Redshift daha sonra rastgele bir veritabanı şifreleme anahtarı, DEK, üçüncü katman oluşturur ve bunu kümenin belleğine yükler. Bellekteki şifre çözülmüş CEK, DEK'i şifreler ve bu da bellekte saklanır.

Bu şifrelenmiş DEK daha sonra güvenli bir kanal üzerinden gönderilir ve Redshift'te kümeden ayrı olarak saklanır. Hem CEK hem de DEK artık hem şifrelenmiş hem de şifre çözülmüş formda kümenin belleğinde saklanır. Şifre çözülmüş DEK daha sonra veritabanındaki her veri bloğu için Redshift tarafından rastgele oluşturulan veri anahtarlarını, dördüncü katman, şifrelemek için kullanılır.

Amazon S3 kovalarınızın yapılandırmasını izlemek ve kova günlüğünün etkinleştirildiğinden emin olmak için AWS Trusted Advisor'ı kullanabilirsiniz, bu da güvenlik denetimleri gerçekleştirmek ve S3'teki kullanım modellerini izlemek için yararlı olabilir.

### CloudHSM

<details>

<summary>Redshift'i CloudHSM ile Kullanma</summary>

Şifrelemenizi gerçekleştirmek için CloudHSM ile çalışırken, öncelikle HSM istemciniz ve Redshift arasında istemci ve sunucu sertifikaları kullanarak güvenilir bir bağlantı kurmanız gerekir.

Bu bağlantı, şifreleme anahtarlarının HSM istemciniz ve Redshift kümeleriniz arasında gönderilmesine izin vererek güvenli iletişim sağlamak için gereklidir. Rastgele oluşturulan özel ve genel anahtar çifti kullanarak, Redshift bir genel istemci sertifikası oluşturur, bu sertifika şifrelenir ve Redshift tarafından saklanır. Bu sertifika indirilip HSM istemcinize kaydedilmeli ve doğru HSM bölümüne atanmalıdır.

Daha sonra Redshift'i HSM istemcinizin şu ayrıntılarıyla yapılandırmanız gerekir: HSM IP adresi, HSM bölüm adı, HSM bölüm şifresi ve CloudHSM tarafından dahili bir ana anahtar kullanılarak şifrelenen genel HSM sunucu sertifikası. Bu bilgiler sağlandıktan sonra, Redshift bağlantı kurabileceğini ve geliştirme bölümüne erişebileceğini doğrular.

İç güvenlik politikalarınız veya yönetim kontrolleriniz anahtar döndürme uygulamanız gerektiğini belirtiyorsa, Redshift ile şifrelenmiş kümeler için şifreleme anahtarlarını döndürmenizi sağlayarak bu mümkündür, ancak anahtar döndürme işlemi sırasında kümenin çok kısa bir süre için kullanılamaz hale geleceğini bilmeniz gerekir, bu nedenle anahtarları yalnızca gerektiğinde veya tehlikeye girdiğini düşündüğünüzde döndürmek en iyisidir.

Döndürme sırasında, Redshift kümeniz ve bu kümenin yedekleri için CEK'i döndürecektir. Küme için bir DEK döndürecektir, ancak S3'te DEK kullanılarak şifrelenmiş anlık görüntüler için bir DEK döndürmek mümkün değildir. Küme, işlem tamamlanana kadar 'anahtarları döndürüyor' durumuna geçecek ve durum 'kullanılabilir' olarak geri dönecektir.

</details>

### Enumeration
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistence

Aşağıdaki eylemler, diğer AWS hesaplarına kümeye erişim izni vermeyi sağlar:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **Twitter'da** bizi takip edin 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}
