# AWS - Redshift Enum

{% hint style="success" %}
Leer en oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer en oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** 游눫 [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Amazon Redshift

Redshift is 'n volledig bestuurde diens wat kan skaal tot oor 'n petabyte in grootte, wat gebruik word as 'n **data warehouse vir groot data-oplossings**. Deur Redshift-klusters te gebruik, kan jy analises uitvoer teen jou datastelle met behulp van vinnige, SQL-gebaseerde navraaginstrumente en besigheidsintelligensie-toepassings om 'n groter begrip van visie vir jou besigheid te verkry.

**Redshift bied enkripsie in rus met behulp van 'n vier-vlak hi칢rargie van enkripsiesleutels met behulp van 칩f KMS 칩f CloudHSM om die boonste vlak van sleutels te bestuur**. **Wanneer enkripsie vir jou kluster geaktiveer is, kan dit nie gedeaktiveer word nie en omgekeerd**. Wanneer jy 'n onge칢nkripteerde kluster het, kan dit nie ge칢nkripteer word nie.

Enkripsie vir jou kluster kan slegs tydens die skepping daarvan plaasvind, en sodra dit ge칢nkripteer is, word die data, metadata en enige momentopnames ook ge칢nkripteer. Die vlakke van enkripsiesleutels is soos volg, **vlak een is die hoofsleutel, vlak twee is die kluster enkripsiesleutel, die CEK, vlak drie, die databasis enkripsiesleutel, die DEK, en uiteindelik vlak vier, die data enkripsiesleutels self**.

### KMS

Tydens die skepping van jou kluster, kan jy 칩f die **standaard KMS-sleutel** vir Redshift kies 칩f jou **eie CMK** kies, wat jou meer buigsaamheid gee oor die beheer van die sleutel, spesifiek vanuit 'n ouditbare perspektief.

Die standaard KMS-sleutel vir Redshift word outomaties deur Redshift geskep die eerste keer dat die sleutelopsie gekies en gebruik word, en dit word volledig deur AWS bestuur.

Hierdie KMS-sleutel word dan ge칢nkripteer met die CMK-hoofsleutel, vlak een. Hierdie ge칢nkripteerde KMS-data-sleutel word dan gebruik as die kluster enkripsiesleutel, die CEK, vlak twee. Hierdie CEK word dan deur KMS na Redshift gestuur waar dit apart van die kluster gestoor word. Redshift stuur dan hierdie ge칢nkripteerde CEK na die kluster oor 'n veilige kanaal waar dit in geheue gestoor word.

Redshift vra dan KMS om die CEK, vlak twee, te dekripteer. Hierdie gede칢nkripteerde CEK word dan ook in geheue gestoor. Redshift skep dan 'n ewekansige databasis enkripsiesleutel, die DEK, vlak drie, en laai dit in die geheue van die kluster. Die gede칢nkripteerde CEK in geheue enkripteer dan die DEK, wat ook in geheue gestoor word.

Hierdie ge칢nkripteerde DEK word dan oor 'n veilige kanaal gestuur en apart van die kluster in Redshift gestoor. Beide die CEK en die DEK word nou in geheue van die kluster gestoor, beide in 'n ge칢nkripteerde en gede칢nkripteerde vorm. Die gede칢nkripteerde DEK word dan gebruik om data-sleutels, vlak vier, te enkripteer wat ewekansig deur Redshift gegenereer word vir elke datablock in die databasis.

Jy kan AWS Trusted Advisor gebruik om die konfigurasie van jou Amazon S3-emmers te monitor en te verseker dat emmer-logboeke geaktiveer is, wat nuttig kan wees vir die uitvoering van sekuriteitsoudits en die opsporing van gebruikspatrone in S3.

### CloudHSM

<details>

<summary>Gebruik Redshift met CloudHSM</summary>

Wanneer jy met CloudHSM werk om jou enkripsie uit te voer, moet jy eers 'n vertroude verbinding tussen jou HSM-kli칢nt en Redshift opstel terwyl jy kli칢nt- en bedienersertifikate gebruik.

Hierdie verbinding is nodig om veilige kommunikasie te verskaf, wat toelaat dat enkripsiesleutels tussen jou HSM-kli칢nt en jou Redshift-klusters gestuur word. Met behulp van 'n ewekansig gegenereerde private en publieke sleutelpaar, skep Redshift 'n publieke kli칢ntsertifikaat, wat ge칢nkripteer en deur Redshift gestoor word. Dit moet afgelaai en geregistreer word by jou HSM-kli칢nt, en aan die korrekte HSM-partisie toegewys word.

Jy moet dan Redshift konfigureer met die volgende besonderhede van jou HSM-kli칢nt: die HSM IP-adres, die HSM-partisie naam, die HSM-partisie wagwoord, en die publieke HSM-bedienersertifikaat, wat deur CloudHSM ge칢nkripteer word met 'n interne hoofsleutel. Sodra hierdie inligting verskaf is, sal Redshift bevestig en verifieer dat dit kan koppel en toegang tot die ontwikkelingspartisie het.

As jou interne sekuriteitsbeleide of bestuurskontroles bepaal dat jy sleuteldraai moet toepas, dan is dit moontlik met Redshift wat jou in staat stel om enkripsiesleutels vir ge칢nkripteerde klusters te draai, maar jy moet bewus wees dat tydens die sleuteldraai-proses, dit 'n kluster vir 'n baie kort tydjie onbeskikbaar sal maak, en daarom is dit die beste om slegs sleutels te draai soos en wanneer jy dit nodig het, of as jy voel dat hulle gekompromitteer is.

Tydens die draai, sal Redshift die CEK vir jou kluster en vir enige rugsteun van daardie kluster draai. Dit sal 'n DEK vir die kluster draai, maar dit is nie moontlik om 'n DEK vir die momentopnames wat in S3 gestoor is en met die DEK ge칢nkripteer is, te draai nie. Dit sal die kluster in 'n toestand van 'sleutels draai' plaas totdat die proses voltooi is wanneer die status sal terugkeer na 'beskikbaar'.

</details>

### Enumeration
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistensie

Die volgende aksies laat toe om toegang tot ander AWS-rekeninge tot die groep te verleen:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** 游눫 [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-bewaarplekke.

</details>
{% endhint %}
