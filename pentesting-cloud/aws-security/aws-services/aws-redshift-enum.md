# AWS - Redshift Enum

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Amazon Redshift

Redshift es un servicio completamente gestionado que puede escalar hasta m치s de un petabyte en tama침o, y se utiliza como un **almac칠n de datos para soluciones de big data**. Usando cl칰steres de Redshift, puedes ejecutar an치lisis contra tus conjuntos de datos utilizando herramientas de consulta r치pidas basadas en SQL y aplicaciones de inteligencia empresarial para obtener una mayor comprensi칩n y visi칩n para tu negocio.

**Redshift ofrece cifrado en reposo utilizando una jerarqu칤a de cuatro niveles de claves de cifrado usando KMS o CloudHSM para gestionar el nivel superior de claves**. **Cuando el cifrado est치 habilitado para tu cl칰ster, no se puede deshabilitar y viceversa**. Cuando tienes un cl칰ster no cifrado, no se puede cifrar.

El cifrado para tu cl칰ster solo puede ocurrir durante su creaci칩n, y una vez cifrado, los datos, metadatos y cualquier instant치nea tambi칠n est치n cifrados. El nivel de jerarqu칤a de las claves de cifrado es el siguiente, **el nivel uno es la clave maestra, el nivel dos es la clave de cifrado del cl칰ster, la CEK, el nivel tres, la clave de cifrado de la base de datos, la DEK, y finalmente el nivel cuatro, las propias claves de cifrado de datos**.

### KMS

Durante la creaci칩n de tu cl칰ster, puedes seleccionar la **clave KMS predeterminada** para Redshift o seleccionar tu **propia CMK**, lo que te da m치s flexibilidad sobre el control de la clave, espec칤ficamente desde una perspectiva auditable.

La clave KMS predeterminada para Redshift es creada autom치ticamente por Redshift la primera vez que se selecciona y usa la opci칩n de clave, y es completamente gestionada por AWS.

Esta clave KMS es entonces cifrada con la clave maestra CMK, nivel uno. Esta clave de datos KMS cifrada se usa entonces como la clave de cifrado del cl칰ster, la CEK, nivel dos. Esta CEK es entonces enviada por KMS a Redshift donde se almacena por separado del cl칰ster. Redshift luego env칤a esta CEK cifrada al cl칰ster a trav칠s de un canal seguro donde se almacena en memoria.

Redshift luego solicita a KMS que descifre la CEK, nivel dos. Esta CEK descifrada se almacena tambi칠n en memoria. Redshift luego crea una clave de cifrado de base de datos aleatoria, la DEK, nivel tres, y la carga en la memoria del cl칰ster. La CEK descifrada en memoria luego cifra la DEK, que tambi칠n se almacena en memoria.

Esta DEK cifrada se env칤a luego a trav칠s de un canal seguro y se almacena en Redshift por separado del cl칰ster. Tanto la CEK como la DEK ahora se almacenan en la memoria del cl칰ster tanto en forma cifrada como descifrada. La DEK descifrada se usa luego para cifrar las claves de datos, nivel cuatro, que son generadas aleatoriamente por Redshift para cada bloque de datos en la base de datos.

Puedes usar AWS Trusted Advisor para monitorear la configuraci칩n de tus buckets de Amazon S3 y asegurarte de que el registro de buckets est칠 habilitado, lo cual puede ser 칰til para realizar auditor칤as de seguridad y rastrear patrones de uso en S3.

### CloudHSM

<details>

<summary>Usando Redshift con CloudHSM</summary>

Cuando trabajas con CloudHSM para realizar tu cifrado, primero debes establecer una conexi칩n de confianza entre tu cliente HSM y Redshift mientras usas certificados de cliente y servidor.

Esta conexi칩n es necesaria para proporcionar comunicaciones seguras, permitiendo que las claves de cifrado se env칤en entre tu cliente HSM y tus cl칰steres de Redshift. Usando un par de claves privadas y p칰blicas generadas aleatoriamente, Redshift crea un certificado de cliente p칰blico, que es cifrado y almacenado por Redshift. Este debe ser descargado y registrado en tu cliente HSM, y asignado a la partici칩n HSM correcta.

Luego debes configurar Redshift con los siguientes detalles de tu cliente HSM: la direcci칩n IP del HSM, el nombre de la partici칩n HSM, la contrase침a de la partici칩n HSM y el certificado de servidor p칰blico HSM, que es cifrado por CloudHSM usando una clave maestra interna. Una vez que se ha proporcionado esta informaci칩n, Redshift confirmar치 y verificar치 que puede conectarse y acceder a la partici칩n de desarrollo.

Si tus pol칤ticas de seguridad internas o controles de gobernanza dictan que debes aplicar la rotaci칩n de claves, entonces esto es posible con Redshift permiti칠ndote rotar claves de cifrado para cl칰steres cifrados, sin embargo, debes ser consciente de que durante el proceso de rotaci칩n de claves, har치 que un cl칰ster no est칠 disponible por un per칤odo muy corto de tiempo, por lo que es mejor rotar claves solo cuando sea necesario, o si sientes que pueden haber sido comprometidas.

Durante la rotaci칩n, Redshift rotar치 la CEK para tu cl칰ster y para cualquier respaldo de ese cl칰ster. Rotar치 una DEK para el cl칰ster pero no es posible rotar una DEK para las instant치neas almacenadas en S3 que han sido cifradas usando la DEK. Pondr치 el cl칰ster en un estado de 'rotaci칩n de claves' hasta que el proceso se complete cuando el estado volver치 a 'disponible'.

</details>

### Enumeraci칩n
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistencia

Las siguientes acciones permiten otorgar acceso a otras cuentas de AWS al cl칰ster:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
