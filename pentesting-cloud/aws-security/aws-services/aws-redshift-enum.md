# AWS - Redshift Enum

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository github.

</details>
{% endhint %}

## Amazon Redshift

Redshift √® un servizio completamente gestito che pu√≤ scalare fino a oltre un petabyte di dimensioni, utilizzato come **data warehouse per soluzioni di big data**. Utilizzando i cluster Redshift, √® possibile eseguire analisi sui tuoi dataset utilizzando strumenti di query SQL veloci e applicazioni di business intelligence per ottenere una maggiore comprensione della visione per la tua azienda.

**Redshift offre crittografia a riposo utilizzando una gerarchia a quattro livelli di chiavi di crittografia utilizzando KMS o CloudHSM per gestire il livello superiore delle chiavi**. **Quando la crittografia √® abilitata per il tuo cluster, non pu√≤ essere disabilitata e viceversa**. Quando hai un cluster non crittografato, non pu√≤ essere crittografato.

La crittografia per il tuo cluster pu√≤ avvenire solo durante la sua creazione, e una volta crittografato, i dati, i metadati e qualsiasi snapshot sono anche crittografati. I livelli di gerarchia delle chiavi di crittografia sono i seguenti, **il primo livello √® la chiave master, il secondo livello √® la chiave di crittografia del cluster, il CEK, il terzo livello, la chiave di crittografia del database, il DEK, e infine il quarto livello, le chiavi di crittografia dei dati stesse**.

### KMS

Durante la creazione del tuo cluster, puoi selezionare la **chiave KMS predefinita** per Redshift o selezionare la tua **CMK**, che ti d√† maggiore flessibilit√† nel controllo della chiave, specificamente da una prospettiva di auditabilit√†.

La chiave KMS predefinita per Redshift √® creata automaticamente da Redshift la prima volta che l'opzione della chiave √® selezionata e utilizzata, ed √® completamente gestita da AWS.

Questa chiave KMS √® quindi crittografata con la chiave master CMK, livello uno. Questa chiave dati KMS crittografata √® quindi utilizzata come chiave di crittografia del cluster, il CEK, livello due. Questo CEK √® quindi inviato da KMS a Redshift dove √® memorizzato separatamente dal cluster. Redshift quindi invia questo CEK crittografato al cluster tramite un canale sicuro dove √® memorizzato in memoria.

Redshift quindi richiede a KMS di decrittografare il CEK, livello due. Questo CEK decrittografato √® quindi anche memorizzato in memoria. Redshift quindi crea una chiave di crittografia del database casuale, il DEK, livello tre, e la carica nella memoria del cluster. Il CEK decrittografato in memoria quindi crittografa il DEK, che √® anche memorizzato in memoria.

Questo DEK crittografato √® quindi inviato tramite un canale sicuro e memorizzato in Redshift separatamente dal cluster. Sia il CEK che il DEK sono ora memorizzati in memoria del cluster sia in forma crittografata che decrittografata. Il DEK decrittografato √® quindi utilizzato per crittografare le chiavi dei dati, livello quattro, che sono generate casualmente da Redshift per ogni blocco di dati nel database.

Puoi utilizzare AWS Trusted Advisor per monitorare la configurazione dei tuoi bucket Amazon S3 e assicurarti che il logging del bucket sia abilitato, il che pu√≤ essere utile per eseguire audit di sicurezza e tracciare i modelli di utilizzo in S3.

### CloudHSM

<details>

<summary>Utilizzare Redshift con CloudHSM</summary>

Quando lavori con CloudHSM per eseguire la tua crittografia, innanzitutto devi impostare una connessione fidata tra il tuo client HSM e Redshift utilizzando certificati client e server.

Questa connessione √® necessaria per fornire comunicazioni sicure, permettendo alle chiavi di crittografia di essere inviate tra il tuo client HSM e i tuoi cluster Redshift. Utilizzando una coppia di chiavi privata e pubblica generata casualmente, Redshift crea un certificato client pubblico, che √® crittografato e memorizzato da Redshift. Questo deve essere scaricato e registrato sul tuo client HSM, e assegnato alla partizione HSM corretta.

Devi quindi configurare Redshift con i seguenti dettagli del tuo client HSM: l'indirizzo IP dell'HSM, il nome della partizione HSM, la password della partizione HSM, e il certificato server pubblico HSM, che √® crittografato da CloudHSM utilizzando una chiave master interna. Una volta che queste informazioni sono state fornite, Redshift confermer√† e verificher√† che pu√≤ connettersi e accedere alla partizione di sviluppo.

Se le tue politiche di sicurezza interne o i controlli di governance stabiliscono che devi applicare la rotazione delle chiavi, allora questo √® possibile con Redshift permettendoti di ruotare le chiavi di crittografia per i cluster crittografati, tuttavia, devi essere consapevole che durante il processo di rotazione delle chiavi, render√† un cluster non disponibile per un periodo di tempo molto breve, quindi √® meglio ruotare le chiavi solo quando necessario, o se ritieni che possano essere state compromesse.

Durante la rotazione, Redshift ruoter√† il CEK per il tuo cluster e per qualsiasi backup di quel cluster. Ruoter√† un DEK per il cluster ma non √® possibile ruotare un DEK per gli snapshot memorizzati in S3 che sono stati crittografati utilizzando il DEK. Metter√† il cluster in uno stato di 'rotazione delle chiavi' fino a quando il processo non sar√† completato quando lo stato torner√† a 'disponibile'.

</details>

### Enumeration
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistence

Le seguenti azioni consentono di concedere l'accesso ad altri account AWS al cluster:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository su github.

</details>
{% endhint %}
