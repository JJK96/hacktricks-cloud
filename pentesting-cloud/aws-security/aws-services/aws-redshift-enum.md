# AWS - Redshift Enum

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Amazon Redshift

Redshift je potpuno upravljana usluga koja može skalirati do preko petabajta veličine, koja se koristi kao **data warehouse za big data rešenja**. Korišćenjem Redshift klastera, možete pokretati analitiku nad vašim datasetovima koristeći brze, SQL-bazirane alate za upite i aplikacije za poslovnu inteligenciju kako biste dobili veće razumevanje vizije za vaš biznis.

**Redshift nudi enkripciju u mirovanju koristeći četvorostepenu hijerarhiju enkripcijskih ključeva koristeći ili KMS ili CloudHSM za upravljanje najvišim nivoom ključeva**. **Kada je enkripcija omogućena za vaš klaster, ne može se onemogućiti i obrnuto**. Kada imate neenkriptovani klaster, ne može se enkriptovati.

Enkripcija za vaš klaster može se desiti samo tokom njegovog kreiranja, i jednom kada je enkriptovan, podaci, metapodaci i bilo koji snimci su takođe enkriptovani. Nivoi hijerarhije enkripcijskih ključeva su sledeći, **prvi nivo je master ključ, drugi nivo je klaster enkripcijski ključ, CEK, treći nivo, enkripcijski ključ baze podataka, DEK, i konačno četvrti nivo, sami enkripcijski ključevi podataka**.

### KMS

Tokom kreiranja vašeg klastera, možete odabrati **podrazumevani KMS ključ** za Redshift ili odabrati vaš **vlastiti CMK**, što vam daje veću fleksibilnost u kontroli ključa, posebno iz perspektive revizije.

Podrazumevani KMS ključ za Redshift automatski kreira Redshift prvi put kada se opcija ključa odabere i koristi, i njime u potpunosti upravlja AWS.

Ovaj KMS ključ je zatim enkriptovan sa CMK master ključem, prvi nivo. Ovaj enkriptovani KMS podatkovni ključ se zatim koristi kao klaster enkripcijski ključ, CEK, drugi nivo. Ovaj CEK zatim šalje KMS-u Redshift gde se čuva odvojeno od klastera. Redshift zatim šalje ovaj enkriptovani CEK klasteru preko sigurnog kanala gde se čuva u memoriji.

Redshift zatim zahteva od KMS-a da dekriptuje CEK, drugi nivo. Ovaj dekriptovani CEK se zatim takođe čuva u memoriji. Redshift zatim kreira nasumični enkripcijski ključ baze podataka, DEK, treći nivo, i učitava ga u memoriju klastera. Dekriptovani CEK u memoriji zatim enkriptuje DEK, koji se takođe čuva u memoriji.

Ovaj enkriptovani DEK se zatim šalje preko sigurnog kanala i čuva u Redshift-u odvojeno od klastera. I CEK i DEK su sada čuvani u memoriji klastera i u enkriptovanom i u dekriptovanom obliku. Dekriptovani DEK se zatim koristi za enkripciju ključeva podataka, četvrti nivo, koji su nasumično generisani od strane Redshift-a za svaki blok podataka u bazi podataka.

Možete koristiti AWS Trusted Advisor za praćenje konfiguracije vaših Amazon S3 bucket-a i osigurati da je logovanje bucket-a omogućeno, što može biti korisno za izvođenje sigurnosnih revizija i praćenje obrazaca korišćenja u S3.

### CloudHSM

<details>

<summary>Korišćenje Redshift-a sa CloudHSM</summary>

Kada radite sa CloudHSM za izvođenje enkripcije, prvo morate postaviti poverljivu vezu između vašeg HSM klijenta i Redshift-a koristeći klijentske i serverske sertifikate.

Ova veza je potrebna za obezbeđivanje sigurnih komunikacija, omogućavajući slanje enkripcijskih ključeva između vašeg HSM klijenta i vaših Redshift klastera. Korišćenjem nasumično generisanog privatnog i javnog para ključeva, Redshift kreira javni klijentski sertifikat, koji je enkriptovan i čuvan od strane Redshift-a. Ovo mora biti preuzeto i registrovano na vaš HSM klijent, i dodeljeno odgovarajućoj HSM particiji.

Zatim morate konfigurisati Redshift sa sledećim detaljima vašeg HSM klijenta: HSM IP adresa, naziv HSM particije, lozinka HSM particije, i javni HSM serverski sertifikat, koji je enkriptovan od strane CloudHSM koristeći interni master ključ. Kada su ovi podaci obezbeđeni, Redshift će potvrditi i verifikovati da može da se poveže i pristupi razvojnoj particiji.

Ako vaša interna sigurnosna pravila ili kontrola upravljanja nalažu da morate primeniti rotaciju ključeva, to je moguće sa Redshift-om omogućavajući vam da rotirate enkripcijske ključeve za enkriptovane klastere, međutim, morate biti svesni da će tokom procesa rotacije ključeva klaster biti nedostupan na vrlo kratko vreme, pa je najbolje rotirati ključeve samo kada je to potrebno, ili ako smatrate da su možda kompromitovani.

Tokom rotacije, Redshift će rotirati CEK za vaš klaster i za bilo koje bekape tog klastera. Rotiraće DEK za klaster, ali nije moguće rotirati DEK za snimke čuvane u S3 koji su enkriptovani koristeći DEK. Klaster će biti u stanju 'rotacije ključeva' dok se proces ne završi kada će status biti vraćen na 'dostupan'.

</details>

### Enumeration
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistence

Sledeće akcije omogućavaju dodeljivanje pristupa drugim AWS nalozima na klaster:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
