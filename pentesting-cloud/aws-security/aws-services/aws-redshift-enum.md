# AWS - Redshift Enum

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Amazon Redshift

Το Redshift είναι μια πλήρως διαχειριζόμενη υπηρεσία που μπορεί να κλιμακωθεί σε μέγεθος άνω του ενός petabyte, η οποία χρησιμοποιείται ως **αποθήκη δεδομένων για λύσεις μεγάλων δεδομένων**. Χρησιμοποιώντας Redshift clusters, μπορείτε να εκτελείτε αναλύσεις στα σύνολα δεδομένων σας χρησιμοποιώντας γρήγορα, εργαλεία ερωτημάτων SQL και εφαρμογές επιχειρηματικής ευφυΐας για να αποκτήσετε μεγαλύτερη κατανόηση και όραμα για την επιχείρησή σας.

**Το Redshift προσφέρει κρυπτογράφηση σε κατάσταση ηρεμίας χρησιμοποιώντας μια τετραεπίπεδη ιεραρχία κλειδιών κρυπτογράφησης χρησιμοποιώντας είτε KMS είτε CloudHSM για τη διαχείριση του ανώτατου επιπέδου κλειδιών**. **Όταν η κρυπτογράφηση είναι ενεργοποιημένη για το cluster σας, δεν μπορεί να απενεργοποιηθεί και το αντίστροφο**. Όταν έχετε ένα μη κρυπτογραφημένο cluster, δεν μπορεί να κρυπτογραφηθεί.

Η κρυπτογράφηση για το cluster σας μπορεί να γίνει μόνο κατά τη δημιουργία του, και μόλις κρυπτογραφηθεί, τα δεδομένα, τα μεταδεδομένα και οποιαδήποτε στιγμιότυπα είναι επίσης κρυπτογραφημένα. Το επίπεδο ιεράρχησης των κλειδιών κρυπτογράφησης είναι ως εξής, **το πρώτο επίπεδο είναι το κύριο κλειδί, το δεύτερο επίπεδο είναι το κλειδί κρυπτογράφησης του cluster, το CEK, το τρίτο επίπεδο, το κλειδί κρυπτογράφησης της βάσης δεδομένων, το DEK, και τέλος το τέταρτο επίπεδο, τα ίδια τα κλειδιά κρυπτογράφησης δεδομένων**.

### KMS

Κατά τη δημιουργία του cluster σας, μπορείτε είτε να επιλέξετε το **προεπιλεγμένο KMS κλειδί** για το Redshift είτε να επιλέξετε το **δικό σας CMK**, το οποίο σας δίνει μεγαλύτερη ευελιξία στον έλεγχο του κλειδιού, ειδικά από την άποψη της ελεγκτικής.

Το προεπιλεγμένο KMS κλειδί για το Redshift δημιουργείται αυτόματα από το Redshift την πρώτη φορά που επιλέγεται και χρησιμοποιείται η επιλογή κλειδιού, και διαχειρίζεται πλήρως από την AWS.

Αυτό το KMS κλειδί κρυπτογραφείται στη συνέχεια με το κύριο κλειδί CMK, το πρώτο επίπεδο. Αυτό το κρυπτογραφημένο KMS κλειδί δεδομένων χρησιμοποιείται στη συνέχεια ως το κλειδί κρυπτογράφησης του cluster, το CEK, το δεύτερο επίπεδο. Αυτό το CEK αποστέλλεται στη συνέχεια από το KMS στο Redshift όπου αποθηκεύεται ξεχωριστά από το cluster. Το Redshift αποστέλλει στη συνέχεια αυτό το κρυπτογραφημένο CEK στο cluster μέσω ενός ασφαλούς καναλιού όπου αποθηκεύεται στη μνήμη.

Το Redshift στη συνέχεια ζητά από το KMS να αποκρυπτογραφήσει το CEK, το δεύτερο επίπεδο. Αυτό το αποκρυπτογραφημένο CEK αποθηκεύεται επίσης στη μνήμη. Το Redshift στη συνέχεια δημιουργεί ένα τυχαίο κλειδί κρυπτογράφησης βάσης δεδομένων, το DEK, το τρίτο επίπεδο, και το φορτώνει στη μνήμη του cluster. Το αποκρυπτογραφημένο CEK στη μνήμη κρυπτογραφεί στη συνέχεια το DEK, το οποίο επίσης αποθηκεύεται στη μνήμη.

Αυτό το κρυπτογραφημένο DEK αποστέλλεται στη συνέχεια μέσω ενός ασφαλούς καναλιού και αποθηκεύεται στο Redshift ξεχωριστά από το cluster. Τόσο το CEK όσο και το DEK αποθηκεύονται τώρα στη μνήμη του cluster τόσο σε κρυπτογραφημένη όσο και σε αποκρυπτογραφημένη μορφή. Το αποκρυπτογραφημένο DEK χρησιμοποιείται στη συνέχεια για την κρυπτογράφηση των κλειδιών δεδομένων, το τέταρτο επίπεδο, που δημιουργούνται τυχαία από το Redshift για κάθε μπλοκ δεδομένων στη βάση δεδομένων.

Μπορείτε να χρησιμοποιήσετε το AWS Trusted Advisor για να παρακολουθείτε τη διαμόρφωση των Amazon S3 buckets σας και να διασφαλίσετε ότι η καταγραφή των buckets είναι ενεργοποιημένη, κάτι που μπορεί να είναι χρήσιμο για την εκτέλεση ελέγχων ασφαλείας και την παρακολούθηση των προτύπων χρήσης στο S3.

### CloudHSM

<details>

<summary>Χρήση του Redshift με το CloudHSM</summary>

Όταν εργάζεστε με το CloudHSM για να εκτελέσετε την κρυπτογράφησή σας, πρώτα πρέπει να δημιουργήσετε μια αξιόπιστη σύνδεση μεταξύ του HSM client σας και του Redshift χρησιμοποιώντας πιστοποιητικά client και server.

Αυτή η σύνδεση είναι απαραίτητη για να παρέχει ασφαλείς επικοινωνίες, επιτρέποντας την αποστολή κλειδιών κρυπτογράφησης μεταξύ του HSM client σας και των Redshift clusters σας. Χρησιμοποιώντας ένα τυχαία δημιουργημένο ζεύγος ιδιωτικού και δημόσιου κλειδιού, το Redshift δημιουργεί ένα δημόσιο πιστοποιητικό client, το οποίο κρυπτογραφείται και αποθηκεύεται από το Redshift. Αυτό πρέπει να κατεβαστεί και να καταχωρηθεί στον HSM client σας και να ανατεθεί στο σωστό HSM partition.

Πρέπει στη συνέχεια να διαμορφώσετε το Redshift με τις ακόλουθες λεπτομέρειες του HSM client σας: τη διεύθυνση IP του HSM, το όνομα του HSM partition, τον κωδικό πρόσβασης του HSM partition και το δημόσιο πιστοποιητικό server του HSM, το οποίο κρυπτογραφείται από το CloudHSM χρησιμοποιώντας ένα εσωτερικό κύριο κλειδί. Μόλις παρασχεθούν αυτές οι πληροφορίες, το Redshift θα επιβεβαιώσει και θα επαληθεύσει ότι μπορεί να συνδεθεί και να έχει πρόσβαση στο partition ανάπτυξης.

Εάν οι εσωτερικές πολιτικές ασφαλείας ή οι έλεγχοι διακυβέρνησης υπαγορεύουν ότι πρέπει να εφαρμόσετε περιστροφή κλειδιών, τότε αυτό είναι δυνατό με το Redshift επιτρέποντάς σας να περιστρέψετε τα κλειδιά κρυπτογράφησης για κρυπτογραφημένα clusters, ωστόσο, πρέπει να γνωρίζετε ότι κατά τη διαδικασία περιστροφής κλειδιών, το cluster θα είναι μη διαθέσιμο για πολύ σύντομο χρονικό διάστημα, και έτσι είναι καλύτερο να περιστρέφετε τα κλειδιά μόνο όταν είναι απαραίτητο ή αν πιστεύετε ότι μπορεί να έχουν παραβιαστεί.

Κατά την περιστροφή, το Redshift θα περιστρέψει το CEK για το cluster σας και για οποιαδήποτε αντίγραφα ασφαλείας αυτού του cluster. Θα περιστρέψει ένα DEK για το cluster αλλά δεν είναι δυνατό να περιστραφεί ένα DEK για τα στιγμιότυπα που αποθηκεύονται στο S3 και έχουν κρυπτογραφηθεί χρησιμοποιώντας το DEK. Θα θέσει το cluster σε κατάσταση 'rotating keys' μέχρι να ολοκληρωθεί η διαδικασία, όταν η κατάσταση θα επιστρέψει σε 'available'.

</details>

### Enumeration
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistence

Οι παρακάτω ενέργειες επιτρέπουν την παραχώρηση πρόσβασης σε άλλους λογαριασμούς AWS στο cluster:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Δείτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
