# AWS - IAM Post Exploitation

{% hint style="success" %}
AWS Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХреЛ рд╕рдорд░реНрдерди рджреЗрдВ</summary>

* [**subscription plans**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>
{% endhint %}

## IAM

IAM рдПрдХреНрд╕реЗрд╕ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП:

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

## Confused Deputy Problem

рдпрджрд┐ рдЖрдк **рдХрд┐рд╕реА рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ (A)** рдХреЛ рдЕрдкрдиреЗ рдЦрд╛рддреЗ рдореЗрдВ **role** рдПрдХреНрд╕реЗрд╕ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЗ рдкрд╛рд╕ **0 visibility** рд╣реЛрдЧреА рдХрд┐ **рдХреМрди рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЙрд╕ рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддрд╛ рд╣реИ**ред рдпрд╣ рдПрдХ рд╕рдорд╕реНрдпрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдпрджрд┐ рдХреЛрдИ рдЕрдиреНрдп рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ (B) рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ (A) рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **B рднреА рдЖрдкрдХреЗ рдЦрд╛рддреЗ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХреЗ**ред

рдЗрд╕рд▓рд┐рдП, рдЬрдм рдХрд┐рд╕реА рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ рдХреЛ рдЖрдкрдХреЗ рдЦрд╛рддреЗ рдореЗрдВ рдПрдХ role рдПрдХреНрд╕реЗрд╕ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреА рдЬрд╛рддреА рд╣реИ, рддреЛ `ExternalId` рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред рдпрд╣ рдПрдХ "рдЧреБрдкреНрдд" рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╣реИ рдЬрд┐рд╕реЗ рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ (A) рдХреЛ **рдЖрдкрдХреЗ рд╕рдВрдЧрдарди рдореЗрдВ role рдХреЛ assume рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ**ред рдЪреВрдВрдХрд┐ **рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ B рдЗрд╕ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЛ рдирд╣реАрдВ рдЬрд╛рдирддрд╛**, рднрд▓реЗ рд╣реА рдЙрд╕рдХреЗ рдкрд╛рд╕ A рдкрд░ рдкрд╣реБрдВрдЪ рд╣реЛ, рд╡рд╣ **рдЖрдкрдХреЗ role рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рд╣реЛрдЧрд╛**ред

<figure><img src="../../../.gitbook/assets/image (95).png" alt=""><figcaption></figcaption></figure>

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣ `ExternalId` "рдЧреБрдкреНрдд" **рдЧреБрдкреНрдд рдирд╣реАрдВ рд╣реИ**, рдХреЛрдИ рднреА рдЬреЛ **IAM assume role policy рдХреЛ рдкрдврд╝ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕реЗ рджреЗрдЦ рд╕рдХреЗрдЧрд╛**ред рд▓реЗрдХрд┐рди рдЬрдм рддрдХ рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ A рдЗрд╕реЗ рдЬрд╛рдирддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ **B рдЗрд╕реЗ рдирд╣реАрдВ рдЬрд╛рдирддрд╛**, рдпрд╣ **B рдХреЛ A рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдкрдХреЗ role рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рд╕реЗ рд░реЛрдХрддрд╛ рд╣реИ**ред

рдЙрджрд╛рд╣рд░рдг:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
{% hint style="warning" %}
рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдПрдХ confused deputy рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛рдирд╛ рд╣реЛрдЧрд╛ рдХрд┐ рдХреНрдпрд╛ рд╡рд░реНрддрдорд╛рди рдЦрд╛рддреЗ рдХреЗ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдЕрдиреНрдп рдЦрд╛рддреЛрдВ рдореЗрдВ рднреВрдорд┐рдХрд╛рдУрдВ рдХрд╛ рдкреНрд░рддрд┐рд░реВрдкрдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

### рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рдЯреНрд░рд╕реНрдЯреНрд╕

#### рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" },
}
```
рдпрд╣ рдиреАрддрд┐ **рд╕рднреА AWS** рдХреЛ рднреВрдорд┐рдХрд╛ рдЧреНрд░рд╣рдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред

#### Service as principal
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
рдпрд╣ рдиреАрддрд┐ **рдХрд┐рд╕реА рднреА рдЦрд╛рддреЗ рдХреЛ рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ** рдХрд┐ рд╡реЗ рдЕрдкрдиреЗ apigateway рдХреЛ рдЗрд╕ Lambda рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░ рд╕рдХреЗрдВред

#### S3 as principal
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
рдпрджрд┐ рдПрдХ S3 рдмрдХреЗрдЯ рдХреЛ рдПрдХ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ S3 рдмрдХреЗрдЯреНрд╕ рдХреЗ рдкрд╛рд╕ рдПрдХ рдЕрдХрд╛рдЙрдВрдЯ ID рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ, рдЕрдЧрд░ рдЖрдкрдиреЗ **рдЕрдкрдирд╛ рдмрдХреЗрдЯ рдбрд┐рд▓реАрдЯ рдХрд░ рджрд┐рдпрд╛ рдФрд░ рд╣рдорд▓рд╛рд╡рд░ рдиреЗ** рдЗрд╕реЗ рдЕрдкрдиреЗ рдЕрдХрд╛рдЙрдВрдЯ рдореЗрдВ рдмрдирд╛ рд▓рд┐рдпрд╛, рддреЛ рд╡реЗ рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

#### рд╕рдорд░реНрдерд┐рдд рдирд╣реАрдВ рд╣реИ
```json
{
"Effect": "Allow",
"Principal": {"Service": "cloudtrail.amazonaws.com"},
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
Confused Deputy рд╕рдорд╕реНрдпрд╛рдУрдВ рд╕реЗ рдмрдЪрдиреЗ рдХрд╛ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рддрд░реАрдХрд╛ `AWS:SourceArn` рдХреЗ рд╕рд╛рде рдПрдХ condition рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реИ рддрд╛рдХрд┐ origin ARN рдХреА рдЬрд╛рдВрдЪ рдХреА рдЬрд╛ рд╕рдХреЗред рд╣рд╛рд▓рд╛рдВрдХрд┐, **рдХреБрдЫ рд╕реЗрд╡рд╛рдПрдВ рдЗрд╕рдХрд╛ рд╕рдорд░реНрдерди рдирд╣реАрдВ рдХрд░ рд╕рдХрддреА рд╣реИрдВ** (рдЬреИрд╕реЗ рдХрд┐ рдХреБрдЫ рд╕реНрд░реЛрддреЛрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░ CloudTrail)ред

## References

* [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

{% hint style="success" %}
AWS Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХреЛ рд╕рдорд░реНрдерди рджреЗрдВ</summary>

* [**subscription plans**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>
{% endhint %}
