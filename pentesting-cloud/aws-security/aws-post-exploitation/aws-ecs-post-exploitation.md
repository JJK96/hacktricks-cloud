# AWS - ECS Post Exploitation

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ κάνοντας υποβολή PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## ECS

Για περισσότερες πληροφορίες ελέγξτε:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### Ρόλοι IAM του Κεντρικού Οικοδεσπότη

Στο ECS ένας **ρόλος IAM μπορεί να ανατεθεί στο task** που εκτελείται μέσα στο container. **Αν** το task εκτελείται μέσα σε ένα **EC2** instance, το **EC2 instance** θα έχει επισυναπτόμενο έναν **άλλο ρόλο IAM**.\
Αυτό σημαίνει ότι αν καταφέρετε να **διαρρεύσετε** ένα ECS instance, μπορείτε πιθανώς να **αποκτήσετε τον ρόλο IAM που σχετίζεται με το ECR και το EC2 instance**. Για περισσότερες πληροφορίες σχετικά με το πώς να λάβετε αυτές τις διαπιστεύσεις, ελέγξτε:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

{% hint style="danger" %}
Σημειώστε ότι αν το EC2 instance επιβάλλει το IMDSv2, [**σύμφωνα με τα έγγραφα**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html), η **απάντηση του αιτήματος PUT** θα έχει ένα **όριο hop του 1**, κάνοντας αδύνατη την πρόσβαση στα μεταδεδομένα του EC2 από ένα container μέσα στο EC2 instance.
{% endhint %}

### Ανύψωση δικαιωμάτων στον κόμβο για να κλέψετε τις διαπιστεύσεις & τα μυστικά άλλων containers

Αλλά επιπλέον, το EC2 χρησιμοποιεί το docker για την εκτέλεση των εργασιών του ECS, οπότε αν μπορείτε να δραπετεύσετε στον κόμβο ή **να έχετε πρόσβαση στο socket του docker**, μπορείτε να **ελέγξετε** ποια **άλλα containers** εκτελούνται, και ακόμη **να μπείτε μέσα σε αυτά** και **να κλέψετε τους ρόλους IAM** που είναι επισυναπτυμένοι.

#### Εκτέλεση containers στον τρέχοντα κόμβο

Επιπλέον, ο **ρόλος του EC2 instance** θα έχει συνήθως αρκετές **άδειες** για να **ενημερώσει την κατάσταση της εργασίας του container instance** των EC2 instances που χρησιμοποιούνται ως κόμβοι μέσα στο cluster. Ένας επιτιθέμενος θα μπορούσε να τροποποιήσει τη **κατάσταση μιας εργασίας σε DRAINING**, τότε το ECS θα **αφαιρέσει όλες τις εργασίες από αυτήν** και αυτές που εκτελούνται ως **REPLICA** θα εκτελεστούν σε ένα διαφορετικό instance, πιθανώς μέσα στο **instance του επιτιθέμενου** ώστε να μπορεί **να κλέψει τους ρόλους IAM** και πιθανά ευαίσθητες πληροφορίες από μέσα στο container.
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
Η ίδια τεχνική μπορεί να γίνει με το **απεγγραφή της EC2 μονάδας από το cluster**. Αυτό είναι ενδεχομένως λιγότερο αόρατο, αλλά θα **αναγκάσει τα tasks να εκτελεστούν σε άλλες μονάδες:**
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
Μια τελική τεχνική για να αναγκαστεί η επανεκτέλεση των εργασιών είναι να υποδείξετε στο ECS ότι η **εργασία ή το container διακόπηκε**. Υπάρχουν 3 πιθανά APIs για να το επιτύχετε:
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### Κλοπή ευαίσθητων πληροφοριών από τα containers του ECR

Η EC2 instance πιθανότατα θα έχει επίσης την άδεια `ecr:GetAuthorizationToken` που της επιτρέπει να **κατεβάζει εικόνες** (μπορείτε να αναζητήσετε ευαίσθητες πληροφορίες μέσα σε αυτές).
