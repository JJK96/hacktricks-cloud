# AWS - ECSポストエクスプロイテーション

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して**ハッキングトリックを共有**してください。

</details>
{% endhint %}

## ECS

詳細は以下を参照してください:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### ホストIAMロール

ECSでは、コンテナ内で実行されているタスクに**IAMロールを割り当てる**ことができます。タスクが**EC2**インスタンス内で実行されている場合、**EC2インスタンス**には別のIAMロールがアタッチされています。\
つまり、ECSインスタンスを**侵害**することができれば、ECRおよびEC2インスタンスに関連付けられたIAMロールを**取得**する可能性があります。これらの資格情報を取得する方法について詳細は以下を参照してください:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

{% hint style="danger" %}
EC2インスタンスがIMDSv2を強制している場合、[**ドキュメントによると**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html)、**PUTリクエストの応答**には**ホップ制限が1**があり、EC2インスタンス内のコンテナからEC2メタデータにアクセスすることができなくなります。
{% endhint %}

### ノードへの昇格による他のコンテナの資格情報とシークレットの盗み出し

さらに、EC2はECsタスクを実行するためにdockerを使用しているため、ノードに脱出したり**dockerソケットにアクセス**したりすると、実行されている**他のコンテナ**を確認し、それらに**アクセス**して**アタッチされたIAMロール**を盗むことができます。

#### 現在のホストでコンテナを実行する

さらに、**EC2インスタンスロール**には通常、クラスタ内のノードとして使用されているEC2インスタンスの**コンテナインスタンスの状態を更新する**ための十分な**権限**があります。攻撃者はインスタンスの状態を**DRAINING**に変更することができ、その後ECSは**それからすべてのタスクを削除**し、**REPLICA**として実行されているタスクは**別のインスタンスで実行**されるようになり、攻撃者のインスタンス内で**アタッチされたIAMロール**やコンテナ内の機密情報を盗むことができます。
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
同じテクニックは、クラスタからEC2インスタンスを登録解除することで行うこともできます。これは潜在的にはステルス性が低いかもしれませんが、他のインスタンスでタスクが実行されるように**強制**します。
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
最後のテクニックは、ECSに**タスクまたはコンテナが停止**されたことを示すことで、タスクの再実行を強制する方法です。これを行うための潜在的なAPIは3つあります：
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### ECRコンテナから機密情報を盗む

EC2インスタンスはおそらく`ecr:GetAuthorizationToken`権限も持っており、それにより**イメージをダウンロード**できます（それらに機密情報が含まれている可能性があります）。
