# AWS - P√≥s-Explora√ß√£o do ECS

{% hint style="success" %}
Aprenda e pratique Hacking na AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line"> [**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte) <img src="/.gitbook/assets/image.png" alt="" data-size="line"> \
Aprenda e pratique Hacking no GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line"> [**Treinamento HackTricks GCP Red Team Expert (GRTE)** <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

- Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
- **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
- **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## ECS

Para mais informa√ß√µes, consulte:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### Fun√ß√µes IAM do Host

No ECS, uma **fun√ß√£o IAM pode ser atribu√≠da √† tarefa** em execu√ß√£o dentro do cont√™iner. **Se** a tarefa for executada dentro de uma **inst√¢ncia EC2**, a **inst√¢ncia EC2** ter√° **outra fun√ß√£o IAM** anexada a ela.\
Isso significa que se voc√™ conseguir **comprometer** uma inst√¢ncia ECS, potencialmente poder√° **obter a fun√ß√£o IAM associada ao ECR e √† inst√¢ncia EC2**. Para mais informa√ß√µes sobre como obter essas credenciais, consulte:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

{% hint style="danger" %}
Observe que se a inst√¢ncia EC2 estiver aplicando o IMDSv2, [**conforme a documenta√ß√£o**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html), a **resposta da solicita√ß√£o PUT** ter√° um **limite de salto de 1**, tornando imposs√≠vel acessar os metadados da EC2 de um cont√™iner dentro da inst√¢ncia EC2.
{% endhint %}

### Privil√©gios para o n√≥ para roubar credenciais e segredos de outros cont√™ineres

Al√©m disso, o EC2 usa o docker para executar tarefas do ECS, ent√£o se voc√™ conseguir escapar para o n√≥ ou **acessar o socket do docker**, voc√™ pode **verificar** quais **outros cont√™ineres** est√£o sendo executados e at√© **entrar neles** e **roubar suas fun√ß√µes IAM** anexadas.

#### Fazendo cont√™ineres serem executados no host atual

Al√©m disso, a **fun√ß√£o da inst√¢ncia EC2** geralmente ter√° permiss√µes suficientes para **atualizar o estado da inst√¢ncia do cont√™iner** das inst√¢ncias EC2 sendo usadas como n√≥s dentro do cluster. Um atacante poderia modificar o **estado de uma inst√¢ncia para DRAINING**, ent√£o o ECS ir√° **remover todas as tarefas dela** e as que est√£o sendo executadas como **REPLICA** ser√£o **executadas em uma inst√¢ncia diferente**, potencialmente dentro da **inst√¢ncia do atacante** para que ele possa **roubar suas fun√ß√µes IAM** e informa√ß√µes sens√≠veis potenciais de dentro do cont√™iner.
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
A mesma t√©cnica pode ser feita ao **remover o registro da inst√¢ncia EC2 do cluster**. Isso √© potencialmente menos furtivo, mas ir√° **for√ßar as tarefas a serem executadas em outras inst√¢ncias:**
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
Uma t√©cnica final para for√ßar a reexecu√ß√£o de tarefas √© indicar ao ECS que a **tarefa ou cont√™iner foi interrompido**. Existem 3 APIs potenciais para fazer isso:
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### Roubar informa√ß√µes sens√≠veis dos cont√™ineres ECR

A inst√¢ncia EC2 provavelmente ter√° permiss√£o `ecr:GetAuthorizationToken` permitindo **baixar imagens** (voc√™ poderia procurar informa√ß√µes sens√≠veis nelas).
