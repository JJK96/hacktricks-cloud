# AWS - ECS Na-Exploitation

{% hint style="success" %}
Leer & oefen AWS Hack:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

## ECS

Vir meer inligting kyk:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### Gasheer IAM-rolle

In ECS kan 'n **IAM-rol toegewys word aan die taak** wat binne die houer hardloop. **As** die taak binne 'n **EC2**-instansie hardloop, sal die **EC2-instansie** 'n **ander IAM-rol** daaraan geheg h√™.\
Dit beteken dat as jy daarin slaag om 'n ECS-instansie te **kompromiteer**, kan jy potensieel die IAM-rol wat aan die ECR en aan die EC2-instansie gekoppel is, **verkry**. Vir meer inligting oor hoe om daardie geloofsbriewe te kry, kyk:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

{% hint style="danger" %}
Let daarop dat as die EC2-instansie IMDSv2 afdwing, [**volgens die dokumente**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html), sal die **antwoord van die PUT-aanvraag** 'n **hop-limiet van 1** h√™, wat dit onmoontlik maak om die EC2-metadata van 'n houer binne die EC2-instansie te bereik.
{% endhint %}

### Privesc na node om ander houers se geloofsbriewe & geheime te steel

Maar boonop gebruik EC2 docker om ECs take uit te voer, so as jy na die node kan ontsnap of die **docker-socket kan bereik**, kan jy **kontroleer** watter **ander houers** uitgevoer word, en selfs **daarin kom** en hul **IAM-rolle** wat daaraan geheg is, **steel**.

#### Laat houers op die huidige gasheer hardloop

Verder sal die **EC2-instansierol** gewoonlik genoeg **toestemmings** h√™ om die **staat van die houerinstansie** van die EC2-instansies wat as nodes binne die groep gebruik word, te **opdateer**. 'n Aanvaller kan die **staat van 'n instansie verander na DRAINING**, dan sal ECS **alle take daarvan verwyder** en diegene wat as **REPLICA** uitgevoer word, sal op 'n ander instansie **hardloop**, moontlik binne die **aanvaller se instansie** sodat hy hul **IAM-rolle** en potensi√´le sensitiewe inligting van binne die houer kan **steel**.
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
Dieselfde tegniek kan uitgevoer word deur die EC2-instantie van die groep af te meld. Dit is moontlik minder heimlik, maar dit sal die take dwing om op ander instansies uitgevoer te word:
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
'n Laaste tegniek om die heruitvoering van take af te dwing, is deur ECS aan te dui dat die **taak of houer gestop is**. Daar is 3 potensi√´le API's om dit te doen:
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### Steel sensitiewe inligting uit ECR-houers

Die EC2-instantie sal waarskynlik ook die toestemming `ecr:GetAuthorizationToken` h√™ wat dit in staat stel om **afbeeldings af te laai** (jy kan soek na sensitiewe inligting daarin). 

{% hint style="success" %}
Leer & oefen AWS Hack: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
