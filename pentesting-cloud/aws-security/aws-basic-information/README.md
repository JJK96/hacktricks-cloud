# AWS - Información Básica

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripción**](https://github.com/sponsors/carlospolop)!
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Jerarquía de la Organización

![](<../../../.gitbook/assets/image (151).png>)

### Cuentas

En AWS hay una **cuenta raíz**, que es el **contenedor principal para todas las cuentas** de tu **organización**. Sin embargo, no necesitas usar esa cuenta para desplegar recursos, puedes crear **otras cuentas para separar diferentes infraestructuras de AWS** entre ellas.

Esto es muy interesante desde un punto de vista de **seguridad**, ya que **una cuenta no podrá acceder a los recursos de otra cuenta** (excepto que se creen puentes específicamente), de esta manera puedes crear límites entre despliegues.

Por lo tanto, hay **dos tipos de cuentas en una organización** (estamos hablando de cuentas de AWS y no de cuentas de Usuario): una sola cuenta que se designa como la cuenta de administración, y una o más cuentas miembro.

*   La **cuenta de administración (la cuenta raíz)** es la cuenta que usas para crear la organización. Desde la cuenta de administración de la organización, puedes hacer lo siguiente:

* Crear cuentas en la organización
* Invitar otras cuentas existentes a la organización
* Eliminar cuentas de la organización
* Gestionar invitaciones
* Aplicar políticas a entidades (raíces, OUs o cuentas) dentro de la organización
* Habilitar la integración con servicios compatibles de AWS para proporcionar funcionalidad de servicio en todas las cuentas de la organización.
* Es posible iniciar sesión como el usuario raíz usando el correo electrónico y la contraseña utilizados para crear esta cuenta raíz/organización.

La cuenta de administración tiene las **responsabilidades de una cuenta pagadora** y es responsable de pagar todos los cargos que acumulen las cuentas miembro. No puedes cambiar la cuenta de administración de una organización.
* **Cuentas miembro** componen el resto de las cuentas en una organización. Una cuenta solo puede ser miembro de una organización a la vez. Puedes adjuntar una política a una cuenta para aplicar controles solo a esa cuenta.
* Las cuentas miembro **deben usar una dirección de correo electrónico válida** y pueden tener un **nombre**, en general no podrán gestionar la facturación (pero se les puede dar acceso a ella).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Organization Units**

Las cuentas pueden agruparse en **Organization Units (OU)**. De esta manera, puedes crear **políticas** para la Organization Unit que se van a **aplicar a todas las cuentas hijas**. Ten en cuenta que una OU puede tener otras OUs como hijas.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Service Control Policy (SCP)

Una **service control policy (SCP)** es una política que especifica los servicios y acciones que los usuarios y roles pueden usar en las cuentas que afecta la SCP. Las SCPs son **similares a las políticas de permisos de IAM** excepto que **no otorgan ningún permiso**. En su lugar, las SCPs especifican los **permisos máximos** para una organización, unidad organizativa (OU) o cuenta. Cuando adjuntas una SCP a la raíz de tu organización o a una OU, la **SCP limita los permisos para las entidades en las cuentas miembro**.

Esta es la ÚNICA forma en que **incluso el usuario root puede ser detenido** de hacer algo. Por ejemplo, podría usarse para evitar que los usuarios deshabiliten CloudTrail o eliminen copias de seguridad.\
La única forma de evitar esto es comprometer también la **cuenta maestra** que configura las SCPs (la cuenta maestra no puede ser bloqueada).

{% hint style="warning" %}
Ten en cuenta que **las SCPs solo restringen a los principales en la cuenta**, por lo que otras cuentas no se ven afectadas. Esto significa que tener una SCP que deniegue `s3:GetObject` no impedirá que las personas **accedan a un bucket S3 público** en tu cuenta.
{% endhint %}

Ejemplos de SCP:

* Denegar completamente la cuenta root
* Permitir solo regiones específicas
* Permitir solo servicios en la lista blanca
*   Denegar que GuardDuty, CloudTrail y S3 Public Block Access sean deshabilitados
*   Denegar que los roles de seguridad/respuesta a incidentes sean eliminados o modificados.
* Denegar que se eliminen copias de seguridad.
* Denegar la creación de usuarios IAM y claves de acceso

Encuentra **ejemplos JSON** en [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)

### ARN

**Amazon Resource Name** es el **nombre único** que cada recurso dentro de AWS tiene, se compone de la siguiente manera:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Note que hay 4 particiones en AWS pero solo 3 formas de llamarlas:

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US public Internet (GovCloud): `aws-us-gov`
* AWS Secret (US Classified): `aws`

## IAM - Identity and Access Management

IAM es el servicio que te permitirá gestionar la **Autenticación**, **Autorización** y **Control de Acceso** dentro de tu cuenta de AWS.

* **Autenticación** - Proceso de definir una identidad y la verificación de esa identidad. Este proceso se puede subdividir en: Identificación y verificación.
* **Autorización** - Determina a qué puede acceder una identidad dentro de un sistema una vez que ha sido autenticada.
* **Control de Acceso** - El método y proceso de cómo se concede acceso a un recurso seguro.

IAM se puede definir por su capacidad para gestionar, controlar y gobernar los mecanismos de autenticación, autorización y control de acceso de identidades a tus recursos dentro de tu cuenta de AWS.

### [Usuario raíz de la cuenta de AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Cuando creas por primera vez una cuenta de Amazon Web Services (AWS), comienzas con una única identidad de inicio de sesión que tiene **acceso completo a todos** los servicios y recursos de AWS en la cuenta. Este es el _**usuario raíz**_ de la cuenta de AWS y se accede iniciando sesión con la **dirección de correo electrónico y la contraseña que usaste para crear la cuenta**.

Ten en cuenta que un nuevo **usuario administrador** tendrá **menos permisos que el usuario raíz**.

Desde un punto de vista de seguridad, se recomienda crear otros usuarios y evitar usar este.

### [Usuarios IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

Un _usuario_ IAM es una entidad que creas en AWS para **representar a la persona o aplicación** que lo usa para **interactuar con AWS**. Un usuario en AWS consiste en un nombre y credenciales (contraseña y hasta dos claves de acceso).

Cuando creas un usuario IAM, le otorgas **permisos** haciéndolo miembro de un **grupo de usuarios** que tiene políticas de permisos apropiadas adjuntas (recomendado), o **adjuntando directamente políticas** al usuario.

Los usuarios pueden tener **MFA habilitado para iniciar sesión** a través de la consola. Los tokens API de usuarios con MFA habilitado no están protegidos por MFA. Si deseas **restringir el acceso de las claves API de un usuario usando MFA** necesitas indicar en la política que para realizar ciertas acciones MFA debe estar presente (ejemplo [**aquí**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)).

#### CLI

* **Access Key ID**: 20 caracteres alfanuméricos aleatorios en mayúsculas como AKHDNAPO86BSHKDIRYT
* **Secret access key ID**: 40 caracteres aleatorios en mayúsculas y minúsculas: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (No es posible recuperar IDs de claves de acceso secretas perdidas).

Siempre que necesites **cambiar la Clave de Acceso** este es el proceso que debes seguir:\
_Crear una nueva clave de acceso -> Aplicar la nueva clave al sistema/aplicación -> marcar la original como inactiva -> Probar y verificar que la nueva clave de acceso funciona -> Eliminar la clave de acceso antigua_

### MFA - Autenticación Multifactor

Se usa para **crear un factor adicional para la autenticación** además de tus métodos existentes, como la contraseña, creando así un nivel de autenticación multifactor.\
Puedes usar una **aplicación virtual gratuita o un dispositivo físico**. Puedes usar aplicaciones como google authentication de forma gratuita para activar un MFA en AWS.

Las políticas con condiciones MFA se pueden adjuntar a lo siguiente:

* Un usuario o grupo IAM
* Un recurso como un bucket de Amazon S3, una cola de Amazon SQS o un tema de Amazon SNS
* La política de confianza de un rol IAM que puede ser asumido por un usuario

Si deseas **acceder vía CLI** a un recurso que **verifica MFA** necesitas llamar a **`GetSessionToken`**. Eso te dará un token con información sobre MFA.\
Ten en cuenta que **las credenciales de `AssumeRole` no contienen esta información**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
Como [**se indica aquí**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), hay muchos casos diferentes donde **MFA no puede ser utilizado**.

### [Grupos de usuarios IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Un [grupo de usuarios](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) de IAM es una forma de **adjuntar políticas a múltiples usuarios** al mismo tiempo, lo que puede facilitar la gestión de los permisos para esos usuarios. **Roles y grupos no pueden ser parte de un grupo**.

Puedes adjuntar una **política basada en identidad a un grupo de usuarios** para que todos los **usuarios** en el grupo de usuarios **reciban los permisos de la política**. **No puedes** identificar un **grupo de usuarios** como un **`Principal`** en una **política** (como una política basada en recursos) porque los grupos se relacionan con permisos, no con autenticación, y los principales son entidades IAM autenticadas.

Aquí hay algunas características importantes de los grupos de usuarios:

* Un **grupo** de usuarios puede **contener muchos usuarios**, y un **usuario** puede **pertenecer a múltiples grupos**.
* **Los grupos de usuarios no pueden anidarse**; solo pueden contener usuarios, no otros grupos de usuarios.
* No hay **ningún grupo de usuarios predeterminado que incluya automáticamente a todos los usuarios en la cuenta de AWS**. Si deseas tener un grupo de usuarios así, debes crearlo y asignar cada nuevo usuario a él.
* El número y tamaño de los recursos IAM en una cuenta de AWS, como el número de grupos y el número de grupos de los que un usuario puede ser miembro, están limitados. Para más información, consulta [Cuotas de IAM y AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html).

### [Roles IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Un **rol** de IAM es muy **similar** a un **usuario**, en el sentido de que es una **identidad con políticas de permisos que determinan qué** puede y no puede hacer en AWS. Sin embargo, un rol **no tiene credenciales** (contraseña o claves de acceso) asociadas con él. En lugar de estar asociado de manera única con una persona, un rol está destinado a ser **asumido por cualquiera que lo necesite (y tenga suficientes permisos)**. Un **usuario IAM puede asumir un rol para** temporalmente **tomar diferentes permisos para una tarea específica**. Un rol puede ser **asignado a un** [**usuario federado**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html) que inicia sesión utilizando un proveedor de identidad externo en lugar de IAM.

Un rol IAM consiste en **dos tipos de políticas**: Una **política de confianza**, que no puede estar vacía, definiendo **quién puede asumir** el rol, y una **política de permisos**, que no puede estar vacía, definiendo **a qué puede acceder**.

#### AWS Security Token Service (STS)

AWS Security Token Service (STS) es un servicio web que facilita la **emisión de credenciales temporales y de privilegios limitados**. Está específicamente diseñado para:

### [Credenciales temporales en IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Las credenciales temporales se utilizan principalmente con roles IAM**, pero también hay otros usos. Puedes solicitar credenciales temporales que tengan un conjunto de permisos más restringido que tu usuario IAM estándar. Esto **previene** que **realices accidentalmente tareas que no están permitidas** por las credenciales más restringidas. Un beneficio de las credenciales temporales es que expiran automáticamente después de un período de tiempo establecido. Tienes control sobre la duración en que las credenciales son válidas.

### Políticas

#### Permisos de Política

Se utilizan para asignar permisos. Hay 2 tipos:

* Políticas gestionadas por AWS (preconfiguradas por AWS)
* Políticas gestionadas por el cliente: Configuradas por ti. Puedes crear políticas basadas en políticas gestionadas por AWS (modificando una de ellas y creando la tuya propia), utilizando el generador de políticas (una vista GUI que te ayuda a otorgar y denegar permisos) o escribiendo la tuya propia.

Por **defecto, el acceso** está **denegado**, el acceso será concedido si se ha especificado un rol explícito.\
Si **existe un único "Deny", anulará el "Allow"**, excepto para las solicitudes que utilicen las credenciales de seguridad raíz de la cuenta de AWS (que están permitidas por defecto).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
Los [campos globales que se pueden usar para condiciones en cualquier servicio están documentados aquí](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount).\
Los [campos específicos que se pueden usar para condiciones por servicio están documentados aquí](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html).

#### Inline Policies

Este tipo de políticas se **asignan directamente** a un usuario, grupo o rol. Luego, no aparecen en la lista de Policies como cualquier otra que pueda ser utilizada.\
Las inline policies son útiles si deseas **mantener una relación estricta uno a uno entre una política y la identidad** a la que se aplica. Por ejemplo, quieres asegurarte de que los permisos en una política no se asignen inadvertidamente a una identidad distinta de aquella para la que están destinados. Cuando usas una inline policy, los permisos en la política no pueden ser adjuntados inadvertidamente a la identidad incorrecta. Además, cuando usas la AWS Management Console para eliminar esa identidad, las políticas incrustadas en la identidad también se eliminan. Esto se debe a que son parte de la entidad principal.

#### Resource Bucket Policies

Estas son **políticas** que pueden definirse en **recursos**. **No todos los recursos de AWS las soportan**.

Si un principal no tiene una denegación explícita sobre ellos, y una resource policy les otorga acceso, entonces se les permite.

### IAM Boundaries

Las IAM boundaries pueden usarse para **limitar los permisos a los que un usuario o rol debería tener acceso**. De esta manera, incluso si un conjunto diferente de permisos es otorgado al usuario por una **política diferente**, la operación **fallará** si intenta usarlos.

Una boundary es solo una política adjunta a un usuario que **indica el nivel máximo de permisos que el usuario o rol puede tener**. Así que, **incluso si el usuario tiene acceso de Administrador**, si la boundary indica que solo puede leer S3 buckets, eso es lo máximo que puede hacer.

**Esto**, **SCPs** y **seguir el principio de menor privilegio** son las formas de controlar que los usuarios no tengan más permisos de los que necesitan.

### Session Policies

Una session policy es una **política establecida cuando se asume un rol** de alguna manera. Esto será como una **IAM boundary para esa sesión**: Esto significa que la session policy no otorga permisos, sino que **los restringe a los indicados en la política** (siendo los permisos máximos los que tiene el rol).

Esto es útil para **medidas de seguridad**: Cuando un administrador va a asumir un rol muy privilegiado, podría restringir los permisos solo a los indicados en la session policy en caso de que la sesión se vea comprometida.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Note que por defecto **AWS podría agregar políticas de sesión a las sesiones** que se van a generar por otras razones. Por ejemplo, en [roles asumidos de cognito no autenticados](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) por defecto (usando autenticación mejorada), AWS generará **credenciales de sesión con una política de sesión** que limita los servicios a los que esa sesión puede acceder [**a la siguiente lista**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Por lo tanto, si en algún momento te enfrentas al error "... porque ninguna política de sesión permite el ...", y el rol tiene acceso para realizar la acción, es porque **hay una política de sesión que lo impide**.

### Federación de Identidad

La federación de identidad **permite a los usuarios de proveedores de identidad que son externos** a AWS acceder a los recursos de AWS de manera segura sin tener que proporcionar credenciales de usuario de AWS desde una cuenta de usuario IAM válida.\
Un ejemplo de un proveedor de identidad puede ser tu propio **Microsoft Active Directory** corporativo (a través de **SAML**) o servicios **OpenID** (como **Google**). El acceso federado permitirá entonces a los usuarios dentro de él acceder a AWS.

Para configurar esta confianza, se genera un **Proveedor de Identidad IAM (SAML u OAuth)** que **confiará** en la **otra plataforma**. Luego, se asigna al menos un **rol IAM (confiando) al Proveedor de Identidad**. Si un usuario de la plataforma confiada accede a AWS, lo hará como el rol mencionado.

Sin embargo, usualmente querrás dar un **rol diferente dependiendo del grupo del usuario** en la plataforma de terceros. Entonces, varios **roles IAM pueden confiar** en el Proveedor de Identidad de terceros y la plataforma de terceros será la que permita a los usuarios asumir un rol u otro.

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### IAM Identity Center

AWS IAM Identity Center (sucesor de AWS Single Sign-On) amplía las capacidades de AWS Identity and Access Management (IAM) para proporcionar un **lugar central** que reúne la **administración de usuarios y su acceso a cuentas de AWS** y aplicaciones en la nube.

El dominio de inicio de sesión será algo como `<user_input>.awsapps.com`.

Para iniciar sesión a los usuarios, se pueden usar 3 fuentes de identidad:

* Identity Center Directory: Usuarios regulares de AWS
* Active Directory: Soporta diferentes conectores
* Proveedor de Identidad Externo: Todos los usuarios y grupos provienen de un Proveedor de Identidad Externo (IdP)

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

En el caso más simple del directorio de Identity Center, el **Identity Center tendrá una lista de usuarios y grupos** y podrá **asignar políticas** a ellos para **cualquiera de las cuentas** de la organización.

Para dar acceso a un usuario/grupo de Identity Center a una cuenta, se creará un **Proveedor de Identidad SAML confiando en el Identity Center**, y se creará un **rol confiando en el Proveedor de Identidad con las políticas indicadas** en la cuenta de destino.

#### AwsSSOInlinePolicy

Es posible **dar permisos a través de políticas inline a roles creados vía IAM Identity Center**. Los roles creados en las cuentas que reciben **políticas inline en AWS Identity Center** tendrán estos permisos en una política inline llamada **`AwsSSOInlinePolicy`**.

Por lo tanto, incluso si ves 2 roles con una política inline llamada **`AwsSSOInlinePolicy`**, **no significa que tengan los mismos permisos**.

### Confianzas y Roles entre Cuentas

**Un usuario** (confiando) puede crear un Rol entre Cuentas con algunas políticas y luego, **permitir a otro usuario** (confiado) **acceder a su cuenta** pero solo **teniendo el acceso indicado en las nuevas políticas del rol**. Para crear esto, solo crea un nuevo Rol y selecciona Rol entre Cuentas. Los Roles para Acceso entre Cuentas ofrecen dos opciones. Proporcionar acceso entre cuentas de AWS que posees, y proporcionar acceso entre una cuenta que posees y una cuenta de AWS de terceros.\
Se recomienda **especificar el usuario que es confiado y no poner algo genérico** porque si no, otros usuarios autenticados como usuarios federados también podrán abusar de esta confianza.

### AWS Simple AD

No soportado:

* Relaciones de Confianza
* Centro de Administración de AD
* Soporte completo de la API de PS
* Papelera de reciclaje de AD
* Cuentas de Servicio Administradas por Grupo
* Extensiones de Esquema
* Sin acceso directo al SO o Instancias

#### Federación Web o Autenticación OpenID

La aplicación usa AssumeRoleWithWebIdentity para crear credenciales temporales. Sin embargo, esto no otorga acceso a la consola de AWS, solo acceso a recursos dentro de AWS.

### Otras opciones de IAM

* Puedes **establecer una política de contraseñas** configurando opciones como longitud mínima y requisitos de contraseña.
* Puedes **descargar el "Informe de Credenciales"** con información sobre las credenciales actuales (como el tiempo de creación del usuario, si la contraseña está habilitada...). Puedes generar un informe de credenciales tan a menudo como una vez cada **cuatro horas**.

AWS Identity and Access Management (IAM) proporciona **control de acceso detallado** en todo AWS. Con IAM, puedes especificar **quién puede acceder a qué servicios y recursos**, y bajo qué condiciones. Con las políticas de IAM, gestionas permisos para tu fuerza laboral y sistemas para **asegurar permisos de menor privilegio**.

### Prefijos de ID de IAM

En [**esta página**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) puedes encontrar los **prefijos de ID de IAM** de las claves dependiendo de su naturaleza:

| ABIA | [Token portador del servicio AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Credencial específica del contexto                                                                                                                                                                                           |
| AGPA | Grupo de usuarios                                                                                                                                                                                                            |
| AIDA | Usuario IAM                                                                                                                                                                                                              |
| AIPA | Perfil de instancia de Amazon EC2                                                                                                                                                                                           |
| AKIA | Clave de acceso                                                                                                                                                                                                            |
| ANPA | Política gestionada                                                                                                                                                                                                        |
| ANVA | Versión en una política gestionada                                                                                                                                                                                           |
| APKA | Clave pública                                                                                                                                                                                                            |
| AROA | Rol                                                                                                                                                                                                                  |
| ASCA | Certificado                                                                                                                                                                                                           |
| ASIA | [IDs de claves de acceso temporales (AWS STS)](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) usan este prefijo, pero son únicos solo en combinación con la clave de acceso secreta y el token de sesión. |

### Permisos recomendados para auditar cuentas

Los siguientes privilegios otorgan varios accesos de lectura de metadatos:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Varios

### Autenticación CLI

Para que un usuario regular se autentique en AWS a través de CLI, necesitas tener **credenciales locales**. Por defecto, puedes configurarlas **manualmente** en `~/.aws/credentials` o **ejecutando** `aws configure`.\
En ese archivo puedes tener más de un perfil, si **no se especifica ningún perfil** usando el **aws cli**, se usará el llamado **`[default]`** en ese archivo.\
Ejemplo de archivo de credenciales con más de 1 perfil:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Si necesitas acceder a **diferentes cuentas de AWS** y tu perfil tiene acceso para **asumir un rol dentro de esas cuentas**, no necesitas llamar manualmente a STS cada vez (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) y configurar las credenciales.

Puedes usar el archivo `~/.aws/config` para [**indicar qué roles asumir**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), y luego usar el parámetro `--profile` como de costumbre (el `assume-role` se realizará de manera transparente para el usuario).\
Un ejemplo de archivo de configuración:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Con este archivo de configuración, puedes usar aws cli como:
```
aws --profile acc2 ...
```
Si estás buscando algo **similar** a esto pero para el **navegador** puedes revisar la **extensión** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## Referencias

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Revisa los [**planes de suscripción**](https://github.com/sponsors/carlospolop)!
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
