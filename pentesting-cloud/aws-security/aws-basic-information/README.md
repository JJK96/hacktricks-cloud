# AWS - Informazioni di Base

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}

## Gerarchia dell'Organizzazione

![](<../../../.gitbook/assets/image (151).png>)

### Account

In AWS c'√® un **account root**, che √® il **contenitore principale per tutti gli account** della tua **organizzazione**. Tuttavia, non √® necessario utilizzare quell'account per distribuire risorse, puoi creare **altri account per separare le diverse infrastrutture AWS** tra di loro.

Questo √® molto interessante dal punto di vista della **sicurezza**, poich√© **un account non sar√† in grado di accedere alle risorse di un altro account** (a meno che non vengano creati collegamenti specifici), in questo modo puoi creare confini tra le distribuzioni.

Pertanto, ci sono **due tipi di account in un'organizzazione** (stiamo parlando di account AWS e non di account utente): un singolo account designato come account di gestione e uno o pi√π account membri.

*   L'**account di gestione (l'account root)** √® l'account che usi per creare l'organizzazione. Dall'account di gestione dell'organizzazione, puoi fare quanto segue:

* Creare account nell'organizzazione
* Invitare altri account esistenti nell'organizzazione
* Rimuovere account dall'organizzazione
* Gestire inviti
* Applicare politiche alle entit√† (root, OU o account) all'interno dell'organizzazione
* Abilitare l'integrazione con i servizi AWS supportati per fornire funzionalit√† di servizio a tutti gli account dell'organizzazione.
* √à possibile accedere come utente root utilizzando l'email e la password utilizzate per creare questo account root/organizzazione.

L'account di gestione ha le **responsabilit√† di un account pagatore** ed √® responsabile del pagamento di tutti i costi sostenuti dagli account membri. Non puoi cambiare l'account di gestione di un'organizzazione.
* Gli **account membri** costituiscono tutti gli altri account in un'organizzazione. Un account pu√≤ essere membro di una sola organizzazione alla volta. Puoi allegare una politica a un account per applicare controlli solo a quell'account.
* Gli account membri **devono utilizzare un indirizzo email valido** e possono avere un **nome**, in generale non saranno in grado di gestire la fatturazione (ma potrebbero avere accesso ad essa).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Organization Units**

Gli account possono essere raggruppati in **Organization Units (OU)**. In questo modo, puoi creare **policies** per l'Organization Unit che verranno **applicate a tutti gli account figli**. Nota che un'OU pu√≤ avere altre OU come figli.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Service Control Policy (SCP)

Una **service control policy (SCP)** √® una policy che specifica i servizi e le azioni che utenti e ruoli possono utilizzare negli account che la SCP influenza. Le SCP sono **simili alle policy di permessi IAM** tranne per il fatto che **non concedono alcun permesso**. Invece, le SCP specificano i **permessi massimi** per un'organizzazione, unit√† organizzativa (OU) o account. Quando si allega una SCP alla radice dell'organizzazione o a una OU, la **SCP limita i permessi per le entit√† negli account membri**.

Questo √® l'UNICO modo in cui **anche l'utente root pu√≤ essere fermato** dal fare qualcosa. Ad esempio, potrebbe essere utilizzato per impedire agli utenti di disabilitare CloudTrail o eliminare i backup.\
L'unico modo per aggirare questo √® compromettere anche l'**account master** che configura le SCP (l'account master non pu√≤ essere bloccato).

{% hint style="warning" %}
Nota che **le SCP limitano solo i principali nell'account**, quindi altri account non sono influenzati. Questo significa che avere una SCP che nega `s3:GetObject` non impedir√† alle persone di **accedere a un bucket S3 pubblico** nel tuo account.
{% endhint %}

Esempi di SCP:

* Negare completamente l'account root
* Consentire solo regioni specifiche
* Consentire solo servizi in lista bianca
* Negare la disabilitazione di GuardDuty, CloudTrail e S3 Public Block Access
* Negare la cancellazione o modifica dei ruoli di sicurezza/risposta agli incidenti
* Negare la cancellazione dei backup
* Negare la creazione di utenti IAM e chiavi di accesso

Trova **esempi JSON** in [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)

### ARN

**Amazon Resource Name** √® il **nome unico** che ogni risorsa all'interno di AWS ha, ed √® composto cos√¨:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Nota che ci sono 4 partizioni in AWS ma solo 3 modi per chiamarle:

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US public Internet (GovCloud): `aws-us-gov`
* AWS Secret (US Classified): `aws`

## IAM - Identity and Access Management

IAM √® il servizio che ti permetter√† di gestire **Autenticazione**, **Autorizzazione** e **Controllo degli Accessi** all'interno del tuo account AWS.

* **Autenticazione** - Processo di definizione di un'identit√† e verifica di tale identit√†. Questo processo pu√≤ essere suddiviso in: Identificazione e verifica.
* **Autorizzazione** - Determina cosa un'identit√† pu√≤ accedere all'interno di un sistema una volta autenticata.
* **Controllo degli Accessi** - Il metodo e il processo di come viene concesso l'accesso a una risorsa sicura.

IAM pu√≤ essere definito dalla sua capacit√† di gestire, controllare e governare i meccanismi di autenticazione, autorizzazione e controllo degli accessi delle identit√† alle tue risorse all'interno del tuo account AWS.

### [Utente root dell'account AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Quando crei per la prima volta un account Amazon Web Services (AWS), inizi con un'unica identit√† di accesso che ha **accesso completo a tutti** i servizi e le risorse AWS nell'account. Questo √® l'utente _**root dell'account AWS**_ e vi si accede effettuando l'accesso con **l'indirizzo email e la password che hai utilizzato per creare l'account**.

Nota che un nuovo **utente admin** avr√† **meno permessi dell'utente root**.

Da un punto di vista della sicurezza, √® consigliato creare altri utenti ed evitare di usare questo.

### [Utenti IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

Un _utente_ IAM √® un'entit√† che crei in AWS per **rappresentare la persona o l'applicazione** che lo utilizza per **interagire con AWS**. Un utente in AWS consiste in un nome e credenziali (password e fino a due chiavi di accesso).

Quando crei un utente IAM, gli concedi **permessi** rendendolo un **membro di un gruppo di utenti** che ha politiche di permesso appropriate allegate (consigliato), oppure **allegando direttamente politiche** all'utente.

Gli utenti possono avere **MFA abilitato per il login** tramite la console. I token API degli utenti con MFA abilitato non sono protetti da MFA. Se vuoi **limitare l'accesso delle chiavi API di un utente utilizzando MFA** devi indicare nella politica che per eseguire determinate azioni √® necessario che MFA sia presente (esempio [**qui**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)).

#### CLI

* **Access Key ID**: 20 caratteri alfanumerici maiuscoli casuali come AKHDNAPO86BSHKDIRYT
* **Secret access key ID**: 40 caratteri casuali maiuscoli e minuscoli: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (Non √® possibile recuperare gli ID delle chiavi di accesso segrete perse).

Ogni volta che hai bisogno di **cambiare la chiave di accesso** questo √® il processo che dovresti seguire:\
_Crea una nuova chiave di accesso -> Applica la nuova chiave al sistema/applicazione -> segna quella originale come inattiva -> Testa e verifica che la nuova chiave di accesso funzioni -> Elimina la vecchia chiave di accesso_

### MFA - Multi Factor Authentication

√à utilizzato per **creare un fattore aggiuntivo per l'autenticazione** oltre ai tuoi metodi esistenti, come la password, creando quindi un livello di autenticazione multi-fattore.\
Puoi utilizzare un'applicazione virtuale gratuita o un dispositivo fisico. Puoi usare app come google authentication gratuitamente per attivare un MFA in AWS.

Le politiche con condizioni MFA possono essere allegate ai seguenti:

* Un utente o gruppo IAM
* Una risorsa come un bucket Amazon S3, una coda Amazon SQS o un argomento Amazon SNS
* La politica di fiducia di un ruolo IAM che pu√≤ essere assunto da un utente

Se vuoi **accedere tramite CLI** a una risorsa che **controlla MFA** devi chiamare **`GetSessionToken`**. Questo ti dar√† un token con informazioni su MFA.\
Nota che **le credenziali `AssumeRole` non contengono queste informazioni**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
Come [**indicato qui**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), ci sono molti casi diversi in cui **MFA non pu√≤ essere utilizzato**.

### [Gruppi di utenti IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Un [gruppo di utenti](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) IAM √® un modo per **assegnare politiche a pi√π utenti** contemporaneamente, il che pu√≤ rendere pi√π facile gestire le autorizzazioni per quegli utenti. **Ruoli e gruppi non possono far parte di un gruppo**.

Puoi assegnare una **politica basata sull'identit√† a un gruppo di utenti** in modo che tutti gli **utenti** nel gruppo di utenti **ricevano le autorizzazioni della politica**. **Non puoi** identificare un **gruppo di utenti** come **`Principal`** in una **politica** (come una politica basata sulle risorse) perch√© i gruppi riguardano le autorizzazioni, non l'autenticazione, e i principal sono entit√† IAM autenticate.

Ecco alcune caratteristiche importanti dei gruppi di utenti:

* Un **gruppo** di utenti pu√≤ **contenere molti utenti**, e un **utente** pu√≤ **appartenere a pi√π gruppi**.
* **I gruppi di utenti non possono essere nidificati**; possono contenere solo utenti, non altri gruppi di utenti.
* Non esiste **un gruppo di utenti predefinito che include automaticamente tutti gli utenti nell'account AWS**. Se desideri avere un gruppo di utenti del genere, devi crearlo e assegnare ogni nuovo utente ad esso.
* Il numero e la dimensione delle risorse IAM in un account AWS, come il numero di gruppi e il numero di gruppi di cui un utente pu√≤ essere membro, sono limitati. Per ulteriori informazioni, consulta [IAM e AWS STS quote](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html).

### [Ruoli IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Un **ruolo** IAM √® molto **simile** a un **utente**, in quanto √® un'**identit√† con politiche di autorizzazione che determinano cosa** pu√≤ e non pu√≤ fare in AWS. Tuttavia, un ruolo **non ha credenziali** (password o chiavi di accesso) associate. Invece di essere associato unicamente a una persona, un ruolo √® destinato a essere **assumibile da chiunque ne abbia bisogno (e abbia sufficienti permessi)**. Un **utente IAM pu√≤ assumere un ruolo per temporaneamente** assumere diverse autorizzazioni per un compito specifico. Un ruolo pu√≤ essere **assegnato a un** [**utente federato**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html) che accede utilizzando un provider di identit√† esterno invece di IAM.

Un ruolo IAM consiste di **due tipi di politiche**: una **politica di fiducia**, che non pu√≤ essere vuota, definendo **chi pu√≤ assumere** il ruolo, e una **politica di autorizzazioni**, che non pu√≤ essere vuota, definendo **cosa pu√≤ accedere**.

#### AWS Security Token Service (STS)

AWS Security Token Service (STS) √® un servizio web che facilita l'**emissione di credenziali temporanee e a privilegio limitato**. √à specificamente progettato per:

### [Credenziali temporanee in IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Le credenziali temporanee sono utilizzate principalmente con i ruoli IAM**, ma ci sono anche altri usi. Puoi richiedere credenziali temporanee che hanno un set di autorizzazioni pi√π ristretto rispetto al tuo utente IAM standard. Questo **impedisce** di **eseguire accidentalmente attivit√† non consentite** dalle credenziali pi√π ristrette. Un vantaggio delle credenziali temporanee √® che scadono automaticamente dopo un periodo di tempo stabilito. Hai il controllo sulla durata di validit√† delle credenziali.

### Politiche

#### Autorizzazioni delle politiche

Sono utilizzate per assegnare autorizzazioni. Ci sono 2 tipi:

* Politiche gestite da AWS (preconfigurate da AWS)
* Politiche gestite dal cliente: Configurate da te. Puoi creare politiche basate su politiche gestite da AWS (modificandone una e creando la tua), utilizzando il generatore di politiche (una vista GUI che ti aiuta a concedere e negare autorizzazioni) o scrivendo le tue.

Per **default l'accesso** √® **negato**, l'accesso sar√† concesso se √® stato specificato un ruolo esplicito.\
Se **esiste un singolo "Deny", sovrascriver√† l'"Allow"**, eccetto per le richieste che utilizzano le credenziali di sicurezza root dell'account AWS (che sono consentite per default).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
I [campi globali che possono essere utilizzati per le condizioni in qualsiasi servizio sono documentati qui](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount).\
I [campi specifici che possono essere utilizzati per le condizioni per servizio sono documentati qui](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html).

#### Inline Policies

Questo tipo di politiche sono **assegnate direttamente** a un utente, gruppo o ruolo. Quindi, non appaiono nella lista delle Policies come qualsiasi altra che pu√≤ essere utilizzata.\
Le inline policies sono utili se si vuole **mantenere una relazione stretta uno-a-uno tra una policy e l'identit√†** a cui √® applicata. Ad esempio, si vuole essere sicuri che i permessi in una policy non siano assegnati inavvertitamente a un'identit√† diversa da quella a cui sono destinati. Quando si utilizza una inline policy, i permessi nella policy non possono essere inavvertitamente associati all'identit√† sbagliata. Inoltre, quando si utilizza la AWS Management Console per eliminare quell'identit√†, le politiche incorporate nell'identit√† vengono eliminate anche. Questo perch√© fanno parte dell'entit√† principale.

#### Resource Bucket Policies

Queste sono **policies** che possono essere definite in **risorse**. **Non tutte le risorse di AWS le supportano**.

Se un principal non ha un esplicito deny su di esse, e una resource policy gli concede l'accesso, allora sono consentite.

### IAM Boundaries

IAM boundaries possono essere utilizzati per **limitare i permessi a cui un utente o ruolo dovrebbe avere accesso**. In questo modo, anche se un diverso set di permessi √® concesso all'utente da una **diversa policy**, l'operazione **fallir√†** se tenta di utilizzarli.

Un boundary √® solo una policy associata a un utente che **indica il livello massimo di permessi che l'utente o il ruolo pu√≤ avere**. Quindi, **anche se l'utente ha accesso da Administrator**, se il boundary indica che pu√≤ solo leggere i bucket S3, questo √® il massimo che pu√≤ fare.

**Questo**, **SCPs** e **seguire il principio del minimo privilegio** sono i modi per controllare che gli utenti non abbiano pi√π permessi di quelli di cui hanno bisogno.

### Session Policies

Una session policy √® una **policy impostata quando un ruolo √® assunto** in qualche modo. Questo sar√† come un **IAM boundary per quella sessione**: Questo significa che la session policy non concede permessi ma **li limita a quelli indicati nella policy** (essendo i permessi massimi quelli che il ruolo ha).

Questo √® utile per **misure di sicurezza**: Quando un admin sta per assumere un ruolo molto privilegiato, potrebbe limitare i permessi solo a quelli indicati nella session policy nel caso in cui la sessione venga compromessa.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Nota che per impostazione predefinita **AWS potrebbe aggiungere politiche di sessione alle sessioni** che verranno generate per motivi terzi. Ad esempio, in [ruoli assunti non autenticati di cognito](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) per impostazione predefinita (utilizzando l'autenticazione avanzata), AWS generer√† **credenziali di sessione con una politica di sessione** che limita i servizi a cui quella sessione pu√≤ accedere [**alla seguente lista**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Pertanto, se a un certo punto si verifica l'errore "... perch√© nessuna politica di sessione consente il ...", e il ruolo ha accesso per eseguire l'azione, √® perch√© **c'√® una politica di sessione che lo impedisce**.

### Federazione di Identit√†

La federazione di identit√† **consente agli utenti di provider di identit√† esterni** ad AWS di accedere in modo sicuro alle risorse AWS senza dover fornire credenziali utente AWS da un account utente IAM valido.\
Un esempio di provider di identit√† pu√≤ essere la tua **Microsoft Active Directory** aziendale (tramite **SAML**) o servizi **OpenID** (come **Google**). L'accesso federato consentir√† quindi agli utenti al suo interno di accedere ad AWS.

Per configurare questa fiducia, viene generato un **IAM Identity Provider (SAML o OAuth)** che **si fider√†** dell'**altra piattaforma**. Quindi, viene assegnato almeno un **ruolo IAM (fiducioso) al provider di identit√†**. Se un utente della piattaforma fidata accede ad AWS, acceder√† come il ruolo menzionato.

Tuttavia, di solito si desidera assegnare un **ruolo diverso a seconda del gruppo dell'utente** nella piattaforma di terze parti. Quindi, diversi **ruoli IAM possono fidarsi** del provider di identit√† di terze parti e sar√† la piattaforma di terze parti a consentire agli utenti di assumere un ruolo o l'altro.

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### IAM Identity Center

AWS IAM Identity Center (successore di AWS Single Sign-On) espande le capacit√† di AWS Identity and Access Management (IAM) per fornire un **luogo centrale** che riunisce **l'amministrazione degli utenti e il loro accesso agli account AWS** e alle applicazioni cloud.

Il dominio di accesso sar√† qualcosa come `<user_input>.awsapps.com`.

Per autenticare gli utenti, possono essere utilizzate 3 fonti di identit√†:

* Identity Center Directory: Utenti AWS regolari
* Active Directory: Supporta diversi connettori
* External Identity Provider: Tutti gli utenti e i gruppi provengono da un provider di identit√† esterno (IdP)

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

Nel caso pi√π semplice di directory Identity Center, l'**Identity Center avr√† un elenco di utenti e gruppi** e sar√† in grado di **assegnare politiche** a loro **a uno qualsiasi degli account** dell'organizzazione.

Per dare accesso a un utente/gruppo di Identity Center a un account, verr√† creato un **SAML Identity Provider che si fida dell'Identity Center**, e verr√† creato un **ruolo che si fida del provider di identit√† con le politiche indicate** nell'account di destinazione.

#### AwsSSOInlinePolicy

√à possibile **concedere permessi tramite politiche inline ai ruoli creati tramite IAM Identity Center**. I ruoli creati negli account a cui vengono assegnate **politiche inline in AWS Identity Center** avranno questi permessi in una politica inline chiamata **`AwsSSOInlinePolicy`**.

Pertanto, anche se vedi 2 ruoli con una politica inline chiamata **`AwsSSOInlinePolicy`**, **non significa che abbiano gli stessi permessi**.

### Cross Account Trusts and Roles

**Un utente** (fiducioso) pu√≤ creare un Cross Account Role con alcune politiche e quindi, **consentire a un altro utente** (fidato) di **accedere al suo account** ma solo **avendo l'accesso indicato nelle nuove politiche del ruolo**. Per creare questo, basta creare un nuovo ruolo e selezionare Cross Account Role. I ruoli per l'accesso tra account offrono due opzioni. Fornire accesso tra account AWS che possiedi e fornire accesso tra un account che possiedi e un account AWS di terze parti.\
√à consigliato **specificare l'utente che √® fidato e non mettere qualcosa di generico** perch√© altrimenti altri utenti autenticati come utenti federati potranno anche abusare di questa fiducia.

### AWS Simple AD

Non supportato:

* Relazioni di fiducia
* Centro di amministrazione AD
* Supporto completo API PS
* Cestino AD
* Account di servizio gestiti di gruppo
* Estensioni dello schema
* Nessun accesso diretto a OS o istanze

#### Web Federation o OpenID Authentication

L'app utilizza AssumeRoleWithWebIdentity per creare credenziali temporanee. Tuttavia, questo non concede l'accesso alla console AWS, solo l'accesso alle risorse all'interno di AWS.

### Altre opzioni IAM

* Puoi **impostare una politica di password** con opzioni come lunghezza minima e requisiti di password.
* Puoi **scaricare il "Credential Report"** con informazioni sulle credenziali attuali (come il tempo di creazione dell'utente, se la password √® abilitata...). Puoi generare un rapporto delle credenziali ogni **quattro ore**.

AWS Identity and Access Management (IAM) fornisce **controllo degli accessi granulare** su tutto AWS. Con IAM, puoi specificare **chi pu√≤ accedere a quali servizi e risorse**, e in quali condizioni. Con le politiche IAM, gestisci i permessi per la tua forza lavoro e i tuoi sistemi per **garantire i permessi di minimo privilegio**.

### Prefissi ID IAM

In [**questa pagina**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) puoi trovare i **prefissi ID IAM** delle chiavi a seconda della loro natura:

| ABIA | [Token portatore del servizio AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Credenziale specifica del contesto                                                                                                                                                                                           |
| AGPA | Gruppo di utenti                                                                                                                                                                                                            |
| AIDA | Utente IAM                                                                                                                                                                                                              |
| AIPA | Profilo istanza Amazon EC2                                                                                                                                                                                           |
| AKIA | Chiave di accesso                                                                                                                                                                                                            |
| ANPA | Politica gestita                                                                                                                                                                                                        |
| ANVA | Versione in una politica gestita                                                                                                                                                                                           |
| APKA | Chiave pubblica                                                                                                                                                                                                            |
| AROA | Ruolo                                                                                                                                                                                                                  |
| ASCA | Certificato                                                                                                                                                                                                           |
| ASIA | [ID chiavi di accesso temporanee (AWS STS)](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) utilizzano questo prefisso, ma sono uniche solo in combinazione con la chiave di accesso segreta e il token di sessione. |

### Permessi raccomandati per audit degli account

I seguenti privilegi concedono vari accessi in lettura ai metadati:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Varie

### CLI Authentication

Per un utente regolare autenticarsi ad AWS tramite CLI √® necessario avere **credenziali locali**. Per impostazione predefinita, puoi configurarle **manualmente** in `~/.aws/credentials` o **eseguendo** `aws configure`.\
In quel file puoi avere pi√π di un profilo, se **nessun profilo** √® specificato utilizzando la **aws cli**, verr√† utilizzato quello chiamato **`[default]`** in quel file.\
Esempio di file di credenziali con pi√π di un profilo:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Se hai bisogno di accedere a **diversi account AWS** e il tuo profilo ha ricevuto l'accesso per **assumere un ruolo all'interno di quegli account**, non √® necessario chiamare manualmente STS ogni volta (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) e configurare le credenziali.

Puoi utilizzare il file `~/.aws/config` per [**indicare quali ruoli assumere**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), e poi usare il parametro `--profile` come al solito (l'`assume-role` sar√† eseguito in modo trasparente per l'utente).\
Un esempio di file di configurazione:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Con questo file di configurazione puoi quindi utilizzare aws cli come:
```
aws --profile acc2 ...
```
Se stai cercando qualcosa di **simile** a questo ma per il **browser** puoi controllare l'**estensione** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## Riferimenti

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}
