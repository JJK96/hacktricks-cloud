# AWS - Podstawowe Informacje

{% hint style="success" %}
Ucz się i ćwicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz się i ćwicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawdź [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel się trikami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Hierarchia Organizacji

![](<../../../.gitbook/assets/image (151).png>)

### Konta

W AWS istnieje **konto root**, które jest **nadrzędnym kontenerem dla wszystkich kont** w Twojej **organizacji**. Nie musisz jednak używać tego konta do wdrażania zasobów, możesz tworzyć **inne konta, aby oddzielić różne infrastruktury AWS** między sobą.

Jest to bardzo interesujące z punktu widzenia **bezpieczeństwa**, ponieważ **jedno konto nie będzie mogło uzyskać dostępu do zasobów z innego konta** (chyba że specjalnie utworzone są mosty), dzięki czemu można tworzyć granice między wdrożeniami.

W związku z tym, w organizacji istnieją **dwa rodzaje kont** (mówimy o kontach AWS, a nie kontach użytkowników): jedno konto wyznaczone jako konto zarządzające oraz jedno lub więcej kont członkowskich.

*   **Konto zarządzające (konto root)** to konto, którego używasz do tworzenia organizacji. Z konta zarządzającego organizacją możesz wykonywać następujące czynności:

* Tworzyć konta w organizacji
* Zapraszać inne istniejące konta do organizacji
* Usuwać konta z organizacji
* Zarządzać zaproszeniami
* Stosować polityki do jednostek (korzeni, OU lub kont) w organizacji
* Włączać integrację z obsługiwanymi usługami AWS, aby zapewnić funkcjonalność usług we wszystkich kontach w organizacji.
* Możliwe jest logowanie się jako użytkownik root za pomocą e-maila i hasła użytego do utworzenia tego konta root/organizacji.

Konto zarządzające ma **odpowiedzialność konta płatnika** i jest odpowiedzialne za opłacanie wszystkich opłat naliczanych przez konta członkowskie. Nie można zmienić konta zarządzającego organizacją.
* **Konta członkowskie** stanowią resztę kont w organizacji. Konto może być członkiem tylko jednej organizacji na raz. Możesz dołączyć politykę do konta, aby zastosować kontrolę tylko do tego jednego konta.
* Konta członkowskie **muszą używać ważnego adresu e-mail** i mogą mieć **nazwę**, zazwyczaj nie będą mogły zarządzać rozliczeniami (ale mogą mieć do nich dostęp).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Organization Units**

Konta mogą być grupowane w **Organization Units (OU)**. W ten sposób możesz tworzyć **polityki** dla Organization Unit, które będą **stosowane do wszystkich kont podrzędnych**. Zauważ, że OU może mieć inne OU jako podrzędne.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Service Control Policy (SCP)

**Service control policy (SCP)** to polityka, która określa usługi i działania, z których mogą korzystać użytkownicy i role w kontach, na które wpływa SCP. SCP są **podobne do polityk uprawnień IAM**, z tą różnicą, że **nie przyznają żadnych uprawnień**. Zamiast tego, SCP określają **maksymalne uprawnienia** dla organizacji, jednostki organizacyjnej (OU) lub konta. Gdy dołączysz SCP do korzenia organizacji lub OU, **SCP ogranicza uprawnienia dla podmiotów w kontach członkowskich**.

To jest JEDYNY sposób, aby **nawet użytkownik root nie mógł czegoś zrobić**. Na przykład, może być używany do uniemożliwienia użytkownikom wyłączania CloudTrail lub usuwania kopii zapasowych.\
Jedynym sposobem na obejście tego jest również skompromitowanie **konta głównego**, które konfiguruje SCP (konto główne nie może być zablokowane).

{% hint style="warning" %}
Należy pamiętać, że **SCP ograniczają tylko podmioty w koncie**, więc inne konta nie są dotknięte. Oznacza to, że posiadanie SCP odmawiającego `s3:GetObject` nie uniemożliwi ludziom **dostępu do publicznego bucketu S3** w twoim koncie.
{% endhint %}

Przykłady SCP:

* Całkowite odmówienie dostępu kontu root
* Zezwalanie tylko na określone regiony
* Zezwalanie tylko na usługi z białej listy
*   Odmówienie wyłączenia GuardDuty, CloudTrail i S3 Public Block Access
*   Odmówienie usunięcia lub modyfikacji ról bezpieczeństwa/reakcji na incydenty
* Odmówienie usunięcia kopii zapasowych
* Odmówienie tworzenia użytkowników IAM i kluczy dostępu

Znajdź **przykłady JSON** na [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)

### ARN

**Amazon Resource Name** to **unikalna nazwa**, którą ma każdy zasób w AWS, składa się z:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Zauważ, że w AWS są 4 partycje, ale tylko 3 sposoby, aby je wywołać:

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US public Internet (GovCloud): `aws-us-gov`
* AWS Secret (US Classified): `aws`

## IAM - Identity and Access Management

IAM to usługa, która pozwala zarządzać **Uwierzytelnianiem**, **Autoryzacją** i **Kontrolą Dostępu** w Twoim koncie AWS.

* **Uwierzytelnianie** - Proces definiowania tożsamości i weryfikacji tej tożsamości. Proces ten można podzielić na: Identyfikację i weryfikację.
* **Autoryzacja** - Określa, do czego tożsamość ma dostęp w systemie po jej uwierzytelnieniu.
* **Kontrola Dostępu** - Metoda i proces przyznawania dostępu do zasobu zabezpieczonego

IAM można zdefiniować przez jego zdolność do zarządzania, kontrolowania i nadzorowania mechanizmów uwierzytelniania, autoryzacji i kontroli dostępu tożsamości do zasobów w Twoim koncie AWS.

### [Użytkownik root konta AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Kiedy po raz pierwszy tworzysz konto Amazon Web Services (AWS), zaczynasz od pojedynczej tożsamości logowania, która ma **pełny dostęp do wszystkich** usług i zasobów AWS w koncie. Jest to _**użytkownik root konta AWS**_ i uzyskuje się do niego dostęp, logując się za pomocą **adresu e-mail i hasła, których użyłeś do utworzenia konta**.

Zauważ, że nowy **użytkownik admin** będzie miał **mniej uprawnień niż użytkownik root**.

Z punktu widzenia bezpieczeństwa zaleca się tworzenie innych użytkowników i unikanie używania tego.

### [Użytkownicy IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

Użytkownik IAM to jednostka, którą tworzysz w AWS, aby **reprezentować osobę lub aplikację**, która używa jej do **interakcji z AWS**. Użytkownik w AWS składa się z nazwy i poświadczeń (hasło i do dwóch kluczy dostępu).

Kiedy tworzysz użytkownika IAM, nadajesz mu **uprawnienia**, czyniąc go **członkiem grupy użytkowników**, która ma odpowiednie polityki uprawnień (zalecane), lub **bezpośrednio przypisując polityki** do użytkownika.

Użytkownicy mogą mieć **włączone MFA do logowania** przez konsolę. Tokeny API użytkowników z włączonym MFA nie są chronione przez MFA. Jeśli chcesz **ograniczyć dostęp do kluczy API użytkownika za pomocą MFA**, musisz wskazać w polityce, że aby wykonać określone działania, MFA musi być obecne (przykład [**tutaj**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)).

#### CLI

* **Access Key ID**: 20 losowych wielkich liter i cyfr, np. AKHDNAPO86BSHKDIRYT
* **Secret access key ID**: 40 losowych wielkich i małych liter: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (Nie można odzyskać utraconych identyfikatorów kluczy dostępu).

Kiedy musisz **zmienić klucz dostępu**, oto proces, który powinieneś wykonać:\
_Utwórz nowy klucz dostępu -> Zastosuj nowy klucz do systemu/aplikacji -> oznacz oryginalny jako nieaktywny -> Przetestuj i zweryfikuj działanie nowego klucza dostępu -> Usuń stary klucz dostępu_

### MFA - Multi Factor Authentication

Jest używane do **tworzenia dodatkowego czynnika uwierzytelniania** oprócz istniejących metod, takich jak hasło, tworząc w ten sposób wielopoziomowe uwierzytelnianie.\
Możesz użyć **darmowej aplikacji wirtualnej lub fizycznego urządzenia**. Możesz użyć aplikacji takich jak google authentication za darmo, aby aktywować MFA w AWS.

Polityki z warunkami MFA mogą być przypisane do następujących:

* Użytkownik lub grupa IAM
* Zasób, taki jak Amazon S3 bucket, Amazon SQS queue, lub Amazon SNS topic
* Polityka zaufania roli IAM, którą może przyjąć użytkownik

Jeśli chcesz **uzyskać dostęp przez CLI** do zasobu, który **sprawdza MFA**, musisz wywołać **`GetSessionToken`**. To da ci token z informacjami o MFA.\
Zauważ, że **poświadczenia `AssumeRole` nie zawierają tych informacji**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
Jak [**stwierdzono tutaj**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), istnieje wiele różnych przypadków, w których **MFA nie może być używane**.

### [Grupy użytkowników IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Grupa użytkowników IAM to sposób na **przypisanie polityk do wielu użytkowników** jednocześnie, co może ułatwić zarządzanie uprawnieniami tych użytkowników. **Role i grupy nie mogą być częścią grupy**.

Możesz przypisać **politykę opartą na tożsamości do grupy użytkowników**, aby wszyscy **użytkownicy** w grupie użytkowników **otrzymali uprawnienia polityki**. **Nie możesz** zidentyfikować **grupy użytkowników** jako **`Principal`** w **polityce** (takiej jak polityka oparta na zasobach), ponieważ grupy odnoszą się do uprawnień, a nie uwierzytelniania, a principal to uwierzytelnione jednostki IAM.

Oto kilka ważnych cech grup użytkowników:

* Grupa użytkowników może **zawierać wielu użytkowników**, a użytkownik może **należeć do wielu grup**.
* **Grupy użytkowników nie mogą być zagnieżdżone**; mogą zawierać tylko użytkowników, a nie inne grupy użytkowników.
* **Nie ma domyślnej grupy użytkowników, która automatycznie obejmuje wszystkich użytkowników w koncie AWS**. Jeśli chcesz mieć taką grupę użytkowników, musisz ją utworzyć i przypisać do niej każdego nowego użytkownika.
* Liczba i rozmiar zasobów IAM w koncie AWS, takich jak liczba grup i liczba grup, do których użytkownik może należeć, są ograniczone. Więcej informacji znajdziesz w [IAM and AWS STS quotas](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html).

### [Role IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Rola IAM jest bardzo **podobna** do **użytkownika**, ponieważ jest to **tożsamość z politykami uprawnień, które określają, co** może, a czego nie może robić w AWS. Jednak rola **nie ma żadnych poświadczeń** (hasła ani kluczy dostępu) związanych z nią. Zamiast być unikalnie powiązana z jedną osobą, rola jest przeznaczona do **przyjmowania przez każdego, kto jej potrzebuje (i ma wystarczające uprawnienia)**. Użytkownik IAM może **przyjąć rolę, aby tymczasowo** uzyskać inne uprawnienia do wykonania określonego zadania. Rola może być **przypisana do** [**użytkownika federacyjnego**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html), który loguje się za pomocą zewnętrznego dostawcy tożsamości zamiast IAM.

Rola IAM składa się z **dwóch rodzajów polityk**: **Polityki zaufania**, która nie może być pusta, definiującej **kto może przyjąć** rolę, oraz **polityki uprawnień**, która nie może być pusta, definiującej **do czego ma dostęp**.

#### AWS Security Token Service (STS)

AWS Security Token Service (STS) to usługa internetowa, która ułatwia **wydawanie tymczasowych, ograniczonych uprawnień poświadczeń**. Jest specjalnie dostosowana do:

### [Tymczasowe poświadczenia w IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Tymczasowe poświadczenia są głównie używane z rolami IAM**, ale istnieją również inne zastosowania. Możesz zażądać tymczasowych poświadczeń, które mają bardziej ograniczony zestaw uprawnień niż standardowy użytkownik IAM. To **zapobiega** przypadkowemu **wykonywaniu zadań, które nie są dozwolone** przez bardziej ograniczone poświadczenia. Korzyścią z tymczasowych poświadczeń jest to, że automatycznie wygasają po określonym czasie. Masz kontrolę nad czasem, przez jaki poświadczenia są ważne.

### Polityki

#### Uprawnienia polityki

Służą do przypisywania uprawnień. Istnieją 2 rodzaje:

* Polityki zarządzane przez AWS (wstępnie skonfigurowane przez AWS)
* Polityki zarządzane przez klienta: Konfigurowane przez Ciebie. Możesz tworzyć polityki na podstawie polityk zarządzanych przez AWS (modyfikując jedną z nich i tworząc własną), używając generatora polityk (widok GUI, który pomaga w przyznawaniu i odmawianiu uprawnień) lub pisząc własne.

Domyślnie dostęp jest **odmówiony**, dostęp zostanie przyznany, jeśli określono wyraźną rolę.\
Jeśli istnieje pojedyncze "Deny", nadpisze ono "Allow", z wyjątkiem żądań, które używają głównych poświadczeń zabezpieczeń konta AWS (które są dozwolone domyślnie).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
[Globalne pola, które mogą być używane do warunków w dowolnej usłudze, są udokumentowane tutaj](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount).\
[Specyficzne pola, które mogą być używane do warunków na usługę, są udokumentowane tutaj](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html).

#### Inline Policies

Ten rodzaj polityk jest **bezpośrednio przypisany** do użytkownika, grupy lub roli. Wtedy nie pojawiają się one na liście Polityk, ponieważ nikt inny nie może ich używać.\
Inline policies są przydatne, jeśli chcesz **utrzymać ścisły związek jeden do jednego między polityką a tożsamością**, do której jest stosowana. Na przykład, chcesz mieć pewność, że uprawnienia w polityce nie zostaną przypadkowo przypisane do innej tożsamości niż ta, do której są przeznaczone. Kiedy używasz inline policy, uprawnienia w polityce nie mogą być przypadkowo przypisane do niewłaściwej tożsamości. Dodatkowo, kiedy używasz AWS Management Console do usunięcia tej tożsamości, polityki osadzone w tożsamości są również usuwane. Dzieje się tak, ponieważ są one częścią głównego podmiotu.

#### Resource Bucket Policies

Są to **polityki**, które mogą być zdefiniowane w **zasobach**. **Nie wszystkie zasoby AWS je obsługują**.

Jeśli podmiot nie ma wyraźnego odmowy na nich, a polityka zasobów przyznaje im dostęp, to są one dozwolone.

### IAM Boundaries

IAM boundaries mogą być używane do **ograniczenia uprawnień, do których użytkownik lub rola powinna mieć dostęp**. W ten sposób, nawet jeśli inny zestaw uprawnień jest przyznany użytkownikowi przez **inną politykę**, operacja **zawiedzie**, jeśli spróbuje ich użyć.

Boundary to po prostu polityka przypisana do użytkownika, która **wskazuje maksymalny poziom uprawnień, jakie użytkownik lub rola mogą mieć**. Więc, **nawet jeśli użytkownik ma dostęp Administratora**, jeśli boundary wskazuje, że może tylko czytać S3 buckets, to jest to maksymalne, co może zrobić.

**To**, **SCPs** i **przestrzeganie zasady najmniejszych uprawnień** to sposoby na kontrolowanie, aby użytkownicy nie mieli więcej uprawnień niż potrzebują.

### Session Policies

Session policy to **polityka ustawiona, gdy rola jest przyjmowana** w jakiś sposób. Będzie to jak **IAM boundary dla tej sesji**: Oznacza to, że session policy nie przyznaje uprawnień, ale **ogranicza je do tych wskazanych w polityce** (maksymalne uprawnienia to te, które ma rola).

Jest to przydatne dla **środków bezpieczeństwa**: Kiedy administrator ma przyjąć bardzo uprzywilejowaną rolę, może ograniczyć uprawnienia tylko do tych wskazanych w session policy na wypadek, gdyby sesja została skompromitowana.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Zauważ, że domyślnie **AWS może dodać polityki sesji do sesji**, które będą generowane z powodu trzecich powodów. Na przykład, w [nieautoryzowanych rolach przyjętych przez cognito](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) domyślnie (używając ulepszonego uwierzytelniania), AWS wygeneruje **poświadczenia sesji z polityką sesji**, która ogranicza usługi, do których sesja może uzyskać dostęp [**do następującej listy**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Dlatego, jeśli w pewnym momencie napotkasz błąd "... ponieważ żadna polityka sesji nie pozwala na ...", a rola ma dostęp do wykonania akcji, to dlatego, że **istnieje polityka sesji, która to uniemożliwia**.

### Federacja Tożsamości

Federacja tożsamości **pozwala użytkownikom z dostawców tożsamości, którzy są zewnętrzni** wobec AWS, na bezpieczny dostęp do zasobów AWS bez konieczności podawania poświadczeń użytkownika AWS z ważnego konta IAM.\
Przykładem dostawcy tożsamości może być Twoja własna korporacyjna **Microsoft Active Directory** (przez **SAML**) lub usługi **OpenID** (jak **Google**). Dostęp federacyjny pozwoli wtedy użytkownikom w nim na dostęp do AWS.

Aby skonfigurować to zaufanie, generowany jest **dostawca tożsamości IAM (SAML lub OAuth)**, który będzie **ufał** **innej platformie**. Następnie, co najmniej jedna **rola IAM jest przypisana (ufająca) do dostawcy tożsamości**. Jeśli użytkownik z zaufanej platformy uzyska dostęp do AWS, będzie miał dostęp jako wspomniana rola.

Jednak zazwyczaj będziesz chciał przyznać **inną rolę w zależności od grupy użytkownika** na platformie trzeciej. Wtedy, kilka **ról IAM może ufać** dostawcy tożsamości trzeciej strony, a platforma trzeciej strony będzie tą, która pozwala użytkownikom przyjąć jedną rolę lub inną.

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### IAM Identity Center

AWS IAM Identity Center (następca AWS Single Sign-On) rozszerza możliwości AWS Identity and Access Management (IAM), aby zapewnić **centralne miejsce**, które łączy **administrację użytkownikami i ich dostępem do kont AWS** oraz aplikacji w chmurze.

Domena logowania będzie wyglądać jak `<user_input>.awsapps.com`.

Aby zalogować użytkowników, można użyć 3 źródeł tożsamości:

* Identity Center Directory: Zwykli użytkownicy AWS
* Active Directory: Obsługuje różne konektory
* Zewnętrzny dostawca tożsamości: Wszyscy użytkownicy i grupy pochodzą od zewnętrznego dostawcy tożsamości (IdP)

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

W najprostszym przypadku katalogu Identity Center, **Identity Center będzie miał listę użytkowników i grup** i będzie mógł **przypisywać polityki** do nich do **dowolnego z kont** organizacji.

Aby przyznać dostęp użytkownikowi/grupie Identity Center do konta, **zostanie utworzony dostawca tożsamości SAML ufający Identity Center**, a **rola ufająca dostawcy tożsamości z wskazanymi politykami zostanie utworzona** na docelowym koncie.

#### AwsSSOInlinePolicy

Możliwe jest **przyznanie uprawnień za pomocą polityk inline do ról tworzonych przez IAM Identity Center**. Role tworzone na kontach, którym przyznawane są **polityki inline w AWS Identity Center**, będą miały te uprawnienia w polityce inline zwanej **`AwsSSOInlinePolicy`**.

Dlatego, nawet jeśli widzisz 2 role z polityką inline zwaną **`AwsSSOInlinePolicy`**, to **nie oznacza, że mają te same uprawnienia**.

### Cross Account Trusts and Roles

**Użytkownik** (ufający) może utworzyć rolę Cross Account z pewnymi politykami, a następnie **pozwolić innemu użytkownikowi** (zaufanemu) **uzyskać dostęp do jego konta**, ale tylko **mając dostęp wskazany w nowych politykach roli**. Aby to utworzyć, wystarczy utworzyć nową rolę i wybrać Cross Account Role. Role dla dostępu między kontami oferują dwie opcje. Zapewnienie dostępu między kontami AWS, które posiadasz, oraz zapewnienie dostępu między kontem, które posiadasz, a kontem AWS trzeciej strony.\
Zaleca się **określenie użytkownika, który jest zaufany, a nie umieszczanie czegoś ogólnego**, ponieważ w przeciwnym razie inni uwierzytelnieni użytkownicy, tacy jak użytkownicy federacyjni, będą mogli również nadużywać tego zaufania.

### AWS Simple AD

Nieobsługiwane:

* Relacje zaufania
* Centrum administracyjne AD
* Pełne wsparcie API PS
* Kosz na śmieci AD
* Zarządzane konta usług grupowych
* Rozszerzenia schematu
* Brak bezpośredniego dostępu do OS lub instancji

#### Web Federation or OpenID Authentication

Aplikacja używa AssumeRoleWithWebIdentity do tworzenia tymczasowych poświadczeń. Jednak to nie przyznaje dostępu do konsoli AWS, tylko dostęp do zasobów w AWS.

### Inne opcje IAM

* Możesz **ustawić politykę haseł**, określając opcje takie jak minimalna długość i wymagania dotyczące hasła.
* Możesz **pobrać "Raport poświadczeń"** z informacjami o bieżących poświadczeniach (takich jak czas utworzenia użytkownika, czy hasło jest włączone...). Możesz generować raport poświadczeń tak często, jak raz na **cztery godziny**.

AWS Identity and Access Management (IAM) zapewnia **drobnoziarnistą kontrolę dostępu** w całym AWS. Dzięki IAM możesz określić **kto może uzyskać dostęp do których usług i zasobów**, i na jakich warunkach. Dzięki politykom IAM zarządzasz uprawnieniami dla swojej siły roboczej i systemów, aby **zapewnić uprawnienia najmniejszego przywileju**.

### IAM ID Prefixes

Na [**tej stronie**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) możesz znaleźć **prefiksy ID IAM** kluczy w zależności od ich natury:

| ABIA | [AWS STS service bearer token](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Kontekstowe poświadczenie                                                                                                                                                                                             |
| AGPA | Grupa użytkowników                                                                                                                                                                                                    |
| AIDA | Użytkownik IAM                                                                                                                                                                                                        |
| AIPA | Profil instancji Amazon EC2                                                                                                                                                                                           |
| AKIA | Klucz dostępu                                                                                                                                                                                                         |
| ANPA | Zarządzana polityka                                                                                                                                                                                                   |
| ANVA | Wersja w zarządzanej polityce                                                                                                                                                                                         |
| APKA | Klucz publiczny                                                                                                                                                                                                       |
| AROA | Rola                                                                                                                                                                                                                  |
| ASCA | Certyfikat                                                                                                                                                                                                            |
| ASIA | [Tymczasowe (AWS STS) identyfikatory kluczy dostępu](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) używają tego prefiksu, ale są unikalne tylko w połączeniu z tajnym kluczem dostępu i tokenem sesji. |

### Zalecane uprawnienia do audytu kont

Następujące uprawnienia przyznają różne dostępy do metadanych:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Różne

### CLI Authentication

Aby zwykły użytkownik mógł uwierzytelnić się w AWS za pomocą CLI, musisz mieć **lokalne poświadczenia**. Domyślnie możesz je skonfigurować **ręcznie** w `~/.aws/credentials` lub **uruchamiając** `aws configure`.\
W tym pliku możesz mieć więcej niż jeden profil, jeśli **żaden profil** nie jest określony przy użyciu **aws cli**, używany będzie ten o nazwie **`[default]`** w tym pliku.\
Przykład pliku poświadczeń z więcej niż jednym profilem:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Jeśli potrzebujesz dostępu do **różnych kont AWS** i Twój profil ma dostęp do **przyjęcia roli w tych kontach**, nie musisz ręcznie wywoływać STS za każdym razem (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) i konfigurować poświadczeń.

Możesz użyć pliku `~/.aws/config`, aby [**wskazać, które role przyjąć**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), a następnie użyć parametru `--profile` jak zwykle (operacja `assume-role` zostanie wykonana w sposób przejrzysty dla użytkownika).\
Przykład pliku konfiguracyjnego:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Z tym plikiem konfiguracyjnym możesz następnie używać aws cli, na przykład:
```
aws --profile acc2 ...
```
Jeśli szukasz czegoś **podobnego** do tego, ale dla **przeglądarki**, możesz sprawdzić **rozszerzenie** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## References

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

{% hint style="success" %}
Ucz się i ćwicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz się i ćwicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawdź [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) albo **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel się trikami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów na githubie.

</details>
{% endhint %}
