# AWS - Basic Information

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**구독 플랜**](https://github.com/sponsors/carlospolop)을 확인하세요!
* **💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**telegram 그룹**](https://t.me/peass)에 가입하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우하세요.**
* **PR을 제출하여** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 저장소에 해킹 트릭을 공유하세요.**

</details>
{% endhint %}

## Organization Hierarchy

![](<../../../.gitbook/assets/image (151).png>)

### Accounts

AWS에는 **루트 계정**이 있으며, 이는 **조직의 모든 계정의 상위 컨테이너**입니다. 그러나 리소스를 배포하기 위해 해당 계정을 사용할 필요는 없으며, **다른 계정을 생성하여 서로 다른 AWS** 인프라를 분리할 수 있습니다.

이는 **보안** 관점에서 매우 흥미로운데, **한 계정이 다른 계정의 리소스에 접근할 수 없기** 때문에(특별히 브리지가 생성되지 않는 한), 이렇게 배포 간 경계를 만들 수 있습니다.

따라서 조직에는 **두 가지 유형의 계정**이 있습니다(AWS 계정에 대해 이야기하는 것이며 사용자 계정이 아닙니다): 관리 계정으로 지정된 단일 계정과 하나 이상의 멤버 계정입니다.

*   **관리 계정(루트 계정)**은 조직을 생성하는 데 사용하는 계정입니다. 조직의 관리 계정에서 다음을 수행할 수 있습니다:

* 조직 내 계정 생성
* 기존 계정을 조직에 초대
* 조직에서 계정 제거
* 초대 관리
* 조직 내 엔터티(루트, OU 또는 계정)에 정책 적용
* 조직의 모든 계정에 걸쳐 서비스 기능을 제공하기 위해 지원되는 AWS 서비스와의 통합 활성화
* 이 루트 계정/조직을 생성하는 데 사용된 이메일과 비밀번호를 사용하여 루트 사용자로 로그인할 수 있습니다.

관리 계정은 **지불 계정의 책임**을 가지며 멤버 계정에서 발생한 모든 요금을 지불할 책임이 있습니다. 조직의 관리 계정을 변경할 수 없습니다.
* **멤버 계정**은 조직의 나머지 모든 계정으로 구성됩니다. 계정은 한 번에 하나의 조직에만 속할 수 있습니다. 계정에 정책을 첨부하여 해당 계정에만 제어를 적용할 수 있습니다.
* 멤버 계정은 **유효한 이메일 주소를 사용해야** 하며 **이름**을 가질 수 있습니다. 일반적으로 청구 관리를 할 수 없지만 접근 권한을 부여받을 수 있습니다.
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Organization Units**

Accounts는 **Organization Units (OU)**로 그룹화될 수 있습니다. 이렇게 하면 Organization Unit에 대한 **policies**를 생성하여 **모든 하위 계정에 적용**할 수 있습니다. OU는 다른 OU를 하위로 가질 수 있다는 점에 유의하세요.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Service Control Policy (SCP)

**서비스 제어 정책(SCP)**은 SCP가 영향을 미치는 계정에서 사용자와 역할이 사용할 수 있는 서비스와 작업을 지정하는 정책입니다. SCP는 **IAM 권한 정책과 유사**하지만 **아무런 권한도 부여하지 않습니다**. 대신, SCP는 조직, 조직 단위(OU) 또는 계정에 대한 **최대 권한**을 지정합니다. SCP를 조직 루트 또는 OU에 연결하면 **회원 계정의 엔터티에 대한 권한이 제한**됩니다.

이것은 **루트 사용자조차도** 어떤 작업을 하지 못하게 막을 수 있는 유일한 방법입니다. 예를 들어, 사용자가 CloudTrail을 비활성화하거나 백업을 삭제하지 못하도록 막을 수 있습니다.\
이를 우회하는 유일한 방법은 SCP를 구성하는 **마스터 계정**을 손상시키는 것입니다(마스터 계정은 차단될 수 없습니다).

{% hint style="warning" %}
**SCP는 계정 내의 주체만 제한**하므로 다른 계정에는 영향을 미치지 않습니다. 이는 SCP가 `s3:GetObject`를 거부하더라도 **계정 내의 공개 S3 버킷에 접근하는 것을 막지 못한다**는 것을 의미합니다.
{% endhint %}

SCP 예시:

* 루트 계정을 완전히 거부
* 특정 지역만 허용
* 허용된 서비스만 허용
* GuardDuty, CloudTrail, S3 Public Block Access 비활성화 거부
* 보안/사고 대응 역할 삭제 또는 수정 거부
* 백업 삭제 거부
* IAM 사용자 및 액세스 키 생성 거부

**JSON 예시**는 [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)에서 찾을 수 있습니다.

### ARN

**Amazon Resource Name**은 AWS 내의 모든 리소스가 가지는 **고유 이름**으로, 다음과 같이 구성됩니다:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
AWS에는 4개의 파티션이 있지만 호출 방법은 3가지뿐입니다:

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US public Internet (GovCloud): `aws-us-gov`
* AWS Secret (US Classified): `aws`

## IAM - Identity and Access Management

IAM은 AWS 계정 내에서 **인증**, **권한 부여** 및 **액세스 제어**를 관리할 수 있게 해주는 서비스입니다.

* **Authentication** - 신원을 정의하고 그 신원을 검증하는 과정. 이 과정은 식별과 검증으로 세분화될 수 있습니다.
* **Authorization** - 신원이 시스템에 인증된 후 시스템 내에서 무엇을 액세스할 수 있는지를 결정합니다.
* **Access Control** - 보안 리소스에 대한 액세스가 어떻게 부여되는지에 대한 방법과 과정입니다.

IAM은 AWS 계정 내의 리소스에 대한 신원의 인증, 권한 부여 및 액세스 제어 메커니즘을 관리, 제어 및 통제할 수 있는 능력으로 정의될 수 있습니다.

### [AWS account root user](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Amazon Web Services (AWS) 계정을 처음 만들면, 계정 내의 모든 AWS 서비스와 리소스에 **완전한 액세스 권한**을 가진 단일 로그인 신원으로 시작합니다. 이것이 AWS 계정 _**루트 사용자**_이며, **계정을 만들 때 사용한 이메일 주소와 비밀번호로 로그인**하여 액세스할 수 있습니다.

새로운 **관리자 사용자**는 **루트 사용자보다 권한이 적습니다**.

보안 관점에서 다른 사용자를 생성하고 이 사용자는 사용하지 않는 것이 좋습니다.

### [IAM users](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

IAM _사용자_는 AWS에서 **AWS와 상호 작용하는 사람 또는 애플리케이션을 나타내기 위해** 생성하는 엔터티입니다. AWS의 사용자는 이름과 자격 증명(비밀번호 및 최대 두 개의 액세스 키)으로 구성됩니다.

IAM 사용자를 생성할 때, 적절한 권한 정책이 첨부된 **사용자 그룹의 구성원**으로 만들어 **권한을 부여**하거나, 사용자에게 **직접 정책을 첨부**하여 권한을 부여합니다.

사용자는 **콘솔을 통해 로그인하기 위해 MFA를 활성화**할 수 있습니다. MFA가 활성화된 사용자의 API 토큰은 MFA로 보호되지 않습니다. 사용자의 API 키 액세스를 MFA로 제한하려면 정책에서 특정 작업을 수행하기 위해 MFA가 필요하다고 명시해야 합니다 (예제는 [**여기**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html) 참조).

#### CLI

* **Access Key ID**: AKHDNAPO86BSHKDIRYT와 같은 20개의 무작위 대문자 영숫자 문자
* **Secret access key ID**: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU와 같은 40개의 무작위 대소문자 문자 (분실한 비밀 액세스 키 ID는 복구할 수 없습니다).

**Access Key를 변경**해야 할 때는 다음 절차를 따라야 합니다:\
_새 액세스 키 생성 -> 시스템/애플리케이션에 새 키 적용 -> 원래 키를 비활성화로 표시 -> 새 액세스 키가 작동하는지 테스트 및 확인 -> 오래된 액세스 키 삭제_

### MFA - Multi Factor Authentication

기존 방법(예: 비밀번호) 외에 **추가 인증 요소를 생성**하여 다중 요소 인증 수준을 만듭니다.\
**무료 가상 애플리케이션 또는 물리적 장치**를 사용할 수 있습니다. AWS에서 MFA를 활성화하기 위해 google authentication과 같은 앱을 무료로 사용할 수 있습니다.

MFA 조건이 있는 정책은 다음에 첨부될 수 있습니다:

* IAM 사용자 또는 그룹
* Amazon S3 버킷, Amazon SQS 큐 또는 Amazon SNS 주제와 같은 리소스
* 사용자가 가정할 수 있는 IAM 역할의 신뢰 정책

**CLI를 통해** MFA를 **확인하는 리소스에 액세스**하려면 **`GetSessionToken`**을 호출해야 합니다. 그러면 MFA에 대한 정보가 포함된 토큰을 받게 됩니다.\
**`AssumeRole` 자격 증명에는 이 정보가 포함되지 않습니다**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
As [**stated here**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), there are a lot of different cases where **MFA cannot be used**.

### [IAM user groups](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

IAM [user group](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html)은 여러 사용자에게 한 번에 정책을 부여하는 방법으로, 이러한 사용자의 권한을 관리하기 쉽게 만듭니다. **역할과 그룹은 그룹의 일부가 될 수 없습니다**.

**사용자 그룹에 기반한 정책을 부여**하여 사용자 그룹의 **모든 사용자**가 **정책의 권한을 받도록** 할 수 있습니다. **정책**(예: 리소스 기반 정책)에서 **`Principal`**로 **사용자 그룹**을 식별할 수는 없습니다. 이는 그룹이 권한과 관련이 있고, Principal은 인증된 IAM 엔터티이기 때문입니다.

다음은 사용자 그룹의 중요한 특성입니다:

* 사용자 **그룹**은 **많은 사용자를 포함**할 수 있으며, **사용자**는 **여러 그룹에 속할 수 있습니다**.
* **사용자 그룹은 중첩될 수 없습니다**; 사용자만 포함할 수 있으며, 다른 사용자 그룹은 포함할 수 없습니다.
* AWS 계정에 **모든 사용자를 자동으로 포함하는 기본 사용자 그룹은 없습니다**. 그런 사용자 그룹을 원한다면, 직접 생성하고 각 새로운 사용자를 할당해야 합니다.
* AWS 계정의 IAM 리소스 수와 크기, 예를 들어 그룹 수와 사용자가 속할 수 있는 그룹 수는 제한이 있습니다. 자세한 내용은 [IAM 및 AWS STS 할당량](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html)을 참조하십시오.

### [IAM roles](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

IAM **role**은 **사용자**와 매우 **유사**하며, AWS에서 **무엇을 할 수 있고 할 수 없는지 결정하는 권한 정책을 가진** 신원입니다. 그러나 역할에는 **자격 증명**(비밀번호 또는 액세스 키)이 없습니다. 한 사람과 고유하게 연결되는 대신, 역할은 **필요한 사람이 사용할 수 있도록** 설계되었습니다. **IAM 사용자는 특정 작업을 위해 임시로** 다른 권한을 가지기 위해 역할을 맡을 수 있습니다. 역할은 외부 신원 제공자를 사용하여 로그인하는 [**연합 사용자**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html)에게 **할당될 수 있습니다**.

IAM 역할은 **두 가지 유형의 정책**으로 구성됩니다: 역할을 **누가 맡을 수 있는지 정의하는** **신뢰 정책**(비어 있을 수 없음)과 **무엇을 접근할 수 있는지 정의하는** **권한 정책**(비어 있을 수 없음).

#### AWS Security Token Service (STS)

AWS Security Token Service (STS)는 **임시, 제한된 권한 자격 증명 발급**을 용이하게 하는 웹 서비스입니다. 이는 다음과 같은 용도로 특별히 맞춰져 있습니다:

### [Temporary credentials in IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**임시 자격 증명은 주로 IAM 역할과 함께 사용**되지만, 다른 용도로도 사용됩니다. 표준 IAM 사용자보다 더 제한된 권한을 가진 임시 자격 증명을 요청할 수 있습니다. 이는 **더 제한된 자격 증명으로 허용되지 않는 작업을 실수로 수행하는 것을 방지**합니다. 임시 자격 증명의 장점은 설정된 기간이 지나면 자동으로 만료된다는 것입니다. 자격 증명이 유효한 기간을 제어할 수 있습니다.

### Policies

#### Policy Permissions

권한을 부여하는 데 사용됩니다. 두 가지 유형이 있습니다:

* AWS 관리 정책 (AWS에서 미리 구성한 정책)
* 고객 관리 정책: 사용자가 구성한 정책. AWS 관리 정책을 기반으로 정책을 생성하거나(하나를 수정하여 자신의 정책을 생성), 정책 생성기(권한 부여 및 거부를 도와주는 GUI 뷰)를 사용하거나 직접 작성할 수 있습니다.

**기본적으로 접근은** **거부**되며, 명시적인 역할이 지정된 경우에만 접근이 허용됩니다.\
**단일 "Deny"가 존재하면 "Allow"를 무시**하며, AWS 계정의 루트 보안 자격 증명을 사용하는 요청은 기본적으로 허용됩니다.
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
[조건에 사용할 수 있는 글로벌 필드는 여기에서 문서화되어 있습니다](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount).\
[서비스별로 조건에 사용할 수 있는 특정 필드는 여기에서 문서화되어 있습니다](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html).

#### Inline Policies

이러한 종류의 정책은 사용자, 그룹 또는 역할에 **직접 할당**됩니다. 따라서 다른 사람이 사용할 수 있는 정책 목록에 나타나지 않습니다.\
Inline policies는 정책과 적용되는 신원 간의 **엄격한 일대일 관계를 유지**하려는 경우 유용합니다. 예를 들어, 정책의 권한이 의도된 신원 외의 다른 신원에 실수로 할당되지 않도록 하고 싶을 때 유용합니다. Inline policy를 사용하면 정책의 권한이 잘못된 신원에 실수로 연결되지 않습니다. 또한 AWS Management Console을 사용하여 해당 신원을 삭제할 때, 신원에 포함된 정책도 함께 삭제됩니다. 이는 정책이 주체 엔터티의 일부이기 때문입니다.

#### Resource Bucket Policies

이것들은 **리소스**에 정의될 수 있는 **정책**입니다. **모든 AWS 리소스가 이를 지원하는 것은 아닙니다**.

주체가 명시적인 거부를 가지고 있지 않고 리소스 정책이 접근을 허용하는 경우, 접근이 허용됩니다.

### IAM Boundaries

IAM boundaries는 **사용자나 역할이 접근할 수 있는 권한을 제한**하는 데 사용될 수 있습니다. 이렇게 하면 **다른 정책**에 의해 사용자가 다른 권한을 부여받더라도, 이를 사용하려고 하면 **실패**하게 됩니다.

Boundary는 사용자에게 첨부된 정책으로, **사용자나 역할이 가질 수 있는 최대 권한 수준을 나타냅니다**. 따라서 **사용자가 관리자 접근 권한을 가지고 있더라도**, boundary가 그가 S3 버킷을 읽을 수만 있다고 표시하면, 그것이 그가 할 수 있는 최대한의 작업입니다.

**이것**, **SCPs** 및 **최소 권한 원칙**을 따르는 것이 사용자가 필요한 권한 이상을 가지지 않도록 제어하는 방법입니다.

### Session Policies

Session policy는 **역할이 어떤 방식으로든 가정될 때 설정되는 정책**입니다. 이는 **해당 세션에 대한 IAM boundary와 유사합니다**: 즉, session policy는 권한을 부여하지 않지만 **정책에 명시된 권한으로 제한**합니다 (역할이 가진 최대 권한).

이는 **보안 조치**에 유용합니다: 관리자가 매우 높은 권한을 가진 역할을 가정할 때, 세션이 손상될 경우를 대비하여 session policy에 명시된 권한으로만 제한할 수 있습니다.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
기본적으로 **AWS는 세션 정책을 추가할 수 있습니다**. 이는 타사 이유로 생성되는 세션에 적용됩니다. 예를 들어, [인증되지 않은 cognito 가정 역할](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles)에서는 기본적으로 (향상된 인증을 사용하여) AWS가 **세션 정책이 포함된 세션 자격 증명**을 생성하여 해당 세션이 접근할 수 있는 서비스를 [**다음 목록**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services)으로 제한합니다.

따라서, "... 세션 정책이 허용하지 않기 때문에 ..."라는 오류가 발생하고 역할이 해당 작업을 수행할 수 있는 권한이 있는 경우, **세션 정책이 이를 방지하고 있기 때문**입니다.

### Identity Federation

Identity federation은 **외부의 신원 제공자**로부터 온 사용자가 유효한 IAM 사용자 계정의 AWS 사용자 자격 증명을 제공하지 않고도 AWS 리소스에 안전하게 접근할 수 있도록 합니다.\
신원 제공자의 예로는 **Microsoft Active Directory**(**SAML**을 통해) 또는 **OpenID** 서비스(예: **Google**)가 있습니다. 연합된 접근은 해당 사용자들이 AWS에 접근할 수 있도록 합니다.

이 신뢰를 구성하려면, **IAM Identity Provider(SAML 또는 OAuth)**가 생성되어 **다른 플랫폼을 신뢰**하게 됩니다. 그런 다음, 최소한 하나의 **IAM 역할이 신원 제공자를 신뢰하도록 할당**됩니다. 신뢰된 플랫폼의 사용자가 AWS에 접근하면, 그는 언급된 역할로 접근하게 됩니다.

그러나, 일반적으로 **타사 플랫폼의 사용자 그룹에 따라 다른 역할을 부여**하고 싶을 것입니다. 그런 다음, 여러 **IAM 역할이 타사 신원 제공자를 신뢰**할 수 있으며, 타사 플랫폼이 사용자가 어떤 역할을 맡을지 결정하게 됩니다.

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### IAM Identity Center

AWS IAM Identity Center(AWS Single Sign-On의 후속)는 AWS Identity and Access Management(IAM)의 기능을 확장하여 **사용자와 그들의 AWS 계정 및 클라우드 애플리케이션에 대한 접근 관리**를 중앙에서 제공합니다.

로그인 도메인은 `<user_input>.awsapps.com`과 같은 형태가 됩니다.

사용자를 로그인시키기 위해 사용할 수 있는 신원 소스는 다음과 같습니다:

* Identity Center Directory: 일반 AWS 사용자
* Active Directory: 다양한 커넥터 지원
* External Identity Provider: 모든 사용자와 그룹이 외부 신원 제공자(IdP)에서 옴

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

가장 간단한 경우인 Identity Center 디렉토리에서는, **Identity Center가 사용자 및 그룹 목록을 가지고** 있으며, **조직의 모든 계정에 대해 정책을 할당**할 수 있습니다.

Identity Center 사용자/그룹에게 계정 접근 권한을 부여하기 위해 **Identity Center를 신뢰하는 SAML Identity Provider가 생성**되고, **지정된 정책을 가진 신원 제공자를 신뢰하는 역할이 대상 계정에 생성**됩니다.

#### AwsSSOInlinePolicy

IAM Identity Center를 통해 생성된 역할에 **인라인 정책을 통해 권한을 부여**할 수 있습니다. AWS Identity Center에서 **인라인 정책을 부여받은 계정의 역할**은 **`AwsSSOInlinePolicy`**라는 인라인 정책에서 이러한 권한을 갖게 됩니다.

따라서, **`AwsSSOInlinePolicy`**라는 인라인 정책을 가진 두 역할을 보더라도, **동일한 권한을 가지고 있지 않을 수 있습니다**.

### Cross Account Trusts and Roles

**사용자**(신뢰하는)는 일부 정책을 가진 Cross Account Role을 생성하고, **다른 사용자**(신뢰받는)가 **새로운 역할 정책에 명시된 접근 권한만을 가지고 자신의 계정에 접근할 수 있도록 허용**할 수 있습니다. 이를 생성하려면, 새 역할을 생성하고 Cross Account Role을 선택하면 됩니다. Cross-Account Access를 위한 역할은 두 가지 옵션을 제공합니다. 소유한 AWS 계정 간의 접근 제공과 소유한 계정과 타사 AWS 계정 간의 접근 제공입니다.\
**신뢰받는 사용자를 명시하고 일반적인 것을 넣지 않는 것이 좋습니다**. 그렇지 않으면, 연합된 사용자와 같은 다른 인증된 사용자도 이 신뢰를 악용할 수 있기 때문입니다.

### AWS Simple AD

지원되지 않음:

* 신뢰 관계
* AD 관리 센터
* 전체 PS API 지원
* AD 휴지통
* 그룹 관리 서비스 계정
* 스키마 확장
* OS 또는 인스턴스에 대한 직접 접근 없음

#### Web Federation or OpenID Authentication

앱은 AssumeRoleWithWebIdentity를 사용하여 임시 자격 증명을 생성합니다. 그러나 이는 AWS 콘솔 접근 권한을 부여하지 않으며, AWS 내의 리소스에 대한 접근만을 부여합니다.

### Other IAM options

* 최소 길이 및 비밀번호 요구 사항과 같은 옵션으로 **비밀번호 정책을 설정**할 수 있습니다.
* 현재 자격 증명에 대한 정보(예: 사용자 생성 시간, 비밀번호 활성화 여부 등)를 포함한 **"자격 증명 보고서"를 다운로드**할 수 있습니다. 자격 증명 보고서는 **4시간마다** 한 번 생성할 수 있습니다.

AWS Identity and Access Management (IAM)는 AWS 전반에 걸쳐 **세밀한 접근 제어**를 제공합니다. IAM을 사용하면 **누가 어떤 서비스와 리소스에 접근할 수 있는지** 및 어떤 조건에서 접근할 수 있는지를 지정할 수 있습니다. IAM 정책을 통해, 최소 권한 원칙을 **보장하기 위해** 인력과 시스템에 대한 권한을 관리할 수 있습니다.

### IAM ID Prefixes

[**이 페이지**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids)에서 키의 성격에 따라 **IAM ID 접두사**를 찾을 수 있습니다:

| ABIA | [AWS STS 서비스 베어러 토큰](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | 컨텍스트별 자격 증명                                                                                                                                                                                           |
| AGPA | 사용자 그룹                                                                                                                                                                                                            |
| AIDA | IAM 사용자                                                                                                                                                                                                              |
| AIPA | Amazon EC2 인스턴스 프로필                                                                                                                                                                                           |
| AKIA | 접근 키                                                                                                                                                                                                            |
| ANPA | 관리 정책                                                                                                                                                                                                        |
| ANVA | 관리 정책의 버전                                                                                                                                                                                           |
| APKA | 공개 키                                                                                                                                                                                                            |
| AROA | 역할                                                                                                                                                                                                                  |
| ASCA | 인증서                                                                                                                                                                                                           |
| ASIA | [임시 (AWS STS) 접근 키 ID](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html)는 이 접두사를 사용하지만, 비밀 접근 키 및 세션 토큰과 결합된 경우에만 고유합니다. |

### Recommended permissions to audit accounts

다음 권한은 메타데이터의 다양한 읽기 접근 권한을 부여합니다:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Misc

### CLI Authentication

일반 사용자가 CLI를 통해 AWS에 인증하려면 **로컬 자격 증명**이 필요합니다. 기본적으로 `~/.aws/credentials`에 **수동으로** 구성하거나 **`aws configure`를 실행**하여 구성할 수 있습니다.\
해당 파일에는 하나 이상의 프로필을 가질 수 있으며, **aws cli**를 사용할 때 **프로필이 지정되지 않으면**, 해당 파일에서 **`[default]`**로 불리는 프로필이 사용됩니다.\
여러 프로필이 있는 자격 증명 파일의 예:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
만약 **다른 AWS 계정**에 접근해야 하고, 프로필이 **그 계정 내 역할을 가정할 수 있는** 권한을 부여받았다면, 매번 수동으로 STS를 호출(`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`)하고 자격 증명을 설정할 필요가 없습니다.

`~/.aws/config` 파일을 사용하여 [**가정할 역할을 지정**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html)할 수 있으며, 평소처럼 `--profile` 매개변수를 사용할 수 있습니다 (`assume-role`은 사용자에게 투명하게 수행됩니다).\
config 파일 예시:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
이 구성 파일을 사용하여 aws cli를 다음과 같이 사용할 수 있습니다:
```
aws --profile acc2 ...
```
If you are looking for something **similar** to this but for the **browser** you can check the **extension** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## References

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

{% hint style="success" %}
AWS 해킹을 배우고 연습하세요:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP 해킹을 배우고 연습하세요: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원하기</summary>

* [**subscription plans**](https://github.com/sponsors/carlospolop)을 확인하세요!
* 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) 또는 [**telegram group**](https://t.me/peass)에 가입하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)을 팔로우하세요.
* PR을 제출하여 [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 해킹 트릭을 공유하세요.

</details>
{% endhint %}
