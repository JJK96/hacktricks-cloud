# AWS - Basic Information

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **PRを提出してハッキングトリックを共有する** [**HackTricks**](https://github.com/carlospolop/hacktricks) および [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubリポジトリ。

</details>
{% endhint %}

## Organization Hierarchy

![](<../../../.gitbook/assets/image (151).png>)

### Accounts

AWSには**ルートアカウント**があり、これは**組織のすべてのアカウントの親コンテナ**です。しかし、そのアカウントを使用してリソースをデプロイする必要はなく、**異なるAWSインフラストラクチャを分離するために他のアカウントを作成**できます。

これは**セキュリティ**の観点から非常に興味深いです。**1つのアカウントは他のアカウントのリソースにアクセスできない**（特定のブリッジが作成されていない限り）ため、この方法でデプロイメント間に境界を作成できます。

したがって、組織には**2種類のアカウント**があります（ここではAWSアカウントについて話しており、ユーザーアカウントではありません）：管理アカウントとして指定された単一のアカウントと、1つ以上のメンバーアカウントです。

* **管理アカウント（ルートアカウント）**は、組織を作成するために使用するアカウントです。組織の管理アカウントからは、以下のことができます：

* 組織内でアカウントを作成する
* 他の既存のアカウントを組織に招待する
* 組織からアカウントを削除する
* 招待を管理する
* 組織内のエンティティ（ルート、OU、またはアカウント）にポリシーを適用する
* 組織内のすべてのアカウントにサービス機能を提供するために、サポートされているAWSサービスとの統合を有効にする
* このルートアカウント/組織を作成するために使用したメールとパスワードを使用してルートユーザーとしてログインすることが可能です。

管理アカウントは**支払アカウントの責任**を持ち、メンバーアカウントによって発生したすべての料金を支払う責任があります。組織の管理アカウントを変更することはできません。
* **メンバーアカウント**は、組織内の残りのすべてのアカウントを構成します。アカウントは一度に1つの組織のメンバーであることができます。アカウントにポリシーを添付して、その1つのアカウントにのみ制御を適用することができます。
* メンバーアカウントは**有効なメールアドレスを使用する必要があり**、**名前**を持つことができます。一般的に、請求を管理することはできません（ただし、アクセスが与えられる場合もあります）。
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Organization Units**

アカウントは**Organization Units (OU)**にグループ化できます。この方法で、Organization Unitに対して**ポリシー**を作成し、それが**すべての子アカウントに適用**されます。OUは他のOUを子として持つことができることに注意してください。
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Service Control Policy (SCP)

**サービスコントロールポリシー (SCP)** は、SCP が影響を与えるアカウントでユーザーやロールが使用できるサービスとアクションを指定するポリシーです。SCP は **IAM** 権限ポリシーに似ていますが、**権限を付与しません**。代わりに、SCP は組織、組織単位 (OU)、またはアカウントの**最大権限**を指定します。SCP を組織のルートや OU にアタッチすると、**SCP はメンバーアカウント内のエンティティの権限を制限**します。

これは、**ルートユーザーでさえ何かをするのを止める唯一の方法**です。例えば、ユーザーが CloudTrail を無効にしたり、バックアップを削除したりするのを防ぐために使用できます。\
これを回避する唯一の方法は、SCP を設定する**マスターアカウント**も侵害することです（マスターアカウントはブロックできません）。

{% hint style="warning" %}
**SCP はアカウント内のプリンシパルのみを制限**することに注意してください。他のアカウントには影響しません。つまり、SCP が `s3:GetObject` を拒否しても、アカウント内の**公開 S3 バケットにアクセスする**ことは止められません。
{% endhint %}

SCP の例:

* ルートアカウントを完全に拒否
* 特定のリージョンのみを許可
* ホワイトリストに登録されたサービスのみを許可
* GuardDuty、CloudTrail、および S3 Public Block Access の無効化を拒否
* セキュリティ/インシデント対応ロールの削除または変更を拒否
* バックアップの削除を拒否
* IAM ユーザーとアクセスキーの作成を拒否

**JSON の例**は [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html) で見つけてください。

### ARN

**Amazon Resource Name** は、AWS 内のすべてのリソースが持つ**一意の名前**で、次のように構成されています:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
AWSには4つのパーティションがありますが、呼び出し方法は3つだけです:

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US public Internet (GovCloud): `aws-us-gov`
* AWS Secret (US Classified): `aws`

## IAM - Identity and Access Management

IAMは、AWSアカウント内で**認証**、**認可**、および**アクセス制御**を管理するサービスです。

* **認証** - アイデンティティを定義し、そのアイデンティティを検証するプロセス。このプロセスは、識別と検証に分けることができます。
* **認可** - 認証されたアイデンティティがシステム内でアクセスできる内容を決定します。
* **アクセス制御** - セキュアなリソースへのアクセスがどのように付与されるかの方法とプロセス

IAMは、AWSアカウント内のリソースに対するアイデンティティの認証、認可、およびアクセス制御メカニズムを管理、制御、ガバナンスする能力によって定義できます。

### [AWSアカウントのルートユーザー](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Amazon Web Services (AWS) アカウントを最初に作成すると、アカウント内の**すべての**AWSサービスとリソースに完全にアクセスできる単一のサインインアイデンティティから始まります。これがAWSアカウントの_**ルートユーザー**_であり、**アカウント作成に使用したメールアドレスとパスワード**でサインインします。

新しい**管理者ユーザー**は**ルートユーザーよりも権限が少ない**ことに注意してください。

セキュリティの観点から、他のユーザーを作成し、このユーザーの使用を避けることが推奨されます。

### [IAMユーザー](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

IAM _ユーザー_ は、AWSで**人またはアプリケーションを表す**ために作成するエンティティです。AWSのユーザーは、名前と資格情報（パスワードおよび最大2つのアクセスキー）で構成されます。

IAMユーザーを作成すると、適切な権限ポリシーが添付された**ユーザーグループのメンバー**にすることで（推奨）、またはユーザーに**直接ポリシーを添付**することで、**権限**を付与します。

ユーザーは**MFAを有効にしてコンソールにログイン**できます。MFAが有効なユーザーのAPIトークンはMFAによって保護されません。ユーザーのAPIキーのアクセスをMFAで制限したい場合は、特定のアクションを実行するためにMFAが必要であることをポリシーに示す必要があります（例は[**こちら**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)）。

#### CLI

* **アクセスキーID**: AKHDNAPO86BSHKDIRYTのような20文字のランダムな大文字の英数字
* **シークレットアクセスキーID**: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtUのような40文字のランダムな大文字と小文字の文字列（失われたシークレットアクセスキーIDを取得することはできません）。

アクセスキーを**変更する必要がある場合**、次のプロセスに従うべきです:\
_新しいアクセスキーを作成 -> 新しいキーをシステム/アプリケーションに適用 -> 元のキーを非アクティブにする -> 新しいアクセスキーが機能することをテストおよび確認 -> 古いアクセスキーを削除_

### MFA - Multi Factor Authentication

既存の方法（パスワードなど）に加えて**追加の認証要素を作成**するために使用され、したがって、マルチファクターレベルの認証を作成します。\
**無料の仮想アプリケーションまたは物理デバイス**を使用できます。AWSでMFAを有効にするために、Google認証などのアプリを無料で使用できます。

MFA条件を持つポリシーは、次のものに添付できます:

* IAMユーザーまたはグループ
* Amazon S3バケット、Amazon SQSキュー、またはAmazon SNSトピックなどのリソース
* ユーザーが引き受けることができるIAMロールの信頼ポリシー

MFAを**チェックするリソースにCLI経由でアクセス**する場合は、**`GetSessionToken`**を呼び出す必要があります。それにより、MFAに関する情報を含むトークンが得られます。\
**`AssumeRole`の資格情報にはこの情報が含まれていない**ことに注意してください。
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
As [**stated here**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), there are a lot of different cases where **MFA cannot be used**.

### [IAM user groups](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

IAM [user group](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) は、**複数のユーザーにポリシーを一度にアタッチする**方法であり、これによりこれらのユーザーの権限を管理しやすくなります。**ロールとグループはグループの一部にはなれません**。

**ユーザーグループにアイデンティティベースのポリシーをアタッチ**することで、ユーザーグループ内の**すべてのユーザーがそのポリシーの権限を受け取る**ことができます。**ユーザーグループをポリシーの** **`Principal`** **として識別することはできません**（リソースベースのポリシーなど）なぜなら、グループは認証ではなく権限に関連しており、プリンシパルは認証されたIAMエンティティだからです。

ユーザーグループの重要な特徴は次のとおりです：

* ユーザー**グループ**は**多くのユーザーを含む**ことができ、**ユーザー**は**複数のグループに属する**ことができます。
* **ユーザーグループはネストできません**。ユーザーのみを含むことができ、他のユーザーグループを含むことはできません。
* **AWSアカウント内のすべてのユーザーを自動的に含むデフォルトのユーザーグループはありません**。そのようなユーザーグループが必要な場合は、それを作成し、新しいユーザーをすべてそのグループに割り当てる必要があります。
* AWSアカウント内のIAMリソースの数とサイズ（グループの数、ユーザーがメンバーになれるグループの数など）には制限があります。詳細については、[IAMとAWS STSのクォータ](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html)を参照してください。

### [IAM roles](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

IAM **role** は**ユーザー**に非常に**似ており**、AWSで何ができるかを決定する**権限ポリシーを持つアイデンティティ**です。しかし、ロールには**資格情報（パスワードやアクセスキー）がありません**。特定の人物に一意に関連付けられるのではなく、ロールは**必要な人が（十分な権限を持って）引き受けることができる**ことを意図しています。**IAMユーザーは特定のタスクのために一時的にロールを引き受ける**ことができます。ロールは、IAMの代わりに外部のアイデンティティプロバイダーを使用してサインインする[**フェデレーテッドユーザー**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html)に割り当てることができます。

IAMロールは**2種類のポリシー**で構成されています：**信頼ポリシー**（空にできない）、ロールを**引き受けることができる人を定義**し、**権限ポリシー**（空にできない）、**アクセスできるものを定義**します。

#### AWS Security Token Service (STS)

AWS Security Token Service (STS) は、**一時的な、限定的な権限を持つ資格情報の発行**を支援するウェブサービスです。これは特に以下のために設計されています：

### [Temporary credentials in IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**一時的な資格情報は主にIAMロールで使用されます**が、他にも使用方法があります。標準のIAMユーザーよりも制限された権限を持つ一時的な資格情報をリクエストすることができます。これにより、**制限された資格情報によって許可されていないタスクを誤って実行することを防ぐ**ことができます。一時的な資格情報の利点は、設定された期間後に自動的に期限切れになることです。資格情報の有効期間を制御できます。

### Policies

#### Policy Permissions

権限を割り当てるために使用されます。2種類あります：

* AWS managed policies (AWSによって事前構成されたもの)
* Customer Managed Policies: あなたが構成するもの。AWS managed policiesに基づいてポリシーを作成することができます（それらの1つを修正して独自のものを作成）、ポリシージェネレーターを使用する（権限の付与と拒否を支援するGUIビュー）または独自に作成することができます。

**デフォルトではアクセスは拒否されます**。明示的なロールが指定されている場合にアクセスが許可されます。\
**単一の「Deny」が存在する場合、それは「Allow」を上書きします**。ただし、AWSアカウントのルートセキュリティ資格情報を使用するリクエスト（デフォルトで許可されている）を除きます。
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
[グローバルフィールドは、任意のサービスで条件に使用できるものがここに記載されています](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount)。\
[サービスごとに条件に使用できる特定のフィールドはここに記載されています](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html)。

#### Inline Policies

この種類のポリシーはユーザー、グループ、またはロールに**直接割り当てられます**。そのため、他の誰も使用できないため、ポリシーリストには表示されません。\
Inline policiesは、ポリシーとそれが適用されるアイデンティティの間に**厳密な一対一の関係を維持したい場合に便利です**。例えば、ポリシーの権限が意図したアイデンティティ以外に誤って割り当てられないようにしたい場合です。Inline policyを使用すると、ポリシーの権限が誤って間違ったアイデンティティに付与されることはありません。さらに、AWS Management Consoleを使用してそのアイデンティティを削除すると、そのアイデンティティに埋め込まれたポリシーも削除されます。これは、それらが主要なエンティティの一部であるためです。

#### Resource Bucket Policies

これらは**リソース**に定義できる**ポリシー**です。**すべてのAWSリソースがこれをサポートしているわけではありません**。

プリンシパルに明示的な拒否がない場合、リソースポリシーがアクセスを許可すると、アクセスが許可されます。

### IAM Boundaries

IAM boundariesは、ユーザーまたはロールがアクセスできる権限を**制限するために使用できます**。この方法では、**異なるポリシー**によってユーザーに異なる権限が付与されていても、操作が**失敗**します。

boundaryは、ユーザーに付与されるポリシーであり、**ユーザーまたはロールが持つことができる最大の権限を示します**。したがって、**ユーザーが管理者アクセス権を持っていても**、boundaryがS3バケットの読み取りのみを許可している場合、それが最大の権限となります。

**これ**、**SCPs**、および**最小権限の原則**に従うことが、ユーザーが必要以上の権限を持たないようにする方法です。

### Session Policies

Session policyは、**ロールが何らかの方法で引き受けられたときに設定されるポリシー**です。これは、そのセッションの**IAM boundaryのようなもの**です：つまり、session policyは権限を付与するのではなく、**ポリシーで指定された権限に制限します**（ロールが持つ最大の権限が基準となります）。

これは**セキュリティ対策**として有用です：管理者が非常に高い権限を持つロールを引き受ける際に、セッションが侵害された場合に備えて、session policyで指定された権限のみに制限することができます。
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
デフォルトでは、**AWSはセッションポリシーをセッションに追加する**ことがあります。これは第三の理由によって生成されるセッションに対して行われます。例えば、[unauthenticated cognito assumed roles](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles)の場合、デフォルトで（強化認証を使用して）、AWSは**セッションポリシーを持つセッション認証情報**を生成し、そのセッションがアクセスできるサービスを[**次のリスト**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services)に制限します。

したがって、ある時点で「... because no session policy allows the ...」というエラーが発生し、ロールがそのアクションを実行するアクセス権を持っている場合、それは**セッションポリシーがそれを防いでいる**ためです。

### Identity Federation

Identity federationは、**外部のアイデンティティプロバイダーからのユーザーが**、有効なIAMユーザーアカウントのAWSユーザー認証情報を提供することなく、AWSリソースに安全にアクセスできるようにします。\
アイデンティティプロバイダーの例としては、企業の**Microsoft Active Directory**（**SAML**経由）や**OpenID**サービス（**Google**など）があります。フェデレーテッドアクセスにより、その中のユーザーがAWSにアクセスできるようになります。

この信頼を構成するために、**IAM Identity Provider（SAMLまたはOAuth）**が生成され、**他のプラットフォームを信頼**します。次に、少なくとも1つの**IAMロールがアイデンティティプロバイダーを信頼するように割り当てられます**。信頼されたプラットフォームのユーザーがAWSにアクセスすると、前述のロールとしてアクセスすることになります。

しかし、通常は**第三者プラットフォームのユーザーグループに応じて異なるロールを付与**したいと考えるでしょう。その場合、複数の**IAMロールが第三者アイデンティティプロバイダーを信頼**し、第三者プラットフォームがユーザーにどのロールを引き受けるかを許可します。

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### IAM Identity Center

AWS IAM Identity Center（AWS Single Sign-Onの後継）は、AWS Identity and Access Management (IAM)の機能を拡張し、**ユーザーとそのAWSアカウントおよびクラウドアプリケーションへのアクセスの管理を一元化**します。

ログインドメインは`<user_input>.awsapps.com`のようになります。

ユーザーをログインさせるために、次の3つのアイデンティティソースを使用できます：

* Identity Center Directory: 通常のAWSユーザー
* Active Directory: 異なるコネクタをサポート
* External Identity Provider: すべてのユーザーとグループが外部アイデンティティプロバイダー（IdP）から来る

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

最も単純なIdentity Centerディレクトリの場合、**Identity Centerはユーザーとグループのリストを持ち**、組織の**任意のアカウントにポリシーを割り当てる**ことができます。

Identity Centerユーザー/グループにアカウントへのアクセスを与えるために、**Identity Centerを信頼するSAML Identity Providerが作成され**、**指定されたポリシーを持つIdentity Providerを信頼するロールが宛先アカウントに作成されます**。

#### AwsSSOInlinePolicy

IAM Identity Centerを介して作成されたロールに**インラインポリシーを介して権限を与える**ことが可能です。AWS Identity Centerでインラインポリシーを与えられたアカウントに作成されたロールは、**`AwsSSOInlinePolicy`**というインラインポリシーにこれらの権限を持ちます。

したがって、2つのロールに**`AwsSSOInlinePolicy`**というインラインポリシーがある場合でも、それが**同じ権限を持っているとは限りません**。

### Cross Account Trusts and Roles

**ユーザー**（信頼する側）は、いくつかのポリシーを持つCross Account Roleを作成し、**他のユーザー**（信頼される側）に**新しいロールポリシーで指定されたアクセス権のみを持って**自分のアカウントにアクセスすることを許可できます。これを作成するには、新しいロールを作成し、Cross Account Roleを選択します。Cross-Account Accessのロールは2つのオプションを提供します。所有するAWSアカウント間のアクセスを提供することと、所有するアカウントと第三者のAWSアカウント間のアクセスを提供することです。\
信頼されるユーザーを指定し、一般的なものを設定しないことをお勧めします。そうしないと、フェデレーテッドユーザーなどの他の認証済みユーザーがこの信頼を悪用する可能性があります。

### AWS Simple AD

サポートされていない機能：

* Trust Relations
* AD Admin Center
* Full PS API support
* AD Recycle Bin
* Group Managed Service Accounts
* Schema Extensions
* No Direct access to OS or Instances

#### Web Federation or OpenID Authentication

アプリはAssumeRoleWithWebIdentityを使用して一時的な認証情報を作成します。ただし、これによりAWSコンソールへのアクセスが許可されるわけではなく、AWS内のリソースへのアクセスのみが許可されます。

### Other IAM options

* 最小長やパスワード要件などのオプションを設定する**パスワードポリシーを設定**できます。
* 現在の認証情報に関する情報（ユーザー作成時間、パスワードが有効かどうかなど）を含む**"Credential Report"をダウンロード**できます。認証情報レポートは**4時間ごと**に生成できます。

AWS Identity and Access Management (IAM)は、AWS全体で**きめ細かいアクセス制御**を提供します。IAMを使用すると、**誰がどのサービスとリソースにアクセスできるか**、およびどの条件下でアクセスできるかを指定できます。IAMポリシーを使用して、最小特権の権限を確保するために、従業員とシステムへの権限を管理します。

### IAM ID Prefixes

[**このページ**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids)で、キーの性質に応じた**IAM IDプレフィックス**を見つけることができます：

| ABIA | [AWS STS service bearer token](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Context-specific credential                                                                                                                                                                                           |
| AGPA | User group                                                                                                                                                                                                            |
| AIDA | IAM user                                                                                                                                                                                                              |
| AIPA | Amazon EC2 instance profile                                                                                                                                                                                           |
| AKIA | Access key                                                                                                                                                                                                            |
| ANPA | Managed policy                                                                                                                                                                                                        |
| ANVA | Version in a managed policy                                                                                                                                                                                           |
| APKA | Public key                                                                                                                                                                                                            |
| AROA | Role                                                                                                                                                                                                                  |
| ASCA | Certificate                                                                                                                                                                                                           |
| ASIA | [Temporary (AWS STS) access key IDs](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) use this prefix, but are unique only in combination with the secret access key and the session token. |

### Recommended permissions to audit accounts

次の特権は、メタデータのさまざまな読み取りアクセスを提供します：

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Misc

### CLI Authentication

通常のユーザーがCLIを介してAWSに認証するためには、**ローカル認証情報**が必要です。デフォルトでは、`~/.aws/credentials`に**手動で**設定するか、**`aws configure`を実行**して設定できます。\
そのファイルには複数のプロファイルを持つことができ、**aws cli**を使用して**プロファイルが指定されていない**場合、そのファイル内の**`[default]`**と呼ばれるプロファイルが使用されます。\
複数のプロファイルを持つ認証情報ファイルの例：
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
もし**異なるAWSアカウント**にアクセスする必要があり、あなたのプロファイルが**それらのアカウント内のロールを引き受ける**アクセス権を与えられている場合、毎回手動でSTSを呼び出して（`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`）資格情報を設定する必要はありません。

`~/.aws/config`ファイルを使用して[**引き受けるロールを指定**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html)し、通常通り`--profile`パラメータを使用できます（`assume-role`はユーザーに対して透過的に実行されます）。\
設定ファイルの例:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
この設定ファイルを使用して、次のようにaws cliを使用できます:
```
aws --profile acc2 ...
```
もし**ブラウザ**用に**似たような**ものを探しているなら、**拡張機能** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en)をチェックしてください。

## 参考文献

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

{% hint style="success" %}
AWS Hackingを学び、練習する:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingを学び、練習する: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローしてください。
* **PRを提出してハッキングトリックを共有してください** [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリに。

</details>
{% endhint %}
