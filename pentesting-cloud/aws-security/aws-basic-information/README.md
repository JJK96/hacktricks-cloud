# AWS - Informa√ß√µes B√°sicas

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Hierarquia da Organiza√ß√£o

![](<../../../.gitbook/assets/image (151).png>)

### Contas

Na AWS, existe uma **conta root**, que √© o **container pai para todas as contas** da sua **organiza√ß√£o**. No entanto, voc√™ n√£o precisa usar essa conta para implantar recursos; voc√™ pode criar **outras contas para separar diferentes infraestruturas AWS** entre elas.

Isso √© muito interessante do ponto de vista de **seguran√ßa**, pois **uma conta n√£o poder√° acessar recursos de outra conta** (exceto se pontes forem especificamente criadas), assim voc√™ pode criar limites entre as implanta√ß√µes.

Portanto, existem **dois tipos de contas em uma organiza√ß√£o** (estamos falando de contas AWS e n√£o de contas de Usu√°rio): uma √∫nica conta designada como conta de gerenciamento e uma ou mais contas membro.

*   A **conta de gerenciamento (a conta root)** √© a conta que voc√™ usa para criar a organiza√ß√£o. A partir da conta de gerenciamento da organiza√ß√£o, voc√™ pode fazer o seguinte:

* Criar contas na organiza√ß√£o
* Convidar outras contas existentes para a organiza√ß√£o
* Remover contas da organiza√ß√£o
* Gerenciar convites
* Aplicar pol√≠ticas a entidades (roots, OUs ou contas) dentro da organiza√ß√£o
* Habilitar integra√ß√£o com servi√ßos AWS suportados para fornecer funcionalidade de servi√ßo em todas as contas da organiza√ß√£o.
* √â poss√≠vel fazer login como usu√°rio root usando o e-mail e a senha usados para criar essa conta root/organiza√ß√£o.

A conta de gerenciamento tem as **responsabilidades de uma conta pagadora** e √© respons√°vel por pagar todas as cobran√ßas acumuladas pelas contas membro. Voc√™ n√£o pode alterar a conta de gerenciamento de uma organiza√ß√£o.
* **Contas membro** comp√µem todas as outras contas em uma organiza√ß√£o. Uma conta pode ser membro de apenas uma organiza√ß√£o por vez. Voc√™ pode anexar uma pol√≠tica a uma conta para aplicar controles apenas a essa conta.
* Contas membro **devem usar um endere√ßo de e-mail v√°lido** e podem ter um **nome**; em geral, elas n√£o poder√£o gerenciar a cobran√ßa (mas podem receber acesso a isso).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Organization Units**

Contas podem ser agrupadas em **Organization Units (OU)**. Dessa forma, voc√™ pode criar **pol√≠ticas** para a Organization Unit que ser√£o **aplicadas a todas as contas filhas**. Note que uma OU pode ter outras OUs como filhas.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Service Control Policy (SCP)

Uma **service control policy (SCP)** √© uma pol√≠tica que especifica os servi√ßos e a√ß√µes que usu√°rios e fun√ß√µes podem usar nas contas que a SCP afeta. SCPs s√£o **semelhantes √†s pol√≠ticas de permiss√µes do IAM**, exceto que elas **n√£o concedem nenhuma permiss√£o**. Em vez disso, as SCPs especificam as **permiss√µes m√°ximas** para uma organiza√ß√£o, unidade organizacional (OU) ou conta. Quando voc√™ anexa uma SCP √† raiz da sua organiza√ß√£o ou a uma OU, a **SCP limita as permiss√µes para entidades em contas membros**.

Esta √© a √öNICA maneira de **at√© mesmo o usu√°rio root ser impedido** de fazer algo. Por exemplo, pode ser usada para impedir usu√°rios de desativar o CloudTrail ou excluir backups.\
A √∫nica maneira de contornar isso √© comprometer tamb√©m a **conta master** que configura as SCPs (a conta master n√£o pode ser bloqueada).

{% hint style="warning" %}
Note que **SCPs apenas restringem os principais na conta**, ent√£o outras contas n√£o s√£o afetadas. Isso significa que ter uma SCP negando `s3:GetObject` n√£o impedir√° pessoas de **acessar um bucket S3 p√∫blico** na sua conta.
{% endhint %}

Exemplos de SCP:

* Negar completamente a conta root
* Permitir apenas regi√µes espec√≠ficas
* Permitir apenas servi√ßos na lista branca
*   Negar que GuardDuty, CloudTrail e S3 Public Block Access sejam desativados
*   Negar que fun√ß√µes de seguran√ßa/resposta a incidentes sejam exclu√≠das ou modificadas.
* Negar que backups sejam exclu√≠dos.
* Negar a cria√ß√£o de usu√°rios IAM e chaves de acesso

Encontre **exemplos de JSON** em [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)

### ARN

**Amazon Resource Name** √© o **nome √∫nico** que cada recurso dentro do AWS possui, composto da seguinte forma:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Note que existem 4 parti√ß√µes na AWS, mas apenas 3 maneiras de cham√°-las:

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US public Internet (GovCloud): `aws-us-gov`
* AWS Secret (US Classified): `aws`

## IAM - Identity and Access Management

IAM √© o servi√ßo que permitir√° gerenciar **Autentica√ß√£o**, **Autoriza√ß√£o** e **Controle de Acesso** dentro da sua conta AWS.

* **Autentica√ß√£o** - Processo de definir uma identidade e a verifica√ß√£o dessa identidade. Este processo pode ser subdividido em: Identifica√ß√£o e verifica√ß√£o.
* **Autoriza√ß√£o** - Determina o que uma identidade pode acessar dentro de um sistema uma vez que foi autenticada.
* **Controle de Acesso** - O m√©todo e processo de como o acesso √© concedido a um recurso seguro.

IAM pode ser definido por sua capacidade de gerenciar, controlar e governar mecanismos de autentica√ß√£o, autoriza√ß√£o e controle de acesso de identidades aos seus recursos dentro da sua conta AWS.

### [Usu√°rio root da conta AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Quando voc√™ cria uma conta Amazon Web Services (AWS) pela primeira vez, voc√™ come√ßa com uma identidade de login √∫nica que tem **acesso completo a todos** os servi√ßos e recursos da AWS na conta. Este √© o _**usu√°rio root da conta AWS**_ e √© acessado fazendo login com o **endere√ßo de e-mail e senha que voc√™ usou para criar a conta**.

Note que um novo **usu√°rio admin** ter√° **menos permiss√µes que o usu√°rio root**.

Do ponto de vista de seguran√ßa, √© recomendado criar outros usu√°rios e evitar usar este.

### [Usu√°rios IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

Um _usu√°rio_ IAM √© uma entidade que voc√™ cria na AWS para **representar a pessoa ou aplica√ß√£o** que a utiliza para **interagir com a AWS**. Um usu√°rio na AWS consiste em um nome e credenciais (senha e at√© duas chaves de acesso).

Quando voc√™ cria um usu√°rio IAM, voc√™ concede **permiss√µes** tornando-o um **membro de um grupo de usu√°rios** que tem pol√≠ticas de permiss√£o apropriadas anexadas (recomendado), ou **anexando diretamente pol√≠ticas** ao usu√°rio.

Usu√°rios podem ter **MFA habilitado para login** atrav√©s do console. Tokens de API de usu√°rios com MFA habilitado n√£o s√£o protegidos por MFA. Se voc√™ quiser **restringir o acesso das chaves de API de um usu√°rio usando MFA**, voc√™ precisa indicar na pol√≠tica que, para realizar certas a√ß√µes, o MFA precisa estar presente (exemplo [**aqui**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)).

#### CLI

* **Access Key ID**: 20 caracteres alfanum√©ricos mai√∫sculos aleat√≥rios como AKHDNAPO86BSHKDIRYT
* **Secret access key ID**: 40 caracteres aleat√≥rios mai√∫sculos e min√∫sculos: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (N√£o √© poss√≠vel recuperar IDs de chaves de acesso secretas perdidas).

Sempre que voc√™ precisar **alterar a Chave de Acesso**, este √© o processo que voc√™ deve seguir:\
_Criar uma nova chave de acesso -> Aplicar a nova chave ao sistema/aplica√ß√£o -> marcar a original como inativa -> Testar e verificar se a nova chave de acesso est√° funcionando -> Excluir a chave de acesso antiga_

### MFA - Autentica√ß√£o Multi Fator

√â usado para **criar um fator adicional para autentica√ß√£o** al√©m dos seus m√©todos existentes, como senha, criando assim um n√≠vel de autentica√ß√£o multifatorial.\
Voc√™ pode usar um **aplicativo virtual gratuito ou um dispositivo f√≠sico**. Voc√™ pode usar aplicativos como o google authentication gratuitamente para ativar um MFA na AWS.

Pol√≠ticas com condi√ß√µes de MFA podem ser anexadas aos seguintes:

* Um usu√°rio ou grupo IAM
* Um recurso como um bucket Amazon S3, fila Amazon SQS ou t√≥pico Amazon SNS
* A pol√≠tica de confian√ßa de uma fun√ß√£o IAM que pode ser assumida por um usu√°rio

Se voc√™ quiser **acessar via CLI** um recurso que **verifica o MFA**, voc√™ precisa chamar **`GetSessionToken`**. Isso lhe dar√° um token com informa√ß√µes sobre o MFA.\
Note que **credenciais `AssumeRole` n√£o cont√™m essa informa√ß√£o**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
Como [**afirmado aqui**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), h√° muitos casos diferentes onde **MFA n√£o pode ser usado**.

### [Grupos de usu√°rios IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Um [grupo de usu√°rios](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) IAM √© uma maneira de **anexar pol√≠ticas a v√°rios usu√°rios** de uma vez, o que pode facilitar a gest√£o das permiss√µes desses usu√°rios. **Pap√©is e grupos n√£o podem fazer parte de um grupo**.

Voc√™ pode anexar uma **pol√≠tica baseada em identidade a um grupo de usu√°rios** para que todos os **usu√°rios** no grupo de usu√°rios **recebam as permiss√µes da pol√≠tica**. Voc√™ **n√£o pode** identificar um **grupo de usu√°rios** como um **`Principal`** em uma **pol√≠tica** (como uma pol√≠tica baseada em recursos) porque grupos se relacionam com permiss√µes, n√£o autentica√ß√£o, e principais s√£o entidades IAM autenticadas.

Aqui est√£o algumas caracter√≠sticas importantes dos grupos de usu√°rios:

* Um **grupo** de usu√°rios pode **conter muitos usu√°rios**, e um **usu√°rio** pode **pertencer a v√°rios grupos**.
* **Grupos de usu√°rios n√£o podem ser aninhados**; eles podem conter apenas usu√°rios, n√£o outros grupos de usu√°rios.
* N√£o h√° **grupo de usu√°rios padr√£o que inclua automaticamente todos os usu√°rios na conta AWS**. Se voc√™ quiser ter um grupo de usu√°rios assim, deve cri√°-lo e atribuir cada novo usu√°rio a ele.
* O n√∫mero e o tamanho dos recursos IAM em uma conta AWS, como o n√∫mero de grupos e o n√∫mero de grupos dos quais um usu√°rio pode ser membro, s√£o limitados. Para mais informa√ß√µes, veja [Cotas do IAM e AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html).

### [Pap√©is IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Um **papel** IAM √© muito **similar** a um **usu√°rio**, pois √© uma **identidade com pol√≠ticas de permiss√£o que determinam o que** ele pode e n√£o pode fazer na AWS. No entanto, um papel **n√£o tem credenciais** (senha ou chaves de acesso) associadas a ele. Em vez de ser associado exclusivamente a uma pessoa, um papel √© destinado a ser **assumido por qualquer pessoa que precise dele (e tenha permiss√µes suficientes)**. Um **usu√°rio IAM pode assumir um papel para temporariamente** assumir diferentes permiss√µes para uma tarefa espec√≠fica. Um papel pode ser **atribu√≠do a um** [**usu√°rio federado**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html) que faz login usando um provedor de identidade externo em vez do IAM.

Um papel IAM consiste em **dois tipos de pol√≠ticas**: Uma **pol√≠tica de confian√ßa**, que n√£o pode estar vazia, definindo **quem pode assumir** o papel, e uma **pol√≠tica de permiss√µes**, que n√£o pode estar vazia, definindo **o que ele pode acessar**.

#### AWS Security Token Service (STS)

AWS Security Token Service (STS) √© um servi√ßo web que facilita a **emiss√£o de credenciais tempor√°rias e de privil√©gio limitado**. Ele √© especificamente adaptado para:

### [Credenciais tempor√°rias no IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Credenciais tempor√°rias s√£o usadas principalmente com pap√©is IAM**, mas tamb√©m h√° outros usos. Voc√™ pode solicitar credenciais tempor√°rias que tenham um conjunto de permiss√µes mais restrito do que seu usu√°rio IAM padr√£o. Isso **previne** que voc√™ **execute acidentalmente tarefas que n√£o s√£o permitidas** pelas credenciais mais restritas. Um benef√≠cio das credenciais tempor√°rias √© que elas expiram automaticamente ap√≥s um per√≠odo de tempo definido. Voc√™ tem controle sobre a dura√ß√£o em que as credenciais s√£o v√°lidas.

### Pol√≠ticas

#### Permiss√µes de Pol√≠tica

S√£o usadas para atribuir permiss√µes. Existem 2 tipos:

* Pol√≠ticas gerenciadas pela AWS (pr√©-configuradas pela AWS)
* Pol√≠ticas Gerenciadas pelo Cliente: Configuradas por voc√™. Voc√™ pode criar pol√≠ticas baseadas em pol√≠ticas gerenciadas pela AWS (modificando uma delas e criando a sua pr√≥pria), usando o gerador de pol√≠ticas (uma vis√£o GUI que ajuda a conceder e negar permiss√µes) ou escrevendo a sua pr√≥pria.

Por **padr√£o, o acesso** √© **negado**, o acesso ser√° concedido se uma fun√ß√£o expl√≠cita tiver sido especificada.\
Se **existir um √∫nico "Deny", ele substituir√° o "Allow"**, exceto para solicita√ß√µes que usam as credenciais de seguran√ßa raiz da conta AWS (que s√£o permitidas por padr√£o).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
Os [campos globais que podem ser usados para condi√ß√µes em qualquer servi√ßo est√£o documentados aqui](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount).\
Os [campos espec√≠ficos que podem ser usados para condi√ß√µes por servi√ßo est√£o documentados aqui](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html).

#### Inline Policies

Este tipo de pol√≠ticas s√£o **atribu√≠das diretamente** a um usu√°rio, grupo ou fun√ß√£o. Ent√£o, elas n√£o aparecem na lista de Policies como qualquer outra que pode ser usada.\
Inline policies s√£o √∫teis se voc√™ quiser **manter uma rela√ß√£o estrita de um-para-um entre uma policy e a identidade** √† qual ela √© aplicada. Por exemplo, voc√™ quer ter certeza de que as permiss√µes em uma policy n√£o s√£o inadvertidamente atribu√≠das a uma identidade diferente daquela para a qual foram destinadas. Quando voc√™ usa uma inline policy, as permiss√µes na policy n√£o podem ser inadvertidamente atribu√≠das √† identidade errada. Al√©m disso, quando voc√™ usa o AWS Management Console para excluir essa identidade, as policies incorporadas na identidade tamb√©m s√£o exclu√≠das. Isso porque elas fazem parte da entidade principal.

#### Resource Bucket Policies

Estas s√£o **policies** que podem ser definidas em **recursos**. **Nem todos os recursos da AWS as suportam**.

Se um principal n√£o tiver uma nega√ß√£o expl√≠cita sobre eles, e uma resource policy lhes conceder acesso, ent√£o eles s√£o permitidos.

### IAM Boundaries

IAM boundaries podem ser usadas para **limitar as permiss√µes que um usu√°rio ou fun√ß√£o deve ter acesso**. Desta forma, mesmo que um conjunto diferente de permiss√µes seja concedido ao usu√°rio por uma **policy diferente**, a opera√ß√£o **falhar√°** se ele tentar us√°-las.

Uma boundary √© apenas uma policy anexada a um usu√°rio que **indica o n√≠vel m√°ximo de permiss√µes que o usu√°rio ou fun√ß√£o pode ter**. Ent√£o, **mesmo que o usu√°rio tenha acesso de Administrador**, se a boundary indicar que ele s√≥ pode ler buckets S3, isso √© o m√°ximo que ele pode fazer.

**Isso**, **SCPs** e **seguir o princ√≠pio do menor privil√©gio** s√£o as maneiras de controlar que os usu√°rios n√£o tenham mais permiss√µes do que as necess√°rias.

### Session Policies

Uma session policy √© uma **policy definida quando uma fun√ß√£o √© assumida** de alguma forma. Isso ser√° como uma **IAM boundary para essa sess√£o**: Isso significa que a session policy n√£o concede permiss√µes, mas **as restringe √†s indicadas na policy** (sendo as permiss√µes m√°ximas aquelas que a fun√ß√£o possui).

Isso √© √∫til para **medidas de seguran√ßa**: Quando um administrador vai assumir uma fun√ß√£o muito privilegiada, ele pode restringir a permiss√£o apenas √†s indicadas na session policy caso a sess√£o seja comprometida.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Note que por padr√£o **AWS pode adicionar pol√≠ticas de sess√£o √†s sess√µes** que ser√£o geradas por terceiros motivos. Por exemplo, em [fun√ß√µes assumidas n√£o autenticadas do cognito](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) por padr√£o (usando autentica√ß√£o aprimorada), a AWS gerar√° **credenciais de sess√£o com uma pol√≠tica de sess√£o** que limita os servi√ßos que a sess√£o pode acessar [**√† seguinte lista**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Portanto, se em algum momento voc√™ enfrentar o erro "... porque nenhuma pol√≠tica de sess√£o permite ...", e a fun√ß√£o tem acesso para realizar a a√ß√£o, √© porque **h√° uma pol√≠tica de sess√£o impedindo isso**.

### Federa√ß√£o de Identidade

A federa√ß√£o de identidade **permite que usu√°rios de provedores de identidade que s√£o externos** √† AWS acessem recursos da AWS de forma segura sem precisar fornecer credenciais de usu√°rio da AWS de uma conta de usu√°rio IAM v√°lida.\
Um exemplo de um provedor de identidade pode ser seu pr√≥prio **Microsoft Active Directory** corporativo (via **SAML**) ou servi√ßos **OpenID** (como **Google**). O acesso federado permitir√° ent√£o que os usu√°rios dentro dele acessem a AWS.

Para configurar essa confian√ßa, um **Provedor de Identidade IAM √© gerado (SAML ou OAuth)** que **confiar√°** na **outra plataforma**. Ent√£o, pelo menos uma **fun√ß√£o IAM √© atribu√≠da (confiando) ao Provedor de Identidade**. Se um usu√°rio da plataforma confi√°vel acessar a AWS, ele estar√° acessando como a fun√ß√£o mencionada.

No entanto, voc√™ geralmente desejar√° dar uma **fun√ß√£o diferente dependendo do grupo do usu√°rio** na plataforma de terceiros. Ent√£o, v√°rias **fun√ß√µes IAM podem confiar** no Provedor de Identidade de terceiros e a plataforma de terceiros ser√° a respons√°vel por permitir que os usu√°rios assumam uma fun√ß√£o ou outra.

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### IAM Identity Center

O AWS IAM Identity Center (sucessor do AWS Single Sign-On) expande as capacidades do AWS Identity and Access Management (IAM) para fornecer um **local central** que re√∫ne **administra√ß√£o de usu√°rios e seu acesso a contas AWS** e aplicativos em nuvem.

O dom√≠nio de login ser√° algo como `<user_input>.awsapps.com`.

Para fazer login dos usu√°rios, existem 3 fontes de identidade que podem ser usadas:

* Identity Center Directory: Usu√°rios regulares da AWS
* Active Directory: Suporta diferentes conectores
* Provedor de Identidade Externo: Todos os usu√°rios e grupos v√™m de um Provedor de Identidade Externo (IdP)

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

No caso mais simples do diret√≥rio do Identity Center, o **Identity Center ter√° uma lista de usu√°rios e grupos** e poder√° **atribuir pol√≠ticas** a eles para **qualquer uma das contas** da organiza√ß√£o.

Para dar acesso a um usu√°rio/grupo do Identity Center a uma conta, um **Provedor de Identidade SAML confiando no Identity Center ser√° criado**, e uma **fun√ß√£o confiando no Provedor de Identidade com as pol√≠ticas indicadas ser√° criada** na conta de destino.

#### AwsSSOInlinePolicy

√â poss√≠vel **dar permiss√µes via pol√≠ticas inline para fun√ß√µes criadas via IAM Identity Center**. As fun√ß√µes criadas nas contas que est√£o recebendo **pol√≠ticas inline no AWS Identity Center** ter√£o essas permiss√µes em uma pol√≠tica inline chamada **`AwsSSOInlinePolicy`**.

Portanto, mesmo que voc√™ veja 2 fun√ß√µes com uma pol√≠tica inline chamada **`AwsSSOInlinePolicy`**, isso **n√£o significa que elas t√™m as mesmas permiss√µes**.

### Confian√ßas e Fun√ß√µes Entre Contas

**Um usu√°rio** (confiando) pode criar uma Fun√ß√£o Entre Contas com algumas pol√≠ticas e ent√£o, **permitir que outro usu√°rio** (confi√°vel) **acesse sua conta** mas apenas **tendo o acesso indicado nas novas pol√≠ticas de fun√ß√£o**. Para criar isso, basta criar uma nova Fun√ß√£o e selecionar Fun√ß√£o Entre Contas. Fun√ß√µes para Acesso Entre Contas oferecem duas op√ß√µes. Fornecer acesso entre contas AWS que voc√™ possui, e fornecer acesso entre uma conta que voc√™ possui e uma conta AWS de terceiros.\
√â recomendado **especificar o usu√°rio que √© confi√°vel e n√£o colocar algo gen√©rico** porque, se n√£o, outros usu√°rios autenticados, como usu√°rios federados, tamb√©m poder√£o abusar dessa confian√ßa.

### AWS Simple AD

N√£o suportado:

* Rela√ß√µes de Confian√ßa
* Centro de Administra√ß√£o AD
* Suporte completo √† API PS
* Lixeira AD
* Contas de Servi√ßo Gerenciadas por Grupo
* Extens√µes de Esquema
* Sem acesso direto ao SO ou Inst√¢ncias

#### Federa√ß√£o Web ou Autentica√ß√£o OpenID

O aplicativo usa o AssumeRoleWithWebIdentity para criar credenciais tempor√°rias. No entanto, isso n√£o concede acesso ao console da AWS, apenas acesso a recursos dentro da AWS.

### Outras op√ß√µes de IAM

* Voc√™ pode **definir uma pol√≠tica de senha configurando** op√ß√µes como comprimento m√≠nimo e requisitos de senha.
* Voc√™ pode **baixar o "Relat√≥rio de Credenciais"** com informa√ß√µes sobre as credenciais atuais (como tempo de cria√ß√£o do usu√°rio, se a senha est√° habilitada...). Voc√™ pode gerar um relat√≥rio de credenciais com a frequ√™ncia de uma vez a cada **quatro horas**.

O AWS Identity and Access Management (IAM) fornece **controle de acesso granular** em toda a AWS. Com o IAM, voc√™ pode especificar **quem pode acessar quais servi√ßos e recursos**, e sob quais condi√ß√µes. Com pol√≠ticas do IAM, voc√™ gerencia permiss√µes para sua for√ßa de trabalho e sistemas para **garantir permiss√µes de menor privil√©gio**.

### Prefixos de ID do IAM

Nesta [**p√°gina**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) voc√™ pode encontrar os **prefixos de ID do IAM** das chaves dependendo de sua natureza:

| ABIA | [Token portador do servi√ßo AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Credencial espec√≠fica do contexto                                                                                                                                                                                     |
| AGPA | Grupo de usu√°rios                                                                                                                                                                                                     |
| AIDA | Usu√°rio IAM                                                                                                                                                                                                           |
| AIPA | Perfil de inst√¢ncia do Amazon EC2                                                                                                                                                                                     |
| AKIA | Chave de acesso                                                                                                                                                                                                       |
| ANPA | Pol√≠tica gerenciada                                                                                                                                                                                                   |
| ANVA | Vers√£o em uma pol√≠tica gerenciada                                                                                                                                                                                     |
| APKA | Chave p√∫blica                                                                                                                                                                                                         |
| AROA | Fun√ß√£o                                                                                                                                                                                                                |
| ASCA | Certificado                                                                                                                                                                                                           |
| ASIA | [IDs de chave de acesso tempor√°rio (AWS STS)](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) usam este prefixo, mas s√£o √∫nicos apenas em combina√ß√£o com a chave de acesso secreta e o token de sess√£o. |

### Permiss√µes recomendadas para auditar contas

Os seguintes privil√©gios concedem v√°rios acessos de leitura de metadados:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Diversos

### Autentica√ß√£o CLI

Para que um usu√°rio regular se autentique na AWS via CLI, voc√™ precisa ter **credenciais locais**. Por padr√£o, voc√™ pode configur√°-las **manualmente** em `~/.aws/credentials` ou **executando** `aws configure`.\
Nesse arquivo, voc√™ pode ter mais de um perfil, se **nenhum perfil** for especificado usando o **aws cli**, o chamado **`[default]`** nesse arquivo ser√° usado.\
Exemplo de arquivo de credenciais com mais de 1 perfil:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Se voc√™ precisar acessar **diferentes contas AWS** e seu perfil tiver acesso para **assumir um papel dentro dessas contas**, voc√™ n√£o precisa chamar manualmente o STS toda vez (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) e configurar as credenciais.

Voc√™ pode usar o arquivo `~/.aws/config` para [**indicar quais pap√©is assumir**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), e ent√£o usar o par√¢metro `--profile` como de costume (o `assume-role` ser√° realizado de forma transparente para o usu√°rio).\
Um exemplo de arquivo de configura√ß√£o:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Com este arquivo de configura√ß√£o, voc√™ pode ent√£o usar aws cli assim:
```
aws --profile acc2 ...
```
Se voc√™ est√° procurando algo **similar** a isso, mas para o **navegador**, voc√™ pode conferir a **extens√£o** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## Refer√™ncias

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte o HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
