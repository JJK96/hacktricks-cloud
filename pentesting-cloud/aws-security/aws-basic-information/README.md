# AWS - Taarifa za Msingi

{% hint style="success" %}
Jifunze na fanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na fanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Mpangilio wa Shirika

![](<../../../.gitbook/assets/image (151).png>)

### Akaunti

Katika AWS kuna **akaunti ya mzizi,** ambayo ni **konteina mzazi kwa akaunti zote** za **shirika** lako. Hata hivyo, huhitaji kutumia akaunti hiyo kupeleka rasilimali, unaweza kuunda **akaunti nyingine kutenganisha miundombinu tofauti ya AWS** kati yao.

Hii ni ya kuvutia sana kutoka kwa mtazamo wa **usalama,** kwani **akaunti moja haitakuwa na uwezo wa kufikia rasilimali kutoka akaunti nyingine** (isipokuwa madaraja yameundwa mahsusi), kwa hivyo kwa njia hii unaweza kuunda mipaka kati ya upelekaji.

Kwa hivyo, kuna **aina mbili za akaunti katika shirika** (tunazungumzia akaunti za AWS na sio akaunti za Mtumiaji): akaunti moja ambayo imeteuliwa kama akaunti ya usimamizi, na moja au zaidi ya akaunti za wanachama.

*   **Akaunti ya usimamizi (akaunti ya mzizi)** ni akaunti unayotumia kuunda shirika. Kutoka kwa akaunti ya usimamizi ya shirika, unaweza kufanya yafuatayo:

* Unda akaunti katika shirika
* Alika akaunti zingine zilizopo kwenye shirika
* Ondoa akaunti kutoka kwa shirika
* Dhibiti mialiko
* Tumia sera kwa vyombo (mizizi, OUs, au akaunti) ndani ya shirika
* Wezesha ujumuishaji na huduma za AWS zinazoungwa mkono ili kutoa utendaji wa huduma katika akaunti zote za shirika.
* Inawezekana kuingia kama mtumiaji wa mzizi kwa kutumia barua pepe na nenosiri lililotumika kuunda akaunti/ shirika hili la mzizi.

Akaunti ya usimamizi ina **majukumu ya akaunti ya malipo** na inawajibika kulipa gharama zote zinazokusanywa na akaunti za wanachama. Huwezi kubadilisha akaunti ya usimamizi ya shirika.
* **Akaunti za wanachama** zinaunda akaunti zote zilizobaki katika shirika. Akaunti inaweza kuwa mwanachama wa shirika moja tu kwa wakati mmoja. Unaweza kuambatisha sera kwa akaunti ili kutumia udhibiti kwa akaunti hiyo moja tu.
* Akaunti za wanachama **lazima zitumie anwani halali ya barua pepe** na zinaweza kuwa na **jina,** kwa ujumla hazitaweza kudhibiti bili (lakini zinaweza kupewa ufikiaji wa hiyo).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Organization Units**

Akaunti zinaweza kuunganishwa katika **Organization Units (OU)**. Kwa njia hii, unaweza kuunda **sera** kwa ajili ya Organization Unit ambazo zitatumika kwa **akaunti zote za watoto**. Kumbuka kuwa OU inaweza kuwa na OUs nyingine kama watoto.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Service Control Policy (SCP)

**Service control policy (SCP)** ni sera inayobainisha huduma na vitendo ambavyo watumiaji na majukumu wanaweza kutumia katika akaunti ambazo SCP inaathiri. SCPs ni **sawa na sera za ruhusa za IAM** isipokuwa kwamba **hazitoi ruhusa yoyote**. Badala yake, SCPs zinaainisha **ruhusa za juu zaidi** kwa shirika, kitengo cha shirika (OU), au akaunti. Unapounganisha SCP kwenye mzizi wa shirika lako au OU, **SCP inapunguza ruhusa kwa vyombo katika akaunti za wanachama**.

Hii ndiyo NJIA PEKEE ambayo **hata mtumiaji wa mzizi anaweza kuzuiwa** kufanya kitu. Kwa mfano, inaweza kutumika kuzuia watumiaji kuzima CloudTrail au kufuta nakala za chelezo.\
Njia pekee ya kuipita hii ni kuathiri pia **akaunti kuu** inayosanidi SCPs (akaunti kuu haiwezi kuzuiwa).

{% hint style="warning" %}
Kumbuka kwamba **SCPs zinazuia tu wakuu katika akaunti**, kwa hivyo akaunti zingine haziathiriki. Hii inamaanisha kuwa na SCP inayokataa `s3:GetObject` haitazuia watu **kupata ndoo ya S3 ya umma** katika akaunti yako.
{% endhint %}

Mifano ya SCP:

* Kukataa akaunti ya mzizi kabisa
* Kuruhusu tu maeneo maalum
* Kuruhusu tu huduma zilizoorodheshwa
* Kukataa GuardDuty, CloudTrail, na S3 Public Block Access kutoka

kuzimwa
* Kukataa majukumu ya usalama/majibu ya tukio kutoka kufutwa au

kubadilishwa.
* Kukataa nakala za chelezo kutoka kufutwa.
* Kukataa kuunda watumiaji wa IAM na funguo za ufikiaji

Pata **mifano ya JSON** katika [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)

### ARN

**Amazon Resource Name** ni **jina la kipekee** ambalo kila rasilimali ndani ya AWS inayo, linaundwa kama ifuatavyo:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Note kwamba kuna partitions 4 katika AWS lakini kuna njia 3 tu za kuziita:

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US public Internet (GovCloud): `aws-us-gov`
* AWS Secret (US Classified): `aws`

## IAM - Identity and Access Management

IAM ni huduma ambayo itakuruhusu kusimamia **Authentication**, **Authorization** na **Access Control** ndani ya akaunti yako ya AWS.

* **Authentication** - Mchakato wa kufafanua utambulisho na uthibitisho wa utambulisho huo. Mchakato huu unaweza kugawanywa katika: Utambulisho na uthibitisho.
* **Authorization** - Inaamua kile utambulisho unaweza kufikia ndani ya mfumo mara tu utakapothibitishwa.
* **Access Control** - Njia na mchakato wa jinsi upatikanaji unavyotolewa kwa rasilimali salama.

IAM inaweza kufafanuliwa kwa uwezo wake wa kusimamia, kudhibiti na kuongoza mifumo ya uthibitisho, idhini na udhibiti wa upatikanaji wa utambulisho kwa rasilimali zako ndani ya akaunti yako ya AWS.

### [AWS account root user](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Unapounda akaunti ya Amazon Web Services (AWS) kwa mara ya kwanza, unaanza na utambulisho wa kuingia mmoja ambao una **upatikanaji kamili wa huduma zote** za AWS na rasilimali katika akaunti. Huyu ni _**root user**_ wa akaunti ya AWS na anafikiwa kwa kuingia na **anwani ya barua pepe na nenosiri ulilotumia kuunda akaunti**.

Kumbuka kwamba mtumiaji mpya wa **admin** atakuwa na **ruhusa chache kuliko root user**.

Kutoka kwa mtazamo wa usalama, inashauriwa kuunda watumiaji wengine na kuepuka kutumia huyu.

### [IAM users](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

Mtumiaji wa IAM ni chombo unachounda katika AWS ili **kumwakilisha mtu au programu** inayotumia kuingiliana na AWS. Mtumiaji katika AWS anajumuisha jina na sifa (nenosiri na hadi funguo mbili za upatikanaji).

Unapounda mtumiaji wa IAM, unampa **ruhusa** kwa kumfanya kuwa **mwanachama wa kikundi cha watumiaji** ambacho kina sera za ruhusa zinazofaa zilizoambatanishwa (inapendekezwa), au kwa **kuambatanisha sera moja kwa moja** kwa mtumiaji.

Watumiaji wanaweza kuwa na **MFA imewezeshwa kuingia** kupitia console. Tokeni za API za watumiaji walio na MFA hazilindwi na MFA. Ikiwa unataka **kuzuia upatikanaji wa funguo za API za watumiaji kwa kutumia MFA** unahitaji kuonyesha katika sera kwamba ili kutekeleza vitendo fulani MFA inahitaji kuwepo (mfano [**hapa**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)).

#### CLI

* **Access Key ID**: Herufi 20 za nasibu za alphanumeric kubwa kama AKHDNAPO86BSHKDIRYT
* **Secret access key ID**: Herufi 40 za nasibu kubwa na ndogo: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (Haiwezekani kurejesha vitambulisho vya siri vilivyopotea).

Wakati wowote unahitaji **kubadilisha Access Key** huu ndio mchakato unaopaswa kufuata:\
_Unde Access Key mpya -> Tumia ufunguo mpya kwa mfumo/programu -> weka alama ya asili kama isiyotumika -> Jaribu na hakikisha ufunguo mpya unafanya kazi -> Futa ufunguo wa zamani_

### MFA - Multi Factor Authentication

Inatumika **kuunda kipengele cha ziada cha uthibitisho** pamoja na njia zako zilizopo, kama nenosiri, hivyo, kuunda kiwango cha uthibitisho wa vipengele vingi.\
Unaweza kutumia **programu ya bure ya virtual au kifaa cha kimwili**. Unaweza kutumia programu kama google authentication bure kuamsha MFA katika AWS.

Sera zilizo na masharti ya MFA zinaweza kuambatanishwa na yafuatayo:

* Mtumiaji wa IAM au kikundi
* Rasilimali kama vile ndoo ya Amazon S3, foleni ya Amazon SQS, au mada ya Amazon SNS
* Sera ya uaminifu ya jukumu la IAM ambalo linaweza kudhaniwa na mtumiaji

Ikiwa unataka **kupata kupitia CLI** rasilimali ambayo **inaangalia MFA** unahitaji kuita **`GetSessionToken`**. Hiyo itakupa tokeni yenye taarifa kuhusu MFA.\
Kumbuka kwamba **`AssumeRole` vitambulisho havina taarifa hii**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
Kama ilivyoelezwa [**hapa**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), kuna kesi nyingi tofauti ambapo **MFA haiwezi kutumika**.

### [Vikundi vya watumiaji wa IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Kikundi cha [watumiaji wa IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) ni njia ya **kuambatisha sera kwa watumiaji wengi** kwa wakati mmoja, ambayo inaweza kurahisisha usimamizi wa ruhusa kwa watumiaji hao. **Majukumu na vikundi haviwezi kuwa sehemu ya kikundi**.

Unaweza kuambatisha **sera inayotegemea utambulisho kwa kikundi cha watumiaji** ili watumiaji wote katika kikundi cha watumiaji **wapokee ruhusa za sera hiyo**. Huwezi kutambua **kikundi cha watumiaji** kama **`Principal`** katika **sera** (kama sera inayotegemea rasilimali) kwa sababu vikundi vinahusiana na ruhusa, sio uthibitisho, na principals ni vyombo vya IAM vilivyothibitishwa.

Hapa kuna sifa muhimu za vikundi vya watumiaji:

* Kikundi cha **watumiaji** kinaweza **kuwa na watumiaji wengi**, na **mtumiaji** anaweza **kuwemo katika vikundi vingi**.
* **Vikundi vya watumiaji haviwezi kuingiliana**; vinaweza kuwa na watumiaji tu, sio vikundi vingine vya watumiaji.
* Hakuna **kikundi cha watumiaji cha chaguo-msingi kinachojumuisha watumiaji wote katika akaunti ya AWS**. Ikiwa unataka kuwa na kikundi cha watumiaji kama hicho, lazima ukitengeze na kuwapa watumiaji wapya kila mmoja.
* Idadi na ukubwa wa rasilimali za IAM katika akaunti ya AWS, kama idadi ya vikundi, na idadi ya vikundi ambavyo mtumiaji anaweza kuwa mwanachama wake, ni vikwazo. Kwa maelezo zaidi, angalia [Vikomo vya IAM na AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html).

### [Majukumu ya IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Jukumu la IAM **linashabihiana sana** na **mtumiaji**, kwa kuwa ni **utambulisho wenye sera za ruhusa zinazobainisha nini** linaweza na haliwezi kufanya katika AWS. Hata hivyo, jukumu **halina hati za uthibitisho** (nenosiri au funguo za ufikiaji) zinazohusishwa nalo. Badala ya kuhusishwa kipekee na mtu mmoja, jukumu linakusudiwa kuwa **linachukuliwa na yeyote anayelihitaji (na kuwa na ruhusa za kutosha)**. **Mtumiaji wa IAM anaweza kuchukua jukumu kwa muda** ili kuchukua ruhusa tofauti kwa kazi maalum. Jukumu linaweza **kupewa** [**mtumiaji aliyeunganishwa**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html) ambaye anaingia kwa kutumia mtoa utambulisho wa nje badala ya IAM.

Jukumu la IAM linajumuisha **aina mbili za sera**: **Sera ya uaminifu**, ambayo haiwezi kuwa tupu, inabainisha **nani anaweza kuchukua** jukumu, na **sera ya ruhusa**, ambayo haiwezi kuwa tupu, inabainisha **nini inaweza kufikia**.

#### Huduma ya Ishara ya Usalama ya AWS (STS)

Huduma ya Ishara ya Usalama ya AWS (STS) ni huduma ya wavuti inayowezesha **kutolewa kwa hati za muda, zenye ruhusa ndogo**. Imeundwa mahsusi kwa ajili ya:

### [Hati za muda katika IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Hati za muda zinatumika hasa na majukumu ya IAM**, lakini pia kuna matumizi mengine. Unaweza kuomba hati za muda ambazo zina seti ndogo ya ruhusa kuliko mtumiaji wako wa kawaida wa IAM. Hii **inakuzuia** **kutekeleza kazi ambazo haziruhusiwi** na hati za muda zilizo na ruhusa ndogo. Faida ya hati za muda ni kwamba zinakwisha muda wake kiotomatiki baada ya kipindi fulani. Una udhibiti juu ya muda ambao hati hizo ni halali.

### Sera

#### Ruhusa za Sera

Zinatumika kupeana ruhusa. Kuna aina 2:

* Sera zinazosimamiwa na AWS (zilizosanidiwa awali na AWS)
* Sera Zinazosimamiwa na Mteja: Zinasanidiwa na wewe. Unaweza kuunda sera kulingana na sera zinazosimamiwa na AWS (kubadilisha moja yao na kuunda yako mwenyewe), kutumia jenereta ya sera (mwonekano wa GUI unaokusaidia kutoa na kukataa ruhusa) au kuandika yako mwenyewe.

Kwa **ruhusa za ufikiaji wa chaguo-msingi** **zinakataliwa**, ufikiaji utapewa ikiwa jukumu maalum limebainishwa.\
Ikiwa **"Deny" moja ipo, itapuuza "Allow"**, isipokuwa kwa maombi yanayotumia hati za usalama za mizizi za akaunti ya AWS (ambazo zinaruhusiwa kwa chaguo-msingi).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
[Sehemu za kimataifa ambazo zinaweza kutumika kwa masharti katika huduma yoyote zimeandikwa hapa](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount).\
[Sehemu maalum ambazo zinaweza kutumika kwa masharti kwa kila huduma zimeandikwa hapa](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html).

#### Inline Policies

Aina hii ya sera **inawekwa moja kwa moja** kwa mtumiaji, kundi au jukumu. Kisha, hazionekani kwenye orodha ya Sera kama nyingine yoyote inaweza kuzitumia.\
Inline policies ni muhimu ikiwa unataka **kudumisha uhusiano wa moja kwa moja kati ya sera na utambulisho** ambao inatumika kwake. Kwa mfano, unataka kuwa na uhakika kwamba ruhusa katika sera hazijatolewa kwa utambulisho mwingine tofauti na ule uliokusudiwa. Unapotumia inline policy, ruhusa katika sera haziwezi kuambatanishwa kwa bahati mbaya na utambulisho usio sahihi. Aidha, unapotumia AWS Management Console kufuta utambulisho huo, sera zilizowekwa ndani ya utambulisho huo pia zinafutwa. Hii ni kwa sababu ni sehemu ya chombo kikuu.

#### Resource Bucket Policies

Hizi ni **sera** ambazo zinaweza kufafanuliwa katika **rasilimali**. **Sio rasilimali zote za AWS zinazounga mkono**.

Ikiwa mkuu hana katazo la wazi juu yao, na sera ya rasilimali inawapa ufikiaji, basi wanaruhusiwa.

### IAM Boundaries

IAM boundaries zinaweza kutumika **kuzuia ruhusa ambazo mtumiaji au jukumu linapaswa kuwa na ufikiaji**. Kwa njia hii, hata kama seti tofauti ya ruhusa imetolewa kwa mtumiaji na **sera tofauti** operesheni itashindwa ikiwa atajaribu kuzitumia.

Boundary ni sera tu iliyowekwa kwa mtumiaji ambayo **inaonyesha kiwango cha juu cha ruhusa ambazo mtumiaji au jukumu linaweza kuwa nazo**. Kwa hivyo, **hata kama mtumiaji ana ufikiaji wa Msimamizi**, ikiwa boundary inaonyesha anaweza tu kusoma S¬∑ buckets, hicho ndicho kiwango cha juu anachoweza kufanya.

**Hii**, **SCPs** na **kufuata kanuni ya ruhusa ndogo zaidi** ni njia za kudhibiti kwamba watumiaji hawana ruhusa zaidi ya zile wanazohitaji.

### Session Policies

Session policy ni **sera iliyowekwa wakati jukumu linachukuliwa** kwa namna fulani. Hii itakuwa kama **IAM boundary kwa kikao hicho**: Hii inamaanisha kwamba session policy haitoi ruhusa lakini **inazizuia kwa zile zilizoonyeshwa katika sera** (ikiwa ruhusa za juu zaidi ni zile ambazo jukumu lina).

Hii ni muhimu kwa **hatua za usalama**: Wakati msimamizi anachukua jukumu lenye ruhusa nyingi anaweza kuzuia ruhusa kwa zile zilizoonyeshwa katika session policy iwapo kikao kitavunjwa.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Note kwamba kwa chaguo-msingi **AWS inaweza kuongeza sera za kikao kwenye vikao** ambavyo vitazalishwa kwa sababu za tatu. Kwa mfano, katika [nafasi za kujitwalia za cognito zisizo na uthibitisho](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) kwa chaguo-msingi (kutumia uthibitisho ulioboreshwa), AWS itazalisha **vitambulisho vya kikao na sera ya kikao** inayopunguza huduma ambazo kikao kinaweza kufikia [**kwa orodha ifuatayo**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Kwa hivyo, ikiwa wakati fulani utakutana na kosa "... kwa sababu hakuna sera ya kikao inayoruhusu ...", na nafasi ina ufikiaji wa kutekeleza kitendo, ni kwa sababu **kuna sera ya kikao inayozuia**.

### Shirikisho la Utambulisho

Shirikisho la utambulisho **linaruhusu watumiaji kutoka kwa watoa utambulisho ambao ni wa nje** kwa AWS kufikia rasilimali za AWS kwa usalama bila kulazimika kutoa vitambulisho vya mtumiaji wa AWS kutoka akaunti halali ya mtumiaji wa IAM.\
Mfano wa mtoa utambulisho unaweza kuwa **Microsoft Active Directory** ya kampuni yako (kupitia **SAML**) au huduma za **OpenID** (kama **Google**). Ufikiaji wa shirikisho basi utaruhusu watumiaji ndani yake kufikia AWS.

Ili kusanidi uaminifu huu, **Mtoa Utambulisho wa IAM huzalishwa (SAML au OAuth)** ambao uta**amini** **jukwaa lingine**. Kisha, angalau **nafasi moja ya IAM inatolewa (inayoamini) kwa Mtoa Utambulisho**. Ikiwa mtumiaji kutoka jukwaa linaloaminika atafikia AWS, atakuwa akifikia kama nafasi iliyotajwa.

Hata hivyo, kwa kawaida utataka kutoa **nafasi tofauti kulingana na kundi la mtumiaji** katika jukwaa la tatu. Kisha, **nafasi kadhaa za IAM zinaweza kuamini** Mtoa Utambulisho wa jukwaa la tatu na jukwaa la tatu litakuwa linaruhusu watumiaji kuchukua nafasi moja au nyingine.

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### Kituo cha Utambulisho cha IAM

AWS IAM Identity Center (mrithi wa AWS Single Sign-On) inapanua uwezo wa Usimamizi wa Utambulisho na Ufikiaji wa AWS (IAM) kutoa **mahali pa kati** kinachounganisha **usimamizi wa watumiaji na ufikiaji wao kwa akaunti za AWS** na programu za wingu.

Kikoa cha kuingia kitakuwa kitu kama `<user_input>.awsapps.com`.

Ili kuingia watumiaji, kuna vyanzo 3 vya utambulisho vinavyoweza kutumika:

* Saraka ya Kituo cha Utambulisho: Watumiaji wa kawaida wa AWS
* Active Directory: Inasaidia kiunganishi tofauti
* Mtoa Utambulisho wa Nje: Watumiaji na vikundi vyote vinatoka kwa Mtoa Utambulisho wa nje (IdP)

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

Katika kesi rahisi ya saraka ya Kituo cha Utambulisho, **Kituo cha Utambulisho kitakuwa na orodha ya watumiaji na vikundi** na kitaweza **kutoa sera** kwao kwa **akaunti yoyote** ya shirika.

Ili kutoa ufikiaji kwa mtumiaji/kundi la Kituo cha Utambulisho kwa akaunti, **Mtoa Utambulisho wa SAML anayeamini Kituo cha Utambulisho ataundwa**, na **nafasi inayoamini Mtoa Utambulisho na sera zilizowekwa itaundwa** katika akaunti lengwa.

#### AwsSSOInlinePolicy

Inawezekana **kutoa ruhusa kupitia sera za ndani kwa nafasi zilizoundwa kupitia Kituo cha Utambulisho cha IAM**. Nafasi zilizoundwa katika akaunti zinazopatiwa **sera za ndani katika Kituo cha Utambulisho cha AWS** zitakuwa na ruhusa hizi katika sera ya ndani inayoitwa **`AwsSSOInlinePolicy`**.

Kwa hivyo, hata kama utaona nafasi 2 zenye sera ya ndani inayoitwa **`AwsSSOInlinePolicy`**, **haimaanishi ina ruhusa sawa**.

### Uaminifu na Nafasi za Akaunti za Msalaba

**Mtumiaji** (anayeamini) anaweza kuunda Nafasi ya Akaunti ya Msalaba na sera fulani na kisha, **kuruhusu mtumiaji mwingine** (anayeaminika) **kufikia akaunti yake** lakini tu **akiwa na ufikiaji ulioonyeshwa katika sera mpya za nafasi**. Ili kuunda hii, unda tu Nafasi mpya na uchague Nafasi ya Akaunti ya Msalaba. Nafasi za Ufikiaji wa Akaunti ya Msalaba zinatoa chaguzi mbili. Kutoa ufikiaji kati ya akaunti za AWS unazomiliki, na kutoa ufikiaji kati ya akaunti unayomiliki na akaunti ya AWS ya mtu wa tatu.\
Inashauriwa **kubainisha mtumiaji anayeaminika na sio kuweka kitu cha jumla** kwa sababu ikiwa sivyo, watumiaji wengine waliothibitishwa kama watumiaji wa shirikisho wataweza pia kutumia uaminifu huu vibaya.

### AWS Simple AD

Haijaungwa mkono:

* Mahusiano ya Uaminifu
* Kituo cha Usimamizi wa AD
* Msaada kamili wa PS API
* Recycle Bin ya AD
* Akaunti za Huduma Zinazosimamiwa na Kundi
* Upanuzi wa Schema
* Hakuna Ufikiaji wa Moja kwa Moja kwa OS au Instances

#### Shirikisho la Wavuti au Uthibitisho wa OpenID

Programu inatumia AssumeRoleWithWebIdentity kuunda vitambulisho vya muda. Hata hivyo, hii haipatii ufikiaji wa dashibodi ya AWS, bali ufikiaji wa rasilimali ndani ya AWS.

### Chaguzi Nyingine za IAM

* Unaweza **kusanidi sera ya nenosiri** kwa kuweka chaguzi kama urefu wa chini na mahitaji ya nenosiri.
* Unaweza **kupakua "Ripoti ya Kitambulisho"** yenye taarifa kuhusu vitambulisho vya sasa (kama wakati wa kuundwa kwa mtumiaji, ikiwa nenosiri limewezeshwa...). Unaweza kuzalisha ripoti ya kitambulisho mara nyingi kama kila **saa nne**.

Usimamizi wa Utambulisho na Ufikiaji wa AWS (IAM) hutoa **udhibiti wa ufikiaji wa kina** katika AWS yote. Kwa IAM, unaweza kubainisha **nani anaweza kufikia huduma na rasilimali gani**, na chini ya masharti gani. Kwa sera za IAM, unasimamia ruhusa kwa wafanyakazi wako na mifumo ili **kuhakikisha ruhusa za kiwango cha chini**.

### Viambishi vya Kitambulisho cha IAM

Katika [**ukurasa huu**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) unaweza kupata **viambishi vya Kitambulisho cha IAM** vya funguo kulingana na asili yao:

| ABIA | [Tokeni ya mtoa huduma wa AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Kitambulisho maalum cha muktadha                                                                                                                                                                                       |
| AGPA | Kundi la mtumiaji                                                                                                                                                                                                      |
| AIDA | Mtumiaji wa IAM                                                                                                                                                                                                        |
| AIPA | Profaili ya instance ya Amazon EC2                                                                                                                                                                                     |
| AKIA | Kitufe cha ufikiaji                                                                                                                                                                                                    |
| ANPA | Sera inayosimamiwa                                                                                                                                                                                                     |
| ANVA | Toleo katika sera inayosimamiwa                                                                                                                                                                                         |
| APKA | Kitufe cha umma                                                                                                                                                                                                        |
| AROA | Nafasi                                                                                                                                                                                                                 |
| ASCA | Cheti                                                                                                                                                                                                                  |
| ASIA | [Vitambulisho vya ufikiaji wa muda (AWS STS)](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) hutumia kiambishi hiki, lakini ni vya kipekee tu kwa mchanganyiko na kitufe cha siri cha ufikiaji na tokeni ya kikao. |

### Ruhusa Zinazopendekezwa za Kukagua Akaunti

Ruhusa zifuatazo zinatoa ufikiaji wa kusoma wa metadata:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Mengineyo

### Uthibitisho wa CLI

Ili mtumiaji wa kawaida kuthibitisha kwa AWS kupitia CLI unahitaji kuwa na **vitambulisho vya ndani**. Kwa chaguo-msingi unaweza kuvisanidi **kwa mikono** katika `~/.aws/credentials` au kwa **kuendesha** `aws configure`.\
Katika faili hiyo unaweza kuwa na zaidi ya wasifu mmoja, ikiwa **hakuna wasifu** uliobainishwa kwa kutumia **aws cli**, ile inayoitwa **`[default]`** katika faili hiyo itatumika.\
Mfano wa faili ya vitambulisho yenye zaidi ya wasifu 1:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Ikiwa unahitaji kufikia **akaunti tofauti za AWS** na wasifu wako umepewa ruhusa ya **kuchukua jukumu ndani ya akaunti hizo**, huna haja ya kuita STS kwa mkono kila wakati (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) na kusanidi sifa.

Unaweza kutumia faili ya `~/.aws/config` [**kuonyesha majukumu ya kuchukua**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), na kisha kutumia param ya `--profile` kama kawaida (kuchukua jukumu kutafanyika kwa njia isiyoonekana kwa mtumiaji).\
Mfano wa faili ya config:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Kwa kutumia faili hii ya usanidi unaweza kisha kutumia aws cli kama:
```
aws --profile acc2 ...
```
Ikiwa unatafuta kitu **kama** hiki lakini kwa **kivinjari** unaweza kuangalia **kiendelezi** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## Marejeo

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

{% hint style="success" %}
Jifunze & fanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & fanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Saidi HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
