# AWS - Βασικές Πληροφορίες

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Δείτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Ιεραρχία Οργάνωσης

![](<../../../.gitbook/assets/image (151).png>)

### Λογαριασμοί

Στο AWS υπάρχει ένας **root λογαριασμός**, ο οποίος είναι ο **κύριος κοντέινερ για όλους τους λογαριασμούς** της **οργάνωσής** σας. Ωστόσο, δεν χρειάζεται να χρησιμοποιήσετε αυτόν τον λογαριασμό για να αναπτύξετε πόρους, μπορείτε να δημιουργήσετε **άλλους λογαριασμούς για να διαχωρίσετε διαφορετικές υποδομές AWS** μεταξύ τους.

Αυτό είναι πολύ ενδιαφέρον από την άποψη της **ασφάλειας**, καθώς **ένας λογαριασμός δεν θα μπορεί να έχει πρόσβαση σε πόρους από άλλον λογαριασμό** (εκτός αν δημιουργηθούν συγκεκριμένες γέφυρες), έτσι μπορείτε να δημιουργήσετε όρια μεταξύ των αναπτύξεων.

Επομένως, υπάρχουν **δύο τύποι λογαριασμών σε μια οργάνωση** (μιλάμε για λογαριασμούς AWS και όχι για λογαριασμούς Χρηστών): ένας μοναδικός λογαριασμός που ορίζεται ως ο διαχειριστικός λογαριασμός και ένας ή περισσότεροι λογαριασμοί μέλη.

*   Ο **διαχειριστικός λογαριασμός (ο root λογαριασμός)** είναι ο λογαριασμός που χρησιμοποιείτε για να δημιουργήσετε την οργάνωση. Από τον διαχειριστικό λογαριασμό της οργάνωσης, μπορείτε να κάνετε τα εξής:

* Δημιουργία λογαριασμών στην οργάνωση
* Πρόσκληση άλλων υπαρχόντων λογαριασμών στην οργάνωση
* Αφαίρεση λογαριασμών από την οργάνωση
* Διαχείριση προσκλήσεων
* Εφαρμογή πολιτικών σε οντότητες (roots, OUs, ή λογαριασμούς) εντός της οργάνωσης
* Ενεργοποίηση ενσωμάτωσης με υποστηριζόμενες υπηρεσίες AWS για παροχή λειτουργικότητας υπηρεσιών σε όλους τους λογαριασμούς της οργάνωσης.
* Είναι δυνατό να συνδεθείτε ως root χρήστης χρησιμοποιώντας το email και τον κωδικό πρόσβασης που χρησιμοποιήθηκαν για τη δημιουργία αυτού του root λογαριασμού/οργάνωσης.

Ο διαχειριστικός λογαριασμός έχει τις **ευθύνες ενός λογαριασμού πληρωτή** και είναι υπεύθυνος για την πληρωμή όλων των χρεώσεων που προκύπτουν από τους λογαριασμούς μέλη. Δεν μπορείτε να αλλάξετε τον διαχειριστικό λογαριασμό μιας οργάνωσης.
* **Λογαριασμοί μέλη** αποτελούν όλους τους υπόλοιπους λογαριασμούς σε μια οργάνωση. Ένας λογαριασμός μπορεί να είναι μέλος μόνο μιας οργάνωσης κάθε φορά. Μπορείτε να επισυνάψετε μια πολιτική σε έναν λογαριασμό για να εφαρμόσετε ελέγχους μόνο σε αυτόν τον λογαριασμό.
* Οι λογαριασμοί μέλη **πρέπει να χρησιμοποιούν έγκυρη διεύθυνση email** και μπορούν να έχουν ένα **όνομα**, γενικά δεν θα μπορούν να διαχειρίζονται τη χρέωση (αλλά μπορεί να τους δοθεί πρόσβαση σε αυτήν).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Organization Units**

Οι λογαριασμοί μπορούν να ομαδοποιηθούν σε **Organization Units (OU)**. Με αυτόν τον τρόπο, μπορείτε να δημιουργήσετε **πολιτικές** για το Organization Unit που θα **εφαρμοστούν σε όλους τους υπολογαριασμούς**. Σημειώστε ότι ένα OU μπορεί να έχει άλλα OUs ως υπολογαριασμούς.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Service Control Policy (SCP)

Μια **πολιτική ελέγχου υπηρεσιών (SCP)** είναι μια πολιτική που καθορίζει τις υπηρεσίες και τις ενέργειες που μπορούν να χρησιμοποιούν οι χρήστες και οι ρόλοι στους λογαριασμούς που επηρεάζει η SCP. Οι SCPs είναι **παρόμοιες με τις πολιτικές δικαιωμάτων IAM** εκτός από το ότι **δεν χορηγούν καμία άδεια**. Αντίθετα, οι SCPs καθορίζουν τις **μέγιστες άδειες** για έναν οργανισμό, μια οργανωτική μονάδα (OU) ή έναν λογαριασμό. Όταν επισυνάπτετε μια SCP στη ρίζα του οργανισμού σας ή σε μια OU, η **SCP περιορίζει τις άδειες για οντότητες σε λογαριασμούς μελών**.

Αυτός είναι ο ΜΟΝΟΣ τρόπος που **ακόμα και ο root χρήστης μπορεί να σταματήσει** από το να κάνει κάτι. Για παράδειγμα, θα μπορούσε να χρησιμοποιηθεί για να σταματήσει τους χρήστες από το να απενεργοποιήσουν το CloudTrail ή να διαγράψουν αντίγραφα ασφαλείας.\
Ο μόνος τρόπος να παρακαμφθεί αυτό είναι να παραβιαστεί επίσης ο **κύριος λογαριασμός** που διαμορφώνει τις SCPs (ο κύριος λογαριασμός δεν μπορεί να αποκλειστεί).

{% hint style="warning" %}
Σημειώστε ότι οι **SCPs περιορίζουν μόνο τους principals στον λογαριασμό**, οπότε άλλοι λογαριασμοί δεν επηρεάζονται. Αυτό σημαίνει ότι η ύπαρξη μιας SCP που αρνείται το `s3:GetObject` δεν θα σταματήσει τους ανθρώπους από το **να έχουν πρόσβαση σε έναν δημόσιο S3 bucket** στον λογαριασμό σας.
{% endhint %}

Παραδείγματα SCP:

* Απαγόρευση του root λογαριασμού εντελώς
* Επιτρέπονται μόνο συγκεκριμένες περιοχές
* Επιτρέπονται μόνο υπηρεσίες στη λευκή λίστα
* Απαγόρευση απενεργοποίησης των GuardDuty, CloudTrail και S3 Public Block Access
* Απαγόρευση διαγραφής ή τροποποίησης ρόλων ασφαλείας/αντιμετώπισης περιστατικών
* Απαγόρευση διαγραφής αντιγράφων ασφαλείας
* Απαγόρευση δημιουργίας IAM χρηστών και κλειδιών πρόσβασης

Βρείτε **παραδείγματα JSON** στο [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)

### ARN

**Amazon Resource Name** είναι το **μοναδικό όνομα** που έχει κάθε πόρος μέσα στο AWS, και αποτελείται ως εξής:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Σημειώστε ότι υπάρχουν 4 διαμερίσματα στο AWS αλλά μόνο 3 τρόποι να τα καλέσετε:

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US public Internet (GovCloud): `aws-us-gov`
* AWS Secret (US Classified): `aws`

## IAM - Identity and Access Management

IAM είναι η υπηρεσία που θα σας επιτρέψει να διαχειριστείτε **Authentication**, **Authorization** και **Access Control** μέσα στον λογαριασμό σας στο AWS.

* **Authentication** - Διαδικασία ορισμού μιας ταυτότητας και επαλήθευσης αυτής της ταυτότητας. Αυτή η διαδικασία μπορεί να υποδιαιρεθεί σε: Αναγνώριση και επαλήθευση.
* **Authorization** - Καθορίζει τι μπορεί να έχει πρόσβαση μια ταυτότητα μέσα σε ένα σύστημα αφού έχει επαληθευτεί.
* **Access Control** - Η μέθοδος και η διαδικασία του πώς χορηγείται πρόσβαση σε έναν ασφαλή πόρο.

IAM μπορεί να οριστεί από την ικανότητά του να διαχειρίζεται, να ελέγχει και να κυβερνά τους μηχανισμούς authentication, authorization και access control των ταυτοτήτων στους πόρους σας μέσα στον λογαριασμό σας στο AWS.

### [AWS account root user](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Όταν δημιουργείτε για πρώτη φορά έναν λογαριασμό Amazon Web Services (AWS), ξεκινάτε με μια ταυτότητα σύνδεσης που έχει **πλήρη πρόσβαση σε όλες** τις υπηρεσίες και τους πόρους του AWS στον λογαριασμό. Αυτός είναι ο _**root user**_ του λογαριασμού AWS και αποκτάται με τη σύνδεση με τη **διεύθυνση email και τον κωδικό πρόσβασης που χρησιμοποιήσατε για να δημιουργήσετε τον λογαριασμό**.

Σημειώστε ότι ένας νέος **admin user** θα έχει **λιγότερα δικαιώματα από τον root user**.

Από άποψη ασφάλειας, συνιστάται να δημιουργήσετε άλλους χρήστες και να αποφύγετε τη χρήση αυτού.

### [IAM users](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

Ένας IAM _user_ είναι μια οντότητα που δημιουργείτε στο AWS για να **αντιπροσωπεύει το άτομο ή την εφαρμογή** που το χρησιμοποιεί για να **αλληλεπιδράσει με το AWS**. Ένας χρήστης στο AWS αποτελείται από ένα όνομα και διαπιστευτήρια (κωδικό πρόσβασης και έως δύο access keys).

Όταν δημιουργείτε έναν IAM user, του χορηγείτε **δικαιώματα** κάνοντάς τον **μέλος μιας ομάδας χρηστών** που έχει συνημμένες κατάλληλες πολιτικές δικαιωμάτων (συνιστάται), ή με **άμεση συνημμένη πολιτική** στον χρήστη.

Οι χρήστες μπορούν να έχουν **MFA ενεργοποιημένο για σύνδεση** μέσω της κονσόλας. Τα API tokens των χρηστών με ενεργοποιημένο MFA δεν προστατεύονται από το MFA. Αν θέλετε να **περιορίσετε την πρόσβαση των API keys ενός χρήστη χρησιμοποιώντας MFA** πρέπει να υποδείξετε στην πολιτική ότι για να εκτελεστούν ορισμένες ενέργειες πρέπει να υπάρχει MFA (παράδειγμα [**εδώ**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)).

#### CLI

* **Access Key ID**: 20 τυχαίοι κεφαλαίοι αλφαριθμητικοί χαρακτήρες όπως AKHDNAPO86BSHKDIRYT
* **Secret access key ID**: 40 τυχαίοι κεφαλαίοι και πεζοί χαρακτήρες: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (Δεν είναι δυνατή η ανάκτηση χαμένων secret access key IDs).

Όποτε χρειάζεται να **αλλάξετε το Access Key** αυτή είναι η διαδικασία που πρέπει να ακολουθήσετε:\
_Δημιουργήστε ένα νέο access key -> Εφαρμόστε το νέο κλειδί στο σύστημα/εφαρμογή -> σημειώστε το αρχικό ως ανενεργό -> Δοκιμάστε και επαληθεύστε ότι το νέο access key λειτουργεί -> Διαγράψτε το παλιό access key_

### MFA - Multi Factor Authentication

Χρησιμοποιείται για να **δημιουργήσει έναν επιπλέον παράγοντα για authentication** εκτός από τις υπάρχουσες μεθόδους σας, όπως ο κωδικός πρόσβασης, δημιουργώντας έτσι ένα επίπεδο multi-factor authentication.\
Μπορείτε να χρησιμοποιήσετε μια **δωρεάν εικονική εφαρμογή ή μια φυσική συσκευή**. Μπορείτε να χρησιμοποιήσετε εφαρμογές όπως το google authentication δωρεάν για να ενεργοποιήσετε ένα MFA στο AWS.

Πολιτικές με συνθήκες MFA μπορούν να συνημθούν στα εξής:

* Ένας IAM user ή ομάδα
* Ένας πόρος όπως ένας Amazon S3 bucket, Amazon SQS queue, ή Amazon SNS topic
* Η trust policy ενός IAM role που μπορεί να αναληφθεί από έναν χρήστη

Αν θέλετε να **πρόσβαση μέσω CLI** σε έναν πόρο που **ελέγχει για MFA** πρέπει να καλέσετε **`GetSessionToken`**. Αυτό θα σας δώσει ένα token με πληροφορίες για το MFA.\
Σημειώστε ότι **τα credentials του `AssumeRole` δεν περιέχουν αυτές τις πληροφορίες**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
Όπως [**αναφέρεται εδώ**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), υπάρχουν πολλές διαφορετικές περιπτώσεις όπου **MFA δεν μπορεί να χρησιμοποιηθεί**.

### [Ομάδες χρηστών IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Μια [ομάδα χρηστών](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) IAM είναι ένας τρόπος να **επισυνάψετε πολιτικές σε πολλούς χρήστες** ταυτόχρονα, κάτι που μπορεί να διευκολύνει τη διαχείριση των δικαιωμάτων για αυτούς τους χρήστες. **Ρόλοι και ομάδες δεν μπορούν να είναι μέρος μιας ομάδας**.

Μπορείτε να επισυνάψετε μια **πολιτική βασισμένη στην ταυτότητα σε μια ομάδα χρηστών** ώστε όλοι οι **χρήστες** στην ομάδα χρηστών να **λαμβάνουν τα δικαιώματα της πολιτικής**. Δεν μπορείτε να προσδιορίσετε μια **ομάδα χρηστών** ως **`Principal`** σε μια **πολιτική** (όπως μια πολιτική βασισμένη σε πόρους) επειδή οι ομάδες σχετίζονται με δικαιώματα, όχι με αυθεντικοποίηση, και οι principals είναι αυθεντικοποιημένες οντότητες IAM.

Εδώ είναι μερικά σημαντικά χαρακτηριστικά των ομάδων χρηστών:

* Μια **ομάδα χρηστών** μπορεί να **περιέχει πολλούς χρήστες**, και ένας **χρήστης** μπορεί να **ανήκει σε πολλές ομάδες**.
* **Οι ομάδες χρηστών δεν μπορούν να είναι φωλιασμένες**; μπορούν να περιέχουν μόνο χρήστες, όχι άλλες ομάδες χρηστών.
* Δεν υπάρχει **προεπιλεγμένη ομάδα χρηστών που να περιλαμβάνει αυτόματα όλους τους χρήστες στον λογαριασμό AWS**. Αν θέλετε να έχετε μια τέτοια ομάδα χρηστών, πρέπει να τη δημιουργήσετε και να αναθέσετε κάθε νέο χρήστη σε αυτήν.
* Ο αριθμός και το μέγεθος των πόρων IAM σε έναν λογαριασμό AWS, όπως ο αριθμός των ομάδων και ο αριθμός των ομάδων στις οποίες μπορεί να είναι μέλος ένας χρήστης, είναι περιορισμένα. Για περισσότερες πληροφορίες, δείτε [IAM και AWS STS quotas](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html).

### [Ρόλοι IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Ένας **ρόλος** IAM είναι πολύ **παρόμοιος** με έναν **χρήστη**, καθώς είναι μια **ταυτότητα με πολιτικές δικαιωμάτων που καθορίζουν τι** μπορεί και τι δεν μπορεί να κάνει στο AWS. Ωστόσο, ένας ρόλος **δεν έχει διαπιστευτήρια** (κωδικό πρόσβασης ή κλειδιά πρόσβασης) που σχετίζονται με αυτόν. Αντί να συνδέεται μοναδικά με ένα άτομο, ένας ρόλος προορίζεται να **αναλαμβάνεται από οποιονδήποτε τον χρειάζεται (και έχει αρκετά δικαιώματα)**. Ένας **χρήστης IAM μπορεί να αναλάβει έναν ρόλο προσωρινά** για να αναλάβει διαφορετικά δικαιώματα για μια συγκεκριμένη εργασία. Ένας ρόλος μπορεί να **ανατεθεί σε έναν** [**ομοσπονδιακό χρήστη**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html) που συνδέεται χρησιμοποιώντας έναν εξωτερικό πάροχο ταυτότητας αντί για IAM.

Ένας ρόλος IAM αποτελείται από **δύο τύπους πολιτικών**: Μια **πολιτική εμπιστοσύνης**, η οποία δεν μπορεί να είναι κενή, που καθορίζει **ποιος μπορεί να αναλάβει** τον ρόλο, και μια **πολιτική δικαιωμάτων**, η οποία δεν μπορεί να είναι κενή, που καθορίζει **τι μπορεί να έχει πρόσβαση**.

#### AWS Security Token Service (STS)

Το AWS Security Token Service (STS) είναι μια διαδικτυακή υπηρεσία που διευκολύνει την **έκδοση προσωρινών, περιορισμένων δικαιωμάτων διαπιστευτηρίων**. Είναι ειδικά προσαρμοσμένη για:

### [Προσωρινά διαπιστευτήρια στο IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Τα προσωρινά διαπιστευτήρια χρησιμοποιούνται κυρίως με ρόλους IAM**, αλλά υπάρχουν και άλλες χρήσεις. Μπορείτε να ζητήσετε προσωρινά διαπιστευτήρια που έχουν ένα πιο περιορισμένο σύνολο δικαιωμάτων από τον κανονικό χρήστη IAM σας. Αυτό **αποτρέπει** την **τυχαία εκτέλεση εργασιών που δεν επιτρέπονται** από τα πιο περιορισμένα διαπιστευτήρια. Ένα πλεονέκτημα των προσωρινών διαπιστευτηρίων είναι ότι λήγουν αυτόματα μετά από μια καθορισμένη χρονική περίοδο. Έχετε τον έλεγχο της διάρκειας που τα διαπιστευτήρια είναι έγκυρα.

### Πολιτικές

#### Δικαιώματα Πολιτικής

Χρησιμοποιούνται για την ανάθεση δικαιωμάτων. Υπάρχουν 2 τύποι:

* AWS managed policies (προδιαμορφωμένες από το AWS)
* Customer Managed Policies: Διαμορφώνονται από εσάς. Μπορείτε να δημιουργήσετε πολιτικές βασισμένες στις AWS managed policies (τροποποιώντας μία από αυτές και δημιουργώντας τη δική σας), χρησιμοποιώντας τον δημιουργό πολιτικής (μια γραφική διεπαφή που σας βοηθά να χορηγείτε και να αρνείστε δικαιώματα) ή γράφοντας τη δική σας.

Από **προεπιλογή η πρόσβαση** είναι **αρνημένη**, η πρόσβαση θα χορηγηθεί αν έχει καθοριστεί ρητός ρόλος.\
Αν **υπάρχει ένα μόνο "Deny", θα υπερισχύσει του "Allow"**, εκτός από αιτήματα που χρησιμοποιούν τα διαπιστευτήρια ασφαλείας root του λογαριασμού AWS (τα οποία επιτρέπονται από προεπιλογή).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
Οι [παγκόσμια πεδία που μπορούν να χρησιμοποιηθούν για συνθήκες σε οποιαδήποτε υπηρεσία τεκμηριώνονται εδώ](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount).\
Τα [συγκεκριμένα πεδία που μπορούν να χρησιμοποιηθούν για συνθήκες ανά υπηρεσία τεκμηριώνονται εδώ](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html).

#### Inline Policies

Αυτού του είδους οι πολιτικές είναι **άμεσα ανατεθειμένες** σε έναν χρήστη, ομάδα ή ρόλο. Έτσι, δεν εμφανίζονται στη λίστα Πολιτικών όπως οποιαδήποτε άλλη μπορεί να τις χρησιμοποιήσει.\
Οι inline policies είναι χρήσιμες αν θέλετε να **διατηρήσετε μια αυστηρή σχέση ένα προς ένα μεταξύ μιας πολιτικής και της ταυτότητας** στην οποία εφαρμόζεται. Για παράδειγμα, θέλετε να είστε σίγουροι ότι τα δικαιώματα σε μια πολιτική δεν ανατίθενται κατά λάθος σε μια ταυτότητα διαφορετική από αυτήν για την οποία προορίζονται. Όταν χρησιμοποιείτε μια inline policy, τα δικαιώματα στην πολιτική δεν μπορούν να ανατεθούν κατά λάθος στη λάθος ταυτότητα. Επιπλέον, όταν χρησιμοποιείτε το AWS Management Console για να διαγράψετε αυτήν την ταυτότητα, οι πολιτικές που είναι ενσωματωμένες στην ταυτότητα διαγράφονται επίσης. Αυτό συμβαίνει επειδή είναι μέρος της κύριας οντότητας.

#### Resource Bucket Policies

Αυτές είναι **πολιτικές** που μπορούν να οριστούν σε **πόρους**. **Όχι όλοι οι πόροι του AWS τις υποστηρίζουν**.

Αν ένας principal δεν έχει ρητή άρνηση σε αυτούς, και μια resource policy του παρέχει πρόσβαση, τότε επιτρέπεται.

### IAM Boundaries

Τα IAM boundaries μπορούν να χρησιμοποιηθούν για να **περιορίσουν τα δικαιώματα που ένας χρήστης ή ρόλος πρέπει να έχει πρόσβαση**. Με αυτόν τον τρόπο, ακόμα και αν ένα διαφορετικό σύνολο δικαιωμάτων χορηγηθεί στον χρήστη από μια **διαφορετική πολιτική**, η λειτουργία θα **αποτύχει** αν προσπαθήσει να τα χρησιμοποιήσει.

Ένα boundary είναι απλώς μια πολιτική που επισυνάπτεται σε έναν χρήστη που **υποδεικνύει το μέγιστο επίπεδο δικαιωμάτων που ο χρήστης ή ο ρόλος μπορεί να έχει**. Έτσι, **ακόμα και αν ο χρήστης έχει Administrator access**, αν το boundary υποδεικνύει ότι μπορεί μόνο να διαβάσει S3 buckets, αυτό είναι το μέγιστο που μπορεί να κάνει.

**Αυτό**, **SCPs** και **ακολουθώντας την αρχή του ελάχιστου προνομίου** είναι οι τρόποι να ελέγξετε ότι οι χρήστες δεν έχουν περισσότερα δικαιώματα από αυτά που χρειάζονται.

### Session Policies

Μια session policy είναι μια **πολιτική που ορίζεται όταν ένας ρόλος αναλαμβάνεται** με κάποιο τρόπο. Αυτό θα είναι σαν ένα **IAM boundary για αυτήν τη συνεδρία**: Αυτό σημαίνει ότι η session policy δεν χορηγεί δικαιώματα αλλά **τα περιορίζει σε αυτά που υποδεικνύονται στην πολιτική** (με τα μέγιστα δικαιώματα να είναι αυτά που έχει ο ρόλος).

Αυτό είναι χρήσιμο για **μέτρα ασφαλείας**: Όταν ένας διαχειριστής πρόκειται να αναλάβει έναν πολύ προνομιούχο ρόλο, θα μπορούσε να περιορίσει τα δικαιώματα μόνο σε αυτά που υποδεικνύονται στην session policy σε περίπτωση που η συνεδρία παραβιαστεί.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Σημειώστε ότι από προεπιλογή **AWS μπορεί να προσθέσει πολιτικές συνεδρίας σε συνεδρίες** που πρόκειται να δημιουργηθούν λόγω τρίτων λόγων. Για παράδειγμα, σε [unauthenticated cognito assumed roles](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) από προεπιλογή (χρησιμοποιώντας ενισχυμένη αυθεντικοποίηση), το AWS θα δημιουργήσει **διαπιστευτήρια συνεδρίας με πολιτική συνεδρίας** που περιορίζει τις υπηρεσίες που μπορεί να έχει πρόσβαση η συνεδρία [**στην ακόλουθη λίστα**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Επομένως, αν κάποια στιγμή αντιμετωπίσετε το σφάλμα "... επειδή καμία πολιτική συνεδρίας δεν επιτρέπει το ...", και ο ρόλος έχει πρόσβαση να εκτελέσει τη δράση, είναι επειδή **υπάρχει μια πολιτική συνεδρίας που το αποτρέπει**.

### Identity Federation

Η ομοσπονδία ταυτότητας **επιτρέπει στους χρήστες από παρόχους ταυτότητας που είναι εξωτερικοί** προς το AWS να έχουν ασφαλή πρόσβαση σε πόρους του AWS χωρίς να χρειάζεται να παρέχουν διαπιστευτήρια χρήστη AWS από έναν έγκυρο λογαριασμό χρήστη IAM.\
Ένα παράδειγμα παρόχου ταυτότητας μπορεί να είναι ο δικός σας εταιρικός **Microsoft Active Directory** (μέσω **SAML**) ή υπηρεσίες **OpenID** (όπως **Google**). Η ομοσπονδιακή πρόσβαση θα επιτρέψει στη συνέχεια στους χρήστες εντός αυτής να έχουν πρόσβαση στο AWS.

Για να διαμορφώσετε αυτήν την εμπιστοσύνη, δημιουργείται ένας **IAM Identity Provider (SAML ή OAuth)** που θα **εμπιστεύεται** την **άλλη πλατφόρμα**. Στη συνέχεια, τουλάχιστον ένας **IAM ρόλος ανατίθεται (εμπιστευόμενος) στον Identity Provider**. Αν ένας χρήστης από την εμπιστευόμενη πλατφόρμα έχει πρόσβαση στο AWS, θα έχει πρόσβαση ως ο αναφερόμενος ρόλος.

Ωστόσο, συνήθως θα θέλετε να δώσετε έναν **διαφορετικό ρόλο ανάλογα με την ομάδα του χρήστη** στην τρίτη πλατφόρμα. Στη συνέχεια, αρκετοί **IAM ρόλοι μπορούν να εμπιστεύονται** τον τρίτο πάροχο ταυτότητας και η τρίτη πλατφόρμα θα είναι αυτή που θα επιτρέπει στους χρήστες να αναλαμβάνουν έναν ρόλο ή τον άλλο.

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### IAM Identity Center

Το AWS IAM Identity Center (διάδοχος του AWS Single Sign-On) επεκτείνει τις δυνατότητες του AWS Identity and Access Management (IAM) για να παρέχει ένα **κεντρικό σημείο** που συγκεντρώνει **τη διαχείριση των χρηστών και της πρόσβασής τους σε λογαριασμούς AWS** και εφαρμογές cloud.

Ο τομέας σύνδεσης θα είναι κάτι σαν `<user_input>.awsapps.com`.

Για να συνδεθούν οι χρήστες, υπάρχουν 3 πηγές ταυτότητας που μπορούν να χρησιμοποιηθούν:

* Identity Center Directory: Κανονικοί χρήστες AWS
* Active Directory: Υποστηρίζει διαφορετικούς συνδέσμους
* External Identity Provider: Όλοι οι χρήστες και οι ομάδες προέρχονται από έναν εξωτερικό πάροχο ταυτότητας (IdP)

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

Στην απλούστερη περίπτωση του καταλόγου Identity Center, το **Identity Center θα έχει μια λίστα χρηστών και ομάδων** και θα μπορεί να **αναθέτει πολιτικές** σε αυτούς σε **οποιονδήποτε από τους λογαριασμούς** της οργάνωσης.

Για να δώσετε πρόσβαση σε έναν χρήστη/ομάδα του Identity Center σε έναν λογαριασμό, θα δημιουργηθεί ένας **SAML Identity Provider που εμπιστεύεται το Identity Center**, και ένας **ρόλος που εμπιστεύεται τον Identity Provider με τις υποδεικνυόμενες πολιτικές θα δημιουργηθεί** στον προορισμό λογαριασμού.

#### AwsSSOInlinePolicy

Είναι δυνατόν να **δοθούν δικαιώματα μέσω ενσωματωμένων πολιτικών σε ρόλους που δημιουργούνται μέσω του IAM Identity Center**. Οι ρόλοι που δημιουργούνται στους λογαριασμούς που δίνονται **ενσωματωμένες πολιτικές στο AWS Identity Center** θα έχουν αυτά τα δικαιώματα σε μια ενσωματωμένη πολιτική που ονομάζεται **`AwsSSOInlinePolicy`**.

Επομένως, ακόμα κι αν δείτε 2 ρόλους με μια ενσωματωμένη πολιτική που ονομάζεται **`AwsSSOInlinePolicy`**, αυτό **δεν σημαίνει ότι έχουν τα ίδια δικαιώματα**.

### Cross Account Trusts and Roles

**Ένας χρήστης** (εμπιστευόμενος) μπορεί να δημιουργήσει έναν Cross Account Role με κάποιες πολιτικές και στη συνέχεια, **να επιτρέψει σε έναν άλλο χρήστη** (εμπιστευόμενο) να **έχει πρόσβαση στον λογαριασμό του** αλλά μόνο **έχοντας την πρόσβαση που υποδεικνύεται στις νέες πολιτικές ρόλου**. Για να δημιουργήσετε αυτό, απλά δημιουργήστε έναν νέο ρόλο και επιλέξτε Cross Account Role. Οι ρόλοι για Cross-Account Access προσφέρουν δύο επιλογές. Παροχή πρόσβασης μεταξύ λογαριασμών AWS που κατέχετε και παροχή πρόσβασης μεταξύ ενός λογαριασμού που κατέχετε και ενός τρίτου λογαριασμού AWS.\
Συνιστάται να **καθορίσετε τον χρήστη που είναι εμπιστευόμενος και να μην βάλετε κάτι γενικό** γιατί αν όχι, άλλοι αυθεντικοποιημένοι χρήστες όπως οι ομοσπονδιακοί χρήστες θα μπορούν επίσης να καταχραστούν αυτήν την εμπιστοσύνη.

### AWS Simple AD

Δεν υποστηρίζεται:

* Trust Relations
* AD Admin Center
* Full PS API support
* AD Recycle Bin
* Group Managed Service Accounts
* Schema Extensions
* No Direct access to OS or Instances

#### Web Federation or OpenID Authentication

Η εφαρμογή χρησιμοποιεί το AssumeRoleWithWebIdentity για να δημιουργήσει προσωρινά διαπιστευτήρια. Ωστόσο, αυτό δεν παρέχει πρόσβαση στην κονσόλα AWS, μόνο πρόσβαση σε πόρους εντός του AWS.

### Other IAM options

* Μπορείτε να **ορίσετε μια πολιτική κωδικού πρόσβασης** ρυθμίζοντας επιλογές όπως το ελάχιστο μήκος και τις απαιτήσεις κωδικού πρόσβασης.
* Μπορείτε να **κατεβάσετε "Credential Report"** με πληροφορίες σχετικά με τα τρέχοντα διαπιστευτήρια (όπως ο χρόνος δημιουργίας χρήστη, αν είναι ενεργοποιημένος ο κωδικός πρόσβασης...). Μπορείτε να δημιουργήσετε μια αναφορά διαπιστευτηρίων όσο συχνά μία φορά κάθε **τέσσερις ώρες**.

Το AWS Identity and Access Management (IAM) παρέχει **λεπτομερή έλεγχο πρόσβασης** σε όλο το AWS. Με το IAM, μπορείτε να καθορίσετε **ποιος μπορεί να έχει πρόσβαση σε ποιες υπηρεσίες και πόρους**, και υπό ποιες συνθήκες. Με τις πολιτικές IAM, διαχειρίζεστε τα δικαιώματα στο εργατικό δυναμικό και τα συστήματά σας για να **εξασφαλίσετε δικαιώματα ελάχιστης προνομίας**.

### IAM ID Prefixes

Στην [**αυτή τη σελίδα**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) μπορείτε να βρείτε τα **IAM ID prefixes** των κλειδιών ανάλογα με τη φύση τους:

| ABIA | [AWS STS service bearer token](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Context-specific credential                                                                                                                                                                                           |
| AGPA | User group                                                                                                                                                                                                            |
| AIDA | IAM user                                                                                                                                                                                                              |
| AIPA | Amazon EC2 instance profile                                                                                                                                                                                           |
| AKIA | Access key                                                                                                                                                                                                            |
| ANPA | Managed policy                                                                                                                                                                                                        |
| ANVA | Version in a managed policy                                                                                                                                                                                           |
| APKA | Public key                                                                                                                                                                                                            |
| AROA | Role                                                                                                                                                                                                                  |
| ASCA | Certificate                                                                                                                                                                                                           |
| ASIA | [Temporary (AWS STS) access key IDs](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) use this prefix, but are unique only in combination with the secret access key and the session token. |

### Recommended permissions to audit accounts

Τα ακόλουθα δικαιώματα παρέχουν διάφορες αναγνώσεις πρόσβασης μεταδεδομένων:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Misc

### CLI Authentication

Για να αυθεντικοποιηθεί ένας κανονικός χρήστης στο AWS μέσω CLI, πρέπει να έχει **τοπικά διαπιστευτήρια**. Από προεπιλογή μπορείτε να τα διαμορφώσετε **χειροκίνητα** στο `~/.aws/credentials` ή **τρέχοντας** `aws configure`.\
Σε αυτό το αρχείο μπορείτε να έχετε περισσότερα από ένα προφίλ, αν **δεν καθοριστεί προφίλ** χρησιμοποιώντας το **aws cli**, θα χρησιμοποιηθεί αυτό που ονομάζεται **`[default]`** σε αυτό το αρχείο.\
Παράδειγμα αρχείου διαπιστευτηρίων με περισσότερα από 1 προφίλ:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Αν χρειάζεστε πρόσβαση σε **διαφορετικούς λογαριασμούς AWS** και το προφίλ σας έχει δοθεί πρόσβαση για **ανάληψη ρόλου μέσα σε αυτούς τους λογαριασμούς**, δεν χρειάζεται να καλείτε χειροκίνητα STS κάθε φορά (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) και να διαμορφώνετε τα διαπιστευτήρια.

Μπορείτε να χρησιμοποιήσετε το αρχείο `~/.aws/config` για να [**υποδείξετε ποιους ρόλους να αναλάβετε**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), και στη συνέχεια να χρησιμοποιήσετε την παράμετρο `--profile` όπως συνήθως (η `assume-role` θα εκτελεστεί με διαφανή τρόπο για τον χρήστη).\
Ένα παράδειγμα αρχείου config:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Με αυτό το αρχείο ρυθμίσεων μπορείτε στη συνέχεια να χρησιμοποιήσετε το aws cli όπως:
```
aws --profile acc2 ...
```
Αν ψάχνετε για κάτι **παρόμοιο** με αυτό αλλά για τον **browser** μπορείτε να ελέγξετε την **επέκταση** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## Αναφορές

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
