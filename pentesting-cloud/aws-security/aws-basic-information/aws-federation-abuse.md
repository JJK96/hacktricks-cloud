# AWS - рд╕рдВрдШ Abuse

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг AWS рд░реЗрдб рдЯреАрдо рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг GCP рд░реЗрдб рдЯреАрдо рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рдЬреБрдбрд╝реЗрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВред

</details>
{% endhint %}

## SAML

SAML рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдХреГрдкрдпрд╛ рдЬрд╛рдБрдЪреЗрдВ:

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

**SAML рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ рдкрд╣рдЪрд╛рди рд╕рдВрдШ рдХреИрд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ** рдЗрд╕рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдПрдХ **рдирд╛рдо** рдФрд░ рд╕рднреА SAML рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди (**рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕**, **рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХреБрдВрдЬреА рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгрдкрддреНрд░**) рдХреЛ рд╕рдореЗрдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ **рдореЗрдЯрд╛рдбреЗрдЯрд╛ XML** рдкреНрд░рджрд╛рди рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

## OIDC - Github рдХреНрд░рд┐рдпрд╛рдПрдБ рджреБрд░реБрдкрдпреЛрдЧ

рдПрдХ рдЧрд┐рдЯрд╣рдм рдХреНрд░рд┐рдпрд╛ рдХреЛ рдкрд╣рдЪрд╛рди рдкреНрд░рджрд╛рддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП:

1. _рдкреНрд░рджрд╛рддрд╛ рдкреНрд░рдХрд╛рд░_ рдХреЗ рд▓рд┐рдП, **OpenID Connect** рдХрд╛ рдЪрдпрди рдХрд░реЗрдВред
2. _рдкреНрд░рджрд╛рддрд╛ URL_ рдХреЗ рд▓рд┐рдП, `https://token.actions.githubusercontent.com` рджрд░реНрдЬ рдХрд░реЗрдВред
3. рдкреНрд░рджрд╛рддрд╛ рдХрд╛ рдердВрдмрдкреНрд░рд┐рдВрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП _рдердВрдмрдкреНрд░рд┐рдВрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ_ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ
4. _рджрд░реНрд╢рдХ_ рдХреЗ рд▓рд┐рдП, `sts.amazonaws.com` рджрд░реНрдЬ рдХрд░реЗрдВред
5. рдЧрд┐рдЯрд╣рдм рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЬреЛ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдЪрд╛рд╣рд┐рдП рдЙрдиреНрд╣реЗрдВ рдФрд░ рдПрдХ **рднрд░реЛрд╕рд╛ рдиреАрддрд┐** рдмрдирд╛рдПрдВ рдЬреЛ рдкреНрд░рджрд╛рддрд╛ рдХреЛ рд╡рд┐рд╢реНрд╡рд╛рд╕ рдХрд░рддреА рд╣реИ рдЬреИрд╕реЗ:
* ```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::0123456789:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:sub": [
"repo:ORG_OR_USER_NAME/REPOSITORY:pull_request",
"repo:ORG_OR_USER_NAME/REPOSITORY:ref:refs/heads/main"
],
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
6. рдкрд┐рдЫрд▓реА рдиреАрддрд┐ рдореЗрдВ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдХреИрд╕реЗ рдХреЗрд╡рд▓ рдПрдХ **рд╢рд╛рдЦрд╛** рдХреЛ **рдЕрдиреБрдорддрд┐** рджреА рдЧрдИ рдереА рдЬреЛ рдПрдХ рд╡рд┐рд╢реЗрд╖ **рдЯреНрд░рд┐рдЧрд░** рдХреЗ рд╕рд╛рде **рд╕рдВрдЧрдарди** рдХреЗ **рдкреБрдирд░реНрдирд┐рд░реНрдорд╛рдг** рд╕реЗ рдЕрдзрд┐рдХреГрдд рдереАред
7. рдЧрд┐рдЯрд╣рдм рдХреНрд░рд┐рдпрд╛ рдЬреЛ **рдЕрдиреБрдХрд░рдг** рдХрд░ рд╕рдХрддреА рд╣реИ, рдЙрд╕ **рднреВрдорд┐рдХрд╛** рдХрд╛ **ARN** рдЬреЛ рдЧрд┐рдЯрд╣рдм рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЬрд╛рдирдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕реЗ рдПрдХ **рдЧреБрдкреНрдд** рдореЗрдВ рдПрдХ **рдкрд░реНрдпрд╛рд╡рд░рдг** рдХреЗ рдЕрдВрджрд░ рдПрдХ **рд░рд╣рд╕реНрдп** рдХреЗ рд░реВрдк рдореЗрдВ **рд╕реНрдЯреЛрд░** рдХрд░реЗрдВред
8. рдЕрдВрддрддрдГ AWS рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЧрд┐рдЯрд╣рдм рдХреНрд░рд┐рдпрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдЬреЛ рдХрд╛рд░реНрдпрдкреНрд░рд╡рд╛рд╣ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рд╣реИрдВ:
```yaml
name: 'test AWS Access'

# The workflow should only trigger on pull requests to the main branch
on:
pull_request:
branches:
- main

# Required to get the ID Token that will be used for OIDC
permissions:
id-token: write
contents: read # needed for private repos to checkout

jobs:
aws:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v3

- name: Configure AWS Credentials
uses: aws-actions/configure-aws-credentials@v1
with:
aws-region: eu-west-1
role-to-assume: ${{ secrets.READ_ROLE }}
role-session-name: OIDCSession

- run: aws sts get-caller-identity
shell: bash
```
## OIDC - EKS рджреБрд░реБрдкрдпреЛрдЧ
```bash
# Crate an EKS cluster (~10min)
eksctl create cluster --name demo --fargate
```

```bash
# Create an Identity Provider for an EKS cluster
eksctl utils associate-iam-oidc-provider --cluster Testing --approve
```
рдПрдХ **EKS** рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ **OIDC рдкреНрд░рджрд╛рддрд╛рдУрдВ** рдХреЛ рдПрдХ **рдирдП рдУрдкрди рдЖрдИрдбреА рдЖрдИрдбреЗрдВрдЯрд┐рдЯреА рдкреНрд░рджрд╛рддрд╛** рдХреЗ рд░реВрдк рдореЗрдВ рд╕реЗрдЯ рдХрд░рдХреЗ рд╕рд░рд▓рддрд╛ рд╕реЗ рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдиреАрддрд┐ рд╣реИ:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::123456789098:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:aud": "sts.amazonaws.com"
}
}
}
]
}
```
рдпрд╣ рдиреАрддрд┐ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдЗрд╕ рдмрд╛рдд рдХреА рдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд░ рд░рд╣реА рд╣реИ рдХрд┐ **рдХреЗрд╡рд▓** **рдЖрдИрдПрдХреЗрдПрд╕ рдХреНрд▓рд╕реНрдЯрд░** рдЬрд┐рд╕рдХрд╛ **рдЖрдИрдбреА** `20C159CDF6F2349B68846BEC03BE031B` рд╣реИ, рд╡рд╣ рднреВрдорд┐рдХрд╛ рдЕрдиреБрдорд╛рди рдХрд░ рд╕рдХрддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ рдирд╣реАрдВ рджрд┐рдЦрд╛ рд░рд╣рд╛ рд╣реИ рдХрд┐ рдХреМрди рд╕реА рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдЗрд╕реЗ рдЕрдиреБрдорд╛рди рдХрд░ рд╕рдХрддреА рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ **рдХреЛрдИ рднреА рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдПрдХ рд╡реЗрдм рдкрд╣рдЪрд╛рди рдЯреЛрдХрди рд╣реИ** рднреВрдорд┐рдХрд╛ рдЕрдиреБрдорд╛рди рдХрд░ рд╕рдХрддреА рд╣реИред

**рднреВрдорд┐рдХрд╛ рдЕрдиреБрдорд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреМрди рд╕реА рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдЕрдиреБрдорд╛рди рдХрд░ рд╕рдХрддреА рд╣реИ,** рдЗрд╕реЗ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдПрдХ **рд╢рд░реНрдд** рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ, рдЬрд╣рд╛рдВ **рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдирд╛рдо рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╣реИ**, рдЬреИрд╕реЗ:&#x20;

{% code overflow="wrap" %}
```bash
"oidc.eks.region-code.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:sub": "system:serviceaccount:default:my-service-account",
```
{% endcode %}

## рд╕рдВрджрд░реНрдн

* [https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/](https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/)

{% hint style="success" %}
рдПрдбрд╡рд╛рдВрд╕реНрдб рд╡реЗрдм рд╕рд░реНрд╡рд┐рд╕реЗрдЬ (AWS) рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг AWS рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
рдЧреВрдЧрд▓ рдХреНрд▓рд╛рдЙрдб рдкреНрд▓реЗрдЯрдлреЙрд░реНрдо (GCP) рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг GCP рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдФрд░ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдХреЛ** **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>
{% endhint %}
