# AWS - 페더레이션 남용

{% hint style="success" %}
AWS 해킹을 배우고 실습하세요:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP 해킹을 배우고 실습하세요: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원하기</summary>

* [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* **💬 [디스코드 그룹](https://discord.gg/hRep4RUj7f)** 또는 [텔레그램 그룹](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* **HackTricks** 및 **HackTricks Cloud** 깃허브 저장소에 PR을 제출하여 해킹 트릭을 공유하세요.

</details>
{% endhint %}

## SAML

SAML에 대한 정보는 다음을 확인하세요:

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

**SAML을 통한 Identity Federation**을 구성하려면 **이름**과 모든 SAML 구성을 포함하는 **메타데이터 XML**(**엔드포인트**, **공개 키가 있는 인증서)를 제공**하면 됩니다.

## OIDC - Github Actions 남용

Identity 공급자로 github action을 추가하려면:

1. _Provider type_으로 **OpenID Connect**를 선택합니다.
2. _Provider URL_에 `https://token.actions.githubusercontent.com`을 입력합니다.
3. _Get thumbprint_를 클릭하여 공급자의 썸프린트를 가져옵니다.
4. _Audience_에 `sts.amazonaws.com`을 입력합니다.
5. github action이 필요로 하는 **권한** 및 공급자를 신뢰하는 **신뢰 정책**이 있는 **새 역할**을 만듭니다.
* ```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::0123456789:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:sub": [
"repo:ORG_OR_USER_NAME/REPOSITORY:pull_request",
"repo:ORG_OR_USER_NAME/REPOSITORY:ref:refs/heads/main"
],
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
6. 이전 정책에서 어떻게 **조직**의 **저장소**에서 **특정 트리거**로 **특정 브랜치**만이 허가되었는지 확인하세요.
7. github action이 **가장할 수 있는 역할**의 **ARN**은 github action이 알아야 하는 "비밀"이므로 이를 **환경**의 **비밀** 내에 **저장**하세요.
8. 마지막으로 github action을 사용하여 워크플로에서 사용할 AWS 자격 증명을 구성하세요.
```yaml
name: 'test AWS Access'

# The workflow should only trigger on pull requests to the main branch
on:
pull_request:
branches:
- main

# Required to get the ID Token that will be used for OIDC
permissions:
id-token: write
contents: read # needed for private repos to checkout

jobs:
aws:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v3

- name: Configure AWS Credentials
uses: aws-actions/configure-aws-credentials@v1
with:
aws-region: eu-west-1
role-to-assume: ${{ secrets.READ_ROLE }}
role-session-name: OIDCSession

- run: aws sts get-caller-identity
shell: bash
```
## OIDC - EKS 남용
```bash
# Crate an EKS cluster (~10min)
eksctl create cluster --name demo --fargate
```

```bash
# Create an Identity Provider for an EKS cluster
eksctl utils associate-iam-oidc-provider --cluster Testing --approve
```
**OIDC 공급자**를 생성하는 것은 간단하며, **EKS** 클러스터의 **OIDC URL**을 **새로운 Open ID Identity 공급자**로 설정함으로써 가능합니다. 이것은 일반적인 기본 정책입니다:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::123456789098:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:aud": "sts.amazonaws.com"
}
}
}
]
}
```
이 정책은 **id**가 `20C159CDF6F2349B68846BEC03BE031B`인 **EKS 클러스터**만 역할을 가정할 수 있다고 올바르게 나타내고 있습니다. 그러나 어떤 서비스 계정이 그 역할을 가정할 수 있는지 명시하지 않았기 때문에 **웹 신원 토큰을 가진 A**NY 서비스 계정이 그 역할을 가정할 수 있게 됩니다.

**어떤 서비스 계정이 그 역할을 가정할 수 있는지 지정하려면,** **서비스 계정 이름이 지정된** **조건**을 지정해야 합니다. 다음과 같이:&#x20;

{% code overflow="wrap" %}
```bash
"oidc.eks.region-code.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:sub": "system:serviceaccount:default:my-service-account",
```
{% endcode %}

## 참고 자료

* [https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/](https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/)

{% hint style="success" %}
AWS 해킹을 배우고 실습하세요:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP 해킹을 배우고 실습하세요: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원하기</summary>

* [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* 💬 [**디스코드 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* 해킹 팁을 공유하려면 [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>
{% endhint %}
