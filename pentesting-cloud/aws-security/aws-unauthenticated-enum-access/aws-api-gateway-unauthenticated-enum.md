# AWS - API Gateway Unauthenticated Enum

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

### API Invoke bypass

Σύμφωνα με την ομιλία [Attack Vectors for APIs Using AWS API Gateway Lambda Authorizers - Alexandre & Leonardo](https://www.youtube.com/watch?v=bsPKk7WDOnE), οι Lambda Authorizers μπορούν να διαμορφωθούν **χρησιμοποιώντας σύνταξη IAM** για να δώσουν δικαιώματα για την εκτέλεση API endpoints. Αυτό είναι παρμένο [**από τα έγγραφα**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Permission",
"Action": [
"execute-api:Execution-operation"
],
"Resource": [
"arn:aws:execute-api:region:account-id:api-id/stage/METHOD_HTTP_VERB/Resource-path"
]
}
]
}
```
Το πρόβλημα με αυτόν τον τρόπο να δώσετε δικαιώματα για την εκτέλεση endpoints είναι ότι το **"\*" υποδηλώνει "οτιδήποτε"** και δεν υποστηρίζεται **καμία άλλη σύνταξη regex**.

Μερικά παραδείγματα:

* Ένας κανόνας όπως `arn:aws:execute-apis:sa-east-1:accid:api-id/prod/*/dashboard/*` για να δώσει σε κάθε χρήστη πρόσβαση στο `/dashboard/user/{username}` θα τους δώσει πρόσβαση σε άλλες διαδρομές όπως το `/admin/dashboard/createAdmin` για παράδειγμα.

{% hint style="warning" %}
Σημειώστε ότι το **"\*" δεν σταματά να επεκτείνεται με κάθετες**, επομένως, αν χρησιμοποιήσετε "\*" στο api-id για παράδειγμα, θα μπορούσε επίσης να υποδηλώνει "οποιοδήποτε στάδιο" ή "οποιαδήποτε μέθοδο" εφόσον το τελικό regex είναι ακόμα έγκυρο.\
Έτσι `arn:aws:execute-apis:sa-east-1:accid:*/prod/GET/dashboard/*`\
Μπορεί να επικυρώσει ένα αίτημα post στο στάδιο test στη διαδρομή `/prod/GET/dashboard/admin` για παράδειγμα.
{% endhint %}

Πρέπει πάντα να έχετε ξεκάθαρο τι θέλετε να επιτρέψετε να προσπελαστεί και στη συνέχεια να ελέγξετε αν άλλα σενάρια είναι δυνατά με τα δικαιώματα που έχουν δοθεί.

Για περισσότερες πληροφορίες, εκτός από τα [**docs**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html), μπορείτε να βρείτε κώδικα για την υλοποίηση authorizers σε [**αυτό το επίσημο aws github**](https://github.com/awslabs/aws-apigateway-lambda-authorizer-blueprints/tree/master/blueprints).

### IAM Policy Injection

Στην ίδια [**ομιλία**](https://www.youtube.com/watch?v=bsPKk7WDOnE) εκτίθεται το γεγονός ότι αν ο κώδικας χρησιμοποιεί **εισαγωγή χρήστη** για να **δημιουργήσει τις IAM policies**, wildcards (και άλλες όπως "." ή συγκεκριμένες συμβολοσειρές) μπορούν να συμπεριληφθούν εκεί με στόχο την **παράκαμψη περιορισμών**.

### Public URL template
```
https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided}
```
### Λήψη ID Λογαριασμού από δημόσιο API Gateway URL

Όπως και με τα S3 buckets, Data Exchange και Lambda URLs gateways, είναι δυνατό να βρεθεί το ID λογαριασμού ενός λογαριασμού εκμεταλλευόμενοι το **`aws:ResourceAccount`** **Policy Condition Key** από ένα δημόσιο API Gateway URL. Αυτό γίνεται βρίσκοντας το ID λογαριασμού ένα χαρακτήρα τη φορά εκμεταλλευόμενοι τα wildcards στην ενότητα **`aws:ResourceAccount`** της πολιτικής.\
Αυτή η τεχνική επιτρέπει επίσης την απόκτηση **τιμών ετικετών** αν γνωρίζετε το κλειδί της ετικέτας (υπάρχουν μερικές προεπιλεγμένες ενδιαφέρουσες).

Μπορείτε να βρείτε περισσότερες πληροφορίες στην [**αρχική έρευνα**](https://blog.plerion.com/conditional-love-for-aws-metadata-enumeration/) και το εργαλείο [**conditional-love**](https://github.com/plerionhq/conditional-love/) για την αυτοματοποίηση αυτής της εκμετάλλευσης.

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Συμμετάσχετε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή την [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
