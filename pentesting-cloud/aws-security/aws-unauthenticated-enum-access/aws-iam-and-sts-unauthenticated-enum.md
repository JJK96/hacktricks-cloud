# AWS - IAM & STS Unauthenticated Enum

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Εντοπισμός Ρόλων & Ονομάτων Χρηστών σε έναν λογαριασμό

### ~~Assume Role Brute-Force~~

{% hint style="danger" %}
**Αυτή η τεχνική δεν λειτουργεί** πλέον καθώς αν ο ρόλος υπάρχει ή όχι, πάντα λαμβάνετε αυτό το σφάλμα:

`An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::947247140022:user/testenv is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::429217632764:role/account-balanceasdas`

Μπορείτε **να το δοκιμάσετε εκτελώντας**:

`aws sts assume-role --role-arn arn:aws:iam::412345678909:role/superadmin --role-session-name s3-access-example`
{% endhint %}

Η προσπάθεια **ανάληψης ρόλου χωρίς τις απαραίτητες άδειες** προκαλεί ένα μήνυμα σφάλματος από το AWS. Για παράδειγμα, αν δεν έχετε εξουσιοδότηση, το AWS μπορεί να επιστρέψει:
```ruby
An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::012345678901:user/MyUser is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::111111111111:role/aws-service-role/rds.amazonaws.com/AWSServiceRoleForRDS
```
Αυτό το μήνυμα επιβεβαιώνει την ύπαρξη του ρόλου αλλά υποδεικνύει ότι η πολιτική ανάληψης ρόλου δεν επιτρέπει την ανάληψή σας. Αντίθετα, η προσπάθεια **ανάληψης ενός ανύπαρκτου ρόλου οδηγεί σε διαφορετικό σφάλμα**:
```less
An error occurred (AccessDenied) when calling the AssumeRole operation: Not authorized to perform sts:AssumeRole
```
Ενδιαφέρον είναι ότι αυτή η μέθοδος **διάκρισης μεταξύ υπαρχόντων και μη υπαρχόντων ρόλων** είναι εφαρμόσιμη ακόμα και σε διαφορετικούς λογαριασμούς AWS. Με ένα έγκυρο AWS account ID και μια στοχευμένη λίστα λέξεων, μπορεί κανείς να απαριθμήσει τους ρόλους που υπάρχουν στον λογαριασμό χωρίς να αντιμετωπίσει εγγενείς περιορισμούς.

Μπορείτε να χρησιμοποιήσετε αυτό το [script για να απαριθμήσετε πιθανούς principals](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/assume\_role\_enum) εκμεταλλευόμενοι αυτό το ζήτημα.

### Trust Policies: Brute-Force Cross Account roles and users

Η διαμόρφωση ή η ενημέρωση της **trust policy ενός IAM ρόλου περιλαμβάνει τον καθορισμό των AWS πόρων ή υπηρεσιών που επιτρέπεται να αναλάβουν αυτόν τον ρόλο** και να αποκτήσουν προσωρινά διαπιστευτήρια. Εάν ο καθορισμένος πόρος στην πολιτική **υπάρχει**, η trust policy αποθηκεύεται **επιτυχώς**. Ωστόσο, εάν ο πόρος **δεν υπάρχει**, δημιουργείται **σφάλμα**, υποδεικνύοντας ότι παρέχεται ένας μη έγκυρος principal.

{% hint style="warning" %}
Σημειώστε ότι σε αυτόν τον πόρο θα μπορούσατε να καθορίσετε έναν cross account ρόλο ή χρήστη:

* `arn:aws:iam::acc_id:role/role_name`
* `arn:aws:iam::acc_id:user/user_name`
{% endhint %}

Αυτό είναι ένα παράδειγμα πολιτικής:
```json
{
"Version":"2012-10-17",
"Statement":[
{
"Effect":"Allow",
"Principal":
{
"AWS":"arn:aws:iam::216825089941:role\/Test"
},
"Action":"sts:AssumeRole"
}
]
}
```
#### GUI

Αυτό είναι το **σφάλμα** που θα βρείτε αν χρησιμοποιήσετε έναν **ρόλο που δεν υπάρχει**. Αν ο ρόλος **υπάρχει**, η πολιτική θα **αποθηκευτεί** χωρίς κανένα σφάλμα. (Το σφάλμα είναι για ενημέρωση, αλλά λειτουργεί και κατά τη δημιουργία)

![](<../../../.gitbook/assets/image (153).png>)

#### CLI
```bash
### You could also use: aws iam update-assume-role-policy
# When it works
aws iam create-role --role-name Test-Role --assume-role-policy-document file://a.json
{
"Role": {
"Path": "/",
"RoleName": "Test-Role",
"RoleId": "AROA5ZDCUJS3DVEIYOB73",
"Arn": "arn:aws:iam::947247140022:role/Test-Role",
"CreateDate": "2022-05-03T20:50:04Z",
"AssumeRolePolicyDocument": {
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::316584767888:role/account-balance"
},
"Action": [
"sts:AssumeRole"
]
}
]
}
}
}

# When it doesn't work
aws iam create-role --role-name Test-Role2 --assume-role-policy-document file://a.json
An error occurred (MalformedPolicyDocument) when calling the CreateRole operation: Invalid principal in policy: "AWS":"arn:aws:iam::316584767888:role/account-balanceefd23f2"
```
You can automate this process with [https://github.com/carlospolop/aws\_tools](https://github.com/carlospolop/aws\_tools)

* `bash unauth_iam.sh -t user -i 316584767888 -r TestRole -w ./unauth_wordlist.txt`

Our using [Pacu](https://github.com/RhinoSecurityLabs/pacu):

* `run iam__enum_users --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* `run iam__enum_roles --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* The `admin` role used in the example is a **role in your account to by impersonated** by pacu to create the policies it needs to create for the enumeration

### Privesc

Σε περίπτωση που ο ρόλος έχει διαμορφωθεί λάθος και επιτρέπει σε οποιονδήποτε να τον αναλάβει:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
Ο επιτιθέμενος θα μπορούσε απλά να το υποθέσει.

## Third Party OIDC Federation

Φανταστείτε ότι καταφέρνετε να διαβάσετε ένα **Github Actions workflow** που έχει πρόσβαση σε έναν **ρόλο** μέσα στο **AWS**.\
Αυτή η εμπιστοσύνη μπορεί να δώσει πρόσβαση σε έναν ρόλο με την ακόλουθη **trust policy**:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::<acc_id>:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
Αυτή η πολιτική εμπιστοσύνης μπορεί να είναι σωστή, αλλά η **έλλειψη περισσότερων συνθηκών** θα πρέπει να σας κάνει να την αμφισβητήσετε.\
Αυτό συμβαίνει επειδή ο προηγούμενος ρόλος μπορεί να αναληφθεί από **ΟΠΟΙΟΝΔΗΠΟΤΕ από Github Actions**! Θα πρέπει να καθορίσετε στις συνθήκες και άλλα πράγματα όπως το όνομα της οργάνωσης, το όνομα του αποθετηρίου, το περιβάλλον, το κλαδί...

Μια άλλη πιθανή εσφαλμένη διαμόρφωση είναι να **προσθέσετε μια συνθήκη** όπως η ακόλουθη:
```json
"StringLike": {
"token.actions.githubusercontent.com:sub": "repo:org_name*:*"
}
```
Note that **wildcard** (\*) before the **colon** (:). You can create an org such as **org\_name1** and **assume the role** from a Github Action.

## Αναφορές

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/](https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Δείτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
