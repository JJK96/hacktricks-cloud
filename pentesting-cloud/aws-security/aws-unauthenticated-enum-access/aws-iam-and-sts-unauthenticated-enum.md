# AWS - IAM & STS Unauthenticated Enum

{% hint style="success" %}
Jifunze na kufanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na kufanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}

## Tambua Majukumu & Majina ya Watumiaji katika akaunti

### ~~Assume Role Brute-Force~~

{% hint style="danger" %}
**Mbinu hii haifanyi kazi** tena kwani kama jukumu lipo au halipo unapata kosa hili kila wakati:

`An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::947247140022:user/testenv is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::429217632764:role/account-balanceasdas`

Unaweza **kujaribu hili kwa kuendesha**:

`aws sts assume-role --role-arn arn:aws:iam::412345678909:role/superadmin --role-session-name s3-access-example`
{% endhint %}

Kujaribu **kuchukua jukumu bila ruhusa zinazohitajika** husababisha ujumbe wa kosa wa AWS. Kwa mfano, ikiwa huna ruhusa, AWS inaweza kurudisha:
```ruby
An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::012345678901:user/MyUser is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::111111111111:role/aws-service-role/rds.amazonaws.com/AWSServiceRoleForRDS
```
Ujumbe huu unathibitisha uwepo wa jukumu lakini unaonyesha kuwa sera yake ya kudhani jukumu hairuhusu kudhani kwako. Kinyume chake, kujaribu **kudhani jukumu ambalo halipo husababisha kosa tofauti**:
```less
An error occurred (AccessDenied) when calling the AssumeRole operation: Not authorized to perform sts:AssumeRole
```
Kwa kuvutia, njia hii ya **kutofautisha kati ya majukumu yaliyopo na yasiyopo** inatumika hata katika akaunti tofauti za AWS. Ukiwa na kitambulisho halali cha akaunti ya AWS na orodha ya maneno lengwa, mtu anaweza kuorodhesha majukumu yaliyopo kwenye akaunti bila kukutana na vikwazo vyovyote vya asili.

Unaweza kutumia [script hii kuorodhesha principals zinazowezekana](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/assume\_role\_enum) kwa kutumia tatizo hili.

### Sera za Uaminifu: Brute-Force Cross Account roles na watumiaji

Kusanidi au kusasisha **sera ya uaminifu ya jukumu la IAM kunahusisha kufafanua ni rasilimali au huduma gani za AWS zinazoruhusiwa kuchukua jukumu hilo** na kupata hati za muda. Ikiwa rasilimali iliyotajwa kwenye sera **ipo**, sera ya uaminifu inaokolewa **kwa mafanikio**. Hata hivyo, ikiwa rasilimali **haipo**, **kosa linatolewa**, likionyesha kuwa principal batili ilitolewa.

{% hint style="warning" %}
Kumbuka kuwa kwenye rasilimali hiyo unaweza kutaja jukumu au mtumiaji wa akaunti tofauti:

* `arn:aws:iam::acc_id:role/role_name`
* `arn:aws:iam::acc_id:user/user_name`
{% endhint %}

Hii ni mfano wa sera:
```json
{
"Version":"2012-10-17",
"Statement":[
{
"Effect":"Allow",
"Principal":
{
"AWS":"arn:aws:iam::216825089941:role\/Test"
},
"Action":"sts:AssumeRole"
}
]
}
```
#### GUI

Hiyo ndiyo **kosa** utakayopata ikiwa utatumia **jukumu ambalo halipo**. Ikiwa jukumu **lipo**, sera ita**hifadhiwa** bila makosa yoyote. (Kosa ni kwa ajili ya kusasisha, lakini pia hufanya kazi wakati wa kuunda)

![](<../../../.gitbook/assets/image (153).png>)

#### CLI
```bash
### You could also use: aws iam update-assume-role-policy
# When it works
aws iam create-role --role-name Test-Role --assume-role-policy-document file://a.json
{
"Role": {
"Path": "/",
"RoleName": "Test-Role",
"RoleId": "AROA5ZDCUJS3DVEIYOB73",
"Arn": "arn:aws:iam::947247140022:role/Test-Role",
"CreateDate": "2022-05-03T20:50:04Z",
"AssumeRolePolicyDocument": {
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::316584767888:role/account-balance"
},
"Action": [
"sts:AssumeRole"
]
}
]
}
}
}

# When it doesn't work
aws iam create-role --role-name Test-Role2 --assume-role-policy-document file://a.json
An error occurred (MalformedPolicyDocument) when calling the CreateRole operation: Invalid principal in policy: "AWS":"arn:aws:iam::316584767888:role/account-balanceefd23f2"
```
Unaweza kuendesha mchakato huu kiotomatiki na [https://github.com/carlospolop/aws\_tools](https://github.com/carlospolop/aws\_tools)

* `bash unauth_iam.sh -t user -i 316584767888 -r TestRole -w ./unauth_wordlist.txt`

Au kutumia [Pacu](https://github.com/RhinoSecurityLabs/pacu):

* `run iam__enum_users --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* `run iam__enum_roles --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* Jukumu la `admin` lililotumika katika mfano ni **jukumu katika akaunti yako la kuigwa** na pacu ili kuunda sera inazohitaji kuunda kwa ajili ya orodha

### Privesc

Iwapo jukumu lilikuwa limewekwa vibaya na kuruhusu yeyote kulichukua:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
The attacker could just assume it.

## Third Party OIDC Federation

Fikiria kwamba umeweza kusoma **Github Actions workflow** ambayo inapata **role** ndani ya **AWS**.\
Hii imani inaweza kutoa ufikiaji kwa role yenye **trust policy** ifuatayo:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::<acc_id>:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
Sera hii ya uaminifu inaweza kuwa sahihi, lakini **ukosefu wa masharti zaidi** unapaswa kukufanya usiiamini.\
Hii ni kwa sababu jukumu la awali linaweza kuchukuliwa na **MTU YEYOTE kutoka Github Actions**! Unapaswa kubainisha katika masharti pia mambo mengine kama jina la shirika, jina la repo, env, tawi...

Hitilafu nyingine inayoweza kutokea ni **kuongeza sharti** kama ifuatavyo:
```json
"StringLike": {
"token.actions.githubusercontent.com:sub": "repo:org_name*:*"
}
```
Note that **wildcard** (\*) before the **colon** (:). You can create an org such as **org\_name1** and **assume the role** from a Github Action.

## Marejeo

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/](https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/)

{% hint style="success" %}
Jifunze na fanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na fanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
