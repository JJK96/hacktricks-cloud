# AWS - IAM & STS Unauthenticated Enum

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –ø–æ–¥–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}

## –ü–µ—Ä–µ–ª—ñ—á–µ–Ω–Ω—è —Ä–æ–ª–µ–π —Ç–∞ —ñ–º–µ–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –≤ –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—ñ

### ~~Assume Role Brute-Force~~

{% hint style="danger" %}
**–¶—è —Ç–µ—Ö–Ω—ñ–∫–∞ –±—ñ–ª—å—à–µ –Ω–µ –ø—Ä–∞—Ü—é—î**, –æ—Å–∫—ñ–ª—å–∫–∏ –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–æ–≥–æ, —á–∏ —ñ—Å–Ω—É—î —Ä–æ–ª—å, –≤–∏ –∑–∞–≤–∂–¥–∏ –æ—Ç—Ä–∏–º—É—î—Ç–µ —Ü—é –ø–æ–º–∏–ª–∫—É:

`An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::947247140022:user/testenv is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::429217632764:role/account-balanceasdas`

–í–∏ –º–æ–∂–µ—Ç–µ **–ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ü–µ, –∑–∞–ø—É—Å—Ç–∏–≤—à–∏**:

`aws sts assume-role --role-arn arn:aws:iam::412345678909:role/superadmin --role-session-name s3-access-example`
{% endhint %}

–°–ø—Ä–æ–±–∞ **–ø—Ä–∏–π–Ω—è—Ç–∏ —Ä–æ–ª—å –±–µ–∑ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –¥–æ–∑–≤–æ–ª—ñ–≤** –≤–∏–∫–ª–∏–∫–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É AWS. –ù–∞–ø—Ä–∏–∫–ª–∞–¥, —è–∫—â–æ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ, AWS –º–æ–∂–µ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏:
```ruby
An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::012345678901:user/MyUser is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::111111111111:role/aws-service-role/rds.amazonaws.com/AWSServiceRoleForRDS
```
–¶–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î —ñ—Å–Ω—É–≤–∞–Ω–Ω—è —Ä–æ–ª—ñ, –∞–ª–µ –≤–∫–∞–∑—É—î –Ω–∞ —Ç–µ, —â–æ —ó—ó –ø–æ–ª—ñ—Ç–∏–∫–∞ –ø—Ä–∏–π–Ω—è—Ç—Ç—è —Ä–æ–ª—ñ –Ω–µ –¥–æ–∑–≤–æ–ª—è—î –≤–∞–º —ó—ó –ø—Ä–∏–π–Ω—è—Ç–∏. –ù–∞ –≤—ñ–¥–º—ñ–Ω—É –≤—ñ–¥ —Ü—å–æ–≥–æ, —Å–ø—Ä–æ–±–∞ **–ø—Ä–∏–π–Ω—è—Ç–∏ –Ω–µ—ñ—Å–Ω—É—é—á—É —Ä–æ–ª—å –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ —ñ–Ω—à–æ—ó –ø–æ–º–∏–ª–∫–∏**:
```less
An error occurred (AccessDenied) when calling the AssumeRole operation: Not authorized to perform sts:AssumeRole
```
–¶—ñ–∫–∞–≤–æ, —â–æ —Ü–µ–π –º–µ—Ç–æ–¥ **—Ä–æ–∑—Ä—ñ–∑–Ω–µ–Ω–Ω—è –º—ñ–∂ —ñ—Å–Ω—É—é—á–∏–º–∏ —Ç–∞ –Ω–µ—ñ—Å–Ω—É—é—á–∏–º–∏ —Ä–æ–ª—è–º–∏** –∑–∞—Å—Ç–æ—Å–æ–≤–Ω–∏–π –Ω–∞–≤—ñ—Ç—å –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö AWS –∞–∫–∞—É–Ω—Ç—ñ–≤. –ú–∞—é—á–∏ –¥—ñ–π—Å–Ω–∏–π ID AWS –∞–∫–∞—É–Ω—Ç—É —Ç–∞ —Ü—ñ–ª—å–æ–≤–∏–π —Å–ª–æ–≤–Ω–∏–∫, –º–æ–∂–Ω–∞ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ —Ä–æ–ª—ñ, –ø—Ä–∏—Å—É—Ç–Ω—ñ –≤ –∞–∫–∞—É–Ω—Ç—ñ, –±–µ–∑ –±—É–¥—å-—è–∫–∏—Ö –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ—Ö –æ–±–º–µ–∂–µ–Ω—å.

–í–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü–µ–π [—Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞–Ω–Ω—è –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏—Ö principals](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/assume\_role\_enum), –∑–ª–æ–≤–∂–∏–≤–∞—é—á–∏ —Ü—ñ—î—é –ø—Ä–æ–±–ª–µ–º–æ—é.

### Trust Policies: Brute-Force Cross Account roles and users

–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞–±–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è **trust policy —Ä–æ–ª—ñ IAM –≤–∫–ª—é—á–∞—î –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è, —è–∫—ñ —Ä–µ—Å—É—Ä—Å–∏ –∞–±–æ —Å–µ—Ä–≤—ñ—Å–∏ AWS –º–∞—é—Ç—å –ø—Ä–∞–≤–æ –ø—Ä–∏–π–º–∞—Ç–∏ —Ü—é —Ä–æ–ª—å** —Ç–∞ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Ç–∏–º—á–∞—Å–æ–≤—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ. –Ø–∫—â–æ –≤–∫–∞–∑–∞–Ω–∏–π —Ä–µ—Å—É—Ä—Å —É –ø–æ–ª—ñ—Ç–∏—Ü—ñ **—ñ—Å–Ω—É—î**, trust policy –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è **—É—Å–ø—ñ—à–Ω–æ**. –û–¥–Ω–∞–∫, —è–∫—â–æ —Ä–µ—Å—É—Ä—Å **–Ω–µ —ñ—Å–Ω—É—î**, –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è **–ø–æ–º–∏–ª–∫–∞**, —â–æ –≤–∫–∞–∑—É—î –Ω–∞ —Ç–µ, —â–æ –±—É–ª–æ –Ω–∞–¥–∞–Ω–æ –Ω–µ–¥—ñ–π—Å–Ω–æ–≥–æ principal.

{% hint style="warning" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –≤ —Ü—å–æ–º—É —Ä–µ—Å—É—Ä—Å—ñ –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∫–∞–∑–∞—Ç–∏ —Ä–æ–ª—å –∞–±–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ —ñ–Ω—à–æ–≥–æ –∞–∫–∞—É–Ω—Ç—É:

* `arn:aws:iam::acc_id:role/role_name`
* `arn:aws:iam::acc_id:user/user_name`
{% endhint %}

–¶–µ –ø—Ä–∏–∫–ª–∞–¥ –ø–æ–ª—ñ—Ç–∏–∫–∏:
```json
{
"Version":"2012-10-17",
"Statement":[
{
"Effect":"Allow",
"Principal":
{
"AWS":"arn:aws:iam::216825089941:role\/Test"
},
"Action":"sts:AssumeRole"
}
]
}
```
#### GUI

–¶–µ **–ø–æ–º–∏–ª–∫–∞**, —è–∫—É –≤–∏ –∑–Ω–∞–π–¥–µ—Ç–µ, —è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ **—Ä–æ–ª—å, —è–∫–∞ –Ω–µ —ñ—Å–Ω—É—î**. –Ø–∫—â–æ —Ä–æ–ª—å **—ñ—Å–Ω—É—î**, –ø–æ–ª—ñ—Ç–∏–∫–∞ –±—É–¥–µ **–∑–±–µ—Ä–µ–∂–µ–Ω–∞** –±–µ–∑ –±—É–¥—å-—è–∫–∏—Ö –ø–æ–º–∏–ª–æ–∫. (–ü–æ–º–∏–ª–∫–∞ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è, –∞–ª–µ –≤–æ–Ω–∞ —Ç–∞–∫–æ–∂ –ø—Ä–∞—Ü—é—î –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ)

![](<../../../.gitbook/assets/image (153).png>)

#### CLI
```bash
### You could also use: aws iam update-assume-role-policy
# When it works
aws iam create-role --role-name Test-Role --assume-role-policy-document file://a.json
{
"Role": {
"Path": "/",
"RoleName": "Test-Role",
"RoleId": "AROA5ZDCUJS3DVEIYOB73",
"Arn": "arn:aws:iam::947247140022:role/Test-Role",
"CreateDate": "2022-05-03T20:50:04Z",
"AssumeRolePolicyDocument": {
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::316584767888:role/account-balance"
},
"Action": [
"sts:AssumeRole"
]
}
]
}
}
}

# When it doesn't work
aws iam create-role --role-name Test-Role2 --assume-role-policy-document file://a.json
An error occurred (MalformedPolicyDocument) when calling the CreateRole operation: Invalid principal in policy: "AWS":"arn:aws:iam::316584767888:role/account-balanceefd23f2"
```
–í–∏ –º–æ–∂–µ—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑—É–≤–∞—Ç–∏ —Ü–µ–π –ø—Ä–æ—Ü–µ—Å –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é [https://github.com/carlospolop/aws\_tools](https://github.com/carlospolop/aws\_tools)

* `bash unauth_iam.sh -t user -i 316584767888 -r TestRole -w ./unauth_wordlist.txt`

–ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ [Pacu](https://github.com/RhinoSecurityLabs/pacu):

* `run iam__enum_users --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* `run iam__enum_roles --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* –†–æ–ª—å `admin`, –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∞ –≤ –ø—Ä–∏–∫–ª–∞–¥—ñ, —î **—Ä–æ–ª–ª—é —É –≤–∞—à–æ–º—É –∞–∫–∞—É–Ω—Ç—ñ, —è–∫—É pacu –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏** –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ–ª—ñ—Ç–∏–∫, –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞–Ω–Ω—è

### Privesc

–£ –≤–∏–ø–∞–¥–∫—É, —è–∫—â–æ —Ä–æ–ª—å –±—É–ª–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∞ —ñ –¥–æ–∑–≤–æ–ª—è—î –±—É–¥—å-–∫–æ–º—É —ó—ó –ø—Ä–∏–π–Ω—è—Ç–∏:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
–ê—Ç–∞–∫—É–≤–∞–ª—å–Ω–∏–∫ –º–æ–∂–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–ø—É—Å—Ç–∏—Ç–∏ —Ü–µ.

## Third Party OIDC Federation

–£—è–≤—ñ—Ç—å, —â–æ –≤–∞–º –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ **Github Actions workflow**, —è–∫–∏–π –æ—Ç—Ä–∏–º—É—î –¥–æ—Å—Ç—É–ø –¥–æ **—Ä–æ–ª—ñ** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ **AWS**.\
–¶—è –¥–æ–≤—ñ—Ä–∞ –º–æ–∂–µ –Ω–∞–¥–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ä–æ–ª—ñ –∑ –Ω–∞—Å—Ç—É–ø–Ω–æ—é **trust policy**:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::<acc_id>:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
–¶—è –ø–æ–ª—ñ—Ç–∏–∫–∞ –¥–æ–≤—ñ—Ä–∏ –º–æ–∂–µ –±—É—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—é, –∞–ª–µ **–≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö —É–º–æ–≤** –ø–æ–≤–∏–Ω–Ω–∞ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ —É –≤–∞—Å –Ω–µ–¥–æ–≤—ñ—Ä—É.\
–¶–µ —Ç–æ–º—É, —â–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—é —Ä–æ–ª—å –º–æ–∂–µ –ø—Ä–∏–π–Ω—è—Ç–∏ **–ë–£–î–¨-–•–¢–û –∑ Github Actions**! –í–∏ –ø–æ–≤–∏–Ω–Ω—ñ –≤–∫–∞–∑–∞—Ç–∏ –≤ —É–º–æ–≤–∞—Ö —Ç–∞–∫–æ–∂ —ñ–Ω—à—ñ —Ä–µ—á—ñ, —Ç–∞–∫—ñ —è–∫ –Ω–∞–∑–≤–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó, –Ω–∞–∑–≤–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é, —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ, –≥—ñ–ª–∫–∞...

–©–µ –æ–¥–Ω—ñ—î—é –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ—é –ø–æ–º–∏–ª–∫–æ—é –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —î **–¥–æ–¥–∞–≤–∞–Ω–Ω—è —É–º–æ–≤–∏**, —è–∫ —É –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ:
```json
"StringLike": {
"token.actions.githubusercontent.com:sub": "repo:org_name*:*"
}
```
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É –Ω–∞ **wildcard** (\*) –ø–µ—Ä–µ–¥ **colon** (:). –í–∏ –º–æ–∂–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—é, —Ç–∞–∫—É —è–∫ **org\_name1**, —ñ **assume the role** –∑ Github Action.

## References

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/](https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/)

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**telegram group**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –ø–æ–¥–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤.

</details>
{% endhint %}
