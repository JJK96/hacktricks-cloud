# AWS - S3 Unauthenticated Enum

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## S3 Public Buckets

Ένας κάδος θεωρείται **“δημόσιος”** αν **οποιοσδήποτε χρήστης μπορεί να καταγράψει τα περιεχόμενα** του κάδου, και **“ιδιωτικός”** αν τα περιεχόμενα του κάδου μπορούν **να καταγραφούν ή να γραφτούν μόνο από συγκεκριμένους χρήστες**.

Οι εταιρείες μπορεί να έχουν **λανθασμένες ρυθμίσεις δικαιωμάτων κάδων** δίνοντας πρόσβαση είτε σε όλα είτε σε όλους τους αυθεντικοποιημένους χρήστες στο AWS σε οποιονδήποτε λογαριασμό (δηλαδή σε οποιονδήποτε). Σημειώστε ότι ακόμα και με τέτοιες λανθασμένες ρυθμίσεις, ορισμένες ενέργειες μπορεί να μην είναι δυνατές καθώς οι κάδοι μπορεί να έχουν τις δικές τους λίστες ελέγχου πρόσβασης (ACLs).

**Μάθετε για τις λανθασμένες ρυθμίσεις του AWS-S3 εδώ:** [**http://flaws.cloud**](http://flaws.cloud/) **και** [**http://flaws2.cloud/**](http://flaws2.cloud)

### Εύρεση AWS Buckets

Διάφορες μέθοδοι για να βρείτε πότε μια ιστοσελίδα χρησιμοποιεί AWS για την αποθήκευση κάποιων πόρων:

#### Enumeration & OSINT:

* Χρησιμοποιώντας το **wappalyzer** browser plugin
* Χρησιμοποιώντας το burp (**spidering** την ιστοσελίδα) ή με χειροκίνητη πλοήγηση μέσω της σελίδας, όλοι οι **πόροι** που **φορτώνονται** θα αποθηκευτούν στο Ιστορικό.
*   **Ελέγξτε για πόρους** σε τομείς όπως:

```
http://s3.amazonaws.com/[bucket_name]/
http://[bucket_name].s3.amazonaws.com/
```
* Ελέγξτε για **CNAMES** όπως `resources.domain.com` που μπορεί να έχουν το CNAME `bucket.s3.amazonaws.com`
* Ελέγξτε [https://buckets.grayhatwarfare.com](https://buckets.grayhatwarfare.com/), μια ιστοσελίδα με ήδη **ανακαλυφθέντες ανοιχτούς κάδους**.
* Το **όνομα του κάδου** και το **όνομα τομέα του κάδου** πρέπει να είναι **το ίδιο.**
* **flaws.cloud** είναι στην **IP** 52.92.181.107 και αν πάτε εκεί, σας ανακατευθύνει στο [https://aws.amazon.com/s3/](https://aws.amazon.com/s3/). Επίσης, `dig -x 52.92.181.107` δίνει `s3-website-us-west-2.amazonaws.com`.
* Για να ελέγξετε αν είναι κάδος, μπορείτε επίσης να **επισκεφθείτε** [https://flaws.cloud.s3.amazonaws.com/](https://flaws.cloud.s3.amazonaws.com/).

#### Brute-Force

Μπορείτε να βρείτε κάδους με **brute-forcing ονομάτων** που σχετίζονται με την εταιρεία που κάνετε pentesting:

* [https://github.com/sa7mon/S3Scanner](https://github.com/sa7mon/S3Scanner)
* [https://github.com/clario-tech/s3-inspector](https://github.com/clario-tech/s3-inspector)
* [https://github.com/jordanpotti/AWSBucketDump](https://github.com/jordanpotti/AWSBucketDump) (Περιέχει μια λίστα με πιθανά ονόματα κάδων)
* [https://github.com/fellchase/flumberboozle/tree/master/flumberbuckets](https://github.com/fellchase/flumberboozle/tree/master/flumberbuckets)
* [https://github.com/smaranchand/bucky](https://github.com/smaranchand/bucky)
* [https://github.com/tomdev/teh\_s3\_bucketeers](https://github.com/tomdev/teh\_s3\_bucketeers)
* [https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/s3](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/s3)
* [https://github.com/Eilonh/s3crets\_scanner](https://github.com/Eilonh/s3crets\_scanner)
* [https://github.com/belane/CloudHunter](https://github.com/belane/CloudHunter)

<pre class="language-bash"><code class="lang-bash"># Δημιουργήστε μια λίστα λέξεων για να δημιουργήσετε συνδυασμούς
curl -s https://raw.githubusercontent.com/cujanovic/goaltdns/master/words.txt > /tmp/words-s3.txt.temp
curl -s https://raw.githubusercontent.com/jordanpotti/AWSBucketDump/master/BucketNames.txt >>/tmp/words-s3.txt.temp
cat /tmp/words-s3.txt.temp | sort -u > /tmp/words-s3.txt

# Δημιουργήστε μια λίστα λέξεων βασισμένη στους τομείς και υποτομείς για δοκιμή
## Γράψτε αυτούς τους τομείς και υποτομείς στο subdomains.txt
cat subdomains.txt > /tmp/words-hosts-s3.txt
cat subdomains.txt | tr "." "-" >> /tmp/words-hosts-s3.txt
cat subdomains.txt | tr "." "\n" | sort -u >> /tmp/words-hosts-s3.txt

# Δημιουργήστε συνδυασμούς βασισμένους σε μια λίστα με τους τομείς και υποτομείς για επίθεση
goaltdns -l /tmp/words-hosts-s3.txt -w /tmp/words-s3.txt -o /tmp/final-words-s3.txt.temp
## Το προηγούμενο εργαλείο είναι εξειδικευμένο στη δημιουργία συνδυασμών για υποτομείς, ας φιλτράρουμε αυτή τη λίστα
<strong>### Αφαιρέστε γραμμές που τελειώνουν με "."
</strong>cat /tmp/final-words-s3.txt.temp | grep -Ev "\.$" > /tmp/final-words-s3.txt.temp2
### Δημιουργήστε λίστα χωρίς TLD
cat /tmp/final-words-s3.txt.temp2 | sed -E 's/\.[a-zA-Z0-9]+$//' > /tmp/final-words-s3.txt.temp3
### Δημιουργήστε λίστα χωρίς τελείες
cat /tmp/final-words-s3.txt.temp3 | tr -d "." > /tmp/final-words-s3.txt.temp4http://phantom.s3.amazonaws.com/
### Δημιουργήστε λίστα χωρίς παύλες
cat /tmp/final-words-s3.txt.temp3 | tr "." "-" > /tmp/final-words-s3.txt.temp5

## Δημιουργήστε την τελική λίστα λέξεων
cat /tmp/final-words-s3.txt.temp2 /tmp/final-words-s3.txt.temp3 /tmp/final-words-s3.txt.temp4 /tmp/final-words-s3.txt.temp5 | grep -v -- "-\." | awk '{print tolower($0)}' | sort -u > /tmp/final-words-s3.txt

## Καλέστε το s3scanner
s3scanner --threads 100 scan --buckets-file /tmp/final-words-s3.txt  | grep bucket_exists
</code></pre>

#### Loot S3 Buckets

Δεδομένων των ανοιχτών κάδων S3, το [**BucketLoot**](https://github.com/redhuntlabs/BucketLoot) μπορεί αυτόματα να **αναζητήσει ενδιαφέρουσες πληροφορίες**.

### Εύρεση της Περιοχής

Μπορείτε να βρείτε όλες τις υποστηριζόμενες περιοχές από το AWS στο [**https://docs.aws.amazon.com/general/latest/gr/s3.html**](https://docs.aws.amazon.com/general/latest/gr/s3.html)

#### Με DNS

Μπορείτε να βρείτε την περιοχή ενός κάδου με **`dig`** και **`nslookup`** κάνοντας ένα **αίτημα DNS της ανακαλυφθείσας IP**:
```bash
dig flaws.cloud
;; ANSWER SECTION:
flaws.cloud.    5    IN    A    52.218.192.11

nslookup 52.218.192.11
Non-authoritative answer:
11.192.218.52.in-addr.arpa name = s3-website-us-west-2.amazonaws.com.
```
Ελέγξτε ότι ο επιλυμένος τομέας έχει τη λέξη "website".\
Μπορείτε να αποκτήσετε πρόσβαση στον στατικό ιστότοπο πηγαίνοντας στο: `flaws.cloud.s3-website-us-west-2.amazonaws.com`\
ή μπορείτε να αποκτήσετε πρόσβαση στον κάδο επισκεπτόμενοι: `flaws.cloud.s3-us-west-2.amazonaws.com`

#### Δοκιμάζοντας

Αν προσπαθήσετε να αποκτήσετε πρόσβαση σε έναν κάδο, αλλά στο **όνομα τομέα καθορίσετε άλλη περιοχή** (για παράδειγμα ο κάδος είναι στο `bucket.s3.amazonaws.com` αλλά προσπαθείτε να αποκτήσετε πρόσβαση στο `bucket.s3-website-us-west-2.amazonaws.com`, τότε θα **καθοδηγηθείτε στη σωστή τοποθεσία**:

![](<../../../.gitbook/assets/image (106).png>)

### Καταμέτρηση του κάδου

Για να δοκιμάσετε την ανοιχτότητα του κάδου, ένας χρήστης μπορεί απλά να εισάγει το URL στον περιηγητή του. Ένας ιδιωτικός κάδος θα απαντήσει με "Access Denied". Ένας δημόσιος κάδος θα καταγράψει τα πρώτα 1.000 αντικείμενα που έχουν αποθηκευτεί.

Ανοιχτό για όλους:

![](<../../../.gitbook/assets/image (201).png>)

Ιδιωτικό:

![](<../../../.gitbook/assets/image (83).png>)

Μπορείτε επίσης να το ελέγξετε με το cli:
```bash
#Use --no-sign-request for check Everyones permissions
#Use --profile <PROFILE_NAME> to indicate the AWS profile(keys) that youwant to use: Check for "Any Authenticated AWS User" permissions
#--recursive if you want list recursivelyls
#Opcionally you can select the region if you now it
aws s3 ls s3://flaws.cloud/ [--no-sign-request] [--profile <PROFILE_NAME>] [ --recursive] [--region us-west-2]
```
Αν ο κάδος δεν έχει όνομα τομέα, όταν προσπαθείτε να τον απαριθμήσετε, **βάλτε μόνο το όνομα του κάδου** και όχι ολόκληρο το AWSs3 domain. Παράδειγμα: `s3://<BUCKETNAME>`

### Δημόσιο πρότυπο URL
```
https://{user_provided}.s3.amazonaws.com
```
### Λήψη ID Λογαριασμού από δημόσιο Bucket

Είναι δυνατό να προσδιοριστεί ένας λογαριασμός AWS εκμεταλλευόμενοι το νέο **`S3:ResourceAccount`** **Policy Condition Key**. Αυτή η συνθήκη **περιορίζει την πρόσβαση με βάση το S3 bucket** στο οποίο βρίσκεται ένας λογαριασμός (άλλες πολιτικές βασισμένες σε λογαριασμούς περιορίζουν με βάση τον λογαριασμό στον οποίο βρίσκεται ο αιτών).\
Και επειδή η πολιτική μπορεί να περιέχει **wildcards** είναι δυνατό να βρεθεί ο αριθμός λογαριασμού **ένα ψηφίο τη φορά**.

Αυτό το εργαλείο αυτοματοποιεί τη διαδικασία:
```bash
# Installation
pipx install s3-account-search
pip install s3-account-search
# With a bucket
s3-account-search arn:aws:iam::123456789012:role/s3_read s3://my-bucket
# With an object
s3-account-search arn:aws:iam::123456789012:role/s3_read s3://my-bucket/path/to/object.ext
```
Αυτή η τεχνική λειτουργεί επίσης με API Gateway URLs, Lambda URLs, Data Exchange data sets και ακόμη και για να λάβετε την τιμή των tags (αν γνωρίζετε το tag key). Μπορείτε να βρείτε περισσότερες πληροφορίες στην [**αρχική έρευνα**](https://blog.plerion.com/conditional-love-for-aws-metadata-enumeration/) και το εργαλείο [**conditional-love**](https://github.com/plerionhq/conditional-love/) για την αυτοματοποίηση αυτής της εκμετάλλευσης.

### Επιβεβαίωση ότι ένας bucket ανήκει σε έναν AWS λογαριασμό

Όπως εξηγείται σε [**αυτή την ανάρτηση στο blog**](https://blog.plerion.com/things-you-wish-you-didnt-need-to-know-about-s3/)**, αν έχετε δικαιώματα να καταχωρίσετε έναν bucket** είναι δυνατό να επιβεβαιώσετε ένα accountID στο οποίο ανήκει ο bucket στέλνοντας ένα αίτημα όπως:
```bash
curl -X GET "[bucketname].amazonaws.com/" \
-H "x-amz-expected-bucket-owner: [correct-account-id]"

<?xml version="1.0" encoding="UTF-8"?>
<ListBucketResult xmlns="http://s3.amazonaws.com/doc/2006-03-01/">...</ListBucketResult>
```
If the error is an “Access Denied” it means that the account ID was wrong.

### Used Emails as root account enumeration

Όπως εξηγείται σε [**αυτό το blog post**](https://blog.plerion.com/things-you-wish-you-didnt-need-to-know-about-s3/), είναι δυνατό να ελέγξετε αν μια διεύθυνση email σχετίζεται με οποιονδήποτε AWS account **προσπαθώντας να παραχωρήσετε δικαιώματα email** σε ένα S3 bucket μέσω ACLs. Αν αυτό δεν προκαλέσει σφάλμα, σημαίνει ότι το email είναι root user κάποιου AWS account:
```python
s3_client.put_bucket_acl(
Bucket=bucket_name,
AccessControlPolicy={
'Grants': [
{
'Grantee': {
'EmailAddress': 'some@emailtotest.com',
'Type': 'AmazonCustomerByEmail',
},
'Permission': 'READ'
},
],
'Owner': {
'DisplayName': 'Whatever',
'ID': 'c3d78ab5093a9ab8a5184de715d409c2ab5a0e2da66f08c2f6cc5c0bdeadbeef'
}
}
)
```
## Αναφορές

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://cloudar.be/awsblog/finding-the-account-id-of-any-public-s3-bucket/](https://cloudar.be/awsblog/finding-the-account-id-of-any-public-s3-bucket/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Δείτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
