# AWS - S3 Unauthenticated Enum

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## S3 Public Buckets

Bir bucket, **herhangi bir kullanıcının içeriği listeleyebilmesi** durumunda **“public”** olarak kabul edilir ve bucket'ın içeriği **yalnızca belirli kullanıcılar tarafından listelenebilir veya yazılabilir** ise **“private”** olarak kabul edilir.

Şirketler, **bucket izinlerini yanlış yapılandırarak** ya her şeye ya da AWS'de herhangi bir hesaba kimliği doğrulanmış herkese (yani herkese) erişim verebilir. Bu tür yanlış yapılandırmalarla bile bazı eylemler gerçekleştirilemeyebilir çünkü bucket'lar kendi erişim kontrol listelerine (ACL'ler) sahip olabilir.

**AWS-S3 yanlış yapılandırmaları hakkında bilgi edinin:** [**http://flaws.cloud**](http://flaws.cloud/) **ve** [**http://flaws2.cloud/**](http://flaws2.cloud)

### AWS Buckets Bulma

Bir web sayfasının bazı kaynakları depolamak için AWS kullandığını bulmak için farklı yöntemler:

#### Enumeration & OSINT:

* **wappalyzer** tarayıcı eklentisini kullanarak
* burp kullanarak (**web'i tarayarak**) veya sayfada manuel olarak gezerek tüm **yüklenen kaynaklar** Geçmişte kaydedilecektir.
*   **Kaynakları** şu alan adlarında kontrol edin:

```
http://s3.amazonaws.com/[bucket_name]/
http://[bucket_name].s3.amazonaws.com/
```
* `resources.domain.com` gibi CNAMES'leri kontrol edin, `bucket.s3.amazonaws.com` CNAME'ine sahip olabilir.
* [https://buckets.grayhatwarfare.com](https://buckets.grayhatwarfare.com/), zaten **keşfedilmiş açık bucket'ların** bulunduğu bir web sitesidir.
* **bucket adı** ve **bucket alan adı** **aynı** olmalıdır.
* **flaws.cloud** IP'si 52.92.181.107'dir ve oraya giderseniz sizi [https://aws.amazon.com/s3/](https://aws.amazon.com/s3/) adresine yönlendirir. Ayrıca, `dig -x 52.92.181.107` `s3-website-us-west-2.amazonaws.com` verir.
* Bir bucket olduğunu kontrol etmek için [https://flaws.cloud.s3.amazonaws.com/](https://flaws.cloud.s3.amazonaws.com/) adresini de ziyaret edebilirsiniz.

#### Brute-Force

Pentesting yaptığınız şirketle ilgili adları **brute-forcing** yaparak bucket'ları bulabilirsiniz:

* [https://github.com/sa7mon/S3Scanner](https://github.com/sa7mon/S3Scanner)
* [https://github.com/clario-tech/s3-inspector](https://github.com/clario-tech/s3-inspector)
* [https://github.com/jordanpotti/AWSBucketDump](https://github.com/jordanpotti/AWSBucketDump) (Potansiyel bucket adları içeren bir liste içerir)
* [https://github.com/fellchase/flumberboozle/tree/master/flumberbuckets](https://github.com/fellchase/flumberboozle/tree/master/flumberbuckets)
* [https://github.com/smaranchand/bucky](https://github.com/smaranchand/bucky)
* [https://github.com/tomdev/teh\_s3\_bucketeers](https://github.com/tomdev/teh\_s3\_bucketeers)
* [https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/s3](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/s3)
* [https://github.com/Eilonh/s3crets\_scanner](https://github.com/Eilonh/s3crets\_scanner)
* [https://github.com/belane/CloudHunter](https://github.com/belane/CloudHunter)

<pre class="language-bash"><code class="lang-bash"># Permütasyonlar oluşturmak için bir wordlist oluşturun
curl -s https://raw.githubusercontent.com/cujanovic/goaltdns/master/words.txt > /tmp/words-s3.txt.temp
curl -s https://raw.githubusercontent.com/jordanpotti/AWSBucketDump/master/BucketNames.txt >>/tmp/words-s3.txt.temp
cat /tmp/words-s3.txt.temp | sort -u > /tmp/words-s3.txt

# Test etmek için alan adlarına ve alt alan adlarına dayalı bir wordlist oluşturun
## Bu alan adlarını ve alt alan adlarını subdomains.txt dosyasına yazın
cat subdomains.txt > /tmp/words-hosts-s3.txt
cat subdomains.txt | tr "." "-" >> /tmp/words-hosts-s3.txt
cat subdomains.txt | tr "." "\n" | sort -u >> /tmp/words-hosts-s3.txt

# Saldırılacak alan adları ve alt alan adları listesine dayalı permütasyonlar oluşturun
goaltdns -l /tmp/words-hosts-s3.txt -w /tmp/words-s3.txt -o /tmp/final-words-s3.txt.temp
## Önceki araç alt alan adları için permütasyonlar oluşturmada uzmanlaşmıştır, bu listeyi filtreleyelim
<strong>### "." ile biten satırları kaldırın
</strong>cat /tmp/final-words-s3.txt.temp | grep -Ev "\.$" > /tmp/final-words-s3.txt.temp2
### TLD olmadan liste oluşturun
cat /tmp/final-words-s3.txt.temp2 | sed -E 's/\.[a-zA-Z0-9]+$//' > /tmp/final-words-s3.txt.temp3
### Noktasız liste oluşturun
cat /tmp/final-words-s3.txt.temp3 | tr -d "." > /tmp/final-words-s3.txt.temp4http://phantom.s3.amazonaws.com/
### Tire olmadan liste oluşturun
cat /tmp/final-words-s3.txt.temp3 | tr "." "-" > /tmp/final-words-s3.txt.temp5

## Nihai wordlist'i oluşturun
cat /tmp/final-words-s3.txt.temp2 /tmp/final-words-s3.txt.temp3 /tmp/final-words-s3.txt.temp4 /tmp/final-words-s3.txt.temp5 | grep -v -- "-\." | awk '{print tolower($0)}' | sort -u > /tmp/final-words-s3.txt

## s3scanner'ı çağırın
s3scanner --threads 100 scan --buckets-file /tmp/final-words-s3.txt  | grep bucket_exists
</code></pre>

#### Loot S3 Buckets

Açık S3 bucket'ları verildiğinde, [**BucketLoot**](https://github.com/redhuntlabs/BucketLoot) otomatik olarak **ilginç bilgileri arayabilir**.

### Bölgeyi Bulma

AWS tarafından desteklenen tüm bölgeleri [**https://docs.aws.amazon.com/general/latest/gr/s3.html**](https://docs.aws.amazon.com/general/latest/gr/s3.html) adresinde bulabilirsiniz.

#### DNS ile

Keşfedilen IP'nin **DNS isteği** yaparak bir bucket'ın bölgesini **`dig`** ve **`nslookup`** ile alabilirsiniz:
```bash
dig flaws.cloud
;; ANSWER SECTION:
flaws.cloud.    5    IN    A    52.218.192.11

nslookup 52.218.192.11
Non-authoritative answer:
11.192.218.52.in-addr.arpa name = s3-website-us-west-2.amazonaws.com.
```
Çözümlenen alan adında "website" kelimesinin olup olmadığını kontrol edin.\
Statik web sitesine şu adresten erişebilirsiniz: `flaws.cloud.s3-website-us-west-2.amazonaws.com`\
veya bucket'a şu adresten erişebilirsiniz: `flaws.cloud.s3-us-west-2.amazonaws.com`

#### Deneyerek

Bir bucket'a erişmeye çalışırsanız, ancak **alan adında başka bir bölge belirtirseniz** (örneğin, bucket `bucket.s3.amazonaws.com`'da ama siz `bucket.s3-website-us-west-2.amazonaws.com`'a erişmeye çalışırsanız), o zaman **doğru konuma yönlendirilirsiniz**:

![](<../../../.gitbook/assets/image (106).png>)

### Bucket'ı Numaralandırma

Bir kullanıcının bucket'ın açıklığını test etmesi için URL'yi web tarayıcısına girmesi yeterlidir. Özel bir bucket "Access Denied" yanıtı verecektir. Herkese açık bir bucket, depolanan ilk 1.000 nesneyi listeleyecektir.

Herkese açık:

![](<../../../.gitbook/assets/image (201).png>)

Özel:

![](<../../../.gitbook/assets/image (83).png>)

Bunu cli ile de kontrol edebilirsiniz:
```bash
#Use --no-sign-request for check Everyones permissions
#Use --profile <PROFILE_NAME> to indicate the AWS profile(keys) that youwant to use: Check for "Any Authenticated AWS User" permissions
#--recursive if you want list recursivelyls
#Opcionally you can select the region if you now it
aws s3 ls s3://flaws.cloud/ [--no-sign-request] [--profile <PROFILE_NAME>] [ --recursive] [--region us-west-2]
```
Eğer bucket bir domain adına sahip değilse, onu enumerate etmeye çalışırken, **sadece bucket adını** koyun, tüm AWSs3 domainini değil. Örnek: `s3://<BUCKETNAME>`

### Public URL şablonu
```
https://{user_provided}.s3.amazonaws.com
```
### Get Account ID from public Bucket

Bir AWS hesabını belirlemek, yeni **`S3:ResourceAccount`** **Policy Condition Key**'den yararlanarak mümkündür. Bu koşul, **bir hesabın bulunduğu S3 bucket'a dayalı olarak erişimi kısıtlar** (diğer hesap tabanlı politikalar, istekte bulunan prensipin bulunduğu hesaba dayalı olarak kısıtlar).\
Ve politika **wildcards** içerebileceği için, hesap numarasını **sadece birer birer** bulmak mümkündür.

Bu araç süreci otomatikleştirir:
```bash
# Installation
pipx install s3-account-search
pip install s3-account-search
# With a bucket
s3-account-search arn:aws:iam::123456789012:role/s3_read s3://my-bucket
# With an object
s3-account-search arn:aws:iam::123456789012:role/s3_read s3://my-bucket/path/to/object.ext
```
Bu teknik, API Gateway URL'leri, Lambda URL'leri, Data Exchange veri setleri ve hatta etiketlerin değerlerini almak için de çalışır (eğer etiket anahtarını biliyorsanız). Daha fazla bilgiyi [**orijinal araştırmada**](https://blog.plerion.com/conditional-love-for-aws-metadata-enumeration/) ve bu istismarı otomatikleştirmek için [**conditional-love**](https://github.com/plerionhq/conditional-love/) aracında bulabilirsiniz.

### Bir bucket'ın bir AWS hesabına ait olduğunu doğrulama

[**Bu blog yazısında**](https://blog.plerion.com/things-you-wish-you-didnt-need-to-know-about-s3/) açıklandığı gibi, **bir bucket'ı listeleme izinleriniz varsa**, aşağıdaki gibi bir istek göndererek bucket'ın ait olduğu accountID'yi doğrulamak mümkündür:
```bash
curl -X GET "[bucketname].amazonaws.com/" \
-H "x-amz-expected-bucket-owner: [correct-account-id]"

<?xml version="1.0" encoding="UTF-8"?>
<ListBucketResult xmlns="http://s3.amazonaws.com/doc/2006-03-01/">...</ListBucketResult>
```
Eğer hata “Access Denied” ise, bu hesap kimliğinin yanlış olduğu anlamına gelir.

### Kök hesap numaralandırma olarak kullanılan e-postalar

[**Bu blog yazısında**](https://blog.plerion.com/things-you-wish-you-didnt-need-to-know-about-s3/) açıklandığı gibi, bir e-posta adresinin herhangi bir AWS hesabıyla ilişkili olup olmadığını, bir S3 bucket üzerinde ACL'ler aracılığıyla **bir e-postaya izin vermeye çalışarak** kontrol etmek mümkündür. Eğer bu bir hata tetiklemiyorsa, bu e-postanın bazı AWS hesaplarının kök kullanıcısı olduğu anlamına gelir:
```python
s3_client.put_bucket_acl(
Bucket=bucket_name,
AccessControlPolicy={
'Grants': [
{
'Grantee': {
'EmailAddress': 'some@emailtotest.com',
'Type': 'AmazonCustomerByEmail',
},
'Permission': 'READ'
},
],
'Owner': {
'DisplayName': 'Whatever',
'ID': 'c3d78ab5093a9ab8a5184de715d409c2ab5a0e2da66f08c2f6cc5c0bdeadbeef'
}
}
)
```
## Referanslar

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://cloudar.be/awsblog/finding-the-account-id-of-any-public-s3-bucket/](https://cloudar.be/awsblog/finding-the-account-id-of-any-public-s3-bucket/)

{% hint style="success" %}
AWS Hacking öğren ve pratik yap:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğren ve pratik yap: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekle</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol et!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katıl veya bizi **Twitter**'da takip et 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek hacking ipuçlarını paylaş.

</details>
{% endhint %}
