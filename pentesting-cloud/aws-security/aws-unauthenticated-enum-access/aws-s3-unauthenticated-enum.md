# AWS - S3 Unauthenticated Enum

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repo's.

</details>
{% endhint %}

## S3 Publieke Buckets

'n Bucket word as **‚Äúpubliek‚Äù** beskou as **enige gebruiker die inhoud** van die bucket kan lys, en **‚Äúprivaat‚Äù** as die inhoud van die bucket **slegs deur sekere gebruikers gelys of geskryf kan word**.

Maatskappye mag **bucket-permissies verkeerd gekonfigureer** h√™ wat toegang gee √≥f tot alles √≥f tot almal wat in AWS in enige rekening geverifieer is (dus tot enigiemand). Let daarop dat selfs met sulke verkeerde konfigurasies sommige aksies dalk nie uitgevoer kan word nie, aangesien buckets hul eie toegangbeheerlyste (ACL's) mag h√™.

**Leer oor AWS-S3 verkeerde konfigurasie hier:** [**http://flaws.cloud**](http://flaws.cloud/) **en** [**http://flaws2.cloud/**](http://flaws2.cloud)

### Vind AWS Buckets

Verskillende metodes om te vind wanneer 'n webblad AWS gebruik om sommige hulpbronne te stoor:

#### Enumerasie & OSINT:

* Gebruik **wappalyzer** blaaier-inprop
* Gebruik burp (**spidering** die web) of deur handmatig deur die bladsy te navigeer, sal alle **hulpbronne** wat **gelaai** word in die Geskiedenis gestoor word.
*   **Kyk vir hulpbronne** in domeine soos:

```
http://s3.amazonaws.com/[bucket_name]/
http://[bucket_name].s3.amazonaws.com/
```
* Kyk vir **CNAMES** soos `resources.domain.com` mag die CNAME `bucket.s3.amazonaws.com` h√™
* Kyk [https://buckets.grayhatwarfare.com](https://buckets.grayhatwarfare.com/), 'n web met reeds **ontdekte oop buckets**.
* Die **bucket naam** en die **bucket domein naam** moet **dieselfde wees.**
* **flaws.cloud** is in **IP** 52.92.181.107 en as jy daarheen gaan, herlei dit jou na [https://aws.amazon.com/s3/](https://aws.amazon.com/s3/). Ook, `dig -x 52.92.181.107` gee `s3-website-us-west-2.amazonaws.com`.
* Om te kyk of dit 'n bucket is, kan jy ook **besoek** [https://flaws.cloud.s3.amazonaws.com/](https://flaws.cloud.s3.amazonaws.com/).

#### Brute-Force

Jy kan buckets vind deur **name te brute-force** wat verband hou met die maatskappy wat jy pentest:

* [https://github.com/sa7mon/S3Scanner](https://github.com/sa7mon/S3Scanner)
* [https://github.com/clario-tech/s3-inspector](https://github.com/clario-tech/s3-inspector)
* [https://github.com/jordanpotti/AWSBucketDump](https://github.com/jordanpotti/AWSBucketDump) (Bevat 'n lys met potensi√´le bucket name)
* [https://github.com/fellchase/flumberboozle/tree/master/flumberbuckets](https://github.com/fellchase/flumberboozle/tree/master/flumberbuckets)
* [https://github.com/smaranchand/bucky](https://github.com/smaranchand/bucky)
* [https://github.com/tomdev/teh\_s3\_bucketeers](https://github.com/tomdev/teh\_s3\_bucketeers)
* [https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/s3](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/s3)
* [https://github.com/Eilonh/s3crets\_scanner](https://github.com/Eilonh/s3crets\_scanner)
* [https://github.com/belane/CloudHunter](https://github.com/belane/CloudHunter)

<pre class="language-bash"><code class="lang-bash"># Genereer 'n woordlys om permutasies te skep
curl -s https://raw.githubusercontent.com/cujanovic/goaltdns/master/words.txt > /tmp/words-s3.txt.temp
curl -s https://raw.githubusercontent.com/jordanpotti/AWSBucketDump/master/BucketNames.txt >>/tmp/words-s3.txt.temp
cat /tmp/words-s3.txt.temp | sort -u > /tmp/words-s3.txt

# Genereer 'n woordlys gebaseer op die domeine en subdomeine om te toets
## Skryf daardie domeine en subdomeine in subdomains.txt
cat subdomains.txt > /tmp/words-hosts-s3.txt
cat subdomains.txt | tr "." "-" >> /tmp/words-hosts-s3.txt
cat subdomains.txt | tr "." "\n" | sort -u >> /tmp/words-hosts-s3.txt

# Skep permutasies gebaseer op 'n lys met die domeine en subdomeine om aan te val
goaltdns -l /tmp/words-hosts-s3.txt -w /tmp/words-s3.txt -o /tmp/final-words-s3.txt.temp
## Die vorige hulpmiddel is gespesialiseerd in die skep van permutasies vir subdomeine, laat ons daardie lys filter
<strong>### Verwyder re√´ls wat eindig met "."
</strong>cat /tmp/final-words-s3.txt.temp | grep -Ev "\.$" > /tmp/final-words-s3.txt.temp2
### Skep lys sonder TLD
cat /tmp/final-words-s3.txt.temp2 | sed -E 's/\.[a-zA-Z0-9]+$//' > /tmp/final-words-s3.txt.temp3
### Skep lys sonder kolletjies
cat /tmp/final-words-s3.txt.temp3 | tr -d "." > /tmp/final-words-s3.txt.temp4http://phantom.s3.amazonaws.com/
### Skep lys sonder koppeltekens
cat /tmp/final-words-s3.txt.temp3 | tr "." "-" > /tmp/final-words-s3.txt.temp5

## Genereer die finale woordlys
cat /tmp/final-words-s3.txt.temp2 /tmp/final-words-s3.txt.temp3 /tmp/final-words-s3.txt.temp4 /tmp/final-words-s3.txt.temp5 | grep -v -- "-\." | awk '{print tolower($0)}' | sort -u > /tmp/final-words-s3.txt

## Roep s3scanner
s3scanner --threads 100 scan --buckets-file /tmp/final-words-s3.txt  | grep bucket_exists
</code></pre>

#### Plunder S3 Buckets

Gegewe S3 oop buckets, kan [**BucketLoot**](https://github.com/redhuntlabs/BucketLoot) outomaties **soek na interessante inligting**.

### Vind die Streek

Jy kan al die ondersteunde streke deur AWS vind by [**https://docs.aws.amazon.com/general/latest/gr/s3.html**](https://docs.aws.amazon.com/general/latest/gr/s3.html)

#### Deur DNS

Jy kan die streek van 'n bucket kry met 'n **`dig`** en **`nslookup`** deur 'n **DNS-versoek van die ontdekte IP** te doen:
```bash
dig flaws.cloud
;; ANSWER SECTION:
flaws.cloud.    5    IN    A    52.218.192.11

nslookup 52.218.192.11
Non-authoritative answer:
11.192.218.52.in-addr.arpa name = s3-website-us-west-2.amazonaws.com.
```
Kyk of die opgeloste domein die woord "website" bevat.\
Jy kan toegang kry tot die statiese webwerf deur te gaan na: `flaws.cloud.s3-website-us-west-2.amazonaws.com`\
of jy kan die emmer besoek deur te gaan na: `flaws.cloud.s3-us-west-2.amazonaws.com`

#### Deur te Probeer

As jy probeer om toegang tot 'n emmer te kry, maar in die **domeinnaam 'n ander streek spesifiseer** (byvoorbeeld die emmer is in `bucket.s3.amazonaws.com` maar jy probeer toegang kry tot `bucket.s3-website-us-west-2.amazonaws.com`, dan sal jy **na die korrekte ligging verwys word**:

![](<../../../.gitbook/assets/image (106).png>)

### Emmer Enumerasie

Om die oopheid van die emmer te toets, kan 'n gebruiker net die URL in hul webblaaier invoer. 'n Privaat emmer sal reageer met "Access Denied". 'n Publieke emmer sal die eerste 1,000 voorwerpe wat gestoor is, lys.

Oop vir almal:

![](<../../../.gitbook/assets/image (201).png>)

Privaat:

![](<../../../.gitbook/assets/image (83).png>)

Jy kan dit ook met die cli nagaan:
```bash
#Use --no-sign-request for check Everyones permissions
#Use --profile <PROFILE_NAME> to indicate the AWS profile(keys) that youwant to use: Check for "Any Authenticated AWS User" permissions
#--recursive if you want list recursivelyls
#Opcionally you can select the region if you now it
aws s3 ls s3://flaws.cloud/ [--no-sign-request] [--profile <PROFILE_NAME>] [ --recursive] [--region us-west-2]
```
As die emmer nie 'n domeinnaam het nie, wanneer jy probeer om dit te enumereer, **sit slegs die emmernaam** en nie die hele AWSs3-domein nie. Voorbeeld: `s3://<BUCKETNAME>`

### Publieke URL-sjabloon
```
https://{user_provided}.s3.amazonaws.com
```
### Kry Rekening-ID van publieke Emmer

Dit is moontlik om 'n AWS-rekening te bepaal deur gebruik te maak van die nuwe **`S3:ResourceAccount`** **Beleidstoestand Sleutel**. Hierdie toestand **beperk toegang gebaseer op die S3-emmer** waarin 'n rekening is (ander rekeninggebaseerde beleide beperk gebaseer op die rekening waarin die versoekende prinsipaal is).\
En omdat die beleid **wildcards** kan bevat, is dit moontlik om die rekeningnommer **net een nommer op 'n slag** te vind.

Hierdie hulpmiddel outomatiseer die proses:
```bash
# Installation
pipx install s3-account-search
pip install s3-account-search
# With a bucket
s3-account-search arn:aws:iam::123456789012:role/s3_read s3://my-bucket
# With an object
s3-account-search arn:aws:iam::123456789012:role/s3_read s3://my-bucket/path/to/object.ext
```
Hierdie tegniek werk ook met API Gateway URLs, Lambda URLs, Data Exchange data stelle en selfs om die waarde van tags te kry (as jy die tag sleutel ken). Jy kan meer inligting vind in die [**oorspronklike navorsing**](https://blog.plerion.com/conditional-love-for-aws-metadata-enumeration/) en die hulpmiddel [**conditional-love**](https://github.com/plerionhq/conditional-love/) om hierdie uitbuiting te outomatiseer.

### Bevestiging dat 'n emmer aan 'n AWS-rekening behoort

Soos verduidelik in [**hierdie blogpos**](https://blog.plerion.com/things-you-wish-you-didnt-need-to-know-about-s3/)**, as jy toestemming het om 'n emmer te lys** is dit moontlik om 'n rekeningID te bevestig waaraan die emmer behoort deur 'n versoek soos die volgende te stuur:
```bash
curl -X GET "[bucketname].amazonaws.com/" \
-H "x-amz-expected-bucket-owner: [correct-account-id]"

<?xml version="1.0" encoding="UTF-8"?>
<ListBucketResult xmlns="http://s3.amazonaws.com/doc/2006-03-01/">...</ListBucketResult>
```
As die fout 'n "Access Denied" is, beteken dit dat die rekening-ID verkeerd was.

### Gebruik E-posse as root rekening enumerasie

Soos verduidelik in [**hierdie blog post**](https://blog.plerion.com/things-you-wish-you-didnt-need-to-know-about-s3/), is dit moontlik om te kyk of 'n e-posadres aan enige AWS-rekening gekoppel is deur **te probeer om e-pos toestemmings** oor 'n S3-emmer via ACLs te gee. As dit nie 'n fout veroorsaak nie, beteken dit dat die e-pos 'n root gebruiker van 'n AWS-rekening is:
```python
s3_client.put_bucket_acl(
Bucket=bucket_name,
AccessControlPolicy={
'Grants': [
{
'Grantee': {
'EmailAddress': 'some@emailtotest.com',
'Type': 'AmazonCustomerByEmail',
},
'Permission': 'READ'
},
],
'Owner': {
'DisplayName': 'Whatever',
'ID': 'c3d78ab5093a9ab8a5184de715d409c2ab5a0e2da66f08c2f6cc5c0bdeadbeef'
}
}
)
```
## Verwysings

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://cloudar.be/awsblog/finding-the-account-id-of-any-public-s3-bucket/](https://cloudar.be/awsblog/finding-the-account-id-of-any-public-s3-bucket/)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking tricks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
