# AWS - EC2 Persistence

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して**ハッキングトリックを共有**してください。

</details>
{% endhint %}

## EC2

詳細はこちらをチェックしてください:

{% content-ref url="../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### セキュリティグループ接続トラッキングの永続化

**EC2インスタンスが侵害された**ことが発見された場合、**マシンのネットワークを孤立**しようとするかもしれません。これは明示的な**Deny NACL**（ただし、NACLはサブネット全体に影響を与えます）や**どのようなインバウンドまたはアウトバウンド**トラフィックも許可しないように**セキュリティグループを変更**することで行うことができます。

攻撃者がマシンから発信された**リバースシェルを持っていた場合**、セキュリティグループが変更されても**インバウンドまたはアウトバウンド**トラフィックを許可しないように変更されても、**[セキュリティグループ接続トラッキング](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/security-group-connection-tracking.html)**によって**接続が切断されない**。

### EC2ライフサイクルマネージャー

このサービスは、**AMIとスナップショットの作成をスケジュール**し、さらに**他のアカウントと共有**することができます。\
攻撃者は、**すべてのイメージまたはすべてのボリュームのAMIまたはスナップショットの生成**を**毎週**行い、**自分のアカウントと共有**することができます。

### スケジュールされたインスタンス

インスタンスを毎日、毎週、または月次に実行することが可能です。攻撃者は、高い権限や興味深いアクセスが可能なマシンを実行することができます。

### スポットフリートリクエスト

スポットインスタンスは通常のインスタンスよりも**安価**です。攻撃者は、**5年間の小さなスポットフリートリクエスト**（例えば）を起動し、**自動IP**割り当てと**ユーザーデータ**を使用して、**スポットインスタンスが起動するときに攻撃者に送信する**IPアドレスと**高い特権を持つIAMロール**を設定することができます。

### バックドアインスタンス

攻撃者はインスタンスにアクセスしてバックドアを設置することができます:

* 例えば、従来の**rootkit**を使用する
* 新しい**パブリックSSHキー**を追加する（[EC2特権昇格オプション](../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md)を確認）
* **ユーザーデータ**にバックドアを設置する

### **バックドア起動構成**

* 使用されているAMIにバックドアを設置する
* ユーザーデータにバックドアを設置する
* キーペアにバックドアを設置する

### VPN

VPNを作成して、攻撃者が直接VPCに接続できるようにします。

### VPCピアリング

被害者VPCと攻撃者VPCの間にピアリング接続を作成して、攻撃者が被害者VPCにアクセスできるようにします。

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して**ハッキングトリックを共有**してください。

</details>
{% endhint %}
