# AWS - Lambda Persistence

{% hint style="success" %}
学习和实践 AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和实践 GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交 PRs 分享黑客技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库。

</details>
{% endhint %}

## Lambda

更多信息请查看：

{% content-ref url="../../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Lambda Layer Persistence

可以在 Lambda 执行时以隐蔽的方式**引入/后门一个层以执行任意代码**：

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Lambda Extension Persistence

滥用 Lambda Layers 也可以滥用扩展并在 Lambda 中持久存在，还可以窃取和修改请求。

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### 通过资源策略

可以授予外部账户对不同 Lambda 操作（如调用或更新代码）的访问权限：

<figure><img src="../../../../.gitbook/assets/image (255).png" alt=""><figcaption></figcaption></figure>

### 版本、别名和权重

一个 Lambda 可以有**不同的版本**（每个版本有不同的代码）。\
然后，你可以创建**具有不同版本的不同别名**并为每个别名设置不同的权重。\
这样，攻击者可以创建一个**后门版本 1**和一个**仅包含合法代码的版本 2**，并且**仅在 1% 的请求中执行版本 1**以保持隐蔽。

<figure><img src="../../../../.gitbook/assets/image (120).png" alt=""><figcaption></figcaption></figure>

### 版本后门 + API Gateway

1. 复制 Lambda 的原始代码
2. **创建一个新的版本后门**原始代码（或仅包含恶意代码）。发布并**部署该版本**到 $LATEST
3. 调用与 Lambda 相关的 API gateway 以执行代码
4. **创建一个包含原始代码的新版本**，发布并部署该**版本**到 $LATEST。
5. 这将隐藏在先前版本中的后门代码
6. 转到 API Gateway 并**创建一个新的 POST 方法**（或选择任何其他方法）以执行 Lambda 的后门版本：`arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
7. 注意 arn 末尾的 :1 **表示函数的版本**（在此场景中，版本 1 将是后门版本）。
8. 选择创建的 POST 方法并在操作中选择 **`Deploy API`**
9. 现在，当你**通过 POST 调用函数时，你的后门**将被调用

### Cron/Event 执行器

你可以让**lambda 函数在某些事件发生时或在某些时间间隔后运行**，这使得 lambda 成为一种获得持久性并避免检测的不错且常见的方法。\
这里有一些想法可以通过创建 lambda 使你在 AWS 中的**存在更加隐蔽**。

* 每次创建新用户时，lambda 生成一个新用户密钥并发送给攻击者。
* 每次创建新角色时，lambda 赋予被攻陷用户 assume role 权限。
* 每次生成新的 cloudtrail 日志时，删除/更改它们

{% hint style="success" %}
学习和实践 AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和实践 GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交 PRs 分享黑客技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库。

</details>
{% endhint %}
