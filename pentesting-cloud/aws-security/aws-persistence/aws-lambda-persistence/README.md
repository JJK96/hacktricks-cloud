# AWS - Lambda Persistence

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks'e ve** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github depolarına PR göndererek hacking ipuçlarını paylaşın.**

</details>
{% endhint %}

## Lambda

Daha fazla bilgi için kontrol edin:

{% content-ref url="../../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Lambda Layer Persistence

Lambda çalıştırıldığında gizli bir şekilde keyfi kod çalıştırmak için bir katman eklemek/backdoorlamak mümkündür:

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Lambda Extension Persistence

Lambda Layers'ı kötüye kullanarak, uzantıları kötüye kullanmak ve lambda içinde kalıcı olmak, ayrıca istekleri çalmak ve değiştirmek de mümkündür.

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### Kaynak politikaları aracılığıyla

Farklı lambda eylemlerine (örneğin, çağırma veya kod güncelleme) dış hesaplara erişim izni vermek mümkündür:

<figure><img src="../../../../.gitbook/assets/image (255).png" alt=""><figcaption></figcaption></figure>

### Sürümler, Takma Adlar ve Ağırlıklar

Bir Lambda'nın **farklı sürümleri** olabilir (her sürümde farklı kodlarla).\
Daha sonra, lambda'nın **farklı sürümleriyle farklı takma adlar** oluşturabilir ve her birine farklı ağırlıklar atayabilirsiniz.\
Bu şekilde bir saldırgan, **backdoorlanmış bir sürüm 1** ve **sadece meşru kod içeren bir sürüm 2** oluşturabilir ve **isteklerin sadece %1'inde sürüm 1'i çalıştırarak** gizli kalabilir.

<figure><img src="../../../../.gitbook/assets/image (120).png" alt=""><figcaption></figcaption></figure>

### Sürüm Backdoor + API Gateway

1. Lambda'nın orijinal kodunu kopyalayın
2. Orijinal kodu backdoorlayarak (veya sadece kötü niyetli kodla) **yeni bir sürüm oluşturun**. Bu sürümü $LATEST'e **yayınlayın ve dağıtın**
1. Kodu çalıştırmak için lambda ile ilgili API gateway'ini çağırın
3. **Orijinal kodla yeni bir sürüm oluşturun**, yayınlayın ve bu **sürümü** $LATEST'e dağıtın.
1. Bu, backdoorlanmış kodu önceki bir sürümde gizleyecektir
4. API Gateway'e gidin ve **yeni bir POST yöntemi oluşturun** (veya başka bir yöntemi seçin) ve bu yöntem backdoorlanmış lambda sürümünü çalıştıracaktır: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. arn'ın sonundaki :1'in **işlevin sürümünü belirttiğini** unutmayın (bu senaryoda sürüm 1 backdoorlanmış olan olacaktır).
5. Oluşturulan POST yöntemini seçin ve Eylemler'de **`Deploy API`** seçin
6. Şimdi, **POST yöntemiyle işlevi çağırdığınızda Backdoor** çalıştırılacaktır

### Cron/Olay tetikleyici

Lambda işlevlerinin **bir şey olduğunda veya belirli bir süre geçtiğinde çalıştırılabilmesi** lambda'yı kalıcılık sağlamak ve tespitten kaçınmak için güzel ve yaygın bir yol haline getirir.\
İşte **AWS'deki varlığınızı daha gizli hale getirmek için lambda oluşturarak** bazı fikirler.

* Yeni bir kullanıcı oluşturulduğunda lambda yeni bir kullanıcı anahtarı oluşturur ve saldırgana gönderir.
* Yeni bir rol oluşturulduğunda lambda, ele geçirilmiş kullanıcılara rol alma izinleri verir.
* Yeni cloudtrail günlükleri oluşturulduğunda, bunları silin/değiştirin

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks'e ve** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github depolarına PR göndererek hacking ipuçlarını paylaşın.**

</details>
{% endhint %}
