# AWS - Lambda Persistence

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Lambda

F√ºr weitere Informationen siehe:

{% content-ref url="../../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Lambda Layer Persistence

Es ist m√∂glich, eine **Schicht zu infiltrieren/backdooren, um beliebigen Code auszuf√ºhren**, wenn die Lambda auf eine unauff√§llige Weise ausgef√ºhrt wird:

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Lambda Extension Persistence

Durch das Ausnutzen von Lambda Layers ist es auch m√∂glich, Erweiterungen zu missbrauchen und in der Lambda zu persistieren, aber auch Anfragen zu stehlen und zu modifizieren.

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### √úber Ressourcenrichtlinien

Es ist m√∂glich, externen Konten Zugriff auf verschiedene Lambda-Aktionen (wie z.B. Aufrufen oder Aktualisieren von Code) zu gew√§hren:

<figure><img src="../../../../.gitbook/assets/image (255).png" alt=""><figcaption></figcaption></figure>

### Versionen, Aliase & Gewichte

Eine Lambda kann **verschiedene Versionen** haben (mit unterschiedlichem Code in jeder Version).\
Dann kann man **verschiedene Aliase mit verschiedenen Versionen** der Lambda erstellen und diesen unterschiedliche Gewichte zuweisen.\
Auf diese Weise k√∂nnte ein Angreifer eine **backdoorte Version 1** und eine **Version 2 nur mit dem legitimen Code** erstellen und **nur die Version 1 in 1%** der Anfragen ausf√ºhren, um unauff√§llig zu bleiben.

<figure><img src="../../../../.gitbook/assets/image (120).png" alt=""><figcaption></figcaption></figure>

### Version Backdoor + API Gateway

1. Kopiere den Originalcode der Lambda
2. **Erstelle eine neue Version, die den Originalcode backdoort** (oder nur mit b√∂sartigem Code). Ver√∂ffentliche und **deploye diese Version** auf $LATEST
1. Rufe das API-Gateway auf, das mit der Lambda verbunden ist, um den Code auszuf√ºhren
3. **Erstelle eine neue Version mit dem Originalcode**, ver√∂ffentliche und deploye diese **Version** auf $LATEST.
1. Dies wird den backdoorten Code in einer vorherigen Version verbergen
4. Gehe zum API-Gateway und **erstelle eine neue POST-Methode** (oder w√§hle eine andere Methode), die die backdoorte Version der Lambda ausf√ºhrt: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. Beachte das abschlie√üende :1 der ARN, das **die Version der Funktion** angibt (Version 1 wird in diesem Szenario die backdoorte sein).
5. W√§hle die erstellte POST-Methode aus und w√§hle in den Aktionen **`Deploy API`**
6. Jetzt, wenn du **die Funktion √ºber POST aufrufst, wird dein Backdoor** aktiviert

### Cron/Event-Aktor

Die Tatsache, dass du **Lambda-Funktionen ausf√ºhren lassen kannst, wenn etwas passiert oder nach einer bestimmten Zeit**, macht Lambda zu einer netten und g√§ngigen Methode, um Persistenz zu erreichen und Erkennung zu vermeiden.\
Hier sind einige Ideen, um deine **Pr√§senz in AWS unauff√§lliger zu gestalten, indem du Lambdas erstellst**.

* Jedes Mal, wenn ein neuer Benutzer erstellt wird, generiert Lambda einen neuen Benutzerschl√ºssel und sendet ihn an den Angreifer.
* Jedes Mal, wenn eine neue Rolle erstellt wird, gibt Lambda kompromittierten Benutzern Berechtigungen zur Rollen√ºbernahme.
* Jedes Mal, wenn neue CloudTrail-Protokolle erstellt werden, l√∂sche/ver√§ndere sie

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
