# AWS - Lambda Persistence

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Lambda

Για περισσότερες πληροφορίες ελέγξτε:

{% content-ref url="../../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Lambda Layer Persistence

Είναι δυνατόν να **εισαγάγετε/backdoor ένα layer για να εκτελέσετε αυθαίρετο κώδικα** όταν η lambda εκτελείται με διακριτικό τρόπο:

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Lambda Extension Persistence

Εκμεταλλευόμενοι τα Lambda Layers είναι επίσης δυνατό να εκμεταλλευτείτε τις επεκτάσεις και να παραμείνετε στη lambda αλλά και να κλέψετε και να τροποποιήσετε αιτήματα.

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### Μέσω πολιτικών πόρων

Είναι δυνατόν να παραχωρήσετε πρόσβαση σε διάφορες ενέργειες lambda (όπως invoke ή update code) σε εξωτερικούς λογαριασμούς:

<figure><img src="../../../../.gitbook/assets/image (255).png" alt=""><figcaption></figcaption></figure>

### Εκδόσεις, Ψευδώνυμα & Βάρη

Μια Lambda μπορεί να έχει **διαφορετικές εκδόσεις** (με διαφορετικό κώδικα κάθε έκδοση).\
Στη συνέχεια, μπορείτε να δημιουργήσετε **διαφορετικά ψευδώνυμα με διαφορετικές εκδόσεις** της lambda και να ορίσετε διαφορετικά βάρη σε κάθε μία.\
Με αυτόν τον τρόπο ένας επιτιθέμενος θα μπορούσε να δημιουργήσει μια **backdoored έκδοση 1** και μια **έκδοση 2 με μόνο τον νόμιμο κώδικα** και **να εκτελεί μόνο την έκδοση 1 στο 1%** των αιτημάτων για να παραμείνει διακριτικός.

<figure><img src="../../../../.gitbook/assets/image (120).png" alt=""><figcaption></figcaption></figure>

### Έκδοση Backdoor + API Gateway

1. Αντιγράψτε τον αρχικό κώδικα της Lambda
2. **Δημιουργήστε μια νέα έκδοση backdooring** τον αρχικό κώδικα (ή απλά με κακόβουλο κώδικα). Δημοσιεύστε και **αναπτύξτε αυτήν την έκδοση** στο $LATEST
1. Καλέστε το API gateway που σχετίζεται με τη lambda για να εκτελέσετε τον κώδικα
3. **Δημιουργήστε μια νέα έκδοση με τον αρχικό κώδικα**, Δημοσιεύστε και αναπτύξτε αυτήν την **έκδοση** στο $LATEST.
1. Αυτό θα κρύψει τον backdoored κώδικα σε μια προηγούμενη έκδοση
4. Πηγαίνετε στο API Gateway και **δημιουργήστε μια νέα μέθοδο POST** (ή επιλέξτε οποιαδήποτε άλλη μέθοδο) που θα εκτελέσει την backdoored έκδοση της lambda: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. Σημειώστε το τελικό :1 του arn **που υποδεικνύει την έκδοση της λειτουργίας** (η έκδοση 1 θα είναι η backdoored σε αυτό το σενάριο).
5. Επιλέξτε τη μέθοδο POST που δημιουργήθηκε και στις Ενέργειες επιλέξτε **`Deploy API`**
6. Τώρα, όταν **καλέσετε τη λειτουργία μέσω POST το Backdoor σας** θα ενεργοποιηθεί

### Cron/Event actuator

Το γεγονός ότι μπορείτε να κάνετε **τις λειτουργίες lambda να εκτελούνται όταν συμβαίνει κάτι ή όταν περάσει κάποιος χρόνος** καθιστά τη lambda έναν ωραίο και κοινό τρόπο για να αποκτήσετε επιμονή και να αποφύγετε την ανίχνευση.\
Εδώ έχετε μερικές ιδέες για να κάνετε την **παρουσία σας στο AWS πιο διακριτική δημιουργώντας lambdas**.

* Κάθε φορά που δημιουργείται ένας νέος χρήστης, η lambda δημιουργεί ένα νέο κλειδί χρήστη και το στέλνει στον επιτιθέμενο.
* Κάθε φορά που δημιουργείται ένας νέος ρόλος, η lambda δίνει δικαιώματα assume role σε παραβιασμένους χρήστες.
* Κάθε φορά που δημιουργούνται νέα cloudtrail logs, διαγράψτε/τροποποιήστε τα

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
