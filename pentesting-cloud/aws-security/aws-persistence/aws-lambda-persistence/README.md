# AWS - Lambda Persistence

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Lambda

Vir meer inligting, kyk na:

{% content-ref url="../../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Lambda Layer Persistence

Dit is moontlik om **'n laag in te voer/agterdeur om arbitr√™re kode uit te voer** wanneer die lambda op 'n stil manier uitgevoer word:

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Lambda Extension Persistence

Deur Lambda Layers te misbruik, is dit ook moontlik om uitbreidings te misbruik en in die lambda te persisteer, maar ook versoeke te steel en te verander.

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### Via resource policies

Dit is moontlik om toegang tot verskillende lambda aksies (soos invoke of update code) aan eksterne rekeninge te verleen:

<figure><img src="../../../../.gitbook/assets/image (255).png" alt=""><figcaption></figcaption></figure>

### Versions, Aliases & Weights

'n Lambda kan **verskillende weergawes** h√™ (met verskillende kode elke weergawe).\
Dan kan jy **verskillende aliasse met verskillende weergawes** van die lambda skep en verskillende gewigte aan elkeen toeken.\
Op hierdie manier kan 'n aanvaller 'n **agterdeur weergawe 1** skep en 'n **weergawe 2 met slegs die wettige kode** en **slegs die weergawe 1 in 1%** van die versoeke uitvoer om stil te bly.

<figure><img src="../../../../.gitbook/assets/image (120).png" alt=""><figcaption></figcaption></figure>

### Version Backdoor + API Gateway

1. Kopieer die oorspronklike kode van die Lambda
2. **Skep 'n nuwe weergawe met 'n agterdeur** in die oorspronklike kode (of net met kwaadwillige kode). Publiseer en **ontplooi daardie weergawe** na $LATEST
1. Roep die API gateway wat verband hou met die lambda om die kode uit te voer
3. **Skep 'n nuwe weergawe met die oorspronklike kode**, publiseer en ontplooi daardie **weergawe** na $LATEST.
1. Dit sal die agterdeur kode in 'n vorige weergawe wegsteek
4. Gaan na die API Gateway en **skep 'n nuwe POST metode** (of kies enige ander metode) wat die agterdeur weergawe van die lambda sal uitvoer: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. Let op die finale :1 van die arn **wat die weergawe van die funksie aandui** (weergawe 1 sal die agterdeur een wees in hierdie scenario).
5. Kies die geskepte POST metode en in Aksies kies **`Deploy API`**
6. Nou, wanneer jy **die funksie via POST aanroep, sal jou agterdeur** geaktiveer word

### Cron/Event actuator

Die feit dat jy **lambda funksies kan laat loop wanneer iets gebeur of wanneer 'n sekere tyd verbygaan** maak lambda 'n goeie en algemene manier om volharding te verkry en opsporing te vermy.\
Hier is 'n paar idees om jou **teenwoordigheid in AWS meer stil te maak deur lambdas te skep**.

* Elke keer as 'n nuwe gebruiker geskep word, genereer lambda 'n nuwe gebruikersleutel en stuur dit aan die aanvaller.
* Elke keer as 'n nuwe rol geskep word, gee lambda assume role toestemmings aan gekompromitteerde gebruikers.
* Elke keer as nuwe cloudtrail logs gegenereer word, verwyder/verander dit

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
