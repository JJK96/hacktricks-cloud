# AWS - Abusing Lambda Extensions

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Lambda Extensions

Lambda-uitbreidings verbeter funksies deur te integreer met verskeie **monitering, waarneembaarheid, sekuriteit, en bestuursinstrumente**. Hierdie uitbreidings, bygevoeg via [.zip argiewe met behulp van Lambda-lae](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) of ingesluit in [houerbeeldontplooiings](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), werk in twee modusse: **intern** en **ekstern**.

* **Interne uitbreidings** smelt saam met die runtime-proses, manipuleer sy opstart met behulp van **taalspesifieke omgewingsveranderlikes** en **omslagskripte**. Hierdie aanpassing is van toepassing op 'n reeks runtimes, insluitend **Java Correto 8 en 11, Node.js 10 en 12, en .NET Core 3.1**.
* **Eksterne uitbreidings** werk as afsonderlike prosesse, handhaaf operasionele belyning met die Lambda-funksie se lewensiklus. Hulle is versoenbaar met verskeie runtimes soos **Node.js 10 en 12, Python 3.7 en 3.8, Ruby 2.5 en 2.7, Java Corretto 8 en 11, .NET Core 3.1**, en **pasgemaakte runtimes**.

Vir meer inligting oor [**hoe lambda-uitbreidings werk, kyk na die dokumentasie**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Eksterne Uitbreiding vir Volharding, Steel van Versoeke & Wysiging van Versoeke

Dit is 'n opsomming van die tegniek voorgestel in hierdie pos: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Dit is gevind dat die standaard Linux-kern in die Lambda-runtime-omgewing saamgestel is met ‚Äú**process\_vm\_readv**‚Äù en ‚Äú**process\_vm\_writev**‚Äù stelseloproepe. En alle prosesse loop met dieselfde gebruikers-ID, selfs die nuwe proses wat vir die eksterne uitbreiding geskep is. **Dit beteken dat 'n eksterne uitbreiding volle lees- en skryftoegang het tot Rapid se hoopgeheue, volgens ontwerp.**

Boonop, terwyl Lambda-uitbreidings die vermo√´ het om **inroepgebeurtenisse te inteken**, openbaar AWS nie die rou data aan hierdie uitbreidings nie. Dit verseker dat **uitbreidings nie toegang het tot sensitiewe inligting** wat via die HTTP-versoek oorgedra word nie.

Die Init (Rapid) proses monitor alle API-versoeke by [http://127.0.0.1:9001](http://127.0.0.1:9001/) terwyl Lambda-uitbreidings ge√Ønitialiseer en uitgevoer word voor die uitvoering van enige runtime-kode, maar na Rapid.

<figure><img src="../../../../.gitbook/assets/image (254).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

Die veranderlike **`AWS_LAMBDA_RUNTIME_API`** dui die **IP**-adres en **poort**-nommer van die Rapid API aan vir **kind runtime prosesse** en bykomende uitbreidings.

{% hint style="warning" %}
Deur die **`AWS_LAMBDA_RUNTIME_API`** omgewingsveranderlike te verander na 'n **`poort`** waartoe ons toegang het, is dit moontlik om alle aksies binne die Lambda-runtime te onderskep (**man-in-the-middle**). Dit is moontlik omdat die uitbreiding met dieselfde voorregte as Rapid Init loop, en die stelsel se kern toelaat vir **wysiging van prosesgeheue**, wat die verandering van die poortnommer moontlik maak.
{% endhint %}

Omdat **uitbreidings voor enige runtime-kode loop**, sal die wysiging van die omgewingsveranderlike die runtime-proses (bv. Python, Java, Node, Ruby) be√Ønvloed soos dit begin. Verder, **uitbreidings wat na** ons s'n gelaai word, wat op hierdie veranderlike staatmaak, sal ook deur ons uitbreiding roeteer. Hierdie opstelling kan wanware in staat stel om sekuriteitsmaatre√´ls of log-uitbreidings direk binne die runtime-omgewing heeltemal te omseil.

<figure><img src="../../../../.gitbook/assets/image (267).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

Die instrument [**lambda-spy**](https://github.com/clearvector/lambda-spy) is geskep om daardie **geheueskrywe** uit te voer en **sensitiewe inligting** van lambda-versoeke, ander **uitbreidings** **versoeke** te steel en selfs **hulle** te **wysig**.

## Verwysings

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
