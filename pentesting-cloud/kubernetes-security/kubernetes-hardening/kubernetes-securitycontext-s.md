# Contexto de Seguridad de Kubernetes

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}

## Contexto de Seguridad del Pod <a href="#podsecuritycontext-v1-core" id="podsecuritycontext-v1-core"></a>

[**Desde la documentaci칩n:**](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core)

Al especificar el contexto de seguridad de un Pod, puedes utilizar varios atributos. Desde un punto de vista de seguridad defensiva, debes considerar:

* Tener **runASNonRoot** como **True**
* Configurar **runAsUser**
* Si es posible, considerar **limitar** **permisos** indicando **seLinuxOptions** y **seccompProfile**
* **NO** dar acceso de **grupo privilegiado** a trav칠s de **runAsGroup** y **supplementaryGroups**

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroup</strong></a><br><em>entero</em></p>                                                                                                                                                                                                                                                 | <p>Un grupo suplementario especial que se aplica a <strong>todos los contenedores en un pod</strong>. Algunos tipos de volumen permiten que Kubelet <strong>cambie la propiedad de ese volumen</strong> para que sea propiedad del pod:<br>1. El GID propietario ser치 el FSGroup<br>2. Se establece el bit setgid (los nuevos archivos creados en el volumen ser치n propiedad de FSGroup)<br>3. Los bits de permiso se OR'd con rw-rw---- Si no se establece, Kubelet no modificar치 la propiedad y permisos de ning칰n volumen</p> |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroupChangePolicy</strong></a><br><em>cadena</em></p>                                                                                                                                                                                                                                      | Esto define el comportamiento de **cambiar la propiedad y permisos del volumen** antes de ser expuesto dentro del Pod.                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsGroup</strong></a><br><em>entero</em></p>                                                                                                                                                                                                                                              | El **GID para ejecutar el punto de entrada del proceso del contenedor**. Utiliza el valor predeterminado en tiempo de ejecuci칩n si no est치 establecido. Tambi칠n puede establecerse en SecurityContext.                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>booleano</em></p>                                                                                                                                                                                                                                            | Indica que el contenedor debe ejecutarse como un usuario no root. Si es verdadero, Kubelet validar치 la imagen en tiempo de ejecuci칩n para asegurarse de que no se ejecute como UID 0 (root) y fallar치 al iniciar el contenedor si lo hace.                                                                                                                                                                                                                                                                          |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsUser</strong></a><br><em>entero</em></p>                                                                                                                                                                                                                                               | El **UID para ejecutar el punto de entrada del proceso del contenedor**. Por defecto, se utiliza el usuario especificado en los metadatos de la imagen si no se especifica.                                                                                                                                                                                                                                                                                                                                                              |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>M치s informaci칩n sobre</em> <em><strong>seLinux</strong></em></p>                                                           | El **contexto SELinux que se aplicar치 a todos los contenedores**. Si no se especifica, el tiempo de ejecuci칩n del contenedor asignar치 un contexto SELinux aleatorio para cada contenedor.                                                                                                                                                                                                                                                                                                                             |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a><br><em>M치s informaci칩n sobre</em> <em><strong>Seccomp</strong></em></p>                                                           | Las **opciones de seccomp a utilizar por los contenedores** en este pod.                                                                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>supplementalGroups</strong></a><br><em>arreglo de enteros</em></p>                                                                                                                                                                                                                                | Una lista de **grupos aplicados al primer proceso ejecutado en cada contenedor**, adem치s del GID principal del contenedor.                                                                                                                                                                                                                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>sysctls</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#sysctl-v1-core"><em>Sysctl</em></a> <em>arreglo</em><br><em>M치s informaci칩n sobre</em> <a href="https://www.garron.me/en/go2linux/sysctl-linux.html"><em><strong>sysctls</strong></em></a></p> | Sysctls contiene una lista de **sysctls con namespace utilizados para el pod**. Los pods con sysctls no admitidos (por el tiempo de ejecuci칩n del contenedor) podr칤an fallar al iniciarse.                                                                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                                                                           | La configuraci칩n espec칤fica de Windows aplicada a todos los contenedores. Si no se especifica, se utilizar치n las opciones dentro del SecurityContext de un contenedor.                                                                                                                                                                                                                                                                                                                                               |
## SecurityContext

[**Desde la documentaci칩n:**](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core)

Este contexto se establece dentro de las **definiciones de contenedores**. Desde un punto de vista de seguridad defensiva, debes considerar:

* **allowPrivilegeEscalation** a **False**
* No agregar **capabilities** sensibles (y eliminar las que no necesitas)
* **privileged** a **False**
* Si es posible, establecer **readOnlyFilesystem** como **True**
* Establecer **runAsNonRoot** como **True** y establecer un **runAsUser**
* Si es posible, considerar **limitar** **permisos** indicando **seLinuxOptions** y **seccompProfile**
* **NO** dar acceso de **grupo privilegiado** a trav칠s de **runAsGroup**

Ten en cuenta que los atributos establecidos en **SecurityContext y PodSecurityContext**, el valor especificado en **SecurityContext** tiene **precedencia**.

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>allowPrivilegeEscalation</strong></a><br><em>boolean</em></p>                                                                                                                                                                      | **AllowPrivilegeEscalation** controla si un proceso puede **obtener m치s privilegios** que su proceso padre. Este booleano controla directamente si se establecer치 la bandera no\_new\_privs en el proceso del contenedor. AllowPrivilegeEscalation es verdadero siempre que el contenedor se ejecute como **Privileged** o tenga **CAP\_SYS\_ADMIN** |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>capabilities</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#capabilities-v1-core"><em>Capabilities</em></a><br><em>M치s informaci칩n sobre</em> <em><strong>Capabilities</strong></em></p>  | Las **capabilities para agregar/eliminar al ejecutar contenedores**. Por defecto, se establecen en el conjunto predeterminado de capabilities.                                                                                                                                                                                                                    |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>privileged</strong></a><br><em>boolean</em></p>                                                                                                                                                                                    | Ejecutar el contenedor en modo privilegiado. Los procesos en contenedores privilegiados son esencialmente **equivalentes a root en el host**. Por defecto es falso.                                                                                                                                                                               |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>procMount</strong></a><br><em>string</em></p>                                                                                                                                                                                      | procMount denota el **tipo de montaje de proc a usar para los contenedores**. El valor predeterminado es DefaultProcMount que utiliza los valores predeterminados del tiempo de ejecuci칩n del contenedor para rutas de solo lectura y rutas enmascaradas.                                                                                                                                    |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>readOnlyRootFilesystem</strong></a><br><em>boolean</em></p>                                                                                                                                                                        | Si este **contenedor tiene un sistema de archivos ra칤z de solo lectura**. Por defecto es falso.                                                                                                                                                                                                                                             |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsGroup</strong></a><br><em>integer</em></p>                                                                                                                                                                                    | El **GID para ejecutar el punto de entrada** del proceso del contenedor. Utiliza el valor predeterminado del tiempo de ejecuci칩n si no est치 establecido.                                                                                                                                                                                                                                |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>boolean</em></p>                                                                                                                                                                                  | Indica que el contenedor debe **ejecutarse como un usuario no root**. Si es verdadero, Kubelet validar치 la imagen en tiempo de ejecuci칩n para asegurarse de que no se ejecute como UID 0 (root) y fallar치 al iniciar el contenedor si lo hace.                                                                                                          |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsUser</strong></a><br><em>integer</em></p>                                                                                                                                                                                     | El **UID para ejecutar el punto de entrada** del proceso del contenedor. Por defecto es el usuario especificado en los metadatos de la imagen si no se especifica.                                                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>M치s informaci칩n sobre</em> <em><strong>seLinux</strong></em></p> | El **contexto SELinux que se aplicar치 al contenedor**. Si no se especifica, el tiempo de ejecuci칩n del contenedor asignar치 un contexto SELinux aleatorio para cada contenedor.                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a></p>                                                               | Las **opciones de seccomp** a utilizar por este contenedor.                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                 | La **configuraci칩n espec칤fica de Windows** aplicada a todos los contenedores.                                                                                                                                                                                                                                                              |

## Referencias

* [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core)
* [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* 춰Consulta los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
