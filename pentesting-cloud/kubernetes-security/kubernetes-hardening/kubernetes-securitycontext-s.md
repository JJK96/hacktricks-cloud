# Kubernetes安全上下文

{% hint style="success" %}
学习并练习AWS Hacking：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks培训AWS红队专家（ARTE）**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习GCP Hacking：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks培训GCP红队专家（GRTE）**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持HackTricks</summary>

* 检查[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享黑客技巧。

</details>
{% endhint %}

## Pod安全上下文 <a href="#podsecuritycontext-v1-core" id="podsecuritycontext-v1-core"></a>

[**来自文档：**](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core)

在指定Pod的安全上下文时，您可以使用多个属性。从防御安全性的角度考虑：

* 将**runASNonRoot**设置为**True**
* 配置**runAsUser**
* 如果可能，考虑通过指定**seLinuxOptions**和**seccompProfile**来**限制权限**
* **不要**通过**runAsGroup**和**supplementaryGroups**授予**特权组**访问权限

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroup</strong></a><br><em>整数</em></p>                                                                                                                                                                                                                                                 | <p>适用于**Pod中所有容器**的特殊补充组。某些卷类型允许Kubelet将**该卷的所有权**更改为由Pod拥有：<br>1. 拥有的GID将是FSGroup<br>2. 设置了setgid位（在卷中创建的新文件将由FSGroup拥有）<br>3. 权限位与rw-rw----进行OR运算 如果未设置，Kubelet将不会修改任何卷的所有权和权限</p> |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroupChangePolicy</strong></a><br><em>字符串</em></p>                                                                                                                                                                                                                                      | 这定义了在暴露到Pod内部之前**更改卷的所有权和权限**的行为。                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsGroup</strong></a><br><em>整数</em></p>                                                                                                                                                                                                                                              | 用于运行容器进程入口点的**GID**。如果未设置，则使用运行时默认值。也可以在SecurityContext中设置。                                                                                                                                                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>布尔值</em></p>                                                                                                                                                                                                                                            | 表示容器必须以非root用户身份运行。如果为true，则Kubelet将在运行时验证镜像，以确保其不以UID 0（root）运行，并在其这样做时无法启动容器。                                                                                                                                                                                                                                                                                                                                          |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsUser</strong></a><br><em>整数</em></p>                                                                                                                                                                                                                                               | 用于运行容器进程入口点的**UID**。如果未指定，默认为镜像元数据中指定的用户。                                                                                                                                                                                                                                                                                                                                                              |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>有关</em> <em><strong>seLinux</strong></em>的更多信息</p>                                                           | 要应用于所有容器的**SELinux上下文**。如果未指定，容器运行时将为每个容器分配一个随机的SELinux上下文。                                                                                                                                                                                                                                                                                                                             |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a><br><em>有关</em> <em><strong>Seccomp</strong></em>的更多信息</p>                                                           | 该Pod中容器使用的**seccomp选项**。                                                                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>supplementalGroups</strong></a><br><em>整数数组</em></p>                                                                                                                                                                                                                                | 应用于每个容器中第一个运行进程的**组列表**，除了容器的主要GID。                                                                                                                                                                                                                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>sysctls</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#sysctl-v1-core"><em>Sysctl</em></a> <em>数组</em><br><em>有关</em> <a href="https://www.garron.me/en/go2linux/sysctl-linux.html"><em><strong>sysctls</strong></em></a></p> | Sysctls包含用于该Pod的**命名空间sysctls**列表。具有不受容器运行时支持的sysctls的Pod可能无法启动。                                                                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                                                                           | 应用于所有容器的Windows特定设置。如果未指定，将使用容器的SecurityContext中的选项。                                                                                                                                                                                                                                                                                                                                               |
## SecurityContext

[**来自文档：**](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core)

此上下文设置在**容器定义**内。从防御安全的角度考虑：

- 将**allowPrivilegeEscalation**设置为**False**
- 不要添加敏感的**capabilities**（并移除不需要的）
- 将**privileged**设置为**False**
- 如果可能，将**readOnlyFilesystem**设置为**True**
- 将**runAsNonRoot**设置为**True**，并设置一个**runAsUser**
- 如果可能，考虑通过指定**seLinuxOptions**和**seccompProfile**来**限制权限**
- **不要**通过**runAsGroup**给予**特权组**访问权限。

请注意，在**SecurityContext和PodSecurityContext**中设置的属性，**SecurityContext**中指定的值**优先**。

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>allowPrivilegeEscalation</strong></a><br><em>boolean</em></p>                                                                                                                                                                      | **AllowPrivilegeEscalation** 控制进程是否可以比其父进程**获得更多权限**。此布尔值直接控制容器进程上是否设置no\_new\_privs标志。当容器以**Privileged**方式运行或具有**CAP\_SYS\_ADMIN**时，AllowPrivilegeEscalation始终为true |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>capabilities</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#capabilities-v1-core"><em>Capabilities</em></a><br><em>More info about</em> <em><strong>Capabilities</strong></em></p>  | 运行容器时要添加/删除的**capabilities**。默认为默认的capabilities集。                                                                                                                                                                                                                    |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>privileged</strong></a><br><em>boolean</em></p>                                                                                                                                                                                    | 以特权模式运行容器。特权容器中的进程基本上等同于主机上的root。默认为false。                                                                                                                                                                               |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>procMount</strong></a><br><em>string</em></p>                                                                                                                                                                                      | procMount表示用于容器的**proc挂载类型**。默认值为DefaultProcMount，它使用容器运行时默认值来设置只读路径和掩码路径。                                                                                                                                    |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>readOnlyRootFilesystem</strong></a><br><em>boolean</em></p>                                                                                                                                                                        | 此**容器是否具有只读根文件系统**。默认值为false。                                                                                                                                                                                                                                             |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsGroup</strong></a><br><em>integer</em></p>                                                                                                                                                                                    | 运行容器进程入口点的**GID**。如果未设置，则使用运行时默认值。                                                                                                                                                                                                                                |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>boolean</em></p>                                                                                                                                                                                  | 表示容器必须以非root用户身份运行。如果为true，则Kubelet将在运行时验证镜像，以确保其不以UID 0（root）运行，并在其以此运行时失败启动容器。                                                                                                          |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsUser</strong></a><br><em>integer</em></p>                                                                                                                                                                                     | 运行容器进程入口点的**UID**。如果未指定，默认为镜像元数据中指定的用户。                                                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>More info about</em> <em><strong>seLinux</strong></em></p> | 要应用于容器的**SELinux上下文**。如果未指定，容器运行时将为每个容器分配一个随机的SELinux上下文。                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a></p>                                                               | 此容器要使用的**seccomp选项**。                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                 | 应用于所有容器的**Windows特定设置**。                                                                                                                                                                                                                                                              |

## 参考资料

* [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core)
* [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core)

{% hint style="success" %}
学习并练习AWS Hacking：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习GCP Hacking：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 **电报群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** 上关注我们**。
* 通过向**HackTricks**和**HackTricks Cloud** github 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}
