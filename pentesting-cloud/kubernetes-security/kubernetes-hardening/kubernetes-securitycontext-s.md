# Bezpieczeństwo Kontekstu Bezpieczeństwa Kubernetes

{% hint style="success" %}
Dowiedz się i ćwicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz się i ćwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel się sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Kontekst Bezpieczeństwa Pod <a href="#podsecuritycontext-v1-core" id="podsecuritycontext-v1-core"></a>

[**Z dokumentacji:**](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core)

Podczas określania kontekstu bezpieczeństwa Pod, można użyć kilku atrybutów. Z punktu widzenia defensywnego bezpieczeństwa należy rozważyć:

* Ustawienie **runASNonRoot** na **True**
* Skonfigurowanie **runAsUser**
* Jeśli to możliwe, rozważ **ograniczenie** **uprawnień** poprzez wskazanie **seLinuxOptions** i **seccompProfile**
* **NIE** udzielaj dostępu do **grupy uprawnień** poprzez **runAsGroup** i **supplementaryGroups**

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroup</strong></a><br><em>liczba całkowita</em></p>                                                                                                                                                                                                                                                 | <p>Specjalna grupa uzupełniająca, która dotyczy <strong>wszystkich kontenerów w podzie</strong>. Niektóre typy woluminów pozwalają Kubeletowi <strong>zmienić właściciela tego woluminu</strong>, aby był on własnością poda:<br>1. GID właściciela będzie FSGroup<br>2. Ustawiony zostanie bit setgid (nowe pliki utworzone w woluminie będą własnością FSGroup)<br>3. Bity uprawnień są OR'owane z rw-rw---- Jeśli nieustawione, Kubelet nie zmodyfikuje właściciela i uprawnień żadnego woluminu</p> |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroupChangePolicy</strong></a><br><em>łańcuch znaków</em></p>                                                                                                                                                                                                                                      | Określa zachowanie **zmiany właściciela i uprawnień woluminu** przed jego ujawnieniem wewnątrz Poda.                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsGroup</strong></a><br><em>liczba całkowita</em></p>                                                                                                                                                                                                                                              | GID, pod którym ma być uruchamiany punkt wejścia procesu kontenera. Używa domyślnego czasu wykonywania, jeśli nieustawiony. Może również być ustawiony w SecurityContext.                                                                                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>boolean</em></p>                                                                                                                                                                                                                                            | Wskazuje, że kontener musi działać jako użytkownik nie będący rootem. Jeśli wartość jest prawdziwa, Kubelet zweryfikuje obraz w czasie wykonywania, aby upewnić się, że nie działa jako UID 0 (root) i nie uruchomi kontenera, jeśli tak jest.                                                                                                                                                                                                                                                                          |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsUser</strong></a><br><em>liczba całkowita</em></p>                                                                                                                                                                                                                                               | UID, pod którym ma być uruchamiany punkt wejścia procesu kontenera. Domyślnie jest to użytkownik określony w metadanych obrazu, jeśli nieokreślony.                                                                                                                                                                                                                                                                                                                                                              |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>Więcej informacji o</em> <em><strong>seLinux</strong></em></p>                                                           | Kontekst SELinux, który ma być stosowany do wszystkich kontenerów. Jeśli nieokreślony, runtime kontenera przydzieli losowy kontekst SELinux dla każdego kontenera.                                                                                                                                                                                                                                                                                                                             |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a><br><em>Więcej informacji o</em> <em><strong>Seccomp</strong></em></p>                                                           | Opcje seccomp do użycia przez kontenery w tym podzie.                                                                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>supplementalGroups</strong></a><br><em>tablica liczb całkowitych</em></p>                                                                                                                                                                                                                                | Lista **grup stosowanych do pierwszego procesu uruchamianego w każdym kontenerze**, oprócz głównego GID kontenera.                                                                                                                                                                                                                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>sysctls</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#sysctl-v1-core"><em>Sysctl</em></a> <em>tablica</em><br><em>Więcej informacji o</em> <a href="https://www.garron.me/en/go2linux/sysctl-linux.html"><em><strong>sysctls</strong></em></a></p> | Sysctls zawierają listę **sysctls przestrzennych używanych dla poda**. Pody z nieobsługiwanymi sysctls (przez runtime kontenera) mogą nie uruchomić się poprawnie.                                                                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                                                                           | Specyficzne dla systemu Windows ustawienia stosowane do wszystkich kontenerów. Jeśli nieokreślone, opcje w ramach SecurityContext kontenera zostaną użyte.                                                                                                                                                                                                                                                                                                                                               |
## SecurityContext

[**Z dokumentacji:**](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core)

Ten kontekst jest ustawiany w **definicjach kontenerów**. Z punktu widzenia obronnej bezpieczeństwa należy rozważyć:

* **allowPrivilegeEscalation** ustawione na **False**
* Nie dodawać wrażliwych **capabilities** (i usuwać te, których nie potrzebujesz)
* **privileged** ustawione na **False**
* Jeśli to możliwe, ustaw **readOnlyFilesystem** na **True**
* Ustaw **runAsNonRoot** na **True** i ustaw **runAsUser**
* Jeśli to możliwe, rozważ **ograniczenie** **uprawnień** poprzez wskazanie **seLinuxOptions** i **seccompProfile**
* **NIE** udzielać dostępu do **grupy uprawnień** za pomocą **runAsGroup**

Zauważ, że atrybuty ustawione w **zarówno SecurityContext, jak i PodSecurityContext**, wartość określona w **SecurityContext** ma **najwyższy priorytet**.

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>allowPrivilegeEscalation</strong></a><br><em>boolean</em></p>                                                                                                                                                                      | **AllowPrivilegeEscalation** kontroluje, czy proces może **uzyskać więcej uprawnień** niż jego proces nadrzędny. Ta wartość bezpośrednio kontroluje, czy flaga no\_new\_privs zostanie ustawiona w procesie kontenera. AllowPrivilegeEscalation jest zawsze ustawione na true, gdy kontener jest uruchamiany jako **Privileged** lub ma **CAP\_SYS\_ADMIN**. |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>capabilities</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#capabilities-v1-core"><em>Capabilities</em></a><br><em>More info about</em> <em><strong>Capabilities</strong></em></p>  | **Capabilities do dodania/usunięcia podczas uruchamiania kontenerów**. Domyślnie ustawione na domyślny zestaw capabilities.                                                                                                                                                                                                                    |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>privileged</strong></a><br><em>boolean</em></p>                                                                                                                                                                                    | Uruchom kontener w trybie uprzywilejowanym. Procesy w kontenerach uprzywilejowanych są w zasadzie **równoważne z rootem na hoście**. Domyślnie ustawione na false.                                                                                                                                                                               |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>procMount</strong></a><br><em>string</em></p>                                                                                                                                                                                      | procMount określa **typ montowania proc do użycia dla kontenerów**. Domyślnie jest to DefaultProcMount, który używa domyślnych ustawień ścieżek tylko do odczytu i zasłoniętych ścieżek kontenera.                                                                                                                                    |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>readOnlyRootFilesystem</strong></a><br><em>boolean</em></p>                                                                                                                                                                        | Czy ten **kontener ma system plików root tylko do odczytu**. Domyślnie ustawione na false.                                                                                                                                                                                                                                             |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsGroup</strong></a><br><em>integer</em></p>                                                                                                                                                                                    | **GID, z którym ma być uruchomiony entrypoint** procesu kontenera. Używa domyślnych ustawień czasu wykonywania, jeśli nie jest ustawione.                                                                                                                                                                                                                                |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>boolean</em></p>                                                                                                                                                                                  | Wskazuje, że kontener musi **działać jako użytkownik nie będący rootem**. Jeśli wartość jest true, Kubelet zweryfikuje obraz podczas uruchamiania, aby upewnić się, że nie działa jako UID 0 (root) i nie uruchomi kontenera, jeśli tak jest.                                                                                                          |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsUser</strong></a><br><em>integer</em></p>                                                                                                                                                                                     | **UID, z którym ma być uruchomiony entrypoint** procesu kontenera. Domyślnie jest to użytkownik określony w metadanych obrazu, jeśli nie jest określony.                                                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>More info about</em> <em><strong>seLinux</strong></em></p> | **Kontekst SELinux, który ma być zastosowany do kontenera**. Jeśli nie jest określony, czas wykonywania kontenera przydzieli losowy kontekst SELinux dla każdego kontenera.                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a></p>                                                               | **Opcje seccomp** do użycia przez ten kontener.                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                 | **Specyficzne dla systemu Windows ustawienia** stosowane do wszystkich kontenerów.                                                                                                                                                                                                                                                              |

## References

* [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core)
* [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core)

{% hint style="success" %}
Naucz się i ćwicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz się i ćwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel się trikami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}
