# Kubernetes Absicherung

{% hint style="success" %}
Lernen Sie & √ºben Sie AWS Hacking: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories senden.

</details>
{% endhint %}

## Tools zur Analyse eines Clusters

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) ist ein K8s Open-Source-Tool, das eine Multi-Cloud-K8s-√úbersicht bietet, einschlie√ülich Risikoanalyse, Sicherheitskonformit√§t, RBAC-Visualisierung und Scannen von Bildschwachstellen. Kubescape scannt K8s-Cluster, YAML-Dateien und HELM-Charts, erkennt Fehlkonfigurationen gem√§√ü mehrerer Frameworks (wie dem [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK¬Æ](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), Software-Schwachstellen und RBAC-Verst√∂√üe (rollenbasierte Zugriffskontrolle) in fr√ºhen Phasen des CI/CD-Pipelines, berechnet das Risiko sofort und zeigt Risikotrends im Laufe der Zeit an.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

Das Tool [**kube-bench**](https://github.com/aquasecurity/kube-bench) ist ein Tool, das √ºberpr√ºft, ob Kubernetes sicher bereitgestellt ist, indem es die in der [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/) dokumentierten √úberpr√ºfungen ausf√ºhrt.\
Sie k√∂nnen w√§hlen:

* kube-bench innerhalb eines Containers ausf√ºhren (PID-Namespace mit dem Host teilen)
* Einen Container ausf√ºhren, der kube-bench auf dem Host installiert und dann kube-bench direkt auf dem Host ausf√ºhrt
* Die neuesten Bin√§rdateien von der [Releases-Seite](https://github.com/aquasecurity/kube-bench/releases) installieren,
* Es aus dem Quellcode kompilieren.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

Das Tool [**kubeaudit**](https://github.com/Shopify/kubeaudit) ist ein Befehlszeilentool und ein Go-Paket zum **Auditing von Kubernetes-Clustern** hinsichtlich verschiedener Sicherheitsbedenken.

Kubeaudit kann erkennen, ob es in einem Container in einem Cluster ausgef√ºhrt wird. In diesem Fall wird versucht, alle Kubernetes-Ressourcen in diesem Cluster zu √ºberpr√ºfen:
```
kubeaudit all
```
Dieses Tool verf√ºgt auch √ºber das Argument `autofix`, um **automatisch erkannte Probleme zu beheben.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

Das Tool [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) sucht nach Sicherheitsschwachstellen in Kubernetes-Clustern. Das Tool wurde entwickelt, um das Bewusstsein und die Sichtbarkeit f√ºr Sicherheitsprobleme in Kubernetes-Umgebungen zu erh√∂hen.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) ist ein Tool zur Schwachstellenanalyse und CIS Docker-Benchmark-Tool, das es Benutzern erm√∂glicht, eine genaue und sofortige Risikobewertung ihrer Kubernetes-Cluster zu erhalten. Kubei scannt alle Bilder, die in einem Kubernetes-Cluster verwendet werden, einschlie√ülich Bilder von Anwendungspods und Systempods.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) ist ein Tool zur √úberpr√ºfung von Kubernetes-Clustern auf riskante Berechtigungen im Rollenbasierten Zugriffskontrollmodell (RBAC) von Kubernetes.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) ist ein Tool, das entwickelt wurde, um andere Arten von hochriskanten Checks im Vergleich zu anderen Tools zu testen. Es hat haupts√§chlich 3 verschiedene Modi:

* **`find-role-relationships`**: Ermittelt, welche AWS-Rollen in welchen Pods ausgef√ºhrt werden.
* **`find-secrets`**: Versucht, Geheimnisse in K8s-Ressourcen wie Pods, ConfigMaps und Secrets zu identifizieren.
* **`test-imds-access`**: Versucht, Pods auszuf√ºhren und auf die Metadaten v1 und v2 zuzugreifen. WARNUNG: Dies f√ºhrt einen Pod im Cluster aus, seien Sie sehr vorsichtig, da Sie dies m√∂glicherweise nicht tun m√∂chten!

## **Audit des IaC-Codes**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) ist ein Dienstprogramm, das live Kubernetes-Cluster scannt und **potenzielle Probleme mit bereitgestellten Ressourcen und Konfigurationen meldet**. Es bereinigt Ihren Cluster basierend auf dem, was bereitgestellt ist, und nicht auf dem, was auf der Festplatte liegt. Durch Scannen Ihres Clusters erkennt es Fehlkonfigurationen und hilft Ihnen sicherzustellen, dass bew√§hrte Verfahren eingehalten werden, um zuk√ºnftige Kopfschmerzen zu vermeiden. Es zielt darauf ab, die kognitive √úberlastung zu reduzieren, mit der man konfrontiert ist, wenn man einen Kubernetes-Cluster in freier Wildbahn betreibt. Dar√ºber hinaus meldet es potenzielle Ressourcen√ºber- oder -unterauslastungen, wenn Ihr Cluster √ºber Kapazit√§t l√§uft.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) findet **Sicherheitsl√ºcken**, Compliance-Probleme und Infrastrukturfehlkonfigurationen in den folgenden **Infrastruktur als Code-L√∂sungen**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM und OpenAPI 3.0-Spezifikationen

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) ist ein statisches Code-Analysetool f√ºr Infrastruktur als Code.

Es scannt Cloud-Infrastruktur, die mit [Terraform](https://terraform.io), Terraform-Plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) oder [ARM-Vorlagen](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) bereitgestellt wurde, und erkennt Sicherheits- und Compliance-Fehlkonfigurationen mithilfe von graphenbasiertem Scannen.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) ist ein Tool, das eine statische Codeanalyse Ihrer Kubernetes-Objektdefinitionen durchf√ºhrt.

Zur Installation:

| Distribution                                        | Befehl / Link                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Vorkompilierte Bin√§rdateien f√ºr macOS, Linux und Windows    | [GitHub-Ver√∂ffentlichungen](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS und Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS und Linux) | `kubectl krew install score`                                                            |

## Tipps

### Kubernetes PodSecurityContext und SecurityContext

Sie k√∂nnen den **Sicherheitskontext der Pods** (mit _PodSecurityContext_) und der **Container**, die ausgef√ºhrt werden sollen (mit _SecurityContext_), konfigurieren. Lesen Sie f√ºr weitere Informationen:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kubernetes-API-H√§rtung

Es ist sehr wichtig, **den Zugriff auf den Kubernetes-API-Server zu sch√ºtzen**, da ein b√∂sartiger Akteur mit ausreichenden Berechtigungen diesen missbrauchen und die Umgebung auf vielf√§ltige Weise besch√§digen k√∂nnte.\
Es ist wichtig, sowohl den **Zugriff** (Urspr√ºnge f√ºr den Zugriff auf den API-Server whitelisten und jede andere Verbindung ablehnen) als auch die [**Authentifizierung**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (nach dem Prinzip des **geringsten** **Privilegs**) zu sichern. Und definitiv **niemals** **anonyme** **Anfragen** zulassen.

**G√§ngiger Anfrageprozess:**\
Benutzer oder K8s-Servicekonto ‚Äì> Authentifizierung ‚Äì> Autorisierung ‚Äì> Zulassungssteuerung.

**Tipps**:

* Ports schlie√üen.
* Anonymen Zugriff vermeiden.
* NodeRestriction; Kein Zugriff von bestimmten Knoten auf die API.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* Verhindert im Wesentlichen, dass Kubelets Labels mit einem node-restriction.kubernetes.io/-Pr√§fix hinzuf√ºgen/entfernen/aktualisieren. Dieses Labelpr√§fix ist f√ºr Administratoren reserviert, um ihre Knotenobjekte f√ºr Zwecke der Arbeitslastisolierung zu kennzeichnen, und Kubelets d√ºrfen Labels mit diesem Pr√§fix nicht √§ndern.
* Erm√∂glicht Kubelets auch das Hinzuf√ºgen/Entfernen/Aktualisieren dieser Labels und Labelpr√§fixe.
* Stellen Sie mit Labels die sichere Arbeitslastisolierung sicher.
* Bestimmte Pods vom API-Zugriff ausschlie√üen.
* Exponieren Sie den ApiServer nicht im Internet.
* Unberechtigten Zugriff RBAC vermeiden.
* ApiServer-Port mit Firewall und IP-Whitelisting. 

### SecurityContext-H√§rtung

Standardm√§√üig wird der Root-Benutzer verwendet, wenn ein Pod gestartet wird, wenn kein anderer Benutzer angegeben ist. Sie k√∂nnen Ihre Anwendung in einem sichereren Kontext ausf√ºhren, indem Sie eine Vorlage √§hnlich der folgenden verwenden:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Allgemeine H√§rtung

Sie sollten Ihre Kubernetes-Umgebung so h√§ufig wie n√∂tig aktualisieren, um sicherzustellen, dass:

* Abh√§ngigkeiten auf dem neuesten Stand sind.
* Fehler- und Sicherheitspatches installiert sind.

[**Versionszyklen**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Alle 3 Monate gibt es eine neue Nebenversion -- 1.20.3 = 1(Hauptversion).20(Nebenversion).3(Patch)

**Der beste Weg, ein Kubernetes-Cluster zu aktualisieren, ist (von** [**hier**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

* Aktualisieren Sie die Master-Komponenten in folgender Reihenfolge:
* etcd (alle Instanzen).
* kube-apiserver (alle Steuerungsebene-Hosts).
* kube-controller-manager.
* kube-scheduler.
* Cloud-Controller-Manager, wenn Sie einen verwenden.
* Aktualisieren Sie die Worker-Komponenten wie kube-proxy, kubelet.

{% hint style="success" %}
Lernen Sie & √ºben Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie & √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>
{% endhint %}
