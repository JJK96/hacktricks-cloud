# Kubernetes Sıkılaştırma

<details>

<summary><strong>Sıfırdan kahraman olmaya kadar AWS hackleme öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)'i **takip edin**.
* **Hacking püf noktalarınızı paylaşarak PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

## Küme analiz etmek için Araçlar

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape), çoklu bulut K8s tek pencere sunan, risk analizi, güvenlik uyumluluğu, RBAC görselleştirici ve görüntü güvenlik açıkları taraması sağlayan açık kaynaklı bir K8s aracıdır. Kubescape, K8s kümelerini, YAML dosyalarını ve HELM grafiklerini tarar, [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo) gibi çeşitli çerçevelere göre yanlış yapılandırmaları, yazılım güvenlik açıklarını ve RBAC (rol-tabanlı-erişim-kontrol) ihlallerini tespit eder, CI/CD boru hattının erken aşamalarında risk puanını anında hesaplar ve zaman içinde risk eğilimlerini gösterir.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

[**Kube-bench**](https://github.com/aquasecurity/kube-bench) aracı, [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/) belgelerinde belirtilen denetimleri çalıştırarak Kubernetes'in güvenli bir şekilde dağıtılıp dağıtılmadığını kontrol eden bir araçtır.\
Şunları seçebilirsiniz:

* bir konteyner içinden kube-bench'i çalıştırın (ana makineyle PID ad alanını paylaşarak)
* ana makineye kube-bench'i yükleyen bir konteyner çalıştırın ve ardından kube-bench'i doğrudan ana makinede çalıştırın
* [Yayınlar sayfasından](https://github.com/aquasecurity/kube-bench/releases) en son ikili dosyaları yükleyin,
* kaynaktan derleyin.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

[**Kubeaudit**](https://github.com/Shopify/kubeaudit) aracı, çeşitli farklı güvenlik endişeleri için **Kubernetes kümelerini denetlemek** için bir komut satırı aracı ve bir Go paketidir.

Kubeaudit, bir kümedeki bir konteyner içinde çalıştırılıp çalıştırılmadığını algılayabilir. Eğer öyleyse, o kümedeki tüm Kubernetes kaynaklarını denetlemeye çalışacaktır:
```
kubeaudit all
```
Bu aracın ayrıca tespit edilen sorunları **otomatik olarak düzeltmek** için `autofix` argümanı bulunmaktadır.

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

[**Kube-hunter**](https://github.com/aquasecurity/kube-hunter) aracı, Kubernetes kümelerindeki güvenlik zayıflıklarını arar. Aracın amacı, Kubernetes ortamlarındaki güvenlik sorunlarına yönelik farkındalığı ve görünürlüğü artırmaktır.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei), kubernetes kümelerinin doğru ve hızlı bir risk değerlendirmesi almasını sağlayan bir zafiyet tarama ve CIS Docker benchmark aracıdır. Kubei, bir Kubernetes kümesinde kullanılan tüm görüntüleri tarar, uygulama pod'larının ve sistem pod'larının görüntülerini içerir.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan), Kubernetes kümesini tarayan ve Kubernetes'in Rol tabanlı erişim kontrolü (RBAC) yetkilendirme modelinde riskli izinleri taramak için bir araçtır.

### [Yönetilen Kubernetes Denetim Aracı Kiti](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit), diğer araçlarla karşılaştırıldığında yüksek riskli kontrolleri test etmek için oluşturulmuş bir araçtır. Genellikle 3 farklı modu vardır:

* **`find-role-relationships`**: Hangi AWS rollerinin hangi pod'larda çalıştığını bulur
* **`find-secrets`**: Pod'lar, ConfigMaps ve Secrets gibi K8s kaynaklarında gizli bilgileri tanımlamaya çalışır.
* **`test-imds-access`**: Pod'ları çalıştırmaya ve metadata v1 ve v2'ye erişmeye çalışır. UYARI: Bu, bir pod'u kümede çalıştıracaktır, bunu yapmak istemeyebilirsiniz, çok dikkatli olun!

## **IaC Kodunu Denetleme**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye), canlı Kubernetes kümesini tarayan ve **dağıtılan kaynaklar ve yapılandırmalarla ilgili potansiyel sorunları raporlayan** bir yardımcı programdır. Kümenizi tarayarak, yanlış yapılandırmaları tespit eder ve en iyi uygulamaların yerinde olduğundan emin olmanıza yardımcı olarak gelecekteki baş ağrılarını önler. Vahşi doğada bir Kubernetes kümesini işletirken karşılaşılan bilişsel yükü azaltmayı amaçlar. Ayrıca, kümeniz bir metrik sunucusu kullanıyorsa, potansiyel kaynak aşırı/eksik tahsislerini raporlar ve kümenizin kapasitesinin tükendiğinde sizi uyarır.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics), aşağıdaki **Altyapı olarak Kod çözümlerinde** güvenlik zafiyetlerini, uyumluluk sorunlarını ve altyapı yan yapılandırmalarını bulur: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM ve OpenAPI 3.0 özellikleri

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov), altyapı olarak kod için bir statik kod analiz aracıdır.

[Terraform](https://terraform.io), Terraform plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) veya [ARM Şablonları](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) kullanılarak sağlanan bulut altyapısını grafik tabanlı tarama kullanarak güvenlik ve uyumluluk yan yapılandırmalarını tespit eder.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score), Kubernetes nesne tanımlamalarını statik kod analizi yapabilen bir araçtır.

Kurulum için:

| Dağıtım                                             | Komut / Bağlantı                                                                        |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| macOS, Linux ve Windows için derlenmiş ikili dosyalar | [GitHub sürümleri](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS ve Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS ve Linux) | `kubectl krew install score`                                                            |

## İpuçları

### Kubernetes PodSecurityContext ve SecurityContext

**Pod'ların güvenlik bağlamını** (_PodSecurityContext_ ile) ve çalıştırılacak olan **konteynerlerin** (_SecurityContext_ ile) güvenlik bağlamını yapılandırabilirsiniz. Daha fazla bilgi için okuyun:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kubernetes API Sıkılaştırma

**Kubernetes Api Sunucusuna erişimi korumak** çok önemlidir, çünkü yeterli ayrıcalıklara sahip kötü niyetli bir aktör, çevreye birçok şekilde zarar verebilir.\
**Erişimi** (**API Sunucusuna erişim için whitelist** kökenler ve diğer bağlantıları reddetme) ve [**kimlik doğrulama**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (en az ayrıcalık ilkesini takip etme) güvence altına almak önemlidir. Ve kesinlikle **anonim isteklere asla izin vermemek** önemlidir.

**Ortak İstek Süreci:**\
Kullanıcı veya K8s Hizmet Hesabı –> Kimlik Doğrulama –> Yetkilendirme –> Kabul Kontrolü.

**İpuçları**:

* Portları kapatın.
* Anonim erişimden kaçının.
* NodeRestriction; API'ye belirli düğümlerden erişimi engelleme.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* Temelde kubeletlerin, bu etiketleri ve etiket öneklerini eklemesine/çıkarmasına/ güncellemesine izin vermez. Bu etiket öneki, yöneticilerin iş yükü izolasyonu amaçları için Node nesnelerine etiket eklemeleri içindir ve kubeletler bu önekle etiketleri değiştiremeyecektir.
* Etiketlerle güvenli iş yükü izolasyonunu sağlayın.
* Belirli pod'ların API erişiminden kaçının.
* ApiServer'ın internete açık olmasını önleyin.
* Yetkisiz erişimi RBAC ile engelleyin.
* ApiServer portunu güvenlik duvarı ve IP beyaz listeleme ile koruyun.

### SecurityContext Sıkılaştırma

Varsayılan olarak, başka bir kullanıcı belirtilmediğinde bir Pod başlatıldığında kök kullanıcı kullanılacaktır. Uygulamanızı aşağıdaki şablon benzeri bir şablonda çalıştırarak daha güvenli bir bağlamda çalıştırabilirsiniz:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Genel Sıkılaştırma

Gerektiğinde Kubernetes ortamınızı güncellemelisiniz:

* Bağımlılıklar güncel.
* Hata ve güvenlik yamaları.

[**Sürüm döngüleri**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Her 3 ayda bir yeni bir küçük sürüm çıkar -- 1.20.3 = 1(Büyük).20(Küçük).3(yama)

**Bir Kubernetes Kümesini güncellemenin en iyi yolu (buradan** [**buraya**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

* Master Düğüm bileşenlerini şu sırayla güncelleyin:
* etcd (tüm örnekler).
* kube-apiserver (tüm kontrol düzlemi ana bilgisayarları).
* kube-controller-manager.
* kube-scheduler.
* Bulut denetleyici yöneticisi, kullanıyorsanız.
* kube-proxy, kubelet gibi İşçi Düğüm bileşenlerini güncelleyin.

<details>

<summary><strong>Sıfırdan kahraman olmak için AWS hacklemeyi öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya beni **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)'de **takip edin**.
* **Hacking hilelerinizi paylaşarak PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
