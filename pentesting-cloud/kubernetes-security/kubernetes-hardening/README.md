# Kubernetesのハードニング

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してハッキングトリックを共有してください。

</details>
{% endhint %}

## クラスタを分析するためのツール

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape)は、K8sのオープンソースツールで、リスク分析、セキュリティコンプライアンス、RBACビジュアライザー、およびイメージの脆弱性スキャンを提供するマルチクラウドK8sシングルペインオブグラスです。Kubescapeは、K8sクラスタ、YAMLファイル、HELMチャートをスキャンし、複数のフレームワーク（[NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo)、[MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)など）に従ってミス構成を検出し、ソフトウェアの脆弱性やRBAC（ロールベースアクセス制御）の違反をCI/CDパイプラインの初期段階で計算し、リスクスコアを即座に表示し、時間の経過とともにリスクトレンドを表示します。
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

ツール[**kube-bench**](https://github.com/aquasecurity/kube-bench)は、[**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/)で文書化されたチェックを実行して、Kubernetesがセキュアに展開されているかどうかを確認するツールです。\
次の方法で実行できます：

* ホストとPIDネームスペースを共有するコンテナ内からkube-benchを実行する
* ホストにkube-benchをインストールするコンテナを実行し、その後ホストでkube-benchを直接実行する
* [リリースページ](https://github.com/aquasecurity/kube-bench/releases)から最新のバイナリをインストールする
* ソースからコンパイルする。

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

ツール[**kubeaudit**](https://github.com/Shopify/kubeaudit)は、さまざまなセキュリティ上の懸念事項に対して**Kubernetesクラスタ**を監査するためのコマンドラインツールおよびGoパッケージです。

Kubeauditは、クラスタ内のコンテナで実行されているかどうかを検出できます。その場合、そのクラスタ内のすべてのKubernetesリソースを監査しようとします。
```
kubeaudit all
```
このツールには、検出された問題を**自動的に修正する**ための引数 `autofix` もあります。

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

ツール [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) は、Kubernetes クラスター内のセキュリティ上の脆弱性を探します。このツールは、Kubernetes 環境におけるセキュリティ問題の認識と可視性を高めるために開発されました。
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei)は、ユーザーがkubernetesクラスターの正確で即座のリスク評価を行うことを可能にする脆弱性スキャンおよびCIS Dockerベンチマークツールです。Kubeiは、Kubernetesクラスターで使用されているすべてのイメージをスキャンします。これには、アプリケーションポッドおよびシステムポッドのイメージが含まれます。

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan)は、Kubernetesクラスターをスキャンして、Kubernetesのロールベースアクセス制御（RBAC）認可モデルでのリスクのある権限を検出するツールです。

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)は、他の種類の高リスクチェックをテストするために構築されたツールです。主に3つの異なるモードがあります：

* **`find-role-relationships`**: AWSロールがどのポッドで実行されているかを見つけます
* **`find-secrets`**: ポッド、ConfigMaps、SecretsなどのK8sリソース内のシークレットを特定しようとします。
* **`test-imds-access`**: ポッドを実行し、メタデータv1およびv2にアクセスしようとします。警告：これによりクラスター内でポッドが実行されるため、これを行いたくない場合があるため、非常に注意してください！

## **IaCコードの監査**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye)は、ライブKubernetesクラスターをスキャンし、**デプロイされたリソースと構成に関する潜在的な問題を報告**するユーティリティです。クラスターをスキャンすることで、ミス構成を検出し、ベストプラクティスが適用されていることを確認し、将来の問題を防ぎます。これにより、野生のKubernetesクラスターを操作する際に直面する認知負荷を軽減することを目指しています。さらに、クラスターがメトリックサーバーを使用している場合、潜在的なリソースの過剰/不足割り当てを報告し、クラスターが容量不足になると警告を試みます。

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics)は、次の**インフラストラクチャコードソリューション**で**セキュリティ脆弱性**、コンプライアンスの問題、およびインフラストラクチャのミス構成を検出します：Terraform、Kubernetes、Docker、AWS CloudFormation、Ansible、Helm、Microsoft ARM、およびOpenAPI 3.0の仕様

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov)は、インフラストラクチャコード用の静的コード解析ツールです。

[Terraform](https://terraform.io)、Terraform plan、[Cloudformation](https://aws.amazon.com/cloudformation/)、[AWS SAM](https://aws.amazon.com/serverless/sam/)、[Kubernetes](https://kubernetes.io)、[Dockerfile](https://www.docker.com)、[Serverless](https://www.serverless.com)、または[ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview)を使用してプロビジョニングされたクラウドインフラストラクチャをスキャンし、グラフベースのスキャンを使用してセキュリティおよびコンプライアンスのミス構成を検出します。

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score)は、Kubernetesオブジェクト定義の静的コード解析を実行するツールです。

インストール方法：

| ディストリビューション                               | コマンド/リンク                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| macOS、Linux、Windows用の事前ビルドバイナリ           | [GitHubリリース](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew（macOSおよびLinux）                         | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/)（macOSおよびLinux） | `kubectl krew install score`                                                            |

## ヒント

### Kubernetes PodSecurityContextとSecurityContext

**PodSecurityContext**でポッドの**セキュリティコンテキスト**を構成し、**SecurityContext**で実行される**コンテナ**のセキュリティコンテキストを構成できます。詳細については、次を参照してください：

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kubernetes APIのハードニング

**Kubernetes Api Serverへのアクセスを保護することは非常に重要**です。十分な権限を持つ悪意のあるアクターがそれを悪用し、環境を多くの方法で損傷させる可能性があるためです。\
**アクセス**（API Serverへのアクセスの**ホワイトリスト**化と他の接続を拒否する）と[**認証**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/)（**最小特権**の原則に従う）を確保することが重要です。そして、**決して** **匿名** **リクエスト**を**許可**しないことが重要です。

**一般的なリクエストプロセス：**\
ユーザーまたはK8s ServiceAccount –> 認証 –> 認可 –> アドミッションコントロール。

**ヒント**：

* ポートを閉じる。
* 匿名アクセスを避ける。
* NodeRestriction；特定のノードからAPIへのアクセスを拒否する。
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* これは、kubeletsがノードオブジェクトをワークロード分離の目的でラベル付けするために予約されたラベル接頭辞であるnode-restriction.kubernetes.io/接頭辞のラベルを追加/削除/更新することを許可しません。
* また、kubeletsがこれらのラベルとラベル接頭辞を追加/削除/更新できるようにします。
* ラベルを使用してセキュアなワークロード分離を確保します。
* 特定のポッドがAPIアクセスを拒否します。
* ApiServerのインターネットへの露出を避ける。
* 不正なアクセスRBACを避ける。
* ファイアウォールとIPホワイトリストを使用したApiServerポートの保護。
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### 一般的なハードニング

必要に応じてKubernetes環境を以下のように頻繁に更新する必要があります：

* 依存関係を最新の状態に保つ。
* バグとセキュリティパッチを適用する。

[**リリースサイクル**](https://kubernetes.io/docs/setup/release/version-skew-policy/): 3ヶ月ごとに新しいマイナーリリースがあります -- 1.20.3 = 1(メジャー).20(マイナー).3(パッチ)

**Kubernetesクラスタをアップデートする最良の方法は（**[**こちら**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**）:**

* このシーケンスに従ってマスターノードコンポーネントをアップグレードする：
* etcd（すべてのインスタンス）。
* kube-apiserver（すべてのコントロールプレーンホスト）。
* kube-controller-manager。
* kube-scheduler。
* クラウドコントローラーマネージャ（使用している場合）。
* kube-proxy、kubeletなどのワーカーノードコンポーネントをアップグレードする。

{% hint style="success" %}
AWSハッキングの学習と実践:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と実践: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローする。**
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出してハッキングトリックを共有する。

</details>
{% endhint %}
