# Kubernetes Verharding

<details>

<summary><strong>Leer AWS hak vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling van eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou haktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## Gereedskap om 'n groep te analiseer

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) is 'n K8s oopbron-gereedskap wat 'n multi-wolk K8s enkelvenster bied, insluitend risiko-analise, sekuriteitsnakoming, RBAC-visualiseerder en beeldkwesbaarhede-skandering. Kubescape skandeer K8s-groepe, YAML-l√™ers, en HELM-kaarte, wat verkeerde konfigurasies opspoor volgens verskeie raamwerke (soos die [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo) , [MITRE ATT\&CK¬Æ](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), sagtewarekwesbaarhede, en RBAC (rolgebaseerde-toegangsbeheer) oortredings in die vroe√´ stadiums van die CI/CD-pyplyn, bereken risikoscore onmiddellik en toon risikotendense oor tyd.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

Die gereedskap [**kube-bench**](https://github.com/aquasecurity/kube-bench) is 'n gereedskap wat nagaan of Kubernetes veilig ge√Ømplementeer is deur die kontroles uit te voer wat gedokumenteer is in die [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Jy kan kies om:

* voer kube-bench uit binne 'n houer (PID-namespace deel met die gasheer)
* voer 'n houer uit wat kube-bench op die gasheer installeer, en voer dan kube-bench direk op die gasheer uit
* installeer die nuutste bine√™re l√™ers van die [Releases-bladsy](https://github.com/aquasecurity/kube-bench/releases),
* dit van bron af saamstel.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

Die gereedskap [**kubeaudit**](https://github.com/Shopify/kubeaudit) is 'n opdraglyn-gereedskap en 'n Go-pakket om **Kubernetes-klusters te oudit** vir verskeie sekuriteitskwessies.

Kubeaudit kan opspoor of dit binne 'n houer in 'n kluster uitgevoer word. Indien wel, sal dit probeer om alle Kubernetes-hulpbronne in daardie kluster te oudit:
```
kubeaudit all
```
Hierdie instrument het ook die argument `autofix` om **opgespoorde kwessies outomaties te reg.**

### [**Kube-jagter**](https://github.com/aquasecurity/kube-hunter)

Die instrument [**kube-jagter**](https://github.com/aquasecurity/kube-hunter) soek na sekuriteitskwessies in Kubernetes-klusters. Die instrument is ontwikkel om bewustheid en sigbaarheid vir sekuriteitskwessies in Kubernetes-omgewings te verhoog.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) is 'n kwesbaarhede-skandering en CIS Docker toets wat gebruikers in staat stel om 'n akkurate en onmiddellike risiko-assessering van hul kubernetes-klusters te kry. Kubei skandeer alle beelde wat in 'n Kubernetes-kluster gebruik word, insluitend beelde van toepassingspeules en stelselpeules.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) is 'n instrument vir die skandering van 'n Kubernetes-kluster vir risikovolle toestemmings in Kubernetes se Rolgebaseerde toegangsbeheer (RBAC) magtigingsmodel.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) is 'n instrument wat gebou is om ander tipe ho√´ risiko-toetse te toets in vergelyking met die ander instrumente. Dit het hoofsaaklik 3 verskillende modusse:

* **`find-role-relationships`**: Wat sal vind watter AWS-rolle in watter peules hardloop
* **`find-secrets`**: Wat poog om geheime in K8s-hulpbronne soos Peules, ConfigMaps, en Geheime te identifiseer.
* **`test-imds-access`**: Wat sal poog om peules te hardloop en toegang tot die metadata v1 en v2 te verkry. WAARSKUWING: Dit sal 'n peul in die kluster hardloop, wees baie versigtig omdat jy dit miskien nie wil doen nie!

## **Toets IaC-kode**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) is 'n nut wat lewendige Kubernetes-kluster skandeer en **potensi√´le probleme met ge√Ømplementeerde hulpbronne en konfigurasies rapporteer**. Dit maak jou kluster skoon op grond van wat ge√Ømplementeer is en nie wat op die skyf sit nie. Deur jou kluster te skandeer, ontdek dit wanopsette en help dit om te verseker dat die beste praktyke op hul plek is, wat toekomstige kopseer voorkom. Dit mik daarop om die kognitiewe \_oorlading te verminder wat 'n mens in die wild ervaar wanneer 'n Kubernetes-kluster bedryf word. Verder, as jou kluster 'n metriek-bediener gebruik, rapporteer dit potensi√´le hulpbronne oor/onder toekenning en probeer om jou te waarsku as jou kluster uit kapasiteit loop.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) vind **sekuriteitskwesbaarhede**, nakomingskwessies, en infrastruktuurmisconfiguraties in die volgende **Infrastruktuur as Kode-oplossings**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM, en OpenAPI 3.0 spesifikasies

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) is 'n statiese kode-ontledingsinstrument vir infrastruktuur-as-kode.

Dit skandeer wolk-infrastruktuur wat voorsien is met [Terraform](https://terraform.io), Terraform-plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) of [ARM-sjablone](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) en ontdek sekuriteits- en nakomingsmisconfiguraties deur middel van grafiekgebaseerde skandering.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) is 'n instrument wat statiese kode-ontleding van jou Kubernetes-objekdefinisies uitvoer.

Om te installeer:

| Verspreiding                                        | Opdrag / Skakel                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Voorafgeboude bina√™re l√™ers vir macOS, Linux, en Windows    | [GitHub vrystellings](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS en Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS en Linux) | `kubectl krew install score`                                                            |

## Wenke

### Kubernetes PodSecurityContext en SecurityContext

Jy kan die **sekuriteitskonteks van die Peules** (met _PodSecurityContext_) en van die **houers** wat gaan hardloop, konfigureer (met _SecurityContext_). Vir meer inligting lees:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kubernetes API-verharding

Dit is baie belangrik om **die toegang tot die Kubernetes-API-bediener te beskerm** aangesien 'n kwaadwillige akteur met genoeg voorregte dit kan misbruik en op baie maniere die omgewing kan beskadig.\
Dit is belangrik om beide die **toegang** te beveilig (**witlys** oorspronge om toegang tot die API-bediener te verkry en enige ander verbinding te ontken) en die [**verifikasie**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (deur die beginsel van **minste** **voorreg** te volg). En beslis **nooit** **anonieme** **versoeke** **toe** **te** **laat**.

**Gewone versoekproses:**\
Gebruiker of K8s-diensrekening ‚Äì> Verifikasie ‚Äì> Magtiging ‚Äì> Toelatingsbeheer.

**Wenke**:

* Sluit porte.
* Vermy Anonieme toegang.
* NodeRestriction; Geen toegang vanaf spesifieke nodes tot die API.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* Voorkom basies dat kubelets etikette met 'n node-restriction.kubernetes.io/ voorvoegsel byvoeg/verwyder/opdateer. Hierdie etiketvoorvoegsel is gereserveer vir administrateurs om hul Node-voorwerpe te etiketteer vir werklasdoeleindes, en kubelets sal nie toegelaat word om etikette met daardie voorvoegsel te wysig nie.
* En ook, laat kubelets toe om hierdie etikette en etiketvoorvoegsels by te voeg/verwyder/opdateer.
* Verseker met etikette die veilige werklas-isolasie.
* Vermy spesifieke peules van API-toegang.
* Vermy ApiServer-blootstelling aan die internet.
* Vermy ongemagtigde toegang RBAC.
* ApiServer-poort met firewall en IP-witlysing.

### SecurityContext-verharding

Standaard sal die root-gebruiker gebruik word wanneer 'n Peul begin word as geen ander gebruiker gespesifiseer is nie. Jy kan jou toepassing binne 'n meer veilige konteks hardloop deur 'n templaat soortgelyk aan die volgende te gebruik:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Algemene Verharding

Jy moet jou Kubernetes-omgewing so gereeld as nodig opdateer om te verseker dat:

* Afhanklikhede op datum is.
* Fout- en sekuriteitspatches.

[**Vrystellingsiklusse**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Elke 3 maande is daar 'n nuwe klein vrystelling -- 1.20.3 = 1(Hoof).20(Klein).3(patch)

**Die beste manier om 'n Kubernetes-kluster op te dateer is (van** [**hier**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

* Opgradeer die Meester Node-komponente in hierdie volgorde:
* etcd (alle instansies).
* kube-apiserver (alle beheervlak-gashere).
* kube-controller-bestuurder.
* kube-scheduler.
* wolkbeheerder, indien jy een gebruik.
* Opgradeer die Werker Node-komponente soos kube-proxy, kubelet.

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
