# Fortalecimiento de Kubernetes

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipo Rojo de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Herramientas para analizar un cl√∫ster

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) es una herramienta de c√≥digo abierto de K8s que proporciona una vista √∫nica de m√∫ltiples nubes de K8s, incluyendo an√°lisis de riesgos, cumplimiento de seguridad, visualizador de RBAC y escaneo de vulnerabilidades de im√°genes. Kubescape escanea cl√∫steres de K8s, archivos YAML y gr√°ficos HELM, detectando configuraciones incorrectas seg√∫n m√∫ltiples marcos (como el [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK¬Æ](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), vulnerabilidades de software y violaciones de RBAC (control de acceso basado en roles) en las primeras etapas del pipeline CI/CD, calcula el puntaje de riesgo al instante y muestra tendencias de riesgo con el tiempo.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

La herramienta [**kube-bench**](https://github.com/aquasecurity/kube-bench) es una herramienta que verifica si Kubernetes est√° desplegado de forma segura ejecutando las verificaciones documentadas en el [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Puedes elegir:

* ejecutar kube-bench desde dentro de un contenedor (compartiendo el espacio de nombres PID con el host)
* ejecutar un contenedor que instala kube-bench en el host, y luego ejecutar kube-bench directamente en el host
* instalar los binarios m√°s recientes desde la [p√°gina de versiones (Releases page)](https://github.com/aquasecurity/kube-bench/releases),
* compilarlo desde el c√≥digo fuente.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

La herramienta [**kubeaudit**](https://github.com/Shopify/kubeaudit) es una herramienta de l√≠nea de comandos y un paquete Go para **auditar cl√∫steres de Kubernetes** en busca de diversas preocupaciones de seguridad.

Kubeaudit puede detectar si se est√° ejecutando dentro de un contenedor en un cl√∫ster. Si es as√≠, intentar√° auditar todos los recursos de Kubernetes en ese cl√∫ster:
```
kubeaudit all
```
Este herramienta tambi√©n tiene el argumento `autofix` para **corregir autom√°ticamente los problemas detectados.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

La herramienta [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) busca debilidades de seguridad en cl√∫steres de Kubernetes. La herramienta fue desarrollada para aumentar la conciencia y visibilidad de problemas de seguridad en entornos de Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) es una herramienta de escaneo de vulnerabilidades y benchmark CIS Docker que permite a los usuarios obtener una evaluaci√≥n de riesgos precisa e inmediata de sus cl√∫steres de Kubernetes. Kubei escanea todas las im√°genes que se utilizan en un cl√∫ster de Kubernetes, incluidas las im√°genes de los pods de aplicaciones y los pods del sistema.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) es una herramienta para escanear cl√∫steres de Kubernetes en busca de permisos riesgosos en el modelo de autorizaci√≥n basado en roles (RBAC) de Kubernetes.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) es una herramienta dise√±ada para probar otro tipo de verificaciones de alto riesgo en comparaci√≥n con otras herramientas. Principalmente tiene 3 modos diferentes:

* **`find-role-relationships`**: Que encontrar√° qu√© roles de AWS se est√°n ejecutando en qu√© pods.
* **`find-secrets`**: Que intenta identificar secretos en recursos de K8s como Pods, ConfigMaps y Secrets.
* **`test-imds-access`**: Que intentar√° ejecutar pods y acceder a los metadatos v1 y v2. ADVERTENCIA: Esto ejecutar√° un pod en el cl√∫ster, ¬°ten mucho cuidado porque tal vez no quieras hacer esto!

## **Auditar C√≥digo IaC**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) es una utilidad que escanea cl√∫steres de Kubernetes en vivo y **reporta posibles problemas con los recursos y configuraciones implementados**. Limpia su cl√∫ster en funci√≥n de lo que est√° implementado y no de lo que est√° en disco. Al escanear su cl√∫ster, detecta configuraciones incorrectas y le ayuda a garantizar que las mejores pr√°cticas est√©n en su lugar, evitando as√≠ dolores de cabeza futuros. Su objetivo es reducir la sobrecarga cognitiva que uno enfrenta al operar un cl√∫ster de Kubernetes en la naturaleza. Adem√°s, si su cl√∫ster emplea un servidor de m√©tricas, informa posibles sobreasignaciones/subasignaciones de recursos e intenta advertirle si su cl√∫ster se queda sin capacidad.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) encuentra **vulnerabilidades de seguridad**, problemas de cumplimiento y configuraciones incorrectas de infraestructura en las siguientes **soluciones de Infraestructura como C√≥digo**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM y especificaciones OpenAPI 3.0

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) es una herramienta de an√°lisis est√°tico de c√≥digo para infraestructura como c√≥digo.

Escanea la infraestructura en la nube provista utilizando [Terraform](https://terraform.io), Terraform plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) o [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) y detecta configuraciones incorrectas de seguridad y cumplimiento utilizando un escaneo basado en gr√°ficos.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) es una herramienta que realiza an√°lisis de c√≥digo est√°tico de las definiciones de objetos de Kubernetes.

Para instalar:

| Distribuci√≥n                                        | Comando / Enlace                                                                        |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Binarios precompilados para macOS, Linux y Windows  | [Lanzamientos de GitHub](https://github.com/zegl/kube-score/releases)                    |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS y Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS y Linux) | `kubectl krew install score`                                                            |

## Consejos

### Contexto de Seguridad de Pod y Contexto de Seguridad

Puede configurar el **contexto de seguridad de los Pods** (con _PodSecurityContext_) y de los **contenedores** que se van a ejecutar (con _SecurityContext_). Para obtener m√°s informaci√≥n, lea:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Reforzamiento de la API de Kubernetes

Es muy importante **proteger el acceso al servidor de la API de Kubernetes** ya que un actor malicioso con suficientes privilegios podr√≠a abusar de √©l y da√±ar el entorno de muchas maneras.\
Es importante asegurar tanto el **acceso** (permitir solo or√≠genes en la lista blanca para acceder al servidor de la API y denegar cualquier otra conexi√≥n) como la [**autenticaci√≥n**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (siguiendo el principio de **menor** **privilegio**). Y definitivamente **nunca** **permitir** **solicitudes** **an√≥nimas**.

**Proceso de solicitud com√∫n:**\
Usuario o Cuenta de Servicio de K8s ‚Äì> Autenticaci√≥n ‚Äì> Autorizaci√≥n ‚Äì> Control de Admisi√≥n.

**Consejos**:

* Cerrar puertos.
* Evitar el acceso an√≥nimo.
* Restricci√≥n de Nodo; Sin acceso desde nodos espec√≠ficos a la API.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* B√°sicamente evita que los kubelets agreguen/quiten/actualicen etiquetas con un prefijo de node-restriction.kubernetes.io/. Este prefijo de etiqueta est√° reservado para que los administradores etiqueten sus objetos de Nodo con fines de aislamiento de carga de trabajo, y no se permitir√° que los kubelets modifiquen etiquetas con ese prefijo.
* Y tambi√©n, permite a los kubelets agregar/quitar/actualizar estas etiquetas y prefijos de etiquetas.
* Asegurar con etiquetas el aislamiento seguro de la carga de trabajo.
* Evitar que pods espec√≠ficos accedan a la API.
* Evitar la exposici√≥n del ApiServer a internet.
* Evitar el acceso no autorizado RBAC.
* Puerto de ApiServer con firewall y lista blanca de IP.

### Reforzamiento del Contexto de Seguridad

Por defecto, se utilizar√° el usuario root cuando se inicie un Pod si no se especifica otro usuario. Puede ejecutar su aplicaci√≥n dentro de un contexto m√°s seguro utilizando una plantilla similar a la siguiente:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Endurecimiento General

Deber√≠as actualizar tu entorno de Kubernetes tan frecuentemente como sea necesario para tener:

* Dependencias actualizadas.
* Parches de errores y seguridad.

[**Ciclos de lanzamiento**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Cada 3 meses hay un nuevo lanzamiento menor -- 1.20.3 = 1(Mayor).20(Menor).3(parche)

**La mejor manera de actualizar un cl√∫ster de Kubernetes es (desde** [**aqu√≠**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

* Actualiza los componentes del Nodo Maestro siguiendo esta secuencia:
* etcd (todas las instancias).
* kube-apiserver (todos los hosts del plano de control).
* kube-controller-manager.
* kube-scheduler.
* cloud controller manager, si utilizas uno.
* Actualiza los componentes del Nodo de Trabajo como kube-proxy, kubelet.

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
