# Renforcement de la s√©curit√© de Kubernetes

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## Outils pour analyser un cluster

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) est un outil open-source K8s fournissant une vue d'ensemble multi-cloud de K8s, comprenant l'analyse des risques, la conformit√© de s√©curit√©, un visualiseur RBAC et la num√©risation des vuln√©rabilit√©s des images. Kubescape analyse les clusters K8s, les fichiers YAML et les charts HELM, d√©tectant les mauvaises configurations selon plusieurs cadres (comme le [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK¬Æ](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), les vuln√©rabilit√©s logicielles et les violations de RBAC (contr√¥le d'acc√®s bas√© sur les r√¥les) aux premiers stades du pipeline CI/CD, calculant instantan√©ment le score de risque et montrant les tendances des risques au fil du temps.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

L'outil [**kube-bench**](https://github.com/aquasecurity/kube-bench) est un outil qui v√©rifie si Kubernetes est d√©ploy√© de mani√®re s√©curis√©e en ex√©cutant les v√©rifications document√©es dans le [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Vous pouvez choisir de :

* ex√©cuter kube-bench depuis l'int√©rieur d'un conteneur (partageant l'espace de nom PID avec l'h√¥te)
* ex√©cuter un conteneur qui installe kube-bench sur l'h√¥te, puis ex√©cuter kube-bench directement sur l'h√¥te
* installer les binaires les plus r√©cents depuis la [page des Releases](https://github.com/aquasecurity/kube-bench/releases),
* le compiler √† partir de la source.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

L'outil [**kubeaudit**](https://github.com/Shopify/kubeaudit) est un outil en ligne de commande et un package Go pour **auditer les clusters Kubernetes** pour divers probl√®mes de s√©curit√© diff√©rents.

Kubeaudit peut d√©tecter s'il s'ex√©cute √† l'int√©rieur d'un conteneur dans un cluster. Dans ce cas, il essaiera d'auditer toutes les ressources Kubernetes dans ce cluster :
```
kubeaudit all
```
Ce outil dispose √©galement de l'argument `autofix` pour **corriger automatiquement les probl√®mes d√©tect√©s.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

L'outil [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) recherche les faiblesses de s√©curit√© dans les clusters Kubernetes. L'outil a √©t√© d√©velopp√© pour sensibiliser et mettre en lumi√®re les probl√®mes de s√©curit√© dans les environnements Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) est un outil d'analyse des vuln√©rabilit√©s et de r√©f√©rentiel CIS Docker qui permet aux utilisateurs d'obtenir une √©valuation pr√©cise et imm√©diate des risques de leurs clusters Kubernetes. Kubei analyse toutes les images utilis√©es dans un cluster Kubernetes, y compris les images des pods d'application et des pods syst√®me.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) est un outil d'analyse des autorisations risqu√©es dans un cluster Kubernetes bas√© sur le mod√®le d'autorisation bas√© sur les r√¥les (RBAC) de Kubernetes.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) est un outil con√ßu pour tester d'autres types de v√©rifications √† haut risque par rapport aux autres outils. Il comporte principalement 3 modes diff√©rents :

* **`find-role-relationships`**: Qui permet de trouver quels r√¥les AWS s'ex√©cutent dans quels pods
* **`find-secrets`**: Qui tente d'identifier les secrets dans les ressources K8s telles que les Pods, ConfigMaps et Secrets.
* **`test-imds-access`**: Qui tentera d'ex√©cuter des pods et d'acc√©der aux m√©tadonn√©es v1 et v2. AVERTISSEMENT : Cela ex√©cutera un pod dans le cluster, soyez tr√®s prudent car vous ne voudrez peut-√™tre pas le faire !

## **Audit du code IaC**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) est un utilitaire qui analyse en direct le cluster Kubernetes et **signale les probl√®mes potentiels avec les ressources et configurations d√©ploy√©es**. Il nettoie votre cluster en fonction de ce qui est d√©ploy√© et non de ce qui est stock√© sur le disque. En analysant votre cluster, il d√©tecte les mauvaises configurations et vous aide √† garantir que les meilleures pratiques sont en place, pr√©venant ainsi les probl√®mes futurs. Il vise √† r√©duire la surcharge cognitive √† laquelle on est confront√© lors de l'exploitation d'un cluster Kubernetes dans la nature. De plus, si votre cluster utilise un serveur de m√©triques, il signale les ressources potentielles en surallocation/sous-allocation et tente de vous avertir si votre cluster manque de capacit√©.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) trouve des **vuln√©rabilit√©s de s√©curit√©**, des probl√®mes de conformit√© et des erreurs de configuration d'infrastructure dans les solutions **Infrastructure as Code** suivantes : Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM et les sp√©cifications OpenAPI 3.0

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) est un outil d'analyse statique du code pour l'infrastructure en tant que code.

Il analyse l'infrastructure cloud provisionn√©e √† l'aide de [Terraform](https://terraform.io), Terraform plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) ou [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) et d√©tecte les erreurs de configuration de s√©curit√© et de conformit√© √† l'aide d'une analyse bas√©e sur des graphiques.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) est un outil qui effectue une analyse statique du code de vos d√©finitions d'objets Kubernetes.

Pour installer :

| Distribution                                        | Commande / Lien                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Binaires pr√©-construits pour macOS, Linux et Windows | [Versions GitHub](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS et Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS et Linux) | `kubectl krew install score`                                                            |

## Conseils

### Contexte de s√©curit√© des Pods Kubernetes et SecurityContext

Vous pouvez configurer le **contexte de s√©curit√© des Pods** (avec _PodSecurityContext_) et des **conteneurs** qui vont √™tre ex√©cut√©s (avec _SecurityContext_). Pour plus d'informations, consultez :

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Durcissement de l'API Kubernetes

Il est tr√®s important de **prot√©ger l'acc√®s au serveur API Kubernetes** car un acteur malveillant avec suffisamment de privil√®ges pourrait l'exploiter et endommager l'environnement de nombreuses mani√®res.\
Il est important de s√©curiser √† la fois l'**acc√®s** (autoriser les origines en liste blanche √† acc√©der au serveur API et refuser toute autre connexion) et l'[**authentification**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (en suivant le principe du **principe** **du** **moindre** **privil√®ge**). Et surtout **ne jamais** **autoriser** **les** **requ√™tes** **anonymes**.

**Processus de requ√™te courant :**\
Utilisateur ou compte de service K8s ‚Äì> Authentification ‚Äì> Autorisation ‚Äì> Contr√¥le d'admission.

**Conseils** :

* Fermer les ports.
* √âviter l'acc√®s anonyme.
* Restriction de n≈ìud ; Aucun acc√®s √† partir de n≈ìuds sp√©cifiques √† l'API.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* Emp√™che essentiellement les kubelets d'ajouter/supprimer/mettre √† jour des libell√©s avec un pr√©fixe node-restriction.kubernetes.io/. Ce pr√©fixe de libell√© est r√©serv√© aux administrateurs pour √©tiqueter leurs objets Node √† des fins d'isolation des charges de travail, et les kubelets ne seront pas autoris√©s √† modifier les libell√©s avec ce pr√©fixe.
* Et permet √©galement aux kubelets d'ajouter/supprimer/mettre √† jour ces libell√©s et pr√©fixes de libell√©s.
* Assurer avec des libell√©s l'isolation s√©curis√©e des charges de travail.
* √âviter l'acc√®s √† l'API de pods sp√©cifiques.
* √âviter l'exposition de l'ApiServer √† Internet.
* √âviter l'acc√®s non autoris√© RBAC.
* Port ApiServer avec pare-feu et liste blanche IP.

### Durcissement du SecurityContext

Par d√©faut, l'utilisateur root sera utilis√© lorsqu'un Pod est d√©marr√© si aucun autre utilisateur n'est sp√©cifi√©. Vous pouvez ex√©cuter votre application dans un contexte plus s√©curis√© en utilisant un mod√®le similaire au suivant:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Renforcement G√©n√©ral

Vous devriez mettre √† jour votre environnement Kubernetes aussi fr√©quemment que n√©cessaire pour :

* Avoir des d√©pendances √† jour.
* Des correctifs de bogues et de s√©curit√©.

[**Cycles de publication**](https://kubernetes.io/docs/setup/release/version-skew-policy/) : Tous les 3 mois, il y a une nouvelle version mineure -- 1.20.3 = 1(Majeur).20(Mineur).3(correctif)

**La meilleure fa√ßon de mettre √† jour un cluster Kubernetes est (√† partir de** [**ici**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**) :**

* Mettre √† jour les composants du n≈ìud ma√Ætre en suivant cette s√©quence :
* etcd (toutes les instances).
* kube-apiserver (tous les h√¥tes du plan de contr√¥le).
* kube-controller-manager.
* kube-scheduler.
* cloud controller manager, si vous en utilisez un.
* Mettre √† jour les composants du n≈ìud de travail tels que kube-proxy, kubelet.

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
