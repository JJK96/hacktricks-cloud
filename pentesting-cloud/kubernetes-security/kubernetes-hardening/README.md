# Ενίσχυση του Kubernetes

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 στην [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ κάνοντας υποβολή PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Εργαλεία για ανάλυση ενός cluster

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) είναι ένα εργαλείο ανοιχτού κώδικα για το Kubernetes που παρέχει μια πολυ-νέφους μιας μόνος προβολή, περιλαμβάνοντας ανάλυση κινδύνων, συμμόρφωση με την ασφάλεια, RBAC visualizer και σάρωση ευπαθειών εικόνας. Το Kubescape σαρώνει τα clusters του Kubernetes, τα αρχεία YAML και τα HELM charts, ανιχνεύοντας λανθασμένες ρυθμίσεις σύμφωνα με πολλά πλαίσια (όπως το [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), ευπαθείες λογισμικού και παραβιάσεις RBAC (role-based-access-control) στα αρχικά στάδια του CI/CD pipeline, υπολογίζει αμέσως τον βαθμό κινδύνου και εμφανίζει τις τάσεις κινδύνου με την πάροδο του χρόνου.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

Το εργαλείο [**kube-bench**](https://github.com/aquasecurity/kube-bench) είναι ένα εργαλείο που ελέγχει εάν το Kubernetes έχει αναπτυχθεί με ασφάλεια εκτελώντας τους ελέγχους που τεκμηριώνονται στο [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Μπορείτε να επιλέξετε:

* να εκτελέσετε το kube-bench από μέσα σε ένα container (κοινή χρήση του namespace PID με τον host)
* να εκτελέσετε ένα container που εγκαθιστά το kube-bench στον host, και στη συνέχεια να εκτελέσετε το kube-bench απευθείας στον host
* να εγκαταστήσετε τα πιο πρόσφατα δυαδικά αρχεία από τη [σελίδα έκδοσης (Releases page)](https://github.com/aquasecurity/kube-bench/releases),
* να το συντάξετε από τον πηγαίο κώδικα.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

Το εργαλείο [**kubeaudit**](https://github.com/Shopify/kubeaudit) είναι ένα εργαλείο γραμμής εντολής και ένα πακέτο Go για **επιθεώρηση των συστάδων Kubernetes** για διάφορα θέματα ασφάλειας.

Το Kubeaudit μπορεί να ανιχνεύσει εάν εκτελείται μέσα σε ένα container σε μια συστάδα. Σε αυτή την περίπτωση, θα προσπαθήσει να επιθεωρήσει όλους τους πόρους Kubernetes σε αυτή τη συστάδα:
```
kubeaudit all
```
Αυτό το εργαλείο έχει επίσης το όρισμα `autofix` για **αυτόματη επιδιόρθωση των εντοπισμένων θεμάτων.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

Το εργαλείο [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) κυνηγά αδυναμίες ασφαλείας σε συστάδες Kubernetes. Το εργαλείο αναπτύχθηκε για να αυξήσει την ευαισθητοποίηση και την ορατότητα για θέματα ασφάλειας σε περιβάλλοντα Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) είναι ένα εργαλείο σάρωσης ευπαθειών και CIS Docker benchmark που επιτρέπει στους χρήστες να λάβουν μια ακριβή και άμεση αξιολόγηση κινδύνου των Kubernetes clusters τους. Το Kubei σαρώνει όλες τις εικόνες που χρησιμοποιούνται σε ένα Kubernetes cluster, συμπεριλαμβανομένων των εικόνων των pods εφαρμογών και των συστήματος pods.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) είναι ένα εργαλείο για τη σάρωση του Kubernetes cluster για επικίνδυνες άδειες στο μοντέλο εξουσιοδότησης βασισμένο σε ρόλους (RBAC) του Kubernetes.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) είναι ένα εργαλείο που δοκιμάζει άλλους τύπους ελέγχων υψηλού κινδύνου σε σύγκριση με τα άλλα εργαλεία. Κύριως έχει 3 διαφορετικές λειτουργίες:

* **`find-role-relationships`**: Που θα βρει ποιοι ρόλοι AWS τρέχουν σε ποια pods
* **`find-secrets`**: Που προσπαθεί να εντοπίσει μυστικά σε πόρους K8s όπως Pods, ConfigMaps και Secrets.
* **`test-imds-access`**: Που θα προσπαθήσει να εκτελέσει pods και να προσπαθήσει να έχει πρόσβαση στα μεταδεδομένα v1 και v2. ΠΡΟΕΙΔΟΠΟΙΗΣΗ: Αυτό θα εκτελέσει ένα pod στο cluster, να είστε πολύ προσεκτικοί επειδή ίσως δεν θέλετε να το κάνετε!

## **Ελέγχος Κώδικα IaC**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) είναι ένα εργαλείο που σαρώνει ζωντανό Kubernetes cluster και **αναφέρει πιθανά θέματα με τους αναπτυγμένους πόρους και τις διαμορφώσεις**. Καθαρίζει το cluster σας με βάση το τι έχει αναπτυχθεί και όχι τι βρίσκεται στο δίσκο. Με τη σάρωση του cluster σας, ανιχνεύει λανθασμένες ρυθμίσεις και σας βοηθά να εξασφαλίσετε ότι οι βέλτιστες πρακτικές είναι σε θέση, αποτρέποντας έτσι μελλοντικά προβλήματα. Στοχεύει στη μείωση του γνωστικού _φορτίου_ που αντιμετωπίζει κανείς κατά τη λειτουργία ενός Kubernetes cluster στη φύση. Επιπλέον, αν το cluster σας χρησιμοποιεί ένα μετρητή μετρικών, αναφέρει πιθανούς πόρους υπερβολικών/υπο-εκχωρήσεων και προσπαθεί να σας προειδοποιήσει αν το cluster σας εξαντλήσει τη χωρητικότητά του.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) εντοπίζει **ευπαθείες ασφάλειας**, θέματα συμμόρφωσης και λανθασμένες διαμορφώσεις υποδομής στις ακόλουθες **λύσεις υποδομής ως κώδικα**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM και προδιαγραφές OpenAPI 3.0

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) είναι ένα εργαλείο ανάλυσης στατικού κώδικα για υποδομή ως κώδικα.

Σαρώνει την υποδομή στο cloud που παρέχεται χρησιμοποιώντας [Terraform](https://terraform.io), Terraform plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) ή [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) και ανιχνεύει λανθασμένες ρυθμίσεις ασφάλειας και συμμόρφωσης χρησιμοποιώντας σάρωση βασισμένη σε γράφους.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) είναι ένα εργαλείο που εκτελεί ανάλυση στατικού κώδικα των ορισμών αντικειμένων Kubernetes σας.

Για εγκατάσταση:

| Διανομή                                        | Εντολή / Σύνδεσμος                                                                          |
| --------------------------------------------- | --------------------------------------------------------------------------------------- |
| Προεγκατεσκευασμένα δυαδικά για macOS, Linux και Windows    | [Κυκλοφορίες GitHub](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS και Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS και Linux) | `kubectl krew install score`                                                            |

## Συμβουλές

### Kubernetes PodSecurityContext και SecurityContext

Μπορείτε να διαμορφώσετε το **περιβάλλον ασφαλείας των Pods** (με _PodSecurityContext_) και των **containers** που θα εκτελεστούν (με _SecurityContext_). Για περισσότερες πληροφορίες διαβάστε:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Ενίσχυση Ασφάλειας Kubernetes API

Είναι πολύ σημαντικό να **προστατεύετε την πρόσβαση στον Διακομιστή API του Kubernetes** καθώς ένας κακόβουλος χρήστης με επαρκή δικαιώματα θα μπορούσε να το καταχραστεί και να προκαλέσει ζημιές σε πολλούς τρόπους το περιβάλλον.\
Είναι σημαντικό να ασφαλίζετε τόσο τη **πρόσβαση** (**λευκή λίστα** προέλευσης για πρόσβαση στον Διακομιστή API και απαγόρευση οποιασδήποτε άλλης σύνδεσης) όσο και την [**πιστοποίηση**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (ακολουθώντας την αρχή του **ελάχιστου** **προνομίου**). Και σίγουρα **ποτέ** **μην** **επιτρέπετε** **ανώνυμες** **αιτήσεις**.

**Κοινή διαδικασία αιτήματος:**\
Χρήστης ή Λογαριασμός Υπηρεσίας K8s –> Πιστοποίηση –> Εξουσιοδότηση –> Έλεγχος Εισαγωγής.

**Συμβουλές**:

* Κλείστε θύρες.
* Αποφύγετε την Ανώνυμη πρόσβαση.
* NodeRestriction; Χωρίς πρόσβαση από συγκεκριμένους κόμβους στο API.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* Βασικά εμποδίζει τα kubelets από το προσθέτουν/αφαιρούν/ενημερώνουν ετικέτες με πρόθεμα node-restriction.kubernetes.io/. Αυτό το πρόθεμα ετικέτας είναι κατοχυρωμένο για τους διαχειριστές για να ετικετάρουν τα αντικείμενα Node για λόγους απομόνωσης φορτίου εργασίας, και τα kubelets δεν θα επιτρέπεται να τροποποιούν ετικέτες με αυτό το πρόθεμα.
* Και επίσης, επιτρέπει στα kubelets να προσθέτουν/αφαιρούν/ενημερώνουν αυτές τις ετικέτες και πρόθεμα ετικέτας.
* Βεβαιωθείτε με ετικέτες την ασφαλή απομόνωση φορτίου εργασίας.
* Αποφύγετε συγκεκριμένα pods από πρόσβαση στο API.
* Αποφύγετε την έκθεση του ApiServer στο διαδίκτυο.
* Αποφύγετε την μη εξουσιοδοτημένη πρόσβαση RBAC.
* Θύρα ApiServer με firewall και IP whitelisting.

### Ενίσχυση Περιβάλλοντος SecurityContext

Από προεπιλογή θα χρησιμοποιηθεί ο ριζικός χρήστης όταν ξεκινάει ένα Pod αν δεν έχει καθοριστεί άλλος χρήστης. Μπορείτε να εκτελέσετε την εφαρμογή σας μέσα σε ένα πιο ασφαλές περιβάλλον χρησιμοποιώντας ένα πρότυπο παρόμοιο
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Γενική Ενίσχυση

Θα πρέπει να ενημερώνετε το περιβάλλον σας Kubernetes τόσο συχνά όσο απαιτείται για:

* Ενημερωμένες εξαρτήσεις.
* Διορθώσεις σφαλμάτων και ασφαλείας.

[**Κύκλοι κυκλοφορίας**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Κάθε 3 μήνες υπάρχει μια νέα μικρή έκδοση -- 1.20.3 = 1(Μείζον).20(Ελάχιστο).3(επιδιόρθωση)

**Ο καλύτερος τρόπος για να ενημερώσετε ένα Cluster Kubernetes είναι (από** [**εδώ**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

* Αναβαθμίστε τα στοιχεία του Master Node ακολουθώντας αυτήν την ακολουθία:
* etcd (όλες οι περιπτώσεις).
* kube-apiserver (όλοι οι οικοδεσπότες ελέγχου του επιπέδου).
* kube-controller-manager.
* kube-scheduler.
* cloud controller manager, αν χρησιμοποιείτε έναν.
* Αναβαθμίστε τα στοιχεία του Worker Node όπως kube-proxy, kubelet.

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα τηλεγράφου**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
{% endhint %}
