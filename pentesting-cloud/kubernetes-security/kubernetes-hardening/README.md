# Kubuni Kubuni

<details>

<summary><strong>Jifunze kuhusu kuvamia AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **fuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za kuvamia kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Zana za kuchambua kikundi

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) ni zana ya chanzo wazi ya K8s inayotoa kioo cha moja kwa moja cha K8s kwenye wingu nyingi, ikiwa ni pamoja na uchambuzi wa hatari, uthibitisho wa usalama, RBAC visualizer na uchunguzi wa mapungufu ya picha. Kubescape inachunguza vikundi vya K8s, faili za YAML, na chati za HELM, ikigundua usanidi mbaya kulingana na fremu nyingi (kama vile [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK¬Æ](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), mapungufu ya programu, na uvunjaji wa RBAC (udhibiti wa upatikanaji kulingana na jukumu) katika hatua za awali za mstari wa CI/CD, hupima alama ya hatari mara moja na kuonyesha mwelekeo wa hatari kwa muda.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

Chombo cha [**kube-bench**](https://github.com/aquasecurity/kube-bench) ni chombo kinachochunguza ikiwa Kubernetes imewekwa kwa usalama kwa kutekeleza ukaguzi ulioorodheshwa katika [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Unaweza kuchagua:

* kukimbia kube-bench kutoka ndani ya kontena (kushiriki nafasi ya PID na mwenyeji)
* kukimbia kontena inayoweka kube-bench kwenye mwenyeji, na kisha kukimbia kube-bench moja kwa moja kwenye mwenyeji
* kusakinisha faili za hivi karibuni kutoka kwenye [Ukurasa wa Kutolewa](https://github.com/aquasecurity/kube-bench/releases),
* kuzikusanya kutoka kwenye chanzo.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

Chombo [**kubeaudit**](https://github.com/Shopify/kubeaudit) ni chombo cha mstari wa amri na pakiti ya Go ya **kukagua vikundi vya Kubernetes** kwa wasiwasi tofauti wa usalama.

Kubeaudit inaweza kugundua ikiwa inakimbia ndani ya kontena kwenye kikundi. Ikiwa ndivyo, itajaribu kukagua rasilimali zote za Kubernetes kwenye kikundi hicho:
```
kubeaudit all
```
Herramienta hii pia ina hoja ya maelezo `autofix` kurekebisha moja kwa moja masuala yaliyogunduliwa.

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

Zana [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) inatafuta udhaifu wa usalama katika vikundi vya Kubernetes. Zana ilibuniwa ili kuongeza uelewa na uwazi kwa masuala ya usalama katika mazingira ya Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) ni zana ya uchunguzi wa mapungufu na kipimo cha CIS Docker ambacho huruhusu watumiaji kupata tathmini sahihi na ya haraka ya hatari katika vikundi vyao vya kubernetes. Kubei huchunguza picha zote zinazotumiwa katika kikundi cha Kubernetes, ikiwa ni pamoja na picha za podi za maombi na podi za mfumo.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) ni zana ya kuchunguza kikundi cha Kubernetes kwa ruhusa hatari katika mfano wa idhini ya kudhibiti msingi wa majukumu ya Kubernetes (RBAC).

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) ni zana iliyoundwa kufanya majaribio ya aina nyingine ya ukaguzi wa hatari ya juu ikilinganishwa na zana zingine. Kimsingi ina njia 3 tofauti:

* **`find-role-relationships`**: Itapata ni majukumu gani ya AWS yanayoendeshwa katika podi zipi
* **`find-secrets`**: Inajaribu kutambua siri katika rasilimali za K8s kama vile Podi, ConfigMaps, na Secrets.
* **`test-imds-access`**: Itajaribu kuendesha podi na kujaribu kupata ufikivu wa metadata v1 na v2. ONYO: Hii itaendesha podi katika kikundi, kuwa mwangalifu sana kwa sababu labda hutaki kufanya hivi!

## **Ukaguzi wa Kanuni ya IaC**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) ni zana inayochunguza kikundi cha Kubernetes kilicho hai na **kuripoti masuala yanayowezekana na rasilimali zilizosanikishwa na mipangilio**. Inasafisha kikundi chako kulingana na kilichosanikishwa na sio kilichopo kwenye diski. Kwa kuchunguza kikundi chako, inagundua upangaji mbaya na kukusaidia kuhakikisha kuwa mazoea bora yamewekwa, hivyo kuzuia maumivu ya kichwa ya baadaye. Lengo lake ni kupunguza mzigo wa kiakili unaoelekea wakati wa kuendesha kikundi cha Kubernetes kwa porini. Zaidi ya hayo, ikiwa kikundi chako kinatumia metric-server, inaripoti rasilimali zinazowezekana za kuweka/alokesheni zaidi/chini na kujaribu kukuarifu ikiwa kikundi chako kitakosa uwezo.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) hupata **mapungufu ya usalama**, masuala ya utii, na upangaji mbaya wa miundombinu katika suluhisho za **Miundombinu kama Kanuni**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM, na vipimo vya OpenAPI 3.0

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) ni zana ya uchambuzi wa kanuni ya tuli kwa miundombinu kama kanuni.

Inachunguza miundombinu ya wingu iliyosanikishwa kwa kutumia [Terraform](https://terraform.io), Terraform plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) au [Mifano ya ARM](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) na kugundua upangaji mbaya wa usalama na utii kwa kutumia uchambuzi wa grafu.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) ni zana inayofanya uchambuzi wa kanuni ya tuli ya ufafanuzi wako wa vitu vya Kubernetes.

Kufunga:

| Usambazaji                                          | Amri / Kiungo                                                                           |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Binari zilizojengwa mapema kwa macOS, Linux, na Windows    | [Uachiliaji wa GitHub](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS na Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS na Linux) | `kubectl krew install score`                                                            |

## Vidokezo

### Kubernetes PodSecurityContext na SecurityContext

Unaweza kusanidi **muktadha wa usalama wa Podi** (na _PodSecurityContext_) na wa **kontena** ambazo zitakayoendeshwa (na _SecurityContext_). Kwa maelezo zaidi soma:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kuboresha API ya Kubernetes

Ni muhimu sana **kulinda ufikivu wa Seva ya API ya Kubernetes** kwani mhusika mwenye nia mbaya na mamlaka za kutosha anaweza kutumia vibaya na kuharibu mazingira kwa njia nyingi.\
Ni muhimu kuhakikisha **ufikivu** (**kutengeneza orodha nyeupe** za asili kufikia Seva ya API na kukataa uunganisho mwingine) na [**uthibitisho**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (kufuata kanuni ya **mamlaka** **ya chini**). Na hakika **kamwe** **ruhusu** **ombi** **la** **anomali**.

**Mchakato wa Ombi la Kawaida:**\
Mtumiaji au Akaunti ya Huduma ya K8s ‚Äì> Uthibitisho ‚Äì> Uidhinishaji ‚Äì> Kudhibiti Kuingia.

**Vidokezo**:

* Funga bandari.
* Epuka ufikivu wa Anomali.
* Kizuizi cha Node; Hakuna ufikivu kutoka kwa nodi maalum kwa API.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* Kimsingi inazuia kubelets kuongeza/kutoa/kusasisha lebo na kivuli cha node-restriction.kubernetes.io/. Lebo hii ya kivuli imetengwa kwa waendeshaji wa mfumo kuweka lebo Node zao kwa madhumuni ya kusimamia mzigo wa kazi, na kubelets hawataruhusiwa kurekebisha lebo na kivuli hicho.
* Na pia, inaruhusu kubelets kuongeza/kutoa/kusasisha lebo hizi na vikundi vya lebo.
* Hakikisha na lebo kufanya kazi salama ya kusimamia mzigo.
* Epuka podi maalum kutoka kwa ufikivu wa API.
* Epuka kufichua ApiServer kwa mtandao.
* Epuka ufikivu usioruhusiwa wa RBAC.
* Bandari ya ApiServer na firewall na orodha nyeupe ya IP.

### Kuboresha Muktadha wa Usalama

Kwa chaguo-msingi, mtumiaji wa mizizi atatumika wakati Podi inaanza ikiwa mtumiaji mwingine hajasanidiwa. Unaweza kuendesha programu yako ndani ya muktadha salama zaidi kwa kutumia kiolezo kama ifuatavyo:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Kufunga Kwa Ujumla

Unapaswa kusasisha mazingira yako ya Kubernetes mara kwa mara kama inavyohitajika kuwa na:

* Mahitaji yaliyosasishwa.
* Mende na visasaisho vya usalama.

[**Mizunguko ya Kutolewa**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Kila baada ya miezi 3 kuna kutolewa kwa toleo dogo jipya -- 1.20.3 = 1(Kuu).20(Dogo).3(kisasa)

**Njia bora ya kusasisha Kikundi cha Kubernetes ni (kutoka** [**hapa**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

* Sasisha vipengele vya Nodi ya Mwalimu kwa kufuata mfuatano huu:
* etcd (mifano yote).
* kube-apiserver (wenyeji wote wa udhibiti wa kiunzi).
* kube-controller-manager.
* kube-scheduler.
* meneja wa kudhibiti wa wingu, ikiwa unatumia moja.
* Sasisha vipengele vya Nodi ya Wafanyakazi kama vile kube-proxy, kubelet.
