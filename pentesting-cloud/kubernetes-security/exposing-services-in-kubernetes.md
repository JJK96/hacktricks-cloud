# Expondo Servi√ßos no Kubernetes

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

Existem **diferentes maneiras de expor servi√ßos** no Kubernetes para que tanto os endpoints **internos** quanto os **externos** possam acess√°-los. Essa configura√ß√£o no Kubernetes √© bastante cr√≠tica, pois o administrador poderia dar acesso a **atacantes a servi√ßos aos quais n√£o deveriam ter acesso**.

### Enumera√ß√£o Autom√°tica

Antes de come√ßar a enumerar as maneiras que o K8s oferece para expor servi√ßos ao p√∫blico, saiba que se voc√™ puder listar namespaces, servi√ßos e ingressos, poder√° encontrar tudo exposto ao p√∫blico com:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

Um servi√ßo **ClusterIP** √© o **padr√£o** de **servi√ßo** do Kubernetes. Ele fornece um **servi√ßo interno** em seu cluster que outras aplica√ß√µes dentro do seu cluster podem acessar. N√£o h√° **acesso externo**.

No entanto, isso pode ser acessado usando o Proxy do Kubernetes:
```bash
kubectl proxy --port=8080
```
Agora, voc√™ pode navegar atrav√©s da API do Kubernetes para acessar servi√ßos usando este esquema:

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

Por exemplo, voc√™ poderia usar a seguinte URL:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

para acessar este servi√ßo:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_Este m√©todo requer que voc√™ execute `kubectl` como um **usu√°rio autenticado**._

Liste todos os ClusterIPs:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep ClusterIP
```
{% endcode %}

### NodePort

Quando o **NodePort** √© utilizado, uma porta designada √© disponibilizada em todos os N√≥s (representando as M√°quinas Virtuais). O **tr√°fego** direcionado para esta porta espec√≠fica √© ent√£o sistematicamente **roteado para o servi√ßo**. Tipicamente, este m√©todo n√£o √© recomendado devido √†s suas desvantagens.

Listar todos os NodePorts:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep NodePort
```
{% endcode %}

Um exemplo de especifica√ß√£o NodePort:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
Se voc√™ **n√£o especificar** o **nodePort** no yaml (√© a porta que ser√° aberta) uma porta na **faixa de 30000 a 32767 ser√° usada**.

### LoadBalancer <a href="#id-0d96" id="id-0d96"></a>

Exp√µe o Servi√ßo externamente **usando um balanceador de carga do provedor de nuvem**. No GKE, isso ir√° iniciar um [Network Load Balancer](https://cloud.google.com/compute/docs/load-balancing/network/) que lhe dar√° um √∫nico endere√ßo IP que encaminhar√° todo o tr√°fego para o seu servi√ßo. Na AWS, ele lan√ßar√° um Balanceador de Carga.

Voc√™ tem que pagar por um LoadBalancer por servi√ßo exposto, o que pode ser caro.

Listar todos os LoadBalancers:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,EXTERNAL-IP:.status.loadBalancer.ingress[*],PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep LoadBalancer
```
{% endcode %}

### IPs Externos <a href="#external-ips" id="external-ips"></a>

{% hint style="success" %}
Os IPs externos s√£o expostos por servi√ßos do tipo Load Balancers e geralmente s√£o usados quando um Load Balancer de Provedor de Nuvem externo est√° sendo utilizado.

Para encontr√°-los, verifique os balanceadores de carga com valores no campo `EXTERNAL-IP`.
{% endhint %}

O tr√°fego que ingressa no cluster com o **IP externo** (como **IP de destino**), na porta do Servi√ßo, ser√° **roteado para um dos endpoints do Servi√ßo**. Os `externalIPs` n√£o s√£o gerenciados pelo Kubernetes e s√£o de responsabilidade do administrador do cluster.

No especifica√ß√£o do Servi√ßo, os `externalIPs` podem ser especificados juntamente com qualquer um dos `ServiceTypes`. No exemplo abaixo, "`meu-servico`" pode ser acessado pelos clientes em "`80.11.12.10:80`" (`externalIP:port`)
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### ExternalName

[**Da documenta√ß√£o:**](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) Servi√ßos do tipo ExternalName **mapeiam um Servi√ßo para um nome DNS**, e n√£o para um seletor t√≠pico como `meu-servi√ßo` ou `cassandra`. Voc√™ especifica esses Servi√ßos com o par√¢metro `spec.externalName`.

Esta defini√ß√£o de Servi√ßo, por exemplo, mapeia o Servi√ßo `meu-servi√ßo` no namespace `prod` para `meu.banco.dados.exemplo.com`:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
Quando se procura o host `my-service.prod.svc.cluster.local`, o Servi√ßo de DNS do cluster retorna um registro `CNAME` com o valor `my.database.example.com`. Acesso ao `my-service` funciona da mesma forma que outros Servi√ßos, mas com a diferen√ßa crucial de que **a redire√ß√£o ocorre no n√≠vel do DNS** em vez de por meio de proxy ou encaminhamento.

Liste todos os ExternalNames:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces | grep ExternalName
```
{% endcode %}

### Ingress

Ao contr√°rio de todos os exemplos acima, **Ingress N√ÉO √© um tipo de servi√ßo**. Em vez disso, ele fica **na frente de v√°rios servi√ßos e atua como um "roteador inteligente"** ou ponto de entrada em seu cluster.

Voc√™ pode fazer muitas coisas diferentes com um Ingress, e existem **muitos tipos de controladores de Ingress que t√™m capacidades diferentes**.

O controlador de Ingress padr√£o do GKE criar√° um [Balanceador de Carga HTTP(S)](https://cloud.google.com/compute/docs/load-balancing/http/) para voc√™. Isso permitir√° que voc√™ fa√ßa roteamento com base em caminho e subdom√≠nio para os servi√ßos de backend. Por exemplo, voc√™ pode enviar tudo em foo.seudominio.com para o servi√ßo foo e tudo sob o caminho seu dominio.com/bar/ para o servi√ßo bar.

O YAML para um objeto Ingress no GKE com um [Balanceador de Carga HTTP L7](https://cloud.google.com/compute/docs/load-balancing/http/) pode se parecer com isso:
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
Liste todos os ingressos:

{% code overflow="wrap" %}
```bash
kubectl get ingresses --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RULES:spec.rules[*],STATUS:status'
```
{% endcode %}

Embora, neste caso, seja melhor obter as informa√ß√µes de cada um individualmente para l√™-las melhor:
```bash
kubectl get ingresses --all-namespaces -o=yaml
```
### Refer√™ncias

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
