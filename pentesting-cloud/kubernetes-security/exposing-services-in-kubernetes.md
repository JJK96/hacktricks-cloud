# Kubernetes'te Hizmetleri Açığa Çıkarma

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **HackTricks** ve **HackTricks Cloud** github depolarına PR göndererek hacking püf noktalarını paylaşın.

</details>
{% endhint %}

**Kubernetes'te hizmetleri açığa çıkarmak için farklı yollar** bulunmaktadır, böylece **iç** ve **dış** uç noktalar bunlara erişebilir. Bu Kubernetes yapılandırması oldukça kritiktir çünkü yönetici, **saldırganlara erişmesi gerekmeyen hizmetlere erişim sağlayabilir**.

### Otomatik Numaralandırma

K8s'in hizmetleri genel kullanıma açma yollarını numaralandırmaya başlamadan önce, namespace'leri, hizmetleri ve girişleri listeleyebiliyorsanız, her şeyin genel kullanıma açık olduğunu bulabilirsiniz:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

Bir **ClusterIP** servisi, **varsayılan** Kubernetes **servisidir**. Kümeniz içinde diğer uygulamaların erişebileceği bir **servis** sağlar. **Harici erişim yoktur**.

Ancak, bu Kubernetes Proxy kullanılarak erişilebilir:
```bash
kubectl proxy --port=8080
```
Şimdi, Kubernetes API'si üzerinden hizmetlere erişmek için bu şemayı kullanabilirsiniz:

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

Örneğin, aşağıdaki URL'yi kullanabilirsiniz:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

bu hizmete erişmek için:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_Bu yöntem, `kubectl`'i **kimlik doğrulanmış bir kullanıcı** olarak çalıştırmanızı gerektirir._

Tüm ClusterIP'leri listele:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep ClusterIP
```
### NodePort

**NodePort** kullanıldığında, tüm Düğümlerde (Sanal Makineleri temsil eden) belirli bir bağlantı noktası kullanılabilir hale getirilir. Bu belirli bağlantı noktasına yönlendirilen **trafik**, ardından hizmete sistemli bir şekilde yönlendirilir. Genellikle, bu yöntem dezavantajları nedeniyle önerilmez.

Tüm NodePort'ları listele:
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep NodePort
```
{% endcode %}

Bir NodePort spesifikasyonu örneği:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
Eğer yaml dosyasında **nodePort** belirtmezseniz (açılacak olan port), **30000–32767 aralığında bir port** kullanılacaktır.

### LoadBalancer <a href="#id-0d96" id="id-0d96"></a>

Dışarıya **bir bulut sağlayıcısının yük dengeleyicisini kullanarak** Servisi açar. GKE'de, bu [Network Load Balancer](https://cloud.google.com/compute/docs/load-balancing/network/) oluşturacak ve tüm trafiği servisinize iletecek tek bir IP adresi sağlayacaktır. AWS'de bir Yük Dengeleyici başlatacaktır.

Her açılan servis için bir Yük Dengeleyiciye ödeme yapmanız gerekebilir, bu maliyetli olabilir.

Tüm Yük Dengeleyicileri listele:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,EXTERNAL-IP:.status.loadBalancer.ingress[*],PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep LoadBalancer
```
{% endcode %}

### Harici IP'ler <a href="#external-ips" id="external-ips"></a>

{% hint style="success" %}
Harici IP'ler, Yük Dengeleyiciler türündeki hizmetler tarafından açığa çıkarılır ve genellikle harici bir Bulut Sağlayıcı Yük Dengeleyicisi kullanıldığında kullanılır.

Onları bulmak için, `EXTERNAL-IP` alanında değerleri olan yük dengeleyicileri kontrol edin.
{% endhint %}

Küme içine giren trafiğin **harici IP** (hedef IP olarak) üzerinden, Servis bağlantı noktasına yönlendirilecektir. `externalIPs`, Kubernetes tarafından yönetilmez ve küme yöneticisinin sorumluluğundadır.

Servis özelliklerinde, `externalIPs` herhangi bir `ServiceTypes` ile birlikte belirtilebilir. Aşağıdaki örnekte, "`my-service`" "`80.11.12.10:80`" (`externalIP:port`) üzerinden istemciler tarafından erişilebilir.
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### ExternalName

[**Dokümantasyondan:**](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) Dış Ad

Tipindeki hizmetler, bir Hizmeti tipik bir seçiciye (`my-service` veya `cassandra` gibi) değil, bir DNS adına **eşler**. Bu Hizmetleri `spec.externalName` parametresi ile belirtirsiniz.

Örneğin, bu Hizmet tanımı, `prod` ad alanındaki `my-service` Hizmetini `my.database.example.com`'a eşler:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
```markdown
Kubernetes'te hizmetleri açığa çıkarma
```

Liste dışındaki tüm ExternalNames:
```bash
kubectl get services --all-namespaces | grep ExternalName
```
{% endcode %}

### Ingress

Tüm yukarıdaki örneklerin aksine, **Ingress bir hizmet türü DEĞİLDİR**. Bunun yerine, **çoklu hizmetlerin önünde oturur ve bir "akıllı yönlendirici" veya kümenize giriş noktası olarak hareket eder**.

Bir Ingress ile birçok farklı şey yapabilirsiniz ve **farklı yeteneklere sahip birçok türde Ingress denetleyicisi bulunmaktadır**.

Varsayılan GKE ingress denetleyicisi sizin için bir [HTTP(S) Yük Dengeleyici](https://cloud.google.com/compute/docs/load-balancing/http/) oluşturacaktır. Bu size hem yol tabanlı hem de alt alan tabanlı yönlendirme imkanı sağlar. Örneğin, foo.yourdomain.com'daki her şeyi foo servisine gönderebilir ve yourdomain.com/bar/ yolunun altındaki her şeyi bar servisine gönderebilirsiniz.

GKE'de bir Ingress nesnesi için bir YAML dosyası, [L7 HTTP Yük Dengeleyici](https://cloud.google.com/compute/docs/load-balancing/http/) ile şöyle görünebilir:
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
Tüm girişleri listele:

{% code overflow="wrap" %}
```bash
kubectl get ingresses --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RULES:spec.rules[*],STATUS:status'
```
{% endcode %}

Bu durumda her birini tek tek alıp daha iyi okumak için bilgilerini almak daha iyidir:
```bash
kubectl get ingresses --all-namespaces -o=yaml
```
### Referanslar

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

{% hint style="success" %}
AWS Hacking'ı öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'ı öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
