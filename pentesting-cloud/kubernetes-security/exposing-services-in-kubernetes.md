# Exponiendo Servicios en Kubernetes

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

Hay **diferentes formas de exponer servicios** en Kubernetes para que tanto los puntos finales **internos** como los **externos** puedan acceder a ellos. Esta configuraci√≥n de Kubernetes es bastante cr√≠tica ya que el administrador podr√≠a dar acceso a **atacantes a servicios a los que no deber√≠an poder acceder**.

### Enumeraci√≥n Autom√°tica

Antes de comenzar a enumerar las formas en que K8s ofrece para exponer servicios al p√∫blico, ten en cuenta que si puedes listar los espacios de nombres, servicios e ingresos, puedes encontrar todo lo expuesto al p√∫blico con:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

Un servicio **ClusterIP** es el **servicio por defecto** de Kubernetes. Te proporciona un **servicio dentro** de tu cl√∫ster al que otras aplicaciones dentro de tu cl√∫ster pueden acceder. No hay **acceso externo**.

Sin embargo, se puede acceder a esto utilizando el Proxy de Kubernetes:
```bash
kubectl proxy --port=8080
```
Ahora, puedes navegar a trav√©s de la API de Kubernetes para acceder a los servicios utilizando este esquema:

`http://localhost:8080/api/v1/proxy/namespaces/<NOMBRE-ESPACIO>/services/<NOMBRE-SERVICIO>:<NOMBRE-PUERTO>/`

Por ejemplo, podr√≠as usar la siguiente URL:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

para acceder a este servicio:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_Este m√©todo requiere que ejecutes `kubectl` como un **usuario autenticado**._

Listar todos los ClusterIPs:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep ClusterIP
```
{% endcode %}

### NodePort

Cuando se utiliza **NodePort**, se pone a disposici√≥n un puerto designado en todos los Nodos (que representan las M√°quinas Virtuales). El **tr√°fico** dirigido a este puerto espec√≠fico se enruta sistem√°ticamente hacia el servicio. Normalmente, este m√©todo no se recomienda debido a sus inconvenientes.

Listar todos los NodePorts:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep NodePort
```
{% endcode %}

Un ejemplo de especificaci√≥n NodePort:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
Si **no especificas** el **nodePort** en el archivo yaml (es el puerto que se abrir√°) se usar√° un puerto en el **rango 30000‚Äì32767**.

### LoadBalancer <a href="#id-0d96" id="id-0d96"></a>

Expone el Servicio externamente **utilizando el balanceador de carga del proveedor de la nube**. En GKE, esto iniciar√° un [Network Load Balancer](https://cloud.google.com/compute/docs/load-balancing/network/) que te proporcionar√° una √∫nica direcci√≥n IP que reenviar√° todo el tr√°fico a tu servicio. En AWS se lanzar√° un Load Balancer.

Debes pagar por un LoadBalancer por servicio expuesto, lo cual puede resultar costoso.

Listar todos los LoadBalancers:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,EXTERNAL-IP:.status.loadBalancer.ingress[*],PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep LoadBalancer
```
{% endcode %}

### IPs Externas <a href="#external-ips" id="external-ips"></a>

{% hint style="success" %}
Las IPs externas son expuestas por servicios de tipo Load Balancers y generalmente se utilizan cuando se est√° utilizando un Load Balancer externo del proveedor de la nube.

Para encontrarlas, verifica los balanceadores de carga con valores en el campo `EXTERNAL-IP`.
{% endhint %}

El tr√°fico que ingresa al cl√∫ster con la **IP externa** (como **IP de destino**), en el puerto del Servicio, ser√° **ruteado a uno de los endpoints del Servicio**. Las `externalIPs` no son gestionadas por Kubernetes y son responsabilidad del administrador del cl√∫ster.

En la especificaci√≥n del Servicio, las `externalIPs` pueden ser especificadas junto con cualquiera de los `ServiceTypes`. En el ejemplo a continuaci√≥n, "`mi-servicio`" puede ser accedido por clientes en "`80.11.12.10:80`" (`externalIP:puerto`)
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### ExternalName

[**Desde la documentaci√≥n:**](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) Los Servicios de tipo ExternalName **mapean un Servicio a un nombre DNS**, no a un selector t√≠pico como `my-service` o `cassandra`. Especificas estos Servicios con el par√°metro `spec.externalName`.

Esta definici√≥n de Servicio, por ejemplo, mapea el Servicio `my-service` en el espacio de nombres `prod` a `my.database.example.com`:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
Cuando se busca el host `my-service.prod.svc.cluster.local`, el Servicio de DNS del cl√∫ster devuelve un registro `CNAME` con el valor `my.database.example.com`. Acceder a `my-service` funciona de la misma manera que otros Servicios pero con la diferencia crucial de que **la redirecci√≥n ocurre a nivel de DNS** en lugar de a trav√©s de un proxy o reenv√≠o.

Lista todos los ExternalNames:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces | grep ExternalName
```
{% endcode %}

### Ingress

A diferencia de todos los ejemplos anteriores, **Ingress NO es un tipo de servicio**. En cambio, se sit√∫a **frente a m√∫ltiples servicios y act√∫a como un "enrutador inteligente"** o punto de entrada a tu cl√∫ster.

Puedes hacer muchas cosas diferentes con un Ingress, y hay **muchos tipos de controladores de Ingress que tienen diferentes capacidades**.

El controlador de Ingress predeterminado de GKE crear√° un [Balanceador de carga HTTP(S)](https://cloud.google.com/compute/docs/load-balancing/http/) para ti. Esto te permitir√° realizar enrutamiento basado en ruta y subdominio hacia los servicios backend. Por ejemplo, puedes enviar todo en foo.tudominio.com al servicio foo, y todo bajo la ruta tu dominio.com/bar/ al servicio bar.

El YAML para un objeto Ingress en GKE con un [Balanceador de carga HTTP L7](https://cloud.google.com/compute/docs/load-balancing/http/) podr√≠a verse as√≠:
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
Enumera todos los ingresos:

{% code overflow="wrap" %}
```bash
kubectl get ingresses --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RULES:spec.rules[*],STATUS:status'
```
{% endcode %}

Aunque en este caso es mejor obtener la informaci√≥n de uno por uno para leerlo mejor:
```bash
kubectl get ingresses --all-namespaces -o=yaml
```
### Referencias

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red de Equipos Rojos de HackTricks en AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
