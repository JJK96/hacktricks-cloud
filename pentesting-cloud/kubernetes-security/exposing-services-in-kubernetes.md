# Εκθέτοντας Υπηρεσίες στο Kubernetes

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ κάνοντας υποβολή PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

Υπάρχουν **διαφορετικοί τρόποι εκθέτοντας υπηρεσίες** στο Kubernetes ώστε τόσο οι **εσωτερικές** όσο και οι **εξωτερικές** κατευθύνσεις να μπορούν να τις προσπελάσουν. Αυτή η διαμόρφωση του Kubernetes είναι αρκετά κρίσιμη καθώς ο διαχειριστής θα μπορούσε να δώσει πρόσβαση σε **επιτιθέμενους σε υπηρεσίες στις οποίες δεν θα έπρεπε να έχουν πρόσβαση**.

### Αυτόματη Απαρίθμηση

Πριν αρχίσετε να απαριθμείτε τους τρόπους που προσφέρει το K8s για την εκθέτοντας υπηρεσίες στο κοινό, γνωρίστε ότι αν μπορείτε να καταλογογραφήσετε τους χώρους ονομάτων, τις υπηρεσίες και τις εισόδους, μπορείτε να βρείτε τα πάντα που εκτίθενται στο κοινό με:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

Ένα υπηρεσία **ClusterIP** είναι η **προεπιλογή** υπηρεσίας του Kubernetes. Σας παρέχει μια **υπηρεσία μέσα** στο cluster σας που άλλες εφαρμογές μέσα στο cluster σας μπορούν να έχουν πρόσβαση. Δεν υπάρχει **εξωτερική πρόσβαση**.

Ωστόσο, αυτό μπορεί να προσπελαστεί χρησιμοποιώντας το Kubernetes Proxy:
```bash
kubectl proxy --port=8080
```
Τώρα, μπορείτε να πλοηγηθείτε μέσω του API του Kubernetes για να έχετε πρόσβαση σε υπηρεσίες χρησιμοποιώντας αυτό το σχήμα:

`http://localhost:8080/api/v1/proxy/namespaces/<ΟΝΟΜΑ-ΧΩΡΟΥ>/services/<ΟΝΟΜΑ-ΥΠΗΡΕΣΙΑΣ>:<ΟΝΟΜΑ-ΘΥΡΑΣ>/`

Για παράδειγμα, θα μπορούσατε να χρησιμοποιήσετε το παρακάτω URL:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

για να έχετε πρόσβαση σε αυτήν την υπηρεσία:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_Αυτή η μέθοδος απαιτεί να εκτελέσετε το `kubectl` ως έναν **εξουσιοδοτημένο χρήστη**._

Λίστα με όλες τις ClusterIPs:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep ClusterIP
```
{% endcode %}

### NodePort

Όταν χρησιμοποιείται το **NodePort**, ένας καθορισμένος θύρας γίνεται διαθέσιμος σε όλους τους κόμβους (που αντιπροσωπεύουν τις εικονικές μηχανές). Το **Traffic** που κατευθύνεται σε αυτήν τη συγκεκριμένη θύρα δρομολογείται στη συνέχεια συστηματικά προς την υπηρεσία. Συνήθως, αυτή η μέθοδος δεν συνιστάται λόγω των μειονεκτημάτων της.

Καταγράψτε όλους τους NodePorts:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep NodePort
```
{% endcode %}

Ένα παράδειγμα προδιαγραφής NodePort:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
Αν **δεν καθορίσετε** το **nodePort** στο αρχείο yaml (είναι η θύρα που θα ανοίξει) θα χρησιμοποιηθεί μια θύρα στο **εύρος 30000–32767**.

### LoadBalancer <a href="#id-0d96" id="id-0d96"></a>

Εκθέτει την υπηρεσία εξωτερικά **χρησιμοποιώντας τον ισορροπητή φορτίου του παροχέα cloud**. Στο GKE, αυτό θα δημιουργήσει ένα [Network Load Balancer](https://cloud.google.com/compute/docs/load-balancing/network/) που θα σας δώσει μια μοναδική διεύθυνση IP που θα προωθεί όλη την κίνηση στην υπηρεσία σας. Στο AWS θα εκκινήσει έναν ισορροπητή φορτίου.

Πρέπει να πληρώσετε για ένα LoadBalancer ανά εκτεθειμένη υπηρεσία, το οποίο μπορεί να είναι ακριβό.

Λίστα όλων των LoadBalancers:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,EXTERNAL-IP:.status.loadBalancer.ingress[*],PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep LoadBalancer
```
{% endcode %}

### Εξωτερικές Διευθύνσεις IP <a href="#external-ips" id="external-ips"></a>

{% hint style="success" %}
Οι εξωτερικές διευθύνσεις IP εκτίθενται από υπηρεσίες τύπου Load Balancers και χρησιμοποιούνται γενικά όταν χρησιμοποιείται ένας εξωτερικός Φορέας Φόρτου Σύννεφο.

Για να τις βρείτε, ελέγξτε τους φορείς φόρτου με τιμές στο πεδίο `EXTERNAL-IP`.
{% endhint %}

Η κίνηση που εισέρχεται στο cluster με την **εξωτερική IP** (ως **διεύθυνση IP προορισμού**), στη θύρα της Υπηρεσίας, θα **κατευθύνεται σε ένα από τα άκρα της Υπηρεσίας**. Οι `externalIPs` δεν διαχειρίζονται από το Kubernetes και αποτελούν ευθύνη του διαχειριστή του cluster.

Στο προσδιορισμό της Υπηρεσίας, οι `externalIPs` μπορούν να καθοριστούν μαζί με οποιονδήποτε από τους `ServiceTypes`. Στο παρακάτω παράδειγμα, η "`my-service`" μπορεί να προσπελαστεί από πελάτες στη διεύθυνση "`80.11.12.10:80`" (`externalIP:port`)
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### ExternalName

[**Από τα έγγραφα:**](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) Οι υπηρεσίες τύπου ExternalName **αντιστοιχίζουν μια υπηρεσία σε ένα όνομα DNS**, όχι σε έναν τυπικό επιλογέα όπως `my-service` ή `cassandra`. Καθορίζετε αυτές τις Υπηρεσίες με την παράμετρο `spec.externalName`.

Αυτός ο ορισμός Υπηρεσίας, για παράδειγμα, αντιστοιχίζει την Υπηρεσία `my-service` στο χώρο ονομάτων `prod` στο `my.database.example.com`:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
Όταν αναζητείτε τον οικοδεσπότη `my-service.prod.svc.cluster.local`, η Υπηρεσία DNS του cluster επιστρέφει ένα εγγραφή `CNAME` με την τιμή `my.database.example.com`. Η πρόσβαση στο `my-service` λειτουργεί με τον ίδιο τρόπο με τις άλλες Υπηρεσίες, αλλά με την κρίσιμη διαφορά ότι **η ανακατεύθυνση συμβαίνει στο επίπεδο DNS** αντί για προώθηση ή διαμεσολάβηση.

Καταγράψτε όλα τα ExternalNames:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces | grep ExternalName
```
{% endcode %}

### Ingress

Σε αντίθεση με όλα τα παραπάνω παραδείγματα, **το Ingress ΔΕΝ είναι ένας τύπος υπηρεσίας**. Αντ' αυτού, βρίσκεται **μπροστά από πολλαπλές υπηρεσίες και λειτουργεί ως ένα "έξυπνο δρομολογητή"** ή σημείο εισόδου στο cluster σας.

Μπορείτε να κάνετε πολλά διαφορετικά πράγματα με ένα Ingress, και υπάρχουν **πολλοί τύποι ελεγκτών Ingress που έχουν διαφορετικές δυνατότητες**.

Ο προεπιλεγμένος ελεγκτής Ingress του GKE θα δημιουργήσει έναν [HTTP(S) Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) για εσάς. Αυτό θα σας επιτρέψει να κάνετε δρομολόγηση βάσει διαδρομής και subdomain προς υπηρεσίες backend. Για παράδειγμα, μπορείτε να στείλετε τα πάντα στο foo.yourdomain.com στην υπηρεσία foo, και τα πάντα κάτω από τη διαδρομή yourdomain.com/bar/ στην υπηρεσία bar.

Το YAML για ένα αντικείμενο Ingress στο GKE με έναν [L7 HTTP Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) μπορεί να μοιάζει με αυτό:
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
Καταγράψτε όλα τα ingresses:

{% code overflow="wrap" %}
```bash
kubectl get ingresses --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RULES:spec.rules[*],STATUS:status'
```
{% endcode %}

Παρόλο που σε αυτήν την περίπτωση είναι καλύτερο να πάρετε τις πληροφορίες κάθε μία ξεχωριστά για να τις διαβάσετε καλύτερα:
```bash
kubectl get ingresses --all-namespaces -o=yaml
```
### Αναφορές

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Χάκινγκ του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Χάκινγκ του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα τηλεγράφου**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε χάκινγκ κόλπα υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
