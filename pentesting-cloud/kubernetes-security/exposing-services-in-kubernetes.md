# Esposizione dei Servizi in Kubernetes

{% hint style="success" %}
Impara e pratica l'Hacking su AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di Github.

</details>
{% endhint %}

Ci sono **diversi modi per esporre servizi** in Kubernetes in modo che entrambi gli endpoint **interni** ed **esterni** possano accedervi. Questa configurazione di Kubernetes √® piuttosto critica poich√© l'amministratore potrebbe dare accesso agli **attaccanti a servizi ai quali non dovrebbero poter accedere**.

### Enumerazione Automatica

Prima di iniziare a enumerare i modi in cui K8s offre per esporre servizi al pubblico, sappi che se puoi elencare i namespace, i servizi e gli ingressi, puoi trovare tutto ci√≤ che √® esposto al pubblico con:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

Un servizio **ClusterIP** √® il **servizio** Kubernetes **predefinito**. Ti fornisce un **servizio all'interno** del tuo cluster a cui altre app all'interno del cluster possono accedere. Non c'√® **accesso esterno**.

Tuttavia, questo pu√≤ essere accessibile utilizzando il Proxy Kubernetes:
```bash
kubectl proxy --port=8080
```
Ora, puoi navigare attraverso l'API di Kubernetes per accedere ai servizi utilizzando questo schema:

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

Ad esempio, potresti utilizzare il seguente URL:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

per accedere a questo servizio:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_Questo metodo richiede di eseguire `kubectl` come un **utente autenticato**._

Elenca tutti i ClusterIP:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep ClusterIP
```
{% endcode %}

### NodePort

Quando viene utilizzato **NodePort**, una porta designata viene resa disponibile su tutti i Nodi (che rappresentano le macchine virtuali). Il **traffico** indirizzato a questa porta specifica viene quindi instradato sistematicamente al servizio. Tipicamente, questo metodo non √® raccomandato a causa dei suoi svantaggi.

Elenca tutti i NodePorts:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep NodePort
```
{% endcode %}

Un esempio di specifica NodePort:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
Se **non si specifica** il **nodePort** nel file yaml (√® la porta che verr√† aperta) verr√† utilizzata una porta nell'**intervallo 30000‚Äì32767**.

### LoadBalancer <a href="#id-0d96" id="id-0d96"></a>

Espone il Servizio esternamente **utilizzando un bilanciamento del carico del fornitore di servizi cloud**. Su GKE, questo creer√† un [Network Load Balancer](https://cloud.google.com/compute/docs/load-balancing/network/) che ti fornir√† un singolo indirizzo IP che inoltrer√† tutto il traffico al tuo servizio. Su AWS verr√† avviato un Load Balancer.

√à necessario pagare un LoadBalancer per ogni servizio esposto, il che pu√≤ essere costoso.

Elenca tutti i LoadBalancer:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,EXTERNAL-IP:.status.loadBalancer.ingress[*],PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep LoadBalancer
```
{% endcode %}

### Indirizzi IP esterni <a href="#external-ips" id="external-ips"></a>

{% hint style="success" %}
Gli indirizzi IP esterni sono esposti dai servizi di tipo Load Balancer e sono generalmente utilizzati quando viene utilizzato un Load Balancer del Cloud Provider esterno.

Per trovarli, controlla i bilanciatori di carico con valori nel campo `EXTERNAL-IP`.
{% endhint %}

Il traffico che entra nel cluster con l'**indirizzo IP esterno** (come **indirizzo IP di destinazione**), sulla porta del Servizio, verr√† **instradato verso uno dei punti finali del Servizio**. Gli `externalIPs` non sono gestiti da Kubernetes e sono responsabilit√† dell'amministratore del cluster.

Nella specifica del Servizio, gli `externalIPs` possono essere specificati insieme a uno qualsiasi dei `ServiceTypes`. Nell'esempio seguente, "`my-service`" pu√≤ essere accessibile dai client su "`80.11.12.10:80`" (`externalIP:port`)
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### ExternalName

[**Dalla documentazione:**](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) I servizi di tipo ExternalName **mappano un Servizio su un nome DNS**, non su un selettore tipico come `my-service` o `cassandra`. Specificare questi Servizi con il parametro `spec.externalName`.

Questa definizione di Servizio, ad esempio, mappa il Servizio `my-service` nello spazio dei nomi `prod` su `my.database.example.com`:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
Quando si cerca l'host `my-service.prod.svc.cluster.local`, il Servizio DNS del cluster restituisce un record `CNAME` con il valore `my.database.example.com`. L'accesso a `my-service` funziona allo stesso modo degli altri Servizi ma con la differenza cruciale che **il reindirizzamento avviene a livello DNS** anzich√© tramite proxy o inoltro.

Elencare tutti gli ExternalNames:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces | grep ExternalName
```
{% endcode %}

### Ingress

A differenza di tutti gli esempi sopra, **Ingress NON √® un tipo di servizio**. Invece, si trova **davanti a pi√π servizi e agisce come un "router intelligente"** o punto di ingresso nel tuo cluster.

Puoi fare molte cose diverse con un Ingress, e ci sono **molti tipi di controller Ingress che hanno capacit√† diverse**.

Il controller Ingress predefinito di GKE avvier√† un [HTTP(S) Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) per te. Questo ti permetter√† di fare routing basato su percorsi e subdomini verso i servizi di backend. Ad esempio, puoi inviare tutto su foo.tuodominio.com al servizio foo, e tutto sotto il percorso yourdomain.com/bar/ al servizio bar.

Il YAML per un oggetto Ingress su GKE con un [L7 HTTP Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) potrebbe apparire cos√¨:
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
Elenca tutti gli ingressi:

{% code overflow="wrap" %}
```bash
kubectl get ingresses --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RULES:spec.rules[*],STATUS:status'
```
{% endcode %}

Anche in questo caso √® meglio ottenere le informazioni uno per uno per leggerle meglio:
```bash
kubectl get ingresses --all-namespaces -o=yaml
```
### Riferimenti

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

{% hint style="success" %}
Impara e pratica l'Hacking su AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di Github.

</details>
{% endhint %}
