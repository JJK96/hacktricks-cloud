# Kufunua Huduma katika Kubernetes

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **fuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

Kuna **njia tofauti za kufunua huduma** katika Kubernetes ili **endpoints za ndani** na **endpoints za nje** ziweze kuzifikia. Usanidi huu wa Kubernetes ni muhimu sana kwani msimamizi anaweza kutoa ufikiaji kwa **waharibifu kwa huduma ambazo hawapaswi kuzifikia**.

### Uorodheshaji wa Kiotomatiki

Kabla ya kuanza kuorodhesha njia ambazo K8s inatoa kufunua huduma kwa umma, tambua kwamba ikiwa unaweza kuorodhesha majina ya nafasi, huduma na ingresses, unaweza kupata kila kitu kilichofunuliwa kwa umma kwa:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

**ClusterIP** huduma ni **chaguo-msingi** la Kubernetes **huduma**. Inakupa **huduma ndani** ya kikundi chako ambayo programu zingine ndani ya kikundi chako zinaweza kufikia. Hakuna **upatikanaji wa nje**.

Hata hivyo, hii inaweza kufikiwa kwa kutumia Kubernetes Proxy:
```bash
kubectl proxy --port=8080
```
Sasa, unaweza kutembea kupitia API ya Kubernetes ili kupata huduma kwa kutumia mpangilio huu:

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

Kwa mfano, unaweza kutumia URL ifuatayo:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

kupata huduma hii:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_Mbinu hii inahitaji uendeshe `kubectl` kama **mtumiaji aliyeidhinishwa**._

Pata orodha ya ClusterIPs:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep ClusterIP
```
{% endcode %}

### NodePort

Wakati **NodePort** unapotumiwa, bandari maalum inapatikana kwenye Nodes zote (zinawakilisha Mashine za Virtual). **Trafiki** inayoelekezwa kwenye bandari hii maalum kisha inaelekezwa kwa mpangilio kwenye huduma. Kwa kawaida, njia hii haipendekezwi kutokana na mapungufu yake.

Panga NodePorts zote:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep NodePort
```
{% endcode %}

Mfano wa maelezo ya NodePort:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
If you **don't specify** the **nodePort** in the yaml (it's the port that will be opened) a port in the **range 30000‚Äì32767 will be used**.

### LoadBalancer <a href="#id-0d96" id="id-0d96"></a>

Inaonyesha Huduma kwa njia ya nje **kwa kutumia balansa ya mzigo ya mtoa huduma wa wingu**. Kwenye GKE, hii itaanzisha [Balansa ya Mzigo wa Mtandao](https://cloud.google.com/compute/docs/load-balancing/network/) ambayo itakupa anwani moja ya IP itakayopeleka trafiki yote kwenye huduma yako. Kwenye AWS itaanzisha Balansa ya Mzigo.

Unalazimika kulipa kwa kila Balansa ya Mzigo iliyofunguliwa kwa huduma, ambayo inaweza kuwa ghali.

Pata orodha ya Balansa zote za Mzigo:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,EXTERNAL-IP:.status.loadBalancer.ingress[*],PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep LoadBalancer
```
{% endcode %}

### Anwani za IP za Kigeni <a href="#external-ips" id="external-ips"></a>

{% hint style="success" %}
Anwani za IP za Kigeni hufichuliwa na huduma za aina ya Load Balancers na kwa kawaida hutumiwa wakati Load Balancer wa Cloud wa Kigeni unapotumiwa.

Ili kuzipata, angalia load balancers zenye thamani katika uga wa `EXTERNAL-IP`.
{% endhint %}

Trafiki inayoingia kwenye kikundi na **anwani ya IP ya kigeni** (kama **anwani ya marudio**), kwenye bandari ya Huduma, itaelekezwa kwa moja ya vituo vya Huduma. `externalIPs` hazisimamiwi na Kubernetes na ni jukumu la msimamizi wa kikundi.

Katika maelezo ya Huduma, `externalIPs` inaweza kutajwa pamoja na aina yoyote ya `ServiceTypes`. Katika mfano hapa chini, "`huduma-yangu`" inaweza kufikiwa na wateja kwa "`80.11.12.10:80`" (`externalIP:port`)
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### JinaLaNje

[**Kutoka kwa nyaraka:**](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) Huduma za aina ya ExternalName **hufanya ramani ya Huduma kwa jina la DNS**, si kwa kawaida ya kuchagua kama `my-service` au `cassandra`. Unaweza kutaja Huduma hizi kwa kutumia parameter ya `spec.externalName`.

Hii ufafanuzi wa Huduma, kwa mfano, unafanya ramani ya Huduma ya `my-service` katika eneo la `prod` kwenda `my.database.example.com`:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
### Kufuatia huduma ya `my-service.prod.svc.cluster.local`, Huduma ya DNS ya kikundi inarudisha rekodi ya `CNAME` yenye thamani ya `my.database.example.com`. Kufikia `my-service` hufanya kazi kwa njia ile ile kama Huduma zingine lakini tofauti muhimu ni kwamba **urekebishaji hufanyika kwenye kiwango cha DNS** badala ya kupitia kusambaza au kusonga mbele.

Orodhesha ExternalNames zote:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces | grep ExternalName
```
{% endcode %}

### Ingress

Tofauti na mifano yote hapo juu, **Ingress SI aina ya huduma**. Badala yake, inakaa **mbele ya huduma nyingi na hufanya kazi kama "router mjanja"** au mlango wa kuingia kwenye kikundi chako.

Unaweza kufanya mambo mengi tofauti na Ingress, na kuna **aina nyingi za watawala wa Ingress zenye uwezo tofauti**.

Watawala wa Ingress wa msingi wa GKE wataanzisha [HTTP(S) Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) kwako. Hii itakuruhusu kufanya mwelekeo kulingana na njia na subdomain kwa huduma za nyuma. Kwa mfano, unaweza kutuma kila kitu kwenye foo.yourdomain.com kwa huduma ya foo, na kila kitu chini ya njia ya yourdomain.com/bar/ kwa huduma ya bar.

YAML kwa kitu cha Ingress kwenye GKE na [L7 HTTP Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) inaweza kuonekana kama hivi:
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
Panga yote yaingie:

{% code overflow="wrap" %}
```bash
kubectl get ingresses --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RULES:spec.rules[*],STATUS:status'
```
{% endcode %}

Ingawa katika kesi hii ni bora kupata habari ya kila moja moja kwa moja ili kuisoma vizuri:
```bash
kubectl get ingresses --all-namespaces -o=yaml
```
### Marejeo

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **fuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za kuhack kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
