# Ujawnianie Usług w Kubernetes

{% hint style="success" %}
Dowiedz się i ćwicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz się i ćwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostępniaj sztuczki hakerskie, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów na githubie.

</details>
{% endhint %}

Istnieje **różne sposoby ujawniania usług** w Kubernetes, dzięki czemu zarówno **wewnętrzne** punkty końcowe, jak i **zewnętrzne** punkty końcowe mogą uzyskać do nich dostęp. Konfiguracja Kubernetes jest dość krytyczna, ponieważ administrator może udzielić dostępu **atakującym do usług, do których nie powinni mieć dostępu**.

### Automatyczne Wyliczanie

Zanim zaczniesz wyliczać sposoby, jakie oferuje K8s do ujawniania usług publicznie, wiedz, że jeśli możesz wymienić przestrzenie nazw, usługi i wpisy, możesz znaleźć wszystko ujawnione publicznie za pomocą:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

Usługa **ClusterIP** to **domyślna** usługa Kubernetes. Zapewnia ona usługę wewnątrz klastra, do której inne aplikacje wewnątrz klastra mogą uzyskać dostęp. Nie ma **dostępu zewnętrznego**.

Jednak można uzyskać do niej dostęp za pomocą Kubernetesa Proxy:
```bash
kubectl proxy --port=8080
```
Teraz możesz nawigować przez interfejs API Kubernetes, aby uzyskać dostęp do usług za pomocą tego schematu:

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

Na przykład, możesz użyć następującego adresu URL:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

aby uzyskać dostęp do tej usługi:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_Ta metoda wymaga uruchomienia `kubectl` jako **uwierzytelniony użytkownik**._

Lista wszystkich ClusterIPów:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep ClusterIP
```
{% endcode %}

### NodePort

Kiedy jest wykorzystywany **NodePort**, określony port jest udostępniany na wszystkich węzłach (reprezentujących maszyny wirtualne). **Ruch** skierowany do tego konkretnego portu jest następnie systematycznie **kierowany do usługi**. Zazwyczaj ta metoda nie jest zalecana ze względu na jej wady.

Lista wszystkich NodePortów:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep NodePort
```
{% endcode %}

Przykład specyfikacji NodePort:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
Jeśli **nie określisz** pola **nodePort** w pliku yaml (jest to port, który zostanie otwarty), zostanie użyty port z zakresu **30000–32767**.

### LoadBalancer <a href="#id-0d96" id="id-0d96"></a>

Wystawia usługę na zewnątrz **za pomocą load balancera dostawcy chmury**. Na GKE spowoduje to uruchomienie [Network Load Balancer](https://cloud.google.com/compute/docs/load-balancing/network/), który udostępni pojedynczy adres IP przekierowujący cały ruch do Twojej usługi. W AWS spowoduje to uruchomienie Load Balancera.

Trzeba płacić za każdy LoadBalancer na wystawioną usługę, co może być kosztowne.

Wyświetl wszystkie LoadBalancery:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,EXTERNAL-IP:.status.loadBalancer.ingress[*],PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep LoadBalancer
```
{% endcode %}

### Zewnętrzne adresy IP <a href="#external-ips" id="external-ips"></a>

{% hint style="success" %}
Zewnętrzne adresy IP są udostępniane przez usługi typu Load Balancers i zazwyczaj są używane, gdy używany jest zewnętrzny Load Balancer dostawcy chmury.

Aby je znaleźć, sprawdź balansery obciążenia z wartościami w polu `EXTERNAL-IP`.
{% endhint %}

Ruch, który wchodzi do klastra z **zewnętrznym adresem IP** (jako **adres docelowy IP**), na porcie usługi, będzie **kierowany do jednego z punktów końcowych usługi**. `externalIPs` nie są zarządzane przez Kubernetes i są odpowiedzialnością administratora klastra.

W specyfikacji usługi, `externalIPs` mogą być określone wraz z dowolnymi `ServiceTypes`. W poniższym przykładzie "`moja-usługa`" może być dostępna dla klientów pod adresem "`80.11.12.10:80`" (`externalIP:port`)
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### ExternalName

[**Z dokumentacji:**](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) Usługi typu ExternalName **mapują usługę na nazwę DNS**, a nie na typowy selektor, taki jak `my-service` lub `cassandra`. Określasz te Usługi za pomocą parametru `spec.externalName`.

Poniższa definicja Usługi mapuje Usługę `my-service` w przestrzeni nazw `prod` na `my.database.example.com`:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
Gdy wyszukujemy hosta `my-service.prod.svc.cluster.local`, usługa DNS klastra zwraca rekord `CNAME` o wartości `my.database.example.com`. Dostęp do `my-service` działa tak samo jak w przypadku innych Usług, ale z istotną różnicą, że **przekierowanie następuje na poziomie DNS**, a nie poprzez proxy lub przekazywanie.

Lista wszystkich ExternalNames:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces | grep ExternalName
```
{% endcode %}

### Ingress

W przeciwieństwie do wszystkich powyższych przykładów, **Ingress NIE jest rodzajem usługi**. Zamiast tego znajduje się **przed wieloma usługami i działa jak "inteligentny router"** lub punkt wejścia do klastra.

Możesz wykonać wiele różnych czynności za pomocą Ingress, a istnieje **wiele rodzajów kontrolerów Ingress o różnych możliwościach**.

Domyślny kontroler Ingress w GKE uruchomi [Balancer obciążenia HTTP(S)](https://cloud.google.com/compute/docs/load-balancing/http/) dla Ciebie. Pozwoli to na zarządzanie ruchem zarówno na podstawie ścieżki, jak i subdomeny do usług backendowych. Na przykład możesz przekierować wszystko na foo.twojadomena.com do usługi foo, a wszystko pod ścieżką twojadomena.com/bar/ do usługi bar.

YAML dla obiektu Ingress w GKE z [Balancerem obciążenia HTTP L7](https://cloud.google.com/compute/docs/load-balancing/http/) może wyglądać tak:
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
Wypisz wszystkie wejścia:

{% code overflow="wrap" %}
```bash
kubectl get ingresses --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RULES:spec.rules[*],STATUS:status'
```
{% endcode %}

Chociaż w tym przypadku lepiej jest uzyskać informacje o każdym z osobna, aby lepiej je przeczytać:
```bash
kubectl get ingresses --all-namespaces -o=yaml
```
### Odnośniki

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

{% hint style="success" %}
Naucz się i praktykuj Hacking w AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz się i praktykuj Hacking w GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel się trikami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
