# Blootstelling van Dienste in Kubernetes

<details>

<summary><strong>Leer AWS hak vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling van eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou haktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

Daar is **verskillende maniere om dienste bloot te stel** in Kubernetes sodat beide **interne** eindpunte en **eksterne** eindpunte hulle kan bereik. Hierdie Kubernetes-konfigurasie is baie krities aangesien die administrateur toegang aan **aanvallers kan gee tot dienste waarop hulle nie toegang behoort te h√™ nie**.

### Outomatiese Opsomming

Voordat jy begin met die opsomming van die maniere waarop K8s dienste aan die publiek blootstel, moet jy weet dat as jy namespaces, dienste en ingresses kan lys, kan jy alles wat aan die publiek blootgestel is, vind met:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

'n **ClusterIP**-diens is die **verstek** Kubernetes **diens**. Dit gee jou 'n **diens binne** jou cluster wat ander programme binne jou cluster kan bereik. Daar is **geen eksterne toegang** nie.

Nietemin kan hierdie toegang kry deur die gebruik van die Kubernetes Proksi:
```bash
kubectl proxy --port=8080
```
Nou kan jy deur die Kubernetes API navigeer om dienste te bereik met behulp van hierdie skema:

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

Byvoorbeeld, jy kan die volgende URL gebruik:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

om toegang tot hierdie diens te verkry:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_Hierdie metode vereis dat jy `kubectl` uitvoer as 'n **geautentiseerde gebruiker**._

Lys alle ClusterIP's:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep ClusterIP
```
### NodePort

Wanneer **NodePort** gebruik word, word 'n aangewese poort beskikbaar gestel op alle Nodes (wat die Virtuele Masjiene verteenwoordig). **Verkeer** wat na hierdie spesifieke poort gestuur word, word dan sistematies **gerouteer na die diens**. Gewoonlik word hierdie metode nie aanbeveel nie as gevolg van sy nadele.

Lys alle NodePorts op:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep NodePort
```
{% endcode %}

'n Voorbeeld van 'n NodePort-spesifikasie:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
Indien jy **nie die nodePort spesifiseer** in die yaml nie (dit is die poort wat oopgemaak sal word) sal 'n poort in die **reeks 30000‚Äì32767 gebruik word**.

### LoadBalancer <a href="#id-0d96" id="id-0d96"></a>

Stel die Diens ekstern bloot **deur 'n wolkverskaffer se balanser te gebruik**. Op GKE, sal dit 'n [Netwerk Balanser](https://cloud.google.com/compute/docs/load-balancing/network/) opstel wat jou 'n enkele IP-adres sal gee wat alle verkeer na jou diens sal deurstuur. Op AWS sal dit 'n Balanser begin.

Jy moet vir 'n Balanser per blootgestelde diens betaal, wat duur kan wees.

Lys alle Balansers op:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,EXTERNAL-IP:.status.loadBalancer.ingress[*],PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep LoadBalancer
```
{% endcode %}

### Eksterne IP-adresse <a href="#external-ips" id="external-ips"></a>

{% hint style="success" %}
Eksterne IP-adresse word blootgestel deur dienste van die tipe Laai Balansiers en hulle word gewoonlik gebruik wanneer 'n eksterne Wolkmynbouer Laai Balansier gebruik word.

Om hulle te vind, kyk vir laaibalansiers met waardes in die `EXTERNAL-IP` veld.
{% endhint %}

Verkeer wat in die groep inkom met die **eksterne IP-adres** (as **bestemmings-IP**), op die Dienspoort, sal **geroeteer word na een van die Diens-eindpunte**. `externalIPs` word nie deur Kubernetes bestuur nie en is die verantwoordelikheid van die groepadministrateur.

In die Diensspesifikasie kan `externalIPs` saam met enige van die `ServiceTypes` gespesifiseer word. In die voorbeeld hieronder kan "`my-service`" deur kli√´nte op "`80.11.12.10:80`" (`externalIP:port`) benader word.
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### ExternalName

[**Van die dokumente:**](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) Dienste van die tipe ExternalName **map 'n Diens na 'n DNS-naam**, nie na 'n tipiese kieser soos `my-service` of `cassandra`. Jy spesifiseer hierdie Dienste met die `spec.externalName` parameter.

Hierdie Diensdefinisie, byvoorbeeld, map die `my-service` Diens in die `prod` naamspasie na `my.database.example.com`:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
Wanneer daar opgesoek word na die gasheer `my-service.prod.svc.cluster.local`, gee die cluster DNS-diens 'n `CNAME`-inskrywing terug met die waarde `my.database.example.com`. Toegang tot `my-service` werk op dieselfde manier as ander Dienste, maar met die kritieke verskil dat **herleiing plaasvind op DNS-vlak** eerder as deur middel van proksiedienste of deurstuur.

Lys alle EksterneName op:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces | grep ExternalName
```
{% endcode %}

### Ingress

In teenstelling tot al die bogenoemde voorbeelde, **is Ingress NIE 'n tipe diens nie**. In plaas daarvan sit dit **voor meerdere dienste en tree op as 'n "slim roeteerder"** of ingang tot jou groep.

Jy kan baie verskillende dinge doen met 'n Ingress, en daar is **baie tipes Ingress-beheerders wat verskillende vermo√´ns het**.

Die verstek GKE ingress-beheerder sal 'n [HTTP(S) Laaibalansier](https://cloud.google.com/compute/docs/load-balancing/http/) vir jou opstel. Dit sal jou toelaat om beide pad-gebaseerde en subdomein-gebaseerde roetetoewysing na agterste dienste te doen. Byvoorbeeld, jy kan alles op foo.joudomein.com stuur na die foo-diens, en alles onder die joudomein.com/bar/ pad na die bar-diens.

Die YAML vir 'n Ingress-voorwerp op GKE met 'n [L7 HTTP Laaibalansier](https://cloud.google.com/compute/docs/load-balancing/http/) kan lyk soos dit:
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
Lys alle die inganges:

{% code overflow="wrap" %}
```bash
kubectl get ingresses --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RULES:spec.rules[*],STATUS:status'
```
{% endcode %}

Alhoewel dit in hierdie geval beter is om die inligting van elkeen een vir een te kry om dit beter te lees:
```bash
kubectl get ingresses --all-namespaces -o=yaml
```
### Verwysings

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS-familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
