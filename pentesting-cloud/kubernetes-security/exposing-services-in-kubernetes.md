# Kubernetes'te Hizmetleri Açığa Çıkarma

<details>

<summary><strong>Sıfırdan kahraman olacak şekilde AWS hacklemeyi öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**]'na göz atın (https://github.com/sponsors/carlospolop)!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**]'yi (https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**]'i (https://opensea.io/collection/the-peass-family) içeren koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya beni **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**'de takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR'lar göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

Kubernetes'te hizmetleri açığa çıkarmak için **farklı yöntemler** bulunmaktadır, böylece **iç** ve **dış** uç noktalar bunlara erişebilir. Bu Kubernetes yapılandırması oldukça kritiktir çünkü yönetici, **erişmemeleri gereken hizmetlere saldırganlara erişim sağlayabilir**. 

### Otomatik Numaralandırma

K8s'in hizmetleri genel kullanıma açma yollarını numaralandırmaya başlamadan önce, namespace'leri, hizmetleri ve ingress'leri listeleyebiliyorsanız, her şeyin genel kullanıma açık olduğunu bulabilirsiniz:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

Bir **ClusterIP** servisi, **varsayılan** Kubernetes **servisidir**. Kümeniz içinde diğer uygulamaların erişebileceği bir **servis** sağlar. **Harici erişim yoktur**.

Ancak, bu Kubernetes Proxy kullanılarak erişilebilir:
```bash
kubectl proxy --port=8080
```
Şimdi, Kubernetes API'si üzerinden hizmetlere erişmek için bu şemayı kullanabilirsiniz:

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

Örneğin, aşağıdaki URL'yi kullanabilirsiniz:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

bu hizmete erişmek için:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_Bu yöntem, `kubectl`'i **kimlik doğrulanmış bir kullanıcı** olarak çalıştırmanızı gerektirir._

Tüm ClusterIP'leri listele:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep ClusterIP
```
### NodePort

**NodePort** kullanıldığında, tüm Düğümlerde (Sanal Makineleri temsil eden) belirli bir bağlantı noktası kullanılabilir hale getirilir. Bu belirli bağlantı noktasına yönlendirilen **trafik**, ardından hizmete sistemli bir şekilde yönlendirilir. Genellikle, bu yöntem dezavantajları nedeniyle önerilmez.

Tüm NodePort'ları listele:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep NodePort
```
{% endcode %}

NodePort spesifikasyonuna bir örnek:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
Eğer yaml dosyasında **nodePort** belirtmezseniz (açılacak olan port), **30000–32767 aralığında bir port** kullanılacaktır.

### LoadBalancer <a href="#id-0d96" id="id-0d96"></a>

Dışarıya **bir bulut sağlayıcısının yük dengeleyicisini kullanarak** Servisi açar. GKE'de, bu [Network Load Balancer](https://cloud.google.com/compute/docs/load-balancing/network/) oluşturacak ve tüm trafiği servisinize iletecek tek bir IP adresi sağlayacaktır. AWS'de bir Yük Dengeleyici başlatacaktır.

Her açılan servis için bir Yük Dengeleyiciye ödeme yapmanız gerekebilir, bu maliyetli olabilir.

Tüm Yük Dengeleyicileri listele:

{% code overflow="wrap" %}
```bash
kubectl get services --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,TYPE:.spec.type,CLUSTER-IP:.spec.clusterIP,EXTERNAL-IP:.status.loadBalancer.ingress[*],PORT(S):.spec.ports[*].port,NODEPORT(S):.spec.ports[*].nodePort,TARGETPORT(S):.spec.ports[*].targetPort,SELECTOR:.spec.selector' | grep LoadBalancer
```
{% endcode %}

### Harici IP'ler <a href="#external-ips" id="external-ips"></a>

{% hint style="success" %}
Harici IP'ler, Yük Dengeleyiciler türündeki hizmetler tarafından açığa çıkarılır ve genellikle harici bir Bulut Sağlayıcı Yük Dengeleyicisi kullanıldığında kullanılır.

Bunları bulmak için, `EXTERNAL-IP` alanında değerleri olan yük dengeleyicileri kontrol edin.
{% endhint %}

Küme içine giren trafiğin **harici IP** (hedef IP olarak) üzerinden, Servis portuna yönlendirileceği bir Servis uç noktasına **yönlendirilecektir**. `externalIPs`, Kubernetes tarafından yönetilmez ve küme yöneticisinin sorumluluğundadır.

Servis özelliklerinde, `externalIPs` herhangi bir `ServiceTypes` ile birlikte belirtilebilir. Aşağıdaki örnekte, "`my-service`" "`80.11.12.10:80`" (`externalIP:port`) üzerinden istemciler tarafından erişilebilir.
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### ExternalName

[**Dokümantasyondan:**](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) ExternalName türündeki Servisler, bir Servisi tipik bir seçiciye (`my-service` veya `cassandra` gibi) değil, bir DNS adına **eşler**. Bu Servisler belirliyorsunuz ve `spec.externalName` parametresi ile tanımlıyorsunuz.

Örneğin, aşağıdaki Servis tanımı, `prod` ad alanındaki `my-service` Servisini `my.database.example.com` adresine eşler:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
```markdown
Kubernetes'te `my-service.prod.svc.cluster.local` ana bilgisayarını aradığınızda, küme DNS Hizmeti `my.database.example.com` değerine sahip bir `CNAME` kaydı döndürür. `my-service`'e erişmek diğer Hizmetlerle aynı şekilde çalışır ancak **yönlendirme DNS seviyesinde** proxy veya yönlendirme yoluyla değil gerçekleşir.

Tüm ExternalNames'leri listele:

{% code overflow="wrap" %}
```
```bash
kubectl get services --all-namespaces | grep ExternalName
```
{% endcode %}

### Ingress

Tüm yukarıdaki örneklerin aksine, **Ingress bir hizmet türü DEĞİLDİR**. Bunun yerine, **çoklu hizmetlerin önünde oturur ve bir "akıllı yönlendirici" veya kümenize giriş noktası olarak hareket eder**.

Bir Ingress ile birçok farklı şey yapabilirsiniz ve **farklı yeteneklere sahip birçok türde Ingress denetleyicisi bulunmaktadır**.

Varsayılan GKE ingress denetleyicisi sizin için bir [HTTP(S) Yük Dengeleyici](https://cloud.google.com/compute/docs/load-balancing/http/) oluşturacaktır. Bu size hem yol tabanlı hem de alt alan tabanlı yönlendirme imkanı sağlar. Örneğin, foo.yourdomain.com'daki her şeyi foo servisine gönderebilir ve yourdomain.com/bar/ yolunun altındaki her şeyi bar servisine gönderebilirsiniz.

GKE'de bir Ingress nesnesi için bir [L7 HTTP Yük Dengeleyici](https://cloud.google.com/compute/docs/load-balancing/http/) ile YAML şöyle görünebilir:
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
Tüm girişleri listele:

{% code overflow="wrap" %}
```bash
kubectl get ingresses --all-namespaces -o=custom-columns='NAMESPACE:.metadata.namespace,NAME:.metadata.name,RULES:spec.rules[*],STATUS:status'
```
{% endcode %}

Bu durumda her birini tek tek alıp daha iyi okumak için bilgilerini almak daha iyidir:
```bash
kubectl get ingresses --all-namespaces -o=yaml
```
### Referanslar

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

<details>

<summary><strong>Sıfırdan kahraman olacak şekilde AWS hackleme öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **💬 [Discord grubuna](https://discord.gg/hRep4RUj7f) veya [telegram grubuna](https://t.me/peass) katılın veya beni Twitter'da takip edin** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Hacking püf noktalarınızı paylaşarak PR'lar göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
