# Controle de Acesso Baseado em Fun√ß√£o do Kubernetes (RBAC)

{% hint style="success" %}
Aprenda e pratique Hacking na AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking no GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Controle de Acesso Baseado em Fun√ß√£o (RBAC)

O Kubernetes possui um **m√≥dulo de autoriza√ß√£o chamado Controle de Acesso Baseado em Fun√ß√£o** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) que ajuda a definir permiss√µes de utiliza√ß√£o para o servidor de API.

O modelo de permiss√£o do RBAC √© constru√≠do a partir de **tr√™s partes individuais**:

1. **Fun√ß√£o/ClusterRole ‚Äì** A permiss√£o real. Cont√©m _**regras**_ que representam um conjunto de permiss√µes. Cada regra cont√©m [recursos](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) e [verbos](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). O verbo √© a a√ß√£o que ser√° aplicada ao recurso.
2. **Sujeito (Usu√°rio, Grupo ou ServiceAccount) ‚Äì** O objeto que receber√° as permiss√µes.
3. **RoleBinding/ClusterRoleBinding ‚Äì** A conex√£o entre Fun√ß√£o/ClusterRole e o sujeito.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

A diferen√ßa entre "**Fun√ß√µes**" e "**ClusterRoles**" est√° apenas onde a fun√ß√£o ser√° aplicada ‚Äì uma "**Fun√ß√£o**" conceder√° acesso a apenas **um** **namespace espec√≠fico**, enquanto um "**ClusterRole**" pode ser usado em **todos os namespaces** no cluster. Al√©m disso, **ClusterRoles** tamb√©m podem conceder acesso a:

* recursos de **escopo de cluster** (como n√≥s).
* endpoints de **n√£o recurso** (como /healthz).
* recursos de namespace (como Pods), **em todos os namespaces**.

A partir do **Kubernetes** 1.6 em diante, as pol√≠ticas de **RBAC** s√£o **ativadas por padr√£o**. Mas para habilitar o RBAC, voc√™ pode usar algo como:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Modelos

No modelo de uma **Fun√ß√£o** ou de um **ClusterRole** voc√™ precisar√° indicar o **nome da fun√ß√£o**, o **espa√ßo de nomes** (em fun√ß√µes) e ent√£o os **apiGroups**, **recursos** e **verbos** da fun√ß√£o:

- Os **apiGroups** s√£o uma matriz que cont√©m os diferentes **espa√ßos de nomes da API** aos quais essa regra se aplica. Por exemplo, uma defini√ß√£o de Pod usa apiVersion: v1. _Pode ter valores como rbac.authorization.k8s.io ou \[\*]_.
- Os **recursos** s√£o uma matriz que define **a quais recursos essa regra se aplica**. Voc√™ pode encontrar todos os recursos com: `kubectl api-resources --namespaced=true`
- Os **verbos** s√£o uma matriz que cont√©m os **verbos permitidos**. O verbo no Kubernetes define o **tipo de a√ß√£o** que voc√™ precisa aplicar ao recurso. Por exemplo, o verbo de listagem √© usado em cole√ß√µes enquanto "get" √© usado em um √∫nico recurso.

### Verbos de Regras

(_Essas informa√ß√µes foram retiradas da_ [_**documenta√ß√£o**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| Verbo HTTP | verbo da requisi√ß√£o                                                                                                                                           |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST       | create                                                                                                                                                        |
| GET, HEAD  | get (para recursos individuais), list (para cole√ß√µes, incluindo conte√∫do completo do objeto), watch (para observar um recurso individual ou cole√ß√£o de recursos) |
| PUT        | update                                                                                                                                                        |
| PATCH      | patch                                                                                                                                                         |
| DELETE     | delete (para recursos individuais), deletecollection (para cole√ß√µes)                                                                                         |

√Äs vezes o Kubernetes verifica a autoriza√ß√£o para permiss√µes adicionais usando verbos especializados. Por exemplo:

- [Pol√≠tica de Seguran√ßa do Pod](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
- Verbo `use` em recursos `podsecuritypolicies` no grupo de API `policy`.
- [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
- Verbos `bind` e `escalate` em recursos `roles` e `clusterroles` no grupo de API `rbac.authorization.k8s.io`.
- [Autentica√ß√£o](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
- Verbo `impersonate` em `usu√°rios`, `grupos` e `contas de servi√ßo` no grupo de API principal, e os `userextras` no grupo de API `authentication.k8s.io`.

{% hint style="warning" %}
Voc√™ pode encontrar **todos os verbos que cada recurso suporta** executando `kubectl api-resources --sort-by name -o wide`
{% endhint %}

### Exemplos

{% code title="Fun√ß√£o" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Por exemplo, voc√™ pode usar um **ClusterRole** para permitir que um usu√°rio espec√≠fico execute:
```
kubectl get pods --all-namespaces
```
### **RoleBinding e ClusterRoleBinding**

**[Da documenta√ß√£o:](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding)** Um **role binding concede as permiss√µes definidas em um role para um usu√°rio ou conjunto de usu√°rios**. Ele cont√©m uma lista de subjects (usu√°rios, grupos ou contas de servi√ßo) e uma refer√™ncia ao role concedido. Um **RoleBinding** concede permiss√µes dentro de um **namespace** espec√≠fico, enquanto um **ClusterRoleBinding** concede esse acesso **em todo o cluster**.

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**As permiss√µes s√£o aditivas**, ent√£o se voc√™ tiver um clusterRole com "list" e "delete" de segredos, voc√™ pode adicion√°-lo com um Role com "get". Portanto, esteja ciente e teste sempre seus pap√©is e permiss√µes e **especifique o que √© PERMITIDO, pois por padr√£o tudo √© NEGADO.**

## **Enumerando RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Abuso de Fun√ß√µes/ClusterRoles para Escala√ß√£o de Privil√©gios

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
Aprenda e pratique Hacking na AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking no GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
