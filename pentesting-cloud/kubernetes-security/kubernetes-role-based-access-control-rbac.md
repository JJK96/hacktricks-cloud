# Kubernetes Rolgebaseerde Toegangsbeheer (RBAC)

{% hint style="success" %}
Leer & oefen AWS-hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP-hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Controleer de [**abonnementsplannen**](https://github.com/sponsors/carlospolop)!
* **Sluit aan bij de** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of de [**telegramgroep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktrucs door PR's in te dienen bij de** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>
{% endhint %}

## Rolgebaseerde Toegangsbeheer (RBAC)

Kubernetes het 'n **goedkeuringsmodule genaamd Rolgebaseerde Toegangsbeheer** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) wat help om gebruikersregte aan die API-bediener toe te ken.

RBAC se toestemmingsmodel is opgebou uit **drie individuele dele**:

1. **Rol\ClusterRol ¬≠‚Äì** Die werklike toestemming. Dit bevat _**re√´ls**_ wat 'n stel toestemmings verteenwoordig. Elke re√´l bevat [hulpbronne](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) en [werkwoorde](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). Die werkwoord is die aksie wat op die hulpbron toegepas sal word.
2. **Onderwerp (Gebruiker, Groep of Diensrekening) ‚Äì** Die objek wat die toestemmings sal ontvang.
3. **Rolbinding\ClusterRolbinding ‚Äì** Die skakel tussen Rol\ClusterRol en die onderwerp.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

Die verskil tussen "**Rolle**" en "**ClusterRoles**" is net waar die rol toegepas sal word ‚Äì 'n "**Rol**" sal toegang verleen tot slegs **een** **spesifieke** **naamruimte**, terwyl 'n "**ClusterRol**" in **alle name ruimtes** in die cluster gebruik kan word. Verder kan **ClusterRoles** ook toegang verleen tot:

* **kluster-omvang** hulpbronne (soos knotte).
* **nie-hulpbron** eindpunte (soos /healthz).
* naamruimte-hulpbronne (soos Peule), **oor alle name ruimtes**.

Vanaf **Kubernetes** 1.6 aan, is **RBAC** beleide **standaard ingeskakel**. Maar om RBAC in te skakel kan jy iets soos gebruik:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Templaat

In die templaat van 'n **Rol** of 'n **ClusterRole** sal jy die **naam van die rol**, die **namespace** (in rolle) en dan die **apiGroups**, **hulpbronne** en **werkwoorde** van die rol moet aandui:

- Die **apiGroups** is 'n array wat die verskillende **API namespaces** bevat waaraan hierdie re√´l van toepassing is. Byvoorbeeld, 'n Pod-definisie gebruik apiVersion: v1. _Dit kan waardes h√™ soos rbac.authorization.k8s.io of \[\*]_.
- Die **hulpbronne** is 'n array wat bepaal **op watter hulpbronne hierdie re√´l van toepassing is**. Jy kan al die hulpbronne vind met: `kubectl api-resources --namespaced=true`
- Die **werkwoorde** is 'n array wat die **toegelate werkwoorde** bevat. Die werkwoord in Kubernetes definieer die **tipe aksie** wat jy moet toepas op die hulpbron. Byvoorbeeld, die lyswerkwoord word gebruik teen versamelings terwyl "kry" teen 'n enkele hulpbron gebruik word.

### Re√´ls Werkwoorde

(_Hierdie inligting is geneem van_ [_**die dokumente**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| HTTP werkwoord | versoek werkwoord                                                                                                                                              |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST           | skep                                                                                                                                                          |
| GET, HEAD      | kry (vir individuele hulpbronne), lys (vir versamelings, insluitend volledige objekinhoud), kyk (vir die kyk na 'n individuele hulpbron of versameling hulpbronne) |
| PUT            | opdateer                                                                                                                                                      |
| PATCH          | lap                                                                                                                                                          |
| DELETE         | verwyder (vir individuele hulpbronne), deletecollection (vir versamelings)                                                                                     |

Kubernetes kyk soms na outorisasie vir addisionele toestemmings deur gespesialiseerde werkwoorde te gebruik. Byvoorbeeld:

- [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
- `use` werkwoord op `podsecuritypolicies` hulpbronne in die `policy` API groep.
- [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
- `bind` en `escalate` werkwoorde op `roles` en `clusterroles` hulpbronne in die `rbac.authorization.k8s.io` API groep.
- [Authentication](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
- `impersonate` werkwoord op `users`, `groups`, en `serviceaccounts` in die kern API groep, en die `userextras` in die `authentication.k8s.io` API groep.

{% hint style="waarskuwing" %}
Jy kan **al die werkwoorde wat elke hulpbron ondersteun** vind deur `kubectl api-resources --sort-by name -o wide` uit te voer
{% endhint %}

### Voorbeelde

{% code title="Rol" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}  
### Rolgebaseerde toegangsbeheer (RBAC) in Kubernetes

RBAC stel jou in staat om fynkorrelige controle te h√™ oor wat gebruikers kan doen in 'n Kubernetes-omgewing. Dit is belangrik om te verstaan hoe rolle en regte toegewys word binne 'n Kubernetes-kluster.  
{% endcode %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Byvoorbeeld, jy kan 'n **ClusterRole** gebruik om 'n spesifieke gebruiker toe te laat om uit te voer:
```
kubectl get pods --all-namespaces
```
### **RoleBinding en ClusterRoleBinding**

**[Van die dokumente:](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding)** 'n **RoleBinding verleen die toestemmings wat in 'n rol gedefinieer is aan 'n gebruiker of 'n stel gebruikers**. Dit bevat 'n lys van onderwerpe (gebruikers, groepe, of diensrekeninge), en 'n verwysing na die rol wat verleen word. 'n **RoleBinding** verleen toestemmings binne 'n spesifieke **naamspasie** terwyl 'n **ClusterRoleBinding** daardie toegang **oor die hele klas** verleen.
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**Toestemmings is additief** dus as jy 'n clusterRole het met "lys" en "verwyder" geheime kan jy dit byvoeg met 'n Rol met "kry". Wees dus bewus en toets altyd jou rolle en toestemmings en **spesifiseer wat IS TOEGELAAT, omdat alles standaard GEWEIER word.**

## **Opsomming van RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Misbruik Rolle/ClusterRoles vir Voorregverhoging

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[misbruik-van-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
Leer & oefen AWS-hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP-hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
