# Έλεγχος Πρόσβασης Βασισμένος σε Ρόλους (RBAC) στο Kubernetes

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ κάνοντας υποβολή PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Έλεγχος Πρόσβασης Βασισμένος σε Ρόλους (RBAC)

Το Kubernetes διαθέτει ένα **μοντέλο εξουσιοδότησης με το όνομα Έλεγχος Πρόσβασης Βασισμένος σε Ρόλους** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) που βοηθά στον καθορισμό των δικαιωμάτων χρήσης στον διακομιστή API.

Το μοντέλο δικαιωμάτων του RBAC αποτελείται από **τρία μεμονωμένα μέρη**:

1. **Ρόλος\ClusterRole ­–** Το πραγματικό δικαίωμα. Περιέχει _**κανόνες**_ που αντιπροσωπεύουν ένα σύνολο δικαιωμάτων. Κάθε κανόνας περιέχει [πόρους](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) και [ρήματα](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). Το ρήμα είναι η ενέργεια που θα εφαρμοστεί στον πόρο.
2. **Υποκείμενο (Χρήστης, Ομάδα ή Λογαριασμός Υπηρεσίας) –** Το αντικείμενο που θα λάβει τα δικαιώματα.
3. **RoleBinding\ClusterRoleBinding –** Η σύνδεση μεταξύ Ρόλου\ClusterRole και του υποκειμένου.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

Η διαφορά μεταξύ των “**Ρόλων**” και των “**ClusterRoles**” είναι απλώς όπου θα εφαρμοστεί ο ρόλος – ένας “**Ρόλος**” θα χορηγήσει πρόσβαση μόνο σε **ένα συγκεκριμένο** **χώρο ονομάτων**, ενώ ένα “**ClusterRole**” μπορεί να χρησιμοποιηθεί σε **όλους τους χώρους ονομάτων** στο cluster. Επιπλέον, οι **ClusterRoles** μπορούν επίσης να χορηγήσουν πρόσβαση σε:

* πόρους με εύρος cluster (όπως κόμβους).
* σημεία άκρης μη-πόρου (όπως /healthz).
* πόρους με εύρος ονομάτων (όπως Pods), **σε όλους τους χώρους ονομάτων**.

Από την έκδοση **Kubernetes** 1.6 και μετά, οι πολιτικές του **RBAC** είναι **ενεργοποιημένες από προεπιλογή**. Ωστόσο, για να ενεργοποιήσετε το RBAC μπορείτε να χρησιμοποιήσετε κάτι παρόμοιο με:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Πρότυπα

Στο πρότυπο ενός **Ρόλου** ή ενός **ClusterRole** θα χρειαστεί να υποδείξετε το **όνομα του ρόλου**, το **namespace** (στους ρόλους) και στη συνέχεια τα **apiGroups**, **resources** και **verbs** του ρόλου:

* Τα **apiGroups** είναι ένας πίνακας που περιέχει τα διαφορετικά **ονόματα χώρων ονομάτων API** στα οποία εφαρμόζεται αυτός ο κανόνας. Για παράδειγμα, μια ορισμός Pod χρησιμοποιεί apiVersion: v1. _Μπορεί να έχει τιμές όπως rbac.authorization.k8s.io ή \[\*]_.
* Οι **πόροι (resources)** είναι ένας πίνακας που ορίζει **ποιους πόρους εφαρμόζεται αυτός ο κανόνας**. Μπορείτε να βρείτε όλους τους πόρους με: `kubectl api-resources --namespaced=true`
* Οι **ρήματα (verbs)** είναι ένας πίνακας που περιέχει τα **επιτρεπόμενα ρήματα**. Το ρήμα στο Kubernetes ορίζει το **τύπο δράσης** που πρέπει να εφαρμόσετε στον πόρο. Για παράδειγμα, το ρήμα λίστα χρησιμοποιείται εναντίον συλλογών ενώ το "get" χρησιμοποιείται εναντίον ενός μοναδικού πόρου.

### Ρήματα Κανόνων

(_Αυτές οι πληροφορίες προήλθαν από_ [_**τα έγγραφα**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| HTTP ρήμα | ρήμα αίτησης                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get (για μεμονωμένους πόρους), list (για συλλογές, συμπεριλαμβανομένου του πλήρους περιεχομένου αντικειμένου), watch (για παρακολούθηση ενός μεμονωμένου πόρου ή συλλογής πόρων) |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete (για μεμονωμένους πόρους), deletecollection (για συλλογές)                                                                                         |

Το Kubernetes μερικές φορές ελέγχει την εξουσιοδότηση για επιπλέον δικαιώματα χρησιμοποιώντας εξειδικευμένα ρήματα. Για παράδειγμα:

* [Πολιτική Ασφάλειας Ποδιών (PodSecurityPolicy)](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
* το ρήμα `use` στους πόρους `podsecuritypolicies` στην ομάδα API `policy`.
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
* τα ρήματα `bind` και `escalate` στους πόρους `roles` και `clusterroles` στην ομάδα API `rbac.authorization.k8s.io`.
* [Ταυτοποίηση (Authentication)](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
* το ρήμα `impersonate` στους πόρους `users`, `groups` και `serviceaccounts` στην κύρια ομάδα API, και το `userextras` στην ομάδα API `authentication.k8s.io`.

{% hint style="warning" %}
Μπορείτε να βρείτε **όλα τα ρήματα που υποστηρίζει κάθε πόρος** εκτελώντας `kubectl api-resources --sort-by name -o wide`
{% endhint %}

### Παραδείγματα

{% code title="Ρόλος" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Για παράδειγμα, μπορείτε να χρησιμοποιήσετε ένα **ClusterRole** για να επιτρέψετε σε ένα συγκεκριμένο χρήστη να εκτελέσει:
```
kubectl get pods --all-namespaces
```
### **RoleBinding και ClusterRoleBinding**

**[Από τα έγγραφα:](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding)** Ένα **role binding χορηγεί τις άδειες που ορίζονται σε ένα ρόλο σε έναν χρήστη ή ομάδα χρηστών**. Κρατά μια λίστα από θέματα (χρήστες, ομάδες ή λογαριασμούς υπηρεσίας) και μια αναφορά στον ρόλο που χορηγείται. Ένα **RoleBinding** χορηγεί άδειες εντός ενός συγκεκριμένου **namespace** ενώ ένα **ClusterRoleBinding** χορηγεί αυτήν την πρόσβαση **σε όλο το cluster**.

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**Οι άδειες είναι πρόσθετες** οπότε αν έχετε ένα clusterRole με "list" και "delete" μυστικά μπορείτε να το προσθέσετε με ένα Role με "get". Έτσι, να είστε προσεκτικοί και να ελέγχετε πάντα τους ρόλους και τις άδειες σας και **να καθορίζετε τι επιτρέπεται, επειδή τα πάντα απορρίπτονται από προεπιλογή.**

## **Απαρίθμηση RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Κατάχρηση Ρόλων/ClusterRoles για Ανόδο Προνομίων

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Συμμετέχετε** 💬 στην [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Κοινοποιήστε τεχνικές χάκινγκ υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
