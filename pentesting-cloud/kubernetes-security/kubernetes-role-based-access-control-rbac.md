# Contr√¥le d'acc√®s bas√© sur les r√¥les de Kubernetes (RBAC)

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## Contr√¥le d'acc√®s bas√© sur les r√¥les (RBAC)

Kubernetes dispose d'un **module d'autorisation nomm√© Contr√¥le d'acc√®s bas√© sur les r√¥les** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) qui aide √† d√©finir les autorisations d'utilisation du serveur API.

Le mod√®le d'autorisation de RBAC est construit √† partir de **trois parties individuelles** :

1. **R√¥le/ClusterRole ‚Äì** La permission r√©elle. Il contient des _**r√®gles**_ qui repr√©sentent un ensemble d'autorisations. Chaque r√®gle contient des [ressources](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) et des [verbes](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). Le verbe est l'action qui sera appliqu√©e sur la ressource.
2. **Sujet (Utilisateur, Groupe ou Compte de service) ‚Äì** L'objet qui recevra les autorisations.
3. **RoleBinding/ClusterRoleBinding ‚Äì** La connexion entre le R√¥le/ClusterRole et le sujet.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

La diff√©rence entre les "**R√¥les**" et les "**ClusterRoles**" r√©side uniquement dans l'endroit o√π le r√¥le sera appliqu√© - un "**R√¥le**" accordera l'acc√®s √† un **seul** **espace de noms** **sp√©cifique**, tandis qu'un "**ClusterRole**" peut √™tre utilis√© dans **tous les espaces de noms** du cluster. De plus, les **ClusterRoles** peuvent √©galement accorder l'acc√®s √† :

* ressources de port√©e cluster (comme les n≈ìuds).
* points de terminaison non li√©s aux ressources (comme /healthz).
* ressources de port√©e namespace (comme les Pods), **dans tous les espaces de noms**.

√Ä partir de **Kubernetes** 1.6, les politiques **RBAC** sont **activ√©es par d√©faut**. Mais pour activer RBAC, vous pouvez utiliser quelque chose comme :
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Mod√®les

Dans le mod√®le d'un **R√¥le** ou d'un **ClusterRole**, vous devrez indiquer le **nom du r√¥le**, l'**espace de noms** (dans les r√¥les) et ensuite les **apiGroups**, **resources** et **verbs** du r√¥le :

* Les **apiGroups** est un tableau qui contient les diff√©rents **espaces de noms API** auxquels cette r√®gle s'applique. Par exemple, une d√©finition de Pod utilise apiVersion: v1. _Il peut avoir des valeurs telles que rbac.authorization.k8s.io ou \[\*]_.
* Les **resources** est un tableau qui d√©finit **√† quelles ressources cette r√®gle s'applique**. Vous pouvez trouver toutes les ressources avec : `kubectl api-resources --namespaced=true`
* Les **verbs** est un tableau qui contient les **verbes autoris√©s**. Le verbe dans Kubernetes d√©finit le **type d'action** que vous devez appliquer √† la ressource. Par exemple, le verbe list est utilis√© contre des collections tandis que "get" est utilis√© contre une ressource unique.

### Verbes des r√®gles

(_Ces informations ont √©t√© extraites de_ [_**la documentation**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| Verbe HTTP | verbe de requ√™te                                                                                                                                             |
| ---------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST       | create                                                                                                                                                      |
| GET, HEAD  | get (pour les ressources individuelles), list (pour les collections, y compris le contenu complet de l'objet), watch (pour surveiller une ressource individuelle ou une collection de ressources) |
| PUT        | update                                                                                                                                                      |
| PATCH      | patch                                                                                                                                                       |
| DELETE     | delete (pour les ressources individuelles), deletecollection (pour les collections)                                                                         |

Parfois, Kubernetes v√©rifie l'autorisation pour des autorisations suppl√©mentaires en utilisant des verbes sp√©cialis√©s. Par exemple :

* [Politique de s√©curit√© des pods](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
* Verbe `use` sur les ressources `podsecuritypolicies` dans le groupe API `policy`.
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
* Verbes `bind` et `escalate` sur les ressources `roles` et `clusterroles` dans le groupe API `rbac.authorization.k8s.io`.
* [Authentification](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
* Verbe `impersonate` sur les `utilisateurs`, `groupes` et `comptes de service` dans le groupe API principal, et les `userextras` dans le groupe API `authentication.k8s.io`.

{% hint style="warning" %}
Vous pouvez trouver **tous les verbes que chaque ressource prend en charge** en ex√©cutant `kubectl api-resources --sort-by name -o wide`
{% endhint %}

### Exemples

{% code title="R√¥le" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Par exemple, vous pouvez utiliser un **ClusterRole** pour permettre √† un utilisateur particulier d'ex√©cuter :
```
kubectl get pods --all-namespaces
```
### **RoleBinding et ClusterRoleBinding**

**[Depuis la documentation:](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding)** Un **role binding accorde les autorisations d√©finies dans un r√¥le √† un utilisateur ou √† un ensemble d'utilisateurs**. Il contient une liste de sujets (utilisateurs, groupes ou comptes de service), et une r√©f√©rence au r√¥le accord√©. Un **RoleBinding** accorde des autorisations dans un **espace de noms** sp√©cifique tandis qu'un **ClusterRoleBinding** accorde cet acc√®s √† l'ensemble du **cluster**.

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**Les autorisations sont additives** donc si vous avez un clusterRole avec les autorisations "list" et "delete" pour les secrets, vous pouvez l'ajouter avec un Role avec l'autorisation "get". Soyez conscient et testez toujours vos r√¥les et autorisations et **sp√©cifiez ce qui est AUTORIS√â, car tout est REFUS√â par d√©faut.**

## **√ânum√©ration de RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Abus des r√¥les/ClusterRoles pour l'escalade de privil√®ges

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
