# Controllo degli accessi basato sui ruoli di Kubernetes (RBAC)

{% hint style="success" %}
Impara e pratica l'hacking su AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Controllo degli accessi basato sui ruoli (RBAC)

Kubernetes ha un **modulo di autorizzazione chiamato Controllo degli Accessi Basato sui Ruoli** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) che aiuta a impostare le autorizzazioni di utilizzo per il server API.

Il modello di autorizzazione di RBAC √® composto da **tre parti individuali**:

1. **Ruolo/Ruolo di Cluster ‚Äì** La vera autorizzazione. Contiene _**regole**_ che rappresentano un insieme di autorizzazioni. Ogni regola contiene [risorse](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) e [verbi](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). Il verbo √® l'azione che verr√† applicata alla risorsa.
2. **Soggetto (Utente, Gruppo o ServiceAccount) ‚Äì** L'oggetto che ricever√† le autorizzazioni.
3. **RoleBinding/ClusterRoleBinding ‚Äì** La connessione tra Ruolo/Ruolo di Cluster e il soggetto.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

La differenza tra "**Ruoli**" e "**Ruoli di Cluster**" sta solo nel luogo in cui il ruolo verr√† applicato ‚Äì un "**Ruolo**" conceder√† l'accesso a **un solo** **namespace** **specifico**, mentre un "**Ruolo di Cluster**" pu√≤ essere utilizzato in **tutti i namespace** nel cluster. Inoltre, i **Ruoli di Cluster** possono anche concedere accesso a:

* risorse a livello di cluster (come i nodi).
* endpoint non relativi alle risorse (come /healthz).
* risorse a livello di namespace (come i Pod), **in tutti i namespace**.

A partire da **Kubernetes** 1.6, le **politiche RBAC** sono **abilitate per impostazione predefinita**. Ma per abilitare RBAC puoi utilizzare qualcosa del genere:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Modelli

Nel modello di un **Ruolo** o di un **ClusterRole** sar√† necessario indicare il **nome del ruolo**, lo **spazio dei nomi** (nei ruoli) e quindi gli **apiGroups**, le **risorse** e i **verbi** del ruolo:

- Gli **apiGroups** sono un array che contiene i diversi **spazi dei nomi API** a cui si applica questa regola. Ad esempio, una definizione di Pod utilizza apiVersion: v1. _Pu√≤ avere valori come rbac.authorization.k8s.io o \[\*]_.
- Le **risorse** sono un array che definisce **a quali risorse si applica questa regola**. Puoi trovare tutte le risorse con: `kubectl api-resources --namespaced=true`
- I **verbi** sono un array che contiene i **verbi consentiti**. Il verbo in Kubernetes definisce il **tipo di azione** che devi applicare alla risorsa. Ad esempio, il verbo di elenco viene utilizzato contro le raccolte mentre "get" viene utilizzato contro una singola risorsa.

### Verbi delle Regole

(_Questa informazione √® stata presa da_ [_**i documenti**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| Verbo HTTP | verbo della richiesta                                                                                                                                         |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST       | create                                                                                                                                                        |
| GET, HEAD  | get (per risorse individuali), list (per raccolte, inclusi i contenuti completi degli oggetti), watch (per osservare una risorsa individuale o una raccolta di risorse) |
| PUT        | update                                                                                                                                                        |
| PATCH      | patch                                                                                                                                                         |
| DELETE     | delete (per risorse individuali), deletecollection (per raccolte)                                                                                             |

A volte Kubernetes controlla l'autorizzazione per autorizzazioni aggiuntive utilizzando verbi specializzati. Ad esempio:

- [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
- verbo `use` su risorse `podsecuritypolicies` nel gruppo API `policy`.
- [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
- verbi `bind` e `escalate` su risorse `roles` e `clusterroles` nel gruppo API `rbac.authorization.k8s.io`.
- [Autenticazione](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
- verbo `impersonate` su `users`, `groups` e `serviceaccounts` nel gruppo API principale, e gli `userextras` nel gruppo API `authentication.k8s.io`.

{% hint style="warning" %}
Puoi trovare **tutti i verbi supportati da ciascuna risorsa** eseguendo `kubectl api-resources --sort-by name -o wide`
{% endhint %}

### Esempi

{% code title="Ruolo" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Ad esempio, puoi utilizzare un **ClusterRole** per consentire a un utente specifico di eseguire:
```
kubectl get pods --all-namespaces
```
### **RoleBinding e ClusterRoleBinding**

**[Dalla documentazione:](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding)** Un **role binding concede le autorizzazioni definite in un ruolo a un utente o a un insieme di utenti**. Contiene un elenco di soggetti (utenti, gruppi o account di servizio) e un riferimento al ruolo concesso. Un **RoleBinding** concede autorizzazioni all'interno di uno specifico **namespace** mentre un **ClusterRoleBinding** concede quell'accesso a livello di **cluster**.

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**Le autorizzazioni sono additive** quindi se hai un clusterRole con "list" e "delete" segreti puoi aggiungerlo con un Role con "get". Quindi fai attenzione e testa sempre i tuoi ruoli e le autorizzazioni e **specificare cosa √® CONSENTITO, perch√© per impostazione predefinita tutto √® NEGATO.**

## **Enumerazione RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Abuso di Ruoli/ClusterRoles per l'Elevazione dei Privilegi

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
Impara e pratica l'Hacking su AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
