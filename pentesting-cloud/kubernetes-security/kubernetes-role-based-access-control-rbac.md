# Kubernetes Rol Tabanlı Erişim Kontrolü (RBAC)

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## Rol Tabanlı Erişim Kontrolü (RBAC)

Kubernetes'in **Rol Tabanlı Erişim Kontrolü** adında bir **yetkilendirme modülü** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) vardır ve API sunucusuna kullanım izinleri belirlemeye yardımcı olur.

RBAC'nin izin modeli **üç ayrı parçadan** oluşur:

1. **Rol\ClusterRole –** Gerçek izin. Bir dizi izni temsil eden _**kurallar**_ içerir. Her kural [kaynakları](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) ve [fiilleri](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb) içerir. Fiil, kaynağa uygulanacak eylemdir.
2. **Konu (Kullanıcı, Grup veya ServiceAccount) –** İzinleri alacak nesne.
3. **RoleBinding\ClusterRoleBinding –** Rol\ClusterRole ile konu arasındaki bağlantı.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

“**Roller**” ile “**ClusterRoller**” arasındaki fark, rolün uygulanacağı yerdir - bir “**Rol**” yalnızca **bir** **belirli** **ad alanına** erişim sağlayacaktır, ancak “**ClusterRole**” tüm ad alanlarında kullanılabilir. Dahası, **ClusterRoller** ayrıca şunlara erişim sağlayabilir:

* **küme kapsamlı** kaynaklar (örneğin düğümler).
* **kaynak olmayan** uç noktalar (/healthz gibi).
* ad alanına özgü kaynaklar (örneğin Pod'lar), **tüm ad alanları** boyunca.

**Kubernetes** 1.6'dan itibaren **RBAC** politikaları **varsayılan olarak etkindir**. Ancak RBAC'yi etkinleştirmek için şuna benzer bir şey kullanabilirsiniz:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Şablonlar

Bir **Rol** veya **ClusterRole** şablonunda **rolün adını**, **ad alanını** (rollerde) ve ardından rolün **apiGroups**, **kaynaklar** ve **fiillerini** belirtmeniz gerekecektir:

- **apiGroups**, bu kuralın uygulandığı farklı **API ad alanlarını** içeren bir dizi içerir. Örneğin, bir Pod tanımı apiVersion: v1 kullanır. _Değerler rbac.authorization.k8s.io veya \[\*] olabilir_.
- **kaynaklar**, bu kuralın uygulandığı **hangi kaynakları** tanımlayan bir dizi içerir. Tüm kaynakları şu komutla bulabilirsiniz: `kubectl api-resources --namespaced=true`
- **fiiller**, **izin verilen fiilleri** içeren bir dizi içerir. Kubernetes'te fiil, kaynağa uygulamanız gereken **eylem türünü** tanımlar. Örneğin, list fiili koleksiyonlara karşı kullanılırken "get" tek bir kaynağa karşı kullanılır.

### Kuralların Fiilleri

(_Bu bilgi_ [_**belgelerden alınmıştır**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| HTTP fiili | istek fiili                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get (bireysel kaynaklar için), list (koleksiyonlar için, tam nesne içeriği dahil), watch (bireysel kaynağı veya kaynak koleksiyonunu izlemek için) |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete (bireysel kaynaklar için), deletecollection (koleksiyonlar için)                                                                                         |

Kubernetes bazen özel fiiller kullanarak ek izinler için yetkilendirme kontrolü yapar. Örneğin:

- [Pod Güvenlik Politikası](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
- `policy` API grubundaki `podsecuritypolicies` kaynaklarında `use` fiili.
- [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
- `rbac.authorization.k8s.io` API grubundaki `roles` ve `clusterroles` kaynaklarında `bind` ve `escalate` fiilleri.
- [Kimlik Doğrulama](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
- `authentication.k8s.io` API grubundaki `users`, `groups` ve `serviceaccounts` üzerinde `impersonate` fiili ve `authentication.k8s.io` API grubundaki `userextras`.

{% hint style="warning" %}
Her kaynağın desteklediği **tüm fiilleri** bulabilirsiniz `kubectl api-resources --sort-by name -o wide` komutunu çalıştırarak
{% endhint %}

### Örnekler

{% code title="Rol" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %} 

## Küme Rolü
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Örneğin, belirli bir kullanıcının şunu çalıştırmasına izin vermek için bir **ClusterRole** kullanabilirsiniz:
```
kubectl get pods --all-namespaces
```
### **RoleBinding ve ClusterRoleBinding**

**[Dokümandan:](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding)** Bir **role binding, bir role'de tanımlanan izinleri bir kullanıcıya veya kullanıcı grubuna verir**. Bu, bir liste konuları (kullanıcılar, gruplar veya servis hesapları) ve verilen role referansı içerir. Bir **RoleBinding**, belirli bir **namespace** içinde izinler verirken, bir **ClusterRoleBinding** bu erişimi **küme genelinde** verir.

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %} 

---

Küme Rol Bağlama

---
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**İzinler eklenir** bu yüzden "list" ve "delete" izinlerine sahip bir clusterRole'unuz varsa, bunu "get" izni olan bir Role ile ekleyebilirsiniz. Bu yüzden rollerinizi ve izinlerinizi her zaman test edin ve **NEYE İZİN VERİLDİĞİNİ belirtin, çünkü varsayılan olarak HER ŞEY REDDEDİLİR.**

## **RBAC Numaralandırma**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Yetki Yükseltme için Rol/ClusterRoles'un Kötüye Kullanımı

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
AWS Hacking'i Öğrenin ve Uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i Öğrenin ve Uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR göndererek HackTricks** ve **HackTricks Cloud** github depolarına katkıda bulunun.

</details>
{% endhint %}
