# Kubernetes ロールベースアクセス制御（RBAC）

{% hint style="success" %}
AWSハッキングの学習と練習：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、ハッキングトリックを共有してください。

</details>
{% endhint %}

## ロールベースアクセス制御（RBAC）

Kubernetesには、APIサーバーへの利用権限を設定するのに役立つ**ロールベースアクセス制御（RBAC）**という**認可モジュール**があります。

RBACの権限モデルは**3つの個々の部分**から構築されています：

1. **Role\ClusterRole** – 実際の権限。一連の権限を表す**ルール**が含まれています。各ルールには[リソース](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types)と[動詞](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb)が含まれています。動詞はリソースに適用されるアクションです。
2. **Subject（ユーザー、グループ、またはServiceAccount）** – 権限を受け取るオブジェクト。
3. **RoleBinding\ClusterRoleBinding** – Role\ClusterRoleとSubjectの接続。

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

「**Roles**」と「**ClusterRoles**」の違いは、ロールが適用される場所だけです – 「**Role**」は**1つの特定のネームスペース**へのアクセスを許可しますが、「**ClusterRole**」はクラスター内の**すべてのネームスペース**で使用できます。さらに、**ClusterRoles**は以下にアクセスを許可することもできます：

* **クラスタースコープ**のリソース（ノードなど）。
* **非リソース**エンドポイント（/healthzなど）。
* ネームスペースリソース（Podなど）、**すべてのネームスペース**をまたいで。

**Kubernetes** 1.6以降、**RBAC**ポリシーは**デフォルトで有効**になっています。ただし、RBACを有効にするには次のようなものを使用できます：
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## テンプレート

**Role**または**ClusterRole**のテンプレートでは、**ロールの名前**、**名前空間**（ロールの場合）、そしてロールの**apiGroups**、**リソース**、**動詞**を指定する必要があります：

- **apiGroups**は、このルールが適用される**API名前空間**を含む配列です。例えば、Podの定義はapiVersion: v1を使用します。_rbac.authorization.k8s.ioや\[\*]などの値を持つことができます_。
- **resources**は、このルールが適用される**リソース**を定義する配列です。すべてのリソースは次のコマンドで見つけることができます：`kubectl api-resources --namespaced=true`
- **verbs**は、**許可された動詞**を含む配列です。Kubernetesの動詞は、リソースに適用する**アクションの種類**を定義します。例えば、list動詞はコレクションに対して使用され、"get"は単一のリソースに対して使用されます。

### ルールの動詞

(_この情報は_ [_**ドキュメント**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb) _から取得されました_)

| HTTP動詞 | リクエスト動詞                                                                                                                                                |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get（個々のリソース用）、list（コレクション用、完全なオブジェクトコンテンツを含む）、watch（個々のリソースまたはリソースコレクションを監視するため） |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete（個々のリソース用）、deletecollection（コレクション用）                                                                                                 |

Kubernetesは、専門の動詞を使用して追加の権限の認可をチェックすることがあります。例：

- [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
- `policy` APIグループ内の`podsecuritypolicies`リソースで`use`動詞を使用します。
- [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
- `rbac.authorization.k8s.io` APIグループ内の`roles`および`clusterroles`リソースで`bind`および`escalate`動詞を使用します。
- [Authentication](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
- `core` APIグループ内の`users`、`groups`、`serviceaccounts`および`authentication.k8s.io` APIグループ内の`userextras`で`impersonate`動詞を使用します。

{% hint style="warning" %}
各リソースがサポートする**すべての動詞を見つける**には、`kubectl api-resources --sort-by name -o wide`を実行できます。
{% endhint %}

### 例

{% code title="Role" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

たとえば、特定のユーザーが実行するのを許可するために **ClusterRole** を使用できます：
```
kubectl get pods --all-namespaces
```
### **RoleBindingとClusterRoleBinding**

**[ドキュメントから：](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding)** **RoleBindingは、ユーザーまたはユーザーのセットに定義された権限を付与します**。それはサブジェクト（ユーザー、グループ、またはサービスアカウント）のリストと、付与される役割への参照を保持します。**RoleBinding**は特定の**名前空間**内で権限を付与し、**ClusterRoleBinding**はそのアクセスを**クラスタ全体**に付与します。

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**アクセス許可は追加されます**ので、"list"と"delete"のシークレットを持つclusterRoleがある場合、それを"get"を持つRoleと組み合わせることができます。したがって、常に役割とアクセス許可をテストし、**何が許可されているかを明確に指定してください。なぜなら、デフォルトではすべてが拒否されているからです。**

## **RBACの列挙**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### 特権昇格のための役割/ClusterRolesの乱用

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
AWSハッキングの学習と実践:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と実践: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**購読プラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出してハッキングテクニックを共有してください。

</details>
{% endhint %}
