# Kontrola pristupa zasnovana na ulozi u Kubernetesu (RBAC)

{% hint style="success" %}
Nauƒçite i ve≈æbajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nauƒçite i ve≈æbajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Kontrola pristupa zasnovana na ulozi (RBAC)

Kubernetes ima **modul autorizacije nazvan Kontrola pristupa zasnovana na ulozi** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) koji poma≈æe u postavljanju dozvola za kori≈°ƒáenje API servera.

RBAC-ov model dozvola se sastoji od **tri pojedinaƒçna dela**:

1. **Uloga/ClusterUloga ¬≠‚Äì** Stvarna dozvola. Sadr≈æi _**pravila**_ koja predstavljaju skup dozvola. Svako pravilo sadr≈æi [resurse](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) i [glagole](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). Glagol je akcija koja ƒáe se primeniti na resurs.
2. **Predmet (Korisnik, Grupa ili ServiceAccount) ‚Äì** Objekat koji ƒáe dobiti dozvole.
3. **RoleBinding/ClusterRoleBinding ‚Äì** Veza izmeƒëu Uloge/ClusterUloge i predmeta.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

Razlika izmeƒëu "**Uloga**" i "**ClusterUloga**" je samo gde ƒáe se uloga primeniti ‚Äì "Uloga" ƒáe omoguƒáiti pristup samo **jednom** **specifiƒçnom** **namespace-u**, dok se "ClusterUloga" mo≈æe koristiti u **svim namespace-ima** u klasteru. Osim toga, **ClusterUloge** takoƒëe mogu omoguƒáiti pristup:

* **resursima na nivou klastera** (kao ≈°to su ƒçvorovi).
* **non-resource** endpoint-ima (kao ≈°to je /healthz).
* resursima u namespace-u (kao ≈°to su Podovi), **u svim namespace-ima**.

Od **Kubernetesa** verzije 1.6 nadalje, **RBAC** politike su **podrazumevano omoguƒáene**. Ali da biste omoguƒáili RBAC, mo≈æete koristiti ne≈°to sliƒçno:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## ≈†abloni

U ≈°ablonu **Uloge** ili **ClusterRole**-a moraƒáete navesti **ime uloge**, **prostor imena** (u ulogama), a zatim **apiGroups**, **resurse** i **glagole** uloge:

- **apiGroups** je niz koji sadr≈æi razliƒçite **API prostore imena** na koje se ova pravila odnose. Na primer, definicija Pod-a koristi apiVersion: v1. _Mo≈æe imati vrednosti poput rbac.authorization.k8s.io ili \[\*]_.
- **resursi** je niz koji defini≈°e **na koje resurse se odnose ova pravila**. Sve resurse mo≈æete pronaƒái sa: `kubectl api-resources --namespaced=true`
- **glagoli** je niz koji sadr≈æi **dozvoljene glagole**. Glagol u Kubernetes-u defini≈°e **vrstu radnje** koju treba primeniti na resurs. Na primer, glagol list se koristi protiv kolekcija dok se "get" koristi protiv pojedinaƒçnog resursa.

### Glagoli pravila

(_Ove informacije su preuzete sa_ [_**dokumentacije**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| HTTP glagol | glagol zahteva                                                                                                                                                |
| ----------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST        | create                                                                                                                                                        |
| GET, HEAD   | get (za pojedinaƒçne resurse), list (za kolekcije, ukljuƒçujuƒái pun sadr≈æaj objekta), watch (za praƒáenje pojedinaƒçnog resursa ili kolekcije resursa)           |
| PUT         | update                                                                                                                                                        |
| PATCH       | patch                                                                                                                                                         |
| DELETE      | delete (za pojedinaƒçne resurse), deletecollection (za kolekcije)                                                                                               |

Ponekad Kubernetes proverava autorizaciju za dodatne dozvole koristeƒái specijalizovane glagole. Na primer:

- [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
- glagol `use` na resursima `podsecuritypolicies` u grupi API-ja `policy`.
- [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
- glagoli `bind` i `escalate` na resursima `roles` i `clusterroles` u grupi API-ja `rbac.authorization.k8s.io`.
- [Autentikacija](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
- glagol `impersonate` na `korisnicima`, `grupama` i `serviceaccounts` u osnovnoj grupi API-ja, i `userextras` u grupi API-ja `authentication.k8s.io`.

{% hint style="warning" %}
Mo≈æete pronaƒái **sve glagole koje podr≈æava svaki resurs** izvr≈°avanjem `kubectl api-resources --sort-by name -o wide`
{% endhint %}

### Primeri

{% code title="Uloga" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Na primer, mo≈æete koristiti **ClusterRole** da biste omoguƒáili odreƒëenom korisniku da pokrene:
```
kubectl get pods --all-namespaces
```
### **RoleBinding –∏ ClusterRoleBinding**

**[–ò–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—ò–µ:](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding)** **RoleBinding** dodeljuje dozvole definisane u ulozi korisniku ili setu korisnika. On sadr≈æi listu subjekata (korisnici, grupe ili servisni nalozi) i referencu na dodeljenu ulogu. **RoleBinding** dodeljuje dozvole unutar odreƒëenog **namespace-a**, dok **ClusterRoleBinding** dodeljuje pristup na nivou **klastera**.

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**Dozvole su aditivne** pa ako imate clusterRole sa "list" i "delete" tajnama, mo≈æete ga dodati sa Role sa "get". Zato budite oprezni i uvek testirajte svoje uloge i dozvole i **navedite ≈°ta je DOZVOLJENO, jer je sve podrazumevano ZABRANJENO.**

## **Enumeracija RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Zloupotreba uloga/ClusterRoles za eskalaciju privilegija

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[zloupotreba-uloga-clusterroles-u-kubernetesu](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
Nauƒçite i ve≈æbajte hakovanje AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Obuka AWS Crveni Tim Ekspert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nauƒçite i ve≈æbajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Obuka GCP Crveni Tim Ekspert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
