# Udhibiti wa Upatikanaji kulingana na Majukumu ya Kubernetes (RBAC)

{% hint style="success" %}
Jifunze na zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>unga mkono HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Udhibiti wa Upatikanaji kulingana na Majukumu (RBAC)

Kubernetes ina **moduli ya idhini inayoitwa Udhibiti wa Upatikanaji kulingana na Majukumu** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) ambayo husaidia kuweka ruhusa za matumizi kwa seva ya API.

Modeli ya ruhusa ya RBAC imejengwa kutoka kwa **sehemu tatu tofauti**:

1. **Jukumu/Jukumu la Kikundi -** Ruhusa halisi. Ina _**mipangilio**_ inayowakilisha seti ya ruhusa. Kila maelekezo yanajumuisha [rasilimali](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) na [vitendo](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). Kitendo ni hatua itakayotekelezwa kwenye rasilimali.
2. **Mada (Mtumiaji, Kikundi au Akaunti ya Huduma) -** Kitu ambacho kitapokea ruhusa.
3. **Kufunga Jukumu/Jukumu la Kikundi -** Uunganisho kati ya Jukumu/Jukumu la Kikundi na mada.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

Tofauti kati ya "**Jukumu**" na "**Jukumu la Kikundi**" ni mahali tu ambapo jukumu litatumika - "Jukumu" litatoa upatikanaji kwa **eneo moja tu la kipekee**, wakati "Jukumu la Kikundi" linaweza kutumika katika **eneo zote** katika kikundi. Zaidi ya hayo, **Jukumu la Kikundi** pia linaweza kutoa upatikanaji kwa:

* rasilimali za **kikundi-eneo** (kama vile nodi).
* vituo vya **bila-rasilimali** (kama vile /healthz).
* rasilimali za eneo (kama vile Pods), **katika maeneo yote**.

Kuanzia **Kubernetes** 1.6 na kuendelea, sera za **RBAC** zime **wezeshwa kwa chaguo-msingi**. Lakini ili kuwezesha RBAC unaweza kutumia kitu kama:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Vielelezo

Katika kigezo cha **Jukumu** au **Jukumu la Kikundi cha Kiklaster** utahitaji kuonyesha **jina la jukumu**, **eneo** (katika majukumu) na kisha **apiGroups**, **rasilimali** na **maneno** ya jukumu:

- **apiGroups** ni safu inayojumuisha **nafasi za API** tofauti ambazo sheria hii inatumika. Kwa mfano, ufafanuzi wa Pod hutumia apiVersion: v1. _Inaweza kuwa na thamani kama rbac.authorization.k8s.io au \[\*]_.
- **Rasilimali** ni safu inayoelezea **ni rasilimali zipi sheria hii inatumika**. Unaweza kupata rasilimali zote kwa: `kubectl api-resources --namespaced=true`
- **Maneno** ni safu inayojumuisha **maneno yanayoruhusiwa**. Kitenzi katika Kubernetes hufafanua **aina ya hatua** unayohitaji kutumia kwa rasilimali. Kwa mfano, kitenzi cha orodha hutumiwa dhidi ya makusanyo wakati "pata" hutumiwa dhidi ya rasilimali moja.

### Maneno ya Sheria

(_Maelezo haya yalichukuliwa kutoka_ [_**nyaraka**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| Kitenzi cha HTTP | kitenzi cha ombi                                                                                                                                             |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST           | umba                                                                                                                                                        |
| GET, HEAD      | pata (kwa rasilimali binafsi), orodhesha (kwa makusanyo, ikiwa ni pamoja na maudhui kamili ya kitu), angalia (kwa kufuatilia rasilimali binafsi au mkusanyo wa rasilimali) |
| WEKA           | sasisha                                                                                                                                                     |
| KITAMBUA       | kipande                                                                                                                                                     |
| ONDOA          | futa (kwa rasilimali binafsi), futa mkusanyo (kwa makusanyo)                                                                                                   |

Kubernetes mara nyingine hufanya uhakiki wa idhini kwa ruhusa za ziada kwa kutumia maneno maalum. Kwa mfano:

- [Sera ya Usalama wa Pod](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
- kitenzi cha `tumia` kwenye rasilimali za `podsecuritypolicies` katika kikundi cha API cha `sera`.
- [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
- maneno ya `unganisha` na `kukuza` kwenye rasilimali za `majukumu` na `majukumu ya kikundi` katika kikundi cha API cha `rbac.authorization.k8s.io`.
- [Uthibitishaji](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
- kitenzi cha `jitambulishe` kwenye `watumiaji`, `makundi`, na `akaunti za huduma` katika kikundi cha API cha msingi, na `userextras` katika kikundi cha API cha `authentication.k8s.io`.

{% hint style="warning" %}
Unaweza kupata **maneno yote ambayo kila rasilimali inasaidia** kwa kutekeleza `kubectl api-resources --sort-by name -o wide`
{% endhint %}

### Mifano

{% code title="Jukumu" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="Jukumu la Kikundi cha Kikundi" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Kwa mfano, unaweza kutumia **ClusterRole** kuruhusu mtumiaji fulani kuendesha:
```
kubectl get pods --all-namespaces
```
### **RoleBinding na ClusterRoleBinding**

**[Kutoka kwa nyaraka:](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding)** **RoleBinding inatoa ruhusa zilizoelezwa katika jukumu kwa mtumiaji au kikundi cha watumiaji**. Inashikilia orodha ya wahusika (watumiaji, vikundi, au akaunti za huduma), na marejeo kwa jukumu linalopewa. **RoleBinding** inatoa ruhusa ndani ya **namespace** maalum wakati **ClusterRoleBinding** inatoa ufikiaji huo **kwa kiwango cha kikundi**.

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**Ruhusa ni za kuongezeka** kwa hivyo ikiwa una jukumu la kikundi na "orodha" na "futa" siri unaweza kuiongeza na Jukumu na "pata". Kwa hivyo kuwa makini na jaribu jukumu na ruhusa zako **na eleza ni NINI KURUHUSIWA, kwa sababu kila kitu ni KUKATALIWA kwa chaguo-msingi.**

## **Kuorodhesha RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Matumizi ya Majukumu/ Majukumu ya Kikundi kwa Ajili ya Kuongeza Madaraka

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
Jifunze na zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>unga mkono HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
