# Kubernetes基于角色的访问控制（RBAC）

{% hint style="success" %}
学习并练习AWS黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks培训AWS红队专家（ARTE）**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习GCP黑客技术：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks培训GCP红队专家（GRTE）**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持HackTricks</summary>

* 检查[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享黑客技巧。**

</details>
{% endhint %}

## 基于角色的访问控制（RBAC）

Kubernetes有一个名为基于角色的访问控制（[RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)）的**授权模块**，可帮助设置对API服务器的使用权限。

RBAC的权限模型由**三个独立部分**构成：

1. **Role\ClusterRole** – 实际权限。它包含代表一组权限的**规则**。每个规则包含[资源](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types)和[动词](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb)。动词是将应用于资源的操作。
2. **Subject（用户、组或ServiceAccount）** – 将接收权限的对象。
3. **RoleBinding\ClusterRoleBinding** – Role\ClusterRole和Subject之间的连接。

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

“**Roles**”和“**ClusterRoles**”之间的区别仅在于角色将应用的位置 – “**Role**”将仅授予对**一个特定命名空间**的访问权限，而“**ClusterRole**”可用于**集群中的所有命名空间**。此外，**ClusterRoles**还可以授予对以下内容的访问权限：

* **集群范围**资源（如节点）。
* **非资源**端点（如/healthz）。
* 命名空间资源（如Pods），**跨所有命名空间**。

从**Kubernetes** 1.6开始，**RBAC**策略**默认启用**。但要启用RBAC，您可以使用类似以下内容：
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## 模板

在**Role**或**ClusterRole**的模板中，您需要指定**角色的名称**，**命名空间**（在角色中），然后是角色的**apiGroups**，**资源**和**动词**：

- **apiGroups**是一个包含此规则适用于的不同**API命名空间**的数组。例如，Pod定义使用apiVersion：v1。_它可以具有值，如rbac.authorization.k8s.io或\[\*]_。
- **资源**是一个定义**此规则适用于哪些资源**的数组。您可以使用以下命令找到所有资源：`kubectl api-resources --namespaced=true`
- **动词**是一个包含**允许的动词**的数组。Kubernetes中的动词定义了您需要对资源应用的**操作类型**。例如，list动词用于集合，而"get"用于单个资源。

### 规则动词

（_此信息摘自_ [_**文档**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb)）

| HTTP动词 | 请求动词                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get（用于单个资源），list（用于集合，包括完整对象内容），watch（用于监视单个资源或资源集合） |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete（用于单个资源），deletecollection（用于集合）                                                                                         |

有时Kubernetes使用专门的动词检查附加权限的授权。例如：

- [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
- 在`policy` API组中对`podsecuritypolicies`资源使用`use`动词。
- [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
- 在`rbac.authorization.k8s.io` API组中对`roles`和`clusterroles`资源使用`bind`和`escalate`动词。
- [Authentication](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
- 在核心API组中对`users`，`groups`和`serviceaccounts`使用`impersonate`动词，并在`authentication.k8s.io` API组中对`userextras`使用。

{% hint style="warning" %}
您可以通过执行`kubectl api-resources --sort-by name -o wide`找到**每个资源支持的所有动词**
{% endhint %}

### 示例

{% code title="Role" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

例如，您可以使用**ClusterRole**来允许特定用户运行：
```
kubectl get pods --all-namespaces
```
### **RoleBinding和ClusterRoleBinding**

**[来自文档：](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding)** 一个**role binding授予了在一个角色中定义的权限给一个用户或一组用户**。它包含了一组主体（用户、组或服务账户）以及被授予的角色的引用。**RoleBinding**在特定的**命名空间**内授予权限，而**ClusterRoleBinding**则在整个**集群范围**内授予权限。

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**权限是可累加的**，因此如果您有一个具有“list”和“delete” secrets 的 clusterRole，您可以将其与一个具有“get”的 Role 结合使用。因此，请注意并始终测试您的角色和权限，并**指定允许的操作，因为默认情况下一切都被拒绝。**

## **枚举 RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### 滥用角色/ClusterRoles 进行特权升级

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

{% hint style="success" %}
学习并实践 AWS 黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并实践 GCP 黑客技术: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 检查 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}
