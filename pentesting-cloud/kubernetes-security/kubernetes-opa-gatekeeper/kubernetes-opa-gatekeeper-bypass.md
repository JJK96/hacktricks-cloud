# Kubernetes - Bypass OPA Gatekeeper

**Originalni autor ove stranice je** [**Guillaume**](https://www.linkedin.com/in/guillaume-chapela-ab4b9a196)

## Zloupotreba loše konfiguracije

### Nabrojavanje pravila

Imati pregled može pomoći da se zna koja pravila su aktivna, u kojem režimu i ko može da ih zaobiđe.

#### Sa CLI-em
```bash
$ kubectl api-resources | grep gatekeeper
k8smandatoryannotations                                                             constraints.gatekeeper.sh/v1beta1                  false        K8sMandatoryAnnotations
k8smandatorylabels                                                                  constraints.gatekeeper.sh/v1beta1                  false        K8sMandatoryLabel
constrainttemplates                                                                 templates.gatekeeper.sh/v1                         false        ConstraintTemplate
```
**ConstraintTemplate** i **Constraint** mogu se koristiti u Open Policy Agent (OPA) Gatekeeper-u kako bi se primenila pravila na Kubernetes resurse.
```bash
$ kubectl get constrainttemplates
$ kubectl get k8smandatorylabels
```
#### Sa grafičkim korisničkim interfejsom

Grafički korisnički interfejs može biti dostupan za pristup OPA pravilima pomoću **Gatekeeper Policy Manager**-a. To je "jednostavni _samo za čitanje_ veb korisnički interfejs za pregled statusa OPA Gatekeeper pravila u Kubernetes klasteru."

<figure><img src="../../../.gitbook/assets/05-constraints.png" alt=""><figcaption></figcaption></figure>

Potražite izloženu rutu:
```bash
$ kubectl get services -A | grep gatekeeper
$ kubectl get services -A | grep 'gatekeeper-policy-manager-system'
```
### Isključeni namespace-ovi

Kao što je prikazano na slici iznad, određena pravila se ne primenjuju univerzalno na sve namespace-ove ili korisnike. Umesto toga, ona funkcionišu na osnovu bele liste. Na primer, ograničenje `liveness-probe` je isključeno iz primene na pet navedenih namespace-ova.

### Bypass

Sa sveobuhvatnim pregledom konfiguracije Gatekeeper-a, moguće je identifikovati potencijalne loše konfiguracije koje bi mogle biti iskorišćene radi sticanja privilegija. Potražite beležene ili isključene namespace-ove gde pravilo ne važi, a zatim izvršite napad na tom mestu.

{% content-ref url="../abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](../abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

## Reference

* [https://github.com/open-policy-agent/gatekeeper](https://github.com/open-policy-agent/gatekeeper)
* [https://github.com/sighupio/gatekeeper-policy-manager](https://github.com/sighupio/gatekeeper-policy-manager)
