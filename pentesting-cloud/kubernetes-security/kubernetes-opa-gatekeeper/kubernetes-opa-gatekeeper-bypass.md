# Kubernetes - OPA Gatekeeper umgehen

**Der ursprüngliche Autor dieser Seite ist** [**Guillaume**](https://www.linkedin.com/in/guillaume-c-ab4b9a196/en)

## Missbrauch von Fehlkonfiguration

### Regeln aufzählen

Ein Überblick kann dabei helfen zu wissen, welche Regeln aktiv sind, in welchem Modus und wer sie umgehen kann.

#### Mit der Befehlszeile
```bash
$ kubectl api-resources | grep gatekeeper
k8smandatoryannotations                                                             constraints.gatekeeper.sh/v1beta1                  false        K8sMandatoryAnnotations
k8smandatorylabels                                                                  constraints.gatekeeper.sh/v1beta1                  false        K8sMandatoryLabel
constrainttemplates                                                                 templates.gatekeeper.sh/v1                         false        ConstraintTemplate
```
**ConstraintTemplate** und **Constraint** können in Open Policy Agent (OPA) Gatekeeper verwendet werden, um Regeln für Kubernetes-Ressourcen durchzusetzen.
```bash
$ kubectl get constrainttemplates
$ kubectl get k8smandatorylabels
```
#### Mit der GUI

Ein grafisches Benutzeroberfläche (GUI) kann auch verfügbar sein, um auf die OPA-Regeln mit dem **Gatekeeper Policy Manager** zuzugreifen. Es handelt sich um "eine einfache _nur-Lese_ Web-Benutzeroberfläche zur Anzeige des Status von OPA Gatekeeper-Richtlinien in einem Kubernetes-Cluster."

<figure><img src="../../../.gitbook/assets/05-constraints.png" alt=""><figcaption></figcaption></figure>

Suche nach dem freigegebenen Pfad:
```bash
$ kubectl get services -A | grep gatekeeper
$ kubectl get services -A | grep 'gatekeeper-policy-manager-system'
```
### Ausgeschlossene Namespaces

Wie im obigen Bild dargestellt, werden bestimmte Regeln möglicherweise nicht universell auf alle Namespaces oder Benutzer angewendet. Stattdessen funktionieren sie auf Whitelist-Basis. Zum Beispiel ist die Einschränkung `liveness-probe` davon ausgenommen, auf die fünf angegebenen Namespaces angewendet zu werden.

### Umgehung

Mit einem umfassenden Überblick über die Gatekeeper-Konfiguration ist es möglich, potenzielle Fehlkonfigurationen zu identifizieren, die ausgenutzt werden könnten, um Privilegien zu erlangen. Suchen Sie nach whitelisted oder ausgeschlossenen Namespaces, in denen die Regel nicht gilt, und führen Sie dann dort Ihren Angriff durch.

{% content-ref url="../abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](../abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

## Referenzen

* [https://github.com/open-policy-agent/gatekeeper](https://github.com/open-policy-agent/gatekeeper)
* [https://github.com/sighupio/gatekeeper-policy-manager](https://github.com/sighupio/gatekeeper-policy-manager)
