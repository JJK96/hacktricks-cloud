# Kubernetes - OPA Gatekeeper bypass

**このページの元の著者は** [**Guillaume**](https://www.linkedin.com/in/guillaume-c-ab4b9a196/en)

## 設定ミスの乱用

### ルールの列挙

概要を把握することで、どのルールがアクティブであり、どのモードであり、誰がバイパスできるかがわかるかもしれません。

#### CLIを使用して
```bash
$ kubectl api-resources | grep gatekeeper
k8smandatoryannotations                                                             constraints.gatekeeper.sh/v1beta1                  false        K8sMandatoryAnnotations
k8smandatorylabels                                                                  constraints.gatekeeper.sh/v1beta1                  false        K8sMandatoryLabel
constrainttemplates                                                                 templates.gatekeeper.sh/v1                         false        ConstraintTemplate
```
**ConstraintTemplate**と**Constraint**は、Open Policy Agent (OPA) GatekeeperでKubernetesリソースにルールを強制するために使用できます。
```bash
$ kubectl get constrainttemplates
$ kubectl get k8smandatorylabels
```
#### GUIを使用する

**Gatekeeper Policy Manager**を使用してOPAルールにアクセスするためのグラフィカルユーザーインターフェースも利用可能です。これは、"Kubernetesクラスター内のOPA Gatekeeperポリシーのステータスを表示するためのシンプルな読み取り専用Web UI"です。

<figure><img src="../../../.gitbook/assets/05-constraints.png" alt=""><figcaption></figcaption></figure>

公開されたルートを検索します：
```bash
$ kubectl get services -A | grep gatekeeper
$ kubectl get services -A | grep 'gatekeeper-policy-manager-system'
```
### 除外された名前空間

上記の画像に示されているように、特定のルールはすべての名前空間やユーザに普遍的に適用されるわけではありません。代わりに、ホワイトリスト方式で動作します。たとえば、`liveness-probe` 制約は、指定された5つの名前空間には適用されません。

### バイパス

Gatekeeperの設定を包括的に把握することで、特権を取得するために悪用できる潜在的な誤構成を特定することが可能です。ルールが適用されないホワイトリスト化された名前空間や除外された名前空間を探し、そこで攻撃を実行してください。

{% content-ref url="../abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](../abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

## 参考文献

* [https://github.com/open-policy-agent/gatekeeper](https://github.com/open-policy-agent/gatekeeper)
* [https://github.com/sighupio/gatekeeper-policy-manager](https://github.com/sighupio/gatekeeper-policy-manager)
