# Uthibitisho na Idhini ya Kubelet

{% hint style="success" %}
Jifunze na zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}

## Uthibitisho wa Kubelet <a href="#kubelet-authentication" id="kubelet-authentication"></a>

**[Kutoka kwa nyaraka:](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)**

Kwa chaguo-msingi, maombi kwa mwisho wa HTTPS wa kubelet ambayo hayakataliwi na njia zingine za uthibitisho zilizowekwa hutambuliwa kama maombi ya kujitegemea, na kupewa **jina la mtumiaji `system:anonymous`** na **kikundi cha `system:unauthenticated`**.

Njia **3** za uthibitisho ni:

* **Kujitegemea** (chaguo-msingi): Tumia kuweka parameta **`--anonymous-auth=true` au mazingira:**
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: Hii ita **wezesha** kubectl **API bearer tokens** kama idhini (kitambulisho chochote halali kitakuwa halali). Ruhusu kwa:
* hakikisha kikundi cha API cha `authentication.k8s.io/v1beta1` kimezimishwa kwenye seva ya API
* anzisha kubelet na bendera za **`--authentication-token-webhook`** na **`--kubeconfig`** au tumia mipangilio ifuatayo:
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
Kubeleti huita **API ya TokenReview** kwenye seva ya API iliyowekwa ili **kutambua habari ya mtumiaji** kutoka kwa tokeni za bearer
{% endhint %}

* **Vyeti vya mteja vya X509:** Kuruhusu kuthibitisha kupitia vyeti vya mteja vya X509
* angalia [hati ya uthibitishaji wa apiserver](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs) kwa maelezo zaidi
* anzisha kubeleti na bendera `--client-ca-file`, ukiweka faili ya CA kuthibitisha vyeti vya mteja. Au na config:
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Uthibitishaji wa Kubelet <a href="#kubelet-authentication" id="kubelet-authentication"></a>

Ombi lolote ambalo limehakikiwa kwa mafanikio (ikiwa ni pamoja na ombi la kienyeji) **linaidhinishwa kisha**. **Hali ya idhini ya msingi** ni **`AlwaysAllow`**, ambayo **inaruhusu maombi yote**.

Walakini, thamani nyingine inayowezekana ni **`webhook`** (ambayo ndio **utakayopata zaidi**). Hali hii ita **angalia ruhusa za mtumiaji aliyeidhinishwa** kuruhusu au kukataa kitendo.

{% hint style="warning" %}
Tafadhali kumbuka kwamba hata kama **uthibitishaji wa kienyeji umewezeshwa** upatikanaji wa **kienyeji** unaweza **kutokuwa na ruhusa yoyote** ya kufanya kitendo chochote.
{% endhint %}

Uthibitishaji kupitia webhook unaweza kusanidiwa kwa kutumia **param `--authorization-mode=Webhook`** au kupitia faili ya usanidi kwa:
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
Kubelet huita API ya **`SubjectAccessReview`** kwenye seva ya API iliyowekwa ili **kutambua** ikiwa kila ombi lime **idhinishwa.**

Kubelet inaidhinisha maombi ya API kwa kutumia njia ile ile ya [vipengele vya ombi](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes) kama apiserver:

* **Kitendo**

| Muhimu ya HTTP | muhimu ya ombi                                                                                                                                                |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST           | kuunda                                                                                                                                                        |
| GET, HEAD      | pata (kwa rasilimali binafsi), orodhesha (kwa makusanyo, ikiwa ni pamoja na maudhui kamili ya kitu), angalia (kwa kufuatilia rasilimali binafsi au mkusanyiko wa rasilimali) |
| WEKA           | sasisha                                                                                                                                                       |
| KITAMBUA       | kitambo                                                                                                                                                       |
| ONDOA          | ondoa (kwa rasilimali binafsi), ondoakusanyo (kwa makusanyo)                                                                                                     |

* **Rasilimali** inayozungumza na api ya Kubelet ni **daima** **nodes** na **subrasilimali** inatokana na njia ya ombi linaloingia:

| API ya Kubelet | rasilimali | subrasilimali |
| -------------- | --------- | ----------- |
| /takwimu/\*    | nodes    | takwimu       |
| /vipimo/\*  | nodes    | vipimo     |
| /mambo/\*     | nodes    | log         |
| /maelezo/\*     | nodes    | maelezo        |
| _zote nyingine_ | nodes    | proksi       |

Kwa mfano, ombi lifuatalo lilijaribu kupata habari za pods za kubelet bila idhini:
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* Tumepata **Katazwa**, hivyo ombi lime **pitisha ukaguzi wa Uthibitishaji**. Vinginevyo, tungepata ujumbe wa `Hauruhusiwi`.
* Tunaweza kuona **jina la mtumiaji** (katika kesi hii kutoka kwa ishara)
* Angalia jinsi **rasilimali** ilivyokuwa **wakala** na **rasilimali ya ziada** **proxy** (ambayo ina maana na habari iliyotangulia)

## Marejeo

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

{% hint style="success" %}
Jifunze & zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
