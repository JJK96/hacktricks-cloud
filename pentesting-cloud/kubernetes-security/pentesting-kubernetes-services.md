# Pentesting Kubernetes Dienste

{% hint style="success" %}
Leer & oefen AWS Hack: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Controleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

Kubernetes maak gebruik van verskeie **spesifieke netwerkdienste** wat jy dalk **blootgestel aan die internet** kan vind of in 'n **interne netwerk nadat jy een pod gekompromitteer het**.

## Blootgestelde pods vind met OSINT

Een manier kan wees om te soek na `Identity LIKE "k8s.%.com"` in [crt.sh](https://crt.sh) om subdomeine wat verband hou met kubernetes te vind. 'n Ander manier kan wees om te soek na `"k8s.%.com"` in github en te soek na **YAML-l√™ers** wat die string bevat.

## Hoe Kubernetes Dienste Blootstel

Dit kan nuttig wees vir jou om te verstaan hoe Kubernetes dienste **openlik blootstel** sodat jy hulle kan vind:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Blootgestelde pods vind deur poortskandering

Die volgende poorte mag oop wees in 'n Kubernetes-kluster:

| Poort           | Proses         | Beskrywing                                                             |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API-poort                                                   |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Kontainermetriek                                                      |
| 6443/TCP        | kube-apiserver | Kubernetes API-poort                                                   |
| 8443/TCP        | kube-apiserver | Minikube API-poort                                                     |
| 8080/TCP        | kube-apiserver | Onveilige API-poort                                                    |
| 10250/TCP       | kubelet        | HTTPS API wat volle toegang toelaat                                    |
| 10255/TCP       | kubelet        | Ongeagtelike lees-slegs HTTP-poort: pods, lopende pods en nodestatus   |
| 10256/TCP       | kube-proxy     | Kube Proxy gesondheidskontroleserver                                   |
| 9099/TCP        | calico-felix   | Gesondheidskontroleserver vir Calico                                  |
| 6782-4/TCP      | weave          | Metriek en eindpunte                                                   |
| 30000-32767/TCP | NodePort       | Proksi na die dienste                                                  |
| 44134/TCP       | Tiller         | Helm-diens wat luister                                                 |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Dit is die **API Kubernetes-diens** waarmee die administrateurs gewoonlik kommunikeer met die hulpmiddel **`kubectl`**.

**Gewone poorte: 6443 en 443**, maar ook 8443 in minikube en 8080 as onveilig.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Kyk na die volgende bladsy om te leer hoe om sensitiewe data te verkry en sensitiewe aksies uit te voer deur met hierdie diens te praat:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Hierdie diens **hardloop op elke node van die groep**. Dit is die diens wat die peule binne die **node** sal **beheer**. Dit kommunikeer met die **kube-apiserver**.

As jy hierdie diens blootgestel vind, het jy moontlik 'n **ongeagte RCE** gevind.

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Indien die antwoord `Onbevoegd` is, vereis dit verifikasie.

As jy nodusse kan lys, kan jy 'n lys van kubelet-eindpunte kry met:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Slegs lees)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```
helm --host tiller-deploy.kube-system:44134 version
```
Jy kan hierdie diens misbruik om voorregte binne Kubernetes te eskaleer:

### cAdvisor

Diens nuttig om metriek in te samel.
```
curl -k https://<IP Address>:4194
```
### NodePort

Wanneer 'n poort blootgestel word in al die nodes via 'n **NodePort**, word dieselfde poort oopgemaak in al die nodes wat die verkeer na die verklaarde **Diens** proksifiseer. Standaard sal hierdie poort in die **reeks 30000-32767** wees. Dus kan nuwe ongekontroleerde dienste toeganklik wees deur daardie poorte.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Kwesbare Verkeerde Konfigurasies

### Kube-apiserver Anonieme Toegang

Anonieme toegang tot **kube-apiserver API-eindpunte is nie toegelaat** nie. Maar jy kan sekere eindpunte nagaan:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Nagaan vir ETCD Anonieme Toegang**

Die ETCD stoor die groep geheime, konfigurasie l√™ers en meer **sensitiewe data**. Standaard kan die ETCD **nie** anoniem benader word nie, maar dit is altyd goed om te kontroleer.

As die ETCD anoniem benader kan word, mag jy nodig h√™ om die [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **werktuig** te **gebruik**. Die volgende bevel sal al die gestoorde sleutels kry:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

Die [**Kubelet-dokumentasie**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) verduidelik dat **standaard anonieme toegang** tot die diens **toegelaat word:**

> Maak anonieme versoek aan die Kubelet-bediener moontlik. Versoeke wat nie deur 'n ander verifikasiemetode verwerp word nie, word as anonieme versoek behandel. Anonieme versoek het 'n gebruikersnaam van `system:anonymous`, en 'n groepnaam van `system:unauthenticated`

Om beter te verstaan hoe die **verifikasie en magtiging van die Kubelet API werk**, kyk na hierdie bladsy:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

Die **Kubelet**-diens **API is nie gedokumenteer nie**, maar die bronkode kan hier gevind word en om die blootgestelde eindpunte te vind is so maklik as **om uit te voer**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
### /pods

Hierdie eindpunt lys bokse en hul houers:
```bash
kubeletctl pods
```
#### /exec

Hierdie eindpunt maak dit baie maklik om kode binne enige houer uit te voer:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Om hierdie aanval te voorkom, moet die _**kubelet**_ diens uitgevoer word met `--anonymous-auth false` en die diens moet op netwerkvlak geskei word.
{% endhint %}

### **Kubelet (Slegs leespoort) Inligting Blootstelling Kontroleer**

Wanneer 'n **kubelet slegs leespoort** blootgestel word, word dit moontlik vir ongemagtigde partye om inligting van die API te onttrek. Die blootstelling van hierdie poort kan lei tot die bekendmaking van verskeie **klusterkonfigurasie-elemente**. Alhoewel die inligting, insluitend **pod name, plekke van interne l√™ers, en ander konfigurasies**, nie krities hoef te wees nie, stel sy blootstelling steeds 'n sekuriteitsrisiko en moet vermy word.

'n Voorbeeld van hoe hierdie kwesbaarheid uitgebuit kan word, behels 'n afgele√´ aanvaller wat toegang verkry tot 'n spesifieke URL. Deur te navigeer na `http://<eksterne-IP>:10255/pods`, kan die aanvaller potensieel sensitiewe inligting van die kubelet onttrek:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Verwysings

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
Leer & oefen AWS Hack:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
