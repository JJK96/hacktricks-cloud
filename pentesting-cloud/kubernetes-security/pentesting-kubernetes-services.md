# Test d'intrusion des services Kubernetes

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

Kubernetes utilise plusieurs **services r√©seau sp√©cifiques** que vous pourriez trouver **expos√©s sur Internet** ou dans un **r√©seau interne une fois que vous avez compromis un pod**.

## Recherche de pods expos√©s avec OSINT

Une m√©thode pourrait consister √† rechercher `Identity LIKE "k8s.%.com"` dans [crt.sh](https://crt.sh) pour trouver des sous-domaines li√©s √† Kubernetes. Une autre m√©thode pourrait consister √† rechercher `"k8s.%.com"` sur GitHub et √† rechercher des fichiers **YAML** contenant la cha√Æne.

## Comment Kubernetes expose les services

Il pourrait √™tre utile pour vous de comprendre comment Kubernetes peut **exposer des services publiquement** afin de les trouver :

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Recherche de pods expos√©s via un balayage de ports

Les ports suivants pourraient √™tre ouverts dans un cluster Kubernetes :

| Port            | Processus       | Description                                                            |
| --------------- | --------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver  | Port de l'API Kubernetes                                                |
| 2379/TCP        | etcd            |                                                                        |
| 6666/TCP        | etcd            | etcd                                                                   |
| 4194/TCP        | cAdvisor        | M√©triques des conteneurs                                               |
| 6443/TCP        | kube-apiserver  | Port de l'API Kubernetes                                                |
| 8443/TCP        | kube-apiserver  | Port de l'API Minikube                                                  |
| 8080/TCP        | kube-apiserver  | Port API non s√©curis√©                                                  |
| 10250/TCP       | kubelet         | API HTTPS permettant un acc√®s complet en mode complet                  |
| 10255/TCP       | kubelet         | Port HTTP en lecture seule non authentifi√© : pods, pods en cours d'ex√©cution et √©tat du n≈ìud |
| 10256/TCP       | kube-proxy      | Serveur de v√©rification de l'√©tat de sant√© de Kube Proxy               |
| 9099/TCP        | calico-felix    | Serveur de v√©rification de l'√©tat de sant√© pour Calico                 |
| 6782-4/TCP      | weave           | M√©triques et points de terminaison                                     |
| 30000-32767/TCP | NodePort        | Proxy vers les services                                                |
| 44134/TCP       | Tiller          | Service Helm en √©coute                                                 |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

C'est le service **API Kubernetes** avec lequel les administrateurs communiquent g√©n√©ralement en utilisant l'outil **`kubectl`**.

**Ports courants : 6443 et 443**, mais aussi 8443 dans minikube et 8080 en mode non s√©curis√©.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Consultez la page suivante pour apprendre comment obtenir des donn√©es sensibles et effectuer des actions sensibles en parlant √† ce service :**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### API Kubelet

Ce service **s'ex√©cute sur chaque n≈ìud du cluster**. C'est le service qui **contr√¥lera** les pods √† l'int√©rieur du **n≈ìud**. Il communique avec le **kube-apiserver**.

Si vous trouvez ce service expos√©, vous pourriez avoir d√©couvert une **RCE non authentifi√©e**.

#### API Kubelet
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Si la r√©ponse est `Unauthorized`, alors une authentification est requise.

Si vous pouvez r√©pertorier les n≈ìuds, vous pouvez obtenir une liste des points de terminaison des kubelets avec :
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Lecture seule)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### API etcd
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```
helm --host tiller-deploy.kube-system:44134 version
```
Vous pourriez abuser de ce service pour escalader les privil√®ges √† l'int√©rieur de Kubernetes :

### cAdvisor

Service utile pour collecter des m√©triques.
```
curl -k https://<IP Address>:4194
```
### NodePort

Lorsqu'un port est expos√© dans tous les n≈ìuds via un **NodePort**, le m√™me port est ouvert dans tous les n≈ìuds pour acheminer le trafic vers le **Service** d√©clar√©. Par d√©faut, ce port sera dans la **plage 30000-32767**. Ainsi, de nouveaux services non v√©rifi√©s pourraient √™tre accessibles via ces ports.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Vuln√©rabilit√©s de configuration incorrecte

### Acc√®s anonyme √† Kube-apiserver

L'acc√®s anonyme aux points d'API de **kube-apiserver n'est pas autoris√©**. Mais vous pouvez v√©rifier certains points d'acc√®s :

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **V√©rification de l'acc√®s anonyme √† ETCD**

ETCD stocke les secrets du cluster, les fichiers de configuration et d'autres donn√©es **sensibles**. Par **d√©faut**, l'ETCD **ne peut pas** √™tre acc√©d√© **anonymement**, mais il est toujours bon de v√©rifier.

Si l'ETCD peut √™tre acc√©d√© de mani√®re anonyme, vous devrez peut-√™tre **utiliser l'outil** [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). La commande suivante r√©cup√©rera toutes les cl√©s stock√©es :
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

La [**documentation de Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) explique que par **d√©faut l'acc√®s anonyme** au service est **autoris√©:**

> Active les requ√™tes anonymes vers le serveur Kubelet. Les requ√™tes qui ne sont pas rejet√©es par un autre m√©thode d'authentification sont trait√©es comme des requ√™tes anonymes. Les requ√™tes anonymes ont un nom d'utilisateur `system:anonymous`, et un nom de groupe `system:unauthenticated`

Pour mieux comprendre comment **l'authentification et l'autorisation de l'API Kubelet** fonctionnent, consultez cette page:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

Le **service Kubelet** **API n'est pas document√©**, mais le code source peut √™tre trouv√© ici et trouver les points de terminaison expos√©s est aussi simple que **d'ex√©cuter**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Tous semblent int√©ressants.

Vous pouvez utiliser l'outil [**Kubeletctl**](https://github.com/cyberark/kubeletctl) pour interagir avec les Kubelets et leurs points de terminaison.

#### /pods

Cet endpoint r√©pertorie les pods et leurs conteneurs :
```bash
kubeletctl pods
```
#### /exec

Cet endpoint permet d'ex√©cuter du code √† l'int√©rieur de n'importe quel conteneur tr√®s facilement :
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Pour √©viter cette attaque, le service _**kubelet**_ doit √™tre ex√©cut√© avec `--anonymous-auth false` et le service doit √™tre s√©par√© au niveau du r√©seau.
{% endhint %}

### **V√©rification de l'exposition des informations du port de lecture de Kubelet**

Lorsqu'un **port de lecture seule de kubelet** est expos√©, il devient possible de r√©cup√©rer des informations de l'API par des parties non autoris√©es. L'exposition de ce port peut entra√Æner la divulgation de divers **√©l√©ments de configuration de cluster**. Bien que les informations, y compris les **noms des pods, les emplacements des fichiers internes et autres configurations**, ne soient pas critiques, leur exposition repr√©sente tout de m√™me un risque pour la s√©curit√© et doit √™tre √©vit√©e.

Un exemple de l'exploitation de cette vuln√©rabilit√© implique un attaquant distant acc√©dant √† une URL sp√©cifique. En naviguant vers `http://<external-IP>:10255/pods`, l'attaquant peut potentiellement r√©cup√©rer des informations sensibles du kubelet :

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## R√©f√©rences

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
