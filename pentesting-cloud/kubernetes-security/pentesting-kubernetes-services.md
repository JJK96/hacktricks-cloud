# Testowanie penetracyjne usług Kubernetes

{% hint style="success" %}
Dowiedz się i ćwicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz się i ćwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel się trikami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

Kubernetes używa kilku **konkretnych usług sieciowych**, które mogą być **odsłonięte w Internecie** lub w **sieci wewnętrznej po skompromitowaniu jednego z podów**.

## Znajdowanie odsłoniętych podów za pomocą OSINT

Jednym ze sposobów może być wyszukiwanie `Identity LIKE "k8s.%.com"` w [crt.sh](https://crt.sh), aby znaleźć subdomeny związane z kubernetes. Innym sposobem może być wyszukiwanie `"k8s.%.com"` w githubie i szukanie plików **YAML** zawierających ten ciąg.

## Jak Kubernetes Odsłania Usługi

Może być dla Ciebie przydatne zrozumienie, w jaki sposób Kubernetes może **odsłaniać usługi publicznie**, aby je znaleźć:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Znajdowanie odsłoniętych podów poprzez skanowanie portów

Następujące porty mogą być otwarte w klastrze Kubernetes:

| Port            | Proces         | Opis                                                                   |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Port API Kubernetes                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Metryki kontenerów                                                     |
| 6443/TCP        | kube-apiserver | Port API Kubernetes                                                    |
| 8443/TCP        | kube-apiserver | Port API Minikube                                                      |
| 8080/TCP        | kube-apiserver | Niezabezpieczony port API                                              |
| 10250/TCP       | kubelet        | API HTTPS umożliwiające pełny dostęp                                    |
| 10255/TCP       | kubelet        | Nieuwierzytelniony port HTTP tylko do odczytu: podów, działających podów i stanu węzła |
| 10256/TCP       | kube-proxy     | Serwer sprawdzania stanu Kube Proxy                                    |
| 9099/TCP        | calico-felix   | Serwer sprawdzania stanu dla Calico                                    |
| 6782-4/TCP      | weave          | Metryki i punkty końcowe                                                |
| 30000-32767/TCP | NodePort       | Proxy do usług                                                         |
| 44134/TCP       | Tiller         | Usługa Helm nasłuchująca                                                |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

To jest **usługa API Kubernetes**, z którą zazwyczaj rozmawiają administratorzy za pomocą narzędzia **`kubectl`**.

**Typowe porty: 6443 i 443**, ale także 8443 w minikube i 8080 jako niezabezpieczony.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Sprawdź następującą stronę, aby dowiedzieć się, jak uzyskać wrażliwe dane i wykonać wrażliwe działania rozmawiając z tym usługą:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Interfejs API Kubelet

Ta usługa **działa na każdym węźle klastra**. Jest to usługa, która będzie **kontrolować** pody wewnątrz **węzła**. Komunikuje się z **kube-apiserver**.

Jeśli znajdziesz tę usługę wystawioną, możesz natrafić na **nieuwierzytelniony RCE**.

#### Interfejs API Kubelet
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Jeśli odpowiedź brzmi `Unauthorized`, oznacza to konieczność uwierzytelnienia.

Jeśli możesz wyświetlić węzły, możesz uzyskać listę punktów końcowych kubeletów za pomocą:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Tylko do odczytu)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### Interfejs API etcd
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```
helm --host tiller-deploy.kube-system:44134 version
```
Możesz wykorzystać ten serwis do eskalacji uprawnień wewnątrz Kubernetes:

### cAdvisor

Usługa przydatna do zbierania metryk.
```
curl -k https://<IP Address>:4194
```
### NodePort

Gdy port jest wystawiony we wszystkich węzłach za pomocą **NodePort**, ten sam port jest otwarty we wszystkich węzłach przekierowując ruch do zadeklarowanego **Service**. Domyślnie ten port będzie w zakresie **30000-32767**. Dlatego nowe niesprawdzone usługi mogą być dostępne za pomocą tych portów.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Wrażliwe błędy konfiguracji

### Dostęp anonimowy do kube-apiserver

Dostęp anonimowy do **punktów końcowych interfejsu API kube-apiserver nie jest dozwolony**. Jednak można sprawdzić niektóre punkty końcowe:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Sprawdzanie dostępu anonimowego do ETCD**

ETCD przechowuje tajne klucze klastra, pliki konfiguracyjne i inne **wrażliwe dane**. Domyślnie **dostęp anonimowy do ETCD jest zablokowany**, ale zawsze warto to sprawdzić.

Jeśli ETCD można uzyskać anonimowo, może być konieczne **użycie** [**narzędzia etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). Poniższe polecenie pobierze wszystkie przechowywane klucze:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **RCE Kubelet**

[Dokumentacja **Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) wyjaśnia, że domyślnie **dostęp anonimowy do usługi jest dozwolony:**

> Umożliwia anonimowe żądania do serwera **Kubelet**. Żądania, które nie są odrzucane przez inny sposób uwierzytelniania, są traktowane jako żądania anonimowe. Żądania anonimowe mają nazwę użytkownika `system:anonymous` i nazwę grupy `system:unauthenticated`.

Aby lepiej zrozumieć, jak działa **uwierzytelnianie i autoryzacja interfejsu API Kubelet**, sprawdź tę stronę:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

Usługa **Kubelet** **API nie jest udokumentowana**, ale kod źródłowy można znaleźć tutaj, a znalezienie wystawionych punktów końcowych jest tak łatwe jak **uruchomienie**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Wszystkie one brzmią interesująco.

Możesz użyć narzędzia [**Kubeletctl**](https://github.com/cyberark/kubeletctl) do interakcji z Kubeletami i ich punktami końcowymi.

#### /pods

Ten punkt końcowy wyświetla listę podów i ich kontenerów:
```bash
kubeletctl pods
```
#### /exec

Ten punkt końcowy pozwala łatwo wykonywać kod wewnątrz dowolnego kontenera:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Aby uniknąć tego ataku, usługa _**kubelet**_ powinna być uruchomiona z `--anonymous-auth false`, a usługa powinna być segregowana na poziomie sieci.
{% endhint %}

### **Sprawdzanie Wystawienia Informacji Portu Tylko do Odczytu Kubelet**

Gdy **port tylko do odczytu kubelet** jest wystawiony, istnieje możliwość pobierania informacji z interfejsu API przez nieautoryzowane strony. Wystawienie tego portu może prowadzić do ujawnienia różnych **elementów konfiguracji klastra**. Chociaż informacje, w tym **nazwy podów, lokalizacje plików wewnętrznych i inne konfiguracje**, mogą nie być krytyczne, ich ujawnienie wciąż stanowi ryzyko dla bezpieczeństwa i powinno być unikane.

Przykładem wykorzystania tej podatności jest sytuacja, w której zdalny atakujący uzyskuje dostęp do określonego adresu URL. Przechodząc do `http://<external-IP>:10255/pods`, atakujący może potencjalnie pozyskać wrażliwe informacje z kubelet:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referencje

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
Dowiedz się i ćwicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz się i ćwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostępnij sztuczki hakerskie, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
