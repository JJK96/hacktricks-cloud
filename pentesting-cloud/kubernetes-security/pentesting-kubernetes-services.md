# Pentesting Kubernetes Services

{% hint style="success" %}
Lernen Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys senden.

</details>
{% endhint %}

Kubernetes verwendet mehrere **spezifische Netzwerkdienste**, die m√∂glicherweise **im Internet freigelegt sind** oder in einem **internen Netzwerk, sobald Sie einen Pod kompromittiert haben**.

## Auffinden freigelegter Pods mit OSINT

Eine M√∂glichkeit k√∂nnte sein, nach `Identity LIKE "k8s.%.com"` in [crt.sh](https://crt.sh) zu suchen, um Subdomains im Zusammenhang mit Kubernetes zu finden. Eine andere M√∂glichkeit k√∂nnte sein, nach `"k8s.%.com"` in Github zu suchen und nach **YAML-Dateien** zu suchen, die den String enthalten.

## Wie Kubernetes Dienste freilegt

Es k√∂nnte f√ºr Sie n√ºtzlich sein zu verstehen, wie Kubernetes Dienste **√∂ffentlich freilegen** kann, um sie zu finden:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Auffinden freigelegter Pods √ºber Portscans

Die folgenden Ports k√∂nnten in einem Kubernetes-Cluster ge√∂ffnet sein:

| Port            | Prozess        | Beschreibung                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes-API-Port                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Container-Metriken                                                      |
| 6443/TCP        | kube-apiserver | Kubernetes-API-Port                                                    |
| 8443/TCP        | kube-apiserver | Minikube-API-Port                                                      |
| 8080/TCP        | kube-apiserver | Unsicherer API-Port                                                    |
| 10250/TCP       | kubelet        | HTTPS-API, die vollst√§ndigen Zugriff erm√∂glicht                         |
| 10255/TCP       | kubelet        | Nicht authentifizierter schreibgesch√ºtzter HTTP-Port: Pods, laufende Pods und Knotenzustand |
| 10256/TCP       | kube-proxy     | Kube Proxy Health Check Server                                         |
| 9099/TCP        | calico-felix   | Health Check Server f√ºr Calico                                         |
| 6782-4/TCP      | weave          | Metriken und Endpunkte                                                  |
| 30000-32767/TCP | NodePort       | Proxy zu den Diensten                                                   |
| 44134/TCP       | Tiller         | Helm-Dienst, der zuh√∂rt                                                 |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Dies ist der **API Kubernetes-Dienst**, mit dem Administratoren normalerweise mit dem Tool **`kubectl`** kommunizieren.

**G√§ngige Ports: 6443 und 443**, aber auch 8443 in Minikube und 8080 als unsicher.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**√úberpr√ºfen Sie die folgende Seite, um zu erfahren, wie Sie sensible Daten erhalten und sensible Aktionen mit diesem Dienst ausf√ºhren k√∂nnen:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Dieser Dienst **l√§uft auf jedem Knoten des Clusters**. Es ist der Dienst, der die Pods innerhalb des **Knotens** steuert. Er kommuniziert mit dem **kube-apiserver**.

Wenn Sie feststellen, dass dieser Dienst freigelegt ist, haben Sie m√∂glicherweise eine **nicht authentifizierte RCE** gefunden.

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Wenn die Antwort `Unauthorized` lautet, erfordert dies eine Authentifizierung.

Wenn Sie Knoten auflisten k√∂nnen, k√∂nnen Sie eine Liste der Kubelet-Endpunkte mit erhalten:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Nur lesen)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

Tiller ist ein Server, der auf dem Kubernetes-Cluster l√§uft und die Kommunikation mit der Helm-CLI erm√∂glicht. Es ist wichtig, Tiller richtig zu konfigurieren, um Sicherheitsl√ºcken zu vermeiden.
```
helm --host tiller-deploy.kube-system:44134 version
```
Du k√∂nntest diesen Service missbrauchen, um Privilegien innerhalb von Kubernetes zu eskalieren:

### cAdvisor

Dienst n√ºtzlich zum Sammeln von Metriken.
```
curl -k https://<IP Address>:4194
```
### NodePort

Wenn ein Port √ºber einen **NodePort** auf allen Nodes freigegeben wird, wird derselbe Port auf allen Nodes ge√∂ffnet, um den Datenverkehr zum deklarierten **Service** zu leiten. Standardm√§√üig befindet sich dieser Port im **Bereich 30000-32767**. Daher k√∂nnen neue nicht √ºberpr√ºfte Services √ºber diese Ports erreichbar sein.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Anf√§llige Fehlkonfigurationen

### Kube-apiserver Anonymer Zugriff

Der anonyme Zugriff auf **kube-apiserver-API-Endpunkte ist nicht erlaubt**. Aber Sie k√∂nnten einige Endpunkte √ºberpr√ºfen:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **√úberpr√ºfung des ETCD-Anonymen Zugriffs**

Der ETCD speichert die Clustergeheimnisse, Konfigurationsdateien und weitere **sensible Daten**. Standardm√§√üig kann auf den ETCD **nicht anonym** zugegriffen werden, aber es ist immer gut zu √ºberpr√ºfen.

Wenn auf den ETCD anonym zugegriffen werden kann, m√ºssen Sie m√∂glicherweise das [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **Werkzeug** verwenden. Mit dem folgenden Befehl werden alle gespeicherten Schl√ºssel abgerufen:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

Die [**Kubelet-Dokumentation**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) erkl√§rt, dass standardm√§√üig **anonymer Zugriff auf den Dienst erlaubt ist:**

> Erm√∂glicht anonyme Anfragen an den Kubelet-Server. Anfragen, die nicht von einer anderen Authentifizierungsmethode abgelehnt werden, werden als anonyme Anfragen behandelt. Anonyme Anfragen haben einen Benutzernamen von `system:anonymous` und einen Gruppennamen von `system:unauthenticated`

Um besser zu verstehen, wie die **Authentifizierung und Autorisierung der Kubelet-API funktioniert**, schauen Sie sich diese Seite an:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

Der **Kubelet**-Service **API ist nicht dokumentiert**, aber der Quellcode kann hier gefunden werden und das Auffinden der freigegebenen Endpunkte ist so einfach wie **das Ausf√ºhren**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Alle klingen interessant.

Sie k√∂nnen das [**Kubeletctl**](https://github.com/cyberark/kubeletctl)-Tool verwenden, um mit Kubelets und deren Endpunkten zu interagieren.

#### /pods

Dieser Endpunkt listet Pods und ihre Container auf:
```bash
kubeletctl pods
```
#### /exec

Dieser Endpunkt erm√∂glicht es, Code sehr einfach innerhalb eines beliebigen Containers auszuf√ºhren:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Um diesen Angriff zu vermeiden, sollte der _**kubelet**_-Dienst mit `--anonymous-auth false` ausgef√ºhrt werden und der Dienst auf Netzwerkebene getrennt werden.
{% endhint %}

### **√úberpr√ºfung der Offenlegung von Kubelet (Nur-Lese-Port) Informationen**

Wenn ein **kubelet Nur-Lese-Port** freigelegt ist, wird es m√∂glich, dass Informationen von Unbefugten aus der API abgerufen werden k√∂nnen. Die Offenlegung dieses Ports kann zur Offenlegung verschiedener **Cluster-Konfigurationselemente** f√ºhren. Obwohl die Informationen, einschlie√ülich **Pod-Namen, Speicherorte interner Dateien und anderer Konfigurationen**, m√∂glicherweise nicht kritisch sind, stellt ihre Offenlegung dennoch ein Sicherheitsrisiko dar und sollte vermieden werden.

Ein Beispiel, wie diese Schwachstelle ausgenutzt werden kann, beinhaltet einen entfernten Angreifer, der auf eine bestimmte URL zugreift. Indem er zu `http://<external-IP>:10255/pods` navigiert, kann der Angreifer potenziell sensible Informationen vom kubelet abrufen:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referenzen

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
Lernen und √ºben Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen und √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>
{% endhint %}
