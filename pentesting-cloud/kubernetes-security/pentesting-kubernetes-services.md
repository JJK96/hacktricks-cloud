# Kubernetes Hizmetlerinin Pentesting'i

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahramana öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**]'na göz atın (https://github.com/sponsors/carlospolop)!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya beni **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)'de **takip edin**.
* **Hacking püf noktalarınızı paylaşarak PR'lar göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

Kubernetes, **İnternete açık olabilecek özel ağ hizmetlerini** kullanır veya **bir pod'u ele geçirdikten sonra iç ağda bulabilirsiniz**.

## OSINT ile Açıkta Bulunan Pod'ları Bulma

Bir yol, `Identity LIKE "k8s.%.com"` ifadesini [crt.sh](https://crt.sh) sitesinde aramaktır ve kubernetes ile ilgili alt alanları bulabilirsiniz. Başka bir yol, github'da `"k8s.%.com"` ifadesini aramak ve bu dizeyi içeren **YAML dosyalarını** aramaktır.

## Kubernetes Hizmetlerini Nasıl Açığa Çıkarır

Kubernetes'ın hizmetleri nasıl **genel olarak açığa çıkarabileceğini** anlamanız faydalı olabilir:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Port Taraması ile Açıkta Bulunan Pod'ları Bulma

Aşağıdaki portlar bir Kubernetes kümesinde açık olabilir:

| Port            | İşlem          | Açıklama                                                               |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API portu                                                   |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Konteyner metrikleri                                                   |
| 6443/TCP        | kube-apiserver | Kubernetes API portu                                                   |
| 8443/TCP        | kube-apiserver | Minikube API portu                                                     |
| 8080/TCP        | kube-apiserver | Güvensiz API portu                                                     |
| 10250/TCP       | kubelet        | Tam erişim sağlayan HTTPS API                                          |
| 10255/TCP       | kubelet        | Kimlik doğrulamasız salt okunur HTTP portu: podlar, çalışan podlar ve düğüm durumu |
| 10256/TCP       | kube-proxy     | Kube Proxy sağlık kontrol sunucusu                                     |
| 9099/TCP        | calico-felix   | Calico için sağlık kontrol sunucusu                                    |
| 6782-4/TCP      | weave          | Metrikler ve uç noktalar                                               |
| 30000-32767/TCP | NodePort       | Hizmetlere proxy yapar                                                 |
| 44134/TCP       | Tiller         | Helm hizmeti dinleme                                                   |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Bu genellikle yöneticilerin **`kubectl`** aracını kullanarak konuştuğu **API Kubernetes servisi**'dir.

**Yaygın portlar: 6443 ve 443**, ancak minikube'da 8443 ve güvensiz olarak 8080 de kullanılabilir.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Hassas verileri nasıl elde edeceğinizi ve bu servisle iletişim kurarak hassas işlemleri nasıl gerçekleştireceğinizi öğrenmek için aşağıdaki sayfayı kontrol edin:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Bu servis **kümenin her düğümünde çalışır**. Bu, düğüm içindeki **pods'ları kontrol edecek** olan servistir. **kube-apiserver** ile iletişim kurar.

Bu servisi açık bulursanız, **kimlik doğrulamasız RCE** bulmuş olabilirsiniz.

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Eğer yanıt `Unauthorized` ise kimlik doğrulaması gerektirir.

Eğer düğümleri listeleyebiliyorsanız, kubelet uç noktalarının bir listesini alabilirsiniz:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Sadece Okuma)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

Tiller, Kubernetes'de kullanılan bir bileşen olan Helm'in (kubernetes paket yöneticisi) bir parçasıdır. Tiller, Kubernetes kümesindeki pod'lar arasında Helm komutlarını dağıtmak ve yönetmek için kullanılır. Tiller, güvenlik açıklarına neden olabileceği için Kubernetes kümesinde devre dışı bırakılmalıdır.
```
helm --host tiller-deploy.kube-system:44134 version
```
### cAdvisor

Metrikleri toplamak için kullanışlı bir hizmet. Bu hizmeti kullanarak ayrıcalıkları yükseltebilirsiniz.
```
curl -k https://<IP Address>:4194
```
### NodePort

Bir port **NodePort** aracılığıyla tüm düğümlerde açıldığında, aynı port tüm düğümlerde açılır ve trafiği ilan edilen **Servis**e yönlendirir. Varsayılan olarak, bu port **30000-32767 aralığında** olacaktır. Bu nedenle, kontrol edilmemiş yeni servislere bu portlar aracılığıyla erişilebilir olabilir.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Hassas Yanlış Yapılandırmalar

### Kube-apiserver Anonim Erişim

**kube-apiserver API uç noktalarına anonim erişim izin verilmez**. Ancak bazı uç noktaları kontrol edebilirsiniz:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **ETCD Anonim Erişimini Kontrol Etme**

ETCD, küme sırlarını, yapılandırma dosyalarını ve daha **hassas verileri** depolar. **Varsayılan olarak**, ETCD **anonim olarak** erişilemez, ancak her zaman kontrol etmek iyidir.

ETCD'ye anonim erişim sağlanabiliyorsa, [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **aracını kullanmanız gerekebilir**. Aşağıdaki komut tüm depolanan anahtarları alacaktır:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

[**Kubelet belgeleri**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) varsayılan olarak servise **anonim erişime izin verildiğini** açıklar:

> Kubelet sunucusuna anonim istekleri etkinleştirir. Başka bir kimlik doğrulama yöntemi tarafından reddedilmeyen istekler anonim istekler olarak kabul edilir. Anonim isteklerin bir kullanıcı adı `system:anonymous` ve bir grup adı `system:unauthenticated`'dir.

**Kubelet API'nin kimlik doğrulama ve yetkilendirme** nasıl çalıştığını daha iyi anlamak için bu sayfaya bakın:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet** servisinin **API'si belgelenmemiştir**, ancak kaynak kodu burada bulunabilir ve açık uç noktalarını bulmak **şu şekilde kolaydır**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Hepsinin ilginç geldiğini düşünüyorum.

Kubeletlerle ve uç noktalarıyla etkileşim kurmak için [**Kubeletctl**](https://github.com/cyberark/kubeletctl) aracını kullanabilirsiniz.

#### /pods

Bu uç nokta, pod'ları ve içerdikleri konteynerleri listeler:
```bash
kubeletctl pods
```
#### /exec

Bu uç nokta, herhangi bir konteyner içinde kodu çok kolay bir şekilde çalıştırmayı sağlar:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Bu saldırıyı önlemek için _**kubelet**_ servisinin `--anonymous-auth false` parametresi ile çalıştırılması ve servisin ağ düzeyinde ayrılması gerekmektedir.
{% endhint %}

### **Kubelet (Sadece Okuma Portu) Bilgi Sızdırma Kontrolü**

Bir **kubelet sadece okuma portu** açık olduğunda, yetkisiz kişilerin API'den bilgi alabilmesi mümkün hale gelir. Bu portun açılması, çeşitli **küme yapılandırma unsurlarının** ifşa edilmesine neden olabilir. Bilgiler arasında **pod isimleri, iç dosyaların konumları ve diğer yapılandırmalar** bulunabilir. Bu bilgiler kritik olmasa da, açığa çıkması hala bir güvenlik riski oluşturur ve kaçınılmalıdır.

Bu zafiyetin nasıl sömürülebileceğine dair bir örnek, uzaktan bir saldırganın belirli bir URL'ye erişmesini içerir. `http://<external-IP>:10255/pods` adresine giderek, saldırgan kubeletten hassas bilgileri potansiyel olarak alabilir:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referanslar

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahraman seviyesine öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **💬 [Discord grubuna](https://discord.gg/hRep4RUj7f) veya [telegram grubuna](https://t.me/peass) katılın veya** beni **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)** takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR'lar göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
