# Ελεγχος Ευπειθών Υπηρεσιών Kubernetes

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Συμμετέχετε** 💬 στην [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ καταθέτοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

Το Kubernetes χρησιμοποιεί αρκετές **συγκεκριμένες υπηρεσίες δικτύου** που ενδέχεται να βρείτε **εκτεθειμένες στο Internet** ή σε ένα **εσωτερικό δίκτυο αφού έχετε διαρρήξει ένα pod**.

## Εύρεση εκτεθειμένων pods με OSINT

Ένας τρόπος θα μπορούσε να είναι η αναζήτηση για `Identity LIKE "k8s.%.com"` στο [crt.sh](https://crt.sh) για να βρείτε υποτομείς που σχετίζονται με το kubernetes. Ένας άλλος τρόπος θα μπορούσε να είναι η αναζήτηση `"k8s.%.com"` στο github και η αναζήτηση για **αρχεία YAML** που περιέχουν τη συμβολοσειρά.

## Πώς Εκθέτει Υπηρεσίες το Kubernetes

Μπορεί να σας φανεί χρήσιμο να κατανοήσετε πώς το Kubernetes μπορεί να **εκθέσει υπηρεσίες δημόσια** για να τις βρείτε:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Εύρεση Εκτεθειμένων pods μέσω σάρωσης θυρών

Οι παρακάτω θύρες ενδέχεται να είναι ανοιχτές σε ένα cluster Kubernetes:

| Θύρα           | Διεργασία      | Περιγραφή                                                              |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Θύρα API του Kubernetes                                                |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Μετρήσεις container                                                    |
| 6443/TCP        | kube-apiserver | Θύρα API του Kubernetes                                                |
| 8443/TCP        | kube-apiserver | Θύρα API του Minikube                                                  |
| 8080/TCP        | kube-apiserver | Μη ασφαλής θύρα API                                                   |
| 10250/TCP       | kubelet        | HTTPS API που επιτρέπει πλήρη πρόσβαση                                |
| 10255/TCP       | kubelet        | Μη εξουσιοδοτημένη ανάγνωση-only HTTP θύρα: pods, running pods και κατάσταση κόμβου |
| 10256/TCP       | kube-proxy     | Εξυπηρετητής ελέγχου υγείας Kube Proxy                              |
| 9099/TCP        | calico-felix   | Εξυπηρετητής ελέγχου υγείας για το Calico                         |
| 6782-4/TCP      | weave          | Μετρήσεις και σημεία άκρων                                           |
| 30000-32767/TCP | NodePort       | Διαμεσολαβητής προς τις υπηρεσίες                                  |
| 44134/TCP       | Tiller         | Υπηρεσία Helm που ακούει                                              |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Αυτή είναι η υπηρεσία **API Kubernetes** με την οποία οι διαχειριστές επικοινωνούν συνήθως χρησιμοποιώντας το εργαλείο **`kubectl`**.

**Συνήθεις θύρες: 6443 και 443**, αλλά επίσης 8443 στο minikube και 8080 ως ανασφαλής.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Ελέγξτε την παρακάτω σελίδα για να μάθετε πώς να αποκτήσετε ευαίσθητα δεδομένα και να εκτελέσετε ευαίσθητες ενέργειες μιλώντας σε αυτήν την υπηρεσία:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Αυτή η υπηρεσία **τρέχει σε κάθε κόμβο του cluster**. Είναι η υπηρεσία που θα **ελέγχει** τα pods μέσα στον **κόμβο**. Μιλάει με τον **kube-apiserver**.

Αν βρείτε αυτήν την υπηρεσία εκτεθειμένη, μπορεί να έχετε βρει ένα **μη εξουσιοδοτημένο RCE**.
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Εάν η απάντηση είναι `Μη εξουσιοδοτημένος` τότε απαιτείται πιστοποίηση.

Εάν μπορείτε να καταγράψετε τους κόμβους, μπορείτε να λάβετε μια λίστα με τα σημεία άκρων kubelets με:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Μόνο για ανάγνωση)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### Πρωτόκολλο etcd
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

### Tiller
```
helm --host tiller-deploy.kube-system:44134 version
```
Μπορείτε να καταχραστείτε αυτήν την υπηρεσία για την ανάδειξη προνομίων μέσα στο Kubernetes:

### cAdvisor

Υπηρεσία χρήσιμη για τη συλλογή μετρήσεων.
```
curl -k https://<IP Address>:4194
```
### NodePort

Όταν ένας θύρα εκτίθεται σε όλους τους κόμβους μέσω ενός **NodePort**, η ίδια θύρα ανοίγεται σε όλους τους κόμβους προωθώντας την κίνηση στην δηλωμένη **Υπηρεσία**. Από προεπιλογή, αυτή η θύρα θα είναι στο **εύρος 30000-32767**. Έτσι, νέες μη ελεγμένες υπηρεσίες ενδέχεται να είναι προσβάσιμες μέσω αυτών των θυρών.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Ευάλωτες Λανθασμένες Διαμορφώσεις

### Ανώνυμη Πρόσβαση στο Kube-apiserver

Η ανώνυμη πρόσβαση στα **σημεία API του kube-apiserver δεν επιτρέπεται**. Ωστόσο, μπορείτε να ελέγξετε μερικά σημεία:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Έλεγχος για Ανώνυμη Πρόσβαση στο ETCD**

Το ETCD αποθηκεύει τα μυστικά του cluster, τα αρχεία διαμόρφωσης και περισσότερα **ευαίσθητα δεδομένα**. Από **προεπιλογή**, το ETCD **δεν μπορεί** να προσπελαστεί **ανώνυμα**, αλλά είναι πάντα καλό να γίνει έλεγχος.

Αν το ETCD μπορεί να προσπελαστεί ανώνυμα, μπορεί να χρειαστεί να **χρησιμοποιήσετε το** [**εργαλείο etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). Η παρακάτω εντολή θα ανακτήσει όλα τα κλειδιά που έχουν αποθηκευτεί:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

Η [**τεκμηρίωση του Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) εξηγεί ότι από προεπιλογή η **ανώνυμη πρόσβαση** στην υπηρεσία επιτρέπεται:

> Ενεργοποιεί ανώνυμα αιτήματα προς τον διακομιστή Kubelet. Τα αιτήματα που δεν απορρίπτονται από άλλη μέθοδο πιστοποίησης θεωρούνται ως ανώνυμα αιτήματα. Τα ανώνυμα αιτήματα έχουν ως όνομα χρήστη το `system:anonymous`, και ως όνομα ομάδας το `system:unauthenticated`.

Για να κατανοήσετε καλύτερα πως λειτουργεί η **πιστοποίηση και η εξουσιοδότηση του API του Kubelet**, ελέγξτε αυτήν τη σελίδα:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

Η **υπηρεσία Kubelet** **API δεν έχει τεκμηριωθεί**, αλλά ο κώδικας πηγής μπορεί να βρεθεί εδώ και η εύρεση των εκτεθειμένων σημείων πρόσβασης είναι τόσο εύκολη όσο το **εξής εντολή:**
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Μπορείτε να χρησιμοποιήσετε το [**Kubeletctl**](https://github.com/cyberark/kubeletctl) εργαλείο για να αλληλεπιδράτε με τα Kubelets και τα σημεία τους.

#### /pods

Αυτό το σημείο τερματικού λίσταρει τα pods και τα containers τους:
```bash
kubeletctl pods
```
#### /exec

Αυτό το σημείο επιτρέπει την εκτέλεση κώδικα μέσα σε οποιοδήποτε container πολύ εύκολα:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Για να αποφευχθεί αυτή η επίθεση, ο υπηρεσία _**kubelet**_ θα πρέπει να εκτελείται με την παράμετρο `--anonymous-auth false` και η υπηρεσία θα πρέπει να είναι απομονωμένη στο επίπεδο δικτύου.
{% endhint %}

### **Έλεγχος Έκθεσης Πληροφοριών Kubelet (Θύρα Μόνο για Ανάγνωση)**

Όταν μια **θύρα μόνο για ανάγνωση του kubelet** είναι εκτεθειμένη, γίνεται δυνατή η ανάκτηση πληροφοριών από το API από μη εξουσιοδοτημένα μέρη. Η έκθεση αυτής της θύρας μπορεί να οδηγήσει στη διαρροή διάφορων **στοιχείων διαμόρφωσης cluster**. Αν και οι πληροφορίες, συμπεριλαμβανομένων των **ονομάτων των pods, των τοποθεσιών εσωτερικών αρχείων και άλλων διαμορφώσεων**, ενδέχεται να μην είναι κρίσιμες, η έκθεσή τους αποτελεί παρόλα αυτά κίνδυνο για την ασφάλεια και θα πρέπει να αποφεύγεται.

Ένα παράδειγμα πώς αυτή η ευπάθεια μπορεί να εκμεταλλευτεί εμπλέκει έναν απομακρυσμένο εισβολέα που έχει πρόσβαση σε ένα συγκεκριμένο URL. Μεταβαίνοντας στο `http://<external-IP>:10255/pods`, ο εισβολέας μπορεί πιθανόν να ανακτήσει ευαίσθητες πληροφορίες από το kubelet:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Αναφορές

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 στην ομάδα [**Discord**](https://discord.gg/hRep4RUj7f) ή στην ομάδα [**telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
{% endhint %}
