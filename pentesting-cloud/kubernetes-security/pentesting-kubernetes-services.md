# Kubernetes Hizmetlerinin Pentesting'i

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

Kubernetes, **belirli ağ hizmetlerini** kullanan ve muhtemelen İnternete **açık veya bir pod'u ele geçirdikten sonra iç ağda bulabileceğiniz** birkaç hizmet kullanır.

## OSINT ile Açıkta Bulunan Pod'ları Bulma

Bir yol, `Identity LIKE "k8s.%.com"` ifadesini [crt.sh](https://crt.sh) sitesinde aramaktır ve kubernetes ile ilgili alt alanları bulmaktır. Başka bir yol ise `"k8s.%.com"` ifadesini github'da aramak ve bu ifadeyi içeren **YAML dosyalarını** aramaktır.

## Kubernetes Hizmetlerini Nasıl Açığa Çıkarır

Hizmetleri **genel olarak açığa çıkarabilen Kubernetes'in** nasıl çalıştığını anlamanız faydalı olabilir:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Port Taraması ile Açıkta Bulunan Pod'ları Bulma

Aşağıdaki portlar bir Kubernetes kümesinde açık olabilir:

| Port            | İşlem          | Açıklama                                                               |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API port                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Konteyner metrikleri                                                   |
| 6443/TCP        | kube-apiserver | Kubernetes API port                                                    |
| 8443/TCP        | kube-apiserver | Minikube API port                                                      |
| 8080/TCP        | kube-apiserver | Güvensiz API portu                                                     |
| 10250/TCP       | kubelet        | Tam erişim sağlayan HTTPS API                                          |
| 10255/TCP       | kubelet        | Kimlik doğrulamasız salt okunur HTTP portu: podlar, çalışan podlar ve düğüm durumu |
| 10256/TCP       | kube-proxy     | Kube Proxy sağlık kontrol sunucusu                                     |
| 9099/TCP        | calico-felix   | Calico için sağlık kontrol sunucusu                                    |
| 6782-4/TCP      | weave          | Metrikler ve uç noktalar                                               |
| 30000-32767/TCP | NodePort       | Hizmetlere proxy yapar                                                 |
| 44134/TCP       | Tiller         | Helm hizmeti dinleme                                                   |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Bu genellikle yöneticilerin **`kubectl`** aracını kullanarak konuştuğu **API Kubernetes servisi**'dir.

**Yaygın portlar: 6443 ve 443**, ancak minikube'da 8443 ve güvensiz olarak 8080 de kullanılabilir.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Aşağıdaki sayfayı kontrol edin ve bu servisle iletişim kurarak hassas verileri nasıl elde edeceğinizi ve hassas işlemleri nasıl gerçekleştireceğinizi öğrenin:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Bu servis **kümenin her düğümünde çalışır**. Bu, düğüm içindeki **pods'ları kontrol edecek** olan servistir. **kube-apiserver** ile iletişim kurar.

Bu servisi açık bulursanız, **kimlik doğrulamasız RCE** bulmuş olabilirsiniz.

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Eğer yanıt `Yetkisiz` ise kimlik doğrulaması gerektirir.

Eğer düğümleri listeleyebiliyorsanız, kubelet uç noktalarının bir listesini alabilirsiniz:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Sadece Okuma)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

Tiller, Kubernetes'de kullanılan bir bileşen olan Helm'in eski bir sürümüdür. Kubernetes sürüm 1.14'ten itibaren Tiller kullanımı önerilmemektedir. Tiller, Kubernetes kümesindeki uygulamaları yönetmek için kullanılan bir araçtır. Ancak güvenlik endişeleri nedeniyle Helm v3'te Tiller kaldırılmıştır.
```
helm --host tiller-deploy.kube-system:44134 version
```
### cAdvisor

Metrikleri toplamak için kullanışlı bir hizmet.
```
curl -k https://<IP Address>:4194
```
### NodePort

Bir port **NodePort** aracılığıyla tüm düğümlerde açıldığında, aynı port tüm düğümlerde açılır ve trafiği ilan edilen **Service**'e yönlendirir. Varsayılan olarak bu port **30000-32767 aralığında** olacaktır. Bu nedenle, kontrol edilmemiş yeni servislere bu portlar aracılığıyla erişilebilir.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Hassas Yanlış Yapılandırmalar

### Kube-apiserver Anonim Erişim

**kube-apiserver API uç noktalarına anonim erişim izin verilmez**. Ancak bazı uç noktaları kontrol edebilirsiniz:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **ETCD Anonim Erişim Kontrolü**

ETCD, küme sırlarını, yapılandırma dosyalarını ve daha **hassas verileri** depolar. **Varsayılan olarak**, ETCD'ye **anonim olarak** erişilemez, ancak her zaman kontrol etmek iyidir.

ETCD'ye anonim erişim sağlanabiliyorsa, [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **aracını kullanmanız gerekebilir**. Aşağıdaki komut tüm depolanan anahtarları alacaktır:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

[**Kubelet belgeleri**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) varsayılan olarak servise **anonim erişime izin verildiğini** açıklar:

> Kubelet sunucusuna anonim istekleri etkinleştirir. Başka bir kimlik doğrulama yöntemi tarafından reddedilmeyen istekler anonim istekler olarak kabul edilir. Anonim isteklerin bir kullanıcı adı `system:anonymous` ve bir grup adı `system:unauthenticated`'dir.

**Kubelet API'nin kimlik doğrulama ve yetkilendirme** nasıl çalıştığını daha iyi anlamak için bu sayfaya bakın:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet** servisinin **API'si belgelenmemiştir**, ancak kaynak kodu burada bulunabilir ve açık uç noktalarını bulmak **şu şekilde kolaydır**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Tümü ilginç görünüyor.

Kubeletlerle ve uç noktalarıyla etkileşim kurmak için [**Kubeletctl**](https://github.com/cyberark/kubeletctl) aracını kullanabilirsiniz.

#### /pods

Bu uç nokta, pod'ları ve içerdikleri konteynerleri listeler:
```bash
kubeletctl pods
```
#### /exec

Bu uç nokta herhangi bir konteyner içinde kodu çok kolay bir şekilde çalıştırmaya olanak tanır:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Bu saldırıyı önlemek için _**kubelet**_ servisinin `--anonymous-auth false` parametresi ile çalıştırılması ve servisin ağ düzeyinde ayrılması gerekmektedir.
{% endhint %}

### **Kubelet (Sadece Okuma Portu) Bilgi Sızdırma Kontrolü**

Bir **kubelet sadece okuma portu** açık olduğunda, yetkisiz kişilerin API'den bilgi alması mümkün hale gelir. Bu portun açılması, çeşitli **küme yapılandırma unsurlarının** ifşa edilmesine neden olabilir. Bilgiler, **pod isimleri, iç dosyaların konumları ve diğer yapılandırmalar** gibi kritik olmayabilir, ancak bu bilgilerin ifşası hala bir güvenlik riski oluşturur ve kaçınılmalıdır.

Bu zafiyetin nasıl sömürülebileceğine dair bir örnek, uzaktan bir saldırganın belirli bir URL'ye erişmesini içerir. `http://<external-IP>:10255/pods` adresine giderek, saldırgan kubeletten hassas bilgileri potansiyel olarak alabilir:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referanslar

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Destek HackTricks</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
