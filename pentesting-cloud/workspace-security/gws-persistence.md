# GWS - 持久性

{% hint style="success" %}
学习并练习AWS Hacking：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习GCP Hacking：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}

{% hint style="danger" %}
本节中提到的所有更改设置的操作都会生成一个**安全警报发送到电子邮件，甚至会向与帐户同步的任何移动设备推送通知**。
{% endhint %}

## Gmail 中的持久性

* 您可以创建**过滤器来隐藏**来自 Google 的安全通知
* `from: (no-reply@accounts.google.com) "Security Alert"`
* 这将阻止安全电子邮件到达邮箱（但不会阻止推送通知到移动设备）

<details>

<summary>创建 Gmail 过滤器的步骤</summary>

（来自[**这里**](https://support.google.com/mail/answer/6579)的说明）

1. 打开[Gmail](https://mail.google.com/)。
2. 在顶部的搜索框中，单击显示搜索选项 ![photos tune](https://lh3.googleusercontent.com/cD6YR\_YvqXqNKxrWn2NAWkV6tjJtg8vfvqijKT1\_9zVCrl2sAx9jROKhLqiHo2ZDYTE=w36)。
3. 输入您的搜索条件。如果要检查搜索是否正确，请单击**搜索**查看显示的电子邮件。&#x20;
4. 在搜索窗口底部，单击**创建过滤器**。
5. 选择过滤器的操作。
6. 单击**创建过滤器**。

在[https://mail.google.com/mail/u/0/#settings/filters](https://mail.google.com/mail/u/0/#settings/filters)中检查当前的过滤器（以删除它们）

</details>

<figure><img src="../../.gitbook/assets/image (331).png" alt=""><figcaption></figcaption></figure>

* 创建**转发地址以转发敏感信息**（或全部内容）- 您需要手动访问。
* 在[https://mail.google.com/mail/u/2/#settings/fwdandpop](https://mail.google.com/mail/u/2/#settings/fwdandpop)中创建一个转发地址
* 接收地址将需要确认此操作
* 然后，设置为转发所有电子邮件并保留副本（记得点击保存更改）：

<figure><img src="../../.gitbook/assets/image (332).png" alt=""><figcaption></figcaption></figure>

还可以创建过滤器，仅将特定电子邮件转发到其他电子邮件地址。

## 应用程序密码

如果您成功**入侵了谷歌用户会话**，并且用户启用了**双因素身份验证**，您可以**生成**一个[**应用程序密码**](https://support.google.com/accounts/answer/185833?hl=en)（点击链接查看步骤）。请注意，**谷歌不再推荐使用应用程序密码**，并且当用户**更改谷歌账户密码时，应用程序密码将被撤销**。

**即使您有一个开放的会话，您也需要知道用户的密码才能创建应用程序密码。**

{% hint style="info" %}
应用程序密码只能用于已启用双重验证的帐户。
{% endhint %}

## 更改双因素身份验证和类似设置

也可以在此页面[**https://myaccount.google.com/security**](https://myaccount.google.com/security)**中关闭双因素身份验证或注册新设备**（或电话号码）。\
**还可以生成密码（添加您自己的设备），更改密码，添加用于验证电话和恢复的手机号码，更改恢复电子邮件和更改安全问题。**

{% hint style="danger" %}
为了**防止安全推送通知**到达用户手机，您可以**登出他的智能手机**（尽管这可能有点奇怪），因为您无法从这里重新登录他。

还可以**定位设备**。
{% endhint %}

**即使您有一个开放的会话，您也需要知道用户的密码才能更改这些设置。**

## 通过 OAuth 应用程序实现持久性

如果您**入侵了用户的帐户**，您可以**同意**向**OAuth 应用程序**授予所有可能的权限。唯一的问题是 Workspace 可能配置为**禁止未经审查的外部和/或内部 OAuth 应用程序**。\
Workspace 组织通常默认不信任外部 OAuth 应用程序，但信任内部应用程序，因此如果您有**足够的权限在组织内生成新的 OAuth 应用程序**，并且外部应用程序被禁止，则生成并**使用该新的内部 OAuth 应用程序来保持持久性**。

查看以下页面获取有关 OAuth 应用程序的更多信息：

{% content-ref url="gws-google-platforms-phishing/" %}
[gws-google-platforms-phishing](gws-google-platforms-phishing/)
{% endcontent-ref %}

## 通过委托实现持久性

您可以**将帐户委托给攻击者控制的不同帐户**（如果允许）。在 Workspace **组织**中，此选项必须是**已启用**的。它可以被禁用，启用于某些用户/组或所有用户（通常仅对某些用户/组启用或完全禁用）。

<details>

<summary>如果您是 Workspace 管理员，请查看此内容以启用该功能</summary>

（信息来自[文档](https://support.google.com/a/answer/7223765)）

作为组织（例如您的工作或学校）的管理员，您可以控制用户是否可以委托他们的 Gmail 帐户。您可以让每个人都有委托其帐户的选项。或者，只允许某些部门的人设置委托。例如，您可以：

* 将行政助理添加为您的 Gmail 帐户的代表，以便他们可以代表您阅读和发送电子邮件。&#x20;
* 将一个组，例如您的销售部门，在 Groups 中作为代表添加，以便每个人都可以访问一个 Gmail 帐户。

用户只能将访问权限委托给同一组织中的另一个用户，而不管他们的域或其组织单位如何。

### 委托限制和限制&#x20;

* **允许用户将邮箱访问权限授予 Google 组** 选项：要使用此选项，必须为被委托帐户的 OU 和每个组成员的 OU 启用该选项。属于未启用此选项的 OU 的组成员无法访问被委托的帐户。
* 在典型使用中，40 个被委托用户可以同时访问一个 Gmail 帐户。一个或多个代表的高于平均使用可能会减少此数字。&#x20;
* 频繁访问 Gmail 的自动化流程也可能减少可以同时访问帐户的代表数量。这些流程包括频繁访问 Gmail 的 API 或浏览器扩展程序。
* 单个 Gmail 帐户支持最多 1,000 个唯一代表。Groups 中的一个组计为一个代表。
* 委托不会增加 Gmail 帐户的限制。具有被委托用户的 Gmail 帐户具有标准 Gmail 帐户限制和政策。有关详细信息，请访问[Gmail 限制和政策](https://support.google.com/a/topic/28609)。
### 步骤 1：为您的用户打开Gmail委派功能

**开始之前：** 要为特定用户应用设置，请将他们的帐户放入一个[组织单位](https://support.google.com/a/topic/1227584)。

1. [登录](https://admin.google.com/)到您的[Google管理控制台](https://support.google.com/a/answer/182076)。
   
使用一个_管理员帐户_登录，而不是您当前的CarlosPolop@gmail.com帐户。
2. 在管理控制台中，转到菜单 ![](https://storage.googleapis.com/support-kms-prod/JxKYG9DqcsormHflJJ8Z8bHuyVI5YheC0lAp)![然后](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn) **应用**![然后](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Google Workspace**![然后](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Gmail**![然后](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**用户设置**。
3. 要将设置应用于所有人，请保留顶部组织单位选定。否则，选择一个子[组织单位](https://support.google.com/a/topic/1227584)。
4. 点击**邮件委派**。
5. 勾选**允许用户将对其邮箱的访问权限委派给域中的其他用户**框。
6. (可选) 要让用户指定委派消息中包含的发件人信息，勾选**允许用户自定义此设置**框。
7. 选择由代表发送的邮件中包含的默认发件人信息的选项：&#x20;
   * **显示帐户所有者和发送电子邮件的代表**—消息包括Gmail帐户所有者和代表的电子邮件地址。
   * **仅显示帐户所有者**—消息仅包括Gmail帐户所有者的电子邮件地址。不包括代表的电子邮件地址。
8. (可选) 要让用户将组中的群组作为代表添加，勾选**允许用户将其邮箱访问权限授予Google群组**框。
9. 点击**保存**。如果配置了子组织单位，您可能可以**继承**或**覆盖**父组织单位的设置。
10. (可选) 要为其他组织单位打开Gmail委派，请重复步骤3-9。

更改可能需要最多24小时才能生效，但通常会更快。[了解更多](https://support.google.com/a/answer/7514107)

### 步骤 2：让用户为他们的帐户设置委派

在您打开委派后，您的用户可以转到他们的Gmail设置来分配委派。委派可以阅读、发送和接收用户的邮件。&#x20;

有关详细信息，请直接将用户指向[委派和协作电子邮件](https://support.google.com/a/users/answer/138350)。

</details>
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **的 GitHub 仓库提交 PR 来分享黑客技巧。**

</details>
{% endhint %}
