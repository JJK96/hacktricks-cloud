# GWS - Persistencia

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripción**](https://github.com/sponsors/carlospolop)!
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>
{% endhint %}

{% hint style="danger" %}
Todas las acciones mencionadas en esta sección que cambien la configuración generarán una **alerta de seguridad al correo electrónico e incluso una notificación push a cualquier dispositivo móvil sincronizado** con la cuenta.
{% endhint %}

## **Persistencia en Gmail**

* Puedes crear **filtros para ocultar** notificaciones de seguridad de Google
* `from: (no-reply@accounts.google.com) "Security Alert"`
* Esto evitará que los correos de seguridad lleguen al correo electrónico (pero no evitará las notificaciones push al dispositivo móvil)

<details>

<summary> Pasos para crear un filtro en Gmail</summary>

(Instrucciones de [**aquí**](https://support.google.com/mail/answer/6579))

1. Abre [Gmail](https://mail.google.com/).
2. En la caja de búsqueda en la parte superior, haz clic en Mostrar opciones de búsqueda ![photos tune](https://lh3.googleusercontent.com/cD6YR\_YvqXqNKxrWn2NAWkV6tjJtg8vfvqijKT1\_9zVCrl2sAx9jROKhLqiHo2ZDYTE=w36) .
3. Ingresa tus criterios de búsqueda. Si deseas verificar que tu búsqueda funcionó correctamente, verifica qué correos electrónicos aparecen haciendo clic en **Buscar**.&#x20;
4. En la parte inferior de la ventana de búsqueda, haz clic en **Crear filtro**.
5. Elige qué te gustaría que haga el filtro.
6. Haz clic en **Crear filtro**.

Verifica tus filtros actuales (para eliminarlos) en [https://mail.google.com/mail/u/0/#settings/filters](https://mail.google.com/mail/u/0/#settings/filters)

</details>

<figure><img src="../../.gitbook/assets/image (331).png" alt=""><figcaption></figcaption></figure>

* Crea una **dirección de reenvío para enviar información sensible** (o todo) - Necesitas acceso manual.
* Crea una dirección de reenvío en [https://mail.google.com/mail/u/2/#settings/fwdandpop](https://mail.google.com/mail/u/2/#settings/fwdandpop)
* La dirección receptora deberá confirmar esto
* Luego, configura para reenviar todos los correos electrónicos manteniendo una copia (recuerda hacer clic en guardar cambios):

<figure><img src="../../.gitbook/assets/image (332).png" alt=""><figcaption></figcaption></figure>

También es posible crear filtros y reenviar solo correos electrónicos específicos a la otra dirección de correo electrónico.

## Contraseñas de aplicaciones

Si lograste **comprometer la sesión de un usuario de Google** y el usuario tenía **2FA**, puedes **generar** una [**contraseña de aplicación**](https://support.google.com/accounts/answer/185833?hl=es) (sigue el enlace para ver los pasos). Ten en cuenta que **Google ya no recomienda las contraseñas de aplicaciones** y estas se revocan cuando el usuario **cambia la contraseña de su cuenta de Google.**

**Incluso si tienes una sesión abierta, necesitarás conocer la contraseña del usuario para crear una contraseña de aplicación.**

{% hint style="info" %}
Las contraseñas de aplicaciones solo se pueden usar con cuentas que tengan activada la **Verificación en dos pasos**.
{% endhint %}

## Cambiar 2-FA y similares

También es posible **desactivar la 2-FA o inscribir un nuevo dispositivo** (o número de teléfono) en esta página [**https://myaccount.google.com/security**](https://myaccount.google.com/security)**.**\
**También es posible generar contraseñas de seguridad (agregar tu propio dispositivo), cambiar la contraseña, agregar números de teléfono para verificar teléfonos y recuperación, cambiar el correo electrónico de recuperación y cambiar las preguntas de seguridad).**

{% hint style="danger" %}
Para **evitar que las notificaciones de seguridad push** lleguen al teléfono del usuario, podrías **cerrar la sesión en su teléfono inteligente** (aunque eso sería extraño) porque no puedes iniciar sesión nuevamente desde aquí.

También es posible **localizar el dispositivo.**
{% endhint %}

**Incluso si tienes una sesión abierta, necesitarás conocer la contraseña del usuario para cambiar estas configuraciones.**

## Persistencia a través de aplicaciones OAuth

Si has **comprometido la cuenta de un usuario**, simplemente puedes **aceptar** otorgar todos los permisos posibles a una **Aplicación OAuth**. El único problema es que Workspace puede estar configurado para **prohibir aplicaciones OAuth externas y/o internas no revisadas.**\
Es bastante común que las Organizaciones de Workspace no confíen por defecto en aplicaciones OAuth externas pero confíen en las internas, por lo que si tienes **suficientes permisos para generar una nueva aplicación OAuth** dentro de la organización y las aplicaciones externas están prohibidas, genérala y **utiliza esa nueva aplicación OAuth interna para mantener la persistencia**.

Consulta la siguiente página para obtener más información sobre las Aplicaciones OAuth:

{% content-ref url="gws-google-platforms-phishing/" %}
[gws-google-platforms-phishing](gws-google-platforms-phishing/)
{% endcontent-ref %}

## Persistencia a través de delegación

Simplemente puedes **delegar la cuenta** a una cuenta diferente controlada por el atacante (si se te permite hacerlo). En las **Organizaciones** de Workspace esta opción debe estar **habilitada**. Puede estar deshabilitada para todos, habilitada para algunos usuarios/grupos o para todos (generalmente solo está habilitada para algunos usuarios/grupos o completamente deshabilitada).

<details>

<summary>Si eres un administrador de Workspace, verifica esto para habilitar la función</summary>

(Información [copiada de la documentación](https://support.google.com/a/answer/7223765))

Como administrador de tu organización (por ejemplo, tu trabajo o escuela), controlas si los usuarios pueden delegar acceso a su cuenta de Gmail. Puedes permitir que todos tengan la opción de delegar su cuenta. O, solo permitir que las personas en ciertos departamentos configuren la delegación. Por ejemplo, puedes:

* Agregar un asistente administrativo como delegado en tu cuenta de Gmail para que pueda leer y enviar correos electrónicos en tu nombre.&#x20;
* Agregar un grupo, como tu departamento de ventas, en Grupos como delegado para dar acceso a todos a una cuenta de Gmail.

Los usuarios solo pueden delegar acceso a otro usuario en la misma organización, independientemente de su dominio o su unidad organizativa.

### Límites y restricciones de delegación&#x20;

* Opción **Permitir a los usuarios otorgar acceso a su buzón a un grupo de Google**: Para usar esta opción, debe estar habilitada para la OU de la cuenta delegada y para la OU de cada miembro del grupo. Los miembros del grupo que pertenecen a una OU sin esta opción habilitada no pueden acceder a la cuenta delegada.
* Con un uso típico, 40 usuarios delegados pueden acceder a una cuenta de Gmail al mismo tiempo. Un uso por encima del promedio por uno o más delegados podría reducir este número.&#x20;
* Los procesos automatizados que acceden con frecuencia a Gmail también podrían reducir el número de delegados que pueden acceder a una cuenta al mismo tiempo. Estos procesos incluyen API o extensiones de navegador que acceden con frecuencia a Gmail.
* Una sola cuenta de Gmail admite hasta 1,000 delegados únicos. Un grupo en Grupos cuenta como un delegado hacia el límite.
* La delegación no aumenta los límites de una cuenta de Gmail. Las cuentas de Gmail con usuarios delegados tienen los límites y políticas estándar de una cuenta de Gmail. Para más detalles, visita [Límites y políticas de Gmail](https://support.google.com/a/topic/28609).
### Paso 1: Activar la delegación de Gmail para tus usuarios&#x20;

**Antes de comenzar:** Para aplicar la configuración para ciertos usuarios, coloca sus cuentas en una [unidad organizativa](https://support.google.com/a/topic/1227584).

1.  [Inicia sesión](https://admin.google.com/) en tu [consola de administración de Google](https://support.google.com/a/answer/182076).

Inicia sesión utilizando una _cuenta de administrador_, no tu cuenta actual CarlosPolop@gmail.com
2. En la consola de administración, ve a Menú ![](https://storage.googleapis.com/support-kms-prod/JxKYG9DqcsormHflJJ8Z8bHuyVI5YheC0lAp)![y luego](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)![](https://storage.googleapis.com/support-kms-prod/ocGtUSENh4QebLpvZcmLcNRZyaTBcolMRSyl) **Aplicaciones**![y luego](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Google Workspace**![y luego](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Gmail**![y luego](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Configuración de usuario**.
3. Para aplicar la configuración a todos, deja seleccionada la unidad organizativa superior. De lo contrario, selecciona una [unidad organizativa](https://support.google.com/a/topic/1227584) secundaria.
4. Haz clic en **Delegación de correo**.
5. Marca la casilla **Permitir que los usuarios deleguen acceso a su buzón a otros usuarios del dominio**.
6. (Opcional) Para permitir que los usuarios especifiquen qué información del remitente se incluye en los mensajes delegados enviados desde su cuenta, marca la casilla **Permitir a los usuarios personalizar esta configuración**.
7. Selecciona una opción para la información del remitente predeterminada que se incluirá en los mensajes enviados por los delegados:&#x20;
* **Mostrar el propietario de la cuenta y el delegado que envió el correo electrónico**—Los mensajes incluyen las direcciones de correo electrónico del propietario de la cuenta de Gmail y del delegado.
* **Mostrar solo el propietario de la cuenta**—Los mensajes incluyen la dirección de correo electrónico solo del propietario de la cuenta de Gmail. La dirección de correo electrónico del delegado no se incluye.
8. (Opcional) Para permitir que los usuarios añadan un grupo en Grupos como delegado, marca la casilla **Permitir que los usuarios concedan acceso a su buzón a un grupo de Google**.
9. Haz clic en **Guardar**. Si configuraste una unidad organizativa secundaria, es posible que puedas **Heredar** o **Anular** la configuración de una unidad organizativa principal.
10. (Opcional) Para activar la delegación de Gmail para otras unidades organizativas, repite los pasos 3–9.

Los cambios pueden tardar hasta 24 horas, pero generalmente ocurren más rápidamente. [Más información](https://support.google.com/a/answer/7514107)

### Paso 2: Haz que los usuarios configuren delegados para sus cuentas

Después de activar la delegación, tus usuarios van a la configuración de Gmail para asignar delegados. Los delegados pueden leer, enviar y recibir mensajes en nombre del usuario. &#x20;

Para más detalles, dirige a los usuarios a [Delegar y colaborar en correos electrónicos](https://support.google.com/a/users/answer/138350).

</details>

<details>

<summary>Desde un usuario regular, verifica aquí las instrucciones para intentar delegar tu acceso</summary>

(Información copiada [**de la documentación**](https://support.google.com/mail/answer/138350))

Puedes agregar hasta 10 delegados.

Si estás usando Gmail a través de tu trabajo, escuela u otra organización:

* Puedes agregar hasta 1000 delegados dentro de tu organización.
* Con un uso típico, 40 delegados pueden acceder a una cuenta de Gmail al mismo tiempo.&#x20;
* Si utilizas procesos automatizados, como APIs o extensiones de navegador, algunos delegados pueden acceder a una cuenta de Gmail al mismo tiempo.

1. En tu computadora, abre [Gmail](https://mail.google.com/). No puedes agregar delegados desde la aplicación de Gmail.
2. En la esquina superior derecha, haz clic en Configuración ![Configuración](https://lh3.googleusercontent.com/p3J-ZSPOLtuBBR\_ofWTFDfdgAYQgi8mR5c76ie8XQ2wjegk7-yyU5zdRVHKybQgUlQ=w36-h36) ![y luego](https://lh3.googleusercontent.com/3\_l97rr0GvhSP2XV5OoCkV2ZDTIisAOczrSdzNCBxhIKWrjXjHucxNwocghoUa39gw=w36-h36) **Ver todas las configuraciones**.
3. Haz clic en la pestaña **Cuentas e importación** o **Cuentas**.
4. En la sección "Conceder acceso a tu cuenta", haz clic en **Añadir otra cuenta**. Si estás usando Gmail a través de tu trabajo o escuela, tu organización puede restringir la delegación de correos electrónicos. Si no ves esta configuración, contacta a tu administrador.
* Si no ves Conceder acceso a tu cuenta, entonces está restringido.
5.  Ingresa la dirección de correo electrónico de la persona que deseas agregar. Si estás usando Gmail a través de tu trabajo, escuela u otra organización, y tu administrador lo permite, puedes ingresar la dirección de correo electrónico de un grupo. Este grupo debe tener el mismo dominio que tu organización. Los miembros externos del grupo no tienen acceso a la delegación. \
\
**Importante:** Si la cuenta que delegas es una cuenta nueva o se restableció la contraseña, el administrador debe desactivar el requisito de cambiar la contraseña cuando inicies sesión por primera vez.

* [Aprende cómo un administrador puede crear un usuario](https://support.google.com/a/answer/33310).
* [Aprende cómo un administrador puede restablecer contraseñas](https://support.google.com/a/answer/33319).

6\. Haz clic en **Siguiente paso** ![y luego](https://lh3.googleusercontent.com/QbWcYKta5vh\_4-OgUeFmK-JOB0YgLLoGh69P478nE6mKdfpWQniiBabjF7FVoCVXI0g=h36) **Enviar correo electrónico para conceder acceso**.

La persona que agregaste recibirá un correo electrónico pidiéndole que confirme. La invitación caduca después de una semana.

Si agregaste un grupo, todos los miembros del grupo se convertirán en delegados sin necesidad de confirmar.&#x20;

Nota: Puede tardar hasta 24 horas en que la delegación comience a surtir efecto.

</details>

## Persistencia a través de la aplicación de Android

Si tienes una **sesión dentro de la cuenta de Google de las víctimas** puedes navegar a la **Play Store** y podrías ser capaz de **instalar malware** que ya has subido a la tienda directamente **en el teléfono** para mantener la persistencia y acceder al teléfono de las víctimas.

## **Persistencia a través de** Scripts de Aplicaciones

Puedes crear **disparadores basados en el tiempo** en Scripts de Aplicaciones, por lo que si el Script de Aplicación es aceptado por el usuario, se **activará** incluso **sin que el usuario lo acceda**. Para obtener más información sobre cómo hacer esto, consulta:

{% content-ref url="gws-google-platforms-phishing/gws-app-scripts.md" %}
[gws-app-scripts.md](gws-google-platforms-phishing/gws-app-scripts.md)
{% endcontent-ref %}

## Referencias

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch y Beau Bullock - OK Google, How do I Red Team GSuite?

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* ¡Consulta los [**planes de suscripción**](https://github.com/sponsors/carlospolop)!
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**.
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de Github.

</details>
{% endhint %}
