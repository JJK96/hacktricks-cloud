# GWS - 永続性

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、または **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
{% endhint %}

{% hint style="danger" %}
このセクションで言及されているすべての設定変更アクションは、**セキュリティアラートをメールで生成し、アカウントに同期されたモバイルにプッシュ通知を送信**します。
{% endhint %}

## Gmailでの永続性

* Googleからのセキュリティ通知を非表示にするために**フィルタを作成**できます
* `from: (no-reply@accounts.google.com) "Security Alert"`
* これにより、セキュリティメールがメールに届かなくなります（ただし、モバイルへのプッシュ通知は防げません）

<details>

<summary>Gmailフィルタを作成する手順</summary>

（[こちら](https://support.google.com/mail/answer/6579)からの手順）

1. [Gmail](https://mail.google.com/)を開きます。
2. 上部の検索ボックスで、[表示オプションを表示]をクリックします ![photos tune](https://lh3.googleusercontent.com/cD6YR\_YvqXqNKxrWn2NAWkV6tjJtg8vfvqijKT1\_9zVCrl2sAx9jROKhLqiHo2ZDYTE=w36) 。
3. 検索条件を入力します。検索が正しく機能しているか確認するには、[検索]をクリックして表示されるメールを確認してください。
4. 検索ウィンドウの下部で、[フィルタを作成]をクリックします。
5. フィルタの動作を選択します。
6. [フィルタを作成]をクリックします。

現在のフィルタを確認するには（削除するには）、[https://mail.google.com/mail/u/0/#settings/filters](https://mail.google.com/mail/u/0/#settings/filters)を確認してください。

</details>

<figure><img src="../../.gitbook/assets/image (331).png" alt=""><figcaption></figcaption></figure>

* **機密情報を転送するための転送アドレスを作成**できます - 手動アクセスが必要です。
* [https://mail.google.com/mail/u/2/#settings/fwdandpop](https://mail.google.com/mail/u/2/#settings/fwdandpop)で転送アドレスを作成します
* 受信アドレスはこれを確認する必要があります
* 次に、すべてのメールを転送してコピーを保持するように設定します（変更を保存することを忘れないでください）:

<figure><img src="../../.gitbook/assets/image (332).png" alt=""><figcaption></figcaption></figure>

他のメールアドレスに特定のメールのみを転送するためにもフィルタを作成し、転送することが可能です。

## アプリパスワード

**Googleユーザーセッションを侵害**し、ユーザーが**2FA**を持っている場合、[**アプリパスワード**](https://support.google.com/accounts/answer/185833?hl=en)を生成できます（手順を確認するにはリンクを参照）。**AppパスワードはGoogleによって推奨されておらず、ユーザーがGoogleアカウントのパスワードを変更すると取り消されます。**

**オープンセッションがあっても、ユーザーのパスワードを知っている必要があります。**

{% hint style="info" %}
Appパスワードは、**2段階認証が有効になっているアカウントでのみ使用できます。**
{% endhint %}

## 2-FAおよび類似の変更

**2-FAを無効にしたり、新しいデバイス**（または電話番号）を登録することも可能です（[**https://myaccount.google.com/security**](https://myaccount.google.com/security)で行います）。\
**デバイスにセキュリティプッシュ通知が届かないようにするには、ユーザーのスマートフォンからサインアウト**することもできます（それは奇妙なことですが）、ここから再度サインインすることはできません。

**デバイスの場所を特定する**ことも可能です。

**これらの設定を変更するには、オープンセッションがあっても、ユーザーのパスワードを知っている必要があります。**

## OAuthアプリを介した永続性

**ユーザーアカウントを侵害**した場合、**OAuthアプリ**にすべての権限を付与するだけで済みます。唯一の問題は、Workspaceが**未承認の外部および/または内部OAuthアプリを許可しないように構成**されている可能性があることです。\
Workspace組織がデフォルトで外部OAuthアプリを信頼しないことはかなり一般的ですが、内部アプリには信頼しているため、組織内で新しいOAuthアプリケーションを生成する権限がある場合、外部アプリが許可されていない場合は、新しい内部OAuthアプリを生成し、**永続性を維持するためにその新しい内部OAuthアプリを使用**できます。

OAuthアプリに関する詳細情報については、次のページを参照してください：

{% content-ref url="gws-google-platforms-phishing/" %}
[gws-google-platforms-phishing](gws-google-platforms-phishing/)
{% endcontent-ref %}

## 委任による永続性

単に**アカウントを攻撃者が制御する別のアカウントに委任**することができます（これが許可されている場合）。Workspaceの**組織**では、このオプションを**有効にする**必要があります。誰にでも無効にすることができ、一部のユーザー/グループに対して有効にすることもできます（通常、一部のユーザー/グループまたは完全に無効にされています）。

<details>

<summary>Workspace管理者の場合は、この機能を有効にするためにこれを確認してください</summary>

（[ドキュメントからコピー](https://support.google.com/a/answer/7223765)）

たとえば、組織（たとえば、仕事や学校）の管理者として、ユーザーがGmailアカウントへのアクセスを委任できるかどうかを制御します。誰もがアカウントを委任できるようにすることもできます。または、特定の部門の人々だけに委任の設定を許可することもできます。たとえば、次のようにできます：

* 管理アシスタントをGmailアカウントの代理人として追加して、彼らがあなたの代わりにメールを読み取り、送信できるようにします。
* グループ（たとえば、営業部門）を代理人としてGroupsに追加して、すべての人が1つのGmailアカウントにアクセスできるようにします。

ユーザーは、ドメインまたは組織単位に関係なく、同じ組織内の別のユーザーにアクセスを委任できます。

### 委任の制限と制約

* **Googleグループにメールボックスアクセスを許可する**オプション：このオプションを使用するには、委任されたアカウントのOUと各グループメンバーのOUで有効にする必要があります。このオプションが有効にされていないOUに属するグループメンバーは、委任されたアカウントにアクセスできません。
* 通常の使用では、40人の委任ユーザーが同時にGmailアカウントにアクセスできます。1人以上の代理人による平均以上の使用は、この数を減らす可能性があります。
* 頻繁にGmailにアクセスする自動化プロセスは、同時にアカウントにアクセスできる代理人の数を減らす可能性があります。これらのプロセスには、Gmailに頻繁にアクセスするAPIやブラウザ拡張機能が含まれます。
* 1つのGmailアカウントには、最大1,000人のユニークな代理人をサポートします。Groupsのグループは、制限に対する1つの代理人として数えられます。
* 委任は、Gmailアカウントの制限を増やしません。委任されたユーザーのいるGmailアカウントは、標準のGmailアカウントの制限とポリシーを持っています。詳細については、[Gmailの制限とポリシー](https://support.google.com/a/topic/28609)をご覧ください。
### ステップ1: ユーザーのGmail委任を有効にする

**始める前に:** 特定のユーザーに設定を適用するには、彼らのアカウントを[組織単位](https://support.google.com/a/topic/1227584)に配置します。

1. [サインイン](https://admin.google.com/)して[Google管理コンソール](https://support.google.com/a/answer/182076)にアクセスします。

管理者アカウントを使用してサインインし、現在のアカウントCarlosPolop@gmail.comを使用しないでください。
2. 管理コンソールで、メニューに移動し、**アプリ**、**Google Workspace**、**Gmail**、**ユーザー設定**の順に移動します。
3. すべてのユーザーに設定を適用する場合は、トップの組織単位を選択したままにします。それ以外の場合は、子[組織単位](https://support.google.com/a/topic/1227584)を選択します。
4. **メール委任**をクリックします。
5. **ドメイン内の他のユーザーにメールボックスへのアクセスを委任できるようにする**ボックスをチェックします。
6. (オプション) ユーザーが自分のアカウントから送信された委任メッセージに含める送信者情報を指定できるようにするには、**この設定をカスタマイズすることを許可**ボックスをチェックします。
7. 代理人によって送信されたメッセージに含まれるデフォルトの送信者情報のオプションを選択します:
   - **アカウント所有者とメールボックスへのアクセスを委任されたユーザーを表示**—メッセージにはGmailアカウント所有者と代理人のメールアドレスが含まれます。
   - **アカウント所有者のみを表示**—メッセージにはGmailアカウント所有者のメールアドレスのみが含まれます。代理人のメールアドレスは含まれません。
8. (オプション) ユーザーがグループを代理人として追加できるようにするには、**ユーザーがGoogleグループにメールボックスアクセスを許可**ボックスをチェックします。
9. **保存**をクリックします。子組織単位を構成した場合、親組織単位の設定を**継承**または**オーバーライド**することができる場合があります。
10. (オプション) 他の組織単位に対してGmail委任を有効にするには、ステップ3から9を繰り返します。

変更は最大24時間かかる場合がありますが、通常はもっと早く反映されます。[詳細はこちら](https://support.google.com/a/answer/7514107)

### ステップ2: ユーザーにアカウントの委任を設定させる

委任を有効にした後、ユーザーは自分のGmail設定に移動して代理人を割り当てることができます。 代理人はそのユーザーの代わりにメッセージを読み取ったり、送信したり、受信したりできます。

詳細については、ユーザーに[メールの委任と共同作業](https://support.google.com/a/users/answer/138350)を参照するように指示してください。
* **[HackTricks](https://github.com/carlospolop/hacktricks)** および **[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)** のGitHubリポジトリにPRを送信してハッキングのテクニックを共有してください。
