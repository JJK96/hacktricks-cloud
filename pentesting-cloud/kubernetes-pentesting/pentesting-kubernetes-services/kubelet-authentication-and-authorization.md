# Kubelet身份验证与授权

{% hint style="success" %}
学习并实践AWS黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks培训AWS红队专家（ARTE）**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并实践GCP黑客技术：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks培训GCP红队专家（GRTE）**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持HackTricks</summary>

* 检查[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享黑客技巧。

</details>
{% endhint %}

## Kubelet身份验证 <a href="#kubelet-authentication" id="kubelet-authentication"></a>

**[来自文档：](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)**

默认情况下，对kubelet的HTTPS端点的请求如果未被其他配置的身份验证方法拒绝，则被视为匿名请求，并被赋予**用户名为`system:anonymous`**和**组为`system:unauthenticated`**。

有**3**种身份验证**方法**：

* **匿名**（默认）：使用设置参数**`--anonymous-auth=true`或配置：**
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: 这将**启用** kubectl **API 令牌**作为授权（任何有效令牌都将有效）。允许它使用：
* 确保在 API 服务器中启用了 `authentication.k8s.io/v1beta1` API 组
* 使用以下设置启动 kubelet：**`--authentication-token-webhook`** 和 **`--kubeconfig`** 标志或使用以下设置：
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
kubelet调用配置的API服务器上的**`TokenReview` API**来**确定用户信息**，从持有者令牌中获取
{% endhint %}

* **X509客户端证书：**允许通过X509客户端证书进行身份验证
* 有关更多详细信息，请参阅[apiserver身份验证文档](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs)
* 使用`--client-ca-file`标志启动kubelet，提供CA捆绑包以验证客户端证书。或者使用以下配置：
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Kubelet授权 <a href="#kubelet-authentication" id="kubelet-authentication"></a>

任何成功认证的请求（包括匿名请求）**随后将被授权**。**默认**授权模式是**`AlwaysAllow`**，**允许所有请求**。

然而，另一个可能的值是**`webhook`**（这是您**大多数情况下会发现的**）。这种模式将**检查经过认证的用户的权限**以允许或拒绝一个操作。

{% hint style="warning" %}
请注意，即使**启用了匿名认证**，**匿名访问**可能**没有任何权限**执行任何操作。
{% endhint %}

通过webhook进行授权可以使用**参数 `--authorization-mode=Webhook`**进行配置，或者通过配置文件：
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
kubelet调用配置的API服务器上的**`SubjectAccessReview`** API来**确定**每个请求是否**被授权**。

kubelet使用与apiserver相同的[请求属性](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes)方法来授权API请求：

* **操作**

| HTTP动词 | 请求动词                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get（用于单个资源），list（用于集合，包括完整对象内容），watch（用于监视单个资源或资源集合） |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete（用于单个资源），deletecollection（用于集合）                                                                                         |

* 与Kubelet API通信的**资源**始终为**nodes**，**子资源**根据传入请求的路径**确定**：

| Kubelet API  | 资源 | 子资源 |
| ------------ | -------- | ----------- |
| /stats/\*    | nodes    | stats       |
| /metrics/\*  | nodes    | metrics     |
| /logs/\*     | nodes    | log         |
| /spec/\*     | nodes    | spec        |
| _所有其他_ | nodes    | proxy       |

例如，以下请求尝试未经授权访问kubelet的pods信息：
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* 我们收到了一个**Forbidden**，所以请求**通过了身份验证检查**。如果没有通过，我们将只会收到一个`未经授权`的消息。
* 我们可以看到**用户名**（在这种情况下是从令牌中获取的）
* 检查**资源**是如何**节点**和**子资源**是**代理**（这与先前的信息相符）

## 参考

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

{% hint style="success" %}
学习并练习AWS黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks培训AWS红队专家（ARTE）**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习GCP黑客技术：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks培训GCP红队专家（GRTE）**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持HackTricks</summary>

* 检查[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享黑客技巧。

</details>
{% endhint %}
