# Authentification et autorisation de Kubelet

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Authentification de Kubelet <a href="#kubelet-authentication" id="kubelet-authentication"></a>

**[√Ä partir de la documentation :](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)**

Par d√©faut, les requ√™tes vers l'endpoint HTTPS de Kubelet qui ne sont pas rejet√©es par d'autres m√©thodes d'authentification configur√©es sont trait√©es comme des requ√™tes anonymes et re√ßoivent un **nom d'utilisateur `system:anonymous`** et un **groupe `system:unauthenticated`**.

Les **3** m√©thodes d'authentification sont :

* **Anonyme** (par d√©faut) : Utilisez le param√®tre **`--anonymous-auth=true` ou la configuration :**
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: Cela **activera** les jetons d'**API bearer** de kubectl comme autorisation (tout jeton valide sera accept√©). Autorisez-le avec :
* assurez-vous que le groupe d'API `authentication.k8s.io/v1beta1` est activ√© dans le serveur API
* d√©marrez le kubelet avec les drapeaux **`--authentication-token-webhook`** et **`--kubeconfig`** ou utilisez le param√©trage suivant :
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
Le kubelet appelle l'API **`TokenReview`** sur le serveur API configur√© pour **d√©terminer les informations utilisateur** √† partir des jetons de porteur
{% endhint %}

* **Certificats client X509 :** Permettent de s'authentifier via des certificats client X509
* consultez la [documentation sur l'authentification de l'apiserver](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs) pour plus de d√©tails
* d√©marrez le kubelet avec le drapeau `--client-ca-file`, en fournissant un bundle CA pour v√©rifier les certificats clients. Ou avec la configuration :
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Autorisation de Kubelet <a href="#kubelet-authentication" id="kubelet-authentication"></a>

Toute demande qui est authentifi√©e avec succ√®s (y compris une demande anonyme) **est ensuite autoris√©e**. Le mode d'autorisation **par d√©faut** est **`AlwaysAllow`**, qui **autorise toutes les demandes**.

Cependant, l'autre valeur possible est **`webhook`** (ce que vous trouverez **principalement**). Ce mode **v√©rifiera les autorisations de l'utilisateur authentifi√©** pour autoriser ou refuser une action.

{% hint style="warning" %}
Notez que m√™me si l'**authentification anonyme est activ√©e**, l'**acc√®s anonyme** pourrait **ne pas avoir les autorisations** pour effectuer une action.
{% endhint %}

L'autorisation via webhook peut √™tre configur√©e en utilisant le **param√®tre `--authorization-mode=Webhook`** ou via le fichier de configuration avec :
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
Le kubelet appelle l'API **`SubjectAccessReview`** sur le serveur API configur√© pour **d√©terminer** si chaque requ√™te est **autoris√©e.**

Le kubelet autorise les requ√™tes API en utilisant la m√™me approche des [attributs de requ√™te](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes) que l'apiserver :

* **Action**

| Verbe HTTP | verbe de requ√™te                                                                                                                                              |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST       | create                                                                                                                                                        |
| GET, HEAD  | get (pour les ressources individuelles), list (pour les collections, y compris le contenu complet de l'objet), watch (pour surveiller une ressource individuelle ou une collection de ressources) |
| PUT        | update                                                                                                                                                        |
| PATCH      | patch                                                                                                                                                         |
| DELETE     | delete (pour les ressources individuelles), deletecollection (pour les collections)                                                                           |

* La **ressource** interagissant avec l'API Kubelet est **toujours** **nodes** et le **sous-ressource** est **d√©termin√©e** √† partir du chemin de la requ√™te entrante :

| API Kubelet | ressource | sous-ressource |
| ----------- | --------- | ------------- |
| /stats/\*   | nodes     | stats         |
| /metrics/\* | nodes     | metrics       |
| /logs/\*    | nodes     | log           |
| /spec/\*    | nodes     | spec          |
| _tous les autres_ | nodes | proxy       |

Par exemple, la requ√™te suivante a tent√© d'acc√©der aux informations des pods du kubelet sans permission :
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* Nous avons re√ßu un **Interdit**, donc la requ√™te a **pass√© la v√©rification d'authentification**. Sinon, nous aurions simplement re√ßu un message `Non autoris√©`.
* Nous pouvons voir le **nom d'utilisateur** (dans ce cas √† partir du jeton)
* V√©rifiez comment la **ressource** √©tait **nodes** et la **sous-ressource** **proxy** (ce qui est logique avec les informations pr√©c√©dentes)

## R√©f√©rences

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}
