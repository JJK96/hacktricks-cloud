# Autentica√ß√£o e Autoriza√ß√£o do Kubelet

{% hint style="success" %}
Aprenda e pratique Hacking na AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking na GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Autentica√ß√£o do Kubelet <a href="#kubelet-authentication" id="kubelet-authentication"></a>

**[Da documenta√ß√£o:](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)**

Por padr√£o, solicita√ß√µes ao endpoint HTTPS do kubelet que n√£o s√£o rejeitadas por outros m√©todos de autentica√ß√£o configurados s√£o tratadas como solicita√ß√µes an√¥nimas e recebem um **nome de usu√°rio `system:anonymous`** e um **grupo `system:unauthenticated`**.

Os **3** m√©todos de autentica√ß√£o s√£o:

* **An√¥nimo** (padr√£o): Use a configura√ß√£o definindo o par√¢metro **`--anonymous-auth=true` ou a configura√ß√£o:**
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: Isso ir√° **habilitar** os **tokens de portador da API kubectl** como autoriza√ß√£o (qualquer token v√°lido ser√° v√°lido). Permita com:
* garantir que o grupo de API `authentication.k8s.io/v1beta1` esteja habilitado no servidor de API
* iniciar o kubelet com as flags **`--authentication-token-webhook`** e **`--kubeconfig`** ou usar a seguinte configura√ß√£o:
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
O kubelet chama a API **`TokenReview`** no servidor API configurado para **determinar informa√ß√µes do usu√°rio** a partir de tokens de portador
{% endhint %}

* **Certificados de cliente X509:** Permitem autenticar via certificados de cliente X509
* consulte a [documenta√ß√£o de autentica√ß√£o do apiserver](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs) para mais detalhes
* inicie o kubelet com a flag `--client-ca-file`, fornecendo um pacote CA para verificar os certificados de cliente. Ou com a configura√ß√£o:
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Autoriza√ß√£o do Kubelet <a href="#kubelet-authentication" id="kubelet-authentication"></a>

Qualquer solicita√ß√£o que seja autenticada com sucesso (incluindo uma solicita√ß√£o an√¥nima) **√© ent√£o autorizada**. O modo de autoriza√ß√£o **padr√£o** √© **`AlwaysAllow`**, que **permite todas as solicita√ß√µes**.

No entanto, o outro valor poss√≠vel √© **`webhook`** (que √© o que voc√™ **encontrar√° principalmente por a√≠**). Este modo ir√° **verificar as permiss√µes do usu√°rio autenticado** para permitir ou negar uma a√ß√£o.

{% hint style="warning" %}
Observe que mesmo que a **autentica√ß√£o an√¥nima esteja habilitada**, o **acesso an√¥nimo** pode **n√£o ter permiss√µes** para realizar qualquer a√ß√£o.
{% endhint %}

A autoriza√ß√£o via webhook pode ser configurada usando o **par√¢metro `--authorization-mode=Webhook`** ou via o arquivo de configura√ß√£o com:
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
O kubelet chama a API **`SubjectAccessReview`** no servidor API configurado para **determinar** se cada solicita√ß√£o √© **autorizada**.

O kubelet autoriza solicita√ß√µes de API usando a mesma abordagem de [atributos de solicita√ß√£o](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes) que o apiserver:

* **A√ß√£o**

| Verbo HTTP | verbo de solicita√ß√£o                                                                                                                                         |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST       | create                                                                                                                                                        |
| GET, HEAD  | get (para recursos individuais), list (para cole√ß√µes, incluindo conte√∫do completo do objeto), watch (para observar um recurso individual ou cole√ß√£o de recursos) |
| PUT        | update                                                                                                                                                        |
| PATCH      | patch                                                                                                                                                         |
| DELETE     | delete (para recursos individuais), deletecollection (para cole√ß√µes)                                                                                         |

* O **recurso** que se comunica com a API do Kubelet √© **sempre** **nodes** e o **subrecurso** √© **determinado** a partir do caminho da solicita√ß√£o recebida:

| API do Kubelet | recurso | subrecurso |
| -------------- | ------- | ---------- |
| /stats/\*      | nodes   | stats      |
| /metrics/\*    | nodes   | metrics    |
| /logs/\*       | nodes   | log        |
| /spec/\*       | nodes   | spec       |
| _todos os outros_ | nodes | proxy      |

Por exemplo, a seguinte solicita√ß√£o tentou acessar as informa√ß√µes dos pods do kubelet sem permiss√£o:
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* Recebemos um **Proibido**, ent√£o a solicita√ß√£o **passou na verifica√ß√£o de Autentica√ß√£o**. Caso contr√°rio, ter√≠amos recebido apenas uma mensagem `N√£o autorizado`.
* Podemos ver o **nome de usu√°rio** (neste caso, do token)
* Verifique como o **recurso** era **nodes** e o **subrecurso** **proxy** (o que faz sentido com as informa√ß√µes anteriores)

## Refer√™ncias

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
