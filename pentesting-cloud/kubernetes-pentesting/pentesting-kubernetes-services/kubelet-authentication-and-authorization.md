# Kubelet 認証 & 認可

{% hint style="success" %}
AWS ハッキングの学習と実践:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP ハッキングの学習と実践: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks のサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に参加するか、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** をフォローする。**
* ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出する。

</details>
{% endhint %}

## Kubelet 認証 <a href="#kubelet-authentication" id="kubelet-authentication"></a>

**[ドキュメントから:](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)**

デフォルトでは、他の構成された認証方法で拒否されない kubelet の HTTPS エンドポイントへのリクエストは匿名リクエストとして扱われ、**ユーザー名が `system:anonymous`** で、**グループが `system:unauthenticated`** として与えられます。

認証方法は **3** つあります:

* **匿名** (デフォルト): パラメータ **`--anonymous-auth=true` を設定するか、設定ファイルを使用します:
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: これにより、kubectl **APIベアラートークン**を認証として**有効に**します（有効なトークンはすべて有効です）。次のように許可します：
* APIサーバーで`authentication.k8s.io/v1beta1` APIグループが有効になっていることを確認します
* kubeletを**`--authentication-token-webhook`**および**`--kubeconfig`**フラグで起動するか、次の設定を使用します：
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
kubeletは、構成されたAPIサーバー上で**`TokenReview` API**を呼び出して、ベアラートークンから**ユーザー情報を決定**します。
{% endhint %}

* **X509クライアント証明書:** X509クライアント証明書を使用して認証を許可します
* 詳細については、[apiserver認証ドキュメント](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs)を参照してください
* `--client-ca-file`フラグを使用して、クライアント証明書を検証するためのCAバンドルを提供してkubeletを起動します。または、次の構成で開始します:
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Kubeletの認可 <a href="#kubelet-authentication" id="kubelet-authentication"></a>

**正常に認証された**すべてのリクエスト（匿名リクエストを含む）**はその後認可されます**。**デフォルト**の認可モードは**`AlwaysAllow`**で、**すべてのリクエストを許可**します。

ただし、他の可能な値は**`webhook`**です（**ほとんどの場所で見つけることができる**ものです）。このモードでは、**認証されたユーザーの権限をチェック**して、アクションを許可または拒否します。

{% hint style="warning" %}
**匿名認証が有効**になっていても、**匿名アクセス**はアクションを実行するための**権限を持っていない**可能性があります。
{% endhint %}

Webhookを介した認可は、**`--authorization-mode=Webhook`**パラメータを使用するか、次のように構成ファイルを介して行うことができます：
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
kubeletは、各リクエストが**認可**されているかを判断するために、設定されたAPIサーバー上で**`SubjectAccessReview`** APIを呼び出します。

kubeletは、APIリクエストを認可する際に、apiserverと同じ[リクエスト属性](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes)アプローチを使用します:

* **アクション**

| HTTP動詞 | リクエスト動詞                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get (個々のリソース用), list (コレクション用、完全なオブジェクトコンテンツを含む), watch (個々のリソースまたはリソースコレクションを監視するため) |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete (個々のリソース用), deletecollection (コレクション用)                                                                                         |

* Kubelet APIにアクセスする**リソース**は常に**nodes**であり、**サブリソース**は着信リクエストのパスから**決定**されます:

| Kubelet API  | リソース | サブリソース |
| ------------ | -------- | ----------- |
| /stats/\*    | nodes    | stats       |
| /metrics/\*  | nodes    | metrics     |
| /logs/\*     | nodes    | log         |
| /spec/\*     | nodes    | spec        |
| その他すべて | nodes    | proxy       |

たとえば、次のリクエストは、許可なくkubeletのポッド情報にアクセスしようとしました:
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* 私たちは**Forbidden**を受け取ったので、リクエストは**認証チェックをパスしました**。そうでなければ、単に`Unauthorised`メッセージを受け取っていたでしょう。
* **ユーザー名**（この場合はトークンから）
* **リソース**が**nodes**であり、**サブリソース**が**proxy**であることを確認します（前の情報と一致します）

## 参考文献

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

{% hint style="success" %}
AWSハッキングの学習と実践：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と実践：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**購読プラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加**するか、[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して**ハッキングトリックを共有**してください。

</details>
{% endhint %}
