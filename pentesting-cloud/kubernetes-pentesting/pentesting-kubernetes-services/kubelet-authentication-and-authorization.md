# Autenticazione e Autorizzazione di Kubelet

{% hint style="success" %}
Impara e pratica l'Hacking su AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di Github.

</details>
{% endhint %}

## Autenticazione di Kubelet <a href="#kubelet-authentication" id="kubelet-authentication"></a>

**[Dalla documentazione:](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)**

Per impostazione predefinita, le richieste all'endpoint HTTPS di kubelet che non vengono respinte da altri metodi di autenticazione configurati sono trattate come richieste anonime e vengono assegnati un **username di `system:anonymous`** e un **gruppo di `system:unauthenticated`**.

I **3** metodi di autenticazione sono:

* **Anonimo** (predefinito): Usare l'impostazione del parametro **`--anonymous-auth=true` o la configurazione:**
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: Questo abiliter√† i **token bearer API di kubectl** come autorizzazione (qualsiasi token valido sar√† accettato). Consentilo con:
* assicurati che il gruppo API `authentication.k8s.io/v1beta1` sia abilitato nel server API
* avvia il kubelet con i flag **`--authentication-token-webhook`** e **`--kubeconfig`** o utilizza l'impostazione seguente:
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
Il kubelet chiama l'API **`TokenReview`** sul server API configurato per **determinare le informazioni dell'utente** dai token bearer
{% endhint %}

* **Certificati client X509:** Consentono di autenticarsi tramite certificati client X509
* consultare la [documentazione sull'autenticazione dell'apiserver](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs) per ulteriori dettagli
* avviare il kubelet con il flag `--client-ca-file`, fornendo un bundle CA per verificare i certificati client. Oppure con la configurazione:
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Autorizzazione di Kubelet <a href="#kubelet-authentication" id="kubelet-authentication"></a>

Qualsiasi richiesta che viene autenticata con successo (inclusa una richiesta anonima) **viene quindi autorizzata**. La modalit√† di autorizzazione **predefinita** √® **`AlwaysAllow`**, che **permette tutte le richieste**.

Tuttavia, l'altro valore possibile √® **`webhook`** (che √® quello che **troverai principalmente**). Questa modalit√† **verificher√† i permessi dell'utente autenticato** per consentire o negare un'azione.

{% hint style="warning" %}
Nota che anche se l'**autenticazione anonima √® abilitata**, l'**accesso anonimo** potrebbe **non avere nessun permesso** per eseguire alcuna azione.
{% endhint %}

L'autorizzazione tramite webhook pu√≤ essere configurata utilizzando il **parametro `--authorization-mode=Webhook`** o tramite il file di configurazione con:
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
Il kubelet chiama l'API **`SubjectAccessReview`** sul server API configurato per **determinare** se ogni richiesta √® **autorizzata**.

Il kubelet autorizza le richieste API utilizzando lo stesso approccio degli [attributi della richiesta](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes) come l'apiserver:

* **Azione**

| Verbo HTTP | verbo della richiesta                                                                                                                                        |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST       | create                                                                                                                                                        |
| GET, HEAD  | get (per risorse individuali), list (per raccolte, inclusi i contenuti completi degli oggetti), watch (per osservare una risorsa individuale o una raccolta di risorse) |
| PUT        | update                                                                                                                                                        |
| PATCH      | patch                                                                                                                                                         |
| DELETE     | delete (per risorse individuali), deletecollection (per raccolte)                                                                                         |

* La **risorsa** che parla con l'API Kubelet √® **sempre** **nodes** e la **sotto-risorsa** √® **determinata** dal percorso della richiesta in arrivo:

| API Kubelet | risorsa | sotto-risorsa |
| ----------- | ------- | ------------- |
| /stats/\*   | nodes   | stats        |
| /metrics/\* | nodes   | metrics      |
| /logs/\*    | nodes   | log          |
| /spec/\*    | nodes   | spec         |
| _tutti gli altri_ | nodes   | proxy        |

Ad esempio, la seguente richiesta ha cercato di accedere alle informazioni sui pod del kubelet senza autorizzazione:
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* Abbiamo ricevuto un **Vietato**, quindi la richiesta **ha superato il controllo di autenticazione**. In caso contrario, avremmo ricevuto solo un messaggio `Non autorizzato`.
* Possiamo vedere lo **username** (in questo caso dal token)
* Controlla come la **risorsa** era **nodi** e la **sotto-risorsa** **proxy** (che ha senso con le informazioni precedenti)

## Riferimenti

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

{% hint style="success" %}
Impara e pratica l'Hacking su AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
