---
description: >-
  このページでは、クラスターにtektonがインストールされており、ネームスペースを作成できる（編集権限がある場合もあります）という前提で特権昇格シナリオを示しています。
---

# OpenShift - Tekton

**このページの元の著者は** [**Haroun**](https://www.linkedin.com/in/haroun-al-mounayar-571830211)

### tektonとは

ドキュメントによると：_Tektonは、クラウドプロバイダーやオンプレミスシステム上で開発者がビルド、テスト、展開できる強力で柔軟なオープンソースフレームワークであるCI/CDシステムを作成するためのものです。_ JenkinsとTektonの両方は、アプリケーションのテスト、ビルド、展開に使用できますが、TektonはCloud Nativeです。

Tektonでは、すべてがYAMLファイルで表現されます。開発者は`Pipelines`というタイプのカスタムリソース（CR）を作成し、それらで実行したい複数の`Tasks`を指定できます。Pipelineを実行するには、`PipelineRun`というタイプのリソースを作成する必要があります。

Tektonがインストールされると、各ネームスペースに`pipeline`という名前のサービスアカウント（sa）が作成されます。Pipelineが実行されると、このsaを使用してYAMLファイルで定義されたタスクを実行するために`pipeline`という名前のポッドが生成されます。

{% embed url="https://tekton.dev/docs/getting-started/pipelines/" %}
Pipelinesに関するTektonドキュメント
{% endembed %}

### Pipelineサービスアカウントの機能

デフォルトでは、pipelineサービスアカウントは`pipelines-scc`機能を使用できます。これは、tektonのグローバルデフォルト構成によるものです。実際、tektonのグローバル構成も`TektonConfig`というopenshiftオブジェクト内のYAMLであり、クラスターにいくつかのリーダーロールがある場合に表示できます。
```yaml
apiVersion: operator.tekton.dev/v1alpha1
kind: TektonConfig
metadata:
name: config
spec:
...
...
platforms:
openshift:
scc:
default: "pipelines-scc"
```
### ミスコンフィグ

問題は、パイプラインサービスアカウントが使用できるデフォルトのsccがユーザーによって制御可能であることです。これは、ネームスペース定義内のラベルを使用して行うことができます。たとえば、次のyaml定義を持つネームスペースを作成できる場合:
```yaml
apiVersion: v1
kind: Namespace
metadata:
name: test-namespace
annotations:
operator.tekton.dev/scc: privileged
```
### 修正

Tektonのドキュメントによると、`TektonConfig`オブジェクトにラベルを追加することで、sccのオーバーライドを制限する方法が記載されています。

{% embed url="https://tekton.dev/docs/operator/sccconfig/" %}
sccに関するTektonのドキュメント
{% endembed %}

このラベルは`max-allowed`と呼ばれます。
```yaml
apiVersion: operator.tekton.dev/v1alpha1
kind: TektonConfig
metadata:
name: config
spec:
...
...
platforms:
openshift:
scc:
default: "restricted-v2"
maxAllowed: "privileged"
```

