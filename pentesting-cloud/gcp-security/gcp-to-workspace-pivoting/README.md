# GCP <--> Workspace Pivoting

{% hint style="success" %}
Lernen Sie & √ºben Sie AWS-Hacking: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie & √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys einreichen.

</details>
{% endhint %}

## **Von GCP zu GWS**

### **Grundlagen der bereichsweiten Delegation**

Die bereichsweite Delegation von Google Workspace erm√∂glicht es einem Identit√§tsobjekt, entweder einer **externen App** aus dem Google Workspace Marketplace oder einem internen **GCP-Servicekonto**, **Daten im gesamten Workspace im Namen von Benutzern abzurufen**.

{% hint style="info" %}
Dies bedeutet im Wesentlichen, dass **Servicekonten** innerhalb von GCP-Projekten einer Organisation in der Lage sein k√∂nnten, **Workspace-Benutzer** derselben Organisation (oder sogar einer anderen) zu **imitieren**.
{% endhint %}

F√ºr weitere Informationen dar√ºber, wie dies genau funktioniert, siehe:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Kompromittierung einer bestehenden Delegation

Wenn ein Angreifer **einen gewissen Zugriff auf GCP kompromittiert** hat und die E-Mail-Adresse eines g√ºltigen Workspace-Benutzers kennt (vorzugsweise **Super-Admin**) des Unternehmens, k√∂nnte er **alle Projekte auflisten**, auf die er Zugriff hat, **alle SAs der Projekte auflisten**, √ºberpr√ºfen, auf welche **Servicekonten er Zugriff hat**, und **alle diese Schritte mit jedem SA wiederholen** kann er imitieren.\
Mit einer **Liste aller Servicekonten**, auf die er **Zugriff** hat, und der Liste der **Workspace-E-Mails** k√∂nnte der Angreifer versuchen, **jeden Benutzer mit jedem Servicekonto zu imitieren**.

{% hint style="danger" %}
Beachten Sie, dass bei der Konfiguration der bereichsweiten Delegation kein Workspace-Benutzer erforderlich ist. Daher reicht es aus, **einen g√ºltigen Benutzer zu kennen, um die Imitation durchzuf√ºhren**.\
Die **Berechtigungen des imitierten Benutzers werden jedoch verwendet**, sodass Sie bei einem Super-Admin auf alles zugreifen k√∂nnen. Wenn er keine Berechtigungen hat, ist dies nutzlos.
{% endhint %}

#### [GCP Delegations-Token generieren](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

Dieses einfache Skript wird **ein OAuth-Token als der delegierte Benutzer generieren**, den Sie dann verwenden k√∂nnen, um auf andere Google APIs zuzugreifen, mit oder ohne `gcloud`:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Dies ist ein Tool, das den Angriff gem√§√ü dieser Schritte durchf√ºhren kann:

1. **Aufz√§hlen von GCP-Projekten** unter Verwendung der Resource Manager API.
2. Iterieren Sie √ºber jeden Projektressourcen und **z√§hlen Sie GCP-Servicekontenressourcen auf**, auf die der anf√§ngliche IAM-Benutzer Zugriff hat, unter Verwendung von _GetIAMPolicy_.
3. Iterieren Sie √ºber **jede Servicekonto-Rolle** und finden Sie eingebaute, grundlegende und benutzerdefinierte Rollen mit der Berechtigung _**serviceAccountKeys.create**_ auf der Ziel-Servicekonto-Ressource. Es sollte beachtet werden, dass die Editor-Rolle diese Berechtigung von Natur aus besitzt.
4. Erstellen Sie einen **neuen privaten Schl√ºssel `KEY_ALG_RSA_2048`** f√ºr jede Servicekonto-Ressource, die mit der relevanten Berechtigung in der IAM-Richtlinie gefunden wurde.
5. Iterieren Sie √ºber **jedes neue Servicekonto und erstellen Sie ein `JWT`-Objekt** daf√ºr, das aus den SA-privaten Schl√ºsselinformationen und einem OAuth-Bereich besteht. Der Prozess der Erstellung eines neuen _JWT_-Objekts wird **alle vorhandenen Kombinationen von OAuth-Bereichen** aus der Liste **oauth\_scopes.txt** durchlaufen, um alle Delegierungsm√∂glichkeiten zu finden. Die Liste **oauth\_scopes.txt** wird mit allen von uns als relevant f√ºr den Missbrauch von Workspace-Identit√§ten gefundenen OAuth-Bereichen aktualisiert.
6. Die Methode `_make_authorization_grant_assertion` zeigt die Notwendigkeit auf, einen **Ziel-Workspace-Benutzer** zu deklarieren, der als _subject_ bezeichnet wird, um JWTs unter DWD zu generieren. Obwohl dies zun√§chst einen spezifischen Benutzer zu erfordern scheint, ist es wichtig zu erkennen, dass **DWD jede Identit√§t innerhalb einer Dom√§ne beeinflusst**. Folglich beeinflusst das Erstellen eines JWT f√ºr **einen beliebigen Dom√§nenbenutzer** alle Identit√§ten in dieser Dom√§ne, im Einklang mit unserer Kombinationsaufz√§hlungspr√ºfung. Einfach ausgedr√ºckt, ist ein g√ºltiger Workspace-Benutzer ausreichend, um fortzufahren.\
Dieser Benutzer kann in der _config.yaml_ Datei von DeleFriend definiert werden. Wenn ein Ziel-Workspace-Benutzer noch nicht bekannt ist, erleichtert das Tool die automatische Identifizierung g√ºltiger Workspace-Benutzer durch Scannen von Dom√§nenbenutzern mit Rollen in GCP-Projekten. Es ist wichtig zu beachten (erneut), dass JWTs dom√§nenspezifisch sind und nicht f√ºr jeden Benutzer generiert werden; daher zielt der automatische Prozess auf eine einzelne eindeutige Identit√§t pro Dom√§ne ab.
7. **Aufz√§hlen und Erstellen eines neuen Bearer-Zugriffstokens** f√ºr jedes JWT und Validieren des Tokens gegen die tokeninfo API.

#### [Gitlab's Python-Skript](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab hat [dieses Python-Skript](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) erstellt, das zwei Dinge tun kann - das Benutzerverzeichnis auflisten und ein neues Administratorkonto erstellen, w√§hrend ein JSON mit SA-Anmeldeinformationen und dem zu imitierenden Benutzer angegeben wird. So verwenden Sie es:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Erstellen einer neuen Delegation (Persistenz)

Es ist m√∂glich, **Domain-weite Delegationen unter** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)** zu √ºberpr√ºfen**.

Ein Angreifer mit der F√§higkeit, **Service-Konten in einem GCP-Projekt zu erstellen** und **Super-Admin-Berechtigungen f√ºr GWS zu haben, k√∂nnte eine neue Delegation erstellen, die es Service-Konten erm√∂glicht, einige GWS-Benutzer zu impersonieren**:

1. **Generierung eines neuen Service-Kontos und entsprechendes Schl√ºsselpaar:** Auf GCP k√∂nnen neue Ressourcen f√ºr Service-Konten entweder interaktiv √ºber die Konsole oder programmgesteuert √ºber direkte API-Aufrufe und CLI-Tools erstellt werden. Hierf√ºr sind die **Rolle `iam.serviceAccountAdmin`** oder eine benutzerdefinierte Rolle mit der Berechtigung **`iam.serviceAccounts.create`** erforderlich. Sobald das Service-Konto erstellt ist, werden wir fortfahren, ein **zugeh√∂riges Schl√ºsselpaar zu generieren** (**Berechtigung `iam.serviceAccountKeys.create`**).
2. **Erstellung einer neuen Delegation**: Es ist wichtig zu verstehen, dass **nur die Rolle des Super-Admins die F√§higkeit besitzt, eine globale Domain-weite Delegation in Google Workspace einzurichten** und Domain-weite Delegation **nicht programmgesteuert eingerichtet werden kann**. Sie kann nur **manuell** √ºber die Google Workspace **Konsole** erstellt und angepasst werden.
* Die Erstellung der Regel findet sich auf der Seite **API-Steuerungen ‚Üí Verwalten der Domain-weiten Delegation in der Google Workspace Admin-Konsole**.
3. **Anh√§ngen der Berechtigung f√ºr OAuth-Bereiche**: Bei der Konfiguration einer neuen Delegation erfordert Google nur 2 Parameter, die Client-ID, die die **OAuth-ID des GCP-Service-Konto**-Ressource ist, und **OAuth-Bereiche**, die definieren, welche API-Aufrufe die Delegation erfordert.
* Die **vollst√§ndige Liste der OAuth-Bereiche** finden Sie [**hier**](https://developers.google.com/identity/protocols/oauth2/scopes), aber hier ist eine Empfehlung: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **Handeln im Namen der Zielidentit√§t:** Zu diesem Zeitpunkt haben wir ein funktionierendes delegiertes Objekt in GWS. Jetzt k√∂nnen wir **unter Verwendung des privaten Schl√ºssels des GCP-Service-Kontos API-Aufrufe** (im Umfang, der im OAuth-Bereichsparameter definiert ist) durchf√ºhren, um es auszul√∂sen und **im Namen einer beliebigen Identit√§t, die in Google Workspace existiert, zu handeln**. Wie wir gelernt haben, wird das Service-Konto Zugriffstoken gem√§√ü seinen Anforderungen generieren und gem√§√ü den Berechtigungen, die es f√ºr REST-API-Anwendungen hat, handeln.
* √úberpr√ºfen Sie den **vorherigen Abschnitt** f√ºr einige **Tools**, um diese Delegation zu verwenden.

#### Delegation zwischen Organisationen

Die OAuth-SA-ID ist global und kann f√ºr **delegierte Handlungen zwischen Organisationen** verwendet werden. Es wurden keine Einschr√§nkungen implementiert, um eine globale Delegation zu verhindern. Einfach ausgedr√ºckt k√∂nnen **Service-Konten aus verschiedenen GCP-Organisationen verwendet werden, um domainweite Delegationen in anderen Workspace-Organisationen zu konfigurieren**. Dies w√ºrde dazu f√ºhren, dass **nur der Zugriff eines Super-Admins auf Workspace erforderlich ist**, und nicht der Zugriff auf dasselbe GCP-Konto, da der Angreifer Service-Konten und private Schl√ºssel in seinem pers√∂nlich kontrollierten GCP-Konto erstellen kann.

### Erstellen eines Projekts zur Auflistung von Workspace

Standardm√§√üig haben **Workspace-Benutzer** die Berechtigung, **neue Projekte zu erstellen**, und wenn ein neues Projekt erstellt wird, erh√§lt der **Ersteller die Eigent√ºmerrolle** dar√ºber.

Daher kann ein Benutzer ein Projekt erstellen, die **APIs aktivieren**, um Workspace in seinem neuen Projekt aufzulisten und versuchen, dies zu **auflisten**.

{% hint style="danger" %}
Damit ein Benutzer Workspace auflisten kann, ben√∂tigt er auch ausreichende Workspace-Berechtigungen (nicht jeder Benutzer wird in der Lage sein, das Verzeichnis aufzulisten).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

√úberpr√ºfen Sie **weitere Enumerationen in**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Ausnutzen von Gcloud

Weitere Informationen zum `gcloud`-Ablauf zur Anmeldung finden Sie unter:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Wie dort erkl√§rt, kann gcloud den Bereich `https://www.googleapis.com/auth/drive` anfordern, der einem Benutzer den Zugriff auf das Laufwerk des Benutzers erm√∂glichen w√ºrde.\
Als Angreifer k√∂nnten Sie, wenn Sie den Computer eines Benutzers **physisch kompromittiert** haben und der **Benutzer immer noch mit seinem Konto angemeldet ist**, sich anmelden und ein Token generieren, das Zugriff auf das Laufwerk gew√§hrt, indem Sie:
```bash
gcloud auth login --enable-gdrive-access
```
Wenn ein Angreifer den Computer eines Benutzers kompromittiert, k√∂nnte er auch die Datei `google-cloud-sdk/lib/googlecloudsdk/core/config.py` √§ndern und im **`CLOUDSDK_SCOPES`** den Scope **`'https://www.googleapis.com/auth/drive'`** hinzuf√ºgen:

<figure><img src="../../../.gitbook/assets/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Daher wird beim n√§chsten Mal, wenn sich der Benutzer anmeldet, ein **Token mit Zugriff auf Drive erstellt**, den der Angreifer missbrauchen k√∂nnte, um auf das Laufwerk zuzugreifen. Offensichtlich wird der Browser anzeigen, dass das generierte Token Zugriff auf Drive haben wird, aber da der Benutzer sich selbst mit **`gcloud auth login`** authentifizieren wird, wird er wahrscheinlich **nichts Verd√§chtiges vermuten.**

Um Drive-Dateien aufzulisten: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## Von GWS zu GCP

### Zugriff auf privilegierte GCP-Benutzer

Wenn ein Angreifer vollst√§ndigen Zugriff auf GWS hat, kann er auf Gruppen mit privilegiertem Zugriff auf GCP oder sogar Benutzer zugreifen. Daher ist der √úbergang von GWS zu GCP in der Regel "einfacher", einfach weil **Benutzer in GWS hohe Berechtigungen √ºber GCP haben**.&#x20;

### Google Groups Privilege Escalation

Standardm√§√üig k√∂nnen Benutzer **frei Workspace-Gruppen der Organisation beitreten** und diese Gruppen **k√∂nnen GCP-Berechtigungen** zugewiesen haben (√ºberpr√ºfen Sie Ihre Gruppen unter [https://groups.google.com/](https://groups.google.com/)).

Durch Ausnutzen der **google groups privesc** k√∂nnten Sie in der Lage sein, zu einer Gruppe mit einer Art privilegiertem Zugriff auf GCP zu eskalieren.

### Referenzen

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{% hint style="success" %}
Lernen & √ºben Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
{% endhint %}
