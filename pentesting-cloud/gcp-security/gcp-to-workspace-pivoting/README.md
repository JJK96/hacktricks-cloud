# GCP <--> Workspace Pivoting

{% hint style="success" %}
AWS Hacking'ı öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitimi AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'ı öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitimi GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek HackTricks ve HackTricks Cloud github depolarına katkıda bulunun.**

</details>
{% endhint %}

## **GCP'den GWS'ye**

### **Alan Geniş Yetkilendirme Temelleri**

Google Workspace'in Alan Geniş Yetkilendirme özelliği, bir **harici uygulama** (Google Workspace Marketplace'den) veya bir iç **GCP Hizmet Hesabı**nın, **kullanıcılar adına Workspace üzerindeki verilere erişmesine izin verir**.

{% hint style="info" %}
Bu temelde, bir organizasyonun GCP projelerindeki **hizmet hesapları**, aynı organizasyonun (veya farklı bir organizasyonun) Workspace kullanıcılarını **taklit edebilir**.
{% endhint %}

Bu konunun nasıl çalıştığı hakkında daha fazla bilgi için şuraya bakın:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Mevcut yetkilendirmeyi tehlikeye atma

Eğer bir saldırgan **GCP üzerinde bazı erişimleri ele geçirdiyse** ve şirketin geçerli bir Workspace kullanıcı e-postasını (tercihen **süper yönetici**) bildiği takdirde, **erişebildiği tüm projeleri sıralayabilir**, projelerin **tüm hizmet hesaplarını sıralayabilir**, hangi **hizmet hesaplarına erişimi olduğunu** kontrol edebilir ve her bir hizmet hesabı ile bu adımları **tekrarlayabilir**.\
Erişebildiği **tüm hizmet hesapları listesi** ve **Workspace e-postaları listesi** ile saldırgan, her bir hizmet hesabı ile kullanıcıyı **taklit etmeyi deneyebilir**.

{% hint style="danger" %}
Alan geniş yetkilendirme yapılandırılırken bir Workspace kullanıcısına gerek yoktur, bu nedenle sadece **bir geçerli olanını bilmek taklit için yeterli ve gereklidir**.\
Ancak, taklit edilen kullanıcının **yetkileri kullanılacaktır**, bu nedenle Süper Yönetici ise her şeye erişebilirsiniz. Eğer hiçbir erişimi yoksa bu işe yaramaz olacaktır.
{% endhint %}

#### [GCP Yetkilendirme Jetonu Oluşturma](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

Bu basit betik, **taklit edilen kullanıcı olarak bir OAuth jetonu oluşturacak** ve ardından bu jetonu `gcloud` ile veya olmadan diğer Google API'larına erişmek için kullanabilirsiniz:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Bu, aşağıdaki adımları izleyerek saldırı gerçekleştirebilen bir araçtır:

1. Kaynak Yöneticisi API'sını kullanarak **GCP Projelerini Numaralandırın**.
2. Her proje kaynağında döngü oluşturun ve başlangıç IAM kullanıcısının erişimi olan **GCP Hizmet hesabı kaynaklarını numaralandırın**.
3. **Her hizmet hesabı rolünde döngü oluşturun** ve IAM politikasında ilgili izne sahip olan hedef hizmet hesabı kaynağında _**serviceAccountKeys.create**_ izni bulunan yerleşik, temel ve özel rolleri bulun. Editör rolünün bu izne sahip olduğu unutulmamalıdır.
4. IAM politikasında ilgili izne sahip bulunan her hizmet hesabı kaynağı için **yeni bir `KEY_ALG_RSA_2048`** özel anahtarı oluşturun.
5. **Her yeni hizmet hesabı üzerinde döngü oluşturun ve onun için bir `JWT`** **nesnesi** oluşturun. Bu, SA özel anahtar kimlik bilgileri ve bir OAuth kapsamından oluşan bir _JWT_ nesnesi oluşturma süreci, tüm var olan OAuth kapsamı kombinasyonları üzerinde döngü oluşturacaktır. Tüm vekil olasılıklarını bulmak için **oauth\_scopes.txt** listesinden tüm OAuth kapsamlarının kombinasyonları üzerinde döngü oluşturulur. **oauth\_scopes.txt** listesi, Workspace kimliklerini kötüye kullanmak için uygun bulduğumuz tüm OAuth kapsamları ile güncellenir.
6. `_make_authorization_grant_assertion` yöntemi, DWD altında JWT'ler oluşturmak için bir **hedef workspace kullanıcısını** belirtme gerekliliğini ortaya koyar, _subject_ olarak adlandırılır. Bu belirli bir kullanıcı gerektiriyor gibi görünse de, **DWD bir alan içindeki her kimliği etkiler**. Dolayısıyla, **herhangi bir alan kullanıcısı** için bir JWT oluşturmak, kombinasyon numaralama kontrolümüzle tutarlı olarak, o alan içindeki tüm kimlikleri etkiler. Basitçe söylemek gerekirse, geçerli bir Workspace kullanıcısı ileri gitmek için yeterlidir.\
Bu kullanıcı, DeleFriend'in _config.yaml_ dosyasında tanımlanabilir. Hedef workspace kullanıcısı zaten bilinmiyorsa, araç, GCP projelerinde rolleri olan alan kullanıcılarını tarayarak geçerli workspace kullanıcılarını otomatik olarak tanımlamayı kolaylaştırır. (Tekrar belirtmek gerekirse) JWT'ler alan özgül olduğundan ve her kullanıcı için oluşturulmadığından, otomatik süreç her alan için tek bir benzersiz kimliği hedefler.
7. **Her JWT için yeni bir taşıyıcı erişim belirteci numaralandırın ve oluşturun** ve belirteçleri tokeninfo API'sine karşı doğrulayın.

#### [Gitlab'ın Python betiği](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab, kullanıcı dizinini listelemek ve bir json ile belirtilen SA kimlik bilgileri ve taklit edilecek kullanıcı ile yeni bir yönetici hesabı oluşturmak için [bu Python betiğini](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) oluşturdu. İşte nasıl kullanacağınız:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Yeni bir yetkilendirme oluşturun (Kalıcılık)

**https://admin.google.com/u/1/ac/owl/domainwidedelegation** adresindeki **Alan Geniş Yetkilendirmelerini kontrol etmek mümkündür**.

Bir saldırgan, bir GCP projesinde **hizmet hesapları oluşturma yeteneğine** ve **GWS'de süper yönetici ayrıcalığına** sahip olarak, SAs'nin bazı GWS kullanıcılarını taklit etmelerine izin veren yeni bir yetkilendirme oluşturabilir:

1. **Yeni bir Hizmet Hesabı ve İlgili Anahtar Çifti Oluşturma:** GCP'de, yeni hizmet hesabı kaynakları ya konsol aracılığıyla etkileşimli olarak ya da doğrudan API çağrıları ve CLI araçları kullanılarak programatik olarak üretilebilir. Bu, **rol `iam.serviceAccountAdmin`** veya **`iam.serviceAccounts.create`** **izinini** içeren herhangi bir özel rol gerektirir. Hizmet hesabı oluşturulduktan sonra, ilgili bir **anahtar çifti oluşturacağız** (**`iam.serviceAccountKeys.create`** izni).
2. **Yeni yetkilendirme oluşturma**: **Yalnızca Süper Yönetici rolünün, Google Workspace'de küresel Alan Geniş yetkilendirmesini kurma yeteneğine sahip olduğunu** ve Alan Geniş yetkilendirmenin **programatik olarak kurulamayacağını**, yalnızca Google Workspace **konsolu** aracılığıyla **manuel olarak** oluşturulup ayarlanabileceğini anlamak önemlidir.
* Kuralın oluşturulması, **API kontrolleri → Google Workspace Yönetici konsolunda Alan Geniş yetkilendirmeyi Yönet** sayfasında bulunabilir.
3. **OAuth kapsam ayrıcalığını eklemek**: Yeni bir yetkilendirme yapılandırılırken, Google'ın yalnızca 2 parametreye ihtiyacı vardır: İstemci Kimliği, yani **GCP Hizmet Hesabı** kaynağının **OAuth Kimliği** ve yetkilendirmenin hangi API çağrılarını gerektirdiğini tanımlayan **OAuth kapsamları**.
* **OAuth kapsamlarının tam listesi** [**burada**](https://developers.google.com/identity/protocols/oauth2/scopes) bulunabilir, ancak burada bir öneri: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **Hedef kimlik adına hareket etme:** Bu noktada, GWS'de işlevsel bir yetkilendirilmiş nesnemiz var. Şimdi, **GCP Hizmet Hesabı özel anahtarı kullanarak API çağrıları yapabiliriz** (OAuth kapsam parametresinde tanımlanan kapsamda) ve **Google Workspace'de var olan herhangi bir kimlik adına hareket edebiliriz**. Hizmet hesabının REST API uygulamalarına sahip olduğu izinlere göre ihtiyaçları doğrultusunda erişim belirteçleri oluşturacağını öğrendik.
* Bu yetkilendirmeyi kullanmak için bazı **araçlar** için **önceki bölüme** bakın.

#### Kuruluşlar Arası Yetkilendirme

OAuth SA Kimliği küreseldir ve **kuruluşlar arası yetkilendirme** için kullanılabilir. Kuruluşlar arası yetkilendirmeyi önlemek için herhangi bir kısıtlama uygulanmamıştır. Basitçe ifade etmek gerekirse, **farklı GCP kuruluşlarından hizmet hesapları, diğer Workspace kuruluşlarında alan geniş yetkilendirmesini yapılandırmak için kullanılabilir**. Bu, yalnızca Workspace'e Süper Yönetici erişimine ihtiyaç duyulacağı anlamına gelir ve saldırgan, Hizmet Hesapları ve özel anahtarları kendi kontrolündeki GCP hesabında oluşturabilir.

### Workspace'ı numaralandırmak için bir Proje oluşturma

**Varsayılan olarak** Workspace **kullanıcıları**, **yeni projeler oluşturma iznine** sahiptir ve yeni bir proje oluşturulduğunda **oluşturucu üzerinde Sahip rolü** alır.

Bu nedenle, bir kullanıcı bir proje **oluşturabilir**, yeni projesinde Workspace'ı numaralandırmak için **API'leri etkinleştirebilir** ve onu **numaralandırmaya** çalışabilir.

{% hint style="danger" %}
Bir kullanıcının Workspace'ı numaralandırabilmesi için yeterli Workspace iznine de ihtiyacı vardır (her kullanıcı dizini numaralandıramayabilir).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

**Daha fazla numaralandırma için** şunu kontrol edin:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Gcloud Kötüye Kullanımı

`gcloud` akışı hakkında daha fazla bilgiyi şurada bulabilirsiniz:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Orada açıklandığı gibi, gcloud, kullanıcının sürücüsüne erişim izni verecek olan `https://www.googleapis.com/auth/drive` kapsamını isteyebilir.\
Bir saldırgan olarak, bir kullanıcının bilgisayarını **fiziksel olarak** ele geçirdiyseniz ve **kullanıcı hala oturum açık** ise, kullanıcı hesabıyla sürücüye erişim izni olan bir belge oluşturarak oturum açabilirsiniz:
```bash
gcloud auth login --enable-gdrive-access
```
Eğer bir saldırgan bir kullanıcının bilgisayarını ele geçirirse, aynı zamanda `google-cloud-sdk/lib/googlecloudsdk/core/config.py` dosyasını da değiştirebilir ve **`CLOUDSDK_SCOPES`** içine **`'https://www.googleapis.com/auth/drive'`** kapsamını ekleyebilir:

<figure><img src="../../../.gitbook/assets/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Bu nedenle, kullanıcı bir sonraki oturum açtığında, saldırganın sürücüye erişim sağlayabileceği bir **token oluşturacak**. Açıkçası, tarayıcı oluşturulan token'ın sürücüye erişim sağlayacağını belirtecektir, ancak kullanıcı **`gcloud auth login`** komutunu kendisi çağıracağından dolayı **muhtemelen hiçbir şeyden şüphelenmeyecektir.**

Sürücü dosyalarını listelemek için: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## GWS'den GCP'ye

### Ayrıcalıklı GCP kullanıcılarına erişim

Bir saldırganın GWS üzerinde tam erişimi varsa, genellikle GWS'deki kullanıcıların GCP üzerinde yüksek ayrıcalıklara sahip olması nedeniyle GWS'den GCP'ye geçmek daha "basit" olacaktır.&#x20;

### Google Grupları Ayrıcalık Yükseltme

Varsayılan olarak kullanıcılar **Kuruluşun Workspace gruplarına serbestçe katılabilir** ve bu gruplar **GCP izinleri** atamış olabilir (gruplarınızı [https://groups.google.com/](https://groups.google.com/) adresinden kontrol edin).

**Google grupları ayrıcalık yükseltme**yi kötüye kullanarak GCP'ye ayrıcalıklı erişime sahip bir gruba yükseltebilirsiniz.

### Referanslar

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{% hint style="success" %}
AWS Hacking öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
