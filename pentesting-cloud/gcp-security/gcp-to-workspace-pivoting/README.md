# GCP <--> Workspace Pivoting

{% hint style="success" %}
Aprende y practica Hacking en AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* ¬°Consulta los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## **De GCP a GWS**

### **Conceptos b√°sicos de Delegaci√≥n a nivel de dominio**

La delegaci√≥n a nivel de dominio de Google Workspace permite que un objeto de identidad, ya sea una **aplicaci√≥n externa** del Marketplace de Google Workspace o una **Cuenta de Servicio de GCP** interna, **acceda a datos en toda la Workspace en nombre de los usuarios**.

{% hint style="info" %}
B√°sicamente esto significa que las **cuentas de servicio** dentro de los proyectos de GCP de una organizaci√≥n podr√≠an **hacerse pasar por usuarios de Workspace** de la misma organizaci√≥n (o incluso de una diferente).
{% endhint %}

Para obtener m√°s informaci√≥n sobre c√≥mo funciona exactamente esto, consulta:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Comprometer la delegaci√≥n existente

Si un atacante **ha comprometido alg√∫n acceso en GCP** y **conoce un correo electr√≥nico v√°lido de usuario de Workspace** (preferiblemente **super administrador**) de la empresa, podr√≠a **enumerar todos los proyectos** a los que tiene acceso, **enumerar todas las Cuentas de Servicio** de los proyectos, verificar a qu√© **cuentas de servicio tiene acceso**, y **repetir** todos estos pasos con cada CS que pueda hacerse pasar.\
Con una **lista de todas las cuentas de servicio** a las que tiene **acceso** y la lista de **correos electr√≥nicos de Workspace**, el atacante podr√≠a intentar **hacerse pasar por usuario con cada cuenta de servicio**.

{% hint style="danger" %}
Ten en cuenta que al configurar la delegaci√≥n a nivel de dominio no se necesita un usuario de Workspace, por lo tanto, solo conocer **uno v√°lido es suficiente y necesario para la suplantaci√≥n**.\
Sin embargo, se utilizar√°n los **privilegios del usuario suplantado**, por lo que si es un Super Administrador podr√°s acceder a todo. Si no tiene ning√∫n acceso, esto ser√° in√∫til.
{% endhint %}

#### [GCP Generate Delegation Token](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

Este sencillo script **generar√° un token OAuth como el usuario delegado** que luego podr√°s usar para acceder a otras APIs de Google con o sin `gcloud`:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Esta es una herramienta que puede realizar el ataque siguiendo estos pasos:

1. **Enumerar Proyectos de GCP** utilizando la API de Resource Manager.
2. Iterar en cada recurso del proyecto y **enumerar los recursos de cuentas de servicio de GCP** a los cuales el usuario IAM inicial tiene acceso utilizando _GetIAMPolicy_.
3. Iterar en **cada rol de cuenta de servicio** y encontrar roles integrados, b√°sicos y personalizados con permiso _**serviceAccountKeys.create**_ en el recurso de cuenta de servicio objetivo. Cabe destacar que el rol de Editor posee inherentemente este permiso.
4. Crear una **nueva clave privada `KEY_ALG_RSA_2048`** para cada recurso de cuenta de servicio que se encuentre con el permiso relevante en la pol√≠tica IAM.
5. Iterar en **cada nueva cuenta de servicio y crear un `objeto JWT`** para ella que est√© compuesto por las credenciales de la clave privada de SA y un alcance de OAuth. El proceso de creaci√≥n de un nuevo objeto _JWT_ iterar√° en todas las combinaciones existentes de alcances de OAuth de la lista **oauth\_scopes.txt**, para encontrar todas las posibilidades de delegaci√≥n. La lista **oauth\_scopes.txt** se actualiza con todos los alcances de OAuth que hemos encontrado relevantes para abusar de las identidades de Workspace.
6. El m√©todo `_make_authorization_grant_assertion` revela la necesidad de declarar un **usuario de espacio de trabajo objetivo**, referido como _subject_, para generar JWT bajo DWD. Aunque esto pueda parecer que requiere un usuario espec√≠fico, es importante darse cuenta de que **DWD influye en cada identidad dentro de un dominio**. En consecuencia, crear un JWT para **cualquier usuario de dominio** afecta a todas las identidades en ese dominio, coherente con nuestra verificaci√≥n de enumeraci√≥n de combinaciones. En resumen, un usuario v√°lido de Workspace es suficiente para avanzar.\
Este usuario puede ser definido en el archivo _config.yaml_ de DeleFriend. Si un usuario de espacio de trabajo objetivo a√∫n no se conoce, la herramienta facilita la identificaci√≥n autom√°tica de usuarios de espacio de trabajo v√°lidos escaneando usuarios de dominio con roles en proyectos de GCP. Es importante tener en cuenta (nuevamente) que los JWT son espec√≠ficos del dominio y no se generan para cada usuario; por lo tanto, el proceso autom√°tico apunta a una identidad √∫nica por dominio.
7. **Enumerar y crear un nuevo token de acceso de portador** para cada JWT y validar el token contra la API de tokeninfo.

#### [Script de Python de Gitlab](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab ha creado [este script de Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) que puede hacer dos cosas: listar el directorio de usuarios y crear una nueva cuenta administrativa mientras indica un json con credenciales de SA y el usuario a suplantar. As√≠ es como lo usar√≠as:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Crear una nueva delegaci√≥n (Persistencia)

Es posible **verificar las Delegaciones a Nivel de Dominio en** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

Un atacante con la capacidad de **crear cuentas de servicio en un proyecto de GCP** y **privilegio de super administrador en GWS podr√≠a crear una nueva delegaci√≥n que permita a las cuentas de servicio suplantar a algunos usuarios de GWS:**

1. **Generaci√≥n de una Nueva Cuenta de Servicio y Par de Claves Correspondiente:** En GCP, los recursos de nuevas cuentas de servicio pueden ser producidos de forma interactiva a trav√©s de la consola o program√°ticamente utilizando llamadas directas a la API y herramientas de CLI. Esto requiere el **rol `iam.serviceAccountAdmin`** o cualquier rol personalizado equipado con el **permiso `iam.serviceAccounts.create`**. Una vez que se crea la cuenta de servicio, procederemos a generar un **par de claves relacionadas** (permiso **`iam.serviceAccountKeys.create`**).
2. **Creaci√≥n de una nueva delegaci√≥n**: Es importante entender que **solo el rol de Super Administrador posee la capacidad de configurar la delegaci√≥n global a nivel de dominio en Google Workspace** y la delegaci√≥n a nivel de dominio **no puede ser configurada program√°ticamente,** solo puede ser creada y ajustada **manualmente** a trav√©s de la **consola de Google Workspace**.
* La creaci√≥n de la regla se puede encontrar en la p√°gina **Controles de API ‚Üí Administrar la delegaci√≥n a nivel de dominio en la consola de administraci√≥n de Google Workspace**.
3. **Asignaci√≥n del privilegio de alcance de OAuth**: Al configurar una nueva delegaci√≥n, Google requiere solo 2 par√°metros, el ID de Cliente, que es el **ID OAuth de la cuenta de servicio de GCP**, y los **alcances de OAuth** que definen qu√© llamadas a la API requiere la delegaci√≥n.
* La **lista completa de alcances de OAuth** se puede encontrar [**aqu√≠**](https://developers.google.com/identity/protocols/oauth2/scopes), pero aqu√≠ hay una recomendaci√≥n: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **Actuar en nombre de la identidad objetivo:** En este punto, tenemos un objeto delegado funcional en GWS. Ahora, **utilizando la clave privada de la cuenta de servicio de GCP, podemos realizar llamadas a la API** (en el alcance definido en el par√°metro de alcance de OAuth) para activarlo y **actuar en nombre de cualquier identidad que exista en Google Workspace**. Como aprendimos, la cuenta de servicio generar√° tokens de acceso seg√∫n sus necesidades y de acuerdo con el permiso que tenga para aplicaciones de API REST.
* Consulta la **secci√≥n anterior** para algunas **herramientas** para utilizar esta delegaci√≥n.

#### Delegaci√≥n Cruzada entre Organizaciones

El ID de SA de OAuth es global y se puede utilizar para **delegaci√≥n cruzada entre organizaciones**. No se ha implementado ninguna restricci√≥n para evitar la delegaci√≥n cruzada global. En t√©rminos simples, **las cuentas de servicio de diferentes organizaciones de GCP pueden ser utilizadas para configurar la delegaci√≥n a nivel de dominio en otras organizaciones de Workspace**. Esto resultar√≠a en **solo necesitar acceso de Super Administrador a Workspace**, y no acceso a la misma cuenta de GCP, ya que el adversario puede crear cuentas de servicio y claves privadas en su cuenta de GCP controlada personalmente.

### Crear un Proyecto para enumerar Workspace

Por **defecto** los **usuarios** de Workspace tienen permiso para **crear nuevos proyectos**, y cuando se crea un nuevo proyecto el **creador obtiene el rol de Propietario** sobre √©l.

Por lo tanto, un usuario puede **crear un proyecto**, **habilitar** las **APIs** para enumerar Workspace en su nuevo proyecto e intentar **enumerarlo**.

{% hint style="danger" %}
Para que un usuario pueda enumerar Workspace tambi√©n necesita suficientes permisos de Workspace (no todos los usuarios podr√°n enumerar el directorio).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Verifica **m√°s enumeraci√≥n en**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Abusando de Gcloud

Puedes encontrar m√°s informaci√≥n sobre el flujo de `gcloud` para iniciar sesi√≥n en:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Como se explica all√≠, gcloud puede solicitar el alcance `https://www.googleapis.com/auth/drive` lo que permitir√≠a a un usuario acceder a la unidad del usuario.\
Como atacante, si has comprometido **f√≠sicamente** la computadora de un usuario y el **usuario sigue conectado** con su cuenta, podr√≠as iniciar sesi√≥n generando un token con acceso a la unidad usando:
```bash
gcloud auth login --enable-gdrive-access
```
Si un atacante compromete la computadora de un usuario, tambi√©n podr√≠a modificar el archivo `google-cloud-sdk/lib/googlecloudsdk/core/config.py` y agregar en el **`CLOUDSDK_SCOPES`** el alcance **`'https://www.googleapis.com/auth/drive'`**:

<figure><img src="../../../.gitbook/assets/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Por lo tanto, la pr√≥xima vez que el usuario inicie sesi√≥n, crear√° un **token con acceso a Drive** que el atacante podr√≠a abusar para acceder a Drive. Obviamente, el navegador indicar√° que el token generado tendr√° acceso a Drive, pero como el usuario ejecutar√° el **`gcloud auth login`**, probablemente **no sospechar√° nada.**

Para listar archivos de Drive: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## De GWS a GCP

### Acceso a usuarios privilegiados de GCP

Si un atacante tiene acceso completo sobre GWS, podr√° acceder a grupos con acceso privilegiado sobre GCP o incluso a usuarios, por lo tanto, moverse de GWS a GCP suele ser m√°s "simple" simplemente porque **los usuarios en GWS tienen altos privilegios sobre GCP**.&#x20;

### Escalada de privilegios en Google Groups

Por defecto, los usuarios pueden **unirse libremente a grupos de Workspace de la Organizaci√≥n** y esos grupos **podr√≠an tener permisos de GCP** asignados (verifica tus grupos en [https://groups.google.com/](https://groups.google.com/)).

Abusando de la **escalada de privilegios en google groups** podr√≠as ser capaz de escalar a un grupo con alg√∫n tipo de acceso privilegiado a GCP.

### Referencias

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* ¬°Consulta los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
