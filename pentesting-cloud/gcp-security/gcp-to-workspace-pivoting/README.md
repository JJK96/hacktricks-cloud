# GCP <--> Workspace Pivoting

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## **De GCP √† GWS**

### **Principes de la d√©l√©gation √† l'√©chelle du domaine**

La d√©l√©gation √† l'√©chelle du domaine de Google Workspace permet √† un objet d'identit√©, qu'il s'agisse d'une **application externe** du Google Workspace Marketplace ou d'un **compte de service GCP** interne, d'**acc√©der aux donn√©es √† travers le Workspace au nom des utilisateurs**.

{% hint style="info" %}
Cela signifie essentiellement que les **comptes de service** √† l'int√©rieur des projets GCP d'une organisation pourraient √™tre en mesure d'**usurper les utilisateurs de Workspace** de la m√™me organisation (ou m√™me d'une autre).
{% endhint %}

Pour plus d'informations sur le fonctionnement exact, consultez :

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Compromettre une d√©l√©gation existante

Si un attaquant **a compromis un certain acc√®s sur GCP** et **conna√Æt un e-mail d'utilisateur Workspace valide** (de pr√©f√©rence **super administrateur**) de l'entreprise, il pourrait **√©num√©rer tous les projets** auxquels il a acc√®s, **√©num√©rer tous les comptes de service** des projets, v√©rifier √† quels **comptes de service il a acc√®s**, et **r√©p√©ter** toutes ces √©tapes avec chaque compte de service qu'il peut usurper.\
Avec une **liste de tous les comptes de service** auxquels il a **acc√®s** et la liste des **e-mails de Workspace**, l'attaquant pourrait essayer d'**usurper l'utilisateur avec chaque compte de service**.

{% hint style="danger" %}
Notez que lors de la configuration de la d√©l√©gation √† l'√©chelle du domaine, aucun utilisateur Workspace n'est n√©cessaire, il suffit donc de conna√Ætre **un seul valide, ce qui est suffisant et n√©cessaire pour l'usurpation**.\
Cependant, les **privil√®ges de l'utilisateur usurp√© seront utilis√©s**, donc s'il s'agit d'un super administrateur, vous pourrez tout acc√©der. Si celui-ci n'a aucun acc√®s, cela sera inutile.
{% endhint %}

#### [GCP G√©n√©rer un jeton de d√©l√©gation](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

Ce script simple permettra de **g√©n√©rer un jeton OAuth en tant qu'utilisateur d√©l√©gu√©** que vous pourrez ensuite utiliser pour acc√©der √† d'autres API Google avec ou sans `gcloud`:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

C'est un outil qui peut effectuer l'attaque en suivant ces √©tapes :

1. **√ânum√©rer les projets GCP** en utilisant l'API Resource Manager.
2. It√©rer sur chaque ressource de projet, et **√©num√©rer les ressources de compte de service GCP** auxquelles l'utilisateur IAM initial a acc√®s en utilisant _GetIAMPolicy_.
3. It√©rer sur **chaque r√¥le de compte de service**, et trouver les r√¥les int√©gr√©s, de base et personnalis√©s avec l'autorisation _**serviceAccountKeys.create**_ sur la ressource de compte de service cible. Il convient de noter que le r√¥le d'√âditeur poss√®de naturellement cette autorisation.
4. Cr√©er une **nouvelle cl√© priv√©e `KEY_ALG_RSA_2048`** pour chaque ressource de compte de service qui est trouv√©e avec l'autorisation pertinente dans la strat√©gie IAM.
5. It√©rer sur **chaque nouveau compte de service et cr√©er un `objet JWT`** pour celui-ci qui est compos√© des informations d'identification de la cl√© priv√©e SA et d'une port√©e OAuth. Le processus de cr√©ation d'un nouvel objet _JWT_ va **it√©rer sur toutes les combinaisons existantes de port√©es OAuth** de la liste **oauth\_scopes.txt**, afin de trouver toutes les possibilit√©s de d√©l√©gation. La liste **oauth\_scopes.txt** est mise √† jour avec toutes les port√©es OAuth que nous avons trouv√©es pertinentes pour abuser des identit√©s Workspace.
6. La m√©thode `_make_authorization_grant_assertion` r√©v√®le la n√©cessit√© de d√©clarer un **utilisateur Workspace cible**, appel√© _sujet_, pour g√©n√©rer des JWT sous DWD. Bien que cela puisse sembler n√©cessiter un utilisateur sp√©cifique, il est important de r√©aliser que **DWD influence chaque identit√© au sein d'un domaine**. Par cons√©quent, la cr√©ation d'un JWT pour **n'importe quel utilisateur de domaine** affecte toutes les identit√©s de ce domaine, conforme √† notre v√©rification d'√©num√©ration des combinaisons. En d'autres termes, un seul utilisateur Workspace valide est suffisant pour avancer.\
Cet utilisateur peut √™tre d√©fini dans le fichier _config.yaml_ de DeleFriend. Si un utilisateur Workspace cible n'est pas d√©j√† connu, l'outil facilite l'identification automatique des utilisateurs Workspace valides en scannant les utilisateurs de domaine avec des r√¥les sur les projets GCP. Il est important de noter (encore une fois) que les JWT sont sp√©cifiques au domaine et ne sont pas g√©n√©r√©s pour chaque utilisateur ; par cons√©quent, le processus automatique cible une identit√© unique par domaine.
7. **√ânum√©rer et cr√©er un nouveau jeton d'acc√®s de porteur** pour chaque JWT et valider le jeton contre l'API tokeninfo.

#### [Script Python de Gitlab](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab a cr√©√© [ce script Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) qui peut faire deux choses - lister le r√©pertoire utilisateur et cr√©er un nouveau compte administratif tout en indiquant un json avec les informations d'identification SA et l'utilisateur √† usurper. Voici comment vous l'utiliseriez :
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Cr√©er une nouvelle d√©l√©gation (Persistance)

Il est possible de **v√©rifier les D√©l√©gations √† l'√©chelle du domaine dans** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

Un attaquant ayant la capacit√© de **cr√©er des comptes de service dans un projet GCP** et **le privil√®ge de super administrateur pour GWS pourrait cr√©er une nouvelle d√©l√©gation permettant aux comptes de service d'usurper certains utilisateurs de GWS:**

1. **G√©n√©ration d'un nouveau compte de service et de la paire de cl√©s correspondante:** Sur GCP, de nouveaux comptes de service peuvent √™tre cr√©√©s de mani√®re interactive via la console ou de mani√®re programmatique en utilisant des appels API directs et des outils CLI. Cela n√©cessite le **r√¥le `iam.serviceAccountAdmin`** ou tout r√¥le personnalis√© √©quip√© de l'**autorisation `iam.serviceAccounts.create`**. Une fois le compte de service cr√©√©, nous proc√©derons √† la g√©n√©ration d'une **paire de cl√©s associ√©e** (autorisation **`iam.serviceAccountKeys.create`**).
2. **Cr√©ation d'une nouvelle d√©l√©gation**: Il est important de comprendre que **seul le r√¥le de Super Admin poss√®de la capacit√© de configurer une d√©l√©gation globale √† l'√©chelle du domaine dans Google Workspace** et la d√©l√©gation √† l'√©chelle du domaine **ne peut pas √™tre configur√©e de mani√®re programmatique,** elle ne peut √™tre cr√©√©e et ajust√©e que **manuellement** via la **console** de Google Workspace.
* La cr√©ation de la r√®gle peut √™tre trouv√©e sous la page **Contr√¥les API ‚Üí G√©rer la d√©l√©gation √† l'√©chelle du domaine dans la console d'administration de Google Workspace**.
3. **Attribution du privil√®ge des √©tendues OAuth**: Lors de la configuration d'une nouvelle d√©l√©gation, Google ne requiert que 2 param√®tres, l'ID Client, qui est l'**ID OAuth du compte de service GCP**, et les **√©tendues OAuth** qui d√©finissent les appels API n√©cessaires √† la d√©l√©gation.
* La **liste compl√®te des √©tendues OAuth** peut √™tre trouv√©e [**ici**](https://developers.google.com/identity/protocols/oauth2/scopes), mais voici une recommandation: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **Agir au nom de l'identit√© cible:** √Ä ce stade, nous avons un objet d√©l√©gu√© fonctionnel dans GWS. Maintenant, **en utilisant la cl√© priv√©e du compte de service GCP, nous pouvons effectuer des appels API** (dans la port√©e d√©finie dans le param√®tre d'√©tendue OAuth) pour le d√©clencher et **agir au nom de toute identit√© existante dans Google Workspace**. Comme nous l'avons appris, le compte de service g√©n√©rera des jetons d'acc√®s selon ses besoins et selon les autorisations qu'il a pour les applications API REST.
* V√©rifiez la **section pr√©c√©dente** pour certains **outils** √† utiliser avec cette d√©l√©gation.

#### D√©l√©gation interorganisationnelle

L'ID OAuth du compte de service est global et peut √™tre utilis√© pour la **d√©l√©gation interorganisationnelle**. Aucune restriction n'a √©t√© mise en place pour emp√™cher la d√©l√©gation interglobale. En termes simples, **les comptes de service de diff√©rentes organisations GCP peuvent √™tre utilis√©s pour configurer une d√©l√©gation √† l'√©chelle du domaine sur d'autres organisations Workspace**. Cela n√©cessiterait **seulement un acc√®s Super Admin √† Workspace**, et non un acc√®s au m√™me compte GCP, car l'adversaire peut cr√©er des comptes de service et des cl√©s priv√©es sur son compte GCP personnellement contr√¥l√©.

### Cr√©ation d'un projet pour √©num√©rer Workspace

Par **d√©faut**, les **utilisateurs** de Workspace ont la permission de **cr√©er de nouveaux projets**, et lorsqu'un nouveau projet est cr√©√©, le **cr√©ateur obtient le r√¥le de Propri√©taire** dessus.

Par cons√©quent, un utilisateur peut **cr√©er un projet**, **activer** les **APIs** pour √©num√©rer Workspace dans son nouveau projet et essayer de **l'√©num√©rer**.

{% hint style="danger" %}
Pour qu'un utilisateur puisse √©num√©rer Workspace, il a √©galement besoin de suffisamment de permissions Workspace (tous les utilisateurs ne pourront pas √©num√©rer l'annuaire).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

V√©rifiez **plus d'√©num√©ration dans**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Abus de Gcloud

Vous pouvez trouver plus d'informations sur le flux `gcloud` pour vous connecter √†:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Comme expliqu√©, gcloud peut demander la port√©e `https://www.googleapis.com/auth/drive` qui permettrait √† un utilisateur d'acc√©der au lecteur de l'utilisateur.\
En tant qu'attaquant, si vous avez compromis **physiquement** l'ordinateur d'un utilisateur et que l'**utilisateur est toujours connect√©** avec son compte, vous pourriez vous connecter en g√©n√©rant un jeton avec acc√®s au lecteur en utilisant:
```bash
gcloud auth login --enable-gdrive-access
```
Si un attaquant compromet l'ordinateur d'un utilisateur, il pourrait √©galement modifier le fichier `google-cloud-sdk/lib/googlecloudsdk/core/config.py` et ajouter dans les **`CLOUDSDK_SCOPES`** la port√©e **`'https://www.googleapis.com/auth/drive'`**:

<figure><img src="../../../.gitbook/assets/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Ainsi, la prochaine fois que l'utilisateur se connectera, il cr√©era un **jeton avec acc√®s au drive** que l'attaquant pourrait exploiter pour acc√©der au drive. Bien s√ªr, le navigateur indiquera que le jeton g√©n√©r√© aura acc√®s au drive, mais comme l'utilisateur appellera lui-m√™me **`gcloud auth login`**, il ne soup√ßonnera probablement **rien.**

Pour lister les fichiers du drive : **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## De GWS √† GCP

### Acc√©der aux utilisateurs privil√©gi√©s de GCP

Si un attaquant a un acc√®s complet sur GWS, il pourra acc√©der √† des groupes avec des acc√®s privil√©gi√©s sur GCP ou m√™me √† des utilisateurs, donc passer de GWS √† GCP est g√©n√©ralement plus "simple" simplement parce que **les utilisateurs de GWS ont des privil√®ges √©lev√©s sur GCP**.&#x20;

### Escalade de privil√®ges des Google Groups

Par d√©faut, les utilisateurs peuvent **rejoindre librement les groupes Workspace de l'Organisation** et ces groupes **peuvent avoir des autorisations GCP** attribu√©es (v√©rifiez vos groupes sur [https://groups.google.com/](https://groups.google.com/)).

En abusant de la **privil√®ge d'escalade des groupes Google**, vous pourriez √™tre en mesure d'escalader vers un groupe avec un certain type d'acc√®s privil√©gi√© √† GCP.

### R√©f√©rences

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Formation Expert en √âquipe Rouge AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Formation Expert en √âquipe Rouge GCP (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
