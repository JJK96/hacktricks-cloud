# GCP <--> Workspace Pivoting

{% hint style="success" %}
Aprenda e pratique Hacking AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte o HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>
{% endhint %}

## **De GCP para GWS**

### **No√ß√µes b√°sicas de Delega√ß√£o em Toda a Organiza√ß√£o**

A delega√ß√£o em toda a organiza√ß√£o do Google Workspace permite que um objeto de identidade, seja um **aplicativo externo** do Google Workspace Marketplace ou uma **Conta de Servi√ßo GCP** interna, **acesse dados em toda a organiza√ß√£o em nome dos usu√°rios**.

{% hint style="info" %}
Isso basicamente significa que **contas de servi√ßo** dentro de projetos GCP de uma organiza√ß√£o podem ser capazes de **se passar por usu√°rios do Workspace** da mesma organiza√ß√£o (ou at√© mesmo de uma diferente).
{% endhint %}

Para obter mais informa√ß√µes sobre como isso funciona exatamente, consulte:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Comprometer a delega√ß√£o existente

Se um atacante **comprometer algum acesso no GCP** e **conhecer um e-mail de usu√°rio v√°lido do Workspace** (preferencialmente **super administrador**) da empresa, ele poderia **enumerar todos os projetos** aos quais tem acesso, **enumerar todas as Contas de Servi√ßo** dos projetos, verificar a quais **contas de servi√ßo ele tem acesso** e **repetir** todos esses passos com cada CS que ele pode se passar.\
Com uma **lista de todas as contas de servi√ßo** √†s quais ele tem **acesso** e a lista de **e-mails do Workspace**, o atacante poderia tentar **se passar por usu√°rio com cada conta de servi√ßo**.

{% hint style="danger" %}
Observe que ao configurar a delega√ß√£o em toda a organiza√ß√£o, nenhum usu√°rio do Workspace √© necess√°rio, portanto, apenas saber **um v√°lido √© suficiente e necess√°rio para a falsifica√ß√£o**.\
No entanto, os **privil√©gios do usu√°rio falsificado ser√£o usados**, ent√£o se for Super Administrador voc√™ poder√° acessar tudo. Se ele n√£o tiver nenhum acesso, isso ser√° in√∫til.
{% endhint %}

#### [GCP Generate Delegation Token](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

Este simples script ir√° **gerar um token OAuth como o usu√°rio delegado** que voc√™ pode ent√£o usar para acessar outras APIs do Google com ou sem `gcloud`:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Esta √© uma ferramenta que pode realizar o ataque seguindo estes passos:

1. **Enumerar Projetos GCP** usando a API do Gerenciador de Recursos.
2. Iterar em cada recurso do projeto e **enumerar os recursos da conta de servi√ßo GCP** aos quais o usu√°rio IAM inicial tem acesso usando _GetIAMPolicy_.
3. Iterar em **cada fun√ß√£o da conta de servi√ßo** e encontrar fun√ß√µes integradas, b√°sicas e personalizadas com permiss√£o _**serviceAccountKeys.create**_ no recurso da conta de servi√ßo alvo. Deve-se notar que a fun√ß√£o Editor possui inerentemente essa permiss√£o.
4. Criar uma **nova chave privada `KEY_ALG_RSA_2048`** para cada recurso da conta de servi√ßo que √© encontrado com permiss√£o relevante na pol√≠tica IAM.
5. Iterar em **cada nova conta de servi√ßo e criar um `objeto JWT`** para ela que √© composto pelas credenciais da chave privada SA e um escopo OAuth. O processo de cria√ß√£o de um novo objeto _JWT_ ir√° **iterar em todas as combina√ß√µes existentes de escopos OAuth** da lista **oauth\_scopes.txt**, a fim de encontrar todas as possibilidades de delega√ß√£o. A lista **oauth\_scopes.txt** √© atualizada com todos os escopos OAuth que encontramos relevantes para abusar das identidades do Workspace.
6. O m√©todo `_make_authorization_grant_assertion` revela a necessidade de declarar um **usu√°rio de workspace alvo**, referido como _subject_, para gerar JWTs sob DWD. Embora isso possa parecer exigir um usu√°rio espec√≠fico, √© importante perceber que **DWD influencia todas as identidades dentro de um dom√≠nio**. Consequentemente, criar um JWT para **qualquer usu√°rio de dom√≠nio** afeta todas as identidades nesse dom√≠nio, de acordo com nossa verifica√ß√£o de enumera√ß√£o de combina√ß√µes. Em termos simples, um √∫nico usu√°rio v√°lido do Workspace √© suficiente para avan√ßar.\
Este usu√°rio pode ser definido no arquivo _config.yaml_ do DeleFriend. Se um usu√°rio de workspace alvo ainda n√£o for conhecido, a ferramenta facilita a identifica√ß√£o autom√°tica de usu√°rios de workspace v√°lidos escaneando usu√°rios de dom√≠nio com fun√ß√µes em projetos GCP. √â fundamental observar (novamente) que os JWTs s√£o espec√≠ficos do dom√≠nio e n√£o s√£o gerados para cada usu√°rio; portanto, o processo autom√°tico visa uma identidade √∫nica por dom√≠nio.
7. **Enumerar e criar um novo token de acesso de portador** para cada JWT e validar o token contra a API tokeninfo.

#### [Script Python do Gitlab](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

O Gitlab criou [este script Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) que pode fazer duas coisas - listar o diret√≥rio de usu√°rios e criar uma nova conta administrativa indicando um json com credenciais SA e o usu√°rio a ser impersonificado. Aqui est√° como voc√™ o utilizaria:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Criar uma nova delega√ß√£o (Persist√™ncia)

√â poss√≠vel **verificar Delega√ß√µes em Toda a Organiza√ß√£o em** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

Um atacante com a capacidade de **criar contas de servi√ßo em um projeto GCP** e **privil√©gio de super administrador para GWS poderia criar uma nova delega√ß√£o permitindo que as contas de servi√ßo se fa√ßam passar por alguns usu√°rios do GWS:**

1. **Gerando uma Nova Conta de Servi√ßo e Par de Chaves Correspondente:** No GCP, novos recursos de conta de servi√ßo podem ser produzidos interativamente via console ou programaticamente usando chamadas de API diretas e ferramentas CLI. Isso requer a **fun√ß√£o `iam.serviceAccountAdmin`** ou qualquer fun√ß√£o personalizada equipada com a **permiss√£o `iam.serviceAccounts.create`**. Uma vez que a conta de servi√ßo √© criada, procederemos para gerar um **par de chaves relacionadas** (permiss√£o **`iam.serviceAccountKeys.create`**).
2. **Cria√ß√£o de nova delega√ß√£o**: √â importante entender que **apenas a fun√ß√£o de Super Administrador possui a capacidade de configurar a delega√ß√£o global em toda a organiza√ß√£o no Google Workspace** e a delega√ß√£o em toda a organiza√ß√£o **n√£o pode ser configurada programaticamente,** ela s√≥ pode ser criada e ajustada **manualmente** atrav√©s do **console** do Google Workspace.
* A cria√ß√£o da regra pode ser encontrada na p√°gina **Controles de API ‚Üí Gerenciar Delega√ß√£o em Toda a Organiza√ß√£o no console de Administra√ß√£o do Google Workspace**.
3. **Anexando o privil√©gio de escopos OAuth**: Ao configurar uma nova delega√ß√£o, o Google requer apenas 2 par√¢metros, o ID do Cliente, que √© o **ID OAuth da conta de servi√ßo do GCP**, e **escopos OAuth** que definem quais chamadas de API a delega√ß√£o requer.
* A **lista completa de escopos OAuth** pode ser encontrada [**aqui**](https://developers.google.com/identity/protocols/oauth2/scopes), mas aqui est√° uma recomenda√ß√£o: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **Atuando em nome da identidade alvo:** Neste ponto, temos um objeto delegado funcional no GWS. Agora, **usando a chave privada da conta de servi√ßo do GCP, podemos realizar chamadas de API** (no escopo definido no par√¢metro de escopo OAuth) para ativ√°-lo e **atuar em nome de qualquer identidade que exista no Google Workspace**. Como aprendemos, a conta de servi√ßo gerar√° tokens de acesso de acordo com suas necessidades e de acordo com a permiss√£o que ele tem para aplicativos de API REST.
* Verifique a **se√ß√£o anterior** para algumas **ferramentas** para usar essa delega√ß√£o.

#### Delega√ß√£o Cruzada entre Organiza√ß√µes

O ID do SA OAuth √© global e pode ser usado para **delega√ß√£o cruzada entre organiza√ß√µes**. N√£o foi implementada nenhuma restri√ß√£o para evitar a delega√ß√£o global cruzada. Em termos simples, **contas de servi√ßo de diferentes organiza√ß√µes GCP podem ser usadas para configurar a delega√ß√£o em toda a organiza√ß√£o em outras organiza√ß√µes do Workspace**. Isso resultaria em **apenas precisar de acesso de Super Administrador ao Workspace**, e n√£o acesso √† mesma conta GCP, j√° que o advers√°rio pode criar Contas de Servi√ßo e chaves privadas em sua conta GCP controlada pessoalmente.

### Criando um Projeto para enumerar o Workspace

Por **padr√£o** os **usu√°rios** do Workspace t√™m permiss√£o para **criar novos projetos**, e quando um novo projeto √© criado o **criador recebe a fun√ß√£o de Propriet√°rio** sobre ele.

Portanto, um usu√°rio pode **criar um projeto**, **ativar** as **APIs** para enumerar o Workspace em seu novo projeto e tentar **enumer√°-lo**.

{% hint style="danger" %}
Para que um usu√°rio possa enumerar o Workspace, ele tamb√©m precisa ter permiss√µes suficientes no Workspace (nem todo usu√°rio poder√° enumerar o diret√≥rio).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Verifique **mais enumera√ß√£o em**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Abusando do Gcloud

Voc√™ pode encontrar mais informa√ß√µes sobre o fluxo do `gcloud` para fazer login em:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Como explicado l√°, o gcloud pode solicitar o escopo `https://www.googleapis.com/auth/drive` que permitiria a um usu√°rio acessar a unidade do usu√°rio.\
Como atacante, se voc√™ comprometeu **fisicamente** o computador de um usu√°rio e o **usu√°rio ainda est√° logado** com sua conta, voc√™ poderia fazer login gerando um token com acesso √† unidade usando:
```bash
gcloud auth login --enable-gdrive-access
```
Se um atacante comprometer o computador de um usu√°rio, ele tamb√©m poder√° modificar o arquivo `google-cloud-sdk/lib/googlecloudsdk/core/config.py` e adicionar no **`CLOUDSDK_SCOPES`** o escopo **`'https://www.googleapis.com/auth/drive'`**:

<figure><img src="../../../.gitbook/assets/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Portanto, na pr√≥xima vez que o usu√°rio fizer login, ele criar√° um **token com acesso ao drive** que o atacante poder√° abusar para acessar o drive. Obviamente, o navegador indicar√° que o token gerado ter√° acesso ao drive, mas como o usu√°rio ir√° chamar o **`gcloud auth login`**, ele provavelmente **n√£o suspeitar√° de nada.**

Para listar os arquivos do drive: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## Do GWS para o GCP

### Acesso a usu√°rios privilegiados do GCP

Se um atacante tiver acesso completo ao GWS, ele poder√° acessar grupos com acesso privilegiado ao GCP ou at√© mesmo usu√°rios, portanto, a transi√ß√£o do GWS para o GCP geralmente √© mais "simples" apenas porque **os usu√°rios no GWS t√™m altos privil√©gios sobre o GCP**.

### Escalonamento de Privil√©gios em Grupos do Google

Por padr√£o, os usu√°rios podem **se juntar livremente aos grupos do Workspace da Organiza√ß√£o** e esses grupos **podem ter permiss√µes do GCP** atribu√≠das (verifique seus grupos em [https://groups.google.com/](https://groups.google.com/)).

Abusando do **escalamento de privil√©gios em grupos do Google**, voc√™ pode ser capaz de escalar para um grupo com algum tipo de acesso privilegiado ao GCP.

### Refer√™ncias

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{% hint style="success" %}
Aprenda e pratique Hacking na AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking no GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
