# GCP <--> Pivoting di Workspace

{% hint style="success" %}
Impara & pratica l'Hacking su AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara & pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di github.

</details>
{% endhint %}

## **Da GCP a GWS**

### **Concetti di Delega su Larga Scala di Dominio**

La delega su larga scala di dominio di Google Workspace consente a un oggetto di identit√†, sia un **app esterna** dal Google Workspace Marketplace o un **Account di Servizio GCP** interno, di **accedere ai dati in tutta l'organizzazione** a nome degli utenti.

{% hint style="info" %}
Questo significa essenzialmente che **gli account di servizio** all'interno dei progetti GCP di un'organizzazione potrebbero essere in grado di **impersonare gli utenti di Workspace** della stessa organizzazione (o anche di un'altra).
{% endhint %}

Per ulteriori informazioni su come funziona esattamente questo, controlla:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Compromissione della delega esistente

Se un attaccante **ha compromesso alcuni accessi su GCP** e **conosce un'email utente valida di Workspace** (preferibilmente **super admin**) dell'azienda, potrebbe **enumerare tutti i progetti** a cui ha accesso, **enumerare tutti gli Account di Servizio** dei progetti, controllare a quali **account di servizio ha accesso**, e **ripetere** tutti questi passaggi con ciascun Account di Servizio che pu√≤ impersonare.\
Con un **elenco di tutti gli account di servizio** a cui ha **accesso** e l'elenco delle **email di Workspace**, l'attaccante potrebbe provare a **impersonare l'utente con ciascun account di servizio**.

{% hint style="danger" %}
Nota che quando si configura la delega su larga scala di dominio non √® necessario un utente di Workspace, quindi conoscere **uno valido √® sufficiente e necessario per l'impersonificazione**.\
Tuttavia, verranno utilizzati i **privilegi dell'utente impersonato**, quindi se √® un Super Admin sarai in grado di accedere a tutto. Se non ha alcun accesso, ci√≤ sar√† inutile.
{% endhint %}

#### [Generazione Token di Delega GCP](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

Questo semplice script generer√† un **token OAuth come utente delegato** che potrai poi utilizzare per accedere ad altre API Google con o senza `gcloud`:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Questo √® uno strumento che pu√≤ eseguire l'attacco seguendo questi passaggi:

1. **Enumerare i progetti GCP** utilizzando l'API del Gestore delle risorse.
2. Iterare su ciascuna risorsa del progetto e **enumerare le risorse degli account di servizio GCP** a cui l'utente IAM iniziale ha accesso utilizzando _GetIAMPolicy_.
3. Iterare su **ciascun ruolo dell'account di servizio** e trovare ruoli incorporati, di base e personalizzati con il permesso _**serviceAccountKeys.create**_ sulla risorsa dell'account di servizio di destinazione. Va notato che il ruolo di Editor possiede inherentemente questo permesso.
4. Creare una **nuova chiave privata `KEY_ALG_RSA_2048`** per ciascuna risorsa dell'account di servizio trovata con il permesso rilevante nella policy IAM.
5. Iterare su **ciascun nuovo account di servizio e creare un `oggetto JWT`** per esso composto dalle credenziali della chiave privata SA e uno scope OAuth. Il processo di creazione di un nuovo oggetto _JWT_ **iterer√† su tutte le combinazioni esistenti di scope OAuth** dalla lista **oauth\_scopes.txt**, al fine di trovare tutte le possibilit√† di delega. La lista **oauth\_scopes.txt** viene aggiornata con tutti gli scope OAuth che abbiamo trovato rilevanti per abusare delle identit√† di Workspace.
6. Il metodo `_make_authorization_grant_assertion` rivela la necessit√† di dichiarare un **utente di Workspace di destinazione**, denominato _subject_, per generare JWT sotto DWD. Anche se potrebbe sembrare necessario un utente specifico, √® importante capire che **DWD influenza ogni identit√† all'interno di un dominio**. Di conseguenza, creare un JWT per **qualsiasi utente di dominio** influisce su tutte le identit√† in quel dominio, coerentemente con il nostro controllo di enumerazione delle combinazioni. In poche parole, un singolo utente valido di Workspace √® sufficiente per procedere.\
Questo utente pu√≤ essere definito nel file _config.yaml_ di DeleFriend. Se un utente di Workspace di destinazione non √® gi√† noto, lo strumento facilita l'identificazione automatica degli utenti di Workspace validi scansionando gli utenti di dominio con ruoli nei progetti GCP. √à importante notare (ancora una volta) che i JWT sono specifici del dominio e non vengono generati per ogni utente; quindi, il processo automatico mira a un'unica identit√† unica per dominio.
7. **Enumerare e creare un nuovo token di accesso bearer** per ciascun JWT e convalidare il token con l'API tokeninfo.

#### [Script Python di Gitlab](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab ha creato [questo script Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) che pu√≤ fare due cose: elencare la directory degli utenti e creare un nuovo account amministrativo indicando un json con le credenziali SA e l'utente da impersonare. Ecco come si utilizzerebbe:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Creare una nuova delega (Persistenza)

√à possibile **verificare le Deleghe a livello di dominio in** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

Un attaccante con la capacit√† di **creare account di servizio in un progetto GCP** e **privilegi di super amministratore su GWS potrebbe creare una nuova delega consentendo agli account di servizio di impersonare alcuni utenti di GWS:**

1. **Generazione di un nuovo account di servizio e coppia di chiavi corrispondente:** Su GCP, nuove risorse di account di servizio possono essere prodotte interattivamente tramite la console o programmaticamente utilizzando chiamate API dirette e strumenti CLI. Ci√≤ richiede il **ruolo `iam.serviceAccountAdmin`** o qualsiasi ruolo personalizzato dotato dell'**autorizzazione `iam.serviceAccounts.create`**. Una volta creato l'account di servizio, procederemo a generare una **coppia di chiavi correlata** (autorizzazione **`iam.serviceAccountKeys.create`**).
2. **Creazione di una nuova delega**: √à importante comprendere che **solo il ruolo di Super Amministratore possiede la capacit√† di configurare la delega globale a livello di dominio in Google Workspace** e la delega a livello di dominio **non pu√≤ essere configurata in modo programmato,** pu√≤ solo essere creata e regolata **manualmente** tramite la **console di Google Workspace**.
* La creazione della regola pu√≤ essere trovata nella pagina **Controlli API ‚Üí Gestisci la delega a livello di dominio in Google Workspace Admin console**.
3. **Attivazione del privilegio degli ambiti OAuth**: Quando si configura una nuova delega, Google richiede solo 2 parametri, l'ID client, che √® l'**ID OAuth dell'account di servizio GCP**, e **gli ambiti OAuth** che definiscono quali chiamate API richiede la delega.
* L'**elenco completo degli ambiti OAuth** pu√≤ essere trovato [**qui**](https://developers.google.com/identity/protocols/oauth2/scopes), ma ecco una raccomandazione: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **Agire a nome dell'identit√† target:** A questo punto, abbiamo un oggetto delegato funzionante in GWS. Ora, **utilizzando la chiave privata dell'account di servizio GCP, possiamo effettuare chiamate API** (nello scope definito nel parametro di ambito OAuth) per attivarlo e **agire a nome di qualsiasi identit√† esistente in Google Workspace**. Come abbiamo appreso, l'account di servizio generer√† token di accesso secondo le sue esigenze e in base all'autorizzazione che ha per le applicazioni REST API.
* Controlla la **sezione precedente** per alcuni **strumenti** per utilizzare questa delega.

#### Delega tra organizzazioni incrociate

L'ID OAuth dell'account di servizio √® globale e pu√≤ essere utilizzato per **deleghe tra organizzazioni incrociate**. Non √® stata implementata alcuna restrizione per impedire la delega globale incrociata. In parole semplici, **gli account di servizio di diverse organizzazioni GCP possono essere utilizzati per configurare la delega a livello di dominio su altre organizzazioni di Workspace**. Ci√≤ comporterebbe il **bisogno solo di accesso Super Amministratore a Workspace**, e non l'accesso allo stesso account GCP, poich√© l'avversario pu√≤ creare Account di Servizio e chiavi private sul suo account GCP personalmente controllato.

### Creazione di un progetto per enumerare Workspace

Per **default** gli **utenti** di Workspace hanno il permesso di **creare nuovi progetti**, e quando viene creato un nuovo progetto il **creatore ottiene il ruolo di Proprietario** su di esso.

Pertanto, un utente pu√≤ **creare un progetto**, **abilitare** le **API** per enumerare Workspace nel suo nuovo progetto e provare a **enumerarlo**.

{% hint style="danger" %}
Affinch√© un utente possa enumerare Workspace, ha anche bisogno di abbastanza permessi di Workspace (non tutti gli utenti saranno in grado di enumerare la directory).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Controlla **ulteriore enumerazione in**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Abuso di Gcloud

Puoi trovare ulteriori informazioni sul flusso `gcloud` per effettuare il login in:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Come spiegato l√¨, gcloud pu√≤ richiedere lo scope `https://www.googleapis.com/auth/drive` che consentirebbe a un utente di accedere al drive dell'utente.\
Come attaccante, se hai compromesso **fisicamente** il computer di un utente e l'**utente √® ancora connesso** con il suo account, potresti effettuare il login generando un token con accesso al drive utilizzando:
```bash
gcloud auth login --enable-gdrive-access
```
Se un attaccante compromette il computer di un utente potrebbe anche modificare il file `google-cloud-sdk/lib/googlecloudsdk/core/config.py` e aggiungere nello **`CLOUDSDK_SCOPES`** lo scope **`'https://www.googleapis.com/auth/drive'`**:

<figure><img src="../../../.gitbook/assets/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Pertanto, la prossima volta che l'utente effettuer√† l'accesso, verr√† creato un **token con accesso a Drive** che l'attaccante potrebbe sfruttare per accedere a Drive. Ovviamente, il browser indicher√† che il token generato avr√† accesso a Drive, ma poich√© l'utente eseguir√† il comando **`gcloud auth login`**, probabilmente **non sospetter√† nulla.**

Per elencare i file di Drive: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## Da GWS a GCP

### Accesso agli utenti privilegiati di GCP

Se un attaccante ha completo accesso su GWS sar√† in grado di accedere a gruppi con accesso privilegiato su GCP o addirittura agli utenti, quindi passare da GWS a GCP √® di solito pi√π "semplice" solo perch√© **gli utenti in GWS hanno alti privilegi su GCP**.&#x20;

### Escalation dei privilegi dei Google Groups

Per impostazione predefinita gli utenti possono **unirsi liberamente ai gruppi di Workspace dell'Organizzazione** e quei gruppi **potrebbero avere assegnati permessi GCP** (controlla i tuoi gruppi su [https://groups.google.com/](https://groups.google.com/)).

Sfruttando la **google groups privesc** potresti essere in grado di scalare a un gruppo con qualche tipo di accesso privilegiato a GCP.

### Riferimenti

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{% hint style="success" %}
Impara e pratica l'Hacking su AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di Github.

</details>
{% endhint %}
