# GCP - Comprensione della Delega a Livello di Dominio

{% hint style="success" %}
Impara e pratica l'Hacking su AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line"> [**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte) <img src="/.gitbook/assets/image.png" alt="" data-size="line"> \
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line"> [**HackTricks Training GCP Red Team Expert (GRTE)** <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di Github.

</details>
{% endhint %}

Questo post √® l'introduzione di [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) a cui si pu√≤ accedere per ulteriori dettagli.

## **Comprensione della Delega a Livello di Dominio**

La delega a livello di dominio di Google Workspace consente a un oggetto identit√†, sia un **applicazione esterna** dal Google Workspace Marketplace che un **Account di Servizio GCP interno**, di **accedere ai dati in tutto il Workspace per conto degli utenti**. Questa funzionalit√†, fondamentale per le applicazioni che interagiscono con le API di Google o i servizi che necessitano di impersonificazione degli utenti, migliora l'efficienza e riduce gli errori umani automatizzando compiti. Utilizzando OAuth 2.0, gli sviluppatori di app e gli amministratori possono concedere a questi account di servizio l'accesso ai dati degli utenti senza il consenso individuale dell'utente.\
\
Google Workspace consente la creazione di due tipi principali di identit√† oggetto delegate globali:

* **Applicazioni GWS:** Le applicazioni dal Google Workspace Marketplace possono essere configurate come identit√† delegate. Prima di essere rese disponibili nel marketplace, ogni applicazione Workspace viene sottoposta a una revisione da parte di Google per ridurre al minimo possibili abusi. Anche se questo non elimina completamente il rischio di abusi, aumenta significativamente la difficolt√† che tali incidenti si verifichino.
* **Account di Servizio GCP:** Per saperne di pi√π sugli [**Account di Servizio GCP clicca qui**](../gcp-basic-information/#service-accounts).

### **Delega a Livello di Dominio: Nel Dettaglio**

Ecco come un Account di Servizio GCP pu√≤ accedere alle API di Google per conto di altre identit√† in Google Workspace:

<figure><img src="../../../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

1. **L'Identit√† crea un JWT:** L'Identit√† utilizza la chiave privata dell'account di servizio (parte del file di coppia di chiavi JSON) per firmare un JWT. Questo JWT contiene informazioni sull'account di servizio, sull'utente di destinazione da impersonare e sugli ambiti OAuth di accesso all'API REST richiesta.
2. **L'Identit√† utilizza il JWT per richiedere un token di accesso:** L'applicazione/l'utente utilizza il JWT per richiedere un token di accesso dal servizio OAuth 2.0 di Google. La richiesta include anche l'utente di destinazione da impersonare (l'email dell'utente di Workspace) e gli ambiti per i quali viene richiesto l'accesso.
3. **Il servizio OAuth 2.0 di Google restituisce un token di accesso:** Il token di accesso rappresenta l'autorit√† dell'account di servizio di agire per conto dell'utente per gli ambiti specificati. Questo token √® tipicamente a breve termine e deve essere aggiornato periodicamente (secondo le esigenze dell'applicazione). √à essenziale comprendere che gli ambiti OAuth specificati nel token JWT hanno validit√† e impatto sul token di accesso risultante. Ad esempio, i token di accesso che possiedono pi√π ambiti avranno validit√† per numerose applicazioni API REST.
4. **L'Identit√† utilizza il token di accesso per chiamare le API di Google**: Ora con un token di accesso pertinente, il servizio pu√≤ accedere all'API REST richiesta. L'applicazione utilizza questo token di accesso nell'intestazione "Autorizzazione" delle sue richieste HTTP destinate alle API di Google. Queste API utilizzano il token per verificare l'identit√† impersonata e confermare che abbia l'autorizzazione necessaria.
5. **Le API di Google restituiscono i dati richiesti**: Se il token di accesso √® valido e l'account di servizio ha l'autorizzazione appropriata, le API di Google restituiscono i dati richiesti. Ad esempio, nella seguente immagine, abbiamo sfruttato il metodo _users.messages.list_ per elencare tutti gli ID dei messaggi Gmail associati a un utente di Workspace di destinazione.

{% hint style="success" %}
Impara e pratica l'Hacking su AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line"> [**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte) <img src="/.gitbook/assets/image.png" alt="" data-size="line"> \
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line"> [**HackTricks Training GCP Red Team Expert (GRTE)** <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di Github.

</details>
{% endhint %}
