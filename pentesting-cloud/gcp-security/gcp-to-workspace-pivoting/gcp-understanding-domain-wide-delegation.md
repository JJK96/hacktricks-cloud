# GCP - Alan Geniş Delegasyonun Anlaşılması

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

Bu yazı, daha fazla ayrıntı için erişilebilen [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) adresindeki [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) adresindeki giriş yazısıdır.

## **Alan Geniş Delegasyonunun Anlaşılması**

Google Workspace'in Alan Geniş Delegasyonu, bir **harici uygulama** (Google Workspace Marketplace'den) veya bir iç **GCP Hizmet Hesabı** olmak üzere bir kimlik nesnesinin, kullanıcılar adına Workspace üzerindeki verilere **erişmesine izin verir**. Google API'leri ile etkileşim kuran uygulamalar veya kullanıcı taklitine ihtiyaç duyan hizmetler için hayati olan bu özellik, görevleri otomatikleştirerek verimliliği artırır ve insan hatalarını en aza indirir. OAuth 2.0 kullanarak, uygulama geliştiricileri ve yöneticiler, bu hizmet hesaplarına bireysel kullanıcı onayı olmaksızın erişim izni verebilirler.\
\
Google Workspace, iki ana türde global delegasyon nesnesi kimlik oluşturmayı sağlar:

* **GWS Uygulamaları:** Workspace Marketplace'den uygulamalar, bir delegasyon kimliği olarak yapılandırılabilir. Marketplace'de mevcut hale getirilmeden önce, her Workspace uygulaması, olası kötüye kullanımı en aza indirmek için Google tarafından incelenir. Bu, kötüye kullanım riskini tamamen ortadan kaldırmaz, ancak bu tür olayların gerçekleşme olasılığını önemli ölçüde azaltır.
* **GCP Hizmet Hesabı:** [**GCP Hizmet Hesapları hakkında daha fazla bilgi edinin**](../gcp-basic-information/#service-accounts).

### **Alan Geniş Delegasyonu: İç Mekanizma**

Bir GCP Hizmet Hesabının, Google Workspace'deki diğer kimlikler adına Google API'lerine erişmesi şu şekilde gerçekleşir:

<figure><img src="../../../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

1. **Kimlik bir JWT oluşturur:** Kimlik, hizmet hesabının özel anahtarını (JSON anahtar çifti dosyasının bir parçası) kullanarak bir JWT imzalar. Bu JWT, istenen REST API'sine erişim kapsamı için hizmet hesabı, taklit edilecek hedef kullanıcı ve OAuth kapsamları hakkında iddialar içerir.
2. **Kimlik, bir erişim belirteci istemek için JWT'yi kullanır:** Uygulama/kullanıcı, JWT'yi Google'ın OAuth 2.0 hizmetinden bir erişim belirteci istemek için kullanır. İstek ayrıca taklit edilecek hedef kullanıcıyı (kullanıcının Workspace e-postası) ve erişim istendiği kapsamları içerir.
3. **Google'ın OAuth 2.0 hizmeti bir erişim belirteci döndürür:** Erişim belirteci, hizmet hesabının belirtilen kapsamlar için kullanıcı adına hareket etme yetkisini temsil eder. Bu belirteç genellikle kısa ömürlüdür ve periyodik olarak yenilenmelidir (uygulamanın ihtiyacına göre). JWT belirtecinde belirtilen OAuth kapsamlarının geçerliliği ve erişim belirteci üzerindeki etkisi önemlidir. Örneğin, birden fazla kapsama sahip erişim belirteçleri, birçok REST API uygulaması için geçerlilik sağlar.
4. **Kimlik, Google API'lerini aramak için erişim belirtecini kullanır**: Artık ilgili bir erişim belirteciyle, hizmet gerekli REST API'ye erişebilir. Uygulama, bu erişim belirtecini, Google API'lerine yönelik HTTP istekleri için "Yetkilendirme" başlığında kullanır. Bu API'ler, taklit edilen kimliği doğrulamak ve gerekli yetkiye sahip olduğunu onaylamak için bu belirteci kullanır.
5. **Google API'leri istenen verileri döndürür**: Erişim belirteci geçerli ise ve hizmet hesabının uygun yetkisi varsa, Google API'leri istenen verileri döndürür. Örneğin, aşağıdaki resimde, bir hedef Workspace kullanıcısıyla ilişkilendirilen tüm Gmail mesaj kimliklerini listelemek için _users.messages.list_ yöntemini kullandık.

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
