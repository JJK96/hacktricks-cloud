# GCP - Compreens√£o da Delega√ß√£o em Toda a Organiza√ß√£o

{% hint style="success" %}
Aprenda e pratique Hacking na AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line"> [**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte) <img src="/.gitbook/assets/image.png" alt="" data-size="line"> \
Aprenda e pratique Hacking na GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line"> [**Treinamento HackTricks GCP Red Team Expert (GRTE)** <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

- Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
- **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
- **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

Este post √© a introdu√ß√£o de [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) que pode ser acessado para mais detalhes.

## **Compreens√£o da Delega√ß√£o em Toda a Organiza√ß√£o**

A delega√ß√£o em toda a organiza√ß√£o do Google Workspace permite que um objeto de identidade, seja um **aplicativo externo** do Google Workspace Marketplace ou uma **Conta de Servi√ßo GCP** interna, **acesse dados em todo o Workspace em nome dos usu√°rios**. Este recurso, que √© crucial para aplicativos que interagem com APIs do Google ou servi√ßos que precisam de impersonifica√ß√£o de usu√°rio, melhora a efici√™ncia e minimiza erros humanos automatizando tarefas. Usando OAuth 2.0, desenvolvedores de aplicativos e administradores podem conceder a essas contas de servi√ßo acesso aos dados do usu√°rio sem consentimento individual do usu√°rio. \
\
O Google Workspace permite a cria√ß√£o de dois principais tipos de identidades de objeto delegadas globais:

- **Aplicativos GWS:** Aplicativos do Workspace Marketplace podem ser configurados como uma identidade delegada. Antes de serem disponibilizados no mercado, cada aplicativo do Workspace passa por uma revis√£o do Google para minimizar poss√≠veis abusos. Embora isso n√£o elimine totalmente o risco de abuso, aumenta significativamente a dificuldade para tais incidentes ocorrerem.
- **Conta de Servi√ßo GCP:** Saiba mais sobre [**Contas de Servi√ßo GCP aqui**](../gcp-basic-information/#service-accounts).

### **Delega√ß√£o em Toda a Organiza√ß√£o: Por Dentro**

Assim √© como uma Conta de Servi√ßo GCP pode acessar APIs do Google em nome de outras identidades no Google Workspace:

<figure><img src="../../../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

1. **Identidade cria um JWT:** A identidade usa a chave privada da conta de servi√ßo (parte do arquivo de par de chaves JSON) para assinar um JWT. Este JWT cont√©m reivindica√ß√µes sobre a conta de servi√ßo, o usu√°rio alvo para impersonificar e os escopos OAuth de acesso √† API REST que est√° sendo solicitada.
2. **A identidade usa o JWT para solicitar um token de acesso:** O aplicativo/usu√°rio usa o JWT para solicitar um token de acesso do servi√ßo OAuth 2.0 do Google. A solicita√ß√£o tamb√©m inclui o usu√°rio alvo para impersonificar (o e-mail do usu√°rio do Workspace) e os escopos para os quais o acesso √© solicitado.
3. **O servi√ßo OAuth 2.0 do Google retorna um token de acesso:** O token de acesso representa a autoridade da conta de servi√ßo para agir em nome do usu√°rio para os escopos especificados. Este token √© tipicamente de curta dura√ß√£o e deve ser atualizado periodicamente (conforme a necessidade do aplicativo). √â essencial entender que os escopos OAuth especificados no token JWT t√™m validade e impacto no token de acesso resultante. Por exemplo, tokens de acesso possuindo v√°rios escopos ter√£o validade para numerosas aplica√ß√µes de API REST.
4. **A identidade usa o token de acesso para chamar APIs do Google**: Agora, com um token de acesso relevante, o servi√ßo pode acessar a API REST necess√°ria. O aplicativo usa este token de acesso no cabe√ßalho "Autoriza√ß√£o" de suas solicita√ß√µes HTTP destinadas √†s APIs do Google. Estas APIs utilizam o token para verificar a identidade impersonificada e confirmar que ela possui a autoriza√ß√£o necess√°ria.
5. **As APIs do Google retornam os dados solicitados**: Se o token de acesso for v√°lido e a conta de servi√ßo tiver a autoriza√ß√£o apropriada, as APIs do Google retornam os dados solicitados. Por exemplo, na imagem a seguir, utilizamos o m√©todo _users.messages.list_ para listar todos os IDs de mensagens do Gmail associados a um usu√°rio alvo do Workspace.

{% hint style="success" %}
Aprenda e pratique Hacking na AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line"> [**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte) <img src="/.gitbook/assets/image.png" alt="" data-size="line"> \
Aprenda e pratique Hacking na GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line"> [**Treinamento HackTricks GCP Red Team Expert (GRTE)** <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

- Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
- **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
- **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
