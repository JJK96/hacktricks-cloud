# GCP - ドメインワイドデリゲーションの理解

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、ハッキングテクニックを共有してください。

</details>
{% endhint %}

この投稿は、[https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)の紹介です。詳細についてはリンクを参照してください。

## **ドメインワイドデリゲーションの理解**

Google Workspaceのドメインワイドデリゲーションは、Google Workspace Marketplaceからの**外部アプリ**または内部の**GCPサービスアカウント**が**ユーザーを代表してWorkspace全体のデータにアクセス**できるようにします。この機能は、Google APIとやり取りするアプリやユーザーの模倣が必要なサービスが効率を高め、タスクを自動化することで人為的なエラーを最小限に抑えます。OAuth 2.0を使用して、アプリの開発者や管理者はこれらのサービスアカウントにユーザーデータへのアクセス権を個々のユーザーの同意なしに与えることができます。

Google Workspaceでは、次の2つの主要なグローバルデリゲートオブジェクトアイデンティティを作成できます:

* **GWSアプリケーション:** Workspace Marketplaceからのアプリケーションをデリゲートアイデンティティとして設定できます。各Workspaceアプリケーションは、潜在的な誤用を最小限に抑えるためにGoogleによる審査を受けた後、マーケットプレイスで利用可能になります。これにより、誤用のリスクは完全に排除されませんが、そのようなインシデントが発生する難易度は大幅に増加します。
* **GCPサービスアカウント:** [**こちらでGCPサービスアカウントについて詳しく学ぶ**](../gcp-basic-information/#service-accounts)。

### **ドメインワイドデリゲーション: 内部構造**

これがGCPサービスアカウントがGoogle APIに他のGoogle Workspaceのアイデンティティを代表してアクセスする方法です:

<figure><img src="../../../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

1. **アイデンティティがJWTを作成:** アイデンティティは、サービスアカウントの秘密鍵（JSONキーペアファイルの一部）を使用してJWTに署名します。このJWTには、サービスアカウントに関するクレーム、模倣するターゲットユーザー、リクエストされているREST APIへのアクセスのOAuthスコープが含まれています。
2. **アイデンティティがアクセストークンをリクエストに使用:** アプリケーション/ユーザーは、JWTを使用してGoogleのOAuth 2.0サービスからアクセストークンをリクエストします。リクエストには、模倣するターゲットユーザー（ユーザーのWorkspaceメール）と、アクセスがリクエストされているスコープが含まれます。
3. **GoogleのOAuth 2.0サービスがアクセストークンを返す:** アクセストークンは、サービスアカウントが指定されたスコープのユーザーを代表してアクションを実行する権限を表します。このトークンは通常、短命であり、定期的に更新する必要があります（アプリケーションの必要に応じて）。JWTトークンで指定されたOAuthスコープがアクセストークンに対して有効であり、影響を与えることが重要です。たとえば、複数のスコープを持つアクセストークンは、多数のREST APIアプリケーションに対して有効です。
4. **アイデンティティがアクセストークンを使用してGoogle APIを呼び出す**: 関連するアクセストークンを使用して、サービスは必要なREST APIにアクセスできます。アプリケーションは、これらのアクセストークンをGoogle APIに向けたHTTPリクエストの「Authorization」ヘッダーに使用します。これらのAPIは、トークンを使用して模倣されたアイデンティティを検証し、必要な権限を持っていることを確認します。
5. **Google APIが要求されたデータを返す**: アクセストークンが有効であり、サービスアカウントに適切な権限がある場合、Google APIは要求されたデータを返します。たとえば、次の図では、_users.messages.list_メソッドを使用して、対象のWorkspaceユーザーに関連するすべてのGmailメッセージIDをリストアップしています。

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、ハッキングテクニックを共有してください。

</details>
{% endhint %}
