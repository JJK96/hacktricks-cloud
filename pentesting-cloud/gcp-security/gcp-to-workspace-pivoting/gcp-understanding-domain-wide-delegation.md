# GCP - Begrip van Domeinwye Delegering

{% hint style="success" %}
Leer & oefen AWS Hack: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Controleer de [**abonnementsplannen**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

Hierdie pos is die inleiding van [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) wat besoek kan word vir meer besonderhede.

## **Begrip van Domeinwye Delegering**

Google Workspace se Domeinwye delegering maak dit moontlik vir 'n identiteitsobjek, of dit nou 'n **eksterne toepassing** van Google Workspace Marketplace is of 'n interne **GCP-diensrekening**, om **data regoor die Workspace namens gebruikers te benader**. Hierdie kenmerk, wat noodsaaklik is vir toepassings wat met Google API's interaksie h√™ of dienste wat gebruikersverpersoonliking benodig, verbeter doeltreffendheid en minimaliseer menslike foute deur take te outomatiseer. Deur gebruik te maak van OAuth 2.0, kan toepassingsontwikkelaars en administrateurs hierdie diensrekeninge toegang tot gebruikersdata gee sonder individuele gebruikersgoedkeuring.\
\
Google Workspace maak die skepping van twee hooftipes globale gedelegeerde objekidentiteite moontlik:

* **GWS-toepassings:** Toepassings van die Workspace Marketplace kan as 'n gedelegeerde identiteit opgestel word. Voordat dit in die mark beskikbaar gestel word, ondergaan elke Workspace-toepassing 'n hersiening deur Google om potensi√´le misbruik te minimaliseer. Alhoewel dit nie die risiko van misbruik heeltemal uitskakel nie, verhoog dit die moeilikheid vir sulke voorvalle aansienlik.
* **GCP-diensrekening:** Leer meer oor [**GCP-diensrekeninge hier**](../gcp-basic-information/#service-accounts).

### **Domeinwye Delegering: Onder die Skerms**

So kan 'n GCP-diensrekening Google API's namens ander identiteite in Google Workspace benader:

<figure><img src="../../../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

1. **Identiteit skep 'n JWT:** Die identiteit gebruik die privaatsleutel van die diensrekening (deel van die JSON-sleutelpaar l√™er) om 'n JWT te onderteken. Hierdie JWT bevat eise oor die diensrekening, die teikengebruiker om te verpersoonlik, en die OAuth-scope van toegang tot die REST-API wat aangevra word.
2. **Die Identiteit gebruik die JWT om 'n toegangsteken aan te vra:** Die toepassing/gebruiker gebruik die JWT om 'n toegangsteken van Google se OAuth 2.0-diens aan te vra. Die versoek sluit ook die teikengebruiker om te verpersoonlik (die gebruiker se Workspace-e-pos) en die scopes waarvoor toegang aangevra word, in.
3. **Google se OAuth 2.0-diens gee 'n toegangsteken terug:** Die toegangsteken verteenwoordig die gesag van die diensrekening om namens die gebruiker op te tree vir die gespesifiseerde scopes. Hierdie teken is tipies kortstondig en moet periodiek hernu word (volgens die toepassing se behoefte). Dit is noodsaaklik om te verstaan dat die OAuth-scopes wat in die JWT-teken gespesifiseer is, geldigheid het en 'n impak op die resulterende toegangsteken het. Byvoorbeeld, toegangstekens met verskeie scopes sal geldigheid h√™ vir verskeie REST-API-toepassings.
4. **Die Identiteit gebruik die toegangsteken om Google API's te roep:** Nou, met 'n relevante toegangsteken, kan die diens die vereiste REST-API benader. Die toepassing gebruik hierdie toegangsteken in die "Authorization" kop van sy HTTP-versoeke wat bestem is vir Google API's. Hierdie API's gebruik die teken om die verpersoonlikte identiteit te verifieer en te bevestig dat dit die nodige magtiging het.
5. **Google API's gee die versoekte data terug:** As die toegangsteken geldig is en die diensrekening die nodige magtiging het, gee die Google API's die versoekte data terug. Byvoorbeeld, in die volgende prentjie het ons die _users.messages.list_ metode gebruik om al die Gmail-boodskap-ID's wat met 'n teiken Workspace-gebruiker geassosieer word, te lys.

{% hint style="success" %}
Leer & oefen AWS Hack: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**abonnementsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
