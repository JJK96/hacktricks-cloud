# GCP - Razumevanje Delegacije na Nivou Domena

{% hint style="success" %}
Naučite i vežbajte hakovanje AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Obuka AWS Crveni Tim Ekspert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte hakovanje GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Obuka GCP Crveni Tim Ekspert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

Ovaj post je uvod u [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) gde se može pristupiti više detalja.

## **Razumevanje Delegacije na Nivou Domena**

Delegacija na nivou domena u Google Workspace-u omogućava objektu identiteta, bilo da je to **spoljni aplikacija** sa Google Workspace Marketplace-a ili interni **GCP Servisni Nalog**, da **pristupi podacima širom Workspace-a u ime korisnika**. Ova funkcija, koja je ključna za aplikacije koje interaguju sa Google API-jima ili uslugama koje zahtevaju impersonaciju korisnika, poboljšava efikasnost i minimizira ljudske greške automatizacijom zadataka. Korišćenjem OAuth 2.0, razvojni programeri aplikacija i administratori mogu dati ovim servisnim nalozima pristup korisničkim podacima bez pojedinačne saglasnosti korisnika.\
\
Google Workspace omogućava kreiranje dva glavna tipa globalnih delegiranih objekata identiteta:

* **GWS Aplikacije:** Aplikacije sa Workspace Marketplace-a mogu biti podešene kao delegirani identitet. Pre nego što postanu dostupne na tržištu, svaka Workspace aplikacija prolazi kroz pregled od strane Google-a kako bi se minimizirala potencijalna zloupotreba. Iako ovo ne eliminiše potpuno rizik od zloupotrebe, značajno povećava težinu za takve incidente da se dese.
* **GCP Servisni Nalog:** Saznajte više o [**GCP Servisnim Nalozima ovde**](../gcp-basic-information/#service-accounts).

### **Delegacija na Nivou Domena: Iznutra**

Ovako GCP Servisni Nalog može pristupiti Google API-jima u ime drugih identiteta u Google Workspace-u:

<figure><img src="../../../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

1. **Identitet kreira JWT:** Identitet koristi privatni ključ servisnog naloga (deo JSON ključnog para fajla) da potpiše JWT. Ovaj JWT sadrži tvrdnje o servisnom nalogu, ciljanom korisniku za impersonaciju i OAuth opsege pristupa REST API-ju koji se zahteva.
2. **Identitet koristi JWT da zatraži pristupni token:** Aplikacija/korisnik koristi JWT da zatraži pristupni token od Google-ovog OAuth 2.0 servisa. Zahtev takođe uključuje ciljanog korisnika za impersonaciju (email korisnika Workspace-a) i opsege za koje se zahteva pristup.
3. **Google-ov OAuth 2.0 servis vraća pristupni token:** Pristupni token predstavlja ovlašćenje servisnog naloga da deluje u ime korisnika za određene opsege. Ovaj token je obično kratkotrajan i mora se osvežavati periodično (prema potrebi aplikacije). Važno je razumeti da OAuth opsezi navedeni u JWT tokenu imaju važnost i uticaj na rezultantni pristupni token. Na primer, pristupni tokeni koji poseduju više opsega će imati važnost za brojne REST API aplikacije.
4. **Identitet koristi pristupni token da pozove Google API-je**: Sada sa relevantnim pristupnim tokenom, servis može pristupiti potrebnom REST API-ju. Aplikacija koristi ovaj pristupni token u "Authorization" zaglavlju svojih HTTP zahteva namenjenih Google API-jima. Ovi API-ji koriste token da provere impersonirani identitet i potvrde da ima neophodnu autorizaciju.
5. **Google API-ji vraćaju tražene podatke**: Ako je pristupni token validan i servisni nalog ima odgovarajuću autorizaciju, Google API-ji vraćaju tražene podatke. Na primer, na sledećoj slici, iskoristili smo _users.messages.list_ metod da bismo naveli sve Gmail ID poruka povezanih sa ciljanim korisnikom Workspace-a. 

{% hint style="success" %}
Naučite i vežbajte hakovanje AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Obuka AWS Crveni Tim Ekspert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte hakovanje GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Obuka GCP Crveni Tim Ekspert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
