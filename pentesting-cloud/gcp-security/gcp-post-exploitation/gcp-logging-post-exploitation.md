# GCP - Logging Post Exploitation

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}

## Informazioni di Base

Per maggiori informazioni controlla:

{% content-ref url="../gcp-services/gcp-logging-enum.md" %}
[gcp-logging-enum.md](../gcp-services/gcp-logging-enum.md)
{% endcontent-ref %}

Per altri modi di interrompere il monitoraggio controlla:

{% content-ref url="gcp-monitoring-post-exploitation.md" %}
[gcp-monitoring-post-exploitation.md](gcp-monitoring-post-exploitation.md)
{% endcontent-ref %}

### Logging Predefinito

**Per impostazione predefinita non verrai catturato solo per aver eseguito azioni di lettura. Per maggiori informazioni controlla la sezione Logging Enum.**

### Aggiungi Principale Eccettuato

In [https://console.cloud.google.com/iam-admin/audit/allservices](https://console.cloud.google.com/iam-admin/audit/allservices) e [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) √® possibile aggiungere principali per non generare log. Un attaccante potrebbe abusare di questo per evitare di essere catturato.

### Leggi i log - `logging.logEntries.list`

{% code overflow="wrap" %}
```bash
# Read logs
gcloud logging read "logName=projects/your-project-id/logs/log-id" --limit=10 --format=json

# Everything from a timestamp
gcloud logging read "timestamp >= \"2023-01-01T00:00:00Z\"" --limit=10 --format=json

# Use these options to indicate a different bucket or view to use: --bucket=_Required  --view=_Default
```
{% endcode %}

### `logging.logs.delete`

{% code overflow="wrap" %}
```bash
# Delete all entries from a log in the _Default log bucket - logging.logs.delete
gcloud logging logs delete <log-name>
```
{% endcode %}

### Scrivere log - `logging.logEntries.create`

{% code overflow="wrap" %}
```bash
# Write a log entry to try to disrupt some system
gcloud logging write LOG_NAME "A deceptive log entry" --severity=ERROR
```
{% endcode %}

### `logging.buckets.update`

{% code overflow="wrap" %}
```bash
# Set retention period to 1 day (_Required has a fixed one of 400days)

gcloud logging buckets update bucketlog --location=<location> --description="New description" --retention-days=1
```
{% endcode %}

### `logging.buckets.delete`

### Descrizione

Questa autorizzazione consente a un utente di eliminare un bucket di log. L'eliminazione di un bucket di log pu√≤ essere utile per un attaccante per coprire le proprie tracce.

### Esempio di utilizzo

```bash
gcloud logging buckets delete BUCKET_ID --location=LOCATION
```

### `logging.sinks.delete`

### Descrizione

Questa autorizzazione consente a un utente di eliminare un sink di log. I sink di log sono utilizzati per esportare i log in altre destinazioni come Cloud Storage, BigQuery o Pub/Sub. Eliminando un sink di log, un attaccante pu√≤ interrompere l'esportazione dei log e nascondere le proprie attivit√†.

### Esempio di utilizzo

```bash
gcloud logging sinks delete SINK_NAME
```

### `logging.logs.delete`

### Descrizione

Questa autorizzazione consente a un utente di eliminare log specifici. Un attaccante pu√≤ utilizzare questa autorizzazione per eliminare log specifici che potrebbero contenere prove delle sue attivit√†.

### Esempio di utilizzo

```bash
gcloud logging logs delete LOG_NAME
```

### `logging.exclusions.create`

### Descrizione

Questa autorizzazione consente a un utente di creare esclusioni di log. Le esclusioni di log possono essere utilizzate per impedire che determinati log vengano scritti. Un attaccante pu√≤ creare esclusioni per evitare che le sue attivit√† vengano registrate.

### Esempio di utilizzo

```bash
gcloud logging exclusions create EXCLUSION_NAME --log-filter=FILTER
```

### `logging.exclusions.delete`

### Descrizione

Questa autorizzazione consente a un utente di eliminare esclusioni di log. Eliminando un'esclusione, un attaccante pu√≤ ripristinare la registrazione dei log precedentemente esclusi.

### Esempio di utilizzo

```bash
gcloud logging exclusions delete EXCLUSION_NAME
```
```bash
# Delete log bucket
gcloud logging buckets delete BUCKET_NAME --location=<location>
```
### `logging.links.delete`

{% code overflow="wrap" %}
```bash
# Delete link
gcloud logging links delete <link-id> --bucket <bucket> --location <location>
```
{% endcode %}

### `logging.views.delete`

### Descrizione

Questo permesso consente a un utente di eliminare una vista di log specifica. Le viste di log sono utilizzate per filtrare e visualizzare i log in Google Cloud Logging.

### Rilevanza per il post-exploitation

Durante le attivit√† di post-exploitation, un attaccante potrebbe voler eliminare le viste di log per nascondere le proprie tracce. Eliminando le viste di log, l'attaccante pu√≤ impedire agli amministratori di sistema di visualizzare i log che potrebbero rivelare attivit√† malevole.

### Mitigazione

Per mitigare questo rischio, √® importante limitare il permesso `logging.views.delete` solo agli utenti che ne hanno effettivamente bisogno. Inoltre, √® consigliabile monitorare e registrare tutte le attivit√† di eliminazione delle viste di log per rilevare eventuali comportamenti sospetti.

{% endcode %}
```bash
# Delete a logging view to remove access to anyone using it
gcloud logging views delete <view-id> --bucket=<bucket> --location=global
```
### `logging.views.update`

{% code overflow="wrap" %}
```bash
# Update a logging view to hide data
gcloud logging views update <view-id> --log-filter="resource.type=gce_instance" --bucket=<bucket> --location=global --description="New description for the log view"
```
{% endcode %}

### `logging.logMetrics.update`

{% code overflow="wrap" %}
```bash
# Update log based metrics - logging.logMetrics.update
gcloud logging metrics update <metric-name> --description="Changed metric description" --log-filter="severity>CRITICAL" --project=PROJECT_ID
```
{% endcode %}

### `logging.logMetrics.delete`

### Descrizione

Questa autorizzazione consente a un utente di eliminare metriche di log specifiche. Le metriche di log sono utilizzate per monitorare e analizzare i log in GCP. Eliminando queste metriche, un utente malintenzionato potrebbe nascondere le proprie tracce o impedire il rilevamento di attivit√† sospette.

### Impatto

L'eliminazione delle metriche di log pu√≤ avere un impatto significativo sulla capacit√† di monitorare e rilevare attivit√† sospette all'interno di un ambiente GCP. Senza queste metriche, potrebbe essere pi√π difficile identificare comportamenti anomali o potenziali violazioni della sicurezza.

### Mitigazione

Per mitigare questo rischio, √® importante limitare l'accesso all'autorizzazione `logging.logMetrics.delete` solo agli utenti che ne hanno effettivamente bisogno. Inoltre, √® consigliabile implementare controlli di monitoraggio e auditing per rilevare eventuali eliminazioni non autorizzate di metriche di log.

{% endcode %}
```bash
# Delete log based metrics - logging.logMetrics.delete
gcloud logging metrics delete <metric-name>
```
### `logging.sinks.delete`

Questa autorizzazione consente a un utente di eliminare un sink di logging. Un sink di logging √® una risorsa che specifica una destinazione in cui inviare i log. Eliminando un sink, un utente pu√≤ interrompere l'invio di log a una destinazione specifica, il che pu√≤ essere utile per nascondere attivit√† malevole.

### `logging.sinks.update`

Questa autorizzazione consente a un utente di aggiornare un sink di logging esistente. Aggiornando un sink, un utente pu√≤ modificare la destinazione o i filtri dei log, potenzialmente per evitare che certe attivit√† vengano registrate.

### `logging.sinks.create`

Questa autorizzazione consente a un utente di creare un nuovo sink di logging. Creando un nuovo sink, un utente pu√≤ indirizzare i log a una destinazione controllata, permettendo di monitorare o manipolare i log a proprio vantaggio.

### `logging.logs.delete`

Questa autorizzazione consente a un utente di eliminare log specifici. Eliminando i log, un utente pu√≤ rimuovere tracce di attivit√† malevole, rendendo pi√π difficile per gli amministratori rilevare intrusioni o altre azioni non autorizzate.

### `logging.logEntries.create`

Questa autorizzazione consente a un utente di creare nuove voci di log. Creando voci di log, un utente pu√≤ inserire informazioni false o fuorvianti nei log, confondendo gli amministratori o coprendo le proprie tracce.

### `logging.logEntries.list`

Questa autorizzazione consente a un utente di elencare le voci di log esistenti. Elencando le voci di log, un utente pu√≤ ottenere informazioni sulle attivit√† registrate, aiutandolo a pianificare ulteriori azioni malevole o a evitare il rilevamento.
```bash
# Delete sink - logging.sinks.delete
gcloud logging sinks delete <sink-name>
```
### `logging.sinks.update`

{% code overflow="wrap" %}
```bash
# Disable sink - logging.sinks.update
gcloud logging sinks update <sink-name> --disabled

# Createa filter to exclude attackers logs - logging.sinks.update
gcloud logging sinks update SINK_NAME --add-exclusion="name=exclude-info-logs,filter=severity<INFO"

# Change where the sink is storing the data - logging.sinks.update
gcloud logging sinks update <sink-name> new-destination

# Change the service account to one withuot permissions to write in the destination - logging.sinks.update
gcloud logging sinks update SINK_NAME --custom-writer-identity=attacker-service-account-email --project=PROJECT_ID

# Remove explusions to try to overload with logs - logging.sinks.update
gcloud logging sinks update SINK_NAME --clear-exclusions

# If the sink exports to BigQuery, an attacker might enable or disable the use of partitioned tables, potentially leading to inefficient querying and higher costs. - logging.sinks.update
gcloud logging sinks update SINK_NAME --use-partitioned-tables
gcloud logging sinks update SINK_NAME --no-use-partitioned-tables
```
{% endcode %}

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}
