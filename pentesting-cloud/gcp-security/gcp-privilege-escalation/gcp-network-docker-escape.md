# GCP - Netwerk Docker Ontsnapping

{% hint style="success" %}
Leer & oefen AWS Hacken: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacken: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Controleer de [**abonnementsplannen**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Aanvanklike Toestand

In beide beskrywings waar hierdie tegniek gespesifiseer is, het die aanvallers **root** toegang binne 'n **Docker** houer wat deur GCP bestuur word, met toegang tot die gasheer-netwerk (en die vermo√´ns **`CAP_NET_ADMIN`** en **`CAP_NET_RAW`**).

## Aanval Verduideliking

Op 'n Google Compute Engine-instantie toon gereelde inspeksie van netwerkverkeer talryke **gewone HTTP-aanvrae** na die **metadata-instantie** by `169.254.169.254`. Die [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), 'n oopbron-diens, maak gereeld sulke aanvrae.

Hierdie agent is ontwerp om **veranderinge in die metadata te monitor**. Die metadata sluit veral 'n **veld vir SSH openbare sleutels** in. Wanneer 'n nuwe openbare SSH-sleutel by die metadata gevoeg word, **magtig** die agent dit outomaties in die `.authorized_key`-l√™er. Dit kan ook 'n nuwe gebruiker **skep** en hulle by **sudoers** voeg indien nodig.

Die agent monitor veranderinge deur 'n versoek te stuur om alle metadata-waardes outomaties te **herwin** (`GET /computeMetadata/v1/?recursive=true`). Hierdie versoek is ontwerp om die metadata-bediener te laat reageer slegs as daar enige verandering in die metadata sedert die laaste herwinning is, ge√Ødentifiseer deur 'n Etag (`wait_for_change=true&last_etag=`). Daarbenewens word 'n **tydsbeperking**-parameter (`timeout_sec=`) ingesluit. As geen verandering binne die gespesifiseerde tydsbeperking plaasvind nie, reageer die bediener met die **onveranderde waardes**.

Hierdie proses laat die **IMDS** (Instantie Metadata-diens) toe om na **60 sekondes** te reageer as geen konfigurasieverandering plaasgevind het nie, wat 'n potensi√´le **venster skep vir die inspuiting van 'n valse konfigurasierespons** na die gasheeragent.

'n Aanvaller kan hierdie uitbuit deur 'n **Man-in-the-Middle (MitM) aanval** uit te voer, waar die respons van die IMDS-bediener vervals word en 'n nuwe openbare sleutel **ingepas** word. Dit kan ongemagtigde SSH-toegang tot die gasheer moontlik maak.

### Ontsnappings Tegniek

Alhoewel ARP-spoofing ondoeltreffend is op Google Compute Engine-netwerke, kan 'n [**aangepaste weergawe van rshijack**](https://github.com/ezequielpereira/rshijack) ontwikkel deur [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) gebruik word vir pakketinspuiting in die kommunikasie om die SSH-gebruiker in te spuit.

Hierdie weergawe van rshijack maak dit moontlik om die ACK- en SEQ-nommers as opdraglyn-argumente in te voer, wat die vervalsing van 'n respons voor die werklike Metadata-bedienerrespons fasiliteer. Daarbenewens word 'n [**klein Shell-skrip**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) gebruik om 'n **spesiaal saamgestelde lading** terug te stuur. Hierdie lading aktiveer die Google Guest Agent om 'n gebruiker `wouter` te **skep** met 'n gespesifiseerde openbare sleutel in die `.authorized_keys`-l√™er.

Die skrip gebruik dieselfde ETag om te voorkom dat die Metadata-bediener die Google Guest Agent onmiddellik in kennis stel van verskillende metadata-waardes, wat die respons vertraag.

Om die vervalsing uit te voer, is die volgende stappe nodig:

1. **Monitor versoek na die Metadata-bediener** deur **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Soek na 'n lyn soortgelyk aan:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Stuur die valse metadata data met die korrekte ETAG na rshijack:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Hierdie stap magtig die openbare sleutel, wat SSH-verbinding met die ooreenstemmende privaatsleutel moontlik maak.


## Verwysings

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
Leer & oefen AWS-hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP-hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
