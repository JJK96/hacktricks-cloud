# GCP - Διαφυγή Δοχείου Δικτύου

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) στο GitHub.

</details>
{% endhint %}

## Αρχική Κατάσταση

Σε και τα δύο άρθρα όπου αναφέρεται αυτή η τεχνική, οι επιτιθέμενοι κατάφεραν να αποκτήσουν πρόσβαση **root** μέσα σε ένα **Docker** container που διαχειρίζεται η GCP με πρόσβαση στο δίκτυο του κεντρικού υπολογιστή (host network) (και τις δυνατότητες **`CAP_NET_ADMIN`** και **`CAP_NET_RAW`**).

## Εξήγηση Επίθεσης

Σε ένα παράδειγμα υπολογιστικής μονάδας Google Compute Engine, η τακτική επιθετική επιθεώρηση της κίνησης δικτύου αποκαλύπτει πολλά **αιτήματα HTTP** προς την **μονάδα μεταδεδομένων** στη διεύθυνση `169.254.169.254`. Το [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), ένα υπηρεσία ανοικτού κώδικα, κάνει συχνά τέτοια αιτήματα.

Αυτό το πράκτορας είναι σχεδιασμένος να **παρακολουθεί τις αλλαγές στα μεταδεδομένα**. Ειδικότερα, τα μεταδεδομένα περιλαμβάνουν ένα **πεδίο για δημόσια κλειδιά SSH**. Όταν προστίθεται ένα νέο δημόσιο κλειδί SSH στα μεταδεδομένα, ο πράκτορας αυτόματα το **εξουσιοδοτεί** στο αρχείο `.authorized_key`. Μπορεί επίσης να **δημιουργήσει ένα νέο χρήστη** και να τον προσθέσει στους **sudoers** αν χρειαστεί.

Ο πράκτορας παρακολουθεί τις αλλαγές αποστέλλοντας ένα αίτημα για **ανάκτηση όλων των τιμών μεταδεδομένων αναδρομικά** (`GET /computeMetadata/v1/?recursive=true`). Αυτό το αίτημα σχεδιάστηκε να προκαλέσει τον διακομιστή μεταδεδομένων να στείλει μια απάντηση μόνο αν υπάρχει οποιαδήποτε αλλαγή στα μεταδεδομένα από την τελευταία ανάκτηση, που αναγνωρίζεται από ένα Etag (`wait_for_change=true&last_etag=`). Επιπλέον, περιλαμβάνεται και ένας παράμετρος **χρονικού ορίου** (`timeout_sec=`). Αν δεν υπάρξει αλλαγή εντός του καθορισμένου χρονικού ορίου, ο διακομιστής απαντά με τις **μη αλλαγμένες τιμές**.

Αυτή η διαδικασία επιτρέπει στην **IMDS** (Υπηρεσία Μεταδεδομένων Παράδειγμα) να ανταποκριθεί μετά από **60 δευτερόλεπτα** αν δεν έχει συμβεί κάποια αλλαγή στη διαμόρφωση, δημιουργώντας ένα πιθανό **παράθυρο για την εισαγωγή μιας ψεύτικης απάντησης διαμόρφωσης** στον πράκτορα επισκέπτη.

Ένας επιτιθέμενος θα μπορούσε να εκμεταλλευτεί αυτό εκτελώντας μια επίθεση **Man-in-the-Middle (MitM)**, παραποιώντας την απάντηση από τον διακομιστή IMDS και **εισάγοντας ένα νέο δημόσιο κλειδί**. Αυτό θα μπορούσε να επιτρέψει μη εξουσιοδοτημένη πρόσβαση SSH στον κεντρικό υπολογιστή.

### Τεχνική Διαφυγής

Ενώ η παραποίηση ARP είναι αναποτελεσματική στα δίκτυα Google Compute Engine, μια [**τροποποιημένη έκδοση του rshijack**](https://github.com/ezequielpereira/rshijack) που αναπτύχθηκε από τον [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) μπορεί να χρησιμοποιηθεί για την εισαγωγή πακέτων στην επικοινωνία για την εισαγωγή του χρήστη SSH.

Αυτή η έκδοση του rshijack επιτρέπει την εισαγωγή των αριθμών ACK και SEQ ως ορίσματα γραμμής εντολών, διευκολύνοντας την παραποίηση μιας απάντησης πριν από την πραγματική απάντηση του διακομιστή Μεταδεδομένων. Επιπλέον, χρησιμοποιείται ένα [**μικρό Shell script**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) για την επιστροφή ενός **ειδικά διαμορφωμένου φορτίου**. Αυτό το φορτίο ενεργοποιεί το Google Guest Agent να **δημιουργήσει ένα χρήστη `wouter`** με ένα συγκεκριμένο δημόσιο κλειδί στο αρχείο `.authorized_keys`.

Το σενάριο χρησιμοποιεί τον ίδιο ETag για να εμποδίσει τον διακομιστή Μεταδεδομένων από το να ειδοποιήσει αμέσως το Google Guest Agent για διαφορετικές τιμές μεταδεδομένων, καθυστερώντας έτσι την απάντηση.

Για την εκτέλεση της παραποίησης, είναι απαραίτητα τα ακόλουθα βήματα:

1. **Παρακολούθηση αιτημάτων προς τον διακομιστή Μεταδεδομένων** χρησιμοποιώντας το **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Ψάξτε για μια γραμμή παρόμοια με:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Στείλτε τα ψεύτικα δεδομένα μεταδεδομένων με το σωστό ETAG στο rshijack:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Αυτό το βήμα εξουσιοδοτεί το δημόσιο κλειδί, ενεργοποιώντας τη σύνδεση SSH με το αντίστοιχο ιδιωτικό κλειδί.


## Αναφορές

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Κοινοποιήστε κόλπα χάκινγκ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
{% endhint %}
