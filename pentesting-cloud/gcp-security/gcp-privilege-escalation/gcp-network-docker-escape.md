# GCP - √âvasion Docker du r√©seau

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## √âtat initial

Dans les deux rapports o√π cette technique est sp√©cifi√©e, les attaquants ont r√©ussi √† obtenir un acc√®s **root** √† l'int√©rieur d'un conteneur **Docker** g√©r√© par GCP avec acc√®s au r√©seau h√¥te (et les capacit√©s **`CAP_NET_ADMIN`** et **`CAP_NET_RAW`**).

## Explication de l'attaque

Sur une instance Google Compute Engine, une inspection r√©guli√®re du trafic r√©seau r√©v√®le de nombreuses **requ√™tes HTTP en clair** vers l'**instance de m√©tadonn√©es** √† `169.254.169.254`. L' [**Agent invit√© Google**](https://github.com/GoogleCloudPlatform/guest-agent), un service open-source, effectue fr√©quemment de telles requ√™tes.

Cet agent est con√ßu pour **surveiller les changements dans les m√©tadonn√©es**. Notamment, les m√©tadonn√©es incluent un **champ pour les cl√©s publiques SSH**. Lorsqu'une nouvelle cl√© SSH publique est ajout√©e aux m√©tadonn√©es, l'agent l'autorise automatiquement dans le fichier `.authorized_key`. Il peut √©galement **cr√©er un nouvel utilisateur** et l'ajouter aux **sudoers** si n√©cessaire.

L'agent surveille les changements en envoyant une requ√™te pour **r√©cup√©rer toutes les valeurs des m√©tadonn√©es de mani√®re r√©cursive** (`GET /computeMetadata/v1/?recursive=true`). Cette requ√™te est con√ßue pour inciter le serveur de m√©tadonn√©es √† envoyer une r√©ponse uniquement s'il y a eu un changement dans les m√©tadonn√©es depuis la derni√®re r√©cup√©ration, identifi√© par un Etag (`wait_for_change=true&last_etag=`). De plus, un param√®tre **timeout** (`timeout_sec=`) est inclus. Si aucun changement ne se produit dans le d√©lai sp√©cifi√©, le serveur r√©pond avec les **valeurs inchang√©es**.

Ce processus permet au **IMDS** (Instance Metadata Service) de r√©pondre apr√®s **60 secondes** s'il n'y a eu aucun changement de configuration, cr√©ant une **fen√™tre potentielle pour injecter une fausse r√©ponse de configuration** √† l'agent invit√©.

Un attaquant pourrait exploiter cela en effectuant une attaque de type **Man-in-the-Middle (MitM)**, en usurpant la r√©ponse du serveur IMDS et **ins√©rant une nouvelle cl√© publique**. Cela pourrait permettre un acc√®s SSH non autoris√© √† l'h√¥te.

### Technique d'√©vasion

Bien que le d√©tournement ARP soit inefficace sur les r√©seaux Google Compute Engine, une [**version modifi√©e de rshijack**](https://github.com/ezequielpereira/rshijack) d√©velopp√©e par [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) peut √™tre utilis√©e pour l'injection de paquets dans la communication afin d'injecter l'utilisateur SSH.

Cette version de rshijack permet d'entrer les num√©ros ACK et SEQ en tant qu'arguments de ligne de commande, facilitant l'usurpation d'une r√©ponse avant la v√©ritable r√©ponse du serveur de m√©tadonn√©es. De plus, un [**petit script Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) est utilis√© pour renvoyer une **charge utile sp√©cialement con√ßue**. Cette charge utile d√©clenche l'Agent invit√© Google pour **cr√©er un utilisateur `wouter`** avec une cl√© publique sp√©cifi√©e dans le fichier `.authorized_keys`.

Le script utilise le m√™me ETag pour emp√™cher le serveur de m√©tadonn√©es de notifier imm√©diatement l'Agent invit√© Google de diff√©rentes valeurs de m√©tadonn√©es, retardant ainsi la r√©ponse.

Pour ex√©cuter l'usurpation, les √©tapes suivantes sont n√©cessaires :

1. **Surveiller les requ√™tes vers le serveur de m√©tadonn√©es** en utilisant **tcpdump** :
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Cherchez une ligne similaire √† :
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Envoyez les fausses donn√©es de m√©tadonn√©es avec le bon ETAG √† rshijack :
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Cette √©tape autorise la cl√© publique, permettant la connexion SSH avec la cl√© priv√©e correspondante.


## R√©f√©rences

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
