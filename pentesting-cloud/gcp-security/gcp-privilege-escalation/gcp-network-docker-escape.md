# GCP - Ucieczka z Docker Network

{% hint style="success" %}
Dowiedz się i ćwicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz się i ćwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel się trikami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Stan Początkowy

W obu opisach, gdzie ta technika jest określona, atakujący uzyskali dostęp **root** do kontenera **Docker** zarządzanego przez GCP z dostępem do sieci hosta (oraz uprawnieniami **`CAP_NET_ADMIN`** i **`CAP_NET_RAW`**).

## Wyjaśnienie Ataku

Na instancji Google Compute Engine regularna inspekcja ruchu sieciowego ujawnia liczne **zwykłe żądania HTTP** do **instancji metadanych** pod adresem `169.254.169.254`. [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), usługa typu open-source, często wysyła takie żądania.

Ten agent jest zaprojektowany do **monitorowania zmian w metadanych**. Warto zauważyć, że metadane zawierają **pole dla kluczy publicznych SSH**. Gdy dodany zostaje nowy klucz publiczny SSH do metadanych, agent automatycznie **autoryzuje** go w pliku `.authorized_key`. Może również **utworzyć nowego użytkownika** i dodać go do **sudoers**, jeśli jest to konieczne.

Agent monitoruje zmiany, wysyłając żądanie o **pobranie wszystkich wartości metadanych rekurencyjnie** (`GET /computeMetadata/v1/?recursive=true`). To żądanie ma na celu skłonienie serwera metadanych do wysłania odpowiedzi tylko w przypadku zmiany w metadanych od ostatniego pobrania, zidentyfikowanej za pomocą Etag (`wait_for_change=true&last_etag=`). Dodatkowo zawiera parametr **timeout** (`timeout_sec=`). Jeśli w określonym czasie nie nastąpi żadna zmiana, serwer odpowiada **niezmienionymi wartościami**.

Ten proces pozwala **IMDS** (Instance Metadata Service) odpowiedzieć po **60 sekundach**, jeśli nie nastąpiła żadna zmiana konfiguracji, tworząc potencjalne **okno do wstrzyknięcia fałszywej odpowiedzi konfiguracyjnej** do agenta gościa.

Atakujący mógłby wykorzystać to, wykonując atak **Man-in-the-Middle (MitM)**, podszywając się pod odpowiedź serwera IMDS i **wstawiając nowy klucz publiczny**. To mogłoby umożliwić nieautoryzowany dostęp SSH do hosta.

### Technika Ucieczki

Podczas gdy podsłuchiwanie ARP jest nieskuteczne w sieciach Google Compute Engine, [**zmodyfikowana wersja rshijack**](https://github.com/ezequielpereira/rshijack) opracowana przez [**Ezequiela**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) może być użyta do wstrzykiwania pakietów w komunikacji w celu wstrzyknięcia użytkownika SSH.

Ta wersja rshijack pozwala na wprowadzenie numerów ACK i SEQ jako argumentów wiersza poleceń, ułatwiając podszywanie się pod odpowiedź przed rzeczywistą odpowiedzią serwera Metadanych. Dodatkowo używany jest [**mały skrypt Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) do zwrócenia **specjalnie spreparowanego ładunku**. Ten ładunek powoduje, że Google Guest Agent **tworzy użytkownika `wouter`** z określonym kluczem publicznym w pliku `.authorized_keys`.

Skrypt używa tego samego ETag, aby uniemożliwić serwerowi Metadanych natychmiastowe powiadomienie Google Guest Agent o innych wartościach metadanych, opóźniając w ten sposób odpowiedź.

Aby przeprowadzić podszywanie, konieczne są następujące kroki:

1. **Monitoruj żądania do serwera Metadanych** za pomocą **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Znajdź linię podobną do:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Wyślij fałszywe dane metadanych z poprawnym ETAG do rshijack:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Ten krok autoryzuje klucz publiczny, umożliwiając połączenie SSH z odpowiadającym mu kluczem prywatnym.


## Odnośniki

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
Naucz się i praktykuj Hacking w AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz się i praktykuj Hacking w GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się trikami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
