# GCP - Ağ Docker Kaçışı

{% hint style="success" %}
AWS Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## Başlangıç Durumu

Bu teknik belirtildiği iki yazıda da, saldırganların GCP tarafından yönetilen bir **Docker** konteynerinde **root** erişimine sahip oldukları ve ana ağa erişim sağladıkları belirtilmiştir (**`CAP_NET_ADMIN`** ve **`CAP_NET_RAW`** yeteneklerine sahip).

## Saldırı Açıklaması

Google Compute Engine örneğinde, ağ trafiğinin düzenli olarak incelenmesi, `169.254.169.254` adresindeki **metadata örneğine** birçok **düz HTTP isteği** gösterir. Açık kaynaklı bir hizmet olan [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent) sık sık bu tür isteklerde bulunur.

Bu ajan, **metadata'daki değişiklikleri izlemek** için tasarlanmıştır. Özellikle, metadata bir **SSH genel anahtar alanı** içerir. Yeni bir genel SSH anahtarı metadata'ya eklenirse, ajan otomatik olarak bunu `.authorized_key` dosyasında **yetkilendirir**. Gerekirse yeni bir kullanıcı oluşturabilir ve onları **sudoers** grubuna ekleyebilir.

Ajan, tüm metadata değerlerini **rekürsif olarak almak için bir istek göndererek değişiklikleri izler** (`GET /computeMetadata/v1/?recursive=true`). Bu istek, metadata sunucusunu, son alınan değerlerden bu yana metadata'da herhangi bir değişiklik olup olmadığını belirten bir Etag ile yanıt göndermeye zorlar (`wait_for_change=true&last_etag=`). Ayrıca, bir **zaman aşımı** parametresi (`timeout_sec=`) de dahil edilir. Belirtilen zaman aşımı içinde herhangi bir değişiklik olmazsa, sunucu **değişmeyen değerlerle** yanıt verir.

Bu süreç, **IMDS** (Örnek Metadata Servisi) 'nin, yapılandırma değişikliği olmadığında **60 saniye sonra** yanıt vermesine izin verir, böylece ajanın yanıtına **sahte bir yapılandırma yanıtı enjekte etme potansiyeli** yaratır.

Bir saldırgan, bu durumu **Man-in-the-Middle (MitM) saldırısı** gerçekleştirerek, IMDS sunucusundan gelen yanıtı sahteleştirerek ve yeni bir genel anahtar **ekleyerek** sömürülebilir. Bu, ana bilgisayara yetkisiz SSH erişimini sağlayabilir.

### Kaçış Tekniği

ARP spoofing, Google Compute Engine ağlarında etkisiz olsa da, [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) tarafından geliştirilen [**rshijack'ın modifiye edilmiş bir sürümü**](https://github.com/ezequielpereira/rshijack), SSH kullanıcısını enjekte etmek için iletişimde paket enjeksiyonu yapmak için kullanılabilir.

Bu rshijack sürümü, ACK ve SEQ numaralarını komut satırı argümanları olarak girmeyi sağlar, böylece gerçek Metadata sunucusu yanıtından önce yanıtı sahteleştirmeyi kolaylaştırır. Ayrıca, **özel olarak oluşturulmuş bir yükü** döndüren [**küçük bir Shell betiği**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) kullanılır. Bu yük, Google Guest Agent'ın `.authorized_keys` dosyasında belirli bir genel anahtara sahip bir kullanıcı olan `wouter`'ı **oluşturmasını tetikler**.

Betik, Metadata sunucusunun hemen Google Guest Agent'ı farklı metadata değerleri hakkında bilgilendirmesini önlemek için aynı ETag'i kullanır, böylece yanıtı geciktirir.

Sahteleştirmeyi gerçekleştirmek için aşağıdaki adımlar gereklidir:

1. **Metadata sunucusuna yapılan istekleri** **tcpdump** kullanarak izleyin:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Aşağıdaki satıra benzer bir satır arayın:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Doğru ETAG ile sahte metadata verisini rshijack'e gönderin:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Bu adım, genel anahtarı yetkilendirerek ilgili özel anahtarla SSH bağlantısını etkinleştirir.


## Referanslar

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
AWS Hacking öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitimi AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitimi GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* Hacking püf noktalarını paylaşarak PR'ler göndererek **HackTricks** ve **HackTricks Cloud** github depolarına katkıda bulunun.

</details>
{% endhint %}
