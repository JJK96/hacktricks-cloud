# GCP - ネットワーク Docker エスケープ

{% hint style="success" %}
AWS ハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP ハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks のサポート</summary>

* [**購読プラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に参加するか、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** をフォローする。**
* **HackTricks** と **HackTricks Cloud** の github リポジトリに PR を提出してハッキングテクニックを共有する。

</details>
{% endhint %}

## 初期状態

このテクニックが指定されている両方の解説では、攻撃者が **`CAP_NET_ADMIN`** および **`CAP_NET_RAW`** の権限を持つホストネットワークにアクセス権を持つ GCP によって管理される **Docker** コンテナ内で **root** アクセスを取得することに成功しました。

## 攻撃の説明

Google Compute Engine インスタンスでは、ネットワークトラフィックの定期的な検査により、`169.254.169.254` の **メタデータインスタンス** への多数の **プレーン HTTP リクエスト** が明らかになります。オープンソースのサービスである [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent) は、頻繁にこのようなリクエストを行います。

このエージェントは、メタデータの変更を監視するように設計されています。特に、メタデータには **SSH 公開鍵のフィールド** が含まれています。新しい公開 SSH 鍵がメタデータに追加されると、エージェントは自動的に `.authorized_key` ファイルでその鍵を **承認** します。必要に応じて、新しいユーザーを **sudoers に追加** することもあります。

エージェントは、すべてのメタデータ値を再帰的に取得するリクエストを送信して変更を監視します (`GET /computeMetadata/v1/?recursive=true`)。このリクエストは、メタデータサーバーに対して、最後の取得以降にメタデータに変更がある場合にのみ応答を送信するよう促します。これは Etag によって識別されます (`wait_for_change=true&last_etag=`)。さらに、**タイムアウト** パラメーター (`timeout_sec=`) も含まれます。指定されたタイムアウト内に変更が発生しない場合、サーバーは **変更されていない値** を返します。

このプロセスにより、IMDS（Instance Metadata Service）は、構成の変更が発生しない場合に **60 秒後** に応答するようになり、ゲストエージェントに偽の構成応答を注入する可能性のある **ウィンドウ** が生じます。

攻撃者は、これを悪用して **Man-in-the-Middle (MitM) 攻撃** を実行し、IMDS サーバーからの応答をスプーフィングして新しい公開鍵を **挿入** することができます。これにより、ホストへの未承認の SSH アクセスが可能になります。

### エスケープテクニック

ARP スプーフィングは Google Compute Engine ネットワークでは効果がありませんが、[**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) によって開発された [**rshijack の改良版**](https://github.com/ezequielpereira/rshijack) を使用して、通信へのパケットインジェクションに使用できます。これにより、SSH ユーザーを挿入できます。

この rshijack のバージョンでは、ACK および SEQ 番号をコマンドライン引数として入力できるため、実際のメタデータサーバーの応答の前に応答をスプーフィングすることが容易になります。さらに、[**小さなシェルスクリプト**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) を使用して、**特別に作成されたペイロード** を返します。このペイロードにより、Google Guest Agent が `.authorized_keys` ファイルに指定された公開鍵を持つユーザー `wouter` を **作成** します。

スクリプトは、異なるメタデータ値を Google Guest Agent にすぐに通知させないようにするために同じ ETag を使用し、応答を遅らせます。

スプーフィングを実行するには、次の手順が必要です：

1. **tcpdump** を使用して、**メタデータサーバーへのリクエストを監視**します：
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Look for a line similar to:  

```html
<h2 id="docker-socket">Docker Socket</h2>
```
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. 正しいETAGを使用して、rshijackに偽のメタデータデータを送信します：
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
この手順では、公開鍵を認証し、対応する秘密鍵でSSH接続を有効にします。


## 参考文献

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
AWSハッキングの学習と実践：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と実践：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
{% endhint %}
