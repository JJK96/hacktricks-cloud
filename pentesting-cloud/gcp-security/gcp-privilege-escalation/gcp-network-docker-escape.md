# GCP - 네트워크 도커 탈출

{% hint style="success" %}
AWS 해킹 학습 및 실습:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP 해킹 학습 및 실습: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원</summary>

* [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* 💬 [**디스코드 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) 깃헙 저장소에 PR을 제출하여 해킹 요령을 공유하세요.

</details>
{% endhint %}

## 초기 상태

이 기술이 명시된 두 가지 설명서에서 공격자들은 GCP에서 호스트 네트워크에 액세스 권한을 갖는 **Docker** 컨테이너 내에서 **루트** 액세스를 획득했습니다.

## 공격 설명

Google Compute Engine 인스턴스에서 네트워크 트래픽을 정기적으로 검사하면 `169.254.169.254`의 **메타데이터 인스턴스**로의 다수의 **일반 HTTP 요청**이 나타납니다. 오픈 소스 서비스인 [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent)는 이러한 요청을 자주 수행합니다.

이 에이전트는 **메타데이터의 변경 사항을 모니터링**하는 데 사용됩니다. 특히 메타데이터에는 **SSH 공개 키 필드**가 포함되어 있습니다. 새로운 공개 SSH 키가 메타데이터에 추가되면 에이전트가 자동으로 `.authorized_key` 파일에서 이를 **인가**합니다. 필요한 경우 **새 사용자를 생성**하고 필요하면 **sudoers에 추가**할 수도 있습니다.

에이전트는 **재귀적으로 모든 메타데이터 값을 검색**하기 위해 요청을 보내어 변경 사항이 있는 경우에만 메타데이터 서버가 응답하도록 설계되었습니다(`GET /computeMetadata/v1/?recursive=true`). 이 요청은 마지막 검색 이후 메타데이터에 변경 사항이 있는 경우에만 응답하도록 메타데이터 서버에 프롬프트합니다. 또한 **타임아웃** 매개변수(`timeout_sec=`)가 포함됩니다. 지정된 시간 내에 변경이 발생하지 않으면 서버는 **변경되지 않은 값**으로 응답합니다.

이 프로세스를 통해 **IMDS**(인스턴스 메타데이터 서비스)는 구성 변경이 발생하지 않은 경우 **60초 후에 응답**할 수 있으며, 게스트 에이전트에 가짜 구성 응답을 주입할 **가능성의 창을 만듭니다**.

공격자는 **Man-in-the-Middle (MitM) 공격**을 수행하여 IMDS 서버로부터의 응답을 위조하고 **새로운 공개 키를 삽입**함으로써 이를 악용할 수 있습니다. 이는 호스트로의 무단 SSH 액세스를 가능하게 할 수 있습니다.

### 탈출 기술

Google Compute Engine 네트워크에서 ARP 스푸핑은 효과적이지 않지만, [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)이 개발한 [**rshijack의 수정 버전**](https://github.com/ezequielpereira/rshijack)을 사용하여 통신에 대한 패킷 주입에 사용할 수 있습니다.

이 rshijack 버전은 ACK 및 SEQ 번호를 명령줄 인수로 입력할 수 있도록하여 실제 메타데이터 서버 응답 이전에 응답을 위조하는 것을 용이하게 합니다. 또한 [**작은 셸 스크립트**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh)를 사용하여 **특별히 제작된 페이로드**를 반환합니다. 이 페이로드는 Google Guest Agent가 `.authorized_keys` 파일에 지정된 공개 키를 가진 사용자 `wouter`를 **생성**하도록 유도합니다.

이 스크립트는 메타데이터 서버가 즉시 다른 메타데이터 값을 Google Guest Agent에 알리지 못하도록 동일한 ETag를 사용하여 응답을 지연시킵니다.

위조를 실행하려면 다음 단계가 필요합니다:

1. **tcpdump**를 사용하여 **메타데이터 서버로의 요청을 모니터링**하세요:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
찾으세요.
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. 올바른 ETAG를 사용하여 rshijack으로 가짜 메타데이터 데이터를 전송하십시오:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
이 단계는 공개 키를 승인하여 해당 개인 키와의 SSH 연결을 활성화합니다.


## 참고 자료

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
AWS 해킹 학습 및 실습:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP 해킹 학습 및 실습: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원</summary>

* [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* 💬 [**디스코드 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* 해킹 요령을 공유하려면 [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>
{% endhint %}
