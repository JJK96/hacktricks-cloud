# GCP - Kuboresha Mamlaka

{% hint style="success" %}
Jifunze na zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Utangulizi wa Kuboresha Mamlaka ya GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, kama mawingu mengine yoyote, ina **wahusika**: watumiaji, vikundi na akaunti za huduma, na **rasilimali** kama injini ya kuhesabu, kazi za wingu...\
Kisha, kupitia majukumu, **ruhusa hupewa wahusika hao juu ya rasilimali**. Hii ndio njia ya kueleza ruhusa ambazo mhusika ana juu ya rasilimali katika GCP.\
Kuna ruhusa fulani ambazo zitaruhusu mtumiaji **kupata ruhusa zaidi** kwenye rasilimali au rasilimali za tatu, na hicho ndicho kinachoitwa **kuboresha mamlaka** (pia, kutumia mapungufu kupata ruhusa zaidi).

Kwa hivyo, ningependa kutenganisha mbinu za kuboresha mamlaka ya GCP katika **makundi 2**:

* **Privesc kwa mhusika**: Hii itakuruhusu **kujifanya kuwa mhusika mwingine**, na kwa hivyo kutenda kama yeye na ruhusa zake zote. mf.: Tumia _getAccessToken_ kujifanya kuwa akaunti ya huduma.
* **Privesc kwenye rasilimali**: Hii itakuruhusu **kupata ruhusa zaidi juu ya rasilimali maalum**. mf.: unaweza kutumia ruhusa ya _setIamPolicy_ kwenye cloudfunctions kukuruhusu kuzindua kazi.

* Tafadhali kumbuka kuwa baadhi ya **ruhusa za rasilimali pia zitaruhusu kuambatisha akaunti ya huduma** isiyojulikana kwenye rasilimali. Hii inamaanisha kuwa utaweza kuzindua rasilimali na SA, kuingia kwenye rasilimali, na **kuiba token ya SA**. Kwa hivyo, hii itaruhusu kuboresha kwa mhusika kupitia kuboresha kwa rasilimali. Hii imetokea kwenye rasilimali kadhaa hapo awali, lakini sasa ni nadra zaidi (ingawa inaweza kutokea bado).

Kwa dhahiri, mbinu za kuboresha mamlaka za kuvutia zaidi ni zile za **kundi la pili** kwa sababu itakuruhusu **kupata ruhusa zaidi nje ya rasilimali ambazo tayari una ruhusa fulani juu yake**. Walakini, kumbuka kwamba **kuboresha kwenye rasilimali** inaweza pia kukupa ufikiaji wa **habari nyeti** au hata kwa **wahusika wengine** (labda kupitia kusoma siri ambayo ina token ya SA).

{% hint style="warning" %}
Ni muhimu pia kueleza kwamba katika **Akaunti za Huduma za GCP ni wahusika na ruhusa**, kwa hivyo kuboresha mamlaka katika SA kutakuruhusu kujifanya kuwa hiyo pia.
{% endhint %}

{% hint style="info" %}
Ruhusa kati ya mabano inaonyesha ruhusa zinazohitajika kudukua mapungufu kwa kutumia `gcloud`. Huenda zisihitajike ikiwa unadukua kupitia API.
{% endhint %}

## Ruhusa kwa Metodolojia ya Kuboresha Mamlaka

Hivi ndivyo **ninavyopima ruhusa maalum** kufanya vitendo maalum ndani ya GCP.

1. Pakua repo ya github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Ongeza kwenye vipimo/ script mpya

## Kupitisha mipaka ya ufikiaji <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Vidokezo vya SA vilivyovuja kutoka kwa huduma ya metadata ya GCP vina **vipimo vya ufikiaji**. Hizi ni **vizuizi** kwenye **ruhusa** ambazo token inayo. Kwa mfano, ikiwa token ina **wigo wa** `https://www.googleapis.com/auth/cloud-platform`, itakuwa na **ufikiaji kamili** kwa huduma zote za GCP. Walakini, ikiwa token ina **wigo wa** `https://www.googleapis.com/auth/cloud-platform.read-only`, itakuwa na **ufikiaji wa kusoma tu** kwa huduma zote za GCP hata ikiwa SA ina ruhusa zaidi katika IAM.

Hakuna njia moja kwa moja ya kupitisha ruhusa hizi, lakini unaweza jaribu kutafuta **vitambulisho vipya** kwenye mwenyeji aliyeathiriwa, **pata ufunguo wa huduma** kuzalisha token ya OAuth bila kizuizi au **hamia kwenye VM tofauti iliyopunguzwa**.

Wakati [vipimo vya ufikiaji](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) vinapotumiwa, token ya OAuth inayozalishwa kwa kifaa cha kuhesabu (VM) itakuwa na **kizuizi cha** [**wigo**](https://oauth.net/2/scope/) **kilichojumuishwa**. Walakini, unaweza kuweza **kupitisha** kizuizi hiki na kutumia ruhusa ambazo akaunti iliyodukuliwa ina.

Njia bora ya kupitisha kizuizi hiki ni au kupata **vitambulisho vipya** kwenye mwenyeji aliyeathiriwa, kupata **ufunguo wa huduma** wa kuzalisha token ya OAuth bila kizuizi au kudukua **VM tofauti na SA iliyopunguzwa**.

Angalia SA na ufunguo uliozalishwa na:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Mbinu za Kuinua Hadhi

Njia ya kuinua hadhi zako katika AWS ni kuwa na ruhusa za kutosha ili uweze, kwa namna fulani, kupata upatikanaji wa ruhusa za akaunti/watumiaji/vikundi vingine vya huduma. Kutumia mfululizo wa kuinua hadhi mpaka upate ufikiaji wa usimamizi juu ya shirika.

{% hint style="warning" %}
GCP ina **maelfu** (ikiwa sio maelfu) ya **ruhusa** ambazo kifaa kinaweza kupewa. Katika kitabu hiki unaweza kupata **ruhusa zote nilizozijua** ambazo unaweza kuzitumia kwa **kuinua hadhi**, lakini ikiwa **unajua njia fulani** ambayo haijatajwa hapa, **tutafadhali shiriki**.
{% endhint %}

**Kurasa ndogo za sehemu hii zimepangwa kulingana na huduma. Unaweza kupata njia tofauti za kuinua hadhi kwa huduma kwenye kila huduma.**

### Kutumia GCP kuinua hadhi kwa ndani

Ikiwa uko ndani ya mashine katika GCP unaweza kuwa na uwezo wa kutumia ruhusa kwa ajili ya kuinua hadhi hata kwa ndani:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Marejeo

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Jifunze & zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
