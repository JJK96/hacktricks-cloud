# GCP - 特権昇格

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
{% endhint %}

## GCP特権昇格の概要 <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCPは、他のクラウドと同様に、**主体**（ユーザー、グループ、サービスアカウント）といくつかの**リソース**（コンピュートエンジン、クラウドファンクションなど）を持っています。\
その後、**ロールを介して主体にリソース上の権限が付与**されます。これは、GCPのリソースに対する主体の権限を指定する方法です。\
特定の権限により、ユーザーがリソースまたはサードパーティのリソースに**さらに権限を取得**できるようになり、これが**特権昇格**と呼ばれるものです（また、権限を取得するために脆弱性を悪用することも含まれます）。

したがって、GCP特権昇格テクニックを**2つのグループ**に分けたいと思います：

- **主体への特権昇格**：これにより、**他の主体になりすます**ことができ、その主体としてすべての権限を持って行動できます。例：_getAccessToken_を悪用してサービスアカウントになりすます。
- **リソース上の特権昇格**：これにより、**特定のリソースに対してさらに権限を取得**できます。例：cloudfunctions上の_setIamPolicy_権限を悪用して関数をトリガーできるようにします。
- 一部の**リソース権限**では、リソースに**任意のサービスアカウントを添付**することもできます。これは、SAを使用してリソースを起動し、リソースに入り、SAトークンを**盗む**ことができることを意味します。したがって、これにより、リソース昇格を介して主体に昇格できます。これは以前いくつかのリソースで発生しましたが、今ではそれほど頻繁ではありません（しかし、まだ起こり得ます）。

明らかに、最も興味深い特権昇格テクニックは**第2グループ**のものです。なぜなら、これにより、**すでに特権を持っているリソースの外でさらに特権を取得**できるからです。ただし、**リソース内での昇格**は、**機密情報**や**他の主体**（たとえば、SAのトークンを含む秘密を読むことを通じて）へのアクセスも可能にすることに注意してください。

{% hint style="warning" %}
また、**GCPサービスアカウントは主体と権限の両方**であることにも注意することが重要です。そのため、SAで特権を昇格させると、それをなりすますこともできます。
{% endhint %}

{% hint style="info" %}
かぎかっこ内の権限は、`gcloud`を使用して脆弱性を悪用するために必要な権限を示しています。APIを介して悪用する場合は必要ない場合があります。
{% endhint %}

## 特権昇格方法論の権限

これは、GCP内で特定のアクションを実行するための特定の権限を**テスト**する方法です。

1. GitHubリポジトリ[https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)をダウンロードします。
2. tests/に新しいスクリプトを追加します。

## アクセススコープのバイパス <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

GCPメタデータサービスから漏洩したSAのトークンには**アクセススコープ**があります。これらはトークンが持つ**権限の制限**です。たとえば、トークンに**`https://www.googleapis.com/auth/cloud-platform`**スコープがある場合、すべてのGCPサービスに**完全アクセス**できます。ただし、トークンに**`https://www.googleapis.com/auth/cloud-platform.read-only`**スコープがある場合、IAMでより多くの権限を持っていても、すべてのGCPサービスに**読み取り専用アクセス**しかありません。

これらの権限をバイパスする直接的な方法はありませんが、侵害されたホストで**新しい資格情報を検索**したり、制限なしでOAuthトークンを生成する**サービスキーを見つけたり**、**制限の少ない別のVMに移動**することを試してみることができます。

[アクセススコープ](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam)が使用されると、計算インスタンス（VM）用に生成されるOAuthトークンには**スコープの制限**が含まれます。ただし、この制限を**バイパス**して侵害されたアカウントの権限を悪用することができるかもしれません。

この制限を**バイパス**する最良の方法は、侵害されたホストで**新しい資格情報を見つける**か、**制限なしでOAuthトークンを生成するためのサービスキーを見つける**か、**制限の少ないSAを持つ別のVMを侵害する**ことです。

次のコマンドで生成されたSAのキーを確認します：
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## 特権昇格テクニック

AWSで特権を昇格させる方法は、他のサービスアカウント/ユーザー/グループの特権にアクセスできるだけの権限を持つことです。特権昇格を繰り返し、最終的に組織全体に管理者アクセス権を持つようにします。

{% hint style="warning" %}
GCPには、エンティティに付与できる**数百**（もしくは数千）の**権限**があります。この本では、**特権昇格**に悪用できる**私が知っているすべての権限**を見つけることができますが、ここに記載されていない**パス**をご存知の場合は、**共有してください**。
{% endhint %}

**このセクションのサブページはサービスごとに並べられています。各サービスで特権昇格の異なる方法を見つけることができます。**

### GCPを悪用してローカルで特権昇格する

GCP内のマシンにいる場合、権限を悪用してローカルで特権昇格することができるかもしれません：

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## 参考文献

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
AWSハッキングを学び、実践する：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングを学び、実践する：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)を**フォロー**してください。
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、ハッキングトリックを共有してください。

</details>
{% endhint %}
