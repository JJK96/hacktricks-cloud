# GCP - Privilege Escalation

{% hint style="success" %}
Lernen Sie und √ºben Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie und √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys senden.

</details>
{% endhint %}

## Einf√ºhrung in die GCP-Privilege-Eskalation <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP hat wie jede andere Cloud einige **Prinzipale**: Benutzer, Gruppen und Dienstkonten, und einige **Ressourcen** wie Compute Engine, Cloud Functions...\
Dann werden √ºber Rollen **Berechtigungen f√ºr diese Prinzipale √ºber die Ressourcen erteilt**. Dies ist die Art und Weise, die Berechtigungen eines Prinzips √ºber eine Ressource in GCP anzugeben.\
Es gibt bestimmte Berechtigungen, die einem Benutzer erlauben, **noch mehr Berechtigungen** f√ºr die Ressource oder Drittanbieterressourcen zu erhalten, und das wird als **Privilege Escalation** bezeichnet (auch das Ausnutzen von Schwachstellen, um mehr Berechtigungen zu erhalten).

Daher m√∂chte ich die GCP-Privilege-Eskalationstechniken in **2 Gruppen** unterteilen:

* **Privesc auf ein Prinzipal**: Dies wird es Ihnen erm√∂glichen, **einen anderen Prinzipal zu verk√∂rpern** und daher mit all seinen Berechtigungen wie er zu handeln. z.B.: Missbrauch von _getAccessToken_ um ein Dienstkonto zu verk√∂rpern.
* **Privesc auf die Ressource**: Dies wird es Ihnen erm√∂glichen, **mehr Berechtigungen √ºber die spezifische Ressource zu erhalten**. z.B.: Sie k√∂nnen die _setIamPolicy_-Berechtigung √ºber Cloud Functions missbrauchen, um die Funktion auszul√∂sen.
* Beachten Sie, dass einige **Ressourcenberechtigungen es Ihnen auch erlauben, ein beliebiges Dienstkonto** an die Ressource anzuh√§ngen. Dies bedeutet, dass Sie eine Ressource mit einem SA starten, in die Ressource eintreten und das SA-Token **stehlen** k√∂nnen. Daher k√∂nnen Sie √ºber eine Ressourcen-Eskalation zu einem Prinzipal eskalieren. Dies ist in mehreren Ressourcen zuvor passiert, aber jetzt ist es weniger h√§ufig (kann aber immer noch passieren).

Offensichtlich sind die interessantesten Privilege-Eskalationstechniken diejenigen der **zweiten Gruppe**, weil sie es Ihnen erm√∂glichen, **mehr Berechtigungen au√üerhalb der Ressourcen zu erhalten**, √ºber die Sie bereits einige Berechtigungen haben. Beachten Sie jedoch, dass das **Eskalieren in Ressourcen** Ihnen auch Zugriff auf **sensible Informationen** oder sogar auf **andere Prinzipale** geben kann (vielleicht durch das Lesen eines Geheimnisses, das ein Token eines SA enth√§lt).

{% hint style="warning" %}
Es ist auch wichtig zu beachten, dass in **GCP-Dienstkonten sowohl Prinzipale als auch Berechtigungen** sind, daher erm√∂glicht das Eskalieren von Berechtigungen in einem SA auch, es zu verk√∂rpern.
{% endhint %}

{% hint style="info" %}
Die Berechtigungen in Klammern geben die Berechtigungen an, die ben√∂tigt werden, um die Schwachstelle mit `gcloud` auszunutzen. Diese sind m√∂glicherweise nicht erforderlich, wenn sie √ºber die API ausgenutzt werden.
{% endhint %}

## Berechtigungen f√ºr die Privilege-Eskalationsmethodik

So **teste ich spezifische Berechtigungen**, um spezifische Aktionen in GCP durchzuf√ºhren.

1. Laden Sie das Github-Repository [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts) herunter.
2. F√ºgen Sie im Ordner tests/ das neue Skript hinzu.

## Umgehen von Zugriffsberechtigungen <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Tokens von SA, die aus dem GCP-Metadatendienst **durchgesickert** sind, haben **Zugriffsberechtigungen**. Dies sind **Einschr√§nkungen** f√ºr die **Berechtigungen**, die der Token hat. Wenn der Token z.B. den **`https://www.googleapis.com/auth/cloud-platform`**-Bereich hat, hat er **vollen Zugriff** auf alle GCP-Dienste. Wenn der Token jedoch den Bereich **`https://www.googleapis.com/auth/cloud-platform.read-only`** hat, hat er nur **Lesezugriff** auf alle GCP-Dienste, auch wenn das SA in IAM mehr Berechtigungen hat.

Es gibt keinen direkten Weg, um diese Berechtigungen zu umgehen, aber Sie k√∂nnten immer versuchen, nach **neuen Anmeldeinformationen** im kompromittierten Host zu suchen, den **Service-Schl√ºssel zu finden**, um ein OAuth-Token ohne Einschr√§nkung zu generieren, oder zu einem anderen VM mit weniger Einschr√§nkungen zu **wechseln**.

Wenn [Zugriffsberechtigungen](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) verwendet werden, wird das OAuth-Token, das f√ºr die Berechnungsinstanz (VM) generiert wird, eine **Bereichseinschr√§nkung enthalten**. M√∂glicherweise k√∂nnen Sie jedoch diese Einschr√§nkung umgehen und die Berechtigungen des kompromittierten Kontos ausnutzen.

Der **beste Weg, um** diese Einschr√§nkung zu umgehen, besteht darin, entweder **neue Anmeldeinformationen** im kompromittierten Host zu finden, den **Service-Schl√ºssel zu finden, um ein OAuth-Token** ohne Einschr√§nkung zu generieren, oder eine andere VM mit einem SA mit weniger Einschr√§nkungen zu **kompromittieren**.

√úberpr√ºfen Sie SA mit generierten Schl√ºsseln mit:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Techniken zur Privilegieneskalation

Der Weg, um Ihre Berechtigungen in AWS zu eskalieren, besteht darin, ausreichende Berechtigungen zu haben, um auf die Berechtigungen anderer Dienstkonten/Benutzer/Gruppen zugreifen zu k√∂nnen. Eskalationen verketten, bis Sie Admin-Zugriff auf die Organisation haben.

{% hint style="warning" %}
GCP hat **hunderte** (wenn nicht tausende) von **Berechtigungen**, die einer Entit√§t gew√§hrt werden k√∂nnen. In diesem Buch finden Sie **alle Berechtigungen, die ich kenne**, die Sie missbrauchen k√∂nnen, um **Berechtigungen zu eskalieren**, aber wenn Sie einen **Weg kennen**, der hier nicht erw√§hnt wird, **teilen Sie ihn bitte**.
{% endhint %}

**Die Unterseiten dieses Abschnitts sind nach Diensten geordnet. Sie finden auf jedem Dienst verschiedene M√∂glichkeiten, Berechtigungen auf den Diensten zu eskalieren.**

### Missbrauch von GCP zur Eskalation von Berechtigungen lokal

Wenn Sie sich in einer Maschine in GCP befinden, k√∂nnten Sie Berechtigungen missbrauchen, um Berechtigungen sogar lokal zu eskalieren:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Referenzen

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Lernen & √ºben Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys einreichen.

</details>
{% endhint %}
