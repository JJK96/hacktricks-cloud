# GCP - Ayrıcalık Yükseltme

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## GCP Ayrıcalık Yükseltme Giriş <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, diğer bulutlar gibi bazı **ilkeleri** bulunur: kullanıcılar, gruplar ve hizmet hesapları, ve bazı **kaynaklar** gibi hesaplama motoru, bulut işlevleri...\
Sonra, roller aracılığıyla, **izinler bu ilkelerin kaynaklar üzerinde verilir**. Bu, bir ilkenin GCP'deki bir kaynağa sahip olduğu izinleri belirtmenin yoludur.\
Bazı izinler, bir kullanıcıya kaynağın üzerinde **daha fazla izin almasına izin verecek**, ve bu da **ayrıcalık yükseltme** olarak adlandırılır (ayrıca, daha fazla izin almak için zafiyetlerin sömürülmesi).

Bu nedenle, GCP ayrıcalık yükseltme tekniklerini **2 gruba ayırmak istiyorum**:

* **İlke yükseltme bir ilkeye**: Bu size **başka bir ilkeyi taklit etme** izni verecektir ve dolayısıyla tüm izinleriyle onun gibi davranmanıza olanak tanır. örn.: Bir hizmet hesabını taklit etmek için _getAccessToken_ kötüye kullanımı.
* **Kaynak üzerinde ilke yükseltme**: Bu size **belirli kaynağın üzerinde daha fazla izin almanızı sağlayacaktır**. örn.: cloudfunctions üzerinde _setIamPolicy_ iznini kötüye kullanarak işlevi tetiklemenize izin verir.
* Bazı **kaynak izinleri ayrıca bir hizmet hesabını kaynağa eklemenize izin verecektir**. Bu, bir kaynağı bir SA ile başlatmanıza, kaynağa girmenize ve **SA belirtecinin çalınmasına izin verecektir**. Bu nedenle, bu, bir kaynak yükseltmesi aracılığıyla bir ilkeye yükselmenize izin verecektir. Bu daha önce birkaç kaynakta meydana gelmiş olsa da, şimdi daha az yaygın (ancak hala olabilir).

Açıkçası, en ilginç ayrıcalık yükseltme teknikleri **ikinci gruptakilerdir** çünkü size **zaten bazı ayrıcalıklara sahip olduğunuz kaynakların dışında daha fazla ayrıcalık kazandıracaktır**. Ancak, **kaynaklarda yükselme** size aynı zamanda **duyarlı bilgilere** veya hatta **diğer ilkelerin** (belki bir SA belirteci içeren bir sırrı okuyarak) erişim sağlayabilir.

{% hint style="warning" %}
Ayrıca **GCP Hizmet Hesapları hem ilke hem izinlerdir**, bu nedenle bir SA'da ayrıcalıklar yükseltmek, onu taklit etmenize de izin verecektir.
{% endhint %}

{% hint style="info" %}
Parantez içindeki izinler, zafiyetin `gcloud` ile sömürülmesi için gereken izinleri gösterir. Bunlar, API aracılığıyla sömürülürken gerekli olmayabilir.
{% endhint %}

## Ayrıcalık Yükseltme Metodolojisi için İzinler

Bu, belirli eylemleri gerçekleştirmek için belirli izinleri **test etmek için nasıl** yaptığımı gösterir GCP içinde.

1. Github deposunu indirin [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Yeni betiği tests/ klasörüne ekleyin

## Erişim Kapsamlarını Atlatma <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

GCP metadata servisinden sızdırılan SA belirteçleri **erişim kapsamlarına** sahiptir. Bunlar, belirtecin sahip olduğu **izinler üzerindeki kısıtlamalardır**. Örneğin, belirtecin **`https://www.googleapis.com/auth/cloud-platform`** kapsamı varsa, tüm GCP hizmetlerine **tam erişimi** olacaktır. Ancak, belirtecin **`https://www.googleapis.com/auth/cloud-platform.read-only`** kapsamı varsa, IAM'de SA'nın daha fazla izne sahip olmasına rağmen, tüm GCP hizmetlerine **salt okuma erişimi** olacaktır.

Bu izinleri atlamak için doğrudan bir yol yoktur, ancak kompromize edilmiş ana makinede **yeni kimlik bilgileri arayabilir**, kısıtlamasız bir OAuth belirteci oluşturmak için **hizmet anahtarını bulabilir** veya **daha az kısıtlanmış farklı bir VM'ye geçebilirsiniz**.

[erişim kapsamları](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) kullanıldığında, hesaplama örneği (VM) için oluşturulan OAuth belirteci **dahil edilmiş bir kapsam sınırlamasına** sahip olacaktır. Bununla birlikte, bu sınırlamayı atlayabilir ve kompromize edilmiş hesabın sahip olduğu izinleri sömürebilirsiniz.

Bu kısıtlamayı atlatmanın **en iyi yolu**, ya kompromize edilmiş ana makinede **yeni kimlik bilgileri bulmak**, kısıtlamasız bir OAuth belirteci oluşturmak için **hizmet anahtarını bulmak** veya **daha az kısıtlanmış bir SA'ya sahip farklı bir VM'yi ele geçirmektir**.

Anahtarları oluşturulan SA'yı kontrol edin:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Yetki Yükseltme Teknikleri

AWS'de yetkilerinizi yükseltmenin yolu, başka hizmet hesapları/kullanıcıları/gruplarının yetkilerine bir şekilde erişebilecek kadar yeterli izne sahip olmaktır. Yönetici erişimine sahip olana kadar yükseltmeleri zincirleme olarak gerçekleştirirsiniz.

{% hint style="warning" %}
GCP'de bir varlığa verilebilecek **yüzlerce** (belki de binlerce) **izin** bulunmaktadır. Bu kitapta, **yetki yükseltmek için kötüye kullanabileceğiniz tüm izinleri** bulabilirsiniz, ancak burada bahsedilmeyen **bir yol biliyorsanız, lütfen paylaşın**.
{% endhint %}

**Bu bölümün alt sayfaları hizmetlere göre sıralanmıştır. Her hizmette yetkileri yükseltmenin farklı yollarını bulabilirsiniz.**

### Yetkileri yerel olarak yükseltmek için GCP'yi kötüye kullanma

Eğer GCP'deki bir makinede iseniz, izinleri kötüye kullanarak yerel olarak bile yetkileri yükseltebilirsiniz:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Referanslar

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
