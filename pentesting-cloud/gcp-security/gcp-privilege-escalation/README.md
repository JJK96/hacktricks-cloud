# GCP - Escalatione dei Privilegi

{% hint style="success" %}
Impara e pratica l'Hacking su AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Introduzione all'Escalatione dei Privilegi in GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, come qualsiasi altro cloud, ha alcuni **principali**: utenti, gruppi e account di servizio, e alcune **risorse** come motore di calcolo, funzioni cloud...\
Quindi, tramite ruoli, **vengono concessi permessi a quei principali sulle risorse**. Questo √® il modo per specificare i permessi che un principale ha su una risorsa in GCP.\
Ci sono determinati permessi che permetteranno a un utente di **ottenere ancora pi√π permessi** sulla risorsa o su risorse di terze parti, ed √® ci√≤ che viene chiamato **escalatione dei privilegi** (anche, lo sfruttamento delle vulnerabilit√† per ottenere pi√π permessi).

Pertanto, vorrei separare le tecniche di escalatione dei privilegi in GCP in **2 gruppi**:

* **Privesc a un principale**: Questo ti permetter√† di **impersonare un altro principale**, e quindi agire come lui con tutti i suoi permessi. es.: Abuso di _getAccessToken_ per impersonare un account di servizio.
* **Privesc sulla risorsa**: Questo ti permetter√† di **ottenere pi√π permessi sulla risorsa specifica**. es.: puoi abusare del permesso _setIamPolicy_ su cloudfunctions per permetterti di attivare la funzione.
* Nota che alcuni **permessi delle risorse ti permetteranno anche di associare un account di servizio arbitrario** alla risorsa. Ci√≤ significa che sarai in grado di avviare una risorsa con un SA, accedere alla risorsa e **rubare il token SA**. Pertanto, ci√≤ permetter√† di scalare a un principale tramite un'escalatione della risorsa. Questo √® successo in diverse risorse in passato, ma ora √® meno frequente (ma pu√≤ ancora accadere).

Ovviamente, le tecniche di escalatione dei privilegi pi√π interessanti sono quelle del **secondo gruppo** perch√© ti permetteranno di **ottenere pi√π privilegi al di fuori delle risorse su cui hai gi√† alcuni privilegi**. Tuttavia, nota che **scalare nelle risorse** potrebbe darti anche accesso a **informazioni sensibili** o persino a **altri principali** (forse tramite la lettura di un segreto che contiene un token di un SA).

{% hint style="warning" %}
√à importante notare anche che nei **Service Account di GCP sono sia principali che permessi**, quindi l'escalatione dei privilegi in un SA ti permetter√† anche di impersonarlo.
{% endhint %}

{% hint style="info" %}
I permessi tra parentesi indicano i permessi necessari per sfruttare la vulnerabilit√† con `gcloud`. Potrebbero non essere necessari se sfruttati tramite l'API.
{% endhint %}

## Permessi per la Metodologia di Escalatione dei Privilegi

Questo √® come **testo per permessi specifici** per eseguire azioni specifiche all'interno di GCP.

1. Scarica il repository github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Aggiungi in tests/ il nuovo script

## Bypassare gli access scopes <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

I token di SA trapelati dal servizio di metadati di GCP hanno **access scopes**. Questi sono **restrizioni** sui **permessi** che il token ha. Ad esempio, se il token ha lo scope **`https://www.googleapis.com/auth/cloud-platform`**, avr√† **accesso completo** a tutti i servizi GCP. Tuttavia, se il token ha lo scope **`https://www.googleapis.com/auth/cloud-platform.read-only`**, avr√† solo **accesso in sola lettura** a tutti i servizi GCP anche se il SA ha pi√π permessi in IAM.

Non c'√® un modo diretto per aggirare questi permessi, ma potresti sempre provare a cercare **nuove credenziali** nell'host compromesso, **trovare la chiave di servizio** per generare un token OAuth senza restrizioni o **passare a un diverso VM meno restrittivo**.

Quando vengono utilizzati [access scopes](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), il token OAuth generato per l'istanza di calcolo (VM) avr√† una **limitazione di scope inclusa**. Tuttavia, potresti essere in grado di **aggirare** questa limitazione e sfruttare i permessi dell'account compromesso.

Il **modo migliore per aggirare** questa restrizione √® trovare **nuove credenziali** nell'host compromesso, trovare la **chiave di servizio per generare un token OAuth** senza restrizioni o compromettere un diverso VM con un SA meno restrittivo.

Controlla SA con chiavi generate con:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Tecniche di Escalation dei Privilegi

Il modo per aumentare i tuoi privilegi in AWS √® avere abbastanza autorizzazioni per poter, in qualche modo, accedere ad altri privilegi di account/utenti/gruppi di servizio. Concatenare le escalation fino ad ottenere l'accesso amministrativo sull'organizzazione.

{% hint style="warning" %}
GCP ha **centinaia** (se non migliaia) di **autorizzazioni** che un'entit√† pu√≤ ottenere. In questo libro puoi trovare **tutte le autorizzazioni che conosco** che puoi abusare per **aumentare i privilegi**, ma se conosci qualche percorso non menzionato qui, **per favore condividilo**.
{% endhint %}

**Le sottopagine di questa sezione sono ordinate per servizi. Su ciascun servizio puoi trovare diversi modi per aumentare i privilegi sui servizi.**

### Abusare di GCP per aumentare i privilegi localmente

Se ti trovi all'interno di una macchina in GCP potresti essere in grado di abusare delle autorizzazioni per aumentare i privilegi anche localmente:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Riferimenti

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Impara e pratica l'Hacking su AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di Github.

</details>
{% endhint %}
