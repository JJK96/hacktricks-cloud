# GCP - 提权

{% hint style="success" %}
学习并练习AWS黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks培训AWS红队专家（ARTE）**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习GCP黑客技术：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks培训GCP红队专家（GRTE）**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持HackTricks</summary>

* 查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享黑客技巧。

</details>
{% endhint %}

## GCP提权简介 <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP，像任何其他云一样，有一些**主体**：用户、组和服务帐户，以及一些**资源**，如计算引擎、云函数...\
然后，通过角色，**为这些主体授予对资源的权限**。这是在GCP中指定主体对资源具有的权限的方式。\
有一些权限将允许用户在资源或第三方资源上**获得更多权限**，这就是所谓的**提权**（也就是利用漏洞获得更多权限）。

因此，我想将GCP提权技术分为**2组**：

* **提升为主体**：这将允许您**冒充另一个主体**，因此可以像该主体一样行事，拥有他的所有权限。例如：滥用_getAccessToken_来冒充服务帐户。
* **资源上的提权**：这将允许您**获得对特定资源的更多权限**。例如：您可以滥用_cloudfunctions_上的_setIamPolicy_权限，以允许您触发该函数。
* 请注意，一些**资源权限还将允许您将任意服务帐户**附加到资源上。这意味着您将能够使用SA启动资源，进入资源，并**窃取SA令牌**。因此，这将允许通过资源提升提升为主体。这在以前的几个资源中发生过，但现在发生的频率较低（但仍可能发生）。

显然，最有趣的提权技术是**第二组**的技术，因为它将允许您**获得更多特权，超出您已经拥有某些资源权限的范围**。但是，请注意，**在资源中提升**也可能让您访问**敏感信息**，甚至访问**其他主体**（也许通过读取包含SA令牌的秘密）。

{% hint style="warning" %}
还要注意，在**GCP服务帐户既是主体又是权限**，因此在SA中提升权限也将允许您冒充它。
{% endhint %}

{% hint style="info" %}
括号中的权限指示使用`gcloud`来利用漏洞所需的权限。如果通过API利用漏洞，则可能不需要这些权限。
{% endhint %}

## 提权方法论的权限

这是我**测试特定权限**以执行GCP内部特定操作的方法。

1. 下载github仓库[https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. 在tests/中添加新脚本

## 绕过访问范围 <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

从GCP元数据服务泄漏的SA令牌具有**访问范围**。这些是对令牌具有的**权限**的**限制**。例如，如果令牌具有**`https://www.googleapis.com/auth/cloud-platform`**范围，它将对所有GCP服务具有**完全访问权限**。但是，如果令牌具有**`https://www.googleapis.com/auth/cloud-platform.read-only`**范围，即使SA在IAM中具有更多权限，它也只能对所有GCP服务进行**只读访问**。

没有直接的方法来绕过这些权限，但您可以尝试在受损主机中搜索**新凭据**，找到**服务密钥**以生成没有限制的OAuth令牌，或者**跳转到权限较低的不同VM**。

当使用[访问范围](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam)时，为计算实例（VM）生成的OAuth令牌将包含**范围**的[**限制**](https://oauth.net/2/scope/)。但是，您可能能够**绕过**此限制并利用受损帐户具有的权限。

**绕过**此限制的**最佳方法**是在受损主机中**查找新凭据**，找到**服务密钥以生成没有限制的OAuth令牌**，或者**攻击权限较低的不同VM**。

使用以下命令检查具有生成密钥的SA：
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## 提权技术

在AWS中提升权限的方法是拥有足够的权限，以便能够以某种方式访问其他服务账户/用户/组的权限。通过串联提权直到获得组织的管理员访问权限。

{% hint style="warning" %}
GCP有**数百**（如果不是数千）个**权限**可以授予实体。在本书中，您可以找到我所知道的所有可以滥用以**提升权限**的**权限**，但如果您**知道**这里没有提到的**某些路径**，**请分享**。
{% endhint %}

**本节的子页面按服务排序。您可以在每个服务中找到不同的提权方式。**

### 滥用GCP以在本地提升权限

如果您在GCP中的一台机器内，您可能能够滥用权限以在本地提升权限：

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## 参考资料

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
学习并练习AWS黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习GCP黑客技术：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享黑客技巧。

</details>
{% endhint %}
