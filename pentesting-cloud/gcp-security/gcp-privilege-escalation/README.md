# GCP - Eskalacija privilegija

{% hint style="success" %}
Naučite i vežbajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Uvod u Eskalaciju privilegija u GCP-u <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, kao i svaki drugi oblak, ima neke **principale**: korisnike, grupe i servisne naloge, i neke **resurse** poput računarskog motora, cloud funkcija...\
Zatim, putem uloga, **dozvole se dodeljuju tim principima nad resursima**. To je način da se specificira dozvole koje princip ima nad resursom u GCP-u.\
Postoje određene dozvole koje će korisniku omogućiti **dobijanje još više dozvola** nad resursom ili resursima treće strane, a to se naziva **eskalcija privilegija** (takođe, iskorišćavanje ranjivosti radi dobijanja više dozvola).

Stoga, želeo bih da razdvojim tehnike eskalacije privilegija u GCP-u u **2 grupe**:

* **Privesc na principala**: To će vam omogućiti da **se predstavite kao drugi princip**, i stoga delujete kao on sa svim njegovim dozvolama. npr.: Zloupotreba _getAccessToken_ da se predstavite kao servisni nalog.
* **Privesc na resursu**: To će vam omogućiti da **dobijete više dozvola nad određenim resursom**. npr.: možete zloupotrebiti dozvolu _setIamPolicy_ nad cloud funkcijama da biste omogućili pokretanje funkcije.
* Imajte na umu da će neke **dozvole nad resursima takođe omogućiti povezivanje proizvoljnog servisnog naloga** sa resursom. To znači da ćete moći da pokrenete resurs sa SA, uđete u resurs i **ukradete SA token**. Stoga, to će vam omogućiti da eskalirate na principala putem eskalacije resursa. Ovo se dešavalo u nekoliko resursa ranije, ali sada je manje učestalo (ali se i dalje može desiti).

Očigledno, najinteresantnije tehnike eskalacije privilegija su one iz **druge grupe** jer će vam omogućiti da **dobijete više privilegija izvan resursa nad kojima već imate neke privilegije**. Međutim, imajte na umu da **eskalcija u resursima** može vam takođe omogućiti pristup **osetljivim informacijama** ili čak **drugim principima** (možda čitanjem tajne koja sadrži token SA).

{% hint style="warning" %}
Važno je napomenuti i da su u **GCP servisni nalozi i principali i dozvole**, tako da eskalacija privilegija u SA će vam omogućiti i da se predstavite kao on.
{% endhint %}

{% hint style="info" %}
Dozvole između zagrada ukazuju na dozvole potrebne za iskorišćavanje ranjivosti pomoću `gcloud`. One možda nisu potrebne ako se iskorišćava putem API-ja.
{% endhint %}

## Dozvole za Metodologiju Eskalacije privilegija

Ovako **testiram specifične dozvole** za obavljanje određenih akcija unutar GCP-a.

1. Preuzmite github repozitorijum [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Dodajte novi skript u tests/

## Zaobilazak pristupnih opsega <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Tokeni SA koji cure iz GCP metadata servisa imaju **pristupne opsege**. To su **ograničenja** na **dozvole** koje token ima. Na primer, ako token ima opseg **`https://www.googleapis.com/auth/cloud-platform`**, imaće **puni pristup** svim GCP uslugama. Međutim, ako token ima opseg **`https://www.googleapis.com/auth/cloud-platform.read-only`**, imaće samo **samo čitanje pristupa** svim GCP uslugama čak i ako SA ima više dozvola u IAM.

Ne postoji direktni način za zaobilaženje ovih dozvola, ali uvek možete pokušati da **tražite nove akreditive** na kompromitovanom hostu, **pronađete servisni ključ** za generisanje OAuth tokena bez ograničenja ili **pređete na drugi VM sa manje ograničenjima**.

Kada se koriste [pristupni opsezi](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), OAuth token koji se generiše za računarski instancu (VM) će **imati** [**ograničenje opsega**](https://oauth.net/2/scope/) **uključeno**. Međutim, možda ćete moći da **zaobiđete** ovo ograničenje i iskoristite dozvole koje kompromitovani nalog ima.

**Najbolji način zaobiđanja** ovog ograničenja je ili da **pronađete nove akreditive** na kompromitovanom hostu, da **pronađete servisni ključ za generisanje OAuth tokena** bez ograničenja ili da **kompromitujete drugi VM sa manje ograničenjima**.

Proverite SA sa generisanim ključevima pomoću:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Tehnike eskalacije privilegija

Način da eskalirate svoje privilegije u AWS-u je da imate dovoljno dozvola da možete, na neki način, pristupiti privilegijama drugih servisnih naloga/korisnika/grupa. Povezivanje eskalacija dok ne dobijete administratorski pristup organizaciji.

{% hint style="warning" %}
GCP ima **stotine** (ako ne i hiljade) **dozvola** koje entitet može dobiti. U ovoj knjizi možete pronaći **sve dozvole koje znam** da možete zloupotrebiti za **eskalciju privilegija**, ali ako **znate neki drugi put** koji nije naveden ovde, **molimo vas da ga podelite**.
{% endhint %}

**Podstranice ove sekcije su poređane po servisima. Na svakom servisu možete pronaći različite načine eskalacije privilegija na servisima.**

### Zloupotreba GCP-a za eskalaciju privilegija lokalno

Ako ste unutar mašine u GCP-u, možda ćete moći zloupotrebiti dozvole da eskalirate privilegije čak i lokalno:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Reference

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Naučite i vežbajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
