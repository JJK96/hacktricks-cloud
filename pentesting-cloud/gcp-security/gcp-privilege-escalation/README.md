# GCP - Ανόδος Προνομίων

{% hint style="success" %}
Μάθε & εξάσκησε το Hacking στο AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθε & εξάσκησε το Hacking στο GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Συμμετέχετε** 💬 στην [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Εισαγωγή στην Ανόδο Προνομίων στο GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

Το GCP, όπως κάθε άλλο cloud, έχει κάποιους **κύριους**: χρήστες, ομάδες και λογαριασμούς υπηρεσιών, και κάποιους **πόρους** όπως μηχανή υπολογιστών, λειτουργίες cloud...\
Στη συνέχεια, μέσω ρόλων, **χορηγούνται δικαιώματα σε αυτούς τους κύριους πάνω στους πόρους**. Αυτός είναι ο τρόπος να καθορίζονται τα δικαιώματα που έχει ένας κύριος πάνω σε έναν πόρο στο GCP.\
Υπάρχουν ορισμένα δικαιώματα που θα επιτρέψουν σε έναν χρήστη να **αποκτήσει ακόμα περισσότερα δικαιώματα** στον πόρο ή σε πόρους τρίτων, και αυτός είναι ο λόγος που ονομάζεται **ανόδος προνομίων** (επίσης, η εκμετάλλευση των ευπαθειών για να αποκτήσετε περισσότερα δικαιώματα).

Γι' αυτό, θα ήθελα να χωρίσω τις τεχνικές ανόδου προνομίων στο GCP σε **2 ομάδες**:

* **Ανόδος προνομίων σε έναν κύριο**: Αυτό θα σας επιτρέψει να **υποκαταστήσετε έναν άλλο κύριο**, και συνεπώς να ενεργήσετε όπως αυτός με όλα τα δικαιώματά του. π.χ.: Κατάχρηση _getAccessToken_ για να υποκαταστήσετε έναν λογαριασμό υπηρεσίας.
* **Ανόδος προνομίων στον πόρο**: Αυτό θα σας επιτρέψει να **αποκτήσετε περισσότερα δικαιώματα πάνω στον συγκεκριμένο πόρο**. π.χ.: μπορείτε να καταχραστείτε το δικαίωμα _setIamPolicy_ στις cloudfunctions για να σας επιτρέψει να ενεργοποιήσετε τη λειτουργία.

* Σημειώστε ότι ορισμένα **δικαιώματα πόρων θα σας επιτρέψουν επίσης να συνδέσετε έναν αυθαίρετο λογαριασμό υπηρεσίας** στον πόρο. Αυτό σημαίνει ότι θα μπορείτε να ξεκινήσετε έναν πόρο με έναν ΛΥ, να μπείτε στον πόρο και **να κλέψετε το διακριτικό του ΛΥ**. Συνεπώς, αυτό θα σας επιτρέψει να ανέβετε σε έναν κύριο μέσω μιας ανόδου προνομίων στον πόρο. Αυτό έχει συμβεί σε αρκετούς πόρους προηγουμένως, αλλά τώρα είναι λιγότερο συχνό (αλλά μπορεί ακόμα να συμβεί).

Φυσικά, οι πιο ενδιαφέρουσες τεχνικές ανόδου προνομίων είναι αυτές της **δεύτερης ομάδας** επειδή θα σας επιτρέψουν να **αποκτήσετε περισσότερα προνόμια έξω από τους πόρους στους οποίους ήδη έχετε κάποια προνόμια**. Ωστόσο, σημειώστε ότι **η ανόδος στους πόρους** μπορεί να σας δώσει επίσης πρόσβαση σε **ευαίσθητες πληροφορίες** ή ακόμα και σε **άλλους κύριους** (ίσως μέσω της ανάγνωσης ενός μυστικού που περιέχει ένα διακριτικό ενός ΛΥ).

{% hint style="warning" %}
Σημαντικό είναι επίσης να σημειωθεί ότι στο **GCP οι Λογαριασμοί Υπηρεσίας είναι ταυτόχρονα κύριοι και δικαιώματα**, οπότε η ανόδος προνομίων σε έναν ΛΥ θα σας επιτρέψει επίσης να τον υποκαταστήσετε.
{% endhint %}

{% hint style="info" %}
Τα δικαιώματα μεταξύ παρενθέσεων υποδεικνύουν τα δικαιώματα που απαιτούνται για να εκμεταλλευτείτε την ευπάθεια με το `gcloud`. Αυτά ενδέχεται να μην είναι απαραίτητα αν την εκμεταλλευτείτε μέσω του API.
{% endhint %}

## Δικαιώματα για τη Μεθοδολογία Ανόδου Προνομίων

Έτσι **ελέγχω για συγκεκριμένα δικαιώματα** για να εκτελέσω συγκεκριμένες ενέργειες μέσα στο GCP.

1. Κατεβάστε το αποθετήριο στο github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Προσθέστε στα tests/ το νέο script

## Παράκαμψη πεδίων πρόσβασης <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Τα διακριτικά των ΛΥ που διέρρευσαν από την υπηρεσία μεταδεδομένων του GCP έχουν **πεδία πρόσβασης**. Αυτά είναι **περιορισμοί** στα **δικαιώματα** που έχει το διακριτικό. Για παράδειγμα, αν το διακριτικό έχει το πεδίο **`https://www.googleapis.com/auth/cloud-platform`**, θα έχει **πλήρη πρόσβαση** σε όλες τις υπηρεσίες του GCP. Ωστόσο, αν το διακριτικό έχει το πεδίο **`https://www.googleapis.com/auth/cloud-platform.read-only`**, θα έχει μόνο **πρόσβαση μόνο για ανάγνωση** σε όλες τις υπηρεσίες του GCP ακόμα κι αν ο ΛΥ έχει περισσότερα δικαιώματα στο IAM.

Δεν υπάρχει άμεσος τρόπος να παρακάμψετε αυτά τα δικαιώματα, αλλά μπορείτε πάντα να δοκιμάσετε να αναζητήσετε **νέα διαπιστευτήρια** στο υποβαθμισμένο υπολογιστικό σταθμό, **να βρείτε το κλειδί υπηρεσίας** για να δημιουργήσετε ένα διακριτικό OAuth χωρίς περιορισμό ή **να μεταβείτε σε ένα διαφορετικό VM με λιγότερους περιορισμούς**.

Όταν χρησιμοποιούνται [πεδία πρόσβασης](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), το διακριτικό OAuth που δημιουργείται για την υπολογιστική μονάδα (VM) θα **έχει περιορισμό πεδίου** [**scope**](https://oauth.net/2/scope/) **συμπεριλαμβανόμενο**. Ωστόσο, ενδέχεται να μπορείτε να **παρακάμψετε** αυτόν τον περιορισμό και να εκμεταλλευτείτε τα δικαιώματα που έχει ο υποβαθμισμένος λογαριασμός.

Ο **καλύτερος τρόπος για παράκαμψη** αυτού του περιορισμού είναι είτε να **βρείτε νέα διαπιστευτήρια** στ
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Τεχνικές Εξέλιξης Δικαιωμάτων

Ο τρόπος για να εξελίξετε τα δικαιώματά σας στο AWS είναι να έχετε αρκετές άδειες ώστε, με κάποιον τρόπο, να έχετε πρόσβαση στα δικαιώματα άλλων λογαριασμών/χρηστών/ομάδων υπηρεσιών. Αλυσιδωτές εξελίξεις μέχρι να έχετε διαχειριστική πρόσβαση στον οργανισμό.

{% hint style="warning" %}
Η GCP έχει **εκατοντάδες** (αν όχι χιλιάδες) **άδειες** που μπορεί να χορηγηθεί σε ένα οντότητα. Σε αυτό το βιβλίο μπορείτε να βρείτε **όλες τις άδειες που γνωρίζω** που μπορείτε να καταχραστείτε για να **εξελίξετε δικαιώματα**, αλλά αν γνωρίζετε κάποιον άλλον τρόπο που δεν αναφέρεται εδώ, **μοιραστείτε τον παρακαλώ**.
{% endhint %}

**Οι υποσελίδες αυτής της ενότητας είναι ταξινομημένες ανά υπηρεσίες. Μπορείτε να βρείτε σε κάθε υπηρεσία διαφορετικούς τρόπους για να εξελίξετε δικαιώματα στις υπηρεσίες.**

### Κατάχρηση της GCP για την εξέλιξη δικαιωμάτων τοπικά

Αν βρίσκεστε μέσα σε μια μηχανή στην GCP, μπορείτε να καταχραστείτε άδειες για να εξελίξετε δικαιώματα ακόμα και τοπικά:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Αναφορές

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ κάνοντας υποβολή PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
