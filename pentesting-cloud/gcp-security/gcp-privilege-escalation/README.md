# GCP - Voorregverhoging

{% hint style="success" %}
Leer & oefen AWS-hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP-hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Controleer de [**abonnementsplannen**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hackingtruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

## Inleiding tot GCP Voorregverhoging <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, soos enige ander wolk, het sekere **beginsels**: gebruikers, groepe en diensrekeninge, en sekere **hulpbronne** soos rekeninge, wolkfunksies...\
Dan word via rolle **toestemmings aan daardie beginsels oor die hulpbronne toegeken**. Dit is die manier om die toestemmings wat 'n beginsel oor 'n hulpbron in GCP het, te spesifiseer.\
Daar is sekere toestemmings wat 'n gebruiker sal toelaat om **selfs meer toestemmings** op die hulpbron of derdeparty-hulpbronne te kry, en dit is wat **voorregverhoging** genoem word (ook, die uitbuiting van die kwesbaarhede om meer toestemmings te kry).

Daarom wil ek GCP voorregverhogingstegnieke in **2 groepe** verdeel:

* **Privesc na 'n beginsel**: Dit sal jou toelaat om **'n ander beginsel te impersoneer**, en dus soos dit op te tree met al sy toestemmings. bv.: Misbruik _getAccessToken_ om 'n diensrekening te impersoneer.
* **Privesc op die hulpbron**: Dit sal jou toelaat om **meer toestemmings oor die spesifieke hulpbron te kry**. bv.: jy kan _setIamPolicy_-toestemming oor cloudfunksies misbruik om die funksie te aktiveer.
* Let daarop dat sommige **hulpbron-toestemmings jou ook kan toelaat om 'n willekeurige diensrekening** aan die hulpbron te heg. Dit beteken dat jy 'n hulpbron met 'n DR kan begin, in die hulpbron kan kom, en **die DR-token kan steel**. Daarom sal dit toelaat om na 'n beginsel via 'n hulpbronverhoging te verhoog. Dit het voorheen in verskeie hulpbronne gebeur, maar dit is nou minder gereeld (maar kan steeds gebeur).

Duidelik is die mees interessante voorregverhogingstegnieke di√© van die **tweede groep** omdat dit jou sal toelaat om **meer voorregte buite die hulpbronne wat jy reeds het, te kry**. Let egter daarop dat **verhoging in hulpbronne** jou ook toegang kan gee tot **sensitiewe inligting** of selfs tot **ander beginsels** (miskien deur 'n geheim te lees wat 'n token van 'n DR bevat).

{% hint style="warning" %}
Dit is ook belangrik om te let dat in **GCP-diensrekeninge beide beginsels en toestemmings** is, sodat voorregte in 'n DR jou ook in staat sal stel om dit te impersoneer.
{% endhint %}

{% hint style="info" %}
Die toestemmings tussen hakies dui die toestemmings aan wat nodig is om die kwesbaarheid met `gcloud` te benut. Dit mag dalk nie nodig wees as dit deur die API benut word nie.
{% endhint %}

## Toestemmings vir Voorregverhogingsmetodologie

Dit is hoe ek **spesifieke toestemmings toets** om spesifieke aksies binne GCP uit te voer.

1. Laai die github-opslag [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts) af.
2. Voeg die nuwe skripsie by in tests/

## Oorskryding van toegangsbereike <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Tokens van DR wat uit die GCP-metadata-diens lek, het **toegangsbereike**. Dit is **beperkings** op die **toestemmings** wat die token het. Byvoorbeeld, as die token die **`https://www.googleapis.com/auth/cloud-platform`**-bereik het, sal dit **volle toegang** tot alle GCP-diens h√™. Maar as die token die **`https://www.googleapis.com/auth/cloud-platform.read-only`**-bereik het, sal dit slegs **lees-toegang** tot alle GCP-diens h√™ selfs al het die DR meer toestemmings in IAM.

Daar is geen direkte manier om hierdie toestemmings te omseil nie, maar jy kan altyd probeer om te soek na **nuwe geloofsbriewe** in die gekompromitteerde gasheer, **die diensleutel vind** om 'n OAuth-token sonder beperking te genereer of **spring na 'n ander VM wat minder beperk is**.

Wanneer [toegangsbereike](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) gebruik word, sal die OAuth-token wat vir die rekenaarinstansie (VM) gegenereer word, 'n [**bereikbeperking**](https://oauth.net/2/scope/) ingesluit h√™. Jy mag egter hierdie beperking kan **omseil** en die toestemmings wat die gekompromitteerde rekening het, benut.

Die **beste manier om hierdie beperking te omseil** is om √≥f **nuwe geloofsbriewe te vind** in die gekompromitteerde gasheer, om **die diensleutel te vind om 'n OAuth-token te genereer** sonder beperking of om **'n ander VM met 'n minder beperkte DR te kompromiteer**.

Kontroleer DR met sleutels gegenereer met:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Voorregskaleringstegnieke

Die manier om jou voorregte in AWS te verhoog, is om genoeg toestemmings te h√™ om op een of ander manier toegang te verkry tot ander diensrekening/gebruikers/groep voorregte. Kettingvoorregte totdat jy admin-toegang oor die organisasie het.

{% hint style="warning" %}
GCP het **honderde** (indien nie duisende nie) van **toestemmings** wat 'n entiteit verleen kan word. In hierdie boek kan jy **alle toestemmings wat ek ken** vind wat jy kan misbruik om **voorregte te verhoog**, maar as jy **'n pad ken** wat hier nie genoem word nie, **deel dit asseblief**.
{% endhint %}

**Die subbladsye van hierdie afdeling is gesorteer volgens dienste. Jy kan op elke diens verskillende maniere vind om voorregte op die dienste te verhoog.**

### Misbruik van GCP om voorregte plaaslik te verhoog

As jy binne 'n masjien in GCP is, kan jy dalk toestemmings misbruik om selfs plaaslik voorregte te verhoog:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Verwysings

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Leer & oefen AWS-hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP-hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
