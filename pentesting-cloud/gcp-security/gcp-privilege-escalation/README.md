# GCP - √âl√©vation de privil√®ges

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## Introduction √† l'√©levation de privil√®ges GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, comme tout autre cloud, a certains **principes** : utilisateurs, groupes et comptes de service, et quelques **ressources** comme les instances de calcul, les fonctions cloud...\
Ensuite, via les r√¥les, **des autorisations sont accord√©es √† ces principes sur les ressources**. C'est la mani√®re de sp√©cifier les autorisations qu'un principe a sur une ressource dans GCP.\
Il existe certaines autorisations qui permettront √† un utilisateur d'**obtenir encore plus d'autorisations** sur la ressource ou sur des ressources tierces, et c'est ce qu'on appelle **l'√©l√©vation de privil√®ges** (√©galement, l'exploitation des vuln√©rabilit√©s pour obtenir plus d'autorisations).

Par cons√©quent, je voudrais s√©parer les techniques d'√©l√©vation de privil√®ges GCP en **2 groupes** :

* **√âl√©vation de privil√®ges vers un principe** : Cela vous permettra de **usurper l'identit√© d'un autre principe**, et donc d'agir comme lui avec toutes ses autorisations. Par exemple : Abuser de _getAccessToken_ pour usurper l'identit√© d'un compte de service.
* **√âl√©vation de privil√®ges sur la ressource** : Cela vous permettra d'**obtenir plus d'autorisations sur la ressource sp√©cifique**. Par exemple : vous pouvez abuser de l'autorisation _setIamPolicy_ sur les fonctions cloud pour vous permettre de d√©clencher la fonction.
* Notez que certaines **autorisations sur les ressources vous permettront √©galement d'attacher un compte de service arbitraire** √† la ressource. Cela signifie que vous pourrez lancer une ressource avec un compte de service, acc√©der √† la ressource et **voler le jeton du compte de service**. Par cons√©quent, cela permettra de passer √† un principe via une √©l√©vation de privil√®ges sur une ressource. Cela s'est produit dans plusieurs ressources pr√©c√©demment, mais c'est maintenant moins fr√©quent (mais cela peut encore se produire).

De toute √©vidence, les techniques d'√©l√©vation de privil√®ges les plus int√©ressantes sont celles du **deuxi√®me groupe** car elles vous permettront d'**obtenir plus de privil√®ges en dehors des ressources sur lesquelles vous avez d√©j√† certains privil√®ges**. Cependant, notez que **l'√©l√©vation dans les ressources** peut √©galement vous donner acc√®s √† des **informations sensibles** ou m√™me √† **d'autres principes** (peut-√™tre en lisant un secret contenant un jeton d'un compte de service).

{% hint style="warning" %}
Il est √©galement important de noter qu'**dans GCP, les comptes de service sont √† la fois des principes et des autorisations**, donc l'√©l√©vation de privil√®ges dans un compte de service vous permettra √©galement de l'usurper.
{% endhint %}

{% hint style="info" %}
Les autorisations entre parenth√®ses indiquent les autorisations n√©cessaires pour exploiter la vuln√©rabilit√© avec `gcloud`. Elles pourraient ne pas √™tre n√©cessaires si elle est exploit√©e via l'API.
{% endhint %}

## Autorisations pour la m√©thodologie d'√©l√©vation de privil√®ges

C'est ainsi que je **teste des autorisations sp√©cifiques** pour effectuer des actions sp√©cifiques dans GCP.

1. T√©l√©chargez le d√©p√¥t GitHub [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Ajoutez dans tests/ le nouveau script

## Contournement des √©tendues d'acc√®s <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Les jetons de compte de service divulgu√©s √† partir du service de m√©tadonn√©es GCP ont des **√©tendues d'acc√®s**. Ce sont des **restrictions** sur les **autorisations** que le jeton poss√®de. Par exemple, si le jeton a l'√©tendue **`https://www.googleapis.com/auth/cloud-platform`**, il aura un **acc√®s complet** √† tous les services GCP. Cependant, si le jeton a l'√©tendue **`https://www.googleapis.com/auth/cloud-platform.read-only`**, il aura seulement un **acc√®s en lecture seule** √† tous les services GCP m√™me si le compte de service a plus d'autorisations dans IAM.

Il n'y a pas de moyen direct de contourner ces autorisations, mais vous pouvez toujours essayer de rechercher de **nouvelles informations d'identification** sur l'h√¥te compromis, **trouver la cl√© de service** pour g√©n√©rer un jeton OAuth sans restriction ou **passer √† une autre VM moins restreinte**.

Lorsque les [√©tendues d'acc√®s](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) sont utilis√©es, le jeton OAuth g√©n√©r√© pour l'instance de calcul (VM) **aura une** [**limitation de port√©e**](https://oauth.net/2/scope/) **incluse**. Cependant, vous pourriez √™tre en mesure de **contourner** cette limitation et exploiter les autorisations dont dispose le compte compromis.

La **meilleure fa√ßon de contourner** cette restriction est soit de **trouver de nouvelles informations d'identification** sur l'h√¥te compromis, de **trouver la cl√© de service pour g√©n√©rer un jeton OAuth** sans restriction ou de **compromettre une autre VM avec un compte de service moins restreint**.

V√©rifiez le compte de service avec les cl√©s g√©n√©r√©es avec :
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Techniques d'√©l√©vation de privil√®ges

La fa√ßon d'escalader vos privil√®ges dans AWS est d'avoir suffisamment d'autorisations pour pouvoir, d'une mani√®re ou d'une autre, acc√©der aux privil√®ges d'autres comptes/utilisateurs/groupes de services. Encha√Æner les √©l√©vations jusqu'√† obtenir un acc√®s administratif sur l'organisation.

{% hint style="warning" %}
GCP a **des centaines** (voire des milliers) de **permissions** qu'une entit√© peut se voir accorder. Dans ce livre, vous pouvez trouver **toutes les autorisations que je connais** que vous pouvez abuser pour **escalader des privil√®ges**, mais si vous **connaissez un chemin** non mentionn√© ici, **veuillez le partager**.
{% endhint %}

**Les sous-pages de cette section sont class√©es par services. Vous pouvez trouver sur chaque service diff√©rentes fa√ßons d'escalader les privil√®ges sur les services.**

### Abus de GCP pour escalader les privil√®ges localement

Si vous √™tes √† l'int√©rieur d'une machine dans GCP, vous pourriez √™tre en mesure d'abuser des autorisations pour escalader les privil√®ges m√™me localement :

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
