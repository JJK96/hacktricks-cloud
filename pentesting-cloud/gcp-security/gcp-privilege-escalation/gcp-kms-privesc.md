# GCP - KMS Ayrıcalık Yükseltme

{% hint style="success" %}
AWS Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## KMS

KMS hakkında bilgi:

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

KMS'de **izinlerin** sadece **Orglar**, **Klasörler** ve **Projelerden** değil aynı zamanda **Anahtar Halkalarından** da **miras alındığını** unutmayın.

### `cloudkms.cryptoKeyVersions.useToDecrypt`

Bu izni kullanarak bu izne sahip olduğunuz anahtarla **bilgileri şifreleyebilirsiniz**.
```bash
gcloud kms decrypt \
--location=[LOCATION] \
--keyring=[KEYRING_NAME] \
--key=[KEY_NAME] \
--version=[KEY_VERSION] \
--ciphertext-file=[ENCRYPTED_FILE_PATH] \
--plaintext-file=[DECRYPTED_FILE_PATH]
```
### `cloudkms.cryptoKeys.setIamPolicy`

Bu izne sahip bir saldırgan, anahtarı kullanarak bilgileri şifrelemek için kendisine izin verebilir.
```bash
gcloud kms keys add-iam-policy-binding [KEY_NAME] \
--location [LOCATION] \
--keyring [KEYRING_NAME] \
--member [MEMBER] \
--role roles/cloudkms.cryptoKeyDecrypter
```
### `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`

İşte bu yetkilendirme nasıl çalışırın kavramsal bir açıklaması:

1. **Hizmet Hesabı A**, KMS'deki belirli bir anahtarı kullanarak şifrelemeyi doğrudan çözebilme erişimine sahiptir.
2. **Hizmet Hesabı B**, `useToDecryptViaDelegation` iznini verilir. Bu, KMS'nin Hizmet Hesabı A adına veri çözmek için istekte bulunmasına izin verir.

Bu **izin kullanımı, KMS hizmetinin izinleri kontrol ettiği şekilde** şifre çözme isteği yapıldığında örtük olarak gerçekleşir.

Google Cloud KMS API'sini (Python veya başka bir dilde) kullanarak standart bir şifre çözme isteği yaptığınızda, hizmet **isteği yapan hizmet hesabının gerekli izinlere sahip olup olmadığını kontrol eder**. Eğer istek, **`useToDecryptViaDelegation`** iznine sahip bir hizmet hesabı tarafından yapılırsa, KMS, bu **hesabın anahtarı sahibi adına şifre çözme isteğinde bulunmaya yetkili olup olmadığını doğrular**.

#### Yetkilendirme için Kurulum

1. **Özel Rolü Tanımlayın**: Özel rolü tanımlayan bir YAML dosyası oluşturun (örneğin, `custom_role.yaml`). Bu dosya, `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation` iznini içermelidir. İşte bu dosyanın nasıl görünebileceğine dair bir örnek:
```yaml
title: "KMS Decryption via Delegation"
description: "Allows decryption via delegation"
stage: "GA"
includedPermissions:
- "cloudkms.cryptoKeyVersions.useToDecryptViaDelegation"
```
2. **gcloud CLI Kullanarak Özel Rol Oluşturma**: Google Cloud projesinde özel rol oluşturmak için aşağıdaki komutu kullanın:

{% code overflow="wrap" %}
```bash
gcloud iam roles create kms_decryptor_via_delegation --project [YOUR_PROJECT_ID] --file custom_role.yaml
```
{% endcode %}

`[PROJE_KIMLIK_NUMARANIZ]` ifadesini Google Cloud proje kimlik numaranızla değiştirin.

3. **Özel Rolü Bir Hizmet Hesabına Verme**: Bu izni kullanacak bir hizmet hesabına özel rolünüzü atayın. Aşağıdaki komutu kullanın:
```bash
# Give this permission to the service account to impersonate
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member "serviceAccount:[SERVICE_ACCOUNT_B_EMAIL]" \
--role "projects/[PROJECT_ID]/roles/[CUSTOM_ROLE_ID]"

# Give this permission over the project to be able to impersonate any SA
gcloud projects add-iam-policy-binding [YOUR_PROJECT_ID] \
--member="serviceAccount:[SERVICE_ACCOUNT_EMAIL]" \
--role="projects/[YOUR_PROJECT_ID]/roles/kms_decryptor_via_delegation"
```
`[YOUR_PROJECT_ID]` ve `[SERVICE_ACCOUNT_EMAIL]` yerine sırasıyla proje kimliğinizi ve hizmet hesabının e-posta adresini yazın.

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin**.
* **HackTricks** ve **HackTricks Cloud** github depolarına PR göndererek hacking püf noktalarını paylaşın.

</details>
{% endhint %}
