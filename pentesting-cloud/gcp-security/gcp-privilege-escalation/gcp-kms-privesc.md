# GCP - KMS рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг AWS рд░реЗрдб рдЯреАрдо рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг GCP рд░реЗрдб рдЯреАрдо рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВред

</details>
{% endhint %}

## KMS

KMS рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА:

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ KMS рдореЗрдВ **рдЕрдиреБрдорддрд┐рдпрд╛рдБ** рдХреЗрд╡рд▓ **Orgs**, **Folders** рдФрд░ **Projects** рд╕реЗ рд╣реА **рд╡рд┐рд░рд╛рд╕рдд** рдореЗрдВ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИрдВ, рдмрд▓реНрдХрд┐ **Keyrings** рд╕реЗ рднреАред

### `cloudkms.cryptoKeyVersions.useToDecrypt`

рдЖрдк рдЗрд╕ рдЕрдиреБрдорддрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдХреБрдВрдЬреА рдХреЗ рд╕рд╛рде рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```bash
gcloud kms decrypt \
--location=[LOCATION] \
--keyring=[KEYRING_NAME] \
--key=[KEY_NAME] \
--version=[KEY_VERSION] \
--ciphertext-file=[ENCRYPTED_FILE_PATH] \
--plaintext-file=[DECRYPTED_FILE_PATH]
```
### `cloudkms.cryptoKeys.setIamPolicy`

рдЗрд╕ рдЕрдиреБрдорддрд┐ рдХреЗ рд╕рд╛рде рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **рдЦреБрдж рдХреЛ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рджреЗ рд╕рдХрддрд╛ рд╣реИ** рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реВрдЪрдирд╛ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред
```bash
gcloud kms keys add-iam-policy-binding [KEY_NAME] \
--location [LOCATION] \
--keyring [KEYRING_NAME] \
--member [MEMBER] \
--role roles/cloudkms.cryptoKeyDecrypter
```
### `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`

рдпрд╣рд╛рдБ рдЗрд╕ рдбреЗрд▓реАрдЧреЗрд╢рди рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд╕рд┐рджреНрдзрд╛рдВрддрд┐рдХ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рд╣реИ:

1. **рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ A** рдХреЛ KMS рдореЗрдВ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХрд╛ рд╕реАрдзрд╛ рдПрдХреНрд╕реЗрд╕ рд╣реИред
2. **рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ B** рдХреЛ `useToDecryptViaDelegation` рдЕрдиреБрдорддрд┐ рдкреНрд░рджрд╛рди рдХреА рдЧрдИ рд╣реИред рдЗрд╕рд╕реЗ рдпрд╣ KMS рд╕реЗ рдбреЗрдЯрд╛ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ A рдХреА рдУрд░ рд╕реЗ рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддрд╛ рд╣реИред

**рдЗрд╕ рдЕрдиреБрдорддрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ KMS рд╕реЗрд╡рд╛ рдЪреЗрдХ рдХрд░рддреА рд╣реИ рдЬрдм рдПрдХ рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред

рдЬрдм рдЖрдк Google Cloud KMS API (Python рдпрд╛ рдХрд┐рд╕реА рдЕрдиреНрдп рднрд╛рд╖рд╛ рдореЗрдВ) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реНрдЯреИрдВрдбрд░реНрдб рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдЕрдиреБрд░реЛрдз рдХрд░рддреЗ рд╣реИрдВ, рд╕реЗрд╡рд╛ **рдпрд╣ рдЬрд╛рдВрдЪрддреА рд╣реИ рдХрд┐ рдЕрдиреБрд░реЛрдзрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдХреЗ рдкрд╛рд╕ рдЖрд╡рд╢реНрдпрдХ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ**ред рдЕрдЧрд░ рдЕрдиреБрд░реЛрдз рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рджреНрд╡рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ **`useToDecryptViaDelegation`** рдЕрдиреБрдорддрд┐ рд╣реИ, рддреЛ KMS рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдпрд╣ **рдЦреБрдж рдХреБрдВрдЬреА рдХреЗ рдорд╛рд▓рд┐рдХ рдХреЗ рд▓рд┐рдП рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ**ред

#### рдбреЗрд▓реАрдЧреЗрд╢рди рдХреЗ рд▓рд┐рдП рд╕реЗрдЯрдЕрдк

1. **рдХрд╕реНрдЯрдо рд░реЛрд▓ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░реЗрдВ**: рдПрдХ YAML рдлрд╝рд╛рдЗрд▓ рдмрдирд╛рдПрдВ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `custom_role.yaml`) рдЬреЛ рдХрд╕реНрдЯрдо рд░реЛрд▓ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддреА рд╣реИред рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation` рдЕрдиреБрдорддрд┐ рд╢рд╛рдорд┐рд▓ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред рдпрд╣рд╛рдБ рдПрдХ рдЙрджрд╛рд╣рд░рдг рд╣реИ рдХрд┐ рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдХреИрд╕реЗ рджрд┐рдЦ рд╕рдХрддреА рд╣реИ:
```yaml
title: "KMS Decryption via Delegation"
description: "Allows decryption via delegation"
stage: "GA"
includedPermissions:
- "cloudkms.cryptoKeyVersions.useToDecryptViaDelegation"
```
2. **gcloud CLI рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд╕реНрдЯрдо рднреВрдорд┐рдХрд╛ рдмрдирд╛рдПрдВ**: рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдЕрдкрдиреЗ Google Cloud рдкрд░рд┐рдпреЛрдЬрдирд╛ рдореЗрдВ рдХрд╕реНрдЯрдо рднреВрдорд┐рдХрд╛ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП:
```bash
gcloud iam roles create kms_decryptor_via_delegation --project [YOUR_PROJECT_ID] --file custom_role.yaml
```
{% endcode %}

рдЕрдкрдиреЗ Google Cloud рдкрд░рд┐рдпреЛрдЬрдирд╛ рдЖрдИрдбреА рдХреЗ рд╕рд╛рде `[YOUR_PROJECT_ID]` рдХреЛ рдмрджрд▓реЗрдВред

3. **рдХрд╕реНрдЯрдо рднреВрдорд┐рдХрд╛ рдХреЛ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЛ рдкреНрд░рджрд╛рди рдХрд░реЗрдВ**: рдЗрд╕ рдЕрдиреБрдорддрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдЖрдкрдХреА рдХрд╕реНрдЯрдо рднреВрдорд┐рдХрд╛ рдХреЛ рдЕрд╕рд╛рдЗрди рдХрд░реЗрдВред рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:
```bash
# Give this permission to the service account to impersonate
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member "serviceAccount:[SERVICE_ACCOUNT_B_EMAIL]" \
--role "projects/[PROJECT_ID]/roles/[CUSTOM_ROLE_ID]"

# Give this permission over the project to be able to impersonate any SA
gcloud projects add-iam-policy-binding [YOUR_PROJECT_ID] \
--member="serviceAccount:[SERVICE_ACCOUNT_EMAIL]" \
--role="projects/[YOUR_PROJECT_ID]/roles/kms_decryptor_via_delegation"
```
`[YOUR_PROJECT_ID]` рдФрд░ `[SERVICE_ACCOUNT_EMAIL]` рдХреЛ рдЕрдкрдиреЗ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдЖрдИрдбреА рдФрд░ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЗ рдИрдореЗрд▓ рдХреЗ рд╕рд╛рде рдмрджрд▓реЗрдВред

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг AWS рд░реЗрдб рдЯреАрдо рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг GCP рд░реЗрдб рдЯреАрдо рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>
{% endhint %}
