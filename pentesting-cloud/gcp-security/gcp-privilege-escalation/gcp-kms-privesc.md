# GCP - KMS Privilege Escalation

{% hint style="success" %}
Lernen Sie und √ºben Sie AWS-Hacking: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie und √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys senden.

</details>
{% endhint %}

## KMS

Informationen zu KMS:

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

Beachten Sie, dass in KMS die **Berechtigungen** nicht nur von Organisationen, Ordnern und Projekten geerbt werden, sondern auch von **Keyrings**.

### `cloudkms.cryptoKeyVersions.useToDecrypt`

Sie k√∂nnen diese Berechtigung verwenden, um **Informationen mit dem Schl√ºssel zu entschl√ºsseln**, √ºber den Sie diese Berechtigung haben.
```bash
gcloud kms decrypt \
--location=[LOCATION] \
--keyring=[KEYRING_NAME] \
--key=[KEY_NAME] \
--version=[KEY_VERSION] \
--ciphertext-file=[ENCRYPTED_FILE_PATH] \
--plaintext-file=[DECRYPTED_FILE_PATH]
```
### `cloudkms.cryptoKeys.setIamPolicy`

Ein Angreifer mit dieser Berechtigung k√∂nnte **sich selbst Berechtigungen geben**, um den Schl√ºssel zur Entschl√ºsselung von Informationen zu verwenden.
```bash
gcloud kms keys add-iam-policy-binding [KEY_NAME] \
--location [LOCATION] \
--keyring [KEYRING_NAME] \
--member [MEMBER] \
--role roles/cloudkms.cryptoKeyDecrypter
```
### `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`

Hier ist eine konzeptionelle Aufschl√ºsselung, wie diese Delegation funktioniert:

1. **Dienstkonto A** hat direkten Zugriff auf das Entschl√ºsseln unter Verwendung eines bestimmten Schl√ºssels in KMS.
2. **Dienstkonto B** erh√§lt die Berechtigung `useToDecryptViaDelegation`. Dies erm√∂glicht es ihm, KMS aufzufordern, Daten stellvertretend f√ºr Dienstkonto A zu entschl√ºsseln.

Die Verwendung dieser **Berechtigung ist implizit in der Art und Weise, wie der KMS-Dienst Berechtigungen √ºberpr√ºft**, wenn eine Entschl√ºsselungsanforderung gestellt wird.

Wenn Sie eine Standard-Entschl√ºsselungsanforderung √ºber die Google Cloud KMS-API (in Python oder einer anderen Sprache) stellen, √ºberpr√ºft der Dienst, ob das anfordernde Dienstkonto √ºber die erforderlichen Berechtigungen verf√ºgt. Wenn die Anforderung von einem Dienstkonto mit der **`useToDecryptViaDelegation`**-Berechtigung gestellt wird, √ºberpr√ºft KMS, ob dieses **Konto berechtigt ist, die Entschl√ºsselung stellvertretend f√ºr die Entit√§t, die den Schl√ºssel besitzt, anzufordern**.

#### Einrichten f√ºr Delegation

1. **Definieren der benutzerdefinierten Rolle**: Erstellen Sie eine YAML-Datei (z. B. `custom_role.yaml`), die die benutzerdefinierte Rolle definiert. Diese Datei sollte die Berechtigung `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation` enthalten. Hier ist ein Beispiel, wie diese Datei aussehen k√∂nnte:
```yaml
title: "KMS Decryption via Delegation"
description: "Allows decryption via delegation"
stage: "GA"
includedPermissions:
- "cloudkms.cryptoKeyVersions.useToDecryptViaDelegation"
```
2. **Erstellen der benutzerdefinierten Rolle mit dem gcloud CLI**: Verwenden Sie den folgenden Befehl, um die benutzerdefinierte Rolle in Ihrem Google Cloud-Projekt zu erstellen:

{% code overflow="wrap" %}
```bash
gcloud iam roles create kms_decryptor_via_delegation --project [YOUR_PROJECT_ID] --file custom_role.yaml
```
{% endcode %}

Ersetzen Sie `[YOUR_PROJECT_ID]` durch Ihre Google Cloud-Projekt-ID.

3. **Weisen Sie die benutzerdefinierte Rolle einem Dienstkonto zu**: Weisen Sie Ihre benutzerdefinierte Rolle einem Dienstkonto zu, das diese Berechtigung verwenden wird. Verwenden Sie den folgenden Befehl:
```bash
# Give this permission to the service account to impersonate
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member "serviceAccount:[SERVICE_ACCOUNT_B_EMAIL]" \
--role "projects/[PROJECT_ID]/roles/[CUSTOM_ROLE_ID]"

# Give this permission over the project to be able to impersonate any SA
gcloud projects add-iam-policy-binding [YOUR_PROJECT_ID] \
--member="serviceAccount:[SERVICE_ACCOUNT_EMAIL]" \
--role="projects/[YOUR_PROJECT_ID]/roles/kms_decryptor_via_delegation"
```
Ersetzen Sie `[IHRE_PROJEKT_ID]` und `[SERVICE_ACCOUNT_EMAIL]` durch Ihre Projekt-ID und die E-Mail des Dienstkontos, respectively.

{% hint style="success" %}
Lernen Sie & √ºben Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie & √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys einreichen.

</details>
{% endhint %}
