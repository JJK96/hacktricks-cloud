# GCP - Speicherprivilegien-Eskalation

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## Speicher

Grundlegende Informationen:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Diese Berechtigung erm√∂glicht es Ihnen, **Dateien herunterzuladen, die im Cloud-Speicher gespeichert sind**. Dies kann Ihnen potenziell erm√∂glichen, Berechtigungen zu eskalieren, da in einigen F√§llen **sensible Informationen dort gespeichert sind**. Dar√ºber hinaus speichern einige GCP-Dienste ihre Informationen in Buckets:

* **GCP Composer**: Wenn Sie eine Composer-Umgebung erstellen, wird der **Code aller DAGs** in einem **Bucket** gespeichert. Diese Aufgaben k√∂nnen interessante Informationen in ihrem Code enthalten.
* **GCR (Container Registry)**: Das **Image** der Container wird in **Buckets** gespeichert, was bedeutet, dass Sie, wenn Sie die Buckets lesen k√∂nnen, die Bilder herunterladen und **nach Lecks und/oder Quellcode suchen** k√∂nnen.

### `storage.objects.setIamPolicy`

Sie k√∂nnen sich die Berechtigung geben, **einen der vorherigen Szenarien dieses Abschnitts zu missbrauchen**.

### **`storage.buckets.setIamPolicy`**

F√ºr ein Beispiel, wie Berechtigungen mit dieser Berechtigung ge√§ndert werden k√∂nnen, √ºberpr√ºfen Sie diese Seite:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Die "Interoperabilit√§ts"-Funktion des Cloud-Speichers, die f√ºr **Cross-Cloud-Interaktionen** wie mit AWS S3 konzipiert ist, beinhaltet die **Erstellung von HMAC-Schl√ºsseln f√ºr Dienstkonten und Benutzer**. Ein Angreifer kann dies ausnutzen, indem er **einen HMAC-Schl√ºssel f√ºr ein Dienstkonto mit erh√∂hten Berechtigungen generiert**, um so **Berechtigungen im Cloud-Speicher zu eskalieren**. W√§hrend benutzerbezogene HMAC-Schl√ºssel nur √ºber die Weboberfl√§che abrufbar sind, bleiben sowohl der Zugriffs- als auch der geheime Schl√ºssel **dauerhaft zug√§nglich**, was potenziellen Backup-Zugriff erm√∂glicht. Im Gegensatz dazu sind Dienstkonto-verkn√ºpfte HMAC-Schl√ºssel √ºber die API abrufbar, aber ihre Zugriffs- und geheimen Schl√ºssel sind nach der Erstellung nicht abrufbar, was eine zus√§tzliche Komplexit√§t f√ºr den kontinuierlichen Zugriff darstellt.
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
Ein weiteres Exploit-Skript f√ºr diese Methode finden Sie [hier](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Speicher Schreibberechtigungen

Um ein neues Objekt in einem Eimer zu erstellen, ben√∂tigen Sie `storage.objects.create` und laut [der Dokumentation](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions) ben√∂tigen Sie auch `storage.objects.delete`, um ein vorhandenes Objekt zu √§ndern.

Eine sehr h√§ufige Ausnutzung von Eimern, in denen Sie in der Cloud schreiben k√∂nnen, besteht darin, dass der Eimer Webserverdateien speichert. M√∂glicherweise k√∂nnen Sie neuen Code speichern, der von der Webanwendung verwendet wird.

### Composer

**Composer** ist **Apache Airflow**, der innerhalb von GCP verwaltet wird. Es hat mehrere interessante Funktionen:

* Es l√§uft in einem **GKE-Cluster**, sodass der **SA, den der Cluster verwendet, vom im Composer ausgef√ºhrten Code zug√§nglich ist**.
* Es speichert den **Code in einem Eimer**, daher wird **jeder mit Schreibzugriff auf diesen Eimer** in der Lage sein, einen DGA-Code zu √§ndern/hinzuzuf√ºgen (den Code, den Apache Airflow ausf√ºhren wird).\
Dann, wenn Sie **Schreibzugriff auf den Eimer haben, den Composer verwendet**, um den Code zu speichern, k√∂nnen Sie **zu dem SA eskalieren, der im GKE-Cluster l√§uft**.

### Cloud Functions

* Der Code von Cloud Functions wird im Speicher gespeichert, sodass es m√∂glich ist, durch √úberschreiben davon beliebigen Code auszuf√ºhren.

### App Engine

* Der Quellcode von App Engine wird in Eimern gespeichert, durch **√úberschreiben des Codes k√∂nnte es m√∂glich sein, beliebigen Code auszuf√ºhren. DAS IST NICHT M√ñGLICH**
* **Es scheint, dass Container-Schichten im Eimer gespeichert sind, vielleicht diese √§ndern?**

### GCR

* **Google Container Registry** speichert die Images in Eimern, wenn Sie **diese Eimer beschreiben k√∂nnen**, k√∂nnten Sie m√∂glicherweise **seitlich zu dem Ort wechseln, an dem diese Eimer ausgef√ºhrt werden**.
* Der von GCR verwendete Eimer hat eine URL √§hnlich wie `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Die Top-Level-Subdomains sind [hier](https://cloud.google.com/container-registry/docs/pushing-and-pulling) angegeben).

## **Referenzen**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
