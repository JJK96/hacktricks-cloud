# GCP - Storage Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Storage

Temel Bilgiler:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Bu izin, **Cloud Storage içinde saklanan dosyaları indirmenize** olanak tanır. Bu, bazı durumlarda **hassas bilgilerin orada saklanması** nedeniyle yetki yükseltmenize olanak sağlayabilir. Ayrıca, bazı GCP hizmetleri bilgilerini bucket'larda saklar:

* **GCP Composer**: Bir Composer Ortamı oluşturduğunuzda, **tüm DAG'ların kodu** bir **bucket** içinde saklanacaktır. Bu görevler, kodlarının içinde ilginç bilgiler içerebilir.
* **GCR (Container Registry)**: Konteynerlerin **görüntüleri** **bucket'larda** saklanır, bu da bucket'ları okuyabiliyorsanız görüntüleri indirebileceğiniz ve **sızıntılar ve/veya kaynak kodu** arayabileceğiniz anlamına gelir.

### `storage.objects.setIamPolicy`

Bu bölümdeki önceki senaryoları **istismar etme** izni verebilirsiniz.

### **`storage.buckets.setIamPolicy`**

Bu izinle izinleri nasıl değiştireceğinize dair bir örnek için bu sayfayı kontrol edin:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Cloud Storage'ın "işletilebilirlik" özelliği, AWS S3 gibi **bulutlar arası etkileşimler** için tasarlanmıştır ve **HMAC anahtarlarının Hizmet Hesapları ve kullanıcılar için oluşturulmasını** içerir. Bir saldırgan, **yükseltilmiş yetkilere sahip bir Hizmet Hesabı için HMAC anahtarı oluşturarak** bunu istismar edebilir ve böylece **Cloud Storage içinde yetki yükseltebilir**. Kullanıcıya bağlı HMAC anahtarları yalnızca web konsolu aracılığıyla alınabilirken, hem erişim hem de gizli anahtarlar **sürekli erişilebilir** kalır ve potansiyel yedek erişim depolamasına olanak tanır. Öte yandan, Hizmet Hesabı ile bağlantılı HMAC anahtarları API erişimine açıktır, ancak erişim ve gizli anahtarları oluşturulduktan sonra alınamaz, bu da sürekli erişim için bir katman karmaşıklığı ekler.

{% code overflow="wrap" %}
```bash
# Create key
gsutil hmac create <sa-email> # You might need to execute this inside a VM instance

## If you have TROUBLES creating the HMAC key this was you can also do it contacting the API directly:
PROJECT_ID = '$PROJECT_ID'
TARGET_SERVICE_ACCOUNT = f"exam-storage-sa-read-flag-3@{PROJECT_ID}.iam.gserviceaccount.com"
ACCESS_TOKEN = "$CLOUDSDK_AUTH_ACCESS_TOKEN"
import requests
import json
key = requests.post(
f'https://www.googleapis.com/storage/v1/projects/{PROJECT_ID}/hmacKeys',
params={'access_token': ACCESS_TOKEN, 'serviceAccountEmail': TARGET_SERVICE_ACCOUNT}
).json()
#print(json.dumps(key, indent=4))
print(f'ID: {key["metadata"]["accessId"]}')
print(f'Secret: {key["secret"]}')


# Configure gsutil to use the HMAC key
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
{% endcode %}

Bu yöntem için başka bir istismar betiği [burada](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py) bulunabilir.

## `storage.objects.create`, `storage.objects.delete` = Depolama Yazma izinleri

Bir **nesne oluşturmak** için bir kovada `storage.objects.create` ve [belgelere](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions) göre mevcut bir nesneyi **değiştirmek** için `storage.objects.delete` iznine de ihtiyacınız var.

Bulut içinde yazma yapabileceğiniz kovaların çok **yaygın bir istismar** durumu, eğer **kova web sunucusu dosyalarını kaydediyorsa**, web uygulaması tarafından kullanılacak **yeni kodlar depolayabilmenizdir**.

### Composer

**Composer**, GCP içinde yönetilen **Apache Airflow**'dur. Birkaç ilginç özelliği vardır:

* **GKE kümesinin içinde çalışır**, bu nedenle **kümenin kullandığı SA, Composer içinde çalışan kod tarafından erişilebilir**.
* Bir composer ortamının tüm bileşenleri (**DAG'ların kodu**, eklentiler ve veriler) bir GCP kovasında depolanır. Eğer saldırganın buna okuma ve yazma izinleri varsa, kovayı izleyebilir ve **herhangi bir DAG oluşturulduğunda veya güncellendiğinde, arka kapılı bir versiyon gönderebilir**, böylece composer ortamı depolamadan arka kapılı versiyonu alır.

**Bu saldırının bir PoC'sini repoda bulabilirsiniz:** [**https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs**](https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs)

### Cloud Functions

* Cloud Functions kodu Depolama'da saklanır ve yeni bir versiyon oluşturulduğunda kod kovaya itilir ve ardından bu koddan yeni bir konteyner oluşturulur. Bu nedenle, **yeni versiyon oluşturulmadan önce kodu üzerine yazarak bulut fonksiyonunun rastgele kod çalıştırmasını sağlamak mümkündür**.

**Bu saldırının bir PoC'sini repoda bulabilirsiniz:** [**https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions**](https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions)

### App Engine

* App Engine versiyonları, `staging.<project-id>.appspot.com` formatında bir kova içinde bazı veriler oluşturur. Bu kovayı önceden ele geçirmenin mümkün olmadığını unutmayın çünkü GCP kullanıcıları `appspot.com` alan adını kullanarak kova oluşturmak için yetkilendirilmemiştir.

Ancak, bu kovada okuma ve yazma erişimi ile, **AppEngine versiyonuna bağlı SA'ya yetki yükseltmek mümkündür**. Kovayı izleyerek ve herhangi bir değişiklik yapıldığında, kodu mümkün olan en hızlı şekilde değiştirebilirsiniz. Bu şekilde, bu koddan oluşturulan konteyner **arka kapılı kodu çalıştıracaktır**.

**Bu saldırının bir PoC'sini repoda bulabilirsiniz:** [**https://github.com/carlospolop/Monitor-Backdoor-AppEngine**](https://github.com/carlospolop/Monitor-Backdoor-AppEngine)

### GCR

* **Google Container Registry**, görüntüleri kovalar içinde saklar, eğer bu **kovalara yazabiliyorsanız**, bu kovaların çalıştığı yere **yanal hareket etme** imkanınız olabilir.
* GCR tarafından kullanılan kova, `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` benzeri bir URL'ye sahip olacaktır (En üst düzey alt alan adları [burada](https://cloud.google.com/container-registry/docs/pushing-and-pulling) belirtilmiştir).

{% hint style="success" %}
Bu hizmet kullanımdan kaldırılmıştır, bu nedenle bu saldırı artık faydalı değildir. Ayrıca, bu hizmetin yerini alan Artifactory, görüntüleri kovalar içinde saklamaz.
{% endhint %}

## **Referanslar**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
