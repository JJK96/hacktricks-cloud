# GCP - √âl√©vation de privil√®ges du stockage

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert Red Team AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Stockage

Informations de base :

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Cette autorisation vous permet de **t√©l√©charger des fichiers stock√©s dans Cloud Storage**. Cela pourrait potentiellement vous permettre d'√©lever les privil√®ges car dans certaines occasions, **des informations sensibles y sont enregistr√©es**. De plus, certains services GCP stockent leurs informations dans des buckets :

* **GCP Composer** : Lorsque vous cr√©ez un environnement Composer, le **code de tous les DAGs** sera enregistr√© dans un **bucket**. Ces t√¢ches peuvent contenir des informations int√©ressantes dans leur code.
* **GCR (Container Registry)** : L'**image** des conteneurs est stock√©e dans des **buckets**, ce qui signifie que si vous pouvez lire les buckets, vous pourrez t√©l√©charger les images et **rechercher des fuites et/ou du code source**.

### `storage.objects.setIamPolicy`

Vous pouvez vous donner la permission d'**exploiter l'un des sc√©narios pr√©c√©dents de cette section**.

### **`storage.buckets.setIamPolicy`**

Pour un exemple de modification des autorisations avec cette autorisation, consultez cette page :

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

La fonctionnalit√© "interop√©rabilit√©" de Cloud Storage, con√ßue pour les **interactions inter-cloud** comme avec AWS S3, implique la **cr√©ation de cl√©s HMAC pour les comptes de service et les utilisateurs**. Un attaquant peut exploiter cela en **g√©n√©rant une cl√© HMAC pour un compte de service avec des privil√®ges √©lev√©s**, permettant ainsi d'**√©lever les privil√®ges au sein de Cloud Storage**. Alors que les cl√©s HMAC associ√©es √† l'utilisateur ne sont r√©cup√©rables que via la console web, les cl√©s d'acc√®s et secr√®tes restent **accessibles en permanence**, permettant une √©ventuelle sauvegarde d'acc√®s au stockage. En revanche, les cl√©s HMAC li√©es au compte de service sont accessibles via l'API, mais leurs cl√©s d'acc√®s et secr√®tes ne sont pas r√©cup√©rables apr√®s la cr√©ation, ajoutant une couche de complexit√© pour un acc√®s continu.
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
Un autre script d'exploitation pour cette m√©thode peut √™tre trouv√© [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Autorisations d'√©criture de stockage

Pour **cr√©er un nouvel objet** √† l'int√©rieur d'un bucket, vous avez besoin de `storage.objects.create` et, selon [la documentation](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions), vous avez √©galement besoin de `storage.objects.delete` pour **modifier** un objet existant.

Une **exploitation tr√®s courante** des buckets o√π vous pouvez √©crire dans le cloud est le cas o√π le **bucket enregistre des fichiers de serveur web**, vous pourriez √™tre en mesure de **stocker un nouveau code** qui sera utilis√© par l'application web.

### Composer

**Composer** est **Apache Airflow** g√©r√© √† l'int√©rieur de GCP. Il a plusieurs fonctionnalit√©s int√©ressantes :

* Il s'ex√©cute √† l'int√©rieur d'un **cluster GKE**, donc le **SA utilis√© par le cluster est accessible** par le code s'ex√©cutant √† l'int√©rieur de Composer
* Il stocke le **code dans un bucket**, donc, **toute personne ayant un acc√®s en √©criture sur ce bucket** pourra modifier/ajouter un code DGA (le code qu'Apache Airflow ex√©cutera)\
Ainsi, si vous avez **un acc√®s en √©criture sur le bucket utilis√© par Composer** pour stocker le code, vous pouvez **√©lever les privil√®ges vers le SA s'ex√©cutant dans le cluster GKE**.

### Cloud Functions

* Le code des Cloud Functions est stock√© dans Storage, donc **en l'√©crasant, il est possible d'ex√©cuter un code arbitraire**.

### App Engine

* Le code source de App Engine est stock√© dans des buckets, **en √©crasant le code, il pourrait √™tre possible d'ex√©cuter un code arbitraire. CE N'EST PAS POSSIBLE**
* **Il semble que les couches de conteneurs soient stock√©es dans le bucket, peut-√™tre en les changeant?**

### GCR

* **Google Container Registry** stocke les images √† l'int√©rieur de buckets, si vous pouvez **√©crire dans ces buckets** vous pourriez √™tre en mesure de **se d√©placer lat√©ralement l√† o√π ces buckets sont ex√©cut√©s.**
* Le bucket utilis√© par GCR aura une URL similaire √† `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Les sous-domaines de niveau sup√©rieur sont sp√©cifi√©s [ici](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

## **R√©f√©rences**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
