# GCP - ストレージ特権昇格

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して**ハッキングテクニックを共有**してください。

</details>
{% endhint %}

## ストレージ

基本情報:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

この権限を持つと、**Cloud Storage内に保存されたファイルをダウンロード**できます。これにより、**機密情報が保存されている場合があるため、特権昇格が可能**です。さらに、一部のGCPサービスは情報をバケットに保存しています:

* **GCP Composer**: Composer環境を作成すると、**すべてのDAGのコード**が**バケット**内に保存されます。これらのタスクにはコード内に興味深い情報が含まれている可能性があります。
* **GCR (Container Registry)**: コンテナの**イメージ**は**バケット**に保存されており、バケットを読み取ることでイメージをダウンロードし、**漏洩やソースコードを検索**することができます。

### `storage.objects.setIamPolicy`

この権限を使用すると、このセクションの以前のシナリオを**悪用する権限を与える**ことができます。

### **`storage.buckets.setIamPolicy`**

この権限を使用してアクセス権を変更する例については、次のページを参照してください:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Cloud Storageの「相互運用性」機能は、AWS S3などの**クロスクラウド相互作用**を目的としており、**サービスアカウントとユーザーのためにHMACキーを作成**します。攻撃者はこれを悪用して、特権の昇格を行うために**特権の昇格を行うためにサービスアカウント用のHMACキーを生成**することができます。ユーザー関連のHMACキーはWebコンソールを介してのみ取得可能ですが、アクセスキーとシークレットキーは**永続的にアクセス可能**であり、潜在的なバックアップアクセスストレージを提供します。一方、サービスアカウントにリンクされたHMACキーはAPI経由で取得可能ですが、アクセスキーとシークレットキーは作成後に取得できず、継続的なアクセスのための複雑さが追加されます。
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
別のエクスプロイトスクリプトは[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py)で見つけることができます。

## `storage.objects.create`、`storage.objects.delete` = ストレージ書き込み権限

バケット内に**新しいオブジェクトを作成**するには、`storage.objects.create`が必要であり、[ドキュメント](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions)によると、既存のオブジェクトを**変更**するには`storage.objects.delete`も必要です。

クラウド内で書き込みができるバケットの非常に**一般的な悪用**は、**ウェブサーバーファイルを保存しているバケット**の場合、**新しいコードを保存**して、ウェブアプリケーションで使用される可能性があります。

### Composer

**Composer**はGCP内で管理されている**Apache Airflow**です。いくつかの興味深い機能があります：

- **GKEクラスター内で実行**されるため、Composer内で実行されるコードからアクセス可能な**SAクラスター**があります。
- コードは**バケットに保存**されるため、そのバケットに書き込みアクセス権があると、DGAコード（Apache Airflowが実行するコード）を変更/追加できます。\
そのため、Composerが使用しているバケットに**書き込みアクセス権**がある場合、GKEクラスターで実行されているSAに**特権昇格**できます。

### Cloud Functions

- Cloud Functionsのコードはストレージに保存されており、**上書きすることで任意のコードを実行**できます。

### App Engine

- App Engineのソースコードはバケットに保存され、**コードを上書きすることで任意のコードを実行**できる可能性があります。**これは不可能です**
- **コンテナレイヤーがバケットに保存されているようですが、それを変更することは可能でしょうか？**

### GCR

- **Google Container Registry**はイメージをバケット内に保存し、そのバケットに**書き込み権限**があれば、そのバケットが実行されている場所に**横断できる**かもしれません。
- GCRが使用するバケットは、`gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com`というURLになります（トップレベルのサブドメインは[こちら](https://cloud.google.com/container-registry/docs/pushing-and-pulling)で指定されています）。

## **参考文献**

- [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
AWSハッキングの学習と実践:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と実践: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

- [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
- **ハッキングトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
{% endhint %}
