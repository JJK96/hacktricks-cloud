# GCP - Storage Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Storage

Grundinformationen:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Diese Berechtigung erlaubt es Ihnen, **Dateien, die in Cloud Storage gespeichert sind, herunterzuladen**. Dies kann Ihnen potenziell erm√∂glichen, Privilegien zu eskalieren, da in einigen F√§llen **sensible Informationen dort gespeichert sind**. Dar√ºber hinaus speichern einige GCP-Dienste ihre Informationen in Buckets:

* **GCP Composer**: Wenn Sie eine Composer-Umgebung erstellen, wird der **Code aller DAGs** in einem **Bucket** gespeichert. Diese Aufgaben k√∂nnten interessante Informationen in ihrem Code enthalten.
* **GCR (Container Registry)**: Das **Bild** der Container wird in **Buckets** gespeichert, was bedeutet, dass Sie, wenn Sie die Buckets lesen k√∂nnen, die Bilder herunterladen und **nach Leaks und/oder Quellcode suchen** k√∂nnen.

### `storage.objects.setIamPolicy`

Sie k√∂nnen sich die Berechtigung geben, **eine der vorherigen Szenarien in diesem Abschnitt auszunutzen**.

### **`storage.buckets.setIamPolicy`**

F√ºr ein Beispiel, wie man Berechtigungen mit dieser Berechtigung √§ndert, √ºberpr√ºfen Sie diese Seite:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Die "Interoperabilit√§ts"-Funktion von Cloud Storage, die f√ºr **Cross-Cloud-Interaktionen** wie mit AWS S3 konzipiert ist, umfasst die **Erstellung von HMAC-Schl√ºsseln f√ºr Dienstkonten und Benutzer**. Ein Angreifer kann dies ausnutzen, indem er **einen HMAC-Schl√ºssel f√ºr ein Dienstkonto mit erh√∂hten Berechtigungen generiert**, wodurch er **die Privilegien innerhalb von Cloud Storage eskaliert**. W√§hrend HMAC-Schl√ºssel, die mit Benutzern verbunden sind, nur √ºber die Webkonsole abgerufen werden k√∂nnen, bleiben sowohl die Zugriffs- als auch die geheimen Schl√ºssel **dauerhaft zug√§nglich**, was potenziellen Backup-Zugriffsspeicher erm√∂glicht. Im Gegensatz dazu sind HMAC-Schl√ºssel, die mit Dienstkonten verkn√ºpft sind, √ºber die API zug√§nglich, aber ihre Zugriffs- und geheimen Schl√ºssel sind nach der Erstellung nicht abrufbar, was eine zus√§tzliche Komplexit√§t f√ºr den kontinuierlichen Zugriff hinzuf√ºgt.

{% code overflow="wrap" %}
```bash
# Create key
gsutil hmac create <sa-email> # You might need to execute this inside a VM instance

## If you have TROUBLES creating the HMAC key this was you can also do it contacting the API directly:
PROJECT_ID = '$PROJECT_ID'
TARGET_SERVICE_ACCOUNT = f"exam-storage-sa-read-flag-3@{PROJECT_ID}.iam.gserviceaccount.com"
ACCESS_TOKEN = "$CLOUDSDK_AUTH_ACCESS_TOKEN"
import requests
import json
key = requests.post(
f'https://www.googleapis.com/storage/v1/projects/{PROJECT_ID}/hmacKeys',
params={'access_token': ACCESS_TOKEN, 'serviceAccountEmail': TARGET_SERVICE_ACCOUNT}
).json()
#print(json.dumps(key, indent=4))
print(f'ID: {key["metadata"]["accessId"]}')
print(f'Secret: {key["secret"]}')


# Configure gsutil to use the HMAC key
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
{% endcode %}

Ein weiteres Exploit-Skript f√ºr diese Methode finden Sie [hier](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Speicher Schreibberechtigungen

Um ein **neues Objekt** in einem Bucket zu **erstellen**, ben√∂tigen Sie `storage.objects.create` und, gem√§√ü [den Dokumenten](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions), ben√∂tigen Sie auch `storage.objects.delete`, um ein bestehendes Objekt zu **√§ndern**.

Eine sehr **h√§ufige Ausnutzung** von Buckets, in die Sie in der Cloud schreiben k√∂nnen, ist der Fall, dass der **Bucket Webserver-Dateien speichert**. Sie k√∂nnten in der Lage sein, **neuen Code zu speichern**, der von der Webanwendung verwendet wird.

### Composer

**Composer** ist **Apache Airflow**, das innerhalb von GCP verwaltet wird. Es hat mehrere interessante Funktionen:

* Es l√§uft innerhalb eines **GKE-Clusters**, sodass die **SA, die der Cluster verwendet, von dem Code, der innerhalb von Composer l√§uft, zug√§nglich ist**.
* Es speichert den **Code in einem Bucket**, daher kann **jeder mit Schreibzugriff auf diesen Bucket** einen DGA-Code (den Code, den Apache Airflow ausf√ºhren wird) √§ndern/hinzuf√ºgen.\
Dann, wenn Sie **Schreibzugriff auf den Bucket haben, den Composer verwendet**, um den Code zu speichern, k√∂nnen Sie **privesc zur SA, die im GKE-Cluster l√§uft,** erhalten.

### Cloud Functions

* Der Code von Cloud Functions wird in Storage gespeichert, sodass **es m√∂glich ist, durch √úberschreiben beliebigen Code auszuf√ºhren**.

### App Engine

* Der Quellcode von App Engine wird in Buckets gespeichert, **durch √úberschreiben des Codes k√∂nnte es m√∂glich sein, beliebigen Code auszuf√ºhren. DAS IST NICHT M√ñGLICH**.
* **Es scheint, dass Container-Schichten im Bucket gespeichert sind, vielleicht diese √§ndern?**

### GCR

* **Google Container Registry** speichert die Images in Buckets. Wenn Sie **diese Buckets beschreiben k√∂nnen**, k√∂nnten Sie in der Lage sein, **seitlich zu dem Ort zu wechseln, an dem diese Buckets ausgef√ºhrt werden.**
* Der von GCR verwendete Bucket hat eine URL, die √§hnlich aussieht wie `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Die obersten Subdomains sind [hier](https://cloud.google.com/container-registry/docs/pushing-and-pulling) angegeben).

## **Referenzen**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks unterst√ºtzen</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
