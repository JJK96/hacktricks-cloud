# GCP - Speicherprivilegien-Eskalation

{% hint style="success" %}
Lernen Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
{% endhint %}

## Speicher

Grundlegende Informationen:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Diese Berechtigung erm√∂glicht es Ihnen, **Dateien herunterzuladen, die im Cloud-Speicher gespeichert sind**. Dies kann Ihnen potenziell erm√∂glichen, Berechtigungen zu eskalieren, da in einigen F√§llen **sensible Informationen dort gespeichert sind**. Dar√ºber hinaus speichern einige GCP-Dienste ihre Informationen in Buckets:

* **GCP Composer**: Wenn Sie eine Composer-Umgebung erstellen, wird der **Code aller DAGs** in einem **Bucket** gespeichert. Diese Aufgaben k√∂nnen interessante Informationen in ihrem Code enthalten.
* **GCR (Container Registry)**: Das **Bild** der Container wird in **Buckets** gespeichert, was bedeutet, dass Sie, wenn Sie die Buckets lesen k√∂nnen, die Bilder herunterladen und **nach Lecks und/oder Quellcode suchen** k√∂nnen.

### `storage.objects.setIamPolicy`

Sie k√∂nnen sich die Berechtigung geben, **eines der vorherigen Szenarien dieses Abschnitts zu missbrauchen**.

### **`storage.buckets.setIamPolicy`**

F√ºr ein Beispiel, wie Berechtigungen mit dieser Berechtigung ge√§ndert werden k√∂nnen, √ºberpr√ºfen Sie diese Seite:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Die Funktion "Interoperabilit√§t" des Cloud-Speichers, die f√ºr **Cross-Cloud-Interaktionen** wie mit AWS S3 konzipiert ist, beinhaltet die **Erstellung von HMAC-Schl√ºsseln f√ºr Servicekonten und Benutzer**. Ein Angreifer kann dies ausnutzen, indem er einen HMAC-Schl√ºssel f√ºr ein Servicekonto mit erh√∂hten Berechtigungen generiert und somit die Berechtigungen im Cloud-Speicher eskaliert. W√§hrend benutzerbezogene HMAC-Schl√ºssel nur √ºber die Weboberfl√§che abrufbar sind, bleiben sowohl der Zugriffs- als auch der geheime Schl√ºssel **dauerhaft zug√§nglich**, was potenziellen Backup-Zugriff erm√∂glicht. Im Gegensatz dazu sind Servicekonto-HMAC-Schl√ºssel √ºber die API abrufbar, aber ihre Zugriffs- und geheimen Schl√ºssel sind nach der Erstellung nicht abrufbar, was eine zus√§tzliche Komplexit√§t f√ºr den kontinuierlichen Zugriff darstellt.
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
Eine weitere Exploit-Skript f√ºr diese Methode kann [hier](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py) gefunden werden.

## `storage.objects.create`, `storage.objects.delete` = Speicher Schreibberechtigungen

Um ein neues Objekt in einem Eimer zu erstellen, ben√∂tigen Sie `storage.objects.create` und laut [der Dokumentation](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions) ben√∂tigen Sie auch `storage.objects.delete`, um ein vorhandenes Objekt zu √§ndern.

Eine sehr h√§ufige Ausnutzung von Eimern, in denen Sie in der Cloud schreiben k√∂nnen, besteht darin, dass der Eimer Webserverdateien speichert. M√∂glicherweise k√∂nnen Sie neuen Code speichern, der von der Webanwendung verwendet wird.

### Composer

**Composer** ist **Apache Airflow**, der in GCP verwaltet wird. Es hat mehrere interessante Funktionen:

* Es l√§uft in einem **GKE-Cluster**, sodass der **SA, den der Cluster verwendet, vom im Composer ausgef√ºhrten Code zug√§nglich ist**.
* Es speichert den **Code in einem Eimer**, daher wird **jeder mit Schreibzugriff auf diesen Eimer** in der Lage sein, einen DGA-Code zu √§ndern/hinzuzuf√ºgen (den Code, den Apache Airflow ausf√ºhren wird).
Dann, wenn Sie **Schreibzugriff auf den Eimer haben, den Composer verwendet**, um den Code zu speichern, k√∂nnen Sie **zu dem SA eskalieren, der im GKE-Cluster l√§uft**.

### Cloud Functions

* Der Code von Cloud Functions wird in Storage gespeichert, daher ist es m√∂glich, durch √úberschreiben davon beliebigen Code auszuf√ºhren.

### App Engine

* Der Quellcode von App Engine wird in Eimern gespeichert, durch √úberschreiben des Codes k√∂nnte es m√∂glich sein, beliebigen Code auszuf√ºhren. DAS IST NICHT M√ñGLICH
* **Es scheint, dass Container-Schichten im Eimer gespeichert sind, vielleicht diese √§ndern?**

### GCR

* **Google Container Registry** speichert die Images in Eimern, wenn Sie **diese Eimer beschreiben k√∂nnen**, k√∂nnten Sie in der Lage sein, **seitlich zu bewegen, wo diese Eimer ausgef√ºhrt werden**.
* Der von GCR verwendete Eimer hat eine URL √§hnlich wie `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Die Top-Level-Subdomains sind [hier](https://cloud.google.com/container-registry/docs/pushing-and-pulling) angegeben).

## **Referenzen**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
{% endhint %}
