# GCP - ストレージ特権昇格

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい** または **HackTricks をPDFでダウンロードしたい場合は** [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェック！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)** に参加するか、[telegramグループ](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローする。
* **ハッキングテクニックを共有するために** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリにPRを提出する。

</details>

## ストレージ

基本情報:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

この権限を持つと、**Cloud Storage内に保存されたファイルをダウンロード**できます。これにより、**機密情報が保存されている場合があるため、特権昇格が可能**になります。さらに、一部のGCPサービスは情報をバケットに保存しています:

* **GCP Composer**: Composer環境を作成すると、**すべてのDAGのコード**が**バケット**に保存されます。これらのタスクにはコード内に興味深い情報が含まれている可能性があります。
* **GCR（Container Registry）**: コンテナの**イメージ**が**バケット**に保存されており、バケットを読み取ればイメージをダウンロードして**漏洩やソースコードを検索**できます。

### `storage.objects.setIamPolicy`

この権限を使用すると、このセクションの以前のシナリオの**いずれかを悪用**できます。

### **`storage.buckets.setIamPolicy`**

この権限を使用して権限を変更する例については、次のページを参照してください:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Cloud Storageの「相互運用性」機能は、AWS S3などの**クロスクラウド相互作用**を目的としており、**サービスアカウントやユーザーのためのHMACキーの作成**を含みます。攻撃者はこれを悪用して、**特権の昇格を行うためのサービスアカウント用のHMACキーを生成**し、それにより**Cloud Storage内で特権を昇格**させることができます。ユーザー関連のHMACキーはWebコンソールを介してのみ取得可能ですが、アクセスキーとシークレットキーは**永続的にアクセス可能**であり、潜在的なバックアップアクセスストレージが可能です。一方、サービスアカウントにリンクされたHMACキーはAPI経由で取得可能ですが、アクセスキーとシークレットキーは作成後に取得できず、継続的なアクセスのための複雑さが追加されます。
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
別のこの方法のエクスプロイトスクリプトは[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py)で見つけることができます。

## `storage.objects.create`、`storage.objects.delete` = ストレージ書き込み権限

バケット内に**新しいオブジェクトを作成**するには、`storage.objects.create`が必要であり、[ドキュメント](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions)によると、既存のオブジェクトを**変更**するには`storage.objects.delete`も必要です。

クラウド内で書き込みができるバケットを**悪用**する非常に**一般的な方法**は、**ウェブサーバーファイルを保存しているバケット**の場合、**新しいコードを保存**して、それがウェブアプリケーションで使用される可能性があります。

### Composer

**Composer**はGCP内で管理されている**Apache Airflow**です。いくつかの興味深い機能があります：

* **GKEクラスター**内で実行されるため、Composer内で実行されるコードからアクセスできる**SAクラスター**があります。
* コードをバケットに保存するため、そのバケットに書き込みアクセス権がある**誰でも**がDGAコードを変更/追加できます（Apache Airflowが実行するコード）。
そのため、Composerが使用しているバケットに**書き込みアクセス権**がある場合、GKEクラスターで実行されているSAに**権限昇格**できます。

### Cloud Functions

* Cloud Functionsのコードはストレージに保存されているため、**それを上書きすると任意のコードを実行**できます。

### App Engine

* App Engineのソースコードはバケットに保存されており、**コードを上書きすると任意のコードを実行**できる可能性があります。**これは不可能です**
* **コンテナレイヤーがバケットに保存されているようですが、それを変更することは可能ですか？**

### GCR

* **Google Container Registry**はイメージをバケット内に保存し、そのバケットに**書き込み権限**があれば、そのバケットが実行されている場所に**横断的に移動**できるかもしれません。
* GCRが使用するバケットは、`gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com`というURLを持つ可能性があります（トップレベルのサブドメインは[こちら](https://cloud.google.com/container-registry/docs/pushing-and-pulling)で指定されています）。

## **参考文献**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>で**ゼロからヒーローまでのAWSハッキングを学ぶ**</summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[NFTs](https://opensea.io/collection/the-peass-family)のコレクションである**The PEASS Family**を入手する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**する。
* **ハッキングトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する。

</details>
