# GCP - Escala√ß√£o de Privil√©gios de Armazenamento

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Armazenamento

Informa√ß√µes B√°sicas:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Essa permiss√£o permite que voc√™ **baixe arquivos armazenados no Cloud Storage**. Isso potencialmente permitir√° que voc√™ escalone privil√©gios porque em algumas ocasi√µes **informa√ß√µes sens√≠veis s√£o salvas l√°**. Al√©m disso, alguns servi√ßos do GCP armazenam suas informa√ß√µes em buckets:

* **GCP Composer**: Quando voc√™ cria um Ambiente Composer, o **c√≥digo de todos os DAGs** ser√° salvo dentro de um **bucket**. Essas tarefas podem conter informa√ß√µes interessantes dentro de seu c√≥digo.
* **GCR (Container Registry)**: A **imagem** dos cont√™ineres √© armazenada dentro de **buckets**, o que significa que se voc√™ puder ler os buckets, poder√° baixar as imagens e **procurar por vazamentos e/ou c√≥digo-fonte**.

### `storage.objects.setIamPolicy`

Voc√™ pode conceder permiss√£o para **abusar de qualquer um dos cen√°rios anteriores desta se√ß√£o**.

### **`storage.buckets.setIamPolicy`**

Para um exemplo de como modificar permiss√µes com essa permiss√£o, verifique esta p√°gina:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

O recurso de "interoperabilidade" do Cloud Storage, projetado para **intera√ß√µes entre nuvens** como com o AWS S3, envolve a **cria√ß√£o de chaves HMAC para Contas de Servi√ßo e usu√°rios**. Um atacante pode explorar isso ao **gerar uma chave HMAC para uma Conta de Servi√ßo com privil√©gios elevados**, assim **escalando privil√©gios dentro do Cloud Storage**. Enquanto as chaves HMAC associadas ao usu√°rio s√≥ podem ser recuperadas via console da web, tanto as chaves de acesso quanto as chaves secretas permanecem **perpetuamente acess√≠veis**, permitindo potencial acesso de backup. Por outro lado, as chaves HMAC vinculadas √† Conta de Servi√ßo s√£o acess√≠veis via API, mas suas chaves de acesso e secretas n√£o s√£o recuper√°veis ap√≥s a cria√ß√£o, adicionando uma camada de complexidade para acesso cont√≠nuo.
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
Outro script de exploit para este m√©todo pode ser encontrado [aqui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Permiss√µes de Escrita no Armazenamento

Para **criar um novo objeto** dentro de um bucket, voc√™ precisa de `storage.objects.create` e, de acordo com [a documenta√ß√£o](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions), voc√™ tamb√©m precisa de `storage.objects.delete` para **modificar** um objeto existente.

Uma **explora√ß√£o muito comum** de buckets onde voc√™ pode escrever na nuvem √© no caso em que o **bucket est√° salvando arquivos de servidor web**, voc√™ pode ser capaz de **armazenar novo c√≥digo** que ser√° usado pela aplica√ß√£o web.

### Composer

**Composer** √© o **Apache Airflow** gerenciado dentro do GCP. Possui v√°rias caracter√≠sticas interessantes:

* Ele √© executado dentro de um **cluster GKE**, ent√£o o **SA que o cluster usa √© acess√≠vel** pelo c√≥digo em execu√ß√£o dentro do Composer.
* Ele armazena o **c√≥digo em um bucket**, portanto, **qualquer pessoa com acesso de escrita sobre esse bucket** ser√° capaz de alterar/adicionar um c√≥digo DGA (o c√≥digo que o Apache Airflow executar√°). Ent√£o, se voc√™ tiver **acesso de escrita sobre o bucket que o Composer est√° usando** para armazenar o c√≥digo, voc√™ pode **elevar privil√©gios para o SA em execu√ß√£o no cluster GKE**.

### Fun√ß√µes na Nuvem

* O c√≥digo das Fun√ß√µes na Nuvem √© armazenado no Armazenamento, ent√£o **sobrescrevendo-o, √© poss√≠vel executar c√≥digo arbitr√°rio**.

### App Engine

* O c√≥digo-fonte do App Engine √© armazenado em buckets, **sobrescrevendo o c√≥digo, poderia ser poss√≠vel executar c√≥digo arbitr√°rio. ISSO N√ÉO √â POSS√çVEL**
* **Parece que as camadas de cont√™iner s√£o armazenadas no bucket, talvez alterando essas?**

### GCR

* O **Google Container Registry** armazena as imagens dentro de buckets, se voc√™ pode **escrever nesses buckets**, voc√™ pode ser capaz de **mover lateralmente para onde esses buckets est√£o sendo executados**.
* O bucket usado pelo GCR ter√° uma URL semelhante a `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Os subdom√≠nios de n√≠vel superior s√£o especificados [aqui](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

## **Refer√™ncias**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
