# GCP - Εscalation προνομίων αποθήκευσης

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ κάνοντας υποβολή PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Αποθήκευση

Βασικές πληροφορίες:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Αυτή η άδεια σάς επιτρέπει να **κατεβάσετε αρχεία που αποθηκεύονται μέσα στην Αποθήκευση Cloud**. Αυτό ενδέχεται να σας επιτρέψει να εξελίξετε τα προνόμια επειδή σε ορισμένες περιπτώσεις **αποθηκεύονται εκεί ευαίσθητες πληροφορίες**. Επιπλέον, ορισμένες υπηρεσίες GCP αποθηκεύουν τις πληροφορίες τους σε κάδους:

* **GCP Composer**: Όταν δημιουργείτε ένα Περιβάλλον Composer το **κώδικας όλων των DAGs** θα αποθηκευτεί μέσα σε ένα **κάδο**. Αυτές οι εργασίες μπορεί να περιέχουν ενδιαφέρουσες πληροφορίες μέσα στον κώδικά τους.
* **GCR (Container Registry)**: Η **εικόνα** των εμπορευμάτων αποθηκεύεται μέσα σε **κάδους**, που σημαίνει ότι αν μπορείτε να διαβάσετε τους κάδους θα μπορείτε να κατεβάσετε τις εικόνες και να **αναζητήσετε διαρροές και/ή κώδικα πηγής**.

### `storage.objects.setIamPolicy`

Μπορείτε να δώσετε άδεια να **καταχωρήσετε οποιοδήποτε από τα προηγούμενα σενάρια αυτής της ενότητας**.

### **`storage.buckets.setIamPolicy`**

Για ένα παράδειγμα πώς να τροποποιήσετε τις άδειες με αυτή την άδεια, ελέγξτε αυτή τη σελίδα:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Η λειτουργία "διαλειτουργικότητα" της Αποθήκευσης Cloud, σχεδιασμένη για **διασυνοριακές αλληλεπιδράσεις σαν με το AWS S3**, περιλαμβάνει τη **δημιουργία κλειδιών HMAC για Λογαριασμούς Υπηρεσιών και χρήστες**. Ένας επιτιθέμενος μπορεί να εκμεταλλευτεί αυτό δημιουργώντας ένα κλειδί HMAC για έναν Λογαριασμό Υπηρεσίας με αυξημένα προνόμια, επομένως **εξελίσσοντας τα προνόμια εντός της Αποθήκευσης Cloud**. Ενώ τα κλειδιά HMAC που σχετίζονται με τους χρήστες είναι μόνο ανάκτητα μέσω του web console, τόσο τα κλειδιά πρόσβασης όσο και τα μυστικά κλειδιά παραμένουν **προσβάσιμα μόνιμα**, επιτρέποντας πιθανή εφεδρική πρόσβαση αποθήκευσης. Αντιστρόφως, τα κλειδιά HMAC που συνδέονται με τους Λογαριασμούς Υπηρεσίας είναι προσβάσιμα μέσω API, αλλά τα κλειδιά πρόσβασης και μυστικά κλειδιά δεν είναι ανάκτητα μετά τη δημιουργία τους, προσθέτοντας ένα επίπεδο πολυπλοκότητας για συνεχή πρόσβαση.
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
Μια άλλη συνταγή εκμετάλλευσης για αυτήν τη μέθοδο μπορεί να βρεθεί [εδώ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Δικαιώματα εγγραφής αποθήκευσης

Για να **δημιουργήσετε ένα νέο αντικείμενο** μέσα σε ένα κάδο χρειάζεστε το `storage.objects.create` και, σύμφωνα με [τα έγγραφα](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions), χρειάζεστε επίσης το `storage.objects.delete` για να **τροποποιήσετε** ένα υπάρχον αντικείμενο.

Μια πολύ **συνηθισμένη εκμετάλλευση** των κάδων όπου μπορείτε να γράψετε στο cloud είναι στην περίπτωση που ο **κάδος αποθηκεύει αρχεία διακομιστή web**, μπορείτε να **αποθηκεύσετε νέο κώδικα** που θα χρησιμοποιηθεί από την web εφαρμογή.

### Composer

**Ο Composer** είναι **το Apache Airflow** που διαχειρίζεται μέσα στο GCP. Διαθέτει αρκετά ενδιαφέροντα χαρακτηριστικά:

* Τρέχει μέσα σε ένα **GKE cluster**, έτσι η **SA που χρησιμοποιεί το cluster είναι προσβάσιμη** από τον κώδικα που τρέχει μέσα στον Composer
* Αποθηκεύει τον **κώδικα σε έναν κάδο**, επομένως, **οποιοσδήποτε με δικαίωμα εγγραφής σε αυτόν τον κάδο** θα μπορεί να αλλάξει/προσθέσει έναν κώδικα DGA (τον κώδικα που θα εκτελέσει το Apache Airflow)\
Στη συνέχεια, αν έχετε **δικαίωμα εγγραφής στον κάδο που χρησιμοποιεί ο Composer** για να αποθηκεύσει τον κώδικα, μπορείτε να **αναβαθμιστείτε στην SA που τρέχει στο GKE cluster**.

### Cloud Functions

* Ο κώδικας των Cloud Functions αποθηκεύεται στην Αποθήκευση, έτσι **με τον παρακάτω κώδικα, είναι δυνατή η εκτέλεση αυθαίρετου κώδικα**.

### App Engine

* Ο κώδικας πηγής του App Engine αποθηκεύεται σε κάδους, **με τον παρακάτω κώδικα, είναι δυνατή η εκτέλεση αυθαίρετου κώδικα. ΑΥΤΟ ΔΕΝ ΕΙΝΑΙ ΔΥΝΑΤΟ**
* **Φαίνεται ότι τα επίπεδα των ελαίων αποθηκεύονται στον κάδο, ίσως να αλλάξουν αυτά;**

### GCR

* Το **Google Container Registry** αποθηκεύει τις εικόνες μέσα σε κάδους, αν μπορείτε **να γράψετε σε αυτούς τους κάδους** μπορείτε να **μετακινηθείτε πλαγίως εκεί όπου τρέχουν αυτοί οι κάδοι.**
* Ο κάδος που χρησιμοποιείται από το GCR θα έχει ένα URL παρόμοιο με `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Τα υποεπίπεδα κορυφαίου επιπέδου καθορίζονται [εδώ](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

## **Αναφορές**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα τηλεγράφου**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
{% endhint %}
