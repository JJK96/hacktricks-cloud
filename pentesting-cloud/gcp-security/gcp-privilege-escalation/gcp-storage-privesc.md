# GCP - Storage Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Storage

Basic Information:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Ruhusa hii inakuruhusu **kupakua faili zilizohifadhiwa ndani ya Cloud Storage**. Hii inaweza kukuruhusu kupandisha mamlaka kwa sababu katika baadhi ya matukio **taarifa nyeti huhifadhiwa hapo**. Zaidi ya hayo, baadhi ya huduma za GCP huhifadhi taarifa zao katika ndoo:

* **GCP Composer**: Unapounda Mazingira ya Composer, **kanuni za DAG zote** zitahifadhiwa ndani ya **ndoo**. Kazi hizi zinaweza kuwa na taarifa za kuvutia ndani ya kanuni zao.
* **GCR (Container Registry)**: **Picha** za kontena huhifadhiwa ndani ya **ndoo**, ambayo inamaanisha kwamba ikiwa unaweza kusoma ndoo, utaweza kupakua picha na **kutafuta leaks na/au kanuni ya chanzo**.

### `storage.objects.setIamPolicy`

Unaweza kujipa ruhusa ya **kudhulumu yoyote ya matukio ya awali ya sehemu hii**.

### **`storage.buckets.setIamPolicy`**

Kwa mfano wa jinsi ya kubadilisha ruhusa kwa kutumia ruhusa hii, angalia ukurasa huu:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Kipengele cha "interoperability" cha Cloud Storage, kilichoundwa kwa ajili ya **mawasiliano ya msalaba wa wingu** kama na AWS S3, kinahusisha **kuunda funguo za HMAC kwa Akaunti za Huduma na watumiaji**. Mshambuliaji anaweza kutumia hili kwa **kuunda funguo za HMAC kwa Akaunti ya Huduma yenye mamlaka ya juu**, hivyo **kupandisha mamlaka ndani ya Cloud Storage**. Ingawa funguo za HMAC zinazohusishwa na watumiaji zinaweza kupatikana tu kupitia console ya wavuti, funguo za ufikiaji na siri zinabaki **kupatikana milele**, zikiwa na uwezo wa kuhifadhi upatikanaji wa akiba. Kwa upande mwingine, funguo za HMAC zinazohusishwa na Akaunti za Huduma zinapatikana kupitia API, lakini funguo zao za ufikiaji na siri hazipatikani baada ya kuundwa, zikiongeza kiwango cha ugumu kwa upatikanaji wa kudumu.

{% code overflow="wrap" %}
```bash
# Create key
gsutil hmac create <sa-email> # You might need to execute this inside a VM instance

## If you have TROUBLES creating the HMAC key this was you can also do it contacting the API directly:
PROJECT_ID = '$PROJECT_ID'
TARGET_SERVICE_ACCOUNT = f"exam-storage-sa-read-flag-3@{PROJECT_ID}.iam.gserviceaccount.com"
ACCESS_TOKEN = "$CLOUDSDK_AUTH_ACCESS_TOKEN"
import requests
import json
key = requests.post(
f'https://www.googleapis.com/storage/v1/projects/{PROJECT_ID}/hmacKeys',
params={'access_token': ACCESS_TOKEN, 'serviceAccountEmail': TARGET_SERVICE_ACCOUNT}
).json()
#print(json.dumps(key, indent=4))
print(f'ID: {key["metadata"]["accessId"]}')
print(f'Secret: {key["secret"]}')


# Configure gsutil to use the HMAC key
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
{% endcode %}

Scripti nyingine ya kutekeleza kwa njia hii inaweza kupatikana [hapa](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Ruhusa za Kuandika Hifadhi

Ili **kuunda kitu kipya** ndani ya bakuli unahitaji `storage.objects.create` na, kulingana na [nyaraka](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions), unahitaji pia `storage.objects.delete` ili **kubadilisha** kitu kilichopo.

Utekelezaji wa **kawaida sana** wa bakuli ambapo unaweza kuandika kwenye wingu ni katika kesi **bakuli linaokoa faili za seva za wavuti**, unaweza kuwa na uwezo wa **kuhifadhi msimbo mpya** ambao utatumika na programu ya wavuti.

### Composer

**Composer** ni **Apache Airflow** inayosimamiwa ndani ya GCP. Ina vipengele kadhaa vya kuvutia:

* Inafanya kazi ndani ya **GKE cluster**, hivyo **SA ambayo cluster inatumia inapatikana** na msimbo unaotembea ndani ya Composer
* Inaweka **msimbo katika bakuli**, kwa hivyo, **mtu yeyote mwenye ruhusa ya kuandika juu ya bakuli hiyo** atakuwa na uwezo wa kubadilisha/kutia msimbo wa DGA (msimbo ambao Apache Airflow itatekeleza)\
Kisha, ikiwa una **ruhusa ya kuandika juu ya bakuli ambayo Composer inatumia** kuhifadhi msimbo, unaweza **privesc kwa SA inayotembea katika GKE cluster**.

### Cloud Functions

* Msimbo wa Cloud Functions unahifadhiwa katika Hifadhi na kila wakati toleo jipya linapotengenezwa msimbo unasukumwa kwenye bakuli na kisha kontena jipya linajengwa kutoka kwa msimbo huu. Kwa hivyo, **kufuta msimbo kabla ya toleo jipya kujengwa kunawezekana kufanya kazi ya wingu kutekeleza msimbo wa kiholela**.

Unaweza kupata PoC ya shambulio hili katika repo: [https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions](https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions)

### App Engine

* Msimbo wa chanzo wa App Engine unahifadhiwa katika bakuli, **kufuta msimbo inaweza kuwa inawezekana kutekeleza msimbo wa kiholela. HII HAIWEZEKANI**
* **Inaonekana kama tabaka za kontena zinahifadhiwa katika bakuli, labda kubadilisha hizo?**

### GCR

* **Google Container Registry** inahifadhi picha ndani ya bakuli, ikiwa unaweza **kuandika hizo bakuli** unaweza kuwa na uwezo wa **kuhamasisha kwa upande ambapo hizo bakuli zinakimbia.**
* Bakuli inayotumiwa na GCR itakuwa na URL inayofanana na `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Subdomains za kiwango cha juu zimeelezwa [hapa](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

## **Marejeo**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
Jifunze & fanya mazoezi ya AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Jifunze & fanya mazoezi ya GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **fuata** sisi kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki hila za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
