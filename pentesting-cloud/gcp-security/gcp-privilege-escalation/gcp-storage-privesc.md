# GCP - Depolama Privilege Escalation

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## Depolama

Temel Bilgiler:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Bu izin size **Cloud Storage içinde depolanan dosyaları indirme** olanağı sağlar. Bu potansiyel olarak **yetkilerinizi yükseltmenize izin verebilir** çünkü bazı durumlarda **duyarlı bilgiler orada saklanır**. Ayrıca, bazı GCP hizmetleri bilgilerini kovalara kaydeder:

* **GCP Composer**: Bir Composer Ortamı oluşturduğunuzda, **tüm DAG'ların kodu** bir **kova** içinde saklanır. Bu görevler, kodlarının içinde ilginç bilgiler içerebilir.
* **GCR (Container Registry)**: **Konteynerlerin görüntüleri** kovalarda saklanır, bu da kovaları okuyabiliyorsanız görüntüleri indirebileceğiniz ve **sızıntıları ve/veya kaynak kodunu arayabileceğiniz** anlamına gelir.

### `storage.objects.setIamPolicy`

Bu izin size bu bölümün önceki senaryolarından herhangi birini **kötüye kullanma izni** verebilir.

### **`storage.buckets.setIamPolicy`**

Bu izinle izinleri nasıl değiştireceğinize dair bir örnek için bu sayfayı kontrol edin:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Cloud Storage'ın "uyumluluk" özelliği, AWS S3 gibi **çapraz bulut etkileşimleri** için tasarlanmış olup, **Hizmet Hesapları ve kullanıcılar için HMAC anahtarlarının oluşturulmasını** içerir. Bir saldırgan, bu özelliği **kötüye kullanarak yükseltilmiş ayrıcalıklara sahip bir Hizmet Hesabı için bir HMAC anahtarı oluşturabilir** ve böylece **Cloud Storage içinde ayrıcalıkları yükseltebilir**. Kullanıcıya bağlı HMAC anahtarları yalnızca web konsolu aracılığıyla alınabilirken, erişim ve gizli anahtarlar **sürekli erişilebilir** kalır, potansiyel yedek erişim depolama olanağı sağlar. Bununla birlikte, Hizmet Hesabıyla ilişkilendirilmiş HMAC anahtarları API erişimine açıktır, ancak erişim ve gizli anahtarlar oluşturulduktan sonra alınamaz, sürekli erişim için karmaşık bir katman ekler.
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
Başka bir exploit betiği bu yöntem için [burada](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py) bulunabilir.

## `storage.objects.create`, `storage.objects.delete` = Depolama Yazma izinleri

Bir kova içine **yeni bir nesne oluşturmak** için `storage.objects.create`'a ihtiyacınız var ve [belgelere](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions) göre, mevcut bir nesneyi **değiştirmek** için ayrıca `storage.objects.delete`'a ihtiyacınız var.

Bulutta yazma iznine sahip olduğunuz kovaların çok **sık istismarı**, kovanın **web sunucusu dosyalarını kaydettiği** durumlarda olabilir, bu durumda **web uygulaması tarafından kullanılacak yeni kodları** saklayabilirsiniz.

### Composer

**Composer**, GCP içinde yönetilen **Apache Airflow**'dur. Birkaç ilginç özelliği vardır:

* **GKE kümesi içinde çalışır**, bu nedenle Composer içinde çalışan kod tarafından erişilebilen **SA kümesi kullanılır**
* Kodu bir kovada saklar, bu nedenle, o kovaya **yazma erişimi olan herkes**, bir DGA kodu ekleyebilir/değiştirebilir (Apache Airflow'un yürüteceği kod)\
Dolayısıyla, Composer'ın kodu saklamak için kullandığı kovaya **yazma erişiminiz varsa**, GKE kümesinde çalışan SA'ya **yükselme yapabilirsiniz**.

### Cloud Functions

* Cloud Functions kodu Depolama'da saklanır, bu nedenle **üzerine yazarak keyfi kodu yürütmek mümkündür**.

### App Engine

* App Engine kaynak kodu kovalarda saklanır, **kodu üzerine yazarak keyfi kodu yürütmek mümkün olabilir. BU MÜMKÜN DEĞİLDİR**
* **Muhtemelen konteyner katmanları kovada saklanır, belki onları değiştirerek?**

### GCR

* **Google Container Registry**, görüntüleri kovalarda saklar, eğer **bu kovalara yazabilirseniz**, bu kovaların çalıştırıldığı yere **yan yana geçiş yapabilirsiniz**.
* GCR tarafından kullanılan kova, `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` benzeri bir URL'ye sahip olacaktır (Üst düzey alt alanlar [burada](https://cloud.google.com/container-registry/docs/pushing-and-pulling) belirtilmiştir).

## **Referanslar**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
AWS Hacking öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak HackTricks ve HackTricks Cloud github depolarına PR göndererek katkıda bulunun.**

</details>
{% endhint %}
