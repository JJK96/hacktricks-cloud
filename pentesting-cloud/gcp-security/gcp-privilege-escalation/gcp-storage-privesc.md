# GCP - Kuboresha Mamlaka ya Uhifadhi

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **nifuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Uhifadhi

Taarifa Msingi:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Ruhusa hii inakuruhusu **kupakua faili zilizohifadhiwa ndani ya Uhifadhi wa Wingu**. Hii inaweza kukuruhusu kuboresha mamlaka kwa sababu mara nyingine **taarifa nyeti hufutwa huko**. Zaidi ya hayo, baadhi ya huduma za GCP hufuta taarifa zao kwenye vikapu:

* **GCP Composer**: Unapounda Mazingira ya Composer **mimba ya kila DAG** itahifadhiwa ndani ya **kapu**. Kazi hizi zinaweza kuwa na taarifa muhimu ndani ya nambari zao.
* **GCR (Usajili wa Kontena)**: **Picha** za kontena zimehifadhiwa ndani ya **vikapu**, hii inamaanisha kwamba ikiwa unaweza kusoma vikapu utaweza kupakua picha na **kutafuta uvujaji na/au nambari ya chanzo**.

### `storage.objects.setIamPolicy`

Unaweza kukupa ruhusa ya **kutumia vibaya mojawapo ya hali za awali za sehemu hii**.

### **`storage.buckets.setIamPolicy`**

Kwa mfano wa jinsi ya kubadilisha ruhusa na ruhusa hii angalia ukurasa huu:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Kipengele cha "kubadilishana" cha Uhifadhi wa Wingu, kilichoundwa kwa **mwingiliano wa msalaba wa wingu** kama na AWS S3, inahusisha **uundaji wa funguo za HMAC kwa Akaunti za Huduma na watumiaji**. Mshambuliaji anaweza kutumia hii kwa **kuzalisha funguo la HMAC kwa Akaunti ya Huduma yenye mamlaka iliyopandishwa**, hivyo **kuboresha mamlaka ndani ya Uhifadhi wa Wingu**. Ingawa funguo za HMAC zinazohusiana na mtumiaji zinapatikana tu kupitia kiolesura cha wavuti, funguo za ufikiaji na siri zinabaki **zinafikika milele**, kuruhusu ufikiaji wa akiba wa kuhifadhi. Kinyume chake, funguo za HMAC zinazohusiana na Akaunti ya Huduma zinapatikana kupitia API, lakini ufikiaji na funguo za siri hazipatikani baada ya uundaji, ikiongeza safu ya utata kwa ufikiaji endelevu.
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
Another exploit script for this method can be found [here](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Ruhusu za Kuandika Kwenye Uhifadhi

Ili **kuunda kitu kipya** ndani ya ndoo unahitaji `storage.objects.create` na, kulingana na [nyaraka](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions), unahitaji pia `storage.objects.delete` ili **kubadilisha** kitu kilichopo.

Utekaji wa kawaida sana wa ndoo ambapo unaweza kuandika kwenye wingu ni kama ndoo inaokoa faili za seva za wavuti, unaweza kuweza **kuhifadhi nambari mpya** ambayo itatumika na programu ya wavuti.

### Mtunzi

**Mtunzi** ni **Apache Airflow** inayosimamiwa ndani ya GCP. Ina vipengele vingi vya kuvutia:

* Inaendeshwa ndani ya **kituo cha GKE**, hivyo **SA inayotumiwa na kituo inaweza kufikiwa** na nambari inayotumika ndani ya Mtunzi
* Inahifadhi **nambari kwenye ndoo**, kwa hivyo, **yeyote mwenye ufikiaji wa kuandika kwenye ndoo hiyo** ataweza kubadilisha/kuongeza nambari ya DGA (nambari Apache Airflow itakayoendesha)\
Kwa hivyo, ikiwa una **ufikiaji wa kuandika kwenye ndoo inayotumiwa na Mtunzi** kuhifadhi nambari, unaweza **kuongeza ruhusu kwa SA inayotumika kwenye kituo cha GKE**.

### Kazi za Wingu

* Nambari za Kazi za Wingu zinahifadhiwa kwenye Uhifadhi, hivyo **kwa kuibadilisha, inawezekana kutekeleza nambari ya aina yoyote**.

### Injini ya Programu

* Nambari ya chanzo ya Injini ya Programu inahifadhiwa kwenye ndoo, **kwa kuibadilisha inawezekana kutekeleza nambari ya aina yoyote. HII SIWEZEKANI**
* **Inaonekana kama tabaka za kontena zinahifadhiwa kwenye ndoo, labda kubadilisha hizo?**

### GCR

* **Usajili wa Kontena wa Google** unahifadhi picha ndani ya ndoo, ikiwa unaweza **kuandika kwenye ndoo hizo** unaweza kuweza **kutembea kwa upande kwenda kule ndoo hizo zinaendeshwa.**
* Ndoa inayotumiwa na GCR itakuwa na URL kama `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Vidokezo vya kiwango cha juu vimeelezwa [hapa](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

## **Virejeleo**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **fuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
