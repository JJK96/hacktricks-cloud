# GCP - Kuboresha Mamlaka ya Uhifadhi

{% hint style="success" %}
Jifunze & zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}

## Uhifadhi

Maelezo Msingi:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Ruhusa hii inakuruhusu **kupakua faili zilizohifadhiwa ndani ya Uhifadhi wa Wingu**. Hii inaweza kukuruhusu kuboresha mamlaka kwa sababu mara nyingine **taarifa nyeti hufanywa huko**. Zaidi ya hayo, baadhi ya huduma za GCP huzihifadhi taarifa zao kwenye vikapu:

* **GCP Composer**: Unapounda Mazingira ya Composer **mimba ya kila DAG** itahifadhiwa ndani ya **kapu**. Kazi hizi zinaweza kuwa na taarifa muhimu ndani ya nambari zao.
* **GCR (Usajili wa Kontena)**: **Picha** za kontena zimehifadhiwa ndani ya **vikapu**, hii inamaanisha kwamba ukisoma vikapu utaweza kupakua picha na **kutafuta uvujaji na/au nambari ya chanzo**.

### `storage.objects.setIamPolicy`

Unaweza kujipa ruhusa ya **kutumia vibaya mojawapo ya hali za awali za sehemu hii**.

### **`storage.buckets.setIamPolicy`**

Kwa mfano wa jinsi ya kubadilisha ruhusa na ruhusa hii angalia ukurasa huu:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Kipengele cha "urahisi wa matumizi" cha Uhifadhi wa Wingu, kilichoundwa kwa **mwingiliano wa msalaba wa wingu** kama na AWS S3, inahusisha **ujenzi wa funguo za HMAC kwa Akaunti za Huduma na watumiaji**. Mshambuliaji anaweza kutumia hii kwa **kuzalisha funguo za HMAC kwa Akaunti ya Huduma yenye mamlaka ya juu**, hivyo **kuboresha mamlaka ndani ya Uhifadhi wa Wingu**. Ingawa funguo za HMAC zinazohusiana na mtumiaji zinapatikana tu kupitia kiolesura cha wavuti, funguo za ufikiaji na siri zinabaki **zinafikika milele**, kuruhusu ufikiaji wa akiba wa siku zijazo. Kinyume chake, funguo za HMAC zinazohusiana na Akaunti ya Huduma zinapatikana kupitia API, lakini ufikiaji na funguo za siri hazipatikani baada ya uundaji, ikiongeza safu ya utata kwa ufikiaji endelevu.
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
Another exploit script for this method can be found [here](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Ruhusu za Kuandika Kwenye Uhifadhi

Ili **kuunda kitu kipya** ndani ya ndoo unahitaji `storage.objects.create` na, kulingana na [nyaraka](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions), unahitaji pia `storage.objects.delete` ili **kurekebisha** kitu kilichopo.

Utekaji wa kawaida sana wa ndoo ambapo unaweza kuandika kwenye wingu ni kesi ambapo **ndoo inahifadhi faili za seva ya wavuti**, unaweza kuweza **kuhifadhi msimbo mpya** utakaotumiwa na programu ya wavuti.

### Mtunzi

**Mtunzi** ni **Apache Airflow** inayosimamiwa ndani ya GCP. Ina vipengele vingi vya kuvutia:

* Inakimbia ndani ya **kituo cha GKE**, hivyo **SA inayotumiwa na kituo inaweza kufikiwa** na msimbo unaoruka ndani ya Mtunzi
* Inahifadhi **msimbo kwenye ndoo**, kwa hivyo, **yeyote mwenye ufikiaji wa kuandika kwenye ndoo hiyo** ataweza kubadilisha/kuongeza msimbo wa DGA (msimbo Apache Airflow utakaoendesha)\
Kwa hivyo, ikiwa una **ufikiaji wa kuandika kwenye ndoo inayotumiwa na Mtunzi** kuhifadhi msimbo, unaweza **kuinua ruhusu kwenda kwa SA inayotumika kwenye kituo cha GKE**.

### Kazi za Wingu

* Msimbo wa Kazi za Wingu unahifadhiwa kwenye Uhifadhi, hivyo **kwa kuubadilisha, inawezekana kutekeleza msimbo wa aina yoyote**.

### Injini ya Programu

* Msimbo wa chanzo wa Injini ya Programu unahifadhiwa kwenye ndoo, **kwa kuubadilisha inawezekana kutekeleza msimbo wa aina yoyote. HII SIWEZEKANI**
* **Inaonekana kama safu za kontena zinahifadhiwa kwenye ndoo, labda kubadilisha hizo?**

### GCR

* **Usajili wa Kontena wa Google** unahifadhi picha ndani ya ndoo, ikiwa unaweza **kuandika kwenye ndoo hizo** unaweza kuweza **kutembea kwa upande kwenda kule ndoo hizo zinaendeshwa.**
* Ndoa inayotumiwa na GCR itakuwa na URL kama `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Vidokezo vya kiwango cha juu vimeelezwa [hapa](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

## **Virejeleo**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{% hint style="success" %}
Jifunze & zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>unga mkono HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
