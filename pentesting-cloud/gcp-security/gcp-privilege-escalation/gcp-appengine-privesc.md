# GCP - AppEngine Privesc

{% hint style="success" %}
Nauƒçite i ve≈æbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nauƒçite i ve≈æbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## App Engine

Za vi≈°e informacija o App Engine pogledajte:

{% content-ref url="../gcp-services/gcp-app-engine-enum.md" %}
[gcp-app-engine-enum.md](../gcp-services/gcp-app-engine-enum.md)
{% endcontent-ref %}

### `appengine.applications.get`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.operations.list`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.create`, `appengine.versions.get`, `appengine.versions.list`, `cloudbuild.builds.get`,`iam.serviceAccounts.actAs`, `resourcemanager.projects.get`, `storage.objects.create`, `storage.objects.list`

To su potrebne dozvole za **deploy aplikacije koristeƒái `gcloud` cli**. Mo≈æda bi **`get`** i **`list`** mogle biti **izbegnute**.

Mo≈æete pronaƒái primere python koda na [https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine](https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine)

Podrazumevano, ime App servisa ƒáe biti **`default`**, i mo≈æe postojati samo 1 instanca sa istim imenom.\
Da biste to promenili i kreirali drugu aplikaciju, u **`app.yaml`**, promenite vrednost root kljuƒça u ne≈°to poput **`service: my-second-app`**
```bash
cd python-docs-samples/appengine/flexible/hello_world
gcloud app deploy #Upload and start application inside the folder
```
Dajte mu najmanje 10-15 minuta, ako ne uspe, pozovite **deploy another of times** i saƒçekajte nekoliko minuta.

{% hint style="info" %}
**Moguƒáe je naznaƒçiti Service Account koji ƒáe se koristiti**, ali po defaultu se koristi App Engine default SA.
{% endhint %}

URL aplikacije je ne≈°to poput `https://<proj-name>.oa.r.appspot.com/` ili `https://<service_name>-dot-<proj-name>.oa.r.appspot.com`

### A≈æurirajte ekvivalentne dozvole

Mo≈æda imate dovoljno dozvola da a≈æurirate AppEngine, ali ne i da kreirate novi. U tom sluƒçaju, ovako mo≈æete a≈æurirati trenutni App Engine:
```bash
# Find the code of the App Engine in the buckets
gsutil ls

# Download code
mkdir /tmp/appengine2
cd /tmp/appengine2
## In this case it was found in this custom bucket but you could also use the
## buckets generated when the App Engine is created
gsutil cp gs://appengine-lab-1-gcp-labs-4t04m0i6-3a97003354979ef6/labs_appengine_1_premissions_privesc.zip .
unzip labs_appengine_1_premissions_privesc.zip

## Now modify the code..

## If you don't have an app.yaml, create one like:
cat >> app.yaml <<EOF
runtime: python312

entrypoint: gunicorn -b :\$PORT main:app

env_variables:
A_VARIABLE: "value"
EOF

# Deploy the changes
gcloud app deploy

# Update the SA if you need it (and if you have actas permissions)
gcloud app update --service-account=<sa>@$PROJECT_ID.iam.gserviceaccount.com
```
Ako ste **veƒá kompromitovali AppEngine** i imate dozvolu **`appengine.applications.update`** i **actAs** nad servisnim nalogom koji koristite, mo≈æete izmeniti servisni nalog koji koristi AppEngine sa:
```bash
gcloud app update --service-account=<sa>@$PROJECT_ID.iam.gserviceaccount.com
```
### `appengine.instances.enableDebug`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.get`, `appengine.versions.list`, `compute.projects.get`

Sa ovim dozvolama, moguƒáe je **prijaviti se putem ssh u App Engine instance** tipa **flexible** (ne standard). Neke od **`list`** i **`get`** dozvola **mo≈æda nisu stvarno potrebne**.
```bash
gcloud app instances ssh --service <app-name> --version <version-id> <ID>
```
### `appengine.applications.update`, `appengine.operations.get`

–ú–∏—Å–ª–∏–º –¥–∞ –æ–≤–æ —Å–∞–º–æ –º–µ—ö–∞ –ø–æ–∑–∞–¥–∏–Ω—Å–∫–∏ SA –∫–æ—ò–∏ —õ–µ Google –∫–æ—Ä–∏—Å—Ç–∏—Ç–∏ –∑–∞ –ø–æ–¥–µ—à–∞–≤–∞—ö–µ –∞–ø–ª–∏–∫–∞—Ü–∏—ò–∞, —Ç–∞–∫–æ –¥–∞ –Ω–µ –º–∏—Å–ª–∏–º –¥–∞ –º–æ–∂–µ—Ç–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–∏—Ç–∏ –æ–≤–æ –¥–∞ —É–∫—Ä–∞–¥–µ—Ç–µ service account.

{% code overflow="wrap" %}
```bash
gcloud app update --service-account=<sa_email>
```
{% endcode %}

### `appengine.versions.getFileContents`, `appengine.versions.update`

Nisam siguran kako koristiti ove dozvole ili da li su korisne (imajte na umu da kada promenite kod, kreira se nova verzija, tako da ne znam da li mo≈æete samo a≈æurirati kod ili IAM ulogu jedne, ali pretpostavljam da bi trebalo da mo≈æete, mo≈æda menjajuƒái kod unutar bucket-a??).

### Pristup za pisanje nad bucket-ima

ƒåak i sa pristupom za pisanje nad bucket-ima gde se nalazi izvorni kod **NIJE BILO moguƒáe izvr≈°iti proizvoljan kod menjajuƒái izvorni kod i `manifest.json`**.\
Mo≈æda ako pratite bucket i detektujete trenutak kada se kreira nova verzija i izvorni kod i manifest se uƒçitavaju, moglo bi biti moguƒáe promeniti ih tako da nova verzija koristi one sa backdoor-om??

Takoƒëe izgleda da su slojevi kontejnera sme≈°teni u bucket-u, mo≈æda menjajuƒái njih?

{% hint style="success" %}
Nauƒçite i ve≈æbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nauƒçite i ve≈æbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove podno≈°enjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
