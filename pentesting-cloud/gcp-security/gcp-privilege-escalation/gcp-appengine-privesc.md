# GCP - AppEngine Privesc

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **bizi takip edin** **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## App Engine

App Engine hakkında daha fazla bilgi için:

{% content-ref url="../gcp-services/gcp-app-engine-enum.md" %}
[gcp-app-engine-enum.md](../gcp-services/gcp-app-engine-enum.md)
{% endcontent-ref %}

### `appengine.applications.get`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.operations.list`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.create`, `appengine.versions.get`, `appengine.versions.list`, `cloudbuild.builds.get`,`iam.serviceAccounts.actAs`, `resourcemanager.projects.get`, `storage.objects.create`, `storage.objects.list`

Bunlar, **`gcloud` cli kullanarak bir App dağıtmak için gereken izinlerdir**. Belki **`get`** ve **`list`** olanlar **atlatılabilir**.

Python kod örneklerini [https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine](https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine) adresinde bulabilirsiniz.

Varsayılan olarak, App hizmetinin adı **`default`** olacak ve aynı ada sahip yalnızca 1 örnek olabilir.\
Bunu değiştirmek ve ikinci bir App oluşturmak için, **`app.yaml`** dosyasında, kök anahtarın değerini **`service: my-second-app`** gibi bir şeyle değiştirin.
```bash
cd python-docs-samples/appengine/flexible/hello_world
gcloud app deploy #Upload and start application inside the folder
```
En az 10-15 dakika bekleyin, işe yaramazsa **deploy another of times** çağırın ve birkaç dakika bekleyin.

{% hint style="info" %}
**Kullanılacak Service Account'u belirtmek mümkün** ama varsayılan olarak, App Engine varsayılan SA kullanılır.
{% endhint %}

Uygulamanın URL'si `https://<proj-name>.oa.r.appspot.com/` veya `https://<service_name>-dot-<proj-name>.oa.r.appspot.com` gibi bir şeydir.

### Eşdeğer izinleri güncelleyin

Yeni bir AppEngine oluşturmak için yeterli izniniz olmayabilir, ancak mevcut bir AppEngine'i güncellemek için yeterli izniniz olabilir. Bu durumda, mevcut App Engine'i şu şekilde güncelleyebilirsiniz:
```bash
# Find the code of the App Engine in the buckets
gsutil ls

# Download code
mkdir /tmp/appengine2
cd /tmp/appengine2
## In this case it was found in this custom bucket but you could also use the
## buckets generated when the App Engine is created
gsutil cp gs://appengine-lab-1-gcp-labs-4t04m0i6-3a97003354979ef6/labs_appengine_1_premissions_privesc.zip .
unzip labs_appengine_1_premissions_privesc.zip

## Now modify the code..

## If you don't have an app.yaml, create one like:
cat >> app.yaml <<EOF
runtime: python312

entrypoint: gunicorn -b :\$PORT main:app

env_variables:
A_VARIABLE: "value"
EOF

# Deploy the changes
gcloud app deploy

# Update the SA if you need it (and if you have actas permissions)
gcloud app update --service-account=<sa>@$PROJECT_ID.iam.gserviceaccount.com
```
Eğer **zaten bir AppEngine'i ele geçirdiyseniz** ve **`appengine.applications.update`** iznine ve kullanmak için hizmet hesabı üzerinde **actAs** yetkisine sahipseniz, AppEngine tarafından kullanılan hizmet hesabını şu şekilde değiştirebilirsiniz:
```bash
gcloud app update --service-account=<sa>@$PROJECT_ID.iam.gserviceaccount.com
```
### `appengine.instances.enableDebug`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.get`, `appengine.versions.list`, `compute.projects.get`

Bu izinlerle, **flexible türündeki App Engine instance'larına ssh ile giriş yapmak** mümkündür (standart değil). Bazı **`list`** ve **`get`** izinleri **gerçekten gerekli olmayabilir**.
```bash
gcloud app instances ssh --service <app-name> --version <version-id> <ID>
```
### `appengine.applications.update`, `appengine.operations.get`

Bunun sadece Google'ın uygulamaları kurmak için kullanacağı arka plan SA'yı değiştirdiğini düşünüyorum, bu yüzden bu hizmet hesabını çalmak için kötüye kullanabileceğinizi sanmıyorum.

{% code overflow="wrap" %}
```bash
gcloud app update --service-account=<sa_email>
```
{% endcode %}

### `appengine.versions.getFileContents`, `appengine.versions.update`

Bu izinlerin nasıl kullanılacağını veya faydalı olup olmadığını bilmiyorum (kod değiştirildiğinde yeni bir sürüm oluşturulduğunu unutmayın, bu yüzden sadece kodu veya bir IAM rolünü güncelleyip güncelleyemeyeceğinizi bilmiyorum, ama yapabilmeniz gerektiğini tahmin ediyorum, belki bucket içindeki kodu değiştirerek??).

### Bucket'lar Üzerinde Yazma Erişimi

Kaynak kodun bulunduğu bucket'lar üzerinde yazma erişimi olsa bile, **kaynak kodu ve `manifest.json` dosyasını değiştirerek keyfi kod çalıştırmak MÜMKÜN OLMADI**.\
Belki bucket'ı izleyip yeni bir sürüm oluşturulduğu ve kaynak kod ile manifest yüklendiği anı tespit ederseniz, bunları değiştirerek yeni sürümün arka kapılı olanları kullanmasını sağlayabilirsiniz??

Ayrıca konteyner katmanlarının bucket'ta saklandığı görünüyor, belki bunları değiştirerek?

{% hint style="success" %}
AWS Hacking öğren & pratik yap:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğren & pratik yap: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}
