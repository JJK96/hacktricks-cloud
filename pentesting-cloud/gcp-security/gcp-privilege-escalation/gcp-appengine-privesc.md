# GCP - AppEngine Privesc

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## App Engine

Pour plus d'informations sur App Engine, consultez :

{% content-ref url="../gcp-services/gcp-app-engine-enum.md" %}
[gcp-app-engine-enum.md](../gcp-services/gcp-app-engine-enum.md)
{% endcontent-ref %}

### `appengine.applications.get`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.operations.list`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.create`, `appengine.versions.get`, `appengine.versions.list`, `cloudbuild.builds.get`,`iam.serviceAccounts.actAs`, `resourcemanager.projects.get`, `storage.objects.create`, `storage.objects.list`

Ce sont les permissions n√©cessaires pour **d√©ployer une App en utilisant `gcloud` cli**. Peut-√™tre que les permissions **`get`** et **`list`** pourraient √™tre **√©vit√©es**.

Vous pouvez trouver des exemples de code python sur [https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine](https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine)

Par d√©faut, le nom du service App sera **`default`**, et il ne peut y avoir qu'une seule instance avec le m√™me nom.\
Pour le changer et cr√©er une deuxi√®me App, dans **`app.yaml`**, changez la valeur de la cl√© racine en quelque chose comme **`service: my-second-app`**
```bash
cd python-docs-samples/appengine/flexible/hello_world
gcloud app deploy #Upload and start application inside the folder
```
Donnez-lui au moins 10-15 minutes, si cela ne fonctionne pas, appelez **deploy another of times** et attendez quelques minutes.

{% hint style="info" %}
Il est **possible d'indiquer le Service Account √† utiliser** mais par d√©faut, le SA par d√©faut de App Engine est utilis√©.
{% endhint %}

L'URL de l'application est quelque chose comme `https://<proj-name>.oa.r.appspot.com/` ou `https://<service_name>-dot-<proj-name>.oa.r.appspot.com`

### Mettre √† jour les permissions √©quivalentes

Vous pourriez avoir suffisamment de permissions pour mettre √† jour un AppEngine mais pas pour en cr√©er un nouveau. Dans ce cas, voici comment vous pourriez mettre √† jour l'App Engine actuel :
```bash
# Find the code of the App Engine in the buckets
gsutil ls

# Download code
mkdir /tmp/appengine2
cd /tmp/appengine2
## In this case it was found in this custom bucket but you could also use the
## buckets generated when the App Engine is created
gsutil cp gs://appengine-lab-1-gcp-labs-4t04m0i6-3a97003354979ef6/labs_appengine_1_premissions_privesc.zip .
unzip labs_appengine_1_premissions_privesc.zip

## Now modify the code..

## If you don't have an app.yaml, create one like:
cat >> app.yaml <<EOF
runtime: python312

entrypoint: gunicorn -b :\$PORT main:app

env_variables:
A_VARIABLE: "value"
EOF

# Deploy the changes
gcloud app deploy

# Update the SA if you need it (and if you have actas permissions)
gcloud app update --service-account=<sa>@$PROJECT_ID.iam.gserviceaccount.com
```
Si vous avez **d√©j√† compromis un AppEngine** et que vous avez la permission **`appengine.applications.update`** et **actAs** sur le compte de service √† utiliser, vous pouvez modifier le compte de service utilis√© par AppEngine avec :
```bash
gcloud app update --service-account=<sa>@$PROJECT_ID.iam.gserviceaccount.com
```
### `appengine.instances.enableDebug`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.get`, `appengine.versions.list`, `compute.projects.get`

Avec ces permissions, il est possible de **se connecter via ssh dans les instances App Engine** de type **flexible** (pas standard). Certaines des permissions **`list`** et **`get`** **pourraient ne pas √™tre vraiment n√©cessaires**.
```bash
gcloud app instances ssh --service <app-name> --version <version-id> <ID>
```
### `appengine.applications.update`, `appengine.operations.get`

Je pense que cela change simplement le SA de fond que Google utilisera pour configurer les applications, donc je ne pense pas que vous puissiez abuser de cela pour voler le compte de service.

{% code overflow="wrap" %}
```bash
gcloud app update --service-account=<sa_email>
```
{% endcode %}

### `appengine.versions.getFileContents`, `appengine.versions.update`

Pas s√ªr de savoir comment utiliser ces permissions ou si elles sont utiles (notez que lorsque vous modifiez le code, une nouvelle version est cr√©√©e, donc je ne sais pas si vous pouvez simplement mettre √† jour le code ou le r√¥le IAM d'une version, mais je suppose que vous devriez pouvoir le faire, peut-√™tre en changeant le code √† l'int√©rieur du bucket??).

### Acc√®s en √©criture sur les buckets

M√™me avec un acc√®s en √©criture sur les buckets o√π le code source est situ√© **il N'√âTAIT PAS possible d'ex√©cuter du code arbitraire en modifiant le code source et le `manifest.json`**.\
Peut-√™tre que si vous surveillez le bucket et d√©tectez le moment o√π une nouvelle version est cr√©√©e et que le code source et le manifest sont t√©l√©charg√©s, il pourrait √™tre possible de les changer pour que la nouvelle version utilise ceux avec une porte d√©rob√©e??

Il semble √©galement que les couches de conteneurs soient stock√©es dans le bucket, peut-√™tre les changer?

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
