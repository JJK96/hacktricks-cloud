# GCP - Privilege Escalation in Artifact Registry

{% hint style="success" %}
Lernen Sie und √ºben Sie AWS-Hacking: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie und √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>
{% endhint %}

## Artifact Registry

F√ºr weitere Informationen √ºber Artifact Registry siehe:

{% content-ref url="../gcp-services/gcp-artifact-registry-enum.md" %}
[gcp-artifact-registry-enum.md](../gcp-services/gcp-artifact-registry-enum.md)
{% endcontent-ref %}

### artifactregistry.repositories.uploadArtifacts

Mit dieser Berechtigung k√∂nnte ein Angreifer neue Versionen der Artefakte mit b√∂sartigem Code wie Docker-Images hochladen:

{% code overflow="wrap" %}
```bash
# Configure docker to use gcloud to authenticate with Artifact Registry
gcloud auth configure-docker <location>-docker.pkg.dev

# tag the image to upload it
docker tag <local-img-name>:<local-tag> <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>

# Upload it
docker push <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
{% endcode %}

{% hint style="danger" %}
Es wurde √ºberpr√ºft, dass es **m√∂glich ist, ein neues b√∂sartiges Docker-Image hochzuladen** mit demselben Namen und Tag wie das bereits vorhandene, sodass das **alte den Tag verliert** und beim n√§chsten Mal, wenn das Bild mit diesem Tag **heruntergeladen wird, das b√∂sartige heruntergeladen wird**.
{% endhint %}

<details>

<summary>Laden Sie eine Python-Bibliothek hoch</summary>

**Beginnen Sie mit der Erstellung der hochzuladenden Bibliothek** (wenn Sie die neueste Version aus dem Repository herunterladen k√∂nnen, k√∂nnen Sie diesen Schritt √ºberspringen):

1. **Richten Sie Ihre Projektstruktur ein**:

* Erstellen Sie ein neues Verzeichnis f√ºr Ihre Bibliothek, z. B. `hello_world_library`.
* Erstellen Sie innerhalb dieses Verzeichnisses ein weiteres Verzeichnis mit Ihrem Paketnamen, z. B. `hello_world`.
* Erstellen Sie im Verzeichnis Ihres Pakets eine `__init__.py`-Datei. Diese Datei kann leer sein oder Initialisierungen f√ºr Ihr Paket enthalten.

```bash
mkdir hello_world_library
cd hello_world_library
mkdir hello_world
touch hello_world/__init__.py
```
2. **Schreiben Sie Ihren Bibliothekscode**:

* Erstellen Sie im Verzeichnis `hello_world` eine neue Python-Datei f√ºr Ihr Modul, z. B. `greet.py`.
* Schreiben Sie Ihre "Hallo Welt!"-Funktion:

```python
# hello_world/greet.py
def say_hello():
return "Hallo Welt!"
```
3. **Erstellen Sie eine `setup.py`-Datei**:

* Im Stammverzeichnis Ihres `hello_world_library`-Verzeichnisses erstellen Sie eine `setup.py`-Datei.
* Diese Datei enth√§lt Metadaten zu Ihrer Bibliothek und gibt Python an, wie sie installiert werden soll.

```python
# setup.py
from setuptools import setup, find_packages

setup(
name='hello_world',
version='0.1',
packages=find_packages(),
install_requires=[
# Alle Abh√§ngigkeiten, die Ihre Bibliothek ben√∂tigt
],
)
```



**Jetzt laden wir die Bibliothek hoch:**

1. **Erstellen Sie Ihr Paket**:

* F√ºhren Sie vom Stammverzeichnis Ihres `hello_world_library`-Verzeichnisses aus folgendes aus:

```sh
python3 setup.py sdist bdist_wheel
```
2. **Konfigurieren Sie die Authentifizierung f√ºr Twine** (verwendet zum Hochladen Ihres Pakets):

* Stellen Sie sicher, dass `twine` installiert ist (`pip install twine`).
* Verwenden Sie `gcloud`, um Anmeldeinformationen zu konfigurieren:

{% code overflow="wrap" %}
```sh
twine upload --username 'oauth2accesstoken' --password "$(gcloud auth print-access-token)" --repository-url https://<location>-python.pkg.dev/<project-id>/<repo-name>/ dist/*
```
{% endcode %}

<!---->

3. **Bereinigen Sie den Build**
```bash
rm -rf dist build hello_world.egg-info
```
</details>

{% hint style="danger" %}
Es ist nicht m√∂glich, eine Python-Bibliothek mit derselben Version wie der bereits vorhandenen hochzuladen, aber es ist m√∂glich, **h√∂here Versionen hochzuladen** (oder eine zus√§tzliche **`.0` am Ende** der Version hinzuzuf√ºgen, wenn das funktioniert -nicht in Python jedoch-), oder die **letzte Version zu l√∂schen und eine neue hochzuladen** (erforderlich `artifactregistry.versions.delete)`**:**

{% code overflow="wrap" %}
```sh
gcloud artifacts versions delete <version> --repository=<repo-name> --location=<location> --package=<lib-name>
```
{% endcode %}
{% endhint %}

### `artifactregistry.repositories.downloadArtifacts`

Mit dieser Berechtigung k√∂nnen Sie **Artefakte herunterladen** und nach **vertraulichen Informationen** und **Schwachstellen** suchen.

Laden Sie ein **Docker**-Image herunter:
```sh
# Configure docker to use gcloud to authenticate with Artifact Registry
gcloud auth configure-docker <location>-docker.pkg.dev

# Dowload image
docker pull <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
Laden Sie eine **Python**-Bibliothek herunter:

{% code overflow="wrap" %}
```bash
pip install <lib-name> --index-url "https://oauth2accesstoken:$(gcloud auth print-access-token)@<location>-python.pkg.dev/<project-id>/<repo-name>/simple/" --trusted-host <location>-python.pkg.dev --no-cache-dir
```
{% endcode %}

* Was passiert, wenn ein Remote- und ein Standard-Repository in einem virtuellen Repository gemischt werden und ein Paket in beiden existiert? √úberpr√ºfen Sie diese Seite:

{% content-ref url="../gcp-persistence/gcp-artifact-registry-persistence.md" %}
[gcp-artifact-registry-persistence.md](../gcp-persistence/gcp-artifact-registry-persistence.md)
{% endcontent-ref %}

### `artifactregistry.tags.delete`, `artifactregistry.versions.delete`, `artifactregistry.packages.delete`, (`artifactregistry.repositories.get`, `artifactregistry.tags.get`, `artifactregistry.tags.list`)

L√∂schen Sie Artefakte aus dem Repository, wie z.B. Docker-Images:

{% code overflow="wrap" %}
```bash
# Delete a docker image
gcloud artifacts docker images delete <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
{% endcode %}

### `artifactregistry.repositories.delete`

L√∂schen Sie ein vollst√§ndiges Repository (auch wenn es Inhalt hat):

{% code overflow="wrap" %}
```
gcloud artifacts repositories delete <repo-name> --location=<location>
```
{% endcode %}

### `artifactregistry.repositories.setIamPolicy`

Ein Angreifer mit dieser Berechtigung k√∂nnte sich Berechtigungen geben, um einige der zuvor genannten Repository-Angriffe durchzuf√ºhren.

{% hint style="success" %}
Lernen Sie & √ºben Sie AWS-Hacking: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie & √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>
{% endhint %}
