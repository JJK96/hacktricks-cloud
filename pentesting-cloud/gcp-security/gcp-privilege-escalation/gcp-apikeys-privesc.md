# GCP - Apikeys提权

{% hint style="success" %}
学习并练习AWS Hacking：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks培训AWS红队专家（ARTE）**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习GCP Hacking：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks培训GCP红队专家（GRTE）**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持HackTricks</summary>

* 检查[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享黑客技巧。

</details>
{% endhint %}

## Apikeys

以下权限对于创建和窃取API密钥很有用，不是来自文档的：_API密钥是一个简单的加密字符串，**用于标识没有任何主体的应用程序**。它们用于匿名访问**公共数据**，并用于将API请求与您的项目关联以用于配额和**计费**。_

因此，使用API密钥，您可以让公司为您使用API付费，但您将无法提升权限。

有关API密钥的更多信息，请查看：

{% content-ref url="../gcp-services/gcp-api-keys-enum.md" %}
[gcp-api-keys-enum.md](../gcp-services/gcp-api-keys-enum.md)
{% endcontent-ref %}

有关创建API密钥的其他方法，请查看：

{% content-ref url="gcp-serviceusage-privesc.md" %}
[gcp-serviceusage-privesc.md](gcp-serviceusage-privesc.md)
{% endcontent-ref %}

### 暴力破解API密钥访问 <a href="#apikeys.keys.create" id="apikeys.keys.create"></a>

由于您可能不知道项目中启用了哪些API或应用于找到的API密钥的限制，建议运行工具[**https://github.com/ozguralp/gmapsapiscanner**](https://github.com/ozguralp/gmapsapiscanner)并检查**您可以使用API密钥访问的内容。**

### `apikeys.keys.create` <a href="#apikeys.keys.create" id="apikeys.keys.create"></a>

此权限允许**创建API密钥**：
```bash
gcloud services api-keys create
Operation [operations/akmf.p7-[...]9] complete. Result: {
"@type":"type.googleapis.com/google.api.apikeys.v2.Key",
"createTime":"2022-01-26T12:23:06.281029Z",
"etag":"W/\"HOhA[...]==\"",
"keyString":"AIzaSy[...]oU",
"name":"projects/5[...]6/locations/global/keys/f707[...]e8",
"uid":"f707[...]e8",
"updateTime":"2022-01-26T12:23:06.378442Z"
}
```
你可以在[这里找到一个用于自动化**创建、利用和清理漏洞环境的脚本**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/b-apikeys.keys.create.sh)。

{% hint style="danger" %}
请注意，默认情况下用户具有创建新项目的权限，并且他们被授予新项目的所有者角色。因此，用户可以**创建一个项目并在该项目内创建一个 API 密钥**。
{% endhint %}

### `apikeys.keys.getKeyString`，`apikeys.keys.list` <a href="#apikeys.keys.getkeystringapikeys.keys.list" id="apikeys.keys.getkeystringapikeys.keys.list"></a>

这些权限允许**列出和获取所有 apiKeys 并获取密钥**：
```bash
for  key  in  $(gcloud services api-keys list --uri); do
gcloud services api-keys get-key-string "$key"
done
```
你可以在[这里](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/c-apikeys.keys.getKeyString.sh)找到一个用于自动化**创建、利用和清理漏洞环境的脚本**。

### `apikeys.keys.undelete`，`apikeys.keys.list` <a href="#serviceusage.apikeys.regenerateapikeys.keys.list" id="serviceusage.apikeys.regenerateapikeys.keys.list"></a>

这些权限允许你**列出和重新生成已删除的 API 密钥**。**API 密钥在执行**`undelete`**操作后会显示在输出中**：
```bash
gcloud services api-keys list --show-deleted
gcloud services api-keys undelete <key-uid>
```
### 创建内部 OAuth 应用程序以钓鱼其他工作人员

查看以下页面以了解如何执行此操作，尽管根据文档，此操作属于 **`clientauthconfig`** 服务：

{% content-ref url="../../workspace-security/gws-google-platforms-phishing/" %}
[gws-google-platforms-phishing](../../workspace-security/gws-google-platforms-phishing/)
{% endcontent-ref %}
