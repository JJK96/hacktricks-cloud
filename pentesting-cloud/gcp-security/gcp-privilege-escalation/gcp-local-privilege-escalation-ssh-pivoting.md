# GCP - kuboresha mamlaka ya ndani kwa njia ya ssh pivoting

{% hint style="success" %}
Jifunze na zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks ya Mtaalam wa Timu Nyekundu ya AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks ya Mtaalam wa Timu Nyekundu ya GCP (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}

katika kesi hii tutadhani kwamba umefanikiwa **kudukua akaunti isiyo na mamlaka** ndani ya VM katika mradi wa Compute Engine.

Kwa kushangaza, ruhusa za GPC za kompyuta ya kompyuta ambayo umedukua inaweza kukusaidia **kuboresha mamlaka kwa ndani ndani ya mashine**. Hata kama hilo halitasaidia sana katika mazingira ya wingu, ni vizuri kujua kwamba ni jambo linalowezekana.

## Soma hati za maandishi <a href="#follow-the-scripts" id="follow-the-scripts"></a>

**Mifano ya Kompyuta** labda iko hapo kutekeleza baadhi ya hati za maandishi kutekeleza vitendo na akaunti zao za huduma.

Kwa kuwa IAM ni ya kina, akaunti inaweza kuwa na ruhusa za **kusoma/kuandika** juu ya rasilimali lakini **bila ruhusa za orodha**.

Mfano mzuri wa dhana hii ni Mfano wa Kompyuta ambao una ruhusa ya kusoma/kuandika nakala rudufu kwenye kisanduku cha uhifadhi kinachoitwa `instance82736-long-term-xyz-archive-0332893`.

Kukimbia `gsutil ls` kutoka kwenye mstari wa amri hakurudishi chochote, kwa kuwa akaunti ya huduma inakosa ruhusa ya IAM ya `storage.buckets.list`. Walakini, ikiwa ungekimbia `gsutil ls gs://instance82736-long-term-xyz-archive-0332893` unaweza kupata nakala rudufu kamili ya mfumo wa faili, ikikupa ufikiaji wa maandishi wazi kwa data ambayo akaunti yako ya Linux ya ndani inakosa.

Unaweza kupata jina la kisanduku hiki ndani ya hati ya maandishi (kwa bash, Python, Ruby...).

## Metadata ya Desturi

Waadiministrata wanaweza kuongeza [metadata ya desturi](https://cloud.google.com/compute/docs/storing-retrieving-metadata#custom) kwenye **mfano** na **kiwango cha mradi**. Hii ni njia tu ya kupitisha **jozi za funguo/ thamani za kiholela kwenye mfano**, na mara nyingi hutumiwa kwa mazingira ya mazingira na hati za kuanza/kuzimwa.

Zaidi ya hayo, ni rahisi kuongeza **data ya mtumiaji**, ambayo ni hati ya maandishi itakayokuwa **itekelezwa kila wakati** mashine inapoanzishwa au kuanzishwa upya na inaweza **kufikiwa kutoka kwa mwisho wa metadata pia.**

Kwa habari zaidi angalia:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

## **Kutumia vibali vya IAM**

Vibali vingi vilivyopendekezwa vifuatavyo vinapewa **Compute SA ya chaguo-msingi,** tatizo pekee ni kwamba **wigo wa upatikanaji wa chaguo-msingi unazuia SA kutumia**. Walakini, ikiwa **wigo wa `cloud-platform`** unawezeshwa au tu **wigo wa `compute`** unawezeshwa, utaweza **kuvitumia vibali hivyo**.

Angalia vibali vifuatavyo:

* [**compute.instances.osLogin**](gcp-compute-privesc/#compute.instances.oslogin)
* [**compute.instances.osAdminLogin**](gcp-compute-privesc/#compute.instances.osadminlogin)
* [**compute.projects.setCommonInstanceMetadata**](gcp-compute-privesc/#compute.projects.setcommoninstancemetadata)
* [**compute.instances.setMetadata**](gcp-compute-privesc/#compute.instances.setmetadata)
* [**compute.instances.setIamPolicy**](gcp-compute-privesc/#compute.instances.setiampolicy)

## Tafuta funguo kwenye mfumo wa faili

Angalia ikiwa watumiaji wengine wameingia kwenye gcloud ndani ya sanduku na kuacha vibali vyao kwenye mfumo wa faili:
```
sudo find / -name "gcloud"
```
Hizi ndizo faili za kuvutia zaidi:

* `~/.config/gcloud/credentials.db`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/adc.json`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/.boto`
* `~/.credentials.json`

### Zaidi ya API Keys regexes
```bash
TARGET_DIR="/path/to/whatever"

# Service account keys
grep -Pzr "(?s){[^{}]*?service_account[^{}]*?private_key.*?}" \
"$TARGET_DIR"

# Legacy GCP creds
grep -Pzr "(?s){[^{}]*?client_id[^{}]*?client_secret.*?}" \
"$TARGET_DIR"

# Google API keys
grep -Pr "AIza[a-zA-Z0-9\\-_]{35}" \
"$TARGET_DIR"

# Google OAuth tokens
grep -Pr "ya29\.[a-zA-Z0-9_-]{100,200}" \
"$TARGET_DIR"

# Generic SSH keys
grep -Pzr "(?s)-----BEGIN[ A-Z]*?PRIVATE KEY[a-zA-Z0-9/\+=\n-]*?END[ A-Z]*?PRIVATE KEY-----" \
"$TARGET_DIR"

# Signed storage URLs
grep -Pir "storage.googleapis.com.*?Goog-Signature=[a-f0-9]+" \
"$TARGET_DIR"

# Signed policy documents in HTML
grep -Pzr '(?s)<form action.*?googleapis.com.*?name="signature" value=".*?">' \
"$TARGET_DIR"
```
## Marejeo

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Jifunze na zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
