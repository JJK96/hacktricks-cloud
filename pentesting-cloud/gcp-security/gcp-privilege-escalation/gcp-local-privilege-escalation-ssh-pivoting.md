# GCP - 本地特权升级 SSH 枢纽

{% hint style="success" %}
学习并实践 AWS 黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并实践 GCP 黑客技术：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 检查[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享黑客技巧。**

</details>
{% endhint %}

在这种情况下，我们假设您**已经入侵了计算引擎项目中虚拟机中的非特权帐户**。

令人惊讶的是，您已经入侵的计算引擎的 GCP 权限可能帮助您**在机器内部本地升级特权**。即使在云环境中这并不总是非常有用，但知道这是可能的也是好的。

## 阅读脚本 <a href="#follow-the-scripts" id="follow-the-scripts"></a>

**计算实例**可能存在**执行一些脚本**以使用其服务帐户执行操作。

由于 IAM 是如此细粒度，一个帐户可能对资源具有**读/写**权限，但没有**列出权限**。

一个很好的假设示例是一个具有权限将备份读/写到名为 `instance82736-long-term-xyz-archive-0332893` 的存储桶的计算实例。

从命令行运行 `gsutil ls` 不返回任何内容，因为服务帐户缺少 `storage.buckets.list` IAM 权限。但是，如果您运行 `gsutil ls gs://instance82736-long-term-xyz-archive-0332893`，您可能会找到完整的文件系统备份，从而使您可以明文访问您的本地 Linux 帐户缺少的数据。

您可能会在脚本中（bash、Python、Ruby 等）找到此存储桶名称。

## 自定义元数据

管理员可以在**实例**和**项目级别**添加[自定义元数据](https://cloud.google.com/compute/docs/storing-retrieving-metadata#custom)。这只是一种将**任意键/值对传递到实例**中的方法，通常用于环境变量和启动/关闭脚本。

此外，还可以添加**用户数据**，这是一个将在每次启动或重新启动机器时**执行的脚本，并且也可以从元数据端点访问。**

有关更多信息，请查看：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

## 滥用 IAM 权限

以下大多数建议的权限都是**授予默认的 Compute SA**，唯一的问题是**默认访问范围阻止 SA 使用它们**。但是，如果启用了**`cloud-platform`** **范围**或只启用了**`compute`** **范围**，您将能够**滥用它们**。

检查以下权限：

* [**compute.instances.osLogin**](gcp-compute-privesc/#compute.instances.oslogin)
* [**compute.instances.osAdminLogin**](gcp-compute-privesc/#compute.instances.osadminlogin)
* [**compute.projects.setCommonInstanceMetadata**](gcp-compute-privesc/#compute.projects.setcommoninstancemetadata)
* [**compute.instances.setMetadata**](gcp-compute-privesc/#compute.instances.setmetadata)
* [**compute.instances.setIamPolicy**](gcp-compute-privesc/#compute.instances.setiampolicy)

## 在文件系统中搜索密钥

检查其他用户是否已经在盒子内部使用 gcloud 登录并在文件系统中留下了他们的凭据：
```
sudo find / -name "gcloud"
```
以下是最有趣的文件：

* `~/.config/gcloud/credentials.db`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/adc.json`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/.boto`
* `~/.credentials.json`

### 更多 API 密钥正则表达式
```bash
TARGET_DIR="/path/to/whatever"

# Service account keys
grep -Pzr "(?s){[^{}]*?service_account[^{}]*?private_key.*?}" \
"$TARGET_DIR"

# Legacy GCP creds
grep -Pzr "(?s){[^{}]*?client_id[^{}]*?client_secret.*?}" \
"$TARGET_DIR"

# Google API keys
grep -Pr "AIza[a-zA-Z0-9\\-_]{35}" \
"$TARGET_DIR"

# Google OAuth tokens
grep -Pr "ya29\.[a-zA-Z0-9_-]{100,200}" \
"$TARGET_DIR"

# Generic SSH keys
grep -Pzr "(?s)-----BEGIN[ A-Z]*?PRIVATE KEY[a-zA-Z0-9/\+=\n-]*?END[ A-Z]*?PRIVATE KEY-----" \
"$TARGET_DIR"

# Signed storage URLs
grep -Pir "storage.googleapis.com.*?Goog-Signature=[a-f0-9]+" \
"$TARGET_DIR"

# Signed policy documents in HTML
grep -Pzr '(?s)<form action.*?googleapis.com.*?name="signature" value=".*?">' \
"$TARGET_DIR"
```
## 参考

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
学习并练习AWS Hacking：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 检查[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}
