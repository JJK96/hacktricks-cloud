# GCP - τοπική ανύψωση προνομίων με χρήση ssh pivoting

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Συμμετέχετε** 💬 στην [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Κοινοποιήστε κόλπα χάκερ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

σε αυτό το σενάριο θα υποθέσουμε ότι **έχετε διαρρεύσει ένα λογαριασμό μη προνομιούχου** μέσα σε ένα VM σε ένα έργο Compute Engine.

Εκπληκτικά, οι άδειες GPC του υπολογιστικού μηχανήματος που έχετε διαρρήξει μπορεί να σας βοηθήσουν να **αναβαθμίσετε τα προνόμιά σας τοπικά μέσα σε ένα μηχάνημα**. Ακόμη κι αν αυτό δεν είναι πάντα πολύ χρήσιμο σε ένα περιβάλλον cloud, είναι καλό να γνωρίζετε ότι είναι δυνατόν.

## Διαβάστε τα scripts <a href="#follow-the-scripts" id="follow-the-scripts"></a>

**Οι Υπολογιστικές Ενότητες** πιθανότατα υπάρχουν για να **εκτελέσουν κάποια scripts** για να εκτελέσουν ενέργειες με τους λογαριασμούς υπηρεσιών τους.

Καθώς το IAM είναι τόσο λεπτομερές, ένας λογαριασμός μπορεί να έχει δικαιώματα **ανάγνωσης/εγγραφής** πάνω σε ένα πόρο αλλά **χωρίς δικαιώματα λίστας**.

Ένα εξαιρετικό υποθετικό παράδειγμα αυτού είναι μια Υπολογιστική Ενότητα που έχει άδεια να διαβάζει/γράφει αντίγραφα ασφαλείας σε ένα κάδο αποθήκευσης που ονομάζεται `instance82736-long-term-xyz-archive-0332893`.

Η εκτέλεση της εντολής `gsutil ls` από τη γραμμή εντολών δεν επιστρέφει τίποτα, καθώς ο λογαριασμός υπηρεσίας λείπει η άδεια IAM `storage.buckets.list`. Ωστόσο, αν εκτελέσετε `gsutil ls gs://instance82736-long-term-xyz-archive-0332893` μπορείτε να βρείτε ένα πλήρες αντίγραφο ασφαλείας του συστήματος αρχείων, που σας δίνει πρόσβαση σε κείμενο που ο τοπικός σας λογαριασμός Linux λείπει.

Μπορείτε να βρείτε αυτό το όνομα κάδου μέσα σε ένα script (σε bash, Python, Ruby...).

## Προσαρμοσμένα Metadata

Οι διαχειριστές μπορούν να προσθέσουν [προσαρμοσμένα μεταδεδομένα](https://cloud.google.com/compute/docs/storing-retrieving-metadata#custom) στο **επίπεδο της υπολογιστικής ενότητας** και **του έργου**. Αυτό είναι απλώς ένας τρόπος να περάσετε **αυθαίρετα ζεύγη κλειδιού/τιμής σε μια υπολογιστική ενότητα**, και χρησιμοποιείται συνήθως για μεταβλητές περιβάλλοντος και scripts εκκίνησης/απενεργοποίησης.

Επιπλέον, είναι δυνατόν να προστεθεί **userdata**, το οποίο είναι ένα script που θα **εκτελείται κάθε φορά** που το μηχάνημα εκκινείται ή επανεκκινείται και μπορεί να **έχει πρόσβαση από το metadata endpoint επίσης.**

Για περισσότερες πληροφορίες ελέγξτε:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

## Κατάχρηση δικαιωμάτων IAM

Τα περισσότερα από τα προτεινόμενα δικαιώματα που ακολουθούν **δίνονται στον προεπιλεγμένο Compute SA,** το μόνο πρόβλημα είναι ότι το **προεπιλεγμένο εύρος πρόσβασης εμποδίζει το SA από το να τα χρησιμοποιήσει**. Ωστόσο, αν είναι ενεργοποιημένο το **scope `cloud-platform`** ή απλώς το **scope `compute`,** θα μπορείτε να τα **καταχραστείτε.**

Ελέγξτε τα ακόλουθα δικαιώματα:

* [**compute.instances.osLogin**](gcp-compute-privesc/#compute.instances.oslogin)
* [**compute.instances.osAdminLogin**](gcp-compute-privesc/#compute.instances.osadminlogin)
* [**compute.projects.setCommonInstanceMetadata**](gcp-compute-privesc/#compute.projects.setcommoninstancemetadata)
* [**compute.instances.setMetadata**](gcp-compute-privesc/#compute.instances.setmetadata)
* [**compute.instances.setIamPolicy**](gcp-compute-privesc/#compute.instances.setiampolicy)

## Αναζήτηση για Κλειδιά στο σύστημα αρχείων

Ελέγξτε αν άλλοι χρήστες έχουν συνδεθεί στο gcloud μέσα στο κουτί και έχουν αφήσει τα διαπιστευτήριά τους στο σύστημα αρχείων:
```
sudo find / -name "gcloud"
```
Αυτά είναι τα πιο ενδιαφέροντα αρχεία:

* `~/.config/gcloud/credentials.db`
* `~/.config/gcloud/legacy_credentials/[ΛΟΓΑΡΙΑΣΜΟΣ]/adc.json`
* `~/.config/gcloud/legacy_credentials/[ΛΟΓΑΡΙΑΣΜΟΣ]/.boto`
* `~/.credentials.json`

### Περισσότερα API Keys regexes
```bash
TARGET_DIR="/path/to/whatever"

# Service account keys
grep -Pzr "(?s){[^{}]*?service_account[^{}]*?private_key.*?}" \
"$TARGET_DIR"

# Legacy GCP creds
grep -Pzr "(?s){[^{}]*?client_id[^{}]*?client_secret.*?}" \
"$TARGET_DIR"

# Google API keys
grep -Pr "AIza[a-zA-Z0-9\\-_]{35}" \
"$TARGET_DIR"

# Google OAuth tokens
grep -Pr "ya29\.[a-zA-Z0-9_-]{100,200}" \
"$TARGET_DIR"

# Generic SSH keys
grep -Pzr "(?s)-----BEGIN[ A-Z]*?PRIVATE KEY[a-zA-Z0-9/\+=\n-]*?END[ A-Z]*?PRIVATE KEY-----" \
"$TARGET_DIR"

# Signed storage URLs
grep -Pir "storage.googleapis.com.*?Goog-Signature=[a-f0-9]+" \
"$TARGET_DIR"

# Signed policy documents in HTML
grep -Pzr '(?s)<form action.*?googleapis.com.*?name="signature" value=".*?">' \
"$TARGET_DIR"
```
## Αναφορές

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
{% endhint %}
