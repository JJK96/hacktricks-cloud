# GCP - Informazioni di base

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai repo github di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## **Gerarchia delle risorse**

Google Cloud utilizza una [Gerarchia delle risorse](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) che √® simile, concettualmente, a quella di un filesystem tradizionale. Questo fornisce un flusso di lavoro logico genitore/figlio con punti di attacco specifici per politiche e permessi.

A un livello alto, appare cos√¨:
```
Organization
--> Folders
--> Projects
--> Resources
```
Una macchina virtuale (chiamata Compute Instance) √® una risorsa. Una risorsa risiede in un progetto, probabilmente insieme ad altre Compute Instances, storage buckets, ecc.

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption><p><a href="https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg">https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg</a></p></figcaption></figure>

## **Projects Migration**

√à possibile **migrare un progetto senza alcuna organizzazione** a un'organizzazione con i permessi `roles/resourcemanager.projectCreator` e `roles/resourcemanager.projectMover`. Se il progetto √® all'interno di un'altra organizzazione, √® necessario contattare il supporto GCP per **spostarlo fuori dall'organizzazione prima**. Per maggiori informazioni controlla [**questo**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Organization Policies**

Permettono di centralizzare il controllo sulle risorse cloud della tua organizzazione:

* Centralizzare il controllo per **configurare restrizioni** su come possono essere utilizzate le risorse della tua organizzazione.
* Definire e stabilire **guardrails** per i tuoi team di sviluppo per rimanere entro i limiti di conformit√†.
* Aiutare i proprietari dei progetti e i loro team a muoversi rapidamente senza preoccuparsi di violare la conformit√†.

Queste politiche possono essere create per **influenzare l'intera organizzazione, cartella(e) o progetto(i)**. I discendenti del nodo della gerarchia delle risorse mirato **ereditano la policy dell'organizzazione**.

Per **definire** una policy dell'organizzazione, **scegli un** [**vincolo**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), che √® un particolare tipo di restrizione contro un servizio Google Cloud o un gruppo di servizi Google Cloud. **Configuri quel vincolo con le restrizioni desiderate**.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption><p><a href="https://cloud.google.com/resource-manager/img/org-policy-concepts.svg">https://cloud.google.com/resource-manager/img/org-policy-concepts.svg</a></p></figcaption></figure>

#### Common use cases <a href="#common_use_cases" id="common_use_cases"></a>

* Limitare la condivisione delle risorse in base al dominio.
* Limitare l'uso degli account di servizio Identity and Access Management.
* Limitare la posizione fisica delle nuove risorse create.
* Disabilitare la creazione di account di servizio.

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

Ci sono molti altri vincoli che ti danno un controllo granulare delle risorse della tua organizzazione. Per **maggiori informazioni, vedi l'** [**elenco di tutti i vincoli del servizio Organization Policy**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

### **Default Organization Policies**

<details>

<summary>Queste sono le politiche che Google aggiunger√† per impostazione predefinita quando configuri la tua organizzazione GCP:</summary>

**Access Management Policies**

* **Domain restricted contacts:** Impedisce di aggiungere utenti ai Contatti Essenziali al di fuori dei domini specificati. Questo limita i Contatti Essenziali a consentire solo identit√† utente gestite nei domini selezionati di ricevere notifiche della piattaforma.
* **Domain restricted sharing:** Impedisce di aggiungere utenti alle politiche IAM al di fuori dei domini specificati. Questo limita le politiche IAM a consentire solo identit√† utente gestite nei domini selezionati di accedere alle risorse all'interno di questa organizzazione.
* **Public access prevention:** Impedisce che i bucket di Cloud Storage siano esposti al pubblico. Questo assicura che uno sviluppatore non possa configurare i bucket di Cloud Storage per avere accesso internet non autenticato.
* **Uniform bucket level access:** Impedisce le liste di controllo degli accessi (ACL) a livello di oggetto nei bucket di Cloud Storage. Questo semplifica la gestione degli accessi applicando le politiche IAM in modo coerente su tutti gli oggetti nei bucket di Cloud Storage.
* **Require OS login:** Le VM create in nuovi progetti avranno OS Login abilitato. Questo ti permette di gestire l'accesso SSH alle tue istanze utilizzando IAM senza dover creare e gestire chiavi SSH individuali.

**Additional security policies for service accounts**

* **Disable automatic IAM grants**: Impedisce che gli account di servizio predefiniti di App Engine e Compute Engine ricevano automaticamente il ruolo IAM Editor su un progetto alla creazione. Questo assicura che gli account di servizio non ricevano ruoli IAM eccessivamente permissivi alla creazione.
* **Disable service account key creation**: Impedisce la creazione di chiavi pubbliche per gli account di servizio. Questo aiuta a ridurre il rischio di esposizione delle credenziali persistenti.
* **Disable service account key upload**: Impedisce il caricamento di chiavi pubbliche per gli account di servizio. Questo aiuta a ridurre il rischio di perdita o riutilizzo del materiale delle chiavi.

**Secure VPC network configuration policies**

* **Define allowed external IPs for VM instances**: Impedisce la creazione di istanze Compute con un IP pubblico, che pu√≤ esporle al traffico internet.

<!---->

* **Disable VM nested virtualization**: Impedisce la creazione di VM nidificate su VM Compute Engine. Questo riduce il rischio di sicurezza di avere VM nidificate non monitorate.

<!---->

* **Disable VM serial port:** Impedisce l'accesso alla porta seriale delle VM Compute Engine. Questo impedisce l'input alla porta seriale di un server utilizzando l'API Compute Engine.

<!---->

* **Restrict authorized networks on Cloud SQL instances:** Impedisce che intervalli di rete pubblici o non interni accedano ai tuoi database Cloud SQL.

<!---->

* **Restrict Protocol Forwarding Based on type of IP Address:** Impedisce l'inoltro del protocollo VM per indirizzi IP esterni.

<!---->

* **Restrict Public IP access on Cloud SQL instances:** Impedisce la creazione di istanze Cloud SQL con un IP pubblico, che pu√≤ esporle al traffico internet.

<!---->

* **Restrict shared VPC project lien removal:** Impedisce la cancellazione accidentale dei progetti host VPC condivisi.

<!---->

* **Sets the internal DNS setting for new projects to Zonal DNS Only:** Impedisce l'uso di un'impostazione DNS legacy che ha una disponibilit√† di servizio ridotta.

<!---->

* **Skip default network creation:** Impedisce la creazione automatica della rete VPC predefinita e delle risorse correlate. Questo evita regole firewall predefinite eccessivamente permissive.

<!---->

* **Disable VPC External IPv6 usage:** Impedisce la creazione di subnet IPv6 esterne, che possono essere esposte ad accessi internet non autorizzati.

</details>

## **IAM Roles**

Questi sono come le politiche IAM in AWS poich√© **ogni ruolo contiene un insieme di permessi.**

Tuttavia, a differenza di AWS, non esiste **un repository centralizzato** di ruoli. Invece, **le risorse danno X ruoli di accesso a Y principali**, e l'unico modo per scoprire chi ha accesso a una risorsa √® usare il **metodo `get-iam-policy` su quella risorsa**.\
Questo potrebbe essere un problema perch√© significa che l'unico modo per scoprire **quali permessi ha un principale √® chiedere a ogni risorsa a chi sta dando permessi**, e un utente potrebbe non avere i permessi per ottenere permessi da tutte le risorse.

Ci sono **tre tipi** di ruoli in IAM:

* **Basic/Primitive roles**, che includono i ruoli **Owner**, **Editor**, e **Viewer** che esistevano prima dell'introduzione di IAM.
* **Predefined roles**, che forniscono accesso granulare per un servizio specifico e sono gestiti da Google Cloud. Ci sono molti ruoli predefiniti, puoi **vederli tutti con i privilegi che hanno** [**qui**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles).
* **Custom roles**, che forniscono accesso granulare secondo un elenco di permessi specificato dall'utente.

Ci sono migliaia di permessi in GCP. Per verificare se un ruolo ha un permesso puoi [**cercare il permesso qui**](https://cloud.google.com/iam/docs/permissions-reference) e vedere quali ruoli lo hanno.

Puoi anche [**cercare qui ruoli predefiniti**](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation) **offerti da ciascun prodotto.** Nota che alcuni **ruoli** non possono essere assegnati agli utenti e **solo agli SAs a causa di alcuni permessi** che contengono.\
Inoltre, nota che **i permessi** avranno effetto solo **se sono assegnati al servizio rilevante.**

Oppure verifica se un **ruolo personalizzato pu√≤ usare un** [**permesso specifico qui**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**.**

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## Users <a href="#default-credentials" id="default-credentials"></a>

Nella **console GCP** non c'√® **alcuna gestione di Utenti o Gruppi**, questo viene fatto in **Google Workspace**. Tuttavia, potresti sincronizzare un diverso provider di identit√† in Google Workspace.

Puoi accedere agli **utenti e gruppi di Workspaces in** [**https://admin.google.com**](https://admin.google.com/).

**MFA** pu√≤ essere **forzata** agli utenti di Workspaces, tuttavia, un **attaccante** potrebbe usare un token per accedere a GCP **via cli che non sar√† protetto da MFA** (sar√† protetto da MFA solo quando l'utente effettua il login per generarlo: `gcloud auth login`).

## Groups

Quando viene creata un'organizzazione, √® **fortemente consigliato creare diversi gruppi.** Se gestisci uno di essi potresti aver compromesso tutta o una parte importante dell'organizzazione:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Group</strong></td><td><strong>Function</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(group or individual accounts required for checklist)</em></td><td>Amministrare qualsiasi risorsa che appartiene all'organizzazione. Assegna questo ruolo con parsimonia; gli amministratori dell'organizzazione hanno accesso a tutte le risorse di Google Cloud. In alternativa, poich√© questa funzione √® altamente privilegiata, considera l'uso di account individuali invece di creare un gruppo.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(required for checklist)</em></td><td>Creare reti, subnet, regole firewall e dispositivi di rete come Cloud Router, Cloud VPN e bilanciatori di carico cloud.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(required for checklist)</em></td><td>Configurare account di fatturazione e monitorare il loro utilizzo.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(required for checklist)</em></td><td>Progettare, codificare e testare applicazioni.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Stabilire e gestire le politiche di sicurezza per l'intera organizzazione, inclusa la gestione degli accessi e le <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">politiche di vincolo dell'organizzazione</a>. Vedi la <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">guida alle fondamenta della sicurezza di Google Cloud</a> per maggiori informazioni sulla pianificazione della tua infrastruttura di sicurezza Google Cloud.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Creare o gestire pipeline end-to-end che supportano l'integrazione continua e la consegna, il monitoraggio e la fornitura di sistemi.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(no longer by default)</em></td><td>Monitorare la spesa sui progetti. I membri tipici fanno parte del team finanziario.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(no longer by default)</em></td><td>Rivedere le informazioni sulle risorse in tutta l'organizzazione Google Cloud.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(no longer by default)</em></td><td>Rivedere la sicurezza del cloud.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(no longer by default)</em></td><td>Rivedere le configurazioni di rete.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(no longer by default)</em></td><td>Visualizzare i log di audit.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(no longer by default)</em></td><td>Amministrare il Security Command Center.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(no longer by default)</em></td><td>Gestire i segreti in Secret Manager.</td></tr></tbody></table>

## **Default Password Policy**

* Imporre password forti
* Tra 8 e 100 caratteri
* Nessun riutilizzo
* Nessuna scadenza
* Se le persone accedono a Workspace tramite un provider di terze parti, questi requisiti non si applicano.

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Service accounts**

Questi sono i principali che **le risorse** possono **avere** **allegati** e accedere per interagire facilmente con GCP. Ad esempio, √® possibile accedere al **token di autenticazione** di un Service Account **allegato a una VM** nei metadati.\
√à possibile incontrare alcuni **conflitti** quando si utilizzano sia **IAM che access scopes**. Ad esempio, il tuo account di servizio potrebbe avere il ruolo IAM di `compute.instanceAdmin` ma l'istanza che hai violato √® stata limitata con la limitazione dello scope di `https://www.googleapis.com/auth/compute.readonly`. Questo ti impedirebbe di apportare modifiche utilizzando il token OAuth assegnato automaticamente alla tua istanza.

√à simile ai **ruoli IAM di AWS**. Ma a differenza di AWS, **qualsiasi** account di servizio pu√≤ essere **allegato a qualsiasi servizio** (non √® necessario consentirlo tramite una policy).

Molti degli account di servizio che troverai sono in realt√† **generati automaticamente da GCP** quando inizi a utilizzare un servizio, come:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Tuttavia, √® anche possibile creare e collegare alle risorse **custom service accounts**, che appariranno cos√¨:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Access scopes**

Gli access scope sono **allegati ai token OAuth generati** per accedere agli endpoint API di GCP. **Limitano i permessi** del token OAuth.\
Ci√≤ significa che se un token appartiene a un Proprietario di una risorsa ma non ha nel token lo scope per accedere a quella risorsa, il token **non pu√≤ essere utilizzato per (ab)usare quei privilegi**.

Google in realt√† [raccomanda](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) che **gli access scope non siano utilizzati e di fare affidamento totalmente su IAM**. Il portale di gestione web in realt√† impone questo, ma gli access scope possono ancora essere applicati alle istanze utilizzando account di servizio personalizzati programmaticamente.

Puoi vedere quali **scope** sono **assegnati** **interrogando:**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

I precedenti **scopes** sono quelli generati di **default** utilizzando **`gcloud`** per accedere ai dati. Questo perch√© quando si utilizza **`gcloud`** si crea prima un token OAuth e poi lo si utilizza per contattare gli endpoint.

Lo scope pi√π importante tra questi potenzialmente √® **`cloud-platform`**, che fondamentalmente significa che √® possibile **accedere a qualsiasi servizio in GCP**.

Puoi **trovare un elenco di** [**tutti i possibili scopes qui**](https://developers.google.com/identity/protocols/googlescopes)**.**

Se hai le credenziali del browser **`gcloud`**, √® possibile **ottenere un token con altri scopes,** facendo qualcosa del genere:

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform IAM Policies, Bindings and Memberships**

Come definito da terraform in [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam) utilizzando terraform con GCP ci sono diversi modi per concedere a un principal l'accesso a una risorsa:

* **Memberships**: Si impostano **principals come membri di ruoli** **senza restrizioni** sul ruolo o sui principals. √à possibile mettere un utente come membro di un ruolo e poi mettere un gruppo come membro dello stesso ruolo e anche impostare quei principals (utente e gruppo) come membri di altri ruoli.
* **Bindings**: Diversi **principals possono essere associati a un ruolo**. Quei **principals possono ancora essere associati o essere membri di altri ruoli**. Tuttavia, se un principal che non √® associato al ruolo √® impostato come **membro di un ruolo associato**, la prossima volta che **l'associazione viene applicata, l'appartenenza scomparir√†**.
* **Policies**: Una policy √® **autoritativa**, indica ruoli e principals e quindi, **quei principals non possono avere pi√π ruoli e quei ruoli non possono avere pi√π principals** a meno che quella policy non venga modificata (nemmeno in altre policies, bindings o memberships). Pertanto, quando un ruolo o un principal √® specificato in una policy tutti i suoi privilegi sono **limitati da quella policy**. Ovviamente, questo pu√≤ essere bypassato nel caso in cui al principal venga data l'opzione di modificare la policy o i permessi di escalation dei privilegi (come creare un nuovo principal e associargli un nuovo ruolo).

## Riferimenti

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}
