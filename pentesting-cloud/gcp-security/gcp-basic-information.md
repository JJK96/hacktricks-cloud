# GCP - Osnovne Informacije

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## **Hijerarhija resursa**

Google Cloud koristi [Hijerarhiju resursa](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) koja je konceptualno slična tradicionalnom fajl sistemu. Ovo pruža logičan workflow roditelj/dete sa specifičnim tačkama za pridruživanje politika i dozvola.

Na visokom nivou, izgleda ovako:
```
Organization
--> Folders
--> Projects
--> Resources
```
Virtuelna mašina (nazvana Compute Instance) je resurs. Resurs se nalazi u projektu, verovatno zajedno sa drugim Compute Instances, skladišnim bucket-ima, itd.

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption><p><a href="https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg">https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg</a></p></figcaption></figure>

## **Migracija Projekata**

Moguće je **migrirati projekat bez organizacije** u organizaciju sa dozvolama `roles/resourcemanager.projectCreator` i `roles/resourcemanager.projectMover`. Ako je projekat unutar druge organizacije, potrebno je kontaktirati GCP podršku da bi se **prvo premestio iz organizacije**. Za više informacija pogledajte [**ovde**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Organizacione Politike**

Omogućavaju centralizovanu kontrolu nad cloud resursima vaše organizacije:

* Centralizujte kontrolu da **konfigurišete ograničenja** na način na koji se resursi vaše organizacije mogu koristiti.
* Definišite i uspostavite **zaštitne ograde** za vaše razvojne timove kako bi ostali unutar granica usklađenosti.
* Pomozite vlasnicima projekata i njihovim timovima da se brzo kreću bez brige o kršenju usklađenosti.

Ove politike mogu biti kreirane da **utiču na celu organizaciju, folder(e) ili projekat(e)**. Potomci ciljanog čvora hijerarhije resursa **nasleđuju organizacionu politiku**.

Da biste **definisali** organizacionu politiku, **birate** [**ograničenje**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), što je određena vrsta ograničenja protiv Google Cloud servisa ili grupe Google Cloud servisa. **Konfigurišete to ograničenje sa željenim restrikcijama**.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption><p><a href="https://cloud.google.com/resource-manager/img/org-policy-concepts.svg">https://cloud.google.com/resource-manager/img/org-policy-concepts.svg</a></p></figcaption></figure>

#### Uobičajeni slučajevi upotrebe <a href="#common_use_cases" id="common_use_cases"></a>

* Ograničite deljenje resursa na osnovu domena.
* Ograničite upotrebu Identity and Access Management servisnih naloga.
* Ograničite fizičku lokaciju novokreiranih resursa.
* Onemogućite kreiranje servisnih naloga.

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

Postoji mnogo više ograničenja koja vam daju detaljnu kontrolu nad resursima vaše organizacije. Za **više informacija, pogledajte** [**listu svih ograničenja Organizacione Politike**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

### **Podrazumevane Organizacione Politike**

<details>

<summary>Ovo su politike koje Google dodaje po defaultu prilikom postavljanja vaše GCP organizacije:</summary>

**Politike Upravljanja Pristupom**

* **Kontakti ograničeni na domen:** Sprečava dodavanje korisnika u Essential Contacts van vaših specificiranih domena. Ovo ograničava Essential Contacts da dozvoljava samo upravljane korisničke identitete u vašim odabranim domenima da primaju platformske notifikacije.
* **Deljenje ograničeno na domen:** Sprečava dodavanje korisnika u IAM politike van vaših specificiranih domena. Ovo ograničava IAM politike da dozvoljavaju samo upravljane korisničke identitete u vašim odabranim domenima da pristupaju resursima unutar ove organizacije.
* **Sprečavanje javnog pristupa:** Sprečava Cloud Storage bucket-e da budu izloženi javnosti. Ovo osigurava da programer ne može konfigurisati Cloud Storage bucket-e za neautentifikovani internet pristup.
* **Uniformni pristup na nivou bucket-a:** Sprečava liste kontrole pristupa (ACLs) na nivou objekata u Cloud Storage bucket-ima. Ovo pojednostavljuje vaše upravljanje pristupom primenom IAM politika dosledno na sve objekte u Cloud Storage bucket-ima.
* **Zahtevaj OS prijavu:** VM-ovi kreirani u novim projektima će imati OS Login omogućen. Ovo vam omogućava da upravljate SSH pristupom vašim instancama koristeći IAM bez potrebe za kreiranjem i upravljanjem pojedinačnim SSH ključevima.

**Dodatne sigurnosne politike za servisne naloge**

* **Onemogući automatske IAM dozvole:** Sprečava da podrazumevani App Engine i Compute Engine servisni nalozi automatski dobiju Editor IAM ulogu na projektu prilikom kreiranja. Ovo osigurava da servisni nalozi ne dobiju previše permisivne IAM uloge prilikom kreiranja.
* **Onemogući kreiranje ključeva servisnih naloga:** Sprečava kreiranje javnih ključeva servisnih naloga. Ovo pomaže u smanjenju rizika od izlaganja trajnih akreditiva.
* **Onemogući upload ključeva servisnih naloga:** Sprečava upload javnih ključeva servisnih naloga. Ovo pomaže u smanjenju rizika od curenja ili ponovne upotrebe ključnog materijala.

**Politike sigurne konfiguracije VPC mreže**

* **Definiši dozvoljene eksterne IP adrese za VM instance:** Sprečava kreiranje Compute instanci sa javnim IP-om, što ih može izložiti internet saobraćaju.

<!---->

* **Onemogući VM nested virtualizaciju:** Sprečava kreiranje nested VM-ova na Compute Engine VM-ovima. Ovo smanjuje sigurnosni rizik od neproverenih nested VM-ova.

<!---->

* **Onemogući VM serijski port:** Sprečava pristup serijskom portu Compute Engine VM-ova. Ovo sprečava unos na serijski port servera koristeći Compute Engine API.

<!---->

* **Ograniči autorizovane mreže na Cloud SQL instancama:** Sprečava javne ili ne-internalne mrežne opsege da pristupaju vašim Cloud SQL bazama podataka.

<!---->

* **Ograniči prosleđivanje protokola na osnovu tipa IP adrese:** Sprečava VM prosleđivanje protokola za eksterne IP adrese.

<!---->

* **Ograniči javni IP pristup na Cloud SQL instancama:** Sprečava kreiranje Cloud SQL instanci sa javnim IP-om, što ih može izložiti internet saobraćaju.

<!---->

* **Ograniči uklanjanje Shared VPC projekta:** Sprečava slučajno brisanje Shared VPC host projekata.

<!---->

* **Postavlja internu DNS postavku za nove projekte na Zonal DNS Only:** Sprečava upotrebu zastarele DNS postavke koja ima smanjenu dostupnost usluge.

<!---->

* **Preskoči kreiranje podrazumevane mreže:** Sprečava automatsko kreiranje podrazumevane VPC mreže i povezanih resursa. Ovo izbegava previše permisivna podrazumevana firewall pravila.

<!---->

* **Onemogući VPC eksternu IPv6 upotrebu:** Sprečava kreiranje eksternih IPv6 subnet-ova, koji mogu biti izloženi neovlašćenom internet pristupu.

</details>

## **IAM Uloge**

Ovo su kao IAM politike u AWS-u jer **svaka uloga sadrži set dozvola.**

Međutim, za razliku od AWS-a, ne postoji **centralizovani repo** uloga. Umesto toga, **resursi daju X pristupne uloge Y principalima**, i jedini način da se sazna ko ima pristup resursu je korišćenje **`get-iam-policy` metode nad tim resursom**.\
Ovo može biti problem jer to znači da je jedini način da se sazna **koje dozvole principal ima da se pita svaki resurs kome daje dozvole**, a korisnik možda nema dozvole da dobije dozvole od svih resursa.

Postoje **tri tipa** uloga u IAM:

* **Osnovne/Primitivne uloge**, koje uključuju **Owner**, **Editor**, i **Viewer** uloge koje su postojale pre uvođenja IAM-a.
* **Predefinisane uloge**, koje pružaju granularni pristup za specifičnu uslugu i upravlja ih Google Cloud. Postoji mnogo predefinisanih uloga, možete **videti sve sa privilegijama koje imaju** [**ovde**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles).
* **Prilagođene uloge**, koje pružaju granularni pristup prema listi dozvola koju je korisnik odredio.

Postoje hiljade dozvola u GCP-u. Da biste proverili da li uloga ima dozvolu možete [**pretražiti dozvolu ovde**](https://cloud.google.com/iam/docs/permissions-reference) i videti koje uloge je imaju.

Takođe možete [**pretražiti ovde predefinisane uloge**](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation) **koje nudi svaki proizvod.** Imajte na umu da neke **uloge** ne mogu biti dodeljene korisnicima i **samo SA-ovima zbog nekih dozvola** koje sadrže.\
Takođe, imajte na umu da **dozvole** će **stupiti na snagu** samo ako su **dodeljene relevantnoj usluzi.**

Ili proverite da li **prilagođena uloga može koristiti** [**specifičnu dozvolu ovde**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**.**

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## Korisnici <a href="#default-credentials" id="default-credentials"></a>

U **GCP konzoli** nema **upravljanja Korisnicima ili Grupama**, to se radi u **Google Workspace**. Iako možete sinhronizovati drugog provajdera identiteta u Google Workspace.

Možete pristupiti Workspaces **korisnicima i grupama na** [**https://admin.google.com**](https://admin.google.com/).

**MFA** može biti **forsiran** za Workspaces korisnike, međutim, **napadač** može koristiti token za pristup GCP **preko cli koji neće biti zaštićen MFA-om** (biće zaštićen MFA-om samo kada se korisnik prijavi da ga generiše: `gcloud auth login`).

## Grupe

Kada se kreira organizacija, nekoliko grupa je **snažno preporučeno da se kreira.** Ako upravljate bilo kojom od njih, možda ste kompromitovali celu ili važan deo organizacije:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Grupa</strong></td><td><strong>Funkcija</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(grupa ili pojedinačni nalozi potrebni za checklistu)</em></td><td>Upravljanje bilo kojim resursom koji pripada organizaciji. Dodelite ovu ulogu štedljivo; org admini imaju pristup svim vašim Google Cloud resursima. Alternativno, zbog visoke privilegovanosti ove funkcije, razmislite o korišćenju pojedinačnih naloga umesto kreiranja grupe.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(potrebno za checklistu)</em></td><td>Kreiranje mreža, subnet-ova, firewall pravila i mrežnih uređaja kao što su Cloud Router, Cloud VPN i cloud load balanceri.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(potrebno za checklistu)</em></td><td>Postavljanje billing naloga i praćenje njihove upotrebe.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(potrebno za checklistu)</em></td><td>Dizajniranje, kodiranje i testiranje aplikacija.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Uspostavljanje i upravljanje sigurnosnim politikama za celu organizaciju, uključujući upravljanje pristupom i <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">organizacione ograničavajuće politike</a>. Pogledajte <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">Google Cloud vodič za sigurnosne osnove</a> za više informacija o planiranju vaše Google Cloud sigurnosne infrastrukture.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Kreiranje ili upravljanje end-to-end pipeline-ima koji podržavaju kontinuiranu integraciju i isporuku, praćenje i provisioniranje sistema.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(više nije po defaultu)</em></td><td>Praćenje troškova na projektima. Tipični članovi su deo finansijskog tima.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(više nije po defaultu)</em></td><td>Pregled informacija o resursima širom Google Cloud organizacije.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(više nije po defaultu)</em></td><td>Pregled cloud sigurnosti.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(više nije po defaultu)</em></td><td>Pregled mrežnih konfiguracija.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(više nije po defaultu)</em></td><td>Pregled audit logova.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(više nije po defaultu)</em></td><td>Upravljanje Security Command Center-om.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(više nije po defaultu)</em></td><td>Upravljanje tajnama u Secret Manager-u.</td></tr></tbody></table>

## **Podrazumevana Politika Lozinki**

* Primeni jake lozinke
* Između 8 i 100 karaktera
* Bez ponovne upotrebe
* Bez isteka
* Ako ljudi pristupaju Workspace-u preko trećeg provajdera, ovi zahtevi se ne primenjuju.

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Servisni nalozi**

Ovo su principi koje **resursi** mogu **imati** **prikačene** i pristup za lako interagovanje sa GCP-om. Na primer, moguće je pristupiti **auth token-u** servisnog naloga **prikačenog na VM** u metapodacima.\
Moguće je naići na neke **sukobe** kada se koriste i **IAM i pristupni opsezi**. Na primer, vaš servisni nalog može imati IAM ulogu `compute.instanceAdmin` ali instanca koju ste kompromitovali je ograničena sa opsegom `https://www.googleapis.com/auth/compute.readonly`. Ovo bi vas sprečilo da pravite bilo kakve promene koristeći OAuth token koji je automatski dodeljen vašoj instanci.

Slično je **IAM ulogama iz AWS-a**. Ali za razliku od AWS-a, **bilo koji** servisni nalog može biti **prikačen na bilo koju uslugu** (ne mora to dozvoliti putem politike).

Nekoliko servisnih naloga koje ćete pronaći su zapravo **automatski generisani od strane GCP-a** kada počnete koristiti uslugu, kao:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Međutim, takođe je moguće kreirati i povezati resurse sa **prilagođenim servisnim nalozima**, koji će izgledati ovako:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Access scopes**

Access scope su **prikačeni generisanim OAuth tokenima** za pristup GCP API krajnjim tačkama. Oni **ograničavaju dozvole** OAuth tokena.\
To znači da ako token pripada Vlasniku resursa, ali nema u opsegu tokena pristup tom resursu, token **ne može biti korišćen za (zlo)upotrebu tih privilegija**.

Google zapravo [preporučuje](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) da se **access scope ne koriste i da se potpuno oslanja na IAM**. Web portal za upravljanje zapravo to i sprovodi, ali access scope se i dalje mogu primeniti na instance koristeći prilagođene service accounts programski.

Možete videti koji su **scope-ovi** **dodeljeni** **upitom:**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Prethodni **scopes** su oni generisani **podrazumevano** koristeći **`gcloud`** za pristup podacima. Ovo je zato što kada koristite **`gcloud`**, prvo kreirate OAuth token, a zatim ga koristite za kontaktiranje krajnjih tačaka.

Najvažniji scope od tih potencijalno je **`cloud-platform`**, što u suštini znači da je moguće **pristupiti bilo kojoj usluzi u GCP-u**.

Možete **pronaći listu svih mogućih scope-ova ovde** [**all the possible scopes in here**](https://developers.google.com/identity/protocols/googlescopes)**.**

Ako imate **`gcloud`** kredencijale za pretraživač, moguće je **dobiti token sa drugim scope-ovima**, radeći nešto poput:

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform IAM Policies, Bindings and Memberships**

Kao što je definisano od strane terraform-a u [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam) koristeći terraform sa GCP-om postoje različiti načini da se principalu dodeli pristup resursu:

* **Memberships**: Postavljate **principale kao članove uloga** **bez ograničenja** na ulogu ili principale. Možete postaviti korisnika kao člana uloge, a zatim postaviti grupu kao člana iste uloge i takođe postaviti te principale (korisnika i grupu) kao članove drugih uloga.
* **Bindings**: Nekoliko **principala može biti vezano za ulogu**. Ti **principali i dalje mogu biti vezani ili biti članovi drugih uloga**. Međutim, ako principal koji nije vezan za ulogu bude postavljen kao **član vezane uloge**, sledeći put kada se **veza primeni, članstvo će nestati**.
* **Policies**: Politika je **autoritarna**, ona označava uloge i principale i tada, **ti principi ne mogu imati više uloga i te uloge ne mogu imati više principala** osim ako se ta politika ne izmeni (čak ni u drugim politikama, vezama ili članstvima). Dakle, kada je uloga ili principal specificiran u politici, sva njegova privilegija je **ograničena tom politikom**. Očigledno, ovo se može zaobići u slučaju da je principalu data opcija da izmeni politiku ili dozvole za eskalaciju privilegija (kao što je kreiranje novog principala i vezivanje za novu ulogu).

## References

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove podnošenjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
