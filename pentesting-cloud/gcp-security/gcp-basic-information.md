# GCP - Basic Information

{% hint style="success" %}
学习和练习 AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和练习 GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交 PRs 分享黑客技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库。

</details>
{% endhint %}

## **资源层次结构**

Google Cloud 使用一个 [资源层次结构](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)，概念上类似于传统的文件系统。这提供了一个逻辑上的父/子工作流，并为策略和权限提供了特定的附加点。

在高层次上，它看起来像这样：
```
Organization
--> Folders
--> Projects
--> Resources
```
虚拟机（称为 Compute Instance）是一种资源。资源位于项目中，可能与其他 Compute Instance、存储桶等一起存在。

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption><p><a href="https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg">https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg</a></p></figcaption></figure>

## **项目迁移**

在没有任何组织的情况下，可以通过具有 `roles/resourcemanager.projectCreator` 和 `roles/resourcemanager.projectMover` 权限的组织迁移项目。如果项目在其他组织内，则需要联系 GCP 支持以**首先将其移出组织**。更多信息请查看[**此处**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6)。

## **组织政策**

允许集中控制组织的云资源：

* 集中控制以**配置限制**，规定组织资源的使用方式。
* 定义和建立**护栏**，使开发团队在合规边界内工作。
* 帮助项目所有者及其团队快速行动，而无需担心违反合规性。

这些政策可以创建以**影响整个组织、文件夹或项目**。目标资源层次结构节点的后代**继承组织政策**。

为了**定义**组织政策，**你需要选择一个**[**约束**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints)，这是对 Google Cloud 服务或一组 Google Cloud 服务的特定类型的限制。你**根据所需的限制配置该约束**。

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption><p><a href="https://cloud.google.com/resource-manager/img/org-policy-concepts.svg">https://cloud.google.com/resource-manager/img/org-policy-concepts.svg</a></p></figcaption></figure>

#### 常见用例 <a href="#common_use_cases" id="common_use_cases"></a>

* 基于域限制资源共享。
* 限制 Identity and Access Management 服务账户的使用。
* 限制新创建资源的物理位置。
* 禁用服务账户创建。

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

还有许多其他约束可以对组织的资源进行细粒度控制。有关**更多信息，请参阅**[**所有组织政策服务约束的列表**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**。**

### **默认组织政策**

<details>

<summary>这些是 Google 在设置 GCP 组织时默认添加的政策：</summary>

**访问管理政策**

* **域限制联系人：** 防止将用户添加到指定域之外的 Essential Contacts。这限制了 Essential Contacts 仅允许选定域中的托管用户身份接收平台通知。
* **域限制共享：** 防止将用户添加到指定域之外的 IAM 政策。这限制了 IAM 政策仅允许选定域中的托管用户身份访问组织内的资源。
* **公共访问预防：** 防止 Cloud Storage 存储桶暴露给公众。这确保开发人员无法配置 Cloud Storage 存储桶以进行未经身份验证的互联网访问。
* **统一存储桶级别访问：** 防止 Cloud Storage 存储桶中的对象级访问控制列表（ACL）。这通过在 Cloud Storage 存储桶中的所有对象上始终如一地应用 IAM 政策来简化访问管理。
* **要求 OS 登录：** 在新项目中创建的 VM 将启用 OS 登录。这使你可以使用 IAM 管理对实例的 SSH 访问，而无需创建和管理单独的 SSH 密钥。

**服务账户的其他安全政策**

* **禁用自动 IAM 授权：** 防止默认的 App Engine 和 Compute Engine 服务账户在创建项目时自动获得 Editor IAM 角色。这确保服务账户在创建时不会获得过于宽泛的 IAM 角色。
* **禁用服务账户密钥创建：** 防止创建公共服务账户密钥。这有助于减少暴露持久凭证的风险。
* **禁用服务账户密钥上传：** 防止上传公共服务账户密钥。这有助于减少泄露或重复使用密钥材料的风险。

**安全 VPC 网络配置政策**

* **定义 VM 实例的允许外部 IP：** 防止创建具有公共 IP 的 Compute 实例，这可能会将其暴露给互联网流量。

<!---->

* **禁用 VM 嵌套虚拟化：** 防止在 Compute Engine VM 上创建嵌套 VM。这减少了未监控嵌套 VM 带来的安全风险。

<!---->

* **禁用 VM 串行端口：** 防止对 Compute Engine VM 的串行端口访问。这防止通过 Compute Engine API 向服务器的串行端口输入。

<!---->

* **限制 Cloud SQL 实例上的授权网络：** 防止公共或非内部网络范围访问 Cloud SQL 数据库。

<!---->

* **基于 IP 地址类型限制协议转发：** 防止 VM 协议转发外部 IP 地址。

<!---->

* **限制 Cloud SQL 实例上的公共 IP 访问：** 防止创建具有公共 IP 的 Cloud SQL 实例，这可能会将其暴露给互联网流量。

<!---->

* **限制共享 VPC 项目留置删除：** 防止意外删除共享 VPC 主机项目。

<!---->

* **将新项目的内部 DNS 设置为仅区域 DNS：** 防止使用服务可用性较低的旧版 DNS 设置。

<!---->

* **跳过默认网络创建：** 防止自动创建默认 VPC 网络及相关资源。这避免了过于宽泛的默认防火墙规则。

<!---->

* **禁用 VPC 外部 IPv6 使用：** 防止创建外部 IPv6 子网，这可能会暴露给未经授权的互联网访问。

</details>

## **IAM 角色**

这些类似于 AWS 中的 IAM 政策，因为**每个角色包含一组权限。**

然而，与 AWS 不同的是，没有**集中存储库**来存储角色。相反，**资源为 Y 主体提供 X 访问角色**，唯一的方法是使用**`get-iam-policy` 方法获取该资源的权限**。\
这可能是一个问题，因为这意味着唯一的方法是**询问每个资源它授予了哪些权限**，而用户可能没有权限从所有资源获取权限。

IAM 中有**三种类型**的角色：

* **基本/原始角色**，包括在引入 IAM 之前存在的**所有者**、**编辑者**和**查看者**角色。
* **预定义角色**，为特定服务提供细粒度访问权限，由 Google Cloud 管理。有很多预定义角色，你可以**在此处查看它们的所有权限**[**这里**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles)。
* **自定义角色**，根据用户指定的权限列表提供细粒度访问权限。

GCP 中有成千上万的权限。为了检查某个角色是否具有某个权限，你可以[**在此处搜索权限**](https://cloud.google.com/iam/docs/permissions-reference)并查看哪些角色具有该权限。

你还可以[**在此处搜索预定义角色**](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation)**，由每个产品提供。**请注意，某些**角色**不能附加到用户，**只能附加到 SAs，因为它们包含某些权限**。\
此外，请注意，**权限**只有在**附加到相关服务时**才会**生效**。

或者检查**自定义角色是否可以使用**[**特定权限在这里**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**。**

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## 用户 <a href="#default-credentials" id="default-credentials"></a>

在**GCP 控制台**中没有**用户或组**管理，这是在**Google Workspace**中完成的。尽管你可以在 Google Workspace 中同步不同的身份提供者。

你可以访问 Workspaces **用户和组在**[**https://admin.google.com**](https://admin.google.com/)。

**MFA** 可以**强制** Workspaces 用户使用，但**攻击者**可以使用令牌通过 cli 访问 GCP **，这不会受到 MFA 保护**（只有当用户登录生成它时才会受到 MFA 保护：`gcloud auth login`）。

## 组

当创建一个组织时，强烈建议创建几个组。如果你管理其中任何一个，你可能已经妥协了整个或重要部分的组织：

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>组</strong></td><td><strong>功能</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>（检查表所需的组或个人账户）</em></td><td>管理属于组织的任何资源。谨慎分配此角色；组织管理员可以访问所有 Google Cloud 资源。或者，由于此功能权限很高，考虑使用个人账户而不是创建组。</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>（检查表所需）</em></td><td>创建网络、子网、防火墙规则和网络设备，如 Cloud Router、Cloud VPN 和云负载均衡器。</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>（检查表所需）</em></td><td>设置计费账户并监控其使用情况。</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>（检查表所需）</em></td><td>设计、编码和测试应用程序。</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>为整个组织建立和管理安全政策，包括访问管理和<a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">组织约束政策</a>。有关规划 Google Cloud 安全基础设施的更多信息，请参阅<a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">Google Cloud 安全基础指南</a>。</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>创建或管理支持持续集成和交付、监控和系统配置的端到端管道。</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>（不再默认）</em></td><td>监控项目的支出。典型成员是财务团队的一部分。</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>（不再默认）</em></td><td>审查 Google Cloud 组织中的资源信息。</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>（不再默认）</em></td><td>审查云安全。</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>（不再默认）</em></td><td>审查网络配置。</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>（不再默认）</em></td><td>查看审计日志。</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>（不再默认）</em></td><td>管理安全指挥中心。</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>（不再默认）</em></td><td>管理 Secret Manager 中的秘密。</td></tr></tbody></table>

## **默认密码政策**

* 强制使用强密码
* 长度在 8 到 100 个字符之间
* 不允许重复使用
* 无到期时间
* 如果通过第三方提供商访问 Workspace，这些要求不适用。

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **服务账户**

这些是**资源**可以**附加**并访问以便与 GCP 轻松交互的主体。例如，可以在元数据中访问**附加到 VM 的服务账户**的**身份验证令牌**。\
使用**IAM 和访问范围**时可能会遇到一些**冲突**。例如，你的服务账户可能具有 `compute.instanceAdmin` 的 IAM 角色，但你入侵的实例被限制为 `https://www.googleapis.com/auth/compute.readonly` 的范围。这将阻止你使用自动分配给实例的 OAuth 令牌进行任何更改。

这类似于**AWS 的 IAM 角色**。但与 AWS 不同，**任何**服务账户都可以**附加到任何服务**（不需要通过策略允许）。

你会发现的几个服务账户实际上是**当你开始使用某个服务时由 GCP 自动生成的**，例如：
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
然而，也可以创建和附加到资源**自定义服务账户**，其形式如下：
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Access scopes**

访问范围是**附加到生成的OAuth令牌**以访问GCP API端点。它们**限制了OAuth令牌的权限**。\
这意味着如果一个令牌属于资源的所有者，但在令牌范围内没有访问该资源的权限，则该令牌**不能用于（滥用）这些特权**。

谷歌实际上[建议](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) **不要使用访问范围，而完全依赖IAM**。Web管理门户实际上强制执行这一点，但访问范围仍然可以通过编程方式应用于使用自定义服务帐户的实例。

你可以通过**查询**来查看**分配的** **范围**：

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

前面的 **scopes** 是使用 **`gcloud`** 访问数据时 **默认** 生成的。这是因为当你使用 **`gcloud`** 时，首先会创建一个 OAuth 令牌，然后使用它来联系端点。

其中最重要的 scope 可能是 **`cloud-platform`**，这基本上意味着可以 **访问 GCP 中的任何服务**。

你可以 **在这里找到所有可能的 scopes 列表** [**all the possible scopes in here**](https://developers.google.com/identity/protocols/googlescopes)**.**

如果你有 **`gcloud`** 浏览器凭证，可以通过以下方式 **获取具有其他 scopes 的令牌**：

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform IAM Policies, Bindings and Memberships**

根据terraform在[https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam)中的定义，使用terraform与GCP时，有不同的方法授予主体对资源的访问权限：

* **Memberships**: 你可以将**主体设置为角色的成员**，**没有对角色或主体的限制**。你可以将一个用户设置为一个角色的成员，然后将一个组设置为同一角色的成员，并且还可以将这些主体（用户和组）设置为其他角色的成员。
* **Bindings**: 多个**主体可以绑定到一个角色**。这些**主体仍然可以绑定或成为其他角色的成员**。然而，如果一个未绑定到该角色的主体被设置为**绑定角色的成员**，那么下次**应用绑定时，该成员关系将消失**。
* **Policies**: 策略是**权威性的**，它指示角色和主体，然后，**这些主体不能拥有更多的角色，这些角色也不能拥有更多的主体**，除非该策略被修改（即使在其他策略、绑定或成员关系中也不行）。因此，当策略中指定了角色或主体时，其所有权限都**受该策略限制**。显然，如果主体被赋予修改策略或权限升级的权限（如创建一个新主体并将其绑定到一个新角色），这可以被绕过。

## References

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)

{% hint style="success" %}
学习和练习AWS Hacking：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和练习GCP Hacking：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持HackTricks</summary>

* 查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交PR分享黑客技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库。

</details>
{% endhint %}
