# GCP - Artifact Registry Persistence

{% hint style="success" %}
AWS 해킹 학습 및 실습:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP 해킹 학습 및 실습: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원</summary>

* [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) 깃헙 저장소에 PR을 제출하여 해킹 요령을 공유하세요.

</details>
{% endhint %}

## Artifact Registry

Artifact Registry에 대한 자세한 정보는 다음을 확인하세요:

{% content-ref url="../gcp-services/gcp-artifact-registry-enum.md" %}
[gcp-artifact-registry-enum.md](../gcp-services/gcp-artifact-registry-enum.md)
{% endcontent-ref %}

### 의존성 혼란

* **가상** 저장소에 **원격 및 표준** 저장소가 **혼합**되어 있고 패키지가 둘 다 존재하는 경우에는 무엇이 발생합니까?
* **가상 저장소에서 우선순위가 가장 높게 설정된 것**이 사용됩니다.
* **우선순위가 동일한 경우**:
* **버전**이 **동일한 경우**, 가상 저장소에서 알파벳순으로 먼저 나오는 정책 이름이 사용됩니다.
* 그렇지 않으면 **가장 높은 버전**이 사용됩니다.

{% hint style="danger" %}
따라서 원격 저장소가 더 높거나 동일한 우선순위를 가지는 경우 **가장 높은 버전(의존성 혼란)**을 공개 패키지 레지스트리에서 남용할 수 있습니다.
{% endhint %}

이 기술은 **지속성** 및 **인증되지 않은 액세스**에 유용할 수 있으며, 이를 남용하기 위해서는 Artifact Registry에 저장된 **라이브러리 이름을 알아야**하고 **동일한 라이브러리를 공개 저장소 (예: Python의 PyPi)에 더 높은 버전으로 생성**하면 됩니다.

지속성을 위해 수행해야 할 단계는 다음과 같습니다:

* **요구 사항**: **가상 저장소**가 **존재**하고 사용 중이어야 하며, **공개 저장소에 존재하지 않는 이름을 가진 내부 패키지**를 사용해야 합니다.
* 원격 저장소를 만들지 않은 경우 생성
* 원격 저장소를 가상 저장소에 추가
* 가상 레지스트리의 정책을 편집하여 원격 저장소에 더 높은 우선순위 (또는 동일한)를 부여합니다.\
다음과 같이 실행하세요:
* [gcloud artifacts repositories update --upstream-policy-file ...](https://cloud.google.com/sdk/gcloud/reference/artifacts/repositories/update#--upstream-policy-file)
* 정품 패키지를 다운로드하고 악성 코드를 추가하여 동일한 버전으로 공개 저장소에 등록합니다. 개발자가 설치할 때마다 해당 패키지가 설치됩니다!

의존성 혼란에 대한 자세한 정보는 다음을 확인하세요:

{% embed url="https://book.hacktricks.xyz/pentesting-web/dependency-confusion" %}

{% hint style="success" %}
AWS 해킹 학습 및 실습:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP 해킹 학습 및 실습: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원</summary>

* [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) 깃헙 저장소에 PR을 제출하여 해킹 요령을 공유하세요.

</details>
{% endhint %}
