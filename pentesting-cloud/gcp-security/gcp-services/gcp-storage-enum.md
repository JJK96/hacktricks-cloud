# GCP - Enumeracja magazynu

{% hint style="success" %}
Dowiedz się i ćwicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz się i ćwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plan subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostępniaj sztuczki hakowania, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Magazyn

Google Cloud Platform (GCP) Storage to **rozwiązanie przechowywania w chmurze**, które zapewnia bardzo trwałe i dostępne przechowywanie obiektów dla danych nieustrukturyzowanych. Oferuje **różne klasy przechowywania** oparte na wydajności, dostępności i kosztach, w tym Standard, Nearline, Coldline i Archive. GCP Storage zapewnia również zaawansowane funkcje takie jak **polityki cyklu życia, wersjonowanie i kontrola dostępu** do efektywnego zarządzania i zabezpieczania danych.

Wiadro można przechowywać w regionie, w 2 regionach lub **w wielu regionach (domyślnie)**.

### Typy przechowywania

* **Standardowe przechowywanie**: Jest to domyślna opcja przechowywania, która **zapewnia wysoką wydajność i niski dostęp o niskim opóźnieniu do często odwiedzanych danych**. Nadaje się do szerokiego zakresu zastosowań, w tym dostarczania treści na stronie internetowej, przesyłania mediów strumieniowych i hostowania potoków analizy danych.
* **Przechowywanie Nearline**: Ta klasa przechowywania oferuje **niższe koszty przechowywania** i **nieco wyższe koszty dostępu** niż Standardowe przechowywanie. Jest zoptymalizowana dla danych rzadko odwiedzanych, z minimalnym czasem przechowywania wynoszącym 30 dni. Nadaje się do celów archiwizacji i tworzenia kopii zapasowych.
* **Przechowywanie Coldline**: Ta klasa przechowywania jest zoptymalizowana dla **długoterminowego przechowywania rzadko odwiedzanych danych**, z minimalnym czasem przechowywania wynoszącym 90 dni. Oferuje **niższe koszty przechowywania** niż Przechowywanie Nearline, ale z **wyższymi kosztami dostępu**.
* **Przechowywanie Archive**: Ta klasa przechowywania jest przeznaczona dla zimnych danych, do których dostęp jest **bardzo rzadki**, z minimalnym czasem przechowywania wynoszącym 365 dni. Oferuje **najniższe koszty przechowywania ze wszystkich opcji przechowywania GCP**, ale z **najwyższymi kosztami dostępu**. Nadaje się do długoterminowego przechowywania danych, które muszą być przechowywane ze względów zgodności lub regulacyjnych.
* **Autoklasa**: Jeśli **nie wiesz, jak często będziesz uzyskiwać dostęp** do danych, możesz wybrać Autoklasę, a GCP **automatycznie zmieni typ przechowywania, aby zminimalizować koszty**.

### Kontrola dostępu

Domyślnie zaleca się kontrolowanie dostępu za pomocą **IAM**, ale można również **włączyć korzystanie z list ACL**.\
Jeśli wybierzesz korzystanie tylko z IAM (domyślnie) i **minie 90 dni**, nie będziesz mógł włączyć list ACL dla wiadra.

### Wersjonowanie

Można włączyć wersjonowanie, co spowoduje **zachowanie starych wersji plików wewnątrz wiadra**. Można skonfigurować **liczbę wersji, które chcesz zachować** oraz nawet **jak długo** mają **żyć nieaktualne** wersje (stare wersje). Zalecane jest **7 dni dla typu Standard**.

**Metadane nieaktualnej wersji są zachowywane**. Ponadto **listy ACL nieaktualnych wersji są również zachowywane**, więc starsze wersje mogą mieć inne listy ACL niż bieżąca wersja.

Dowiedz się więcej w [**dokumentacji**](https://cloud.google.com/storage/docs/object-versioning).

### Polityka retencji

Określ, jak **długo** chcesz **zakazać usuwania obiektów wewnątrz wiadra** (bardzo przydatne przynajmniej do celów zgodności).\
Tylko jedno z **wersjonowania lub polityki retencji może być włączone w tym samym czasie**.

### Szyfrowanie

Domyślnie obiekty są **szyfrowane za pomocą zarządzanych przez Google kluczy**, ale można również użyć **klucza z KMS**.

### Dostęp publiczny

Możliwe jest udostępnienie **zewnętrznym użytkownikom** (zalogowanym do GCP lub nie) **dostępu do zawartości wiadra**.\
Domyślnie, gdy wiadro jest tworzone, opcja **publicznego udostępniania wiadra jest wyłączona**, ale przy wystarczających uprawnieniach można ją zmienić.

**Format URL** do dostępu do wiadra to **`https://storage.googleapis.com/<nazwa-wiadra>` lub `https://<nazwa_wiadra>.storage.googleapis.com`** (oba są poprawne).

### Klucze HMAC

Klucz HMAC to rodzaj _poświadczenia_ i może być **powiązany z kontem usługi lub kontem użytkownika w Cloud Storage**. Używasz klucza HMAC do tworzenia _podpisów_, które są następnie dołączane do żądań do Cloud Storage. Podpisy pokazują, że **dane żądanie jest autoryzowane przez użytkownika lub konto usługi**.

Klucze HMAC mają dwie podstawowe części, _ID dostępu_ i _sekret_.

*   **ID dostępu**: Alfanumeryczny ciąg powiązany z określoną usługą lub kontem użytkownika. Gdy jest powiązany z kontem usługi, ciąg ma długość 61 znaków, a gdy jest powiązany z kontem użytkownika, ciąg ma długość 24 znaków. Poniżej przedstawiono przykład ID dostępu:

`GOOGTS7C7FUP3AIRVJTE2BCDKINBTES3HC2GY5CBFJDCQ2SYHV6A6XXVTJFSA`
*   **Sekret**: 40-znakowy zakodowany w Base-64 ciąg, który jest powiązany z określonym ID dostępu. Sekret to klucz uzgodniony wcześniej, który znają tylko ty i Cloud Storage. Używasz swojego sekretu do tworzenia podpisów w ramach procesu uwierzytelniania. Poniżej przedstawiono przykład sekretu:

`bGoa+V7g/yqDXvKRqq+JTFn4uQZbPiQJo4pf9RzJ`

Zarówno **ID dostępu, jak i sekret jednoznacznie identyfikują klucz HMAC**, ale sekret jest znacznie bardziej wrażliwą informacją, ponieważ jest używany do **tworzenia podpisów**.

### Wyliczanie
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -

# Enumerate HMAC keys
gsutil hmac list

# Get permissions
gcloud storage buckets get-iam-policy gs://bucket-name/
gcloud storage objects get-iam-policy gs://bucket-name/folder/object
```
Jeśli otrzymasz błąd odmowy uprawnień podczas wyświetlania kubełków, nadal możesz mieć dostęp do zawartości. Teraz, kiedy znasz konwencję nazewnictwa kubełków, możesz wygenerować listę możliwych nazw i spróbować uzyskać do nich dostęp:
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
Z uprawnieniami `storage.objects.list` i `storage.objects.get` powinieneś móc wyliczyć wszystkie foldery i pliki z kubełka, aby je pobrać. Możesz to osiągnąć za pomocą tego skryptu Pythona:
```python
import requests
import xml.etree.ElementTree as ET

def list_bucket_objects(bucket_name, prefix='', marker=None):
url = f"https://storage.googleapis.com/{bucket_name}?prefix={prefix}"
if marker:
url += f"&marker={marker}"
response = requests.get(url)
xml_data = response.content
root = ET.fromstring(xml_data)
ns = {'ns': 'http://doc.s3.amazonaws.com/2006-03-01'}
for contents in root.findall('.//ns:Contents', namespaces=ns):
key = contents.find('ns:Key', namespaces=ns).text
print(key)
next_marker = root.find('ns:NextMarker', namespaces=ns)
if next_marker is not None:
next_marker_value = next_marker.text
list_bucket_objects(bucket_name, prefix, next_marker_value)

list_bucket_objects('<storage-name>')
```
### Eskalacja uprawnień

Na następnej stronie możesz sprawdzić, jak **nadużyć uprawnienia do przechowywania danych w celu eskalacji uprawnień**:

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### Enumeracja bez uwierzytelnienia

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/" %}
[gcp-storage-unauthenticated-enum](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/)
{% endcontent-ref %}

### Po wykorzystaniu

{% content-ref url="../gcp-post-exploitation/gcp-storage-post-exploitation.md" %}
[gcp-storage-post-exploitation.md](../gcp-post-exploitation/gcp-storage-post-exploitation.md)
{% endcontent-ref %}

### Trwałość

{% content-ref url="../gcp-persistence/gcp-storage-persistence.md" %}
[gcp-storage-persistence.md](../gcp-persistence/gcp-storage-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
Dowiedz się i ćwicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz się i ćwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostępniaj sztuczki hakerskie, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów na GitHubie.

</details>
{% endhint %}
