# GCP - Enumeraci칩n de Almacenamiento

{% hint style="success" %}
Aprende y practica Hacking en AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Consulta los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Almacenamiento

Google Cloud Platform (GCP) Storage es una **soluci칩n de almacenamiento basada en la nube** que proporciona almacenamiento de objetos altamente duradero y disponible para datos no estructurados. Ofrece **varias clases de almacenamiento** basadas en rendimiento, disponibilidad y costos, incluidas Est치ndar, Nearline, Coldline y Archive. GCP Storage tambi칠n proporciona funciones avanzadas como **pol칤ticas de ciclo de vida, versionado y control de acceso** para gestionar y asegurar los datos de manera efectiva.

El bucket puede almacenarse en una regi칩n, en 2 regiones o **multi-regi칩n (por defecto)**.

### Tipos de Almacenamiento

* **Almacenamiento Est치ndar**: Esta es la opci칩n de almacenamiento predeterminada que **ofrece un acceso de alto rendimiento y baja latencia a los datos de acceso frecuente**. Es adecuado para una amplia gama de casos de uso, incluida la entrega de contenido web, transmisi칩n de medios y alojamiento de canalizaciones de an치lisis de datos.
* **Almacenamiento Nearline**: Esta clase de almacenamiento ofrece **costos de almacenamiento m치s bajos** y **costos de acceso ligeramente m치s altos** que el Almacenamiento Est치ndar. Est치 optimizado para datos de acceso poco frecuente, con una duraci칩n m칤nima de almacenamiento de 30 d칤as. Es ideal para fines de copia de seguridad y archivo.
* **Almacenamiento Coldline**: Esta clase de almacenamiento est치 optimizada para el **almacenamiento a largo plazo de datos de acceso poco frecuente**, con una duraci칩n m칤nima de almacenamiento de 90 d칤as. Ofrece **costos de almacenamiento m치s bajos** que el Almacenamiento Nearline, pero con **costos de acceso m치s altos**.
* **Almacenamiento de Archivo**: Esta clase de almacenamiento est치 dise침ada para datos fr칤os que se acceden **muy raramente**, con una duraci칩n m칤nima de almacenamiento de 365 d칤as. Ofrece los **costos de almacenamiento m치s bajos de todas las opciones de almacenamiento de GCP** pero con los **costos de acceso m치s altos**. Es adecuado para la retenci칩n a largo plazo de datos que deben almacenarse por razones de cumplimiento normativo.
* **Autoclass**: Si **no sabes cu치nto vas a acceder** a los datos, puedes seleccionar Autoclass y GCP **cambiar치 autom치ticamente el tipo de almacenamiento** para minimizar los costos.

### Control de Acceso

Por **defecto** se **recomienda** controlar el acceso a trav칠s de **IAM**, pero tambi칠n es posible **habilitar el uso de ACLs**.\
Si seleccionas usar solo IAM (por defecto) y **pasan 90 d칤as**, **no podr치s habilitar ACLs** para el bucket.

### Versionado

Es posible habilitar el versionado, esto **guardar치 versiones antiguas del archivo dentro del bucket**. Es posible configurar el **n칰mero de versiones que deseas mantener** e incluso **por cu치nto tiempo** deseas que las versiones **no actuales** (versiones antiguas) permanezcan. Se recomienda **7 d칤as para el tipo Est치ndar**.

El **metadato de una versi칩n no actual se conserva**. Adem치s, **los ACLs de las versiones no actuales tambi칠n se conservan**, por lo que las versiones antiguas podr칤an tener ACLs diferentes a la versi칩n actual.

Obt칠n m치s informaci칩n en la [**documentaci칩n**](https://cloud.google.com/storage/docs/object-versioning).

### Pol칤tica de Retenci칩n

Indica cu치nto tiempo deseas **prohibir la eliminaci칩n de Objetos dentro del bucket** (muy 칰til para cumplimiento al menos).\
Solo se puede habilitar **una de las opciones de versionado o pol칤tica de retenci칩n a la vez**.

### Encriptaci칩n

Por defecto, los objetos se **encriptan utilizando claves administradas por Google**, pero tambi칠n puedes usar una **clave de KMS**.

### Acceso P칰blico

Es posible dar acceso a **usuarios externos** (con sesi칩n iniciada en GCP o no) al **contenido de los buckets**.\
Por defecto, cuando se crea un bucket, tendr치 **desactivada la opci칩n de exponer p칰blicamente** el bucket, pero con suficientes permisos se puede cambiar.

El **formato de una URL** para acceder a un bucket es **`https://storage.googleapis.com/<nombre-del-bucket>` o `https://<nombre_del_bucket>.storage.googleapis.com`** (ambos son v치lidos).

### Claves HMAC

Una clave HMAC es un tipo de _credencial_ y puede estar **asociada con una cuenta de servicio o una cuenta de usuario en Cloud Storage**. Utilizas una clave HMAC para crear _firmas_ que luego se incluyen en las solicitudes a Cloud Storage. Las firmas muestran que una **solicitud dada est치 autorizada por el usuario o la cuenta de servicio**.

Las claves HMAC tienen dos piezas principales, un _ID de acceso_ y un _secreto_.

*   **ID de Acceso**: Una cadena alfanum칠rica vinculada a una cuenta de servicio o usuario espec칤fico. Cuando est치 vinculada a una cuenta de servicio, la cadena tiene una longitud de 61 caracteres, y cuando est치 vinculada a una cuenta de usuario, la cadena tiene una longitud de 24 caracteres. A continuaci칩n se muestra un ejemplo de un ID de acceso:

`GOOGTS7C7FUP3AIRVJTE2BCDKINBTES3HC2GY5CBFJDCQ2SYHV6A6XXVTJFSA`
*   **Secreto**: Una cadena codificada en Base-64 de 40 caracteres que est치 vinculada a un ID de acceso espec칤fico. Un secreto es una clave precompartida que solo t칰 y Cloud Storage conocen. Utilizas tu secreto para crear firmas como parte del proceso de autenticaci칩n. A continuaci칩n se muestra un ejemplo de un secreto:

`bGoa+V7g/yqDXvKRqq+JTFn4uQZbPiQJo4pf9RzJ`

Tanto el **ID de acceso como el secreto identifican de manera 칰nica una clave HMAC**, pero el secreto es informaci칩n mucho m치s sensible, ya que se utiliza para **crear firmas**.

### Enumeraci칩n
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -

# Enumerate HMAC keys
gsutil hmac list

# Get permissions
gcloud storage buckets get-iam-policy gs://bucket-name/
gcloud storage objects get-iam-policy gs://bucket-name/folder/object
```
Si obtienes un error de permiso denegado al listar los buckets, es posible que a칰n tengas acceso al contenido. Ahora que conoces la convenci칩n de nombres de los buckets, puedes generar una lista de posibles nombres e intentar acceder a ellos:
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
Con los permisos `storage.objects.list` y `storage.objects.get`, deber칤as poder enumerar todas las carpetas y archivos del bucket para descargarlos. Puedes lograrlo con este script de Python:
```python
import requests
import xml.etree.ElementTree as ET

def list_bucket_objects(bucket_name, prefix='', marker=None):
url = f"https://storage.googleapis.com/{bucket_name}?prefix={prefix}"
if marker:
url += f"&marker={marker}"
response = requests.get(url)
xml_data = response.content
root = ET.fromstring(xml_data)
ns = {'ns': 'http://doc.s3.amazonaws.com/2006-03-01'}
for contents in root.findall('.//ns:Contents', namespaces=ns):
key = contents.find('ns:Key', namespaces=ns).text
print(key)
next_marker = root.find('ns:NextMarker', namespaces=ns)
if next_marker is not None:
next_marker_value = next_marker.text
list_bucket_objects(bucket_name, prefix, next_marker_value)

list_bucket_objects('<storage-name>')
```
### Escalada de Privilegios

En la siguiente p치gina puedes ver c칩mo **abusar de los permisos de almacenamiento para escalar privilegios**:

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### Enumeraci칩n sin Autenticaci칩n

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/" %}
[gcp-storage-unauthenticated-enum](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/)
{% endcontent-ref %}

### Post Explotaci칩n

{% content-ref url="../gcp-post-exploitation/gcp-storage-post-exploitation.md" %}
[gcp-storage-post-exploitation.md](../gcp-post-exploitation/gcp-storage-post-exploitation.md)
{% endcontent-ref %}

### Persistencia

{% content-ref url="../gcp-persistence/gcp-storage-persistence.md" %}
[gcp-storage-persistence.md](../gcp-persistence/gcp-storage-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* 춰Consulta los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
