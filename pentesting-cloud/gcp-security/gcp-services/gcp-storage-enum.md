# GCP - Enumerazione dello Storage

{% hint style="success" %}
Impara e pratica l'Hacking su AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}

## Storage

Google Cloud Platform (GCP) Storage √® una **soluzione di storage basata su cloud** che fornisce un archivio di oggetti altamente durevole e disponibile per dati non strutturati. Offre **diverse classi di storage** basate su prestazioni, disponibilit√† e costo, tra cui Standard, Nearline, Coldline e Archive. GCP Storage fornisce anche funzionalit√† avanzate come **policy di ciclo di vita, versioning e controllo degli accessi** per gestire e proteggere i dati in modo efficace.

Il bucket pu√≤ essere archiviato in una regione, in 2 regioni o **multi-regione (predefinito)**.

### Tipi di Storage

* **Standard Storage**: Questa √® l'opzione di storage predefinita che **offre un accesso ad alte prestazioni e a bassa latenza ai dati frequentemente accessibili**. √à adatto a una vasta gamma di casi d'uso, tra cui la fornitura di contenuti per siti web, lo streaming di media e l'hosting di pipeline di analisi dei dati.
* **Nearline Storage**: Questa classe di storage offre **costi di archiviazione inferiori** e **costi di accesso leggermente pi√π alti** rispetto allo Standard Storage. √à ottimizzato per dati accessibili raramente, con una durata minima di archiviazione di 30 giorni. √à ideale per scopi di backup e archiviazione.
* **Coldline Storage**: Questa classe di storage √® ottimizzata per **l'archiviazione a lungo termine di dati accessibili raramente**, con una durata minima di archiviazione di 90 giorni. Offre **costi di archiviazione inferiori** rispetto a Nearline Storage, ma con **costi di accesso pi√π alti**.
* **Archive Storage**: Questa classe di storage √® progettata per dati freddi a cui si accede **molto raramente**, con una durata minima di archiviazione di 365 giorni. Offre i **costi di archiviazione pi√π bassi di tutte le opzioni di storage di GCP** ma con i **costi di accesso pi√π alti**. √à adatto per la conservazione a lungo termine di dati che devono essere archiviati per motivi di conformit√† o normativi.
* **Autoclass**: Se **non sai quanto accederai** ai dati, puoi selezionare Autoclass e GCP **cambier√† automaticamente il tipo di storage per minimizzare i costi**.

### Controllo degli Accessi

Per **default** √® **consigliato** controllare l'accesso tramite **IAM**, ma √® anche possibile **abilitare l'uso delle ACL**.\
Se si seleziona di utilizzare solo IAM (predefinito) e **passano 90 giorni**, non sar√† possibile abilitare le ACL per il bucket.

### Versioning

√à possibile abilitare il versioning, questo salver√† **vecchie versioni del file all'interno del bucket**. √à possibile configurare il **numero di versioni da mantenere** e anche **per quanto tempo** si desidera che le versioni **non correnti** (vecchie versioni) rimangano attive. √à consigliato **7 giorni per il tipo Standard**.

Il **metadata di una versione non corrente viene mantenuto**. Inoltre, **le ACL delle versioni non correnti vengono mantenute**, quindi le versioni pi√π vecchie potrebbero avere ACL diverse dalla versione corrente.

Per saperne di pi√π nella [**documentazione**](https://cloud.google.com/storage/docs/object-versioning).

### Politica di Conservazione

Indica per quanto **tempo** desideri **vietare la cancellazione degli Oggetti all'interno del bucket** (molto utile per la conformit√† almeno).\
Pu√≤ essere abilitata solo una tra **versioning o politica di conservazione alla volta**.

### Crittografia

Per default gli oggetti sono **criptati utilizzando chiavi gestite da Google**, ma √® anche possibile utilizzare una **chiave da KMS**.

### Accesso Pubblico

√à possibile dare **accesso ai contenuti dei bucket agli utenti esterni** (loggati in GCP o meno).\
Per default, quando viene creato un bucket, sar√† **disabilitata l'opzione di esporre pubblicamente** il bucket, ma con le autorizzazioni sufficienti pu√≤ essere modificata.

Il **formato di un URL** per accedere a un bucket √® **`https://storage.googleapis.com/<nome-bucket>` o `https://<nome_bucket>.storage.googleapis.com`** (entrambi sono validi).

### Chiavi HMAC

Una chiave HMAC √® un tipo di _credenziale_ e pu√≤ essere **associata a un account di servizio o a un account utente in Cloud Storage**. Si utilizza una chiave HMAC per creare _firme_ che vengono poi incluse nelle richieste a Cloud Storage. Le firme mostrano che una **richiesta data √® autorizzata dall'utente o dall'account di servizio**.

Le chiavi HMAC hanno due componenti principali, un _ID di accesso_ e un _segreto_.

*   **ID di Accesso**: Una stringa alfanumerica collegata a un servizio specifico o a un account utente. Quando collegata a un account di servizio, la stringa √® lunga 61 caratteri, e quando collegata a un account utente, la stringa √® lunga 24 caratteri. Di seguito viene mostrato un esempio di un ID di accesso:

`GOOGTS7C7FUP3AIRVJTE2BCDKINBTES3HC2GY5CBFJDCQ2SYHV6A6XXVTJFSA`
*   **Segreto**: Una stringa codificata in Base-64 di 40 caratteri che √® collegata a un ID di accesso specifico. Un segreto √® una chiave precondivisa che solo tu e Cloud Storage conoscete. Utilizzi il tuo segreto per creare firme come parte del processo di autenticazione. Di seguito viene mostrato un esempio di un segreto:

`bGoa+V7g/yqDXvKRqq+JTFn4uQZbPiQJo4pf9RzJ`

Sia l'**ID di accesso che il segreto identificano univocamente una chiave HMAC**, ma il segreto √® un'informazione molto pi√π sensibile, poich√© viene utilizzato per **creare firme**.

### Enumerazione
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -

# Enumerate HMAC keys
gsutil hmac list

# Get permissions
gcloud storage buckets get-iam-policy gs://bucket-name/
gcloud storage objects get-iam-policy gs://bucket-name/folder/object
```
Se ricevi un errore di permesso negato nell'elencare i bucket, potresti comunque avere accesso ai contenuti. Ora che conosci la convenzione dei nomi dei bucket, puoi generare un elenco di possibili nomi e provare ad accedervi:
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
Con le autorizzazioni `storage.objects.list` e `storage.objects.get`, dovresti essere in grado di enumerare tutte le cartelle e i file dal bucket per scaricarli. Puoi ottenere ci√≤ con questo script Python:
```python
import requests
import xml.etree.ElementTree as ET

def list_bucket_objects(bucket_name, prefix='', marker=None):
url = f"https://storage.googleapis.com/{bucket_name}?prefix={prefix}"
if marker:
url += f"&marker={marker}"
response = requests.get(url)
xml_data = response.content
root = ET.fromstring(xml_data)
ns = {'ns': 'http://doc.s3.amazonaws.com/2006-03-01'}
for contents in root.findall('.//ns:Contents', namespaces=ns):
key = contents.find('ns:Key', namespaces=ns).text
print(key)
next_marker = root.find('ns:NextMarker', namespaces=ns)
if next_marker is not None:
next_marker_value = next_marker.text
list_bucket_objects(bucket_name, prefix, next_marker_value)

list_bucket_objects('<storage-name>')
```
### Escalazione dei privilegi

Nella seguente pagina puoi controllare come **abusare dei permessi di archiviazione per escalare i privilegi**:

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### Enumerazione non autenticata

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/" %}
[gcp-storage-unauthenticated-enum](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/)
{% endcontent-ref %}

### Post Esploitation

{% content-ref url="../gcp-post-exploitation/gcp-storage-post-exploitation.md" %}
[gcp-storage-post-exploitation.md](../gcp-post-exploitation/gcp-storage-post-exploitation.md)
{% endcontent-ref %}

### Persistenza

{% content-ref url="../gcp-persistence/gcp-storage-persistence.md" %}
[gcp-storage-persistence.md](../gcp-persistence/gcp-storage-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
Impara e pratica l'hacking su AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
