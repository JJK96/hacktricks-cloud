# GCP - KMS Enum

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して、ハッキングテクニックを共有してください。

</details>
{% endhint %}

## KMS

[**Cloud Key Management Service**](https://cloud.google.com/kms/docs/)は、**暗号鍵**の安全な保管場所として機能し、**機密データの暗号化および復号化**などの操作に不可欠です。これらの鍵はキーリング内に整理され、構造化された管理が可能です。さらに、アクセス制御は、個々の鍵レベルまたはキーリング全体で細かく構成でき、権限がセキュリティ要件と正確に一致するように保証されます。

KMSキーリングは**デフォルトでグローバル**として作成されるため、そのキーリング内の鍵はどのリージョンからでもアクセス可能です。ただし、**特定のリージョン**に特定のキーリングを作成することも可能です。

### 鍵保護レベル

* **ソフトウェア鍵**: ソフトウェア鍵は、KMSによって完全にソフトウェアで作成および管理されます。これらの鍵は**ハードウェアセキュリティモジュール（HSM）で保護されておらず**、**テストおよび開発目的**に使用できます。ソフトウェア鍵は、セキュリティが低く攻撃を受けやすいため、**本番環境では推奨されません**。
* **クラウドホストされた鍵**: クラウドホストされた鍵は、信頼性の高いインフラを使用してクラウド内でKMSによって作成および管理されます。これらの鍵は**HSMによって保護されています**が、HSMは**特定の顧客に専用ではありません**。クラウドホストされた鍵は、ほとんどの本番ユースケースに適しています。
* **外部鍵**: 外部鍵は、KMSの外で作成および管理され、暗号操作で使用するためにKMSにインポートされます。外部鍵は、顧客の選択に応じて**ハードウェアセキュリティモジュール（HSM）またはソフトウェアライブラリに保存**できます。

### 鍵の目的

* **対称暗号化/復号化**: **単一の鍵を使用してデータを暗号化および復号化**するために使用されます。対称鍵は、大量のデータを暗号化および復号化する際に高速かつ効率的です。
* **サポート**: [cryptoKeys.encrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/encrypt), [cryptoKeys.decrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/decrypt)
* **非対称署名**: 鍵を共有せずに2者間で安全な通信に使用されます。非対称鍵は、**公開鍵と秘密鍵**からなります。公開鍵は他者と共有され、秘密鍵は秘密に保持されます。
* **サポート**: [cryptoKeyVersions.asymmetricSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricSign), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **非対称復号化**: メッセージまたはデータの真正性を検証するために使用されます。秘密鍵を使用してデジタル署名が作成され、対応する公開鍵を使用して検証できます。
* **サポート**: [cryptoKeyVersions.asymmetricDecrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricDecrypt), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **MAC署名**: **秘密鍵を使用してメッセージ認証コード（MAC）を作成**することで、データの整合性と真正性を確保します。HMACは、ネットワークプロトコルやソフトウェアアプリケーションでメッセージ認証に一般的に使用されます。
* **サポート**: [cryptoKeyVersions.macSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macSign), [cryptoKeyVersions.macVerify](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macVerify)

### ローテーション期間および破棄プログラム期間

**デフォルト**では、**90日**ごとに行われますが、**簡単に**および**完全にカスタマイズ**できます。

「破棄プログラム」期間は、ユーザーが鍵の削除を要求してから鍵が**削除**されるまでの時間です。鍵が作成された後に変更することはできません（デフォルトは1日）。

### プライマリバージョン

各KMS鍵には複数のバージョンがあり、そのうちの1つは**デフォルト**である必要があります。これは、KMS鍵とやり取りする際に**バージョンが指定されていない場合に使用されるもの**です。

### 列挙

**鍵をリストする権限**がある場合、これがアクセス方法です:
```bash
# List the global keyrings available
gcloud kms keyrings list --location global
gcloud kms keyrings get-iam-policy <KEYRING>

# List the keys inside a keyring
gcloud kms keys list --keyring <KEYRING> --location <global/other_locations>
gcloud kms keys get-iam-policy <KEY>

# Encrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global

# Decrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global
```
### 特権昇格

{% content-ref url="../gcp-privilege-escalation/gcp-kms-privesc.md" %}
[gcp-kms-privesc.md](../gcp-privilege-escalation/gcp-kms-privesc.md)
{% endcontent-ref %}

### ポストエクスプロイテーション

{% content-ref url="../gcp-post-exploitation/gcp-kms-post-exploitation.md" %}
[gcp-kms-post-exploitation.md](../gcp-post-exploitation/gcp-kms-post-exploitation.md)
{% endcontent-ref %}

## 参考文献

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

{% hint style="success" %}
AWSハッキングの学習と練習：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**または**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して**ハッキングトリックを共有**してください。

</details>
{% endhint %}
