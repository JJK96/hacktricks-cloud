# GCP - KMS 枚举

{% hint style="success" %}
学习并练习 AWS 黑客技能：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习 GCP 黑客技能：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}

## KMS

[**Cloud Key Management Service**](https://cloud.google.com/kms/docs/) 作为**加密密钥**的安全存储，对于**加密和解密敏感数据**等操作至关重要。这些密钥在密钥环中组织，允许进行结构化管理。此外，访问控制可以被精心配置，无论是在单个密钥级别还是整个密钥环级别，确保权限与安全需求精确对齐。

KMS 密钥环**默认为全局创建**，这意味着该密钥环中的密钥可以从任何区域访问。但是，也可以在**特定区域**创建特定的密钥环。

### 密钥保护级别

* **软件密钥**：软件密钥完全由 KMS 在软件中**创建和管理**。这些密钥**不受任何硬件安全模块 (HSM) 保护**，可用于**测试和开发目的**。由于提供的安全性较低且容易受到攻击，不建议将软件密钥用于生产环境。
* **云托管密钥**：云托管密钥由 KMS 在云中使用高可用性和可靠基础设施**创建和管理**。这些密钥受**HSM 保护**，但 HSM 并**不专门为特定客户而设**。云托管密钥适用于大多数生产用例。
* **外部密钥**：外部密钥在 KMS 外部**创建和管理**，并被导入 KMS 用于加密操作。外部密钥**可以存储在硬件安全模块 (HSM) 或软件库中，取决于客户的偏好**。

### 密钥用途

* **对称加密/解密**：用于使用单个密钥进行**加密和解密数据**的操作。对称密钥对于加密和解密大量数据是快速和高效的。
* **支持**：[cryptoKeys.encrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/encrypt), [cryptoKeys.decrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/decrypt)
* **非对称签名**：用于两方之间的安全通信，而无需共享密钥。非对称密钥成对出现，包括**公钥和私钥**。公钥与他人共享，而私钥保密。
* **支持**：[cryptoKeyVersions.asymmetricSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricSign), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **非对称解密**：用于验证消息或数据的真实性。使用私钥创建数字签名，并可以使用相应的公钥进行验证。
* **支持**：[cryptoKeyVersions.asymmetricDecrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricDecrypt), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **MAC 签名**：通过使用**秘密密钥**创建消息认证码 (MAC) 来确保**数据的完整性和真实性**。HMAC 在网络协议和软件应用程序中常用于消息认证。
* **支持**：[cryptoKeyVersions.macSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macSign), [cryptoKeyVersions.macVerify](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macVerify)

### 旋转周期和销毁周期

**默认**为每**90天**，但可以**轻松**和**完全自定义**。

"程序化销毁" 期间是**用户要求删除密钥**的时间，直到密钥被**删除**。在创建密钥后无法更改 (默认为 1 天)。

### 主版本

每个 KMS 密钥可以有多个版本，其中一个必须是**默认**版本，在与 KMS 密钥**交互时未指定版本时将使用该版本**。

### 枚举

拥有**列出密钥权限**时，可以通过以下方式访问它们：
```bash
# List the global keyrings available
gcloud kms keyrings list --location global
gcloud kms keyrings get-iam-policy <KEYRING>

# List the keys inside a keyring
gcloud kms keys list --keyring <KEYRING> --location <global/other_locations>
gcloud kms keys get-iam-policy <KEY>

# Encrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global

# Decrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global
```
### 提权

{% content-ref url="../gcp-privilege-escalation/gcp-kms-privesc.md" %}
[gcp-kms-privesc.md](../gcp-privilege-escalation/gcp-kms-privesc.md)
{% endcontent-ref %}

### 后渗透

{% content-ref url="../gcp-post-exploitation/gcp-kms-post-exploitation.md" %}
[gcp-kms-post-exploitation.md](../gcp-post-exploitation/gcp-kms-post-exploitation.md)
{% endcontent-ref %}

## 参考资料

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

{% hint style="success" %}
学习并练习 AWS 黑客技能：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习 GCP 黑客技能：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}
