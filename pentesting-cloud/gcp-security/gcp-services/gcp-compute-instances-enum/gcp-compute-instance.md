# GCP - Compute Instances

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Revisa los [**planes de suscripción**](https://github.com/sponsors/carlospolop)!
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Información Básica

Google Cloud Compute Instances son **máquinas virtuales personalizables en la infraestructura en la nube de Google**, que ofrecen potencia de cómputo escalable y bajo demanda para una amplia gama de aplicaciones. Proporcionan características como despliegue global, almacenamiento persistente, opciones flexibles de SO e integraciones sólidas de red y seguridad, lo que las convierte en una opción versátil para alojar sitios web, procesar datos y ejecutar aplicaciones de manera eficiente en la nube.

### VM Confidencial

Las VMs confidenciales utilizan **características de seguridad basadas en hardware** ofrecidas por la última generación de procesadores AMD EPYC, que incluyen cifrado de memoria y virtualización cifrada segura. Estas características permiten que la VM proteja los datos procesados y almacenados dentro de ella, incluso del sistema operativo host y el hipervisor.

Para ejecutar una VM Confidencial puede ser necesario **cambiar** cosas como el **tipo** de la **máquina**, la **interfaz de red**, la **imagen del disco de arranque**.

### Disco y Cifrado de Disco

Es posible **seleccionar el disco** a usar o **crear uno nuevo**. Si seleccionas uno nuevo puedes:

* Seleccionar el **tamaño** del disco
* Seleccionar el **SO**
* Indicar si deseas **eliminar el disco cuando se elimine la instancia**
* **Cifrado**: Por **defecto** se usará una **clave gestionada por Google**, pero también puedes **seleccionar una clave de KMS** o indicar una **clave en bruto a usar**.

### Desplegar Contenedor

Es posible desplegar un **contenedor** dentro de la máquina virtual.\
Es posible configurar la **imagen** a usar, establecer el **comando** a ejecutar dentro, **argumentos**, montar un **volumen**, y **variables de entorno** (¿información sensible?) y configurar varias opciones para este contenedor como ejecutar como **privilegiado**, stdin y pseudo TTY.

### Cuenta de Servicio

Por defecto, se usará la **cuenta de servicio predeterminada de Compute Engine**. El correo electrónico de esta SA es algo como: `<proj-num>-compute@developer.gserviceaccount.com`\
Esta cuenta de servicio tiene **rol de Editor sobre todo el proyecto (altos privilegios).**

Y los **alcances de acceso predeterminados** son los siguientes:

* **https://www.googleapis.com/auth/devstorage.read\_only** -- Acceso de lectura a buckets :)
* https://www.googleapis.com/auth/logging.write
* https://www.googleapis.com/auth/monitoring.write
* https://www.googleapis.com/auth/servicecontrol
* https://www.googleapis.com/auth/service.management.readonly
* https://www.googleapis.com/auth/trace.append

Sin embargo, es posible **otorgarle `cloud-platform` con un clic** o especificar **personalizados**.

<figure><img src="../../../../.gitbook/assets/image (327).png" alt=""><figcaption></figcaption></figure>

### Firewall

Es posible permitir tráfico HTTP y HTTPS.

<figure><img src="../../../../.gitbook/assets/image (326).png" alt=""><figcaption></figcaption></figure>

### Redes

* **Reenvío de IP**: Es posible **habilitar el reenvío de IP** desde la creación de la instancia.
* **Nombre de Host**: Es posible darle a la instancia un nombre de host permanente.
* **Interfaz**: Es posible agregar una interfaz de red.

### Seguridad Extra

Estas opciones **aumentarán la seguridad** de la VM y son recomendadas:

* **Arranque seguro:** El arranque seguro ayuda a proteger tus instancias de VM contra malware a nivel de arranque y kernel y rootkits.
* **Habilitar vTPM:** El Módulo de Plataforma Confiable Virtual (vTPM) valida la integridad de pre-arranque y arranque de tu VM invitada, y ofrece generación y protección de claves.
* **Supervisión de integridad:** La supervisión de integridad te permite monitorear y verificar la integridad de arranque en tiempo de ejecución de tus instancias de VM protegidas usando informes de Stackdriver. Requiere que vTPM esté habilitado.

### Acceso a la VM

La forma común de habilitar el acceso a la VM es **permitiendo ciertas claves públicas SSH** para acceder a la VM.\
Sin embargo, también es posible **habilitar el acceso a la VM mediante el servicio `os-config` usando IAM**. Además, es posible habilitar 2FA para acceder a la VM usando este servicio.\
Cuando este **servicio** está **habilitado**, el acceso mediante **claves SSH está deshabilitado.**

<figure><img src="../../../../.gitbook/assets/image (328).png" alt=""><figcaption></figcaption></figure>

### Metadatos

Es posible definir **automatización** (userdata en AWS) que son **comandos shell** que se ejecutarán cada vez que la máquina se encienda o reinicie.

También es posible **agregar valores de metadatos clave-valor adicionales** que serán accesibles desde el endpoint de metadatos. Esta información se usa comúnmente para variables de entorno y scripts de inicio/apagado. Esto se puede obtener usando el **método `describe`** desde un comando en la sección de enumeración, pero también se podría recuperar desde dentro de la instancia accediendo al endpoint de metadatos.
```bash
# view project metadata
curl "http://metadata.google.internal/computeMetadata/v1/project/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"

# view instance metadata
curl "http://metadata.google.internal/computeMetadata/v1/instance/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"
```
Moreover, **auth token for the attached service account** y **información general** sobre la instancia, red y proyecto también estarán disponibles desde el **metadata endpoint**. Para más información, consulta:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Encryption

Una clave de cifrado gestionada por Google se usa por defecto, pero se puede configurar una clave de cifrado gestionada por el cliente (CMEK). También puedes configurar qué hacer cuando se revoca la CMEK utilizada: Nada o apagar la VM.

<figure><img src="../../../../.gitbook/assets/image (329).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consulta los [**planes de suscripción**](https://github.com/sponsors/carlospolop)!
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
