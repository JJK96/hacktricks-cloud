# GCP - Compute Instances

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローしてください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出してハッキングトリックを共有してください。

</details>
{% endhint %}

## 基本情報

Google Cloud Compute Instancesは、**Googleのクラウドインフラ上のカスタマイズ可能な仮想マシン**であり、さまざまなアプリケーションに対してスケーラブルでオンデマンドのコンピューティングパワーを提供します。これらは、グローバルな展開、永続的なストレージ、柔軟なOS選択、強力なネットワーキングおよびセキュリティ統合などの機能を提供し、ウェブサイトのホスティング、データ処理、アプリケーションの効率的な実行に適した多用途の選択肢となります。

### Confidential VM

Confidential VMsは、**AMD EPYCプロセッサの最新世代が提供するハードウェアベースのセキュリティ機能**を使用します。これには、メモリ暗号化およびセキュア暗号化仮想化が含まれます。これらの機能により、VMはホストオペレーティングシステムやハイパーバイザーからもデータを保護できます。

Confidential VMを実行するには、**マシンのタイプ**、ネットワーク**インターフェース**、**ブートディスクイメージ**などを**変更**する必要があるかもしれません。

### ディスクとディスク暗号化

使用する**ディスクを選択**するか、**新しいディスクを作成**することが可能です。新しいディスクを選択する場合、以下のことができます：

* ディスクの**サイズ**を選択
* **OS**を選択
* インスタンスが削除されたときに**ディスクを削除するかどうか**を指定
* **暗号化**：**デフォルト**では**Google管理キー**が使用されますが、**KMSからキーを選択**するか、使用する**生のキーを指定**することもできます。

### コンテナのデプロイ

仮想マシン内に**コンテナ**をデプロイすることが可能です。\
使用する**イメージ**を設定し、内部で実行する**コマンド**、**引数**、**ボリューム**のマウント、**環境変数**（機密情報？）を設定し、このコンテナのためにいくつかのオプションを構成することができます。例えば、**特権モード**で実行、stdinおよび擬似TTYなどです。

### サービスアカウント

デフォルトでは、**Compute Engineデフォルトサービスアカウント**が使用されます。このSAのメールは次のようになります：`<proj-num>-compute@developer.gserviceaccount.com`\
このサービスアカウントは、**プロジェクト全体に対してEditorロール（高い権限）**を持っています。

そして、**デフォルトのアクセススコープ**は次の通りです：

* **https://www.googleapis.com/auth/devstorage.read\_only** -- バケットへの読み取りアクセス :)
* https://www.googleapis.com/auth/logging.write
* https://www.googleapis.com/auth/monitoring.write
* https://www.googleapis.com/auth/servicecontrol
* https://www.googleapis.com/auth/service.management.readonly
* https://www.googleapis.com/auth/trace.append

ただし、**クリック一つで`cloud-platform`を付与**するか、**カスタムのもの**を指定することも可能です。

<figure><img src="../../../../.gitbook/assets/image (327).png" alt=""><figcaption></figcaption></figure>

### ファイアウォール

HTTPおよびHTTPSトラフィックを許可することが可能です。

<figure><img src="../../../../.gitbook/assets/image (326).png" alt=""><figcaption></figcaption></figure>

### ネットワーキング

* **IPフォワーディング**：インスタンスの作成時に**IPフォワーディングを有効にする**ことが可能です。
* **ホスト名**：インスタンスに永続的なホスト名を付与することが可能です。
* **インターフェース**：ネットワークインターフェースを追加することが可能です。

### 追加のセキュリティ

これらのオプションはVMの**セキュリティを向上**させ、推奨されます：

* **セキュアブート**：セキュアブートは、ブートレベルおよびカーネルレベルのマルウェアやルートキットからVMインスタンスを保護するのに役立ちます。
* **vTPMの有効化**：仮想トラステッドプラットフォームモジュール（vTPM）は、ゲストVMのプレブートおよびブートの整合性を検証し、キーの生成と保護を提供します。
* **整合性監視**：整合性監視により、Stackdriverレポートを使用してシールドされたVMインスタンスのランタイムブート整合性を監視および検証することができます。vTPMの有効化が必要です。

### VMアクセス

VMへのアクセスを有効にする一般的な方法は、**特定のSSH公開鍵を許可**することです。\
しかし、**IAMを使用して`os-config`サービス経由でVMへのアクセスを有効にする**ことも可能です。さらに、このサービスを使用してVMへのアクセスに2FAを有効にすることも可能です。\
この**サービス**が**有効**になると、**SSHキー経由のアクセスは無効**になります。

<figure><img src="../../../../.gitbook/assets/image (328).png" alt=""><figcaption></figcaption></figure>

### メタデータ

**自動化**（AWSのuserdata）を定義することが可能で、これはマシンが起動または再起動するたびに実行される**シェルコマンド**です。

また、メタデータエンドポイントからアクセス可能な**追加のメタデータキーと値**を追加することも可能です。この情報は通常、環境変数やスタートアップ/シャットダウンスクリプトに使用されます。これは、列挙セクションのコマンドから**`describe`メソッド**を使用して取得できますが、インスタンス内部からメタデータエンドポイントにアクセスして取得することもできます。
```bash
# view project metadata
curl "http://metadata.google.internal/computeMetadata/v1/project/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"

# view instance metadata
curl "http://metadata.google.internal/computeMetadata/v1/instance/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"
```
Moreover, **auth token for the attached service account** とインスタンス、ネットワーク、プロジェクトに関する**general info**も**metadata endpoint**から取得可能です。詳細は以下を参照してください:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Encryption

デフォルトではGoogle管理の暗号化キーが使用されますが、Customer-managed encryption key (CMEK)を設定することもできます。使用されているCMEKが取り消された場合の動作も設定可能です: 何もしないか、VMをシャットダウンするか。

<figure><img src="../../../../.gitbook/assets/image (329).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
AWS Hackingを学び、練習する:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingを学び、練習する: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**subscription plans**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discord group**](https://discord.gg/hRep4RUj7f)や[**telegram group**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローしてください。
* **PRを提出して** [**HackTricks**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリでハッキングトリックを共有してください。

</details>
{% endhint %}
