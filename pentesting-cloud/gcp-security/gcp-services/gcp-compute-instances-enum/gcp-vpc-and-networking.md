# GCP - VPC & Networking

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## **GCP Compute Networking im √úberblick**

**VPCs** enthalten **Firewall**-Regeln, um eingehenden Datenverkehr zum VPC zuzulassen. VPCs enthalten auch **Subnetzwerke**, in denen **virtuelle Maschinen** verbunden werden.\
Im Vergleich zu AWS w√§re die **Firewall** das **n√§chste** an **AWS-Sicherheitsgruppen und NACLs**, aber in diesem Fall sind diese **im VPC definiert** und nicht in jeder Instanz.

## **VPC, Subnetzwerke & Firewalls in GCP**

Compute-Instanzen sind mit **Subnetzwerken** verbunden, die Teil von **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)) sind. In GCP gibt es keine Sicherheitsgruppen, sondern [**VPC-Firewalls**](https://cloud.google.com/vpc/docs/firewalls) mit Regeln, die auf dieser Netzwerkebene definiert sind, aber auf jede VM-Instanz angewendet werden.

### Subnetzwerke

Ein **VPC** kann **mehrere Subnetzwerke** haben. Jedes **Subnetzwerk befindet sich in einer Region**.

### Firewalls

Standardm√§√üig hat jedes Netzwerk zwei [**implizite Firewall-Regeln**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **Erlaube ausgehenden** und **Verweigere eingehenden** Datenverkehr.

Wenn ein GCP-Projekt erstellt wird, wird ein VPC namens **`default`** erstellt, mit den folgenden Firewall-Regeln:

* **default-allow-internal:** erlaube allen Datenverkehr von anderen Instanzen im `default`-Netzwerk
* **default-allow-ssh:** erlaube 22 von √ºberall
* **default-allow-rdp:** erlaube 3389 von √ºberall
* **default-allow-icmp:** erlaube Ping von √ºberall

{% hint style="warning" %}
Wie Sie sehen k√∂nnen, neigen **Firewall-Regeln** dazu, **f√ºr interne IP-Adressen** **offener** zu sein. Das Standard-VPC erlaubt allen Datenverkehr zwischen Compute-Instanzen.
{% endhint %}

Es k√∂nnen weitere **Firewall-Regeln** f√ºr das Standard-VPC oder f√ºr neue VPCs erstellt werden. [**Firewall-Regeln**](https://cloud.google.com/vpc/docs/firewalls) k√∂nnen auf Instanzen √ºber die folgenden **Methoden** angewendet werden:

* [**Netzwerk-Tags**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Dienstkonten**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Alle Instanzen innerhalb eines VPCs**

Leider gibt es keinen einfachen `gcloud`-Befehl, um alle Compute-Instanzen mit offenen Ports im Internet anzuzeigen. Sie m√ºssen die Verbindung zwischen Firewall-Regeln, Netzwerk-Tags, Dienstkonten und Instanzen herstellen.

Dieser Prozess wurde mit [diesem Python-Skript](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) automatisiert, das Folgendes exportiert:

* CSV-Datei, die Instanz, √∂ffentliche IP, erlaubtes TCP, erlaubtes UDP zeigt
* nmap-Scan, um alle Instanzen auf Ports zu zielen, die von der √∂ffentlichen Internetverbindung (0.0.0.0/0) erlaubt sind
* masscan, um den vollst√§ndigen TCP-Bereich dieser Instanzen zu zielen, die ALLE TCP-Ports aus dem √∂ffentlichen Internet (0.0.0.0/0) erlauben

### Hierarchische Firewall-Richtlinien <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Hierarchische Firewall-Richtlinien_ erm√∂glichen es Ihnen, eine konsistente Firewall-Richtlinie in Ihrer Organisation zu erstellen und durchzusetzen. Sie k√∂nnen **hierarchische Firewall-Richtlinien der Organisation** als Ganzes oder einzelnen **Ordnern** zuweisen. Diese Richtlinien enthalten Regeln, die Verbindungen explizit verweigern oder zulassen k√∂nnen.

Sie erstellen und wenden Firewall-Richtlinien als separate Schritte an. Sie k√∂nnen Firewall-Richtlinien an den **Organisations- oder Ordnernodes der** [**Ressourcenhierarchie**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) erstellen und anwenden. Eine Firewall-Richtlinienregel kann **Verbindungen blockieren, Verbindungen zulassen oder die Auswertung von Firewall-Regeln** an untergeordnete Ordner oder in VPC-Netzwerken definierte VPC-Firewall-Regeln delegieren.

Standardm√§√üig gelten alle hierarchischen Firewall-Richtlinienregeln f√ºr alle VMs in allen Projekten unter der Organisation oder dem Ordner, in dem die Richtlinie zugeordnet ist. Sie k√∂nnen jedoch **einschr√§nken, welche VMs eine bestimmte Regel erhalten**, indem Sie [Zielnetzwerke oder Ziel-Dienstkonten](https://cloud.google.com/vpc/docs/firewall-policies#targets) angeben.

Hier erfahren Sie, wie Sie [**eine hierarchische Firewall-Richtlinie erstellen**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Auswertung von Firewall-Regeln

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Org: Firewall-Richtlinien, die der Organisation zugewiesen sind
2. Ordner: Firewall-Richtlinien, die dem Ordner zugewiesen sind
3. VPC: Firewall-Regeln, die dem VPC zugewiesen sind
4. Global: Ein anderer Typ von Firewall-Regeln, die VPCs zugewiesen werden k√∂nnen
5. Regional: Mit dem VPC-Netzwerk der Netzwerkschnittstelle der VM und der Region der VM verbundene Firewall-Regeln.

## VPC-Netzwerk-Peering

Erm√∂glicht die Verbindung von zwei Virtual Private Cloud (VPC)-Netzwerken, sodass **Ressourcen in jedem Netzwerk miteinander kommunizieren k√∂nnen**.\
Gepaarte VPC-Netzwerke k√∂nnen im selben Projekt, in verschiedenen Projekten derselben Organisation oder in **verschiedenen Projekten verschiedener Organisationen** sein.

Folgende Berechtigungen sind erforderlich:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[Mehr in der Dokumentation](https://cloud.google.com/vpc/docs/vpc-peering).

## Referenzen

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
