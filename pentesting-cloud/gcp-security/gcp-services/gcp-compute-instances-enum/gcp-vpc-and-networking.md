# GCP - VPC & ネットワーキング

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じてゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝**したい場合や **HackTricks をPDFでダウンロード**したい場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェック！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見る
* **Discordグループ**に **参加** 💬(https://discord.gg/hRep4RUj7f) または [**telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦で **フォロー**する [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks** と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリに **PRを提出**して、あなたのハッキングテクニックを共有する。

</details>

## **GCP Compute Networking の要点**

**VPC** には **Firewall** ルールが含まれ、VPC への着信トラフィックを許可します。VPC にはまた、**仮想マシン** が **接続される** **サブネットワーク** も含まれています。\
AWS と比較すると、**Firewall** は **AWS のセキュリティグループと NACLs** に **最も近い** ものですが、この場合、これらは **VPC で定義** されており、各インスタンスではないです。

## **GCP における VPC、サブネットワーク、およびファイアウォール**

Compute インスタンスは **VPC** に接続された **サブネットワーク** であり、[Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc) の一部です。GCP にはセキュリティグループは存在せず、[**VPC ファイアウォール**](https://cloud.google.com/vpc/docs/firewalls) があり、これらはこのネットワークレベルで定義されたルールが各 VM インスタンスに適用されます。

### サブネットワーク

**VPC** には **複数のサブネットワーク** を持つことができます。各 **サブネットワークは 1 つのリージョン** にあります。

### ファイアウォール

デフォルトでは、すべてのネットワークには二つの [**暗黙のファイアウォールルール**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules) があります: **アウトバウンドを許可** し、**インバウンドを拒否** します。

GCP プロジェクトが作成されると、**`default`** という名前の VPC が作成され、次のファイアウォールルールが適用されます:

* **default-allow-internal:** `default` ネットワーク上の他のインスタンスからのすべてのトラフィックを許可
* **default-allow-ssh:** どこからでも 22 を許可
* **default-allow-rdp:** どこからでも 3389 を許可
* **default-allow-icmp:** どこからでも ping を許可

{% hint style="warning" %}
**ファイアウォールルール** は **内部 IP アドレス** に対して **より許可的** になる傾向があります。デフォルトの VPC では Compute インスタンス間のすべてのトラフィックを許可します。
{% endhint %}

デフォルトの VPC または新しい VPC に **追加のファイアウォールルール** を作成できます。[**ファイアウォールルール**](https://cloud.google.com/vpc/docs/firewalls) は以下の **方法** でインスタンスに適用できます:

* [**ネットワークタグ**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**サービスアカウント**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **VPC 内のすべてのインスタンス**

残念ながら、インターネット上のオープンポートを持つすべての Compute インスタンスを一括で取得するための簡単な `gcloud` コマンドはありません。ファイアウォールルール、ネットワークタグ、サービスアカウント、およびインスタンスの間の関連付けを行う必要があります。

このプロセスは、[この Python スクリプト](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) を使用して自動化され、以下をエクスポートします:

* インスタンス、パブリック IP、許可された TCP、許可された UDP を示す CSV ファイル
* インターネットからのすべてのインスタンスを対象とする nmap スキャン（0.0.0.0/0 からの許可されたポートイングレス）
* インターネットからのすべての TCP ポートを許可するインスタンスのすべての TCP レンジを対象とする masscan

### 階層型ファイアウォールポリシー <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_階層型ファイアウォールポリシー_ を使用すると、組織全体で一貫したファイアウォールポリシーを作成および **強制** できます。これらのポリシーを組織全体または個々の **フォルダ** に割り当てることができます。これらのポリシーには、接続を明示的に拒否または許可するルールが含まれています。

ファイアウォールポリシーを作成および適用することは別々のステップです。ファイアウォールポリシーを [**リソース階層**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) の **組織またはフォルダノード** で作成および適用できます。ファイアウォールポリシールールは、接続をブロックしたり許可したり、下位のフォルダまたは VPC ファイアウォールルールにファイアウォールルールの評価を委任することができます。

デフォルトでは、階層型ファイアウォールポリシールールは、ポリシーが関連付けられている組織またはフォルダの下のすべてのプロジェクトのすべての VM に適用されます。ただし、[ターゲットネットワークまたはターゲットサービスアカウント](https://cloud.google.com/vpc/docs/firewall-policies#targets) を指定することで、特定の VM にルールを適用できます。

ここで [**階層型ファイアウォールポリシーを作成**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud) する方法を読むことができます。

### ファイアウォールルールの評価

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

1. 組織: 組織に割り当てられたファイアウォールポリシー
2. フォルダ: フォルダに割り当てられたファイアウォールポリシー
3. VPC: VPC に割り当てられたファイアウォールルール
4. グローバル: VPC に割り当てられた別のタイプのファイアウォールルール
5. リージョナル: VM の NIC と VM のリージョンに関連付けられた VPC ネットワークに関連付けられたファイアウォールルール。

## VPC ネットワークピアリング

2 つの Virtual Private Cloud (VPC) ネットワークを接続し、**各ネットワークのリソースが互いに通信できるようにします**。\
ピアリングされた VPC ネットワークは、同じプロジェクト内、同じ組織の異なるプロジェクト内、または **異なる組織の異なるプロジェクト内** にあることができます。

必要な権限は次のとおりです:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**詳細はドキュメントを参照**](https://cloud.google.com/vpc/docs/vpc-peering).

## 参考文献

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じてゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝**したい場合や **HackTricks をPDFでダウンロード**したい場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェック！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見る
* **Discordグループ**に **参加** 💬(https://discord.gg/hRep4RUj7f) または [**telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦で **フォロー**する [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks** と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリに **PRを提出**して、あなたのハッキングテクニックを共有する。

</details>
