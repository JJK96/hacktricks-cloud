# GCP - VPC & Networking

<details>

<summary><strong>Zacznij od zera i stań się ekspertem od hakowania AWS dzięki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów na GitHubie.

</details>

## **Sieciowanie obliczeniowe w GCP w pigułce**

**VPC** zawiera reguły **Firewalla** pozwalające na przychodzący ruch do VPC. VPC zawiera również **podsieci**, do których będą podłączone **maszyny wirtualne**.\
W porównaniu z AWS, **Firewall** byłby **najbliższą** rzeczą do **Grup Zabezpieczeń AWS i NACL**, ale w tym przypadku są one **zdefiniowane w VPC**, a nie w każdej instancji.

## **VPC, Podsieci i Firewalle w GCP**

Instancje obliczeniowe są podłączone do **podsieci**, które są częścią **VPC** ([Chmury Prywatnej Wirtualnej](https://cloud.google.com/vpc/docs/vpc)). W GCP nie ma grup zabezpieczeń, są [**firewalle VPC**](https://cloud.google.com/vpc/docs/firewalls) z regułami zdefiniowanymi na poziomie tej sieci, ale stosowanymi do każdej instancji VM.

### Podsieci

**VPC** może mieć **kilka podsieci**. Każda **podsieć znajduje się w 1 regionie**.

### Firewalle

Domyślnie każda sieć ma dwie [**domyślne reguły firewalla**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **zezwalaj wychodzący** i **zabroń przychodzący**.

Podczas tworzenia projektu GCP tworzona jest również VPC o nazwie **`default`**, z następującymi regułami firewalla:

* **default-allow-internal:** zezwalaj na cały ruch z innych instancji w sieci `default`
* **default-allow-ssh:** zezwalaj na 22 z dowolnego miejsca
* **default-allow-rdp:** zezwalaj na 3389 z dowolnego miejsca
* **default-allow-icmp:** zezwalaj na ping z dowolnego miejsca

{% hint style="warning" %}
Jak widać, **reguły firewalla** mają tendencję do bycia **bardziej permisywnymi** dla **adresów IP wewnętrznych**. Domyślna VPC zezwala na cały ruch między Instancjami Obliczeniowymi.
{% endhint %}

Można tworzyć więcej **reguł firewalla** dla domyślnej VPC lub dla nowych VPC. [**Reguły firewalla**](https://cloud.google.com/vpc/docs/firewalls) można stosować do instancji za pomocą następujących **metod**:

* [**Tagi sieciowe**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Konta usług**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Wszystkie instancje w ramach VPC**

Niestety, nie ma prostego polecenia `gcloud`, które wyświetliłoby wszystkie Instancje Obliczeniowe z otwartymi portami w Internecie. Trzeba połączyć kropki między regułami firewalla, tagami sieciowymi, kontami usług i instancjami.

Ten proces został zautomatyzowany za pomocą [tego skryptu w Pythonie](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum), który wyeksportuje:

* Plik CSV pokazujący instancję, publiczny IP, zezwolone TCP, zezwolone UDP
* skan nmap, aby zbadać wszystkie instancje na porty, z których można przyjmować ruch z publicznego Internetu (0.0.0.0/0)
* masscan, aby zbadać pełny zakres TCP tych instancji, które zezwalają na WSZYSTKIE porty TCP z publicznego Internetu (0.0.0.0/0)

### Hierarchiczne Polityki Firewalla <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Hierarchiczne polityki firewalla_ pozwalają tworzyć i **egzekwować spójną politykę firewalla w całej organizacji**. Można przypisać **hierarchiczne polityki firewalla do organizacji** jako całości lub do poszczególnych **folderów**. Te polityki zawierają reguły, które mogą jawnie blokować lub zezwalać na połączenia.

Tworzenie i stosowanie polityk firewalla odbywa się jako oddzielne kroki. Można tworzyć i stosować polityki firewalla na **węzłach organizacji lub folderów** w [**hierarchii zasobów**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Reguła polityki firewalla może **blokować połączenia, zezwalać na połączenia lub przekazywać ocenę reguły firewalla** do reguł firewalla na niższych poziomach folderów lub zdefiniowanych w sieciach VPC.

Domyślnie wszystkie reguły hierarchicznej polityki firewalla stosują się do wszystkich VM w wszystkich projektach w ramach organizacji lub folderu, w którym polityka jest powiązana. Można jednak **ograniczyć, które VM mają daną regułę**, określając [sieci docelowe lub konta usług](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Możesz przeczytać tutaj, jak [**utworzyć Hierarchiczną Politykę Firewalla**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Ocena Reguł Firewalla

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Org: Polityki firewalla przypisane do Organizacji
2. Folder: Polityki firewalla przypisane do Folderu
3. VPC: Reguły firewalla przypisane do VPC
4. Globalne: Inny rodzaj reguł firewalla, które można przypisać do VPC
5. Regionalne: Reguły firewalla związane z siecią VPC interfejsu sieciowego maszyny wirtualnej i regionem maszyny wirtualnej.

## Połączenie Sieci VPC

Pozwala na połączenie dwóch sieci Virtual Private Cloud (VPC), dzięki czemu **zasoby w każdej sieci mogą się komunikować** między sobą.\
Połączone sieci VPC mogą znajdować się w tym samym projekcie, różnych projektach tej samej organizacji lub **różnych projektach różnych organizacji**.

Oto wymagane uprawnienia:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Więcej w dokumentacji**](https://cloud.google.com/vpc/docs/vpc-peering).

## Odnośniki

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>Zacznij od zera i stań się ekspertem od hakowania AWS dzięki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów na GitHubie.

</details>
