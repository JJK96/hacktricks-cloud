# GCP - VPC & Networking

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

- Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
- Obtenha o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
- **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
- **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## **Rede de Computa√ß√£o GCP em Poucas Palavras**

**VPCs** cont√™m regras de **Firewall** para permitir tr√°fego de entrada para a VPC. As VPCs tamb√©m cont√™m **sub-redes** onde as **m√°quinas virtuais** ser√£o **conectadas**.\
Comparando com a AWS, o **Firewall** seria a coisa mais **pr√≥xima** dos **Grupos de Seguran√ßa e NACLs da AWS**, mas neste caso eles s√£o **definidos na VPC** e n√£o em cada inst√¢ncia.

## **VPC, Sub-redes e Firewalls na GCP**

As Inst√¢ncias de Computa√ß√£o est√£o conectadas a **sub-redes** que fazem parte das **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). Na GCP n√£o existem grupos de seguran√ßa, existem [**firewalls de VPC**](https://cloud.google.com/vpc/docs/firewalls) com regras definidas neste n√≠vel de rede, mas aplicadas a cada Inst√¢ncia de VM.

### Sub-redes

Uma **VPC** pode ter **v√°rias sub-redes**. Cada **sub-rede est√° em 1 regi√£o**.

### Firewalls

Por padr√£o, toda rede tem duas [**regras de firewall impl√≠citas**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **permitir sa√≠da** e **negar entrada**.

Quando um projeto GCP √© criado, uma VPC chamada **`default`** tamb√©m √© criada, com as seguintes regras de firewall:

- **default-allow-internal:** permitir todo o tr√°fego de outras inst√¢ncias na rede `default`
- **default-allow-ssh:** permitir 22 de qualquer lugar
- **default-allow-rdp:** permitir 3389 de qualquer lugar
- **default-allow-icmp:** permitir ping de qualquer lugar

{% hint style="warning" %}
Como voc√™ pode ver, as **regras de firewall** tendem a ser **mais permissivas** para **endere√ßos IP internos**. A VPC padr√£o permite todo o tr√°fego entre Inst√¢ncias de Computa√ß√£o.
{% endhint %}

Mais **regras de firewall** podem ser criadas para a VPC padr√£o ou para novas VPCs. [**Regras de firewall**](https://cloud.google.com/vpc/docs/firewalls) podem ser aplicadas √†s inst√¢ncias atrav√©s dos seguintes **m√©todos**:

- [**Tags de rede**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
- [**Contas de servi√ßo**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
- **Todas as inst√¢ncias dentro de uma VPC**

Infelizmente, n√£o h√° um comando `gcloud` simples para listar todas as Inst√¢ncias de Computa√ß√£o com portas abertas na internet. Voc√™ precisa conectar os pontos entre as regras de firewall, tags de rede, contas de servi√ßo e inst√¢ncias.

Esse processo foi automatizado usando [este script em python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) que exportar√° o seguinte:

- Arquivo CSV mostrando inst√¢ncia, IP p√∫blico, TCP permitido, UDP permitido
- Varredura nmap para todas as inst√¢ncias em portas de entrada permitidas da internet p√∫blica (0.0.0.0/0)
- masscan para direcionar a faixa TCP completa daquelas inst√¢ncias que permitem TODAS as portas TCP da internet p√∫blica (0.0.0.0/0)

### Pol√≠ticas de Firewall Hier√°rquicas <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Pol√≠ticas de firewall hier√°rquicas_ permitem que voc√™ crie e **imponha uma pol√≠tica de firewall consistente em toda a organiza√ß√£o**. Voc√™ pode atribuir **pol√≠ticas de firewall hier√°rquicas √† organiza√ß√£o** como um todo ou a **pastas individuais**. Essas pol√≠ticas cont√™m regras que podem explicitamente negar ou permitir conex√µes.

Voc√™ cria e aplica pol√≠ticas de firewall como etapas separadas. Voc√™ pode criar e aplicar pol√≠ticas de firewall nos **n√≥s de organiza√ß√£o ou pasta da** [**hierarquia de recursos**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Uma regra de pol√≠tica de firewall pode **bloquear conex√µes, permitir conex√µes ou adiar a avalia√ß√£o da regra de firewall** para pastas de n√≠veis inferiores ou regras de firewall de VPC definidas em redes VPC.

Por padr√£o, todas as regras de pol√≠tica de firewall hier√°rquicas se aplicam a todas as VMs em todos os projetos sob a organiza√ß√£o ou pasta onde a pol√≠tica est√° associada. No entanto, voc√™ pode **restringir quais VMs recebem uma determinada regra** especificando [redes de destino ou contas de servi√ßo de destino](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Voc√™ pode ler aqui como [**criar uma Pol√≠tica de Firewall Hier√°rquica**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Avalia√ß√£o de Regras de Firewall

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Org: Pol√≠ticas de firewall atribu√≠das √† Organiza√ß√£o
2. Pasta: Pol√≠ticas de firewall atribu√≠das √† Pasta
3. VPC: Regras de firewall atribu√≠das √† VPC
4. Global: Outro tipo de regras de firewall que podem ser atribu√≠das a VPCs
5. Regional: Regras de firewall associadas √† rede VPC da NIC da VM e regi√£o da VM.

## VPC Network Peering

Permite conectar duas redes de Virtual Private Cloud (VPC) para que **recursos em cada rede possam se comunicar** entre si.\
As redes VPC emparelhadas podem estar no mesmo projeto, em projetos diferentes da mesma organiza√ß√£o ou em **projetos diferentes de organiza√ß√µes diferentes**.

Estas s√£o as permiss√µes necess√°rias:

- `compute.networks.addPeering`
- `compute.networks.updatePeering`
- `compute.networks.removePeering`
- `compute.networks.listPeeringRoutes`

[**Mais na documenta√ß√£o**](https://cloud.google.com/vpc/docs/vpc-peering).

## Refer√™ncias

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
- [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

- Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
- Obtenha o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
- **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
- **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
