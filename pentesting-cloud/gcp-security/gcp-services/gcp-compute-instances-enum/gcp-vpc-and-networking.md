# GCP - VPC & Networking

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodičnu PEASS**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## **GCP Računarsko umrežavanje ukratko**

**VPC-ovi** sadrže **Firewall** pravila koja omogućavaju dolazni saobraćaj u VPC. VPC-ovi takođe sadrže **podmreže** gde će biti **povezane virtuelne mašine**.\
U poređenju sa AWS-om, **Firewall** bi bio **najbliža** stvar **AWS** **Security Groups i NACLs**, ali u ovom slučaju su **definisani u VPC-u** a ne u svakom primerku.

## **VPC, Podmreže i Firewall-ovi u GCP-u**

Računarski instance su povezane **podmrežama** koje su deo **VPC-ova** ([Virtualne privatne mreže](https://cloud.google.com/vpc/docs/vpc)). U GCP-u ne postoje sigurnosne grupe, postoje [**VPC firewall-ovi**](https://cloud.google.com/vpc/docs/firewalls) sa pravilima definisanim na ovom nivou mreže ali primenjenim na svaku VM instancu.

### Podmreže

**VPC** može imati **više podmreža**. Svaka **podmreža je u 1 regionu**.

### Firewall-ovi

Podrazumevano, svaka mreža ima dva [**podrazumevana firewall pravila**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **dozvoli odlazni** i **zabrani dolazni** saobraćaj.

Kada se kreira GCP projekat, takođe se kreira VPC nazvan **`default`**, sa sledećim firewall pravilima:

* **default-allow-internal:** dozvoli sav saobraćaj od drugih instanci na `default` mreži
* **default-allow-ssh:** dozvoli 22 sa bilo kog mesta
* **default-allow-rdp:** dozvoli 3389 sa bilo kog mesta
* **default-allow-icmp:** dozvoli ping sa bilo kog mesta

{% hint style="warning" %}
Kao što možete videti, **firewall pravila** obično su **više dozvoljena** za **internu IP adresu**. Podrazumevani VPC dozvoljava sav saobraćaj između Računarskih Instanci.
{% endhint %}

Može se kreirati više **Firewall pravila** za podrazumevani VPC ili za nove VPC-ove. [**Firewall pravila**](https://cloud.google.com/vpc/docs/firewalls) mogu se primeniti na instance putem sledećih **metoda**:

* [**Mrežni tagovi**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Servisni nalozi**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Sve instance unutar VPC-a**

Nažalost, ne postoji jednostavna `gcloud` komanda koja će izlistati sve Računarske Instance sa otvorenim portovima na internetu. Morate povezati tačke između firewall pravila, mrežnih tagova, servisnih naloga i instanci.

Ovaj proces je automatizovan korišćenjem [ovog python skripta](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) koji će izvesti sledeće:

* CSV fajl koji prikazuje instancu, javnu IP adresu, dozvoljeni TCP, dozvoljeni UDP
* nmap skeniranje svih instanci na portovima koji su dozvoljeni za dolazni saobraćaj sa javnog interneta (0.0.0.0/0)
* masscan za ciljanje punog TCP opsega tih instanci koje dozvoljavaju SVE TCP portove sa javnog interneta (0.0.0.0/0)

### Hijerarhijske Firewall Politike <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Hijerarhijske firewall politike_ vam omogućavaju da kreirate i **sprovedete doslednu firewall politiku širom vaše organizacije**. Možete dodeliti **hijerarhijske firewall politike organizaciji** u celini ili pojedinačnim **folderima**. Ove politike sadrže pravila koja mogu eksplicitno zabraniti ili dozvoliti konekcije.

Kreirate i primenjujete firewall politike kao odvojene korake. Možete kreirati i primeniti firewall politike na **čvorovima organizacije ili foldera** [**hijerarhije resursa**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Pravilo firewall politike može **blokirati konekcije, dozvoliti konekcije ili odložiti evaluaciju pravila firewall-a** na nižim nivoima foldera ili VPC firewall pravila definisana u VPC mrežama.

Podrazumevano, sva pravila hijerarhijske firewall politike se primenjuju na sve VM-ove u svim projektima pod organizacijom ili folderom gde je politika povezana. Međutim, možete **ograničiti kojim VM-ovima se dodeljuje dato pravilo** specificiranjem [ciljnih mreža ili ciljnih servisnih naloga](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Možete pročitati ovde kako [**kreirati Hijerarhijsku Firewall Politiku**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Evaluacija Pravila Firewall-a

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Org: Firewall politike dodeljene Organizaciji
2. Folder: Firewall politike dodeljene Folderu
3. VPC: Firewall pravila dodeljena VPC-u
4. Globalno: Još jedan tip firewall pravila koji se može dodeliti VPC-ovima
5. Regionalno: Firewall pravila povezana sa VPC mrežom NIC-a VM-a i regionom VM-a.

## Povezivanje VPC Mreža

Omogućava povezivanje dve Virtualne privatne mreže (VPC) tako da **resursi u svakoj mreži mogu komunicirati** jedni sa drugima.\
Povezane VPC mreže mogu biti u istom projektu, različitim projektima iste organizacije, ili **različitim projektima različitih organizacija**.

Potrebne dozvole su:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Više u dokumentaciji**](https://cloud.google.com/vpc/docs/vpc-peering).

## Reference

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodičnu PEASS**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
