# GCP - Compute Enum

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## GCP VPC & Networking

Μάθετε πώς λειτουργεί αυτό στο:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumeration

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

Μπορείτε εύκολα να βρείτε compute instances με ανοιχτούς κανόνες firewall με [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Compute instances

Αυτός είναι ο τρόπος που μπορείτε να **τρέξετε εικονικές μηχανές μέσα στο GCP.** Ελέγξτε αυτή τη σελίδα για περισσότερες πληροφορίες:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Enumeration
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Για περισσότερες πληροφορίες σχετικά με το πώς να **SSH** ή **τροποποιήσετε τα metadata** μιας instance για **κλιμάκωση προνομίων,** ελέγξτε αυτή τη σελίδα:

{% content-ref url="../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Κλιμάκωση Προνομίων

Στην ακόλουθη σελίδα, μπορείτε να δείτε πώς να **εκμεταλλευτείτε compute permissions για κλιμάκωση προνομίων**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Μη Αυθεντικοποιημένη Απαρίθμηση

{% content-ref url="../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Μετά την Εκμετάλλευση

{% content-ref url="../../gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Εμμονή

{% content-ref url="../../gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Καταγραφές Σειριακής Κονσόλας

Οι Καταγραφές Σειριακής Κονσόλας του Compute Engine είναι μια δυνατότητα που σας επιτρέπει να **προβάλλετε και να διαγνώσετε τις καταγραφές εκκίνησης και λειτουργικού συστήματος** των instances της εικονικής σας μηχανής.

Οι Καταγραφές Σειριακής Κονσόλας παρέχουν μια **χαμηλού επιπέδου προβολή της διαδικασίας εκκίνησης της instance**, συμπεριλαμβανομένων των μηνυμάτων του kernel, των init scripts και άλλων συμβάντων συστήματος που συμβαίνουν κατά την εκκίνηση. Αυτό μπορεί να είναι χρήσιμο για την αποσφαλμάτωση προβλημάτων εκκίνησης, τον εντοπισμό λανθασμένων ρυθμίσεων ή σφαλμάτων λογισμικού, ή την αντιμετώπιση προβλημάτων συνδεσιμότητας δικτύου.

Αυτές οι καταγραφές **μπορεί να αποκαλύψουν ευαίσθητες πληροφορίες** από τις καταγραφές συστήματος που ένας χρήστης με χαμηλά προνόμια συνήθως δεν μπορεί να δει, αλλά με τις κατάλληλες IAM permissions μπορεί να τις διαβάσει.

Μπορείτε να χρησιμοποιήσετε την ακόλουθη [gcloud command](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) για να ερωτήσετε τις καταγραφές σειριακής θύρας (η απαιτούμενη άδεια είναι `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Startup Scripts output

Είναι δυνατό να δείτε την **έξοδο των startup scripts** από την VM εκτελώντας:
```bash
sudo journalctl -u google-startup-scripts.service
```
## OS Configuration Manager

Μπορείτε να χρησιμοποιήσετε την υπηρεσία διαχείρισης διαμόρφωσης OS για να **αναπτύξετε, να ερωτήσετε και να διατηρήσετε συνεπείς διαμορφώσεις** (επιθυμητή κατάσταση και λογισμικό) για την VM instance (VM) σας. Στο Compute Engine, πρέπει να χρησιμοποιήσετε [guest policies](https://cloud.google.com/compute/docs/os-config-management#guest-policy) για να διατηρήσετε συνεπείς διαμορφώσεις λογισμικού σε μια VM.

Η δυνατότητα διαχείρισης διαμόρφωσης OS σας επιτρέπει να ορίσετε πολιτικές διαμόρφωσης που καθορίζουν ποια πακέτα λογισμικού πρέπει να εγκατασταθούν, ποιες υπηρεσίες πρέπει να ενεργοποιηθούν και ποια αρχεία ή διαμορφώσεις πρέπει να υπάρχουν στις VMs σας. Μπορείτε να χρησιμοποιήσετε μια δηλωτική προσέγγιση για τη διαχείριση της διαμόρφωσης λογισμικού των VMs σας, η οποία σας επιτρέπει να αυτοματοποιήσετε και να κλιμακώσετε τη διαδικασία διαχείρισης διαμόρφωσης πιο εύκολα.

Αυτό επίσης επιτρέπει τη σύνδεση σε instances μέσω IAM permissions, οπότε είναι πολύ **χρήσιμο για privesc και pivoting**.

{% hint style="warning" %}
Για να **ενεργοποιήσετε το os-config σε ολόκληρο το project ή σε μια instance** απλά πρέπει να ορίσετε το **metadata** key **`enable-oslogin`** σε **`true`** στο επιθυμητό επίπεδο.\
Επιπλέον, μπορείτε να ορίσετε το metadata **`enable-oslogin-2fa`** σε **`true`** για να ενεργοποιήσετε το 2fa.

Όταν το ενεργοποιείτε κατά τη δημιουργία μιας instance, τα metadata keys θα οριστούν αυτόματα.
{% endhint %}

Περισσότερα για το **2fa στο OS-config**, **ισχύει μόνο αν ο χρήστης είναι χρήστης**, αν είναι SA (όπως το compute SA) δεν θα απαιτείται τίποτα επιπλέον.

### Enumeration
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Images

### Custom Images

**Οι προσαρμοσμένες εικόνες υπολογιστών μπορεί να περιέχουν ευαίσθητες λεπτομέρειες** ή άλλες ευάλωτες διαμορφώσεις που μπορείτε να εκμεταλλευτείτε.

Όταν δημιουργείται μια εικόνα, μπορείτε να επιλέξετε **3 τύπους κρυπτογράφησης**: Χρησιμοποιώντας **κλειδί διαχειριζόμενο από την Google** (προεπιλογή), ένα **κλειδί από KMS**, ή ένα **ακατέργαστο κλειδί** που δίνεται από τον πελάτη.

#### Enumeration

Μπορείτε να ερωτήσετε τη λίστα των μη τυποποιημένων εικόνων σε ένα έργο με την ακόλουθη εντολή:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Μπορείτε στη συνέχεια να [**εξάγετε**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **τους εικονικούς δίσκους** από οποιαδήποτε εικόνα σε πολλαπλές μορφές. Η ακόλουθη εντολή θα εξάγει την εικόνα `test-image` σε μορφή qcow2, επιτρέποντάς σας να κατεβάσετε το αρχείο και να δημιουργήσετε ένα VM τοπικά για περαιτέρω έρευνα:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Privilege Escalation

Ελέγξτε την ενότητα Privilege Escalation των Compute Instances.

### Custom Instance Templates

Ένα [**instance template**](https://cloud.google.com/compute/docs/instance-templates/) **ορίζει τις ιδιότητες του instance** για να βοηθήσει στην ανάπτυξη συνεπών διαμορφώσεων. Αυτά μπορεί να περιέχουν τους ίδιους τύπους ευαίσθητων δεδομένων όπως τα custom metadata ενός τρέχοντος instance. Μπορείτε να χρησιμοποιήσετε τις παρακάτω εντολές για να ερευνήσετε:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Θα μπορούσε να είναι ενδιαφέρον να γνωρίζουμε ποιος δίσκος χρησιμοποιεί νέες εικόνες, αλλά αυτά τα templates συνήθως δεν θα έχουν ευαίσθητες πληροφορίες.

## Snapshots

Τα **snapshots είναι αντίγραφα ασφαλείας των δίσκων**. Σημειώστε ότι αυτό δεν είναι το ίδιο με την κλωνοποίηση ενός δίσκου (άλλη διαθέσιμη δυνατότητα).\
Το **snapshot** θα χρησιμοποιήσει την **ίδια κρυπτογράφηση με τον δίσκο** από τον οποίο έχει ληφθεί.

### Enumeration
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Αύξηση Προνομίων

Ελέγξτε την ενότητα αύξησης προνομίων των Compute Instances.

## Αναφορές

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
