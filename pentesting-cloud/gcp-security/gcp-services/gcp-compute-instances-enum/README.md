# GCP - Compute Enum

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## GCP VPC & Networking

Lerne, wie dies funktioniert in:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumeration

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

Sie finden leicht Compute-Instanzen mit offenen Firewall-Regeln mit [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Compute-Instanzen

Dies ist die M√∂glichkeit, **virtuelle Maschinen innerhalb von GCP auszuf√ºhren.** Weitere Informationen finden Sie auf dieser Seite:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Enumeration
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
F√ºr weitere Informationen dar√ºber, wie man **SSH** oder **Metadaten einer Instanz modifiziert**, um **Privilegien zu eskalieren**, besuchen Sie diese Seite:

{% content-ref url="../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Privilegieneskalation

Auf der folgenden Seite k√∂nnen Sie nachlesen, wie man **Compute-Berechtigungen missbraucht, um Privilegien zu eskalieren**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Unauthentifizierte Enumeration

{% content-ref url="../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../../gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Persistenz

{% content-ref url="../../gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Serielle Konsolenprotokolle

Compute Engine Serielle Konsolenprotokolle sind eine Funktion, die es erm√∂glicht, **Boot- und Betriebssystemprotokolle** Ihrer virtuellen Maschineninstanzen **anzuzeigen und zu diagnostizieren**.

Serielle Konsolenprotokolle bieten eine **niedrigstufige Ansicht des Bootvorgangs der Instanz**, einschlie√ülich Kernel-Meldungen, Init-Skripten und anderen Systemereignissen, die w√§hrend des Bootvorgangs auftreten. Dies kann n√ºtzlich sein, um Boot-Probleme zu debuggen, Fehlkonfigurationen oder Softwarefehler zu identifizieren oder Netzwerkverbindungsprobleme zu beheben.

Diese Protokolle **k√∂nnen sensible Informationen** aus den Systemprotokollen offenlegen, die ein Benutzer mit niedrigen Privilegien normalerweise nicht sehen kann. Mit den entsprechenden IAM-Berechtigungen k√∂nnen Sie jedoch m√∂glicherweise darauf zugreifen.

Sie k√∂nnen den folgenden [gcloud-Befehl](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) verwenden, um die seriellen Portprotokolle abzufragen (die erforderliche Berechtigung ist `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Startup Scripts output

Es ist m√∂glich, die **Ausgabe der Startup-Skripte** von der VM zu sehen, indem man folgendes ausf√ºhrt:
```bash
sudo journalctl -u google-startup-scripts.service
```
## OS Configuration Manager

Sie k√∂nnen den OS-Konfigurationsverwaltungsdienst verwenden, um **konsistente Konfigurationen** (gew√ºnschter Zustand und Software) f√ºr Ihre VM-Instanz (VM) zu **bereitstellen, abzufragen und zu pflegen**. Auf Compute Engine m√ºssen Sie [Gast-Richtlinien](https://cloud.google.com/compute/docs/os-config-management#guest-policy) verwenden, um konsistente Softwarekonfigurationen auf einer VM zu pflegen.

Die OS-Konfigurationsverwaltungsfunktion erm√∂glicht es Ihnen, Konfigurationsrichtlinien zu definieren, die angeben, welche Softwarepakete installiert werden sollen, welche Dienste aktiviert werden sollen und welche Dateien oder Konfigurationen auf Ihren VMs vorhanden sein sollen. Sie k√∂nnen einen deklarativen Ansatz zur Verwaltung der Softwarekonfiguration Ihrer VMs verwenden, der es Ihnen erm√∂glicht, Ihren Konfigurationsverwaltungsprozess einfacher zu automatisieren und zu skalieren.

Dies erm√∂glicht auch das Einloggen in Instanzen √ºber IAM-Berechtigungen, was sehr **n√ºtzlich f√ºr privesc und pivoting** ist.

{% hint style="warning" %}
Um **os-config in einem gesamten Projekt oder in einer Instanz zu aktivieren**, m√ºssen Sie nur den **Metadaten**-Schl√ºssel **`enable-oslogin`** auf **`true`** auf der gew√ºnschten Ebene setzen.\
Dar√ºber hinaus k√∂nnen Sie die Metadaten **`enable-oslogin-2fa`** auf **`true`** setzen, um die 2fa zu aktivieren.

Wenn Sie es beim Erstellen einer Instanz aktivieren, werden die Metadatenschl√ºssel automatisch gesetzt.
{% endhint %}

Mehr √ºber **2fa in OS-config**, **es gilt nur, wenn der Benutzer ein Benutzer ist**, wenn es sich um ein SA (wie das compute SA) handelt, wird nichts Zus√§tzliches ben√∂tigt.

### Enumeration
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Images

### Custom Images

**Benutzerdefinierte Compute-Images k√∂nnen sensible Details** oder andere anf√§llige Konfigurationen enthalten, die Sie ausnutzen k√∂nnen.

Wenn ein Image erstellt wird, k√∂nnen Sie **3 Arten der Verschl√ºsselung** w√§hlen: Verwendung eines **von Google verwalteten Schl√ºssels** (Standard), eines **Schl√ºssels aus KMS** oder eines **rohen Schl√ºssels**, der vom Kunden bereitgestellt wird.

#### Enumeration

Sie k√∂nnen die Liste der nicht standardm√§√üigen Images in einem Projekt mit dem folgenden Befehl abfragen:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Sie k√∂nnen dann [**exportieren**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **die virtuellen Festplatten** von jedem Image in mehreren Formaten. Der folgende Befehl w√ºrde das Image `test-image` im qcow2-Format exportieren, sodass Sie die Datei herunterladen und eine VM lokal f√ºr weitere Untersuchungen erstellen k√∂nnen:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Privilege Escalation

√úberpr√ºfen Sie den Abschnitt zur Privilegieneskalation von Compute Instances.

### Custom Instance Templates

Eine [**instance template**](https://cloud.google.com/compute/docs/instance-templates/) **definiert Instanzeigenschaften**, um konsistente Konfigurationen bereitzustellen. Diese k√∂nnen dieselben Arten von sensiblen Daten enthalten wie die benutzerdefinierten Metadaten einer laufenden Instanz. Sie k√∂nnen die folgenden Befehle verwenden, um dies zu untersuchen:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Es k√∂nnte interessant sein zu wissen, welche Festplatte neue Images verwenden, aber diese Vorlagen enthalten normalerweise keine sensiblen Informationen.

## Snapshots

Die **Snapshots sind Sicherungskopien von Festplatten**. Beachten Sie, dass dies nicht dasselbe ist wie das Klonen einer Festplatte (eine andere verf√ºgbare Funktion).\
Der **Snapshot** verwendet die **gleiche Verschl√ºsselung wie die Festplatte**, von der er erstellt wurde.

### Enumeration
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Privilege Escalation

√úberpr√ºfen Sie den Abschnitt zur Privilegieneskalation von Compute Instances.

## References

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichen.

</details>
{% endhint %}
