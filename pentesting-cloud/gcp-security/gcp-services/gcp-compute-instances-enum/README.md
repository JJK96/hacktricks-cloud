# GCP - Compute Enum

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek hacking ipuçlarını paylaşın.

</details>
{% endhint %}

## GCP VPC & Networking

Bu konunun nasıl çalıştığını öğrenin:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumeration

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

Açık firewall kuralları olan compute instance'larını kolayca bulabilirsiniz: [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Compute instances

Bu, **GCP içinde sanal makineler çalıştırmanın** yoludur. Daha fazla bilgi için bu sayfayı kontrol edin:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Enumeration
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Daha fazla bilgi için bir örneğin **SSH** veya **metadata'sini değiştirme** hakkında **ayrıcalıkları yükseltmek** için bu sayfayı kontrol edin:

{% content-ref url="../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Ayrıcalık Yükseltme

Aşağıdaki sayfada, **hesaplama izinlerini kötüye kullanarak ayrıcalıkları nasıl yükseltebileceğinizi** kontrol edebilirsiniz:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Kimlik Doğrulaması Olmayan Enum

{% content-ref url="../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Sömürü Sonrası

{% content-ref url="../../gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Kalıcılık

{% content-ref url="../../gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Seri Konsol Günlükleri

Compute Engine Seri Konsol Günlükleri, sanal makine örneklerinizin **önyükleme ve işletim sistemi günlüklerini görüntülemenizi ve teşhis etmenizi** sağlayan bir özelliktir.

Seri Konsol Günlükleri, örneğin **önyükleme sürecinin düşük seviyeli bir görünümünü** sağlar, kernel mesajları, init scriptleri ve önyükleme sırasında meydana gelen diğer sistem olaylarını içerir. Bu, önyükleme sorunlarını ayıklamak, yanlış yapılandırmaları veya yazılım hatalarını belirlemek veya ağ bağlantısı sorunlarını gidermek için yararlı olabilir.

Bu günlükler, **düşük ayrıcalıklı bir kullanıcının genellikle göremeyeceği sistem günlüklerinden hassas bilgileri açığa çıkarabilir**, ancak uygun IAM izinleriyle bunları okuyabilirsiniz.

Seri port günlüklerini sorgulamak için aşağıdaki [gcloud komutunu](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) kullanabilirsiniz (gerekli izin `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Startup Scripts çıktısı

VM'den **startup scripts çıktısını** görmek mümkündür, bunun için şu komut çalıştırılır:
```bash
sudo journalctl -u google-startup-scripts.service
```
## OS Configuration Manager

VM instance'ınız (VM) için **tutarlı yapılandırmaları dağıtmak, sorgulamak ve sürdürmek** amacıyla OS yapılandırma yönetim hizmetini kullanabilirsiniz. Compute Engine'de, bir VM'de tutarlı yazılım yapılandırmalarını sürdürmek için [guest policies](https://cloud.google.com/compute/docs/os-config-management#guest-policy) kullanmalısınız.

OS Configuration yönetim özelliği, hangi yazılım paketlerinin yükleneceğini, hangi hizmetlerin etkinleştirileceğini ve VM'lerinizde hangi dosya veya yapılandırmaların bulunması gerektiğini belirten yapılandırma politikaları tanımlamanıza olanak tanır. VM'lerinizin yazılım yapılandırmasını yönetmek için deklaratif bir yaklaşım kullanabilirsiniz, bu da yapılandırma yönetim sürecinizi daha kolay otomatikleştirmenizi ve ölçeklendirmenizi sağlar.

Bu aynı zamanda IAM izinleri aracılığıyla instance'lara giriş yapmayı sağlar, bu nedenle **privesc ve pivoting** için çok **kullanışlıdır**.

{% hint style="warning" %}
Bir projede veya bir instance'da **os-config'i etkinleştirmek için** sadece **metadata** anahtarını **`enable-oslogin`** olarak **`true`** ayarlamanız yeterlidir.\
Ayrıca, 2fa'yı etkinleştirmek için metadata **`enable-oslogin-2fa`** anahtarını **`true`** olarak ayarlayabilirsiniz.

Bir instance oluştururken bunu etkinleştirdiğinizde metadata anahtarları otomatik olarak ayarlanacaktır.
{% endhint %}

OS-config'te **2fa hakkında daha fazla bilgi**, **yalnızca kullanıcı bir kullanıcıysa geçerlidir**, eğer bir SA ise (örneğin compute SA gibi) ekstra bir şey gerektirmez.

### Enumeration
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Images

### Custom Images

**Özel compute görüntüleri hassas ayrıntılar** veya yararlanabileceğiniz diğer savunmasız yapılandırmalar içerebilir.

Bir görüntü oluşturulduğunda **3 tür şifreleme** seçebilirsiniz: **Google yönetimli anahtar** (varsayılan), **KMS'den bir anahtar** veya müşteri tarafından verilen **ham anahtar** kullanarak.

#### Enumeration

Bir projedeki standart olmayan görüntülerin listesini aşağıdaki komutla sorgulayabilirsiniz:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Ardından, herhangi bir görüntüden **sanallaştırma disklerini** birden fazla formatta [**dışa aktarabilirsiniz**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export). Aşağıdaki komut, `test-image` görüntüsünü qcow2 formatında dışa aktarır, dosyayı indirmenize ve daha fazla inceleme için yerel olarak bir VM oluşturmanıza olanak tanır:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Ayrıcalık Yükseltme

Compute Instances ayrıcalık yükseltme bölümünü kontrol edin.

### Özel Örnek Şablonları

Bir [**instance template**](https://cloud.google.com/compute/docs/instance-templates/) **örnek özelliklerini tanımlar** ve tutarlı yapılandırmalar dağıtmaya yardımcı olur. Bunlar, çalışan bir örneğin özel meta verileriyle aynı türde hassas verileri içerebilir. Araştırmak için aşağıdaki komutları kullanabilirsiniz:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Yeni görüntülerin hangi diski kullandığını bilmek ilginç olabilir, ancak bu şablonlar genellikle hassas bilgi içermez.

## Snapshots

**Snapshots, disklerin yedekleridir**. Bunun bir diski klonlamakla (başka bir mevcut özellik) aynı olmadığını unutmayın.\
**Snapshot**, alındığı diskin **aynı şifrelemesini** kullanacaktır.

### Enumeration
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Ayrıcalık Yükseltme

Compute Instances ayrıcalık yükseltme bölümünü kontrol edin.

## Referanslar

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks ve** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github depolarına PR göndererek hacking ipuçlarını paylaşın.**

</details>
{% endhint %}
