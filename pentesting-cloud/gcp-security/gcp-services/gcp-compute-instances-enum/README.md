# GCP - Compute Enum

{% hint style="success" %}
AWSハッキングを学び、練習する:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングを学び、練習する: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローする。**
* **PRを提出してハッキングトリックを共有する** [**HackTricks**](https://github.com/carlospolop/hacktricks) および [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubリポジトリ。

</details>
{% endhint %}

## GCP VPC & Networking

これがどのように機能するかを学ぶ:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumeration

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

[https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum) を使用して、オープンなファイアウォールルールを持つ compute instances を簡単に見つけることができます。

## Compute instances

これは、**GCP 内で仮想マシンを実行する方法です。** 詳細については、このページを確認してください:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Enumeration
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
詳細については、インスタンスの**SSH**または**メタデータの変更**による**権限昇格**について、このページを参照してください:

{% content-ref url="../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### 権限昇格

次のページでは、**compute permissionsを悪用して権限を昇格させる方法**を確認できます:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### 認証なしの列挙

{% content-ref url="../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### ポストエクスプロイト

{% content-ref url="../../gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### 永続化

{% content-ref url="../../gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## シリアルコンソールログ

Compute Engine シリアルコンソールログは、仮想マシンインスタンスの**ブートおよびオペレーティングシステムのログを表示および診断**する機能です。

シリアルコンソールログは、カーネルメッセージ、initスクリプト、およびブート中に発生するその他のシステムイベントを含む、インスタンスのブートプロセスの**低レベルビュー**を提供します。これにより、ブートの問題のデバッグ、設定ミスやソフトウェアエラーの特定、ネットワーク接続の問題のトラブルシューティングに役立ちます。

これらのログは、通常低権限のユーザーが見ることができないシステムログからの**機密情報を露出する可能性**がありますが、適切なIAM権限があればそれらを読むことができます。

次の[gcloudコマンド](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output)を使用してシリアルポートログをクエリできます（必要な権限は`compute.instances.getSerialPortOutput`です）:
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Startup Scripts output

VMを実行している**スタートアップスクリプトの出力**を確認することができます:
```bash
sudo journalctl -u google-startup-scripts.service
```
## OS Configuration Manager

OS 構成管理サービスを使用して、VM インスタンス (VM) の**一貫した構成 (望ましい状態とソフトウェア) をデプロイ、クエリ、および維持**できます。Compute Engine では、VM 上の一貫したソフトウェア構成を維持するために [guest policies](https://cloud.google.com/compute/docs/os-config-management#guest-policy) を使用する必要があります。

OS 構成管理機能を使用すると、インストールするソフトウェアパッケージ、有効にするサービス、および VM 上に存在する必要があるファイルや構成を指定する構成ポリシーを定義できます。VM のソフトウェア構成を管理するために宣言型アプローチを使用できるため、構成管理プロセスをより簡単に自動化およびスケールできます。

これにより、IAM 権限を介してインスタンスにログインすることも可能になるため、**privesc および pivoting に非常に役立ちます**。

{% hint style="warning" %}
**プロジェクト全体またはインスタンスで os-config を有効にする**には、目的のレベルで **metadata** キー **`enable-oslogin`** を **`true`** に設定するだけです。\
さらに、metadata **`enable-oslogin-2fa`** を **`true`** に設定して 2fa を有効にすることもできます。

インスタンスを作成する際にこれを有効にすると、metadata キーが自動的に設定されます。
{% endhint %}

**OS-config の 2fa** について詳しく説明すると、**ユーザーがユーザーである場合にのみ適用されます**。SA (compute SA など) の場合は追加の要件はありません。

### Enumeration
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Images

### Custom Images

**カスタムコンピュートイメージには機密情報**や他の脆弱な設定が含まれている可能性があり、これを悪用することができます。

イメージを作成する際に、**3種類の暗号化**を選択できます: **Google管理キー**（デフォルト）、**KMSからのキー**、またはクライアントが提供する**生のキー**です。

#### Enumeration

次のコマンドを使用して、プロジェクト内の非標準イメージのリストを照会できます:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

次に、任意のイメージから複数のフォーマットで**仮想ディスク**を[**エクスポート**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export)できます。以下のコマンドは、qcow2フォーマットでイメージ`test-image`をエクスポートし、ファイルをダウンロードしてローカルでVMを構築し、さらに調査を行うことができます:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Privilege Escalation

Compute Instances privilege escalation セクションを確認してください。

### Custom Instance Templates

[**instance template**](https://cloud.google.com/compute/docs/instance-templates/) **はインスタンスのプロパティを定義**し、一貫した構成を展開するのに役立ちます。これらは、実行中のインスタンスのカスタムメタデータと同じ種類の機密データを含む場合があります。調査するには、次のコマンドを使用できます:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
新しいイメージがどのディスクを使用しているかを知ることは興味深いかもしれませんが、これらのテンプレートには通常、機密情報は含まれていません。

## Snapshots

**snapshotsはディスクのバックアップ**です。これはディスクのクローン作成（別の利用可能な機能）とは異なることに注意してください。\
**snapshot**は、取得元のディスクと**同じ暗号化**を使用します。

### Enumeration
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Privilege Escalation

Compute Instances の特権昇格セクションを確認してください。

## References

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

{% hint style="success" %}
AWS Hacking を学び、練習する:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking を学び、練習する: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks をサポートする</summary>

* [**subscription plans**](https://github.com/sponsors/carlospolop) を確認してください！
* **💬 [**Discord group**](https://discord.gg/hRep4RUj7f) または [**telegram group**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** をフォローしてください。**
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks) および [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github リポジトリに PR を提出してください。

</details>
{% endhint %}
