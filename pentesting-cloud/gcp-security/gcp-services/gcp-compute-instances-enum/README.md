# GCP - Compute Enum

{% hint style="success" %}
Leer en oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer en oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repo's.

</details>
{% endhint %}

## GCP VPC & Netwerking

Leer hoe dit werk in:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumerasie

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

Jy vind maklik compute instances met oop firewall re√´ls met [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Compute instances

Dit is die manier waarop jy **virtuele masjiene binne GCP kan laat loop.** Kyk na hierdie bladsy vir meer inligting:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Enumerasie
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Vir meer inligting oor hoe om **SSH** of **die metadata te wysig** van 'n instansie om **voorregte te verhoog,** kyk na hierdie bladsy:

{% content-ref url="../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Voorregverhoging

Op die volgende bladsy kan jy sien hoe om **compute permissions te misbruik om voorregte te verhoog**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Onauthentiseerde Enum

{% content-ref url="../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Eksploitasie

{% content-ref url="../../gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Volharding

{% content-ref url="../../gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Seri√´le Konsol Logs

Compute Engine Seri√´le Konsol Logs is 'n funksie wat jou toelaat om **die opstart- en bedryfstelsel logs van jou virtuele masjien instansies te sien en te diagnoseer.**

Seri√´le Konsol Logs bied 'n **laagvlak uitsig van die instansie se opstartproses**, insluitend kernboodskappe, init-skripte, en ander stelselgebeurtenisse wat tydens opstart plaasvind. Dit kan nuttig wees vir die ontfouting van opstartprobleme, die identifisering van verkeerde konfigurasies of sagtewarefoute, of die oplos van netwerkverbindingsprobleme.

Hierdie logs **kan sensitiewe inligting blootstel** uit die stelsel logs wat 'n lae voorreggebruiker gewoonlik nie sal sien nie, maar met die toepaslike IAM voorregte kan jy dalk in staat wees om dit te lees.

Jy kan die volgende [gcloud opdrag](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) gebruik om die seri√´le poort logs te navraag (die toestemming wat benodig word is `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Startup Scripts-uitset

Dit is moontlik om die **uitset van die opstartskripte** van die VM te sien deur uit te voer:
```bash
sudo journalctl -u google-startup-scripts.service
```
## OS Configuration Manager

Jy kan die OS-konfigurasiebestuurdiens gebruik om **konsekwente konfigurasies te ontplooi, navraag te doen en te onderhou** (gewenste toestand en sagteware) vir jou VM-instansie (VM). Op Compute Engine moet jy [guest policies](https://cloud.google.com/compute/docs/os-config-management#guest-policy) gebruik om konsekwente sagtewarekonfigurasies op 'n VM te onderhou.

Die OS-konfigurasiebestuursfunksie laat jou toe om konfigurasiebeleide te definieer wat spesifiseer watter sagtewarepakkette ge√Ønstalleer moet word, watter dienste geaktiveer moet word, en watter l√™ers of konfigurasies op jou VMs teenwoordig moet wees. Jy kan 'n deklaratiewe benadering gebruik om die sagtewarekonfigurasie van jou VMs te bestuur, wat jou in staat stel om jou konfigurasiebestuursproses makliker te outomatiseer en te skaal.

Dit laat ook toe om in instansies aan te meld via IAM-permissies, so dit is baie **nuttig vir privesc en pivoting**.

{% hint style="warning" %}
Om **os-config in 'n hele projek of in 'n instansie te aktiveer** moet jy net die **metadata** sleutel **`enable-oslogin`** stel op **`true`** op die verlangde vlak.\
Boonop kan jy die metadata **`enable-oslogin-2fa`** stel op **`true`** om die 2fa te aktiveer.

Wanneer jy dit aktiveer wanneer jy 'n instansie skep, sal die metadata sleutels outomaties gestel word.
{% endhint %}

Meer oor **2fa in OS-config**, **dit geld slegs as die gebruiker 'n gebruiker is**, as dit 'n SA is (soos die compute SA) sal dit niks ekstra vereis nie.

### Enumeration
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Images

### Custom Images

**Pasgemaakte compute-beelde mag sensitiewe besonderhede bevat** of ander kwesbare konfigurasies wat jy kan uitbuit.

Wanneer 'n beeld geskep word, kan jy **3 tipes enkripsie** kies: Gebruik **Google bestuurde sleutel** (verstek), 'n **sleutel van KMS**, of 'n **rou sleutel** gegee deur die kli√´nt.

#### Enumerasie

Jy kan die lys van nie-standaard beelde in 'n projek opvra met die volgende opdrag:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Jy kan dan [**uitvoer**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **die virtuele skywe** van enige beeld in verskeie formate. Die volgende opdrag sal die beeld `test-image` in qcow2-formaat uitvoer, wat jou toelaat om die l√™er af te laai en 'n VM plaaslik te bou vir verdere ondersoek:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Privilege Escalation

Kyk na die Compute Instances privilege escalation afdeling.

### Custom Instance Templates

'n [**instance template**](https://cloud.google.com/compute/docs/instance-templates/) **definieer instansie-eienskappe** om te help om konsekwente konfigurasies te ontplooi. Hierdie kan dieselfde tipe sensitiewe data bevat as 'n lopende instansie se pasgemaakte metadata. Jy kan die volgende opdragte gebruik om te ondersoek:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Dit kan interessant wees om te weet watter skyf nuwe beelde gebruik, maar hierdie templates sal gewoonlik nie sensitiewe inligting h√™ nie.

## Snapshots

Die **snapshots is rugsteunkopie√´ van skywe**. Let daarop dat dit nie dieselfde is as om 'n skyf te kloon nie (nog 'n beskikbare funksie).\
Die **snapshot** sal dieselfde **enkripsie gebruik as die skyf** waarvan dit geneem is.

### Enumerasie
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Privilege Escalation

Kyk na die Compute Instances privilege escalation afdeling.

## Verwysings

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking tricks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
