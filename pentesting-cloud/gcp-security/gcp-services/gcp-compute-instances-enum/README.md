# GCP - Kuchunguza Enum

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## GCP VPC & Uunganisho

Jifunze kuhusu jinsi hii inavyofanya kazi katika:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Uchunguzi
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

Unaweza kwa urahisi kupata mifano ya kuhesabu na sheria za firewall zilizofunguliwa kwa kutumia [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Mifano ya Kuhesabu

Hii ndio njia unayoweza **kuzindua mashine za kawaida ndani ya GCP.** Angalia ukurasa huu kwa maelezo zaidi:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Uthibitishaji
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
### Kupanda Hadhi

Kwenye ukurasa ufuatao, unaweza kuangalia jinsi ya **kutumia ruhusa za kuhesabu kwa kupanda hadhi**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Uchunguzi Usiothibitishwa

{% content-ref url="../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Baada ya Kuvamia

{% content-ref url="../../gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Uthabiti

{% content-ref url="../../gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Vipakazi vya Konsoli ya Mfululizo

Vipakazi vya Konsoli ya Mfululizo wa Compute Engine ni kipengele kinachokuwezesha **kuona na kutambua magogo ya kuanza na mfumo wa uendeshaji** wa mifano yako ya mashine za virtuali.

Vipakazi vya Konsoli ya Mfululizo hutoa **mtazamo wa kiwango cha chini wa mchakato wa kuanza kwa kifaa**, ikiwa ni pamoja na ujumbe wa kernel, mipango ya kuanzisha, na matukio mengine ya mfumo yanayotokea wakati wa kuanza. Hii inaweza kuwa na manufaa kwa kutatua matatizo ya kuanza, kutambua makosa ya usanidi au programu, au kutatua matatizo ya uunganisho wa mtandao.

Vipakazi hivi **vinaweza kufichua habari nyeti** kutoka kwenye magogo ya mfumo ambayo mtumiaji mwenye ruhusa ndogo kawaida hawezi kuona, lakini kwa ruhusa sahihi ya IAM unaweza kusoma.

Unaweza kutumia [amri ya gcloud ifuatayo](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) kutafuta magogo ya bandari ya mfululizo (ruhusa inayohitajika ni `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Matokeo ya Scripts za Kuanza

Inawezekana kuona **matokeo ya scripts za kuanza** kutoka kwa VM ikitekeleza:
```bash
sudo journalctl -u google-startup-scripts.service
```
## Meneja wa Usanidi wa OS

Unaweza kutumia huduma ya usimamizi wa usanidi wa OS kwa **kupeleka, kuuliza, na kudumisha usanidi thabiti** (hali iliyokusudiwa na programu) kwa kifaa chako cha VM (VM). Kwenye Compute Engine, lazima utumie [sera za mgeni](https://cloud.google.com/compute/docs/os-config-management#guest-policy) kudumisha usanidi thabiti wa programu kwenye VM.

Kipengele cha usimamizi wa usanidi wa OS kinakuruhusu kufafanua sera za usanidi ambazo zinaeleza ni pakiti zipi za programu zinapaswa kusakinishwa, ni huduma zipi zinapaswa kuwezeshwa, na ni faili au usanidi upi unapaswa kuwepo kwenye VM yako. Unaweza kutumia njia ya kielezi katika kusimamia usanidi wa programu kwenye VM zako, ambayo inakuruhusu kiotomatiki na kupanua mchakato wako wa usimamizi wa usanidi kwa urahisi zaidi.

Hii pia inaruhusu kuingia kwenye mifano kupitia ruhusa za IAM, hivyo ni **muhimu kwa privesc na pivoting**.

{% hint style="warning" %}
Ili **kuwezesha os-config katika mradi mzima au kwenye kifaa** unahitaji tu kuweka ufunguo wa **`metadata`** **`enable-oslogin`** kuwa **`kweli`** kwenye kiwango kilichokusudiwa.\
Zaidi ya hayo, unaweza kuweka metadata **`enable-oslogin-2fa`** kuwa **`kweli`** kuwezesha 2fa.

Unapoiwezesha unapounda kifaa ufunguo wa metadata utawekwa moja kwa moja.
{% endhint %}

Zaidi kuhusu **2fa katika OS-config**, **inatumika tu ikiwa mtumiaji ni mtumiaji**, ikiwa ni SA (kama vile SA ya kuhesabu) haitahitaji kitu chochote ziada.

### Uchambuzi
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Picha

### Picha za Desturi

**Picha za kompyuta za desturi zinaweza kuwa na maelezo nyeti** au mipangilio mingine inayoweza kudhuriwa ambayo unaweza kutumia.

Unapounda picha, unaweza kuchagua **aina 3 za kuchipua**: Kutumia **ufunguo uliosimamiwa na Google** (chaguo-msingi), **ufunguo kutoka KMS**, au **ufunguo wa ghafi** uliotolewa na mteja.

#### Uchambuzi

Unaweza kuuliza orodha ya picha zisizo za kawaida katika mradi kwa kutumia amri ifuatayo:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Unaweza kisha [**kusafirisha**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **diski za kivitualishi** kutoka kwa picha yoyote kwa miundo mingi. Amri ifuatayo itasafirisha picha 'picha-ya-jaribio' kwa muundo wa qcow2, ikiruhusu kupakua faili na kujenga VM kwa eneo lako kwa uchunguzi zaidi:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Upandishaji wa Mamlaka

Angalia sehemu ya upandishaji wa mamlaka ya Mifano ya Makadirio. 

### Templeti za Instansia za Desturi

[**Templeti ya instansia**](https://cloud.google.com/compute/docs/instance-templates/) **inadefini mali za instansia** ili kusaidia kupeleka miundombinu thabiti. Hizi zinaweza kuwa na aina sawa ya data nyeti kama data ya desturi ya metadata ya instansia inayofanya kazi. Unaweza kutumia amri zifuatazo kuchunguza:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Inaweza kuwa ya kuvutia kujua ni diski ipi inayotumia picha mpya, lakini kawaida mabuku haya hayatakuwa na habari nyeti.

## Picha za Skrini

**Picha za skrini ni nakala rudufu za diski**. Tafadhali kumbuka kuwa hii sio sawa na kujenga nakala ya diski (huduma nyingine inayopatikana).\
**Picha ya skrini** itatumia **ufichaji sawa na diski** ambayo imetolewa.
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Upandishaji wa Mamlaka

Angalia sehemu ya upandishaji wa mamlaka wa Mifano ya Kuhesabu. 

## Marejeo

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
