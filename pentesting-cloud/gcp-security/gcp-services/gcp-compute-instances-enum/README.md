# GCP - Compute Enum

{% hint style="success" %}
Nauƒçite i ve≈æbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nauƒçite i ve≈æbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hacking trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## GCP VPC & Mre≈æe

Nauƒçite kako ovo funkcioni≈°e u:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumeracija

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

–õ–∞–∫–æ –º–æ–∂–µ—Ç–µ –ø—Ä–æ–Ω–∞—õ–∏ compute instances —Å–∞ –æ—Ç–≤–æ—Ä–µ–Ω–∏–º firewall –ø—Ä–∞–≤–∏–ª–∏–º–∞ –ø–æ–º–æ—õ—É [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Compute instances

–û–≤–æ —ò–µ –Ω–∞—á–∏–Ω –Ω–∞ –∫–æ—ò–∏ –º–æ–∂–µ—Ç–µ **–ø–æ–∫—Ä–µ–Ω—É—Ç–∏ –≤–∏—Ä—Ç—É–µ–ª–Ω–µ –º–∞—à–∏–Ω–µ —É–Ω—É—Ç–∞—Ä GCP.** –ü–æ–≥–ª–µ–¥–∞—ò—Ç–µ –æ–≤—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞ –≤–∏—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—ò–∞:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Enumeration
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
For vi≈°e informacija o tome kako **SSH** ili **modifikovati metapodatke** instance za **eskalaciju privilegija**, pogledajte ovu stranicu:

{% content-ref url="../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Eskalacija Privilegija

Na sledeƒáoj stranici mo≈æete videti kako **zloupotrebiti compute dozvole za eskalaciju privilegija**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Neautentifikovana Enumeracija

{% content-ref url="../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Eksploatacija

{% content-ref url="../../gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Persistencija

{% content-ref url="../../gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Serijski Konzolni Logovi

Compute Engine Serijski Konzolni Logovi su funkcija koja vam omoguƒáava da **pregledate i dijagnostikujete logove pokretanja i operativnog sistema** va≈°ih virtuelnih ma≈°ina.

Serijski Konzolni Logovi pru≈æaju **niskonivojski pregled procesa pokretanja instance**, ukljuƒçujuƒái kernel poruke, init skripte i druge sistemske dogaƒëaje koji se de≈°avaju tokom pokretanja. Ovo mo≈æe biti korisno za otklanjanje problema sa pokretanjem, identifikaciju pogre≈°nih konfiguracija ili softverskih gre≈°aka, ili re≈°avanje problema sa mre≈ænom povezano≈°ƒáu.

Ovi logovi **mogu otkriti osetljive informacije** iz sistemskih logova koje korisnik sa niskim privilegijama obiƒçno ne bi mogao da vidi, ali sa odgovarajuƒáim IAM dozvolama mo≈æete ih proƒçitati.

Mo≈æete koristiti sledeƒáu [gcloud komandu](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) da biste upitili logove serijskog porta (potrebna dozvola je `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Startup Scripts output

Moguƒáe je videti **output startup skripti** sa VM-a izvr≈°avanjem:
```bash
sudo journalctl -u google-startup-scripts.service
```
## OS Configuration Manager

Mo≈æete koristiti servis za upravljanje konfiguracijom OS-a da **implementirate, upitujete i odr≈æavate dosledne konfiguracije** (≈æeljeno stanje i softver) za va≈°u VM instancu (VM). Na Compute Engine-u, morate koristiti [guest policies](https://cloud.google.com/compute/docs/os-config-management#guest-policy) da odr≈æavate dosledne softverske konfiguracije na VM-u.

Funkcija za upravljanje konfiguracijom OS-a omoguƒáava vam da defini≈°ete politike konfiguracije koje specificiraju koji softverski paketi treba da budu instalirani, koje usluge treba da budu omoguƒáene i koji fajlovi ili konfiguracije treba da budu prisutni na va≈°im VM-ovima. Mo≈æete koristiti deklarativni pristup za upravljanje softverskom konfiguracijom va≈°ih VM-ova, ≈°to vam omoguƒáava da automatizujete i skalirate proces upravljanja konfiguracijom lak≈°e.

Ovo takoƒëe omoguƒáava prijavljivanje u instance putem IAM dozvola, tako da je veoma **korisno za privesc i pivoting**.

{% hint style="warning" %}
Da biste **omoguƒáili os-config u celom projektu ili u instanci** samo treba da postavite **metadata** kljuƒç **`enable-oslogin`** na **`true`** na ≈æeljenom nivou.\
Pored toga, mo≈æete postaviti metadata **`enable-oslogin-2fa`** na **`true`** da omoguƒáite 2fa.

Kada ga omoguƒáite prilikom kreiranja instance, metadata kljuƒçevi ƒáe biti automatski postavljeni.
{% endhint %}

Vi≈°e o **2fa u OS-config**, **primenjuje se samo ako je korisnik korisnik**, ako je SA (kao compute SA) neƒáe zahtevati ni≈°ta dodatno.

### Enumeration
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Images

### Custom Images

**Prilagoƒëene compute slike mogu sadr≈æati osetljive detalje** ili druge ranjive konfiguracije koje mo≈æete iskoristiti.

Kada se kreira slika, mo≈æete izabrati **3 tipa enkripcije**: Kori≈°ƒáenjem **Google upravljanog kljuƒça** (podrazumevano), **kljuƒça iz KMS-a**, ili **sirovog kljuƒça** koji daje klijent.

#### Enumeration

Mo≈æete upitom dobiti listu nestandardnih slika u projektu sa sledeƒáom komandom:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Mo≈æete zatim [**izvesti**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **virtuelne diskove** iz bilo koje slike u vi≈°e formata. Sledeƒáa komanda bi izvezla sliku `test-image` u qcow2 formatu, omoguƒáavajuƒái vam da preuzmete fajl i napravite VM lokalno za dalju istragu:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Eskalacija privilegija

Proverite odeljak o eskalaciji privilegija za Compute Instances.

### Prilagoƒëeni ≈°abloni instanci

[**Instance template**](https://cloud.google.com/compute/docs/instance-templates/) **defini≈°e svojstva instance** kako bi pomogao u implementaciji doslednih konfiguracija. Ovi ≈°abloni mogu sadr≈æati iste tipove osetljivih podataka kao i prilagoƒëeni metapodaci pokrenute instance. Mo≈æete koristiti sledeƒáe komande za istra≈æivanje:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Mo≈æe biti zanimljivo znati koji disk koristi nove slike, ali ovi ≈°abloni obiƒçno neƒáe imati osetljive informacije.

## Snapshots

**Snapshots su bekapi diskova**. Imajte na umu da ovo nije isto ≈°to i kloniranje diska (druga dostupna funkcija).\
**Snapshot** ƒáe koristiti **istu enkripciju kao i disk** sa kojeg je napravljen.

### Enumeracija
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Privilege Escalation

Proverite odeljak o eskalaciji privilegija za Compute Instances.

## References

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

{% hint style="success" %}
Nauƒçite i ve≈æbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nauƒçite i ve≈æbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
