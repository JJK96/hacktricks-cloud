# GCP - Cloud Functions Enum

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια github.

</details>
{% endhint %}

## Cloud Functions <a href="#reviewing-cloud-functions" id="reviewing-cloud-functions"></a>

[Google Cloud Functions](https://cloud.google.com/functions/) έχουν σχεδιαστεί για να φιλοξενούν τον κώδικά σας, ο οποίος **εκτελείται σε απόκριση σε γεγονότα**, χωρίς να απαιτείται η διαχείριση ενός λειτουργικού συστήματος υποδοχής. Επιπλέον, αυτές οι λειτουργίες υποστηρίζουν την αποθήκευση μεταβλητών περιβάλλοντος, τις οποίες μπορεί να χρησιμοποιήσει ο κώδικας.

### Storage

Ο κώδικας των Cloud Functions **αποθηκεύεται στο GCP Storage**. Επομένως, οποιοσδήποτε έχει **πρόσβαση ανάγνωσης σε buckets** στο GCP θα μπορεί να **διαβάσει τον κώδικα των Cloud Functions**.\
Ο κώδικας αποθηκεύεται σε ένα bucket όπως τα παρακάτω:

* `gcf-sources-<number>-<region>/<function-name>-<uuid>/version-<n>/function-source.zip`
* `gcf-v2-sources-<number>-<region>/<function-name>function-source.zip`

Για παράδειγμα:\
`gcf-sources-645468741258-us-central1/function-1-003dcbdf-32e1-430f-a5ff-785a6e238c76/version-4/function-source.zip`

{% hint style="warning" %}
Οποιοσδήποτε χρήστης με **δικαιώματα ανάγνωσης στο bucket** που αποθηκεύει τη Cloud Function θα μπορούσε να **διαβάσει τον εκτελούμενο κώδικα**.
{% endhint %}

### Artifact Registry

Εάν η cloud function είναι διαμορφωμένη έτσι ώστε το εκτελούμενο Docker container να αποθηκεύεται μέσα σε ένα Artifact Registry repo μέσα στο project, οποιοσδήποτε με πρόσβαση ανάγνωσης στο repo θα μπορεί να κατεβάσει την εικόνα και να ελέγξει τον πηγαίο κώδικα. Για περισσότερες πληροφορίες ελέγξτε:

{% content-ref url="gcp-artifact-registry-enum.md" %}
[gcp-artifact-registry-enum.md](gcp-artifact-registry-enum.md)
{% endcontent-ref %}

### SA

Εάν δεν έχει καθοριστεί, από προεπιλογή η **App Engine Default Service Account** με **δικαιώματα Editor** στο project θα συνδεθεί με τη Cloud Function.

### Triggers, URL & Authentication

Όταν δημιουργείται μια Cloud Function, πρέπει να καθοριστεί το **trigger**. Ένα κοινό είναι το **HTTPS**, αυτό θα **δημιουργήσει μια URL όπου η λειτουργία** μπορεί να ενεργοποιηθεί μέσω περιήγησης στο web.\
Άλλα triggers είναι pub/sub, Storage, Filestore...

Η μορφή της URL είναι **`https://<region>-<project-gcp-name>.cloudfunctions.net/<func_name>`**

Όταν χρησιμοποιείται το HTTPS trigger, επίσης υποδεικνύεται αν ο **καλούντας χρειάζεται να έχει IAM authorization** για να καλέσει τη Function ή αν **ο καθένας** μπορεί απλά να την καλέσει:

<figure><img src="../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

### Inside the Cloud Function

Ο κώδικας **κατεβαίνει μέσα** στον φάκελο **`/workspace`** με τα ίδια ονόματα αρχείων όπως αυτά που έχουν τα αρχεία στη Cloud Function και εκτελείται με τον χρήστη `www-data`.\
Ο δίσκος **δεν είναι προσαρτημένος ως read-only.**

### Enumeration
```bash
# List functions
gcloud functions list
gcloud functions describe <func_name> # Check triggers to see how is this function invoked
gcloud functions get-iam-policy <func_name>

# Get logs of previous runs. By default, limits to 10 lines
gcloud functions logs read <func_name> --limit [NUMBER]

# Call a function
curl https://<region>-<project>.cloudfunctions.net/<func_name>
gcloud functions call <func_name> --data='{"message": "Hello World!"}'

# If you know the name of projects you could try to BF cloud functions names

# Get events that could be used to trigger a cloud function
gcloud functions event-types list

# Access function with authentication
curl -X POST https://<region>-<project>.cloudfunctions.net/<func_name> \
-H "Authorization: bearer $(gcloud auth print-identity-token)" \
-H "Content-Type: application/json" \
-d '{}'
```
### Privilege Escalation

Στην ακόλουθη σελίδα, μπορείτε να δείτε πώς να **εκμεταλλευτείτε τα δικαιώματα των cloud function για να κλιμακώσετε προνόμια**:

{% content-ref url="../gcp-privilege-escalation/gcp-cloudfunctions-privesc.md" %}
[gcp-cloudfunctions-privesc.md](../gcp-privilege-escalation/gcp-cloudfunctions-privesc.md)
{% endcontent-ref %}

### Unauthenticated Access

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-cloud-functions-unauthenticated-enum.md" %}
[gcp-cloud-functions-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-cloud-functions-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../gcp-post-exploitation/gcp-cloud-functions-post-exploitation.md" %}
[gcp-cloud-functions-post-exploitation.md](../gcp-post-exploitation/gcp-cloud-functions-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../gcp-persistence/gcp-cloud-functions-persistence.md" %}
[gcp-cloud-functions-persistence.md](../gcp-persistence/gcp-cloud-functions-persistence.md)
{% endcontent-ref %}

## References

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
