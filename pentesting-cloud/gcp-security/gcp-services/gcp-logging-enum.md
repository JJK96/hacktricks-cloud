# GCP - 日志枚举

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我的**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

此服务允许用户存储、搜索、分析、监视和对来自GCP的**日志数据和事件**进行警报。

Cloud Logging与其他GCP服务完全集成，为您的所有GCP资源的日志提供了一个集中存储库。它**自动收集来自各种GCP服务**（如App Engine、Compute Engine和Cloud Functions）的日志。您还可以通过使用Cloud Logging代理或API，将Cloud Logging用于在本地运行或在其他云中运行的应用程序。

主要特点：

* **日志数据集中化：**从各种来源聚合日志数据，为您的应用程序和基础设施提供全面视图。
* **实时日志管理：**实时流式传输日志，进行即时分析和响应。
* **强大的数据分析：**使用高级过滤和搜索功能快速筛选大量日志数据。
* **与BigQuery集成：**将日志导出到BigQuery进行详细分析和查询。
* **基于日志的指标：**从日志数据创建自定义指标，用于监视和警报。

### 日志流程

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

基本上，汇集器和基于日志的指标将决定日志应存储在何处。

### GCP日志支持的配置

Cloud Logging具有高度可配置性，以满足各种运营需求：

1. **日志存储桶（Web中的日志存储）：**在Cloud Logging中定义存储桶以管理**日志保留**，控制日志条目的保留时间。
* 默认情况下，创建了桶`_Default`和`_Required`（一个记录，另一个不记录）。
* **\_Required**是：

{% code overflow="wrap" %}
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```
{% endcode %}
* 数据的**保留期**是根据桶配置的，必须**至少为1天**。然而，**\_Required的保留期为400天**，且无法修改。
* 请注意，日志存储桶**在Cloud Storage中不可见**。
2. **日志汇（Web中的日志路由器）：**创建汇以根据**过滤器**将日志条目**导出**到各种目的地，如Pub/Sub、BigQuery或Cloud Storage。
* 默认情况下，为桶`_Default`和`_Required`创建了汇：
* ```bash
_Required  logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **排除过滤器：**可以设置**排除规则**，以防止特定日志条目被摄入，节省成本并减少不必要的噪音。
3. **基于日志的指标：**根据日志内容配置**自定义指标**，允许基于日志数据进行警报和监视。
4. **日志视图：**日志视图提供对您的日志存储桶中的日志**进行高级和细粒度控制**。
* Cloud Logging **自动为每个桶创建`_AllLogs`视图**，显示所有日志。Cloud Logging还为`_Default`桶创建了名为`_Default`的视图。`_Default`桶的`_Default`视图显示所有日志，但不包括数据访问审计日志。`_AllLogs`和`_Default`视图不可编辑。

可以通过IAM策略允许主体**仅使用特定的日志视图**，例如：

{% code overflow="wrap" %}
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
{% endcode %}

### 默认日志

默认情况下，**管理员写入**操作（也称为管理员活动审计日志）会被记录（写入元数据或配置信息），**无法禁用**。

然后，用户可以启用**数据访问审计日志**，这些包括**管理员读取、数据写入和数据写入**。

您可以在文档中找到有关每种日志类型的更多信息：[https://cloud.google.com/iam/docs/audit-logging](https://cloud.google.com/iam/docs/audit-logging)

但是，请注意，这意味着默认情况下**`GetIamPolicy`**操作和其他读取操作**不会被记录**。因此，默认情况下，如果系统管理员没有配置生成更多日志，试图枚举环境的攻击者将不会被抓住。

要在控制台中启用更多日志，系统管理员需要转到[https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit)并启用它们。有两种不同的选项：

* **默认配置**：可以创建默认配置并记录所有管理员读取和/或数据读取和/或数据写入日志，甚至添加豁免主体：

<figure><img src="../../../.gitbook/assets/image (338).png" alt=""><figcaption></figcaption></figure>

* **选择服务**：或者只需**选择要生成日志的服务**以及日志的类型和该特定服务的豁免主体。

还要注意，默认情况下只生成这些日志，因为生成更多日志将增加成本。

### 枚举

`gcloud`命令行工具是GCP生态系统的一个重要组成部分，允许您管理资源和服务。以下是如何使用`gcloud`来管理日志配置和访问日志。
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

示例检查**`cloudresourcemanager`**的日志（用于BF权限）：[https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

没有**`testIamPermissions`**的日志：

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### 后渗透

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### 持久性

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## 参考资料

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

<details>

<summary><strong>从零开始学习AWS黑客技术</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**上关注**我。
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
