# GCP - Enumera√ß√£o de Registos

<details>

<summary><strong>Aprenda a hackear a AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se deseja ver a **sua empresa anunciada no HackTricks** ou **descarregar o HackTricks em PDF** Consulte os [**PLANOS DE SUBSCRI√á√ÉO**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), a nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partilhe os seus truques de hacking submetendo PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√£o B√°sica

Este servi√ßo permite aos utilizadores armazenar, pesquisar, analisar, monitorizar e alertar sobre **dados de registo e eventos** do GCP.

O Cloud Logging est√° totalmente integrado com outros servi√ßos do GCP, fornecendo um reposit√≥rio centralizado para registos de todos os seus recursos do GCP. Ele **recolhe automaticamente registos de v√°rios servi√ßos do GCP** como App Engine, Compute Engine e Cloud Functions. Tamb√©m pode utilizar o Cloud Logging para aplica√ß√µes em execu√ß√£o localmente ou em outras nuvens, utilizando o agente ou API do Cloud Logging.

Funcionalidades Principais:

* **Centraliza√ß√£o de Dados de Registo:** Agregue dados de registo de v√°rias fontes, oferecendo uma vis√£o hol√≠stica das suas aplica√ß√µes e infraestrutura.
* **Gest√£o de Registo em Tempo Real:** Transmita registos em tempo real para an√°lise e resposta imediatas.
* **An√°lise de Dados Poderosa:** Utilize capacidades avan√ßadas de filtragem e pesquisa para analisar rapidamente grandes volumes de dados de registo.
* **Integra√ß√£o com o BigQuery:** Exporte registos para o BigQuery para an√°lise e consulta detalhadas.
* **M√©tricas Baseadas em Registo:** Crie m√©tricas personalizadas a partir dos seus dados de registo para monitoriza√ß√£o e alerta.

### Fluxo de Registos

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

Basicamente, os sinks e m√©tricas baseadas em registo ir√£o determinar onde um registo deve ser armazenado.

### Configura√ß√µes Suportadas pelo Cloud Logging do GCP

O Cloud Logging √© altamente configur√°vel para atender a diversas necessidades operacionais:

1. **Baldes de Registo (Armazenamento de Registos na web):** Defina baldes no Cloud Logging para gerir a **reten√ß√£o de registos**, fornecendo controlo sobre por quanto tempo as suas entradas de registo s√£o retidas.
* Por padr√£o, os baldes `_Default` e `_Required` s√£o criados (um est√° a registar o que o outro n√£o est√°).
*   **\_Required** √©:

{% code overflow="wrap" %}
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```
{% endcode %}
* O **per√≠odo de reten√ß√£o** dos dados √© configurado por balde e deve ser de **pelo menos 1 dia**. No entanto, o **per√≠odo de reten√ß√£o do \_Required √© de 400 dias** e n√£o pode ser modificado.
* Note que os Baldes de Registo **n√£o s√£o vis√≠veis no Cloud Storage.**
2. **Sinks de Registo (Encaminhador de Registo na web):** Crie sinks para **exportar entradas de registo** para v√°rios destinos, como Pub/Sub, BigQuery ou Cloud Storage com base num **filtro**.
* Por **padr√£o**, s√£o criados sinks para os baldes `_Default` e `_Required`:
* ```bash
_Required  logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **Filtros de Exclus√£o:** √â poss√≠vel configurar **exclus√µes para impedir que entradas de registo espec√≠ficas** sejam ingeridas, poupando custos e reduzindo ru√≠do desnecess√°rio.
3. **M√©tricas Baseadas em Registo:** Configure **m√©tricas personalizadas** com base no conte√∫do dos registos, permitindo alertas e monitoriza√ß√£o com base em dados de registo.
4. **Vistas de Registo:** As vistas de registo oferecem um controlo avan√ßado e **granular sobre quem tem acesso** aos registos nos seus baldes de registo.&#x20;
* O Cloud Logging **cria automaticamente a vista `_AllLogs` para cada balde**, que mostra todos os registos. O Cloud Logging tamb√©m cria uma vista para o balde `_Default` chamada `_Default`. A vista `_Default` para o balde `_Default` mostra todos os registos exceto os registos de auditoria de Acesso a Dados. As vistas `_AllLogs` e `_Default` n√£o s√£o edit√°veis.

√â poss√≠vel permitir a um principal **apenas utilizar uma vista de Registo espec√≠fica** com uma pol√≠tica IAM como:

{% code overflow="wrap" %}
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
{% endcode %}

### Registos Padr√£o

Por padr√£o, as opera√ß√µes de **Escrita de Admin** (tamb√©m chamadas de registos de auditoria de Atividade de Admin) s√£o as que s√£o registadas (escrever metadados ou informa√ß√µes de configura√ß√£o) e **n√£o podem ser desativadas**.

Em seguida, o usu√°rio pode ativar os **registos de auditoria de Acesso a Dados**, que s√£o de **Leitura de Admin, Escrita de Dados e Escrita de Dados**.

Voc√™ pode encontrar mais informa√ß√µes sobre cada tipo de registo na documenta√ß√£o: [https://cloud.google.com/iam/docs/audit-logging](https://cloud.google.com/iam/docs/audit-logging)

No entanto, observe que isso significa que por padr√£o as a√ß√µes de **`GetIamPolicy`** e outras a√ß√µes de leitura **n√£o est√£o sendo registadas**. Portanto, por padr√£o, um atacante tentando enumerar o ambiente n√£o ser√° detectado se o administrador do sistema n√£o configurar para gerar mais registos.

Para ativar mais registos no console, o administrador do sistema precisa ir para [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) e ativ√°-los. Existem 2 op√ß√µes diferentes:

* **Configura√ß√£o Padr√£o**: √â poss√≠vel criar uma configura√ß√£o padr√£o e registar todos os registos de Leitura de Admin e/ou Leitura de Dados e/ou Escrita de Dados e at√© adicionar princ√≠pios isentos:

<figure><img src="../../../.gitbook/assets/image (338).png" alt=""><figcaption></figcaption></figure>

* **Selecionar os servi√ßos**: Ou apenas **selecionar os servi√ßos** dos quais gostaria de gerar registos e o tipo de registos e o princ√≠pio isento para esse servi√ßo espec√≠fico.

Tamb√©m observe que por padr√£o apenas esses registos est√£o sendo gerados porque gerar mais registos aumentar√° os custos.

### Enumera√ß√£o

A ferramenta de linha de comando `gcloud` √© uma parte integral do ecossistema do GCP, permitindo que voc√™ gerencie seus recursos e servi√ßos. Veja como voc√™ pode usar o `gcloud` para gerenciar suas configura√ß√µes de registo e aceder aos registos.

{% code overflow="wrap" %}
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

Exemplo para verificar os logs do **`cloudresourcemanager`** (o usado para BF permiss√µes): [https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

N√£o h√° logs de **`testIamPermissions`**:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### P√≥s-Explora√ß√£o

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### Persist√™ncia

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
