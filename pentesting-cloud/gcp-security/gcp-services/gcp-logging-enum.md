# GCP - Enumeraci√≥n de Logging

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* ¬°Consulta los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de GitHub.

</details>
{% endhint %}

## Informaci√≥n B√°sica

Este servicio permite a los usuarios almacenar, buscar, analizar, monitorear y alertar sobre **datos de registro y eventos** de GCP.

Cloud Logging est√° totalmente integrado con otros servicios de GCP, proporcionando un repositorio centralizado para los registros de todos sus recursos de GCP. **Recopila autom√°ticamente registros de varios servicios de GCP** como App Engine, Compute Engine y Cloud Functions. Tambi√©n se puede utilizar Cloud Logging para aplicaciones que se ejecutan localmente o en otras nubes mediante el agente o la API de Cloud Logging.

Caracter√≠sticas clave:

* **Centralizaci√≥n de Datos de Registro:** Agrega datos de registro de diversas fuentes, ofreciendo una vista hol√≠stica de sus aplicaciones e infraestructura.
* **Gesti√≥n de Registros en Tiempo Real:** Transmite registros en tiempo real para an√°lisis y respuesta inmediata.
* **An√°lisis de Datos Potente:** Utiliza capacidades avanzadas de filtrado y b√∫squeda para filtrar r√°pidamente grandes vol√∫menes de datos de registro.
* **Integraci√≥n con BigQuery:** Exporta registros a BigQuery para un an√°lisis detallado y consultas.
* **M√©tricas Basadas en Registros:** Crea m√©tricas personalizadas a partir de tus datos de registro para monitoreo y alertas.

### Flujo de Registros

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

B√°sicamente, los *sinks* y las m√©tricas basadas en registros determinar√°n d√≥nde se debe almacenar un registro.

### Configuraciones Soportadas por GCP Logging

Cloud Logging es altamente configurable para adaptarse a diversas necesidades operativas:

1. **Buckets de Registro (Almacenamiento de registros en la web):** Define buckets en Cloud Logging para gestionar la **retenci√≥n de registros**, proporcionando control sobre cu√°nto tiempo se retienen tus entradas de registro.
* Por defecto se crean los buckets `_Default` y `_Required` (uno registra lo que el otro no).
*   **\_Required** es:

{% code overflow="wrap" %}
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```
{% endcode %}
* El **periodo de retenci√≥n** de los datos se configura por bucket y debe ser **al menos de 1 d√≠a**. Sin embargo, el **periodo de retenci√≥n de \_Required es de 400 d√≠as** y no se puede modificar.
* Ten en cuenta que los Buckets de Registro **no son visibles en Cloud Storage**.
2. **Sinks de Registro (Enrutador de registros en la web):** Crea *sinks* para **exportar entradas de registro** a varios destinos como Pub/Sub, BigQuery o Cloud Storage basado en un **filtro**.
* Por **defecto** se crean *sinks* para los buckets `_Default` y `_Required`:
* ```bash
_Required  logging.googleapis.com/projects/<nombre-proyecto>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<nombre-proyecto>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **Filtros de Exclusi√≥n:** Es posible configurar **exclusiones para evitar que ciertas entradas de registro** sean ingestadas, ahorrando costos y reduciendo ruido innecesario.
3. **M√©tricas Basadas en Registros:** Configura **m√©tricas personalizadas** basadas en el contenido de los registros, permitiendo alertas y monitoreo basados en datos de registro.
4. **Vistas de Registro:** Las vistas de registro brindan un control avanzado y **granular sobre qui√©n tiene acceso** a los registros dentro de tus buckets de registro.&#x20;
* Cloud Logging **crea autom√°ticamente la vista `_AllLogs` para cada bucket**, que muestra todos los registros. Cloud Logging tambi√©n crea una vista para el bucket `_Default` llamada `_Default`. La vista `_Default` para el bucket `_Default` muestra todos los registros excepto los registros de auditor√≠a de acceso a datos. Las vistas `_AllLogs` y `_Default` no son editables.

Es posible permitir que un principal **solo use una vista de registro espec√≠fica** con una pol√≠tica IAM como:

{% code overflow="wrap" %}
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
{% endcode %}

### Registros predeterminados

Por defecto, las operaciones de escritura de administrador (tambi√©n llamados registros de auditor√≠a de actividad de administrador) son las que se registran (escriben metadatos o informaci√≥n de configuraci√≥n) y **no se pueden deshabilitar**.

Luego, el usuario puede habilitar los registros de auditor√≠a de acceso a datos, que incluyen lecturas de administrador, escrituras de datos y lecturas de datos.

Puede encontrar m√°s informaci√≥n sobre cada tipo de registro en la documentaci√≥n: [https://cloud.google.com/iam/docs/audit-logging](https://cloud.google.com/iam/docs/audit-logging)

Sin embargo, tenga en cuenta que esto significa que por defecto las acciones `GetIamPolicy` y otras acciones de lectura **no se registran**. Por lo tanto, de forma predeterminada, un atacante que intente enumerar el entorno no ser√° detectado si el administrador del sistema no configura la generaci√≥n de m√°s registros.

Para habilitar m√°s registros en la consola, el administrador del sistema debe ir a [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) y habilitarlos. Hay 2 opciones diferentes:

* **Configuraci√≥n predeterminada**: Es posible crear una configuraci√≥n predeterminada y registrar todos los registros de lectura de administrador y/o lectura de datos y/o escritura de datos e incluso agregar principios exentos:

<figure><img src="../../../.gitbook/assets/image (338).png" alt=""><figcaption></figcaption></figure>

* **Seleccionar los servicios**: O simplemente **seleccionar los servicios** de los que le gustar√≠a generar registros y el tipo de registros y el principio exceptuado para ese servicio espec√≠fico.

Tambi√©n tenga en cuenta que por defecto solo se generan esos registros porque generar m√°s registros aumentar√° los costos.

### Enumeraci√≥n

La herramienta de l√≠nea de comandos `gcloud` es una parte integral del ecosistema de GCP, que le permite administrar sus recursos y servicios. As√≠ es como puede usar `gcloud` para administrar sus configuraciones de registro y acceder a los registros.

{% code overflow="wrap" %}
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

Ejemplo para verificar los registros de **`cloudresourcemanager`** (el utilizado para BF permisos): [https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

No hay registros de **`testIamPermissions`**:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Post Explotaci√≥n

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### Persistencia

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## Referencias

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* ¬°Consulta los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
