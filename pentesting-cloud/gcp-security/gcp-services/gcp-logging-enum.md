# GCP - ロギング列挙

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝**したい場合や **HackTricks をPDFでダウンロード**したい場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)** に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 で **@carlospolopm** をフォローする
* **ハッキングトリックを共有するために** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリにPRを提出する

</details>

## 基本情報

このサービスは、GCP からの**ログデータとイベント**を保存、検索、分析、監視、アラートに使用することをユーザーに可能にします。

Cloud Logging は他の GCP サービスと完全に統合されており、すべての GCP リソースからのログを集約するための中央リポジトリを提供します。これにより、App Engine、Compute Engine、Cloud Functions などのさまざまな GCP サービスからログを**自動的に収集**できます。Cloud Logging エージェントまたは API を使用して、オンプレミスまたは他のクラウドで実行されているアプリケーションにも Cloud Logging を使用できます。

主な機能:

* **ログデータの集約:** さまざまなソースからのログデータを集約し、アプリケーションとインフラストラクチャの包括的なビューを提供します。
* **リアルタイムログ管理:** 即座の分析と対応のためにログをリアルタイムでストリーム配信します。
* **強力なデータ分析:** 大量のログデータを迅速にふるい分けるための高度なフィルタリングと検索機能を使用します。
* **BigQuery との統合:** 詳細な分析とクエリのためにログを BigQuery にエクスポートします。
* **ログベースのメトリクス:** ログデータからカスタムメトリクスを作成して、監視とアラートを行います。

### ログの流れ

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

基本的に、シンクとログベースのメトリクスはログの保存先を決定します。

### GCP Logging でサポートされる構成

Cloud Logging は多様な運用ニーズに合わせて高度に構成可能です:

1. **ログバケット（Web上のログの保存）:** Cloud Logging でログの**保持期間**を管理するためにログバケットを定義します。
* デフォルトでは、`_Default` と `_Required` のバケットが作成されます（片方はログを記録し、もう片方は記録しません）。
*   **\_Required** は:

{% code overflow="wrap" %}
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```
{% endcode %}
* データの**保持期間**はバケットごとに構成され、**少なくとも1日**である必要があります。ただし、**\_Required の保持期間は400日**であり、変更できません。
* ログバケットは **Cloud Storage で表示されません。**
2. **ログシンク（Web上のログルーター）:** フィルタに基づいてログエントリを Pub/Sub、BigQuery、または Cloud Storage などのさまざまな宛先に**エクスポート**するためにシンクを作成します。
* **デフォルト**では、`_Default` と `_Required` のバケット用のシンクが作成されます:
* ```bash
_Required  logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **除外フィルタ:** 特定のログエントリの取り込みを防ぐために**除外**を設定することが可能で、コストを節約し、不要なノイズを減らすことができます。
3. **ログベースのメトリクス:** ログの内容に基づいて**カスタムメトリクス**を構成し、ログデータに基づいたアラートと監視を行います。
4. **ログビュー:** ログバケット内のログへのアクセス権を高度かつ**細かく制御**するためのログビューを提供します。
* Cloud Logging は**すべてのバケットに対して自動的に `_AllLogs` ビュー**を作成し、すべてのログを表示します。Cloud Logging はまた、`_Default` バケット用に `_Default` というビューを作成します。`_Default` バケットの `_Default` ビューは、データアクセス監査ログを除くすべてのログを表示します。`_AllLogs` と `_Default` ビューは編集できません。

IAM ポリシーを使用して、特定のログビューのみを使用するようにプリンシパルに許可することが可能です:

{% code overflow="wrap" %}
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
{% endcode %}

### デフォルトログ

デフォルトでは、**管理者書き込み**操作（管理者アクティビティ監査ログとも呼ばれる）がログに記録されます（メタデータや構成情報の書き込み）し、**無効にすることはできません**。

その後、ユーザーは**データアクセス監査ログ**を有効にできます。これには**管理者読み取り、データ書き込み、データ書き込み**が含まれます。

各種ログの詳細については、ドキュメントで確認できます：[https://cloud.google.com/iam/docs/audit-logging](https://cloud.google.com/iam/docs/audit-logging)

ただし、これはデフォルトでは**`GetIamPolicy`**アクションやその他の読み取りアクションが**ログに記録されない**ことを意味します。そのため、システム管理者が追加のログを生成するように構成していない限り、環境を列挙しようとする攻撃者はデフォルトでは検知されません。

コンソールでより多くのログを有効にするには、システム管理者は[https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit)に移動して有効にする必要があります。2つの異なるオプションがあります：

* **デフォルト構成**：デフォルト構成を作成し、すべての管理者読み取りおよび/またはデータ読み取りおよび/またはデータ書き込みログを記録し、免除されたプリンシパルを追加することが可能です：

<figure><img src="../../../.gitbook/assets/image (338).png" alt=""><figcaption></figcaption></figure>

* **サービスを選択**：または、ログを生成したいサービスとログの種類、およびその特定のサービスの免除されたプリンシパルを選択することができます。

また、デフォルトではこれらのログのみが生成されているため、より多くのログを生成するとコストが増加します。

### 列挙

`gcloud`コマンドラインツールはGCPエコシステムの重要な部分であり、リソースやサービスを管理することができます。ここでは、`gcloud`を使用してログ構成とアクセスログを管理する方法を示します。

{% code overflow="wrap" %}
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

**`cloudresourcemanager`**のログをチェックする例（アクセス許可をBFするために使用されるもの）：[https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

**`testIamPermissions`**のログはありません：

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### ポストエクスプロイテーション

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### 永続性

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## 参考文献

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**する。
* **ハッキングトリックを共有するために** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する。

</details>
