# GCP - Enumeracija logovanja

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitteru** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

Ova usluga omogućava korisnicima da skladište, pretražuju, analiziraju, nadgledaju i šalju upozorenja o **podacima i događajima logovanja** sa GCP-a.

Cloud Logging je potpuno integrisan sa drugim GCP uslugama, pružajući centralizovano skladište za logove sa svih vaših GCP resursa. On **automatski prikuplja logove iz različitih GCP usluga** poput App Engine-a, Compute Engine-a i Cloud Functions-a. Takođe možete koristiti Cloud Logging za aplikacije koje se izvršavaju lokalno ili na drugim oblakama korišćenjem Cloud Logging agenta ili API-ja.

Ključne funkcionalnosti:

* **Centralizacija podataka logovanja:** Agregirajte podatke logovanja sa različitih izvora, nudeći holistički prikaz vaših aplikacija i infrastrukture.
* **Upravljanje logovima u realnom vremenu:** Strimujte logove u realnom vremenu radi odmahšnje analize i odgovora.
* **Moćna analiza podataka:** Koristite napredne mogućnosti filtriranja i pretrage za brzo pretraživanje velikih količina podataka logovanja.
* **Integracija sa BigQuery-om:** Izvozite logove u BigQuery radi detaljne analize i upita.
* **Metrike zasnovane na logovima:** Kreirajte prilagođene metrike iz vaših podataka logovanja za praćenje i slanje upozorenja.

### Tok logova

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

U osnovi, slivovi i metrike zasnovane na logovima će odrediti gde će log biti smešten.

### Konfiguracije podržane od strane GCP Logovanja

Cloud Logging je visoko konfigurabilan kako bi odgovarao različitim operativnim potrebama:

1. **Log Burevi (Skladištenje logova na vebu):** Definišite bureve u Cloud Logging-u za upravljanje **zadržavanjem logova**, pružajući kontrolu nad tim koliko dugo se vaši unosi logova zadržavaju.
* Podrazumevano su kreirani burevi `_Default` i `_Required` (jedan beleži ono što drugi ne).
*   **\_Required** je:

{% code overflow="wrap" %}
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```
{% endcode %}
* **Period zadržavanja** podataka je konfigurisan po buretu i mora biti **najmanje 1 dan.** Međutim, **period zadržavanja za \_Required je 400 dana** i ne može se menjati.
* Imajte na umu da Log Burevi **nisu vidljivi u Cloud Storage-u.**
2. **Log Sinks (Ruter logova na vebu):** Kreirajte sinkove za **izvoz unosa logova** ka različitim odredištima poput Pub/Sub-a, BigQuery-a ili Cloud Storage-a na osnovu **filtera**.
* Podrazumevano su kreirani sinkovi za bureve `_Default` i `_Required`:
* ```bash
_Required  logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **Filteri isključenja:** Moguće je postaviti **isključenja kako bi se sprečilo da određeni unosi logova budu uneti, čime se štedi trošak i smanjuje nepotrebna buka.
3. **Metrike zasnovane na logovima:** Konfigurišite **prilagođene metrike** na osnovu sadržaja logova, omogućavajući upozorenja i praćenje na osnovu podataka logovanja.
4. **Prikazi logova:** Prikazi logova pružaju naprednu i **granularnu kontrolu nad tim ko ima pristup** logovima unutar vaših log bureva.&#x20;
* Cloud Logging **automatski kreira pogled `_AllLogs` za svaki bure**, koji prikazuje sve logove. Cloud Logging takođe kreira pogled za bure `_Default` nazvan `_Default`. Pogled `_Default` za bure `_Default` prikazuje sve logove osim logova za praćenje pristupa podacima. Pogledi `_AllLogs` i `_Default` nisu izmenjivi.

Moguće je dozvoliti principalu **samo korišćenje određenog Prikaza logova** sa IAM politikom poput:

{% code overflow="wrap" %}
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
{% endcode %}

### Podrazumevani zapisi

Podrazumevano se beleže operacije **Admin Write** (takođe nazvane Admin Activity audit logs) (upisivanje metapodataka ili konfiguracionih informacija) i **ne mogu biti onemogućene**.

Zatim, korisnik može omogućiti **Data Access audit logs**, koji obuhvataju **Admin Read, Data Write i Data Write**.

Više informacija o svakom tipu zapisa možete pronaći u dokumentaciji: [https://cloud.google.com/iam/docs/audit-logging](https://cloud.google.com/iam/docs/audit-logging)

Međutim, imajte na umu da to znači da podrazumevano **`GetIamPolicy`** radnje i ostale čitanje radnje **nisu beležene**. Dakle, podrazumevano napadač koji pokušava da enumeriše okruženje neće biti uhvaćen ako sistem administrator nije konfigurisao generisanje više zapisa.

Da biste omogućili više zapisa u konzoli, sistem administrator treba da ode na [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) i omogući ih. Postoje 2 različite opcije:

* **Podrazumevana konfiguracija**: Moguće je kreirati podrazumevanu konfiguraciju i beležiti sve Admin Read i/ili Data Read i/ili Data Write zapise i čak dodati izuzete principe:

<figure><img src="../../../.gitbook/assets/image (338).png" alt=""><figcaption></figcaption></figure>

* **Izaberite usluge**: Ili jednostavno **izaberite usluge** za koje želite da generišete zapise i tip zapisa i izuzetog principala za tu određenu uslugu.

Takođe imajte na umu da se podrazumevano generišu samo ti zapisi jer generisanje više zapisa povećava troškove.

### Enumeracija

`gcloud` alat za komandnu liniju je integralni deo GCP ekosistema, koji vam omogućava upravljanje resursima i uslugama. Evo kako možete koristiti `gcloud` za upravljanje konfiguracijama zapisa i pristupom zapisa.
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

Primer za proveru zapisa **`cloudresourcemanager`** (onaj koji se koristi za BF dozvole): [https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

Nema zapisa za **`testIamPermissions`**:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Post Eksploatacija

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### Upornost

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## Reference

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili **telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
