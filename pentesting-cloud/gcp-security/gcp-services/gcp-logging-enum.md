# GCP - Enum√©ration des journaux

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge HackTricks AWS)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Informations de base

Ce service permet aux utilisateurs de stocker, rechercher, analyser, surveiller et alerter sur les **donn√©es de journal et les √©v√©nements** de GCP.

Cloud Logging est enti√®rement int√©gr√© √† d'autres services GCP, fournissant un r√©f√©rentiel centralis√© pour les journaux de toutes vos ressources GCP. Il **collecte automatiquement des journaux √† partir de divers services GCP** tels que App Engine, Compute Engine et Cloud Functions. Vous pouvez √©galement utiliser Cloud Logging pour les applications s'ex√©cutant sur site ou dans d'autres clouds en utilisant l'agent Cloud Logging ou l'API.

Fonctionnalit√©s cl√©s :

* **Centralisation des donn√©es de journal :** Agr√©ger les donn√©es de journal √† partir de diff√©rentes sources, offrant une vue holistique de vos applications et infrastructures.
* **Gestion des journaux en temps r√©el :** Diffusez les journaux en temps r√©el pour une analyse et une r√©ponse imm√©diates.
* **Analyse de donn√©es puissante :** Utilisez des capacit√©s de filtrage et de recherche avanc√©es pour parcourir rapidement de grands volumes de donn√©es de journal.
* **Int√©gration avec BigQuery :** Exportez les journaux vers BigQuery pour une analyse et une interrogation d√©taill√©es.
* **M√©triques bas√©es sur les journaux :** Cr√©ez des m√©triques personnalis√©es √† partir de vos donn√©es de journal pour la surveillance et les alertes.

### Flux des journaux

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

Essentiellement, les √©viers et les m√©triques bas√©es sur les journaux d√©termineront o√π un journal doit √™tre stock√©.

### Configurations prises en charge par GCP Logging

Cloud Logging est hautement configurable pour r√©pondre √† divers besoins op√©rationnels :

1. **Buckets de journaux (Stockage des journaux sur le web) :** D√©finissez des buckets dans Cloud Logging pour g√©rer la **r√©tention des journaux**, offrant un contr√¥le sur la dur√©e pendant laquelle vos entr√©es de journal sont conserv√©es.
* Par d√©faut, les buckets `_Default` et `_Required` sont cr√©√©s (l'un enregistre ce que l'autre ne fait pas).
*   **\_Required** est :

{% code overflow="wrap" %}
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```
{% endcode %}
* La **p√©riode de r√©tention** des donn√©es est configur√©e par bucket et doit √™tre d'**au moins 1 jour**. Cependant, la **p√©riode de r√©tention de \_Required est de 400 jours** et ne peut pas √™tre modifi√©e.
* Notez que les Buckets de journaux ne sont **pas visibles dans Cloud Storage**.
2. **√âviers de journaux (Routeur de journaux sur le web) :** Cr√©ez des √©viers pour **exporter les entr√©es de journal** vers diverses destinations telles que Pub/Sub, BigQuery ou Cloud Storage en fonction d'un **filtre**.
* Par **d√©faut**, des √©viers pour les buckets `_Default` et `_Required` sont cr√©√©s :
* ```bash
_Required  logging.googleapis.com/projects/<nom-projet>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<nom-projet>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **Filtres d'exclusion :** Il est possible de configurer des **exclusions pour emp√™cher des entr√©es de journal sp√©cifiques** d'√™tre ing√©r√©es, ce qui permet d'√©conomiser des co√ªts et de r√©duire les bruits inutiles.
3. **M√©triques bas√©es sur les journaux :** Configurez des **m√©triques personnalis√©es** bas√©es sur le contenu des journaux, permettant des alertes et une surveillance bas√©es sur les donn√©es de journal.
4. **Vues de journal :** Les vues de journal offrent un contr√¥le avanc√© et **granulaire sur qui a acc√®s** aux journaux dans vos buckets de journaux.
* Cloud Logging **cr√©e automatiquement la vue `_AllLogs` pour chaque bucket**, qui affiche tous les journaux. Cloud Logging cr√©e √©galement une vue pour le bucket `_Default` appel√©e `_Default`. La vue `_Default` pour le bucket `_Default` affiche tous les journaux sauf les journaux d'audit d'acc√®s aux donn√©es. Les vues `_AllLogs` et `_Default` ne sont pas modifiables.

Il est possible de permettre √† un principal **d'utiliser uniquement une vue de journal sp√©cifique** avec une strat√©gie IAM comme :

{% code overflow="wrap" %}
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
{% endcode %}

### Journaux par d√©faut

Par d√©faut, les op√©rations **Admin Write** (√©galement appel√©es journaux d'audit des activit√©s des administrateurs) sont les seules enregistr√©es (√©crire des m√©tadonn√©es ou des informations de configuration) et **ne peuvent pas √™tre d√©sactiv√©es**.

Ensuite, l'utilisateur peut activer les **journaux d'audit des acc√®s aux donn√©es**, qui incluent les op√©rations **Admin Read, Data Write et Data Write**.

Vous pouvez trouver plus d'informations sur chaque type de journal dans la documentation : [https://cloud.google.com/iam/docs/audit-logging](https://cloud.google.com/iam/docs/audit-logging)

Cependant, notez que cela signifie qu'en par d√©faut, les actions telles que **`GetIamPolicy`** et autres actions de lecture ne sont **pas enregistr√©es**. Ainsi, par d√©faut, un attaquant tentant d'√©num√©rer l'environnement ne sera pas d√©tect√© si le sysadmin n'a pas configur√© la g√©n√©ration de plus de journaux.

Pour activer plus de journaux dans la console, le sysadmin doit se rendre sur [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) et les activer. Il existe 2 options diff√©rentes :

* **Configuration par d√©faut** : Il est possible de cr√©er une configuration par d√©faut et d'enregistrer tous les journaux Admin Read et/ou Data Read et/ou Data Write et m√™me d'ajouter des principaux exempt√©s :

<figure><img src="../../../.gitbook/assets/image (338).png" alt=""><figcaption></figcaption></figure>

* **S√©lectionner les services** : Ou simplement **s√©lectionner les services** pour lesquels vous souhaitez g√©n√©rer des journaux et le type de journaux ainsi que le principal except√© pour ce service sp√©cifique.

Notez √©galement qu'en par d√©faut, seuls ces journaux sont g√©n√©r√©s car g√©n√©rer plus de journaux augmentera les co√ªts.

### √ânum√©ration

L'outil en ligne de commande `gcloud` est une partie int√©grante de l'√©cosyst√®me GCP, vous permettant de g√©rer vos ressources et services. Voici comment vous pouvez utiliser `gcloud` pour g√©rer vos configurations de journalisation et acc√©der aux journaux.
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

Exemple pour v√©rifier les journaux de **`cloudresourcemanager`** (celui utilis√© pour BF permissions): [https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

Il n'y a pas de journaux de **`testIamPermissions`**:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Post Exploitation

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
