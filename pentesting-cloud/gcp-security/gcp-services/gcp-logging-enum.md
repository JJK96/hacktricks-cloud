# GCP - Kuchunguza Kumbukumbu

{% hint style="success" %}
Jifunze na zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks ya Mtaalam wa Timu Nyekundu ya AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks ya Mtaalam wa Timu Nyekundu ya GCP (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}

## Taarifa Msingi

Huduma hii inaruhusu watumiaji kuhifadhi, kutafuta, kuchambua, kufuatilia, na kutoa **data za kumbukumbu na matukio** kutoka GCP.

Kuchuja Kumbukumbu imejumuishwa kabisa na huduma zingine za GCP, ikitoa hifadhi ya kati ya kumbukumbu kutoka kwa rasilimali zako zote za GCP. **Inakusanya kiotomatiki kumbukumbu kutoka kwa huduma mbalimbali za GCP** kama App Engine, Compute Engine, na Cloud Functions. Unaweza pia kutumia Kuchuja Kumbukumbu kwa maombi yanayoendeshwa kwenye tovuti au katika mawingu mengine kwa kutumia wakala au API ya Kuchuja Kumbukumbu.

Vipengele muhimu:

* **Ukuzaji wa Data za Kumbukumbu:** Unganisha data za kumbukumbu kutoka vyanzo mbalimbali, kutoa mtazamo wa kina wa maombi yako na miundombinu.
* **Usimamizi wa Kumbukumbu Halisi:** Pasha kumbukumbu kwa wakati halisi kwa uchambuzi na majibu ya haraka.
* **Uchambuzi wa Data wenye Nguvu:** Tumia uwezo wa kuchuja na kutafuta wa hali ya juu kupitia kiasi kikubwa cha data za kumbukumbu haraka.
* **Uingiliano na BigQuery:** Toa kumbukumbu kwa BigQuery kwa uchambuzi na uulizaji wa kina.
* **Vipimo vya Kumbukumbu kulingana na Kumbukumbu:** Unda vipimo vya desturi kutoka kwa data yako ya kumbukumbu kwa ajili ya ufuatiliaji na kutuma arifa.

### Mchakato wa Kumbukumbu

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

Kimsingi visima na vipimo vya kumbukumbu vitafanya kazi ya kuhifadhi kumbukumbu.

### Vipimo Vinavyoungwa mkono na Kuchuja Kumbukumbu ya GCP

Kuchuja Kumbukumbu inaweza kubadilishwa kwa kiasi kikubwa ili kukidhi mahitaji mbalimbali ya uendeshaji:

1. **Maboksi ya Kumbukumbu (Hifadhi ya Kumbukumbu kwenye wavuti):** Taja maboksi katika Kuchuja Kumbukumbu kusimamia **kutunza kumbukumbu**, kutoa udhibiti juu ya muda gani viingizo vyako vya kumbukumbu vinahifadhiwa.
* Kwa chaguo-msingi maboksi `_Default` na `_Required` hujengwa (moja inachukua kile ambacho kingine hakifanyi hivyo).
*   **\_Required** ni:

{% code overflow="wrap" %}
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```
{% endcode %}
* **Muda wa kutunza** data unaweza kubadilishwa kwa kila boksi na lazima uwe **angalau siku 1.** Hata hivyo **muda wa kutunza wa \_Required ni siku 400** na hauwezi kubadilishwa.
* Tafadhali kumbuka kuwa Maboksi ya Kumbukumbu **hayapo wazi katika Uhifadhi wa Wingu.**
2. **Visima vya Kumbukumbu (Mlenga wa Kumbukumbu kwenye wavuti):** Unda visima ili **kusafirisha viingizo vya kumbukumbu** kwenye vituo mbalimbali kama Pub/Sub, BigQuery, au Uhifadhi wa Wingu kulingana na **kuchuja**.
* Kwa **chaguo-msingi** visima kwa maboksi `_Default` na `_Required` hujengwa:
* ```bash
_Required  logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **Vichujio vya Kutenga:** Inawezekana kuweka **vichujio vya kutenga kuzuia viingizo vya kumbukumbu maalum** kuingizwa, kuokoa gharama, na kupunguza kelele isiyo ya lazima.
3. **Vipimo vya Kumbukumbu kulingana na Kumbukumbu:** Sanidi **vipimo vya desturi** kulingana na maudhui ya kumbukumbu, kuruhusu arifa na ufuatiliaji kulingana na data ya kumbukumbu.
4. **Maoni ya Kumbukumbu:** Maoni ya kumbukumbu hutoa udhibiti wa juu na **wa kina juu ya nani anaye na upatikanaji** wa kumbukumbu ndani ya maboksi yako ya kumbukumbu.&#x20;
* Kuchuja Kumbukumbu **inaunda kiotomatiki maoni ya `_AllLogs` kwa kila boksi**, ambayo inaonyesha kumbukumbu zote. Kuchuja Kumbukumbu pia inaunda maoni kwa boksi la `_Default` linaloitwa `_Default`. Maoni ya `_Default` kwa boksi la `_Default` inaonyesha kumbukumbu zote isipokuwa kumbukumbu za Ukaguzi wa Upatikanaji wa Data. Maoni ya `_AllLogs` na `_Default` hayawezi kuhaririwa.

Inawezekana kuruhusu mwandishi **atumie maoni maalum ya Kumbukumbu** tu na sera ya IAM kama:

{% code overflow="wrap" %}
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
{% endcode %}

### Kumbukumbu za Mipangilio ya Msingi

Kwa chaguo-msingi, operesheni za **Andika Msimamizi** (zinazoitwa pia kumbukumbu za ukaguzi wa Shughuli za Msimamizi) ndizo zinazorekodiwa (andika metadata au maelezo ya usanidi) na **hazitaweza kuzimwa**.

Kisha, mtumiaji anaweza kuwezesha **Kumbukumbu za Ukaguzi wa Upatikanaji wa Data**, hizi ni **Soma ya Msimamizi, Andika Data na Soma ya Data**.

Unaweza kupata habari zaidi kuhusu kila aina ya kumbukumbu katika nyaraka: [https://cloud.google.com/iam/docs/audit-logging](https://cloud.google.com/iam/docs/audit-logging)

Hata hivyo, kumbuka kwamba hii inamaanisha kwamba kwa chaguo-msingi vitendo vya **`GetIamPolicy`** na vitendo vingine vya kusoma **havirekodiwi**. Kwa hivyo, kwa chaguo-msingi, mshambuliaji anayejaribu kutambua mazingira hatachukuliwa hatua ikiwa msimamizi wa mfumo hajaweza kusanidi kuzalisha kumbukumbu zaidi.

Ili kuwezesha kumbukumbu zaidi kwenye konsoli, msimamizi wa mfumo anahitaji kwenda [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) na kuziwezesha. Kuna chaguo 2 tofauti:

* **Mipangilio ya Msingi**: Inawezekana kuunda mipangilio ya msingi na kurekodi kumbukumbu zote za Soma ya Msimamizi na/au Soma ya Data na/au Andika Data na hata kuongeza mabwana waliopewa msamaha:

<figure><img src="../../../.gitbook/assets/image (338).png" alt=""><figcaption></figcaption></figure>

* **Chagua huduma**: Au tu **chagua huduma** unazotaka kuzalisha kumbukumbu na aina ya kumbukumbu na bwana aliye na msamaha kwa huduma hiyo maalum.

Pia kumbuka kwamba kwa chaguo-msingi kumbukumbu hizo pekee zinazalishwa kwa sababu kuzalisha kumbukumbu zaidi kutasababisha ongezeko la gharama.

### Uchambuzi

Zana ya amri ya `gcloud` ni sehemu muhimu ya mfumo wa GCP, ikiruhusu kusimamia rasilimali na huduma zako. Hapa ndio jinsi unavyoweza kutumia `gcloud` kusimamia mipangilio yako ya kumbukumbu na kupata kumbukumbu.
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

Mfano wa kuangalia logs za **`cloudresourcemanager`** (ile inayotumika kwa BF permissions): [https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

Hakuna logs za **`testIamPermissions`**:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Baada ya Uvamizi

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### Uimara

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## Marejeo

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

{% hint style="success" %}
Jifunze & fanyia mazoezi Uvamizi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & fanyia mazoezi Uvamizi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au **kikundi cha** [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
