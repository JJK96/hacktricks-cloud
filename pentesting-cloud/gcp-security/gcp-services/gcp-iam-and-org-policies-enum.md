# GCP - IAM, Principals & Org Policies Enum

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitimi AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitimi GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## Hizmet Hesapları

Hizmet hesabı nedir hakkında bir giriş için şu adrese bakın:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### Numaralandırma

Bir hizmet hesabı her zaman bir projeye aittir:
```bash
gcloud iam service-accounts list --project <project>
```
## Kullanıcılar ve Gruplar

GCP'de Kullanıcılar ve Gruplar nasıl çalıştığı hakkında bir giriş için şu linke bakabilirsiniz:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### Numaralandırma

**`serviceusage.services.enable`** ve **`serviceusage.services.use`** izinleri ile bir projede **hizmetleri etkinleştirmek** ve kullanmak mümkündür.

{% hint style="danger" %}
Varsayılan olarak, Workspace kullanıcılarına **Proje Oluşturucu** rolü verilir, bu da onlara **yeni projeler oluşturma** erişimi sağlar. Bir kullanıcı bir proje oluşturduğunda, projenin üzerinde **`owner`** rolü verilir. Bu nedenle, **Workspace'i numaralandırabilmek için bu hizmetleri etkinleştirebilir**.

Ancak, bu API'ları çağırabilmek için **Workspace'ta yeterli izne sahip olmak da gereklidir**.
{% endhint %}

Eğer **`admin` hizmetini etkinleştirebilirseniz** ve kullanıcıınızın **Workspace'ta yeterli ayrıcalıkları varsa**, aşağıdaki satırlarla **tüm grupları ve kullanıcıları numaralandırabilirsiniz**.\
**`kimlik grupları`** dese de, **grubu olmayan kullanıcıları da döndürür**:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user (you can list at least the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members (you can list at least the groups you belong to)
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
Önceki örneklerde parametre `--labels` gereklidir, bu yüzden genel bir değer kullanılır (API doğrudan kullanıldıysa gerekli değildir, örneğin [**PurplePanda burada yaptığı gibi**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py).
{% endhint %}

Yönetici hizmeti etkin olsa bile, tehlikeye düşmüş çalışma alanı kullanıcınızın yeterli izinlere sahip olmadığından dolayı bunları sıralarken hata almanız mümkündür:

<figure><img src="../../../.gitbook/assets/image (193).png" alt=""><figcaption></figcaption></figure>

## IAM

IAM hakkında temel bilgiler için [**buraya bakın**](../gcp-basic-information/#iam-roles).

### Varsayılan İzinler

[**Belgelerden**](https://cloud.google.com/resource-manager/docs/default-access-control): Bir organizasyon kaynağı oluşturulduğunda, varsayılan olarak tüm alanınızdaki kullanıcılara **Billing Account Creator** ve **Project Creator** rolleri verilir. Bu varsayılan roller, kullanıcılarınızın Google Cloud'u hemen kullanmaya başlamalarını sağlar, ancak organizasyon kaynağınızın düzenli işleyişinde kullanılması amaçlanmamıştır.

Bu **roller** şu **izinleri** verir:

* `billing.accounts.create` ve `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` ve `resourcemanager.projects.create`

Ayrıca, bir kullanıcı bir proje oluşturduğunda, [belgelere](https://cloud.google.com/resource-manager/docs/access-control-proj) göre **otomatik olarak o projenin sahibi olur**. Dolayısıyla, varsayılan olarak, bir kullanıcı bir proje oluşturabilir ve üzerinde herhangi bir hizmeti çalıştırabilir (madenciler? Workspace sıralaması? ...)

{% hint style="danger" %}
GCP Organizasyonunda en yüksek ayrıcalık **Organization Administrator** rolüdür.
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

Çoğu hizmette, bir kaynağın üzerindeki izinleri değiştirebilirsiniz, bunu **`add-iam-policy-binding`** veya **`set-iam-policy`** yöntemini kullanarak yapabilirsiniz. Temel fark, **`add-iam-policy-binding`'in mevcut IAM politikasına yeni bir rol bağlama** eklemesi, **`set-iam-policy`**'in ise önceden verilen izinleri **silecek** ve yalnızca komutta belirtilenleri **ayarlayacak** olmasıdır.

### Sıralama
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
### Bulut varlık IAM Numaralandırma

Farklı kaynaklardaki (örneğin organizasyonlar, klasörler, projeler...) bir kullanıcının tüm izinlerini kontrol etmek için bu hizmeti kullanmanın farklı yolları vardır.

* **`cloudasset.assets.searchAllIamPolicies`** izni, bir kaynağın içindeki **tüm iam politikalarını** isteyebilir.
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* İzin **`cloudasset.assets.analyzeIamPolicy`**, bir kaynak içindeki bir ilkenin **tüm iam politikalarını** isteyebilir.
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* İzin **`cloudasset.assets.searchAllResources`**, bir organizasyonun, klasörün veya projenin tüm kaynaklarını listeleme izni verir. IAM ile ilgili kaynaklar (roller gibi) dahildir.
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* İzin **`cloudasset.assets.analyzeMove`** bir proje gibi bir kaynağı etkileyen politikaları da almak için kullanışlı olabilir.
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* Tahmin ediyorum ki **`cloudasset.assets.queryIamPolicy`** izni aynı zamanda prensiplerin izinlerini bulmaya erişim sağlayabilir
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
### testIamPermissions numaralandırma&#x20;

{% hint style="danger" %}
Eğer **önceki yöntemlerle IAM bilgilerine erişemiyorsanız** ve Kırmızı Takım'da bulunuyorsanız, mevcut izinlerinizi kaba kuvvet uygulamak için [**https://github.com/carlospolop/bf\_my\_gcp\_perms**](https://github.com/carlospolop/bf\_my\_gcp\_perms) **adlı aracı kullanabilirsiniz.**

Ancak, hizmetin **`cloudresourcemanager.googleapis.com`** etkinleştirilmiş olması gerektiğini unutmayın.
{% endhint %}

### İzin Yükseltme

Aşağıdaki sayfada, **IAM izinlerini kötüye kullanarak ayrıcalıkları yükseltme** hakkında bilgi edinebilirsiniz:

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Kimlik Doğrulamasız Numaralandırma <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### Saldırı Sonrası İşlemler <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### Kalıcılık

Yüksek ayrıcalıklara sahipseniz şunları yapabilirsiniz:

* Yeni Hizmet Hesapları oluşturun (veya Workspace'te kullanıcılar oluşturun)
* Kendiniz tarafından kontrol edilen prensiplere daha fazla izin verin
* Daha fazla ayrıcalık tanıyın (vm'de SSRF, zayıf Cloud Function'lar için...)
* ...

## Org Politikaları

Org Politikaları hakkında genel bir bilgi için şuraya bakabilirsiniz:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

IAM politikaları, roller aracılığıyla prensiplerin kaynaklar üzerindeki izinlerini gösterir, bu roller ayrıcalıkları granüler şekilde atar. Organizasyon politikaları **bu hizmetlerin nasıl kullanılabileceğini veya hangi özelliklerin devre dışı bırakılacağını kısıtlar**. Bu, GCP ortamındaki her kaynağın en az ayrıcalığını artırmaya yardımcı olur.
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### İst Privileges

Aşağıdaki sayfada, **yetkileri yükseltmek için org politikaları izinlerini kötüye kullanma** yöntemlerini kontrol edebilirsiniz:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
