# GCP - Wyliczanie IAM, Podmiotów i Polityk Org

{% hint style="success" %}
Dowiedz się i ćwicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz się i ćwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostępnij sztuczki hakerskie, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów na GitHubie.

</details>
{% endhint %}

## Konta Usług

Aby dowiedzieć się więcej na temat tego, co to jest konto usługi, sprawdź:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### Wyliczanie

Konto usługi zawsze należy do projektu:
```bash
gcloud iam service-accounts list --project <project>
```
## Użytkownicy i Grupy

Aby uzyskać wprowadzenie do tego, jak działają Użytkownicy i Grupy w GCP, sprawdź:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### Wyliczanie

Dzięki uprawnieniom **`serviceusage.services.enable`** i **`serviceusage.services.use`** można **włączać usługi** w projekcie i ich używać.

{% hint style="danger" %}
Zauważ, że domyślnie użytkownicy Workspace otrzymują rolę **Twórca projektu**, dając im dostęp do **tworzenia nowych projektów**. Gdy użytkownik tworzy projekt, otrzymuje rolę **`owner`** nad nim. Dlatego może **włączyć te usługi w projekcie, aby móc wyliczyć Workspace**.

Jednak zauważ, że konieczne jest również posiadanie **wystarczających uprawnień w Workspace**, aby móc wywołać te interfejsy API.
{% endhint %}

Jeśli możesz **włączyć usługę `admin`** i jeśli twój użytkownik ma **wystarczające uprawnienia w Workspace**, możesz **wyliczyć wszystkie grupy i użytkowników** za pomocą poniższych poleceń. Nawet jeśli mówi **`grupy tożsamości`**, zwraca również **użytkowników bez żadnych grup**:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user (you can list at least the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members (you can list at least the groups you belong to)
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
W poprzednich przykładach parametr `--labels` jest wymagany, dlatego używana jest ogólna wartość (nie jest wymagany, jeśli używasz API bezpośrednio, tak jak [**robi PurplePanda tutaj**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py).
{% endhint %}

Nawet po włączeniu usługi admin, możliwe jest, że wystąpi błąd podczas wyliczania ich, ponieważ skompromitowany użytkownik przestrzeni roboczej nie ma wystarczających uprawnień:

<figure><img src="../../../.gitbook/assets/image (193).png" alt=""><figcaption></figcaption></figure>

## IAM

Sprawdź [**to podstawowe informacje o IAM**](../gcp-basic-information/#iam-roles).

### Domyślne uprawnienia

Z [**dokumentacji**](https://cloud.google.com/resource-manager/docs/default-access-control): Gdy tworzony jest zasób organizacji, wszyscy użytkownicy w Twojej domenie otrzymują domyślnie role **Twórca konta rozliczeniowego** i **Twórca projektu**. Te domyślne role pozwalają Twoim użytkownikom natychmiast zacząć korzystać z Google Cloud, ale nie są przeznaczone do regularnego użytku w zasobach organizacji.

Te **role** nadają **uprawnienia**:

* `billing.accounts.create` i `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` i `resourcemanager.projects.create`

Ponadto, gdy użytkownik tworzy projekt, automatycznie **otrzymuje uprawnienia właściciela tego projektu** zgodnie z [dokumentacją](https://cloud.google.com/resource-manager/docs/access-control-proj). Dlatego domyślnie użytkownik będzie mógł tworzyć projekt i uruchamiać na nim dowolną usługę (koparki? Wyliczanie przestrzeni roboczej? ...)

{% hint style="danger" %}
Najwyższą uprawnieniem w organizacji GCP jest rola **Administratora organizacji**.
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

W większości usług będziesz mógł zmieniać uprawnienia dla zasobu za pomocą metody **`add-iam-policy-binding`** lub **`set-iam-policy`**. Główną różnicą jest to, że **`add-iam-policy-binding` dodaje nowe powiązanie roli** do istniejącej polityki IAM, podczas gdy **`set-iam-policy`** **usunie wcześniej** przyznane uprawnienia i **ustawi tylko te**, które są wskazane w poleceniu.

### Wyliczanie
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
### Enumeracja IAM cloudasset

Istnieją różne sposoby sprawdzenia wszystkich uprawnień użytkownika w różnych zasobach (takich jak organizacje, foldery, projekty...) za pomocą tej usługi.

* Uprawnienie **`cloudasset.assets.searchAllIamPolicies`** może żądać **wszystkich polityk IAM** wewnątrz zasobu.
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* Uprawnienie **`cloudasset.assets.analyzeIamPolicy`** może żądać **wszystkich polityk IAM** podmiotu w zasobie.
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* Uprawnienie **`cloudasset.assets.searchAllResources`** pozwala na wyświetlanie wszystkich zasobów organizacji, folderu lub projektu. Zasoby związane z IAM (takie jak role) są uwzględnione.
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* Uprawnienie **`cloudasset.assets.analyzeMove`** może być przydatne do pobrania polityk dotyczących zasobu, takiego jak projekt
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* Przypuszczam, że uprawnienie **`cloudasset.assets.queryIamPolicy`** również może umożliwiać znalezienie uprawnień podmiotów
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
### Testowanie uprawnień Iam

{% hint style="danger" %}
Jeśli **nie możesz uzyskać dostępu do informacji IAM** za pomocą poprzednich metod i jesteś w Red Teamie. Możesz **użyć narzędzia** [**https://github.com/carlospolop/bf\_my\_gcp\_perms**](https://github.com/carlospolop/bf\_my\_gcp\_perms) **do brutalnego testowania Twoich obecnych uprawnień.**

Należy jednak pamiętać, że usługa **`cloudresourcemanager.googleapis.com`** musi być włączona.
{% endhint %}

### Eskalacja uprawnień

Na następnej stronie możesz sprawdzić, jak **nadużyć uprawnień IAM w celu eskalacji uprawnień**:

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Enumeracja bez uwierzytelnienia <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### Po eksploatacji <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### Trwałość

Jeśli masz wysokie uprawnienia, możesz:

* Tworzyć nowe SA (lub użytkowników, jeśli jesteś w Workspace)
* Nadawać podmiotom kontrolowanym przez siebie więcej uprawnień
* Przyznawać więcej uprawnień podatnym SA (SSRF w vm, podatna funkcja Cloud...)
* ...

## Polityki organizacyjne

Aby uzyskać wprowadzenie do tego, czym są polityki organizacyjne, sprawdź:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

Polityki IAM wskazują, jakie uprawnienia mają podmioty do zasobów za pomocą ról, które przypisują szczegółowe uprawnienia. Polityki organizacyjne **ograniczają sposób korzystania z tych usług lub wyłączają określone funkcje**. Pomaga to poprawić zasadę najmniejszych uprawnień dla każdego zasobu w środowisku GCP.
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Eskalacja uprawnień

Na następnej stronie możesz sprawdzić, jak **nadużyć uprawnienia polityk organizacyjnych do eskalacji uprawnień**:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
Dowiedz się i ćwicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz się i ćwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostępniaj sztuczki hakerskie, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów na GitHubie.

</details>
{% endhint %}
