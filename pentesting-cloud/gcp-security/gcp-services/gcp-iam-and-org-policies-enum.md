# GCP - IAM、プリンシパル＆組織ポリシーの列挙

{% hint style="success" %}
AWSハッキングの学習と練習：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
{% endhint %}

## サービスアカウント

サービスアカウントについての紹介はこちらを参照してください：

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### 列挙

サービスアカウントは常にプロジェクトに属しています：
```bash
gcloud iam service-accounts list --project <project>
```
## ユーザー＆グループ

GCPでのユーザー＆グループの動作についての紹介は、以下をチェックしてください:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### 列挙

権限 **`serviceusage.services.enable`** と **`serviceusage.services.use`** を使用すると、プロジェクトで **サービスを有効化** し、使用することができます。

{% hint style="danger" %}
デフォルトでは、Workspaceユーザーには **Project Creator** の役割が付与され、**新しいプロジェクトを作成** する権限が与えられます。ユーザーがプロジェクトを作成すると、そのユーザーはそれに対して **`owner`** 役割が付与されます。そのため、彼は **プロジェクトでこれらのサービスを有効化** してWorkspaceを列挙することができます。

ただし、これらのAPIを呼び出すためには、Workspaceで **十分な権限が必要** であることに注意してください。
{% endhint %}

**`admin`サービスを有効化** でき、かつユーザーがWorkspaceで **十分な特権を持っている** 場合、以下の行を使用して **すべてのグループ＆ユーザーを列挙** できます。\
**`identity groups`** と記載されている場合でも、**グループなしのユーザー** も返されます:
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user (you can list at least the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members (you can list at least the groups you belong to)
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
前の例では、パラメータ `--labels` が必要なので、一般的な値が使用されます（[**PurplePanda がここで行っているように**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py) のように直接 API を使用する場合は必要ありません）。
{% endhint %}

管理サービスが有効になっていても、侵害されたワークスペースユーザーに十分な権限がないため、それらを列挙する際にエラーが発生する可能性があります：

<figure><img src="../../../.gitbook/assets/image (193).png" alt=""><figcaption></figcaption></figure>

## IAM

IAM に関する基本情報については、[**こちらを参照してください**](../gcp-basic-information/#iam-roles)。

### デフォルトの権限

[**ドキュメント**](https://cloud.google.com/resource-manager/docs/default-access-control) によると、組織リソースが作成されると、デフォルトでドメイン内のすべてのユーザーに **Billing Account Creator** および **Project Creator** の役割が付与されます。これらのデフォルトの役割により、ユーザーはすぐに Google Cloud を使用できるようになりますが、組織リソースの通常の運用には適していません。

これらの **役割** は以下の **権限** を付与します：

* `billing.accounts.create` および `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` および `resourcemanager.projects.create`

さらに、ユーザーがプロジェクトを作成すると、[ドキュメント](https://cloud.google.com/resource-manager/docs/access-control-proj) によると、そのプロジェクトの所有者が自動的に付与されます。したがって、デフォルトでは、ユーザーはプロジェクトを作成し、その上で任意のサービスを実行できます（マイナー？ワークスペースの列挙？...）

{% hint style="danger" %}
GCP 組織での最高の権限は **Organization Administrator** 役割です。
{% endhint %}

### set-iam-policy と add-iam-policy-binding

ほとんどのサービスでは、リソース上の権限を変更するために **`add-iam-policy-binding`** または **`set-iam-policy`** メソッドを使用できます。主な違いは、**`add-iam-policy-binding` は既存の IAM ポリシーに新しいロール バインディングを追加**するのに対し、**`set-iam-policy`** は以前に付与された権限を削除し、コマンドで指定された権限のみを設定します。

### 列挙
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
### cloudasset IAM 列挙

ユーザーのすべての権限をさまざまなリソース（組織、フォルダー、プロジェクトなど）でチェックするための異なる方法があります。このサービスを使用して、リソース内のすべての IAM ポリシーをリクエストできます。

* 権限 **`cloudasset.assets.searchAllIamPolicies`** は、リソース内の **すべての IAM ポリシー** をリクエストできます。
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* 権限 **`cloudasset.assets.analyzeIamPolicy`** は、リソース内のプリンシパルの **すべての IAM ポリシー** をリクエストできます。
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* 権限 **`cloudasset.assets.searchAllResources`** は、組織、フォルダ、またはプロジェクトのすべてのリソースをリストアップすることを許可します。IAM 関連のリソース（役割など）が含まれます。
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* 権限 **`cloudasset.assets.analyzeMove`** は、プロジェクトのようなリソースに影響を与えるポリシーを取得するのにも役立ちます。
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* 私は、権限 **`cloudasset.assets.queryIamPolicy`** が主体の権限を見つけるためのアクセス権も与える可能性があると考えています
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
### testIamPermissions列挙

{% hint style="danger" %}
前述の方法でIAM情報にアクセスできない場合、Red Teamにいる場合は、[https://github.com/carlospolop/bf_my_gcp_perms](https://github.com/carlospolop/bf_my_gcp_perms) **ツールを使用して**現在の権限を総当たり攻撃することができます。

ただし、`cloudresourcemanager.googleapis.com`サービスが有効になっている必要があります。
{% endhint %}

### 特権昇格

次のページでは、**IAM権限を悪用して特権を昇格**する方法を確認できます：

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### 認証なしの列挙 <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### ポストエクスプロイテーション <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### 永続化

特権が高い場合は、次のことができます：

- 新しいSAを作成する（またはWorkspaceの場合はユーザーを作成する）
- 自分自身が制御するプリンシパルにより多くの権限を付与する
- 脆弱なSAにより多くの特権を付与する（vm内のSSRF、脆弱なCloud Functionなど）
- ...

## 組織ポリシー

組織ポリシーについての紹介は次を参照してください：

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

IAMポリシーは、役割を介してプリンシパルがリソースに対して持つ権限を示し、それらは細かい権限が割り当てられた役割です。組織ポリシーは、**これらのサービスの使用方法を制限したり、無効にする機能を指定**します。これにより、GCP環境の各リソースの最小特権を向上させるのに役立ちます。
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### 特権昇格

次のページで、**組織ポリシーの権限を悪用して特権を昇格させる方法**を確認できます：

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
AWSハッキングの学習と実践：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と実践：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**購読プラン**](https://github.com/sponsors/carlospolop)を確認してください！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
{% endhint %}
