# GCP - Uthibitishaji wa IAM, Mabalozi & Sera za Shirika

{% hint style="success" %}
Jifunze na zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Akaunti za Huduma

Kwa maelezo kuhusu ni nini akaunti ya huduma angalia:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### Uthibitishaji

Akaunti ya huduma daima inahusishwa na mradi:
```bash
gcloud iam service-accounts list --project <project>
```
## Watumiaji & Vikundi

Kwa maelezo kuhusu jinsi Watumiaji & Vikundi wanavyofanya kazi katika GCP angalia:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### Uchambuzi

Kwa ruhusa za **`serviceusage.services.enable`** na **`serviceusage.services.use`** inawezekana **kuwezesha huduma** katika mradi na kuzitumia.

{% hint style="danger" %}
Tafadhali kumbuka kuwa kwa chaguo-msingi, watumiaji wa Workspace wanapewa jukumu la **Mwanzilishi wa Mradi**, kuwapa ufikiaji wa **kuunda miradi mipya**. Wakati mtumiaji anapounda mradi, anapewa jukumu la **`mmiliki`** juu yake. Hivyo, anaweza **kuwezesha huduma hizi kwenye mradi ili aweze kuchambua Workspace**.

Hata hivyo, kumbuka kuwa pia ni muhimu kuwa na **ruhusa za kutosha katika Workspace** ili uweze kuita APIs hizi.
{% endhint %}

Ikiwa unaweza **kuwezesha huduma ya `admin`** na ikiwa mtumiaji wako ana **ruhusa za kutosha katika workspace**, unaweza **kuchambua vikundi & watumiaji wote** kwa mistari ifuatayo.\
Hata kama inasema **`vikundi vya utambulisho`**, pia inarudi **watumiaji bila vikundi vyovyote**:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user (you can list at least the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members (you can list at least the groups you belong to)
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
Katika mifano iliyopita param `--labels` inahitajika, kwa hivyo thamani ya kawaida hutumiwa (haipaswi kutumiwa ikiwa unatumia API moja kwa moja kama [**PurplePanda anavyofanya hapa**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py).
{% endhint %}

Hata na huduma ya admin kuwezeshwa, inawezekana upate kosa unapojaribu kuziorodhesha kwa sababu mtumiaji wa nafasi yako iliyovamiwa hana idhini za kutosha:

<figure><img src="../../../.gitbook/assets/image (193).png" alt=""><figcaption></figcaption></figure>

## IAM

Angalia [**hii kwa habari za msingi kuhusu IAM**](../gcp-basic-information/#iam-roles).

### Idhini za Kimsingi

Kutoka kwa [**nyaraka**](https://cloud.google.com/resource-manager/docs/default-access-control): Wakati rasilimali ya shirika inapoundwa, watumiaji wote katika kikoa chako wanapewa majukumu ya **Mjenzi wa Akaunti ya Bili** na **Mjenzi wa Mradi** kwa chaguo-msingi. Majukumu haya ya msingi huruhusu watumiaji wako kuanza kutumia Google Cloud mara moja, lakini sio kwa matumizi ya kawaida ya rasilimali ya shirika lako.

Majukumu haya yanatoa **idhini**:

* `billing.accounts.create` na `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` na `resourcemanager.projects.create`

Zaidi ya hayo, wakati mtumiaji anapounda mradi, yeye **anapewa moja kwa moja umiliki wa mradi huo** kulingana na [nyaraka](https://cloud.google.com/resource-manager/docs/access-control-proj). Kwa hivyo, kwa chaguo-msingi, mtumiaji ataweza kuunda mradi na kuendesha huduma yoyote kwenye mradi huo (wachimbaji? Uorodheshaji wa Nafasi ya Kazi? ...)

{% hint style="danger" %}
Idhini ya juu kabisa katika Shirika la GCP ni jukumu la **Msimamizi wa Shirika**.
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

Katika huduma nyingi utaweza kubadilisha idhini kwenye rasilimali kwa kutumia njia ya **`add-iam-policy-binding`** au **`set-iam-policy`**. Tofauti kuu ni kwamba **`add-iam-policy-binding` huongeza kifungo kipya cha jukumu** kwenye sera ya IAM iliyopo wakati **`set-iam-policy`** ita **futa idhini zilizotolewa hapo awali** na **kuweka tu zile** zilizotajwa katika amri. 

### Uorodheshaji
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
### Uchambuzi wa IAM wa cloudasset

Kuna njia tofauti za kuangalia ruhusa zote za mtumiaji kwenye rasilimali tofauti (kama vile mashirika, folda, miradi...) kwa kutumia huduma hii.

* Ruhusa **`cloudasset.assets.searchAllIamPolicies`** inaweza kuomba **sera zote za iam** ndani ya rasilimali.
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* Kibali **`cloudasset.assets.analyzeIamPolicy`** kinaweza kuomba **sera zote za iam** za msingi ndani ya rasilimali.
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* Kibali **`cloudasset.assets.searchAllResources`** kuruhusu orodha ya rasilimali zote za shirika, folda, au mradi. Rasilimali zinazohusiana na IAM (kama vile majukumu) zimejumuishwa.
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* Uwezo wa **`cloudasset.assets.analyzeMove`** lakini unaweza kuwa na manufaa pia kwa kupata sera zinazoathiri rasilimali kama mradi
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* Ninafikiri ruhusa **`cloudasset.assets.queryIamPolicy`** inaweza pia kutoa ufikiaji wa kupata ruhusa za wakuu
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
### Uchambuzi wa ruhusa za IamPermissions

{% hint style="danger" %}
Ikiwa **hauwezi kupata habari za IAM** kwa kutumia njia za awali na uko kwenye Timu Nyekundu. Unaweza **kutumia zana**[ **https://github.com/carlospolop/bf\_my\_gcp\_perms**](https://github.com/carlospolop/bf\_my\_gcp\_perms) **kufanya nguvu ya kutumia ruhusa zako za sasa.**

Walakini, kumbuka kuwa huduma **`cloudresourcemanager.googleapis.com`** inahitaji kuwezeshwa.
{% endhint %}

### Privesc

Kwenye ukurasa ufuatao unaweza kuangalia jinsi ya **kutumia vibali vya IAM kuboresha mamlaka**:

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Uchambuzi Bila Kuthibitishwa <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### Baada ya Kuvamia <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### Uthabiti

Ikiwa una mamlaka makubwa unaweza:

* Unda akaunti mpya za SAs (au watumiaji ikiwa ni kwenye Workspace)
* Toa vibali zaidi kwa mabwana wanaodhibitiwa na wewe
* Toa mamlaka zaidi kwa SAs zenye udhaifu (SSRF kwenye vm, Cloud Function yenye udhaifu‚Ä¶)
* ...

## Sera za Shirika

Kwa maelezo kuhusu ni nini Sera za Shirika angalia:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

Sera za IAM zinaonyesha ruhusa ambazo mabwana wana juu ya rasilimali kupitia majukumu, ambayo hupewa ruhusa za kugawanywa kwa undani. Sera za Shirika **zinaruhusu jinsi huduma hizo zinaweza kutumika au ni vipengele vipi vilivyozimwa**. Hii husaidia kuboresha haki ndogo ya kila rasilimali katika mazingira ya GCP.
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Privesc

Kwenye ukurasa ufuatao unaweza kuangalia jinsi ya **kutumia ruhusa za sera za shirika kuboresha mamlaka**:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
Jifunze na zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
