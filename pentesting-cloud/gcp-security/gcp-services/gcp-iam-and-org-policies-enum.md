# GCP - IAM、主体和组织策略枚举

{% hint style="success" %}
学习并练习AWS Hacking：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 检查[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}

## 服务账号

有关服务账号的简介，请查看：

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### 枚举

服务账号始终属于一个项目：
```bash
gcloud iam service-accounts list --project <project>
```
## 用户和用户组

有关在GCP中用户和用户组如何工作的简介，请查看：

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### 枚举

通过权限 **`serviceusage.services.enable`** 和 **`serviceusage.services.use`**，可以在项目中**启用服务**并使用它们。

{% hint style="danger" %}
请注意，默认情况下，Workspace用户被授予 **项目创建者** 角色，使他们能够**创建新项目**。当用户创建一个项目时，他被授予该项目的 **`owner`** 角色。因此，他可以**在项目上启用这些服务以便枚举Workspace**。

但是，请注意，还需要在Workspace中**具有足够的权限**才能调用这些API。
{% endhint %}

如果您可以**启用`admin`服务**，并且您的用户在Workspace中具有**足够的特权**，您可以使用以下代码**枚举所有用户组和用户**。\
即使它说**`身份组`**，它也会返回**没有任何组的用户**：
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user (you can list at least the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members (you can list at least the groups you belong to)
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
在前面的示例中，参数 `--labels` 是必需的，因此使用了一个通用值（如果您直接使用 API，就不需要，就像[**PurplePanda 在这里所做的那样**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py)。
{% endhint %}

即使启用了管理员服务，由于您受损的 Workspace 用户没有足够的权限，可能会在枚举它们时出现错误：

<figure><img src="../../../.gitbook/assets/image (193).png" alt=""><figcaption></figcaption></figure>

## IAM

查看[**这里有关 IAM 的基本信息**](../gcp-basic-information/#iam-roles)。

### 默认权限

根据[文档](https://cloud.google.com/resource-manager/docs/default-access-control)：创建组织资源时，默认情况下，您域中的所有用户都被授予**计费帐户创建者**和**项目创建者**角色。这些默认角色允许您的用户立即开始使用 Google Cloud，但不适用于您组织资源的常规操作。

这些**角色**授予以下**权限**：

* `billing.accounts.create` 和 `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` 和 `resourcemanager.projects.create`

此外，根据[文档](https://cloud.google.com/resource-manager/docs/access-control-proj)，当用户创建项目时，他将**自动被授予该项目的所有者**。因此，默认情况下，用户将能够创建项目并在其上运行任何服务（矿工？Workspace 枚举？...）

{% hint style="danger" %}
GCP 组织中的最高特权是**组织管理员**角色。
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

在大多数服务中，您可以使用方法**`add-iam-policy-binding`**或**`set-iam-policy`**更改资源上的权限。主要区别在于**`add-iam-policy-binding`会向现有 IAM 策略添加新的角色绑定**，而**`set-iam-policy`**将**删除先前**授予的权限，并**仅设置**命令中指定的权限。

### 枚举
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
### cloudasset IAM枚举

有不同的方法可以使用此服务检查用户在不同资源（如组织、文件夹、项目...）中的所有权限。

* 权限 **`cloudasset.assets.searchAllIamPolicies`** 可以请求资源内的 **所有iam策略**。
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* 权限 **`cloudasset.assets.analyzeIamPolicy`** 可以请求资源内特定主体的**所有 IAM 策略**。
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* 权限 **`cloudasset.assets.searchAllResources`** 允许列出组织、文件夹或项目的所有资源，包括 IAM 相关资源（如角色）。
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* 权限 **`cloudasset.assets.analyzeMove`** 可以用于检索影响资源（如项目）的策略。
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* 我认为权限 **`cloudasset.assets.queryIamPolicy`** 也可以访问查找主体权限
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
### 测试IamPermissions枚举

{% hint style="danger" %}
如果您无法使用先前的方法访问IAM信息，并且您是红队成员。您可以使用工具[**https://github.com/carlospolop/bf\_my\_gcp\_perms**](https://github.com/carlospolop/bf\_my\_gcp\_perms) 来暴力破解您当前的权限。

但请注意，需要启用服务`cloudresourcemanager.googleapis.com`。
{% endhint %}

### 提权

在以下页面中，您可以查看如何滥用IAM权限以提升特权：

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### 未经身份验证的枚举 <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### 后期利用 <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### 持久性

如果您拥有高权限，您可以：

- 创建新的SA（或用户，如果在Workspace中）
- 为自己控制的主体提供更多权限
- 为易受攻击的SA提供更多特权（vm中的SSRF，vuln Cloud Function等）
- ...

## 机构策略

有关机构策略的简介，请查看：

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

IAM策略指示了主体通过角色对资源拥有的权限，这些角色分配了细粒度的权限。组织策略**限制了这些服务的使用方式或禁用了哪些功能**。这有助于改善GCP环境中每个资源的最小特权。
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### 提权

您可以查看以下页面，了解如何**滥用组织策略权限来提升特权**：

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

{% hint style="success" %}
学习并实践AWS黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks培训AWS红队专家（ARTE）**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并实践GCP黑客技术：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks培训GCP红队专家（GRTE）**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持HackTricks</summary>

* 查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享黑客技巧。

</details>
{% endhint %}
