# GCP - Temel Bilgiler

<details>

<summary><strong>Sıfırdan kahraman olmak için AWS hackleme öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI'na**](https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

## **Kaynak hiyerarşisi**

Google Cloud, kavramsal olarak geleneksel bir dosya sistemininkine benzer bir [Kaynak hiyerarşisi](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) kullanır. Bu, belirli politika ve izinler için mantıksal bir ebeveyn/çocuk iş akışı sağlar.

Yüksek seviyede şöyle görünür:
```
Organization
--> Folders
--> Projects
--> Resources
```
## **Proje Göçleri**

**Herhangi bir organizasyon olmadan bir projeyi bir organizasyona göç etmek mümkündür**. Bu işlem için `roles/resourcemanager.projectCreator` ve `roles/resourcemanager.projectMover` izinlerine sahip olmak gerekmektedir. Eğer proje başka bir organizasyonun içindeyse, önce onları organizasyondan çıkarmak için GCP destek ekibiyle iletişime geçmek gerekmektedir. Daha fazla bilgi için [**buraya**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6) bakabilirsiniz.

## **Organizasyon Politikaları**

Organizasyonunuzun bulut kaynakları üzerinde merkezi kontrol sağlamasına izin verir:

- Organizasyonunuzun kaynaklarının nasıl kullanılabileceğine dair **kısıtlamaları yapılandırmak** için merkezi kontrol sağlar.
- Geliştirme ekiplerinin uyumluluk sınırları içinde kalmasını sağlamak için **sınırlar** tanımlar ve oluşturur.
- Proje sahiplerine ve ekiplerine uyumluluğu bozmadan hızlı hareket etmelerine yardımcı olur.

Bu politikalar, **tüm organizasyonu, klasör(leri) veya projeyi(leri) etkileyebilir**. Hedeflenen kaynak hiyerarşisi düğümünün **alt kümeleri organizasyon politikasını miras alır**.

Bir organizasyon politikasını **tanımlamak** için, bir [**kısıtlama**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints) seçersiniz, bu belirli bir Google Cloud hizmetine veya bir grup Google Cloud hizmetine karşı bir tür kısıtlamadır. Bu kısıtlamayı **istediğiniz kısıtlamalarla yapılandırırsınız**.

#### Ortak kullanım durumları <a href="#common_use_cases" id="common_use_cases"></a>

- Alan adına göre kaynak paylaşımını sınırlama.
- Kimlik ve Erişim Yönetimi hizmet hesaplarının kullanımını sınırlama.
- Yeni oluşturulan kaynakların fiziksel konumunu kısıtlama.
- Hizmet hesabı oluşturmayı devre dışı bırakma

### **Varsayılan Organizasyon Politikaları**

<details>

<summary>Google'ın GCP organizasyonunuzu kurarken varsayılan olarak ekleyeceği politikalar:</summary>

**Erişim Yönetimi Politikaları**

- **Alan adı kısıtlı kişiler:** Belirtilen alan dışındaki Kritik Kişilere kullanıcı eklenmesini engeller. Bu, yalnızca yönetilen kullanıcı kimliklerine sahip kişilerin platform bildirimleri almasına izin verir.
- **Alan adı kısıtlı paylaşım:** Belirtilen alan dışındaki IAM politikalarına kullanıcı eklenmesini engeller. Bu, yalnızca seçtiğiniz alanlardaki yönetilen kullanıcı kimliklerinin bu organizasyon içindeki kaynaklara erişmesine izin verir.
- **Genel erişim önleme:** Cloud Storage kovalarının genel erişime açık olmasını engeller. Bu, bir geliştiricinin Cloud Storage kovalarını kimliksiz internet erişimine sahip olacak şekilde yapılandırmasını engeller.
- **Düzgün kova düzeyinde erişim:** Cloud Storage kovalarındaki nesne düzeyinde erişim denetim listelerini (ACL'ler) engeller. Bu, Cloud Storage kovalarındaki tüm nesnelere tutarlı bir şekilde IAM politikaları uygulayarak erişim yönetiminizi basitleştirir.
- **İşletim Sistemi girişini gerektir:** Yeni projelerde oluşturulan VM'lerde OS Girişinin etkin olmasını sağlar. Bu, IAM kullanarak örneklerinize SSH erişimini yönetmenizi sağlar ve ayrıca bireysel SSH anahtarları oluşturmanıza ve yönetmenize gerek kalmaz.

**Hizmet hesapları için ek güvenlik politikaları**

- **Otomatik IAM izinlerini devre dışı bırak**: App Engine ve Compute Engine hizmet hesaplarının varsayılan olarak bir projede Editör IAM rolünü otomatik olarak almalarını engeller. Bu, hizmet hesaplarının oluşturulduğunda aşırı derecede geniş izinli IAM rollerini almamalarını sağlar.
- **Hizmet hesabı anahtar oluşturmayı devre dışı bırak**: Genel hizmet hesabı anahtarlarının oluşturulmasını engeller. Bu, kalıcı kimlik bilgilerinin açığa çıkma riskini azaltmaya yardımcı olur.
- **Hizmet hesabı anahtar yükleme işlemini devre dışı bırak**: Genel hizmet hesabı anahtarlarının yüklenmesini engeller. Bu, sızdırılan veya yeniden kullanılan anahtar materyallerinin riskini azaltmaya yardımcı olur.

**Güvenli VPC ağı yapılandırma politikaları**

- **VM örnekleri için izin verilen harici IP'lerin tanımlanması**: Compute örneklerinin genel IP'ye sahip olmasını engeller, bu da onları internet trafiğine açık hale getirebilir.

<!---->

- **VM iç içe sanallaştırmasını devre dışı bırak**: Compute Engine VM'lerinde iç içe VM'lerin oluşturulmasını engeller. Bu, izlenmeyen iç içe VM'lerin güvenlik riskini azaltır.

<!---->

- **VM seri bağlantısını devre dışı bırak:** Compute Engine VM'lerine seri bağlantı erişimini engeller. Bu, Compute Engine API'sını kullanarak sunucunun seri bağlantısına girişi engeller.

<!---->

- **Cloud SQL örneklerinde yetkilendirilmiş ağları kısıtlama:** Genel veya iç ağ olmayan ağ aralıklarının Cloud SQL veritabanlarınıza erişmesini engeller.

<!---->

- **IP Adresi Türüne Göre Protokol Yönlendirmesini Kısıtlama:** Harici IP adresleri için VM protokol yönlendirmesini engeller.

<!---->

- **Cloud SQL örneklerinde Genel IP erişimini kısıtlama:** Genel IP'ye sahip Cloud SQL örneklerinin oluşturulmasını engeller, bu da onları internet trafiğine açık hale getirebilir.

<!---->

- **Paylaşılan VPC proje ipotek kaldırmasını kısıtlama:** Paylaşılan VPC ana projesinin yanlışlıkla silinmesini engeller.

<!---->

- **Yeni projeler için iç DNS ayarını Zonal DNS Only olarak ayarlama:** Hizmet kullanılabilirliğini azaltan eski bir DNS ayarının kullanılmasını engeller.

<!---->

- **Varsayılan ağ oluşturmayı atlamayı devre dışı bırak:** Varsayılan VPC ağının ve ilgili kaynakların otomatik oluşturulmasını engeller. Bu, aşırı derecede genişletilmiş varsayılan güvenlik duvarı kurallarını önler.

<!---->

- **VPC Harici IPv6 kullanımını devre dışı bırak:** Yetkisiz internet erişimine açık olabilen harici IPv6 alt ağlarının oluşturulmasını engeller.

</details>

## **IAM Rolleri**

Bu, **her rolün bir dizi izni içerdiği AWS'deki IAM politikalarına benzerdir**.

Ancak AWS'den farklı olarak, rollerin merkezi bir depo**su yoktur**. Bunun yerine, **kaynaklar X erişim rollerini Y prensiplere verir**, ve bir kaynağın kimlere erişim izni verdiğini öğrenmenin tek yolu, o kaynağın üzerinde **`get-iam-policy` yöntemini kullanmaktır**.\
Bu bir sorun olabilir çünkü bu, bir prensibin hangi izinlere sahip olduğunu öğrenmenin tek yolunun, izin verdiği tüm kaynaklardan izinleri almak olduğu anlamına gelir ve bir kullanıcının tüm kaynaklardan izinleri alacak yetkisi olmayabilir.

IAM'de **üç tür** rol vardır:

- **Temel/İlkel roller**, IAM'in tanıtılmasından önce var olan **Sahip**, **Editör** ve **Görüntüleyici** rollerini içerir.
- **Önceden tanımlanmış roller**, belirli bir hizmet için ayrıntılı erişim sağlar ve Google Cloud tarafından yönetilir. Birçok önceden tanımlanmış rol vardır, **onların tümünü ve sahip oldukları ayrıcalıkları** [**buradan**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles) görebilirsiniz.
- **Özel roller**, kullanıcı tarafından belirtilen bir izin listesine göre ayrıntılı erişim sağlar.

GCP'de binlerce izin bulunmaktadır. Bir rolün bir izne sahip olup olmadığını kontrol etmek için [**buradan izni arayabilirsiniz**](https://cloud.google.com/iam/docs/permissions-reference) ve hangi rollerin ona sahip olduğunu görebilirsiniz.

Ayrıca, **her ürün tarafından sunulan önceden tanımlanmış rolleri** [**buradan arayabilirsiniz**](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation). Bazı **rollerin** kullanıcılara **bağlanamayacağını ve yalnızca Hizmet Hesaplarına** bağlanabileceğini unutmayın çünkü içerdiği bazı izinler.\
Ayrıca, **izinlerin** yalnızca ilgili hizmete **bağlandığında** etkili olacağını unutmayın.

Veya bir **özel rolün** [**burada belirli bir izni kullanıp kullanamayacağını kontrol edebilirsiniz**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**.**

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}
## Kullanıcılar <a href="#default-credentials" id="default-credentials"></a>

**GCP konsolunda** **Kullanıcılar veya Gruplar** yönetimi yapılmaz, bu **Google Workspace**'de gerçekleştirilir. Ancak Google Workspace'de farklı bir kimlik sağlayıcı senkronize edebilirsiniz.

Workspace kullanıcıları ve gruplarına [**https://admin.google.com**](https://admin.google.com/) adresinden erişebilirsiniz.

**MFA**, Workspace kullanıcılarına **zorunlu** olabilir, ancak bir **saldırgan** MFA tarafından korunmayan GCP'ye erişmek için bir belirteç kullanabilir (kullanıcı belirteği oluşturmak için yalnızca oturum açtığında MFA tarafından korunur: `gcloud auth login`).

## Gruplar

Bir organizasyon oluşturulduğunda birkaç grubun **oluşturulması kesinlikle önerilir.** Bunlardan herhangi birini yönetiyorsanız, tüm organizasyonu veya önemli bir kısmını tehlikeye atabilirsiniz:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Grup</strong></td><td><strong>Fonksiyon</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(kontrol listesi için grup veya bireysel hesaplar gereklidir)</em></td><td>Organizasyona ait herhangi bir kaynağı yönetme. Bu rolü dikkatlice atayın; org yöneticileri tüm Google Cloud kaynaklarına erişebilir. Alternatif olarak, bu fonksiyon çok ayrıcalıklı olduğundan, bir grup oluşturmak yerine bireysel hesapları kullanmayı düşünebilirsiniz.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(kontrol listesi için gereklidir)</em></td><td>Ağlar, alt ağlar, güvenlik duvarı kuralları ve Cloud Router, Cloud VPN ve bulut yük dengeleyicileri gibi ağ cihazları oluşturma.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(kontrol listesi için gereklidir)</em></td><td>Faturalandırma hesaplarını kurma ve kullanımlarını izleme.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(kontrol listesi için gereklidir)</em></td><td>Uygulamaları tasarlama, kodlama ve test etme.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Tüm organizasyon için güvenlik politikalarını oluşturma ve yönetme, erişim yönetimi ve <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">organizasyon kısıtlama politikaları</a> gibi. Google Cloud güvenlik altyapınızı planlarken daha fazla bilgi için <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">Google Cloud güvenlik temelleri kılavuzuna</a> bakın.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Sürekli entegrasyon ve dağıtımı destekleyen uçtan uca boru hatları oluşturma veya yönetme, izleme ve sistem sağlama.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(artık varsayılan değil)</em></td><td>Projelerde harcamaları izleme. Tipik üyeler finans ekibinin bir parçasıdır.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(artık varsayılan değil)</em></td><td>Google Cloud organizasyonu genelinde kaynak bilgilerini inceleme.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(artık varsayılan değil)</em></td><td>Bulut güvenliğini inceleme.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(artık varsayılan değil)</em></td><td>Ağ yapılandırmalarını inceleme.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(artık varsayılan değil)</em></td><td>Denetim günlüklerini görüntüleme.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(artık varsayılan değil)</em></td><td>Güvenlik Komut Merkezi'ni yönetme.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(artık varsayılan değil)</em></td><td>Secret Manager'da sırları yönetme.</td></tr></tbody></table>

## **Varsayılan Şifre Politikası**

* Güçlü şifreleri zorunlu kılma
* 8 ile 100 karakter arası
* Tekrar kullanımı yok
* Süresizlik yok
* İnsanlar üçüncü taraf sağlayıcı aracılığıyla Workspace'e erişiyorsa, bu gereksinimler uygulanmaz.

<figure><img src="../../../.gitbook/assets/image (20).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (22).png" alt=""><figcaption></figcaption></figure>

## **Hizmet hesapları**

Bunlar, **kaynakların** **bağlı olabileceği** ve GCP ile kolayca etkileşimde bulunabileceği temsilcilerdir. Örneğin, bir Hizmet Hesabının **VM'ye bağlı** kimlik doğrulama belirteğine erişmek mümkündür.\
IAM ve erişim kapsamlarını birlikte kullanırken bazı **çakışmalarla** karşılaşabilirsiniz. Örneğin, hizmet hesabınızın `compute.instanceAdmin` IAM rolüne sahip olabilir ancak ele geçirdiğiniz örneğin `https://www.googleapis.com/auth/compute.readonly` kapsam kısıtlaması ile sakatlanmış olabilir. Bu durum, örneğinize otomatik olarak atanan OAuth belirteci kullanarak herhangi bir değişiklik yapmanızı engeller.

Bu, **AWS'den IAM rollerine** benzer. Ancak AWS'den farklı olarak, **herhangi bir** hizmet hesabı **herhangi bir hizmete bağlanabilir** (bunu bir politika aracılığıyla izin vermesine gerek yoktur).

Karşılaşacağınız hizmet hesaplarının bir kısmı aslında GCP'yi kullanmaya başladığınızda **otomatik olarak oluşturulur**, örneğin:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Ancak, kaynaklara **özel hizmet hesapları** oluşturmak ve bunlara bağlamak da mümkündür, bu da şöyle görünecektir:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Erişim kapsamları**

Erişim kapsamları, GCP API uç noktalarına erişmek için oluşturulan OAuth belgelerine **eklenir**. Bunlar OAuth belgesinin **izinlerini kısıtlar**.\
Bu, bir belgenin bir kaynağın Sahibi olmasına rağmen, belgeye o kaynağa erişim izni verilmediyse, belge **o ayrıcalıkları (kötüye) kullanmak için kullanılamaz**.

Google aslında [**erişim kapsamlarının kullanılmamasını ve tamamen IAM'a güvenilmesini**](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) **tavsiye eder**. Web yönetim portalı aslında bunu zorunlu kılar, ancak erişim kapsamları özel hizmet hesapları kullanılarak programatik olarak uygulanabilir.

**Hangi kapsamların atandığını görmek için sorgulayarak görebilirsiniz:**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Önceki **kapsamlar** varsayılan olarak **`gcloud`** kullanılarak veriye erişmek için oluşturulanlardır. Bu, **`gcloud`** kullandığınızda önce bir OAuth belirteci oluşturmanız ve ardından uç noktalara erişmek için kullanmanız gerektiği anlamına gelir.

Bu kapsamlar arasında en önemlisi muhtemelen **`cloud-platform`**'dur, bu da temelde **GCP'deki herhangi bir hizmete erişilebileceği** anlamına gelir.

[**Burada tüm olası kapsamların bir listesini bulabilirsiniz**](https://developers.google.com/identity/protocols/googlescopes)**.**

Eğer **`gcloud`** tarayıcı kimlik bilgilerine sahipseniz, başka kapsamlarla bir belirteç almak mümkündür, şöyle bir şey yaparak:
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
## **Terraform IAM Politikaları, Bağlantılar ve Üyelikler**

Terraform tarafından [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam) tanımlandığı gibi GCP ile terraform kullanarak bir ilkeye erişim sağlamanın farklı yolları vardır:

* **Üyelikler**: **İlkelere kısıtlama olmaksızın rollerin üyeleri olarak ilkelere** **üyeler olarak ayarlarsınız**. Bir kullanıcıyı bir rolün üyesi olarak ayarlayabilir ve ardından aynı rolün bir üyesi olarak bir grup ekleyebilir ve bu ilkelere (kullanıcı ve grup) diğer rollerin üyeleri olarak ayarlayabilirsiniz.
* **Bağlantılar**: Bir role **çeşitli ilkelere bağlanabilir**. Bu **ilkelere hala bağlanabilir veya diğer rollerin üyeleri olabilirler**. Ancak, bir role bağlı olmayan bir ilke, bir bağlı role **üye olarak ayarlandığında, bir sonraki** **bağlantı uygulandığında, üyelik kaybolacaktır**.
* **Politikalar**: Bir politika **yetkilidir**, rolleri ve ilkelere gösterir ve sonra, **bu ilkelere daha fazla rol ve bu rollerin daha fazla ilkesi olamaz** **bu politika değiştirilene kadar (bağlı politikalar, bağlantılar veya üyeliklerde bile). Dolayısıyla, bir rol veya ilke politikada belirtildiğinde, tüm ayrıcalıkları **o politika tarafından sınırlanır**. Açıkçası, bu, ilkelere politikayı değiştirme veya ayrıcalık yükseltme izinleri verildiğinde atlanabilir (yeni bir ilke oluşturmak ve ona yeni bir rol bağlamak gibi).

## Referanslar

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)
