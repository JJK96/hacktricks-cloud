# GCP - Informaci칩n B치sica

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## **Jerarqu칤a de recursos**

Google Cloud utiliza una [Jerarqu칤a de recursos](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) que es similar, conceptualmente, a la de un sistema de archivos tradicional. Esto proporciona un flujo de trabajo l칩gico de padre/hijo con puntos de uni칩n espec칤ficos para pol칤ticas y permisos.

A un alto nivel, se ve as칤:
```
Organization
--> Folders
--> Projects
--> Resources
```
Una m치quina virtual (llamada Compute Instance) es un recurso. Un recurso reside en un proyecto, probablemente junto a otras Compute Instances, buckets de almacenamiento, etc.

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption><p><a href="https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg">https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg</a></p></figcaption></figure>

## **Migraci칩n de Proyectos**

Es posible **migrar un proyecto sin ninguna organizaci칩n** a una organizaci칩n con los permisos `roles/resourcemanager.projectCreator` y `roles/resourcemanager.projectMover`. Si el proyecto est치 dentro de otra organizaci칩n, es necesario contactar con el soporte de GCP para **sacarlos de la organizaci칩n primero**. Para m치s informaci칩n, consulta [**esto**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Pol칤ticas de Organizaci칩n**

Permiten centralizar el control sobre los recursos en la nube de tu organizaci칩n:

* Centralizar el control para **configurar restricciones** sobre c칩mo pueden usarse los recursos de tu organizaci칩n.
* Definir y establecer **l칤mites** para que tus equipos de desarrollo se mantengan dentro de los l칤mites de cumplimiento.
* Ayudar a los propietarios de proyectos y sus equipos a moverse r치pidamente sin preocuparse por romper el cumplimiento.

Estas pol칤ticas pueden crearse para **afectar a toda la organizaci칩n, carpeta(s) o proyecto(s)**. Los descendientes del nodo de jerarqu칤a de recursos objetivo **heredan la pol칤tica de la organizaci칩n**.

Para **definir** una pol칤tica de organizaci칩n, **eliges una** [**restricci칩n**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), que es un tipo particular de restricci칩n contra un servicio de Google Cloud o un grupo de servicios de Google Cloud. **Configuras esa restricci칩n con las restricciones deseadas**.

<figure><img src="../../../.gitbook/assets/image (217).png" alt=""><figcaption><p><a href="https://cloud.google.com/resource-manager/img/org-policy-concepts.svg">https://cloud.google.com/resource-manager/img/org-policy-concepts.svg</a></p></figcaption></figure>

#### Casos de uso comunes <a href="#common_use_cases" id="common_use_cases"></a>

* Limitar el intercambio de recursos basado en el dominio.
* Limitar el uso de cuentas de servicio de Identity and Access Management.
* Restringir la ubicaci칩n f칤sica de los recursos reci칠n creados.
* Deshabilitar la creaci칩n de cuentas de servicio.

<figure><img src="../../../.gitbook/assets/image (172).png" alt=""><figcaption></figcaption></figure>

Hay muchas m치s restricciones que te dan un control detallado de los recursos de tu organizaci칩n. Para **m치s informaci칩n, consulta la** [**lista de todas las restricciones del Servicio de Pol칤ticas de Organizaci칩n**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

### **Pol칤ticas de Organizaci칩n Predeterminadas**

<details>

<summary>Estas son las pol칤ticas que Google a침adir치 por defecto al configurar tu organizaci칩n en GCP:</summary>

**Pol칤ticas de Gesti칩n de Acceso**

* **Contactos restringidos por dominio:** Evita agregar usuarios a Contactos Esenciales fuera de tus dominios especificados. Esto limita los Contactos Esenciales a permitir solo identidades de usuario gestionadas en tus dominios seleccionados para recibir notificaciones de la plataforma.
* **Intercambio restringido por dominio:** Evita agregar usuarios a pol칤ticas de IAM fuera de tus dominios especificados. Esto limita las pol칤ticas de IAM a permitir solo identidades de usuario gestionadas en tus dominios seleccionados para acceder a recursos dentro de esta organizaci칩n.
* **Prevenci칩n de acceso p칰blico:** Evita que los buckets de Cloud Storage se expongan al p칰blico. Esto asegura que un desarrollador no pueda configurar los buckets de Cloud Storage para tener acceso no autenticado a internet.
* **Acceso uniforme a nivel de bucket:** Evita las listas de control de acceso (ACL) a nivel de objeto en los buckets de Cloud Storage. Esto simplifica tu gesti칩n de acceso aplicando pol칤ticas de IAM de manera consistente en todos los objetos en los buckets de Cloud Storage.
* **Requerir inicio de sesi칩n en el SO:** Las VMs creadas en nuevos proyectos tendr치n habilitado el inicio de sesi칩n en el SO. Esto te permite gestionar el acceso SSH a tus instancias usando IAM sin necesidad de crear y gestionar claves SSH individuales.

**Pol칤ticas de seguridad adicionales para cuentas de servicio**

* **Deshabilitar concesiones autom치ticas de IAM**: Evita que las cuentas de servicio predeterminadas de App Engine y Compute Engine reciban autom치ticamente el rol de Editor de IAM en un proyecto al crearse. Esto asegura que las cuentas de servicio no reciban roles de IAM excesivamente permisivos al crearse.
* **Deshabilitar la creaci칩n de claves de cuentas de servicio**: Evita la creaci칩n de claves p칰blicas de cuentas de servicio. Esto ayuda a reducir el riesgo de exponer credenciales persistentes.
* **Deshabilitar la carga de claves de cuentas de servicio**: Evita la carga de claves p칰blicas de cuentas de servicio. Esto ayuda a reducir el riesgo de material de clave filtrado o reutilizado.

**Pol칤ticas de configuraci칩n segura de red VPC**

* **Definir IPs externas permitidas para instancias de VM**: Evita la creaci칩n de instancias de Compute con una IP p칰blica, lo que puede exponerlas al tr치fico de internet.

<!---->

* **Deshabilitar la virtualizaci칩n anidada de VM**: Evita la creaci칩n de VMs anidadas en VMs de Compute Engine. Esto disminuye el riesgo de seguridad de tener VMs anidadas no monitoreadas.

<!---->

* **Deshabilitar el puerto serial de VM:** Evita el acceso al puerto serial de las VMs de Compute Engine. Esto previene la entrada al puerto serial de un servidor usando la API de Compute Engine.

<!---->

* **Restringir redes autorizadas en instancias de Cloud SQL:** Evita que rangos de red p칰blicos o no internos accedan a tus bases de datos de Cloud SQL.

<!---->

* **Restringir el reenv칤o de protocolos basado en el tipo de direcci칩n IP:** Evita el reenv칤o de protocolos de VM para direcciones IP externas.

<!---->

* **Restringir el acceso a IP p칰blica en instancias de Cloud SQL:** Evita la creaci칩n de instancias de Cloud SQL con una IP p칰blica, lo que puede exponerlas al tr치fico de internet.

<!---->

* **Restringir la eliminaci칩n de grav치menes de proyectos de VPC compartida:** Evita la eliminaci칩n accidental de proyectos host de VPC compartida.

<!---->

* **Establece la configuraci칩n de DNS interna para nuevos proyectos a solo DNS zonal:** Evita el uso de una configuraci칩n de DNS heredada que tiene una disponibilidad de servicio reducida.

<!---->

* **Omitir la creaci칩n de red predeterminada:** Evita la creaci칩n autom치tica de la red VPC predeterminada y recursos relacionados. Esto evita reglas de firewall predeterminadas excesivamente permisivas.

<!---->

* **Deshabilitar el uso de IPv6 externo en VPC:** Evita la creaci칩n de subredes IPv6 externas, que pueden estar expuestas a acceso no autorizado a internet.

</details>

## **Roles de IAM**

Estos son como las pol칤ticas de IAM en AWS ya que **cada rol contiene un conjunto de permisos.**

Sin embargo, a diferencia de AWS, no hay **un repositorio centralizado** de roles. En lugar de eso, **los recursos dan X roles de acceso a Y principales**, y la 칰nica manera de averiguar qui칠n tiene acceso a un recurso es usar el **m칠todo `get-iam-policy` sobre ese recurso**.\
Esto podr칤a ser un problema porque esto significa que la 칰nica manera de averiguar **qu칠 permisos tiene un principal es preguntar a cada recurso a qui칠n est치 dando permisos**, y un usuario podr칤a no tener permisos para obtener permisos de todos los recursos.

Hay **tres tipos** de roles en IAM:

* **Roles b치sicos/primarios**, que incluyen los roles de **Owner**, **Editor** y **Viewer** que exist칤an antes de la introducci칩n de IAM.
* **Roles predefinidos**, que proporcionan acceso granular para un servicio espec칤fico y son gestionados por Google Cloud. Hay muchos roles predefinidos, puedes **ver todos ellos con los privilegios que tienen** [**aqu칤**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles).
* **Roles personalizados**, que proporcionan acceso granular seg칰n una lista de permisos especificada por el usuario.

Hay miles de permisos en GCP. Para verificar si un rol tiene un permiso puedes [**buscar el permiso aqu칤**](https://cloud.google.com/iam/docs/permissions-reference) y ver qu칠 roles lo tienen.

Tambi칠n puedes [**buscar aqu칤 roles predefinidos**](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation) **ofrecidos por cada producto.** Ten en cuenta que algunos **roles** no pueden ser adjuntados a usuarios y **solo a SAs debido a algunos permisos** que contienen.\
Adem치s, ten en cuenta que **los permisos** solo **tendr치n efecto** si est치n **adjuntos al servicio relevante.**

O verifica si un **rol personalizado puede usar un** [**permiso espec칤fico aqu칤**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**.**

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## Usuarios <a href="#default-credentials" id="default-credentials"></a>

En **GCP console** no hay **gesti칩n de Usuarios o Grupos**, eso se hace en **Google Workspace**. Aunque podr칤as sincronizar un proveedor de identidad diferente en Google Workspace.

Puedes acceder a los usuarios y grupos de Workspaces en [**https://admin.google.com**](https://admin.google.com/).

**MFA** puede ser **forzado** a los usuarios de Workspaces, sin embargo, un **atacante** podr칤a usar un token para acceder a GCP **a trav칠s de cli que no estar치 protegido por MFA** (estar치 protegido por MFA solo cuando el usuario inicie sesi칩n para generarlo: `gcloud auth login`).

## Grupos

Cuando se crea una organizaci칩n, se **sugiere fuertemente crear varios grupos.** Si gestionas alguno de ellos, podr칤as haber comprometido toda o una parte importante de la organizaci칩n:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Grupo</strong></td><td><strong>Funci칩n</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(grupo o cuentas individuales requeridas para la lista de verificaci칩n)</em></td><td>Administrar cualquier recurso que pertenezca a la organizaci칩n. Asigna este rol con moderaci칩n; los administradores de la organizaci칩n tienen acceso a todos tus recursos de Google Cloud. Alternativamente, debido a que esta funci칩n es altamente privilegiada, considera usar cuentas individuales en lugar de crear un grupo.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(requerido para la lista de verificaci칩n)</em></td><td>Crear redes, subredes, reglas de firewall y dispositivos de red como Cloud Router, Cloud VPN y balanceadores de carga en la nube.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(requerido para la lista de verificaci칩n)</em></td><td>Configurar cuentas de facturaci칩n y monitorear su uso.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(requerido para la lista de verificaci칩n)</em></td><td>Dise침ar, codificar y probar aplicaciones.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Establecer y gestionar pol칤ticas de seguridad para toda la organizaci칩n, incluyendo la gesti칩n de acceso y <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">pol칤ticas de restricciones de la organizaci칩n</a>. Consulta la <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">gu칤a de fundamentos de seguridad de Google Cloud</a> para m치s informaci칩n sobre la planificaci칩n de tu infraestructura de seguridad en Google Cloud.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Crear o gestionar pipelines de extremo a extremo que soporten la integraci칩n y entrega continua, monitoreo y aprovisionamiento del sistema.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(ya no por defecto)</em></td><td>Monitorear el gasto en proyectos. Los miembros t칤picos son parte del equipo de finanzas.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(ya no por defecto)</em></td><td>Revisar la informaci칩n de recursos en toda la organizaci칩n de Google Cloud.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(ya no por defecto)</em></td><td>Revisar la seguridad en la nube.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(ya no por defecto)</em></td><td>Revisar configuraciones de red.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(ya no por defecto)</em></td><td>Ver logs de auditor칤a.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(ya no por defecto)</em></td><td>Administrar Security Command Center.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(ya no por defecto)</em></td><td>Gestionar secretos en Secret Manager.</td></tr></tbody></table>

## **Pol칤tica de Contrase침as Predeterminada**

* Hacer cumplir contrase침as fuertes
* Entre 8 y 100 caracteres
* No reutilizaci칩n
* Sin expiraci칩n
* Si las personas acceden a Workspace a trav칠s de un proveedor externo, estos requisitos no se aplican.

<figure><img src="../../../.gitbook/assets/image (20).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (22).png" alt=""><figcaption></figcaption></figure>

## **Cuentas de servicio**

Estos son los principales que **los recursos** pueden **tener** **adjuntos** y acceso para interactuar f치cilmente con GCP. Por ejemplo, es posible acceder al **token de autenticaci칩n** de una cuenta de servicio **adjunta a una VM** en los metadatos.\
Es posible encontrar algunos **conflictos** al usar tanto **IAM como alcances de acceso**. Por ejemplo, tu cuenta de servicio puede tener el rol de IAM de `compute.instanceAdmin` pero la instancia que has comprometido ha sido limitada con el alcance de `https://www.googleapis.com/auth/compute.readonly`. Esto te impedir칤a hacer cambios usando el token OAuth que se asigna autom치ticamente a tu instancia.

Es similar a **los roles de IAM de AWS**. Pero a diferencia de AWS, **cualquier** cuenta de servicio puede ser **adjunta a cualquier servicio** (no necesita permitirlo a trav칠s de una pol칤tica).

Varias de las cuentas de servicio que encontrar치s son en realidad **generadas autom치ticamente por GCP** cuando comienzas a usar un servicio, como:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Sin embargo, tambi칠n es posible crear y adjuntar a recursos **custom service accounts**, que se ver치n as칤:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Access scopes**

Los alcances de acceso est치n **adjuntos a los tokens OAuth generados** para acceder a los endpoints de la API de GCP. **Restringen los permisos** del token OAuth.\
Esto significa que si un token pertenece a un Propietario de un recurso pero no tiene en el alcance del token para acceder a ese recurso, el token **no puede ser usado para (ab)usar esos privilegios**.

Google en realidad [recomienda](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) que **no se usen los alcances de acceso y se conf칤e totalmente en IAM**. El portal de gesti칩n web en realidad refuerza esto, pero los alcances de acceso a칰n pueden aplicarse a instancias usando cuentas de servicio personalizadas program치ticamente.

Puedes ver qu칠 **alcances** est치n **asignados** **consultando:**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Los **alcances** anteriores son los generados por **defecto** usando **`gcloud`** para acceder a datos. Esto se debe a que cuando usas **`gcloud`** primero creas un token OAuth y luego lo usas para contactar los endpoints.

El alcance m치s importante de esos potencialmente es **`cloud-platform`**, que b치sicamente significa que es posible **acceder a cualquier servicio en GCP**.

Puedes **encontrar una lista de** [**todos los posibles alcances aqu칤**](https://developers.google.com/identity/protocols/googlescopes)**.**

Si tienes credenciales de navegador de **`gcloud`**, es posible **obtener un token con otros alcances,** haciendo algo como:

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform IAM Policies, Bindings and Memberships**

Como se define en terraform en [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam) usando terraform con GCP hay diferentes maneras de otorgar acceso a un principal sobre un recurso:

* **Memberships**: Se establecen **principals como miembros de roles** **sin restricciones** sobre el rol o los principals. Puedes poner a un usuario como miembro de un rol y luego poner a un grupo como miembro del mismo rol y tambi칠n establecer esos principals (usuario y grupo) como miembros de otros roles.
* **Bindings**: Varios **principals pueden ser vinculados a un rol**. Esos **principals a칰n pueden ser vinculados o ser miembros de otros roles**. Sin embargo, si un principal que no est치 vinculado al rol se establece como **miembro de un rol vinculado**, la pr칩xima vez que se **aplique la vinculaci칩n, la membres칤a desaparecer치**.
* **Policies**: Una pol칤tica es **autoritativa**, indica roles y principals y luego, **esos principals no pueden tener m치s roles y esos roles no pueden tener m치s principals** a menos que esa pol칤tica sea modificada (ni siquiera en otras pol칤ticas, bindings o memberships). Por lo tanto, cuando un rol o principal se especifica en una pol칤tica, todos sus privilegios est치n **limitados por esa pol칤tica**. Obviamente, esto se puede eludir en caso de que al principal se le d칠 la opci칩n de modificar la pol칤tica o permisos de escalaci칩n de privilegios (como crear un nuevo principal y vincularle un nuevo rol).

## Referencias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
