# GCP - Basic Information

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **PRを提出してハッキングトリックを共有する** [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリに。

</details>
{% endhint %}

## **リソース階層**

Google Cloudは、従来のファイルシステムの概念に似た[リソース階層](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)を使用します。これにより、ポリシーと権限の特定のアタッチメントポイントを持つ論理的な親/子のワークフローが提供されます。

高レベルでは、次のようになります:
```
Organization
--> Folders
--> Projects
--> Resources
```
仮想マシン（Compute Instanceと呼ばれる）はリソースです。リソースはプロジェクト内に存在し、他のCompute Instanceやストレージバケットなどと一緒に存在する可能性があります。

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption><p><a href="https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg">https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg</a></p></figcaption></figure>

## **Projects Migration**

プロジェクトを**組織なしで**組織に移行することが可能です。このためには`roles/resourcemanager.projectCreator`と`roles/resourcemanager.projectMover`の権限が必要です。プロジェクトが他の組織内にある場合、**最初にその組織から移動するためにGCPサポートに連絡する必要があります**。詳細は[**こちら**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6)を参照してください。

## **Organization Policies**

組織のクラウドリソースに対する集中管理を可能にします：

* 組織のリソースの使用方法に**制限を設定**するための集中管理。
* 開発チームがコンプライアンスの範囲内で作業するための**ガードレール**を定義および確立。
* プロジェクトオーナーとそのチームがコンプライアンスを破る心配なく迅速に動けるよう支援。

これらのポリシーは**組織全体、フォルダ、またはプロジェクトに影響を与える**ように作成できます。ターゲットリソース階層ノードの子孫は**組織ポリシーを継承**します。

組織ポリシーを**定義**するには、[**制約**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints)を選択します。これは、Google CloudサービスまたはGoogle Cloudサービスのグループに対する特定の種類の制限です。**その制約を希望する制限で設定**します。

<figure><img src="../../../.gitbook/assets/image (217).png" alt=""><figcaption><p><a href="https://cloud.google.com/resource-manager/img/org-policy-concepts.svg">https://cloud.google.com/resource-manager/img/org-policy-concepts.svg</a></p></figcaption></figure>

#### Common use cases <a href="#common_use_cases" id="common_use_cases"></a>

* ドメインに基づくリソース共有の制限。
* Identity and Access Managementサービスアカウントの使用制限。
* 新しく作成されたリソースの物理的な場所の制限。
* サービスアカウントの作成を無効化。

<figure><img src="../../../.gitbook/assets/image (172).png" alt=""><figcaption></figcaption></figure>

組織のリソースを細かく制御するための多くの制約があります。詳細については、[**すべてのOrganization Policy Service制約のリスト**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)を参照してください。

### **Default Organization Policies**

<details>

<summary>GCP組織を設定する際にGoogleがデフォルトで追加するポリシーは次のとおりです：</summary>

**Access Management Policies**

* **Domain restricted contacts:** 指定されたドメイン外のユーザーをEssential Contactsに追加することを防ぎます。これにより、Essential Contactsは選択したドメイン内の管理されたユーザーIDのみがプラットフォーム通知を受け取ることができます。
* **Domain restricted sharing:** 指定されたドメイン外のユーザーをIAMポリシーに追加することを防ぎます。これにより、IAMポリシーは選択したドメイン内の管理されたユーザーIDのみがこの組織内のリソースにアクセスできるように制限されます。
* **Public access prevention:** Cloud Storageバケットが公開されるのを防ぎます。これにより、開発者がCloud Storageバケットに認証されていないインターネットアクセスを設定することを防ぎます。
* **Uniform bucket level access:** Cloud Storageバケットのオブジェクトレベルのアクセス制御リスト（ACL）を防ぎます。これにより、IAMポリシーをCloud Storageバケット内のすべてのオブジェクトに一貫して適用することでアクセス管理が簡素化されます。
* **Require OS login:** 新しいプロジェクトで作成されたVMにはOS Loginが有効になります。これにより、個別のSSHキーを作成および管理することなく、IAMを使用してインスタンスへのSSHアクセスを管理できます。

**Additional security policies for service accounts**

* **Disable automatic IAM grants**: デフォルトのApp EngineおよびCompute Engineサービスアカウントがプロジェクト作成時に自動的にEditor IAMロールを付与されるのを防ぎます。これにより、サービスアカウントが作成時に過度に許可されたIAMロールを受け取ることを防ぎます。
* **Disable service account key creation**: 公開サービスアカウントキーの作成を防ぎます。これにより、永続的な資格情報が漏洩するリスクを減らします。
* **Disable service account key upload**: 公開サービスアカウントキーのアップロードを防ぎます。これにより、漏洩または再利用されたキー素材のリスクを減らします。

**Secure VPC network configuration policies**

* **Define allowed external IPs for VM instances**: 公開IPを持つComputeインスタンスの作成を防ぎます。これにより、インターネットトラフィックにさらされるのを防ぎます。

<!---->

* **Disable VM nested virtualization**: Compute Engine VM上でのネストされたVMの作成を防ぎます。これにより、監視されていないネストされたVMのセキュリティリスクが減少します。

<!---->

* **Disable VM serial port:** Compute Engine VMへのシリアルポートアクセスを防ぎます。これにより、Compute Engine APIを使用してサーバーのシリアルポートに入力することを防ぎます。

<!---->

* **Restrict authorized networks on Cloud SQL instances:** 公開または内部ネットワーク範囲外からのCloud SQLデータベースへのアクセスを防ぎます。

<!---->

* **Restrict Protocol Forwarding Based on type of IP Address:** 外部IPアドレスに対するVMプロトコル転送を防ぎます。

<!---->

* **Restrict Public IP access on Cloud SQL instances:** 公開IPを持つCloud SQLインスタンスの作成を防ぎます。これにより、インターネットトラフィックにさらされるのを防ぎます。

<!---->

* **Restrict shared VPC project lien removal:** Shared VPCホストプロジェクトの誤って削除されるのを防ぎます。

<!---->

* **Sets the internal DNS setting for new projects to Zonal DNS Only:** サービスの可用性が低下するレガシーDNS設定の使用を防ぎます。

<!---->

* **Skip default network creation:** デフォルトのVPCネットワークおよび関連リソースの自動作成を防ぎます。これにより、過度に許可されたデフォルトのファイアウォールルールを回避します。

<!---->

* **Disable VPC External IPv6 usage:** 外部IPv6サブネットの作成を防ぎます。これにより、未承認のインターネットアクセスにさらされるのを防ぎます。

</details>

## **IAM Roles**

これらはAWSのIAMポリシーのようなもので、**各ロールには一連の権限が含まれています。**

しかし、AWSとは異なり、**ロールの集中リポジトリはありません**。その代わりに、**リソースがYのプリンシパルにXのアクセスロールを与える**形式です。リソースに誰がアクセスできるかを知る唯一の方法は、そのリソースに対して**`get-iam-policy`メソッドを使用すること**です。\
これは問題になる可能性があります。なぜなら、**プリンシパルがどの権限を持っているかを知る唯一の方法は、すべてのリソースに誰に権限を与えているかを尋ねること**であり、ユーザーはすべてのリソースから権限を取得する権限を持っていないかもしれないからです。

IAMには**3種類**のロールがあります：

* **Basic/Primitive roles**：これは**Owner**、**Editor**、および**Viewer**ロールを含み、IAMの導入前から存在していました。
* **Predefined roles**：特定のサービスに対して細かいアクセスを提供し、Google Cloudによって管理されます。多くの定義済みロールがあり、**それらのすべてとその権限を**[**こちら**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles)で確認できます。
* **Custom roles**：ユーザーが指定した権限リストに従って細かいアクセスを提供します。

GCPには数千の権限があります。ロールが権限を持っているかどうかを確認するには、[**こちらで権限を検索**](https://cloud.google.com/iam/docs/permissions-reference)し、どのロールがそれを持っているかを確認できます。

また、[**こちらで定義済みロール**](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation)を**各製品が提供するものを検索**できます。いくつかの**ロール**はユーザーにアタッチできず、**一部の権限のためにSAsにのみアタッチできる**ことに注意してください。\
さらに、**権限**は**関連するサービスにアタッチされている場合にのみ**効果を発揮することに注意してください。

また、**カスタムロールが特定の権限を使用できるかどうかを**[**こちら**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)で確認できます。

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## Users <a href="#default-credentials" id="default-credentials"></a>

**GCPコンソール**には**ユーザーやグループの管理はありません**。それは**Google Workspace**で行われます。ただし、Google Workspaceで異なるアイデンティティプロバイダーを同期することは可能です。

Workspacesの**ユーザーとグループにアクセスするには**[**https://admin.google.com**](https://admin.google.com/)を使用します。

**MFA**はWorkspacesユーザーに**強制**することができますが、**攻撃者**はGCPに**cli経由でアクセスするためのトークンを使用することができ、これはMFAで保護されません**（ユーザーがログインして生成する際にのみMFAで保護されます：`gcloud auth login`）。

## Groups

組織が作成されると、いくつかのグループが**強く推奨されます**。これらのいずれかを管理している場合、組織全体または重要な部分を危険にさらす可能性があります：

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Group</strong></td><td><strong>Function</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(group or individual accounts required for checklist)</em></td><td>組織に属する任意のリソースを管理します。このロールは慎重に割り当ててください。組織管理者はすべてのGoogle Cloudリソースにアクセスできます。代わりに、この機能は非常に特権が高いため、グループを作成する代わりに個別のアカウントを使用することを検討してください。</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(required for checklist)</em></td><td>ネットワーク、サブネット、ファイアウォールルール、およびCloud Router、Cloud VPN、クラウドロードバランサーなどのネットワークデバイスの作成。</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(required for checklist)</em></td><td>請求アカウントの設定と使用状況の監視。</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(required for checklist)</em></td><td>アプリケーションの設計、コーディング、およびテスト。</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>アクセス管理や<a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">組織制約ポリシー</a>を含む、組織全体のセキュリティポリシーの確立と管理。Google Cloudセキュリティ基盤ガイドについては、<a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">こちら</a>を参照してください。</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>継続的インテグレーションとデリバリー、監視、およびシステムプロビジョニングをサポートするエンドツーエンドのパイプラインの作成または管理。</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(no longer by default)</em></td><td>プロジェクトの支出の監視。典型的なメンバーは財務チームの一員です。</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(no longer by default)</em></td><td>Google Cloud組織全体のリソース情報のレビュー。</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(no longer by default)</em></td><td>クラウドセキュリティのレビュー。</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(no longer by default)</em></td><td>ネットワーク構成のレビュー。</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(no longer by default)</em></td><td>監査ログの表示。</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(no longer by default)</em></td><td>Security Command Centerの管理。</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(no longer by default)</em></td><td>Secret Managerでのシークレットの管理。</td></tr></tbody></table>

## **Default Password Policy**

* 強力なパスワードを強制
* 8〜100文字
* 再利用不可
* 有効期限なし
* Workspaceにサードパーティプロバイダーを通じてアクセスしている場合、これらの要件は適用されません。

<figure><img src="../../../.gitbook/assets/image (20).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (22).png" alt=""><figcaption></figcaption></figure>

## **Service accounts**

これらは**リソース**が**アタッチ**され、GCPと簡単にやり取りするためにアクセスできるプリンシパルです。例えば、VMにアタッチされたService Accountの**認証トークン**にメタデータでアクセスすることが可能です。\
**IAMとアクセススコープ**の両方を使用する際に**競合**が発生することがあります。例えば、サービスアカウントが`compute.instanceAdmin`のIAMロールを持っているが、侵入したインスタンスが`https://www.googleapis.com/auth/compute.readonly`のスコープ制限で制限されている場合です。これにより、インスタンスに自動的に割り当てられた
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
しかし、リソースに**カスタムサービスアカウント**を作成してアタッチすることも可能であり、次のようになります:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Access scopes**

Access scopeは、GCP APIエンドポイントにアクセスするために生成されたOAuthトークンに**付与されます**。これにより、OAuthトークンの**権限が制限**されます。\
つまり、トークンがリソースのオーナーに属していても、そのリソースにアクセスするためのスコープがトークンに含まれていない場合、そのトークンは**その権限を（悪用）するために使用することはできません**。

Googleは実際に、**アクセススコープを使用せず、完全にIAMに依存することを[推奨](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions)しています**。ウェブ管理ポータルは実際にこれを強制していますが、カスタムサービスアカウントをプログラムで使用することで、インスタンスにアクセススコープを適用することはまだ可能です。

**スコープ**が**割り当てられているか**を**確認する**には、**クエリを実行**します:

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

以前の**スコープ**は、データにアクセスするために**`gcloud`**を使用して**デフォルト**で生成されるものです。これは、**`gcloud`**を使用すると、最初にOAuthトークンを作成し、それを使用してエンドポイントに接続するためです。

これらの中で最も重要なスコープは**`cloud-platform`**で、基本的に**GCPの任意のサービスにアクセス可能**であることを意味します。

[**すべての可能なスコープのリストはこちら**](https://developers.google.com/identity/protocols/googlescopes)で**確認できます**。

**`gcloud`**のブラウザ資格情報がある場合、他のスコープで**トークンを取得することが可能**で、次のように行います:

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform IAM Policies, Bindings and Memberships**

Terraformによって定義されているように、[https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam)を使用してGCPでプリンシパルにリソースへのアクセスを付与する方法にはいくつかの方法があります：

* **Memberships**: **役割のメンバーとしてプリンシパルを設定**します。役割やプリンシパルに制限はありません。ユーザーを役割のメンバーとして設定し、同じ役割のメンバーとしてグループを設定し、さらに他の役割のメンバーとしてこれらのプリンシパル（ユーザーとグループ）を設定することができます。
* **Bindings**: 複数の**プリンシパルを役割にバインド**できます。これらの**プリンシパルは他の役割にバインドされたり、メンバーになったりすることができます**。しかし、バインドされていないプリンシパルが**バインドされた役割のメンバーとして設定されている場合**、次回バインディングが適用されると**メンバーシップは消えます**。
* **Policies**: ポリシーは**権威的**であり、役割とプリンシパルを示し、その後、**これらのプリンシパルは他の役割を持つことができず、これらの役割は他のプリンシパルを持つことができません**（他のポリシー、バインディング、メンバーシップでも同様）。したがって、ポリシーで役割やプリンシパルが指定されると、そのすべての特権は**そのポリシーによって制限されます**。もちろん、プリンシパルがポリシーを変更するオプションや特権昇格の権限を与えられている場合は、この制限を回避できます（新しいプリンシパルを作成し、新しい役割をバインドするなど）。

## References

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローしてください。
* **ハッキングトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
{% endhint %}
