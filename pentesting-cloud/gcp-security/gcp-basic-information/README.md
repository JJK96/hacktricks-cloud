# GCP - Informazioni di base

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team di HackTricks AWS)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se desideri vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>

## **Gerarchia delle risorse**

Google Cloud utilizza una [Gerarchia delle risorse](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) che √® concettualmente simile a quella di un filesystem tradizionale. Questo fornisce un flusso logico genitore/figlio con punti di attacco specifici per le policy e le autorizzazioni.

A un livello elevato, appare cos√¨:
```
Organization
--> Folders
--> Projects
--> Resources
```
Un **virtual machine** (chiamato un'istanza di calcolo) √® una risorsa. Una risorsa risiede in un progetto, probabilmente insieme ad altre istanze di calcolo, bucket di archiviazione, ecc.

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption><p><a href="https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg">https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg</a></p></figcaption></figure>

## **Migrazione dei Progetti**

√à possibile **migrare un progetto senza alcuna organizzazione** in un'organizzazione con i permessi `roles/resourcemanager.projectCreator` e `roles/resourcemanager.projectMover`. Se il progetto √® all'interno di un'altra organizzazione, √® necessario contattare il supporto GCP per **spostarli fuori dall'organizzazione prima**. Per ulteriori informazioni consulta [**questo**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Politiche dell'Organizzazione**

Consentono di centralizzare il controllo sulle risorse cloud della tua organizzazione:

* Centralizza il controllo per **configurare restrizioni** su come le risorse dell'organizzazione possono essere utilizzate.
* Definire ed istituire **vincoli** per i team di sviluppo per rimanere entro i limiti della conformit√†.
* Aiutare i proprietari dei progetti e i loro team a muoversi rapidamente senza preoccuparsi di violare la conformit√†.

Queste politiche possono essere create per **influenzare l'intera organizzazione, cartelle o progetti**. I discendenti del nodo gerarchico delle risorse mirate **ereditano la politica dell'organizzazione**.

Per **definire** una politica dell'organizzazione, **si sceglie un** [**vincolo**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), che √® un particolare tipo di restrizione contro un servizio Google Cloud o un gruppo di servizi Google Cloud. Si **configura quel vincolo con le restrizioni desiderate**.

<figure><img src="../../../.gitbook/assets/image (217).png" alt=""><figcaption><p><a href="https://cloud.google.com/resource-manager/img/org-policy-concepts.svg">https://cloud.google.com/resource-manager/img/org-policy-concepts.svg</a></p></figcaption></figure>

#### Casi d'uso comuni <a href="#common_use_cases" id="common_use_cases"></a>

* Limitare la condivisione delle risorse in base al dominio.
* Limitare l'uso degli account di servizio Identity and Access Management.
* Limitare la posizione fisica delle risorse appena create.
* Disabilitare la creazione di account di servizio.

<figure><img src="../../../.gitbook/assets/image (172).png" alt=""><figcaption></figcaption></figure>

Ci sono molti altri vincoli che ti danno un controllo dettagliato sulle risorse della tua organizzazione. Per **ulteriori informazioni, consulta l'** [**elenco di tutti i vincoli del servizio Politiche dell'Organizzazione**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

### **Politiche dell'Organizzazione Predefinite**

<details>

<summary>Queste sono le politiche che Google aggiunger√† per impostazione predefinita durante la configurazione dell'organizzazione GCP:</summary>

**Politiche di Gestione degli Accessi**

* **Contatti limitati al dominio:** Impedisce di aggiungere utenti ai Contatti Essenziali al di fuori dei domini specificati. Questo limita i Contatti Essenziali consentendo solo identit√† utente gestite nei domini selezionati a ricevere notifiche della piattaforma.
* **Condivisione limitata al dominio:** Impedisce di aggiungere utenti alle policy IAM al di fuori dei domini specificati. Questo limita le policy IAM consentendo solo identit√† utente gestite nei domini selezionati ad accedere alle risorse all'interno di questa organizzazione.
* **Prevenzione dell'accesso pubblico:** Impedisce ai bucket di Cloud Storage di essere esposti al pubblico. Ci√≤ garantisce che un sviluppatore non possa configurare i bucket di Cloud Storage per avere accesso a Internet non autenticato.
* **Accesso uniforme a livello di bucket:** Impedisce i controlli degli accessi a livello di oggetto (ACL) nei bucket di Cloud Storage. Ci√≤ semplifica la gestione degli accessi applicando in modo coerente le policy IAM su tutti gli oggetti nei bucket di Cloud Storage.
* **Richiedi l'accesso al sistema operativo:** Le VM create in nuovi progetti avranno l'accesso al sistema operativo abilitato. Questo consente di gestire l'accesso SSH alle istanze utilizzando IAM senza la necessit√† di creare e gestire singole chiavi SSH.

**Politiche di sicurezza aggiuntive per gli account di servizio**

* **Disabilita i permessi IAM automatici**: Impedisce che gli account di servizio predefiniti di App Engine e Compute Engine ricevano automaticamente il ruolo IAM Editor su un progetto alla creazione. Ci√≤ garantisce che gli account di servizio non ricevano ruoli IAM eccessivamente permissivi alla creazione.
* **Disabilita la creazione di chiavi di account di servizio**: Impedisce la creazione di chiavi di account di servizio pubbliche. Ci√≤ aiuta a ridurre il rischio di esporre credenziali persistenti.
* **Disabilita il caricamento di chiavi di account di servizio**: Impedisce il caricamento di chiavi di account di servizio pubbliche. Ci√≤ aiuta a ridurre il rischio di materiale chiave esposto o riutilizzato.

**Politiche di configurazione della rete VPC sicura**

* **Definisci gli IP esterni consentiti per le istanze VM**: Impedisce la creazione di istanze di calcolo con un IP pubblico, che potrebbe esporle al traffico Internet.

<!---->

* **Disabilita la virtualizzazione nidificata delle VM**: Impedisce la creazione di VM nidificate su VM di Compute Engine. Ci√≤ riduce il rischio di sicurezza di avere VM nidificate non monitorate.

<!---->

* **Disabilita la porta seriale VM:** Impedisce l'accesso alla porta seriale delle VM di Compute Engine. Ci√≤ impedisce l'input alla porta seriale di un server utilizzando l'API di Compute Engine.

<!---->

* **Limita le reti autorizzate sulle istanze Cloud SQL:** Impedisce a intervalli di reti pubbliche o non interne di accedere ai tuoi database Cloud SQL.

<!---->

* **Limita l'inoltro del protocollo in base al tipo di indirizzo IP:** Impedisce l'inoltro del protocollo VM per gli indirizzi IP esterni.

<!---->

* **Limita l'accesso IP pubblico alle istanze Cloud SQL:** Impedisce la creazione di istanze Cloud SQL con un IP pubblico, che potrebbe esporle al traffico Internet.

<!---->

* **Limita la rimozione del vincolo del progetto VPC condiviso:** Impedisce l'eliminazione accidentale dei progetti host VPC condivisi.

<!---->

* **Imposta l'impostazione DNS interno per i nuovi progetti su Zonal DNS Only:** Impedisce l'uso di un'impostazione DNS legacy che riduce la disponibilit√† del servizio.

<!---->

* **Salta la creazione della rete predefinita:** Impedisce la creazione automatica della rete VPC predefinita e delle risorse correlate. Ci√≤ evita regole del firewall predefinite eccessivamente permissive.

<!---->

* **Disabilita l'uso di IPv6 esterno VPC:** Impedisce la creazione di subnet IPv6 esterne, che potrebbero essere esposte all'accesso a Internet non autorizzato.

</details>

## **Ruoli IAM**

Sono simili alle policy IAM in AWS poich√© **ogni ruolo contiene un insieme di permessi**.

Tuttavia, a differenza di AWS, non esiste un **repository centralizzato** di ruoli. Invece, **le risorse assegnano ruoli di accesso X a principali Y**, e l'unico modo per scoprire chi ha accesso a una risorsa √® utilizzare il **metodo `get-iam-policy` su quella risorsa**.\
Questo potrebbe essere un problema perch√© ci√≤ significa che l'unico modo per scoprire **quali permessi ha un principale √® chiedere a ogni risorsa a chi sta concedendo i permessi**, e un utente potrebbe non avere i permessi per ottenere i permessi da tutte le risorse.

Ci sono **tre tipi** di ruoli in IAM:

* **Ruoli di base/primitivi**, che includono i ruoli **Proprietario**, **Editore** e **Visualizzatore** che esistevano prima dell'introduzione di IAM.
* **Ruoli predefiniti**, che forniscono accesso granulare per un servizio specifico e sono gestiti da Google Cloud. Ci sono molti ruoli predefiniti, puoi **vederli tutti con i privilegi che hanno** [**qui**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles).
* **Ruoli personalizzati**, che forniscono accesso granulare in base a un elenco di permessi specificato dall'utente.

Ci sono migliaia di permessi in GCP. Per verificare se un ruolo ha un permesso puoi [**cercare il permesso qui**](https://cloud.google.com/iam/docs/permissions-reference) e vedere quali ruoli lo hanno.

Puoi anche [**cercare qui i ruoli predefiniti**](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation) **offerti da ciascun prodotto.** Nota che alcuni **ruoli** non possono essere assegnati agli utenti e **solo agli SA a causa di alcuni permessi** che contengono.\
Inoltre, nota che i **permessi** avranno effetto solo se sono **assegnati al servizio rilevante.**

Oppure verifica se un **ruolo personalizzato pu√≤ utilizzare un** [**permesso specifico qui**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**.**

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}
## Utenti <a href="#default-credentials" id="default-credentials"></a>

Nella console di **GCP** non vi √® alcuna gestione degli **Utenti o Gruppi**, che viene gestita in **Google Workspace**. Tuttavia √® possibile sincronizzare un diverso fornitore di identit√† in Google Workspace.

√à possibile accedere agli **utenti e gruppi di Workspace** su [**https://admin.google.com**](https://admin.google.com/).

**MFA** pu√≤ essere **impostata** per gli utenti di Workspace, tuttavia, un **attaccante** potrebbe utilizzare un token per accedere a GCP **tramite CLI senza protezione MFA** (sar√† protetto da MFA solo quando l'utente effettua l'accesso per generarlo: `gcloud auth login`).

## Gruppi

Quando viene creata un'organizzazione, √® **fortemente consigliato creare diversi gruppi**. Se gestisci uno di essi, potresti compromettere tutta o una parte importante dell'organizzazione:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Gruppo</strong></td><td><strong>Funzione</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(account gruppo o individuale richiesto per la checklist)</em></td><td>Amministrazione di qualsiasi risorsa che appartiene all'organizzazione. Assegna questo ruolo con parsimonia; gli amministratori dell'organizzazione hanno accesso a tutte le risorse di Google Cloud. In alternativa, poich√© questa funzione √® molto privilegiata, considera l'uso di account individuali anzich√© creare un gruppo.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(richiesto per la checklist)</em></td><td>Creazione di reti, subnet, regole del firewall e dispositivi di rete come Cloud Router, Cloud VPN e bilanciatori di carico cloud.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(richiesto per la checklist)</em></td><td>Configurazione degli account di fatturazione e monitoraggio del loro utilizzo.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(richiesto per la checklist)</em></td><td>Progettazione, codifica e test di applicazioni.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Stabilire e gestire le politiche di sicurezza per l'intera organizzazione, inclusa la gestione degli accessi e le <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">politiche di vincolo dell'organizzazione</a>. Consulta la <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">guida alle fondamenta della sicurezza di Google Cloud</a> per ulteriori informazioni sulla pianificazione dell'infrastruttura di sicurezza di Google Cloud.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Creazione o gestione di pipeline end-to-end che supportano integrazione e distribuzione continue, monitoraggio e provisioning di sistemi.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(non pi√π di default)</em></td><td>Monitoraggio delle spese nei progetti. I membri tipici fanno parte del team finanziario.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(non pi√π di default)</em></td><td>Revisione delle informazioni sulle risorse in tutta l'organizzazione Google Cloud.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(non pi√π di default)</em></td><td>Revisione della sicurezza cloud.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(non pi√π di default)</em></td><td>Revisione delle configurazioni di rete.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(non pi√π di default)</em></td><td>Visualizzazione dei log di audit.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(non pi√π di default)</em></td><td>Amministrazione del Security Command Center.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(non pi√π di default)</em></td><td>Gestione delle segreti in Secret Manager.</td></tr></tbody></table>

## **Politica Password Predefinita**

* Imporre password sicure
* Tra 8 e 100 caratteri
* Nessun riutilizzo
* Nessuna scadenza
* Se le persone accedono a Workspace tramite un provider di terze parti, questi requisiti non vengono applicati.

<figure><img src="../../../.gitbook/assets/image (20).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (22).png" alt=""><figcaption></figcaption></figure>

## **Account di servizio**

Questi sono i principali che le **risorse** possono **avere** **associati** e accedere per interagire facilmente con GCP. Ad esempio, √® possibile accedere al **token di autenticazione** di un Account di Servizio **associato a una VM** nei metadati.\
√à possibile incontrare alcuni **conflitti** quando si utilizzano sia **IAM che access scopes**. Ad esempio, il tuo account di servizio potrebbe avere il ruolo IAM di `compute.instanceAdmin` ma l'istanza che hai violato √® stata limitata con la limitazione dello scope `https://www.googleapis.com/auth/compute.readonly`. Ci√≤ ti impedirebbe di apportare modifiche utilizzando il token OAuth assegnato automaticamente alla tua istanza.

√à simile ai **ruoli IAM di AWS**. Ma a differenza di AWS, **qualsiasi** account di servizio pu√≤ essere **associato a qualsiasi servizio** (non √® necessario consentirlo tramite una policy).

Molti degli account di servizio che troverai sono effettivamente **generati automaticamente da GCP** quando inizi a utilizzare un servizio, come:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Tuttavia, √® anche possibile creare e collegarsi alle risorse **account di servizio personalizzati**, che avranno questo aspetto:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Ambiti di accesso**

Gli ambiti di accesso sono **associati ai token OAuth generati** per accedere ai punti di API di GCP. Essi **limitano i permessi** del token OAuth.\
Ci√≤ significa che se un token appartiene a un Proprietario di una risorsa ma non ha nell'ambito del token l'accesso a quella risorsa, il token **non pu√≤ essere utilizzato per (ab)usare quei privilegi**.

Google effettivamente [raccomanda](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) di **non utilizzare gli ambiti di accesso e di fare affidamento totalmente su IAM**. Il portale di gestione web effettivamente impone questo, ma gli ambiti di accesso possono comunque essere applicati alle istanze utilizzando account di servizio personalizzati in modo programmato.

√à possibile vedere quali **ambiti** sono **assegnati** tramite **interrogazione:**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Gli **ambiti** precedenti sono quelli generati **per impostazione predefinita** utilizzando **`gcloud`** per accedere ai dati. Questo perch√© quando si utilizza **`gcloud`** si crea prima un token OAuth, e poi lo si utilizza per contattare i punti di contatto.

L'ambito pi√π importante tra quelli potenzialmente disponibili √® **`cloud-platform`**, che significa fondamentalmente che √® possibile **accedere a qualsiasi servizio in GCP**.

√à possibile **trovare un elenco di** [**tutti gli ambiti possibili qui**](https://developers.google.com/identity/protocols/googlescopes)**.**

Se si dispone di credenziali del browser **`gcloud`**, √® possibile **ottenere un token con altri ambiti**, facendo qualcosa del genere:

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Politiche IAM di Terraform, Associazioni e Appartenenze**

Come definito da terraform in [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam) utilizzando terraform con GCP ci sono diversi modi per concedere l'accesso a un principale su una risorsa:

* **Appartenenze**: Si impostano **principali come membri di ruoli** **senza restrizioni** sul ruolo o sui principali. √à possibile mettere un utente come membro di un ruolo e quindi mettere un gruppo come membro dello stesso ruolo e anche impostare quei principali (utente e gruppo) come membri di altri ruoli.
* **Associazioni**: Diversi **principali possono essere associati a un ruolo**. Quei **principali possono ancora essere associati o essere membri di altri ruoli**. Tuttavia, se un principale che non √® associato al ruolo viene impostato come **membro di un ruolo associato**, la prossima volta che viene **applicata l'associazione, l'appartenenza scomparir√†**.
* **Politiche**: Una politica √® **autoritativa**, indica ruoli e principali e quindi, **quei principali non possono avere pi√π ruoli e quei ruoli non possono avere pi√π principali** a meno che quella politica non venga modificata (neanche in altre politiche, associazioni o appartenenze). Pertanto, quando un ruolo o principale √® specificato nella politica, tutti i suoi privilegi sono **limitati da quella politica**. Ovviamente, questo pu√≤ essere aggirato nel caso in cui al principale venga data l'opzione di modificare la politica o i permessi di escalation dei privilegi (come creare un nuovo principale e associargli un nuovo ruolo).

## Riferimenti

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)

<details>

<summary><strong>Impara l'hacking su AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
