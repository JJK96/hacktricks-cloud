# GCP - 基本情報

<details>

<summary><strong>**htARTE (HackTricks AWS Red Team Expert)**</strong>を使用して、**ゼロからヒーローまでAWSハッキングを学ぶ**！</summary>

HackTricks をサポートする他の方法:

- **HackTricks で企業を宣伝**したい場合や **HackTricks をPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
- [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションを見つける
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする
- **ハッキングトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## **リソース階層**

Google Cloud は、従来のファイルシステムに概念的に類似した[リソース階層](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)を使用しています。これにより、ポリシーや権限の特定のアタッチメントポイントを持つ論理的な親子ワークフローが提供されます。

高レベルでは、次のようになります:
```
Organization
--> Folders
--> Projects
--> Resources
```
仮想マシン（Compute Instanceと呼ばれる）はリソースです。リソースはプロジェクト内にあり、おそらく他のCompute Instances、ストレージバケットなどと一緒に存在します。

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption><p><a href="https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg">https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg</a></p></figcaption></figure>

## **プロジェクトの移行**

**組織なしのプロジェクトを組織に移行**することが可能です。この際、`roles/resourcemanager.projectCreator`および`roles/resourcemanager.projectMover`の権限が必要です。プロジェクトが他の組織内にある場合は、まずGCPサポートに連絡して**組織から移動する必要があります**。詳細については[**こちら**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6)を参照してください。

## **組織ポリシー**

組織のクラウドリソースに対する制御を一元化することができます：

- 組織のリソースの使用方法に関する**制限を設定**するための一元化された制御。
- 開発チームがコンプライアンスの範囲内にとどまるための**ガードレール**を定義および確立する。
- プロジェクト所有者とそのチームがコンプライアンスを破る心配なく迅速に移動できるように支援する。

これらのポリシーは、**組織全体、フォルダ、またはプロジェクト**に影響を与えるように作成できます。対象となるリソース階層ノードの**子孫は組織ポリシーを継承**します。

組繹ポリシーを**定義**するには、Google Cloudサービスまたは一群のGoogle Cloudサービスに対する特定の制限である[**制約**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints)を選択します。その制約を所望の制限で**構成**します。

<figure><img src="../../../.gitbook/assets/image (217).png" alt=""><figcaption><p><a href="https://cloud.google.com/resource-manager/img/org-policy-concepts.svg">https://cloud.google.com/resource-manager/img/org-policy-concepts.svg</a></p></figcaption></figure>

#### 一般的な使用例 <a href="#common_use_cases" id="common_use_cases"></a>

- ドメインに基づいたリソース共有の制限。
- Identity and Access Managementサービスアカウントの使用制限。
- 新しく作成されたリソースの物理的な場所の制限。
- サービスアカウントの作成の無効化

<figure><img src="../../../.gitbook/assets/image (172).png" alt=""><figcaption></figcaption></figure>

組織のリソースに対する細かい制御を提供する多くの制約があります。**詳細については、**[**すべての組織ポリシーサービス制約のリスト**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**を参照してください。**

### **デフォルトの組織ポリシー**

<details>

<summary>これらは、GCP組織を設定する際にGoogleがデフォルトで追加するポリシーです：</summary>

**アクセス管理ポリシー**

- **ドメイン制限された連絡先:** 指定したドメイン外のユーザーをEssential Contactsに追加することを防止します。これにより、Essential Contactsは、選択したドメイン内の管理されたユーザーIDのみがプラットフォーム通知を受信できるように制限されます。
- **ドメイン制限された共有:** 指定したドメイン外のIAMポリシーにユーザーを追加することを防止します。これにより、IAMポリシーは、この組織内のリソースにアクセスできるのは選択したドメイン内の管理されたユーザーIDのみとなります。
- **パブリックアクセスの防止:** Cloud Storageバケットが一般に公開されるのを防止します。これにより、開発者がCloud Storageバケットを認証されていないインターネットアクセスを持つように構成できないようになります。
- **一様なバケットレベルのアクセス:** Cloud Storageバケット内のオブジェクトレベルのアクセス制御リスト（ACL）を防止します。これにより、Cloud Storageバケット内のすべてのオブジェクトに一貫してIAMポリシーを適用することで、アクセス管理が簡素化されます。
- **OSログインの必要性:** 新しいプロジェクトで作成されたVMにはOSログインが有効になります。これにより、IAMを使用してインスタンスへのSSHアクセスを管理でき、個々のSSHキーを作成および管理する必要がありません。

**サービスアカウントの追加セキュリティポリシー**

- **自動IAM権限の無効化**: デフォルトのApp EngineおよびCompute Engineサービスアカウントがプロジェクトの作成時に自動的にEditor IAMロールを付与されるのを防止します。これにより、サービスアカウントが作成時に過剰な権限を受け取らないようになります。
- **サービスアカウントキーの作成の無効化**: パブリックサービスアカウントキーの作成を防止します。これにより、永続的な資格情報が公開されるリスクが低減されます。
- **サービスアカウントキーのアップロードの無効化**: パブリックサービスアカウントキーのアップロードを防止します。これにより、キー素材の漏洩や再利用のリスクが低減されます。

**セキュアVPCネットワーク構成ポリシー**

- **VMインスタンスの許可された外部IPの定義**: パブリックIPを持つComputeインスタンスの作成を防止し、それによってインターネットトラフィックにさらされる可能性を排除します。

<!---->

- **VMのネスト仮想化の無効化**: Compute Engine VM上でのネストされたVMの作成を防止します。これにより、監視されていないネストされたVMのセキュリティリスクが低減されます。

<!---->

- **VMシリアルポートの無効化:** Compute Engine VMへのシリアルポートアクセスを防止します。これにより、Compute Engine APIを使用してサーバーのシリアルポートに入力することが防止されます。

<!---->

- **Cloud SQLインスタンスへの許可されたネットワークの制限:** パブリックまたは非内部ネットワーク範囲からCloud SQLデータベースにアクセスするのを防止します。

<!---->

- **IPアドレスの種類に基づくプロトコルフォワーディングの制限:** 外部IPアドレスのためのVMプロトコルフォワーディングを防止します。

<!---->

- **Cloud SQLインスタンスへのパブリックIPアクセスの制限:** パブリックIPを持つCloud SQLインスタンスの作成を防止し、それによってインターネットトラフィックにさらされる可能性を排除します。

<!---->

- **共有VPCプロジェクトのライン削除の制限:** 共有VPCホストプロジェクトの誤った削除を防止します。

<!---->

- **新しいプロジェクトの内部DNS設定をゾナルDNSのみに設定:** サービス可用性が低下するレガシーDNS設定の使用を防止します。

<!---->

- **デフォルトネットワークの作成のスキップ:** デフォルトVPCネットワークと関連リソースの自動作成を防止します。これにより、過剰に許可されたデフォルトのファイアウォールルールを回避します。

<!---->

- **VPC外部IPv6の使用の無効化:** 外部IPv6サブネットの作成を防止し、未承認のインターネットアクセスにさらされる可能性を排除します。

</details>

## **IAMロール**

これらはAWSのIAMポリシーのようなもので、**各ロールには一連の権限が含まれます**。

ただし、AWSとは異なり、ロールの**中央リポジトリは存在しません**。代わりに、**リソースはYプリンシパルにXアクセスロールを与え**、リソースにアクセス権限があるかどうかを調べる唯一の方法は、そのリソース上で**`get-iam-policy`メソッドを使用**することです。\
これは問題になる可能性があります。なぜなら、これはつまり、**どの権限を持つプリンシパルが誰かを調べる唯一の方法は、すべてのリソースにアクセス権限を与えているかどうかを尋ねること**であり、ユーザーがすべてのリソースから権限を取得する権限を持っていない可能性があるからです。

IAMには**3種類**のロールがあります：

- **基本/プリミティブロール**：IAMの導入前から存在していた**Owner**、**Editor**、**Viewer**ロールを含む。
- **事前定義済みロール**：特定のサービスに対する細かいアクセスを提供し、Google Cloudによって管理されます。事前定義済みの多くのロールがあり、それらが持つ権限を**[こちら](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles)**で確認できます。
- **カスタムロール**：ユーザー指定の権限リストに基づいて細かいアクセスを提供します。

GCPには数千の権限があります。ロールに権限があるかどうかを確認するには、[こちらで権限を検索](https://cloud.google.com/iam/docs/permissions-reference)し、どのロールがそれを持っているかを確認できます。

また、各製品が提供する**[こちらの事前定義ロール](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation)**を検索することもできます。一部の**ロール**はユーザーにはアタッチできず、**一部の権限**を含むため、**SAsにのみアタッチ**できます。\
さらに、**権限**は関連するサービスに**アタッチされている場合にのみ**有効になります。

また、**カスタムロールが**[こちらで特定の権限を使用できるかどうかを確認](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**することもできます。**

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}
## ユーザー <a href="#default-credentials" id="default-credentials"></a>

**GCPコンソール**には**ユーザーまたはグループ**管理がありません。これは**Google Workspace**で行われます。ただし、Google Workspaceで異なるアイデンティティプロバイダーを同期させることができます。

Workspacesの**ユーザーとグループにアクセス**するには、[**https://admin.google.com**](https://admin.google.com/)にアクセスできます。

**MFA**はWorkspacesユーザーに**強制**することができますが、**攻撃者**はトークンを使用してGCPにアクセスできます。ただし、これはMFAによって保護されません（ユーザーが生成するためにログインするときのみMFAによって保護されます：`gcloud auth login`）。

## グループ

組織が作成されると、いくつかのグループが**強く作成されることが推奨されます。**これらのいずれかを管理している場合、組織全体または重要な部分を侵害される可能性があります：

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>グループ</strong></td><td><strong>機能</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(チェックリストに必要なグループまたは個人アカウント)</em></td><td>組織に属するリソースの管理。この役割は慎重に割り当ててください。組織管理者はすべてのGoogle Cloudリソースにアクセスできます。代わりに、この機能は非常に特権があるため、グループを作成する代わりに個々のアカウントを使用することを検討してください。</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(チェックリストに必要)</em></td><td>ネットワーク、サブネット、ファイアウォールルール、Cloud Router、Cloud VPN、クラウドロードバランサーなどのネットワークデバイスの作成。</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(チェックリストに必要)</em></td><td>課金アカウントの設定と使用状況の監視。</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(チェックリストに必要)</em></td><td>アプリケーションの設計、コーディング、テスト。</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>組織全体のセキュリティポリシーの確立と管理、アクセス管理および<a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">組織制約ポリシー</a>を含む。Google Cloudセキュリティ基盤ガイドの<a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">ユーザーとグループ</a>に関する詳細情報については、参照してください。</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>継続的な統合とデリバリー、モニタリング、システムプロビジョニングをサポートするエンドツーエンドのパイプラインの作成または管理。</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(デフォルトではなくなりました)</em></td><td>プロジェクトの支出を監視。典型的なメンバーは財務チームの一部です。</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(デフォルトではなくなりました)</em></td><td>Google Cloud組織全体のリソース情報を確認。</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(デフォルトではなくなりました)</em></td><td>クラウドセキュリティのレビュー。</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(デフォルトではなくなりました)</em></td><td>ネットワーク構成のレビュー。</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(デフォルトではなくなりました)</em></td><td>監査ログの表示。</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(デフォルトではなくなりました)</em></td><td>Security Command Centerの管理。</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(デフォルトではなくなりました)</em></td><td>Secret Managerでのシークレットの管理。</td></tr></tbody></table>

## **デフォルトパスワードポリシー**

* 強力なパスワードを強制する
* 8〜100文字
* 再利用不可
* 期限切れなし
* ワークスペースにサードパーティプロバイダーを介してアクセスしている場合、これらの要件は適用されません。

<figure><img src="../../../.gitbook/assets/image (20).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (22).png" alt=""><figcaption></figcaption></figure>

## **サービスアカウント**

これらは**リソース**が**アタッチされている**主体であり、GCPと簡単にやり取りするためのアクセスを提供します。たとえば、VMに**アタッチされた**サービスアカウントの**認証トークン**にアクセスすることができます。\
IAMとアクセススコープの両方を使用すると、いくつかの**競合**が発生する可能性があります。たとえば、サービスアカウントに`compute.instanceAdmin`のIAMロールがあるかもしれませんが、侵害したインスタンスには`https://www.googleapis.com/auth/compute.readonly`のスコープ制限が設定されている可能性があります。これにより、自動的に割り当てられたOAuthトークンを使用して変更を行うことができなくなります。

これは**AWSのIAMロール**に似ています。ただし、AWSとは異なり、**どの**サービスアカウントも**どのサービスにもアタッチ**できます（ポリシーを介して許可する必要はありません）。

GCPを使用し始めると、実際にはGCPによって**自動的に生成されるいくつかのサービスアカウント**がいくつか見つかるでしょう。
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
しかし、**カスタムサービスアカウント**を作成してリソースにアタッチすることも可能です。これは次のようになります：
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **アクセススコープ**

アクセススコープはGCP APIエンドポイントにアクセスするために生成されたOAuthトークンに**添付されます**。これらはOAuthトークンの**権限を制限**します。\
つまり、トークンがリソースの所有者に属していても、そのリソースにアクセスするためのスコープがトークンに含まれていない場合、そのトークンは**それらの権限を悪用することはできません**。

Googleは実際に[推奨しています](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions)が、**アクセススコープは使用せず、完全にIAMに依存する**ことを。Web管理ポータルは実際にこれを強制しますが、アクセススコープはカスタムサービスアカウントをプログラムで使用してインスタンスに適用することができます。

**割り当てられているスコープ**を**クエリして**どのようなものかを確認できます：

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

前の**スコープ**は、データにアクセスするために**`gcloud`**を使用して生成されるデフォルトのものです。これは、**`gcloud`**を使用すると、まずOAuthトークンを作成し、その後エンドポイントにアクセスするために使用するためです。

その中で最も重要なスコープはおそらく**`cloud-platform`**で、基本的には**GCPの任意のサービスにアクセス**できることを意味します。

[**ここにすべての可能なスコープのリスト**](https://developers.google.com/identity/protocols/googlescopes)**があります。**

**`gcloud`**ブラウザの資格情報がある場合、他のスコープでトークンを取得することが可能で、次のように行います：
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform IAMポリシー、バインディング、およびメンバーシップ**

[https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam)でterraformによって定義されたように、GCPでterraformを使用すると、リソースに対するプリンシパルへのアクセスを許可するさまざまな方法があります：

* **メンバーシップ**: **プリンシパルをロールのメンバーとして設定**し、**そのロールやプリンシパルに制限を設けない**方法です。ユーザーをロールのメンバーとして設定し、その後、同じロールのメンバーとしてグループを設定し、これらのプリンシパル（ユーザーとグループ）を他のロールのメンバーとしても設定できます。
* **バインディング**: 複数の**プリンシパルをロールにバインド**することができます。これらの**プリンシパルは引き続きバインドされるか、他のロールのメンバーになることができます**。ただし、ロールにバインドされていないプリンシパルが**バインドされたロールのメンバーとして設定**された場合、次回**バインディングが適用されると、メンバーシップは消えます**。
* **ポリシー**: ポリシーは**権威的**であり、ロールとプリンシパルを示し、その後、**そのポリシーが変更されるまで、これらのプリンシパルは他のロールを持つことができず、これらのロールは他のプリンシパルを持つことができません**（他のポリシー、バインディング、メンバーシップでも同様）。したがって、ポリシーでロールまたはプリンシパルが指定されると、その権限は**そのポリシーによって制限されます**。もちろん、プリンシパルがポリシーを変更するオプションや特権昇格権限（新しいプリンシパルを作成して新しいロールをバインドするなど）を与えられている場合、これをバイパスすることができます。

## 参考文献

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする
* **ハッキングトリックを共有するために** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する

</details>
