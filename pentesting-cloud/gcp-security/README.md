# GCP Pentesting

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>에서 **제로**부터 **히어로**까지 **AWS 해킹 배우기**!</summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고**하거나 **HackTricks를 PDF로 다운로드**하려면 [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 얻으세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* **💬 [디스코드 그룹](https://discord.gg/hRep4RUj7f)** 또는 [텔레그램 그룹](https://t.me/peass)에 **참여**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* **HackTricks** 및 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## 기본 정보

**GCP** 환경을 **펜테스팅**하기 전에, 무엇을 해야 할지, 미구성을 찾는 방법 및 그것을 어떻게 악용할지를 이해하는 데 도움이 되는 몇 가지 **기본 사항**이 있습니다.

**조직** 계층, **권한** 및 기타 기본 개념과 같은 개념은 다음에서 설명됩니다:

{% content-ref url="gcp-basic-information/" %}
[gcp-basic-information](gcp-basic-information/)
{% endcontent-ref %}

## 학습을 위한 랩

* [https://gcpgoat.joshuajebaraj.com/](https://gcpgoat.joshuajebaraj.com/)
* [https://github.com/ine-labs/GCPGoat](https://github.com/ine-labs/GCPGoat)
* [https://github.com/lacioffi/GCP-pentest-lab/](https://github.com/lacioffi/GCP-pentest-lab/)
* [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)

## GCP 펜테스터/레드팀 방법론

GCP 환경을 감사하기 위해서는 사용 중인 **서비스**, **노출된 것**, 누가 **무엇에 액세스** 권한이 있는지 및 내부 GCP 서비스와 **외부 서비스**가 어떻게 연결되어 있는지를 알아야 합니다.

레드팀 관점에서 **GCP 환경을 침해하는 첫 번째 단계**는 일부 **자격 증명을 획득**하는 것입니다. 다음은 그것을 하는 방법에 대한 몇 가지 아이디어입니다:

* 깃허브(또는 유사한 곳)의 **누출** - OSINT
* **사회** 공학 (페이지 [**Workspace Security**](../workspace-security/)를 확인하세요)
* **비밀번호** 재사용 (비밀번호 누출)
* GCP-호스팅 애플리케이션의 취약점
* [**서버 측 요청 위조**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) 메타데이터 엔드포인트에 액세스
* **로컬 파일 읽기**
* `/home/USERNAME/.config/gcloud/*`
* `C:\Users\USERNAME\.config\gcloud\*`
* 3rd parties **침해**
* **내부** 직원

또는 미인증 서비스를 침해함으로써 **노출된 서비스를 침해**할 수 있습니다:

{% content-ref url="gcp-unaunthenticated-enum-and-access/" %}
[gcp-unaunthenticated-enum-and-access](gcp-unaunthenticated-enum-and-access/)
{% endcontent-ref %}

또는 **검토**를 수행 중이라면 다음 역할로 **자격 증명을 요청**할 수 있습니다:

{% content-ref url="gcp-permissions-for-a-pentest.md" %}
[gcp-permissions-for-a-pentest.md](gcp-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
자격 증명을 획득한 후, 해당 자격 증명이 **누구에게 속하는지** 및 **무엇에 액세스 권한이 있는지** 알아야 하므로 일부 기본 열거를 수행해야 합니다:
{% endhint %}

## 기본 열거

### **SSRF**

GCP 메타데이터를 **열거하는 방법**에 대한 자세한 정보는 다음 hacktricks 페이지를 확인하세요:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Whoami

GCP에서 누구인지 추측해 보기 위해 여러 옵션을 시도할 수 있습니다:

{% code overflow="wrap" %}
```bash
#If you are inside a compromise machine
gcloud auth list
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=$(gcloud auth print-access-token)" https://www.googleapis.com/oauth2/v1/tokeninfo
gcloud auth print-identity-token #Get info from the token

#If you compromised a metadata token or somehow found an OAuth token
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=<token>" https://www.googleapis.com/oauth2/v1/tokeninfo
```
{% endcode %}

### 조직 열거
```bash
# Get organizations
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud resource-manager folders list --organization <org_number> # Get folders
gcloud projects list # Get projects
```
### 원칙 및 IAM 열거

충분한 권한이 있다면 **GCP 계정 내 각 엔터티의 권한을 확인**하여 본인과 다른 신원이 무엇을 할 수 있는지, 그리고 **권한 상승**을 어떻게 할 수 있는지 이해하는 데 도움이 됩니다.

IAM을 열거할 충분한 권한이 없다면 **무차별 대입(brute-force)하여** 그것들을 파악할 수 있습니다.\
**열거 및 무차별 대입을 하는 방법**은 다음에서 확인할 수 있습니다:

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

{% hint style="info" %}
이제 **자격 증명에 대한 일부 정보를** 가지고 있습니다 (그리고 레드팀이라면 **감지되지 않았으면** 좋겠습니다). 환경에서 사용되는 서비스를 확인하는 시간입니다.\
다음 섹션에서 **일반적인 서비스를 열거하는 방법**을 확인할 수 있습니다.
{% endhint %}

## 서비스 열거

GCP에는 놀라운 양의 서비스가 있으며, 다음 페이지에서는 **기본 정보, 열거** 치트시트, **탐지 회피** 방법, **지속성** 확보 및 기타 **사후 침투** 트릭에 대해 일부 서비스에 대해 알아볼 수 있습니다:

{% content-ref url="gcp-services/" %}
[gcp-services](gcp-services/)
{% endcontent-ref %}

**수동으로** 모든 작업을 수행할 필요가 없다는 점을 유의하십시오. 이 게시물 아래에서 **자동 도구에 대한** 섹션을 찾을 수 있습니다.

또한, 이 단계에서 **인증되지 않은 사용자에게 노출된 더 많은 서비스**를 발견할 수 있으며, 이를 악용할 수 있습니다:

{% content-ref url="gcp-unaunthenticated-enum-and-access/" %}
[gcp-unaunthenticated-enum-and-access](gcp-unaunthenticated-enum-and-access/)
{% endcontent-ref %}

## 권한 상승, 사후 침투 및 지속성

클라우드 자격 증명을 얻거나 클라우드 내에서 실행 중인 일부 서비스를 침해한 후, **침해된 계정이 가질 수 있는 권한을 남용**하는 것이 가장 일반적인 방법입니다. 따라서, 할 일은 먼저 권한을 열거하는 것입니다.

또한, 이 열거 중에 **권한이 "조직"의 최상위 수준에서 설정될 수 있다는 것을** 기억하십시오.

{% content-ref url="gcp-privilege-escalation/" %}
[gcp-privilege-escalation](gcp-privilege-escalation/)
{% endcontent-ref %}

{% content-ref url="gcp-post-exploitation/" %}
[gcp-post-exploitation](gcp-post-exploitation/)
{% endcontent-ref %}

{% content-ref url="gcp-persistence/" %}
[gcp-persistence](gcp-persistence/)
{% endcontent-ref %}

### 공개적으로 노출된 서비스

GCP 서비스를 열거하는 동안 **인터넷에 요소를 노출하는** 일부 서비스를 발견했을 수 있습니다 (VM/컨테이너 포트, 데이터베이스 또는 큐 서비스, 스냅샷 또는 버킷 등).\
펜테스터/레드팀원으로서 항상 **그들이 AWS 계정으로의 추가 액세스를 제공할 수 있는** **민감한 정보/취약점**을 찾을 수 있는지 확인해야 합니다.

이 책에서는 **노출된 GCP 서비스를 찾고 확인하는 방법**에 대한 **정보**를 찾을 수 있습니다. **노출된 네트워크 서비스의 취약점을 찾는 방법**에 대해서는 특정 **서비스**에 대해 **검색**하는 것을 권장합니다:

{% embed url="https://book.hacktricks.xyz/" %}

## GCP <--> Workspace 피벗

**한** 플랫폼에서 **원칙을 침해**하면 공격자가 **다른 플랫폼을 침해**할 수 있을 수 있습니다. 이를 확인하려면:

{% content-ref url="gcp-to-workspace-pivoting/" %}
[gcp-to-workspace-pivoting](gcp-to-workspace-pivoting/)
{% endcontent-ref %}

## 자동 도구

* **GCloud 콘솔**에서 [https://console.cloud.google.com/iam-admin/asset-inventory/dashboard](https://console.cloud.google.com/iam-admin/asset-inventory/dashboard)에서 프로젝트에서 사용되는 리소스 및 IAM을 볼 수 있습니다.
* 여기에서 이 API에서 지원하는 자산을 볼 수 있습니다: [https://cloud.google.com/asset-inventory/docs/supported-asset-types](https://cloud.google.com/asset-inventory/docs/supported-asset-types)
* [**gcp\_scanner**](https://github.com/google/gcp\_scanner): 이것은 GCP 리소스 스캐너로, GCP에서 특정 자격 증명이 가지는 **액세스 수준을 결정하는 데 도움이 되는** GCP 리소스 스캐너입니다.
```bash
# Install
git clone https://github.com/google/gcp_scanner.git
cd gcp_scanner
virtualenv -p python3 venv
source venv/bin/activate
pip install -r requirements.txt
# Execute with gcloud creds
python3 __main__.py -o /tmp/output/ -g "$HOME/.config/gcloud"
```
* [**gcp\_enum**](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_enum): GCP 환경을 열거하기 위한 Bash 스크립트로, gcloud cli를 사용하여 결과를 파일에 저장합니다.
* [**GCP-IAM-Privilege-Escalation**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation): 높은 IAM 권한을 열거하고 해당 권한을 남용하여 GCP에서 권한 상승을 하는 스크립트입니다 (열거 스크립트를 실행하지 못했습니다).
* [**BF My GCP Permissions**](https://github.com/carlospolop/bf\_my\_gcp\_permissions): 권한을 무차별 대입하는 스크립트입니다.

## gcloud 구성 및 디버그
```bash
# Login so gcloud can use your credentials
gcloud auth login
gcloud config set project security-devbox
gcloud auth print-access-token

# Login so SDKs can use your user credentials
gcloud auth application-default login
gcloud auth application-default set-quota-project security-devbox
gcloud auth application-default print-access-token

# Update gcloud
gcloud components update
```
### gcloud, gsutil 네트워크 캡처

**`gcloud`** cli에서 **`--log-http`** **매개변수**를 사용하여 도구가 수행하는 **요청**을 **출력**할 수 있다. 로그가 토큰 값을 마스킹하지 않으려면 `gcloud config set log_http_redact_token false`를 사용하십시오.

또한, 통신을 가로채려면:
```bash
gcloud config set proxy/address 127.0.0.1
gcloud config set proxy/port 8080
gcloud config set proxy/type http
gcloud config set auth/disable_ssl_validation True

# If you don't want to completely disable ssl_validation use:
gcloud config set core/custom_ca_certs_file cert.pem

# Back to normal
gcloud config unset proxy/address
gcloud config unset proxy/port
gcloud config unset proxy/type
gcloud config unset auth/disable_ssl_validation
gcloud config unset core/custom_ca_certs_file
```
### gcloud에서 OAuth 토큰 구성

**메타데이터 엔드포인트에서 유출된 서비스 계정 OAuth 토큰을 사용하려면** 다음을 수행할 수 있습니다:
```bash
# Via env vars
export CLOUDSDK_AUTH_ACCESS_TOKEN=<token>
gcloud projects list

# Via setup
echo "<token>" > /some/path/to/token
gcloud config set auth/access_token_file /some/path/to/token
gcloud projects list
gcloud config unset auth/access_token_file
```
## 참고 자료

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)를 통해 제로부터 영웅이 되는 AWS 해킹을 배우세요</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사가 HackTricks를 광고하거나 PDF로 다운로드하고 싶다면** [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구매하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* **💬 [**디스코드 그룹**](https://discord.gg/hRep4RUj7f)에 가입하거나 [**텔레그램 그룹**](https://t.me/peass)에 가입하거나** 트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우하세요.**
* **해킹 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>
