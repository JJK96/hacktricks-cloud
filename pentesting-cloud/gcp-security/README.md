# GCP 渗透测试

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS 红队专家）</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想看到您的**公司在 HackTricks 中做广告**或**下载 PDF 版本的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** 上关注我们**。
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 基本信息

在开始渗透测试 **GCP** 环境之前，有一些**基本概念**需要了解，以帮助您理解需要做什么，如何查找配置错误以及如何利用它们。

诸如**组织**层次结构、**权限**和其他基本概念在以下链接中有解释：

{% content-ref url="gcp-basic-information/" %}
[gcp-basic-information](gcp-basic-information/)
{% endcontent-ref %}

## 学习实验

* [https://gcpgoat.joshuajebaraj.com/](https://gcpgoat.joshuajebaraj.com/)
* [https://github.com/ine-labs/GCPGoat](https://github.com/ine-labs/GCPGoat)
* [https://github.com/lacioffi/GCP-pentest-lab/](https://github.com/lacioffi/GCP-pentest-lab/)
* [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)

## GCP 渗透测试员/红队方法论

要审计 GCP 环境，非常重要的是要了解：正在使用哪些**服务**，正在**暴露**什么，谁有**访问权限**，以及内部 GCP 服务和**外部服务**如何连接。

从红队的角度来看，**入侵 GCP 环境的第一步**是设法获取一些**凭据**。以下是一些获取凭据的方法：

* 在 github（或类似网站）中的**泄漏** - OSINT
* **社会**工程（查看页面[**Workspace 安全**](../workspace-security/)）
* **密码**重用（密码泄漏）
* 托管在 GCP 上的应用程序的漏洞
* [**服务器端请求伪造（SSRF）**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)，具有访问元数据端点的权限
* **本地文件读取**
* `/home/USERNAME/.config/gcloud/*`
* `C:\Users\USERNAME\.config\gcloud\*`
* 第三方**遭受攻击**
* **内部**员工

或通过**入侵暴露的未经身份验证服务**：

{% content-ref url="gcp-unaunthenticated-enum-and-access/" %}
[gcp-unaunthenticated-enum-and-access](gcp-unaunthenticated-enum-and-access/)
{% endcontent-ref %}

或者如果您正在进行**审查**，您可以直接**请求具有以下角色的凭据**：

{% content-ref url="gcp-permissions-for-a-pentest.md" %}
[gcp-permissions-for-a-pentest.md](gcp-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
在成功获取凭据后，您需要知道这些凭据属于**谁**，以及他们有权限访问什么，因此您需要执行一些基本枚举：
{% endhint %}

## 基本枚举

### **SSRF**

有关如何**枚举 GCP 元数据**的更多信息，请查看以下 hacktricks 页面：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Whoami

在 GCP 中，您可以尝试多种选项来猜测您是谁：

{% code overflow="wrap" %}
```bash
#If you are inside a compromise machine
gcloud auth list
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=$(gcloud auth print-access-token)" https://www.googleapis.com/oauth2/v1/tokeninfo
gcloud auth print-identity-token #Get info from the token

#If you compromised a metadata token or somehow found an OAuth token
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=<token>" https://www.googleapis.com/oauth2/v1/tokeninfo
```
{% endcode %}

### 组织枚举
```bash
# Get organizations
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud resource-manager folders list --organization <org_number> # Get folders
gcloud projects list # Get projects
```
### 原则与IAM枚举

如果您拥有足够的权限，**检查GCP帐户内每个实体的特权**将帮助您了解您和其他身份可以做什么以及如何**提升特权**。

如果您没有足够的权限来枚举IAM，您可以**尝试暴力破解**以找出它们。\
查看如何进行枚举和暴力破解：

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

{% hint style="info" %}
现在您**已经获取了有关您的凭据的一些信息**（如果您是红队，希望您**尚未被发现**）。现在是时候弄清楚环境中正在使用哪些服务了。\
在以下部分，您可以查看一些**枚举一些常见服务**的方法。
{% endhint %}

## 服务枚举

GCP拥有大量的服务，在以下页面中，您将找到有关**基本信息、枚举**备忘单，如何**避免检测**，获取**持久性**以及其他关于其中一些服务的**后期利用**技巧：

{% content-ref url="gcp-services/" %}
[gcp-services](gcp-services/)
{% endcontent-ref %}

请注意，您**不需要**手动执行所有工作，在本文后面的部分，您可以找到关于[**自动工具**](./#automatic-tools)的**部分**。

此外，在此阶段，您可能会发现**更多服务暴露给未经身份验证的用户**，您可能能够利用它们：

{% content-ref url="gcp-unaunthenticated-enum-and-access/" %}
[gcp-unaunthenticated-enum-and-access](gcp-unaunthenticated-enum-and-access/)
{% endcontent-ref %}

## 特权升级、后期利用和持久性

一旦您获得了一些云凭据或者已经入侵了云中运行的某些服务，最常见的方法就是**滥用被入侵账户可能拥有的配置不当的特权**。因此，您应该首先枚举您的特权。

此外，在此枚举过程中，请记住**权限可以设置在“组织”的最高级别**。

{% content-ref url="gcp-privilege-escalation/" %}
[gcp-privilege-escalation](gcp-privilege-escalation/)
{% endcontent-ref %}

{% content-ref url="gcp-post-exploitation/" %}
[gcp-post-exploitation](gcp-post-exploitation/)
{% endcontent-ref %}

{% content-ref url="gcp-persistence/" %}
[gcp-persistence](gcp-persistence/)
{% endcontent-ref %}

### 公开暴露的服务

在枚举GCP服务时，您可能会发现其中一些服务**向互联网公开元素**（VM/容器端口、数据库或队列服务、快照或存储桶...）。\
作为渗透测试员/红队人员，您应该始终检查是否可以在其中找到**敏感信息/漏洞**，因为它们可能为您提供**进一步访问AWS帐户**的机会。

在本书中，您应该找到有关如何查找**公开暴露的GCP服务以及如何检查它们**的**信息**。关于如何在公开网络服务中找到**漏洞**，我建议您在以下网址中**搜索**特定**服务**：

{% embed url="https://book.hacktricks.xyz/" %}

## GCP <--> Workspace 转移

**入侵**一个平台中的**主体**可能会使攻击者能够**入侵另一个平台**，在以下链接中查看：

{% content-ref url="gcp-to-workspace-pivoting/" %}
[gcp-to-workspace-pivoting](gcp-to-workspace-pivoting/)
{% endcontent-ref %}

## 自动工具

* 在**GCloud控制台**中，您可以在[https://console.cloud.google.com/iam-admin/asset-inventory/dashboard](https://console.cloud.google.com/iam-admin/asset-inventory/dashboard)查看项目使用的资源和IAM。
* 在此处，您可以查看此API支持的资产：[https://cloud.google.com/asset-inventory/docs/supported-asset-types](https://cloud.google.com/asset-inventory/docs/supported-asset-types)
* 检查可以[**在多个云中使用的工具**](../pentesting-cloud-methodology.md)。
* [**gcp\_scanner**](https://github.com/google/gcp\_scanner)：这是一个GCP资源扫描程序，可以帮助确定在GCP上某些凭据具有**何种访问级别**。
```bash
# Install
git clone https://github.com/google/gcp_scanner.git
cd gcp_scanner
virtualenv -p python3 venv
source venv/bin/activate
pip install -r requirements.txt
# Execute with gcloud creds
python3 __main__.py -o /tmp/output/ -g "$HOME/.config/gcloud"
```
* [**gcp\_enum**](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_enum): 用 Bash 脚本使用 gcloud cli 枚举 GCP 环境，并将结果保存在文件中。
* [**GCP-IAM-Privilege-Escalation**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation): 用于枚举高 IAM 权限并利用它们在 GCP 中升级权限的脚本（我无法运行枚举脚本）。
* [**BF My GCP Permissions**](https://github.com/carlospolop/bf\_my\_gcp\_permissions): 用于暴力破解您的权限的脚本。

## gcloud 配置和调试
```bash
# Login so gcloud can use your credentials
gcloud auth login
gcloud config set project security-devbox
gcloud auth print-access-token

# Login so SDKs can use your user credentials
gcloud auth application-default login
gcloud auth application-default set-quota-project security-devbox
gcloud auth application-default print-access-token

# Update gcloud
gcloud components update
```
### 捕获 gcloud, gsutil... 网络

请记住，您可以在 **`gcloud`** cli 中使用 **`--log-http`** **参数** 来 **打印** 工具正在执行的 **请求**。如果您不希望日志遮蔽令牌值，请使用 `gcloud config set log_http_redact_token false`

此外，要拦截通信：
```bash
gcloud config set proxy/address 127.0.0.1
gcloud config set proxy/port 8080
gcloud config set proxy/type http
gcloud config set auth/disable_ssl_validation True

# If you don't want to completely disable ssl_validation use:
gcloud config set core/custom_ca_certs_file cert.pem

# Back to normal
gcloud config unset proxy/address
gcloud config unset proxy/port
gcloud config unset proxy/type
gcloud config unset auth/disable_ssl_validation
gcloud config unset core/custom_ca_certs_file
```
### 在 gcloud 中配置 OAuth 令牌

为了**使用从元数据端点窃取的服务账号 OAuth 令牌**，您只需执行以下操作：
```bash
# Via env vars
export CLOUDSDK_AUTH_ACCESS_TOKEN=<token>
gcloud projects list

# Via setup
echo "<token>" > /some/path/to/token
gcloud config set auth/access_token_file /some/path/to/token
gcloud projects list
gcloud config unset auth/access_token_file
```
## 参考资料

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS 红队专家）</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想看到您的**公司在 HackTricks 中做广告**或**下载 PDF 版本的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
