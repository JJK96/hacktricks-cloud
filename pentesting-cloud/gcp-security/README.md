# GCP Pentesting

{% hint style="success" %}
学习和练习 AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和练习 GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交 PRs 分享黑客技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库。

</details>
{% endhint %}

## 基本信息

**在开始 pentesting** 一个 **GCP** 环境之前，有一些**基本的事情你需要知道**，以帮助你理解需要做什么，如何发现错误配置以及如何利用它们。

诸如**组织**层次结构、**权限**和其他基本概念在以下内容中解释：

{% content-ref url="gcp-basic-information/" %}
[gcp-basic-information](gcp-basic-information/)
{% endcontent-ref %}

## 学习实验室

* [https://gcpgoat.joshuajebaraj.com/](https://gcpgoat.joshuajebaraj.com/)
* [https://github.com/ine-labs/GCPGoat](https://github.com/ine-labs/GCPGoat)
* [https://github.com/lacioffi/GCP-pentest-lab/](https://github.com/lacioffi/GCP-pentest-lab/)
* [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)

## GCP Pentester/Red Team 方法论

为了审计一个 GCP 环境，了解哪些**服务正在使用**，什么**暴露**了，谁对什么有**访问权限**，以及内部 GCP 服务和**外部服务**如何连接是非常重要的。

从 Red Team 的角度来看，**攻破 GCP 环境的第一步**是设法获取一些**凭证**。这里有一些方法：

* github（或类似）上的**泄漏** - OSINT
* **社会**工程（查看页面 [**Workspace Security**](../workspace-security/)）
* **密码**重用（密码泄漏）
* GCP 托管应用程序中的漏洞
* [**服务器端请求伪造**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) 访问元数据端点
* **本地文件读取**
* `/home/USERNAME/.config/gcloud/*`
* `C:\Users\USERNAME\.config\gcloud\*`
* 第三方**泄漏**
* **内部**员工

或者通过**攻破暴露的未认证服务**：

{% content-ref url="gcp-unaunthenticated-enum-and-access/" %}
[gcp-unaunthenticated-enum-and-access](gcp-unaunthenticated-enum-and-access/)
{% endcontent-ref %}

或者如果你在进行**审查**，你可以**请求这些角色的凭证**：

{% content-ref url="gcp-permissions-for-a-pentest.md" %}
[gcp-permissions-for-a-pentest.md](gcp-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
在你设法获取凭证后，你需要知道**这些凭证属于谁**，以及**他们有访问权限**，所以你需要进行一些基本的枚举：
{% endhint %}

## 基本枚举

### **SSRF**

有关如何**枚举 GCP 元数据**的更多信息，请查看以下 hacktricks 页面：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Whoami

在 GCP 中，你可以尝试几种方法来猜测你是谁：

{% code overflow="wrap" %}
```bash
#If you are inside a compromise machine
gcloud auth list
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=$(gcloud auth print-access-token)" https://www.googleapis.com/oauth2/v1/tokeninfo
gcloud auth print-identity-token #Get info from the token

#If you compromised a metadata token or somehow found an OAuth token
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=<token>" https://www.googleapis.com/oauth2/v1/tokeninfo
```
{% endcode %}

### 组织枚举
```bash
# Get organizations
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud resource-manager folders list --organization <org_number> # Get folders
gcloud projects list # Get projects
```
### Principals & IAM Enumeration

如果你有足够的权限，**检查GCP账户中每个实体的权限**将帮助你了解你和其他身份可以做什么以及如何**提升权限**。

如果你没有足够的权限来枚举IAM，你可以**窃取或暴力破解**来弄清楚。\
查看**如何进行枚举和暴力破解**在：

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

{% hint style="info" %}
现在你**有了一些关于你凭证的信息**（如果你是红队，希望你**没有被检测到**）。是时候弄清楚环境中使用了哪些服务了。\
在以下部分，你可以查看一些**枚举常见服务**的方法。
{% endhint %}

## Services Enumeration

GCP有大量的服务，在以下页面中你会找到**基本信息、枚举**备忘单，如何**避免检测**，获得**持久性**，以及其他一些**后期利用**技巧：

{% content-ref url="gcp-services/" %}
[gcp-services](gcp-services/)
{% endcontent-ref %}

注意，你**不需要**全部**手动**完成工作，在这篇文章的下面你可以找到一个**关于**[**自动化工具**](./#automatic-tools)的**部分**。

此外，在这个阶段你可能会发现**更多暴露给未认证用户的服务**，你可能能够利用它们：

{% content-ref url="gcp-unaunthenticated-enum-and-access/" %}
[gcp-unaunthenticated-enum-and-access](gcp-unaunthenticated-enum-and-access/)
{% endcontent-ref %}

## Privilege Escalation, Post Exploitation & Persistence

一旦你获得了一些云凭证或入侵了一些在云中运行的服务，最常见的方法是**滥用被入侵账户可能拥有的错误配置的权限**。所以，你首先应该做的是枚举你的权限。

此外，在这个枚举过程中，记住**权限可以设置在“组织”的最高级别**。

{% content-ref url="gcp-privilege-escalation/" %}
[gcp-privilege-escalation](gcp-privilege-escalation/)
{% endcontent-ref %}

{% content-ref url="gcp-post-exploitation/" %}
[gcp-post-exploitation](gcp-post-exploitation/)
{% endcontent-ref %}

{% content-ref url="gcp-persistence/" %}
[gcp-persistence](gcp-persistence/)
{% endcontent-ref %}

### Publicly Exposed Services

在枚举GCP服务时，你可能会发现一些**将元素暴露给互联网**的服务（VM/容器端口、数据库或队列服务、快照或存储桶...）。\
作为渗透测试员/红队成员，你应该始终检查是否能在这些服务中找到**敏感信息/漏洞**，因为它们可能为你提供**进一步访问AWS账户**的途径。

在这本书中，你应该找到**关于如何发现暴露的GCP服务以及如何检查它们**的信息。关于如何在暴露的网络服务中找到**漏洞**，我建议你**搜索**特定的**服务**在：

{% embed url="https://book.hacktricks.xyz/" %}

## GCP <--> Workspace Pivoting

**入侵**一个平台中的**主体**可能允许攻击者**入侵另一个平台**，查看：

{% content-ref url="gcp-to-workspace-pivoting/" %}
[gcp-to-workspace-pivoting](gcp-to-workspace-pivoting/)
{% endcontent-ref %}

## Automatic Tools

* 在**GCloud控制台**，在[https://console.cloud.google.com/iam-admin/asset-inventory/dashboard](https://console.cloud.google.com/iam-admin/asset-inventory/dashboard)你可以看到项目使用的资源和IAM。
* 这里你可以看到这个API支持的资产：[https://cloud.google.com/asset-inventory/docs/supported-asset-types](https://cloud.google.com/asset-inventory/docs/supported-asset-types)
* 查看**可以在多个云中使用的工具**[**在这里**](../pentesting-cloud-methodology.md)。
* [**gcp\_scanner**](https://github.com/google/gcp\_scanner)：这是一个GCP资源扫描器，可以帮助确定某些凭证在GCP上的**访问级别**。
```bash
# Install
git clone https://github.com/google/gcp_scanner.git
cd gcp_scanner
virtualenv -p python3 venv
source venv/bin/activate
pip install -r requirements.txt
# Execute with gcloud creds
python3 __main__.py -o /tmp/output/ -g "$HOME/.config/gcloud"
```
* [**gcp\_enum**](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_enum): 使用 gcloud cli 枚举 GCP 环境并将结果保存到文件中的 Bash 脚本。
* [**GCP-IAM-Privilege-Escalation**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation): 枚举高 IAM 权限并在 GCP 中滥用它们以提升权限的脚本（我无法运行枚举脚本）。
* [**BF My GCP Permissions**](https://github.com/carlospolop/bf\_my\_gcp\_permissions): 暴力破解你的权限的脚本。

## gcloud config & debug
```bash
# Login so gcloud can use your credentials
gcloud auth login
gcloud config set project security-devbox
gcloud auth print-access-token

# Login so SDKs can use your user credentials
gcloud auth application-default login
gcloud auth application-default set-quota-project security-devbox
gcloud auth application-default print-access-token

# Update gcloud
gcloud components update
```
### 捕获 gcloud, gsutil... 网络

记住你可以使用 **参数** **`--log-http`** 与 **`gcloud`** cli 一起 **打印** 工具正在执行的 **请求**。如果你不希望日志编辑 token 值，使用 `gcloud config set log_http_redact_token false`

此外，要拦截通信：
```bash
gcloud config set proxy/address 127.0.0.1
gcloud config set proxy/port 8080
gcloud config set proxy/type http
gcloud config set auth/disable_ssl_validation True

# If you don't want to completely disable ssl_validation use:
gcloud config set core/custom_ca_certs_file cert.pem

# Back to normal
gcloud config unset proxy/address
gcloud config unset proxy/port
gcloud config unset proxy/type
gcloud config unset auth/disable_ssl_validation
gcloud config unset core/custom_ca_certs_file
```
### OAuth token configure in gcloud

为了**使用从元数据端点泄露的服务账户OAuth令牌**，你可以这样做：
```bash
# Via env vars
export CLOUDSDK_AUTH_ACCESS_TOKEN=<token>
gcloud projects list

# Via setup
echo "<token>" > /some/path/to/token
gcloud config set auth/access_token_file /some/path/to/token
gcloud projects list
gcloud config unset auth/access_token_file
```
## 参考资料

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
学习和练习 AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和练习 GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交 PRs 分享 hacking 技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库。

</details>
{% endhint %}
