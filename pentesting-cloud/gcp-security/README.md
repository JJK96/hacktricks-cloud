# GCP Pentesting

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) **bizi takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## Temel Bilgiler

**GCP ortamında pentesting yapmaya başlamadan önce**, nasıl çalıştığını anlamanıza yardımcı olacak birkaç **temel şeyi bilmeniz gerekir**. Bu, yanlış yapılandırmaları nasıl bulacağınızı ve bunlardan nasıl yararlanacağınızı anlamanıza yardımcı olacaktır.

**Organizasyon** hiyerarşisi, **izinler** ve diğer temel kavramlar gibi kavramlar şu belgede açıklanmıştır:

{% content-ref url="gcp-basic-information/" %}
[gcp-basic-information](gcp-basic-information/)
{% endcontent-ref %}

## Öğrenmek için Laboratuvarlar

* [https://gcpgoat.joshuajebaraj.com/](https://gcpgoat.joshuajebaraj.com/)
* [https://github.com/ine-labs/GCPGoat](https://github.com/ine-labs/GCPGoat)
* [https://github.com/lacioffi/GCP-pentest-lab/](https://github.com/lacioffi/GCP-pentest-lab/)
* [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)

## GCP Pentester/Red Team Metodolojisi

Bir GCP ortamını denetlemek için hangi **hizmetlerin kullanıldığını**, neyin **açıkta olduğunu**, kimin neye **erişimi** olduğunu ve iç GCP hizmetlerinin **dış hizmetlerle** nasıl bağlantılı olduğunu bilmek çok önemlidir.

Red Team bakış açısından, bir GCP ortamını **ele geçirmenin ilk adımı** bazı **kimlik bilgilerini** elde etmektir. İşte bunu yapmanın bazı yolları:

* github (veya benzeri) **Leaks** - OSINT
* **Sosyal** Mühendislik (Sayfayı kontrol edin [**Workspace Security**](../workspace-security/))
* **Şifre** yeniden kullanımı (şifre sızıntıları)
* GCP'de barındırılan uygulamalardaki güvenlik açıkları
* [**Server Side Request Forgery**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) ile metadata endpoint'e erişim
* **Yerel Dosya Okuma**
* `/home/USERNAME/.config/gcloud/*`
* `C:\Users\USERNAME\.config\gcloud\*`
* 3. tarafların **ihlal edilmesi**
* **İç** Çalışan

Veya **açıkta olan kimlik doğrulaması yapılmamış bir hizmeti** ele geçirerek:

{% content-ref url="gcp-unaunthenticated-enum-and-access/" %}
[gcp-unaunthenticated-enum-and-access](gcp-unaunthenticated-enum-and-access/)
{% endcontent-ref %}

Veya bir **inceleme** yapıyorsanız, bu rollere sahip **kimlik bilgilerini** isteyebilirsiniz:

{% content-ref url="gcp-permissions-for-a-pentest.md" %}
[gcp-permissions-for-a-pentest.md](gcp-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
Kimlik bilgilerini elde ettikten sonra, bu kimlik bilgilerinin **kime ait olduğunu** ve **neye erişimleri olduğunu** bilmeniz gerekir, bu yüzden bazı temel enumarasyonlar yapmanız gerekir:
{% endhint %}

## Temel Enumarasyon

### **SSRF**

GCP metadata'sını **enumere etmek** hakkında daha fazla bilgi için aşağıdaki hacktricks sayfasını kontrol edin:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Whoami

GCP'de kim olduğunuzu tahmin etmek için birkaç seçeneği deneyebilirsiniz:

{% code overflow="wrap" %}
```bash
#If you are inside a compromise machine
gcloud auth list
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=$(gcloud auth print-access-token)" https://www.googleapis.com/oauth2/v1/tokeninfo
gcloud auth print-identity-token #Get info from the token

#If you compromised a metadata token or somehow found an OAuth token
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=<token>" https://www.googleapis.com/oauth2/v1/tokeninfo
```
{% endcode %}

### Org Enumeration

### Org Enumeration

GCP'de bir organizasyonun varlıklarını ve yapılandırmalarını keşfetmek, pentesting sürecinin önemli bir parçasıdır. Bu süreç, organizasyonun güvenlik duruşunu anlamak ve potansiyel zayıflıkları belirlemek için gereklidir.

#### GCP'de Organizasyonları Listeleme

GCP'de organizasyonları listelemek için `gcloud` komut satırı aracını kullanabilirsiniz:

```bash
gcloud organizations list
```

Bu komut, erişiminiz olan tüm organizasyonları listeler.

#### Projeleri Listeleme

Bir organizasyon içindeki projeleri listelemek için aşağıdaki komutu kullanabilirsiniz:

```bash
gcloud projects list --filter="parent.id=ORGANIZATION_ID"
```

Bu komut, belirli bir organizasyon kimliği (ORGANIZATION_ID) ile ilişkili tüm projeleri listeler.

#### IAM Rolleri ve Üyeleri Listeleme

Bir organizasyondaki IAM (Identity and Access Management) rollerini ve üyelerini listelemek için şu komutu kullanabilirsiniz:

```bash
gcloud iam roles list --organization=ORGANIZATION_ID
```

Bu komut, belirli bir organizasyon kimliği (ORGANIZATION_ID) ile ilişkili tüm IAM rollerini listeler.

### IAM Rolleri ve İzinleri

IAM rolleri ve izinleri, GCP'deki kaynaklara kimlerin erişebileceğini ve bu kaynaklarla neler yapabileceklerini belirler. IAM politikalarını anlamak, pentesting sürecinde kritik bir adımdır.

#### IAM Politikalarını Görüntüleme

Bir projenin IAM politikasını görüntülemek için şu komutu kullanabilirsiniz:

```bash
gcloud projects get-iam-policy PROJECT_ID
```

Bu komut, belirli bir proje kimliği (PROJECT_ID) ile ilişkili IAM politikasını döndürür.

#### IAM Rolleri ve İzinlerini Analiz Etme

IAM rolleri ve izinlerini analiz etmek, hangi kullanıcıların hangi kaynaklara erişimi olduğunu anlamak için önemlidir. Bu analiz, potansiyel güvenlik açıklarını belirlemenize yardımcı olabilir.

### Sonuç

GCP'de org enumeration, pentesting sürecinin kritik bir parçasıdır. Organizasyonları, projeleri ve IAM rollerini listelemek, güvenlik duruşunu anlamak ve potansiyel zayıflıkları belirlemek için gereklidir. Bu bilgiler, pentesting sürecinde daha derinlemesine analizler yapmanıza ve güvenlik açıklarını etkili bir şekilde bulmanıza yardımcı olacaktır.
```bash
# Get organizations
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud resource-manager folders list --organization <org_number> # Get folders
gcloud projects list # Get projects
```
### Principals & IAM Enumeration

Eğer yeterli izinlere sahipseniz, **GCP hesabındaki her bir varlığın ayrıcalıklarını kontrol etmek**, sizin ve diğer kimliklerin neler yapabileceğini ve nasıl **ayrıcalıkları yükseltebileceğinizi** anlamanıza yardımcı olacaktır.

Eğer IAM'i numaralandırmak için yeterli izinlere sahip değilseniz, bunları **brute-force ile çalabilirsiniz**.\
**Numaralandırma ve brute-forcing nasıl yapılır** kontrol edin:

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

{% hint style="info" %}
Artık **kimlik bilgileriniz hakkında bazı bilgilere sahipsiniz** (ve eğer bir red team iseniz umarım **tespit edilmediniz**). Ortamda hangi hizmetlerin kullanıldığını anlamanın zamanı geldi.\
Aşağıdaki bölümde **bazı yaygın hizmetleri numaralandırmanın** yollarını kontrol edebilirsiniz.
{% endhint %}

## Services Enumeration

GCP'nin şaşırtıcı miktarda hizmeti vardır, aşağıdaki sayfada **temel bilgiler, numaralandırma** hile sayfaları, **tespitten kaçınma**, **kalıcılık** elde etme ve bazıları hakkında diğer **post-exploitation** hilelerini bulacaksınız:

{% content-ref url="gcp-services/" %}
[gcp-services](gcp-services/)
{% endcontent-ref %}

Tüm işleri **manuel olarak** yapmanız gerekmediğini unutmayın, bu gönderinin aşağısında **otomatik araçlar hakkında** bir **bölüm** bulabilirsiniz.

Ayrıca, bu aşamada **kimliği doğrulanmamış kullanıcılara maruz kalan daha fazla hizmet keşfetmiş olabilirsiniz**, bunları istismar edebilirsiniz:

{% content-ref url="gcp-unaunthenticated-enum-and-access/" %}
[gcp-unaunthenticated-enum-and-access](gcp-unaunthenticated-enum-and-access/)
{% endcontent-ref %}

## Privilege Escalation, Post Exploitation & Persistence

Bazı bulut kimlik bilgilerini elde ettiğinizde veya bulut içinde çalışan bir hizmeti ele geçirdiğinizde en yaygın yol, ele geçirilen hesabın sahip olabileceği **yanlış yapılandırılmış ayrıcalıkları kötüye kullanmaktır**. Bu yüzden yapmanız gereken ilk şey, ayrıcalıklarınızı numaralandırmaktır.

Ayrıca, bu numaralandırma sırasında, **izinlerin "Organization" seviyesinin en üstünde ayarlanabileceğini** unutmayın.

{% content-ref url="gcp-privilege-escalation/" %}
[gcp-privilege-escalation](gcp-privilege-escalation/)
{% endcontent-ref %}

{% content-ref url="gcp-post-exploitation/" %}
[gcp-post-exploitation](gcp-post-exploitation/)
{% endcontent-ref %}

{% content-ref url="gcp-persistence/" %}
[gcp-persistence](gcp-persistence/)
{% endcontent-ref %}

### Publicly Exposed Services

GCP hizmetlerini numaralandırırken bazılarını **İnternete maruz bırakan öğeler** (VM/Konteyner portları, veritabanları veya kuyruk hizmetleri, anlık görüntüler veya kovalar...) bulmuş olabilirsiniz.\
Bir pentester/red teamer olarak her zaman **hassas bilgi / güvenlik açıkları** bulup bulamayacağınızı kontrol etmelisiniz çünkü bunlar size **AWS hesabına daha fazla erişim sağlayabilir**.

Bu kitapta **maruz kalan GCP hizmetlerini nasıl bulacağınız ve nasıl kontrol edeceğiniz** hakkında **bilgi** bulmalısınız. Maruz kalan ağ hizmetlerinde **güvenlik açıklarını nasıl bulacağınız** hakkında, belirli **hizmeti** **araştırmanızı** tavsiye ederim:

{% embed url="https://book.hacktricks.xyz/" %}

## GCP <--> Workspace Pivoting

**Bir** platformdaki kimlikleri **ele geçirmek**, bir saldırganın **diğerini ele geçirmesine** izin verebilir, bunu kontrol edin:

{% content-ref url="gcp-to-workspace-pivoting/" %}
[gcp-to-workspace-pivoting](gcp-to-workspace-pivoting/)
{% endcontent-ref %}

## Automatic Tools

* **GCloud konsolunda**, [https://console.cloud.google.com/iam-admin/asset-inventory/dashboard](https://console.cloud.google.com/iam-admin/asset-inventory/dashboard) adresinde proje tarafından kullanılan kaynakları ve IAM'leri görebilirsiniz.
* Bu API tarafından desteklenen varlıkları burada görebilirsiniz: [https://cloud.google.com/asset-inventory/docs/supported-asset-types](https://cloud.google.com/asset-inventory/docs/supported-asset-types)
* **Birden fazla bulutta kullanılabilecek araçları** [**burada kontrol edin**](../pentesting-cloud-methodology.md).
* [**gcp\_scanner**](https://github.com/google/gcp\_scanner): Bu, GCP'de belirli kimlik bilgilerine sahip erişim seviyesini belirlemeye yardımcı olabilecek bir GCP kaynak tarayıcısıdır.
```bash
# Install
git clone https://github.com/google/gcp_scanner.git
cd gcp_scanner
virtualenv -p python3 venv
source venv/bin/activate
pip install -r requirements.txt
# Execute with gcloud creds
python3 __main__.py -o /tmp/output/ -g "$HOME/.config/gcloud"
```
* [**gcp\_enum**](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_enum): gcloud cli kullanarak bir GCP ortamını listelemek ve sonuçları bir dosyada kaydetmek için Bash betiği.
* [**GCP-IAM-Privilege-Escalation**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation): Yüksek IAM ayrıcalıklarını listelemek ve bunları kötüye kullanarak GCP'de ayrıcalıkları yükseltmek için betikler (listeleme betiğini çalıştıramadım).
* [**BF My GCP Permissions**](https://github.com/carlospolop/bf\_my\_gcp\_permissions): İzinlerinizi brute force ile test etmek için betik.

## gcloud config & debug
```bash
# Login so gcloud can use your credentials
gcloud auth login
gcloud config set project security-devbox
gcloud auth print-access-token

# Login so SDKs can use your user credentials
gcloud auth application-default login
gcloud auth application-default set-quota-project security-devbox
gcloud auth application-default print-access-token

# Update gcloud
gcloud components update
```
### gcloud, gsutil... ağını yakalama

**`gcloud`** cli ile **istekleri** **yazdırmak** için **`--log-http`** **parametresini** kullanabileceğinizi unutmayın. Günlüklerin token değerini sansürlemesini istemiyorsanız `gcloud config set log_http_redact_token false` kullanın.

Ayrıca, iletişimi kesmek için:
```bash
gcloud config set proxy/address 127.0.0.1
gcloud config set proxy/port 8080
gcloud config set proxy/type http
gcloud config set auth/disable_ssl_validation True

# If you don't want to completely disable ssl_validation use:
gcloud config set core/custom_ca_certs_file cert.pem

# Back to normal
gcloud config unset proxy/address
gcloud config unset proxy/port
gcloud config unset proxy/type
gcloud config unset auth/disable_ssl_validation
gcloud config unset core/custom_ca_certs_file
```
### OAuth token'ı gcloud'da yapılandırma

**Metadata endpoint'inden sızdırılmış bir service account OAuth token'ını kullanmak** için sadece şunu yapabilirsiniz:
```bash
# Via env vars
export CLOUDSDK_AUTH_ACCESS_TOKEN=<token>
gcloud projects list

# Via setup
echo "<token>" > /some/path/to/token
gcloud config set auth/access_token_file /some/path/to/token
gcloud projects list
gcloud config unset auth/access_token_file
```
## Referanslar

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
AWS Hacking öğren & pratik yap:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğren & pratik yap: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekle</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol et!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katıl veya bizi **Twitter**'da takip et 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek hacking ipuçlarını paylaş.

</details>
{% endhint %}
