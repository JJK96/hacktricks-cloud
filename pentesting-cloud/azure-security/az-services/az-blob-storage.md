# Az - Archiviazione Blob

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team AWS di HackTricks)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>

## Informazioni di Base

[Dalla documentazione:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage √® la soluzione di **archiviazione di oggetti di Microsoft per il cloud**. Blob storage √® ottimizzato per archiviare grandi quantit√† di dati non strutturati. I dati non strutturati sono dati che non seguono un particolare modello o definizione di dati, come testo o dati binari.

Blob storage offre tre tipi di risorse:

* Il **account di archiviazione** (nome univoco)
* Un **contenitore** nell'account di archiviazione (cartella)
* Un **blob** in un contenitore

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Diversi tipi di archiviazione

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Accesso all'Archiviazione <a href="#about-blob-storage" id="about-blob-storage"></a>

* Utilizzare i principali di Azure AD tramite ruoli **RBAC** supportati.
* **Chiavi di accesso**: Utilizzare le chiavi di accesso dell'account di archiviazione. Questo fornisce **accesso completo all'account di archiviazione**.
* **Firma di accesso condiviso** (SAS): **Limitata nel tempo** e con permessi specifici.
* √à possibile generare un URL SAS con una **chiave di accesso** (pi√π complicato da rilevare).
* Poich√© il SAS √® generato dalla chiave di accesso, se viene rinnovato il SAS smette di funzionare.

### Esposizione Pubblica

Se "Consenti accesso pubblico al blob" √® **abilitato** (disabilitato per impostazione predefinita), √® possibile:

* Dare **accesso pubblico per leggere i blob** (√® necessario conoscere il nome).
* **Elenca i blob del contenitore** e **leggerli**.

### Connessione all'Archiviazione

Se trovi qualsiasi **archiviazione** a cui puoi connetterti, potresti utilizzare lo strumento [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) per farlo.

## URL SAS

[Dalla documentazione:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Una firma di accesso condiviso (SAS) fornisce un accesso delegato sicuro alle risorse nel tuo account di archiviazione. Con un SAS, hai un controllo dettagliato su come un client pu√≤ accedere ai tuoi dati. Ad esempio:

* A quali risorse il client pu√≤ accedere.
* Quali autorizzazioni hanno su tali risorse.
* Per quanto tempo il SAS √® valido.

Un URL SAS appare cos√¨: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Utilizza [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) per accedere ai dati o python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### SAS di delega utente <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Puoi **proteggere un token di firma di accesso condiviso (SAS)** per accedere a un contenitore, una directory o un blob utilizzando sia le **credenziali di Azure Active Directory (Azure AD)** che una chiave dell'account. Per creare una SAS di delega utente, devi prima richiedere una **chiave di delega utente**, che verr√† poi utilizzata per firmare la SAS.

Il supporto √® fornito per una **Firma di Accesso Condiviso (SAS) con Delega Utente** sia in **Azure Blob Storage** che in **Azure Data Lake Storage Gen2**. Tuttavia, √® importante notare che le **Policy di Accesso Memorizzate** non sono compatibili con una SAS di delega utente.

Si noti che la SAS di delega utente √® **protetta con le credenziali di Azure AD anzich√© con le chiavi dell'account di archiviazione**. Ci√≤ impedisce ai clienti/applicazioni di memorizzare/recuperare le chiavi di archiviazione per creare SAS.

### SAS di servizio

Una SAS di servizio √® protetta con la **chiave dell'account di archiviazione**. Una SAS di servizio **delega l'accesso a una risorsa in uno solo** dei servizi di archiviazione di Azure: archiviazione di blob, archiviazione di code, archiviazione di tabelle o file di Azure. L'URI per una SAS a livello di servizio consiste dell'URI alla risorsa per la quale la SAS delega l'accesso, seguito dal token SAS.

Per utilizzare le credenziali di Azure Active Directory (Azure AD) per proteggere una SAS per un **contenitore** o un **blob**, utilizzare una **SAS di delega utente**.

### SAS di account

Una SAS di account √® protetta con una delle **chiavi dell'account di archiviazione** (ce ne sono 2). Una SAS di account delega l'accesso alle risorse in uno o pi√π dei servizi di archiviazione. Tutte le operazioni disponibili tramite una SAS di servizio o di delega utente sono disponibili anche tramite una SAS di account.

[dalla documentazione:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Creando una SAS di account, puoi:

* Delegare l'accesso a operazioni a livello di servizio attualmente non disponibili con una SAS specifica del servizio, come le operazioni `Get/Set Service Properties` e `Get Service Stats`.
* Delegare l'accesso a pi√π di un servizio in un account di archiviazione contemporaneamente. Ad esempio, puoi delegare l'accesso alle risorse sia in Azure Blob Storage che in Azure Files utilizzando una SAS di account.
* Delegare l'accesso alle operazioni di scrittura ed eliminazione per contenitori, code, tabelle e condivisioni di file, che non sono disponibili con una SAS specifica dell'oggetto.
* Specificare un indirizzo IP o un intervallo di indirizzi IP da cui accettare le richieste.
* Specificare il protocollo HTTP da cui accettare le richieste (sia HTTPS che HTTP/HTTPS).

## Enumerazione

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Riferimenti

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>Impara l'hacking su AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team di HackTricks su AWS)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se desideri vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e ai repository github di [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
