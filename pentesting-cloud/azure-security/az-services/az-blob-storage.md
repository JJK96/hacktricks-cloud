# Az - Blob Storage

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Βασικές Πληροφορίες

[Από τα έγγραφα:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Το Azure Blob storage είναι η λύση αποθήκευσης αντικειμένων της Microsoft για το cloud. Το Blob storage είναι βελτιστοποιημένο για την αποθήκευση τεράστιων ποσοτήτων μη δομημένων δεδομένων. Μη δομημένα δεδομένα είναι δεδομένα που δεν ακολουθούν ένα συγκεκριμένο μοντέλο δεδομένων ή ορισμό, όπως κείμενο ή δυαδικά δεδομένα.

Το Blob storage προσφέρει τρεις τύπους πόρων:

* Ο **λογαριασμός αποθήκευσης** (μοναδικό όνομα)
* Ένα **container** στον λογαριασμό αποθήκευσης (φάκελος)
* Ένα **blob** σε ένα container

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Διαφορετικοί τύποι αποθήκευσης

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Πρόσβαση στην Αποθήκευση <a href="#about-blob-storage" id="about-blob-storage"></a>

* Χρησιμοποιήστε Azure AD principals μέσω **RBAC roles** που υποστηρίζονται.
* **Access Keys**: Χρησιμοποιήστε access keys του λογαριασμού αποθήκευσης. Αυτό παρέχει **πλήρη πρόσβαση στον λογαριασμό αποθήκευσης.**
* **Shared Access Signature** (SAS): **Χρονικά** **περιορισμένη** και συγκεκριμένες άδειες.
* Μπορείτε να δημιουργήσετε ένα SAS url με ένα **access key** (πιο δύσκολο να ανιχνευτεί).
* Καθώς το SAS δημιουργείται από το access key, αν ανανεωθεί το access key, το SAS σταματά να λειτουργεί.

### Δημόσια Έκθεση

Αν το "Allow Blob public access" είναι **ενεργοποιημένο** (απενεργοποιημένο από προεπιλογή), είναι δυνατό να:

* Δώσετε **δημόσια πρόσβαση για ανάγνωση blobs** (πρέπει να γνωρίζετε το όνομα).
* **Λίστα container blobs** και **ανάγνωση** αυτών.

### Σύνδεση στην Αποθήκευση

Αν βρείτε οποιαδήποτε **αποθήκευση** στην οποία μπορείτε να συνδεθείτε, μπορείτε να χρησιμοποιήσετε το εργαλείο [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) για να το κάνετε.

## SAS URLs

[Από τα έγγραφα:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Ένα shared access signature (SAS) παρέχει ασφαλή εξουσιοδοτημένη πρόσβαση σε πόρους στον λογαριασμό αποθήκευσής σας. Με ένα SAS, έχετε λεπτομερή έλεγχο για το πώς ένας πελάτης μπορεί να έχει πρόσβαση στα δεδομένα σας. Για παράδειγμα:

* Ποιους πόρους μπορεί να έχει πρόσβαση ο πελάτης.
* Τι άδειες έχουν για αυτούς τους πόρους.
* Πόσο καιρό είναι έγκυρο το SAS.

Ένα SAS URL μοιάζει με αυτό: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Χρησιμοποιήστε [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) για να έχετε πρόσβαση στα δεδομένα ή python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Μπορείτε να **ασφαλίσετε ένα shared access signature (SAS)** token για πρόσβαση σε ένα container, directory, ή blob χρησιμοποιώντας είτε Azure Active Directory (Azure AD) **credentials ή ένα account key**. Για να δημιουργήσετε ένα user delegation SAS, πρέπει πρώτα να ζητήσετε ένα **user delegation key**, το οποίο στη συνέχεια χρησιμοποιείτε για να υπογράψετε το SAS.

Υποστηρίζεται ένα **User Delegation Shared Access Signature (SAS)** τόσο στο **Azure Blob Storage** όσο και στο **Azure Data Lake Storage Gen2**. Ωστόσο, είναι σημαντικό να σημειωθεί ότι οι **Stored Access Policies** δεν είναι συμβατές με ένα User Delegation SAS.

Σημειώστε ότι το user delegation SAS είναι **ασφαλισμένο με Azure AD credentials αντί για storage account keys**. Αυτό αποτρέπει τους πελάτες/εφαρμογές από το να αποθηκεύουν/ανακτούν storage keys για να δημιουργήσουν SAS.

### Service SAS

Ένα service SAS είναι ασφαλισμένο με το **storage account key**. Ένα service SAS **αναθέτει πρόσβαση σε έναν πόρο σε μόνο μία** από τις υπηρεσίες Azure Storage: Blob storage, Queue storage, Table storage, ή Azure Files. Το URI για ένα service-level SAS αποτελείται από το URI προς τον πόρο για τον οποίο το SAS θα αναθέσει πρόσβαση, ακολουθούμενο από το SAS token.

Για να χρησιμοποιήσετε Azure Active Directory (Azure AD) credentials για να ασφαλίσετε ένα SAS για ένα **container** ή **blob**, χρησιμοποιήστε ένα **user delegation SAS**.

### Account SAS

Ένα account SAS είναι ασφαλισμένο με ένα από τα **storage account keys** (υπάρχουν 2). Ένα account SAS αναθέτει πρόσβαση σε πόρους σε μία ή περισσότερες από τις υπηρεσίες αποθήκευσης. Όλες οι λειτουργίες που είναι διαθέσιμες μέσω ενός service ή user delegation SAS είναι επίσης διαθέσιμες μέσω ενός account SAS.

[από τα docs:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Δημιουργώντας ένα account SAS, μπορείτε:

* Να αναθέσετε πρόσβαση σε λειτουργίες σε επίπεδο υπηρεσίας που δεν είναι επί του παρόντος διαθέσιμες με ένα service-specific SAS, όπως οι λειτουργίες `Get/Set Service Properties` και `Get Service Stats`.
* Να αναθέσετε πρόσβαση σε περισσότερες από μία υπηρεσίες σε έναν λογαριασμό αποθήκευσης ταυτόχρονα. Για παράδειγμα, μπορείτε να αναθέσετε πρόσβαση σε πόρους τόσο στο Azure Blob Storage όσο και στο Azure Files χρησιμοποιώντας ένα account SAS.
* Να αναθέσετε πρόσβαση σε λειτουργίες εγγραφής και διαγραφής για containers, queues, tables, και file shares, οι οποίες δεν είναι διαθέσιμες με ένα object-specific SAS.
* Να καθορίσετε μια διεύθυνση IP ή ένα εύρος διευθύνσεων IP από τις οποίες θα γίνονται δεκτά αιτήματα.
* Να καθορίσετε το πρωτόκολλο HTTP από το οποίο θα γίνονται δεκτά αιτήματα (είτε HTTPS είτε HTTP/HTTPS).

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Αναφορές

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
