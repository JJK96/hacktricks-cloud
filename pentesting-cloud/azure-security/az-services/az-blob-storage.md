# Az - Blob Storage

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów na GitHubie.

</details>

## Podstawowe informacje

[Z dokumentacji:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage to rozwiązanie **przechowywania obiektów firmy Microsoft dla chmury**. Blob storage jest zoptymalizowany do przechowywania ogromnych ilości danych niestrukturyzowanych. Dane niestrukturyzowane to dane, które nie podlegają określonemu modelowi danych ani definicji, takie jak dane tekstowe lub binarne.

Blob storage oferuje trzy rodzaje zasobów:

* **Konto przechowywania** (unikalna nazwa)
* **Kontener** w koncie przechowywania (folder)
* **Blob** w kontenerze

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Różne rodzaje przechowywania

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Dostęp do przechowywania <a href="#about-blob-storage" id="about-blob-storage"></a>

* Użyj podmiotów Azure AD za pomocą obsługiwanych ról **RBAC**.
* **Klucze dostępu**: Użyj kluczy dostępu do konta przechowywania. Zapewnia to **pełny dostęp do konta przechowywania**.
* **Wspólny podpis dostępu** (SAS): **Ograniczony czasowo** i określone uprawnienia.
* Możesz wygenerować adres URL SAS z **kluczem dostępu** (trudniejszy do wykrycia).
* Ponieważ SAS jest generowany z klucza dostępu, jeśli zostanie odnowiony, SAS przestaje działać.

### Publiczne wystawienie

Jeśli opcja "Zezwalaj na publiczny dostęp do blobów" jest **włączona** (domyślnie wyłączona), można:

* Udzielić **publicznego dostępu do odczytu blobów** (musisz znać nazwę).
* **Wyświetlić bloby kontenera** i **odczytać** je.

### Połączenie z przechowywaniem

Jeśli znajdziesz jakieś **przechowywanie**, do którego możesz się podłączyć, możesz użyć narzędzia [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) do tego celu.

## Adresy URL SAS

[Z dokumentacji:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Wspólny podpis dostępu (SAS) zapewnia bezpieczny udzielony dostęp do zasobów w twoim koncie przechowywania. Dzięki SAS masz szczegółową kontrolę nad tym, w jaki sposób klient może uzyskać dostęp do Twoich danych. Na przykład:

* Do jakich zasobów klient może uzyskać dostęp.
* Jakie uprawnienia mają do tych zasobów.
* Jak długo jest ważny SAS.

Adres URL SAS wygląda tak: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Użyj [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) do dostępu do danych lub python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### Delegacja SAS użytkownika <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Możesz **zabezpieczyć token udostępnionego podpisu dostępu (SAS)** do kontenera, katalogu lub bloba, korzystając zarówno z **poświadczeń Azure Active Directory (Azure AD), jak i klucza konta**. Aby utworzyć delegowanego SAS użytkownika, musisz najpierw poprosić o **klucz delegacji użytkownika**, który następnie używasz do podpisania SAS.

Obsługa **Delegowanego Udostępnionego Podpisu Dostępu (SAS)** jest dostępna zarówno w **Azure Blob Storage**, jak i w **Azure Data Lake Storage Gen2**. Jednak ważne jest zauważenie, że **Zachowane Polityki Dostępu** nie są kompatybilne z Delegowanym SAS użytkownika.

Należy zauważyć, że delegowany SAS użytkownika jest **zabezpieczony za pomocą poświadczeń Azure AD zamiast kluczy konta magazynu**. Zapobiega to klientom/aplikacjom przechowywanie/pobieranie kluczy magazynu w celu utworzenia SAS.

### SAS usługi

SAS usługi jest zabezpieczony za pomocą **klucza konta magazynu**. SAS usługi **deleguje dostęp do zasobu tylko w jednej** z usług Azure Storage: magazyn Blob, magazyn kolejek, magazyn tabel lub pliki Azure. Adres URI dla SAS na poziomie usługi składa się z adresu URI do zasobu, dla którego SAS będzie delegował dostęp, a następnie z tokena SAS.

Aby użyć poświadczeń Azure Active Directory (Azure AD) do zabezpieczenia SAS dla **kontenera** lub **bloba**, użyj **delegowanego SAS użytkownika**.

### SAS konta

SAS konta jest zabezpieczony za pomocą jednego z **kluczy konta magazynu** (jest ich 2). SAS konta deleguje dostęp do zasobów w jednej lub kilku usługach magazynowych. Wszystkie operacje dostępne za pomocą SAS na poziomie usługi lub delegowanego użytkownika są również dostępne za pomocą SAS konta.

[z dokumentacji:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Tworząc SAS konta, możesz:

* Delegować dostęp do operacji na poziomie usługi, które nie są obecnie dostępne za pomocą SAS specyficznego dla usługi, takich jak operacje `Get/Set Service Properties` i `Get Service Stats`.
* Delegować dostęp do więcej niż jednej usługi w koncie magazynowym jednocześnie. Na przykład możesz delegować dostęp do zasobów zarówno w Azure Blob Storage, jak i w plikach Azure, korzystając z SAS konta.
* Delegować dostęp do operacji zapisu i usuwania dla kontenerów, kolejek, tabel i udziałów plików, które nie są dostępne za pomocą SAS specyficznego dla obiektu.
* Określić adres IP lub zakres adresów IP, z których będą akceptowane żądania.
* Określić protokół HTTP, z którego będą akceptowane żądania (HTTPS lub HTTP/HTTPS).

## Wyliczanie

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Odnośniki

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
