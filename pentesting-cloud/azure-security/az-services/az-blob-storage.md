# Az - Blob Storage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage is Microsoft's object **storage solution for the cloud**. Blob storage is optimized for storing massive amounts of unstructured data. Unstructured data is data that doesn't adhere to a particular data model or definition, such as text or binary data.

Blob storage offers three types of resources:

* The **storage account** (unique name)
* A **container** in the storage account (folder)
* A **blob** in a container

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Different types of storage

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Access to Storage <a href="#about-blob-storage" id="about-blob-storage"></a>

* –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ Azure AD principals —á–µ—Ä–µ–∑ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω—ñ **RBAC —Ä–æ–ª—ñ**.
* **Access Keys**: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ access keys –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å—Ö–æ–≤–∏—â–∞. –¶–µ –Ω–∞–¥–∞—î **–ø–æ–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å—Ö–æ–≤–∏—â–∞**.
* **Shared Access Signature** (SAS): **–û–±–º–µ–∂–µ–Ω–∏–π —á–∞—Å–æ–º** —ñ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –¥–æ–∑–≤–æ–ª–∏.
* –í–∏ –º–æ–∂–µ—Ç–µ –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ SAS url –∑ **access key** (—Å–∫–ª–∞–¥–Ω—ñ—à–µ –≤–∏—è–≤–∏—Ç–∏).
* –û—Å–∫—ñ–ª—å–∫–∏ SAS –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∑ access key, —è–∫—â–æ –≤—ñ–Ω –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è, SAS –ø–µ—Ä–µ—Å—Ç–∞—î –ø—Ä–∞—Ü—é–≤–∞—Ç–∏.

### Public Exposure

–Ø–∫—â–æ "Allow Blob public access" **—É–≤—ñ–º–∫–Ω–µ–Ω–æ** (–≤–∏–º–∫–Ω–µ–Ω–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º), –º–æ–∂–ª–∏–≤–æ:

* –ù–∞–¥–∞—Ç–∏ **–ø—É–±–ª—ñ—á–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è blobs** (–ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞—Ç–∏ —ñ–º'—è).
* **–ü–µ—Ä–µ–ª—ñ—á–∏—Ç–∏ blobs –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞** —ñ **—á–∏—Ç–∞—Ç–∏** —ó—Ö.

### Connect to Storage

–Ø–∫—â–æ –≤–∏ –∑–Ω–∞–π–¥–µ—Ç–µ –±—É–¥—å-—è–∫–µ **—Å—Ö–æ–≤–∏—â–µ**, –¥–æ —è–∫–æ–≥–æ –º–æ–∂–Ω–∞ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è, –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) –¥–ª—è —Ü—å–æ–≥–æ.

## SAS URLs

[From the docs:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) A shared access signature (SAS) provides secure delegated access to resources in your storage account. With a SAS, you have granular control over how a client can access your data. For example:

* –Ø–∫—ñ —Ä–µ—Å—É—Ä—Å–∏ –∫–ª—ñ—î–Ω—Ç –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏.
* –Ø–∫—ñ –¥–æ–∑–≤–æ–ª–∏ –≤–æ–Ω–∏ –º–∞—é—Ç—å –Ω–∞ —Ü—ñ —Ä–µ—Å—É—Ä—Å–∏.
* –Ø–∫ –¥–æ–≤–≥–æ SAS —î –¥—ñ–π—Å–Ω–∏–º.

SAS URL –≤–∏–≥–ª—è–¥–∞—î —Ç–∞–∫: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –¥–∞–Ω–∏—Ö –∞–±–æ python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

–í–∏ –º–æ–∂–µ—Ç–µ **–∑–∞—Ö–∏—Å—Ç–∏—Ç–∏ –º–∞—Ä–∫–µ—Ä —Å–ø—ñ–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É (SAS)** –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –∞–±–æ –±–ª–æ–±—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –∞–±–æ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ Azure Active Directory (Azure AD), –∞–±–æ **–∫–ª—é—á –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É**. –©–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ SAS –¥–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —Å–ø–æ—á–∞—Ç–∫—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç–∏ **–∫–ª—é—á –¥–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**, —è–∫–∏–π –ø–æ—Ç—ñ–º –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –ø—ñ–¥–ø–∏—Å–∞–Ω–Ω—è SAS.

–ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –Ω–∞–¥–∞—î—Ç—å—Å—è –¥–ª—è **User Delegation Shared Access Signature (SAS)** —è–∫ —É **Azure Blob Storage**, —Ç–∞–∫ —ñ —É **Azure Data Lake Storage Gen2**. –û–¥–Ω–∞–∫ –≤–∞–∂–ª–∏–≤–æ –∑–∞–∑–Ω–∞—á–∏—Ç–∏, —â–æ **Stored Access Policies** –Ω–µ —Å—É–º—ñ—Å–Ω—ñ –∑ User Delegation SAS.

–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ SAS –¥–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ **–∑–∞—Ö–∏—â–µ–Ω–∏–π –æ–±–ª—ñ–∫–æ–≤–∏–º–∏ –¥–∞–Ω–∏–º–∏ Azure AD –∑–∞–º—ñ—Å—Ç—å –∫–ª—é—á—ñ–≤ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å—Ö–æ–≤–∏—â–∞**. –¶–µ –∑–∞–ø–æ–±—ñ–≥–∞—î –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—é/–æ—Ç—Ä–∏–º–∞–Ω–Ω—é –∫–ª—ñ—î–Ω—Ç–∞–º–∏/–¥–æ–¥–∞—Ç–∫–∞–º–∏ –∫–ª—é—á—ñ–≤ —Å—Ö–æ–≤–∏—â–∞ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è SAS.

### Service SAS

Service SAS –∑–∞—Ö–∏—â–µ–Ω–∏–π **–∫–ª—é—á–µ–º –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å—Ö–æ–≤–∏—â–∞**. Service SAS **–¥–µ–ª–µ–≥—É—î –¥–æ—Å—Ç—É–ø –¥–æ —Ä–µ—Å—É—Ä—Å—É –ª–∏—à–µ –≤ –æ–¥–Ω–æ–º—É** –∑ —Å–µ—Ä–≤—ñ—Å—ñ–≤ Azure Storage: Blob storage, Queue storage, Table storage –∞–±–æ Azure Files. URI –¥–ª—è SAS –Ω–∞ —Ä—ñ–≤–Ω—ñ —Å–µ—Ä–≤—ñ—Å—É —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ URI –¥–æ —Ä–µ—Å—É—Ä—Å—É, –¥–ª—è —è–∫–æ–≥–æ SAS –¥–µ–ª–µ–≥—É–≤–∞—Ç–∏–º–µ –¥–æ—Å—Ç—É–ø, –ø—ñ—Å–ª—è —á–æ–≥–æ –π–¥–µ –º–∞—Ä–∫–µ—Ä SAS.

–©–æ–± –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ Azure Active Directory (Azure AD) –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É SAS –¥–ª—è **–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞** –∞–±–æ **–±–ª–æ–±—É**, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ **user delegation SAS**.

### Account SAS

Account SAS –∑–∞—Ö–∏—â–µ–Ω–∏–π –æ–¥–Ω–∏–º –∑ **–∫–ª—é—á—ñ–≤ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —Å—Ö–æ–≤–∏—â–∞** (—ó—Ö —î 2). Account SAS –¥–µ–ª–µ–≥—É—î –¥–æ—Å—Ç—É–ø –¥–æ —Ä–µ—Å—É—Ä—Å—ñ–≤ –≤ –æ–¥–Ω–æ–º—É –∞–±–æ –¥–µ–∫—ñ–ª—å–∫–æ—Ö —Å–µ—Ä–≤—ñ—Å–∞—Ö —Å—Ö–æ–≤–∏—â–∞. –í—Å—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó, –¥–æ—Å—Ç—É–ø–Ω—ñ —á–µ—Ä–µ–∑ service –∞–±–æ user delegation SAS, —Ç–∞–∫–æ–∂ –¥–æ—Å—Ç—É–ø–Ω—ñ —á–µ—Ä–µ–∑ account SAS.

[–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) –°—Ç–≤–æ—Ä—é—é—á–∏ account SAS, –≤–∏ –º–æ–∂–µ—Ç–µ:

* –î–µ–ª–µ–≥—É–≤–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –æ–ø–µ—Ä–∞—Ü—ñ–π –Ω–∞ —Ä—ñ–≤–Ω—ñ —Å–µ—Ä–≤—ñ—Å—É, —è–∫—ñ –Ω–∞—Ä–∞–∑—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ –∑ service-specific SAS, —Ç–∞–∫–∏—Ö —è–∫ –æ–ø–µ—Ä–∞—Ü—ñ—ó `Get/Set Service Properties` —Ç–∞ `Get Service Stats`.
* –î–µ–ª–µ–≥—É–≤–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –±—ñ–ª—å—à–µ –Ω—ñ–∂ –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤—ñ—Å—É –≤ –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—ñ —Å—Ö–æ–≤–∏—â–∞ –æ–¥–Ω–æ—á–∞—Å–Ω–æ. –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –≤–∏ –º–æ–∂–µ—Ç–µ –¥–µ–ª–µ–≥—É–≤–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ä–µ—Å—É—Ä—Å—ñ–≤ —è–∫ —É Azure Blob Storage, —Ç–∞–∫ —ñ —É Azure Files, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ account SAS.
* –î–µ–ª–µ–≥—É–≤–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –æ–ø–µ—Ä–∞—Ü—ñ–π –∑–∞–ø–∏—Å—É —Ç–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤, —á–µ—Ä–≥, —Ç–∞–±–ª–∏—Ü—å —Ç–∞ —Ñ–∞–π–ª–æ–≤–∏—Ö —Å—Ö–æ–≤–∏—â, —è–∫—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ –∑ object-specific SAS.
* –í–∫–∞–∑–∞—Ç–∏ IP-–∞–¥—Ä–µ—Å—É –∞–±–æ –¥—ñ–∞–ø–∞–∑–æ–Ω IP-–∞–¥—Ä–µ—Å, –∑ —è–∫–∏—Ö –ø—Ä–∏–π–º–∞—Ç–∏ –∑–∞–ø–∏—Ç–∏.
* –í–∫–∞–∑–∞—Ç–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª HTTP, –∑ —è–∫–æ–≥–æ –ø—Ä–∏–π–º–∞—Ç–∏ –∑–∞–ø–∏—Ç–∏ (–∞–±–æ HTTPS, –∞–±–æ HTTP/HTTPS).

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ —É **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –ø–æ–¥–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
