# Az - Blob Storage

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>からAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

- **HackTricks で企業を宣伝**したい場合や **HackTricks をPDFでダウンロード**したい場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)** に参加するか、[telegramグループ](https://t.me/peass) に参加するか、**Twitter** 🐦 で **@hacktricks\_live** をフォローする
- **ハッキングトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリにPRを提出してください。

</details>

## 基本情報

[ドキュメントから：](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage は、Microsoft のオブジェクト **ストレージソリューション**です。Blob storage は、大量の非構造化データを保存するために最適化されています。非構造化データとは、特定のデータモデルや定義に従わないデータのことです（テキストやバイナリデータなど）。

Blob storage には、次の3種類のリソースがあります：

- **ストレージアカウント**（ユニークな名前）
- ストレージアカウント内の **コンテナ**（フォルダ）
- コンテナ内の **Blob**

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### 異なる種類のストレージ

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### ストレージへのアクセス <a href="#about-blob-storage" id="about-blob-storage"></a>

- **RBACロール**をサポートする Azure AD プリンシパルを使用します。
- **アクセスキー**：ストレージアカウントのアクセスキーを使用します。これにより、**ストレージアカウントへの完全なアクセス**が提供されます。
- **共有アクセス署名**（SAS）：**期間限定**で特定の権限を持つもの。
- **アクセスキー**を使用して SAS URL を生成できます（検出がより複雑です）。
- SAS はアクセスキーから生成されるため、更新されると SAS は機能しなくなります。

### パブリック公開

「Blob パブリックアクセスを許可」が **有効** になっている場合（デフォルトでは無効）、次のことが可能です：

- **Blob の読み取り権限を一般公開**する（名前を知る必要があります）。
- コンテナの Blob を **リスト** して **読み取る**。

### ストレージへの接続

接続できる **ストレージ** を見つけた場合は、[**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) を使用して接続できます。

## SAS URL

[ドキュメントから：](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) 共有アクセス署名（SAS）は、ストレージアカウント内のリソースへのセキュアな委任アクセスを提供します。SAS を使用すると、クライアントがデータにアクセスする方法を細かく制御できます。たとえば：

- クライアントがアクセスできるリソース。
- それらのリソースに対する権限。
- SAS の有効期間。

SAS URL は次のようになります：**`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

[**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) を使用してデータにアクセスするか、Python を使用します：

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### ユーザーデリゲーション SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

**コンテナ、ディレクトリ、またはブロブへのアクセスのために共有アクセス署名 (SAS) トークンを保護**するには、Azure Active Directory (Azure AD) **資格情報またはアカウントキー** を使用します。ユーザーデリゲーション SAS を作成するには、まず**ユーザーデリゲーションキー** をリクエストし、その後、SAS に署名するために使用します。

**Azure Blob Storage** および **Azure Data Lake Storage Gen2** の両方で **ユーザーデリゲーション共有アクセス署名 (SAS)** がサポートされています。ただし、**保存されたアクセスポリシー** はユーザーデリゲーション SAS と互換性がないことに注意してください。

ユーザーデリゲーション SAS は **ストレージアカウントキーの代わりに Azure AD 資格情報で保護**されています。これにより、クライアント/アプリケーションがストレージキーを保存/取得して SAS を作成することが防止されます。

### サービス SAS

サービス SAS は **ストレージアカウントキーで保護**されています。サービス SAS は、Azure Storage サービスのうちの**1つのリソースへのアクセスを委任**します: Blob storage、Queue storage、Table storage、または Azure Files。サービスレベルの SAS の URI は、SAS がアクセスを委任するリソースへの URI の後に続く SAS トークンで構成されます。

**コンテナ**または**ブロブ**の SAS を保護するには、Azure Active Directory (Azure AD) 資格情報を使用して**ユーザーデリゲーション SAS**を使用します。

### アカウント SAS

アカウント SAS は、**ストレージアカウントキーの1つで保護**されています (2つあります)。アカウント SAS は、1つ以上のストレージサービスのリソースへのアクセスを委任します。サービスまたはユーザーデリゲーション SAS を介して利用可能なすべての操作は、アカウント SAS を介しても利用可能です。

[ドキュメントから:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) アカウント SAS を作成することで、次のことができます:

* `Get/Set Service Properties` および `Get Service Stats` のようなサービスレベルの操作をサービス固有の SAS では現在利用できない操作に委任します。
* アカウント SAS を使用して、Azure Blob Storage と Azure Files の両方のリソースへのアクセスを委任することで、1度に複数のサービスへのアクセスを委任します。
* オブジェクト固有の SAS では利用できないコンテナ、キュー、テーブル、およびファイル共有の書き込みおよび削除操作を委任します。
* リクエストを受け入れる IP アドレスまたは IP アドレスの範囲を指定します。
* リクエストを受け入れる HTTP プロトコルを指定します (HTTPS または HTTP/HTTPS のいずれか)。

## 列挙

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## 参考文献

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>を使用して、ゼロからヒーローまでAWSハッキングを学びましょう！</summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい**、または **HackTricks をPDFでダウンロードしたい** 場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) コレクションを見つける
* **💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に参加するか、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) をフォローする。
* **ハッキングトリックを共有するために、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出する。

</details>
