# Az - Blob Storage

<details>

<summary><strong>htARTE (HackTricks AWS Red Team 전문가)로부터 AWS 해킹을 처음부터 전문가까지 배우세요!</strong></summary>

HackTricks를 지원하는 다른 방법:

- **회사가 HackTricks에 광고되길 원하거나 HackTricks를 PDF로 다운로드**하려면 [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
- [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구매하세요
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
- 💬 [**디스코드 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)를 **팔로우**하세요.
- **HackTricks** 및 **HackTricks Cloud** github 저장소에 PR을 제출하여 귀하의 해킹 기술을 공유하세요.

</details>

## 기본 정보

[문서에서:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage는 Microsoft의 클라우드를 위한 객체 **저장 솔루션**입니다. Blob storage는 대량의 비구조화 데이터를 저장하기 위해 최적화되어 있습니다. 비구조화 데이터는 텍스트 또는 이진 데이터와 같이 특정 데이터 모델이나 정의에 따르지 않는 데이터입니다.

Blob storage에는 세 가지 유형의 리소스가 있습니다:

- **저장 계정** (고유한 이름)
- 저장 계정의 **컨테이너** (폴더)
- 컨테이너 내의 **blob**

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### 다양한 저장 유형

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### 저장소 액세스 <a href="#about-blob-storage" id="about-blob-storage"></a>

- **RBAC 역할**을 통해 Azure AD 주체를 사용합니다.
- **액세스 키**: 저장 계정의 액세스 키를 사용합니다. 이는 **저장 계정에 대한 완전한 액세스**를 제공합니다.
- **공유 액세스 서명** (SAS): **시간 제한** 및 특정 권한을 제공합니다.
- **액세스 키**로 SAS URL을 생성할 수 있습니다 (탐지가 더 복잡함).
- SAS는 액세스 키에서 생성되므로 갱신되면 SAS가 작동을 중지합니다.

### 공개 노출

"Blob 공개 액세스 허용"이 **활성화**되어 있으면 (기본적으로 비활성화됨), 다음이 가능합니다:

- **Blob 읽기에 대한 공개 액세스** 부여 (이름을 알아야 함).
- 컨테이너 blob를 **목록** 및 **읽기**.

### 저장소에 연결

찾은 **저장소**에 연결할 수 있다면 [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) 도구를 사용할 수 있습니다.

## SAS URL

[문서에서:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) 공유 액세스 서명(SAS)은 저장 계정의 리소스에 대한 안전한 위임 액세스를 제공합니다. SAS를 사용하면 클라이언트가 데이터에 액세스하는 방법을 세밀하게 제어할 수 있습니다. 예를 들어:

- 클라이언트가 액세스할 수 있는 리소스
- 그 리소스에 대한 권한
- SAS의 유효 기간

SAS URL은 다음과 같습니다: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

데이터에 액세스하려면 [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/)를 사용하거나 python을 사용하세요:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### 사용자 위임 SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

**컨테이너, 디렉터리 또는 블롭에 대한 공유 액세스 서명(SAS) 토큰을 안전하게** 만들기 위해 Azure Active Directory (Azure AD) 자격 증명 또는 계정 키를 사용할 수 있습니다. 사용자 위임 SAS를 만들려면 먼저 **사용자 위임 키**를 요청해야 하며, 이 키를 사용하여 SAS에 서명해야 합니다.

**Azure Blob Storage** 및 **Azure Data Lake Storage Gen2**에서 **사용자 위임 공유 액세스 서명(SAS)**를 지원합니다. 그러나 **저장된 액세스 정책**은 사용자 위임 SAS와 호환되지 않음을 중요하게 알아야 합니다.

사용자 위임 SAS는 **저장소 계정 키 대신 Azure AD 자격 증명으로 보호**됩니다. 이로써 클라이언트/애플리케이션이 저장소 키를 저장하거나 검색하여 SAS를 만드는 것을 방지합니다.

### 서비스 SAS

서비스 SAS는 **저장소 계정 키로 보호**됩니다. 서비스 SAS는 Azure Storage 서비스 중 하나인 Blob storage, Queue storage, Table storage 또는 Azure Files 중 하나에 대한 리소스 액세스를 위임합니다. 서비스 수준 SAS의 URI는 SAS가 액세스를 위임할 리소스의 URI로 시작하여 SAS 토큰이 뒤따릅니다.

**컨테이너** 또는 **블롭**에 대한 SAS를 안전하게 하려면 Azure Active Directory (Azure AD) 자격 증명을 사용하여 **사용자 위임 SAS**를 사용하십시오.

### 계정 SAS

계정 SAS는 **저장소 계정 키(2개 중 하나)**로 보호됩니다. 계정 SAS는 하나 이상의 저장소 서비스에 대한 리소스 액세스를 위임합니다. 서비스 또는 사용자 위임 SAS를 통해 가능한 모든 작업은 계정 SAS를 통해 사용할 수 있습니다.

[문서에서:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) 계정 SAS를 만들면 다음을 수행할 수 있습니다:

* `Get/Set Service Properties` 및 `Get Service Stats`와 같은 서비스 수준 작업을 서비스별 SAS로는 현재 사용할 수 없는 작업을 위임합니다.
* 계정 SAS를 사용하여 한 번에 여러 서비스에 대한 액세스를 위임할 수 있습니다. 예를 들어 계정 SAS를 사용하여 Azure Blob Storage 및 Azure Files의 리소스에 액세스를 위임할 수 있습니다.
* 컨테이너, 대기열, 테이블 및 파일 공유에 대한 쓰기 및 삭제 작업을 위임할 수 있습니다. 이는 개체별 SAS로는 사용할 수 없습니다.
* 요청을 수락할 IP 주소 또는 IP 주소 범위를 지정할 수 있습니다.
* 요청을 수락할 HTTP 프로토콜을 지정할 수 있습니다(HTTPS 또는 HTTP/HTTPS 중 하나).
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## 참고 자료

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로부터 영웅이 될 때까지 AWS 해킹을 배우세요!</summary>

HackTricks를 지원하는 다른 방법:

* **회사가 HackTricks를 광고하거나 PDF로 다운로드하고 싶다면** [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구매하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* **💬 [**디스코드 그룹**](https://discord.gg/hRep4RUj7f)에 가입하거나 [**텔레그램 그룹**](https://t.me/peass)에 가입하거나** 트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우하세요.**
* **해킹 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>
