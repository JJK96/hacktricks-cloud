# Az - Blob Storage

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Grundlegende Informationen

[Aus den Dokumenten:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage ist Microsofts **Speicherl√∂sung f√ºr die Cloud**. Blob storage ist optimiert f√ºr die Speicherung gro√üer Mengen unstrukturierter Daten. Unstrukturierte Daten sind Daten, die keinem bestimmten Datenmodell oder keiner Definition entsprechen, wie z. B. Text- oder Bin√§rdaten.

Blob storage bietet drei Arten von Ressourcen:

* Das **Speicherkonto** (eindeutiger Name)
* Ein **Container** im Speicherkonto (Ordner)
* Ein **Blob** in einem Container

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Verschiedene Arten von Speicher

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Zugriff auf Speicher <a href="#about-blob-storage" id="about-blob-storage"></a>

* Verwende Azure AD-Prinzipale √ºber **RBAC-Rollen** unterst√ºtzt.
* **Access Keys**: Verwende Zugriffsschl√ºssel des Speicherkontos. Dies bietet **vollen Zugriff auf das Speicherkonto.**
* **Shared Access Signature** (SAS): **Zeitlich begrenzt** und spezifische Berechtigungen.
* Du kannst eine SAS-URL mit einem **Access Key** generieren (schwieriger zu erkennen).
* Da die SAS aus dem Access Key generiert wird, h√∂rt sie auf zu funktionieren, wenn dieser erneuert wird.

### √ñffentliche Exposition

Wenn "Allow Blob public access" **aktiviert** ist (standardm√§√üig deaktiviert), ist es m√∂glich:

* **√ñffentlichen Zugriff zum Lesen von Blobs** zu gew√§hren (du musst den Namen kennen).
* **Container-Blobs aufzulisten** und **zu lesen**.

### Verbindung zum Speicher

Wenn du einen **Speicher** findest, zu dem du eine Verbindung herstellen kannst, k√∂nntest du das Tool [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) verwenden.

## SAS-URLs

[Aus den Dokumenten:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Eine Shared Access Signature (SAS) bietet sicheren delegierten Zugriff auf Ressourcen in deinem Speicherkonto. Mit einer SAS hast du granulare Kontrolle dar√ºber, wie ein Client auf deine Daten zugreifen kann. Zum Beispiel:

* Auf welche Ressourcen der Client zugreifen darf.
* Welche Berechtigungen er f√ºr diese Ressourcen hat.
* Wie lange die SAS g√ºltig ist.

Eine SAS-URL sieht so aus: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Verwende [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) um auf die Daten zuzugreifen oder Python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Sie k√∂nnen ein **Shared Access Signature (SAS)**-Token f√ºr den Zugriff auf einen Container, ein Verzeichnis oder ein Blob sichern, indem Sie entweder Azure Active Directory (Azure AD) **Anmeldeinformationen oder einen Kontoschl√ºssel** verwenden. Um eine User Delegation SAS zu erstellen, m√ºssen Sie zuerst einen **User Delegation Key** anfordern, den Sie dann verwenden, um die SAS zu signieren.

Unterst√ºtzung wird sowohl f√ºr eine **User Delegation Shared Access Signature (SAS)** in **Azure Blob Storage** als auch in **Azure Data Lake Storage Gen2** bereitgestellt. Es ist jedoch wichtig zu beachten, dass **Stored Access Policies** nicht mit einer User Delegation SAS kompatibel sind.

Beachten Sie, dass die User Delegation SAS **mit Azure AD-Anmeldeinformationen anstelle von Speicherkontoschl√ºsseln gesichert** ist. Dies verhindert, dass Clients/Anwendungen Speicherschl√ºssel speichern/abrufen, um SAS zu erstellen.

### Service SAS

Eine Service SAS ist mit dem **Speicherkontoschl√ºssel** gesichert. Eine Service SAS **delegiert den Zugriff auf eine Ressource in nur einem** der Azure Storage-Dienste: Blob Storage, Queue Storage, Table Storage oder Azure Files. Die URI f√ºr eine Service-Level-SAS besteht aus der URI zur Ressource, f√ºr die die SAS den Zugriff delegiert, gefolgt vom SAS-Token.

Um Azure Active Directory (Azure AD) Anmeldeinformationen zu verwenden, um eine SAS f√ºr einen **Container** oder ein **Blob** zu sichern, verwenden Sie eine **User Delegation SAS**.

### Account SAS

Eine Account SAS ist mit einem der **Speicherkontoschl√ºssel** (es gibt 2) gesichert. Eine Account SAS delegiert den Zugriff auf Ressourcen in einem oder mehreren der Speicherdienste. Alle √ºber eine Service- oder User Delegation SAS verf√ºgbaren Operationen sind auch √ºber eine Account SAS verf√ºgbar.

[aus den Dokumenten:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Durch das Erstellen einer Account SAS k√∂nnen Sie:

* Den Zugriff auf Service-Level-Operationen delegieren, die derzeit nicht mit einer service-spezifischen SAS verf√ºgbar sind, wie z.B. die `Get/Set Service Properties` und `Get Service Stats` Operationen.
* Den Zugriff auf mehr als einen Dienst in einem Speicherkonto gleichzeitig delegieren. Zum Beispiel k√∂nnen Sie den Zugriff auf Ressourcen in sowohl Azure Blob Storage als auch Azure Files mithilfe einer Account SAS delegieren.
* Den Zugriff auf Schreib- und L√∂schoperationen f√ºr Container, Warteschlangen, Tabellen und Dateifreigaben delegieren, die mit einer objekt-spezifischen SAS nicht verf√ºgbar sind.
* Eine IP-Adresse oder einen Bereich von IP-Adressen angeben, von denen aus Anfragen akzeptiert werden sollen.
* Das HTTP-Protokoll angeben, von dem aus Anfragen akzeptiert werden sollen (entweder HTTPS oder HTTP/HTTPS).

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Referenzen

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
