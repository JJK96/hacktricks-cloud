# Az - Stockage Blob

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>

## Informations de base

[√Ä partir de la documentation :](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Le stockage Blob Azure est la solution de **stockage d'objets de Microsoft pour le cloud**. Le stockage Blob est optimis√© pour stocker des quantit√©s massives de donn√©es non structur√©es. Les donn√©es non structur√©es sont des donn√©es qui ne suivent pas un mod√®le ou une d√©finition de donn√©es particulier, telles que des donn√©es textuelles ou binaires.

Le stockage Blob offre trois types de ressources :

* Le **compte de stockage** (nom unique)
* Un **conteneur** dans le compte de stockage (dossier)
* Un **blob** dans un conteneur

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Diff√©rents types de stockage

| **Stockage Blob**               | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Fichiers Azure**              | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Stockage de files d'attente** | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Stockage de table**           | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Acc√®s au stockage <a href="#about-blob-storage" id="about-blob-storage"></a>

* Utilisez des principes Azure AD via les r√¥les **RBAC** pris en charge.
* **Cl√©s d'acc√®s** : Utilisez les cl√©s d'acc√®s du compte de stockage. Cela fournit un **acc√®s complet au compte de stockage**.
* **Signature d'acc√®s partag√©** (SAS) : **Limit√©e dans le temps** et permissions sp√©cifiques.
* Vous pouvez g√©n√©rer une URL SAS avec une **cl√© d'acc√®s** (plus difficile √† d√©tecter).
* Comme le SAS est g√©n√©r√© √† partir de la cl√© d'acc√®s, s'il est renouvel√©, le SAS cesse de fonctionner.

### Exposition publique

Si "Autoriser l'acc√®s public au Blob" est **activ√©** (d√©sactiv√© par d√©faut), il est possible de :

* Donner **acc√®s public en lecture aux blobs** (vous devez conna√Ætre le nom).
* **Lister les blobs du conteneur** et les **lire**.

### Connexion au stockage

Si vous trouvez un **stockage** auquel vous pouvez vous connecter, vous pouvez utiliser l'outil [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) pour le faire.

## URLs SAS

[√Ä partir de la documentation :](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Une signature d'acc√®s partag√© (SAS) fournit un acc√®s d√©l√©gu√© s√©curis√© aux ressources de votre compte de stockage. Avec un SAS, vous avez un contr√¥le granulaire sur la mani√®re dont un client peut acc√©der √† vos donn√©es. Par exemple :

* Quelles ressources le client peut acc√©der.
* Quelles autorisations ils ont sur ces ressources.
* Pendant combien de temps le SAS est valide.

Une URL SAS ressemble √† ceci : **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Utilisez [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) pour acc√©der aux donn√©es ou python :

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### Signature d'acc√®s partag√© d√©l√©gu√© de l'utilisateur <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Vous pouvez **s√©curiser un jeton de signature d'acc√®s partag√© (SAS)** pour acc√©der √† un conteneur, un r√©pertoire ou un blob en utilisant soit les **informations d'identification Azure Active Directory (Azure AD)**, soit une cl√© de compte. Pour cr√©er un SAS de d√©l√©gation d'utilisateur, vous devez d'abord demander une **cl√© de d√©l√©gation d'utilisateur**, que vous utilisez ensuite pour signer le SAS.

Le support est fourni pour une **Signature d'Acc√®s Partag√© D√©l√©gu√©e de l'Utilisateur (SAS)** √† la fois dans **Azure Blob Storage** et **Azure Data Lake Storage Gen2**. Cependant, il est important de noter que les **Strat√©gies d'Acc√®s Stock√©es** ne sont pas compatibles avec un SAS de d√©l√©gation d'utilisateur.

Notez que le SAS de d√©l√©gation d'utilisateur est **s√©curis√© avec les informations d'identification Azure AD au lieu des cl√©s de compte de stockage**. Cela emp√™che les clients/applications de stocker/r√©cup√©rer des cl√©s de stockage pour cr√©er des SAS.

### SAS de service

Un SAS de service est s√©curis√© avec la **cl√© de compte de stockage**. Un SAS de service **d√©l√®gue l'acc√®s √† une ressource dans un seul** des services de stockage Azure : stockage de blobs, stockage de files d'attente, stockage de tables ou fichiers Azure. L'URI pour un SAS au niveau du service se compose de l'URI vers la ressource pour laquelle le SAS d√©l√©guera l'acc√®s, suivi du jeton SAS.

Pour utiliser les informations d'identification Azure Active Directory (Azure AD) pour s√©curiser un SAS pour un **conteneur** ou un **blob**, utilisez un **SAS de d√©l√©gation d'utilisateur**.

### SAS de compte

Un SAS de compte est s√©curis√© avec l'une des **cl√©s de compte de stockage** (il y en a 2). Un SAS de compte d√©l√®gue l'acc√®s √† des ressources dans un ou plusieurs des services de stockage. Toutes les op√©rations disponibles via un SAS de service ou de d√©l√©gation d'utilisateur sont √©galement disponibles via un SAS de compte.

[√† partir de la documentation :](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) En cr√©ant un SAS de compte, vous pouvez :

* D√©l√©guer l'acc√®s √† des op√©rations au niveau du service qui ne sont pas actuellement disponibles avec un SAS sp√©cifique au service, telles que les op√©rations `Get/Set Service Properties` et `Get Service Stats`.
* D√©l√©guer l'acc√®s √† plus d'un service dans un compte de stockage √† la fois. Par exemple, vous pouvez d√©l√©guer l'acc√®s √† des ressources √† la fois dans Azure Blob Storage et Azure Files en utilisant un SAS de compte.
* D√©l√©guer l'acc√®s aux op√©rations d'√©criture et de suppression pour les conteneurs, les files d'attente, les tables et les partages de fichiers, qui ne sont pas disponibles avec un SAS sp√©cifique √† un objet.
* Sp√©cifier une adresse IP ou une plage d'adresses IP √† partir desquelles accepter les demandes.
* Sp√©cifier le protocole HTTP √† partir duquel accepter les demandes (soit HTTPS, soit HTTP/HTTPS).

## √ânum√©ration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## R√©f√©rences

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
