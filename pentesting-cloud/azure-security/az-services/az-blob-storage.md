# Az - Blob Storage

{% hint style="success" %}
Jifunze & fanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & fanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Taarifa za Msingi

[Kutoka kwenye nyaraka:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage ni suluhisho la **hifadhi ya vitu kwa wingu** la Microsoft. Blob storage imeboreshwa kwa kuhifadhi kiasi kikubwa cha data isiyo na muundo. Data isiyo na muundo ni data ambayo haifuati muundo maalum wa data au ufafanuzi, kama vile maandishi au data ya binary.

Blob storage inatoa aina tatu za rasilimali:

* **Akaunti ya hifadhi** (jina la kipekee)
* **Kontena** katika akaunti ya hifadhi (folda)
* **Blob** katika kontena

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Aina tofauti za hifadhi

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Upatikanaji wa Hifadhi <a href="#about-blob-storage" id="about-blob-storage"></a>

* Tumia Azure AD principals kupitia **RBAC roles** zinazoungwa mkono.
* **Access Keys**: Tumia funguo za upatikanaji wa akaunti ya hifadhi. Hii inatoa **upatikanaji kamili wa akaunti ya hifadhi.**
* **Shared Access Signature** (SAS): **Muda** **umewekewa kikomo** na ruhusa maalum.
* Unaweza kuzalisha url ya SAS na **access key** (ngumu zaidi kugundua).
* Kwa kuwa SAS inazalishwa kutoka kwa access key, ikiwa itafanywa upya SAS itaacha kufanya kazi.

### Ufunuo wa Umma

Ikiwa "Ruhusu upatikanaji wa umma wa Blob" **imewezeshwa** (imezimwa kwa chaguo-msingi), inawezekana:

* Kutoa **upatikanaji wa umma kusoma blobs** (unahitaji kujua jina).
* **Orodhesha blobs za kontena** na **zisome**.

### Unganisha na Hifadhi

Ikiwa utapata **hifadhi** yoyote unayoweza kuunganisha nayo unaweza kutumia zana ya [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) kufanya hivyo.

## SAS URLs

[Kutoka kwenye nyaraka:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Shared access signature (SAS) inatoa upatikanaji salama wa rasilimali katika akaunti yako ya hifadhi. Kwa SAS, una udhibiti wa kina juu ya jinsi mteja anavyoweza kufikia data yako. Kwa mfano:

* Rasilimali gani mteja anaweza kufikia.
* Ruhusa gani wanazo kwa rasilimali hizo.
* Muda gani SAS ni halali.

URL ya SAS inaonekana kama hii: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Tumia [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) kufikia data au python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Unaweza **kulinda tokeni ya shared access signature (SAS)** kwa kupata ufikiaji wa kontena, saraka, au blob kwa kutumia ama Azure Active Directory (Azure AD) **credentials au account key**. Ili kuunda user delegation SAS, lazima kwanza uombe **user delegation key**, ambayo kisha utatumia kusaini SAS.

Msaada unatolewa kwa **User Delegation Shared Access Signature (SAS)** katika **Azure Blob Storage** na **Azure Data Lake Storage Gen2**. Hata hivyo, ni muhimu kutambua kwamba **Stored Access Policies** haziendani na User Delegation SAS.

Kumbuka kwamba user delegation SAS **inalindwa na Azure AD credentials badala ya storage account keys**. Hii inazuia wateja/programu kuhifadhi/kupata storage keys ili kuunda SAS.

### Service SAS

Service SAS inalindwa na **storage account key**. Service SAS **inatoa ufikiaji kwa rasilimali katika moja tu** ya huduma za Azure Storage: Blob storage, Queue storage, Table storage, au Azure Files. URI ya service-level SAS inajumuisha URI kwa rasilimali ambayo SAS itatoa ufikiaji, ikifuatiwa na tokeni ya SAS.

Ili kutumia Azure Active Directory (Azure AD) credentials kulinda SAS kwa **kontena** au **blob**, tumia **user delegation SAS**.

### Account SAS

Account SAS inalindwa na moja ya **storage account keys** (kuna 2). Account SAS inatoa ufikiaji kwa rasilimali katika moja au zaidi ya huduma za hifadhi. Shughuli zote zinazopatikana kupitia service au user delegation SAS pia zinapatikana kupitia account SAS.

[kutoka kwa docs:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Kwa kuunda account SAS, unaweza:

* Kutoa ufikiaji kwa shughuli za kiwango cha huduma ambazo hazipatikani kwa sasa na service-specific SAS, kama vile `Get/Set Service Properties` na `Get Service Stats`.
* Kutoa ufikiaji kwa zaidi ya huduma moja katika storage account kwa wakati mmoja. Kwa mfano, unaweza kutoa ufikiaji kwa rasilimali katika Azure Blob Storage na Azure Files kwa kutumia account SAS.
* Kutoa ufikiaji kwa shughuli za kuandika na kufuta kwa kontena, foleni, meza, na sehemu za faili, ambazo hazipatikani na object-specific SAS.
* Kubainisha anwani ya IP au anuwai ya anwani za IP kutoka ambapo kukubali maombi.
* Kubainisha itifaki ya HTTP kutoka ambapo kukubali maombi (ama HTTPS au HTTP/HTTPS).

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Marejeo

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Jifunze na fanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na fanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
