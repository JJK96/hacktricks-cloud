# Az - Blob Storage

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informaci칩n B치sica

[De la documentaci칩n:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage es la **soluci칩n de almacenamiento de objetos en la nube** de Microsoft. Blob storage est치 optimizado para almacenar grandes cantidades de datos no estructurados. Los datos no estructurados son datos que no se adhieren a un modelo de datos o definici칩n particular, como datos de texto o binarios.

Blob storage ofrece tres tipos de recursos:

* La **cuenta de almacenamiento** (nombre 칰nico)
* Un **contenedor** en la cuenta de almacenamiento (carpeta)
* Un **blob** en un contenedor

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Diferentes tipos de almacenamiento

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Acceso al Almacenamiento <a href="#about-blob-storage" id="about-blob-storage"></a>

* Usar los principales de Azure AD a trav칠s de **roles RBAC** soportados.
* **Access Keys**: Usar las claves de acceso de la cuenta de almacenamiento. Esto proporciona **acceso completo a la cuenta de almacenamiento.**
* **Shared Access Signature** (SAS): **Tiempo** **limitado** y permisos espec칤ficos.
* Puedes generar una URL SAS con una **clave de acceso** (m치s complicado de detectar).
* Como el SAS se genera a partir de la clave de acceso, si se renueva, el SAS deja de funcionar.

### Exposici칩n P칰blica

Si "Permitir acceso p칰blico a Blob" est치 **habilitado** (deshabilitado por defecto), es posible:

* Dar **acceso p칰blico para leer blobs** (necesitas conocer el nombre).
* **Listar blobs del contenedor** y **leer**los.

### Conectar al Almacenamiento

Si encuentras alg칰n **almacenamiento** al que puedas conectarte, podr칤as usar la herramienta [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) para hacerlo.

## URLs SAS

[De la documentaci칩n:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Una firma de acceso compartido (SAS) proporciona acceso delegado seguro a recursos en tu cuenta de almacenamiento. Con un SAS, tienes control granular sobre c칩mo un cliente puede acceder a tus datos. Por ejemplo:

* Qu칠 recursos puede acceder el cliente.
* Qu칠 permisos tienen para esos recursos.
* Cu치nto tiempo es v치lido el SAS.

Una URL SAS se ve as칤: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Usa [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) para acceder a los datos o python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Puedes **asegurar un token de firma de acceso compartido (SAS)** para acceder a un contenedor, directorio o blob utilizando credenciales de Azure Active Directory (Azure AD) o una clave de cuenta. Para crear un SAS de delegaci칩n de usuario, primero debes solicitar una **clave de delegaci칩n de usuario**, que luego usar치s para firmar el SAS.

Se proporciona soporte para una **Firma de Acceso Compartido de Delegaci칩n de Usuario (SAS)** tanto en **Azure Blob Storage** como en **Azure Data Lake Storage Gen2**. Sin embargo, es importante notar que las **Pol칤ticas de Acceso Almacenadas** no son compatibles con un SAS de Delegaci칩n de Usuario.

Ten en cuenta que el SAS de delegaci칩n de usuario est치 **asegurado con credenciales de Azure AD en lugar de claves de cuenta de almacenamiento**. Esto evita que los clientes/aplicaciones almacenen/recuperen claves de almacenamiento para crear SAS.

### Service SAS

Un service SAS est치 asegurado con la **clave de cuenta de almacenamiento**. Un service SAS **delegates access to a resource in only one** de los servicios de almacenamiento de Azure: Blob storage, Queue storage, Table storage, o Azure Files. El URI para un SAS a nivel de servicio consiste en el URI al recurso para el cual el SAS delegar치 acceso, seguido del token SAS.

Para usar credenciales de Azure Active Directory (Azure AD) para asegurar un SAS para un **container** o **blob**, usa un **user delegation SAS**.

### Account SAS

Un account SAS est치 asegurado con una de las **claves de cuenta de almacenamiento** (hay 2). Un account SAS delega acceso a recursos en uno o m치s de los servicios de almacenamiento. Todas las operaciones disponibles a trav칠s de un service o user delegation SAS tambi칠n est치n disponibles a trav칠s de un account SAS.

[de la documentaci칩n:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Al crear un account SAS, puedes:

* Delegar acceso a operaciones a nivel de servicio que actualmente no est치n disponibles con un SAS espec칤fico de servicio, como las operaciones `Get/Set Service Properties` y `Get Service Stats`.
* Delegar acceso a m치s de un servicio en una cuenta de almacenamiento a la vez. Por ejemplo, puedes delegar acceso a recursos tanto en Azure Blob Storage como en Azure Files utilizando un account SAS.
* Delegar acceso a operaciones de escritura y eliminaci칩n para contenedores, colas, tablas y comparticiones de archivos, que no est치n disponibles con un SAS espec칤fico de objeto.
* Especificar una direcci칩n IP o un rango de direcciones IP desde las cuales aceptar solicitudes.
* Especificar el protocolo HTTP desde el cual aceptar solicitudes (ya sea HTTPS o HTTP/HTTPS).

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Referencias

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
