# Az - Blob Storage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) **bizi takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## Temel Bilgiler

[Dokümanlardan:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage, Microsoft'un **bulut için nesne depolama çözümüdür**. Blob storage, büyük miktarda yapılandırılmamış veriyi depolamak için optimize edilmiştir. Yapılandırılmamış veri, belirli bir veri modeli veya tanımına uymayan, metin veya ikili veri gibi verilerdir.

Blob storage üç tür kaynak sunar:

* **Depolama hesabı** (benzersiz ad)
* Depolama hesabında bir **kapsayıcı** (klasör)
* Bir kapsayıcıda bir **blob**

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Farklı depolama türleri

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Depolamaya Erişim <a href="#about-blob-storage" id="about-blob-storage"></a>

* **RBAC rolleri** desteklenen Azure AD ilkelerini kullanın.
* **Erişim Anahtarları**: Depolama hesabının erişim anahtarlarını kullanın. Bu, depolama hesabına **tam erişim sağlar.**
* **Paylaşılan Erişim İmzası** (SAS): **Zaman** **sınırlı** ve belirli izinler.
* Bir **erişim anahtarı** ile bir SAS url'si oluşturabilirsiniz (tespit edilmesi daha zor).
* SAS, erişim anahtarından oluşturulduğu için, yenilenirse SAS çalışmayı durdurur.

### Genel Maruz Kalma

"Blob genel erişimine izin ver" **etkinleştirilmişse** (varsayılan olarak devre dışı), şunlar mümkündür:

* **Blob'ları okumak için genel erişim** verin (adını bilmeniz gerekir).
* **Kapsayıcı blob'larını listeleyin** ve **okuyun**.

### Depolamaya Bağlanma

Herhangi bir **depolama** bulursanız, [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) aracını kullanarak bağlanabilirsiniz.

## SAS URL'leri

[Dokümanlardan:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Paylaşılan erişim imzası (SAS), depolama hesabınızdaki kaynaklara güvenli, devredilmiş erişim sağlar. Bir SAS ile, bir istemcinin verilerinize nasıl erişebileceği üzerinde ayrıntılı kontrol sahibi olursunuz. Örneğin:

* İstemcinin hangi kaynaklara erişebileceği.
* Bu kaynaklara hangi izinlere sahip oldukları.
* SAS'in ne kadar süre geçerli olduğu.

Bir SAS URL'si şu şekilde görünür: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Verilere erişmek için [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) veya python kullanın:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Bir konteyner, dizin veya blob'a erişim için bir **paylaşılan erişim imzası (SAS)** jetonunu, Azure Active Directory (Azure AD) **kimlik bilgileri veya bir hesap anahtarı** kullanarak güvence altına alabilirsiniz. Bir kullanıcı yetkilendirme SAS'ı oluşturmak için önce bir **kullanıcı yetkilendirme anahtarı** talep etmelisiniz, ardından bu anahtarı SAS'ı imzalamak için kullanırsınız.

**Azure Blob Storage** ve **Azure Data Lake Storage Gen2**'de **Kullanıcı Yetkilendirme Paylaşılan Erişim İmzası (SAS)** desteği sağlanmaktadır. Ancak, **Depolanan Erişim Politikaları**'nın Kullanıcı Yetkilendirme SAS ile uyumlu olmadığını belirtmek önemlidir.

Kullanıcı yetkilendirme SAS'ın **depolama hesabı anahtarları yerine Azure AD kimlik bilgileri ile güvence altına alındığını** unutmayın. Bu, istemcilerin/uygulamaların SAS oluşturmak için depolama anahtarlarını saklamasını/geri almasını engeller.

### Service SAS

Bir hizmet SAS, **depolama hesabı anahtarı** ile güvence altına alınır. Bir hizmet SAS, Azure Depolama hizmetlerinden yalnızca birindeki bir kaynağa **erişimi devreder**: Blob depolama, Kuyruk depolama, Tablo depolama veya Azure Dosyaları. Hizmet düzeyinde bir SAS için URI, SAS'ın erişimi devredeceği kaynağa yönelik URI ve ardından SAS jetonundan oluşur.

Bir **konteyner** veya **blob** için bir SAS'ı güvence altına almak için Azure Active Directory (Azure AD) kimlik bilgilerini kullanmak için, bir **kullanıcı yetkilendirme SAS'ı** kullanın.

### Account SAS

Bir hesap SAS, iki **depolama hesabı anahtarından** biri ile güvence altına alınır. Bir hesap SAS, bir veya daha fazla depolama hizmetindeki kaynaklara erişimi devreder. Bir hizmet veya kullanıcı yetkilendirme SAS aracılığıyla kullanılabilen tüm işlemler, bir hesap SAS aracılığıyla da kullanılabilir.

[belgelerden:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Bir hesap SAS oluşturarak şunları yapabilirsiniz:

* `Get/Set Service Properties` ve `Get Service Stats` işlemleri gibi şu anda hizmete özgü bir SAS ile mevcut olmayan hizmet düzeyinde işlemlere erişimi devredin.
* Aynı anda bir depolama hesabındaki birden fazla hizmete erişimi devredin. Örneğin, bir hesap SAS kullanarak hem Azure Blob Storage hem de Azure Dosyalar'daki kaynaklara erişimi devredebilirsiniz.
* Nesneye özgü bir SAS ile mevcut olmayan konteynerler, kuyruklar, tablolar ve dosya paylaşımları için yazma ve silme işlemlerine erişimi devredin.
* Talepleri kabul etmek için bir IP adresi veya bir IP adresi aralığı belirtin.
* Talepleri kabul etmek için HTTP protokolünü belirtin (ya HTTPS ya da HTTP/HTTPS).

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Referanslar

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **bizi takip edin** **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek hacking ipuçlarını paylaşın.

</details>
{% endhint %}
