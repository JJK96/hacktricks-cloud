# Az - Blob Storage

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basiese Inligting

[Van die dokumentasie:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage is Microsoft's objek **stooroplossing vir die wolk**. Blob storage is geoptimaliseer vir die stoor van massiewe hoeveelhede ongestruktureerde data. Ongestruktureerde data is data wat nie aan 'n spesifieke datamodel of definisie voldoen nie, soos teks of bin√™re data.

Blob storage bied drie tipes hulpbronne:

* Die **stoorrekening** (unieke naam)
* 'n **Houer** in die stoorrekening (vouler)
* 'n **Blob** in 'n houer

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Verskillende tipes stoor

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Toegang tot Stoor <a href="#about-blob-storage" id="about-blob-storage"></a>

* Gebruik Azure AD-prinsipale via **RBAC-rolle** ondersteun.
* **Toegang Sleutels**: Gebruik toegang sleutels van die stoorrekening. Dit bied **volle toegang tot die stoorrekening.**
* **Gedeelde Toegang Handtekening** (SAS): **Tyd** **beperk** en spesifieke toestemmings.
* Jy kan 'n SAS-URL genereer met 'n **toegang sleutel** (meer ingewikkeld om op te spoor).
* Aangesien die SAS gegenereer word vanaf die toegang sleutel, as dit hernu word, hou die SAS op werk.

### Openbare Blootstelling

As "Laat Blob openbare toegang toe" **geaktiveer** is (gedeaktiveer by verstek), is dit moontlik om:

* **Openbare toegang te gee om blobs te lees** (jy moet die naam ken).
* **Lys houer blobs** en **lees** hulle.

### Koppel aan Stoor

As jy enige **stoor** vind waaraan jy kan koppel, kan jy die hulpmiddel [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) gebruik om dit te doen.

## SAS URLs

[Van die dokumentasie:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) 'n Gedeelde toegang handtekening (SAS) bied veilige gedelegeerde toegang tot hulpbronne in jou stoorrekening. Met 'n SAS het jy fyn beheer oor hoe 'n kli√´nt jou data kan toegang. Byvoorbeeld:

* Watter hulpbronne die kli√´nt mag toegang.
* Watter toestemmings hulle het tot daardie hulpbronne.
* Hoe lank die SAS geldig is.

'n SAS-URL lyk so: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Gebruik [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) om toegang tot die data te kry of python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### Gebruiker-delegering SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Jy kan **'n gedeelde toegangshandtekening (SAS)**-token beveilig vir toegang tot 'n houer, gids, of blob deur gebruik te maak van √≥f Azure Active Directory (Azure AD) **bewyse of 'n rekening sleutel**. Om 'n gebruiker-delegering SAS te skep, moet jy eers 'n **gebruiker-delegering sleutel** versoek, wat jy dan gebruik om die SAS te teken.

Ondersteuning word verskaf vir 'n **Gebruiker Delegering Gedeelde Toegang Handtekening (SAS)** in beide **Azure Blob Storage** en **Azure Data Lake Storage Gen2**. Dit is egter belangrik om daarop te let dat **Gestoorde Toegang Beleide** nie versoenbaar is met 'n Gebruiker Delegering SAS nie.

Let daarop dat gebruiker-delegering SAS **beveilig is met Azure AD-bewyse in plaas van stoorrekening sleutels**. Dit verhoed dat kli√´nte/toepassings stoor sleutels stoor/herwin om SAS te skep.

### Diens SAS

'n Diens SAS is beveilig met die **stoorrekening sleutel**. 'n Diens SAS **delegeer toegang tot 'n hulpbron in slegs een** van die Azure Storage dienste: Blob storage, Queue storage, Table storage, of Azure Files. Die URI vir 'n diensvlak SAS bestaan uit die URI na die hulpbron waarvoor die SAS toegang sal delegeer, gevolg deur die SAS-token.

Om Azure Active Directory (Azure AD) bewyse te gebruik om 'n SAS vir 'n **houer** of **blob** te beveilig, gebruik 'n **gebruiker-delegering SAS**.

### Rekening SAS

'n Rekening SAS is beveilig met een van die **stoorrekening sleutels** (daar is 2). 'n Rekening SAS delegeer toegang tot hulpbronne in een of meer van die stoor dienste. Al die operasies beskikbaar via 'n diens of gebruiker-delegering SAS is ook beskikbaar via 'n rekening SAS.

[van die dokumentasie:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Deur 'n rekening SAS te skep, kan jy:

* Toegang delegeer tot diensvlak operasies wat tans nie beskikbaar is met 'n diens-spesifieke SAS nie, soos die `Get/Set Service Properties` en `Get Service Stats` operasies.
* Toegang delegeer tot meer as een diens in 'n stoorrekening op 'n slag. Byvoorbeeld, jy kan toegang delegeer tot hulpbronne in beide Azure Blob Storage en Azure Files deur 'n rekening SAS te gebruik.
* Toegang delegeer tot skryf en verwyder operasies vir houers, rye, tabelle, en l√™er deel, wat nie beskikbaar is met 'n objek-spesifieke SAS nie.
* 'n IP-adres of 'n reeks IP-adresse spesifiseer van waar af versoeke aanvaar moet word.
* Die HTTP-protokol spesifiseer van waar af versoeke aanvaar moet word (hetsy HTTPS of HTTP/HTTPS).

## Enumerasie

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Verwysings

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking tricks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
