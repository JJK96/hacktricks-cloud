# Az - Blob Storage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Podstawowe Informacje

[Z dokumentacji:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage to rozwiązanie firmy Microsoft do **przechowywania obiektów w chmurze**. Blob storage jest zoptymalizowane do przechowywania ogromnych ilości niestrukturalnych danych. Niestrukturalne dane to dane, które nie są zgodne z określonym modelem danych lub definicją, takie jak tekst lub dane binarne.

Blob storage oferuje trzy typy zasobów:

* **Konto magazynu** (unikalna nazwa)
* **Kontener** w koncie magazynu (folder)
* **Blob** w kontenerze

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Różne typy magazynu

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Dostęp do magazynu <a href="#about-blob-storage" id="about-blob-storage"></a>

* Użyj Azure AD principals za pomocą **ról RBAC**.
* **Access Keys**: Użyj kluczy dostępu do konta magazynu. To zapewnia **pełny dostęp do konta magazynu.**
* **Shared Access Signature** (SAS): **Ograniczony czasowo** i specyficzne uprawnienia.
* Możesz wygenerować URL SAS za pomocą **klucza dostępu** (trudniejsze do wykrycia).
* Ponieważ SAS jest generowany z klucza dostępu, jeśli zostanie odnowiony, SAS przestaje działać.

### Publiczna ekspozycja

Jeśli "Allow Blob public access" jest **włączone** (domyślnie wyłączone), możliwe jest:

* Udzielenie **publicznego dostępu do odczytu blobów** (musisz znać nazwę).
* **Lista blobów w kontenerze** i **odczyt** ich.

### Połączenie z magazynem

Jeśli znajdziesz jakikolwiek **magazyn**, do którego możesz się połączyć, możesz użyć narzędzia [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/), aby to zrobić.

## SAS URLs

[Z dokumentacji:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Shared Access Signature (SAS) zapewnia bezpieczny delegowany dostęp do zasobów w Twoim koncie magazynu. Dzięki SAS masz szczegółową kontrolę nad tym, jak klient może uzyskać dostęp do Twoich danych. Na przykład:

* Jakie zasoby klient może uzyskać.
* Jakie uprawnienia mają do tych zasobów.
* Jak długo SAS jest ważny.

URL SAS wygląda tak: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Użyj [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) do uzyskania dostępu do danych lub python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Możesz **zabezpieczyć token shared access signature (SAS)** do dostępu do kontenera, katalogu lub blobu, używając poświadczeń Azure Active Directory (Azure AD) **lub klucza konta**. Aby utworzyć user delegation SAS, musisz najpierw zażądać **klucza delegacji użytkownika**, którego następnie używasz do podpisania SAS.

Obsługa jest zapewniona dla **User Delegation Shared Access Signature (SAS)** zarówno w **Azure Blob Storage**, jak i **Azure Data Lake Storage Gen2**. Jednakże, należy zauważyć, że **Stored Access Policies** nie są kompatybilne z User Delegation SAS.

Należy zauważyć, że user delegation SAS jest **zabezpieczony poświadczeniami Azure AD zamiast kluczami konta storage**. To zapobiega przechowywaniu/pobieraniu kluczy storage przez klientów/aplikacje w celu tworzenia SAS.

### Service SAS

Service SAS jest zabezpieczony **kluczem konta storage**. Service SAS **deleguje dostęp do zasobu tylko w jednej** z usług Azure Storage: Blob storage, Queue storage, Table storage lub Azure Files. URI dla service-level SAS składa się z URI do zasobu, do którego SAS będzie delegować dostęp, a następnie tokenu SAS.

Aby użyć poświadczeń Azure Active Directory (Azure AD) do zabezpieczenia SAS dla **kontenera** lub **blobu**, użyj **user delegation SAS**.

### Account SAS

Account SAS jest zabezpieczony jednym z **kluczy konta storage** (są 2). Account SAS deleguje dostęp do zasobów w jednej lub więcej usługach storage. Wszystkie operacje dostępne za pomocą service lub user delegation SAS są również dostępne za pomocą account SAS.

[z dokumentacji:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Tworząc account SAS, możesz:

* Delegować dostęp do operacji na poziomie usługi, które nie są obecnie dostępne za pomocą service-specific SAS, takich jak operacje `Get/Set Service Properties` i `Get Service Stats`.
* Delegować dostęp do więcej niż jednej usługi w koncie storage jednocześnie. Na przykład, możesz delegować dostęp do zasobów zarówno w Azure Blob Storage, jak i Azure Files, używając account SAS.
* Delegować dostęp do operacji zapisu i usuwania dla kontenerów, kolejek, tabel i udziałów plików, które nie są dostępne za pomocą object-specific SAS.
* Określić adres IP lub zakres adresów IP, z których będą akceptowane żądania.
* Określić protokół HTTP, z którego będą akceptowane żądania (HTTPS lub HTTP/HTTPS).

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Referencje

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Ucz się i ćwicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz się i ćwicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawdź [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) albo **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel się trikami hakerskimi, przesyłając PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów na githubie.

</details>
{% endhint %}
