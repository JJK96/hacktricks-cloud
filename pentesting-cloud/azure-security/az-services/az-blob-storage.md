# Az - Blob-Speicher

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## Grundlegende Informationen

[Aus den Dokumenten:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob-Speicher ist die Objektspeicherl√∂sung von Microsoft f√ºr die Cloud. Blob-Speicher ist optimiert f√ºr die Speicherung gro√üer Mengen unstrukturierter Daten. Unstrukturierte Daten sind Daten, die sich nicht an ein bestimmtes Datenmodell oder eine bestimmte Definition halten, wie z. B. Text- oder Bin√§rdaten.

Blob-Speicher bietet drei Arten von Ressourcen:

* Das **Speicherkonto** (eindeutiger Name)
* Ein **Container** im Speicherkonto (Ordner)
* Ein **Blob** in einem Container

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Unterschiedliche Arten von Speicher

| **Blob-Speicher**               | <p><code>https://&#x3C;speicherkonto>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<speicherkonto>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure-Dateien**               | `https://<speicherkonto>.file.core.windows.net`                                                                                                                                                |
| **Warteschlangenspeicher**      | `https://<speicherkonto>.queue.core.windows.net`                                                                                                                                               |
| **Tabellenspeicher**            | `https://<speicherkonto>.table.core.windows.net`                                                                                                                                               |

### Zugriff auf Speicher <a href="#about-blob-storage" id="about-blob-storage"></a>

* Verwenden Sie Azure AD-Prinzipale √ºber unterst√ºtzte **RBAC-Rollen**.
* **Zugriffsschl√ºssel**: Verwenden Sie Zugriffsschl√ºssel des Speicherkontos. Dies bietet **vollen Zugriff auf das Speicherkonto**.
* **Shared Access Signature** (SAS): **Zeitlich begrenzt** und spezifische Berechtigungen.
* Sie k√∂nnen eine SAS-URL mit einem **Zugriffsschl√ºssel** generieren (schwieriger zu erkennen).
* Da die SAS aus dem Zugriffsschl√ºssel generiert wird, funktioniert die SAS nicht mehr, wenn sie erneuert wird.

### √ñffentliche Exposition

Wenn "√ñffentlicher Zugriff auf Blob zulassen" **aktiviert** ist (standardm√§√üig deaktiviert), ist es m√∂glich:

* √ñffentlichen Zugriff zum Lesen von Blobs zu geben (Sie m√ºssen den Namen kennen).
* **Liste Container-Blobs** und **lesen** sie.

### Verbindung zum Speicher

Wenn Sie auf einen **Speicher** sto√üen, zu dem Sie eine Verbindung herstellen k√∂nnen, k√∂nnen Sie das Tool [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) verwenden.

## SAS-URLs

[Aus den Dokumenten:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Ein Shared Access Signature (SAS) bietet sicheren delegierten Zugriff auf Ressourcen in Ihrem Speicherkonto. Mit einem SAS haben Sie eine genaue Kontrolle dar√ºber, wie ein Client auf Ihre Daten zugreifen kann. Zum Beispiel:

* Auf welche Ressourcen der Client zugreifen darf.
* Welche Berechtigungen sie f√ºr diese Ressourcen haben.
* Wie lange der SAS g√ºltig ist.

Eine SAS-URL sieht so aus: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Verwenden Sie [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/), um auf die Daten zuzugreifen, oder Python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### Benutzerdelegations-SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Sie k√∂nnen ein **Shared Access Signature (SAS)**-Token f√ºr den Zugriff auf einen Container, ein Verzeichnis oder einen Blob sichern, indem Sie entweder Azure Active Directory (Azure AD) **Anmeldeinformationen oder einen Kontoschl√ºssel** verwenden. Um eine Benutzerdelegations-SAS zu erstellen, m√ºssen Sie zuerst einen **Benutzerdelegations-Schl√ºssel** anfordern, den Sie dann zum Signieren der SAS verwenden.

Es wird Unterst√ºtzung f√ºr eine **Benutzerdelegations-Shared Access Signature (SAS)** sowohl in **Azure Blob Storage** als auch in **Azure Data Lake Storage Gen2** bereitgestellt. Es ist jedoch wichtig zu beachten, dass **Gespeicherte Zugriffsrichtlinien** nicht mit einer Benutzerdelegations-SAS kompatibel sind.

Beachten Sie, dass die Benutzerdelegations-SAS **mit Azure AD-Anmeldeinformationen anstelle von Speicherkontoschl√ºsseln gesichert ist**. Dies verhindert, dass Clients/Anwendungen Speicherschl√ºssel speichern/abrufen, um SAS zu erstellen.

### Service-SAS

Eine Service-SAS ist mit dem **Speicherkontoschl√ºssel gesichert**. Eine Service-SAS **delegiert den Zugriff auf eine Ressource nur in einem** der Azure Storage-Dienste: Blob-Speicher, Warteschlangenspeicher, Tabellenspeicher oder Azure-Dateien. Die URI f√ºr eine SAS auf Serviceniveau besteht aus der URI zur Ressource, f√ºr die die SAS den Zugriff delegiert, gefolgt vom SAS-Token.

Um Azure Active Directory (Azure AD)-Anmeldeinformationen zum Sichern einer SAS f√ºr einen **Container** oder **Blob** zu verwenden, verwenden Sie eine **Benutzerdelegations-SAS**.

### KontoSAS

Eine KontoSAS ist mit einem der **Speicherkontoschl√ºssel** (es gibt 2) gesichert. Eine KontoSAS delegiert den Zugriff auf Ressourcen in einem oder mehreren der Speicherdienste. Alle √ºber eine Service- oder Benutzerdelegations-SAS verf√ºgbaren Operationen sind auch √ºber eine KontoSAS verf√ºgbar.

[Aus den Dokumenten:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Durch Erstellen einer KontoSAS k√∂nnen Sie:

* Den Zugriff auf Serviceniveau-Operationen delegieren, die derzeit nicht mit einer spezifischen Service-SAS verf√ºgbar sind, wie z.B. die Operationen `Get/Set Service Properties` und `Get Service Stats`.
* Den Zugriff auf mehr als einen Dienst in einem Speicherkonto gleichzeitig delegieren. Sie k√∂nnen beispielsweise den Zugriff auf Ressourcen sowohl in Azure Blob Storage als auch in Azure-Dateien delegieren, indem Sie eine KontoSAS verwenden.
* Den Zugriff auf Schreib- und L√∂schvorg√§nge f√ºr Container, Warteschlangen, Tabellen und Dateifreigaben delegieren, die mit einer objektspezifischen SAS nicht verf√ºgbar sind.
* Eine IP-Adresse oder einen IP-Adressbereich angeben, von dem aus Anfragen akzeptiert werden sollen.
* Das HTTP-Protokoll angeben, von dem aus Anfragen akzeptiert werden sollen (entweder HTTPS oder HTTP/HTTPS).

## Enumeration

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Referenzen

* [https://learn.microsoft.com/de-de/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/de-de/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/de-de/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/de-de/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositorys einreichen.

</details>
