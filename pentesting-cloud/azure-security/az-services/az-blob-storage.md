# Az - Almacenamiento de blobs

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Informaci칩n B치sica

[Desde la documentaci칩n:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage es la soluci칩n de **almacenamiento de objetos de Microsoft para la nube**. El almacenamiento de blobs est치 optimizado para almacenar grandes cantidades de datos no estructurados. Los datos no estructurados son datos que no se adhieren a un modelo o definici칩n de datos particular, como texto o datos binarios.

El almacenamiento de blobs ofrece tres tipos de recursos:

* La **cuenta de almacenamiento** (nombre 칰nico)
* Un **contenedor** en la cuenta de almacenamiento (carpeta)
* Un **blob** en un contenedor

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Diferentes tipos de almacenamiento

| **Almacenamiento de blobs**      | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Almacenamiento de colas**      | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Almacenamiento de tablas**     | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Acceso al Almacenamiento <a href="#about-blob-storage" id="about-blob-storage"></a>

* Utiliza principios de Azure AD a trav칠s de roles de **RBAC** compatibles.
* **Claves de acceso**: Utiliza las claves de acceso de la cuenta de almacenamiento. Esto proporciona **acceso completo a la cuenta de almacenamiento**.
* **Firma de acceso compartido** (SAS): **Limitada en el tiempo** y con permisos espec칤ficos.
* Puedes generar una URL de SAS con una **clave de acceso** (m치s complicado de detectar).
* Como el SAS se genera a partir de la clave de acceso, si se renueva la clave, el SAS deja de funcionar.

### Exposici칩n P칰blica

Si se habilita "Permitir acceso p칰blico a blobs" (deshabilitado de forma predeterminada), es posible:

* Dar **acceso p칰blico para leer blobs** (necesitas conocer el nombre).
* **Listar blobs del contenedor** y **leerlos**.

### Conectar al Almacenamiento

Si encuentras alg칰n **almacenamiento** al que puedas conectarte, podr칤as utilizar la herramienta [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) para hacerlo.

## URLs de SAS

[Desde la documentaci칩n:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Una firma de acceso compartido (SAS) proporciona acceso delegado seguro a los recursos de tu cuenta de almacenamiento. Con un SAS, tienes un control detallado sobre c칩mo un cliente puede acceder a tus datos. Por ejemplo:

* A qu칠 recursos puede acceder el cliente.
* Qu칠 permisos tienen para esos recursos.
* Cu치nto tiempo es v치lido el SAS.

Una URL de SAS se ve as칤: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Utiliza [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) para acceder a los datos o python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### SAS de delegaci칩n de usuario <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Puede **asegurar un token de firma de acceso compartido (SAS)** para acceder a un contenedor, directorio o blob utilizando las **credenciales de Azure Active Directory (Azure AD) o una clave de cuenta**. Para crear una SAS de delegaci칩n de usuario, primero debe solicitar una **clave de delegaci칩n de usuario**, que luego utilizar치 para firmar la SAS.

Se proporciona soporte para una **Firma de Acceso Compartido (SAS) de Delegaci칩n de Usuario** tanto en **Azure Blob Storage** como en **Azure Data Lake Storage Gen2**. Sin embargo, es importante tener en cuenta que las **Directivas de Acceso Almacenadas** no son compatibles con una SAS de Delegaci칩n de Usuario.

Tenga en cuenta que la SAS de delegaci칩n de usuario est치 **asegurada con credenciales de Azure AD en lugar de claves de cuenta de almacenamiento**. Esto evita que los clientes/aplicaciones almacenen/recuperen claves de almacenamiento para crear SAS.

### SAS de servicio

Una SAS de servicio est치 asegurada con la **clave de cuenta de almacenamiento**. Una SAS de servicio **delega acceso a un recurso en solo uno** de los servicios de almacenamiento de Azure: almacenamiento de blobs, almacenamiento de colas, almacenamiento de tablas o archivos de Azure. La URI para una SAS a nivel de servicio consta de la URI al recurso para el cual la SAS delegar치 acceso, seguido por el token SAS.

Para utilizar las credenciales de Azure Active Directory (Azure AD) para asegurar una SAS para un **contenedor** o **blob**, utilice una **SAS de delegaci칩n de usuario**.

### SAS de cuenta

Una SAS de cuenta est치 asegurada con una de las **claves de cuenta de almacenamiento** (hay 2). Una SAS de cuenta delega acceso a recursos en uno o m치s de los servicios de almacenamiento. Todas las operaciones disponibles a trav칠s de una SAS de servicio o de delegaci칩n de usuario tambi칠n est치n disponibles a trav칠s de una SAS de cuenta.

[de la documentaci칩n:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Al crear una SAS de cuenta, puede:

* Delegar acceso a operaciones a nivel de servicio que actualmente no est치n disponibles con una SAS espec칤fica del servicio, como las operaciones `Obtener/Establecer Propiedades del Servicio` y `Obtener Estad칤sticas del Servicio`.
* Delegar acceso a m치s de un servicio en una cuenta de almacenamiento a la vez. Por ejemplo, puede delegar acceso a recursos tanto en Azure Blob Storage como en Azure Files mediante una SAS de cuenta.
* Delegar acceso a operaciones de escritura y eliminaci칩n para contenedores, colas, tablas y recursos compartidos de archivos, que no est치n disponibles con una SAS espec칤fica del objeto.
* Especificar una direcci칩n IP o un rango de direcciones IP desde las cuales aceptar solicitudes.
* Especificar el protocolo HTTP desde el cual aceptar solicitudes (ya sea HTTPS o HTTP/HTTPS).

## Enumeraci칩n

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Referencias

* [https://learn.microsoft.com/es-es/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/es-es/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/es-es/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/es-es/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
