# Az - Blob Storage

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hacking trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne Informacije

[Iz dokumentacije:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage je Microsoftovo rešenje za **skladištenje objekata u oblaku**. Blob storage je optimizovan za čuvanje ogromnih količina nestrukturiranih podataka. Nestrukturirani podaci su podaci koji ne prate određeni model podataka ili definiciju, kao što su tekstualni ili binarni podaci.

Blob storage nudi tri tipa resursa:

* **Skladišni nalog** (jedinstveno ime)
* **Kontejner** u skladišnom nalogu (folder)
* **Blob** u kontejneru

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Različiti tipovi skladišta

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Pristup Skladištu <a href="#about-blob-storage" id="about-blob-storage"></a>

* Koristite Azure AD entitete putem **RBAC uloga** koje su podržane.
* **Ključevi za pristup**: Koristite ključeve za pristup skladišnom nalogu. Ovo omogućava **potpun pristup skladišnom nalogu.**
* **Shared Access Signature** (SAS): **Vremenski** **ograničen** i specifične dozvole.
* Možete generisati SAS url sa **ključem za pristup** (teže za detekciju).
* Pošto se SAS generiše iz ključa za pristup, ako se on obnovi, SAS prestaje da radi.

### Javno Izlaganje

Ako je "Dozvoli javni pristup Blob-u" **omogućeno** (onemogućeno po defaultu), moguće je:

* Dati **javni pristup za čitanje blob-ova** (potrebno je znati ime).
* **Listati blob-ove u kontejneru** i **čitati** ih.

### Povezivanje sa Skladištem

Ako pronađete bilo koje **skladište** na koje možete da se povežete, možete koristiti alat [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) za to.

## SAS URL-ovi

[Iz dokumentacije:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Shared access signature (SAS) pruža siguran delegirani pristup resursima u vašem skladišnom nalogu. Sa SAS-om, imate granularnu kontrolu nad time kako klijent može pristupiti vašim podacima. Na primer:

* Koje resurse klijent može da pristupi.
* Koje dozvole imaju za te resurse.
* Koliko dugo je SAS važeći.

SAS URL izgleda ovako: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Koristite [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) za pristup podacima ili python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Možete **osigurati token za deljeni pristup (SAS)** za pristup kontejneru, direktorijumu ili blob-u koristeći ili Azure Active Directory (Azure AD) **akreditive ili ključ naloga**. Da biste kreirali SAS za delegaciju korisnika, prvo morate zatražiti **ključ za delegaciju korisnika**, koji zatim koristite za potpisivanje SAS-a.

Podrška je obezbeđena za **User Delegation Shared Access Signature (SAS)** u oba **Azure Blob Storage** i **Azure Data Lake Storage Gen2**. Međutim, važno je napomenuti da **Stored Access Policies** nisu kompatibilne sa SAS-om za delegaciju korisnika.

Napomena da je SAS za delegaciju korisnika **osiguran sa Azure AD akreditivima umesto ključeva skladišnog naloga**. Ovo sprečava klijente/aplikacije da skladište/preuzimaju ključeve skladišta za kreiranje SAS-a.

### Service SAS

Service SAS je osiguran sa **ključem skladišnog naloga**. Service SAS **delegira pristup resursu u samo jednoj** od Azure Storage usluga: Blob storage, Queue storage, Table storage, ili Azure Files. URI za service-level SAS se sastoji od URI-ja do resursa za koji će SAS delegirati pristup, praćen SAS tokenom.

Da biste koristili Azure Active Directory (Azure AD) akreditive za osiguranje SAS-a za **kontejner** ili **blob**, koristite **user delegation SAS**.

### Account SAS

Account SAS je osiguran sa jednim od **ključeva skladišnog naloga** (postoje 2). Account SAS delegira pristup resursima u jednoj ili više skladišnih usluga. Sve operacije dostupne putem service ili user delegation SAS-a su takođe dostupne putem account SAS-a.

[iz dokumenata:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Kreiranjem account SAS-a, možete:

* Delegirati pristup operacijama na nivou usluge koje trenutno nisu dostupne sa specifičnim SAS-om za uslugu, kao što su `Get/Set Service Properties` i `Get Service Stats` operacije.
* Delegirati pristup više od jedne usluge u skladišnom nalogu istovremeno. Na primer, možete delegirati pristup resursima u oba Azure Blob Storage i Azure Files koristeći account SAS.
* Delegirati pristup operacijama pisanja i brisanja za kontejnere, redove, tabele i deljene datoteke, koje nisu dostupne sa SAS-om specifičnim za objekat.
* Specifikovati IP adresu ili opseg IP adresa sa kojih će se prihvatati zahtevi.
* Specifikovati HTTP protokol sa kojeg će se prihvatati zahtevi (bilo HTTPS ili HTTP/HTTPS).

## Enumeracija

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Reference

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hacking trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
