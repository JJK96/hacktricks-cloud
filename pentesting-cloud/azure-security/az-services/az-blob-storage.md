# Az - Skladištenje Blobova

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne Informacije

[Od dokumenata:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob skladištenje je Microsoftovo objektno **rešenje za skladištenje u oblaku**. Blob skladištenje je optimizovano za skladištenje ogromnih količina nestrukturiranih podataka. Nestrukturirani podaci su podaci koji se ne pridržavaju određenog modela ili definicije, kao što su tekstualni ili binarni podaci.

Blob skladištenje nudi tri vrste resursa:

* **Skladišni nalog** (jedinstveno ime)
* **Kontejner** u skladištnom nalogu (folder)
* **Blob** u kontejneru

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### Različite vrste skladištenja

| **Blob skladištenje**            | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake skladištenje Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Skladištenje redova**          | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Skladištenje tabela**          | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Pristup Skladištu <a href="#about-blob-storage" id="about-blob-storage"></a>

* Koristite Azure AD principe putem **RBAC uloga** koje su podržane.
* **Pristupni ključevi**: Koristite pristupne ključeve skladištnog naloga. Ovo omogućava **puni pristup skladištnom nalogu.**
* **Deljeni pristupni potpis** (SAS): **Vremenski ograničen** i specifične dozvole.
* Možete generisati SAS URL sa **pristupnim ključem** (teže otkriti).
* Pošto je SAS generisan iz pristupnog ključa, ako se obnovi, SAS prestaje da radi.

### Javna Izloženost

Ako je "Dozvoli javni pristup blobovima" **omogućeno** (podrazumevano onemogućeno), moguće je:

* Dati **javni pristup za čitanje blobova** (potrebno je znati ime).
* **Izlistati blobove kontejnera** i **čitati** ih.

### Povezivanje sa Skladištem

Ako pronađete bilo koje **skladište** sa kojim možete da se povežete, možete koristiti alat [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) za to.

## SAS URL-ovi

[Od dokumenata:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Deljeni pristupni potpis (SAS) pruža siguran delegirani pristup resursima u vašem skladištnom nalogu. Sa SAS-om, imate granularnu kontrolu nad tim kako klijent može pristupiti vašim podacima. Na primer:

* Koje resurse klijent može pristupiti.
* Koje dozvole imaju na tim resursima.
* Koliko dugo je SAS validan.

SAS URL izgleda ovako: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Koristite [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) za pristup podacima ili python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name'])

# List blobs inside the containers
container = svc.get_container_client(container=c['name'])

for b in container.list_blobs():
print(b['name'])


# Download all the blobs
blob_name = b['name'].split("/")[::-1][0]
blob = svc.get_blob_client(container=c['name'],blob=b['name'])
with open(blob_name,"wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### SAS sa delegiranjem korisnika <a href="#user-delegation-sas" id="user-delegation-sas"></a>

**Možete osigurati zajednički pristupni potpis (SAS)** token za pristup kontejneru, direktorijumu ili bloku koristeći ili Azure Active Directory (Azure AD) **kredencijale ili ključ naloga**. Da biste kreirali SAS sa delegiranjem korisnika, prvo morate zatražiti **ključ za delegiranje korisnika**, koji zatim koristite za potpisivanje SAS-a.

Podrška je obezbeđena za **SAS sa delegiranjem korisnika** kako u **Azure Blob Storage** tako i u **Azure Data Lake Storage Gen2**. Međutim, važno je napomenuti da **Uskladišteni pristupni propisi** nisu kompatibilni sa SAS-om sa delegiranjem korisnika.

Imajte na umu da je SAS sa delegiranjem korisnika **osiguran Azure AD kredencijalima umesto ključeva za nalog skladišta**. Ovo sprečava klijente/aplikacije da skladište/dobavljaju ključeve za skladištenje kako bi kreirali SAS.

### SAS usluge

SAS usluge su osigurane sa **ključem naloga za skladištenje**. SAS usluge **delegiraju pristup resursu samo u jednoj** od Azure Storage usluga: skladište blokova, skladište redova, skladište tabela ili Azure fajlovi. URI za SAS na nivou usluge sastoji se od URI-ja resursa za koji će SAS delegirati pristup, praćenog SAS tokenom.

Da biste koristili Azure Active Directory (Azure AD) kredencijale za osiguravanje SAS-a za **kontejner** ili **blok**, koristite **SAS sa delegiranjem korisnika**.

### SAS naloga

SAS naloga je osiguran sa jednim od **ključeva naloga za skladištenje** (njih ima 2). SAS naloga delegira pristup resursima u jednoj ili više skladišnih usluga. Sve operacije dostupne putem SAS-a na nivou usluge ili sa delegiranjem korisnika takođe su dostupne putem SAS-a naloga.

[iz dokumentacije:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Kreiranjem SAS naloga možete:

* Delegirati pristup operacijama na nivou usluge koje trenutno nisu dostupne sa SAS-om specifičnim za uslugu, kao što su operacije `Get/Set Service Properties` i `Get Service Stats`.
* Delegirati pristup više od jedne usluge u skladišnom nalogu istovremeno. Na primer, možete delegirati pristup resursima kako u Azure Blob Storage tako i u Azure Files koristeći SAS naloga.
* Delegirati pristup operacijama pisanja i brisanja za kontejnere, redove, tabele i deljene fajlove, koje nisu dostupne sa SAS-om specifičnim za objekat.
* Navesti IP adresu ili opseg IP adresa iz kojih će se prihvatati zahtevi.
* Navesti HTTP protokol iz kojeg će se prihvatati zahtevi (ili HTTPS ili HTTP/HTTPS).

## Enumeracija

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Reference

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
