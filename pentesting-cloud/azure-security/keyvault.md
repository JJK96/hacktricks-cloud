# Az - Anahtar Kasası

{% hint style="success" %}
AWS Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## Temel Bilgiler

[Belgelerden alınan bilgiye göre:](https://learn.microsoft.com/en-us/azure/key-vault/general/basic-concepts) Azure Key Vault, **güvenli bir şekilde saklanan ve erişilen sırlar** için bir bulut hizmetidir. Bir sır, API anahtarları, şifreler, sertifikalar veya kriptografik anahtarlar gibi **erişimi sıkı bir şekilde kontrol etmek istediğiniz her şeydir**. Key Vault hizmeti iki tür konteyneri destekler: kasalar ve yönetilen donanım güvenlik modülü (HSM) havuzları. Kasalar, yazılım ve HSM destekli anahtarları, sırları ve sertifikaları saklamayı destekler. Yönetilen HSM havuzları yalnızca HSM destekli anahtarları destekler. Tam ayrıntılar için [Azure Key Vault REST API genel bakışına](https://learn.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates) bakın.

**URL formatı** şu şekildedir: `https://{kasaya-adı}.vault.azure.net/{nesne-türü}/{nesne-adı}/{nesne-sürümü}` Şunlar geçerlidir:

* `kasaya-adı`, anahtar kasasının global olarak **benzersiz** adıdır
* `nesne-türü` "anahtarlar", "sırlar" veya "sertifikalar" olabilir
* `nesne-adı`, anahtar kasası içindeki nesnenin **benzersiz** adıdır
* `nesne-sürümü`, sistem tarafından oluşturulur ve nesnenin **benzersiz bir sürümüne** erişmek için isteğe bağlı olarak kullanılır.

Kasada saklanan sırlara erişmek için 2 izin modeli kullanılabilir:

* **Kasa erişim politikası**
* **Azure RBAC**

### Erişim Kontrolü <a href="#access-control" id="access-control"></a>

Bir Anahtar Kasası kaynağına erişim, iki düzlem tarafından kontrol edilir:

* **Yönetim düzlemi**, hedefi [management.azure.com](http://management.azure.com/).&#x20;
* Anahtar kasasını yönetmek ve **erişim politikalarını** yönetmek için kullanılır. Yalnızca Azure rol tabanlı erişim kontrolü (**RBAC**) desteklenir.
* **Veri düzlemi**, hedefi **`<kasaya-adı>.vault.azure.com`**.&#x20;
* Anahtar kasasındaki verileri (anahtarlar, sırlar ve sertifikalar) yönetmek ve erişmek için kullanılır. Bu, **anahtar kasası erişim politikalarını** veya Azure **RBAC**'ı destekler.

Yönetim yerinde erişim politikalarını yönetmek için izinlere sahip olan bir rol olan **Katılımcı** gibi bir rol, erişim politikalarını değiştirerek sırlara erişebilir.

### Anahtar Kasası RBAC Yerleşik Roller <a href="#rbac-built-in-roles" id="rbac-built-in-roles"></a>

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Ağ Erişimi

Azure Key Vault'ta, **güvenlik duvarı** kuralları **belirli sanal ağlardan veya IPv4 adres aralıklarından yalnızca veri düzlemi işlemlerine izin vermek üzere** ayarlanabilir. Bu kısıtlama, Azure yönetim portalı üzerinden erişimi de etkiler; kullanıcılar, giriş IP adresleri yetkilendirilmiş aralık içinde değilse anahtar kasasındaki anahtarları, sırları veya sertifikaları listeleyemez.

Bu ayarları analiz etmek ve yönetmek için **Azure CLI**'yi kullanabilirsiniz:
```bash
az keyvault show --name name-vault --query networkAcls
```
Önceki komut, `name-vault`'ın etkin IP aralıklarını ve reddedilen trafiğe yönelik politikaları da içeren f**irewall ayarlarını** gösterecektir.

## Numaralandırma

{% tabs %}
{% tab title="Az Powershell" %}
```powershell
# Get keyvault token
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Connect with PS AzureAD
## $token from management API
Connect-AzAccount -AccessToken $token -AccountId 1937ea5938eb-10eb-a365-10abede52387 -KeyVaultAccessToken $keyvaulttoken

# List vaults
Get-AzKeyVault
# Get secrets names from the vault
Get-AzKeyVaultSecret -VaultName <vault_name>
# Get secret values
Get-AzKeyVaultSecret -VaultName <vault_name> -Name <secret_name> –AsPlainText
```
{% endcode %}
{% endtab %}

{% tab title="tr" %}Bu bölümde, Azure Key Vault hizmetinin güvenliğini artırmak için bazı öneriler bulunmaktadır. Bu öneriler arasında, erişim kontrollerinin düzgün yapılandırılması, güçlü kimlik doğrulama yöntemlerinin kullanılması ve izleme ve günlük tutma işlemlerinin düzenli olarak yapılması yer almaktadır. Bu adımların uygulanması, Azure Key Vault'un güvenliğini artırabilir ve hassas verilerin korunmasına yardımcı olabilir.{% endtab %}
```bash
#!/bin/bash

# Dump all keyvaults from the subscription

# Define Azure subscription ID
AZ_SUBSCRIPTION_ID="your-subscription-id"

# Specify the filename for output
CSV_OUTPUT="vault-names-list.csv"

# Login to Azure account
az login

# Select the desired subscription
az account set --subscription $AZ_SUBSCRIPTION_ID

# Retrieve all resource groups within the subscription
AZ_RESOURCE_GROUPS=$(az group list --query "[].name" -o tsv)

# Initialize the CSV file with headers
echo "Vault Name,Associated Resource Group" > $CSV_OUTPUT

# Iterate over each resource group
for GROUP in $AZ_RESOURCE_GROUPS
do
# Fetch key vaults within the current resource group
VAULT_LIST=$(az keyvault list --resource-group $GROUP --query "[].name" -o tsv)

# Process each key vault
for VAULT in $VAULT_LIST
do
# Extract the key vault's name
VAULT_NAME=$(az keyvault show --name $VAULT --resource-group $GROUP --query "name" -o tsv)

# Append the key vault name and its resource group to the file
echo "$VAULT_NAME,$GROUP" >> $CSV_OUTPUT
done
done
```
{% endtab %}
{% endtabs %}

{% hint style="success" %}
AWS Hacking'ı öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'ı öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
