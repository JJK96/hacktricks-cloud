# Az - Hifadhi ya Kivinjari

{% hint style="success" %}
Jifunze & zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>unga mkono HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Taarifa Msingi

[Kutoka kwa nyaraka:](https://learn.microsoft.com/en-us/azure/key-vault/general/basic-concepts) Azure Key Vault ni huduma ya wingu ya **kuhifadhi na kupata siri kwa usalama**. Siri ni kitu chochote unachotaka **kudhibiti upatikanaji wake kwa karibu**, kama vile funguo za API, nywila, vyeti, au funguo za kryptographia. Huduma ya Key Vault inasaidia aina mbili za vyombo: hifadhi na dimbwi la moduli ya usalama ya vifaa iliyosimamiwa (HSM). Hifadhi inasaidia kuhifadhi programu na funguo zilizosaidiwa na HSM, siri, na vyeti. Dimbwi la HSM lililosimamiwa linasaidia tu funguo zilizosaidiwa na HSM. Angalia [Maelezo ya Jumla ya Azure Key Vault REST API](https://learn.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates) kwa maelezo kamili.

**Muundo wa URL** ni `https://{jina-la-hifadhi}.vault.azure.net/{aina-ya-kiwango}/{jina-la-kiwango}/{toleo-la-kiwango}` Ambapo:

* `jina-la-hifadhi` ni jina la kipekee ulimwenguni la hifadhi ya funguo
* `aina-ya-kiwango` inaweza kuwa "funguo", "siri" au "vyeti"
* `jina-la-kiwango` ni jina la kipekee la kitu ndani ya hifadhi ya funguo
* `toleo-la-kiwango` linaundwa na mfumo na kutumiwa hiari kushughulikia **toleo la kipekee la kitu**.

Ili kupata siri zilizohifadhiwa kwenye hifadhi, mifano 2 ya ruhusa inaweza kutumika:

* **Sera ya upatikanaji wa hifadhi**
* **Azure RBAC**

### Kudhibiti Upatikanaji <a href="#access-control" id="access-control"></a>

Upatikanaji wa rasilimali ya Key Vault unadhibitiwa na ndege mbili:

* **Ndege ya usimamizi**, lengo lake ni [management.azure.com](http://management.azure.com/).&#x20;
* Inatumika kusimamia hifadhi ya funguo na **sera za upatikanaji**. Inasaidia tu udhibiti wa upatikanaji wa msingi wa jukumu la Azure (**RBAC**).
* **Ndege ya data**, lengo lake ni **`<jina-la-hifadhi>.vault.azure.com`**.&#x20;
* Inatumika kusimamia na kupata **data** (funguo, siri, na vyeti) **katika hifadhi ya funguo**. Hii inasaidia **sera za upatikanaji wa hifadhi ya funguo** au Azure **RBAC**.

Jukumu kama **Mchangiaji** ambaye ana ruhusa katika mahali pa usimamizi kusimamia sera za upatikanaji anaweza kupata siri kwa kubadilisha sera za upatikanaji.

### Majukumu Yaliyojengwa Ndani ya RBAC ya Hifadhi ya Funguo <a href="#rbac-built-in-roles" id="rbac-built-in-roles"></a>

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Upatikanaji wa Mtandao

Katika Azure Key Vault, sheria za **firewall** zinaweza kuwekwa ili **kuruhusu operesheni za ndege ya data tu kutoka kwenye mitandao ya kawaida iliyowekwa au safu za anwani za IPv4**. Kizuizi hiki pia kinaathiri upatikanaji kupitia lango la utawala la Azure; watumiaji hawataweza kuorodhesha funguo, siri, au vyeti katika hifadhi ya funguo ikiwa anwani yao ya IP ya kuingia haiko ndani ya safu iliyoruhusiwa.

Kwa uchambuzi na usimamizi wa mipangilio hii, unaweza kutumia **Azure CLI**:
```bash
az keyvault show --name name-vault --query networkAcls
```
The amri iliyopita itaonyesha mipangilio ya f**irewall ya `name-vault`**, ikiwa ni pamoja na safu zilizowezeshwa za IP na sera za trafiki iliyokataliwa.

## Uchambuzi

{% tabs %}
{% tab title="Az Powershell" %}
```powershell
# Get keyvault token
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Connect with PS AzureAD
## $token from management API
Connect-AzAccount -AccessToken $token -AccountId 1937ea5938eb-10eb-a365-10abede52387 -KeyVaultAccessToken $keyvaulttoken

# List vaults
Get-AzKeyVault
# Get secrets names from the vault
Get-AzKeyVaultSecret -VaultName <vault_name>
# Get secret values
Get-AzKeyVaultSecret -VaultName <vault_name> -Name <secret_name> ‚ÄìAsPlainText
```
{% endcode %}
{% endtab %}

{% tab title="az" %}
```bash
#!/bin/bash

# Dump all keyvaults from the subscription

# Define Azure subscription ID
AZ_SUBSCRIPTION_ID="your-subscription-id"

# Specify the filename for output
CSV_OUTPUT="vault-names-list.csv"

# Login to Azure account
az login

# Select the desired subscription
az account set --subscription $AZ_SUBSCRIPTION_ID

# Retrieve all resource groups within the subscription
AZ_RESOURCE_GROUPS=$(az group list --query "[].name" -o tsv)

# Initialize the CSV file with headers
echo "Vault Name,Associated Resource Group" > $CSV_OUTPUT

# Iterate over each resource group
for GROUP in $AZ_RESOURCE_GROUPS
do
# Fetch key vaults within the current resource group
VAULT_LIST=$(az keyvault list --resource-group $GROUP --query "[].name" -o tsv)

# Process each key vault
for VAULT in $VAULT_LIST
do
# Extract the key vault's name
VAULT_NAME=$(az keyvault show --name $VAULT --resource-group $GROUP --query "name" -o tsv)

# Append the key vault name and its resource group to the file
echo "$VAULT_NAME,$GROUP" >> $CSV_OUTPUT
done
done
```
{% endtab %}
{% endtabs %}

{% hint style="success" %}
Jifunze na zoea AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na zoea GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
