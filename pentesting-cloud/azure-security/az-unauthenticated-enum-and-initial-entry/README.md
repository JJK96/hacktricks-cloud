# Az - Ανεξουθέντως Enum & Αρχική Είσοδος

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Azure Tenant

### Απαρίθμηση Tenant

Υπάρχουν μερικά **δημόσια APIs της Azure** που απλώς γνωρίζοντας το **domain του tenant** ένας επιτιθέμενος μπορεί να ερευνήσει για περισσότερες πληροφορίες σχετικά με αυτόν.\
Μπορείτε να ερευνήσετε απευθείας το API ή να χρησιμοποιήσετε τη βιβλιοθήκη PowerShell [**AADInternals**](https://github.com/Gerenios)**:**

| API                                                                  | Πληροφορίες                                                                                                                                                                                                                                           | Συνάρτηση AADInternals                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Πληροφορίες σύνδεσης**, συμπεριλαμβανομένου του ID του tenant                                                                                                                                                                                     | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Όλα τα domains** του tenant                                                                                                                                                                                                                       | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Πληροφορίες σύνδεσης</strong> του tenant, συμπεριλαμβανομένου του ονόματος του tenant και του domain <strong>τύπου πιστοποίησης.</strong><br>Αν το <code>NameSpaceType</code> είναι <strong><code>Managed</code></strong>, σημαίνει ότι χρησιμοποιείται το <strong>AzureAD</strong>.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Πληροφορίες σύνδεσης, συμπεριλαμβανομένων των **πληροφοριών Desktop SSO**                                                                                                                                                                          | `Get-AADIntLoginInformation -UserName <UserName>` |

Μπορείτε να ερευνήσετε όλες τις πληροφορίες ενός Azure tenant με **μόνο έναν εντολή της** [**βιβλιοθήκης AADInternals**](https://github.com/Gerenios)**:**
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Παράδειγμα εξόδου πληροφοριών του Azure tenant:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Είναι δυνατόν να παρατηρηθούν λεπτομέρειες σχετικά με το όνομα του ενοικιαστή, το ID και το όνομα "brand". Επιπλέον, εμφανίζεται η κατάσταση του Desktop Single Sign-On (SSO), γνωστό και ως [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso). Όταν είναι ενεργοποιημένο, αυτό το χαρακτηριστικό διευκολύνει τον προσδιορισμό της παρουσίας (enumeration) ενός συγκεκριμένου χρήστη μέσα στον οργανισμό-στόχο.

Επιπλέον, η έξοδος παρουσιάζει τα ονόματα όλων των επαληθευμένων τομέων που σχετίζονται με τον ενοικιαστή-στόχο, μαζί με τους αντίστοιχους τύπους ταυτότητας τους. Στην περίπτωση των ενωμένων τομέων, το Fully Qualified Domain Name (FQDN) του παροχέα ταυτότητας που χρησιμοποιείται, συνήθως ένας διακομιστής ADFS, αποκαλύπτεται επίσης. Η στήλη "MX" καθορίζει εάν τα emails δρομολογούνται προς το Exchange Online, ενώ η στήλη "SPF" υποδεικνύει την καταχώριση του Exchange Online ως αποστολέα email. Είναι σημαντικό να σημειωθεί ότι η τρέχουσα λειτουργία αναγνώρισης δεν αναλύει τις δηλώσεις "include" μέσα στα SPF records, που μπορεί να οδηγήσει σε ψευδείς αρνητικές απαντήσεις.

### Απαρίθμηση Χρηστών

Είναι δυνατόν να **ελεγχθεί εάν υπάρχει ένα όνομα χρήστη** μέσα σε έναν ενοικιαστή. Αυτό περιλαμβάνει επίσης τους **χρήστες επισκέπτες**, των οποίων το όνομα χρήστη έχει τη μορφή:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
Το email είναι η διεύθυνση email του χρήστη όπου το "@" αντικαθίσταται με το υποκάτω παύλα "_".

Με το [**AADInternals**](https://github.com/Gerenios/AADInternals), μπορείτε εύκολα να ελέγξετε εάν ο χρήστης υπάρχει ή όχι:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
## Unauthenticated Enumeration and Initial Entry

### Introduction

In this section, we will cover the techniques used for unauthenticated enumeration and gaining initial access to Azure environments. Unauthenticated enumeration involves gathering information about the target Azure environment without the need for valid credentials. This information can then be used to identify potential entry points for further exploitation.

### Tools and Techniques

#### Azure AD Connect

Azure AD Connect is a tool used to synchronize on-premises directories with Azure AD. By querying the Azure AD Connect server, an attacker can gather information about users, groups, and other directory objects without authentication.

#### Azure Resource Manager

Azure Resource Manager provides a REST API for managing Azure resources. An attacker can query the API to gather information about resource groups, virtual machines, storage accounts, and other resources without authentication.

#### Azure DNS

Azure DNS is a cloud-based DNS service that can be used to host domain names within Azure. By querying Azure DNS servers, an attacker can gather information about domain names and DNS records without authentication.

### Conclusion

Unauthenticated enumeration is a critical step in the reconnaissance phase of a penetration test. By gathering information about the target Azure environment without authentication, an attacker can identify potential vulnerabilities and entry points for further exploitation. It is important for organizations to regularly assess their Azure environments for security weaknesses and take steps to mitigate any potential risks.
```
UserName         Exists
--------         ------
user@company.com True
```
Μπορείτε επίσης να χρησιμοποιήσετε ένα αρχείο κειμένου που περιέχει μια διεύθυνση email ανά γραμμή:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Υπάρχουν **τρεις διαφορετικές μεθόδοι απαρίθμησης** να επιλέξετε:

| Μέθοδος   | Περιγραφή                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Κανονική  | Αναφέρεται στο API GetCredentialType που αναφέρθηκε παραπάνω. Η προεπιλεγμένη μέθοδος.                                                                                                                           |
| Σύνδεση   | <p>Αυτή η μέθοδος προσπαθεί να συνδεθεί ως ο χρήστης.<br><strong>Σημείωση:</strong> οι ερωτήσεις θα καταγραφούν στο αρχείο καταγραφής συνδέσεων.</p>                                                                                       |
| Αυτόματη Σύνδεση | <p>Αυτή η μέθοδος προσπαθεί να συνδεθεί ως ο χρήστης μέσω της αυτόματης σύνδεσης.<br><strong>Οι ερωτήσεις δεν καταγράφονται</strong> στο αρχείο καταγραφής συνδέσεων! Ως εκ τούτου, λειτουργεί επίσης καλά για επιθέσεις ψεκασμού κωδικών και επιθέσεις με βία.</p> |

Αφού ανακαλύψετε τα έγκυρα ονόματα χρηστών μπορείτε να λάβετε **πληροφορίες σχετικά με έναν χρήστη** με:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Το script [**o365creeper**](https://github.com/LMGsec/o365creeper) σας επιτρέπει επίσης να ανακαλύψετε **αν ένα email είναι έγκυρο**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
**Απαρίθμηση Χρηστών μέσω του Microsoft Teams**

Μια άλλη καλή πηγή πληροφοριών είναι το Microsoft Teams.

Το API του Microsoft Teams επιτρέπει την αναζήτηση χρηστών. Συγκεκριμένα, τα σημεία πρόσβασης "εξωτερική αναζήτησηv3" και "searchUsers" μπορούν να χρησιμοποιηθούν για να ζητηθούν γενικές πληροφορίες σχετικά με λογαριασμούς χρηστών που είναι εγγεγραμμένοι στο Teams.

Ανάλογα με την απάντηση του API, είναι δυνατό να διακριθεί μεταξύ μη υπαρκτών χρηστών και υπαρκτών χρηστών που έχουν έγκυρη συνδρομή στο Teams.

Το σενάριο [**TeamsEnum**](https://github.com/sse-secure-systems/TeamsEnum) μπορεί να χρησιμοποιηθεί για την επικύρωση ενός συγκεκριμένου συνόλου ονομάτων χρηστών έναντι του API του Teams.
```bash
python3 TeamsEnum.py -a password -u <username> -f inputlist.txt -o teamsenum-output.json
```
## Unauthenticated Enumeration and Initial Entry

### Introduction

In this section, we will cover the techniques used to perform unauthenticated enumeration and gain initial access to Azure environments. Unauthenticated enumeration involves gathering information without the need for valid credentials, which can help in identifying potential entry points for further exploitation.

### Enumeration Techniques

1. **DNS Enumeration**: Discovering subdomains and associated IP addresses using tools like `dnsrecon` or `sublist3r`.
   
2. **Service Enumeration**: Identifying open ports and services running on those ports using tools like `nmap` or `masscan`.
   
3. **Web Enumeration**: Enumerating web applications for common vulnerabilities like misconfigurations or outdated software versions.
   
4. **Storage Account Enumeration**: Identifying publicly accessible storage accounts that may contain sensitive data.

### Initial Entry Points

Once potential entry points are identified through enumeration, attackers can exploit vulnerabilities to gain initial access to the Azure environment. This could involve techniques such as:

- **Brute Force Attacks**: Attempting to guess valid credentials for services like SSH or RDP.
  
- **Phishing Attacks**: Sending malicious emails to trick users into revealing their credentials.
  
- **Exploiting Misconfigurations**: Taking advantage of misconfigured services or applications to gain unauthorized access.

By understanding these techniques, security professionals can better protect Azure environments from unauthorized access and potential data breaches.
```
[-] user1@domain - Target user not found. Either the user does not exist, is not Teams-enrolled or is configured to not appear in search results (personal accounts only)
[+] user2@domain - User2 | Company (Away, Mobile)
[+] user3@domain - User3 | Company (Available, Desktop)
```
Επιπλέον, είναι δυνατόν να απαριθμηθούν πληροφορίες διαθεσιμότητας σχετικά με υπάρχοντες χρήστες όπως τα παρακάτω:

- Διαθέσιμος
- Μακριά
- Μην Ενοχλείτε
- Απασχολημένος
- Εκτός σύνδεσης

Εάν έχει ρυθμιστεί ένα **μήνυμα εκτός γραφείου**, είναι επίσης δυνατό να ανακτηθεί το μήνυμα χρησιμοποιώντας το TeamsEnum. Εάν έχει καθοριστεί ένα αρχείο εξόδου, τα μηνύματα εκτός γραφείου αποθηκεύονται αυτόματα στο JSON αρχείο:
```
jq . teamsenum-output.json
```
## Unauthenticated Enumeration and Initial Entry

### Introduction

In this section, we will cover techniques for unauthenticated enumeration and gaining initial access to Azure environments. Unauthenticated enumeration involves gathering information from publicly available sources without the need for authentication. This information can then be used to identify potential entry points into the target Azure environment.

### Tools and Techniques

#### 1. **DNS Enumeration**

DNS enumeration can reveal valuable information about the target Azure environment, such as subdomains and associated IP addresses. Tools like `dnsrecon` and `dnsenum` can be used to perform DNS enumeration.

#### 2. **Subdomain Enumeration**

Discovering subdomains can help identify additional entry points into the Azure environment. Tools like `Sublist3r` and `Amass` can be used to enumerate subdomains.

#### 3. **Open Port Scanning**

Scanning for open ports can reveal services running in the Azure environment. Tools like `Nmap` can be used to scan for open ports and identify potential vulnerabilities.

#### 4. **Web Application Enumeration**

Enumerating web applications can help identify potential entry points for further exploitation. Tools like `Dirb` and `Gobuster` can be used to discover hidden directories and files on web servers.

### Conclusion

Unauthenticated enumeration is a critical phase in the penetration testing process, as it can provide valuable insights into the target Azure environment. By leveraging tools and techniques like DNS enumeration, subdomain enumeration, open port scanning, and web application enumeration, pentesters can gather important information to facilitate further exploitation and penetration testing activities.
```json
{
"email": "user2@domain",
"exists": true,
"info": [
{
"tenantId": "[REDACTED]",
"isShortProfile": false,
"accountEnabled": true,
"featureSettings": {
"coExistenceMode": "TeamsOnly"
},
"userPrincipalName": "user2@domain",
"givenName": "user2@domain",
"surname": "",
"email": "user2@domain",
"tenantName": "Company",
"displayName": "User2",
"type": "Federated",
"mri": "8:orgid:[REDACTED]",
"objectId": "[REDACTED]"
}
],
"presence": [
{
"mri": "8:orgid:[REDACTED]",
"presence": {
"sourceNetwork": "Federated",
"calendarData": {
"outOfOfficeNote": {
"message": "Dear sender. I am out of the office until March 23rd with limited access to my email. I will respond after my return.Kind regards, User2",
"publishTime": "2023-03-15T21:44:42.0649385Z",
"expiry": "2023-04-05T14:00:00Z"
},
"isOutOfOffice": true
},
"capabilities": [
"Audio",
"Video"
],
"availability": "Away",
"activity": "Away",
"deviceType": "Mobile"
},
"etagMatch": false,
"etag": "[REDACTED]",
"status": 20000
}
]
}
```
## Υπηρεσίες Azure

Γνωρίζοντας τώρα τους **τομείς που χρησιμοποιεί ο Azure tenant** είναι η στιγμή να προσπαθήσουμε να βρούμε τις **υπηρεσίες Azure που εκτίθενται**.

Μπορείτε να χρησιμοποιήσετε μια μέθοδο από το [**MicroBust**](https://github.com/NetSPI/MicroBurst) για αυτόν τον σκοπό. Αυτή η λειτουργία θα αναζητήσει το βασικό όνομα τομέα (και μερικές παραλλαγές) σε διάφορους **τομείς υπηρεσιών Azure:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Ανοιχτή Αποθήκευση

Μπορείτε να ανακαλύψετε ανοιχτές αποθηκεύσεις με ένα εργαλείο όπως το [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) το οποίο θα χρησιμοποιήσει το αρχείο **`Microburst/Misc/permitations.txt`** για τη δημιουργία περιπτώσεων (πολύ απλές) προκειμένου να **εντοπίσει ανοιχτούς λογαριασμούς αποθήκευσης**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URLs

Ένα _**shared access signature**_ (SAS) URL είναι ένα URL που **παρέχει πρόσβαση** σε συγκεκριμένο τμήμα ενός λογαριασμού αποθήκευσης (μπορεί να είναι ένας ολόκληρος container, ένα αρχείο...) με κάποιες συγκεκριμένες άδειες (ανάγνωση, εγγραφή...) πάνω στους πόρους. Αν βρείτε ένα διαρρεύσει μπορείτε να έχετε πρόσβαση σε ευαίσθητες πληροφορίες, μοιάζουν με αυτό (αυτό είναι για πρόσβαση σε ένα container, αν απλά χορηγούσε πρόσβαση σε ένα αρχείο, το μονοπάτι του URL θα περιείχε επίσης αυτό το αρχείο):

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Χρησιμοποιήστε το [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) για πρόσβαση στα δεδομένα

## Compromise Credentials

### Phishing

* [**Common Phishing**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (διαπραγμάτευση διαπιστευτήσεων ή OAuth App -[Illicit Consent Grant Attack](az-illicit-consent-grant.md)-)
* [**Device Code Authentication** Phishing](az-device-code-authentication-phishing.md)

### Password Spraying / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## References

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)
* [https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/](https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**Ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή την [**ομάδα τηλεγράφου**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκινγκ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
{% endhint %}
