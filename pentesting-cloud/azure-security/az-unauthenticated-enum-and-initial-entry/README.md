# Az - Kimlik Doğrulamasız Enum ve Başlangıç Girişi

{% hint style="success" %}
AWS Hacking öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## Azure Kiracı

### Kiracı Numaralandırma

Sadece **kiracının alan adını** bilen bir saldırgan, daha fazla bilgi toplamak için sorgulayabileceği **bazı** **genel Azure API'leri** vardır.\
API'yi doğrudan sorgulayabilir veya PowerShell kütüphanesi [**AADInternals**](https://github.com/Gerenios)**'ı kullanabilirsiniz:**

| API                                                                  | Bilgi                                                                                                                                                                                                                                                | AADInternals işlevi                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Kiracı kimlik bilgileri** dahil olmak üzere **Giriş bilgileri**                                                                                                                                                                                      | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | Kiracının **tüm alan adları**                                                                                                                                                                                                                        | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p>Kiracının **Giriş bilgileri**, kiracı Adı ve alan adı dahil olmak üzere **giriş bilgileri**, <strong>kimlik doğrulama türü.</strong><br>Eğer <code>NameSpaceType</code> **Yönetilen** ise, bu **AzureAD**'nin kullanıldığı anlamına gelir.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Giriş bilgileri, **Masaüstü SSO bilgileri** dahil                                                                                                                                                                                                    | `Get-AADIntLoginInformation -UserName <UserName>` |

Azure kiracısının tüm bilgilerini **yalnızca** [**AADInternals**](https://github.com/Gerenios) **kütüphanesinin bir komutu ile** sorgulayabilirsiniz:
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Azure kiracı bilgileri çıktı örneği:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Tenant'ın adı, kimliği ve "marka" adı hakkında ayrıntıları gözlemlemek mümkündür. Ayrıca, Masaüstü Tek Oturum Açma (SSO) durumu, ayrıca [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso) olarak bilinir, görüntülenir. Bu özellik etkinleştirildiğinde, bu özellik hedef organizasyondaki belirli bir kullanıcının varlığının belirlenmesini kolaylaştırır (enumarasyon).

Ayrıca, çıktı hedef kiracıyla ilişkilendirilmiş tüm doğrulanmış alanların adlarını ve bunların ilgili kimlik türlerini sunar. Federasyonlu alanlar durumunda, genellikle bir ADFS sunucusu olan kullanılan kimlik sağlayıcısının Tam Nitelikli Alan Adı (FQDN) de açıklanır. "MX" sütunu e-postaların Exchange Online'a yönlendirilip yönlendirilmediğini belirtirken, "SPF" sütunu Exchange Online'ı bir e-posta gönderici olarak listeler. Mevcut keşif işlevinin SPF kayıtlarındaki "include" ifadelerini ayrıştırmadığı, bu durumun yanlış negatiflere neden olabileceği önemlidir.

### Kullanıcı Enumarasyonu

Tenant içinde bir kullanıcı adının var olup olmadığını kontrol etmek mümkündür. Bu aynı zamanda **konuk kullanıcıları** da içerir, bunların kullanıcı adı şu formatta olabilir:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
E-posta, kullanıcının e-posta adresidir ve "@" işareti alt tire "_" ile değiştirilmiştir.

[**AADInternals**](https://github.com/Gerenios/AADInternals) ile kullanıcının var olup olmadığını kolayca kontrol edebilirsiniz:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
## Azure Unauthenticated Enumeration and Initial Entry

### Unauthenticated Enumeration

1. **Service Discovery**: Utilize tools like `nmap`, `masscan`, and `shodan` to discover exposed services and endpoints.
   
2. **Storage Accounts**: Enumerate storage accounts using tools like `azcopy` and `Azure Storage Explorer` to identify publicly accessible data.

3. **Blob Containers**: Enumerate blob containers within storage accounts to identify sensitive data or misconfigurations.

4. **Web Applications**: Use tools like `dirb` or `gobuster` to discover web applications and directories that may contain vulnerabilities.

### Initial Entry

1. **Weak Credentials**: Attempt default or weak credentials on exposed services like RDP, SSH, or web applications.

2. **Phishing Attacks**: Send phishing emails to Azure users to obtain credentials or deliver payloads for initial access.

3. **Exploiting Misconfigurations**: Exploit misconfigurations in services like storage accounts or web applications to gain unauthorized access.

4. **Brute Force Attacks**: Conduct brute force attacks against login portals or services with weak authentication mechanisms.

5. **Social Engineering**: Gather information about Azure users through social engineering tactics to craft targeted attacks.
```
UserName         Exists
--------         ------
user@company.com True
```
Ayrıca, her satırda bir e-posta adresi içeren bir metin dosyası da kullanabilirsiniz:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
**Üç farklı numaralandırma yöntemi** arasından seçim yapabilirsiniz:

| Yöntem    | Açıklama                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | Bu yukarıda bahsedilen GetCredentialType API'sine atıfta bulunur. Varsayılan yöntem.                                                                                                                           |
| Giriş     | <p>Bu yöntem, kullanıcı olarak giriş yapmaya çalışır.<br><strong>Not:</strong> sorgular oturum açma kayıtlarına kaydedilecektir.</p>                                                                                       |
| Otomatik Giriş | <p>Bu yöntem, kullanıcı olarak otomatik giriş noktası aracılığıyla giriş yapmaya çalışır.<br><strong>Sorgular</strong> oturum açma kayıtlarına kaydedilmez! Bu nedenle, parola püskürtme ve kaba kuvvet saldırıları için de iyi çalışır.</p> |

Geçerli kullanıcı adlarını keşfettikten sonra bir kullanıcı hakkında **bilgi alabilirsiniz**.
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Betik [**o365creeper**](https://github.com/LMGsec/o365creeper) ayrıca **bir e-postanın geçerli olup olmadığını keşfetmenize** olanak tanır.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
**Microsoft Teams Üzerinden Kullanıcı Numaralandırma**

Bilgi için başka bir iyi kaynak Microsoft Teams'tir.

Microsoft Teams'in API'si kullanıcı aramaya izin verir. Özellikle "kullanıcı arama" uç noktaları **externalsearchv3** ve **searchUsers**, Teams'e kayıtlı kullanıcı hesapları hakkında genel bilgi talep etmek için kullanılabilir.

API yanıtına bağlı olarak, mevcut olmayan kullanıcılar ile geçerli bir Teams aboneliği olan mevcut kullanıcılar arasında ayrım yapmak mümkündür.

[**TeamsEnum**](https://github.com/sse-secure-systems/TeamsEnum) betiği, belirli bir kullanıcı adı kümesini Teams API'sine karşı doğrulamak için kullanılabilir.
```bash
python3 TeamsEnum.py -a password -u <username> -f inputlist.txt -o teamsenum-output.json
```
## Az Unauthenticated Enumeration and Initial Entry

### Unauthenticated Enumeration

1. **Service Discovery**: Use tools like `nmap`, `masscan`, or `shodan` to discover exposed services and ports.
2. **Web Applications**: Look for web applications and APIs that might be exposed. Tools like `dirsearch`, `gobuster`, or `ffuf` can be helpful for this.
3. **Storage Accounts**: Identify exposed storage accounts using tools like `azurite`, `azcopy`, or `azdata`.
4. **Database Services**: Search for exposed database services like SQL databases or NoSQL databases.
5. **Other Services**: Check for any other exposed services like Redis, Elasticsearch, etc.

### Initial Entry

1. **Weak Credentials**: Try default or common credentials for services discovered during enumeration.
2. **Brute Force**: Use tools like `hydra`, `medusa`, or `patator` to brute force login pages or services.
3. **Exploitation**: Look for known vulnerabilities in the services or applications discovered during enumeration. Use tools like `searchsploit` or `exploitdb` to find exploits.
4. **Phishing**: Send phishing emails to gather credentials or perform social engineering attacks.
5. **Client-Side Attacks**: Exploit vulnerabilities in client applications or browsers to gain access to the system.
```
[-] user1@domain - Target user not found. Either the user does not exist, is not Teams-enrolled or is configured to not appear in search results (personal accounts only)
[+] user2@domain - User2 | Company (Away, Mobile)
[+] user3@domain - User3 | Company (Available, Desktop)
```
Ayrıca mevcut kullanıcılar hakkında kullanılabilirlik bilgilerini şu şekilde sıralamak mümkündür:

- Uygun
- Uzakta
- Rahatsız Etmeyin
- Meşgul
- Çevrimdışı

Eğer bir **dışarıda mesajı** yapılandırılmışsa, TeamsEnum kullanılarak mesaj alınabilir. Bir çıkış dosyası belirtildiyse, dışarıda mesajları otomatik olarak JSON dosyasına kaydedilir:
```
jq . teamsenum-output.json
```
## Az Unauthenticated Enumeration and Initial Entry

### Unauthenticated Enumeration

1. **Service Discovery**: Utilize tools like `nmap`, `masscan`, and `shodan` to discover exposed services and endpoints.
   
2. **Storage Account Enumeration**: Enumerate storage accounts using tools like `azcopy` and `Azure Storage Explorer`.

3. **Blob Enumeration**: Enumerate blobs within storage accounts using tools like `azcopy` and `Azure Storage Explorer`.

4. **Cosmos DB Enumeration**: Enumerate Cosmos DB instances using tools like `Cosmos DB Explorer`.

5. **SQL Database Enumeration**: Enumerate SQL databases using tools like `mssql-cli` and `Azure Data Studio`.

### Initial Entry

1. **Weak Credentials**: Attempt to login using default or weak credentials for services like Azure Portal, Azure CLI, and Azure Management API.

2. **Brute Force**: Perform brute force attacks against login portals and services with weak authentication mechanisms.

3. **Phishing**: Conduct phishing campaigns to trick users into revealing their credentials or executing malicious actions.

4. **Exploiting Misconfigurations**: Exploit misconfigurations in services like Azure Blob Storage, Azure App Services, and Azure Functions to gain unauthorized access.

5. **Social Engineering**: Use social engineering techniques to manipulate individuals into providing access or sensitive information.
```json
{
"email": "user2@domain",
"exists": true,
"info": [
{
"tenantId": "[REDACTED]",
"isShortProfile": false,
"accountEnabled": true,
"featureSettings": {
"coExistenceMode": "TeamsOnly"
},
"userPrincipalName": "user2@domain",
"givenName": "user2@domain",
"surname": "",
"email": "user2@domain",
"tenantName": "Company",
"displayName": "User2",
"type": "Federated",
"mri": "8:orgid:[REDACTED]",
"objectId": "[REDACTED]"
}
],
"presence": [
{
"mri": "8:orgid:[REDACTED]",
"presence": {
"sourceNetwork": "Federated",
"calendarData": {
"outOfOfficeNote": {
"message": "Dear sender. I am out of the office until March 23rd with limited access to my email. I will respond after my return.Kind regards, User2",
"publishTime": "2023-03-15T21:44:42.0649385Z",
"expiry": "2023-04-05T14:00:00Z"
},
"isOutOfOffice": true
},
"capabilities": [
"Audio",
"Video"
],
"availability": "Away",
"activity": "Away",
"deviceType": "Mobile"
},
"etagMatch": false,
"etag": "[REDACTED]",
"status": 20000
}
]
}
```
## Azure Hizmetleri

Azure kiracısının kullandığı alan adlarını bildiğimize göre artık **açığa çıkarılmış Azure hizmetlerini bulmaya çalışma zamanı**.

Bu hedefe ulaşmak için [**MicroBust**](https://github.com/NetSPI/MicroBurst)'tan bir yöntem kullanabilirsiniz. Bu işlev, temel alan adı (ve birkaç türevini) birkaç **Azure hizmet alanında** arayacaktır:
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Açık Depolama

Açık depolamayı keşfedebilirsiniz, [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) gibi bir araç kullanarak, bu araç **`Microburst/Misc/permitations.txt`** dosyasını kullanarak basit permutasyonlar oluşturacak ve **açık depolama hesaplarını bulmaya çalışacaktır**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URL'leri

Bir _**paylaşılan erişim imzası**_ (SAS) URL'si, belirli bir Depolama hesabının belirli bir bölümüne (tam bir konteyner, bir dosya olabilir...) belirli izinlerle (okuma, yazma...) erişim sağlayan bir URL'dir. Eğer sızdırılmış bir tane bulursanız, hassas bilgilere erişebilirsiniz, şöyle görünürler (bu bir konteynere erişim sağlamak için, eğer sadece bir dosyaya erişim sağlıyorsa URL'nin yolu aynı zamanda o dosyayı da içerecektir):

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Verilere erişmek için [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) kullanın

## Kimlik Bilgilerinin Tehdit Altında Olması

### Sosyal Mühendislik

* [**Yaygın Sosyal Mühendislik**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (kimlik bilgileri veya OAuth Uygulaması -[Yasadışı Onay Hibe Saldırısı](az-illicit-consent-grant.md)-)
* [**Cihaz Kodu Kimlik Doğrulama** Sosyal Mühendislik](az-device-code-authentication-phishing.md)

### Parola Sıkmak / Kaba Kuvvet Saldırısı

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Referanslar

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)
* [https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/](https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
