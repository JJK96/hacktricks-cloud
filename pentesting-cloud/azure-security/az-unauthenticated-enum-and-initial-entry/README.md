# Az - Neautentifikovano Enumerisanje & Početni pristup

{% hint style="success" %}
Naučite i vežbajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Obuka AWS Crveni Tim Stručnjak (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Obuka GCP Crveni Tim Stručnjak (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Azure Tenant

### Enumeracija Tenanta

Postoje neke **javne Azure API-je** za koje samo poznavanje **domena tenanta** omogućava napadaču da pretražuje više informacija o njemu.\
Možete direktno pretraživati API ili koristiti PowerShell biblioteku [**AADInternals**](https://github.com/Gerenios)**:**

| API                                                                  | Informacije                                                                                                                                                                                                                                           | Funkcija AADInternals                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informacije za prijavljivanje**, uključujući ID tenanta                                                                                                                                                                                              | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Svi domeni** tenanta                                                                                                                                                                                                                               | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Informacije za prijavljivanje</strong> tenanta, uključujući ime tenanta i domen <strong>tip autentifikacije.</strong><br>Ako je <code>NameSpaceType</code> <strong><code>Managed</code></strong>, to znači da se koristi <strong>AzureAD</strong>.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informacije za prijavljivanje, uključujući **informacije o Desktop SSO-u**                                                                                                                                                                             | `Get-AADIntLoginInformation -UserName <UserName>` |

Možete pretražiti sve informacije o Azure tenantu sa **samo jednom komandom** [**AADInternals**](https://github.com/Gerenios) **biblioteke**:
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Primer izlaza informacija o Azure zakupcu:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Moguće je posmatrati detalje o imenu zakupca, ID-u i imenu "brenda". Dodatno, prikazan je status Desktop Single Sign-On (SSO), poznat i kao [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso). Kada je omogućena, ova funkcija olakšava određivanje prisustva (enumeracije) određenog korisnika unutar ciljne organizacije.

Osim toga, izlaz prikazuje imena svih verifikovanih domena povezanih sa ciljnim zakupcem, zajedno sa njihovim odgovarajućim tipovima identiteta. U slučaju federiranih domena, potpuno kvalifikovano ime domena (FQDN) identitetskog provajdera u upotrebi, obično ADFS servera, takođe je otkriveno. Kolona "MX" specificira da li se e-pošta usmerava ka Exchange Online-u, dok kolona "SPF" označava navođenje Exchange Online-a kao pošiljaoca e-pošte. Važno je napomenuti da trenutna funkcija izviđanja ne analizira "include" izjave unutar SPF zapisa, što može rezultirati lažnim negativima.

### Enumeracija Korisnika

Moguće je **proveriti da li korisničko ime postoji** unutar zakupca. To uključuje i **gostujuće korisnike**, čije korisničko ime ima format:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
Email adresa je korisnikova email adresa gde je znak "@" zamenjen sa donjom crtom "\_".

Sa [**AADInternals**](https://github.com/Gerenios/AADInternals), možete lako proveriti da li korisnik postoji ili ne:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
## Neautentifikovano nabrajanje i početni ulaz

U ovom scenariju, napadač će koristiti neautentifikovane metode za nabrajanje resursa i pristup početnom ulazu u Azure okruženje.

### Nabrajanje resursa

Nabrajanje resursa može biti izvršeno korišćenjem različitih tehnika kao što su pretraga javno dostupnih informacija, upotreba API-ja za nabrajanje resursa ili skeniranje IP adresa za identifikaciju dostupnih resursa.

### Pristup početnom ulazu

Nakon što su resursi uspešno nabrojani, napadač može iskoristiti ove informacije za pronalaženje početnog ulaza u Azure okruženje. To može uključivati pronalaženje nezaštićenih servisa, slabe lozinke ili ranjivosti koje omogućavaju pristup sistemu.
```
UserName         Exists
--------         ------
user@company.com True
```
Možete takođe koristiti tekstualni fajl koji sadrži jednu email adresu po redu:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Postoje **tri različite metode enumeracije** koje možete odabrati:

| Metoda    | Opis                                                                                                                                                                                                   |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normalna  | Ovo se odnosi na GetCredentialType API pomenut gore. Podrazumevana metoda.                                                                                                                              |
| Prijava   | <p>Ova metoda pokušava da se prijavi kao korisnik.<br><strong>Napomena:</strong> upiti će biti zabeleženi u logovima prijava.</p>                                                                       |
| Autologon | <p>Ova metoda pokušava da se prijavi kao korisnik putem autologon endpointa.<br><strong>Upiti nisu zabeleženi</strong> u logovima prijava! Stoga dobro funkcioniše i za napade poput prskanja lozinki i napada grubom silom.</p> |

Nakon otkrivanja validnih korisničkih imena možete dobiti **informacije o korisniku** sa:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Skripta [**o365creeper**](https://github.com/LMGsec/o365creeper) takođe vam omogućava da otkrijete **da li je e-pošta validna**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
**Enumeracija korisnika putem Microsoft Teams-a**

Još jedan dobar izvor informacija je Microsoft Teams.

API Microsoft Teams-a omogućava pretragu korisnika. Konkretno, endpointovi "externalsearchv3" i "searchUsers" mogu se koristiti za zahtevanje opštih informacija o korisničkim nalozima u Teams-u.

Na osnovu odgovora API-ja moguće je razlikovati nepostojeće korisnike od postojećih korisnika koji imaju važeću pretplatu na Teams.

Skript [**TeamsEnum**](https://github.com/sse-secure-systems/TeamsEnum) može se koristiti za proveru datog skupa korisničkih imena prema Teams API-ju.
```bash
python3 TeamsEnum.py -a password -u <username> -f inputlist.txt -o teamsenum-output.json
```
## Neautentifikovano nabrajanje i početni ulaz

U ovom scenariju, cilj je identifikovati i prikupiti informacije o Azure okruženju bez potrebe za autentifikacijom. Ovo može uključivati otkrivanje javno dostupnih resursa, servisa, informacija o konfiguraciji i drugih korisnih detalja koji mogu pomoći u kasnijim fazama testiranja penetracije. Ove informacije mogu biti korisne za identifikaciju potencijalnih tačaka ulaza ili slabih mesta u sistemu.
```
[-] user1@domain - Target user not found. Either the user does not exist, is not Teams-enrolled or is configured to not appear in search results (personal accounts only)
[+] user2@domain - User2 | Company (Away, Mobile)
[+] user3@domain - User3 | Company (Available, Desktop)
```
Takođe je moguće nabrojati informacije o dostupnosti postojećih korisnika kao što su:

- Dostupan
- Odsutan
- Ne uznemiravaj
- Zauzet
- Van mreže

Ako je konfigurisana **poruka van kancelarije**, moguće je povratiti poruku pomoću TeamsEnum-a. Ako je navedena izlazna datoteka, poruke van kancelarije automatski se čuvaju u JSON datoteci:
```
jq . teamsenum-output.json
```
## Neautentifikovano nabrajanje i početni ulaz

U ovom scenariju, napadač će iskoristiti neautentifikovano nabrajanje resursa i ranjivost početnog ulaza kako bi dobio pristup Azure okruženju.

### Koraci napada:

1. **Nabrajanje resursa**: Napadač će koristiti alate poput `azuriraj` ili `azuriraj-cli` za nabrajanje resursa u Azure okruženju bez potrebe za autentifikacijom.

2. **Identifikacija osetljivih informacija**: Napadač će identifikovati osetljive informacije kao što su lozinke, ključevi ili druge kritične informacije.

3. **Eksploatacija ranjivosti početnog ulaza**: Koristeći otkrivene osetljive informacije, napadač će iskoristiti ranjivost početnog ulaza kako bi dobio pristup Azure okruženju.

### Mere zaštite:

- Redovno ažuriranje i praćenje Azure okruženja radi otkrivanja neobičnih aktivnosti.
- Korišćenje višefaktorskog autentifikovanja radi dodatne sigurnosti.
- Implementacija principa najmanjih privilegija kako bi se smanjio rizik od zloupotrebe privilegija.
```json
{
"email": "user2@domain",
"exists": true,
"info": [
{
"tenantId": "[REDACTED]",
"isShortProfile": false,
"accountEnabled": true,
"featureSettings": {
"coExistenceMode": "TeamsOnly"
},
"userPrincipalName": "user2@domain",
"givenName": "user2@domain",
"surname": "",
"email": "user2@domain",
"tenantName": "Company",
"displayName": "User2",
"type": "Federated",
"mri": "8:orgid:[REDACTED]",
"objectId": "[REDACTED]"
}
],
"presence": [
{
"mri": "8:orgid:[REDACTED]",
"presence": {
"sourceNetwork": "Federated",
"calendarData": {
"outOfOfficeNote": {
"message": "Dear sender. I am out of the office until March 23rd with limited access to my email. I will respond after my return.Kind regards, User2",
"publishTime": "2023-03-15T21:44:42.0649385Z",
"expiry": "2023-04-05T14:00:00Z"
},
"isOutOfOffice": true
},
"capabilities": [
"Audio",
"Video"
],
"availability": "Away",
"activity": "Away",
"deviceType": "Mobile"
},
"etagMatch": false,
"etag": "[REDACTED]",
"status": 20000
}
]
}
```
## Azure Usluge

Sada kada znamo **domene koje Azure zakupac** koristi, vreme je da pokušamo da pronađemo **izložene Azure usluge**.

Možete koristiti metod iz [**MicroBurst**](https://github.com/NetSPI/MicroBurst) za ovaj cilj. Ova funkcija će pretražiti osnovno ime domena (i nekoliko permutacija) u nekoliko **domena Azure usluga:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Otvoreno skladištenje

Možete otkriti otvoreno skladištenje pomoću alata poput [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) koji će koristiti datoteku **`Microburst/Misc/permitations.txt`** za generisanje permutacija (vrlo jednostavno) kako bi pokušao **pronaći otvorene skladišne naloge**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URL-ovi

_**URL sa deljenim pristupom**_ (SAS) je URL koji **omogućava pristup** određenom delu skladišnog naloga (može biti cela kontejner, datoteka...) sa određenim dozvolama (čitanje, pisanje...) nad resursima. Ako pronađete procureli URL, možete pristupiti osetljivim informacijama, izgledaju ovako (ovo je za pristup kontejneru, ako je samo davao pristup datoteci, putanja URL-a će takođe sadržati tu datoteku):

`https://<ime_skladišnog_naloga>.blob.core.windows.net/novikontejner?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Koristite [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) za pristup podacima

## Kompromitovanje Poverljivih Podataka

### Fišing

* [**Uobičajeni Fišing**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (poverljivi podaci ili OAuth aplikacija -[Napad na neovlašćeno davanje saglasnosti](az-illicit-consent-grant.md)-)
* [**Fišing za Autentifikaciju Koda uređaja**](az-device-code-authentication-phishing.md)

### Prskanje Lozinki / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Reference

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)
* [https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/](https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/)

{% hint style="success" %}
Naučite i vežbajte hakovanje AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Obuka AWS Crveni Tim Ekspert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Obuka GCP Crveni Tim Ekspert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
