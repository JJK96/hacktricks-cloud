# Az - Nieuwierzytelniona Enumeracja & PoczƒÖtkowe Wej≈õcie

{% hint style="success" %}
Dowiedz siƒô i ƒáwicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Szkolenie AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz siƒô i ƒáwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Szkolenie GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd≈∫ [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Do≈ÇƒÖcz do** üí¨ [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **≈õled≈∫** nas na **Twitterze** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostƒôpnij sztuczki hakerskie, przesy≈ÇajƒÖc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori√≥w na githubie.

</details>
{% endhint %}

## Azure Tenant

### Enumeracja Tenant√≥w

IstniejƒÖ **publiczne interfejsy API Azure**, kt√≥re pozwalajƒÖ hakerowi na zbieranie informacji o **domenie tenant'a**, znajƒÖc jedynie tƒô domenƒô.\
Mo≈ºesz zapytaƒá bezpo≈õrednio API lub skorzystaƒá z biblioteki PowerShell [**AADInternals**](https://github.com/Gerenios)**:**

| API                                                                  | Informacje                                                                                                                                                                                                                                           | Funkcja AADInternals                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informacje logowania**, w tym ID tenant'a                                                                                                                                                                                                            | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Wszystkie domeny** tenant'a                                                                                                                                                                                                                         | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Informacje logowania</strong> tenant'a, w tym nazwa tenant'a i domena <strong>typu uwierzytelniania.</strong><br>Je≈õli <code>NameSpaceType</code> to <strong><code>Managed</code></strong>, oznacza to, ≈ºe u≈ºywane jest <strong>AzureAD</strong>.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informacje logowania, w tym **informacje o Desktop SSO**                                                                                                                                                                                              | `Get-AADIntLoginInformation -UserName <UserName>` |

Mo≈ºesz zapytaƒá o wszystkie informacje dotyczƒÖce tenant'a Azure za pomocƒÖ **tylko jednej komendy z** [**biblioteki AADInternals**](https://github.com/Gerenios):
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Przyk≈Çadowy wynik informacji o dzier≈ºawcy Azure:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Mo≈ºliwe jest obserwowanie szczeg√≥≈Ç√≥w dotyczƒÖcych nazwy najemcy, identyfikatora i nazwy "marki". Dodatkowo wy≈õwietlany jest status funkcji Jednokrotnego Logowania do Pulpitu (SSO), znanej r√≥wnie≈º jako [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso). Gdy ta funkcja jest w≈ÇƒÖczona, u≈Çatwia to okre≈õlenie obecno≈õci (enumeracji) okre≈õlonego u≈ºytkownika w organizacji docelowej.

 Ponadto wynik prezentuje nazwy wszystkich zweryfikowanych domen powiƒÖzanych z docelowym najemcƒÖ, wraz z odpowiadajƒÖcymi im typami to≈ºsamo≈õci. W przypadku domen federowanych ujawniany jest Pe≈Çna Nazwa Domeny (FQDN) dostawcy to≈ºsamo≈õci u≈ºywanej, zazwyczaj serwera ADFS. Kolumna "MX" okre≈õla, czy e-maile sƒÖ kierowane do Exchange Online, podczas gdy kolumna "SPF" oznacza wymienienie Exchange Online jako nadawcy e-maili. Wa≈ºne jest zauwa≈ºenie, ≈ºe bie≈ºƒÖca funkcja rozpoznawania nie analizuje instrukcji "include" w rekordach SPF, co mo≈ºe prowadziƒá do fa≈Çszywych negatyw√≥w.

### Enumeracja U≈ºytkownik√≥w

Mo≈ºliwe jest **sprawdzenie, czy nazwa u≈ºytkownika istnieje** wewnƒÖtrz najemcy. Dotyczy to r√≥wnie≈º **u≈ºytkownik√≥w go≈õci**, kt√≥rych nazwa u≈ºytkownika ma format:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
E-mail to adres e-mail u≈ºytkownika, gdzie w miejscu ‚Äû@‚Äù jest zastƒÖpiony podkre≈õlnikiem ‚Äû\_‚Äú.

Z [**AADInternals**](https://github.com/Gerenios/AADInternals) mo≈ºesz ≈Çatwo sprawdziƒá, czy u≈ºytkownik istnieje, czy nie:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
## Unauthenticated Enumeration and Initial Entry

### Unauthenticated Enumeration

During the initial phase of a penetration test, it is crucial to gather as much information as possible without triggering any alerts. Unauthenticated enumeration involves collecting data from publicly available sources such as search engines, public repositories, and social media platforms. This information can provide valuable insights into the target organization's infrastructure, applications, and potential security weaknesses.

### Initial Entry

Once sufficient information has been gathered through unauthenticated enumeration, the next step is to identify potential entry points into the target environment. This could involve exploiting misconfigurations, weak credentials, or known vulnerabilities in the target's systems. By leveraging this information, a penetration tester can gain initial access to the target environment and begin further exploitation activities.
```
UserName         Exists
--------         ------
user@company.com True
```
Mo≈ºesz r√≥wnie≈º u≈ºyƒá pliku tekstowego zawierajƒÖcego jeden adres e-mail na wiersz:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
IstniejƒÖ **trzy r√≥≈ºne metody wyliczania** do wyboru:

| Metoda    | Opis                                                                                                                                                                                                   |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | Odnosi siƒô to do wspomnianego powy≈ºej interfejsu API GetCredentialType. Metoda domy≈õlna.                                                                                                               |
| Login     | <p>Ta metoda pr√≥buje zalogowaƒá siƒô jako u≈ºytkownik.<br><strong>Uwaga:</strong> zapytania zostanƒÖ zapisane w dzienniku logowa≈Ñ logowa≈Ñ.</p>                                                               |
| Autologon | <p>Ta metoda pr√≥buje zalogowaƒá siƒô jako u≈ºytkownik za pomocƒÖ punktu ko≈Ñcowego autologowania.<br><strong>Zapytania nie sƒÖ rejestrowane</strong> w dzienniku logowa≈Ñ logowa≈Ñ! Dlatego dobrze dzia≈Ça r√≥wnie≈º dla atak√≥w typu password spray i brute-force.</p> |

Po odkryciu poprawnych nazw u≈ºytkownik√≥w mo≈ºesz uzyskaƒá **informacje o u≈ºytkowniku** za pomocƒÖ:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Skrypt [**o365creeper**](https://github.com/LMGsec/o365creeper) pozwala r√≥wnie≈º odkryƒá, **czy adres e-mail jest poprawny**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
**Wymienianie u≈ºytkownik√≥w za pomocƒÖ Microsoft Teams**

Kolejnym dobrym ≈∫r√≥d≈Çem informacji jest Microsoft Teams.

API Microsoft Teams umo≈ºliwia wyszukiwanie u≈ºytkownik√≥w. W szczeg√≥lno≈õci punkty ko≈Ñcowe "wyszukiwania u≈ºytkownik√≥w" **externalsearchv3** i **searchUsers** mogƒÖ byƒá u≈ºywane do ≈ºƒÖdania og√≥lnych informacji o kontach u≈ºytkownik√≥w zarejestrowanych w Teams.

W zale≈ºno≈õci od odpowiedzi API mo≈ºna odr√≥≈ºniƒá miƒôdzy nieistniejƒÖcymi u≈ºytkownikami a istniejƒÖcymi u≈ºytkownikami posiadajƒÖcymi wa≈ºnƒÖ subskrypcjƒô Teams.

Skrypt [**TeamsEnum**](https://github.com/sse-secure-systems/TeamsEnum) mo≈ºe byƒá u≈ºyty do sprawdzenia okre≈õlonego zestawu nazw u≈ºytkownik√≥w w stosunku do API Teams.
```bash
python3 TeamsEnum.py -a password -u <username> -f inputlist.txt -o teamsenum-output.json
```
## Unauthenticated Enumeration and Initial Entry

### Introduction

In this section, we will cover the techniques used to perform unauthenticated enumeration and gain initial access to Azure environments. Unauthenticated enumeration involves gathering information from publicly available sources without the need for valid credentials. This information can then be used to identify potential entry points into the target Azure environment.

### Tools and Techniques

#### 1. **Public Information Gathering**

   - **Description:** Publicly available information such as DNS records, subdomains, and open ports can provide valuable insights into the target Azure environment.
   
   - **Tools:** `nslookup`, `dig`, `nmap`
   
   - **Techniques:** 
     - Enumerate DNS records to identify subdomains.
     - Use port scanning to discover open ports and services.

#### 2. **Service Identification**

   - **Description:** Identifying specific services running in the Azure environment can help in understanding the attack surface and potential vulnerabilities.
   
   - **Tools:** `nmap`, `curl`, web browsers
   
   - **Techniques:** 
     - Use service banners and responses to identify services.
     - Explore web applications for common vulnerabilities.

#### 3. **Exploitation**

   - **Description:** Once potential entry points are identified, further exploitation can be attempted to gain initial access to the Azure environment.
   
   - **Tools:** Exploitation frameworks, custom scripts
   
   - **Techniques:** 
     - Exploit known vulnerabilities in services.
     - Attempt brute force attacks on login portals.

By following these techniques, an attacker can gather valuable information and potentially gain initial access to Azure environments without the need for valid credentials.
```
[-] user1@domain - Target user not found. Either the user does not exist, is not Teams-enrolled or is configured to not appear in search results (personal accounts only)
[+] user2@domain - User2 | Company (Away, Mobile)
[+] user3@domain - User3 | Company (Available, Desktop)
```
Ponadto istnieje mo≈ºliwo≈õƒá wyliczenia informacji o dostƒôpno≈õci istniejƒÖcych u≈ºytkownik√≥w, takich jak:

- Dostƒôpny
- Z dala
- Nie przeszkadzaƒá
- Zajƒôty
- Offline

Je≈õli skonfigurowano **wiadomo≈õƒá o nieobecno≈õci**, mo≈ºliwe jest r√≥wnie≈º pobranie tej wiadomo≈õci za pomocƒÖ TeamsEnum. Je≈õli zosta≈Ç okre≈õlony plik wyj≈õciowy, wiadomo≈õci o nieobecno≈õci sƒÖ automatycznie przechowywane w pliku JSON:
```
jq . teamsenum-output.json
```
## Unauthenticated Enumeration and Initial Entry

### Introduction

In this section, we will cover the techniques used to perform unauthenticated enumeration and gain initial access to Azure environments. The goal is to provide an overview of the steps involved in identifying and exploiting misconfigurations and vulnerabilities in Azure services without the need for valid credentials.

### Topics Covered

1. **Service Discovery**: Identifying exposed Azure services and resources.
2. **Enumeration Techniques**: Enumerating Azure resources, such as storage accounts, virtual machines, and databases.
3. **Exploitation Methods**: Leveraging misconfigurations and vulnerabilities to gain initial access.
4. **Post-Exploitation**: Establishing persistence and furthering access within the Azure environment.

### Prerequisites

To follow along with the examples in this section, you will need a basic understanding of Azure services and common security concepts. Familiarity with tools like `nmap`, `PowerShell`, and `Azure CLI` will be beneficial but is not required.
```json
{
"email": "user2@domain",
"exists": true,
"info": [
{
"tenantId": "[REDACTED]",
"isShortProfile": false,
"accountEnabled": true,
"featureSettings": {
"coExistenceMode": "TeamsOnly"
},
"userPrincipalName": "user2@domain",
"givenName": "user2@domain",
"surname": "",
"email": "user2@domain",
"tenantName": "Company",
"displayName": "User2",
"type": "Federated",
"mri": "8:orgid:[REDACTED]",
"objectId": "[REDACTED]"
}
],
"presence": [
{
"mri": "8:orgid:[REDACTED]",
"presence": {
"sourceNetwork": "Federated",
"calendarData": {
"outOfOfficeNote": {
"message": "Dear sender. I am out of the office until March 23rd with limited access to my email. I will respond after my return.Kind regards, User2",
"publishTime": "2023-03-15T21:44:42.0649385Z",
"expiry": "2023-04-05T14:00:00Z"
},
"isOutOfOffice": true
},
"capabilities": [
"Audio",
"Video"
],
"availability": "Away",
"activity": "Away",
"deviceType": "Mobile"
},
"etagMatch": false,
"etag": "[REDACTED]",
"status": 20000
}
]
}
```
## Us≈Çugi Azure

WiedzƒÖc ju≈º, **jakie domeny sƒÖ u≈ºywane przez najemcƒô Azure**, czas spr√≥bowaƒá znale≈∫ƒá **ods≈Çoniƒôte us≈Çugi Azure**.

Mo≈ºesz skorzystaƒá z metody z [**MicroBust**](https://github.com/NetSPI/MicroBurst) w celu osiƒÖgniƒôcia tego celu. Ta funkcja bƒôdzie przeszukiwaƒá nazwƒô domeny podstawowej (oraz kilka permutacji) w kilku **domenach us≈Çug Azure:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Otwarte magazynowanie

Mo≈ºesz odkryƒá otwarte magazynowanie za pomocƒÖ narzƒôdzia takiego jak [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1), kt√≥re bƒôdzie u≈ºywaƒá pliku **`Microburst/Misc/permitations.txt`** do generowania permutacji (bardzo proste) w celu **znalezienia otwartych kont magazynowych**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### URL-e SAS

_**Wsp√≥lny podpis dostƒôpu**_ (SAS) URL to adres URL, kt√≥ry **zapewnia dostƒôp** do okre≈õlonej czƒô≈õci konta Storage (mo≈ºe to byƒá pe≈Çny kontener, plik...) z okre≈õlonymi uprawnieniami (odczyt, zapis...) do zasob√≥w. Je≈õli znajdziesz wyciek≈Çy, mo≈ºesz uzyskaƒá dostƒôp do poufnych informacji, wyglƒÖdajƒÖ one tak (to jest dostƒôp do kontenera, je≈õli dotyczy≈Ç tylko pliku, ≈õcie≈ºka URL r√≥wnie≈º zawiera≈Çaby ten plik):

`https://<nazwa_konta_storage>.blob.core.windows.net/nowykontener?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

U≈ºyj [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/), aby uzyskaƒá dostƒôp do danych

## Skompromitowane Dane Logowania

### Phishing

* [**Powszechne Phishing**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (dane logowania lub OAuth App -[Atak na Nieuprawnione Udzielenie Zgody](az-illicit-consent-grant.md)-)
* [**Phishing Autoryzacji Kodu UrzƒÖdzenia**](az-device-code-authentication-phishing.md)

### Spraying Has≈Ça / Atak Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Odno≈õniki

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)
* [https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/](https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/)

{% hint style="success" %}
Naucz siƒô i ƒáwicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Szkolenie AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz siƒô i ƒáwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Szkolenie GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd≈∫ [**plan subskrypcyjny**](https://github.com/sponsors/carlospolop)!
* **Do≈ÇƒÖcz do** üí¨ [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **≈õled≈∫** nas na **Twitterze** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostƒôpnij sztuczki hakerskie, przesy≈ÇajƒÖc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori√≥w na github.

</details>
{% endhint %}
