# Az - Enumeraci√≥n y Entrada Inicial sin Autenticaci√≥n

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* ¬°Consulta los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Inquilino de Azure

### Enumeraci√≥n del Inquilino

Existen algunas **APIs p√∫blicas de Azure** que, solo conociendo el **dominio del inquilino**, un atacante podr√≠a consultar para recopilar m√°s informaci√≥n al respecto.\
Puedes consultar directamente la API o utilizar la biblioteca de PowerShell [**AADInternals**](https://github.com/Gerenios)**:**

| API                                                                  | Informaci√≥n                                                                                                                                                                                                                                           | Funci√≥n de AADInternals                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<dominio>/.well-known/openid-configuration | **Informaci√≥n de inicio de sesi√≥n**, incluido el ID del inquilino                                                                                                                                                                                      | `Get-AADIntTenantID -Domain <dominio>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Todos los dominios** del inquilino                                                                                                                                                                                                                  | `Get-AADIntTenantDomains -Domain <dominio>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<NombreUsuario>    | <p><strong>Informaci√≥n de inicio de sesi√≥n</strong> del inquilino, incluido el Nombre del inquilino y el dominio del <strong>tipo de autenticaci√≥n.</strong><br>Si <code>NameSpaceType</code> es <strong><code>Managed</code></strong>, significa que se utiliza <strong>AzureAD</strong>.</p> | `Get-AADIntLoginInformation -UserName <NombreUsuario>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informaci√≥n de inicio de sesi√≥n, incluida la **informaci√≥n de SSO de escritorio**                                                                                                                                                                      | `Get-AADIntLoginInformation -UserName <NombreUsuario>` |

Puedes consultar toda la informaci√≥n de un inquilino de Azure con **solo un comando de la** [**biblioteca AADInternals**](https://github.com/Gerenios):
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
### Ejemplo de salida de la informaci√≥n del inquilino de Azure:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Es posible observar detalles sobre el nombre del inquilino, ID y nombre de "marca". Adem√°s, se muestra el estado del Inicio de sesi√≥n √∫nico en el escritorio (SSO), tambi√©n conocido como [**SSO sin interrupciones**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso). Cuando est√° habilitada, esta caracter√≠stica facilita la determinaci√≥n de la presencia (enumeraci√≥n) de un usuario espec√≠fico dentro de la organizaci√≥n objetivo.

Adem√°s, la salida presenta los nombres de todos los dominios verificados asociados con el inquilino objetivo, junto con sus respectivos tipos de identidad. En el caso de los dominios federados, se revela tambi√©n el Nombre de Dominio Completo (FQDN) del proveedor de identidad en uso, t√≠picamente un servidor ADFS. La columna "MX" especifica si los correos electr√≥nicos se env√≠an a Exchange Online, mientras que la columna "SPF" denota la inclusi√≥n de Exchange Online como remitente de correos electr√≥nicos. Es importante tener en cuenta que la funci√≥n actual de reconocimiento no analiza las declaraciones "include" dentro de los registros SPF, lo que puede resultar en falsos negativos.

### Enumeraci√≥n de Usuarios

Es posible **verificar si un nombre de usuario existe** dentro de un inquilino. Esto incluye tambi√©n a los **usuarios invitados**, cuyo nombre de usuario tiene el formato:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
El correo electr√≥nico es la direcci√≥n de correo electr√≥nico del usuario donde en ‚Äú@‚Äù se reemplaza con guion bajo ‚Äú\_‚Äú.

Con [**AADInternals**](https://github.com/Gerenios/AADInternals), puedes verificar f√°cilmente si el usuario existe o no:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
## Unauthenticated Enumeration and Initial Entry

### Introduction

In this section, we will cover the techniques used for unauthenticated enumeration and gaining initial access to Azure environments. The goal is to provide an overview of the methods that can be used to gather information and potentially gain access to Azure resources without the need for valid credentials.

### Enumeration Techniques

#### 1. DNS Enumeration

DNS enumeration can be a valuable technique to discover subdomains and other domain-related information that can be used in further attacks.

#### 2. Service Enumeration

Service enumeration involves identifying services running in the Azure environment that may have known vulnerabilities or misconfigurations that can be exploited.

#### 3. Resource Enumeration

Resource enumeration focuses on identifying Azure resources such as storage accounts, virtual machines, and databases that may contain sensitive information or misconfigurations.

### Initial Entry

Once enumeration is complete and potential entry points have been identified, the next step is to attempt to gain initial access to the Azure environment. This can involve exploiting misconfigurations, weak credentials, or known vulnerabilities in Azure services.

By following these techniques, an attacker can gain a foothold in the Azure environment and begin further exploration and exploitation of the target environment.
```
UserName         Exists
--------         ------
user@company.com True
```
Tambi√©n puedes usar un archivo de texto que contenga una direcci√≥n de correo electr√≥nico por fila:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Hay **tres m√©todos de enumeraci√≥n diferentes** para elegir:

| M√©todo    | Descripci√≥n                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | Esto se refiere al API GetCredentialType mencionado anteriormente. El m√©todo predeterminado.                                                                                                            |
| Login     | <p>Este m√©todo intenta iniciar sesi√≥n como el usuario.<br><strong>Nota:</strong> las consultas se registrar√°n en el registro de inicio de sesi√≥n.</p>                                                   |
| Autologon | <p>Este m√©todo intenta iniciar sesi√≥n como el usuario a trav√©s del punto de conexi√≥n de autologon.<br><strong>¬°Las consultas no se registran</strong> en el registro de inicio de sesi√≥n! Por lo tanto, tambi√©n funciona bien para ataques de spray de contrase√±as y de fuerza bruta.</p> |

Despu√©s de descubrir los nombres de usuario v√°lidos, puedes obtener **informaci√≥n sobre un usuario** con:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
El script [**o365creeper**](https://github.com/LMGsec/o365creeper) tambi√©n te permite descubrir **si un correo electr√≥nico es v√°lido**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
**Enumeraci√≥n de usuarios a trav√©s de Microsoft Teams**

Otra buena fuente de informaci√≥n es Microsoft Teams.

La API de Microsoft Teams permite buscar usuarios. En particular, los puntos finales de "b√∫squeda de usuario" **externalsearchv3** y **searchUsers** podr√≠an ser utilizados para solicitar informaci√≥n general sobre cuentas de usuario inscritas en Teams.

Dependiendo de la respuesta de la API, es posible distinguir entre usuarios que no existen y usuarios existentes que tienen una suscripci√≥n v√°lida a Teams.

El script [**TeamsEnum**](https://github.com/sse-secure-systems/TeamsEnum) podr√≠a ser utilizado para validar un conjunto dado de nombres de usuario contra la API de Teams.
```bash
python3 TeamsEnum.py -a password -u <username> -f inputlist.txt -o teamsenum-output.json
```
## Unauthenticated Enumeration and Initial Entry

### Introduction

In this section, we will cover the techniques used to perform unauthenticated enumeration and gain initial access to Azure environments. Unauthenticated enumeration involves gathering information from publicly available sources without the need for valid credentials. This information can then be used to identify potential entry points into the target Azure environment.

### Tools and Techniques

#### Azure Resource Manager (ARM) APIs

Azure Resource Manager (ARM) APIs can be leveraged to gather information about Azure resources without authentication. By querying these APIs, an attacker can discover valuable information such as resource types, configurations, and dependencies.

#### DNS Enumeration

Performing DNS enumeration can provide insights into the Azure environment's infrastructure, including subdomains, IP addresses, and services in use. This information can be crucial for identifying potential targets for further exploitation.

#### Web Scraping

Web scraping techniques can be used to extract information from publicly accessible Azure portals and websites. This information may include details about services, applications, and configurations that can help in planning the attack.

### Initial Entry

Once sufficient information has been gathered through unauthenticated enumeration, the next step is to leverage this information to gain initial access to the Azure environment. This can be achieved through various means, such as exploiting misconfigurations, weak credentials, or known vulnerabilities in Azure services.

By combining the information obtained during the enumeration phase with targeted exploitation techniques, an attacker can establish a foothold in the Azure environment and begin further exploration and exploitation.
```
[-] user1@domain - Target user not found. Either the user does not exist, is not Teams-enrolled or is configured to not appear in search results (personal accounts only)
[+] user2@domain - User2 | Company (Away, Mobile)
[+] user3@domain - User3 | Company (Available, Desktop)
```
Adem√°s, es posible enumerar informaci√≥n de disponibilidad sobre usuarios existentes como la siguiente:

- Disponible
- Ausente
- No molestar
- Ocupado
- Desconectado

Si se configura un **mensaje de fuera de la oficina**, tambi√©n es posible recuperar el mensaje usando TeamsEnum. Si se especific√≥ un archivo de salida, los mensajes de fuera de la oficina se almacenan autom√°ticamente dentro del archivo JSON:
```
jq . teamsenum-output.json
```
El siguiente contenido es de un libro de hacking sobre t√©cnicas de hacking. El contenido es del archivo pentesting-cloud/azure-security/az-unauthenticated-enum-and-initial-entry/README.md. 

### Enumeraci√≥n y Entrada Inicial sin Autenticaci√≥n

La enumeraci√≥n sin autenticaci√≥n es una fase cr√≠tica en una evaluaci√≥n de seguridad. Permite a un atacante recopilar informaci√≥n valiosa sobre la infraestructura objetivo sin la necesidad de credenciales. Esta informaci√≥n puede ser utilizada para identificar posibles puntos de entrada y debilidades en el sistema.
```json
{
"email": "user2@domain",
"exists": true,
"info": [
{
"tenantId": "[REDACTED]",
"isShortProfile": false,
"accountEnabled": true,
"featureSettings": {
"coExistenceMode": "TeamsOnly"
},
"userPrincipalName": "user2@domain",
"givenName": "user2@domain",
"surname": "",
"email": "user2@domain",
"tenantName": "Company",
"displayName": "User2",
"type": "Federated",
"mri": "8:orgid:[REDACTED]",
"objectId": "[REDACTED]"
}
],
"presence": [
{
"mri": "8:orgid:[REDACTED]",
"presence": {
"sourceNetwork": "Federated",
"calendarData": {
"outOfOfficeNote": {
"message": "Dear sender. I am out of the office until March 23rd with limited access to my email. I will respond after my return.Kind regards, User2",
"publishTime": "2023-03-15T21:44:42.0649385Z",
"expiry": "2023-04-05T14:00:00Z"
},
"isOutOfOffice": true
},
"capabilities": [
"Audio",
"Video"
],
"availability": "Away",
"activity": "Away",
"deviceType": "Mobile"
},
"etagMatch": false,
"etag": "[REDACTED]",
"status": 20000
}
]
}
```
## Servicios de Azure

Ahora que conocemos los **dominios que el inquilino de Azure** est√° utilizando, es hora de intentar encontrar **los servicios de Azure expuestos**.

Puedes utilizar un m√©todo de [**MicroBust**](https://github.com/NetSPI/MicroBurst) para este objetivo. Esta funci√≥n buscar√° el nombre de dominio base (y algunas permutaciones) en varios **dominios de servicios de Azure:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Almacenamiento Abierto

Puedes descubrir almacenamiento abierto con una herramienta como [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) que utilizar√° el archivo **`Microburst/Misc/permitations.txt`** para generar permutaciones (muy simples) e intentar **encontrar cuentas de almacenamiento abiertas**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### URLs SAS

Un _**token de acceso compartido**_ (SAS) es una URL que **proporciona acceso** a cierta parte de una cuenta de almacenamiento (puede ser un contenedor completo, un archivo...) con permisos espec√≠ficos (lectura, escritura...) sobre los recursos. Si encuentras uno filtrado podr√≠as acceder a informaci√≥n sensible, se ven as√≠ (esto es para acceder a un contenedor, si solo otorgara acceso a un archivo, la ruta de la URL tambi√©n contendr√≠a ese archivo):

`https://<nombre_cuenta_almacenamiento>.blob.core.windows.net/nuevocontenedor?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Utiliza [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) para acceder a los datos

## Compromiso de Credenciales

### Phishing

* [**Phishing Com√∫n**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (credenciales o Aplicaci√≥n OAuth -[Ataque de Concesi√≥n de Consentimiento Il√≠cito](az-illicit-consent-grant.md)-)
* [**Phishing de Autenticaci√≥n de C√≥digo de Dispositivo**](az-device-code-authentication-phishing.md)

### Password Spraying / Fuerza Bruta

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Referencias

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)
* [https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/](https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoia a HackTricks</summary>

* ¬°Consulta los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
