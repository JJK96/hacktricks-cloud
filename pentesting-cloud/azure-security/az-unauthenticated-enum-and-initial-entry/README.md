# Az - Ongeverifieerde Enum & Inisie√´le Toegang

{% hint style="success" %}
Leer & oefen AWS Hack:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

## Azure Huurder

### Huurder Enumerasie

Daar is **openbare Azure API's** wat net deur die **domein van die huurder** te weet, 'n aanvaller kan ondervra om meer inligting daaroor te versamel.\
Jy kan direk die API ondervra of die PowerShell-biblioteek [**AADInternals**](https://github.com/Gerenios)**:**

| API                                                                  | Inligting                                                                                                                                                                                                                                             | AADInternals funksie                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Aantekeninligting**, insluitend huurder-ID                                                                                                                                                                                                          | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Alle domeine** van die huurder                                                                                                                                                                                                                     | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Aantekeninligting</strong> van die huurder, insluitend huurder Naam en domein <strong>verifikasie tipe.</strong><br>As <code>NameSpaceType</code> is <strong><code>Managed</code></strong>, beteken dit dat <strong>AzureAD</strong> gebruik word.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Aantekeninligting, insluitend **Desktop SSO-inligting**                                                                                                                                                                                              | `Get-AADIntLoginInformation -UserName <UserName>` |

Jy kan alle inligting van 'n Azure huurder ondervra met **net een bevel van die** [**AADInternals**](https://github.com/Gerenios) **biblioteek**:
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Uitvoervoorbeeld van die Azure huurderinligting:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Dit is moontlik om besonderhede oor die huurder se naam, ID, en "handelsmerk" naam waar te neem. Daarbenewens word die status van die Desktop Single Sign-On (SSO), ook bekend as [**Naadlose SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso), vertoon. Wanneer dit geaktiveer is, fasiliteer hierdie kenmerk die bepaling van die teenwoordigheid (opsomming) van 'n spesifieke gebruiker binne die teikenorganisasie.

Verder toon die uitset die name van alle geverifieerde domeine wat met die teikendhuurder geassosieer word, saam met hul onderskeie identiteits tipes. In die geval van gefedereerde domeine, word die Volledig Gekwalifiseerde Domein Naam (FQDN) van die identiteitsverskaffer wat gebruik word, tipies 'n ADFS-bediener, ook bekend gemaak. Die "MX" kolom spesifiseer of e-posse na Exchange Online gestuur word, terwyl die "SPF" kolom die lys van Exchange Online as 'n e-posafsender aandui. Dit is belangrik om daarop te let dat die huidige verkenningsfunksie nie die "include" verklarings binne SPF rekords ontled nie, wat tot vals negatiewe resultate kan lei.

### Gebruiker Opsomming

Dit is moontlik om **te kontroleer of 'n gebruikersnaam bestaan** binne 'n huurder. Dit sluit ook **gasgebruikers** in, wie se gebruikersnaam in die formaat is:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
Die e-pos is die gebruiker se e-posadres waar by ‚Äú@‚Äù vervang word met onderstreep ‚Äú\_‚Äú.

Met [**AADInternals**](https://github.com/Gerenios/AADInternals), kan jy maklik nagaan of die gebruiker bestaan of nie:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
### Unauthenticated Enumeration and Initial Entry

#### Introduction
In this section, we will discuss how to perform unauthenticated enumeration and gain initial access to Azure environments. Unauthenticated enumeration involves gathering information without logging into the target system. This can include discovering publicly accessible resources, services, and configurations that may be vulnerable to exploitation.

#### Tools and Techniques
- **Cloud Metadata API**: Accessing the cloud metadata API can provide valuable information about the target Azure environment, such as instance details, network configuration, and more.
- **DNS Enumeration**: Enumerating DNS records can reveal subdomains, services, and other network-related information that may assist in further attacks.
- **Web Scraping**: Scraping Azure web applications can uncover hidden endpoints, sensitive information, and potential entry points for exploitation.
- **Search Engines**: Utilizing search engines to find publicly exposed Azure resources, such as storage buckets or web applications, can reveal insecure configurations.

#### Initial Entry Points
Once unauthenticated enumeration is performed, potential entry points can be identified for gaining initial access to the Azure environment. These entry points may include weak credentials, misconfigured services, vulnerable applications, or exposed sensitive data.

By leveraging the information obtained through unauthenticated enumeration, an attacker can devise a strategy to exploit these entry points and establish a foothold in the Azure environment.
```
UserName         Exists
--------         ------
user@company.com True
```
Jy kan ook 'n teksl√™er gebruik wat een e-posadres per ry bevat:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Daar is **drie verskillende opnoemingsmetodes** om van te kies:

| Metode    | Beskrywing                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normaal   | Hierdie verwys na die GetCredentialType API wat hierbo genoem word. Die verstekmetode.                                                                                                                 |
| Aanteken  | <p>Hierdie metode probeer om as die gebruiker aan te teken.<br><strong>Let op:</strong> navrae sal aangeteken word in die aanmeldingslog.</p>                                                              |
| Outomatiesaanmelding | <p>Hierdie metode probeer om as die gebruiker aan te teken via die outomatiese aanmeldings-eindpunt.<br><strong>Navrae word nie aangeteken</strong> in die aanmeldingslog nie! Dit werk dus ook goed vir wagwoordspuit- en brutaalkragaanvalle.</p> |

Nadat die geldige gebruikersname ontdek is, kan jy **inligting oor 'n gebruiker** kry met:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Die skripsie [**o365creeper**](https://github.com/LMGsec/o365creeper) laat jou ook toe om te ontdek **of 'n e-pos geldig is**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
**Gebruikeropsomming via Microsoft-spanne**

'n Ander goeie bron van inligting is Microsoft-spanne.

Die API van Microsoft-spanne maak dit moontlik om vir gebruikers te soek. Veral die "gebruikersoek" eindpunte **externalsearchv3** en **searchUsers** kan gebruik word om algemene inligting oor Teams-ingeskrewe gebruikersrekeninge aan te vra.

Afhanklik van die API-reaksie is dit moontlik om tussen nie-bestaande gebruikers en bestaande gebruikers wat 'n geldige Teams intekening het, te onderskei.

Die skripsie [**TeamsEnum**](https://github.com/sse-secure-systems/TeamsEnum) kan gebruik word om 'n gegewe stel gebruikersname teen die Teams API te valideer.
```bash
python3 TeamsEnum.py -a password -u <username> -f inputlist.txt -o teamsenum-output.json
```
### Unauthenticated Enumeration and Initial Entry

#### Introduction
In this section, we will discuss how to perform unauthenticated enumeration and gain initial access to Azure environments.

#### Unauthenticated Enumeration
During the initial phase of a penetration test, it is crucial to gather as much information as possible about the target environment without triggering any alerts. Unauthenticated enumeration involves collecting data from publicly available sources such as search engines, public repositories, and social media platforms.

#### Tools and Techniques
Various tools and techniques can be used for unauthenticated enumeration, including:
- **Search Engines**: Google, Bing, Shodan
- **Public Repositories**: GitHub, Bitbucket
- **Social Media Platforms**: LinkedIn, Twitter
- **Other Tools**: `dirb`, `dirbuster`, `nmap`

#### Initial Entry
Once sufficient information has been gathered during the enumeration phase, the next step is to identify potential entry points into the Azure environment. This could involve exploiting misconfigurations, weak credentials, or known vulnerabilities.

#### Recommendations
- Conduct thorough unauthenticated enumeration before attempting to gain access.
- Use a combination of tools and techniques to gather information discreetly.
- Document all findings and potential entry points for further exploitation.
```
[-] user1@domain - Target user not found. Either the user does not exist, is not Teams-enrolled or is configured to not appear in search results (personal accounts only)
[+] user2@domain - User2 | Company (Away, Mobile)
[+] user3@domain - User3 | Company (Available, Desktop)
```
Verder is dit moontlik om beskikbaarheidsinligting oor bestaande gebruikers te ontleed soos die volgende:

- Beskikbaar
- Weg
- MoetNieGestoorkWord nie
- Besig
- Aflyn

Indien 'n **uit-kantoorboodskap** ingestel is, is dit ook moontlik om die boodskap te onttrek deur TeamsEnum te gebruik. As 'n uitvoerl√™er gespesifiseer is, word die uit-kantoorboodskappe outomaties binne die JSON-l√™er gestoor:
```
jq . teamsenum-output.json
```
### Unauthenticated Enumeration and Initial Entry

#### Introduction
In this section, we will discuss how to perform unauthenticated enumeration and gain initial access to Azure environments.

#### Unauthenticated Enumeration
During the initial phase of a penetration test, it is crucial to gather as much information as possible about the target environment without triggering any security alerts. Unauthenticated enumeration involves collecting data from publicly available sources such as search engines, public repositories, and social media platforms.

#### Tools and Techniques
Various tools and techniques can be used for unauthenticated enumeration, including:
- **Search Engines**: Google Dorks, Bing search operators
- **Public Repositories**: GitHub, GitLab, Bitbucket
- **Social Media Platforms**: LinkedIn, Twitter, Facebook

#### Initial Entry
Once sufficient information has been gathered through unauthenticated enumeration, the next step is to identify potential entry points into the Azure environment. This could involve exploiting misconfigurations, weak credentials, or known vulnerabilities in Azure services.

#### Recommendations
- Regularly monitor and secure public repositories containing sensitive information.
- Implement strong password policies and multi-factor authentication to prevent unauthorized access.
- Keep Azure services and applications up to date with the latest security patches to mitigate known vulnerabilities.
```json
{
"email": "user2@domain",
"exists": true,
"info": [
{
"tenantId": "[REDACTED]",
"isShortProfile": false,
"accountEnabled": true,
"featureSettings": {
"coExistenceMode": "TeamsOnly"
},
"userPrincipalName": "user2@domain",
"givenName": "user2@domain",
"surname": "",
"email": "user2@domain",
"tenantName": "Company",
"displayName": "User2",
"type": "Federated",
"mri": "8:orgid:[REDACTED]",
"objectId": "[REDACTED]"
}
],
"presence": [
{
"mri": "8:orgid:[REDACTED]",
"presence": {
"sourceNetwork": "Federated",
"calendarData": {
"outOfOfficeNote": {
"message": "Dear sender. I am out of the office until March 23rd with limited access to my email. I will respond after my return.Kind regards, User2",
"publishTime": "2023-03-15T21:44:42.0649385Z",
"expiry": "2023-04-05T14:00:00Z"
},
"isOutOfOffice": true
},
"capabilities": [
"Audio",
"Video"
],
"availability": "Away",
"activity": "Away",
"deviceType": "Mobile"
},
"etagMatch": false,
"etag": "[REDACTED]",
"status": 20000
}
]
}
```
## Azure Dienste

Weet dat ons die **domeine wat die Azure huurder** gebruik, ken, is dit tyd om te probeer om **blootgestelde Azure dienste** te vind.

Jy kan 'n metode van [**MicroBust**](https://github.com/NetSPI/MicroBurst) vir so 'n doel gebruik. Hierdie funksie sal die basiese domeinnaam (en 'n paar permutasies) soek in verskeie **Azure diens domeine:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Oop Berging

Jy kan oop berging ontdek met 'n instrument soos [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) wat die l√™er **`Microburst/Misc/permitations.txt`** sal gebruik om permutasies (baie eenvoudig) te genereer om te probeer **om oop bergingsrekeninge te vind**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URL's

'n _**gedeelde toegang handtekening**_ (SAS) URL is 'n URL wat **toegang bied** tot 'n sekere deel van 'n Stoaraak rekening (kan 'n volle houer, 'n l√™er...) met sekere spesifieke regte (lees, skryf...) oor die bronne. As jy een vind wat uitgelek het, kan jy dalk toegang h√™ tot sensitiewe inligting, hulle lyk soos hierdie (dit is om toegang te verkry tot 'n houer, as dit net toegang verleen het tot 'n l√™er, sal die pad van die URL ook daardie l√™er bevat):

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Gebruik [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) om die data te benader

## Kompromitteer Geldeenhede

### Hengel

* [**Gewone Hengel**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (geldeenhede of OAuth App -[Illegale Toestemming Grant Aanval](az-illicit-consent-grant.md)-)
* [**Toestel Kode Verifikasie** Hengel](az-device-code-authentication-phishing.md)

### Wagwoord Spuit / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Verwysings

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)
* [https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/](https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/)

{% hint style="success" %}
Leer & oefen AWS Hack:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Rooi Span Kenner (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Rooi Span Kenner (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hakerstruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
