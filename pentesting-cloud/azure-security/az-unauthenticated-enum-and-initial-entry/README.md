# Az - Enum√©ration non authentifi√©e & Entr√©e initiale

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## Azure Tenant

### √ânum√©ration du locataire

Il existe quelques **APIs Azure publiques** pour lesquelles en connaissant simplement le **domaine du locataire**, un attaquant pourrait interroger pour recueillir plus d'informations √† ce sujet.\
Vous pouvez interroger directement l'API ou utiliser la biblioth√®que PowerShell [**AADInternals**](https://github.com/Gerenios)**:**

| API                                                                  | Information                                                                                                                                                                                                                                           | Fonction AADInternals                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informations de connexion**, y compris l'ID du locataire                                                                                                                                                                                             | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Tous les domaines** du locataire                                                                                                                                                                                                                    | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Informations de connexion</strong> du locataire, y compris le nom du locataire et le domaine du type d'authentification.<br>Si <code>NameSpaceType</code> est <strong><code>Managed</code></strong>, cela signifie qu'**AzureAD** est utilis√©.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informations de connexion, y compris les **informations de SSO de bureau**                                                                                                                                                                             | `Get-AADIntLoginInformation -UserName <UserName>` |

Vous pouvez interroger toutes les informations d'un locataire Azure avec **juste une commande de la** [**biblioth√®que AADInternals**](https://github.com/Gerenios) **:**
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Exemple de sortie des informations du locataire Azure :
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Il est possible d'observer detalles sur le nom du locataire, l'ID et le nom de "marque". De plus, le statut du Single Sign-On du Bureau (SSO), √©galement connu sous le nom de [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso), est affich√©. Lorsqu'il est activ√©, cette fonction facilite la d√©termination de la pr√©sence (√©num√©ration) d'un utilisateur sp√©cifique au sein de l'organisation cible.

De plus, la sortie pr√©sente les noms de tous les domaines v√©rifi√©s associ√©s au locataire cible, ainsi que leurs types d'identit√© respectifs. Dans le cas des domaines f√©d√©r√©s, le Nom de Domaine Complet (FQDN) du fournisseur d'identit√© utilis√©, g√©n√©ralement un serveur ADFS, est √©galement divulgu√©. La colonne "MX" sp√©cifie si les e-mails sont rout√©s vers Exchange Online, tandis que la colonne "SPF" indique l'inscription de Exchange Online en tant qu'exp√©diteur d'e-mails. Il est important de noter que la fonction de reconnaissance actuelle ne parse pas les d√©clarations "include" dans les enregistrements SPF, ce qui peut entra√Æner des faux n√©gatifs.

### √ânum√©ration des Utilisateurs

Il est possible de **v√©rifier si un nom d'utilisateur existe** √† l'int√©rieur d'un locataire. Cela inclut √©galement les **utilisateurs invit√©s**, dont le nom d'utilisateur est au format :
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
L'e-mail est l'adresse e-mail de l'utilisateur o√π le "@" est remplac√© par un tiret bas "\_".

Avec [**AADInternals**](https://github.com/Gerenios/AADInternals), vous pouvez facilement v√©rifier si l'utilisateur existe ou non :
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
# Enum√©ration non authentifi√©e et entr√©e initiale

---

## D√©couverte d'instances Azure Storage non authentifi√©es

Lors de la recherche de cibles potentielles pour une attaque, il est courant de trouver des instances Azure Storage non authentifi√©es. Ces instances peuvent contenir des donn√©es sensibles ou √™tre utilis√©es pour le stockage de fichiers malveillants. Pour les trouver, vous pouvez utiliser des outils d'enum√©ration tels que `Azure Storage Explorer` ou `azcopy`.

---

## D√©couverte d'instances Azure Cosmos DB non authentifi√©es

Azure Cosmos DB est une autre cible courante pour les attaquants en raison de sa nature de base de donn√©es NoSQL flexible et √©volutive. La d√©couverte d'instances Azure Cosmos DB non authentifi√©es peut fournir un point d'entr√©e initial pour une attaque. Vous pouvez les rechercher en utilisant des outils d'enum√©ration comme `Cosmos DB Explorer` ou en interrogeant directement l'API REST de Cosmos DB.

---

## D√©couverte d'instances Azure Key Vault non authentifi√©es

Azure Key Vault est un service de gestion des cl√©s qui stocke de mani√®re s√©curis√©e les informations sensibles telles que des cl√©s d'API, des mots de passe et des certificats. La d√©couverte d'instances Azure Key Vault non authentifi√©es peut potentiellement conduire √† la compromission de ces informations sensibles. Vous pouvez les rechercher en utilisant des outils d'enum√©ration comme `Azure Key Vault Explorer` ou en interrogeant l'API REST d'Azure Key Vault.
```
UserName         Exists
--------         ------
user@company.com True
```
Vous pouvez √©galement utiliser un fichier texte contenant une adresse e-mail par ligne :
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Il existe **trois m√©thodes d'√©num√©ration diff√©rentes** parmi lesquelles choisir :

| M√©thode    | Description                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normale    | Il s'agit de l'API GetCredentialType mentionn√©e ci-dessus. La m√©thode par d√©faut.                                                                                                                           |
| Connexion     | <p>Cette m√©thode tente de se connecter en tant qu'utilisateur.<br><strong>Remarque :</strong> les requ√™tes seront enregistr√©es dans le journal des connexions.</p>                                                                                       |
| Autologon | <p>Cette m√©thode tente de se connecter en tant qu'utilisateur via le point de terminaison autologon.<br><strong>Les requ√™tes ne sont pas enregistr√©es</strong> dans le journal des connexions ! Par cons√©quent, elle fonctionne √©galement bien pour les attaques de pulv√©risation de mots de passe et de force brute.</p> |

Apr√®s avoir d√©couvert les noms d'utilisateur valides, vous pouvez obtenir des **informations sur un utilisateur** avec :
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Le script [**o365creeper**](https://github.com/LMGsec/o365creeper) vous permet √©galement de d√©couvrir **si un e-mail est valide**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
**√ânum√©ration des utilisateurs via Microsoft Teams**

Une autre bonne source d'informations est Microsoft Teams.

L'API de Microsoft Teams permet de rechercher des utilisateurs. En particulier, les points de terminaison "recherche externe" **externalsearchv3** et **searchUsers** pourraient √™tre utilis√©s pour demander des informations g√©n√©rales sur les comptes d'utilisateurs inscrits dans Teams.

En fonction de la r√©ponse de l'API, il est possible de distinguer entre les utilisateurs inexistants et les utilisateurs existants ayant un abonnement Teams valide.

Le script [**TeamsEnum**](https://github.com/sse-secure-systems/TeamsEnum) pourrait √™tre utilis√© pour valider un ensemble donn√© de noms d'utilisateur par rapport √† l'API Teams.
```bash
python3 TeamsEnum.py -a password -u <username> -f inputlist.txt -o teamsenum-output.json
```
## Unauthenticated Enumeration and Initial Entry

### Introduction

In this section, we will cover techniques to perform unauthenticated enumeration and gain initial access to Azure environments. Unauthenticated enumeration involves gathering information without the need for valid credentials, which can help in identifying potential entry points and weaknesses in the target Azure environment.

### Tools and Techniques

1. **Public Information Gathering**: Utilize search engines, public repositories, and other open sources to gather information about the target Azure environment, such as exposed resources, configurations, and potentially sensitive data.

2. **Subdomain Enumeration**: Use tools like `Sublist3r`, `Amass`, or `Subfinder` to discover subdomains associated with the target Azure environment. These subdomains may reveal additional entry points or misconfigurations.

3. **Service Enumeration**: Identify services running in the Azure environment by scanning for open ports and analyzing service banners. This can help in understanding the attack surface and potential vulnerabilities.

4. **Weak Configuration Detection**: Look for common misconfigurations in Azure services, such as storage containers with public access or unsecured databases. Exploiting these weaknesses can lead to unauthorized access.

### Initial Entry Points

Once you have gathered sufficient information through unauthenticated enumeration, you can leverage the identified entry points to gain initial access to the Azure environment. This may involve exploiting misconfigurations, weak credentials, or known vulnerabilities in Azure services.

By combining effective enumeration techniques with thorough analysis of the gathered information, you can increase the chances of successfully gaining access to the target Azure environment without the need for valid credentials.
```
[-] user1@domain - Target user not found. Either the user does not exist, is not Teams-enrolled or is configured to not appear in search results (personal accounts only)
[+] user2@domain - User2 | Company (Away, Mobile)
[+] user3@domain - User3 | Company (Available, Desktop)
```
De plus, il est possible d'√©num√©rer les informations de disponibilit√© des utilisateurs existants comme suit :

- Disponible
- Absent
- Ne pas d√©ranger
- Occup√©
- Hors ligne

Si un **message d'absence** est configur√©, il est √©galement possible de r√©cup√©rer le message en utilisant TeamsEnum. Si un fichier de sortie a √©t√© sp√©cifi√©, les messages d'absence sont automatiquement stock√©s dans le fichier JSON :
```
jq . teamsenum-output.json
```
## Unauthenticated Enumeration and Initial Entry

### Introduction

In this section, we will cover techniques to perform unauthenticated enumeration and gain initial access to Azure environments. Unauthenticated enumeration involves gathering information without the need for valid credentials, which can help in identifying potential entry points for further exploitation.

### Enumeration Techniques

1. **DNS Enumeration**: Discovering subdomains and associated IP addresses using tools like `dnsrecon` or `sublist3r`.
   
2. **Service Enumeration**: Identifying open ports and services running on those ports using tools like `nmap` or `masscan`.
   
3. **Web Enumeration**: Enumerating web applications for common vulnerabilities like misconfigurations or outdated software versions.
   
4. **Storage Account Enumeration**: Identifying publicly accessible storage accounts using tools like `azcopy` or `Azure Storage Explorer`.

### Initial Entry Points

Once potential entry points are identified through enumeration, attackers can exploit vulnerabilities to gain initial access to the Azure environment. This could involve techniques like exploiting misconfigured storage containers, weak passwords, or known vulnerabilities in web applications.

It is important for organizations to regularly perform security assessments and address any identified vulnerabilities to prevent unauthorized access to their Azure environments.
```json
{
"email": "user2@domain",
"exists": true,
"info": [
{
"tenantId": "[REDACTED]",
"isShortProfile": false,
"accountEnabled": true,
"featureSettings": {
"coExistenceMode": "TeamsOnly"
},
"userPrincipalName": "user2@domain",
"givenName": "user2@domain",
"surname": "",
"email": "user2@domain",
"tenantName": "Company",
"displayName": "User2",
"type": "Federated",
"mri": "8:orgid:[REDACTED]",
"objectId": "[REDACTED]"
}
],
"presence": [
{
"mri": "8:orgid:[REDACTED]",
"presence": {
"sourceNetwork": "Federated",
"calendarData": {
"outOfOfficeNote": {
"message": "Dear sender. I am out of the office until March 23rd with limited access to my email. I will respond after my return.Kind regards, User2",
"publishTime": "2023-03-15T21:44:42.0649385Z",
"expiry": "2023-04-05T14:00:00Z"
},
"isOutOfOffice": true
},
"capabilities": [
"Audio",
"Video"
],
"availability": "Away",
"activity": "Away",
"deviceType": "Mobile"
},
"etagMatch": false,
"etag": "[REDACTED]",
"status": 20000
}
]
}
```
## Services Azure

Maintenant que nous connaissons les **domaines utilis√©s par le locataire Azure**, il est temps d'essayer de trouver les **services Azure expos√©s**.

Vous pouvez utiliser une m√©thode de [**MicroBust**](https://github.com/NetSPI/MicroBurst) pour atteindre cet objectif. Cette fonction recherchera le nom de domaine de base (et quelques permutations) dans plusieurs **domaines de services Azure :**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Stockage Ouvert

Vous pourriez d√©couvrir un stockage ouvert avec un outil tel que [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) qui utilisera le fichier **`Microburst/Misc/permitations.txt`** pour g√©n√©rer des permutations (tr√®s simples) afin de **trouver des comptes de stockage ouverts**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### URL SAS

Un _**jeton d'acc√®s partag√©**_ (SAS) est une URL qui **fournit l'acc√®s** √† une certaine partie d'un compte de stockage (peut √™tre un conteneur complet, un fichier...) avec des autorisations sp√©cifiques (lecture, √©criture...) sur les ressources. Si vous en trouvez un qui a fuit√©, vous pourriez √™tre en mesure d'acc√©der √† des informations sensibles, ils ressemblent √† ceci (c'est pour acc√©der √† un conteneur, s'il ne faisait que accorder l'acc√®s √† un fichier, le chemin de l'URL contiendrait √©galement ce fichier) :

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Utilisez [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) pour acc√©der aux donn√©es

## Compromission des identifiants

### Phishing

* [**Phishing Commun**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (identifiants ou application OAuth -[Attaque d'octroi de consentement illicite](az-illicit-consent-grant.md)-)
* [**Phishing d'Authentification par Code Appareil**](az-device-code-authentication-phishing.md)

### Pulv√©risation de mots de passe / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)
* [https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/](https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}
