# Azure Pentesting

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **bizi takip edin** **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## AZURE METODOLOJİSİNİ HÂLÂ OLUŞTURUYORUM

## Temel Bilgiler

{% content-ref url="az-basic-information.md" %}
[az-basic-information.md](az-basic-information.md)
{% endcontent-ref %}

## Azure Pentester/Red Team Metodolojisi

Bir AZURE ortamını denetlemek için hangi **hizmetlerin kullanıldığını**, neyin **açıkta olduğunu**, kimin neye **erişimi** olduğunu ve dahili Azure hizmetleri ile **harici hizmetlerin** nasıl bağlandığını bilmek çok önemlidir.

Red Team bakış açısından, bir Azure ortamını **ele geçirmenin ilk adımı**, Azure AD için bazı **kimlik bilgilerini** elde etmektir. İşte bunu yapmanın bazı yolları:

* github (veya benzeri) **Leaks** - OSINT
* **Sosyal** Mühendislik
* **Şifre** yeniden kullanımı (şifre sızıntıları)
* Azure'da Barındırılan Uygulamalardaki Güvenlik Açıkları
* [**Server Side Request Forgery**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) ile metadata endpoint'e erişim
* **Yerel Dosya Okuma**
* `/home/USERNAME/.azure`
* `C:\Users\USERNAME\.azure`
* `az cli` 2.30 öncesi - Ocak 2022 - **erişim tokenlarını açık metin** olarak saklayan **`accessTokens.json`** dosyası
* **`azureProfile.json`** dosyası, oturum açmış kullanıcı hakkında **bilgi** içerir.
* **`az logout`** tokenı kaldırır.
* Eski **`Az PowerShell`** sürümleri, **erişim tokenlarını** **açık** metin olarak **`TokenCache.dat`** dosyasında saklardı. Ayrıca **ServicePrincipalSecret**'i **açık** metin olarak **`AzureRmContext.json`** dosyasında saklar. **`Save-AzContext`** cmdlet'i **tokenları** **saklamak** için kullanılabilir.\
`Disconnect-AzAccount` kullanarak bunları kaldırın.
* 3. tarafların **ihlal edilmesi**
* **Dahili** Çalışan
* [**Yaygın Phishing**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (kimlik bilgileri veya Oauth Uygulaması)
* [Device Code Authentication Phishing](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
* [Azure **Password Spraying**](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)

Saldırdığınız Azure tenant'ında **hiçbir kullanıcıyı ele geçirmemiş olsanız bile**, ondan **bazı bilgiler toplayabilirsiniz**:

{% content-ref url="az-unauthenticated-enum-and-initial-entry/" %}
[az-unauthenticated-enum-and-initial-entry](az-unauthenticated-enum-and-initial-entry/)
{% endcontent-ref %}

{% hint style="info" %}
Kimlik bilgilerini elde ettikten sonra, bu kimlik bilgilerinin **kime ait olduğunu** ve **neye erişimleri olduğunu** bilmeniz gerekir, bu yüzden bazı temel enumarasyonlar yapmanız gerekir:
{% endhint %}

## Temel Enumarasyon

{% hint style="info" %}
Unutmayın ki enumarasyonun **en gürültülü** kısmı **giriş** yapmaktır, enumarasyonun kendisi değil.
{% endhint %}

### SSRF

Azure içinde bir makinede SSRF bulduysanız, ipuçları için bu sayfayı kontrol edin:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Giriş Koşullarını Atlatma

<figure><img src="../../.gitbook/assets/image (268).png" alt=""><figcaption></figcaption></figure>

Geçerli kimlik bilgilerine sahip olduğunuz ancak giriş yapamadığınız durumlarda, bu yaygın korumalardan bazıları devrede olabilir:

* **IP beyaz listeleme** -- Geçerli bir IP'yi ele geçirmeniz gerekir
* **Coğrafi kısıtlamalar** -- Kullanıcının nerede yaşadığını veya şirketin ofislerinin nerede olduğunu bulun ve aynı şehirden (veya en azından ülkeden) bir IP alın
* **Tarayıcı** -- Belki sadece belirli bir işletim sisteminden (Windows, Linux, Mac, Android, iOS) bir tarayıcıya izin verilir. Kurbanın/şirketin hangi işletim sistemini kullandığını öğrenin.
* Ayrıca **Service Principal kimlik bilgilerini** ele geçirmeyi deneyebilirsiniz, çünkü genellikle daha az sınırlıdırlar ve girişleri daha az incelenir

Bunu atlattıktan sonra, başlangıç ayarlarınıza geri dönebilir ve hala erişiminiz olabilir.

### Alt Alan Adı Ele Geçirme

* [https://godiego.co/posts/STO-Azure/](https://godiego.co/posts/STO-Azure/)

### Whoami

{% hint style="danger" %}
az cli, AzureAD ve Az PowerShell'in nasıl **kurulacağını** öğrenin [**Az - AzureAD**](az-azuread/) bölümünde.
{% endhint %}

Bilmeniz gereken ilk şeylerden biri **kim olduğunuz** (hangi ortamda olduğunuz):

{% tabs %}
{% tab title="az cli" %}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{% endtab %}

{% tab title="AzureAD" %}
```powershell
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{% tab title="Az PowerShell" %}
```powershell
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
# Enumerate all resources visible to the current user
Get-AzResource
# Enumerate all Azure RBAC role assignments
Get-AzRoleAssignment # For all users
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com # For current user
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Azure'ı numaralandırmak için en önemli komutlardan biri, Az PowerShell'den **`Get-AzResource`** komutudur, çünkü bu komut **mevcut kullanıcınızın hangi kaynakları görebileceğini bilmenizi sağlar**.

Aynı bilgiyi **web konsolunda** [https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll) adresine giderek veya "Tüm kaynaklar" araması yaparak alabilirsiniz.
{% endhint %}

### AzureAD Numaralandırma

Varsayılan olarak, herhangi bir kullanıcı **kullanıcılar, gruplar, roller, hizmet ilkeleri gibi şeyleri numaralandırmak için yeterli izinlere sahip olmalıdır** (kontrol edin [varsayılan AzureAD izinleri](az-basic-information.md#default-user-permissions)).\
Burada bir kılavuz bulabilirsiniz:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

{% hint style="info" %}
Artık **kimlik bilgileriniz hakkında bazı bilgilere sahipsiniz** (ve eğer bir red team iseniz umarım **tespit edilmediniz**). Şimdi ortamda hangi hizmetlerin kullanıldığını anlamanın zamanı geldi.\
Aşağıdaki bölümde **bazı yaygın hizmetleri numaralandırmanın bazı yollarını** kontrol edebilirsiniz.
{% endhint %}

## Hizmet İlkesi ve Erişim Politikası

Bir Azure hizmeti, Sistem Kimliği (hizmetin kendisi) veya Kullanıcı Atanmış Yönetilen Kimlik kullanabilir. Bu Kimlik, örneğin, sırları okumak için bir KeyVault'a Erişim Politikası'na sahip olabilir. Bu Erişim Politikaları kısıtlanmalıdır (en az ayrıcalık ilkesi), ancak gerekenden daha fazla izne sahip olabilir. Tipik olarak bir App Service, sırları ve sertifikaları almak için KeyVault kullanır.

Bu kimlikleri keşfetmek faydalıdır.

## App Service SCM

App Service 'konteynerine' giriş yapmak için Kudu konsolu.

## Webshell

portal.azure.com'u kullanarak kabuğu seçin veya shell.azure.com'u kullanarak bash veya powershell için. Bu kabuğun 'disk'i bir depolama hesabında bir görüntü dosyası olarak saklanır.

## Azure DevOps

Azure DevOps, Azure'dan ayrıdır. Depolar, boru hatları (yaml veya sürüm), panolar, wiki ve daha fazlasına sahiptir. Değişken Grupları, değişken değerlerini ve sırları saklamak için kullanılır.

## Otomatik Keşif Araçları

### [**ROADRecon**](https://github.com/dirkjanm/ROADtools)
```powershell
cd ROADTools
pipenv shell
roadrecon auth -u test@corp.onmicrosoft.com -p "Welcome2022!"
roadrecon gather
roadrecon gui
```
### [Monkey365](https://github.com/silverhack/monkey365)

{% code overflow="wrap" %}
```powershell
Import-Module monkey365
Get-Help Invoke-Monkey365
Get-Help Invoke-Monkey365 -Detailed
Invoke-Monkey365 -IncludeAzureActiveDirectory -ExportTo HTML -Verbose -Debug -InformationAction Continue
Invoke-Monkey365 - Instance Azure -Analysis All -ExportTo HTML
```
{% endcode %}

### [**Stormspotter**](https://github.com/Azure/Stormspotter)
```powershell
# Start Backend
cd stormspotter\backend\
pipenv shell
python ssbackend.pyz

# Start Front-end
cd stormspotter\frontend\dist\spa\
quasar.cmd serve -p 9091 --history

# Run Stormcollector
cd stormspotter\stormcollector\
pipenv shell
az login -u test@corp.onmicrosoft.com -p Welcome2022!
python stormspotter\stormcollector\sscollector.pyz cli
# This will generate a .zip file to upload in the frontend (127.0.0.1:9091)
```
### [**AzureHound**](https://github.com/BloodHoundAD/AzureHound)

AzureHound, BloodHound'un Azure Active Directory (Azure AD) için olan versiyonudur. BloodHound, Active Directory ortamlarında saldırı yollarını analiz etmek için kullanılan bir araçtır. AzureHound, benzer şekilde, Azure AD ortamlarında saldırı yollarını analiz etmek için kullanılır. Bu araç, Azure AD'deki kullanıcılar, gruplar, uygulamalar ve izinler arasındaki ilişkileri grafiksel olarak gösterir.
```powershell
# You need to use the Az PowerShell and Azure AD modules:
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

Import-Module AzureAD\AzureAD.psd1
Connect-AzureAD -Credential $creds

# Launch AzureHound
. AzureHound\AzureHound.ps1
Invoke-AzureHound -Verbose

# Simple queries
## All Azure Users
MATCH (n:AZUser) return n.name
## All Azure Applications
MATCH (n:AZApp) return n.objectid
## All Azure Devices
MATCH (n:AZDevice) return n.name
## All Azure Groups
MATCH (n:AZGroup) return n.name
## All Azure Key Vaults
MATCH (n:AZKeyVault) return n.name
## All Azure Resource Groups
MATCH (n:AZResourceGroup) return n.name
## All Azure Service Principals
MATCH (n:AZServicePrincipal) return n.objectid
## All Azure Virtual Machines
MATCH (n:AZVM) return n.name
## All Principals with the ‘Contributor’ role
MATCH p = (n)-[r:AZContributor]->(g) RETURN p

# Advanced queries
## Get Global Admins
MATCH p =(n)-[r:AZGlobalAdmin*1..]->(m) RETURN p
## Owners of Azure Groups
MATCH p = (n)-[r:AZOwns]->(g:AZGroup) RETURN p
## All Azure Users and their Groups
MATCH p=(m:AZUser)-[r:MemberOf]->(n) WHERE NOT m.objectid CONTAINS 'S-1-5' RETURN p
## Privileged Service Principals
MATCH p = (g:AZServicePrincipal)-[r]->(n) RETURN p
## Owners of Azure Applications
MATCH p = (n)-[r:AZOwns]->(g:AZApp) RETURN p
## Paths to VMs
MATCH p = (n)-[r]->(g: AZVM) RETURN p
## Paths to KeyVault
MATCH p = (n)-[r]->(g:AZKeyVault) RETURN p
## Paths to Azure Resource Group
MATCH p = (n)-[r]->(g:AZResourceGroup) RETURN p
## On-Prem users with edges to Azure
MATCH  p=(m:User)-[r:AZResetPassword|AZOwns|AZUserAccessAdministrator|AZContributor|AZAddMembers|AZGlobalAdmin|AZVMContributor|AZOwnsAZAvereContributor]->(n) WHERE m.objectid CONTAINS 'S-1-5-21' RETURN p
## All Azure AD Groups that are synchronized with On-Premise AD
MATCH (n:Group) WHERE n.objectid CONTAINS 'S-1-5' AND n.azsyncid IS NOT NULL RETURN n
```
### [Azucar](https://github.com/nccgroup/azucar)

Azucar, Azure ortamlarının güvenliğini değerlendirmek için kullanılan bir araçtır. Bu araç, çeşitli güvenlik kontrollerini ve yapılandırmalarını denetler ve raporlar oluşturur.
```bash
# You should use an account with at least read-permission on the assets you want to access
git clone https://github.com/nccgroup/azucar.git
PS> Get-ChildItem -Recurse c:\Azucar_V10 | Unblock-File

PS> .\Azucar.ps1 -AuthMode UseCachedCredentials -Verbose -WriteLog -Debug -ExportTo PRINT
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -CertFilePassword MySuperP@ssw0rd! -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000

# resolve the TenantID for an specific username
PS> .\Azucar.ps1 -ResolveTenantUserName user@company.com
```
### [**MicroBurst**](https://github.com/NetSPI/MicroBurst)
```
Import-Module .\MicroBurst.psm1
Import-Module .\Get-AzureDomainInfo.ps1
Get-AzureDomainInfo -folder MicroBurst -Verbose
```
### [**PowerZure**](https://github.com/hausec/PowerZure)
```powershell
Connect-AzAccount
ipmo C:\Path\To\Powerzure.psd1
Get-AzureTarget

# Reader
$ Get-Runbook, Get-AllUsers, Get-Apps, Get-Resources, Get-WebApps, Get-WebAppDetails

# Contributor
$ Execute-Command -OS Windows -VM Win10Test -ResourceGroup Test-RG -Command "whoami"
$ Execute-MSBuild -VM Win10Test  -ResourceGroup Test-RG -File "build.xml"
$ Get-AllSecrets # AllAppSecrets, AllKeyVaultContents
$ Get-AvailableVMDisks, Get-VMDisk # Download a virtual machine's disk

# Owner
$ Set-Role -Role Contributor -User test@contoso.com -Resource Win10VMTest

# Administrator
$ Create-Backdoor, Execute-Backdoor
```
{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) **bizi takip edin.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek hacking ipuçlarını paylaşın.

</details>
{% endhint %}
