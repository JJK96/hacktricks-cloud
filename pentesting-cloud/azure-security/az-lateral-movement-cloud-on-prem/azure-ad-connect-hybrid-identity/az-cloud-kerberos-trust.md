# Az - Bulut Kerberos Güveni

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR gönderin.

</details>
{% endhint %}

**Bu yazı,** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **adresindeki saldırı hakkında daha fazla bilgi için kontrol edilebilir. Bu teknik ayrıca** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)** adresinde de yorumlanmıştır.**

## Temel Bilgiler

### Güven

Azure AD ile bir güven ilişkisi kurulduğunda, AD'de bir **Salt Okunur Etki Alanı Denetleyicisi (RODC)** oluşturulur. **RODC bilgisayar hesabı**, **`AzureADKerberos$`** adında. Ayrıca, ikincil bir `krbtgt` hesabı olan **`krbtgt_AzureAD`** adında. Bu hesap, Azure AD'nin oluşturduğu biletler için kullanılan **Kerberos anahtarlarını** içerir.

Bu nedenle, bu hesap ele geçirilirse herhangi bir kullanıcıyı taklit etmek mümkün olabilir... ancak bu doğru değildir çünkü bu hesap, Etki Alanı Yöneticileri, Kurumsal Yöneticiler, Yöneticiler gibi yaygın ayrıcalıklı AD grupları için bilet oluşturmasının önüne geçilmiştir...

{% hint style="danger" %}
Ancak, gerçek bir senaryoda bu gruplarda olmayan ayrıcalıklı kullanıcılar olacaktır. Bu nedenle, **yeni krbtgt hesabı ele geçirilirse, onları taklit etmek için kullanılabilir.**
{% endhint %}

### Kerberos TGT

Dahası, bir kullanıcı Windows'ta **Azure AD** kullanarak kimlik doğruladığında, **Azure AD** kısmi bir Kerberos biletini **PRT ile birlikte verecektir.** TGT, **AzureAD'nin on-prem AD'deki kullanıcı hakkında sınırlı bilgiye sahip olması nedeniyle kısmidir (güvenlik tanımlayıcı (SID) ve ad gibi).**\
Windows daha sonra, bu kısmi TGT'yi bir `krbtgt` hizmeti için bir hizmet bileti isteyerek tam bir TGT ile değiştirebilir.&#x20;

### NTLM

Kerberos kimlik doğrulamasını desteklemeyen hizmetler olabileceğinden, bir **ikincil `krbtgt`** anahtarını kullanarak imzalanmış bir kısmi TGT istemek ve isteğin **PADATA** kısmında **`KERB-KEY-LIST-REQ`** alanını içeren bir yanıtta **NT hash** içeren tam bir TGT almak mümkündür.

## Bulut Kerberos Güvenini Kötüye Kullanarak Etki Alanı Yöneticisi Elde Etme <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

AzureAD bir **kısmi TGT** oluşturduğunda, kullanıcı hakkında sahip olduğu ayrıntıları kullanacaktır. Bu nedenle, bir Global Yönetici, AzureAD'deki kullanıcının **güvenlik tanımlayıcısını ve adını değiştirebilirse**, o kullanıcı için TGT istendiğinde **güvenlik tanımlayıcısı farklı olacaktır**.

Bu, Microsoft Graph veya Azure AD Graph üzerinden yapılamaz, ancak Global Yöneticilerin kullanabileceği **API Active Directory Connect** kullanılabilir. Bu API, Global Yöneticilerin **hibrit kullanıcıların SAM adını ve SID'sini değiştirmelerine izin verir** ve ardından kimlik doğrulama yaparsak, değiştirilmiş SID içeren bir kısmi TGT alırız.

Bu işlemi AADInternals ile yapabilir ve senkronize edilen kullanıcılara [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a) cmdlet'i aracılığıyla güncelleme yapabilirsiniz.

### Saldırı Önkoşulları <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Saldırının başarısı ve Etki Alanı Yöneticisi ayrıcalıklarının elde edilmesi belirli önkoşulların karşılanmasına bağlıdır:

* Hesapları Senkronizasyon API'si aracılığıyla değiştirme yeteneği önemlidir. Bu, Global Yönetici rolüne sahip olmak veya bir AD Connect senkronizasyon hesabına sahip olmakla elde edilebilir. Ayrıca, Hibrit Kimlik Yöneticisi rolü de yeterlidir, çünkü AD Connect'i yönetme ve yeni senkronizasyon hesapları oluşturma yetkisini verir.
* Bir **hibrit hesabın** varlığı önemlidir. Bu hesap, kurban hesabının ayrıntıları ile değiştirilebilir olmalı ve kimlik doğrulama için erişilebilir olmalıdır.
* Active Directory içinde bir **hedef kurban hesabının** tanımlanması gereklidir. Saldırı senkronize edilmiş herhangi bir hesap üzerinde gerçekleştirilebilir olsa da, Azure AD kiracısının yerinde oluşturulmuş güvenlik tanımlayıcılarına sahip olmaması, senkronize edilmemiş bir hesabın değiştirilmesini gerektirir.
* Ayrıca, bu hesabın etki alanı yöneticisi eşdeğer ayrıcalıklara sahip olması gerekmektedir ancak tipik AD yönetici gruplarının üyesi olmamalıdır, AzureAD RODC tarafından geçersiz TGT'lerin oluşturulmasını önlemek için.
* En uygun hedef, **AD Connect Senkronizasyon hizmeti tarafından kullanılan Active Directory hesabıdır**. Bu hesap Azure AD ile senkronize edilmediği için, SID'si hedeflenebilir durumdadır ve Parola Hash Senkronizasyonu etkinse, doğal olarak Etki Alanı Yöneticisi eşdeğer ayrıcalıklara sahiptir. Hızlı kurulumlar için bu hesap **MSOL\_** ile başlar. Diğer durumlarda, hesap, etki alanı nesnesine verilen Dizin Çoğaltma ayrıcalıklarına sahip tüm hesapların listelenmesiyle belirlenebilir.

### Tam saldırı <a href="#the-full-attack" id="the-full-attack"></a>

Orijinal yazıda kontrol edin: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR gönderin.

</details>
{% endhint %}
