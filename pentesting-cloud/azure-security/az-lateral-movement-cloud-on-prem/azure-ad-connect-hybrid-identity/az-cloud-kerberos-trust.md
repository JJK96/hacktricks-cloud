# Az - Cloud Kerberos Trust

{% hint style="success" %}
Leer & oefen AWS-hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP-hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Controleer de [**abonnementsplannen**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

**Hierdie pos is 'n opsomming van** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **wat nagegaan kan word vir verdere inligting oor die aanval. Hierdie tegniek word ook bespreek in** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Basiese Inligting

### Vertroue

Wanneer 'n vertroue met Azure AD gevestig word, word 'n **Read Only Domain Controller (RODC)** in die AD geskep. Die **RODC-rekenaarrekening**, genaamd **`AzureADKerberos$`**. Ook 'n sekond√™re `krbtgt`-rekening genaamd **`krbtgt_AzureAD`**. Hierdie rekening bevat die **Kerberos-sleutels** wat gebruik word vir kaartjies wat Azure AD skep.

Daarom, as hierdie rekening gekompromitteer word, kan dit moontlik wees om enige gebruiker te impersoneer... alhoewel dit nie waar is nie omdat hierdie rekening verhoed word om kaartjies te skep vir enige algemene bevoorregte AD-groep soos Domain Admins, Enterprise Admins, Administrators...

{% hint style="danger" %}
Nietemin, in 'n werklike scenario gaan daar bevoorregte gebruikers wees wat nie in daardie groepe is nie. Dus kan die **nuwe krbtgt-rekening, indien gekompromitteer, gebruik word om hulle te impersoneer.**
{% endhint %}

### Kerberos TGT

Verder, wanneer 'n gebruiker op Windows geverifieer met 'n hibriede identiteit **Azure AD**, sal **gedeeltelike Kerberos-kaartjie saam met die PRT uitreik.** Die TGT is gedeeltelik omdat **AzureAD beperkte inligting** van die gebruiker in die on-prem AD het (soos die sekuriteitsidentifiseerder (SID) en die naam).\
Windows kan dan **hierdie gedeeltelike TGT vir 'n volledige TGT ruil** deur 'n dienskaartjie vir die `krbtgt`-diens aan te vra.&#x20;

### NTLM

Aangesien daar dienste kan wees wat nie Kerberos-verifikasie ondersteun nie, maar NTLM, is dit moontlik om 'n **gedeeltelike TGT aan te vra wat onderteken is met 'n sekond√™re `krbtgt`-sleutel** wat die **`KERB-KEY-LIST-REQ`-veld in die** PADATA **gedeelte van die versoek insluit en dan 'n volledige TGT kry wat onderteken is met die prim√™re `krbtgt`-sleutel** wat die NT-hash in die antwoord insluit.

## Misbruik van Cloud Kerberos Trust om Domein Admin te verkry <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Wanneer AzureAD 'n **gedeeltelike TGT** genereer, sal dit die besonderhede wat dit van die gebruiker het, gebruik. Daarom, as 'n Globale Admin data soos die **sekuriteitsidentifiseerder en naam van die gebruiker in AzureAD** kan wysig, wanneer 'n TGT vir daardie gebruiker aangevra word, sal die **sekuriteitsidentifiseerder 'n ander een wees**.

Dit is nie moontlik om dit te doen deur die Microsoft Graph of die Azure AD Graph nie, maar dit is moontlik om die **API Active Directory Connect** te gebruik wat deur die Globale Admins gebruik word om **die SAM-naam en SID van enige hibriede gebruiker te wysig**, en dan as ons geverifieer word, kry ons 'n gedeeltelike TGT wat die gewysigde SID bevat.

Let daarop dat ons dit kan doen met AADInternals en opgedateer kan word na gesinkroniseerde gebruikers via die [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a) cmdlet.

### Aanvalsvereistes <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Die sukses van die aanval en die verkryging van Domein Admin-voorregte hang af van die voldoening aan sekere vereistes:

* Die vermo√´ om rekeninge te verander via die Synchronisering-API is krities. Dit kan bereik word deur die rol van Globale Admin te h√™ of 'n AD Connect-sinkroniseringsrekening te besit. Alternatiewelik sou die rol van Hibriede Identiteitsadministrateur voldoende wees, aangesien dit die vermo√´ gee om AD Connect te bestuur en nuwe sinkroniseringsrekeninge te vestig.
* Teenwoordigheid van 'n **hibriede rekening** is noodsaaklik. Hierdie rekening moet vatbaar wees vir verandering met die besonderhede van die slagofferrekening en moet ook toeganklik wees vir verifikasie.
* Identifisering van 'n **teiken-slagofferrekening** binne Active Directory is 'n noodsaaklikheid. Alhoewel die aanval op enige rekening wat reeds gesinkroniseer is, uitgevoer kan word, moet die Azure AD-huurder nie op-premises sekuriteitsidentifiseerders gerepliseer het nie, wat die verandering van 'n nie-gesinkroniseerde rekening vereis om die kaartjie te bekom.
* Daarbenewens moet hierdie rekening domein-admin-ekwivalente voorregte h√™, maar moet nie 'n lid van tipiese AD-administratorsgroepe wees om die skep van ongeldige TGT's deur die AzureAD RODC te vermy.
* Die mees geskikte teiken is die **Active Directory-rekening wat deur die AD Connect Sync-diens gebruik word**. Hierdie rekening word nie met Azure AD gesinkroniseer nie, wat sy SID as 'n lewensvatbare teiken laat, en dit besit inherent domein-admin-ekwivalente voorregte weens sy rol in die sinkronisering van wagwoordhasies (onder die aanname dat Wagwoordhasie-sinkronisering aktief is). Vir domeine met uitdruklike installasie, word hierdie rekening voorafgegaan deur **MSOL\_**. Vir ander gevalle kan die rekening ge√Ødentifiseer word deur alle rekeninge op te som wat toegerus is met Gidsvervaardigingsvoorregte op die domeinobjek.

### Die volledige aanval <a href="#the-full-attack" id="the-full-attack"></a>

Kyk dit in die oorspronklike pos: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
Leer & oefen AWS-hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP-hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**abonnementsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
