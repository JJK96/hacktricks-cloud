# Az - Εμπιστοσύνη Kerberos στο Cloud

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ κάνοντας υποβολή PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

**Αυτή η ανάρτηση είναι ένας περίληψη του** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **το οποίο μπορείτε να ελέγξετε για περισσότερες πληροφορίες σχετικά με την επίθεση. Αυτή η τεχνική σχολιάζεται επίσης στο** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Βασικές Πληροφορίες

### Εμπιστοσύνη

Όταν δημιουργείται μια εμπιστοσύνη με το Azure AD, δημιουργείται ένας **Διακομιστής Περιορισμένων Δικαιωμάτων Εγγραφής (RODC) στο AD.** Ο λογαριασμός υπολογιστή του **RODC**, ονομάζεται **`AzureADKerberos$`**. Επίσης, υπάρχει ένας δευτερεύων λογαριασμός `krbtgt` με το όνομα **`krbtgt_AzureAD`**. Αυτός ο λογαριασμός περιέχει τα **κλειδιά Kerberos** που χρησιμοποιούνται για τα εισιτήρια που δημιουργεί το Azure AD.

Συνεπώς, αν αυτός ο λογαριασμός διαρρεύσει, θα μπορούσε να είναι δυνατή η υποκατάσταση οποιουδήποτε χρήστη... αν και αυτό δεν είναι αλήθεια επειδή αυτός ο λογαριασμός αποτρέπεται από το να δημιουργήσει εισιτήρια για οποιαδήποτε κοινή προνομιούχα ομάδα του AD όπως Domain Admins, Enterprise Admins, Administrators...

{% hint style="danger" %}
Ωστόσο, σε ένα πραγματικό σενάριο θα υπάρχουν προνομιούχοι χρήστες που δεν ανήκουν σε αυτές τις ομάδες. Έτσι ο **νέος λογαριασμός krbtgt, αν διαρρεύσει, μπορεί να χρησιμοποιηθεί για να υποκαταστήσει αυτούς τους χρήστες.**
{% endhint %}

### Kerberos TGT

Επιπλέον, όταν ένας χρήστης πιστοποιείται στα Windows χρησιμοποιώντας ένα υβριδικό ταυτότητας **Azure AD** θα εκδώσει ένα **μερικό εισιτήριο Kerberos μαζί με το PRT.** Το TGT είναι μερικό επειδή το **AzureAD έχει περιορισμένες πληροφορίες** του χρήστη στο on-prem AD (όπως ο αναγνωριστικός ασφαλείας (SID) και το όνομα).\
Τα Windows μπορούν στη συνέχεια να **ανταλλάξουν αυτό το μερικό TGT για ένα πλήρες TGT** ζητώντας ένα εισιτήριο υπηρεσίας για την υπηρεσία `krbtgt`.&#x20;

### NTLM

Καθώς μπορεί να υπάρχουν υπηρεσίες που δεν υποστηρίζουν ταυτοποίηση kerberos αλλά NTLM, είναι δυνατό να ζητηθεί ένα **μερικό TGT υπογεγραμμένο χρησιμοποιώντας ένα δευτερεύον `krbtgt`** κλειδί συμπεριλαμβάνοντας το πεδίο **`KERB-KEY-LIST-REQ`** στο μέρος **PADATA** του αιτήματος και στη συνέχεια να ληφθεί ένα πλήρες TGT υπογεγραμμένο με το κύριο `krbtgt` κλειδί **συμπεριλαμβάνοντας το NT hash στην απάντηση**.

## Κατάχρηση Εμπιστοσύνης Kerberos στο Cloud για την απόκτηση Domain Admin <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Όταν το AzureAD δημιουργεί ένα **μερικό TGT** θα χρησιμοποιεί τις λεπτομέρειες που έχει για τον χρήστη. Επομένως, αν ένας Global Admin μπορούσε να τροποποιήσει δεδομένα όπως το **αναγνωριστικό ασφαλείας και το όνομα του χρήστη στο AzureAD**, όταν ζητά ένα TGT για αυτόν τον χρήστη το **αναγνωριστικό ασφαλείας θα είναι διαφορετικό**.

Δεν είναι δυνατό να γίνει αυτό μέσω του Microsoft Graph ή του Azure AD Graph, αλλά είναι δυνατό να χρησιμοποιηθεί το **API το οποίο χρησιμοποιεί το Active Directory Connect** για να δημιουργήσει και να ενημερώσει συγχρονισμένους χρήστες, το οποίο μπορεί να χρησιμοποιηθεί από τους Global Admins για να **τροποποιήσουν το όνομα SAM και το SID οποιουδήποτε υβριδικού χρήστη**, και στη συνέχεια αν πιστοποιηθούμε, λαμβάνουμε ένα μερικό TGT που περιέχει το τροποποιημένο SID.

Σημειώστε ότι μπορούμε να το κάνουμε αυτό με το AADInternals και να ενημερώσουμε τους συγχρονισμένους χρήστες μέσω της εντολής [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a).

### Προϋποθέσεις επίθεσης <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Η επιτυχία της επίθεσης και η απόκτηση προνομιούχων δικαιωμάτων Domain Admin εξαρτώνται από την ικανότητα να πραγματοποιηθούν ορισμένες προϋποθέσεις:

* Η δυνατότητα να τροποποιηθούν οι λογαριασμοί μέσω του API Συγχρονισμού είναι κρίσιμη. Αυτό μπορεί να επιτευχθεί έχοντας το ρόλο του Global Admin ή κατέχοντας ένα λογαριασμό συγχρονισμού AD Connect. Εναλλακτικά, θα ήταν αρκετό να υπάρχει ο ρόλος του Διαχειριστή Υβριδικής Ταυτότητας, καθώς παρέχει τη δυνατότητα διαχείρισης του AD Connect και τη δημιουργία νέων λογαριασμών συγχρονισμού.
* Η ύπαρξη ενός **υβριδικού λογαριασμού** είναι απαραίτητη. Αυτός ο λογαριασμός πρέπει να είναι επιρρεπής σε τροποποίηση με τις λεπτομέρειες του λογαριασμού θύματος και πρέπει επίσης να είναι προσβάσιμος για πιστοποίηση.
* Η εντοπισμός ενός **λογαριασμού θύματος στο Active Directory** είναι αναγκαίος. Αν και η επίθεση μπορεί να εκτελεστεί σε οποιονδήποτε λογαριασμό έχει ήδη συγχρονιστεί, ο διακομιστής Azure AD δεν πρέπει να έχει αντιγράψει τα αναγνωριστικά ασφαλείας on-premises, απαιτώντας την τροποποίηση ενός λογαριασμού που δεν έχει συγχρονιστεί για την απόκτηση του εισιτηρίου.
* Επιπ
