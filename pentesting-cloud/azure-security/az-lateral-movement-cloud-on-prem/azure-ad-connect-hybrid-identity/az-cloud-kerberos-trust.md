# Az - Confian√ßa Kerberos na Nuvem

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

**Esta postagem √© um resumo de** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **que pode ser consultado para obter mais informa√ß√µes sobre o ataque. Esta t√©cnica tamb√©m √© comentada em** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Informa√ß√µes B√°sicas

### Confian√ßa

Quando uma confian√ßa √© estabelecida com o Azure AD, um **Controlador de Dom√≠nio Somente Leitura (RODC) √© criado no AD.** A conta de computador do **RODC**, chamada **`AzureADKerberos$`**. Al√©m disso, uma conta `krbtgt` secund√°ria chamada **`krbtgt_AzureAD`**. Esta conta cont√©m as **chaves Kerberos** usadas para os tickets que o Azure AD cria.

Portanto, se esta conta for comprometida, poderia ser poss√≠vel se passar por qualquer usu√°rio... embora isso n√£o seja verdade porque esta conta √© impedida de criar tickets para qualquer grupo AD privilegiado comum como Administradores de Dom√≠nio, Administradores de Empresa, Administradores...

{% hint style="danger" %}
No entanto, em um cen√°rio real, haver√° usu√°rios privilegiados que n√£o est√£o nesses grupos. Portanto, a **nova conta krbtgt, se comprometida, poderia ser usada para se passar por eles.**
{% endhint %}

### TGT Kerberos

Al√©m disso, quando um usu√°rio se autentica no Windows usando uma identidade h√≠brida do **Azure AD**, o **Azure AD** emitir√° um **ticket Kerberos parcial juntamente com o PRT.** O TGT √© parcial porque o **AzureAD tem informa√ß√µes limitadas** do usu√°rio no AD local (como o identificador de seguran√ßa (SID) e o nome).\
O Windows pode ent√£o **trocar este TGT parcial por um TGT completo** solicitando um ticket de servi√ßo para o servi√ßo `krbtgt`.&#x20;

### NTLM

Como pode haver servi√ßos que n√£o suportam autentica√ß√£o kerberos, mas NTLM, √© poss√≠vel solicitar um **TGT parcial assinado usando uma chave `krbtgt` secund√°ria** incluindo o campo **`KERB-KEY-LIST-REQ`** na parte **PADATA** da solicita√ß√£o e ent√£o obter um TGT completo assinado com a chave `krbtgt` prim√°ria **incluindo o hash NT na resposta**.

## Abusando da Confian√ßa Kerberos na Nuvem para obter Administrador de Dom√≠nio <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Quando o AzureAD gera um **TGT parcial**, ele estar√° usando os detalhes que possui sobre o usu√°rio. Portanto, se um Administrador Global puder modificar dados como o **identificador de seguran√ßa e nome do usu√°rio no AzureAD**, ao solicitar um TGT para esse usu√°rio, o **identificador de seguran√ßa ser√° diferente**.

N√£o √© poss√≠vel fazer isso atrav√©s do Microsoft Graph ou do Azure AD Graph, mas √© poss√≠vel usar a **API que o Active Directory Connect** usa para criar e atualizar usu√°rios sincronizados, que pode ser usada pelos Administradores Globais para **modificar o nome SAM e SID de qualquer usu√°rio h√≠brido**, e ent√£o, se autenticarmos, obtemos um TGT parcial contendo o SID modificado.

Observe que podemos fazer isso com o AADInternals e atualizar usu√°rios sincronizados via o cmdlet [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a).

### Pr√©-requisitos do Ataque <a href="#attack-prerequisites" id="attack-prerequisites"></a>

O sucesso do ataque e a obten√ß√£o de privil√©gios de Administrador de Dom√≠nio dependem do cumprimento de certos pr√©-requisitos:

* A capacidade de alterar contas via a API de Sincroniza√ß√£o √© crucial. Isso pode ser alcan√ßado tendo o papel de Administrador Global ou possuindo uma conta de sincroniza√ß√£o do AD Connect. Alternativamente, o papel de Administrador de Identidade H√≠brida seria suficiente, pois concede a capacidade de gerenciar o AD Connect e estabelecer novas contas de sincroniza√ß√£o.
* A presen√ßa de uma **conta h√≠brida** √© essencial. Esta conta deve ser pass√≠vel de modifica√ß√£o com os detalhes da conta da v√≠tima e tamb√©m deve ser acess√≠vel para autentica√ß√£o.
* A identifica√ß√£o de uma **conta v√≠tima alvo** dentro do Active Directory √© uma necessidade. Embora o ataque possa ser executado em qualquer conta j√° sincronizada, o locat√°rio do Azure AD n√£o deve ter replicado identificadores de seguran√ßa localmente, exigindo a modifica√ß√£o de uma conta n√£o sincronizada para obter o ticket.
* Al√©m disso, esta conta deve possuir privil√©gios equivalentes aos de um administrador de dom√≠nio, mas n√£o deve ser membro de grupos administrativos AD t√≠picos para evitar a gera√ß√£o de TGTs inv√°lidos pelo RODC do AzureAD.
* O alvo mais adequado √© a **conta do Active Directory utilizada pelo servi√ßo de Sincroniza√ß√£o do AD Connect**. Esta conta n√£o √© sincronizada com o Azure AD, deixando seu SID como um alvo vi√°vel, e ela possui inerentemente privil√©gios equivalentes aos de um Administrador de Dom√≠nio devido ao seu papel na sincroniza√ß√£o de hashes de senha (assumindo que a Sincroniza√ß√£o de Hash de Senha est√° ativa). Para dom√≠nios com instala√ß√£o expressa, esta conta √© prefixada com **MSOL\_**. Para outras inst√¢ncias, a conta pode ser identificada enumerando todas as contas dotadas de privil√©gios de Replica√ß√£o de Diret√≥rio no objeto de dom√≠nio.

### O ataque completo <a href="#the-full-attack" id="the-full-attack"></a>

Verifique no post original: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
