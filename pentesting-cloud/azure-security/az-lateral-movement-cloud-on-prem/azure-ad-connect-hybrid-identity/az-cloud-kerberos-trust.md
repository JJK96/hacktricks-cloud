# Az - Poverenje Kerbera u oblaku

{% hint style="success" %}
Naučite i vežbajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

**Ovaj post je sažetak** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **koji se može proveriti za dodatne informacije o napadu. Ova tehnika je takođe komentarisana u** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Osnovne informacije

### Poverenje

Kada se uspostavi poverenje sa Azure AD, u AD-u se kreira **Read Only Domain Controller (RODC)**. Nalog računara **RODC-a** nazvan je **`AzureADKerberos$`**. Takođe, postoji sekundarni `krbtgt` nalog nazvan **`krbtgt_AzureAD`**. Ovaj nalog sadrži **Kerberos ključeve** koji se koriste za tikete koje kreira Azure AD.

Stoga, ako je ovaj nalog kompromitovan, moguće je preuzeti identitet bilo kog korisnika... iako to nije tačno jer je ovom nalogu onemogućeno kreiranje tiketa za bilo koju uobičajenu privilegovanu AD grupu poput Domain Admins, Enterprise Admins, Administrators...

{% hint style="danger" %}
Međutim, u stvarnom scenariju postojaće privilegovani korisnici koji nisu u tim grupama. Dakle, **novi krbtgt nalog, ako je kompromitovan, može se koristiti za preuzimanje njihovog identiteta.**
{% endhint %}

### Kerberos TGT

Osim toga, kada se korisnik autentifikuje na Windowsu koristeći hibridni identitet **Azure AD** izdaće **delimičan Kerberos tiket zajedno sa PRT-om**. TGT je delimičan jer **AzureAD ima ograničene informacije** o korisniku u on-prem AD-u (kao što su sigurnosni identifikator (SID) i ime).\
Windows može zatim **zameniti ovaj delimičan TGT za pun TGT** zahtevajući servisni tiket za uslugu `krbtgt`.&#x20;

### NTLM

Kako mogu postojati servisi koji ne podržavaju Kerberos autentifikaciju već NTLM, moguće je zatražiti **delimičan TGT potpisan korišćenjem sekundarnog `krbtgt`** ključa uključujući **`KERB-KEY-LIST-REQ`** polje u **PADATA** delu zahteva, a zatim dobiti pun TGT potpisan primarnim `krbtgt` ključem **uključujući NT hash u odgovoru**.

## Zloupotreba Poverenja Kerbera u oblaku radi dobijanja Domain Admin-a <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Kada AzureAD generiše **delimičan TGT** koristiće detalje koje ima o korisniku. Dakle, ako Globalni Admin može da izmeni podatke poput **sigurnosnog identifikatora i imena korisnika u AzureAD-u**, prilikom zahteva za TGT za tog korisnika **sigurnosni identifikator biće drugačiji**.

To nije moguće uraditi putem Microsoft Graph-a ili Azure AD Graph-a, ali je moguće koristiti **API Active Directory Connect** koji koriste Globalni Admini da bi **izmenili SAM ime i SID bilo kog hibridnog korisnika**, a zatim ako se autentičujemo, dobijamo delimičan TGT koji sadrži izmenjeni SID.

Imajte na umu da to možemo uraditi sa AADInternals i ažurirati sinhronizovane korisnike putem [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a) cmdleta.

### Preduslovi napada <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Uspeh napada i sticanje privilegija Domain Admin-a zavise od ispunjenja određenih preduslova:

* Mogućnost izmene naloga putem Synchronization API-ja je ključna. To se može postići imajući ulogu Globalnog Admina ili posedovanjem naloga za sinhronizaciju AD Connect-a. Alternativno, uloga Administratora hibridnog identiteta bi bila dovoljna, jer omogućava upravljanje AD Connect-om i uspostavljanje novih naloga za sinhronizaciju.
* Prisustvo **hibridnog naloga** je neophodno. Ovaj nalog mora biti podložan izmenama sa detaljima žrtvinog naloga i takođe mora biti dostupan za autentifikaciju.
* Identifikacija **ciljnog žrtvenog naloga** u Active Directory-u je neophodna. Iako se napad može izvršiti na bilo koji već sinhronizovan nalog, Azure AD zakupac ne sme imati replikovane sigurnosne identifikatore sa lokacije, što zahteva izmenu neusklađenog naloga radi dobijanja tiketa.
* Osim toga, ovaj nalog treba da ima privilegije ekvivalentne Domain Admin-u, ali ne sme biti član tipičnih AD administratorskih grupa kako bi se izbeglo generisanje nevažećih TGT-ova od strane AzureAD RODC-a.
* Najpogodnija meta je **Active Directory nalog koji koristi AD Connect Sync servis**. Ovaj nalog nije sinhronizovan sa Azure AD-om, ostavljajući njegov SID kao moguću metu, a inherentno poseduje privilegije ekvivalentne Domain Admin-u zbog svoje uloge u sinhronizaciji heševa lozinki (ukoliko je aktivno sinhronizovanje heševa lozinki). Za domene sa ekspres instalacijom, ovaj nalog ima prefiks **MSOL\_**. Za druge instance, nalog se može locirati enumeracijom svih naloga kojima su dodeljene privilegije Repliciranja direktorijuma na objektu domene.

### Potpuni napad <a href="#the-full-attack" id="the-full-attack"></a>

Proverite u originalnom postu: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
Naučite i vežbajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
