# Az - Confiance Kerberos Cloud

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

**Cet article est un r√©sum√© de** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **qui peut √™tre consult√© pour plus d'informations sur l'attaque. Cette technique est √©galement comment√©e dans** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Informations de base

### Confiance

Lorsqu'une confiance est √©tablie avec Azure AD, un **Contr√¥leur de domaine en lecture seule (RODC) est cr√©√© dans l'AD.** Le compte d'ordinateur RODC, nomm√© **`AzureADKerberos$`**. De plus, un compte `krbtgt` secondaire nomm√© **`krbtgt_AzureAD`** est cr√©√©. Ce compte contient les **cl√©s Kerberos** utilis√©es pour les tickets cr√©√©s par Azure AD.

Par cons√©quent, si ce compte est compromis, il pourrait √™tre possible de se faire passer pour n'importe quel utilisateur... bien que ce ne soit pas vrai car ce compte est emp√™ch√© de cr√©er des tickets pour tout groupe AD privil√©gi√© courant comme les administrateurs de domaine, les administrateurs d'entreprise, les administrateurs...

{% hint style="danger" %}
Cependant, dans un sc√©nario r√©el, il y aura des utilisateurs privil√©gi√©s qui ne sont pas dans ces groupes. Ainsi, le **nouveau compte krbtgt, s'il est compromis, pourrait √™tre utilis√© pour se faire passer pour eux.**
{% endhint %}

### TGT Kerberos

De plus, lorsqu'un utilisateur s'authentifie sur Windows en utilisant une identit√© hybride **Azure AD**, Azure AD √©mettra un **ticket Kerberos partiel avec le PRT.** Le TGT est partiel car **AzureAD a des informations limit√©es** sur l'utilisateur dans l'AD sur site (comme l'identifiant de s√©curit√© (SID) et le nom).\
Windows peut ensuite **√©changer ce TGT partiel contre un TGT complet** en demandant un ticket de service pour le service `krbtgt`.&#x20;

### NTLM

Comme il peut y avoir des services qui ne prennent pas en charge l'authentification Kerberos mais NTLM, il est possible de demander un **TGT partiel sign√© en utilisant un `krbtgt` secondaire** incluant le champ **`KERB-KEY-LIST-REQ`** dans la partie **PADATA** de la demande et ensuite obtenir un TGT complet sign√© avec la cl√© `krbtgt` primaire **incluant le hachage NT dans la r√©ponse**.

## Abus de la confiance Kerberos Cloud pour obtenir l'administrateur de domaine <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Lorsque AzureAD g√©n√®re un **TGT partiel**, il utilisera les d√©tails qu'il poss√®de sur l'utilisateur. Par cons√©quent, si un administrateur global pouvait modifier des donn√©es comme le **SID et le nom de l'utilisateur dans AzureAD**, lors de la demande d'un TGT pour cet utilisateur, le **SID serait diff√©rent**.

Il n'est pas possible de le faire via le Microsoft Graph ou l'Azure AD Graph, mais il est possible d'utiliser l'**API Active Directory Connect** utilis√©e pour cr√©er et mettre √† jour les utilisateurs synchronis√©s, ce qui peut √™tre utilis√© par les administrateurs globaux pour **modifier le nom SAM et le SID de tout utilisateur hybride**, et ensuite si nous nous authentifions, nous obtenons un TGT partiel contenant le SID modifi√©.

Notez que nous pouvons le faire avec AADInternals et mettre √† jour les utilisateurs synchronis√©s via la cmdlet [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a).

### Pr√©requis de l'attaque <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Le succ√®s de l'attaque et l'obtention des privil√®ges d'administrateur de domaine d√©pendent de certains pr√©requis :

* La capacit√© de modifier des comptes via l'API de synchronisation est cruciale. Cela peut √™tre r√©alis√© en ayant le r√¥le d'administrateur global ou en poss√©dant un compte de synchronisation AD Connect. Alternativement, le r√¥le d'administrateur d'identit√© hybride suffirait, car il accorde la capacit√© de g√©rer AD Connect et d'√©tablir de nouveaux comptes de synchronisation.
* La pr√©sence d'un **compte hybride** est essentielle. Ce compte doit √™tre modifiable avec les d√©tails du compte de la victime et doit √©galement √™tre accessible pour l'authentification.
* L'identification d'un **compte victime cible** dans Active Directory est une n√©cessit√©. Bien que l'attaque puisse √™tre ex√©cut√©e sur n'importe quel compte d√©j√† synchronis√©, le locataire Azure AD ne doit pas avoir r√©pliqu√© les identifiants de s√©curit√© sur site, ce qui n√©cessite la modification d'un compte non synchronis√© pour obtenir le ticket.
* De plus, ce compte doit poss√©der des privil√®ges √©quivalents √† ceux de l'administrateur de domaine mais ne doit pas √™tre membre des groupes d'administrateurs AD typiques pour √©viter la g√©n√©ration de TGT invalides par le RODC AzureAD.
* La cible la plus appropri√©e est le **compte Active Directory utilis√© par le service de synchronisation AD Connect**. Ce compte n'est pas synchronis√© avec Azure AD, laissant son SID comme une cible viable, et il d√©tient intrins√®quement des privil√®ges √©quivalents √† ceux de l'administrateur de domaine en raison de son r√¥le dans la synchronisation des hachages de mots de passe (en supposant que la synchronisation des hachages de mots de passe est active). Pour les domaines avec une installation express, ce compte est pr√©fix√© par **MSOL\_**. Pour d'autres instances, le compte peut √™tre identifi√© en √©num√©rant tous les comptes dot√©s de privil√®ges de r√©plication de r√©pertoire sur l'objet de domaine.

### L'attaque compl√®te <a href="#the-full-attack" id="the-full-attack"></a>

Consultez l'article original : [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}
