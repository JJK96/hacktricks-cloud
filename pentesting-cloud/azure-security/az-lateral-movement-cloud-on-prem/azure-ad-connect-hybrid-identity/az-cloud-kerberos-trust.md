# Az - Fiducia Kerberos Cloud

{% hint style="success" %}
Impara e pratica l'hacking su AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}

**Questo post √® un riassunto di** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **che pu√≤ essere consultato per ulteriori informazioni sull'attacco. Questa tecnica √® anche commentata in** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Informazioni di Base

### Fiducia

Quando viene stabilita una fiducia con Azure AD, viene creato un **Read Only Domain Controller (RODC)** nell'AD. L'account computer del **RODC**, chiamato **`AzureADKerberos$`**. Inoltre, viene creato un account `krbtgt` secondario chiamato **`krbtgt_AzureAD`**. Questo account contiene le **chiavi Kerberos** utilizzate per i ticket che Azure AD crea.

Pertanto, se questo account viene compromesso, potrebbe essere possibile impersonare qualsiasi utente... anche se non √® vero perch√© a questo account √® impedito di creare ticket per qualsiasi gruppo AD privilegiato comune come Domain Admins, Enterprise Admins, Amministratori...

{% hint style="danger" %}
Tuttavia, in uno scenario reale ci saranno utenti privilegiati che non sono in quei gruppi. Quindi il **nuovo account krbtgt, se compromesso, potrebbe essere utilizzato per impersonarli.**
{% endhint %}

### TGT Kerberos

Inoltre, quando un utente si autentica su Windows utilizzando un'identit√† ibrida **Azure AD** emetter√† un **ticket Kerberos parziale insieme al PRT**. Il TGT √® parziale perch√© **AzureAD ha informazioni limitate** dell'utente nell'AD locale (come l'identificatore di sicurezza (SID) e il nome).\
Windows pu√≤ quindi **scambiare questo TGT parziale per un TGT completo** richiedendo un ticket di servizio per il servizio `krbtgt`.&#x20;

### NTLM

Poich√© potrebbero esserci servizi che non supportano l'autenticazione kerberos ma NTLM, √® possibile richiedere un **TGT parziale firmato utilizzando una chiave `krbtgt` secondaria** includendo il campo **`KERB-KEY-LIST-REQ`** nella parte **PADATA** della richiesta e quindi ottenere un TGT completo firmato con la chiave `krbtgt` primaria **includendo l'hash NT nella risposta**.

## Abuso della Fiducia Kerberos Cloud per ottenere Domain Admin <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Quando AzureAD genera un **TGT parziale** utilizzer√† i dettagli che ha sull'utente. Pertanto, se un Global Admin potesse modificare dati come il **SID e il nome dell'utente in AzureAD**, quando richiede un TGT per quell'utente il **SID sar√† diverso**.

Non √® possibile farlo tramite il Microsoft Graph o l'Azure AD Graph, ma √® possibile utilizzare l'**API Active Directory Connect** utilizzata per creare e aggiornare gli utenti sincronizzati, che pu√≤ essere utilizzata dai Global Admin per **modificare il nome SAM e il SID di qualsiasi utente ibrido**, e quindi se ci autentichiamo, otteniamo un TGT parziale contenente il SID modificato.

Si noti che possiamo fare ci√≤ con AADInternals e aggiornare gli utenti sincronizzati tramite il [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a) cmdlet.

### Prerequisiti dell'Attacco <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Il successo dell'attacco e il conseguimento dei privilegi di Domain Admin dipendono dal soddisfacimento di determinati prerequisiti:

* La capacit√† di modificare gli account tramite l'API di Sincronizzazione √® cruciale. Ci√≤ pu√≤ essere ottenuto avendo il ruolo di Global Admin o possedendo un account di sincronizzazione AD Connect. In alternativa, il ruolo di Amministratore di Identit√† Ibrida sarebbe sufficiente, poich√© concede la capacit√† di gestire AD Connect e stabilire nuovi account di sincronizzazione.
* √à essenziale la presenza di un **account ibrido**. Questo account deve essere modificabile con i dettagli dell'account vittima e deve essere accessibile per l'autenticazione.
* √à necessario identificare un **account vittima target** all'interno di Active Directory. Anche se l'attacco pu√≤ essere eseguito su qualsiasi account gi√† sincronizzato, il tenant di Azure AD non deve aver replicato gli identificatori di sicurezza locali, rendendo necessaria la modifica di un account non sincronizzato per ottenere il ticket.
* Inoltre, questo account dovrebbe possedere privilegi equivalenti a Domain Admin ma non deve essere membro di gruppi amministratori AD tipici per evitare la generazione di TGT non validi da parte del RODC di AzureAD.
* Il target pi√π adatto √® l'**account Active Directory utilizzato dal servizio di sincronizzazione AD Connect**. Questo account non √® sincronizzato con Azure AD, lasciando il suo SID come un obiettivo valido, e detiene intrinsecamente privilegi equivalenti a Domain Admin a causa del suo ruolo nella sincronizzazione degli hash delle password (supponendo che la Password Hash Sync sia attiva). Per i domini con installazione express, questo account √® prefisso con **MSOL\_**. Per altre istanze, l'account pu√≤ essere individuato enumerando tutti gli account dotati di privilegi di Replica Directory sull'oggetto dominio.

### L'attacco completo <a href="#the-full-attack" id="the-full-attack"></a>

Controlla nell'articolo originale: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
Impara e pratica l'hacking su AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}
