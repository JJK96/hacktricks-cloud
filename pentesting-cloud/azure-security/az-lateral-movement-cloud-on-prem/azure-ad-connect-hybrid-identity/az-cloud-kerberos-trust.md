# Az - クラウドKerberosトラスト

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローする。**
* **HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してハッキングテクニックを共有する。

</details>
{% endhint %}

**この投稿は** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **の要約であり、攻撃に関する詳細情報はそちらを参照してください。この技術は** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**でも説明されています。**

## 基本情報

### 信頼関係

Azure ADとの信頼関係が確立されると、ADには**読み取り専用ドメインコントローラ（RODC）**が作成されます。**RODCコンピューターアカウント**は**`AzureADKerberos$`**という名前です。また、2次の`krbtgt`アカウントが**`krbtgt_AzureAD`**という名前で作成されます。このアカウントには、Azure ADが作成するチケットに使用される**Kerberosキー**が含まれています。

したがって、このアカウントが侵害されると、任意のユーザーをなりすますことが可能になります... ただし、このアカウントはドメイン管理者、エンタープライズ管理者、管理者などの一般的な特権付きADグループのためのチケットを作成することができないようになっています...

{% hint style="danger" %}
ただし、実際のシナリオでは、これらのグループに属さない特権ユーザーが存在する可能性があります。そのため、**新しいkrbtgtアカウントが侵害された場合、それを使用して彼らをなりすすことができます。**
{% endhint %}

### Kerberos TGT

さらに、ハイブリッドアイデンティティを使用してWindowsでユーザーが認証すると、**Azure AD**は**部分的なKerberosチケットとPRT**を発行します。TGTは部分的なものですが、**AzureADはオンプレミスADのユーザーに関する情報が制限されている**ため、（セキュリティ識別子（SID）や名前など）が含まれています。\
Windowsは、`krbtgt`サービスのためのサービスチケットを要求することで、この部分的なTGTを完全なTGTに**交換**できます。

### NTLM

Kerberos認証をサポートしていないサービスがあるため、**PADATA**リクエストの**`KERB-KEY-LIST-REQ`**フィールドを含む**2次`krbtgt`**キーで署名された部分的なTGTを要求し、応答で**NTハッシュを含む主要な`krbtgt`**キーで署名された完全なTGTを取得することが可能です。

## クラウドKerberosトラストの悪用によるドメイン管理者の取得 <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

AzureADが**部分的なTGT**を生成する際、ユーザーに関する持っている詳細を使用します。したがって、グローバル管理者がAzureADのユーザーの**セキュリティ識別子や名前などのデータを変更**できる場合、そのユーザーのTGTを要求するとき、**セキュリティ識別子が異なるものになります**。

これはMicrosoft GraphやAzure AD Graphを介してはできませんが、グローバル管理者が使用できる**API Active Directory Connect**を使用して、ハイブリッドユーザーの**SAM名とSIDを変更**することが可能です。その後、認証すると、変更されたSIDを含む部分的なTGTが得られます。

AADInternalsを使用してこれを行い、[Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a)コマンドレットを使用して同期されたユーザーを更新できます。

### 攻撃の前提条件 <a href="#attack-prerequisites" id="attack-prerequisites"></a>

攻撃の成功とドメイン管理者権限の獲得には、特定の前提条件を満たす必要があります：

* 同期APIを介してアカウントを変更できる能力が重要です。これはグローバル管理者の役割を持っているか、AD Connect同期アカウントを所有していることで達成できます。ハイブリッドアイデンティティ管理者の役割も適しており、AD Connectを管理し新しい同期アカウントを確立する権限を与えています。
* **ハイブリッドアカウント**の存在が不可欠です。このアカウントは、被害者アカウントの詳細を変更でき、認証可能である必要があります。
* Active Directory内の**ターゲット被害者アカウント**の特定が必要です。攻撃はすでに同期されているアカウントに対して実行できますが、Azure ADテナントはオンプレミスのセキュリティ識別子を複製していない必要があり、同期されていないアカウントを変更してチケットを取得する必要があります。
* さらに、このアカウントはドメイン管理者と同等の特権を持っている必要がありますが、一般的なAD管理者グループのメンバーではない必要があり、AzureAD RODCによる無効なTGTの生成を回避するためです。
* 最適なターゲットは、**AD Connect Syncサービスで使用されるActive Directoryアカウント**です。このアカウントはAzure ADと同期されていないため、そのSIDが攻撃対象となり、パスワードハッシュの同期に関与する役割を持つため、そのアカウントはデフォルトでドメイン管理者と同等の特権を持っています（パスワードハッシュ同期が有効であると仮定）。Expressインストールのドメインの場合、このアカウントは**MSOL\_**で始まります。他のインスタンスの場合、ドメインオブジェクトにディレクトリレプリケーション権限を持つすべてのアカウントを列挙することで、このアカウントを特定できます。

### 完全な攻撃 <a href="#the-full-attack" id="the-full-attack"></a>

元の投稿で確認してください：[https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローする。**
* **HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してハッキングテクニックを共有する。

</details>
{% endhint %}
