# Az AD Connect - Hibridni identitet

{% hint style="success" %}
Naučite i vežbajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne informacije

Integracija između **Lokalnog Active Directory-ja (AD)** i **Azure AD** je olakšana pomoću **Azure AD Connect**-a, nudeći različite metode koje podržavaju **Single Sign-on (SSO)**. Svaka metoda, iako korisna, predstavlja potencijalne sigurnosne ranjivosti koje bi mogle biti iskorišćene za kompromitovanje cloud ili on-premises okruženja:

* **Prosljeđivanje autentikacije (PTA)**:
- Mogućnost kompromitovanja agenta na on-prem AD, omogućavajući validaciju korisničkih lozinki za Azure konekcije (on-prem ka Cloud-u).
- Izvodljivost registrovanja novog agenta za validaciju autentikacija na novoj lokaciji (Cloud ka on-prem).

{% content-ref url="pta-pass-through-authentication.md" %}
[pta-pass-through-authentication.md](pta-pass-through-authentication.md)
{% endcontent-ref %}

* **Sinhronizacija lozinki (PHS)**:
- Potencijalno izvlačenje lozinki u čistom tekstu privilegovanih korisnika iz AD-a, uključujući akreditive visoko privilegovanog, automatski generisanog AzureAD korisnika.

{% content-ref url="phs-password-hash-sync.md" %}
[phs-password-hash-sync.md](phs-password-hash-sync.md)
{% endcontent-ref %}

* **Federacija**:
- Krađa privatnog ključa korišćenog za SAML potpisivanje, omogućavajući impersonaciju on-prem i cloud identiteta.

{% content-ref url="federation.md" %}
[federation.md](federation.md)
{% endcontent-ref %}

* **Bezbedno SSO:**
- Krađa lozinke korisnika `AZUREADSSOACC`, korištene za potpisivanje Kerberos srebrnih karata, omogućavajući impersonaciju bilo kog cloud korisnika.

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

* **Cloud Kerberos Trust**:
- Mogućnost eskalacije sa Global Admin na on-prem Domain Admin manipulacijom AzureAD korisničkih imena i SID-ova i zahtevanjem TGT-ova od AzureAD.

{% content-ref url="az-cloud-kerberos-trust.md" %}
[az-cloud-kerberos-trust.md](az-cloud-kerberos-trust.md)
{% endcontent-ref %}

* **Podrazumevane aplikacije**:
- Kompromitovanje naloga administratora aplikacije ili naloga za sinhronizaciju na lokalu omogućava modifikaciju postavki direktorijuma, članstava u grupama, korisničkih naloga, SharePoint sajtova i OneDrive fajlova.

{% content-ref url="az-default-applications.md" %}
[az-default-applications.md](az-default-applications.md)
{% endcontent-ref %}

Za svaku metodu integracije, sinhronizacija korisnika se sprovodi, i nalog `MSOL_<installationidentifier>` se kreira u on-prem AD-u. Važno je napomenuti da i **PHS** i **PTA** metode olakšavaju **Bezbedno SSO**, omogućavajući automatsku prijavu za Azure AD računare pridružene on-prem domenu.

Za proveru instalacije **Azure AD Connect**-a, može se koristiti sledeća PowerShell komanda, koristeći **AzureADConnectHealthSync** modul (instaliran podrazumevano sa Azure AD Connect-om):
```powershell
Get-ADSyncConnector
```
{% hint style="success" %}
Učite i vežbajte hakovanje AWS-a: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks obuka AWS Crveni Tim Ekspert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Učite i vežbajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks obuka GCP Crveni Tim Ekspert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
