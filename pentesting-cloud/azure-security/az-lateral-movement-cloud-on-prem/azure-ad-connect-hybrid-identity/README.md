# Az AD Connect - Identidade H√≠brida

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

A integra√ß√£o entre o **Active Directory (AD) local** e o **Azure AD** √© facilitada pelo **Azure AD Connect**, oferecendo v√°rios m√©todos que suportam **Single Sign-on (SSO)**. Cada m√©todo, embora √∫til, apresenta potenciais vulnerabilidades de seguran√ßa que poderiam ser exploradas para comprometer ambientes em nuvem ou locais:

* **Autentica√ß√£o de Passagem (PTA)**:
- Poss√≠vel comprometimento do agente no AD local, permitindo a valida√ß√£o das senhas dos usu√°rios para conex√µes com o Azure (local para nuvem).
- Viabilidade de registrar um novo agente para validar autentica√ß√µes em um novo local (nuvem para local).

{% content-ref url="pta-pass-through-authentication.md" %}
[pta-pass-through-authentication.md](pta-pass-through-authentication.md)
{% endcontent-ref %}

* **Sincroniza√ß√£o de Hash de Senha (PHS)**:
- Extra√ß√£o potencial de senhas em texto claro de usu√°rios privilegiados do AD, incluindo credenciais de um usu√°rio AzureAD auto-gerado de alto privil√©gio.

{% content-ref url="phs-password-hash-sync.md" %}
[phs-password-hash-sync.md](phs-password-hash-sync.md)
{% endcontent-ref %}

* **Federa√ß√£o**:
- Roubo da chave privada usada para assinatura SAML, permitindo a impersonifica√ß√£o de identidades locais e em nuvem.

{% content-ref url="federation.md" %}
[federation.md](federation.md)
{% endcontent-ref %}

* **SSO Cont√≠nuo:**
- Roubo da senha do usu√°rio `AZUREADSSOACC`, usada para assinar tickets Kerberos silver, permitindo a impersonifica√ß√£o de qualquer usu√°rio em nuvem.

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

* **Confian√ßa Kerberos em Nuvem**:
- Possibilidade de escalonamento de Global Admin para Domain Admin local manipulando nomes de usu√°rios e SIDs de usu√°rios AzureAD e solicitando TGTs do AzureAD.

{% content-ref url="az-cloud-kerberos-trust.md" %}
[az-cloud-kerberos-trust.md](az-cloud-kerberos-trust.md)
{% endcontent-ref %}

* **Aplicativos Padr√£o**:
- Comprometer uma conta de Administrador de Aplicativos ou a Conta de Sincroniza√ß√£o local permite a modifica√ß√£o de configura√ß√µes de diret√≥rio, associa√ß√µes de grupos, contas de usu√°rios, sites do SharePoint e arquivos do OneDrive.

{% content-ref url="az-default-applications.md" %}
[az-default-applications.md](az-default-applications.md)
{% endcontent-ref %}

Para cada m√©todo de integra√ß√£o, a sincroniza√ß√£o de usu√°rios √© realizada, e uma conta `MSOL_<installationidentifier>` √© criada no AD local. Notavelmente, tanto os m√©todos **PHS** quanto **PTA** facilitam o **SSO Cont√≠nuo**, permitindo o login autom√°tico para computadores Azure AD associados ao dom√≠nio local.

Para verificar a instala√ß√£o do **Azure AD Connect**, o seguinte comando PowerShell, utilizando o m√≥dulo **AzureADConnectHealthSync** (instalado por padr√£o com o Azure AD Connect), pode ser usado:
```powershell
Get-ADSyncConnector
```
{% hint style="success" %}
Aprenda e pratique Hacking AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte o HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
