# Az - PTA - Pass-through Authentication

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication allows your users to **sign in to both on-premises and cloud-based applications using the same passwords**. This feature provides your users a better experience - one less password to remember, and reduces IT helpdesk costs because your users are less likely to forget how to sign in. When users sign in using Azure AD, this feature **validates users' passwords directly against your on-premises Active Directory**.

PTA에서 **아이덴티티**는 **동기화**되지만 **비밀번호**는 PHS처럼 **동기화되지 않습니다**.

인증은 온프레미스 AD에서 검증되며, 클라우드와의 통신은 **온프레미스 서버**에서 실행되는 **인증 에이전트**에 의해 이루어집니다 (온프레미스 DC에 있을 필요는 없습니다).

### Authentication flow

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. **로그인**을 위해 사용자는 **Azure AD**로 리디렉션되며, 여기서 **사용자 이름**과 **비밀번호**를 입력합니다.
2. **자격 증명**은 **암호화**되어 Azure AD의 **큐**에 설정됩니다.
3. **온프레미스 인증 에이전트**가 큐에서 **자격 증명**을 수집하고 **복호화**합니다. 이 에이전트는 **"Pass-through authentication agent"** 또는 **PTA agent**라고 불립니다.
4. **에이전트**는 **온프레미스 AD**에서 자격 증명을 **검증**하고 **응답**을 Azure AD로 **전송**합니다. 응답이 긍정적이면 사용자의 **로그인이 완료**됩니다.

{% hint style="warning" %}
공격자가 **PTA**를 **침해**하면 큐에 있는 모든 **자격 증명**을 **명확한 텍스트**로 **볼 수 있습니다**.\
또한 **모든 자격 증명**을 AzureAD에 **검증**할 수 있습니다 (Skeleton key와 유사한 공격).
{% endhint %}

### On-Prem -> cloud

**PTA** **에이전트**가 실행 중인 **Azure AD Connect 서버**에 **관리자** 접근 권한이 있는 경우, **AADInternals** 모듈을 사용하여 **모든 비밀번호**를 **검증**하는 **백도어**를 **삽입**할 수 있습니다 (따라서 모든 비밀번호가 인증에 유효하게 됩니다):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
**설치가 실패**하는 경우, 이는 [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe)가 누락되었기 때문일 수 있습니다.
{% endhint %}

이전 백도어가 설치된 머신에서 다음 cmdlet을 사용하여 **PTA 에이전트로 전송된 평문 비밀번호를 볼 수 있습니다**:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
이 백도어는 다음을 수행합니다:

* 숨겨진 폴더 `C:\PTASpy` 생성
* `PTASpy.dll`을 `C:\PTASpy`에 복사
* `PTASpy.dll`을 `AzureADConnectAuthenticationAgentService` 프로세스에 주입

{% hint style="info" %}
AzureADConnectAuthenticationAgent 서비스가 재시작되면, PTASpy는 "언로드"되고 다시 설치해야 합니다.
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
클라우드에서 **GA 권한**을 얻은 후, **공격자가 제어하는 머신**에 **새로운 PTA 에이전트**를 등록할 수 있습니다. 에이전트가 **설치**되면, **이전** 단계를 **반복**하여 **어떤 비밀번호로도 인증**할 수 있으며, **평문으로 비밀번호를 얻을 수 있습니다.**
{% endhint %}

### Seamless SSO

PTA와 함께 Seamless SSO를 사용할 수 있으며, 이는 다른 악용에 취약합니다. 자세한 내용은 다음을 참조하세요:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## References

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

{% hint style="success" %}
AWS Hacking 학습 및 연습:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking 학습 및 연습: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원</summary>

* [**구독 플랜**](https://github.com/sponsors/carlospolop)을 확인하세요!
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**telegram 그룹**](https://t.me/peass)에 가입하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)을 팔로우하세요.
* **PR을 제출하여** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 해킹 트릭을 공유하세요.

</details>
{% endhint %}
