# Az - PTA - Pass-through Authentication

{% hint style="success" %}
AWS Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХреЛ рд╕рдорд░реНрдерди рджреЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рд╣рдореЗрдВ **Twitter** ЁЯРж рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>
{% endhint %}

## Basic Information

[рдбреЙрдХреНрд╕ рд╕реЗ:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication рдЖрдкрдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ **рдЙрд╕реА рдкрд╛рд╕рд╡рд░реНрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдСрди-рдкреНрд░рд┐рдорд╛рдЗрд╕реЗрд╕ рдФрд░ рдХреНрд▓рд╛рдЙрдб-рдЖрдзрд╛рд░рд┐рдд рдПрдкреНрд▓рд┐рдХреЗрд╢рди рджреЛрдиреЛрдВ рдореЗрдВ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ**ред рдпрд╣ рд╕реБрд╡рд┐рдзрд╛ рдЖрдкрдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдмреЗрд╣рддрд░ рдЕрдиреБрднрд╡ рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ - рдпрд╛рдж рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдХрдо рдкрд╛рд╕рд╡рд░реНрдб, рдФрд░ рдЖрдИрдЯреА рд╣реЗрд▓реНрдкрдбреЗрд╕реНрдХ рд▓рд╛рдЧрдд рдХреЛ рдХрдо рдХрд░рддреА рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЖрдкрдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рд╕рд╛рдЗрди рдЗрди рдХрд░рдирд╛ рднреВрд▓рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдХрдо рд╣реЛрддреА рд╣реИред рдЬрдм рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ Azure AD рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рд╛рдЗрди рдЗрди рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ рд╕реБрд╡рд┐рдзрд╛ **рдЖрдкрдХреЗ рдСрди-рдкреНрд░рд┐рдорд╛рдЗрд╕реЗрд╕ Active Directory рдХреЗ рдЦрд┐рд▓рд╛рдл рд╕реАрдзреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ рдорд╛рдиреНрдп рдХрд░рддреА рд╣реИ**ред

PTA рдореЗрдВ **рдкрд╣рдЪрд╛рдиреЗрдВ** **рд╕рд┐рдВрдХ** рдХреА рдЬрд╛рддреА рд╣реИрдВ рд▓реЗрдХрд┐рди **рдкрд╛рд╕рд╡рд░реНрдб** **рдирд╣реАрдВ** рдЬреИрд╕реЗ рдХрд┐ PHS рдореЗрдВред

рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдСрди-рдкреНрд░рд┐рдо AD рдореЗрдВ рдорд╛рдиреНрдп рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдХреНрд▓рд╛рдЙрдб рдХреЗ рд╕рд╛рде рд╕рдВрдЪрд╛рд░ рдПрдХ **рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдПрдЬреЗрдВрдЯ** рджреНрд╡рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ рдПрдХ **рдСрди-рдкреНрд░рд┐рдо рд╕рд░реНрд╡рд░** рдореЗрдВ рдЪрд▓рддрд╛ рд╣реИ (рдпрд╣ рдСрди-рдкреНрд░рд┐рдо DC рдореЗрдВ рд╣реЛрдирд╛ рдЖрд╡рд╢реНрдпрдХ рдирд╣реАрдВ рд╣реИ)ред

### Authentication flow

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. **рд▓реЙрдЧрд┐рди** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ **Azure AD** рдкрд░ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд╣рд╛рдВ рд╡рд╣ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо** рдФрд░ **рдкрд╛рд╕рд╡рд░реНрдб** рднреЗрдЬрддрд╛ рд╣реИ
2. **рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕** рдХреЛ **рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ Azure AD рдореЗрдВ рдПрдХ **рдХреНрдпреВ** рдореЗрдВ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ
3. **рдСрди-рдкреНрд░рд┐рдо рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдПрдЬреЗрдВрдЯ** рдХреНрдпреВ рд╕реЗ **рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕** рдХреЛ рдЗрдХрдЯреНрдард╛ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЙрдиреНрд╣реЗрдВ **рдбрд┐рдХреНрд░рд┐рдкреНрдЯ** рдХрд░рддрд╛ рд╣реИред рдЗрд╕ рдПрдЬреЗрдВрдЯ рдХреЛ **"Pass-through authentication agent"** рдпрд╛ **PTA рдПрдЬреЗрдВрдЯ** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред
4. **рдПрдЬреЗрдВрдЯ** **рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕** рдХреЛ **рдСрди-рдкреНрд░рд┐рдо AD** рдХреЗ рдЦрд┐рд▓рд╛рдл **рдорд╛рдиреНрдп** рдХрд░рддрд╛ рд╣реИ рдФрд░ **рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** рдХреЛ Azure AD рдореЗрдВ **рд╡рд╛рдкрд╕** рднреЗрдЬрддрд╛ рд╣реИ, рдЬреЛ, рдпрджрд┐ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╕рдХрд╛рд░рд╛рддреНрдордХ рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ **рд▓реЙрдЧрд┐рди рдкреВрд░рд╛** рдХрд░рддрд╛ рд╣реИред

{% hint style="warning" %}
рдпрджрд┐ рдХреЛрдИ рд╣рдорд▓рд╛рд╡рд░ **PTA** рд╕реЗ **рд╕рдордЭреМрддрд╛** рдХрд░рддрд╛ рд╣реИ рддреЛ рд╡рд╣ рдХреНрдпреВ рд╕реЗ рд╕рднреА **рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕** (рд╕реНрдкрд╖реНрдЯ-рдкрд╛рда рдореЗрдВ) **рджреЗрдЦ рд╕рдХрддрд╛ рд╣реИ**ред\
рд╡рд╣ AzureAD рдХреЗ рд▓рд┐рдП рдХрд┐рд╕реА рднреА рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ **рдорд╛рдиреНрдп** рднреА рдХрд░ рд╕рдХрддрд╛ рд╣реИ (Skeleton key рдХреЗ рд╕рдорд╛рди рд╣рдорд▓рд╛)ред
{% endhint %}

### On-Prem -> cloud

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ **Azure AD Connect рд╕рд░реНрд╡рд░** рдХреЗ рд▓рд┐рдП **рдПрдбрдорд┐рди** рдПрдХреНрд╕реЗрд╕ рд╣реИ рдЬрд┐рд╕рдореЗрдВ **PTA** **рдПрдЬреЗрдВрдЯ** рдЪрд▓ рд░рд╣рд╛ рд╣реИ, рддреЛ рдЖрдк **AADInternals** рдореЙрдбреНрдпреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ **рдмреИрдХрдбреЛрд░** **рдбрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВ** рдЬреЛ **рд╕рднреА рдкрд╛рд╕рд╡рд░реНрдбреНрд╕** рдХреЛ рдорд╛рдиреНрдп рдХрд░реЗрдЧрд╛ (рдЗрд╕рд▓рд┐рдП рд╕рднреА рдкрд╛рд╕рд╡рд░реНрдб рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдорд╛рдиреНрдп рд╣реЛрдВрдЧреЗ):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
рдпрджрд┐ **рдЗрдВрд╕реНрдЯреЙрд▓реЗрд╢рди рд╡рд┐рдлрд▓** рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рд╕рдВрднрд╡рддрдГ [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe) рдХреЗ рдЧрд╛рдпрдм рд╣реЛрдиреЗ рдХреЗ рдХрд╛рд░рдг рд╣реИред
{% endhint %}

рдпрд╣ рднреА рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **PTA рдПрдЬреЗрдВрдЯ рдХреЛ рднреЗрдЬреЗ рдЧрдП рд╕реНрдкрд╖реНрдЯ-рдкрд╛рда рдкрд╛рд╕рд╡рд░реНрдб рджреЗрдЦреЗрдВ** рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд cmdlet рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрд╕ рдорд╢реАрди рдкрд░ рдЬрд╣рд╛рдВ рдкрд┐рдЫрд▓рд╛ рдмреИрдХрдбреЛрд░ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
This backdoor will:

* рдПрдХ рдЫреБрдкрд╛ рд╣реБрдЖ рдлреЛрд▓реНрдбрд░ рдмрдирд╛рдПрдЧрд╛ `C:\PTASpy`
* рдПрдХ `PTASpy.dll` рдХреЛ `C:\PTASpy` рдореЗрдВ рдХреЙрдкреА рдХрд░реЗрдЧрд╛
* `PTASpy.dll` рдХреЛ `AzureADConnectAuthenticationAgentService` рдкреНрд░реЛрд╕реЗрд╕ рдореЗрдВ рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░реЗрдЧрд╛

{% hint style="info" %}
рдЬрдм AzureADConnectAuthenticationAgent рд╕реЗрд╡рд╛ рдХреЛ рдкреБрдирдГ рдкреНрд░рд╛рд░рдВрдн рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, PTASpy "рдЕрдирд▓реЛрдб" рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдкреБрдирдГ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ рдкрдбрд╝рддрд╛ рд╣реИред
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
рдХреНрд▓рд╛рдЙрдб рдкрд░ **GA рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, **рдПрдХ рдирдпрд╛ PTA рдПрдЬреЗрдВрдЯ рд░рдЬрд┐рд╕реНрдЯрд░** рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЗрд╕реЗ **рдЕрдЯреИрдХрд░ рдирд┐рдпрдВрддреНрд░рд┐рдд рдорд╢реАрди** рдкрд░ рд╕реЗрдЯ рдХрд░рдХреЗред рдПрдХ рдмрд╛рд░ рдПрдЬреЗрдВрдЯ **рд╕реЗрдЯрдЕрдк** рд╣реЛ рдЬрд╛рдиреЗ рдХреЗ рдмрд╛рдж, рд╣рдо **рдкрд┐рдЫрд▓реЗ** рдЪрд░рдгреЛрдВ рдХреЛ **рджреЛрд╣рд░рд╛** рд╕рдХрддреЗ рд╣реИрдВ **рдХрд┐рд╕реА рднреА рдкрд╛рд╕рд╡рд░реНрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП** рдФрд░ рд╕рд╛рде рд╣реА, **рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ рд╕реНрдкрд╖реНрдЯ-рдЯреЗрдХреНрд╕реНрдЯ рдореЗрдВ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред**
{% endhint %}

### Seamless SSO

PTA рдХреЗ рд╕рд╛рде Seamless SSO рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ, рдЬреЛ рдЕрдиреНрдп рджреБрд░реБрдкрдпреЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реИред рдЗрд╕реЗ рджреЗрдЦреЗрдВ:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## References

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

{% hint style="success" %}
AWS Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХреЛ рд╕рдкреЛрд░реНрдЯ рдХрд░реЗрдВ</summary>

* [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* ЁЯТм [**Discord рдЧреНрд░реБрдк**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рдЧреНрд░реБрдк**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рд╣рдореЗрдВ **Twitter** ЁЯРж рдкрд░ рдлреЙрд▓реЛ рдХрд░реЗрдВ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд╝рд┐рдЯрд░реА рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>
{% endhint %}
