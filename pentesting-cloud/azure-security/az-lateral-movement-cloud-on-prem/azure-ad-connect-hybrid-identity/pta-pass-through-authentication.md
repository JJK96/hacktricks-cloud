# Az - PTA - Pass-through Authentication

{% hint style="success" %}
Jifunze na kufanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na kufanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Taarifa za Msingi

[Kutoka kwenye nyaraka:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication inaruhusu watumiaji wako **kuingia kwenye programu za ndani na za wingu kwa kutumia nywila zile zile**. Kipengele hiki kinawapa watumiaji wako uzoefu bora - nywila moja kidogo ya kukumbuka, na hupunguza gharama za msaada wa IT kwa sababu watumiaji wako hawana uwezekano wa kusahau jinsi ya kuingia. Watumiaji wanapoingia kwa kutumia Azure AD, kipengele hiki **kinathibitisha nywila za watumiaji moja kwa moja dhidi ya Active Directory yako ya ndani**.

Katika PTA **utambulisho** **unasawazishwa** lakini **nywila** **hazisawazishwi** kama ilivyo kwenye PHS.

Uthibitishaji unathibitishwa katika AD ya ndani na mawasiliano na wingu hufanywa na **wakala wa uthibitishaji** anayeendesha kwenye **seva ya ndani** (haitaji kuwa kwenye DC ya ndani).

### Mtiririko wa Uthibitishaji

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. Ili **kuingia** mtumiaji anapelekwa kwa **Azure AD**, ambapo anatuma **jina la mtumiaji** na **nywila**
2. **Kitambulisho** **kinasimbwa** na kuwekwa kwenye **foleni** katika Azure AD
3. **Wakala wa uthibitishaji wa ndani** anakusanya **kitambulisho** kutoka kwenye foleni na **anakifungua**. Wakala huyu anaitwa **"Pass-through authentication agent"** au **PTA agent.**
4. **Wakala** **anathibitisha** kitambulisho dhidi ya **AD ya ndani** na kutuma **jibu** **kurudi** kwa Azure AD ambayo, ikiwa jibu ni chanya, **inakamilisha kuingia** kwa mtumiaji.

{% hint style="warning" %}
Ikiwa mshambuliaji **ataingilia** **PTA** anaweza **kuona** **kitambulisho chote** kutoka kwenye foleni (katika **maandishi wazi**).\
Anaweza pia **kuthibitisha kitambulisho chochote** kwa AzureAD (shambulio sawa na Skeleton key).
{% endhint %}

### Ndani -> wingu

Ikiwa una **ufikiaji wa admin** kwenye **seva ya Azure AD Connect** na **wakala wa PTA** unaoendesha, unaweza kutumia **moduli ya AADInternals** **kuingiza mlango wa nyuma** ambao utathibitisha **nywila ZOTE** zilizoingizwa (kwa hivyo nywila zote zitakuwa halali kwa uthibitishaji):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Ikiwa **usakinishaji unashindwa**, hii inaweza kuwa kutokana na kukosekana kwa [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe).
{% endhint %}

Pia inawezekana **kuona nywila wazi zilizotumwa kwa PTA agent** kwa kutumia cmdlet ifuatayo kwenye mashine ambapo backdoor ya awali ilisakinishwa:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
This backdoor will:

* Create a hidden folder `C:\PTASpy`
* Copy a `PTASpy.dll` to `C:\PTASpy`
* Injects `PTASpy.dll` to `AzureADConnectAuthenticationAgentService` process

{% hint style="info" %}
Wakati huduma ya AzureADConnectAuthenticationAgent inapoanzishwa tena, PTASpy inatolewa na inahitaji kusakinishwa tena.
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
Baada ya kupata **GA privileges** kwenye cloud, inawezekana **kusajili PTA agent mpya** kwa kuiweka kwenye **mashine inayodhibitiwa na mshambuliaji**. Mara baada ya agent **kusakinishwa**, tunaweza **kurudia** hatua **za awali** ili **kuthibitisha kwa kutumia nenosiri lolote** na pia, **kupata nywila kwa maandishi wazi.**
{% endhint %}

### Seamless SSO

Inawezekana kutumia Seamless SSO na PTA, ambayo ni dhaifu kwa matumizi mengine mabaya. Angalia katika:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## References

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

{% hint style="success" %}
Jifunze & fanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & fanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
