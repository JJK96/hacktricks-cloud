# Az - PTA - Pass-through Authentication

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Βασικές Πληροφορίες

[Από τα έγγραφα:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Το Azure Active Directory (Azure AD) Pass-through Authentication επιτρέπει στους χρήστες σας να **συνδέονται τόσο σε τοπικές όσο και σε εφαρμογές που βασίζονται στο cloud χρησιμοποιώντας τους ίδιους κωδικούς πρόσβασης**. Αυτή η δυνατότητα παρέχει στους χρήστες σας μια καλύτερη εμπειρία - έναν κωδικό πρόσβασης λιγότερο να θυμούνται, και μειώνει τα κόστη του IT helpdesk επειδή οι χρήστες σας είναι λιγότερο πιθανό να ξεχάσουν πώς να συνδεθούν. Όταν οι χρήστες συνδέονται χρησιμοποιώντας το Azure AD, αυτή η δυνατότητα **επαληθεύει τους κωδικούς πρόσβασης των χρηστών απευθείας έναντι του τοπικού Active Directory σας**.

Στο PTA οι **ταυτότητες** είναι **συγχρονισμένες** αλλά οι **κωδικοί πρόσβασης** **δεν είναι** όπως στο PHS.

Η επαλήθευση γίνεται στο τοπικό AD και η επικοινωνία με το cloud γίνεται από έναν **πράκτορα επαλήθευσης** που εκτελείται σε έναν **τοπικό διακομιστή** (δεν χρειάζεται να είναι στον τοπικό DC).

### Ροή Επαλήθευσης

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. Για να **συνδεθεί** ο χρήστης ανακατευθύνεται στο **Azure AD**, όπου στέλνει το **όνομα χρήστη** και τον **κωδικό πρόσβασης**
2. Τα **διαπιστευτήρια** είναι **κρυπτογραφημένα** και τοποθετούνται σε μια **ουρά** στο Azure AD
3. Ο **τοπικός πράκτορας επαλήθευσης** συλλέγει τα **διαπιστευτήρια** από την ουρά και τα **αποκρυπτογραφεί**. Αυτός ο πράκτορας ονομάζεται **"Pass-through authentication agent"** ή **PTA agent.**
4. Ο **πράκτορας** **επαληθεύει** τα διαπιστευτήρια έναντι του **τοπικού AD** και στέλνει την **απάντηση** **πίσω** στο Azure AD το οποίο, αν η απάντηση είναι θετική, **ολοκληρώνει τη σύνδεση** του χρήστη.

{% hint style="warning" %}
Αν ένας επιτιθέμενος **παραβιάσει** το **PTA** μπορεί να **δει** όλα τα **διαπιστευτήρια** από την ουρά (σε **απλό κείμενο**).\
Μπορεί επίσης να **επαληθεύσει οποιαδήποτε διαπιστευτήρια** στο AzureAD (παρόμοια επίθεση με το Skeleton key).
{% endhint %}

### On-Prem -> cloud

Αν έχετε **διαχειριστική** πρόσβαση στον **διακομιστή Azure AD Connect** με τον **πράκτορα PTA** να εκτελείται, μπορείτε να χρησιμοποιήσετε το **AADInternals** module για να **εισάγετε ένα backdoor** που θα **επαληθεύει ΟΛΟΥΣ τους κωδικούς πρόσβασης** που εισάγονται (έτσι όλοι οι κωδικοί πρόσβασης θα είναι έγκυροι για επαλήθευση):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Αν η **εγκατάσταση αποτύχει**, αυτό πιθανώς οφείλεται στην έλλειψη των [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe).
{% endhint %}

Είναι επίσης δυνατό να **δείτε τους κωδικούς πρόσβασης σε απλό κείμενο που αποστέλλονται στον PTA agent** χρησιμοποιώντας την ακόλουθη cmdlet στη μηχανή όπου εγκαταστάθηκε το προηγούμενο backdoor:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
This backdoor will:

* Create a hidden folder `C:\PTASpy`
* Copy a `PTASpy.dll` to `C:\PTASpy`
* Injects `PTASpy.dll` to `AzureADConnectAuthenticationAgentService` process

{% hint style="info" %}
Όταν η υπηρεσία AzureADConnectAuthenticationAgent επανεκκινείται, το PTASpy "αποφορτώνεται" και πρέπει να επανεγκατασταθεί.
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
Αφού αποκτήσετε **GA προνόμια** στο cloud, είναι δυνατό να **εγγραφεί ένας νέος PTA agent** ρυθμίζοντάς τον σε μια **μηχανή ελεγχόμενη από τον επιτιθέμενο**. Μόλις ο agent **ρυθμιστεί**, μπορούμε να **επαναλάβουμε** τα **προηγούμενα** βήματα για να **αυθεντικοποιηθούμε χρησιμοποιώντας οποιονδήποτε κωδικό πρόσβασης** και επίσης, **να αποκτήσουμε τους κωδικούς πρόσβασης σε απλό κείμενο.**
{% endhint %}

### Seamless SSO

Είναι δυνατό να χρησιμοποιηθεί το Seamless SSO με PTA, το οποίο είναι ευάλωτο σε άλλες καταχρήσεις. Ελέγξτε το στο:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## References

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
