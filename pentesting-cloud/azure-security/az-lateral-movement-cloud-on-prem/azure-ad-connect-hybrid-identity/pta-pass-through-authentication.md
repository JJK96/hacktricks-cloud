# Az - PTA - Pass-through Authentication

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## 基本情報

[ドキュメントから:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authenticationは、ユーザーが**同じパスワードを使用してオンプレミスおよびクラウドベースのアプリケーションにサインインできるようにします**。この機能は、ユーザーにとってより良い体験を提供し、ITヘルプデスクのコストを削減します。ユーザーがAzure ADを使用してサインインすると、この機能は**オンプレミスのActive Directoryに対して直接ユーザーのパスワードを検証します**。

PTAでは、**ID**は**同期**されますが、**パスワード**はPHSのようには**同期されません**。

認証はオンプレミスのADで検証され、クラウドとの通信は**オンプレミスサーバー**で実行される**認証エージェント**によって行われます（オンプレミスのDCである必要はありません）。

### 認証フロー

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. **ログイン**するためにユーザーは**Azure AD**にリダイレクトされ、**ユーザー名**と**パスワード**を送信します
2. **資格情報**は**暗号化**され、Azure ADの**キュー**に設定されます
3. **オンプレミス認証エージェント**がキューから**資格情報**を収集し、**復号化**します。このエージェントは**"Pass-through authentication agent"**または**PTAエージェント**と呼ばれます。
4. **エージェント**は資格情報を**オンプレミスAD**に対して**検証**し、Azure ADに**応答**を送信します。応答が肯定的であれば、ユーザーの**ログインが完了**します。

{% hint style="warning" %}
攻撃者が**PTA**を**侵害**した場合、キューからすべての**資格情報**を**クリアテキスト**で**見る**ことができます。\
また、AzureADに対して**任意の資格情報を検証**することもできます（Skeleton keyに似た攻撃）。
{% endhint %}

### オンプレミス -> クラウド

**PTA**エージェントが実行されている**Azure AD Connectサーバー**に**管理者**アクセスがある場合、**AADInternals**モジュールを使用して**バックドアを挿入**し、**すべてのパスワード**を**検証**することができます（すべてのパスワードが認証に有効になります）：
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
**インストールが失敗**する場合、これはおそらく[Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe)が不足しているためです。
{% endhint %}

以前のバックドアがインストールされたマシンで、以下のコマンドレットを使用して**PTAエージェントに送信された平文パスワードを見る**ことも可能です:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
このバックドアは以下を行います:

* 隠しフォルダ `C:\PTASpy` を作成
* `PTASpy.dll` を `C:\PTASpy` にコピー
* `PTASpy.dll` を `AzureADConnectAuthenticationAgentService` プロセスに注入

{% hint style="info" %}
AzureADConnectAuthenticationAgent サービスが再起動されると、PTASpy は「アンロード」され、再インストールが必要です。
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
クラウドで **GA 特権** を取得した後、**攻撃者が制御するマシン** に **新しい PTA エージェントを登録** することが可能です。エージェントが **セットアップ** されると、**前述の手順** を繰り返して **任意のパスワードを使用して認証** し、**平文のパスワードを取得** することができます。
{% endhint %}

### Seamless SSO

PTA と Seamless SSO を使用することが可能で、これは他の悪用に対して脆弱です。詳細は以下を参照してください:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## 参考文献

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

{% hint style="success" %}
AWS Hacking を学び、実践する:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking を学び、実践する: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks をサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop) をチェック！
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) をフォローしてください。
* **ハッキングトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks) および [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出してください。

</details>
{% endhint %}
