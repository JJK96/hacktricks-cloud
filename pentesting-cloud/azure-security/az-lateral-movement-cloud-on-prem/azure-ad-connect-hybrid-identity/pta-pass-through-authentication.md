# Az - PTA - Pass-through Authentication

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informaci칩n B치sica

[De la documentaci칩n:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication permite a tus usuarios **iniciar sesi칩n en aplicaciones locales y basadas en la nube usando las mismas contrase침as**. Esta caracter칤stica proporciona a tus usuarios una mejor experiencia - una contrase침a menos que recordar, y reduce los costos del servicio de asistencia de TI porque es menos probable que tus usuarios olviden c칩mo iniciar sesi칩n. Cuando los usuarios inician sesi칩n usando Azure AD, esta caracter칤stica **valida las contrase침as de los usuarios directamente contra tu Active Directory local**.

En PTA las **identidades** est치n **sincronizadas** pero las **contrase침as** **no** como en PHS.

La autenticaci칩n se valida en el AD local y la comunicaci칩n con la nube se realiza mediante un **agente de autenticaci칩n** que se ejecuta en un **servidor local** (no necesita estar en el DC local).

### Flujo de Autenticaci칩n

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. Para **iniciar sesi칩n** el usuario es redirigido a **Azure AD**, donde env칤a el **nombre de usuario** y la **contrase침a**
2. Las **credenciales** son **encriptadas** y colocadas en una **cola** en Azure AD
3. El **agente de autenticaci칩n local** recoge las **credenciales** de la cola y las **desencripta**. Este agente se llama **"agente de autenticaci칩n de paso"** o **agente PTA.**
4. El **agente** **valida** las credenciales contra el **AD local** y env칤a la **respuesta** **de vuelta** a Azure AD que, si la respuesta es positiva, **completa el inicio de sesi칩n** del usuario.

{% hint style="warning" %}
Si un atacante **compromete** el **PTA** puede **ver** todas las **credenciales** de la cola (en **texto claro**).\
Tambi칠n puede **validar cualquier credencial** en AzureAD (ataque similar a Skeleton key).
{% endhint %}

### Local -> nube

Si tienes acceso **administrativo** al **servidor de Azure AD Connect** con el **agente PTA** en ejecuci칩n, puedes usar el m칩dulo **AADInternals** para **insertar una puerta trasera** que **validar치 TODAS las contrase침as** introducidas (por lo que todas las contrase침as ser치n v치lidas para la autenticaci칩n):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Si la **instalaci칩n falla**, esto probablemente se deba a la falta de [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe).
{% endhint %}

Tambi칠n es posible **ver las contrase침as en texto claro enviadas al agente PTA** usando el siguiente cmdlet en la m치quina donde se instal칩 el backdoor anterior:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Este backdoor har치:

* Crear una carpeta oculta `C:\PTASpy`
* Copiar un `PTASpy.dll` a `C:\PTASpy`
* Inyectar `PTASpy.dll` al proceso `AzureADConnectAuthenticationAgentService`

{% hint style="info" %}
Cuando se reinicia el servicio AzureADConnectAuthenticationAgent, PTASpy se "descarga" y debe ser reinstalado.
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
Despu칠s de obtener **privilegios GA** en la nube, es posible **registrar un nuevo agente PTA** configur치ndolo en una **m치quina controlada por el atacante**. Una vez que el agente est치 **configurado**, podemos **repetir** los **pasos anteriores** para **autenticar usando cualquier contrase침a** y tambi칠n, **obtener las contrase침as en texto claro.**
{% endhint %}

### Seamless SSO

Es posible usar Seamless SSO con PTA, que es vulnerable a otros abusos. Rev칤salo en:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Referencias

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
