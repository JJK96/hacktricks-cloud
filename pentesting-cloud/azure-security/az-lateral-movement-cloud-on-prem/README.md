# Az - Lateral Movement (Cloud - On-Prem)

## Az - Lateral Movement (Cloud - On-Prem)

{% hint style="success" %}
AWS 해킹 학습 및 연습:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP 해킹 학습 및 연습: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원</summary>

* [**구독 플랜**](https://github.com/sponsors/carlospolop) 확인!
* **💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**telegram 그룹**](https://t.me/peass)에 가입하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우하세요.**
* **PR을 제출하여 해킹 트릭을 공유하세요:** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소.

</details>
{% endhint %}

### 클라우드에 연결된 온프레미스 머신

머신이 클라우드에 연결되는 방법은 여러 가지가 있습니다:

#### Azure AD 가입

<figure><img src="../../../.gitbook/assets/image (259).png" alt=""><figcaption></figcaption></figure>

#### Workplace 가입

<figure><img src="../../../.gitbook/assets/image (222).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Hybrid 가입

<figure><img src="../../../.gitbook/assets/image (178).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### AADJ 또는 Hybrid에 Workplace 가입

<figure><img src="../../../.gitbook/assets/image (252).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large</a></p></figcaption></figure>

### 토큰 및 제한 사항 <a href="#tokens-and-limitations" id="tokens-and-limitations"></a>

Azure AD에는 특정 제한 사항이 있는 다양한 유형의 토큰이 있습니다:

* **Access tokens**: Microsoft Graph와 같은 API 및 리소스에 액세스하는 데 사용됩니다. 특정 클라이언트 및 리소스에 연결됩니다.
* **Refresh tokens**: 새로운 access tokens을 얻기 위해 애플리케이션에 발급됩니다. 발급된 애플리케이션 또는 애플리케이션 그룹에서만 사용할 수 있습니다.
* **Primary Refresh Tokens (PRT)**: Azure AD 가입, 등록 또는 하이브리드 가입 장치에서 Single Sign-On에 사용됩니다. 브라우저 로그인 흐름 및 장치의 모바일 및 데스크탑 애플리케이션 로그인에 사용할 수 있습니다.

가장 흥미로운 유형의 토큰은 Primary Refresh Token (PRT)입니다.

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### 피벗 기술

**손상된 머신에서 클라우드로**:

* [**Pass the Cookie**](az-pass-the-cookie.md): 브라우저에서 Azure 쿠키를 훔쳐 로그인
* [**Phishing Primary Refresh Token**](az-phishing-primary-refresh-token-microsoft-entra.md)**:** PRT를 피싱하여 악용
* [**Pass the PRT**](pass-the-prt.md): 장치 PRT를 훔쳐 Azure에 접근
* [**Pass the Certificate**](az-pass-the-certificate.md)**:** PRT를 기반으로 인증서를 생성하여 다른 머신에서 로그인

**AD를 손상시키는 것에서 클라우드를 손상시키는 것**과 **클라우드를 손상시키는 것에서 AD를 손상시키는 것**:

* [**Azure AD Connect**](azure-ad-connect-hybrid-identity/)
* **클라우드에서 온프레미스로 피벗하는 또 다른 방법은** [**Intune 악용**](../az-services/intune.md)

#### [Roadtx](https://github.com/dirkjanm/ROADtools)

이 도구는 Azure AD에 머신을 등록하여 PRT를 얻고, 여러 가지 방법으로 리소스에 접근하기 위해 PRT(정상 또는 도난)를 사용하는 등의 여러 작업을 수행할 수 있습니다. 이는 직접적인 공격이 아니지만, 다양한 방법으로 리소스에 접근하기 위해 PRT를 사용하는 것을 용이하게 합니다. 자세한 정보는 [https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)에서 확인하세요.

## 참고 자료

* [https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)

{% hint style="success" %}
AWS 해킹 학습 및 연습:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP 해킹 학습 및 연습: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원</summary>

* [**구독 플랜**](https://github.com/sponsors/carlospolop) 확인!
* **💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**telegram 그룹**](https://t.me/peass)에 가입하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우하세요.**
* **PR을 제출하여 해킹 트릭을 공유하세요:** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소.

</details>
{% endhint %}
