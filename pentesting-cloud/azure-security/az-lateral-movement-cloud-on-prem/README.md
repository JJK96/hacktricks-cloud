# Az - Lateral Movement (Cloud - On-Prem)

## Az - Lateral Movement (Cloud - On-Prem)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Maszyny On-Prem połączone z chmurą

Istnieją różne sposoby, w jakie maszyna może być połączona z chmurą:

#### Azure AD joined

<figure><img src="../../../.gitbook/assets/image (259).png" alt=""><figcaption></figcaption></figure>

#### Workplace joined

<figure><img src="../../../.gitbook/assets/image (222).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Hybrid joined

<figure><img src="../../../.gitbook/assets/image (178).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Workplace joined on AADJ or Hybrid

<figure><img src="../../../.gitbook/assets/image (252).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large</a></p></figcaption></figure>

### Tokeny i ograniczenia <a href="#tokens-and-limitations" id="tokens-and-limitations"></a>

W Azure AD istnieją różne typy tokenów z określonymi ograniczeniami:

* **Access tokens**: Używane do dostępu do API i zasobów, takich jak Microsoft Graph. Są powiązane z konkretnym klientem i zasobem.
* **Refresh tokens**: Wydawane aplikacjom w celu uzyskania nowych access tokens. Mogą być używane tylko przez aplikację, której zostały wydane, lub grupę aplikacji.
* **Primary Refresh Tokens (PRT)**: Używane do Single Sign-On na urządzeniach Azure AD joined, registered lub hybrid joined. Mogą być używane w przepływach logowania w przeglądarce oraz do logowania się do aplikacji mobilnych i desktopowych na urządzeniu.

Najbardziej interesującym typem tokena jest Primary Refresh Token (PRT).

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### Techniki pivotingu

Z **kompromitowanej maszyny do chmury**:

* [**Pass the Cookie**](az-pass-the-cookie.md): Kradzież ciasteczek Azure z przeglądarki i użycie ich do logowania
* [**Phishing Primary Refresh Token**](az-phishing-primary-refresh-token-microsoft-entra.md)**:** Phishing PRT w celu jego nadużycia
* [**Pass the PRT**](pass-the-prt.md): Kradzież PRT urządzenia w celu uzyskania dostępu do Azure, podszywając się pod nie.
* [**Pass the Certificate**](az-pass-the-certificate.md)**:** Generowanie certyfikatu na podstawie PRT w celu logowania się z jednej maszyny na drugą

Od kompromitacji **AD** do kompromitacji **chmury** i od kompromitacji **chmury** do kompromitacji **AD**:

* [**Azure AD Connect**](azure-ad-connect-hybrid-identity/)
* **Innym sposobem na pivoting z chmury do On-Prem jest** [**nadużycie Intune**](../az-services/intune.md)

#### [Roadtx](https://github.com/dirkjanm/ROADtools)

To narzędzie pozwala na wykonywanie różnych działań, takich jak rejestracja maszyny w Azure AD w celu uzyskania PRT oraz używanie PRT (legalnych lub skradzionych) do uzyskiwania dostępu do zasobów na różne sposoby. Nie są to bezpośrednie ataki, ale ułatwiają użycie PRT do uzyskiwania dostępu do zasobów na różne sposoby. Więcej informacji znajdziesz na [https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)

## Referencje

* [https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
