# Az - Lateral Movement (Cloud - On-Prem)

## Az - Lateral Movement (Cloud - On-Prem)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### On-Prem machines connected to cloud

There are different ways a machine can be connected to the cloud:

#### Azure AD joined

<figure><img src="../../../.gitbook/assets/image (259).png" alt=""><figcaption></figcaption></figure>

#### Workplace joined

<figure><img src="../../../.gitbook/assets/image (222).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Hybrid joined

<figure><img src="../../../.gitbook/assets/image (178).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Workplace joined on AADJ or Hybrid

<figure><img src="../../../.gitbook/assets/image (252).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large</a></p></figcaption></figure>

### Tokens and limitations <a href="#tokens-and-limitations" id="tokens-and-limitations"></a>

In Azure AD, there are different types of tokens with specific limitations:

* **Access tokens**: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ API —Ç–∞ —Ä–µ—Å—É—Ä—Å—ñ–≤, —Ç–∞–∫–∏—Ö —è–∫ Microsoft Graph. –í–æ–Ω–∏ –ø—Ä–∏–≤'—è–∑–∞–Ω—ñ –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞ —Ç–∞ —Ä–µ—Å—É—Ä—Å—É.
* **Refresh tokens**: –í–∏–¥–∞—é—Ç—å—Å—è –¥–æ–¥–∞—Ç–∫–∞–º –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö access tokens. –í–æ–Ω–∏ –º–æ–∂—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è –ª–∏—à–µ –¥–æ–¥–∞—Ç–∫–æ–º, —è–∫–æ–º—É –≤–æ–Ω–∏ –±—É–ª–∏ –≤–∏–¥–∞–Ω—ñ, –∞–±–æ –≥—Ä—É–ø–æ—é –¥–æ–¥–∞—Ç–∫—ñ–≤.
* **Primary Refresh Tokens (PRT)**: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è —î–¥–∏–Ω–æ–≥–æ –≤—Ö–æ–¥—É –Ω–∞ –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö, –ø—Ä–∏—î–¥–Ω–∞–Ω–∏—Ö –¥–æ Azure AD, –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏—Ö –∞–±–æ –≥—ñ–±—Ä–∏–¥–Ω–∏—Ö. –í–æ–Ω–∏ –º–æ–∂—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è –≤ –ø—Ä–æ—Ü–µ—Å–∞—Ö –≤—Ö–æ–¥—É —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä —Ç–∞ –¥–ª—è –≤—Ö–æ–¥—É –≤ –º–æ–±—ñ–ª—å–Ω—ñ —Ç–∞ –Ω–∞—Å—Ç—ñ–ª—å–Ω—ñ –¥–æ–¥–∞—Ç–∫–∏ –Ω–∞ –ø—Ä–∏—Å—Ç—Ä–æ—ó.
* **Windows Hello for Business keys (WHFB)**: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è –±–µ–∑–ø–∞—Ä–æ–ª—å–Ω–æ—ó –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è Primary Refresh Tokens.

–ù–∞–π—Ü—ñ–∫–∞–≤—ñ—à–∏–π —Ç–∏–ø —Ç–æ–∫–µ–Ω–∞ - —Ü–µ Primary Refresh Token (PRT).

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### Pivoting Techniques

From the **compromised machine to the cloud**:

* [**Pass the Cookie**](az-pass-the-cookie.md): –í–∫—Ä–∞—Å—Ç–∏ Azure cookies –∑ –±—Ä–∞—É–∑–µ—Ä–∞ —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ó—Ö –¥–ª—è –≤—Ö–æ–¥—É
* [**Dump processes access tokens**](az-processes-memory-access-token.md): –í–∏–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–∞–º'—è—Ç—å –ª–æ–∫–∞–ª—å–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤, —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∏—Ö –∑ —Ö–º–∞—Ä–æ—é (—è–∫ excel, Teams...) —Ç–∞ –∑–Ω–∞–π—Ç–∏ access tokens —É –≤—ñ–¥–∫—Ä–∏—Ç–æ–º—É —Ç–µ–∫—Å—Ç—ñ.
* [**Phishing Primary Refresh Token**](az-phishing-primary-refresh-token-microsoft-entra.md)**:** –§—ñ—à–∏–Ω–≥ PRT –¥–ª—è –π–æ–≥–æ –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è
* [**Pass the PRT**](pass-the-prt.md): –í–∫—Ä–∞—Å—Ç–∏ PRT –ø—Ä–∏—Å—Ç—Ä–æ—é –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ Azure, –≤–∏–¥–∞—é—á–∏ —Å–µ–±–µ –∑–∞ –Ω—å–æ–≥–æ.
* [**Pass the Certificate**](az-pass-the-certificate.md)**:** –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –Ω–∞ –æ—Å–Ω–æ–≤—ñ PRT –¥–ª—è –≤—Ö–æ–¥—É –∑ –æ–¥–Ω–æ–≥–æ –ø—Ä–∏—Å—Ç—Ä–æ—é –Ω–∞ —ñ–Ω—à–∏–π

From compromising **AD** to compromising the **Cloud** and from compromising the **Cloud to** compromising **AD**:

* [**Azure AD Connect**](azure-ad-connect-hybrid-identity/)
* **–Ü–Ω—à–∏–π —Å–ø–æ—Å—ñ–± –ø–µ—Ä–µ—Ö–æ–¥—É –∑ —Ö–º–∞—Ä–∏ –Ω–∞ On-Prem - —Ü–µ** [**–∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è Intune**](../az-services/intune.md)

#### [Roadtx](https://github.com/dirkjanm/ROADtools)

This tool allows to perform several actions like register a machine in Azure AD to obtain a PRT, and use PRTs (legit or stolen) to access resources in several different ways. These are not direct attacks, but it facilitates the use of PRTs to access resources in different ways. Find more info in [https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)

## References

* [https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
