# Az - 측면 이동 (클라우드 - 온프렘)

## Az - 측면 이동 (클라우드 - 온프렘)

{% hint style="success" %}
AWS 해킹 학습 및 실습:<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
GCP 해킹 학습 및 실습: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원</summary>

* [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) 깃헙 저장소에 PR을 제출하여 해킹 요령을 공유하세요.

</details>
{% endhint %}

### 클라우드에 연결된 온프렘 머신들

머신이 클라우드에 연결되는 다양한 방법이 있습니다:

#### Azure AD 가입

<figure><img src="../../../.gitbook/assets/image (259).png" alt=""><figcaption></figcaption></figure>

#### Workplace 가입

<figure><img src="../../../.gitbook/assets/image (222).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### 하이브리드 가입

<figure><img src="../../../.gitbook/assets/image (178).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### AADJ 또는 하이브리드에서 Workplace 가입

<figure><img src="../../../.gitbook/assets/image (252).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large</a></p></figcaption></figure>

### 토큰 및 제한 <a href="#tokens-and-limitations" id="tokens-and-limitations"></a>

Azure AD에서는 특정 제한이 있는 다양한 유형의 토큰이 있습니다:

* **액세스 토큰**: Microsoft Graph와 같은 API 및 리소스에 액세스하는 데 사용됩니다. 특정 클라이언트 및 리소스에 바인딩됩니다.
* **새로 고침 토큰**: 응용 프로그램에 새로운 액세스 토큰을 얻기 위해 발급됩니다. 발급된 응용 프로그램 또는 응용 프로그램 그룹에서만 사용할 수 있습니다.
* **기본 새로 고침 토큰 (PRT)**: Azure AD 가입, 등록 또는 하이브리드 가입 장치에서 단일 로그인에 사용됩니다. 브라우저 로그인 흐름 및 장치에서 모바일 및 데스크톱 응용 프로그램에 로그인하는 데 사용할 수 있습니다.
* **Windows Hello for Business 키 (WHFB)**: 무암호 인증에 사용됩니다. 기본 새로 고침 토큰을 얻는 데 사용됩니다.

가장 흥미로운 유형의 토큰은 기본 새로 고침 토큰 (PRT)입니다.

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### 피벗 기법

**감염된 머신에서 클라우드로**:

* [**쿠키 전달**](az-pass-the-cookie.md): 브라우저에서 Azure 쿠키를 도용하여 로그인에 사용
* **프로세스 액세스 토큰 덤프**: [**이 비디오**](https://www.youtube.com/watch?v=OHKZkXC4Duw)에서 설명한대로, 일부 Microsoft 소프트웨어(Excel, Teams 등)는 클라우드와 동기화되어 메모리에 액세스 토큰을 평문으로 저장할 수 있습니다. 따라서 프로세스의 메모리를 덤프하고 JWT 토큰을 검색하면 MFA를 우회하여 피해자의 여러 리소스에 액세스할 수 있습니다.
* [**피싱 기본 새로 고침 토큰**](az-phishing-primary-refresh-token-microsoft-entra.md)**:** PRT를 낚아채서 악용
* [**PRT 전달**](pass-the-prt.md): 장치 PRT를 도용하여 Azure에 접근
* [**인증서 전달**](az-pass-the-certificate.md)**:** PRT를 기반으로 인증서 생성하여 한 기기에서 다른 기기로 로그인

**AD**를 침해하여 **클라우드**를 침해하고 **클라우드**를 침해하여 **AD**를 침해하는 방법:

* [**Azure AD Connect**](azure-ad-connect-hybrid-identity/)
* **온프렘에서 클라우드로 피벗하는 또 다른 방법은** [**Intune 남용**](../az-services/intune.md)

#### [Roadtx](https://github.com/dirkjanm/ROADtools)

이 도구를 사용하면 Azure AD에서 기계를 등록하여 PRT를 얻고, PRT(합법적 또는 도난당한)를 사용하여 여러 가지 방법으로 리소스에 액세스할 수 있습니다. 이들은 직접적인 공격은 아니지만 PRT를 사용하여 다양한 방법으로 리소스에 액세스하는 것을 용이하게 합니다. 자세한 정보는 [https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)에서 확인하세요.

## 참고 자료

* [https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)
