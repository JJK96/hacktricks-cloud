# Az - Laterale Beweging (Wolk - Op-Prem)

## Az - Laterale Beweging (Wolk - Op-Prem)

{% hint style="success" %}
Leer & oefen AWS Hack: <img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Controleer de [**abonnementsplannen**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

### Op-Prem masjiene wat aan die wolk gekoppel is

Daar is verskillende maniere waarop 'n masjien aan die wolk gekoppel kan wees:

#### Azure AD gekoppel

<figure><img src="../../../.gitbook/assets/image (259).png" alt=""><figcaption></figcaption></figure>

#### Workplace gekoppel

<figure><img src="../../../.gitbook/assets/image (222).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Hibried gekoppel

<figure><img src="../../../.gitbook/assets/image (178).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Workplace gekoppel op AADJ of Hibried

<figure><img src="../../../.gitbook/assets/image (252).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large</a></p></figcaption></figure>

### Tokens en beperkings <a href="#tokens-and-limitations" id="tokens-and-limitations"></a>

In Azure AD is daar verskillende tipes tokens met spesifieke beperkings:

* **Toegangstokens**: Gebruik om API's en bronne soos die Microsoft Graph te benader. Hulle is gekoppel aan 'n spesifieke kli√´nt en bron.
* **Vernuwingsleutels**: Uitgereik aan aansoeke om nuwe toegangstokens te verkry. Hulle kan slegs deur die aansoek gebruik word waarvoor hulle uitgereik is of 'n groep aansoeke.
* **Prim√™re Vernuwingsleutels (PRT)**: Gebruik vir Enkel Aanmelding op toestelle wat by Azure AD aangesluit, geregistreer of hibried aangesluit is. Hulle kan gebruik word in aanmeldingsvloeie vir blaaier en vir aanmelding by mobiele en lessenaarprogramme op die toestel.
* **Windows Hello vir Besigheidsleutels (WHFB)**: Gebruik vir wagwoordlose verifikasie. Dit word gebruik om Prim√™re Vernuwingsleutels te verkry.

Die mees interessante tipe token is die Prim√™re Vernuwingsleutel (PRT).

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### Pivoteer Tegnieke

Van die **gekompromiteerde masjien na die wolk**:

* [**Stuur die Koekie**](az-pass-the-cookie.md): Steel Azure-koekies uit die blaaier en gebruik dit om aan te meld
* **Dump prosesse toegangstokens**: Soos verduidelik in [**hierdie video**](https://www.youtube.com/watch?v=OHKZkXC4Duw), mag sommige Microsoft-sagteware wat gesinkroniseer is met die wolk (Excel, Teams...) toegangstokens in teks in die geheue stoor. Dus, deur net die geheue van die proses te dump en te soek na JWT-tokens, kan jy toegang kry tot verskeie bronne van die slagoffer in die wolk deur MFA te omseil.
* [**Hengel na Prim√™re Vernuwingsleutel**](az-phishing-primary-refresh-token-microsoft-entra.md)**:** Hengel die PRT om dit te misbruik
* [**Stuur die PRT**](pass-the-prt.md): Steel die toestel PRT om Azure te benader deur dit te impersoneer.
* [**Stuur die Sertifikaat**](az-pass-the-certificate.md)**:** Skep 'n sertifikaat gebaseer op die PRT om van die een masjien na die ander aan te meld

Van die kompromittering van **AD** tot die kompromittering van die **Wolk** en van die kompromittering van die **Wolk** tot die kompromittering van **AD**:

* [**Azure AD Koppel**](azure-ad-connect-hybrid-identity/)
* **'n Ander manier om van die wolk na Op-Prem te pivoteer is** [**Intune misbruik**](../az-services/intune.md)

#### [Roadtx](https://github.com/dirkjanm/ROADtools)

Hierdie instrument maak dit moontlik om verskeie aksies uit te voer, soos die registreer van 'n masjien in Azure AD om 'n PRT te verkry, en die gebruik van PRT's (wettig of gesteel) om bronne op verskeie verskillende maniere te benader. Dit is nie direkte aanvalle nie, maar dit fasiliteer die gebruik van PRT's om bronne op verskillende maniere te benader. Vind meer inligting in [https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)

## Verwysings

* [https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)

{% hint style="success" %}
Leer & oefen AWS Hack: <img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Controleer die [**abonnementsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
