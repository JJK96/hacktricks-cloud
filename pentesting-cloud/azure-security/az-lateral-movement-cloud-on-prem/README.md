# Az - Laterale Bewegung (Cloud - On-Prem)

## Az - Laterale Bewegung (Cloud - On-Prem)

{% hint style="success" %}
Lernen Sie & √ºben Sie AWS-Hacking: <img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie & √ºben Sie GCP-Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositorys senden.

</details>
{% endhint %}

### On-Prem-Maschinen, die mit der Cloud verbunden sind

Es gibt verschiedene M√∂glichkeiten, wie eine Maschine mit der Cloud verbunden sein kann:

#### Azure AD beigetreten

<figure><img src="../../../.gitbook/assets/image (259).png" alt=""><figcaption></figcaption></figure>

#### Arbeitsplatz beigetreten

<figure><img src="../../../.gitbook/assets/image (222).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Hybrid beigetreten

<figure><img src="../../../.gitbook/assets/image (178).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Arbeitsplatz beigetreten auf AADJ oder Hybrid

<figure><img src="../../../.gitbook/assets/image (252).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large</a></p></figcaption></figure>

### Tokens und Einschr√§nkungen <a href="#tokens-and-limitations" id="tokens-and-limitations"></a>

In Azure AD gibt es verschiedene Arten von Tokens mit spezifischen Einschr√§nkungen:

* **Zugriffstoken**: Wird verwendet, um auf APIs und Ressourcen wie den Microsoft Graph zuzugreifen. Sie sind an einen bestimmten Client und eine bestimmte Ressource gebunden.
* **Aktualisierungstoken**: Wird an Anwendungen ausgegeben, um neue Zugriffstoken zu erhalten. Sie k√∂nnen nur von der Anwendung verwendet werden, f√ºr die sie ausgestellt wurden, oder von einer Gruppe von Anwendungen.
* **Prim√§re Aktualisierungstoken (PRT)**: Wird f√ºr die Single Sign-On auf Azure AD beigetretenen, registrierten oder hybrid beigetretenen Ger√§ten verwendet. Sie k√∂nnen in Browser-Anmeldeabl√§ufen und zum Anmelden bei mobilen und Desktop-Anwendungen auf dem Ger√§t verwendet werden.
* **Windows Hello for Business-Schl√ºssel (WHFB)**: Wird f√ºr die kennwortlose Authentifizierung verwendet. Es wird verwendet, um Prim√§re Aktualisierungstoken zu erhalten.

Der interessanteste Typ von Token ist das Prim√§re Aktualisierungstoken (PRT).

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### Pivoting-Techniken

Vom **kompromittierten Ger√§t zur Cloud**:

* [**Cookie weitergeben**](az-pass-the-cookie.md): Stehlen Sie Azure-Cookies aus dem Browser und verwenden Sie sie zum Einloggen
* **Zugriffstoken von Prozessen auslesen**: Wie in [**diesem Video**](https://www.youtube.com/watch?v=OHKZkXC4Duw) erkl√§rt, k√∂nnen einige Microsoft-Software (Excel, Teams usw.), die mit der Cloud synchronisiert ist, Zugriffstoken im Klartext im Speicher speichern. Das Dumpen des Speichers des Prozesses und das Suchen nach JWT-Token k√∂nnte Ihnen Zugriff auf mehrere Ressourcen des Opfers in der Cloud erm√∂glichen, indem Sie die MFA umgehen.
* [**Phishing des Prim√§ren Aktualisierungstokens**](az-phishing-primary-refresh-token-microsoft-entra.md)**:** Phish das PRT, um es zu missbrauchen
* [**PRT weitergeben**](pass-the-prt.md): Stehlen Sie das Ger√§te-PRT, um sich bei Azure zu authentifizieren.
* [**Zertifikat weitergeben**](az-pass-the-certificate.md)**:** Generieren Sie ein Zertifikat basierend auf dem PRT, um sich von einem Ger√§t auf ein anderes einzuloggen

Vom Kompromittieren von **AD** bis zum Kompromittieren der **Cloud** und vom Kompromittieren der **Cloud** bis zum Kompromittieren von **AD**:

* [**Azure AD Connect**](azure-ad-connect-hybrid-identity/)
* **Ein weiterer Weg, um vom Cloud zu On-Prem zu wechseln, besteht darin,** [**Intune zu missbrauchen**](../az-services/intune.md)

#### [Roadtx](https://github.com/dirkjanm/ROADtools)

Dieses Tool erm√∂glicht es, verschiedene Aktionen wie das Registrieren einer Maschine in Azure AD zur Erlangung eines PRT durchzuf√ºhren und PRTs (legitim oder gestohlen) auf verschiedene Arten zu verwenden, um auf Ressourcen zuzugreifen. Dies sind keine direkten Angriffe, aber es erleichtert die Verwendung von PRTs, um auf Ressourcen auf verschiedene Arten zuzugreifen. Weitere Informationen finden Sie unter [https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)

## Referenzen

* [https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)
