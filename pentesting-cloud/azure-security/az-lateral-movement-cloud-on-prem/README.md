# Az - Yanal Hareket (Bulut - On-Prem)

## Az - Yanal Hareket (Bulut - On-Prem)

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın: <img src="../../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR gönderin.

</details>
{% endhint %}

### On-Prem makinelerinin buluta bağlanması

Bir makinenin buluta bağlanabileceği farklı yollar vardır:

#### Azure AD katılımı

<figure><img src="../../../.gitbook/assets/image (259).png" alt=""><figcaption></figcaption></figure>

#### Workplace katılımı

<figure><img src="../../../.gitbook/assets/image (222).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Hibrit katılım

<figure><img src="../../../.gitbook/assets/image (178).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### AADJ veya Hibrit üzerinde Workplace katılımı

<figure><img src="../../../.gitbook/assets/image (252).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large</a></p></figcaption></figure>

### Tokenlar ve sınırlamalar <a href="#tokens-and-limitations" id="tokens-and-limitations"></a>

Azure AD'de belirli sınırlamalara sahip farklı türde tokenlar bulunmaktadır:

* **Erişim tokenları**: Microsoft Graph gibi API'lara ve kaynaklara erişmek için kullanılır. Belirli bir istemci ve kaynağa bağlıdır.
* **Yenileme tokenları**: Uygulamalara yeni erişim tokenları almak için verilir. Yalnızca verildikleri uygulama veya uygulama grubu tarafından kullanılabilirler.
* **Birincil Yenileme Tokenları (PRT)**: Azure AD'ye katılan, kayıtlı veya hibrit katılan cihazlarda Tek Oturum Açma için kullanılır. Tarayıcı oturum açma akışları ve cihazda mobil ve masaüstü uygulamalara giriş yapmak için kullanılabilirler.
* **Windows Hello for Business anahtarları (WHFB)**: Şifresiz kimlik doğrulaması için kullanılır. Birincil Yenileme Tokenları almak için kullanılır.

En ilginç token türü Birincil Yenileme Tokenu (PRT)'dir.

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### Yönlendirme Teknikleri

**Kompromize edilmiş makineden buluta**:

* [**Çerez Aktarımı**](az-pass-the-cookie.md): Azure çerezlerini tarayıcıdan çalın ve giriş yapmak için kullanın
* **İşlem erişim tokenlarını dökün**: Bazı Microsoft yazılımlarının (Excel, Teams...) bulutla senkronize olduğu açıklanan [**bu video**](https://www.youtube.com/watch?v=OHKZkXC4Duw)da, erişim tokenlarını bellekte düz metin olarak saklayabileceğini belirtir. Bu nedenle, sadece işlem belleğini dökerek ve JWT tokenlarını arayarak, MFA'yı atlayarak kurbanın bulutta birçok kaynağa erişim sağlayabilirsiniz.
* [**Phishing Birincil Yenileme Tokenu**](az-phishing-primary-refresh-token-microsoft-entra.md)**:** PRT'yi avlamak için
* [**PRT Aktarımı**](pass-the-prt.md): Cihaz PRT'sini çalarak onu taklit ederek Azure'a erişin.
* [**Sertifika Aktarımı**](az-pass-the-certificate.md)**:** Bir makineden diğerine giriş yapmak için PRT'ye dayalı bir sertifika oluşturun

**AD**'den **Bulut**'a ve **Bulut**'tan **AD**'ye kompromize etme:

* [**Azure AD Connect**](azure-ad-connect-hybrid-identity/)
* **Buluttan On-Prem'e yönlendirmenin başka bir yolu** [**Intune'yi kötüye kullanmak**](../az-services/intune.md)

#### [Roadtx](https://github.com/dirkjanm/ROADtools)

Bu araç, bir makineyi Azure AD'ye kaydetmek için PRT almak ve PRT'leri (meşru veya çalınmış) farklı yollarla erişim sağlamak için kullanır. Bunlar doğrudan saldırılar değildir, ancak PRT'lerin farklı yollarla erişim sağlamasını kolaylaştırır. Daha fazla bilgi için [https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)

## Referanslar

* [https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)
