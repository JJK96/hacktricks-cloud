# Az - Basic Information

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Organization Hierarchy

<figure><img src="../../.gitbook/assets/image (271).png" alt=""><figcaption></figcaption></figure>

### Management Groups

組織が**多くのAzureサブスクリプション**を持っている場合、それらの**サブスクリプション**の**アクセス管理**、ポリシー、およびコンプライアンスを効率的に管理する方法が必要です。**管理グループ**は、**サブスクリプションの上位にあるガバナンススコープ**を提供します。

1つのディレクトリで**10,000の管理グループ**をサポートでき、管理グループツリーは**最大6レベルの深さ**をサポートできることに注意してください。

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

[From the docs](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory): 各ディレクトリには、**ルート管理グループ**と呼ばれる単一の**トップレベル管理グループ**が与えられます。ルート管理グループは、**すべての管理グループとサブスクリプションがそれに折りたたまれる**ように階層に組み込まれています。このルート管理グループにより、**グローバルポリシーとAzureロールの割り当て**をディレクトリレベルで適用できます。[Azure AD **グローバル管理者**は自分自身を**ユーザーアクセス管理者ロール**に昇格させる必要があります](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin)。アクセスを昇格させた後、管理者は**他のディレクトリユーザーやグループに任意のAzureロールを割り当てて階層を管理**できます。管理者として、**自分のアカウントをルート管理グループの所有者として割り当てる**ことができます。

ルート管理グループは、他の管理グループとは異なり、**移動や削除ができません**。

管理グループは、どのタイプのサブスクリプションを持っていても、エンタープライズグレードの管理をスケールで提供します。ただし、**単一の管理グループ内のすべてのサブスクリプション**は、**同じAzure Active Directory (Azure AD) テナント**を信頼する必要があります。

<figure><img src="../../.gitbook/assets/image (157).png" alt=""><figcaption></figcaption></figure>

### Azure Subscriptions

Azureでは、サブスクリプションはビジネスまたは技術的な**リソースをプロビジョニング**するための**論理コンテナ**として機能します。このコンテナは、仮想マシン（VM）やデータベースなどの**リソースの詳細**を保持します。Azureリソース（例えばVM）を作成する際には、それに関連付けられた**サブスクリプション**を指定します。この構造により、ロールベースのアクセス制御メカニズムを使用してアクセスの委任が容易になります。

### Resource Groups

[From the docs:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) リソースグループは、Azureソリューションの**関連リソース**を保持する**コンテナ**です。リソースグループには、ソリューションのすべてのリソースを含めることも、**グループとして管理したいリソース**のみを含めることもできます。一般的に、**同じライフサイクル**を共有する**リソース**を同じリソースグループに追加することで、それらをグループとして簡単にデプロイ、更新、および削除できます。

すべての**リソース**は**リソースグループ内に**存在し、グループにのみ属することができ、リソースグループが削除されると、その中のすべてのリソースも削除されます。

### Administrative Units

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) 管理単位を使用すると、組織を**任意の単位**に**細分化**し、その単位の**メンバーのみを管理できる特定の管理者**を**割り当てる**ことができます。例えば、大規模な大学の各学校の管理者に権限を委任し、工学部内でのみアクセスを制御し、ユーザーを管理し、ポリシーを設定できるようにすることができます。

**ユーザー**、**グループ**、**デバイス**のみが**管理単位のメンバー**になることができます。

したがって、**管理単位**にはいくつかの**メンバー**が含まれ、他の**プリンシパル**がその管理単位に対して**権限を割り当てられ**、その権限を使用して管理単位のメンバーを管理できます。

## Azure vs Azure AD vs Azure AD Domain Services

**Azure AD**は**Azure**内のサービスであることに注意してください。**Azure**はMicrosoftの**クラウドプラットフォーム**であり、**Azure AD**はAzure内のエンタープライズ**アイデンティティサービス**です。\
さらに、**Azure ADはWindows Active Directoryのようなものではありません**。これは完全に異なる方法で動作するアイデンティティサービスです。Windows Active Directory環境の**ドメインコントローラーをAzureで実行**したい場合は、**Azure AD Domain Services**を使用する必要があります。

## Principals

Azureは異なるタイプのプリンシパルをサポートしています：

* **User**: アクセスするための資格情報を持つ通常の**人**。
* **Group**: 一緒に管理される**プリンシパルのグループ**。グループに付与された**権限**はその**メンバー**に**継承**されます。
* **Service Principal/Enterprise Applications**: これは**アプリケーション**、ホストされたサービス、およびAzureリソースにアクセスするための自動化ツールで使用するために作成された**アイデンティティ**です。このアクセスは、サービスプリンシパルに割り当てられたロールによって**制限**され、**どのリソースにアクセスできるか**およびどのレベルでアクセスできるかを制御できます。セキュリティ上の理由から、ユーザーアイデンティティでログインを許可するのではなく、**自動化ツールにはサービスプリンシパルを使用すること**が常に推奨されます。

**サービスプリンシパル**を作成する際には、**パスワード認証**または**証明書認証**のいずれかを選択できます。

* **パスワード**認証を選択した場合（デフォルト）、**生成されたパスワードを保存**してください。再度アクセスすることはできません。
* 証明書認証を選択した場合、**アプリケーションが秘密鍵にアクセスできる**ことを確認してください。
* **Managed Identity (Metadata Creds)**: Azure Active Directoryのマネージドアイデンティティは、アプリケーションのアイデンティティを**自動的に管理する**ためのソリューションを提供します。これらのアイデンティティは、Azure Active Directory（**Azure AD**）認証と互換性のあるリソースに接続するためにアプリケーションによって使用されます。マネージドアイデンティティを使用することで、アプリケーションは**Azure ADトークンを安全に取得**し、資格情報を直接扱う必要がなくなります。マネージドアイデンティティには2種類あります：
* **システム割り当て**。一部のAzureサービスでは、**サービスインスタンスに直接マネージドアイデンティティを有効にする**ことができます。システム割り当てマネージドアイデンティティを有効にすると、Azure ADにアイデンティティが作成されます。このアイデンティティは**そのサービスインスタンスのライフサイクルに結び付けられます**。**リソース**が**削除**されると、Azureは自動的に**アイデンティティを削除**します。設計上、そのAzureリソースのみがこのアイデンティティを使用してAzure ADからトークンを要求できます。
* **ユーザー割り当て**。スタンドアロンのAzureリソースとしてマネージドアイデンティティを作成することもできます。[ユーザー割り当てマネージドアイデンティティを作成](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal)し、Azureサービスの1つまたは**複数のインスタンス**（複数のリソース）に割り当てることができます。ユーザー割り当てマネージドアイデンティティの場合、**アイデンティティはそれを使用するリソースとは別に管理されます**。

## Roles & Permissions

**ロール**は**スコープ**に対して**プリンシパル**に**割り当てられます**： `principal -[HAS ROLE]->(scope)`

**グループに割り当てられたロール**は、そのグループの**メンバー**全員に**継承**されます。

ロールが割り当てられたスコープに応じて、**ロール**はスコープコンテナ内の**他のリソース**に**継承**されることがあります。例えば、ユーザーAが**サブスクリプションにロールを持っている**場合、そのユーザーは**サブスクリプション内のすべてのリソースグループ**および**リソースグループ内のすべてのリソース**にそのロールを持つことになります。

### **Classic Roles**

| **Owner**                     | <ul><li>すべてのリソースへのフルアクセス</li><li>他のユーザーのアクセスを管理できる</li></ul> | すべてのリソースタイプ |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Contributor**               | <ul><li>すべてのリソースへのフルアクセス</li><li>アクセスを管理できない</li></ul>              | すべてのリソースタイプ |
| **Reader**                    | • すべてのリソースを表示                                                                     | すべてのリソースタイプ |
| **User Access Administrator** | <ul><li>すべてのリソースを表示</li><li>他のユーザーのアクセスを管理できる</li></ul>           | すべてのリソースタイプ |

### Built-In roles

[From the docs: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azure role-based access control (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) には、**ユーザー、グループ、サービスプリンシパル、およびマネージドアイデンティティ**に**割り当てる**ことができるいくつかのAzureの**組み込みロール**があります。ロールの割り当ては、**Azureリソースへのアクセスを制御**する方法です。組み込みロールが組織の特定のニーズを満たさない場合は、独自の[**Azureカスタムロール**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)を作成できます。

**組み込み**ロールは、それが**意図されたリソース**にのみ適用されます。例えば、**Compute**リソースに対する**組み込みロール**の2つの例を確認してください：

| [Disk Backup Reader](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | ディスクバックアップを実行するためのバックアップボールトへの権限を提供します。      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Virtual Machine User Login](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | ポータルで仮想マシンを表示し、通常のユーザーとしてログインします。 | fb879df8-f326-4884-b1cf-06f3ad86be52 |

これらのロールは**論理コンテナ**（管理グループ、サブスクリプション、リソースグループなど）にも**割り当てることができ**、影響を受けるプリンシパルは**そのコンテナ内のリソースに対して**それらのロールを持つことになります。

* [**すべてのAzure組み込みロール**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)のリストはこちら。
* [**すべてのAzure AD組み込みロール**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference)のリストはこちら。

### Custom Roles

Azureはまた、ユーザーが必要とする権限を持つ[**カスタムロール**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)を作成することもできます。

### Permission Denied

* **プリンシパルがリソースに対して何らかのアクセスを持つためには**、（いかなる方法でも）**その権限を付与する明示的なロールが必要**です。
* 明示的な**拒否ロールの割り当ては**、権限を付与するロールよりも**優先されます**。

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### Global Administrator

グローバル管理者ロールを持つユーザーは、**ルート管理グループに対してユーザーアクセス管理者Azureロールに「昇格」する**能力を持っています。これは、グローバル管理者が**すべてのAzureサブスクリプションおよび管理グループのアクセスを管理できる**ことを意味します。\
この昇格は次のページの最後で行うことができます：[https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

### Azure Policies

Azureポリシーは、クラウドコンピューティングサービスであるMicrosoft Azureにおける**規則と規制のセット**であり、組織の標準を管理および強制し、スケールでのコンプライアンスを評価するのに役立ちます。これらのポリシーは、**Azureリソース**に対してさまざまな規則を強制し、それらのリソースが企業の標準およびサービスレ
