# Az - Basic Information

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Gerarchia dell'Organizzazione

<figure><img src="../../.gitbook/assets/image (271).png" alt=""><figcaption></figcaption></figure>

### Gruppi di Gestione

Se la tua organizzazione ha **molti abbonamenti Azure**, potresti aver bisogno di un modo efficiente per **gestire l'accesso**, le politiche e la conformit√† per quegli **abbonamenti**. I **gruppi di gestione** forniscono un **ambito di governance sopra gli abbonamenti**.

Nota che **10.000 gruppi di gestione** possono essere supportati in una singola directory e un albero di gruppi di gestione pu√≤ supportare **fino a sei livelli di profondit√†**.

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

[Dalla documentazione](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory): Ogni directory √® dotata di un singolo **gruppo di gestione di livello superiore chiamato gruppo di gestione radice**. Il gruppo di gestione radice √® integrato nella gerarchia per avere **tutti i gruppi di gestione e gli abbonamenti che si piegano ad esso**. Questo gruppo di gestione radice consente di applicare **politiche globali e assegnazioni di ruoli Azure** a livello di directory. L'[**Amministratore Globale di Azure AD** deve elevare se stesso](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin) al **ruolo di Amministratore dell'Accesso Utente di questo gruppo radice** inizialmente. Dopo aver elevato l'accesso, l'amministratore pu√≤ **assegnare qualsiasi ruolo Azure ad altri utenti o gruppi della directory per gestire la gerarchia**. Come amministratore, puoi assegnare **il tuo account come proprietario del gruppo di gestione radice**.

Il gruppo di gestione radice **non pu√≤ essere spostato o eliminato**, a differenza di altri gruppi di gestione.

I gruppi di gestione ti offrono una gestione di livello enterprise su larga scala, indipendentemente dal tipo di abbonamenti che potresti avere. Tuttavia, **tutti gli abbonamenti all'interno di un singolo gruppo di gestione** devono fidarsi dello **stesso tenant di Azure Active Directory (Azure AD)**.

<figure><img src="../../.gitbook/assets/image (157).png" alt=""><figcaption></figcaption></figure>

### Abbonamenti Azure

In Azure, un abbonamento serve come un **contenitore logico** per lo scopo di **fornire** risorse aziendali o tecniche. Questo contenitore mantiene i **dettagli delle risorse** come macchine virtuali (VM), database, tra gli altri. Alla creazione di una risorsa Azure, come una VM, viene specificato l'**abbonamento associato ad essa**. Questa struttura facilita la delega dell'accesso, utilizzando meccanismi di controllo degli accessi basati sui ruoli.

### Gruppi di Risorse

[Dalla documentazione:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Un gruppo di risorse √® un **contenitore** che contiene **risorse correlate** per una soluzione Azure. Il gruppo di risorse pu√≤ includere tutte le risorse per la soluzione, o solo quelle **risorse che vuoi gestire come un gruppo**. Generalmente, aggiungi **risorse** che condividono lo **stesso ciclo di vita** allo stesso gruppo di risorse in modo da poterle facilmente distribuire, aggiornare ed eliminare come un gruppo.

Tutte le **risorse** devono essere **all'interno di un gruppo di risorse** e possono appartenere solo a un gruppo e se un gruppo di risorse viene eliminato, tutte le risorse al suo interno vengono anch'esse eliminate.

### Unit√† Amministrative

[Dalla documentazione:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) Le unit√† amministrative ti permettono di **suddividere** la tua organizzazione in **qualsiasi unit√†** che desideri, e poi **assegnare amministratori specifici** che possono **gestire solo i membri** di quell'unit√†. Ad esempio, potresti usare le unit√† amministrative per delegare i permessi agli amministratori di ogni scuola in una grande universit√†, in modo che possano controllare l'accesso, gestire gli utenti e impostare politiche solo nella Scuola di Ingegneria.

Solo **utenti**, **gruppi** e **dispositivi** possono essere **membri** di un'**unit√† amministrativa**.

Pertanto, un'**unit√† amministrativa** conterr√† alcuni **membri** e altri **principali** saranno **assegnati permessi su quell'unit√† amministrativa** che possono usare per **gestire i membri** dell'unit√† amministrativa.

## Azure vs Azure AD vs Azure AD Domain Services

√à importante notare che **Azure AD** √® un servizio **all'interno** di **Azure**. **Azure** √® la **piattaforma cloud** di Microsoft mentre **Azure AD** √® un **servizio di identit√† aziendale** in Azure.\
Inoltre, **Azure AD non √® come Windows Active Directory**, √® un servizio di identit√† che funziona in modo completamente diverso. Se vuoi eseguire un **Domain Controller in Azure** per il tuo ambiente Windows Active Directory devi usare **Azure AD Domain Services**.

## Principali

Azure supporta diversi tipi di principali:

* **Utente**: Una **persona** regolare con credenziali per accedere.
* **Gruppo**: Un **gruppo di principali** gestiti insieme. I **permessi** concessi ai gruppi sono **ereditati** dai suoi **membri**.
* **Service Principal/Enterprise Applications**: √à un'**identit√†** creata per **uso** con **applicazioni**, servizi ospitati e strumenti automatizzati per accedere alle risorse Azure. Questo accesso √® **limitato dai ruoli assegnati** al service principal, dandoti controllo su **quali risorse possono essere accedute** e a quale livello. Per motivi di sicurezza, √® sempre raccomandato **usare service principal con strumenti automatizzati** piuttosto che permettere loro di accedere con un'identit√† utente.

Quando crei un **service principal** puoi scegliere tra **autenticazione con password** o **autenticazione con certificato**.

* Se scegli l'autenticazione con **password** (di default), **salva la password generata** poich√© non potrai pi√π accedervi.
* Se scegli l'autenticazione con certificato, assicurati che l'**applicazione avr√† accesso alla chiave privata**.
* **Managed Identity (Metadata Creds)**: Le identit√† gestite in Azure Active Directory offrono una soluzione per **gestire automaticamente l'identit√†** delle applicazioni. Queste identit√† sono usate dalle applicazioni per **connettersi** a **risorse** compatibili con l'autenticazione di Azure Active Directory (**Azure AD**). Utilizzando le identit√† gestite, le applicazioni possono **ottenere token Azure AD** senza la necessit√† di gestire direttamente le credenziali. Ci sono due tipi di identit√† gestite:
* **Assegnata dal sistema**. Alcuni servizi Azure ti permettono di **abilitare un'identit√† gestita direttamente su un'istanza di servizio**. Quando abiliti un'identit√† gestita assegnata dal sistema, viene creata un'identit√† in Azure AD. L'identit√† √® legata al **ciclo di vita di quell'istanza di servizio**. Quando la **risorsa** viene **eliminata**, Azure **elimina automaticamente** l'**identit√†** per te. Per design, solo quella risorsa Azure pu√≤ usare questa identit√† per richiedere token da Azure AD.
* **Assegnata dall'utente**. Puoi anche creare un'identit√† gestita come risorsa Azure autonoma. Puoi [creare un'identit√† gestita assegnata dall'utente](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal) e assegnarla a una o **pi√π istanze** di un servizio Azure (pi√π risorse). Per le identit√† gestite assegnate dall'utente, l'**identit√† √® gestita separatamente dalle risorse che la utilizzano**.

## Ruoli e Permessi

I **ruoli** sono **assegnati** ai **principali** su un **ambito**: `principal -[HAS ROLE]->(scope)`

I **ruoli** assegnati ai **gruppi** sono **ereditati** da tutti i **membri** del gruppo.

A seconda dell'ambito a cui √® stato assegnato il ruolo, il **ruolo** potrebbe essere **ereditato** da **altre risorse** all'interno del contenitore dell'ambito. Ad esempio, se un utente A ha un **ruolo sull'abbonamento**, avr√† quel **ruolo su tutti i gruppi di risorse** all'interno dell'abbonamento e su **tutte le risorse** all'interno del gruppo di risorse.

### **Ruoli Classici**

| **Proprietario**              | <ul><li>Accesso completo a tutte le risorse</li><li>Pu√≤ gestire l'accesso per altri utenti</li></ul> | Tutti i tipi di risorse |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Collaboratore**             | <ul><li>Accesso completo a tutte le risorse</li><li>Non pu√≤ gestire l'accesso</li></ul>              | Tutti i tipi di risorse |
| **Lettore**                   | ‚Ä¢ Visualizza tutte le risorse                                                                     | Tutti i tipi di risorse |
| **Amministratore Accesso Utente** | <ul><li>Visualizza tutte le risorse</li><li>Pu√≤ gestire l'accesso per altri utenti</li></ul>           | Tutti i tipi di risorse |

### Ruoli Integrati

[Dalla documentazione: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azure role-based access control (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) ha diversi **ruoli integrati di Azure** che puoi **assegnare** a **utenti, gruppi, service principal e identit√† gestite**. Le assegnazioni di ruoli sono il modo in cui controlli **l'accesso alle risorse Azure**. Se i ruoli integrati non soddisfano le esigenze specifiche della tua organizzazione, puoi creare i tuoi [**ruoli personalizzati di Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

I **ruoli integrati** si applicano solo alle **risorse** per cui sono **destinati**, ad esempio controlla questi 2 esempi di **ruoli integrati su risorse Compute**:

| [Disk Backup Reader](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Fornisce il permesso al vault di backup per eseguire il backup del disco.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Virtual Machine User Login](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Visualizza le macchine virtuali nel portale e accedi come utente regolare. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Questi ruoli possono **anche essere assegnati su contenitori logici** (come gruppi di gestione, abbonamenti e gruppi di risorse) e i principali interessati li avranno **sulle risorse all'interno di quei contenitori**.

* Trova qui un elenco con [**tutti i ruoli integrati di Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Trova qui un elenco con [**tutti i ruoli integrati di Azure AD**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Ruoli Personalizzati

Azure consente anche di creare [**ruoli personalizzati**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) con i permessi necessari all'utente.

### Permesso Negato

* Affinch√© un **principale abbia accesso a una risorsa**, ha bisogno di un ruolo esplicito che gli venga concesso (in qualsiasi modo) **concedendogli quel permesso**.
* Un'assegnazione di ruolo **negata esplicitamente ha la precedenza** sul ruolo che concede il permesso.

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### Amministratore Globale

Gli utenti con il ruolo di Amministratore Globale hanno la capacit√† di '**elevare' al ruolo di Amministratore dell'Accesso Utente di Azure al gruppo di gestione radice**. Questo significa che un Amministratore Globale sar√† in grado di gestire l'accesso **a tutti gli abbonamenti e gruppi di gestione di Azure.**\
Questa elevazione pu√≤ essere fatta alla fine della pagina: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

### Politiche Azure

Le politiche Azure sono un insieme di **regole e regolamenti in Microsoft Azure**, un servizio di cloud computing, che aiutano a gestire e far rispettare gli standard organizzativi e a valutare la conformit√† su larga scala. Queste politiche impongono diverse regole sulle tue **risorse Azure**, assicurando che quelle risorse rimangano conformi agli standard aziendali e agli accordi sul livello di servizio.

Le politiche Azure sono cruciali per la governance e la sicurezza del cloud, aiutando a garantire che le risorse siano utilizzate correttamente ed efficientemente, e che siano conformi alle normative esterne e alle politiche interne.\
Alcuni esempi:

1. **Garantire la Conformit√† con Specifiche Regioni Azure**: Questa politica garantisce che tutte le risorse siano distribuite in specifiche regioni Azure. Ad esempio, un'azienda potrebbe voler garantire che tutti i suoi dati siano archiviati in Europa per la conformit√† al GDPR.
2. **Imporre Standard di Nomenclatura**: Le politiche possono imporre convenzioni di denominazione per le risorse Azure. Questo aiuta a organizzare e identificare facilmente le risorse in base ai loro nomi, il che √® utile in ambienti di grandi dimensioni.
3. **Limitare Certi Tipi di Risorse**: Questa politica pu√≤ limitare la creazione di certi tipi di risorse. Ad esempio, una politica potrebbe essere impostata per prevenire la creazione di tipi di risorse costose, come certe dimensioni di VM, per controllare i costi.
4. **Imporre Politiche di Tagging**: I tag sono coppie chiave-valore associate alle risorse Azure utilizzate per la gestione delle risorse. Le politiche possono imporre che certi tag debbano essere presenti, o avere valori specifici, per tutte le risorse. Questo √® utile per il tracciamento dei costi, la propriet√† o la categorizzazione delle risorse.
5. **Limitare l'Accesso Pubblico alle Risorse**: Le politiche possono imporre che certe risorse, come account di archiviazione o database, non abbiano endpoint pubblici, garantendo che siano accessibili solo all'interno della rete dell'organizzazione.
6. **Applicare Automaticamente Impostazioni di Sicurezza**: Le politiche possono essere utilizzate per applicare automaticamente impostazioni di sicurezza alle risorse, come applicare un gruppo di sicurezza di rete specifico a tutte le VM o garantire che tutti gli account di archiviazione utilizzino la crittografia.

Nota che le politiche Azure possono essere associate a qualsiasi livello della gerarchia Azure, ma sono **comunemente utilizzate nel gruppo di gestione radice** o in altri gruppi di gestione.

### Ambito dei Permessi

In Azure **i permessi possono essere assegnati a qualsiasi parte della gerarchia**. Questo include gruppi di gestione, abbonamenti, gruppi di risorse e risorse individual
