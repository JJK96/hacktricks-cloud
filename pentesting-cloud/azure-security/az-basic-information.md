# Az - Basic Information

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Organisationshierarchie

<figure><img src="../../.gitbook/assets/image (271).png" alt=""><figcaption></figcaption></figure>

### Management-Gruppen

Wenn Ihre Organisation **viele Azure-Abonnements** hat, ben√∂tigen Sie m√∂glicherweise eine M√∂glichkeit, **Zugriff**, Richtlinien und Compliance f√ºr diese **Abonnements** effizient zu **verwalten**. **Management-Gruppen** bieten einen **Governance-Bereich √ºber Abonnements**.

Beachten Sie, dass **10.000 Management-Gruppen** in einem einzigen Verzeichnis unterst√ºtzt werden k√∂nnen und ein Management-Gruppenbaum **bis zu sechs Ebenen tief** sein kann.

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

[Aus den Dokumenten](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory): Jedem Verzeichnis wird eine einzelne **Top-Level-Management-Gruppe namens Root**-Management-Gruppe zugewiesen. Die Root-Management-Gruppe ist in die Hierarchie eingebaut, sodass **alle Management-Gruppen und Abonnements ihr untergeordnet sind**. Diese Root-Management-Gruppe erm√∂glicht es, **globale Richtlinien und Azure-Rollen** auf Verzeichnisebene anzuwenden. Der [Azure AD **Global Administrator** muss sich selbst erh√∂hen](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin) auf die **User Access Administrator-Rolle dieser Root-Gruppe**. Nach der Erh√∂hung des Zugriffs kann der Administrator **jede Azure-Rolle anderen Verzeichnisbenutzern oder -gruppen zuweisen, um die Hierarchie zu verwalten**. Als Administrator k√∂nnen Sie **Ihr eigenes Konto als Eigent√ºmer der Root-Management-Gruppe** zuweisen.

Die Root-Management-Gruppe **kann nicht verschoben oder gel√∂scht** werden, im Gegensatz zu anderen Management-Gruppen.

Management-Gruppen bieten Ihnen ein Management auf Unternehmensebene, unabh√§ngig davon, welche Art von Abonnements Sie haben. Allerdings m√ºssen **alle Abonnements innerhalb einer einzigen Management-Gruppe** dem **gleichen Azure Active Directory (Azure AD) Mandanten** vertrauen.

<figure><img src="../../.gitbook/assets/image (157).png" alt=""><figcaption></figcaption></figure>

### Azure-Abonnements

In Azure dient ein Abonnement als **logischer Container** zum **Bereitstellen** von gesch√§ftlichen oder technischen **Ressourcen**. Dieser Container verwaltet die **Details der Ressourcen** wie virtuelle Maschinen (VMs), Datenbanken und andere. Bei der Erstellung einer Azure-Ressource, wie einer VM, wird das **damit verbundene Abonnement** angegeben. Diese Struktur erleichtert die Delegation des Zugriffs unter Verwendung von rollenbasierten Zugriffskontrollmechanismen.

### Ressourcengruppen

[Aus den Dokumenten:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Eine Ressourcengruppe ist ein **Container**, der **zusammenh√§ngende Ressourcen** f√ºr eine Azure-L√∂sung enth√§lt. Die Ressourcengruppe kann alle Ressourcen f√ºr die L√∂sung enthalten oder nur diejenigen **Ressourcen, die Sie als Gruppe verwalten m√∂chten**. Im Allgemeinen f√ºgen Sie **Ressourcen**, die den **gleichen Lebenszyklus** teilen, derselben Ressourcengruppe hinzu, damit Sie sie einfach als Gruppe bereitstellen, aktualisieren und l√∂schen k√∂nnen.

Alle **Ressourcen** m√ºssen **innerhalb einer Ressourcengruppe** sein und k√∂nnen nur zu einer Gruppe geh√∂ren. Wenn eine Ressourcengruppe gel√∂scht wird, werden auch alle darin enthaltenen Ressourcen gel√∂scht.

### Verwaltungseinheiten

[Aus den Dokumenten:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) Verwaltungseinheiten erm√∂glichen es Ihnen, Ihre Organisation in **beliebige Einheiten** zu **unterteilen** und dann **spezifische Administratoren** zuzuweisen, die **nur die Mitglieder** dieser Einheit **verwalten** k√∂nnen. Zum Beispiel k√∂nnten Sie Verwaltungseinheiten verwenden, um Berechtigungen an Administratoren jeder Schule einer gro√üen Universit√§t zu delegieren, damit sie den Zugriff kontrollieren, Benutzer verwalten und Richtlinien nur in der Ingenieursschule festlegen k√∂nnen.

Nur **Benutzer**, **Gruppen** und **Ger√§te** k√∂nnen **Mitglieder** einer **Verwaltungseinheit** sein.

Daher wird eine **Verwaltungseinheit** einige **Mitglieder** enthalten und andere **Prinzipale** werden **Berechtigungen √ºber diese** Verwaltungseinheit **zugewiesen**, die sie verwenden k√∂nnen, um die Mitglieder der Verwaltungseinheit zu **verwalten**.

## Azure vs Azure AD vs Azure AD Domain Services

Es ist wichtig zu beachten, dass **Azure AD** ein Dienst **innerhalb** von **Azure** ist. **Azure** ist Microsofts **Cloud-Plattform**, w√§hrend **Azure AD** ein Unternehmens-**Identit√§tsdienst** in Azure ist.\
Dar√ºber hinaus ist **Azure AD nicht wie Windows Active Directory**, es ist ein Identit√§tsdienst, der auf v√∂llig andere Weise funktioniert. Wenn Sie einen **Dom√§nencontroller in Azure** f√ºr Ihre Windows Active Directory-Umgebung betreiben m√∂chten, m√ºssen Sie **Azure AD Domain Services** verwenden.

## Prinzipale

Azure unterst√ºtzt verschiedene Arten von Prinzipalen:

* **Benutzer**: Eine regul√§re **Person** mit Anmeldeinformationen f√ºr den Zugriff.
* **Gruppe**: Eine **Gruppe von Prinzipalen**, die zusammen verwaltet werden. **Berechtigungen**, die Gruppen gew√§hrt werden, werden von ihren **Mitgliedern** **geerbt**.
* **Service Principal/Enterprise Applications**: Es ist eine **Identit√§t**, die f√ºr **Anwendungen**, gehostete Dienste und automatisierte Tools erstellt wurde, um auf Azure-Ressourcen zuzugreifen. Dieser Zugriff ist **durch die zugewiesenen Rollen eingeschr√§nkt**, was Ihnen die Kontrolle dar√ºber gibt, **welche Ressourcen** auf **welcher Ebene** zugegriffen werden kann. Aus Sicherheitsgr√ºnden wird immer empfohlen, **Service Principals mit automatisierten Tools zu verwenden**, anstatt ihnen die Anmeldung mit einer Benutzeridentit√§t zu erlauben.

Beim Erstellen eines **Service Principals** k√∂nnen Sie zwischen **Passwortauthentifizierung** oder **Zertifikatsauthentifizierung** w√§hlen.

* Wenn Sie **Passwort**-Authentifizierung w√§hlen (standardm√§√üig), **speichern Sie das generierte Passwort**, da Sie sp√§ter keinen Zugriff mehr darauf haben.
* Wenn Sie Zertifikatsauthentifizierung w√§hlen, stellen Sie sicher, dass die **Anwendung Zugriff auf den privaten Schl√ºssel** hat.
* **Managed Identity (Metadata Creds)**: Verwaltete Identit√§ten in Azure Active Directory bieten eine L√∂sung f√ºr die **automatische Verwaltung der Identit√§t** von Anwendungen. Diese Identit√§ten werden von Anwendungen verwendet, um **Verbindungen** zu **ressourcen** herzustellen, die mit der Azure Active Directory (**Azure AD**) Authentifizierung kompatibel sind. Durch die Nutzung verwalteter Identit√§ten k√∂nnen Anwendungen **sichere Azure AD-Token** erhalten, ohne dass Anmeldeinformationen direkt verwaltet werden m√ºssen. Es gibt zwei Arten von verwalteten Identit√§ten:
* **Systemzugewiesen**. Einige Azure-Dienste erm√∂glichen es Ihnen, **eine verwaltete Identit√§t direkt auf einer Dienstinstanz zu aktivieren**. Wenn Sie eine systemzugewiesene verwaltete Identit√§t aktivieren, wird eine Identit√§t in Azure AD erstellt. Die Identit√§t ist an den **Lebenszyklus dieser Dienstinstanz** gebunden. Wenn die **Ressource** **gel√∂scht** wird, l√∂scht Azure die **Identit√§t** automatisch f√ºr Sie. Nur diese Azure-Ressource kann diese Identit√§t verwenden, um Token von Azure AD anzufordern.
* **Benutzerzugewiesen**. Sie k√∂nnen auch eine verwaltete Identit√§t als eigenst√§ndige Azure-Ressource erstellen. Sie k√∂nnen [eine benutzerzugewiesene verwaltete Identit√§t erstellen](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal) und sie einer oder **mehreren Instanzen** eines Azure-Dienstes (mehrere Ressourcen) zuweisen. F√ºr benutzerzugewiesene verwaltete Identit√§ten wird die **Identit√§t separat von den Ressourcen verwaltet, die sie verwenden**.

## Rollen & Berechtigungen

**Rollen** werden **Prinzipalen** auf einem **Scope** zugewiesen: `principal -[HAT ROLLE]->(scope)`

**Rollen**, die **Gruppen** zugewiesen werden, werden von allen **Mitgliedern** der Gruppe **geerbt**.

Je nach dem Scope, dem die Rolle zugewiesen wurde, kann die **Rolle** auf **andere Ressourcen** innerhalb des Scope-Containers **vererbt** werden. Zum Beispiel, wenn ein Benutzer A eine **Rolle auf dem Abonnement** hat, wird er diese **Rolle auf alle Ressourcengruppen** innerhalb des Abonnements und auf **alle Ressourcen** innerhalb der Ressourcengruppe haben.

### **Klassische Rollen**

| **Besitzer**                  | <ul><li>Vollzugriff auf alle Ressourcen</li><li>Kann den Zugriff f√ºr andere Benutzer verwalten</li></ul> | Alle Ressourcentypen |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Mitwirkender**              | <ul><li>Vollzugriff auf alle Ressourcen</li><li>Kann den Zugriff nicht verwalten</li></ul>              | Alle Ressourcentypen |
| **Leser**                     | ‚Ä¢ Alle Ressourcen anzeigen                                                                     | Alle Ressourcentypen |
| **Benutzerzugriffsadministrator** | <ul><li>Alle Ressourcen anzeigen</li><li>Kann den Zugriff f√ºr andere Benutzer verwalten</li></ul>           | Alle Ressourcentypen |

### Eingebaute Rollen

[Aus den Dokumenten: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azure role-based access control (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) hat mehrere Azure **eingebaute Rollen**, die Sie **Benutzern, Gruppen, Service Principals und verwalteten Identit√§ten** zuweisen k√∂nnen. Rollenzuweisungen sind der Weg, wie Sie **den Zugriff auf Azure-Ressourcen** steuern. Wenn die eingebauten Rollen nicht den spezifischen Anforderungen Ihrer Organisation entsprechen, k√∂nnen Sie Ihre eigenen [**Azure benutzerdefinierten Rollen**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) erstellen.

**Eingebaute** Rollen gelten nur f√ºr die **Ressourcen**, f√ºr die sie **vorgesehen** sind, zum Beispiel sehen Sie hier zwei Beispiele f√ºr **eingebaute Rollen √ºber Compute**-Ressourcen:

| [Disk Backup Reader](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Bietet Berechtigung f√ºr das Backup-Tresor, um eine Datentr√§ger-Sicherung durchzuf√ºhren.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Virtual Machine User Login](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Virtuelle Maschinen im Portal anzeigen und sich als regul√§rer Benutzer anmelden. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Diese Rollen k√∂nnen **auch √ºber logische Container** (wie Management-Gruppen, Abonnements und Ressourcengruppen) zugewiesen werden und die betroffenen Prinzipale werden sie **√ºber die Ressourcen innerhalb dieser Container** haben.

* Hier finden Sie eine Liste mit [**allen Azure eingebauten Rollen**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Hier finden Sie eine Liste mit [**allen Azure AD eingebauten Rollen**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Benutzerdefinierte Rollen

Azure erm√∂glicht es auch, [**benutzerdefinierte Rollen**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) mit den ben√∂tigten Berechtigungen zu erstellen.

### Berechtigung verweigert

* Damit ein **Prinzipal Zugriff auf eine Ressource** hat, ben√∂tigt er eine explizite Rolle, die ihm (irgendwie) **diese Berechtigung gew√§hrt**.
* Eine explizite **Verweigerung der Rollenzuweisung hat Vorrang** vor der Rolle, die die Berechtigung gew√§hrt.

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### Globaler Administrator

Benutzer mit der Rolle des Globalen Administrators haben die M√∂glichkeit, sich auf die **User Access Administrator Azure-Rolle der Root-Management-Gruppe zu 'erh√∂hen'**. Dies bedeutet, dass ein Globaler Administrator in der Lage sein wird, den Zugriff **auf alle Azure-Abonnements und Management-Gruppen zu verwalten.**\
Diese Erh√∂hung kann am Ende der Seite durchgef√ºhrt werden: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

### Azure-Richtlinien

Azure-Richtlinien sind eine Reihe von **Regeln und Vorschriften in Microsoft Azure**, einem Cloud-Computing-Dienst, die helfen, organisatorische Standards zu verwalten und die Einhaltung in gro√üem Ma√üstab zu bewerten. Diese Richtlinien erzwingen verschiedene Regeln √ºber Ihre **Azure-Ressourcen**, um sicherzustellen, dass diese Ressourcen den Unternehmensstandards und Service-Level-Vereinbarungen entsprechen.

Azure-Richtlinien sind entscheidend f√ºr die Cloud-Governance und -Sicherheit, da sie sicherstellen, dass Ressourcen ordnungsgem√§√ü und effizient genutzt werden und dass sie externen Vorschriften und internen Richtlinien entsprechen.\
Einige Beispiele:

1. **Sicherstellung der Einhaltung bestimmter Azure-Regionen**: Diese Richtlinie stellt sicher, dass alle Ressourcen in bestimmten Azure-Regionen bereitgestellt werden. Zum Beispiel k√∂nnte ein Unternehmen sicherstellen wollen, dass alle seine Daten in Europa gespeichert werden, um die GDPR-Compliance zu gew√§hrleisten.
2. **Durchsetzung von Namensstandards**: Richtlinien k√∂nnen Namenskonventionen f√ºr Azure-Ressourcen durchsetzen. Dies hilft bei der Organisation und einfachen Identifizierung von Ressourcen anhand ihrer Namen, was in gro√üen Umgebungen hilfreich ist.
3. **Einschr√§nkung bestimmter Ressourcentypen**: Diese Richtlinie kann die Erstellung bestimmter Ressourcentypen einschr√§nken. Zum Beispiel k√∂nnte eine Richtlinie festlegen, dass die Erstellung teurer Ressourcentypen, wie bestimmter VM-Gr√∂√üen, verhindert wird, um die Kosten zu kontrollieren.
4. **Durchsetzung von Tagging-Richtlinien**: Tags sind Schl√ºssel-Wert-Paare, die mit Azure-Ressourcen zur Ressourcenverwaltung verwendet werden. Richtlinien k√∂nnen durchsetzen, dass bestimmte Tags vorhanden sein m√ºssen oder bestimmte Werte haben m√ºssen, f√ºr alle Ressourcen. Dies ist n√ºtzlich f√ºr die Kostenverfolgung, den Besitz oder die Kategorisierung von Ressourcen.
5. **Einschr√§nkung des √∂ffentlichen Zugriffs auf Ressourcen**: Richtlinien k√∂nnen durchsetzen, dass bestimmte Ressourcen, wie Speicherkonten oder Datenbanken, keine √∂ffentlichen Endpunkte haben, um sicherzustellen, dass sie nur innerhalb des Netzwerks der Organisation zug√§nglich sind.
6. **Automatische Anwendung von Sicherheitseinstellungen**: Richtlinien k√∂nnen verwendet werden, um automatisch Sicherheitseinstellungen auf Ressourcen anzuwenden, wie das Anwenden einer bestimmten Netzwerksicherheitsgruppe auf alle VMs oder das Sicherstellen, dass alle Speicherkonten Verschl√ºsselung verwenden.

Beachten Sie, dass Azure-Richtlinien an jeder Ebene der Azure-Hierarchie angeh√§ngt werden k√∂nnen, aber sie werden **h√§ufig in der Root-Management-Gruppe** oder in anderen Management-Gruppen verwendet.

### Berechtigungsbereich

In Azure k√∂nnen **Berechtigungen an jedem Teil der Hierarchie zugewiesen werden**. Dazu geh√∂ren Management-Gruppen, Abonnements, Ressourcengruppen und einzelne Ressourcen. Berechtigungen werden von den **enthaltenen Ressourcen** der Entit√§t, der sie zugewiesen wurden, **geerbt**.

Diese hierarchische Struktur erm√∂glicht eine effiziente und skalierbare Verwaltung von Zugriffsberechtigungen.

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (rollenbasierte Zugriffskontrolle) ist das, was wir bereits in den vorherigen Abschnitten gesehen haben: **Zuweisung einer Rolle an einen Prinzipal, um ihm Zugriff** auf eine Ressource zu gew√§hren.\
In einigen F√§llen m√∂chten Sie jedoch m√∂glicherweise **feinere Zugriffsverwaltung** bereitstellen oder die Verwaltung von **hunderten** von Rollenz
