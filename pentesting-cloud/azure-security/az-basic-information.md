# Az - Basic Information

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Organization Hierarchy

<figure><img src="../../.gitbook/assets/image (271).png" alt=""><figcaption></figcaption></figure>

### Management Groups

Αν ο οργανισμός σας έχει **πολλές Azure συνδρομές**, μπορεί να χρειαστείτε έναν τρόπο για να διαχειριστείτε αποτελεσματικά την **πρόσβαση**, τις πολιτικές και τη συμμόρφωση για αυτές τις **συνδρομές**. Οι **ομάδες διαχείρισης** παρέχουν ένα **πλαίσιο διακυβέρνησης πάνω από τις συνδρομές**.

Σημειώστε ότι **10.000 ομάδες διαχείρισης** μπορούν να υποστηριχθούν σε έναν μόνο κατάλογο και ένα δέντρο ομάδων διαχείρισης μπορεί να υποστηρίξει **έως έξι επίπεδα βάθους**.

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

[Από τα έγγραφα](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory): Κάθε κατάλογος λαμβάνει μια **ομάδα διαχείρισης κορυφής που ονομάζεται root**. Η ομάδα διαχείρισης root είναι ενσωματωμένη στην ιεραρχία για να περιλαμβάνει **όλες τις ομάδες διαχείρισης και τις συνδρομές**. Αυτή η ομάδα διαχείρισης root επιτρέπει την εφαρμογή **παγκόσμιων πολιτικών και αναθέσεων ρόλων Azure** σε επίπεδο καταλόγου. Ο [Azure AD **Global Administrator** πρέπει να ανυψώσει τον εαυτό του](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin) στον **ρόλο User Access Administrator αυτής της ομάδας root** αρχικά. Μετά την ανύψωση της πρόσβασης, ο διαχειριστής μπορεί να **αναθέσει οποιονδήποτε ρόλο Azure σε άλλους χρήστες ή ομάδες του καταλόγου για να διαχειριστούν την ιεραρχία**. Ως διαχειριστής, μπορείτε να αναθέσετε **τον δικό σας λογαριασμό ως ιδιοκτήτη της ομάδας διαχείρισης root**.

Η ομάδα διαχείρισης root **δεν μπορεί να μετακινηθεί ή να διαγραφεί**, σε αντίθεση με άλλες ομάδες διαχείρισης.

Οι ομάδες διαχείρισης σας παρέχουν διαχείριση σε επίπεδο επιχείρησης ανεξάρτητα από τον τύπο των συνδρομών που μπορεί να έχετε. Ωστόσο, **όλες οι συνδρομές μέσα σε μια μόνο ομάδα διαχείρισης** πρέπει να εμπιστεύονται τον **ίδιο Azure Active Directory (Azure AD) tenant**.

<figure><img src="../../.gitbook/assets/image (157).png" alt=""><figcaption></figcaption></figure>

### Azure Subscriptions

Στο Azure, μια συνδρομή λειτουργεί ως **λογικό δοχείο** για τον σκοπό της **παροχής** επιχειρηματικών ή τεχνικών **πόρων**. Αυτό το δοχείο διατηρεί τις **λεπτομέρειες των πόρων** όπως εικονικές μηχανές (VMs), βάσεις δεδομένων, μεταξύ άλλων. Κατά τη δημιουργία ενός πόρου Azure, όπως μια VM, η **συνδρομή που σχετίζεται με αυτόν** καθορίζεται. Αυτή η δομή διευκολύνει την ανάθεση πρόσβασης, χρησιμοποιώντας μηχανισμούς ελέγχου πρόσβασης βάσει ρόλων.

### Resource Groups

[Από τα έγγραφα:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Μια ομάδα πόρων είναι ένα **δοχείο** που περιέχει **σχετικούς πόρους** για μια λύση Azure. Η ομάδα πόρων μπορεί να περιλαμβάνει όλους τους πόρους για τη λύση ή μόνο εκείνους τους **πόρους που θέλετε να διαχειριστείτε ως ομάδα**. Γενικά, προσθέστε **πόρους** που μοιράζονται τον **ίδιο κύκλο ζωής** στην ίδια ομάδα πόρων ώστε να μπορείτε εύκολα να τους αναπτύξετε, να τους ενημερώσετε και να τους διαγράψετε ως ομάδα.

Όλοι οι **πόροι** πρέπει να είναι **μέσα σε μια ομάδα πόρων** και μπορούν να ανήκουν μόνο σε μια ομάδα και αν μια ομάδα πόρων διαγραφεί, όλοι οι πόροι μέσα σε αυτήν διαγράφονται επίσης.

### Administrative Units

[Από τα έγγραφα:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) Οι διοικητικές μονάδες σας επιτρέπουν να **υποδιαιρέσετε** τον οργανισμό σας σε **οποιαδήποτε μονάδα** θέλετε και στη συνέχεια να **αναθέσετε συγκεκριμένους διαχειριστές** που μπορούν να **διαχειρίζονται μόνο τα μέλη** αυτής της μονάδας. Για παράδειγμα, θα μπορούσατε να χρησιμοποιήσετε διοικητικές μονάδες για να αναθέσετε δικαιώματα σε διαχειριστές κάθε σχολής σε ένα μεγάλο πανεπιστήμιο, ώστε να μπορούν να ελέγχουν την πρόσβαση, να διαχειρίζονται χρήστες και να ορίζουν πολιτικές μόνο στη Σχολή Μηχανικών.

Μόνο **χρήστες**, **ομάδες** και **συσκευές** μπορούν να είναι **μέλη** μιας **διοικητικής μονάδας**.

Επομένως, μια **διοικητική μονάδα** θα **περιέχει** κάποια **μέλη** και άλλοι **principals** θα έχουν **ανατεθεί δικαιώματα πάνω σε αυτήν** τη διοικητική **μονάδα** που μπορούν να χρησιμοποιήσουν για να **διαχειριστούν τα μέλη** της διοικητικής μονάδας.

## Azure vs Azure AD vs Azure AD Domain Services

Είναι σημαντικό να σημειωθεί ότι το **Azure AD** είναι μια υπηρεσία **μέσα** στο **Azure**. Το **Azure** είναι η **πλατφόρμα cloud** της Microsoft ενώ το **Azure AD** είναι μια **υπηρεσία ταυτότητας** στο Azure.\
Επιπλέον, το **Azure AD δεν είναι όπως το Windows Active Directory**, είναι μια υπηρεσία ταυτότητας που λειτουργεί με εντελώς διαφορετικό τρόπο. Αν θέλετε να εκτελέσετε έναν **Domain Controller στο Azure** για το περιβάλλον Windows Active Directory σας, πρέπει να χρησιμοποιήσετε τις **Azure AD Domain Services**.

## Principals

Το Azure υποστηρίζει διαφορετικούς τύπους principals:

* **User**: Ένα κανονικό **άτομο** με διαπιστευτήρια για πρόσβαση.
* **Group**: Μια **ομάδα principals** που διαχειρίζεται μαζί. Τα **δικαιώματα** που χορηγούνται στις ομάδες **κληρονομούνται** από τα **μέλη** τους.
* **Service Principal/Enterprise Applications**: Είναι μια **ταυτότητα** που δημιουργείται για **χρήση** με **εφαρμογές**, φιλοξενούμενες υπηρεσίες και αυτοματοποιημένα εργαλεία για πρόσβαση σε πόρους Azure. Αυτή η πρόσβαση είναι **περιορισμένη από τους ρόλους που έχουν ανατεθεί** στον service principal, δίνοντάς σας έλεγχο **ποιοι πόροι μπορούν να προσπελαστούν** και σε ποιο επίπεδο. Για λόγους ασφαλείας, συνιστάται πάντα να **χρησιμοποιείτε service principals με αυτοματοποιημένα εργαλεία** αντί να τους επιτρέπετε να συνδεθούν με ταυτότητα χρήστη.

Όταν δημιουργείτε έναν **service principal** μπορείτε να επιλέξετε μεταξύ **password authentication** ή **certificate authentication**.

* Αν επιλέξετε **password** auth (προεπιλογή), **αποθηκεύστε τον κωδικό πρόσβασης που δημιουργήθηκε** καθώς δεν θα μπορείτε να τον προσπελάσετε ξανά.
* Αν επιλέξετε certificate authentication, βεβαιωθείτε ότι η **εφαρμογή θα έχει πρόσβαση στο ιδιωτικό κλειδί**.
* **Managed Identity (Metadata Creds)**: Οι διαχειριζόμενες ταυτότητες στο Azure Active Directory προσφέρουν μια λύση για **αυτόματη διαχείριση της ταυτότητας** των εφαρμογών. Αυτές οι ταυτότητες χρησιμοποιούνται από εφαρμογές για τον σκοπό της **σύνδεσης** με **πόρους** που είναι συμβατοί με την αυθεντικοποίηση Azure Active Directory (**Azure AD**). Χρησιμοποιώντας διαχειριζόμενες ταυτότητες, οι εφαρμογές μπορούν να **ασφαλίσουν tokens Azure AD** ενώ εξαλείφουν την ανάγκη να διαχειρίζονται διαπιστευτήρια απευθείας. Υπάρχουν δύο τύποι διαχειριζόμενων ταυτοτήτων:
* **System-assigned**. Ορισμένες υπηρεσίες Azure σας επιτρέπουν να **ενεργοποιήσετε μια διαχειριζόμενη ταυτότητα απευθείας σε μια υπηρεσία**. Όταν ενεργοποιείτε μια διαχειριζόμενη ταυτότητα που έχει ανατεθεί στο σύστημα, δημιουργείται μια ταυτότητα στο Azure AD. Η ταυτότητα συνδέεται με τον **κύκλο ζωής αυτής της υπηρεσίας**. Όταν ο **πόρος** **διαγράφεται**, το Azure **διαγράφει αυτόματα** την **ταυτότητα** για εσάς. Από σχεδιασμό, μόνο αυτός ο πόρος Azure μπορεί να χρησιμοποιήσει αυτήν την ταυτότητα για να ζητήσει tokens από το Azure AD.
* **User-assigned**. Μπορείτε επίσης να δημιουργήσετε μια διαχειριζόμενη ταυτότητα ως ανεξάρτητο πόρο Azure. Μπορείτε να [δημιουργήσετε μια διαχειριζόμενη ταυτότητα που έχει ανατεθεί από τον χρήστη](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal) και να την αναθέσετε σε μία ή **περισσότερες περιπτώσεις** μιας υπηρεσίας Azure (πολλαπλούς πόρους). Για τις διαχειριζόμενες ταυτότητες που έχουν ανατεθεί από τον χρήστη, η **ταυτότητα διαχειρίζεται ξεχωριστά από τους πόρους που τη χρησιμοποιούν**.

## Roles & Permissions

**Οι ρόλοι** **ανατίθενται** σε **principals** σε ένα **scope**: `principal -[HAS ROLE]->(scope)`

**Οι ρόλοι** που ανατίθενται σε **ομάδες** **κληρονομούνται** από όλα τα **μέλη** της ομάδας.

Ανάλογα με το scope στο οποίο ανατέθηκε ο ρόλος, ο **ρόλος** μπορεί να **κληρονομηθεί** σε **άλλους πόρους** μέσα στο δοχείο scope. Για παράδειγμα, αν ένας χρήστης Α έχει έναν **ρόλο στη συνδρομή**, θα έχει αυτόν τον **ρόλο σε όλες τις ομάδες πόρων** μέσα στη συνδρομή και σε **όλους τους πόρους** μέσα στην ομάδα πόρων.

### **Classic Roles**

| **Owner**                     | <ul><li>Πλήρης πρόσβαση σε όλους τους πόρους</li><li>Μπορεί να διαχειριστεί την πρόσβαση για άλλους χρήστες</li></ul> | Όλοι οι τύποι πόρων |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Contributor**               | <ul><li>Πλήρης πρόσβαση σε όλους τους πόρους</li><li>Δεν μπορεί να διαχειριστεί την πρόσβαση</li></ul>              | Όλοι οι τύποι πόρων |
| **Reader**                    | • Προβολή όλων των πόρων                                                                     | Όλοι οι τύποι πόρων |
| **User Access Administrator** | <ul><li>Προβολή όλων των πόρων</li><li>Μπορεί να διαχειριστεί την πρόσβαση για άλλους χρήστες</li></ul>           | Όλοι οι τύποι πόρων |

### Built-In roles

[Από τα έγγραφα: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Το Azure role-based access control (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) έχει αρκετούς **ενσωματωμένους ρόλους Azure** που μπορείτε να **αναθέσετε** σε **χρήστες, ομάδες, service principals και διαχειριζόμενες ταυτότητες**. Οι αναθέσεις ρόλων είναι ο τρόπος με τον οποίο ελέγχετε την **πρόσβαση σε πόρους Azure**. Αν οι ενσωματωμένοι ρόλοι δεν καλύπτουν τις συγκεκριμένες ανάγκες του οργανισμού σας, μπορείτε να δημιουργήσετε τους δικούς σας [**προσαρμοσμένους ρόλους Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

**Οι ενσωματωμένοι** ρόλοι ισχύουν μόνο για τους **πόρους** για τους οποίους **προορίζονται**, για παράδειγμα δείτε αυτά τα 2 παραδείγματα **ενσωματωμένων ρόλων πάνω σε πόρους Compute**:

| [Disk Backup Reader](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Παρέχει άδεια στο backup vault για να εκτελέσει backup δίσκου.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Virtual Machine User Login](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Προβολή εικονικών μηχανών στο portal και σύνδεση ως κανονικός χρήστης. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Αυτοί οι ρόλοι μπορούν **επίσης να ανατεθούν πάνω σε λογικά δοχεία** (όπως ομάδες διαχείρισης, συνδρομές και ομάδες πόρων) και οι επηρεαζόμενοι principals θα τους έχουν **πάνω στους πόρους μέσα σε αυτά τα δοχεία**.

* Βρείτε εδώ μια λίστα με [**όλους τους ενσωματωμένους ρόλους Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Βρείτε εδώ μια λίστα με [**όλους τους ενσωματωμένους ρόλους Azure AD**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Custom Roles

Το Azure επιτρέπει επίσης τη δημιουργία [**προσαρμοσμένων ρόλων**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) με τα δικαιώματα που χρειάζεται ο χρήστης.

### Permission Denied

* Για να έχει ένας **principal κάποια πρόσβαση σε έναν πόρο** χρειάζεται μια ρητή ανάθεση ρόλου που του **χορηγεί αυτήν την άδεια**.
* Μια ρητή **ανάθεση ρόλου άρνησης υπερισχύει** της ανάθεσης ρόλου που χορηγεί την άδεια.

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### Global Administrator

Οι χρήστες με τον ρόλο Global Administrator έχουν τη δυνατότητα να '**ανυψωθούν' στον ρόλο User Access Administrator Azure στην ομάδα διαχείρισης root**. Αυτό σημαίνει ότι ένας Global Administrator θα μπορεί να διαχειρίζεται την πρόσβαση **σε όλες τις συνδρομές και τις ομάδες διαχείρισης Azure.**\
Αυτή η ανύψωση μπορεί να γίνει στο τέλος της σελίδας: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

### Azure Policies

Οι πολιτικές Azure είναι ένα σύνολο **κανόνων και
