# Az - Device Registration

{% hint style="success" %}
Jifunze na kufanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na kufanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}

## Taarifa za Msingi

Wakati kifaa kinajiunga na AzureAD, kitu kipya kinaumbwa katika AzureAD.

Wakati wa kusajili kifaa, **mtumiaji anaombwa kuingia na akaunti yake** (akiombwa MFA ikiwa inahitajika), kisha inaomba tokeni kwa huduma ya usajili wa kifaa na kisha inaomba uthibitisho wa mwisho.

Kisha, jozi mbili za funguo za RSA zinaundwa kwenye kifaa: **funguo ya kifaa** (**funguo ya umma**) ambayo inatumwa kwa **AzureAD** na **funguo ya usafiri** (**funguo ya faragha**) ambayo inahifadhiwa kwenye TPM ikiwa inawezekana.

Kisha, **kitu** kinaumbwa katika **AzureAD** (sio katika Intune) na AzureAD inarudisha kwa kifaa **cheti** kilichosainiwa nacho. Unaweza kuangalia kwamba **kifaa kimejiunga na AzureAD** na taarifa kuhusu **cheti** (kama kinalindwa na TPM).:
```bash
dsregcmd /status
```
Baada ya usajili wa kifaa, **Primary Refresh Token** huombwa na moduli ya LSASS CloudAP na kupewa kifaa. Pamoja na PRT pia hutolewa **ufunguo wa kikao uliosimbwa kwa njia ambayo ni kifaa pekee kinaweza kuusimbua** (kutumia ufunguo wa umma wa ufunguo wa usafirishaji) na **unahitajika kutumia PRT.**

Kwa maelezo zaidi kuhusu PRT angalia:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

**TPM** **hulinda** dhidi ya **uchimbaji** wa funguo kutoka kwa kifaa kilichozimwa (ikiwa kinalindwa na PIN) na kutoka kwa uchimbaji wa nyenzo za kibinafsi kutoka kwa safu ya OS.\
Lakini **hailindi** dhidi ya **kunusa** muunganisho wa kimwili kati ya TPM na CPU au **kutumia nyenzo za kriptografia** katika TPM wakati mfumo unafanya kazi kutoka kwa mchakato wenye haki za **SYSTEM**.

Ikiwa utaangalia ukurasa ufuatao utaona kwamba **kuiba PRT** kunaweza kutumika kufikia kama **mtumiaji**, ambayo ni nzuri kwa sababu **PRT iko kwenye vifaa**, kwa hivyo inaweza kuibwa kutoka kwao (au ikiwa haijaibwa inaweza kutumiwa vibaya kuzalisha funguo mpya za kusaini):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Kusajili kifaa na tokeni za SSO

Inawezekana kwa mshambulizi kuomba tokeni kwa huduma ya usajili wa kifaa cha Microsoft kutoka kwa kifaa kilichovunjwa na kukisajili:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Ambayo itakupa **cheti unachoweza kutumia kuomba PRTs siku zijazo**. Kwa hivyo kudumisha uthabiti na **kupita MFA** kwa sababu tokeni ya awali ya PRT iliyotumika kusajili kifaa kipya **tayari ilikuwa na ruhusa za MFA**.

{% hint style="success" %}
Kumbuka kwamba ili kufanya shambulio hili utahitaji ruhusa za **kusajili vifaa vipya**. Pia, kusajili kifaa haimaanishi kifaa kitaruhusiwa **kujiandikisha kwenye Intune**.
{% endhint %}

{% hint style="danger" %}
Shambulio hili lilirekebishwa mnamo Septemba 2021 kwani huwezi tena kusajili vifaa vipya kwa kutumia tokeni za SSO. Hata hivyo, bado inawezekana kusajili vifaa kwa njia halali (kuwa na jina la mtumiaji, nenosiri na MFA ikiwa inahitajika). Angalia: [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## Kubadilisha tiketi ya kifaa

Ilikuwa inawezekana **kuomba tiketi ya kifaa**, **kubadilisha** ya sasa ya kifaa, na wakati wa mchakato **kuiba PRT** (kwa hivyo hakuna haja ya kuiba kutoka kwa TPM. Kwa maelezo zaidi [**angalia mazungumzo haya**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Hata hivyo, hili lilirekebishwa.
{% endhint %}

## Kubadilisha ufunguo wa WHFB

[**Angalia slaidi asili hapa**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

Muhtasari wa shambulio:

* Inawezekana **kubadilisha** **ufunguo wa WHFB uliosajiliwa** kutoka kwa **kifaa** kupitia SSO
* Inashinda ulinzi wa TPM kwani ufunguo **unanaswa wakati wa kizazi** cha ufunguo mpya
* Hii pia inatoa **uthabiti**

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

Watumiaji wanaweza kubadilisha mali yao ya searchableDeviceKey kupitia Azure AD Graph, hata hivyo, mshambulizi anahitaji kuwa na kifaa kwenye tenant (kilichosajiliwa papo hapo au kuwa na cheti + ufunguo ulioporwa kutoka kwa kifaa halali) na tokeni halali ya ufikiaji kwa AAD Graph.

Kisha, inawezekana kuzalisha ufunguo mpya na:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
na kisha PATCH taarifa za searchableDeviceKey:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

Inawezekana kupata tokeni ya ufikiaji kutoka kwa mtumiaji kupitia **device code phishing** na kutumia hatua za awali **kuiba ufikiaji wake**. Kwa maelezo zaidi angalia:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## Marejeleo

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

{% hint style="success" %}
Jifunze & fanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & fanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
