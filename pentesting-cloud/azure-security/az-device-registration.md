# Az - Device Registration

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Grundlegende Informationen

Wenn ein Ger√§t AzureAD beitritt, wird ein neues Objekt in AzureAD erstellt.

Bei der Registrierung eines Ger√§ts wird der **Benutzer aufgefordert, sich mit seinem Konto anzumelden** (bei Bedarf mit MFA), dann werden Token f√ºr den Ger√§teregistrierungsdienst angefordert und schlie√ülich eine letzte Best√§tigungsaufforderung gestellt.

Dann werden im Ger√§t zwei RSA-Schl√ºsselpaaren generiert: Der **Ger√§teschl√ºssel** (**√∂ffentlicher** Schl√ºssel), der an **AzureAD** gesendet wird, und der **Transportschl√ºssel** (**privater** Schl√ºssel), der, wenn m√∂glich, im TPM gespeichert wird.

Dann wird das **Objekt** in **AzureAD** (nicht in Intune) generiert und AzureAD gibt dem Ger√§t ein von ihm signiertes **Zertifikat** zur√ºck. Du kannst √ºberpr√ºfen, dass das **Ger√§t AzureAD beigetreten** ist und Informationen √ºber das **Zertifikat** (wie ob es durch TPM gesch√ºtzt ist) einsehen.:
```bash
dsregcmd /status
```
Nach der Ger√§te-Registrierung wird ein **Primary Refresh Token** vom LSASS CloudAP-Modul angefordert und dem Ger√§t zugewiesen. Mit dem PRT wird auch der **Sitzungsschl√ºssel verschl√ºsselt geliefert, sodass nur das Ger√§t ihn entschl√ºsseln kann** (unter Verwendung des √∂ffentlichen Schl√ºssels des Transportschl√ºssels) und er wird **ben√∂tigt, um das PRT zu verwenden.**

F√ºr weitere Informationen dar√ºber, was ein PRT ist, siehe:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

Das **TPM** **sch√ºtzt** vor der **Extraktion** von Schl√ºsseln aus einem ausgeschalteten Ger√§t (wenn durch PIN gesch√ºtzt) und vor der Extraktion des privaten Materials aus der Betriebssystemschicht.\
Aber es **sch√ºtzt nicht** vor dem **Abh√∂ren** der physischen Verbindung zwischen dem TPM und der CPU oder der **Verwendung des kryptografischen Materials** im TPM, w√§hrend das System von einem Prozess mit **SYSTEM**-Rechten l√§uft.

Wenn du die folgende Seite √ºberpr√ºfst, wirst du sehen, dass das **Stehlen des PRT** verwendet werden kann, um wie der **Benutzer** zuzugreifen, was gro√üartig ist, weil das **PRT sich auf Ger√§ten befindet**, sodass es von ihnen gestohlen werden kann (oder wenn nicht gestohlen, missbraucht werden kann, um neue Signaturschl√ºssel zu generieren):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Registrierung eines Ger√§ts mit SSO-Tokens

Es w√§re m√∂glich, dass ein Angreifer ein Token f√ºr den Microsoft-Ger√§teregistrierungsdienst vom kompromittierten Ger√§t anfordert und es registriert:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Welches Ihnen ein **Zertifikat gibt, das Sie in Zukunft verwenden k√∂nnen, um PRTs anzufordern**. Dadurch wird Persistenz aufrechterhalten und **MFA umgangen**, da das urspr√ºngliche PRT-Token, das zur Registrierung des neuen Ger√§ts verwendet wurde, **bereits MFA-Berechtigungen erteilt hatte**.

{% hint style="success" %}
Beachten Sie, dass Sie f√ºr diesen Angriff Berechtigungen zum **Registrieren neuer Ger√§te** ben√∂tigen. Au√üerdem bedeutet die Registrierung eines Ger√§ts nicht, dass das Ger√§t **in Intune aufgenommen werden darf**.
{% endhint %}

{% hint style="danger" %}
Dieser Angriff wurde im September 2021 behoben, da Sie keine neuen Ger√§te mehr mit SSO-Tokens registrieren k√∂nnen. Es ist jedoch weiterhin m√∂glich, Ger√§te auf legitime Weise zu registrieren (mit Benutzername, Passwort und MFA, falls erforderlich). √úberpr√ºfen Sie: [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## √úberschreiben eines Ger√§tetickets

Es war m√∂glich, ein **Ger√§teticket anzufordern**, das aktuelle des Ger√§ts zu **√ºberschreiben** und w√§hrend des Ablaufs das **PRT zu stehlen** (es ist also nicht notwendig, es aus dem TPM zu stehlen). Weitere Informationen finden Sie in diesem [**Vortrag**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Dies wurde jedoch behoben.
{% endhint %}

## WHFB-Schl√ºssel √ºberschreiben

[**√úberpr√ºfen Sie hier die Originalfolien**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

Angriffszusammenfassung:

* Es ist m√∂glich, den **registrierten WHFB-Schl√ºssel** eines **Ger√§ts** √ºber SSO zu **√ºberschreiben**
* Es **umgeht den TPM-Schutz**, da der Schl√ºssel **w√§hrend der Generierung** des neuen Schl√ºssels **abgefangen** wird
* Dies bietet auch **Persistenz**

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

Benutzer k√∂nnen ihre eigene searchableDeviceKey-Eigenschaft √ºber den Azure AD Graph √§ndern, jedoch muss der Angreifer ein Ger√§t im Mandanten haben (registriert im Handumdrehen oder gestohlenes Zertifikat + Schl√ºssel von einem legitimen Ger√§t) und ein g√ºltiges Zugriffstoken f√ºr den AAD Graph.

Dann ist es m√∂glich, einen neuen Schl√ºssel zu generieren mit:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
und dann die Informationen des searchableDeviceKey PATCHen:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

Es ist m√∂glich, ein Zugriffstoken von einem Benutzer √ºber **device code phishing** zu erhalten und die vorherigen Schritte zu missbrauchen, um **seinen Zugriff zu stehlen**. Weitere Informationen finden Sie unter:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## Referenzen

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichen.

</details>
{% endhint %}
