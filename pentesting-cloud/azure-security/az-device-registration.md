# Az - Registracija Uređaja

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hacking trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne Informacije

Kada se uređaj pridruži AzureAD, kreira se novi objekat u AzureAD.

Prilikom registracije uređaja, **korisnik se traži da se prijavi sa svojim nalogom** (tražeći MFA ako je potrebno), zatim se traže tokeni za uslugu registracije uređaja i zatim se traži konačna potvrda.

Zatim se generišu dva RSA para ključeva u uređaju: **ključ uređaja** (**javni** ključ) koji se šalje **AzureAD** i **transportni** ključ (**privatni** ključ) koji se čuva u TPM ako je moguće.

Zatim se generiše **objekat** u **AzureAD** (ne u Intune) i AzureAD vraća uređaju **sertifikat** potpisan od strane njega. Možete proveriti da li je **uređaj pridružen AzureAD** i informacije o **sertifikatu** (kao što je da li je zaštićen TPM-om).
```bash
dsregcmd /status
```
Nakon registracije uređaja, **Primary Refresh Token** zahteva LSASS CloudAP modul i daje se uređaju. Sa PRT-om se takođe isporučuje **ključno sesije šifrovano tako da ga samo uređaj može dešifrovati** (koristeći javni ključ transportnog ključa) i **potrebno je koristiti PRT.**

Za više informacija o tome šta je PRT pogledajte:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

**TPM** **štiti** od **ekstrakcije** ključeva sa isključenog uređaja (ako je zaštićen PIN-om) i od ekstrakcije privatnog materijala sa OS sloja.\
Ali **ne štiti** od **prisluškivanja** fizičke veze između TPM-a i CPU-a ili **korišćenja kriptografskog materijala** u TPM-u dok sistem radi iz procesa sa **SYSTEM** pravima.

Ako pogledate sledeću stranicu, videćete da **krađa PRT-a** može biti korišćena za pristup kao **korisnik**, što je odlično jer se **PRT nalazi na uređajima**, tako da može biti ukraden sa njih (ili ako nije ukraden, zloupotrebljen za generisanje novih ključeva za potpisivanje):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Registracija uređaja sa SSO tokenima

Moguće je da napadač zatraži token za Microsoft uslugu registracije uređaja sa kompromitovanog uređaja i registruje ga:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Koji će vam dati **sertifikat koji možete koristiti za traženje PRT-ova u budućnosti**. Dakle, održavanje postojanosti i **zaobilaženje MFA** jer je originalni PRT token korišćen za registraciju novog uređaja **već imao dodeljene MFA dozvole**.

{% hint style="success" %}
Napomena da za izvođenje ovog napada trebate dozvole za **registraciju novih uređaja**. Takođe, registracija uređaja ne znači da će uređaj biti **dozvoljen za upis u Intune**.
{% endhint %}

{% hint style="danger" %}
Ovaj napad je rešen u septembru 2021. jer više ne možete registrovati nove uređaje koristeći SSO tokene. Međutim, i dalje je moguće registrovati uređaje na legitiman način (imajući korisničko ime, lozinku i MFA ako je potrebno). Proverite: [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## Prepisivanje ticket-a uređaja

Bilo je moguće **zatražiti ticket uređaja**, **prepisati** trenutni na uređaju, i tokom toka **ukrasti PRT** (tako da nema potrebe da se krade iz TPM-a. Za više informacija [**pogledajte ovaj govor**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Međutim, ovo je rešeno.
{% endhint %}

## Prepisivanje WHFB ključa

[**Pogledajte originalne slajdove ovde**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

Sažetak napada:

* Moguće je **prepisati** **registrovani WHFB** ključ sa **uređaja** putem SSO
* To **pobeđuje TPM zaštitu** jer je ključ **presretnut tokom generisanja** novog ključa
* Ovo takođe pruža **postojanost**

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

Korisnici mogu modifikovati svoju sopstvenu searchableDeviceKey svojinu putem Azure AD Graph-a, međutim, napadač mora imati uređaj u tenant-u (registrovan na licu mesta ili sa ukradenim cert + ključem sa legitimnog uređaja) i važeći pristupni token za AAD Graph.

Zatim, moguće je generisati novi ključ sa:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
i zatim PATCH informacije o searchableDeviceKey:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

Moguće je dobiti pristupni token od korisnika putem **device code phishing** i zloupotrebiti prethodne korake da **ukradete njegov pristup**. Za više informacija pogledajte:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## Reference

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove podnošenjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
