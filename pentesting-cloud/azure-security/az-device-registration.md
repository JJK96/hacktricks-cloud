# Az - Device Registration

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Βασικές Πληροφορίες

Όταν μια συσκευή εντάσσεται στο AzureAD, δημιουργείται ένα νέο αντικείμενο στο AzureAD.

Κατά την εγγραφή μιας συσκευής, ο **χρήστης καλείται να συνδεθεί με τον λογαριασμό του** (ζητώντας MFA αν χρειάζεται), στη συνέχεια ζητάει tokens για την υπηρεσία εγγραφής συσκευής και μετά ζητάει μια τελική επιβεβαίωση.

Στη συνέχεια, δημιουργούνται δύο ζεύγη κλειδιών RSA στη συσκευή: Το **κλειδί συσκευής** (**δημόσιο** κλειδί) που αποστέλλεται στο **AzureAD** και το **κλειδί μεταφοράς** (**ιδιωτικό** κλειδί) που αποθηκεύεται στο TPM αν είναι δυνατόν.

Στη συνέχεια, το **αντικείμενο** δημιουργείται στο **AzureAD** (όχι στο Intune) και το AzureAD επιστρέφει στη συσκευή ένα **πιστοποιητικό** υπογεγραμμένο από αυτό. Μπορείτε να ελέγξετε ότι η **συσκευή είναι ενταγμένη στο AzureAD** και πληροφορίες για το **πιστοποιητικό** (όπως αν προστατεύεται από το TPM).
```bash
dsregcmd /status
```
Μετά την εγγραφή της συσκευής, ένα **Primary Refresh Token** ζητείται από το LSASS CloudAP module και δίνεται στη συσκευή. Με το PRT παραδίδεται επίσης το **κλειδί συνεδρίας κρυπτογραφημένο ώστε μόνο η συσκευή να μπορεί να το αποκρυπτογραφήσει** (χρησιμοποιώντας το δημόσιο κλειδί του κλειδιού μεταφοράς) και είναι **απαραίτητο για τη χρήση του PRT.**

Για περισσότερες πληροφορίες σχετικά με το τι είναι ένα PRT, ελέγξτε:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

Το **TPM** **προστατεύει** από την **εξαγωγή** κλειδιών από μια απενεργοποιημένη συσκευή (αν προστατεύεται από PIN) και από την εξαγωγή του ιδιωτικού υλικού από το επίπεδο του λειτουργικού συστήματος.\
Αλλά **δεν προστατεύει** από την **παρακολούθηση** της φυσικής σύνδεσης μεταξύ του TPM και της CPU ή από τη **χρήση του κρυπτογραφικού υλικού** στο TPM ενώ το σύστημα λειτουργεί από μια διαδικασία με δικαιώματα **SYSTEM**.

Αν ελέγξετε την ακόλουθη σελίδα, θα δείτε ότι η **κλοπή του PRT** μπορεί να χρησιμοποιηθεί για πρόσβαση όπως ο **χρήστης**, κάτι που είναι εξαιρετικό επειδή το **PRT βρίσκεται στις συσκευές**, οπότε μπορεί να κλαπεί από αυτές (ή αν δεν κλαπεί, να καταχραστεί για τη δημιουργία νέων κλειδιών υπογραφής):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Εγγραφή μιας συσκευής με SSO tokens

Θα ήταν δυνατό για έναν επιτιθέμενο να ζητήσει ένα token για την υπηρεσία εγγραφής συσκευών της Microsoft από τη συμβιβασμένη συσκευή και να την εγγράψει:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Which will give you a **certificate you can use to ask for PRTs in the future**. Therefore maintaining persistence and **bypassing MFA** because the original PRT token used to register the new device **already had MFA permissions granted**.

{% hint style="success" %}
Σημειώστε ότι για να εκτελέσετε αυτήν την επίθεση θα χρειαστείτε δικαιώματα για **εγγραφή νέων συσκευών**. Επίσης, η εγγραφή μιας συσκευής δεν σημαίνει ότι η συσκευή θα είναι **επιτρεπτή για εγγραφή στο Intune**.
{% endhint %}

{% hint style="danger" %}
Αυτή η επίθεση διορθώθηκε τον Σεπτέμβριο του 2021 καθώς δεν μπορείτε πλέον να εγγράψετε νέες συσκευές χρησιμοποιώντας SSO tokens. Ωστόσο, είναι ακόμα δυνατό να εγγράψετε συσκευές με νόμιμο τρόπο (έχοντας όνομα χρήστη, κωδικό πρόσβασης και MFA αν χρειάζεται). Ελέγξτε: [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## Overwriting a device ticket

Ήταν δυνατό να **ζητήσετε ένα device ticket**, **να αντικαταστήσετε** το τρέχον της συσκευής και κατά τη διάρκεια της διαδικασίας να **κλέψετε το PRT** (οπότε δεν χρειάζεται να το κλέψετε από το TPM. Για περισσότερες πληροφορίες [**ελέγξτε αυτήν την ομιλία**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Ωστόσο, αυτό διορθώθηκε.
{% endhint %}

## Overwrite WHFB key

[**Ελέγξτε τις αρχικές διαφάνειες εδώ**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

Περίληψη επίθεσης:

* Είναι δυνατό να **αντικαταστήσετε** το **καταχωρημένο WHFB** κλειδί από μια **συσκευή** μέσω SSO
* Αυτό **νικά την προστασία TPM** καθώς το κλειδί **υποκλέπτεται κατά τη δημιουργία** του νέου κλειδιού
* Αυτό επίσης παρέχει **επιμονή**

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

Οι χρήστες μπορούν να τροποποιήσουν τη δική τους searchableDeviceKey ιδιότητα μέσω του Azure AD Graph, ωστόσο, ο επιτιθέμενος πρέπει να έχει μια συσκευή στον tenant (εγγεγραμμένη άμεσα ή έχοντας κλέψει το πιστοποιητικό + κλειδί από μια νόμιμη συσκευή) και ένα έγκυρο access token για το AAD Graph.

Στη συνέχεια, είναι δυνατό να δημιουργήσετε ένα νέο κλειδί με:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
και στη συνέχεια PATCH τις πληροφορίες του searchableDeviceKey:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

Είναι δυνατόν να αποκτηθεί ένα access token από έναν χρήστη μέσω **device code phishing** και να καταχραστούν τα προηγούμενα βήματα για να **κλέψουν την πρόσβασή του**. Για περισσότερες πληροφορίες, ελέγξτε:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## Αναφορές

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
