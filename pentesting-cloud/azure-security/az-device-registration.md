# Az - Device Registration

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## 基本情報

デバイスがAzureADに参加すると、AzureADに新しいオブジェクトが作成されます。

デバイスを登録する際、**ユーザーは自分のアカウントでログインするよう求められ**（必要に応じてMFAを要求）、その後デバイス登録サービスのトークンを要求し、最終確認プロンプトを求めます。

次に、デバイス内で2つのRSAキーペアが生成されます：**デバイスキー**（**公開**キー）は**AzureAD**に送信され、**トランスポートキー**（**秘密**キー）は可能であればTPMに保存されます。

その後、**オブジェクト**が**AzureAD**（Intuneではなく）に生成され、AzureADはデバイスに署名された**証明書**を返します。**デバイスがAzureADに参加している**ことや**証明書**に関する情報（TPMで保護されているかどうかなど）を確認できます。
```bash
dsregcmd /status
```
デバイス登録後、**Primary Refresh Token** が LSASS CloudAP モジュールによって要求され、デバイスに提供されます。PRT には **セッションキーが暗号化されてデバイスのみが復号できる**（トランスポートキーの公開鍵を使用）ものも含まれており、**PRT を使用するために必要です**。

PRT についての詳細は以下を参照してください：

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

**TPM** は、PIN で保護されている場合、電源がオフのデバイスからのキーの**抽出**や、OS レイヤーからのプライベートマテリアルの抽出に対して**保護**します。\
しかし、TPM と CPU の間の物理接続の**スニッフィング**や、システムが稼働中に **SYSTEM** 権限を持つプロセスから TPM 内の**暗号化マテリアルの使用**に対しては**保護しません**。

以下のページを確認すると、**PRT の盗難**がユーザーのようにアクセスするために使用できることがわかります。これは **PRT がデバイスに存在する**ため、デバイスから盗むことができる（または盗まなくても新しい署名キーを生成するために悪用できる）ためです：

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## SSO トークンを使用したデバイスの登録

攻撃者が Microsoft デバイス登録サービスのトークンを侵害されたデバイスから要求し、登録することが可能です：
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
将来PRTを要求するために使用できる**証明書を取得**します。したがって、持続性を維持し、**MFAをバイパス**します。なぜなら、新しいデバイスを登録するために使用された元のPRTトークンには**すでにMFAの権限が付与されていた**からです。

{% hint style="success" %}
この攻撃を実行するには、**新しいデバイスを登録する権限**が必要です。また、デバイスを登録することは、そのデバイスが**Intuneに登録されることを意味しません**。
{% endhint %}

{% hint style="danger" %}
この攻撃は2021年9月に修正され、SSOトークンを使用して新しいデバイスを登録することはできなくなりました。しかし、正当な方法（ユーザー名、パスワード、および必要に応じてMFAを持つ）でデバイスを登録することは依然として可能です。詳細は[**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md)を参照してください。
{% endhint %}

## デバイスチケットの上書き

**デバイスチケットを要求**し、デバイスの現在のチケットを**上書き**し、そのフロー中に**PRTを盗む**ことが可能でした（TPMから盗む必要はありません。詳細は[**このトーク**](https://youtu.be/BduCn8cLV1A)を参照してください）。

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
しかし、これは修正されました。
{% endhint %}

## WHFBキーの上書き

[**オリジナルのスライドはこちら**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

攻撃の概要:

* SSOを介して**デバイスから登録されたWHFBキーを上書き**することが可能
* 新しいキーの生成中にキーが**スニッフィングされる**ため、**TPM保護を無効化**
* これにより**持続性**も提供される

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

ユーザーはAzure AD Graphを介して自分のsearchableDeviceKeyプロパティを変更できますが、攻撃者はテナント内にデバイスを持っている必要があります（即座に登録するか、正当なデバイスから証明書とキーを盗む）およびAAD Graphの有効なアクセストークンが必要です。

次に、新しいキーを生成することが可能です:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
そして、searchableDeviceKeyの情報をPATCHします:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

**device code phishing**を通じてユーザーからアクセストークンを取得し、前述の手順を悪用して**アクセスを盗む**ことが可能です。詳細については以下を参照してください:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## 参考文献

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

{% hint style="success" %}
AWS Hackingを学び、練習する:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingを学び、練習する: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローしてください。
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出してください。

</details>
{% endhint %}
