# Az - Device Registration

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informations de base

Lorsqu'un appareil rejoint AzureAD, un nouvel objet est cr√©√© dans AzureAD.

Lors de l'enregistrement d'un appareil, **l'utilisateur est invit√© √† se connecter avec son compte** (en demandant une MFA si n√©cessaire), puis il demande des jetons pour le service d'enregistrement de l'appareil et demande ensuite une confirmation finale.

Ensuite, deux paires de cl√©s RSA sont g√©n√©r√©es dans l'appareil : La **cl√© de l'appareil** (cl√© **publique**) qui est envoy√©e √† **AzureAD** et la cl√© de **transport** (cl√© **priv√©e**) qui est stock√©e dans le TPM si possible.

Ensuite, l'**objet** est g√©n√©r√© dans **AzureAD** (pas dans Intune) et AzureAD renvoie √† l'appareil un **certificat** sign√© par lui. Vous pouvez v√©rifier que l'**appareil est rejoint √† AzureAD** et des informations sur le **certificat** (comme s'il est prot√©g√© par TPM).
```bash
dsregcmd /status
```
Apr√®s l'enregistrement de l'appareil, un **Primary Refresh Token** est demand√© par le module LSASS CloudAP et donn√© √† l'appareil. Avec le PRT est √©galement livr√© la **cl√© de session chiffr√©e de sorte que seul l'appareil puisse la d√©chiffrer** (en utilisant la cl√© publique de la cl√© de transport) et elle est **n√©cessaire pour utiliser le PRT.**

Pour plus d'informations sur ce qu'est un PRT, consultez :

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

Le **TPM** **prot√®ge** contre l'**extraction** de cl√©s d'un appareil √©teint (si prot√©g√© par un code PIN) et contre l'extraction du mat√©riel priv√© de la couche OS.\
Mais il **ne prot√®ge pas** contre le **sniffing** de la connexion physique entre le TPM et le CPU ou **l'utilisation du mat√©riel cryptographique** dans le TPM pendant que le syst√®me fonctionne √† partir d'un processus avec des droits **SYSTEM**.

Si vous consultez la page suivante, vous verrez que **voler le PRT** peut √™tre utilis√© pour acc√©der comme un **utilisateur**, ce qui est g√©nial car le **PRT est situ√© sur les appareils**, donc il peut √™tre vol√© √† partir de ceux-ci (ou s'il n'est pas vol√©, utilis√© pour g√©n√©rer de nouvelles cl√©s de signature) :

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Enregistrer un appareil avec des jetons SSO

Il serait possible pour un attaquant de demander un jeton pour le service d'enregistrement d'appareil Microsoft √† partir de l'appareil compromis et de l'enregistrer :
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Ce qui vous donnera un **certificat que vous pouvez utiliser pour demander des PRT √† l'avenir**. Ainsi, vous maintenez la persistance et **contournez le MFA** car le jeton PRT original utilis√© pour enregistrer le nouvel appareil **avait d√©j√† les permissions MFA accord√©es**.

{% hint style="success" %}
Notez que pour effectuer cette attaque, vous aurez besoin des permissions pour **enregistrer de nouveaux appareils**. De plus, enregistrer un appareil ne signifie pas que l'appareil sera **autoris√© √† s'inscrire dans Intune**.
{% endhint %}

{% hint style="danger" %}
Cette attaque a √©t√© corrig√©e en septembre 2021 car vous ne pouvez plus enregistrer de nouveaux appareils en utilisant des jetons SSO. Cependant, il est toujours possible d'enregistrer des appareils de mani√®re l√©gitime (en ayant le nom d'utilisateur, le mot de passe et le MFA si n√©cessaire). Consultez : [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## Remplacement d'un ticket d'appareil

Il √©tait possible de **demander un ticket d'appareil**, de **remplacer** celui actuel de l'appareil, et pendant le processus **voler le PRT** (donc pas besoin de le voler depuis le TPM. Pour plus d'infos [**consultez cette pr√©sentation**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Cependant, cela a √©t√© corrig√©.
{% endhint %}

## Remplacement de la cl√© WHFB

[**Consultez les diapositives originales ici**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

R√©sum√© de l'attaque :

* Il est possible de **remplacer** la cl√© **WHFB enregistr√©e** d'un **appareil** via SSO
* Cela **d√©fait la protection TPM** car la cl√© est **renifl√©e pendant la g√©n√©ration** de la nouvelle cl√©
* Cela fournit √©galement une **persistance**

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

Les utilisateurs peuvent modifier leur propre propri√©t√© searchableDeviceKey via l'Azure AD Graph, cependant, l'attaquant doit avoir un appareil dans le locataire (enregistr√© √† la vol√©e ou ayant vol√© le certificat + cl√© d'un appareil l√©gitime) et un jeton d'acc√®s valide pour l'AAD Graph.

Ensuite, il est possible de g√©n√©rer une nouvelle cl√© avec :
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
et ensuite PATCH les informations du searchableDeviceKey :

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

Il est possible d'obtenir un jeton d'acc√®s d'un utilisateur via **device code phishing** et d'abuser des √©tapes pr√©c√©dentes pour **voler son acc√®s**. Pour plus d'informations, consultez :

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## R√©f√©rences

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

{% hint style="success" %}
Apprenez et pratiquez AWS Hacking :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez GCP Hacking : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
