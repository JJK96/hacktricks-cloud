# Az - Cihaz Kaydı

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks'e PR göndererek hacking ipuçlarını paylaşın** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>
{% endhint %}

## Temel Bilgiler

Bir cihaz AzureAD'ye katıldığında AzureAD'de yeni bir nesne oluşturulur.

Bir cihaz kaydedilirken, **kullanıcı hesabıyla giriş yapması istenir** (gerekirse MFA isteyerek), ardından cihaz kayıt hizmeti için tokenlar talep edilir ve son bir onay istemi istenir.

Daha sonra, cihazda iki RSA anahtar çifti oluşturulur: **Cihaz anahtarı** (**açık** anahtar) AzureAD'ye gönderilir ve **taşıma** anahtarı (**özel** anahtar) mümkünse TPM'de saklanır.

Daha sonra, **nesne** **AzureAD**'de (Intune'da değil) oluşturulur ve AzureAD cihazına tarafından imzalanmış bir **sertifika** geri verir. **Cihazın AzureAD'ye katıldığını** ve **sertifika** hakkında bilgileri (örneğin TPM ile korunup korunmadığını) kontrol edebilirsiniz.:
```bash
dsregcmd /status
```
Cihaz kaydından sonra, **Primary Refresh Token** LSASS CloudAP modülü tarafından istenir ve cihaza verilir. PRT ile birlikte, **sadece cihazın şifreyi çözebileceği şekilde şifrelenmiş oturum anahtarı** (taşıma anahtarının genel anahtarı kullanılarak) teslim edilir ve **PRT'yi kullanmak için gereklidir.**

PRT'nin ne olduğu hakkında daha fazla bilgi için:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

**TPM**, PIN ile korunduğunda kapalı bir cihazdan anahtar **çıkarılmasına** ve özel materyalin işletim sistemi katmanından çıkarılmasına karşı **koruma sağlar**.\
Ancak, TPM ile CPU arasındaki fiziksel bağlantının **dinlenmesine** veya sistem çalışırken **SYSTEM** haklarına sahip bir işlem tarafından TPM'deki kriptografik materyalin **kullanılmasına** karşı **koruma sağlamaz**.

Aşağıdaki sayfayı kontrol ederseniz, **PRT'nin çalınmasının** bir **kullanıcı** gibi erişim sağlamak için kullanılabileceğini göreceksiniz, bu harika çünkü **PRT cihazlarda bulunur**, bu yüzden onlardan çalınabilir (veya çalınmasa bile yeni imzalama anahtarları oluşturmak için kötüye kullanılabilir):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## SSO tokenları ile cihaz kaydı

Bir saldırganın, ele geçirilmiş cihazdan Microsoft cihaz kayıt hizmeti için bir token talep etmesi ve cihazı kaydetmesi mümkün olabilir:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Which will give you a **certificate you can use to ask for PRTs in the future**. Bu nedenle kalıcılığı sürdürmek ve **MFA'yı atlamak** çünkü yeni cihazı kaydetmek için kullanılan orijinal PRT tokeni **zaten MFA izinleri verilmişti**.

{% hint style="success" %}
Bu saldırıyı gerçekleştirmek için **yeni cihazlar kaydetme** izinlerine sahip olmanız gerektiğini unutmayın. Ayrıca, bir cihazı kaydetmek, cihazın **Intune'a kaydolmasına izin verileceği anlamına gelmez**.
{% endhint %}

{% hint style="danger" %}
Bu saldırı Eylül 2021'de düzeltildi çünkü artık SSO tokenleri kullanarak yeni cihazlar kaydedemezsiniz. Ancak, cihazları yasal bir şekilde kaydetmek hala mümkündür (gerekirse kullanıcı adı, şifre ve MFA ile). Kontrol edin: [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## Bir cihaz biletini üzerine yazma

**Bir cihaz bileti talep etmek**, cihazın mevcut olanını **üzerine yazmak** ve akış sırasında **PRT'yi çalmak** mümkündü (bu nedenle TPM'den çalmaya gerek yok. Daha fazla bilgi için [**bu konuşmayı kontrol edin**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Ancak, bu düzeltildi.
{% endhint %}

## WHFB anahtarını üzerine yazma

[**Orijinal slaytları buradan kontrol edin**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

Saldırı özeti:

* SSO aracılığıyla bir **cihazdan** **kayıtlı WHFB** anahtarını **üzerine yazmak** mümkündür
* Yeni anahtarın **oluşturulması sırasında** anahtar **koklanarak** TPM korumasını **bozar**
* Bu aynı zamanda **kalıcılık sağlar**

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

Kullanıcılar, Azure AD Graph aracılığıyla kendi searchableDeviceKey özelliklerini değiştirebilirler, ancak saldırganın kiracıda bir cihaza sahip olması (anında kaydedilmiş veya yasal bir cihazdan çalınmış sertifika + anahtar) ve AAD Graph için geçerli bir erişim tokenine sahip olması gerekir.

Daha sonra, yeni bir anahtar oluşturmak mümkündür:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
ve ardından searchableDeviceKey bilgisini PATCH edin:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

Bir kullanıcıdan **device code phishing** yoluyla bir erişim token'ı almak ve önceki adımları kötüye kullanarak **erişimini çalmak** mümkündür. Daha fazla bilgi için:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## Referanslar

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) **bizi takip edin.**
* **HackTricks'e** [**PR göndererek**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunarak **hacking ipuçlarını paylaşın.**

</details>
{% endhint %}
