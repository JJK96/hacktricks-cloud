# Az - Conditional Access Policies / MFA Bypass

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne Informacije

Azure Conditional Access politike su pravila postavljena u Microsoft Azure-u za sprovođenje kontrola pristupa Azure uslugama i aplikacijama na osnovu određenih **uslova**. Ove politike pomažu organizacijama da osiguraju svoje resurse primenom pravih kontrola pristupa u pravim okolnostima.\
Conditional access politike u osnovi **definišu** **Ko** može pristupiti **Čemu** sa **Gde** i **Kako**.

Evo nekoliko primera:

1. **Sign-In Risk Policy**: Ova politika može biti postavljena da zahteva multi-factor authentication (MFA) kada se otkrije rizik pri prijavljivanju. Na primer, ako je ponašanje korisnika pri prijavljivanju neobično u poređenju sa njihovim redovnim obrascem, kao što je prijavljivanje iz druge zemlje, sistem može zatražiti dodatnu autentifikaciju.
2. **Device Compliance Policy**: Ova politika može ograničiti pristup Azure uslugama samo na uređaje koji su u skladu sa sigurnosnim standardima organizacije. Na primer, pristup može biti dozvoljen samo sa uređaja koji imaju ažuriran antivirusni softver ili koriste određenu verziju operativnog sistema.

## Zaobilaženje Conditional Access Politika

Moguće je da conditional access politika **proverava neke informacije koje se lako mogu izmeniti omogućavajući zaobilaženje politike**. I ako je, na primer, politika konfigurisala MFA, napadač će moći da je zaobiđe.

### Device Platforms - Uslov Uređaja

Moguće je postaviti uslov na osnovu **platforme uređaja** (Android, iOS, Windows, macOS), međutim, ovo se zasniva na **user-agent** pa je prilično lako zaobići. Čak i **ako sve opcije primenjuju MFA**, ako koristite **user-agent koji ne prepoznaje** moći ćete da zaobiđete MFA.

### Lokacije: Zemlje, IP opsezi - Uslov Uređaja

Naravno, ako je ovo postavljeno u conditional politici, napadač može jednostavno koristiti **VPN** u **dozvoljenoj zemlji** ili pokušati pronaći način da pristupi sa **dozvoljene IP adrese** kako bi zaobišao ove uslove.

### Office365 Klijent Aplikacije

Možete naznačiti da ako klijenti **pristupaju Office 365 aplikacijama iz pretraživača, potrebna je MFA**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Da biste ovo zaobišli, moguće je pretvarati se da se prijavljujete u aplikaciju sa desktop aplikacije (kao što je Microsoft Teams u sledećem primeru) što će zaobići zaštitu:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Kao što Microsoft Teams aplikacija ima mnogo dozvola, moći ćete da koristite taj pristup.

{% hint style="success" %}
Možete pronaći I**D više javnih aplikacija** sa unapred definisanim Office365 dozvolama u bazi podataka roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Ovaj napad je posebno interesantan jer će po defaultu javne Office365 aplikacije imati dozvole za pristup nekim podacima.

### Druge aplikacije

Po defaultu, druge aplikacije koje kreiraju korisnici neće imati dozvole i mogu biti privatne.\
Međutim, korisnici takođe mogu kreirati **javne** **aplikacije** dajući im neke **dozvole.**

Potencijalni scenario gde je politika postavljena da **zahteva MFA za pristup aplikaciji** kada korisnik koristi **pregledač** (možda zato što je to web aplikacija i stoga će to biti jedini način), ako postoji **proxy aplikacija** - aplikacija kojoj je dozvoljeno da **interaguje sa drugim aplikacijama u ime korisnika** - korisnik može **prijaviti se u proxy aplikaciju** i zatim kroz ovu proxy aplikaciju **prijaviti se u prvobitno MFA zaštićenu aplikaciju**.

Proverite tehnike [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) i [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken).

## Drugi Az MFA zaobilasci

### Ring tone

Jedna od opcija za Azure MFA je da **primite poziv na konfigurisan broj telefona** gde će se od korisnika tražiti da **pošalje karakter `#`**.

{% hint style="danger" %}
Pošto su karakteri samo **tonovi**, napadač može **kompromitovati** **glasovnu poštu** broja telefona, konfigurisati kao poruku **ton `#`** i zatim, kada zatraži MFA, osigurati da je **telefon žrtve zauzet** (pozivajući ga) tako da se Azure poziv preusmeri na glasovnu poštu.
{% endhint %}

### Usklađeni uređaji

Politike često zahtevaju usklađeni uređaj ili MFA, tako da **napadač može registrovati usklađeni uređaj**, dobiti **PRT** token i **zaobići MFA na ovaj način**.

Počnite registracijom **usklađenog uređaja u Intune**, zatim **dobijte PRT** sa:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Pronađite više informacija o ovoj vrsti napada na sledećoj stranici:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Alati

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Preuzmite sve politike
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep je PowerShell skripta koja pokušava da **se prijavi na razne Microsoft servise koristeći dati set kredencijala i pokuša da identifikuje da li je MFA omogućen**. U zavisnosti od toga kako su konfigurisane politike uslovnog pristupa i druga podešavanja za višefaktorsku autentifikaciju, neki protokoli mogu ostati sa jednim faktorom. Takođe ima dodatnu proveru za ADFS konfiguracije i može pokušati da se prijavi na on-prem ADFS server ako je detektovan.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token je skup funkcija koje imaju za cilj da pomognu bezbednosnim konsultantima koji treba da validiraju Conditional Access Policies, testiraju Microsoft portale sa omogućenim 2FA, itd.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Testirajte svaki portal** da li je moguće **prijaviti se bez MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Zato što **Azure** **portal** nije ograničen, moguće je prikupiti token sa portal endpoint-a za pristup bilo kojoj usluzi otkrivenoj prethodnim izvršenjem. U ovom slučaju je identifikovan Sharepoint, i zatražen je token za pristup:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Pretpostavljajući da token ima dozvolu Sites.Read.All (iz Sharepoint-a), čak i ako ne možete pristupiti Sharepoint-u sa web-a zbog MFA, moguće je koristiti token za pristup fajlovima sa generisanim tokenom:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Reference

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hacking trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
