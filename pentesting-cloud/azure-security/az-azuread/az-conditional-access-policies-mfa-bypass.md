# Az - Conditional Access Policies / MFA Bypass

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

As pol√≠ticas de Acesso Condicional do Azure s√£o regras configuradas no Microsoft Azure para impor controles de acesso aos servi√ßos e aplicativos do Azure com base em certas **condi√ß√µes**. Essas pol√≠ticas ajudam as organiza√ß√µes a proteger seus recursos aplicando os controles de acesso corretos nas circunst√¢ncias corretas.\
As pol√≠ticas de acesso condicional basicamente **definem** **Quem** pode acessar **O qu√™** de **Onde** e **Como**.

Aqui est√£o alguns exemplos:

1. **Pol√≠tica de Risco de Login**: Esta pol√≠tica pode ser configurada para exigir autentica√ß√£o multifator (MFA) quando um risco de login √© detectado. Por exemplo, se o comportamento de login de um usu√°rio for incomum em compara√ß√£o com seu padr√£o regular, como fazer login de um pa√≠s diferente, o sistema pode solicitar autentica√ß√£o adicional.
2. **Pol√≠tica de Conformidade de Dispositivos**: Esta pol√≠tica pode restringir o acesso aos servi√ßos do Azure apenas a dispositivos que estejam em conformidade com os padr√µes de seguran√ßa da organiza√ß√£o. Por exemplo, o acesso pode ser permitido apenas a partir de dispositivos que tenham software antiv√≠rus atualizado ou estejam executando uma certa vers√£o do sistema operacional.

## Bypasses de Pol√≠ticas de Acesso Condicional

√â poss√≠vel que uma pol√≠tica de acesso condicional esteja **verificando algumas informa√ß√µes que podem ser facilmente adulteradas permitindo um bypass da pol√≠tica**. E se, por exemplo, a pol√≠tica estava configurando MFA, o atacante poder√° burl√°-la.

### Plataformas de Dispositivos - Condi√ß√£o de Dispositivo

√â poss√≠vel definir uma condi√ß√£o com base na **plataforma do dispositivo** (Android, iOS, Windows, macOS), no entanto, isso √© baseado no **user-agent**, ent√£o √© bem f√°cil de burlar. Mesmo **fazendo com que todas as op√ß√µes exijam MFA**, se voc√™ usar um **user-agent que ele n√£o reconhe√ßa**, voc√™ poder√° burlar o MFA.

### Localiza√ß√µes: Pa√≠ses, Faixas de IP - Condi√ß√£o de Dispositivo

Claro que se isso estiver configurado na pol√≠tica condicional, um atacante poderia simplesmente usar uma **VPN** no **pa√≠s permitido** ou tentar encontrar uma maneira de acessar a partir de um **endere√ßo IP permitido** para burlar essas condi√ß√µes.

### Aplicativos Cliente do Office365

Voc√™ poderia indicar que se os clientes **acessarem aplicativos do Office 365 pelo navegador, eles precisam de MFA**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Para burlar isso, √© poss√≠vel fingir que voc√™ est√° fazendo login em um aplicativo a partir de um aplicativo de desktop (como o Microsoft Teams no exemplo a seguir), o que burlar√° a prote√ß√£o:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Como o aplicativo Microsoft Teams possui muitas permiss√µes, voc√™ poder√° usar esse acesso.

{% hint style="success" %}
Voc√™ pode encontrar o **ID de mais aplicativos p√∫blicos** com permiss√µes predefinidas do Office365 no banco de dados do roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Este ataque √© especialmente interessante porque, por padr√£o, aplicativos p√∫blicos do Office365 ter√£o permiss√µes para acessar alguns dados.

### Outros aplicativos

Por padr√£o, outros aplicativos criados por usu√°rios n√£o ter√£o permiss√µes e podem ser privados.\
No entanto, os usu√°rios tamb√©m podem criar **aplicativos p√∫blicos** concedendo-lhes algumas **permiss√µes.**

Um cen√°rio potencial onde uma pol√≠tica √© definida para **exigir MFA para acessar um aplicativo** quando o usu√°rio est√° usando um **navegador** (talvez porque √© um aplicativo web e, portanto, ser√° a √∫nica maneira), se houver um **aplicativo proxy** - um aplicativo permitido para **interagir com outros aplicativos em nome dos usu√°rios** -, o usu√°rio pode **fazer login no aplicativo proxy** e, em seguida, atrav√©s deste aplicativo proxy, **fazer login no aplicativo inicialmente protegido por MFA**.

Verifique as t√©cnicas [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) e [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken).

## Outros Az MFA Bypasses

### Toque de chamada

Uma op√ß√£o do Azure MFA √© **receber uma chamada no n√∫mero de telefone configurado** onde ser√° solicitado ao usu√°rio que **envie o caractere `#`**.

{% hint style="danger" %}
Como os caracteres s√£o apenas **tons**, um atacante pode **comprometer** a **mensagem de correio de voz** do n√∫mero de telefone, configurar como mensagem o **tom de `#`** e, em seguida, ao solicitar o MFA, garantir que o **telefone da v√≠tima esteja ocupado** (chamando-o) para que a chamada do Azure seja redirecionada para o correio de voz.
{% endhint %}

### Dispositivos compat√≠veis

Pol√≠ticas frequentemente exigem um dispositivo compat√≠vel ou MFA, ent√£o um **atacante pode registrar um dispositivo compat√≠vel**, obter um token **PRT** e **burlar o MFA dessa maneira**.

Comece registrando um **dispositivo compat√≠vel no Intune**, depois **obtenha o PRT** com:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Find more information about this kind of attack in the following page:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Ferramentas

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Obtenha todas as pol√≠ticas
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep √© um script PowerShell que tenta **fazer login em v√°rios servi√ßos da Microsoft usando um conjunto de credenciais fornecido e tentar√° identificar se o MFA est√° habilitado**. Dependendo de como as pol√≠ticas de acesso condicional e outras configura√ß√µes de autentica√ß√£o multifator est√£o configuradas, alguns protocolos podem acabar sendo deixados como fator √∫nico. Ele tamb√©m possui uma verifica√ß√£o adicional para configura√ß√µes ADFS e pode tentar fazer login no servidor ADFS on-premises se detectado.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token √© um conjunto de fun√ß√µes que visa ajudar consultores de seguran√ßa que precisam validar Pol√≠ticas de Acesso Condicional, testes para portais Microsoft com 2FA habilitado, etc.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Teste cada portal** para verificar se √© poss√≠vel **fazer login sem MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Porque o **Azure** **portal** n√£o √© **restrito**, √© poss√≠vel **obter um token do endpoint do portal para acessar qualquer servi√ßo detectado** pela execu√ß√£o anterior. Neste caso, o Sharepoint foi identificado, e um token para acess√°-lo √© solicitado:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Supondo que o token tenha a permiss√£o Sites.Read.All (do Sharepoint), mesmo que voc√™ n√£o consiga acessar o Sharepoint pela web por causa do MFA, √© poss√≠vel usar o token para acessar os arquivos com o token gerado:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Refer√™ncias

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Aprenda & pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda & pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
