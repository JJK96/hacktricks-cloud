# Az - Conditional Access Policies / MFA Bypass

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## 基本情報

Azure Conditional Accessポリシーは、特定の**条件**に基づいてAzureサービスやアプリケーションへのアクセス制御を強制するためにMicrosoft Azureで設定されるルールです。これらのポリシーは、適切な状況下で適切なアクセス制御を適用することで、組織のリソースを保護するのに役立ちます。\
Conditional Accessポリシーは基本的に**誰が**、**何を**、**どこから**、**どのように**アクセスできるかを定義します。

以下はいくつかの例です：

1. **Sign-In Risk Policy**: このポリシーは、サインインリスクが検出された場合に多要素認証（MFA）を要求するように設定できます。例えば、ユーザーのログイン行動が通常のパターンと異なる場合（異なる国からのログインなど）、システムは追加の認証を求めることができます。
2. **Device Compliance Policy**: このポリシーは、組織のセキュリティ基準に準拠しているデバイスからのみAzureサービスへのアクセスを制限することができます。例えば、最新のアンチウイルスソフトウェアがインストールされているデバイスや特定のオペレーティングシステムバージョンを実行しているデバイスからのアクセスのみを許可することができます。

## Conditional Accessポリシーのバイパス

Conditional Accessポリシーが**簡単に改ざんできる情報をチェックしている場合、ポリシーをバイパスすることが可能**です。例えば、ポリシーがMFAを設定していた場合、攻撃者はそれをバイパスすることができます。

### デバイスプラットフォーム - デバイス条件

**デバイスプラットフォーム**（Android、iOS、Windows、macOS）に基づいて条件を設定することが可能ですが、これは**ユーザーエージェント**に基づいているため、バイパスは非常に簡単です。すべてのオプションでMFAを強制するように設定しても、**認識されないユーザーエージェント**を使用すればMFAをバイパスすることができます。

### ロケーション: 国、IP範囲 - デバイス条件

もちろん、これがConditional Accessポリシーに設定されている場合、攻撃者は**許可された国**の**VPN**を使用するか、**許可されたIPアドレス**からアクセスする方法を見つけてこれらの条件をバイパスすることができます。

### Office365クライアントアプリ

クライアントが**ブラウザからOffice 365アプリにアクセスする場合にMFAが必要**とすることができます：

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

これをバイパスするために、デスクトップアプリケーション（以下の例ではMicrosoft Teams）からアプリにログインするふりをすることが可能で、これにより保護をバイパスできます：
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Microsoft Teamsアプリには多くの権限があるため、そのアクセスを利用できます。

{% hint style="success" %}
事前定義されたOffice365権限を持つ**より多くの公開アプリケーションのID**は、roadtoolsのデータベースで見つけることができます：

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

この攻撃は特に興味深いです。なぜなら、デフォルトではパブリックOffice365アプリケーションがいくつかのデータにアクセスする権限を持っているからです。

### その他のアプリ

デフォルトでは、ユーザーによって作成された他のアプリは権限を持たず、プライベートである可能性があります。\
しかし、ユーザーは**パブリック**な**アプリ**を作成し、それにいくつかの**権限**を付与することもできます。

ユーザーが**ブラウザ**を使用しているときに**アプリケーションにアクセスするためにMFAを要求する**ポリシーが設定されている潜在的なシナリオでは（おそらくそれがウェブアプリケーションであり、それが唯一の方法であるため）、**プロキシアプリケーション**（ユーザーに代わって他のアプリと**相互作用することを許可されたアプリケーション**）がある場合、ユーザーは**プロキシアプリケーションにログイン**し、その後このプロキシアプリケーションを通じて**最初にMFAで保護されたアプリにログイン**することができます。

[**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep)および[**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken)のテクニックを確認してください。

## その他のAz MFAバイパス

### リングトーン

Azure MFAのオプションの一つは、**設定された電話番号に電話を受ける**ことで、ユーザーに**`#`の文字を送信する**ように求められます。

{% hint style="danger" %}
文字は単なる**トーン**であるため、攻撃者は電話番号の**ボイスメール**メッセージを**侵害**し、メッセージとして**`#`のトーン**を設定し、MFAを要求するときに**被害者の電話が通話中**（電話をかける）であることを確認して、Azureの電話がボイスメールに転送されるようにすることができます。
{% endhint %}

### 準拠デバイス

ポリシーはしばしば準拠デバイスまたはMFAを要求するため、**攻撃者は準拠デバイスを登録**し、**PRT**トークンを取得して**この方法でMFAをバイパス**することができます。

まず、**Intuneで準拠デバイスを登録**し、次に**PRT**を取得します：
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
この種の攻撃に関する詳細情報は、次のページで見つけることができます：

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## ツール

### [roadrecon](https://github.com/dirkjanm/ROADtools)

すべてのポリシーを取得
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweepは、提供された資格情報を使用してさまざまなMicrosoftサービスに**ログインを試み、MFAが有効かどうかを識別しようとする**PowerShellスクリプトです。条件付きアクセスポリシーや他の多要素認証設定の構成方法によっては、一部のプロトコルがシングルファクターのままになることがあります。また、ADFS構成の追加チェックがあり、検出された場合にはオンプレミスのADFSサーバーへのログインを試みることができます。
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey tokenは、Conditional Access Policiesの検証、2FA対応のMicrosoftポータルのテストなどを行う必要があるセキュリティコンサルタントを支援するための一連の機能です。
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**各ポータルをテスト**して、**MFAなしでログイン**できるか確認します:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
**Azure** **ポータル**は**制約されていない**ため、前回の実行で検出された任意のサービスにアクセスするためのトークンをポータルエンドポイントから**収集することが可能**です。この場合、Sharepointが特定され、アクセスするためのトークンが要求されます:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

トークンがSites.Read.All（Sharepointから）の権限を持っていると仮定すると、たとえMFAのためにウェブからSharepointにアクセスできなくても、生成されたトークンを使用してファイルにアクセスすることが可能です:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## 参考文献

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
AWS Hackingを学び、練習する:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingを学び、練習する: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローする。**
* **PRを提出してハッキングトリックを共有する** [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリに。

</details>
{% endhint %}
