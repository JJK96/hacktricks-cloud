# Az - Conditional Access Policies / MFA Bypass

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Βασικές Πληροφορίες

Οι πολιτικές Conditional Access του Azure είναι κανόνες που έχουν οριστεί στο Microsoft Azure για την επιβολή ελέγχων πρόσβασης στις υπηρεσίες και εφαρμογές του Azure με βάση ορισμένες **συνθήκες**. Αυτές οι πολιτικές βοηθούν τους οργανισμούς να ασφαλίσουν τους πόρους τους εφαρμόζοντας τους κατάλληλους ελέγχους πρόσβασης υπό τις κατάλληλες συνθήκες.\
Οι πολιτικές Conditional Access βασικά **ορίζουν** **Ποιος** μπορεί να έχει πρόσβαση σε **Τι** από **Πού** και **Πώς**.

Εδώ είναι μερικά παραδείγματα:

1. **Πολιτική Κινδύνου Σύνδεσης**: Αυτή η πολιτική θα μπορούσε να οριστεί για να απαιτεί πολυπαραγοντική αυθεντικοποίηση (MFA) όταν ανιχνεύεται κίνδυνος σύνδεσης. Για παράδειγμα, αν η συμπεριφορά σύνδεσης ενός χρήστη είναι ασυνήθιστη σε σύγκριση με το κανονικό του μοτίβο, όπως η σύνδεση από διαφορετική χώρα, το σύστημα μπορεί να ζητήσει πρόσθετη αυθεντικοποίηση.
2. **Πολιτική Συμμόρφωσης Συσκευών**: Αυτή η πολιτική μπορεί να περιορίσει την πρόσβαση στις υπηρεσίες του Azure μόνο σε συσκευές που συμμορφώνονται με τα πρότυπα ασφαλείας του οργανισμού. Για παράδειγμα, η πρόσβαση θα μπορούσε να επιτρέπεται μόνο από συσκευές που έχουν ενημερωμένο λογισμικό προστασίας από ιούς ή εκτελούν μια συγκεκριμένη έκδοση λειτουργικού συστήματος.

## Παρακάμψεις Πολιτικών Conditional Access

Είναι πιθανό μια πολιτική Conditional Access να **ελέγχει κάποιες πληροφορίες που μπορούν εύκολα να παραποιηθούν επιτρέποντας την παράκαμψη της πολιτικής**. Και αν για παράδειγμα η πολιτική ρύθμιζε το MFA, ο επιτιθέμενος θα μπορούσε να το παρακάμψει.

### Πλατφόρμες Συσκευών - Συνθήκη Συσκευής

Είναι δυνατό να οριστεί μια συνθήκη με βάση την **πλατφόρμα συσκευής** (Android, iOS, Windows, macOS), ωστόσο, αυτό βασίζεται στον **user-agent** οπότε είναι αρκετά εύκολο να παρακαμφθεί. Ακόμα και **επιβάλλοντας το MFA σε όλες τις επιλογές**, αν χρησιμοποιήσετε έναν **user-agent που δεν αναγνωρίζει** θα μπορέσετε να παρακάμψετε το MFA.

### Τοποθεσίες: Χώρες, Εύρη IP - Συνθήκη Συσκευής

Φυσικά, αν αυτό έχει οριστεί στην πολιτική Conditional Access, ένας επιτιθέμενος θα μπορούσε απλά να χρησιμοποιήσει ένα **VPN** στη **επιτρεπόμενη χώρα** ή να προσπαθήσει να βρει έναν τρόπο να αποκτήσει πρόσβαση από μια **επιτρεπόμενη διεύθυνση IP** για να παρακάμψει αυτές τις συνθήκες.

### Office365 Client Apps

Θα μπορούσατε να υποδείξετε ότι αν οι πελάτες **πρόσβαση στις εφαρμογές του Office 365 από τον περιηγητή χρειάζονται MFA**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Για να παρακάμψετε αυτό, είναι δυνατό να προσποιηθείτε ότι συνδέεστε σε μια εφαρμογή από μια εφαρμογή επιφάνειας εργασίας (όπως το Microsoft Teams στο παρακάτω παράδειγμα) που θα παρακάμψει την προστασία:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Καθώς η εφαρμογή Microsoft Teams έχει πολλές άδειες, θα μπορείτε να χρησιμοποιήσετε αυτήν την πρόσβαση.

{% hint style="success" %}
Μπορείτε να βρείτε το **ID περισσότερων δημόσιων εφαρμογών** με προκαθορισμένες άδειες Office365 στη βάση δεδομένων του roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Αυτή η επίθεση είναι ιδιαίτερα ενδιαφέρουσα επειδή από προεπιλογή οι δημόσιες εφαρμογές του Office365 θα έχουν δικαιώματα πρόσβασης σε ορισμένα δεδομένα.

### Άλλες εφαρμογές

Από προεπιλογή, άλλες εφαρμογές που δημιουργούνται από χρήστες δεν θα έχουν δικαιώματα και θα μπορούσαν να είναι ιδιωτικές.\
Ωστόσο, οι χρήστες θα μπορούσαν επίσης να δημιουργήσουν **δημόσιες** **εφαρμογές** δίνοντάς τους ορισμένα **δικαιώματα.**

Ένα πιθανό σενάριο όπου μια πολιτική έχει οριστεί να **απαιτεί MFA για πρόσβαση σε μια εφαρμογή** όταν ο χρήστης χρησιμοποιεί έναν **φυλλομετρητή** (ίσως επειδή είναι μια διαδικτυακή εφαρμογή και επομένως θα είναι ο μόνος τρόπος), αν υπάρχει μια **εφαρμογή διαμεσολαβητή** -μια εφαρμογή που επιτρέπεται να **αλληλεπιδρά με άλλες εφαρμογές εκ μέρους των χρηστών**-, ο χρήστης θα μπορούσε να **συνδεθεί στην εφαρμογή διαμεσολαβητή** και στη συνέχεια μέσω αυτής της εφαρμογής να **συνδεθεί στην αρχικά προστατευμένη με MFA εφαρμογή**.

Ελέγξτε τις τεχνικές [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) και [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken).

## Άλλες παρακάμψεις Az MFA

### Ήχος κλήσης

Μία επιλογή Azure MFA είναι να **λάβετε μια κλήση στον διαμορφωμένο αριθμό τηλεφώνου** όπου θα ζητηθεί από τον χρήστη να **στείλει τον χαρακτήρα `#`**.

{% hint style="danger" %}
Καθώς οι χαρακτήρες είναι απλώς **τόνοι**, ένας επιτιθέμενος θα μπορούσε να **παραβιάσει** το **μήνυμα φωνητικού ταχυδρομείου** του αριθμού τηλεφώνου, να διαμορφώσει ως μήνυμα τον **τόνο του `#`** και στη συνέχεια, όταν ζητείται το MFA, να βεβαιωθεί ότι το **τηλέφωνο του θύματος είναι απασχολημένο** (καλώντας το) ώστε η κλήση του Azure να ανακατευθυνθεί στο φωνητικό ταχυδρομείο.
{% endhint %}

### Συμβατές Συσκευές

Οι πολιτικές συχνά ζητούν μια συμβατή συσκευή ή MFA, έτσι ένας **επιτιθέμενος θα μπορούσε να καταχωρήσει μια συμβατή συσκευή**, να πάρει ένα **PRT** token και **να παρακάμψει με αυτόν τον τρόπο το MFA**.

Ξεκινήστε καταχωρώντας μια **συμβατή συσκευή στο Intune**, στη συνέχεια **πάρτε το PRT** με:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Βρείτε περισσότερες πληροφορίες σχετικά με αυτό το είδος επίθεσης στην ακόλουθη σελίδα:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Εργαλεία

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Λάβετε όλες τις πολιτικές
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

Το MFASweep είναι ένα PowerShell script που προσπαθεί να **συνδεθεί σε διάφορες υπηρεσίες της Microsoft χρησιμοποιώντας ένα παρεχόμενο σύνολο διαπιστευτηρίων και θα προσπαθήσει να εντοπίσει αν είναι ενεργοποιημένο το MFA**. Ανάλογα με το πώς έχουν διαμορφωθεί οι πολιτικές πρόσβασης υπό όρους και άλλες ρυθμίσεις πολυπαραγοντικής αυθεντικοποίησης, ορισμένα πρωτόκολλα μπορεί να παραμείνουν μονοπαραγοντικά. Έχει επίσης έναν επιπλέον έλεγχο για διαμορφώσεις ADFS και μπορεί να προσπαθήσει να συνδεθεί στον on-prem ADFS server αν ανιχνευθεί.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Το Donkey token είναι ένα σύνολο λειτουργιών που στοχεύουν να βοηθήσουν τους συμβούλους ασφαλείας που χρειάζονται να επικυρώσουν τις Πολιτικές Πρόσβασης υπό Όρους, να δοκιμάσουν πύλες της Microsoft με ενεργοποιημένο το 2FA, κ.λπ.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Δοκιμάστε κάθε portal** αν είναι δυνατό να **συνδεθείτε χωρίς MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Επειδή το **Azure** **portal** δεν είναι **περιορισμένο**, είναι δυνατό να **συλλέξετε ένα token από το portal endpoint για να αποκτήσετε πρόσβαση σε οποιαδήποτε υπηρεσία ανιχνεύθηκε** από την προηγούμενη εκτέλεση. Σε αυτή την περίπτωση, το Sharepoint εντοπίστηκε και ζητείται ένα token για πρόσβαση σε αυτό:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Υποθέτοντας ότι το token έχει την άδεια Sites.Read.All (από το Sharepoint), ακόμα κι αν δεν μπορείτε να έχετε πρόσβαση στο Sharepoint από τον ιστό λόγω MFA, είναι δυνατό να χρησιμοποιήσετε το token για να αποκτήσετε πρόσβαση στα αρχεία με το παραγόμενο token:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Αναφορές

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Δείτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
