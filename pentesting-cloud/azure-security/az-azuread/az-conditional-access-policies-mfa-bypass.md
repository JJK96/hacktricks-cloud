# Az - Conditional Access Policies / MFA Bypass

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Azure Conditional Access policies Microsoft Azure рдореЗрдВ рд╕реЗрдЯ рдХрд┐рдП рдЧрдП рдирд┐рдпрдо рд╣реИрдВ рдЬреЛ рдХреБрдЫ **рд╢рд░реНрддреЛрдВ** рдХреЗ рдЖрдзрд╛рд░ рдкрд░ Azure рд╕реЗрд╡рд╛рдУрдВ рдФрд░ рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рдирд┐рдпрдВрддреНрд░рдг рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВред рдпреЗ рдиреАрддрд┐рдпрд╛рдВ рд╕рдВрдЧрдардиреЛрдВ рдХреЛ рд╕рд╣реА рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ рд╕рд╣реА рдкрд╣реБрдВрдЪ рдирд┐рдпрдВрддреНрд░рдг рд▓рд╛рдЧреВ рдХрд░рдХреЗ рдЕрдкрдиреЗ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддреА рд╣реИрдВред\
Conditional access policies рдореВрд▓ рд░реВрдк рд╕реЗ **рдХреМрди** **рдХреНрдпрд╛** **рдХрд╣рд╛рдВ** рдФрд░ **рдХреИрд╕реЗ** рдПрдХреНрд╕реЗрд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕реЗ **рдкрд░рд┐рднрд╛рд╖рд┐рдд** рдХрд░рддреА рд╣реИрдВред

рдпрд╣рд╛рдВ рдХреБрдЫ рдЙрджрд╛рд╣рд░рдг рджрд┐рдП рдЧрдП рд╣реИрдВ:

1. **Sign-In Risk Policy**: рдпрд╣ рдиреАрддрд┐ рд╕рд╛рдЗрди-рдЗрди рдЬреЛрдЦрд┐рдо рдХрд╛ рдкрддрд╛ рдЪрд▓рдиреЗ рдкрд░ рдорд▓реНрдЯреА-рдлреИрдХреНрдЯрд░ рдСрдереЗрдВрдЯрд┐рдХреЗрд╢рди (MFA) рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛ рд╕рдХрддреА рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрджрд┐ рдХрд┐рд╕реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рд▓реЙрдЧрд┐рди рд╡реНрдпрд╡рд╣рд╛рд░ рдЙрдирдХреЗ рдирд┐рдпрдорд┐рдд рдкреИрдЯрд░реНрди рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдЕрд╕рд╛рдорд╛рдиреНрдп рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ рдХрд┐рд╕реА рдЕрдиреНрдп рджреЗрд╢ рд╕реЗ рд▓реЙрдЧрд┐рди рдХрд░рдирд╛, рддреЛ рд╕рд┐рд╕реНрдЯрдо рдЕрддрд┐рд░рд┐рдХреНрдд рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рд╕рдВрдХреЗрдд рджреЗ рд╕рдХрддрд╛ рд╣реИред
2. **Device Compliance Policy**: рдпрд╣ рдиреАрддрд┐ рдХреЗрд╡рд▓ рдЙрди рдЙрдкрдХрд░рдгреЛрдВ рдХреЛ Azure рд╕реЗрд╡рд╛рдУрдВ рддрдХ рдкрд╣реБрдВрдЪ рдХреЛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд░ рд╕рдХрддреА рд╣реИ рдЬреЛ рд╕рдВрдЧрдарди рдХреЗ рд╕реБрд░рдХреНрд╖рд╛ рдорд╛рдирдХреЛрдВ рдХреЗ рдЕрдиреБрд░реВрдк рд╣реИрдВред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдХреЗрд╡рд▓ рдЙрди рдЙрдкрдХрд░рдгреЛрдВ рд╕реЗ рдкрд╣реБрдВрдЪ рдХреА рдЕрдиреБрдорддрд┐ рджреА рдЬрд╛ рд╕рдХрддреА рд╣реИ рдЬрд┐рдирдореЗрдВ рдЕрдк-рдЯреВ-рдбреЗрдЯ рдПрдВрдЯреАрд╡рд╛рдпрд░рд╕ рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рд╣реИ рдпрд╛ рдЬреЛ рдХрд┐рд╕реА рдирд┐рд╢реНрдЪрд┐рдд рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рд╕рдВрд╕реНрдХрд░рдг рдкрд░ рдЪрд▓ рд░рд╣реЗ рд╣реИрдВред

## Conditional Acces Policies Bypasses

рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдПрдХ conditional access policy **рдХреБрдЫ рдЬрд╛рдирдХрд╛рд░реА рдХреА рдЬрд╛рдВрдЪ рдХрд░ рд░рд╣реА рд╣реЛ рдЬрд┐рд╕реЗ рдЖрд╕рд╛рдиреА рд╕реЗ рдЫреЗрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рд╕реЗ рдиреАрддрд┐ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ**ред рдФрд░ рдпрджрд┐ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдиреАрддрд┐ MFA рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░ рд░рд╣реА рдереА, рддреЛ рд╣рдорд▓рд╛рд╡рд░ рдЗрд╕реЗ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛ред

### Device Platforms - Device Condition

рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **рдбрд┐рд╡рд╛рдЗрд╕ рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо** (Android, iOS, Windows, macOS) рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдПрдХ рд╢рд░реНрдд рд╕реЗрдЯ рдХреА рдЬрд╛рдП, рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ **рдпреВрдЬрд╝рд░-рдПрдЬреЗрдВрдЯ** рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИ рдЗрд╕рд▓рд┐рдП рдЗрд╕реЗ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛ рдХрд╛рдлреА рдЖрд╕рд╛рди рд╣реИред рдпрд╣рд╛рдВ рддрдХ рдХрд┐ **рд╕рднреА рд╡рд┐рдХрд▓реНрдкреЛрдВ рдХреЛ MFA рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдирд╛**, рдпрджрд┐ рдЖрдк **рдпреВрдЬрд╝рд░-рдПрдЬреЗрдВрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдЬрд┐рд╕реЗ рдпрд╣ рдкрд╣рдЪрд╛рди рдирд╣реАрдВ рдкрд╛рддрд╛** рддреЛ рдЖрдк mFA рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдВрдЧреЗред

### Locations: Countries, IP ranges - Device Condition

рдмреЗрд╢рдХ рдпрджрд┐ рдпрд╣ conditional policy рдореЗрдВ рд╕реЗрдЯ рд╣реИ, рддреЛ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **рдЕрдиреБрдордд рджреЗрд╢** рдореЗрдВ **VPN** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдпрд╛ рдЗрди рд╢рд░реНрддреЛрдВ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдЕрдиреБрдордд IP рдкрддрд╛** рд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рдЦреЛрдЬ рд╕рдХрддрд╛ рд╣реИред

### Office365 Client Apps

рдЖрдк рдпрд╣ рд╕рдВрдХреЗрдд рджреЗ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдпрджрд┐ рдХреНрд▓рд╛рдЗрдВрдЯ **рдмреНрд░рд╛рдЙрдЬрд╝рд░ рд╕реЗ Office 365 рдРрдкреНрд╕ рддрдХ рдкрд╣реБрдВрдЪрддреЗ рд╣реИрдВ рддреЛ рдЙрдиреНрд╣реЗрдВ MFA рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

рдЗрд╕реЗ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдЖрдк рдбреЗрд╕реНрдХрдЯреЙрдк рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕реЗ рдХрд┐рд╕реА рдРрдк рдореЗрдВ рд▓реЙрдЧ-рдЗрди рдХрд░рдиреЗ рдХрд╛ рдирд╛рдЯрдХ рдХрд░реЗрдВ (рдЬреИрд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рдореЗрдВ Microsoft Teams) рдЬреЛ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░ рджреЗрдЧрд╛:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
рдЬреИрд╕рд╛ рдХрд┐ Microsoft Teams рдРрдк рдХреЗ рдкрд╛рд╕ рдмрд╣реБрдд рд╕рд╛рд░реА рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рдЖрдк рдЙрд╕ рдПрдХреНрд╕реЗрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХреЗрдВрдЧреЗред

{% hint style="success" %}
рдЖрдк roadtools рдХреЗ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдкреВрд░реНрд╡рдирд┐рд░реНрдзрд╛рд░рд┐рдд Office365 рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдЕрдзрд┐рдХ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХрд╛ I**D рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

рдпрд╣ рд╣рдорд▓рд╛ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рджрд┐рд▓рдЪрд╕реНрдк рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ Office365 рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреБрдЫ рдбреЗрдЯрд╛ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдВрдЧреЗред

### рдЕрдиреНрдп рдРрдкреНрд╕

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдП рдЧрдП рдЕрдиреНрдп рдРрдкреНрд╕ рдХреЗ рдкрд╛рд╕ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдирд╣реАрдВ рд╣реЛрдВрдЧреА рдФрд░ рд╡реЗ рдирд┐рдЬреА рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ** **рдРрдкреНрд╕** рднреА рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдХреБрдЫ **рдЕрдиреБрдорддрд┐рдпрд╛рдБ** рджреЗ рд╕рдХрддреЗ рд╣реИрдВред

рдПрдХ рд╕рдВрднрд╛рд╡рд┐рдд рдкрд░рд┐рджреГрд╢реНрдп рдЬрд╣рд╛рдВ рдПрдХ рдиреАрддрд┐ рд╕реЗрдЯ рдХреА рдЧрдИ рд╣реИ **рдХрд┐рд╕реА рдПрдкреНрд▓рд┐рдХреЗрд╢рди рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП MFA рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ** рдЬрдм рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдмреНрд░рд╛рдЙрдЬрд╝рд░** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реИ (рд╢рд╛рдпрдж рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдПрдХ рд╡реЗрдм рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╣реИ рдФрд░ рдЗрд╕рд▓рд┐рдП рдпрд╣ рдПрдХрдорд╛рддреНрд░ рддрд░реАрдХрд╛ рд╣реЛрдЧрд╛), рдЕрдЧрд░ рдПрдХ **рдкреНрд░реЙрдХреНрд╕реА рдПрдкреНрд▓рд┐рдХреЗрд╢рди** рд╣реИ -рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЬреЛ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреА рдУрд░ рд╕реЗ рдЕрдиреНрдп рдРрдкреНрд╕ рдХреЗ рд╕рд╛рде рдЗрдВрдЯрд░реИрдХреНрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ**-, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдкреНрд░реЙрдХреНрд╕реА рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ рд▓реЙрдЧрд┐рди рдХрд░ рд╕рдХрддрд╛ рд╣реИ** рдФрд░ рдлрд┐рд░ рдЗрд╕ рдкреНрд░реЙрдХреНрд╕реА рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ **рд╢реБрд░реБрдЖрддреА MFA рд╕рдВрд░рдХреНрд╖рд┐рдд рдРрдк рдореЗрдВ рд▓реЙрдЧрд┐рди рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред

[**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) рдФрд░ [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) рддрдХрдиреАрдХреЛрдВ рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВред

## рдЕрдиреНрдп Az MFA рдмрд╛рдИрдкрд╛рд╕

### рд░рд┐рдВрдЧ рдЯреЛрди

рдПрдХ Azure MFA рд╡рд┐рдХрд▓реНрдк рд╣реИ **рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдлреЛрди рдирдВрдмрд░ рдкрд░ рдХреЙрд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛** рдЬрд╣рд╛рдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ **рдЪрд░ `#` рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рд╛ рдЬрд╛рдПрдЧрд╛**ред

{% hint style="danger" %}
рдЪреВрдВрдХрд┐ рдЪрд░ рд╕рд┐рд░реНрдл **рдЯреЛрди** рд╣реЛрддреЗ рд╣реИрдВ, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **рдлреЛрди рдирдВрдмрд░ рдХреЗ рд╡реЙрдЗрд╕рдореЗрд▓** рд╕рдВрджреЗрд╢ рдХреЛ **рд╕рдордЭреМрддрд╛** рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рд╕рдВрджреЗрд╢ рдХреЗ рд░реВрдк рдореЗрдВ **`#` рдХрд╛ рдЯреЛрди** рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░, рдЬрдм MFA рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ **рдкреАрдбрд╝рд┐рдд рдХрд╛ рдлреЛрди рд╡реНрдпрд╕реНрдд** рд╣реИ (рдЙрд╕реЗ рдХреЙрд▓ рдХрд░рдХреЗ) рддрд╛рдХрд┐ Azure рдХреЙрд▓ рд╡реЙрдЗрд╕ рдореЗрд▓ рдкрд░ рдкреБрдирд░реНрдирд┐рд░реНрджреЗрд╢рд┐рдд рд╣реЛ рдЬрд╛рдПред
{% endhint %}

### рдЕрдиреБрдкрд╛рд▓рди рдбрд┐рд╡рд╛рдЗрд╕

рдиреАрддрд┐рдпрд╛рдБ рдЕрдХреНрд╕рд░ рдПрдХ рдЕрдиреБрдкрд╛рд▓рди рдбрд┐рд╡рд╛рдЗрд╕ рдпрд╛ MFA рдХреЗ рд▓рд┐рдП рдкреВрдЫрддреА рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдПрдХ **рд╣рдорд▓рд╛рд╡рд░ рдПрдХ рдЕрдиреБрдкрд╛рд▓рди рдбрд┐рд╡рд╛рдЗрд╕ рдкрдВрдЬреАрдХреГрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ**, рдПрдХ **PRT** рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ **рдЗрд╕ рддрд░рд╣ рд╕реЗ MFA рдХреЛ рдмрд╛рдИрдкрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред

**Intune рдореЗрдВ рдПрдХ рдЕрдиреБрдкрд╛рд▓рди рдбрд┐рд╡рд╛рдЗрд╕ рдкрдВрдЬреАрдХреГрдд** рдХрд░рдХреЗ рд╢реБрд░реВ рдХрд░реЗрдВ, рдлрд┐рд░ **PRT рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХреЗ рд╣рдорд▓реЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреГрд╖реНрда рдкрд░ рдкрд╛рдПрдВ:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## рдЯреВрд▓рд┐рдВрдЧ

### [roadrecon](https://github.com/dirkjanm/ROADtools)

рд╕рднреА рдиреАрддрд┐рдпреЛрдВ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep рдПрдХ PowerShell рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╣реИ рдЬреЛ рджрд┐рдП рдЧрдП рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╡рд┐рднрд┐рдиреНрди Microsoft рд╕реЗрд╡рд╛рдУрдВ рдореЗрдВ **рд▓реЙрдЧ рдЗрди рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреА рд╣реИ рдФрд░ рдпрд╣ рдкрд╣рдЪрд╛рдирдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреА рд╣реИ рдХрд┐ рдХреНрдпрд╛ MFA рд╕рдХреНрд╖рдо рд╣реИ**ред рдЗрд╕ рдмрд╛рдд рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХрдВрдбреАрд╢рдирд▓ рдПрдХреНрд╕реЗрд╕ рдкреЙрд▓рд┐рд╕реА рдФрд░ рдЕрдиреНрдп рдорд▓реНрдЯреА-рдлреИрдХреНрдЯрд░ рдСрдереЗрдВрдЯрд┐рдХреЗрд╢рди рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреИрд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХреА рдЧрдИ рд╣реИрдВ, рдХреБрдЫ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╕рд┐рдВрдЧрд▓ рдлреИрдХреНрдЯрд░ рд░рд╣ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕рдореЗрдВ ADFS рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрддрд┐рд░рд┐рдХреНрдд рдЪреЗрдХ рднреА рд╣реИ рдФрд░ рдпрджрд┐ рдкрддрд╛ рдЪрд▓рддрд╛ рд╣реИ рддреЛ рдСрди-рдкреНрд░реЗрдо ADFS рд╕рд░реНрд╡рд░ рдореЗрдВ рд▓реЙрдЧ рдЗрди рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИред
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token рдПрдХ рд╕реЗрдЯ рд╣реИ рдЬреЛ рд╕реБрд░рдХреНрд╖рд╛ рд╕рд▓рд╛рд╣рдХрд╛рд░реЛрдВ рдХреА рдорджрдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ Conditional Access Policies рдХреЛ рдорд╛рдиреНрдп рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, 2FA-рд╕рдХреНрд╖рдо Microsoft рдкреЛрд░реНрдЯрд▓реНрд╕ рдХреЗ рд▓рд┐рдП рдкрд░реАрдХреНрд╖рдг, рдЖрджрд┐ред
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**рдкреНрд░рддреНрдпреЗрдХ рдкреЛрд░реНрдЯрд▓ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░реЗрдВ** рдХрд┐ рдХреНрдпрд╛ **MFA рдХреЗ рдмрд┐рдирд╛ рд▓реЙрдЧрд┐рди рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
рдХреНрдпреЛрдВрдХрд┐ **Azure** **portal** **рд╕реАрдорд┐рдд рдирд╣реАрдВ рд╣реИ**, рдпрд╣ **рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдкрд┐рдЫрд▓реЗ рдирд┐рд╖реНрдкрд╛рджрди рджреНрд╡рд╛рд░рд╛ рдкрд╣рдЪрд╛рдиреА рдЧрдИ рдХрд┐рд╕реА рднреА рд╕реЗрд╡рд╛ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдкреЛрд░реНрдЯрд▓ рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╕реЗ рдПрдХ рдЯреЛрдХрди рдПрдХрддреНрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ**ред рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ Sharepoint рдХреА рдкрд╣рдЪрд╛рди рдХреА рдЧрдИ рдереА, рдФрд░ рдЗрд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЯреЛрдХрди рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЧрдпрд╛:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

рдорд╛рди рд▓реЗрддреЗ рд╣реИрдВ рдХрд┐ рдЯреЛрдХрди рдХреЗ рдкрд╛рд╕ Sites.Read.All (Sharepoint рд╕реЗ) рдЕрдиреБрдорддрд┐ рд╣реИ, рднрд▓реЗ рд╣реА рдЖрдк MFA рдХреЗ рдХрд╛рд░рдг рд╡реЗрдм рд╕реЗ Sharepoint рддрдХ рдкрд╣реБрдВрдЪ рдирд╣реАрдВ рд╕рдХрддреЗ, рдпрд╣ рдЙрддреНрдкрдиреНрди рдЯреЛрдХрди рдХреЗ рд╕рд╛рде рдлрд╛рдЗрд▓реЛрдВ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## References

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
AWS Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХреЛ рд╕рдорд░реНрдерди рджреЗрдВ</summary>

* [**subscription plans**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram group**](https://t.me/peass) рдпрд╛ **рд╣рдореЗрдВ рдлреЙрд▓реЛ рдХрд░реЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ред**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>
{% endhint %}
