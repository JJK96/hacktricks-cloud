# Az - Conditional Access Policies / MFA Bypass

{% hint style="success" %}
Leer en oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer en oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repo's.

</details>
{% endhint %}

## Basiese Inligting

Azure Conditional Access-beleide is re√´ls wat in Microsoft Azure opgestel is om toegangsbeheer tot Azure-dienste en toepassings af te dwing gebaseer op sekere **voorwaardes**. Hierdie beleide help organisasies om hul hulpbronne te beveilig deur die regte toegangsbeheer onder die regte omstandighede toe te pas.\
Conditional access-beleide definieer basies **Wie** toegang het tot **Wat** van **Waar** en **Hoe**.

Hier is 'n paar voorbeelde:

1. **Sign-In Risk Policy**: Hierdie beleid kan ingestel word om multi-faktor verifikasie (MFA) te vereis wanneer 'n aanmeldingsrisiko opgespoor word. Byvoorbeeld, as 'n gebruiker se aanmeldgedrag ongewoon is in vergelyking met hul gewone patroon, soos om van 'n ander land af aan te meld, kan die stelsel vra vir bykomende verifikasie.
2. **Device Compliance Policy**: Hierdie beleid kan toegang tot Azure-dienste beperk tot toestelle wat voldoen aan die organisasie se sekuriteitstandaarde. Byvoorbeeld, toegang kan slegs toegelaat word vanaf toestelle wat op datum antivirus-sagteware het of 'n sekere bedryfstelselweergawe gebruik.

## Conditional Access Policies Omseilings

Dit is moontlik dat 'n conditional access-beleid **sekere inligting nagaan wat maklik gemanipuleer kan word om die beleid te omseil**. En as die beleid byvoorbeeld MFA gekonfigureer het, sal die aanvaller dit kan omseil.

### Toestelplatforms - Toestelvoorwaarde

Dit is moontlik om 'n voorwaarde te stel gebaseer op die **toestelplatform** (Android, iOS, Windows, macOS), maar dit is gebaseer op die **user-agent** so dit is redelik maklik om te omseil. Selfs **as al die opsies MFA afdwing**, as jy 'n **user-agent gebruik wat dit nie herken nie** sal jy die MFA kan omseil.

### Ligging: Lande, IP-reekse - Toestelvoorwaarde

Natuurlik, as dit in die conditional policy gestel is, kan 'n aanvaller net 'n **VPN** in die **toegestane land** gebruik of probeer om 'n manier te vind om toegang te kry vanaf 'n **toegestane IP-adres** om hierdie voorwaardes te omseil.

### Office365 Kli√´nttoepassings

Jy kan aandui dat as kli√´nte **Office 365-toepassings vanaf die blaaier toegang, hulle MFA benodig**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Om dit te omseil, is dit moontlik om voor te gee dat jy aanmeld in 'n toepassing vanaf 'n lessenaar-toepassing (soos Microsoft Teams in die volgende voorbeeld) wat die beskerming sal omseil:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
As Microsoft Teams app baie toestemmings het, sal jy daardie toegang kan gebruik.

{% hint style="success" %}
Jy kan die **ID van meer publieke toepassings** met voorafbepaalde Office365 toestemmings in die databasis van roadtools vind:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Hierdie aanval is veral interessant omdat publieke Office365 toepassings standaard toestemming sal h√™ om sekere data te bekom.

### Ander toepassings

Standaard sal ander toepassings wat deur gebruikers geskep is nie toestemming h√™ nie en kan privaat wees.\
Gebruikers kan egter ook **publieke** **toepassings** skep en hulle sekere **toestemmings** gee.

'n Potensi√´le scenario waar 'n beleid ingestel is om **MFA te vereis om toegang tot 'n toepassing te kry** wanneer die gebruiker 'n **blaaier** gebruik (miskien omdat dit 'n webtoepassing is en dus die enigste manier sal wees), as daar 'n **proxy toepassing** is - 'n toepassing wat toegelaat word om **met ander toepassings namens gebruikers te kommunikeer** - kan die gebruiker **aanmeld by die proxy toepassing** en dan deur hierdie proxy toepassing **aanmeld by die aanvanklik MFA beskermde toepassing**.

Kyk na die [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) en die [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) tegnieke.

## Ander Az MFA Omseilings

### Ringtoon

Een Azure MFA opsie is om **'n oproep te ontvang op die gekonfigureerde telefoonnommer** waar die gebruiker gevra sal word om die **karakter `#` te stuur**.

{% hint style="danger" %}
Aangesien karakters net **tonen** is, kan 'n aanvaller die **stempos** boodskap van die telefoonnommer **kompromitteer**, die boodskap as die **toon van `#`** stel en dan, wanneer die MFA versoek word, seker maak dat die **slagoffer se telefoon besig is** (deur dit te bel) sodat die Azure oproep na die stempos herlei word.
{% endhint %}

### Voldoenende Toestelle

Beleide vra dikwels vir 'n voldoenende toestel of MFA, so 'n **aanvaller kan 'n voldoenende toestel registreer**, 'n **PRT** token kry en **op hierdie manier die MFA omseil**.

Begin deur 'n **voldoenende toestel in Intune te registreer**, kry dan die **PRT** met:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Vind meer inligting oor hierdie soort aanval op die volgende bladsy:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Gereedskap

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Kry al die beleide
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep is 'n PowerShell-skrip wat probeer om **by verskeie Microsoft-dienste aan te meld met 'n verskafde stel geloofsbriewe en sal probeer om te identifiseer of MFA geaktiveer is**. Afhangende van hoe voorwaardelike toegangsbeleide en ander multi-faktor verifikasie-instellings gekonfigureer is, kan sommige protokolle enkel faktor bly. Dit het ook 'n bykomende toets vir ADFS-konfigurasies en kan probeer om by die plaaslike ADFS-bediener aan te meld indien opgespoor.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token is 'n stel funksies wat daarop gemik is om sekuriteitskonsultante te help wat Voorwaardelike Toegang Beleide moet valideer, toetse vir 2FA-geaktiveerde Microsoft-portale, ens.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Toets elke portaal** of dit moontlik is om **sonder MFA aan te meld**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Omdat die **Azure** **portaal** **nie beperk is nie**, is dit moontlik om **'n teken van die portaal-eindpunt te versamel om toegang te verkry tot enige diens wat deur die vorige uitvoering opgespoor is**. In hierdie geval is Sharepoint ge√Ødentifiseer, en 'n teken om toegang daartoe te verkry, word versoek:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Gestel die token het die toestemming Sites.Read.All (van Sharepoint), selfs al kan jy nie Sharepoint vanaf die web toegang weens MFA nie, is dit moontlik om die token te gebruik om toegang tot die l√™ers te kry met die gegenereerde token:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Verwysings

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
