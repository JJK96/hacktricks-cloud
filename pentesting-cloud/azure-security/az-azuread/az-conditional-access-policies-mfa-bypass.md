# Az - Conditional Access Policies / MFA Bypass

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Temel Bilgiler

Azure Conditional Access politikaları, Microsoft Azure'da belirli **koşullara** dayalı olarak Azure hizmetlerine ve uygulamalarına erişim kontrollerini uygulamak için oluşturulan kurallardır. Bu politikalar, kuruluşların kaynaklarını doğru koşullar altında doğru erişim kontrollerini uygulayarak güvence altına almalarına yardımcı olur.\
Conditional access politikaları temel olarak **Kim**'in **Neye** **Nereden** ve **Nasıl** erişebileceğini **tanımlar**.

İşte birkaç örnek:

1. **Sign-In Risk Policy**: Bu politika, bir oturum açma riski tespit edildiğinde çok faktörlü kimlik doğrulama (MFA) gerektirecek şekilde ayarlanabilir. Örneğin, bir kullanıcının oturum açma davranışı, düzenli modeline kıyasla alışılmadık olduğunda, örneğin farklı bir ülkeden oturum açıyorsa, sistem ek kimlik doğrulama isteyebilir.
2. **Device Compliance Policy**: Bu politika, yalnızca kuruluşun güvenlik standartlarına uygun cihazların Azure hizmetlerine erişimini kısıtlayabilir. Örneğin, yalnızca güncel antivirüs yazılımına sahip veya belirli bir işletim sistemi sürümünü çalıştıran cihazlardan erişime izin verilebilir.

## Conditional Access Politikalarını Atlatma

Bir conditional access politikasının **kolayca değiştirilebilecek bazı bilgileri kontrol etmesi ve bu politikanın atlatılmasına izin vermesi** mümkündür. Ve örneğin politika MFA'yı yapılandırıyorsa, saldırgan bunu atlatabilir.

### Cihaz Platformları - Cihaz Koşulu

**Cihaz platformuna** (Android, iOS, Windows, macOS) dayalı bir koşul ayarlamak mümkündür, ancak bu **user-agent**'a dayalıdır, bu yüzden atlatmak oldukça kolaydır. Tüm seçenekler MFA'yı zorunlu kılsa bile, **tanımadığı bir user-agent kullanırsanız** MFA'yı atlatabilirsiniz.

### Konumlar: Ülkeler, IP aralıkları - Cihaz Koşulu

Elbette bu conditional policy'de ayarlanmışsa, bir saldırgan **izin verilen ülkede** bir **VPN** kullanabilir veya bu koşulları atlatmak için **izin verilen bir IP adresinden** erişim sağlamanın bir yolunu bulabilir.

### Office365 İstemci Uygulamaları

İstemcilerin **tarayıcıdan Office 365 uygulamalarına eriştiklerinde MFA gerektirdiğini** belirtebilirsiniz:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Bunu atlatmak için, bir masaüstü uygulamasından (aşağıdaki örnekte Microsoft Teams gibi) bir uygulamaya giriş yapıyormuş gibi davranmak mümkündür, bu da korumayı atlatacaktır:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Microsoft Teams uygulamasının birçok izni olduğundan, bu erişimi kullanabileceksiniz.

{% hint style="success" %}
**Daha fazla genel uygulamanın** kimliğini, önceden tanımlanmış Office365 izinleriyle birlikte roadtools veritabanında bulabilirsiniz:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Bu saldırı özellikle ilginçtir çünkü varsayılan olarak public Office365 uygulamaları bazı verilere erişim izinlerine sahip olacaktır.

### Diğer uygulamalar

Varsayılan olarak, kullanıcılar tarafından oluşturulan diğer uygulamalar izinlere sahip olmayacak ve özel olabilir.\
Ancak, kullanıcılar **public** **uygulamalar** oluşturarak onlara bazı **izinler** verebilirler.

Bir politikanın, kullanıcının bir **tarayıcı** kullanırken bir **uygulamaya erişmek için MFA gerektirmesi** gerektiği bir senaryoda (belki bu bir web uygulaması olduğu için ve bu nedenle tek yol olacaktır), eğer bir **proxy uygulaması** -kullanıcılar adına diğer uygulamalarla **etkileşime girmesine izin verilen bir uygulama**- varsa, kullanıcı **proxy uygulamasına giriş yapabilir** ve ardından bu proxy uygulaması aracılığıyla **başlangıçta MFA korumalı uygulamaya giriş yapabilir**.

[**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) ve [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) tekniklerini kontrol edin.

## Diğer Az MFA Atlatmaları

### Zil sesi

Bir Azure MFA seçeneği, **kullanıcının yapılandırılmış telefon numarasına bir çağrı alması** ve kullanıcıdan **`#` karakterini göndermesinin istenmesidir**.

{% hint style="danger" %}
Karakterler sadece **tonlar** olduğundan, bir saldırgan telefon numarasının **sesli mesajını** **ele geçirebilir**, mesaj olarak **`#` tonunu** yapılandırabilir ve ardından MFA talep edildiğinde **kurbanın telefonunun meşgul olduğundan** emin olabilir (onu arayarak) böylece Azure çağrısı sesli mesaja yönlendirilir.
{% endhint %}

### Uyumluluk Cihazları

Politikalar genellikle uyumlu bir cihaz veya MFA ister, bu nedenle bir **saldırgan uyumlu bir cihaz kaydedebilir**, bir **PRT** token alabilir ve **bu şekilde MFA'yı atlatabilir**.

Öncelikle **Intune'da uyumlu bir cihaz kaydedin**, ardından **PRT'yi alın**:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Bu tür saldırılar hakkında daha fazla bilgi için aşağıdaki sayfaya bakın:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Araçlar

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Tüm politikaları alın
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep, sağlanan kimlik bilgileri kümesini kullanarak çeşitli Microsoft hizmetlerine **giriş yapmaya çalışan ve MFA'nın etkin olup olmadığını belirlemeye çalışan** bir PowerShell betiğidir. Koşullu erişim politikalarının ve diğer çok faktörlü kimlik doğrulama ayarlarının nasıl yapılandırıldığına bağlı olarak bazı protokoller tek faktörlü olarak kalabilir. Ayrıca ADFS yapılandırmaları için ek bir kontrolü vardır ve tespit edilirse yerel ADFS sunucusuna giriş yapmayı deneyebilir.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token, Koşullu Erişim Politikalarını doğrulaması gereken güvenlik danışmanlarına, 2FA etkin Microsoft portallarını test etmelerine vb. yardımcı olmayı amaçlayan bir dizi işlevdir.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Her portalı test edin** eğer **MFA olmadan giriş yapmak** mümkünse:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Çünkü **Azure** **portalı** **kısıtlanmamış**, **önceki yürütme tarafından tespit edilen herhangi bir hizmete erişmek için portal uç noktasından bir token toplamak mümkündür**. Bu durumda Sharepoint tespit edildi ve ona erişmek için bir token talep edildi:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Tokenun Sites.Read.All (Sharepoint'tan) iznine sahip olduğunu varsayarsak, web üzerinden MFA nedeniyle Sharepoint'e erişemeseniz bile, oluşturulan token ile dosyalara erişmek mümkündür:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Referanslar

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{% hint style="success" %}
AWS Hacking öğren & pratik yap:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğren & pratik yap: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek hacking ipuçlarını paylaşın.

</details>
{% endhint %}
