# Az - AzureAD (AAD)

{% hint style="success" %}
Leer en oefen AWS-hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer en oefen GCP-hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Controleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

## Basiese Inligting

Azure Active Directory (Azure AD) dien as Microsoft se wolkgebaseerde diens vir identiteit- en toegangsbestuur. Dit is instrumenteel om werknemers in staat te stel om aan te meld en toegang te verkry tot hulpbronne, beide binne en buite die organisasie, wat Microsoft 365, die Azure-portaal, en 'n menigte ander SaaS-toepassings insluit. Die ontwerp van Azure AD fokus op die lewering van noodsaaklike identiteitsdienste, insluitend **verifikasie, magtiging, en gebruikersbestuur**.

Kernkenmerke van Azure AD behels **multi-faktor-verifikasie** en **voorwaardelike toegang**, tesame met naadlose integrasie met ander Microsoft-sekuriteitsdienste. Hierdie kenmerke verhoog die veiligheid van gebruikersidentiteite aansienlik en bemagtig organisasies om hul toegangbeleide doeltreffend te implementeer en af te dwing. As 'n fundamentele komponent van Microsoft se wolkdiens-ekosisteem, is Azure AD noodsaaklik vir die wolkgebaseerde bestuur van gebruikersidentiteite.

## Entiteite

### Opname

Vir hierdie opname kan jy die [**az cli-werktuig**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)**,** die **PowerShell-module** [**AzureAD**](https://www.powershellgallery.com/packages/AzureAD/) (of [**AzureAD Preview**](https://www.powershellgallery.com/packages/AzureADPreview)) en die [**Az PowerShell**](https://learn.microsoft.com/en-us/powershell/azure/install-az-ps) module gebruik.

{% hint style="success" %}
In Linux sal jy PowerShell Core moet installeer:
```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Update repos
sudo apt-get update
sudo add-apt-repository universe

# Install & start powershell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
{% endhint %}

#### **Moduleverskille**

* **AzureAD** is 'n PowerShell-module van Microsoft vir die **bestuur van Azure AD. Dit wys nie al die eienskappe van Azure AD-voorwerpe nie en kan nie gebruik word om toegang tot Azure-broninligting te verkry**.
* **Az PowerShell** is 'n module vir die **bestuur van Azure-bronne** van die PowerShell-opdraglyn.

### **Konneksie**

{% tabs %}
{% tab title="az cli" %}
```bash
az login #This will open the browser
az login -u <username> -p <password> #Specify user and password
az login --identity #Use the current machine managed identity (metadata)
az login --identity -u /subscriptions/<subscriptionId>/resourcegroups/myRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myID #Login with user managed identity
# Login as service principal
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p VerySecret --tenant contoso.onmicrosoft.com #With password
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p ~/mycertfile.pem --tenant contoso.onmicrosoft.com #With cert

# Request access token (ARM)
az account get-access-token
# Request access token for different resource. Supported tokens: aad-graph, arm, batch, data-lake, media, ms-graph, oss-rdbms
az account get-access-token --resource-type aad-graph

# If you want to configure some defaults
az configure

# Get user logged-in already
az ad signed-in-user show

# Help
az find "vm" # Find vm commands
az vm -h # Get subdomains
az ad user list --query-examples # Get examples
```
{% endtab %}

{% tab title="Azure AD" %}
{% code overflow="wrap" %}
```powershell
Connect-AzureAD #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds

# Using tokens
## AzureAD cannot request tokens, but can use AADGraph and MSGraph tokens to connect
Connect-AzureAD -AccountId test@corp.onmicrosoft.com -AadAccessToken $token
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
Connect-AzAccount #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

# Get Access Token
(Get-AzAccessToken).Token
# Request access token to other endpoints: AadGraph, AnalysisServices, Arm, Attestation, Batch, DataLake, KeyVault, MSGraph, OperationalInsights, ResourceManager, Storage, Synapse
Get-AzAccessToken -ResourceTypeName MSGraph
(Get-AzAccessToken -Resource "https://graph.microsoft.com").Token

# Conenct with access token
Connect-AzAccount -AccountId test@corp.onmicrosoft.com -AccessToken $token
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId <ACCOUNT-ID>
## The -AccessToken is from management.azure.com

# Connect with Service principal/enterprise app secret
$password = ConvertTo-SecureString 'KWEFNOIRFIPMWL.--DWPNVFI._EDWWEF_ADF~SODNFBWRBIF' -AsPlainText -Force
$creds = New-Object
System.Management.Automation.PSCredential('2923847f-fca2-a420-df10-a01928bec653', $password)
Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 29sd87e56-a192-a934-bca3-0398471ab4e7d

#All the Azure AD cmdlets have the format *-AzAD*
Get-Command *azad*
#Cmdlets for other Azure resources have the format *Az*
Get-Command *az*
```
{% endtab %}

{% tab title="Raw PS" %}
{% code overflow="wrap" %}
```powershell
#Using management
$Token = 'eyJ0eXAi..'
# List subscriptions
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value

# Using graph
Invoke-WebRequest -Uri "https://graph.windows.net/myorganization/users?api-version=1.6" -Headers @{Authorization="Bearer {0}" -f $Token}
```
{% endcode %}
{% endtab %}

{% tab title="Ruw OS" %}
{% code overflow="wrap" %}
```bash
# Request tokens to access endpoints
# ARM
curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Vault
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```
{% endcode %}
{% endtab %}
{% endtabs %}

Wanneer jy **aanmeld** via **CLI** in Azure met enige program, gebruik jy 'n **Azure-toepassing** van 'n **huurder** wat aan **Microsoft** behoort. Hierdie Toepassings, soos diegene wat jy in jou rekening kan skep, **het 'n kli√´nt-ID**. Jy **sal nie almal van hulle kan sien** in die **toegelate toepassingslyste** wat jy in die konsole kan sien nie, **maar hulle is standaard toegelaat**.

Byvoorbeeld 'n **powershell-skrip** wat **verifieer** gebruik 'n toepassing met kli√´nt-ID **`1950a258-227b-4e31-a9cf-717495945fc2`**. Selfs al verskyn die toepassing nie in die konsole nie, kan 'n stelseladministrateur daardie toepassing **blokkeer** sodat gebruikers nie kan toegang verkry deur gereedskap wat via daardie Toepassing koppel nie.

Nietemin, daar is **ander kli√´nt-IDs** van toepassings wat jou **sal toelaat om met Azure te koppel**:
```powershell
# The important part is the ClientId, which identifies the application to login inside Azure

$token = Invoke-Authorize -Credential $credential `
-ClientId '1dfb5f98-f363-4b0f-b63a-8d20ada1e62d' `
-Scope 'Files.Read.All openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "https://graphtryit-staging.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId '65611c08-af8c-46fc-ad20-1888eb1b70d9' `
-Scope 'openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "chrome-extension://imjekgehfljppdblckcmjggcoboemlah" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId 'd3ce4cf8-6810-442d-b42e-375e14710095' `
-Scope 'openid' `
-Redirect_Uri "https://graphexplorer.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue
```
### Gebruikers

{% tabs %}
{% tab title="az cli" %}
```bash
# Enumerate users
az ad user list --output table
az ad user list --query "[].userPrincipalName"
# Get info of 1 user
az ad user show --id "test@corp.onmicrosoft.com"
# Search "admin" users
az ad user list --query "[].displayName" | findstr /i "admin"
az ad user list --query "[?contains(displayName,'admin')].displayName"
# Search attributes containing the word "password"
az ad user list | findstr /i "password" | findstr /v "null,"
# All users from AzureAD
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi==null]"
az ad user list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All users synced from on-prem
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi!=null]"
az ad user list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get groups where the user is a member
az ad user get-member-groups --id <email>
# Get roles assigned to the user
az role assignment list --include-groups --include-classic-administrators true --assignee <email>
```
{% endtab %}

{% tab title="Azure AD" %} 
### Azure AD

Azure AD is Microsoft's cloud-based identity and access management service. It allows organizations to manage user identities and create access policies to secure their resources. Azure AD provides features such as single sign-on, multi-factor authentication, and integration with thousands of SaaS applications. As a pentester, understanding Azure AD is crucial for assessing the security posture of an organization's cloud environment. 

#### Key Points to Consider:
- **User Identities**: Check for weak passwords, inactive accounts, and unnecessary privileges.
- **Access Policies**: Review access control settings and ensure they follow the principle of least privilege.
- **Authentication Methods**: Test multi-factor authentication implementations for effectiveness.
- **Integration with SaaS Applications**: Assess the security implications of integrating Azure AD with various SaaS applications.
- **Monitoring and Logging**: Look for any suspicious activities or misconfigurations in the Azure AD logs.

By focusing on these key areas, a pentester can identify security weaknesses in Azure AD and provide recommendations to enhance the overall security of the cloud environment. 
{% endtab %}
```powershell
# Enumerate Users
Get-AzureADUser -All $true
Get-AzureADUser -All $true | select UserPrincipalName
# Get info of 1 user
Get-AzureADUser -ObjectId test@corp.onmicrosoft.com | fl
# Search "admin" users
Get-AzureADUser -SearchString "admin" #Search admin at the begining of DisplayName or userPrincipalName
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"} #Search "admin" word in DisplayName
# Get all attributes of a user
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com|%{$_.PSObject.Properties.Name}
# Search attributes containing the word "password"
Get-AzureADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
# All users from AzureAD# All users from AzureAD
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All users synced from on-prem
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Objects created by a/any user
Get-AzureADUser [-ObjectId <email>] | Get-AzureADUserCreatedObject
# Devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Objects owned by a specific user
Get-AzureADUserOwnedObject -ObjectId test@corp.onmicrosoft.com
# Get groups & roles where the user is a member
Get-AzureADUserMembership -ObjectId 'test@corp.onmicrosoft.com'
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get devices registered by a user
Get-AzureADUserRegisteredDevice -ObjectId test@defcorphq.onmicrosoft.com
# Apps where a user has a role (role not shown)
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
# Get Administrative Units of a user
$userObj = Get-AzureADUser -Filter "UserPrincipalName eq 'bill@example.com'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where { $_.Id -eq $userObj.ObjectId } }
```
{% endtab %}

{% tab title="Az PowerShell" %}  
### Az PowerShell

Hierdie skakel bevat inligting oor hoe om Az PowerShell te gebruik vir die outentifisering teenoor Azure AD.  
Vir meer inligting, sien die [Az PowerShell-dokumentasie](https://docs.microsoft.com/en-us/powershell/azure/new-azureps-module-az?view=azps-6.0.0).  
{% endtab %}
```powershell
# Enumerate users
Get-AzADUser
# Get details of a user
Get-AzADUser -UserPrincipalName test@defcorphq.onmicrosoft.com
# Search user by string
Get-AzADUser -SearchString "admin" #Search at the beginnig of DisplayName
Get-AzADUser | ?{$_.Displayname -match "admin"}
# Get roles assigned to a user
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
```
{% endtab %}
{% endtabs %}

#### Verander Gebruiker Wagwoord

{% code overflow="wrap" %}
```powershell
$password = "ThisIsTheNewPassword.!123" | ConvertTo- SecureString -AsPlainText ‚ÄìForce

(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "victim@corp.onmicrosoft.com"}).ObjectId | Set- AzureADUserPassword -Password $password ‚ÄìVerbose
```
{% endcode %}

### MFA & Voorwaardelike Toegangsbeleide

Dit word sterk aanbeveel om MFA by elke gebruiker toe te voeg, maar sommige maatskappye sal dit nie instel nie of dit met 'n Voorwaardelike Toegang instel: Die gebruiker sal **vereis MFA as** dit inteken vanaf 'n spesifieke plek, webblaaier of **sekere toestand**. Hierdie beleide, as dit nie korrek geconfigureer word nie, kan vatbaar wees vir **omseilings**. Kontroleer:

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

### Groepe

{% tabs %}
{% tab title="az cli" %}
```powershell
# Enumerate groups
az ad group list
az ad group list --query "[].[displayName]" -o table
# Get info of 1 group
az ad group show --group <group>
# Get "admin" groups
az ad group list --query "[].displayName" | findstr /i "admin"
az ad group list --query "[?contains(displayName,'admin')].displayName"
# All groups from AzureAD
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi==null]"
az ad group list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All groups synced from on-prem
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi!=null]"
az ad group list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get members of group
az ad group member list --group <group> --query "[].userPrincipalName" -o table
# Check if member of group
az ad group member check --group "VM Admins" --member-id <id>
# Get which groups a group is member of
az ad group get-member-groups -g "VM Admins"
# Get Apps where a group has a role (role not shown)
Get-AzureADGroup -ObjectId <id> | Get-AzureADGroupAppRoleAssignment | fl *
```
{% endtab %}

{% tab title="Azure AD" %}

# Azure AD

Hier is 'n paar tegnieke wat jy kan gebruik om Azure AD te toets vir sekuriteitslekke:

- **Brute force-aanvalle:** Probeer om in te log met verskeie kombinasies van gebruikersname en wagwoorde.
- **Phishing-aanvalle:** Stuur valse e-posse wat lyk soos amptelike kennisgewings van Azure AD om inligting te bekom.
- **Token diefstal:** Probeer om toegangstokens te steel wat deur Azure AD uitgereik word om toegang tot hulpbronne te verkry.
- **Misbruik van API-eindpunte:** Identifiseer en misbruik swakke punte in API-eindpunte wat deur Azure AD blootgestel word.

Deur hierdie tegnieke te gebruik, kan jy die veiligheid van Azure AD evalueer en potensi√´le kwessies identifiseer voordat aanvallers dit kan uitbuit.

{% endtab %}
```powershell
# Enumerate Groups
Get-AzureADGroup -All $true
# Get info of 1 group
Get-AzADGroup -DisplayName <resource_group_name> | fl
# Get "admin" groups
Get-AzureADGroup -SearchString "admin" | fl #Groups starting by "admin"
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"} #Groups with the word "admin"
# Get groups allowing dynamic membership
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
# All groups that are from Azure AD
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All groups that are synced from on-prem (note that security groups are not synced)
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Get members of a group
Get-AzureADGroupMember -ObjectId <group_id>
# Get roles of group
Get-AzureADMSGroup -SearchString "Contoso_Helpdesk_Administrators" #Get group id
Get-AzureADMSRoleAssignment -Filter "principalId eq '69584002-b4d1-4055-9c94-320542efd653'"
# Get Administrative Units of a group
$groupObj = Get-AzureADGroup -Filter "displayname eq 'TestGroup'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where {$_.Id -eq $groupObj.ObjectId} }
```
{% endtab %}

{% tab title="Az PowerShell" %}  
### Az PowerShell

#### Install Az PowerShell Module

To interact with Azure AD using PowerShell, you need to install the Az PowerShell module. You can install the module by running the following command:

```powershell
Install-Module -Name Az -AllowClobber -Scope CurrentUser
```

#### Connect to Azure AD

After installing the Az PowerShell module, you can connect to Azure AD using the following command:

```powershell
Connect-AzAccount
```

This command will open a dialog box for you to enter your Azure credentials. Once authenticated, you will be connected to your Azure AD tenant.

#### List Azure AD Users

You can list all the users in your Azure AD tenant using the following command:

```powershell
Get-AzADUser
```

This command will return a list of all the users in your Azure AD tenant, including details such as UserPrincipalName, DisplayName, and ObjectId.

#### Get Azure AD User

To get information about a specific user in Azure AD, you can use the following command:

```powershell
Get-AzADUser -UserPrincipalName user@example.com
```

Replace `user@example.com` with the actual UserPrincipalName of the user you want to get information about.

#### Create Azure AD User

You can create a new user in Azure AD using the following command:

```powershell
New-AzADUser -DisplayName "John Doe" -UserPrincipalName john.doe@example.com -Password "P@ssw0rd"
```

Replace `John Doe`, `john.doe@example.com`, and `P@ssw0rd` with the desired display name, user principal name, and password for the new user.

#### Remove Azure AD User

To remove a user from Azure AD, you can use the following command:

```powershell
Remove-AzADUser -UserPrincipalName user@example.com
```

Replace `user@example.com` with the UserPrincipalName of the user you want to remove from Azure AD.

#### More Azure AD Operations

The Az PowerShell module provides a wide range of cmdlets for performing various operations on Azure AD, such as managing groups, applications, service principals, and more. Explore the cmdlets available in the Az PowerShell module to leverage the full power of Azure AD management through PowerShell.  
{% endtab %}
```powershell
# Get all groups
Get-AzADGroup
# Get details of a group
Get-AzADGroup -ObjectId <id>
# Search group by string
Get-AzADGroup -SearchString "admin" | fl * #Search at the beginnig of DisplayName
Get-AzADGroup |?{$_.Displayname -match "admin"}
# Get members of group
Get-AzADGroupMember -GroupDisplayName <resource_group_name>
# Get roles of group
Get-AzRoleAssignment -ResourceGroupName <resource_group_name>
```
#### Voeg gebruiker by groep

Eienaars van die groep kan nuwe gebruikers by die groep voeg
```powershell
Add-AzureADGroupMember -ObjectId <group_id> -RefObjectId <user_id> -Verbose
```
{% endcode %}

{% hint style="warning" %}
Groepe kan dinamies wees, wat basies beteken dat **as 'n gebruiker aan sekere voorwaardes voldoen, sal dit by 'n groep gevoeg word**. Natuurlik, as die voorwaardes gebaseer is op **eienskappe** wat 'n **gebruiker** kan **beheer**, kan hy hierdie kenmerk misbruik om **in ander groepe in te kom**.\
Kyk hoe om dinamiese groepe te misbruik op die volgende bladsy:
{% endhint %}

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

### Diensprinsepaal / Ondernemings Toepassings

{% hint style="info" %}
Let daarop dat 'n **Diensprinsepaal** in PowerShell terminologie **Ondernemings Toepassings** genoem word in die Azure portal (web).
{% endhint %}

{% tabs %}
{% tab title="az cli" %}
```bash
# Get Service Principals
az ad sp list --all
az ad sp list --all --query "[].[displayName]" -o table
# Get details of one SP
az ad sp show --id 00000000-0000-0000-0000-000000000000
# Search SP by string
az ad sp list --all --query "[?contains(displayName,'app')].displayName"
# Get owner of service principal
az ad sp owner list --id <id> --query "[].[displayName]" -o table
# Get service principals owned by the current user
az ad sp list --show-mine
# List apps that have password credentials
az ad sp list --all --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad sp list -all --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}

# Azure AD

## Azure AD Enumeration

During the enumeration phase, it is crucial to gather as much information as possible about the target Azure AD environment. This includes collecting data such as user accounts, groups, roles, permissions, and application registrations. The information gathered during enumeration will help in identifying potential security weaknesses and misconfigurations that could be exploited during the assessment.

### Tools for Azure AD Enumeration

There are several tools available that can assist in enumerating Azure AD resources. Some commonly used tools include:

- **Azure AD PowerShell Module**: This module provides cmdlets for managing Azure AD resources and can be used to gather information about users, groups, roles, and more.

- **Azure AD Graph API**: The Azure AD Graph API allows developers to interact with Azure AD resources programmatically and can be used to retrieve detailed information about users, groups, roles, and applications.

- **Microsoft Graph API**: The Microsoft Graph API is the newer version of the Azure AD Graph API and provides a unified programmability model that can be used to access a wide range of Microsoft 365 services, including Azure AD.

- **Azure AD Explorer**: This tool provides a graphical interface for exploring Azure AD resources and can be used to view and manipulate user accounts, groups, roles, and more.

By leveraging these tools, pentesters can effectively enumerate Azure AD resources and identify potential security issues that may exist within the environment.

## Azure AD Exploitation

Once the enumeration phase is complete and potential security weaknesses have been identified, the next step is to exploit these vulnerabilities to demonstrate their impact on the target Azure AD environment. This may involve techniques such as password spraying, phishing attacks, privilege escalation, or abusing misconfigured permissions.

### Best Practices for Azure AD Exploitation

When conducting Azure AD exploitation, it is important to follow best practices to minimize the risk of causing disruptions to the target environment. Some key best practices include:

- **Obtain Proper Authorization**: Ensure that you have explicit permission to conduct exploitation activities within the Azure AD environment.

- **Document Findings**: Keep detailed records of the vulnerabilities identified and the exploitation techniques used during the assessment.

- **Limit Impact**: Take precautions to limit the impact of exploitation activities on the target environment to avoid causing disruptions to critical services.

By following these best practices, pentesters can effectively demonstrate the impact of security weaknesses within the Azure AD environment while minimizing the risk of unintended consequences.

{% endtab %}
```powershell
# Get Service Principals
Get-AzureADServicePrincipal -All $true
# Get details about a SP
Get-AzureADServicePrincipal -ObjectId <id> | fl *
# Get SP by string name or Id
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"} | fl
Get-AzureADServicePrincipal -All $true | ?{$_.AppId -match "103947652-1234-5834-103846517389"}
# Get owner of SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwner |fl *
# Get objects owned by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwnedObject
# Get objects created by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalCreatedObject
# Get groups where the SP is a member
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalMembership |fl *
```
{% endtab %}

{% tab title="Az PowerShell" %}  
### Az PowerShell

Hierdie gids demonstreer hoe om te gebruik Az PowerShell module om te interaksie met Azure AD.  
Die volgende stappe sal jou help om aan te meld by Azure AD, gebruikersinligting op te haal, en meer.  
```powershell
# Installeer die Az PowerShell module
Install-Module -Name Az -AllowClobber -Scope CurrentUser -Force

# Meld aan by jou Azure-rekening
Connect-AzAccount

# Haal die lys van alle gebruikers in Azure AD
Get-AzADUser
```
  
Vir meer inligting, sien [Az PowerShell dokumentasie](https://docs.microsoft.com/en-us/powershell/azure/new-azureps-module-az?view=azps-6.0.0).  
{% endtab %}
```powershell
# Get SPs
Get-AzADServicePrincipal
# Get info of 1 SP
Get-AzADServicePrincipal -ObjectId <id>
# Search SP by string
Get-AzADServicePrincipal | ?{$_.DisplayName -match "app"}
# Get roles of a SP
Get-AzRoleAssignment -ServicePrincipalName <String>
```
{% endtab %}

{% tab title="Raw" %}Die volgende is 'n lys van moontlike aanvalle teen Azure AD en hoe om dit te vermy:

1. **Brute Force-aanvalle**: Stel sterk wagwoorde in en aktiveer MFA.
2. **Phishing-aanvalle**: Verskaf opleiding aan gebruikers en implementeer e-pos beskerming.
3. **Token-diefstal**: Gebruik tokenbinding en aktiveer Conditional Access.
4. **Onveilige programmeerpraktyke**: Deurlopende kodehersiening en gebruik van beveiligde biblioteke.
5. **Onvoldoende toegangsbeheer**: Monitor gebruikersaktiwiteit en implementeer 'n beginsel van minste bevoorregting.
6. **Onvoldoende monitering en loggin**: Stel waarskuwings in vir verdagte aktiwiteit en monitor loggebeure gereeld.
7. **Onvoldoende beplanning vir herstel na ramp**: Maak gereelde rugsteune en toets herstelplanne.

Deur hierdie maatre√´ls te implementeer, kan jy die veiligheid van jou Azure AD-omgewing verhoog en potensi√´le aanvalle voorkom.{% endtab %}
```powershell
$Token = 'eyJ0eX..'
$URI = 'https://graph.microsoft.com/v1.0/applications'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
Die eienaar van 'n Diensprinsipaalkan sy wagwoord verander.
{% endhint %}

<details>

<summary>Lys en probeer om 'n klientgeheim by elke Ondernemingsprogram by te voeg</summary>
```powershell
# Just call Add-AzADAppSecret
Function Add-AzADAppSecret
{
<#
.SYNOPSIS
Add client secret to the applications.

.PARAMETER GraphToken
Pass the Graph API Token

.EXAMPLE
PS C:\> Add-AzADAppSecret -GraphToken 'eyJ0eX..'

.LINK
https://docs.microsoft.com/en-us/graph/api/application-list?view=graph-rest-1.0&tabs=http
https://docs.microsoft.com/en-us/graph/api/application-addpassword?view=graph-rest-1.0&tabs=http
#>

[CmdletBinding()]
param(
[Parameter(Mandatory=$True)]
[String]
$GraphToken = $null
)

$AppList = $null
$AppPassword = $null

# List All the Applications

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications"
"Method"  = "GET"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

try
{
$AppList = Invoke-RestMethod @Params -UseBasicParsing
}
catch
{
}

# Add Password in the Application

if($AppList -ne $null)
{
[System.Collections.ArrayList]$Details = @()

foreach($App in $AppList.value)
{
$ID = $App.ID
$psobj = New-Object PSObject

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications/$ID/addPassword"
"Method"  = "POST"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

$Body = @{
"passwordCredential"= @{
"displayName" = "Password"
}
}

try
{
$AppPassword = Invoke-RestMethod @Params -UseBasicParsing -Body ($Body | ConvertTo-Json)
Add-Member -InputObject $psobj -NotePropertyName "Object ID" -NotePropertyValue $ID
Add-Member -InputObject $psobj -NotePropertyName "App ID" -NotePropertyValue $App.appId
Add-Member -InputObject $psobj -NotePropertyName "App Name" -NotePropertyValue $App.displayName
Add-Member -InputObject $psobj -NotePropertyName "Key ID" -NotePropertyValue $AppPassword.keyId
Add-Member -InputObject $psobj -NotePropertyName "Secret" -NotePropertyValue $AppPassword.secretText
$Details.Add($psobj) | Out-Null
}
catch
{
Write-Output "Failed to add new client secret to '$($App.displayName)' Application."
}
}
if($Details -ne $null)
{
Write-Output ""
Write-Output "Client secret added to : "
Write-Output $Details | fl *
}
}
else
{
Write-Output "Failed to Enumerate the Applications."
}
}
```
</details>

### Rolle

{% tabs %}
{% tab title="az cli" %}
```bash
# Get roles
az role definition list
# Get assigned roles
az role assignment list --all --query "[].roleDefinitionName"
az role assignment list --all | jq '.[] | .roleDefinitionName,.scope'
# Get info of 1 role
az role definition list --name "AzureML Registry User"
# Get only custom roles
az role definition list --custom-role-only
# Get only roles assigned to the resource group indicated
az role definition list --resource-group <resource_group>
# Get only roles assigned to the indicated scope
az role definition list --scope <scope>
# Get all the principals a role is assigned to
az role assignment list --all --query "[].{principalName:principalName,principalType:principalType,resourceGroup:resourceGroup,roleDefinitionName:roleDefinitionName}[?roleDefinitionName=='<ROLE_NAME>']"
```
{% endtab %}

{% tab title="Azure AD" %} 
### Azure AD

Azure AD is Microsoft's cloud-based identity and access management service. It allows organizations to manage users and provide secure access to resources in the cloud. Azure AD provides features such as single sign-on, multi-factor authentication, and role-based access control.

#### Enumeration

When conducting a penetration test against Azure AD, enumeration is a crucial phase. Enumerating users, groups, roles, and permissions can help identify potential security weaknesses and misconfigurations in the Azure AD environment.

#### Tools

There are several tools available for enumerating Azure AD resources during a penetration test. Some popular tools include:
- **Azure AD PowerShell Module**: Allows you to manage Azure AD resources using PowerShell cmdlets.
- **Azure AD Graph API**: Provides programmatic access to Azure AD resources for automation and integration purposes.
- **Azure AD Explorer**: A graphical tool for exploring Azure AD resources and permissions.

#### Best Practices

To secure Azure AD and prevent unauthorized access, organizations should follow best practices such as:
- Enforcing strong password policies.
- Implementing multi-factor authentication.
- Regularly reviewing and updating user permissions.
- Monitoring Azure AD logs for suspicious activities.

By following these best practices, organizations can enhance the security of their Azure AD environment and protect sensitive data from unauthorized access. 
{% endtab %}
```powershell
# Get all available role templates
Get-AzureADDirectoryroleTemplate
# Get enabled roles (Assigned roles)
Get-AzureADDirectoryRole
Get-AzureADDirectoryRole -ObjectId <roleID> #Get info about the role
# Get custom roles - use AzureAdPreview
Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
# Users assigned a role (Global Administrator)
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
Get-AzureADDirectoryRole -ObjectId <id> | fl
# Roles of the Administrative Unit (who has permissions over the administrative unit and its members)
Get-AzureADMSScopedRoleMembership -Id <id> | fl *
```
{% endtab %}

{% tab title="Az PowerShell" %}  
### Az PowerShell

#### Install Az PowerShell Module

To interact with Azure AD using PowerShell, you need to install the Az PowerShell module. You can install the module by running the following command:

```powershell
Install-Module -Name Az -AllowClobber -Scope CurrentUser
```

#### Connect to Azure AD

After installing the Az PowerShell module, you can connect to Azure AD using the following command:

```powershell
Connect-AzAccount
```

This command will open a dialog box for you to enter your Azure AD credentials. Once authenticated, you will be connected to your Azure AD tenant.

#### List Azure AD Users

You can list all the users in your Azure AD tenant using the following command:

```powershell
Get-AzADUser
```

This command will return a list of all the users in your Azure AD tenant, including their display names, object IDs, and other relevant information.

#### Get Azure AD User

To get information about a specific user in Azure AD, you can use the following command:

```powershell
Get-AzADUser -UserPrincipalName user@example.com
```

Replace `user@example.com` with the user's actual UPN (User Principal Name) to retrieve information about that specific user.

#### Create Azure AD User

You can create a new user in Azure AD using the following command:

```powershell
New-AzADUser -DisplayName "John Doe" -UserPrincipalName john.doe@example.com -Password "P@ssw0rd123"
```

This command will create a new user with the specified display name, UPN, and password.

#### Update Azure AD User

To update an existing user in Azure AD, you can use the following command:

```powershell
Set-AzADUser -UserPrincipalName user@example.com -DisplayName "Jane Smith"
```

Replace `user@example.com` with the user's UPN and update the display name as needed.

#### Remove Azure AD User

To remove a user from Azure AD, you can use the following command:

```powershell
Remove-AzADUser -UserPrincipalName user@example.com
```

Replace `user@example.com` with the UPN of the user you want to remove from Azure AD.  
{% endtab %}
```powershell
# Get role assignments on the subscription
Get-AzRoleDefinition
# Get Role definition
Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
# Get roles of a user or resource
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/<res_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>
```
{% endtab %}

{% tab title="Vertaal" %}
Hierdie gids demonstreer hoe om 'n Azure AD-aanval te loods deur die gebruik van 'n vervalste webwerf om aanmeldingsinligting te steel. Dit wys ook hoe om 'n vals webwerf te skep en te hospiteer op 'n Azure-webwerf. Die aanval maak gebruik van 'n vervalste webwerf om aanmeldingsinligting te steel en 'n oorspronklike webwerf na te boots. Dit is 'n effektiewe tegniek vir sosiale ingenieurswese en kan gebruik word vir phising-aanvalle. 
{% endtab %}
```powershell
# Get permissions over a resource using ARM directly
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
### Toestelle

{% tabs %}
{% tab title="az cli" %}
```bash
# If you know how to do this send a PR!
```
{% endtab %}

{% tab title="Azure AD" %} 
### Azure AD

Azure AD is Microsoft's cloud-based identity and access management service. It allows organizations to manage users and provide secure access to resources in the cloud. Azure AD provides features such as single sign-on, multi-factor authentication, and role-based access control.

#### Security Best Practices

- Enable multi-factor authentication for all users.
- Regularly review and audit user permissions.
- Implement conditional access policies to control access based on specific conditions.
- Monitor sign-in logs for suspicious activity.
- Enable password protection to prevent weak passwords.
- Use Azure AD Privileged Identity Management to manage, control, and monitor access within Azure AD.
{% endtab %}
```powershell
# Enumerate Devices
Get-AzureADDevice -All $true | fl *
# List all the active devices (and not the stale devices)
Get-AzureADDevice -All $true | ?{$_.ApproximateLastLogonTimeStamp -ne $null}
# Get owners of all devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Registred users of all the devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Get dives managed using Intune
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get Administrative Units of a device
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -ObjectId $_.ObjectId | where {$_.ObjectId -eq $deviceObjId} }
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
Indien 'n toestel (VM) **AzureAD-gekoppel** is, sal gebruikers van AzureAD **kan aanmeld**.\
Verder, as die aangemelde gebruiker die **Eienaar** van die toestel is, sal hy 'n **plaaslike admin** wees.
{% endhint %}

### Aansoeke

{% hint style="info" %}
**Apps** is **App-registrasies** in die portaal (nie Ondernemingsaansoeke).\
Maar elke App-registrasie sal 'n **Ondernemingsaansoek** (**Diensprinsipaal**) met dieselfde naam skep.\
Verder, as die App 'n **multi-huurder App** is, sal **nog 'n** Ondernemingsaansoek (**Diensprinsipaal**) in **daardie huurder** met dieselfde naam geskep word.
{% endhint %}

Wanneer 'n App gegenereer word, word 2 tipes toestemmings gegee:

* **Toestemmings** wat aan die **Diensprinsipaal** gegee word
* **Toestemmings** wat die **app** kan h√™ en gebruik namens die gebruiker.
```bash
# List Apps
az ad app list
az ad app list --query "[].[displayName]" -o table
# Get info of 1 App
az ad app show --id 00000000-0000-0000-0000-000000000000
# Search App by string
az ad app list --query "[?contains(displayName,'app')].displayName"
# Get the owner of an application
az ad app owner list --id <id> --query "[].[displayName]" -o table
# List all the apps with an application password
az ad app list --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad app list --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}

# Azure AD

## Azure AD Enumeration

### User Enumeration

To enumerate users in Azure AD, you can use tools like `Azure AD Recon` or `Azure AD User Enumeration`.

#### Azure AD Recon

1. Install Azure AD Recon tool.
2. Run the tool with the necessary parameters.
3. Enumerate users in Azure AD.

#### Azure AD User Enumeration

1. Use Azure AD User Enumeration tool.
2. Provide required inputs.
3. Enumerate users in Azure AD.

### Group Enumeration

To enumerate groups in Azure AD, you can use tools like `Azure AD Recon` or `Azure AD Group Enumeration`.

#### Azure AD Recon

1. Install Azure AD Recon tool.
2. Run the tool with the necessary parameters.
3. Enumerate groups in Azure AD.

#### Azure AD Group Enumeration

1. Use Azure AD Group Enumeration tool.
2. Provide required inputs.
3. Enumerate groups in Azure AD.

### Device Enumeration

To enumerate devices in Azure AD, you can use tools like `Azure AD Recon` or `Azure AD Device Enumeration`.

#### Azure AD Recon

1. Install Azure AD Recon tool.
2. Run the tool with the necessary parameters.
3. Enumerate devices in Azure AD.

#### Azure AD Device Enumeration

1. Use Azure AD Device Enumeration tool.
2. Provide required inputs.
3. Enumerate devices in Azure AD.

## Azure AD Exploitation

### Password Spraying

To perform password spraying attacks in Azure AD, you can use tools like `Spray` or `Azure AD Password Sprtoolsaying`.

#### Spray

1. Install Spray tool.
2. Run the tool with the necessary parameters.
3. Perform password spraying attacks in Azure AD.

#### Azure AD Password Sprtoolsaying

1. Use Azure AD Password Sprtoolsaying tool.
2. Provide required inputs.
3. Perform password spraying attacks in Azure AD.

### Phishing

To conduct phishing attacks in Azure AD, you can use tools like `Phish` or `Azure AD Phishing Kit`.

#### Phish

1. Install Phish tool.
2. Run the tool with the necessary parameters.
3. Conduct phishing attacks in Azure AD.

#### Azure AD Phishing Kit

1. Use Azure AD Phishing Kit tool.
2. Provide required inputs.
3. Conduct phishing attacks in Azure AD.

### Token Impersonation

To perform token impersonation in Azure AD, you can use tools like `TokenImp` or `Azure AD Token Impersonation`.

#### TokenImp

1. Install TokenImp tool.
2. Run the tool with the necessary parameters.
3. Perform token impersonation in Azure AD.

#### Azure AD Token Impersonation

1. Use Azure AD Token Impersonation tool.
2. Provide required inputs.
3. Perform token impersonation in Azure AD.

{% endtab %}
```powershell
# List all registered applications
Get-AzureADApplication -All $true
# Get details of an application
Get-AzureADApplication -ObjectId <id>  | fl *
# List all the apps with an application password
Get-AzureADApplication -All $true | %{if(Get-AzureADApplicationPasswordCredential -ObjectID $_.ObjectID){$_}}
# Get owner of an application
Get-AzureADApplication -ObjectId <id> | Get-AzureADApplicationOwner |fl *
```
{% endtab %}

{% tab title="Az PowerShell" %}  
### Az PowerShell

Hierdie gids bevat inligting oor hoe om te werk met Azure AD met behulp van Az PowerShell-module.  
Dit sluit in die installering van die Az PowerShell-module, die instelling van die korrekte beleide en die uitvoering van verskeie take soos die skep van gebruikers en groepe, die toewysing van rolle, en nog baie meer.  
Volg die stappe in hierdie gids om te leer hoe om Azure AD te bestuur met behulp van Az PowerShell.  
{% endtab %}
```powershell
# Get Apps
Get-AzADApplication
# Get details of one App
Get-AzADApplication -ObjectId <id>
# Get App searching by string
Get-AzADApplication | ?{$_.DisplayName -match "app"}
# Get Apps with password
Get-AzADAppCredential
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
'n Toepassing met die toestemming **`AppRoleAssignment.ReadWrite`** kan **opklim na 'n Globale Admin** deur homself die rol toe te ken.\
Vir meer inligting [**kyk hierdie**](https://posts.specterops.io/azure-privilege-escalation-via-azure-api-permissions-abuse-74aee1006f48).
{% endhint %}

{% hint style="info" %}
'n Geheime string wat die aansoek gebruik om sy identiteit te bewys wanneer dit 'n token aanvra, is die aansoek wagwoord.\
Dus, as jy hierdie **wagwoord** vind, kan jy toegang kry as die **diensprinsipaal** **binne** die **huurder**.\
Let daarop dat hierdie wagwoord slegs sigbaar is wanneer dit gegenereer word (jy kan dit verander, maar jy kan dit nie weer kry nie).\
Die **eienaar** van die **aansoek** kan 'n wagwoord daaraan **toevoeg** (sodat hy dit kan impersoneer).\
Aanmeldings as hierdie diensprinsipale word **nie gemerk as risikovol** nie en hulle **sal nie MFA h√™ nie.**
{% endhint %}

### Verskil Toepassings & (Ondernemings Toepassings of Diensprinsipale)

Verskil tussen 'n toepassing en 'n Diensprinsipaal in Azure:

* **Toepassing/App Registrasies**: Is toepassings wat in jou Azure AD bestaan
* `(Get-AzureADApplication -filter "DisplayName eq 'testapp'")`
* **Diensprinsipaal/Ondernemings Toepassings**: Sekuriteitsvoorwerpe in jou Azure AD wat **bevoegdhede** in die Azure-gids kan h√™ en gekoppel is aan jou toepassing of 'n derdeparty-toepassing
* `Get-AzureADServicePrincipal -filter "DisplayName eq 'testapp'")`
* 'n Admin mag die gegee toestemmings moet goedkeur as hulle baie sensitief is.

'n Toepassing kan 'n **Derdeparty-huurder** bedryf en sodra jy dit begin gebruik en dit toegang gee, word 'n **Ondernemings Toepassing/Diensprinsipaal in jou huurder** geskep om dit toegang te gee tot die inligting wat dit benodig:

### Administratiewe Eenhede

Dit word gebruik vir beter bestuur van gebruikers.

Administratiewe eenhede **beperk toestemmings in 'n rol tot enige deel van jou organisasie** wat jy definieer. Jy kan byvoorbeeld administratiewe eenhede gebruik om die [Helpdesk-administrator](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#helpdesk-administrator) rol te delegeer aan streekondersteuningspesialiste, sodat hulle slegs gebruikers in die streek wat hulle ondersteun, kan bestuur.

Daarom kan jy rolle aan die administratiewe eenheid toeken en lede daarvan sal hierdie rolle h√™.
```
```
{% endtab %}

{% tab title="AzureAD" %} 
### Azure AD Enumeration

#### User Enumeration

1. **Enumerate Users**: Use tools like `Azure AD Connect` or `PowerShell` scripts to enumerate users in Azure AD.
2. **Check User Attributes**: Look for sensitive user attributes like `UserPrincipalName`, `Mail`, `ProxyAddresses`, etc.
3. **User Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate users and their attributes.

#### Group Enumeration

1. **Enumerate Groups**: Enumerate groups in Azure AD using tools like `Azure AD Graph Explorer`.
2. **Check Group Membership**: Verify group membership to identify privileged groups.
3. **Group Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate groups and their members.

#### Device Enumeration

1. **Enumerate Devices**: Use tools like `Azure AD Connect` or `PowerShell` scripts to enumerate devices in Azure AD.
2. **Check Device Attributes**: Look for device attributes like `DeviceID`, `DeviceOSType`, `DeviceOSVersion`, etc.
3. **Device Enumeration via Graph API**: Utiljsoneer devices and their attributes using Azure AD Graph API.

#### Application Enumeration

1. **Enumerate Applications**: Enumerate applications registered in Azure AD using tools like `Azure Portal`.
2. **Check Application Permissions**: Review application permissions to identify potentially risky configurations.
3. **Application Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate applications and their permissions.

#### Service Principal Enumeration

1. **Enumerate Service Principals**: Enumerate service principals in Azure AD using tools like `PowerShell` scripts.
2. **Check Service Principal Permissions**: Review service principal permissions to identify potential misconfigurations.
3. **Service Principal Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate service principals and their permissions.

#### Domain Enumeration

1. **Enumerate Domains**: Enumerate domains associated with Azure AD using tools like `Azure Portal`.
2. **Check Domain Configuration**: Review domain configurations to identify security weaknesses.
3. **Domain Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate domains and their configurations.

#### Role Enumeration

1. **Enumerate Roles**: Enumerate roles assigned in Azure AD using tools like `Azure Portal`.
2. **Check Role Permissions**: Review role permissions to identify overprivileged roles.
3. **Role Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate roles and their permissions.

#### Policy Enumeration

1. **Enumerate Policies**: Enumerate policies configured in Azure AD using tools like `Azure Portal`.
2. **Check Policy Settings**: Review policy settings to identify any misconfigurations or weaknesses.
3. **Policy Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate policies and their settings.

#### Security Enumeration

1. **Enumerate Security Settings**: Enumerate security settings in Azure AD to identify potential security gaps.
2. **Check Security Configurations**: Review security configurations to ensure best security practices are followed.
3. **Security Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate security settings and configurations.

#### Risk Enumeration

1. **Enumerate Risks**: Enumerate risks associated with Azure AD using tools like `Azure Security Center`.
2. **Check Risk Details**: Review risk details to understand potential security risks.
3. **Risk Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate risks and their details.

#### Log Enumeration

1. **Enumerate Logs**: Enumerate logs related to Azure AD activities for monitoring and analysis.
2. **Check Log Details**: Review log details to identify any suspicious activities or anomalies.
3. **Log Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate logs and their details.

#### Audit Enumeration

1. **Enumerate Audits**: Enumerate audit logs in Azure AD for tracking changes and activities.
2. **Check Audit Details**: Review audit log details to ensure compliance and security.
3. **Audit Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate audit logs and their details.

#### Token Enumeration

1. **Enumerate Tokens**: Enumerate tokens issued by Azure AD for authentication and authorization.
2. **Check Token Details**: Review token details to ensure secure token usage.
3. **Token Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate tokens and their details.

#### Key Enumeration

1. **Enumerate Keys**: Enumerate keys used for encryption and decryption in Azure AD.
2. **Check Key Details**: Review key details to ensure proper key management practices.
3. **Key Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate keys and their details.

#### Certificate Enumeration

1. **Enumerate Certificates**: Enumerate certificates used for secure communication in Azure AD.
2. **Check Certificate Details**: Review certificate details to ensure valid and secure certificates are in use.
3. **Certificate Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate certificates and their details.

#### Endpoint Enumeration

1. **Enumerate Endpoints**: Enumerate endpoints used for Azure AD services and integrations.
2. **Check Endpoint Details**: Review endpoint details to identify any vulnerabilities or misconfigurations.
3. **Endpoint Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate endpoints and their configurations.

#### API Enumeration

1. **Enumerate APIs**: Enumerate APIs exposed by Azure AD for integrations and access.
2. **Check API Permissions**: Review API permissions to ensure secure API usage.
3. **API Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate APIs and their permissions.

#### Scope Enumeration

1. **Enumerate Scopes**: Enumerate scopes defined in Azure AD for access control.
2. **Check Scope Permissions**: Review scope permissions to ensure proper access control.
3. **Scope Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate scopes and their permissions.

#### Trust Enumeration

1. **Enumerate Trusts**: Enumerate trusts established with other entities in Azure AD.
2. **Check Trust Details**: Review trust details to ensure secure and valid trust relationships.
3. **Trust Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate trusts and their details.

#### Configuration Enumeration

1. **Enumerate Configurations**: Enumerate configurations set up in Azure AD for various services and features.
2. **Check Configuration Settings**: Review configuration settings to identify any insecure configurations.
3. **Configuration Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate configurations and their settings.

#### Permission Enumeration

1. **Enumerate Permissions**: Enumerate permissions granted within Azure AD for different entities.
2. **Check Permission Details**: Review permission details to ensure least privilege access.
3. **Permission Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate permissions and their details.

#### Secret Enumeration

1. **Enumerate Secrets**: Enumerate secrets used within Azure AD for secure data storage and access.
2. **Check Secret Management**: Review secret management practices to prevent unauthorized access.
3. **Secret Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate secrets and their usage.

#### Blob Enumeration

1. **Enumerate Blobs**: Enumerate blobs stored within Azure AD for data storage and retrieval.
2. **Check Blob Details**: Review blob details to ensure data security and integrity.
3. **Blob Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate blobs and their details.

#### Query Enumeration

1. **Enumerate Queries**: Enumerate queries performed within Azure AD for data retrieval and analysis.
2. **Check Query Results**: Review query results to identify any anomalies or suspicious activities.
3. **Query Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate queries and their results.

#### Backup Enumeration

1. **Enumerate Backups**: Enumerate backups taken for Azure AD data protection and recovery.
2. **Check Backup Details**: Review backup details to ensure data availability and integrity.
3. **Backup Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate backups and their details.

#### Recovery Enumeration

1. **Enumerate Recovery Options**: Enumerate recovery options available for Azure AD data recovery.
2. **Check Recovery Procedures**: Review recovery procedures to ensure timely and effective data recovery.
3. **Recovery Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate recovery options and procedures.

#### Monitoring Enumeration

1. **Enumerate Monitoring Tools**: Enumerate monitoring tools used for Azure AD security monitoring.
2. **Check Monitoring Alerts**: Review monitoring alerts to detect and respond to security incidents.
3. **Monitoring Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate monitoring tools and alerts.

#### Compliance Enumeration

1. **Enumerate Compliance Standards**: Enumerate compliance standards applicable to Azure AD.
2. **Check Compliance Status**: Review compliance status to ensure adherence to regulatory requirements.
3. **Compliance Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate compliance standards and status.

#### Report Enumeration

1. **Enumerate Reports**: Enumerate reports generated for Azure AD activities and security assessments.
2. **Check Report Details**: Review report details to identify security trends and areas for improvement.
3. **Report Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate reports and their details.

#### Notification Enumeration

1. **Enumerate Notifications**: Enumerate notifications configured for Azure AD security events.
2. **Check Notification Settings**: Review notification settings to ensure timely alerts for security incidents.
3. **Notification Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate notifications and their settings.

#### Integration Enumeration

1. **Enumerate Integrations**: Enumerate integrations with other services and platforms within Azure AD.
2. **Check Integration Details**: Review integration details to identify any security implications.
3. **Integration Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate integrations and their configurations.

#### Vulnerability Enumeration

1. **Enumerate Vulnerabilities**: Enumerate vulnerabilities identified within Azure AD for remediation.
2. **Check Vulnerability Details**: Review vulnerability details to prioritize and address security weaknesses.
3. **Vulnerability Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate vulnerabilities and their details.

#### Exploit Enumeration

1. **Enumerate Exploits**: Enumerate potential exploits targeting Azure AD for security testing.
2. **Check Exploit Techniques**: Review exploit techniques to understand attack vectors and mitigation strategies.
3. **Exploit Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate exploits and their methods.

#### Patch Enumeration

1. **Enumerate Patches**: Enumerate patches applied to Azure AD for security updates.
2. **Check Patch Details**: Review patch details to ensure timely application of security fixes.
3. **Patch Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate patches and their details.

#### Configuration Enumeration

1. **Enumerate Configurations**: Enumerate configurations set up in Azure AD for various services and features.
2. **Check Configuration Settings**: Review configuration settings to identify any insecure configurations.
3. **Configuration Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate configurations and their settings.

#### Hardening Enumeration

1. **Enumerate Hardening Measures**: Enumerate hardening measures implemented in Azure AD for security enhancement.
2. **Check Hardening Status**: Review hardening status to ensure robust security posture.
3. **Hardening Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate hardening measures and their status.

#### Authentication Enumeration

1. **Enumerate Authentication Methods**: Enumerate authentication methods available in Azure AD for user access.
2. **Check Authentication Protocols**: Review authentication protocols to ensure secure user authentication.
3. **Authentication Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate authentication methods and protocols.

#### Authorization Enumeration

1. **Enumerate Authorization Policies**: Enumerate authorization policies defined in Azure AD for access control.
2. **Check Authorization Rules**: Review authorization rules to ensure proper access management.
3. **Authorization Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate authorization policies and rules.

#### Encryption Enumeration

1. **Enumerate Encryption Methods**: Enumerate encryption methods used in Azure AD for data protection.
2. **Check Encryption Algorithms**: Review encryption algorithms to ensure strong data encryption.
3. **Encryption Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate encryption methods and algorithms.

#### Decryption Enumeration

1. **Enumerate Decryption Processes**: Enumerate decryption processes used in Azure AD for data access.
2. **Check Decryption Keys**: Review decryption keys to ensure secure data decryption.
3. **Decryption Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate decryption processes and keys.

#### Firewall Enumeration

1. **Enumerate Firewalls**: Enumerate firewalls configured for Azure AD network security.
2. **Check Firewall Rules**: Review firewall rules to prevent unauthorized access and data exfiltration.
3. **Firewall Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate firewalls and their rules.

#### Intrusion Detection Enumeration

1. **Enumerate Intrusion Detection Systems**: Enumerate intrusion detection systems used for Azure AD security monitoring.
2. **Check IDS Alerts**: Review IDS alerts to detect and respond to potential intrusions.
3. **Intrusion Detection Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate intrusion detection systems and alerts.

#### Intrusion Prevention Enumeration

1. **Enumerate Intrusion Prevention Systems**: Enumate intrusion prevention systems implemented in Azure AD for threat mitigation.
2. **Check IPS Configurations**: Review IPS configurations to prevent and block malicious activities.
3. **Intrusion Prevention Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate intrusion prevention systems and configurations.

#### Threat Intelligence Enumeration

1. **Enumerate Threat Intelligence Feeds**: Enumerate threat intelligence feeds integrated with Azure AD for threat awareness.
2. **Check Threat Indicators**: Review threat indicators to proactively defend against potential threats.
3. **Threat Intelligence Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate threat intelligence feeds and indicators.

#### Incident Response Enumeration

1. **Enumerate Incident Response Plans**: Enumerate incident response plans established for Azure AD security incidents.
2. **Check IR Procedures**: Review incident response procedures to ensure timely and effective incident handling.
3. **Incident Response Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate incident response plans and procedures.

#### Forensics Enumeration

1. **Enumerate Forensics Tools**: Enumerate forensics tools available for investigating security incidents in Azure AD.
2. **Check Forensics Procedures**: Review forensics procedures to gather and analyze digital evidence.
3. **Forensics Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate forensics tools and procedures.

#### Social Engineering Enumeration

1. **Enumerate Social Engineering Tactics**: Enumerate social engineering tactics used for Azure AD user manipulation.
2. **Check Social Engineering Awareness**: Review social engineering awareness to educate users on potential risks.
3. **Social Engineering Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate social engineering tactics and awareness.

#### Phishing Enumeration

1. **Enumerate Phishing Attacks**: Enumerate phishing attacks targeting Azure AD users for credential theft.
2. **Check Phishing Indicators**: Review phishing indicators to identify and mitigate phishing threats.
3. **Phishing Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate phishing attacks and indicators.

#### Malware Enumeration

1. **Enumerate Malware Signatures**: Enumerate malware signatures detected within Azure AD for malware prevention.
2. **Check Malware Behavior**: Review malware behavior to detect and block malicious activities.
3. **Malware Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate malware signatures and behavior.

#### Ransomware Enumeration

1. **Enumerate Ransomware Variants**: Enumerate ransomware variants targeting Azure AD for ransomware protection.
2. **Check Ransomware Trends**: Review ransomware trends to prevent and respond to ransomware attacks.
3. **Ransomware Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate ransomware variants and trends.

#### Data Loss Prevention Enumeration

1. **Enumerate DLP Policies**: Enumerate data loss prevention policies implemented in Azure AD for data protection.
2. **Check DLP Rules**: Review DLP rules to prevent unauthorized data disclosure.
3. **DLP Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate DLP policies and rules.

#### Insider Threat Enumeration

1. **Enumerate Insider Threat Indicators**: Enumerate insider threat indicators within Azure AD for insider threat detection.
2. **Check Insider Threat Alerts**: Review insider threat alerts to prevent insider attacks.
3. **Insider Threat Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate insider threat indicators and alerts.

#### Zero Trust Enumeration

1. **Enumerate Zero Trust Principles**: Enumerate zero trust principles applied in Azure AD for enhanced security.
2. **Check Zero Trust Implementation**: Review zero trust implementation to ensure strict access controls.
3. **Zero Trust Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate zero trust principles and implementation.

#### AI Enumeration

1. **Enumerate AI Algorithms**: Enumerate AI algorithms utilized for threat detection and analysis in Azure AD.
2. **Check AI Models**: Review AI models to enhance security intelligence and automation.
3. **AI Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate AI algorithms and models.

#### IoT Enumeration

1. **Enumerate IoT Devices**: Enumerate IoT devices integrated with Azure AD for device management.
2. **Check IoT Security**: Review IoT security measures to prevent IoT-related threats.
3. **IoT Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate IoT devices and security measures.

#### Blockchain Enumeration

1. **Enumerate Blockchain Transactions**: Enumerate blockchain transactions recorded within Azure AD for data integrity.
2. **Check Blockchain Security**: Review blockchain security to ensure tamper-proof data storage.
3. **Blockchain Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate blockchain transactions and security.

#### Quantum Computing Enumeration

1. **Enumerate Quantum Computing Risks**: Enumerate quantum computing risks affecting Azure AD encryption.
2. **Check Quantum-Resistant Algorithms**: Review quantum-resistant algorithms to protect against quantum threats.
3. **Quantum Computing Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate quantum computing risks and algorithms.

#### Cloud Enumeration

1. **Enumerate Cloud Services**: Enumerate cloud services integrated with Azure AD for seamless operations.
2. **Check Cloud Security**: Review cloud security measures to ensure data protection and compliance.
3. **Cloud Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate cloud services and security controls.

#### SaaS Enumeration

1. **Enumerate SaaS Applications**: Enumerate SaaS applications utilized within Azure AD for productivity and collaboration.
2. **Check SaaS Security**: Review SaaS security configurations to prevent data leaks and unauthorized access.
3. **SaaS Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate SaaS applications and security settings.

#### PaaS Enumeration

1. **Enumerate PaaS Solutions**: Enumerate PaaS solutions deployed on Azure AD for application development.
2. **Check PaaS Security**: Review PaaS security measures to protect applications and data.
3. **PaaS Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate PaaS solutions and security features.

#### IaaS Enumeration

1. **Enumerate IaaS Resources**: Enumerate IaaS resources provisioned within Azure AD for infrastructure management.
2. **Check IaaS Configurations**: Review IaaS configurations to ensure scalable and secure infrastructure.
3. **IaaS Enumeration via Graph API**: Utilize Azure AD Graph API to enumerate IaaS resources and configurations.

#### Virtualization Enumeration

1. **Enumerate Virtual Machines**: Enum
```powershell
# Get Administrative Units
Get-AzureADMSAdministrativeUnit
Get-AzureADMSAdministrativeUnit -Id <id>
# Get ID of admin unit by string
$adminUnitObj = Get-AzureADMSAdministrativeUnit -Filter "displayname eq 'Test administrative unit 2'"
# List the users, groups, and devices affected by the administrative unit
Get-AzureADMSAdministrativeUnitMember -Id <id>
# Get the roles users have over the members of the AU
Get-AzureADMSScopedRoleMembership -Id <id> | fl #Get role ID and role members
```
{% endtab %}
{% endtabs %}

## Azure AD Identity Protection (AIP) <a href="#title-text" id="title-text"></a>

Azure AD Identity Protection (AIP) is 'n sekuriteitsdiens wat **outomatiese opsporing en regstellings gebruik om te help om gebruikersidentiteite in Azure Active Directory te beskerm teen kompromittering**. AIP monitor en evalueer deurlopend die risiko van gebruikersaanmeldings en identiteitskonfigurasies, **en pas outomaties toepaslike sekuriteitsmaatre√´ls toe**, soos die vereiste van multi-faktor-outentifikasie of die blokkering van potensieel gevaarlike aktiwiteite. Dit help organisasies om identiteitsgebaseerde sekuriteitskendings te voorkom.

Vloeidiagram:

1. Azure AD Identity Protection **monitor gebruikersaktiwiteite** en versamel data oor gebruikers **aanmeldings, outentifikasie** gebeure, en ander relevante aktiwiteite.
2. Die diens gebruik **masjienleer-algoritmes** om hierdie data te analiseer en potensi√´le sekuriteitsbedreigings op te spoor.
3. Azure AD Identity Protection **ken 'n vlak van risiko toe aan die dreiging** (bv. aanmelding) en genereer 'n waarskuwing indien nodig om 'n outomatiese aksie uit te voer.

## Azure AD Password Protection (APP)

Azure AD Password Protection (APP) is 'n sekuriteitsfunksie wat **help om swak wagwoorde in Azure Active Directory te voorkom deur sterk wagwoordbeleide af te dwing**. APP blokkeer **gewoonlik gebruikte swak wagwoorde** en hul variasies, wat die risiko van wagwoordverwante kruke verminder. Dit kan op beide die wolkvlak en plaaslike Active Directory toegepas word, wat die algehele wagwoordsekuriteit regoor die organisasie verbeter.

### Verwysings

* [https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units](https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
