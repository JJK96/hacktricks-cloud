# Az - AzureAD (AAD)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

O Azure Active Directory (Azure AD) serve como o servi√ßo baseado em nuvem da Microsoft para gerenciamento de identidade e acesso. √â fundamental para permitir que os funcion√°rios fa√ßam login e acessem recursos, tanto dentro quanto fora da organiza√ß√£o, abrangendo o Microsoft 365, o portal Azure e uma infinidade de outras aplica√ß√µes SaaS. O design do Azure AD se concentra em fornecer servi√ßos de identidade essenciais, incluindo **autentica√ß√£o, autoriza√ß√£o e gerenciamento de usu√°rios**.

Recursos-chave do Azure AD envolvem **autentica√ß√£o multifator** e **acesso condicional**, juntamente com integra√ß√£o perfeita com outros servi√ßos de seguran√ßa da Microsoft. Esses recursos elevam significativamente a seguran√ßa das identidades dos usu√°rios e capacitam as organiza√ß√µes a implementar e fazer cumprir efetivamente suas pol√≠ticas de acesso. Como um componente fundamental do ecossistema de servi√ßos em nuvem da Microsoft, o Azure AD √© essencial para o gerenciamento baseado em nuvem de identidades de usu√°rios.

## Entidades

### Enumera√ß√£o

Para essa enumera√ß√£o, voc√™ pode usar a [**ferramenta az cli**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)**,** o **m√≥dulo PowerShell** [**AzureAD**](https://www.powershellgallery.com/packages/AzureAD/) (ou [**AzureAD Preview**](https://www.powershellgallery.com/packages/AzureADPreview)) e o m√≥dulo [**Az PowerShell**](https://learn.microsoft.com/en-us/powershell/azure/install-az-ps).

{% hint style="success" %}
No Linux, voc√™ precisar√° instalar o PowerShell Core:
```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Update repos
sudo apt-get update
sudo add-apt-repository universe

# Install & start powershell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
{% endhint %}

#### **Diferen√ßas entre M√≥dulos**

* **AzureAD** √© um m√≥dulo do PowerShell da Microsoft para **gerenciar o Azure AD. N√£o mostra todas as propriedades dos objetos do Azure AD e n√£o pode ser usado para acessar informa√ß√µes de recursos do Azure**.
* **Az PowerShell** √© um m√≥dulo para **gerenciar recursos do Azure** a partir da linha de comando do PowerShell.

### **Conex√£o**

{% tabs %}
{% tab title="az cli" %}
```bash
az login #This will open the browser
az login -u <username> -p <password> #Specify user and password
az login --identity #Use the current machine managed identity (metadata)
az login --identity -u /subscriptions/<subscriptionId>/resourcegroups/myRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myID #Login with user managed identity
# Login as service principal
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p VerySecret --tenant contoso.onmicrosoft.com #With password
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p ~/mycertfile.pem --tenant contoso.onmicrosoft.com #With cert

# Request access token (ARM)
az account get-access-token
# Request access token for different resource. Supported tokens: aad-graph, arm, batch, data-lake, media, ms-graph, oss-rdbms
az account get-access-token --resource-type aad-graph

# If you want to configure some defaults
az configure

# Get user logged-in already
az ad signed-in-user show

# Help
az find "vm" # Find vm commands
az vm -h # Get subdomains
az ad user list --query-examples # Get examples
```
{% endtab %}

{% tab title="Azure AD" %}
{% code overflow="wrap" %}
```powershell
Connect-AzureAD #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds

# Using tokens
## AzureAD cannot request tokens, but can use AADGraph and MSGraph tokens to connect
Connect-AzureAD -AccountId test@corp.onmicrosoft.com -AadAccessToken $token
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
Connect-AzAccount #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

# Get Access Token
(Get-AzAccessToken).Token
# Request access token to other endpoints: AadGraph, AnalysisServices, Arm, Attestation, Batch, DataLake, KeyVault, MSGraph, OperationalInsights, ResourceManager, Storage, Synapse
Get-AzAccessToken -ResourceTypeName MSGraph
(Get-AzAccessToken -Resource "https://graph.microsoft.com").Token

# Conenct with access token
Connect-AzAccount -AccountId test@corp.onmicrosoft.com -AccessToken $token
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId <ACCOUNT-ID>
## The -AccessToken is from management.azure.com

# Connect with Service principal/enterprise app secret
$password = ConvertTo-SecureString 'KWEFNOIRFIPMWL.--DWPNVFI._EDWWEF_ADF~SODNFBWRBIF' -AsPlainText -Force
$creds = New-Object
System.Management.Automation.PSCredential('2923847f-fca2-a420-df10-a01928bec653', $password)
Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 29sd87e56-a192-a934-bca3-0398471ab4e7d

#All the Azure AD cmdlets have the format *-AzAD*
Get-Command *azad*
#Cmdlets for other Azure resources have the format *Az*
Get-Command *az*
```
{% endtab %}

{% tab title="C√≥digo Bruto PS" %}
{% code overflow="wrap" %}
```powershell
#Using management
$Token = 'eyJ0eXAi..'
# List subscriptions
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value

# Using graph
Invoke-WebRequest -Uri "https://graph.windows.net/myorganization/users?api-version=1.6" -Headers @{Authorization="Bearer {0}" -f $Token}
```
{% endcode %}
{% endtab %}

{% tab title="Sistema Operacional Puro" %}
{% code overflow="wrap" %}
```bash
# Request tokens to access endpoints
# ARM
curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Vault
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```
{% endcode %}
{% endtab %}
{% endtabs %}

Quando voc√™ faz **login** via **CLI** no Azure com qualquer programa, voc√™ est√° usando um **Aplicativo Azure** de um **locat√°rio** que pertence √† **Microsoft**. Esses Aplicativos, como os que voc√™ pode criar em sua conta, **possuem um ID de cliente**. Voc√™ **n√£o conseguir√° ver todos eles** nas **listas de aplicativos permitidos** que voc√™ pode ver no console, **mas eles s√£o permitidos por padr√£o**.

Por exemplo, um **script powershell** que **autentica** usa um aplicativo com o ID de cliente **`1950a258-227b-4e31-a9cf-717495945fc2`**. Mesmo que o aplicativo n√£o apare√ßa no console, um sysadmin poderia **bloquear esse aplicativo** para que os usu√°rios n√£o possam acessar usando ferramentas que se conectam atrav√©s desse Aplicativo.

No entanto, existem **outros IDs de cliente** de aplicativos que **permitir√£o que voc√™ se conecte ao Azure**:
```powershell
# The important part is the ClientId, which identifies the application to login inside Azure

$token = Invoke-Authorize -Credential $credential `
-ClientId '1dfb5f98-f363-4b0f-b63a-8d20ada1e62d' `
-Scope 'Files.Read.All openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "https://graphtryit-staging.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId '65611c08-af8c-46fc-ad20-1888eb1b70d9' `
-Scope 'openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "chrome-extension://imjekgehfljppdblckcmjggcoboemlah" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId 'd3ce4cf8-6810-442d-b42e-375e14710095' `
-Scope 'openid' `
-Redirect_Uri "https://graphexplorer.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue
```
### Utilizadores

{% tabs %}
{% tab title="az cli" %}
```bash
# Enumerate users
az ad user list --output table
az ad user list --query "[].userPrincipalName"
# Get info of 1 user
az ad user show --id "test@corp.onmicrosoft.com"
# Search "admin" users
az ad user list --query "[].displayName" | findstr /i "admin"
az ad user list --query "[?contains(displayName,'admin')].displayName"
# Search attributes containing the word "password"
az ad user list | findstr /i "password" | findstr /v "null,"
# All users from AzureAD
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi==null]"
az ad user list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All users synced from on-prem
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi!=null]"
az ad user list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get groups where the user is a member
az ad user get-member-groups --id <email>
# Get roles assigned to the user
az role assignment list --include-groups --include-classic-administrators true --assignee <email>
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD

### Enumeration

1. **User Enumeration**: The attacker can use methods like user enumeration through the login interface or the Graph API to gather a list of valid usernames.

2. **Group Enumeration**: Enumerating groups can provide valuable information about the organization's structure and potential targets for further attacks.

3. **Application Enumeration**: Discovering applications registered in Azure AD can help identify potential entry points for attacks.

### Brute Force Attacks

1. **Password Spraying**: Attackers can perform password spraying attacks against Azure AD accounts to avoid account lockouts and detection.

2. **Credential Stuffing**: Using leaked credentials from other breaches, attackers can attempt to log in with the same username and password combination.

### Phishing Attacks

1. **OAuth Phishing**: Attackers can create OAuth phishing pages to trick users into giving their credentials, allowing the attacker to access Azure AD resources.

2. **Password Reset Phishing**: Sending fake password reset emails to users can lead to them disclosing their credentials, giving attackers unauthorized access.

### Exploiting Misconfigurations

1. **SSO Misconfigurations**: Misconfigurations in Single Sign-On (SSjson) settings can lead to unauthorized access to multiple resources in Azure AD.

2. **Application Misconfigurations**: Misconfigured applications can expose sensitive data or allow attackers to escalate privileges within Azure AD.

### Other Techniques

1. **Token Impersonation**: Attackers can steal OAuth tokens to impersonate users and access resources on their behalf.

2. **Pass-the-Hash**: If attackers can obtain password hashes, they can use them to authenticate without knowing the actual passwords.

{% endtab %}
```powershell
# Enumerate Users
Get-AzureADUser -All $true
Get-AzureADUser -All $true | select UserPrincipalName
# Get info of 1 user
Get-AzureADUser -ObjectId test@corp.onmicrosoft.com | fl
# Search "admin" users
Get-AzureADUser -SearchString "admin" #Search admin at the begining of DisplayName or userPrincipalName
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"} #Search "admin" word in DisplayName
# Get all attributes of a user
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com|%{$_.PSObject.Properties.Name}
# Search attributes containing the word "password"
Get-AzureADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
# All users from AzureAD# All users from AzureAD
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All users synced from on-prem
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Objects created by a/any user
Get-AzureADUser [-ObjectId <email>] | Get-AzureADUserCreatedObject
# Devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Objects owned by a specific user
Get-AzureADUserOwnedObject -ObjectId test@corp.onmicrosoft.com
# Get groups & roles where the user is a member
Get-AzureADUserMembership -ObjectId 'test@corp.onmicrosoft.com'
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get devices registered by a user
Get-AzureADUserRegisteredDevice -ObjectId test@defcorphq.onmicrosoft.com
# Apps where a user has a role (role not shown)
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
# Get Administrative Units of a user
$userObj = Get-AzureADUser -Filter "UserPrincipalName eq 'bill@example.com'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where { $_.Id -eq $userObj.ObjectId } }
```
{% endtab %}

{% tab title="Az PowerShell" %} 

## Conectar-se ao Azure AD usando o Az PowerShell

Para se conectar ao Azure AD usando o Az PowerShell, voc√™ pode usar o seguinte comando:

```plaintext
Connect-AzAccount
```

Isso abrir√° uma janela pop-up onde voc√™ poder√° inserir suas credenciais do Azure. Ap√≥s inserir suas credenciais corretamente, voc√™ estar√° conectado ao Azure AD e poder√° come√ßar a executar comandos relacionados ao Azure AD usando o Az PowerShell.

Lembre-se de que voc√™ deve ter as permiss√µes adequadas para se conectar ao Azure AD.
```powershell
# Enumerate users
Get-AzADUser
# Get details of a user
Get-AzADUser -UserPrincipalName test@defcorphq.onmicrosoft.com
# Search user by string
Get-AzADUser -SearchString "admin" #Search at the beginnig of DisplayName
Get-AzADUser | ?{$_.Displayname -match "admin"}
# Get roles assigned to a user
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
```
{% endtab %}
{% endtabs %}

#### Alterar Senha do Usu√°rio

{% code overflow="wrap" %}
```powershell
$password = "ThisIsTheNewPassword.!123" | ConvertTo- SecureString -AsPlainText ‚ÄìForce

(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "victim@corp.onmicrosoft.com"}).ObjectId | Set- AzureADUserPassword -Password $password ‚ÄìVerbose
```
{% endcode %}

### Pol√≠ticas de MFA e Acesso Condicional

√â altamente recomendado adicionar MFA a todos os usu√°rios, no entanto, algumas empresas podem n√£o configur√°-lo ou podem configur√°-lo com um Acesso Condicional: O usu√°rio ser√° **obrigado a usar MFA se** fizer login de uma localiza√ß√£o espec√≠fica, navegador ou **alguma condi√ß√£o**. Essas pol√≠ticas, se n√£o configuradas corretamente, podem estar sujeitas a **burlas**. Verifique:

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

### Grupos

{% tabs %}
{% tab title="az cli" %}
```powershell
# Enumerate groups
az ad group list
az ad group list --query "[].[displayName]" -o table
# Get info of 1 group
az ad group show --group <group>
# Get "admin" groups
az ad group list --query "[].displayName" | findstr /i "admin"
az ad group list --query "[?contains(displayName,'admin')].displayName"
# All groups from AzureAD
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi==null]"
az ad group list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All groups synced from on-prem
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi!=null]"
az ad group list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get members of group
az ad group member list --group <group> --query "[].userPrincipalName" -o table
# Check if member of group
az ad group member check --group "VM Admins" --member-id <id>
# Get which groups a group is member of
az ad group get-member-groups -g "VM Admins"
# Get Apps where a group has a role (role not shown)
Get-AzureADGroup -ObjectId <id> | Get-AzureADGroupAppRoleAssignment | fl *
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD

### Enumeration

1. **User Enumeration**: 
   - Enumerate users through the Graph API using tools like `aad-enum`.
   - Use the `Get-AzureADUser` PowerShell cmdlet to retrieve user information.

2. **Group Enumeration**:
   - Enumerate groups using tools like `aad-enum`.
   - Use the `Get-AzureADGroup` PowerShell cmdlet to retrieve group information.

3. **Application Enumeration**:
   - Enumerate applications using tools like `aad-enum`.
   - Use the `Get-AzureADApplication` PowerShell cmdlet to retrieve application information.

### Brute Force

1. **Password Spraying**:
   - Perform password spraying attacks using tools like `MSOLSpray`.
   - Use common passwords or password lists to attempt authentication.

2. **Credential Stuffing**:
   - Use tools like `CrackMapExec` to perform credential stuffing attacks against Azure AD.

### Exploitation

1. **Phishing**:
   - Conduct phishing campaigns to steal user credentials.
   - Use phishing emails or fake login pages to trick users into giving their credentials.

2. **Password Policies**:
   - Exploit weak password policies to gain access to user accounts.
   - Look for weak password requirements or password reuse policies.

3. **Account Takeover**:
   - Take over user accounts by exploiting vulnerabilities like password reuse or weak authentication methods.
   - Use stolen credentials to gain unauthorized access to accounts.

### Persistence

1. **Backdoors**:
   - Create backdoors in Azure AD to maintain access.
   - Use methods like creating hidden accounts or adding malicious service principals.

2. **OAuth Token Theft**:
   - Steal OAuth tokens to maintain persistent access.
   - Use stolen tokens to impersonate users or access resources.

### Lateral Movement

1. **Azure AD Connect**:
   - Exploit misconfigurations in Azure AD Connect to move laterally.
   - Use compromised credentials to pivot to other systems within the Azure environment.

2. **Service Principals**:
   - Abuse service principals to move laterally within Azure AD.
   - Look for misconfigured service principals that can be leveraged for lateral movement.

### Exfiltration

1. **Data Exfiltration**:
   - Steal sensitive data from Azure AD.
   - Extract user information, credentials, or other sensitive data from Azure AD.

2. **OAuth Token Exfiltration**:
   - Exfiltrate OAuth tokens to maintain access to Azure AD.
   - Use stolen tokens to maintain persistence or access resources.

{% endtab %}
```powershell
# Enumerate Groups
Get-AzureADGroup -All $true
# Get info of 1 group
Get-AzADGroup -DisplayName <resource_group_name> | fl
# Get "admin" groups
Get-AzureADGroup -SearchString "admin" | fl #Groups starting by "admin"
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"} #Groups with the word "admin"
# Get groups allowing dynamic membership
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
# All groups that are from Azure AD
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All groups that are synced from on-prem (note that security groups are not synced)
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Get members of a group
Get-AzureADGroupMember -ObjectId <group_id>
# Get roles of group
Get-AzureADMSGroup -SearchString "Contoso_Helpdesk_Administrators" #Get group id
Get-AzureADMSRoleAssignment -Filter "principalId eq '69584002-b4d1-4055-9c94-320542efd653'"
# Get Administrative Units of a group
$groupObj = Get-AzureADGroup -Filter "displayname eq 'TestGroup'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where {$_.Id -eq $groupObj.ObjectId} }
```
{% endtab %}

{% tab title="Az PowerShell" %} 

## Conectar-se ao Azure AD usando o Az PowerShell

Para se conectar ao Azure AD usando o Az PowerShell, voc√™ pode usar o seguinte comando:

```powershell
Connect-AzAccount
```

Isso abrir√° uma janela pop-up onde voc√™ poder√° inserir suas credenciais do Azure. Ap√≥s inserir suas credenciais corretamente, voc√™ estar√° conectado ao Azure AD e poder√° come√ßar a executar comandos relacionados ao Azure AD usando o Az PowerShell.

Lembre-se de que voc√™ deve ter as permiss√µes adequadas para se conectar ao Azure AD.
```powershell
# Get all groups
Get-AzADGroup
# Get details of a group
Get-AzADGroup -ObjectId <id>
# Search group by string
Get-AzADGroup -SearchString "admin" | fl * #Search at the beginnig of DisplayName
Get-AzADGroup |?{$_.Displayname -match "admin"}
# Get members of group
Get-AzADGroupMember -GroupDisplayName <resource_group_name>
# Get roles of group
Get-AzRoleAssignment -ResourceGroupName <resource_group_name>
```
{% endtab %}
{% endtabs %}

#### Adicionar usu√°rio a um grupo

Os propriet√°rios do grupo podem adicionar novos usu√°rios ao grupo

{% code overflow="wrap" %}
```powershell
Add-AzureADGroupMember -ObjectId <group_id> -RefObjectId <user_id> -Verbose
```
{% endcode %}

{% hint style="warning" %}
Os grupos podem ser din√¢micos, o que basicamente significa que **se um usu√°rio atender a certas condi√ß√µes, ele ser√° adicionado a um grupo**. Claro, se as condi√ß√µes forem baseadas em **atributos** que um **usu√°rio** pode **controlar**, ele poderia abusar desse recurso para **entrar em outros grupos**.\
Verifique como abusar dos grupos din√¢micos na seguinte p√°gina:
{% endhint %}

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

### Service Principals / Enterprise Applications

{% hint style="info" %}
Observe que **Service Principal** na terminologia do PowerShell **√©** chamado de **Enterprise Applications** no portal Azure (web).
{% endhint %}

{% tabs %}
{% tab title="az cli" %}
```bash
# Get Service Principals
az ad sp list --all
az ad sp list --all --query "[].[displayName]" -o table
# Get details of one SP
az ad sp show --id 00000000-0000-0000-0000-000000000000
# Search SP by string
az ad sp list --all --query "[?contains(displayName,'app')].displayName"
# Get owner of service principal
az ad sp owner list --id <id> --query "[].[displayName]" -o table
# Get service principals owned by the current user
az ad sp list --show-mine
# List apps that have password credentials
az ad sp list --all --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad sp list -all --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD

### Enumeration

1. **User Enumeration**: 
   - **Description**: Enumerate valid usernames using methods like user enumeration, password spraying, or phishing attacks.
   - **Impact**: Allows attackers to identify valid accounts for further attacks.

2. **Group Enumeration**:
   - **Description**: Enumerate Azure AD groups to understand the organization's structure and potential attack surface.
   - **Impact**: Helps attackers identify high-privileged groups for privilege escalation attacks.

3. **Application Enumeration**:
   - **Description**: Discover applications registered in Azure AD to identify potential entry points.
   - **Impact**: Provides insights into possible avenues for further exploitation.

### Exploitation

1. **Password Spraying**:
   - **Description**: Attempt to authenticate using a small number of common passwords across many accounts to avoid account lockouts.
   - **Impact**: Can lead to unauthorized access if weak passwords are discovered.

2. **Phishing Attacks**:
   - **Description**: Trick users into providing their credentials through fake login pages or emails.
   - **Impact**: Allows attackers to steal user credentials for unauthorized access.

3. **Token Impersonation**:
   - **Description**: Steal or forge tokens to impersonate users and access resources.
   - **Impact**: Enables attackers to bypass authentication and gain unauthorized access.

### Post-Exploitation

1. **Maintain Access**:
   - **Description**: Establish backdoors or maintain persistence to access the Azure AD environment even after initial access is lost.
   - **Impact**: Allows attackers to continue unauthorized activities over an extended period.

2. **Data Exfiltration**:
   - **Description**: Steal sensitive data from Azure AD, such as user information or authentication tokens.
   - **Impact**: Can lead to data breaches and further compromise of the organization's security.

{% endtab %}
```powershell
# Get Service Principals
Get-AzureADServicePrincipal -All $true
# Get details about a SP
Get-AzureADServicePrincipal -ObjectId <id> | fl *
# Get SP by string name or Id
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"} | fl
Get-AzureADServicePrincipal -All $true | ?{$_.AppId -match "103947652-1234-5834-103846517389"}
# Get owner of SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwner |fl *
# Get objects owned by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwnedObject
# Get objects created by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalCreatedObject
# Get groups where the SP is a member
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalMembership |fl *
```
{% endtab %}

{% tab title="Az PowerShell" %} 

## Conectar-se ao Azure AD usando o Az PowerShell

Para se conectar ao Azure AD usando o Az PowerShell, voc√™ pode seguir as etapas abaixo:

1. Instale o m√≥dulo Az PowerShell, se ainda n√£o estiver instalado:
```powershell
Install-Module -Name Az -AllowClobber -Scope CurrentUser
```

2. Importe o m√≥dulo Az e fa√ßa login no Azure AD:
```powershell
Import-Module Az
Connect-AzAccount
```

3. Siga as instru√ß√µes na janela pop-up para fazer login na sua conta do Azure.

Depois de concluir essas etapas, voc√™ estar√° conectado ao Azure AD usando o Az PowerShell. 

{% endtab %}
```powershell
# Get SPs
Get-AzADServicePrincipal
# Get info of 1 SP
Get-AzADServicePrincipal -ObjectId <id>
# Search SP by string
Get-AzADServicePrincipal | ?{$_.DisplayName -match "app"}
# Get roles of a SP
Get-AzRoleAssignment -ServicePrincipalName <String>
```
{% endtab %}

{% tab title="Traduzido" %}
```powershell
$Token = 'eyJ0eX..'
$URI = 'https://graph.microsoft.com/v1.0/applications'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
O propriet√°rio de um Principal de Servi√ßo pode alterar sua senha.
{% endhint %}

<details>

<summary>Liste e tente adicionar um segredo do cliente em cada Aplicativo Corporativo</summary>
```powershell
# Just call Add-AzADAppSecret
Function Add-AzADAppSecret
{
<#
.SYNOPSIS
Add client secret to the applications.

.PARAMETER GraphToken
Pass the Graph API Token

.EXAMPLE
PS C:\> Add-AzADAppSecret -GraphToken 'eyJ0eX..'

.LINK
https://docs.microsoft.com/en-us/graph/api/application-list?view=graph-rest-1.0&tabs=http
https://docs.microsoft.com/en-us/graph/api/application-addpassword?view=graph-rest-1.0&tabs=http
#>

[CmdletBinding()]
param(
[Parameter(Mandatory=$True)]
[String]
$GraphToken = $null
)

$AppList = $null
$AppPassword = $null

# List All the Applications

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications"
"Method"  = "GET"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

try
{
$AppList = Invoke-RestMethod @Params -UseBasicParsing
}
catch
{
}

# Add Password in the Application

if($AppList -ne $null)
{
[System.Collections.ArrayList]$Details = @()

foreach($App in $AppList.value)
{
$ID = $App.ID
$psobj = New-Object PSObject

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications/$ID/addPassword"
"Method"  = "POST"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

$Body = @{
"passwordCredential"= @{
"displayName" = "Password"
}
}

try
{
$AppPassword = Invoke-RestMethod @Params -UseBasicParsing -Body ($Body | ConvertTo-Json)
Add-Member -InputObject $psobj -NotePropertyName "Object ID" -NotePropertyValue $ID
Add-Member -InputObject $psobj -NotePropertyName "App ID" -NotePropertyValue $App.appId
Add-Member -InputObject $psobj -NotePropertyName "App Name" -NotePropertyValue $App.displayName
Add-Member -InputObject $psobj -NotePropertyName "Key ID" -NotePropertyValue $AppPassword.keyId
Add-Member -InputObject $psobj -NotePropertyName "Secret" -NotePropertyValue $AppPassword.secretText
$Details.Add($psobj) | Out-Null
}
catch
{
Write-Output "Failed to add new client secret to '$($App.displayName)' Application."
}
}
if($Details -ne $null)
{
Write-Output ""
Write-Output "Client secret added to : "
Write-Output $Details | fl *
}
}
else
{
Write-Output "Failed to Enumerate the Applications."
}
}
```
</details>

### Fun√ß√µes

{% tabs %}
{% tab title="az cli" %}
```bash
# Get roles
az role definition list
# Get assigned roles
az role assignment list --all --query "[].roleDefinitionName"
az role assignment list --all | jq '.[] | .roleDefinitionName,.scope'
# Get info of 1 role
az role definition list --name "AzureML Registry User"
# Get only custom roles
az role definition list --custom-role-only
# Get only roles assigned to the resource group indicated
az role definition list --resource-group <resource_group>
# Get only roles assigned to the indicated scope
az role definition list --scope <scope>
# Get all the principals a role is assigned to
az role assignment list --all --query "[].{principalName:principalName,principalType:principalType,resourceGroup:resourceGroup,roleDefinitionName:roleDefinitionName}[?roleDefinitionName=='<ROLE_NAME>']"
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD Enumeration

### User Enumeration

To enumerate users in Azure AD, you can use tools like `Azure AD Recon` or `Azure AD Connect` to gather information about users, groups, and contacts.

#### Azure AD Recon

1. Run Azure AD Recon tool.
2. Select the enumeration option.
3. Provide necessary information like tenant name and credentials.
4. Start the enumeration process.

#### Azure AD Connect

1. Run Azure AD Connect tool.
2. Choose the enumeration mode.
3. Enter the required details.
4. Initiate the enumeration.

### Group Enumeration

For enumerating groups in Azure AD, you can utilize tools like `Azure AD Recon` or `Azure AD Connect` to extract information about different groups present in the Azure AD environment.

#### Azure AD Recon

1. Launch Azure AD Recon.
2. Opt for the group enumeration feature.
3. Input the essential data.
4. Commence the enumeration task.

#### Azure AD Connect

1. Open Azure AD Connect.
2. Select the group enumeration mode.
3. Fill in the necessary particulars.
4. Start the enumeration process.

### Device Enumeration

To enumerate devices in Azure AD, you can employ tools like `Azure AD Recon` or `Azure AD Connect` to retrieve details about devices registered in the Azure AD setup.

#### Azure AD Recon

1. Start Azure AD Recon.
2. Choose the device enumeration function.
3. Provide the required information.
4. Run the enumeration.

#### Azure AD Connect

1. Fire up Azure AD Connect.
2. Opt for the device enumeration option.
3. Enter the mandatory details.
4. Execute the enumeration procedure.

{% endtab %}
```powershell
# Get all available role templates
Get-AzureADDirectoryroleTemplate
# Get enabled roles (Assigned roles)
Get-AzureADDirectoryRole
Get-AzureADDirectoryRole -ObjectId <roleID> #Get info about the role
# Get custom roles - use AzureAdPreview
Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
# Users assigned a role (Global Administrator)
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
Get-AzureADDirectoryRole -ObjectId <id> | fl
# Roles of the Administrative Unit (who has permissions over the administrative unit and its members)
Get-AzureADMSScopedRoleMembership -Id <id> | fl *
```
{% endtab %}

{% tab title="Az PowerShell" %} 

## Conectar-se ao Azure AD usando o Az PowerShell

Para se conectar ao Azure AD usando o Az PowerShell, siga as etapas abaixo:

1. Instale o m√≥dulo Az PowerShell, se ainda n√£o estiver instalado:
```powershell
Install-Module -Name Az -AllowClobber -Scope CurrentUser
```

2. Importe o m√≥dulo Az e conecte-se ao Azure AD:
```powershell
Import-Module Az
Connect-AzAccount
```

3. Siga as instru√ß√µes na janela pop-up para fazer login na sua conta do Azure.

Depois de concluir essas etapas, voc√™ estar√° conectado ao Azure AD usando o Az PowerShell. 

{% endtab %}
```powershell
# Get role assignments on the subscription
Get-AzRoleDefinition
# Get Role definition
Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
# Get roles of a user or resource
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/<res_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>
```
{% endtab %}

{% tab title="Raw" %}O Azure AD Connect √© uma ferramenta usada para sincronizar identidades do Active Directory local com o Azure Active Directory. Isso permite que as organiza√ß√µes gerenciem identidades em um √∫nico local, simplificando o acesso dos usu√°rios a recursos em ambientes locais e na nuvem. Al√©m disso, o Azure AD Connect oferece recursos de autentica√ß√£o √∫nica, sincroniza√ß√£o de senhas e muito mais para melhorar a seguran√ßa e a experi√™ncia do usu√°rio. √â importante garantir que o Azure AD Connect esteja configurado corretamente e seja mantido atualizado para evitar poss√≠veis vulnerabilidades de seguran√ßa.{% endtab %}
```powershell
# Get permissions over a resource using ARM directly
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
### Dispositivos

{% tabs %}
{% tab title="az cli" %}
```bash
# If you know how to do this send a PR!
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD Enumeration

### User Enumeration

To enumerate users in Azure AD, you can use tools like `Azure AD Recon` or `Azure AD Connect` to gather information such as user accounts, groups, and permissions.

#### Using Azure AD Recon

1. Run Azure AD Recon tool.
2. Select the enumeration option.
3. Provide necessary information like tenant ID, client ID, and client secret.
4. Start the enumeration process.

#### Using Azure AD Connect

1. Run Azure AD Connect tool.
2. Select the user enumeration option.
3. Provide the required parameters.
4. Initiate the enumeration process.

### Group Enumeration

To enumerate groups in Azure AD, tools like `Azure AD Recon` or `Azure AD Connect` can be used to retrieve information about groups, group members, and group permissions.

#### Using Azure AD Recon

1. Launch Azure AD Recon.
2. Choose the group enumeration feature.
3. Enter the relevant details.
4. Begin the enumeration.

#### Using Azure AD Connect

1. Open Azure AD Connect.
2. Opt for the group enumeration functionality.
3. Input the necessary data.
4. Commence the enumeration.

### Permission Enumeration

For enumerating permissions in Azure AD, tools such as `Azure AD Recon` or `Azure AD Connect` are helpful in identifying permissions assigned to users and groups.

#### Using Azure AD Recon

1. Start Azure AD Recon.
2. Use the permission enumeration tool.
3. Fill in the specified information.
4. Run the enumeration.

#### Using Azure AD Connect

1. Access Azure AD Connect.
2. Utilize the permission enumeration tool.
3. Complete the required fields.
4. Execute the enumeration process.

{% endtab %}
```powershell
# Enumerate Devices
Get-AzureADDevice -All $true | fl *
# List all the active devices (and not the stale devices)
Get-AzureADDevice -All $true | ?{$_.ApproximateLastLogonTimeStamp -ne $null}
# Get owners of all devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Registred users of all the devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Get dives managed using Intune
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get Administrative Units of a device
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -ObjectId $_.ObjectId | where {$_.ObjectId -eq $deviceObjId} }
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
Se um dispositivo (VM) estiver **associado ao AzureAD**, os usu√°rios do AzureAD poder√£o **fazer login**.\
Al√©m disso, se o usu√°rio logado for **Propriet√°rio** do dispositivo, ele ser√° **administrador local**.
{% endhint %}

### Aplica√ß√µes

{% hint style="info" %}
**Apps** s√£o **Registros de Aplicativos** no portal (n√£o Aplica√ß√µes Corporativas).\
Mas cada Registro de Aplicativo ir√° criar uma **Aplica√ß√£o Corporativa** (**Principal de Servi√ßo**) com o mesmo nome.\
Al√©m disso, se o App for um **App multi-inquilino**, **outra** Aplica√ß√£o Corporativa (**Principal de Servi√ßo**) ser√° criada **naquele inquilino** com o mesmo nome.
{% endhint %}

Quando um App √© gerado, s√£o concedidos 2 tipos de permiss√µes:

* **Permiss√µes** concedidas ao **Principal de Servi√ßo**
* **Permiss√µes** que o **app** pode ter e usar **em nome do usu√°rio**.
```bash
# List Apps
az ad app list
az ad app list --query "[].[displayName]" -o table
# Get info of 1 App
az ad app show --id 00000000-0000-0000-0000-000000000000
# Search App by string
az ad app list --query "[?contains(displayName,'app')].displayName"
# Get the owner of an application
az ad app owner list --id <id> --query "[].[displayName]" -o table
# List all the apps with an application password
az ad app list --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad app list --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD Enumeration

### User Enumeration

To enumerate users in Azure AD, you can use tools like `Azure AD Recon` or `Azure AD User Enumeration`. These tools can help you gather information about users, such as their usernames, email addresses, and assigned roles.

### Group Enumeration

For enumerating groups in Azure AD, tools like `Azure AD Recon` or `Azure AD Group Enumeration` can be used. These tools can provide details about the groups present in the Azure AD environment, including group names, descriptions, and members.

### Device Enumeration

To enumerate devices in Azure AD, tools like `Azure AD Recon` or `Azure AD Device Enumeration` can be utilized. These tools can give you insights into the devices registered in Azure AD, such as device names, types, and associated users.

### Application Enumeration

For enumerating applications in Azure AD, tools like `Azure AD Recon` or `Azure AD Application Enumeration` can be helpful. These tools can reveal information about the applications configured in Azure AD, including application names, owners, and permissions.

{% endtab %}
```powershell
# List all registered applications
Get-AzureADApplication -All $true
# Get details of an application
Get-AzureADApplication -ObjectId <id>  | fl *
# List all the apps with an application password
Get-AzureADApplication -All $true | %{if(Get-AzureADApplicationPasswordCredential -ObjectID $_.ObjectID){$_}}
# Get owner of an application
Get-AzureADApplication -ObjectId <id> | Get-AzureADApplicationOwner |fl *
```
{% endtab %}

{% tab title="Az PowerShell" %} 

## Conectar-se ao Azure AD usando o Az PowerShell

Para se conectar ao Azure AD usando o Az PowerShell, siga as etapas abaixo:

1. Instale o m√≥dulo Az PowerShell, se ainda n√£o estiver instalado:
```powershell
Install-Module -Name Az -AllowClobber -Scope CurrentUser
```

2. Importe o m√≥dulo Az PowerShell:
```powershell
Import-Module Az
```

3. Conecte-se √† sua conta do Azure AD:
```powershell
Connect-AzAccount
```

4. Siga as instru√ß√µes na janela pop-up para fazer login na sua conta do Azure.

Depois de concluir essas etapas, voc√™ estar√° conectado ao Azure AD usando o Az PowerShell. 

{% endtab %}
```powershell
# Get Apps
Get-AzADApplication
# Get details of one App
Get-AzADApplication -ObjectId <id>
# Get App searching by string
Get-AzADApplication | ?{$_.DisplayName -match "app"}
# Get Apps with password
Get-AzADAppCredential
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
Uma aplica√ß√£o com a permiss√£o **`AppRoleAssignment.ReadWrite`** pode **escalar para Administrador Global** concedendo a si mesma a fun√ß√£o.\
Para mais informa√ß√µes [**verifique isso**](https://posts.specterops.io/azure-privilege-escalation-via-azure-api-permissions-abuse-74aee1006f48).
{% endhint %}

{% hint style="info" %}
Uma string secreta que a aplica√ß√£o usa para provar sua identidade ao solicitar um token √© a senha da aplica√ß√£o.\
Portanto, se encontrar essa **senha** voc√™ pode acessar como o **princ√≠pio de servi√ßo** **dentro** do **locat√°rio**.\
Observe que essa senha s√≥ √© vis√≠vel quando gerada (voc√™ poderia alter√°-la, mas n√£o pode obt√™-la novamente).\
O **propriet√°rio** da **aplica√ß√£o** pode **adicionar uma senha** a ela (para que ele possa se passar por ela).\
Os logins como esses princ√≠pios de servi√ßo **n√£o s√£o marcados como arriscados** e eles **n√£o ter√£o MFA**.
{% endhint %}

### Diferen√ßa entre Aplica√ß√µes e (Aplica√ß√µes Empresariais ou Princ√≠pios de Servi√ßo)

Diferen√ßa entre uma aplica√ß√£o e um Princ√≠pio de Servi√ßo no Azure:

* **Aplica√ß√£o/Registros de Aplicativos**: S√£o aplica√ß√µes que existem no seu Azure AD
* `(Get-AzureADApplication -filter "DisplayName eq 'testapp'")`
* **Princ√≠pio de Servi√ßo/Aplica√ß√µes Empresariais**: Objetos de seguran√ßa no seu Azure AD que podem ter **privil√©gios** no Diret√≥rio Azure e est√£o vinculados √† sua aplica√ß√£o ou a uma aplica√ß√£o de terceiros
* `Get-AzureADServicePrincipal -filter "DisplayName eq 'testapp'")`
* Um administrador pode precisar aprovar as permiss√µes concedidas se forem muito sens√≠veis.

Uma aplica√ß√£o pode estar sendo executada em um **locat√°rio de terceiros** e uma vez que voc√™ come√ßa a us√°-la e d√° acesso a ela, um **Aplicativo Empresarial/Princ√≠pio de Servi√ßo √© criado em seu locat√°rio** para dar acesso √†s informa√ß√µes de que precisa:

### Unidades Administrativas

√â usado para melhor gerenciamento de usu√°rios.

Unidades administrativas **restringem permiss√µes em uma fun√ß√£o para qualquer parte de sua organiza√ß√£o** que voc√™ define. Voc√™ poderia, por exemplo, usar unidades administrativas para delegar a fun√ß√£o de [Administrador de Helpdesk](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#helpdesk-administrator) a especialistas em suporte regional, para que possam gerenciar usu√°rios apenas na regi√£o que eles suportam.

Portanto, voc√™ pode atribuir fun√ß√µes √† unidade administrativa e os membros dela ter√£o essas fun√ß√µes.
```
```
{% endtab %}

{% tab title="AzureAD" %}

## AzureAD Enumeration

### User Enumeration

To enumerate users in AzureAD, you can use tools like `Azure AD Recon` or `Azure AD Connect`. These tools can help you gather information about users, groups, and contacts in the Azure Active Directory.

### Group Enumeration

For enumerating groups in AzureAD, tools like `Azure AD Recon` or `Azure AD Connect` can be used. These tools allow you to discover information about the groups present in the Azure Active Directory.

### Device Enumeration

To enumerate devices in AzureAD, you can utilize tools like `Azure AD Recon` or `Azure AD Connect`. By using these tools, you can collect data about the devices registered in the Azure Active Directory.

### Application Enumeration

For enumerating applications in AzureAD, tools like `Azure AD Recon` or `Azure AD Connect` are useful. These tools enable you to find details about the applications configured in the Azure Active Directory.

### Service Principal Enumeration

To enumerate service principals in AzureAD, tools like `Azure AD Recon` or `Azure AD Connect` can be employed. These tools assist in identifying and gathering information about the service principals in the Azure Active Directory.

{% endtab %}
```powershell
# Get Administrative Units
Get-AzureADMSAdministrativeUnit
Get-AzureADMSAdministrativeUnit -Id <id>
# Get ID of admin unit by string
$adminUnitObj = Get-AzureADMSAdministrativeUnit -Filter "displayname eq 'Test administrative unit 2'"
# List the users, groups, and devices affected by the administrative unit
Get-AzureADMSAdministrativeUnitMember -Id <id>
# Get the roles users have over the members of the AU
Get-AzureADMSScopedRoleMembership -Id <id> | fl #Get role ID and role members
```
{% endtab %}
{% endtabs %}

## Prote√ß√£o de Identidade do Azure AD (AIP) <a href="#title-text" id="title-text"></a>

A Prote√ß√£o de Identidade do Azure AD (AIP) √© um servi√ßo de seguran√ßa que utiliza **detec√ß√£o automatizada e remedia√ß√£o para ajudar a proteger identidades de usu√°rios no Azure Active Directory contra comprometimento**. A AIP monitora continuamente e avalia o risco de logins de usu√°rios e configura√ß√µes de identidade, **aplicando automaticamente medidas de seguran√ßa apropriadas**, como exigir autentica√ß√£o multifator ou bloquear atividades potencialmente perigosas. Isso ajuda as organiza√ß√µes a prevenir viola√ß√µes de seguran√ßa baseadas em identidade.

Fluxo:

1. A Prote√ß√£o de Identidade do Azure AD **monitora as atividades do usu√°rio** e coleta dados sobre **logins de usu√°rios, eventos de autentica√ß√£o** e outras atividades relevantes.
2. O servi√ßo utiliza **algoritmos de aprendizado de m√°quina** para analisar esses dados e detectar poss√≠veis amea√ßas de seguran√ßa.
3. A Prote√ß√£o de Identidade do Azure AD **atribui um n√≠vel de risco √† amea√ßa** (por exemplo, login) e gera um alerta, se necess√°rio, para realizar alguma a√ß√£o autom√°tica.

## Prote√ß√£o de Senha do Azure AD (APP)

A Prote√ß√£o de Senha do Azure AD (APP) √© um recurso de seguran√ßa que **ajuda a prevenir senhas fracas no Azure Active Directory, aplicando pol√≠ticas de senha fortes**. O APP bloqueia **senhas fracas comumente usadas** e suas variantes, reduzindo o risco de viola√ß√µes relacionadas a senhas. Pode ser aplicado tanto no n√≠vel da nuvem quanto no Active Directory local, aprimorando a seguran√ßa geral das senhas em toda a organiza√ß√£o.

### Refer√™ncias

* [https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units](https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units)

{% hint style="success" %}
Aprenda e pratique Hacking em AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking em GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
