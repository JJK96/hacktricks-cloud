# Az - Dynamic Groups Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**Dynamic groups** рд╡реЗ рд╕рдореВрд╣ рд╣реЛрддреЗ рд╣реИрдВ рдЬрд┐рдирдореЗрдВ рдПрдХ рд╕реЗрдЯ **рдирд┐рдпрдо** рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рд╕рднреА **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдпрд╛ рдбрд┐рд╡рд╛рдЗрд╕** рдЬреЛ рдирд┐рдпрдореЛрдВ рд╕реЗ рдореЗрд▓ рдЦрд╛рддреЗ рд╣реИрдВ, рд╕рдореВрд╣ рдореЗрдВ рдЬреЛрдбрд╝реЗ рдЬрд╛рддреЗ рд╣реИрдВред рд╣рд░ рдмрд╛рд░ рдЬрдм рдХрд┐рд╕реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдпрд╛ рдбрд┐рд╡рд╛рдЗрд╕ рдХрд╛ **рдЧреБрдг** **рдмрджрд▓рддрд╛** рд╣реИ, рддреЛ рдбрд╛рдпрдирд╛рдорд┐рдХ рдирд┐рдпрдореЛрдВ рдХреЛ **рдлрд┐рд░ рд╕реЗ рдЬрд╛рдВрдЪрд╛** рдЬрд╛рддрд╛ рд╣реИред рдФрд░ рдЬрдм рдПрдХ **рдирдпрд╛ рдирд┐рдпрдо** **рдмрдирд╛рдпрд╛** рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╕рднреА рдбрд┐рд╡рд╛рдЗрд╕ рдФрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреА **рдЬрд╛рдВрдЪ** рдХреА рдЬрд╛рддреА рд╣реИред

рдбрд╛рдпрдирд╛рдорд┐рдХ рд╕рдореВрд╣реЛрдВ рдХреЛ **Azure RBAC roles** рдЕрд╕рд╛рдЗрди рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдбрд╛рдпрдирд╛рдорд┐рдХ рд╕рдореВрд╣реЛрдВ рдореЗрдВ **AzureAD roles** рдЬреЛрдбрд╝рдирд╛ **рд╕рдВрднрд╡ рдирд╣реАрдВ** рд╣реИред

рдЗрд╕ рд╕реБрд╡рд┐рдзрд╛ рдХреЗ рд▓рд┐рдП Azure AD рдкреНрд░реАрдорд┐рдпрдо P1 рд▓рд╛рдЗрд╕реЗрдВрд╕ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред

## Privesc

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХреЛрдИ рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ Azure AD рдореЗрдВ рдЕрддрд┐рдерд┐ рдЖрдордВрддреНрд░рд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдПрдХ рдбрд╛рдпрдирд╛рдорд┐рдХ рд╕рдореВрд╣ **рдирд┐рдпрдо** **рдЧреБрдгреЛрдВ** рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ **рдЕрдиреБрдорддрд┐рдпрд╛рдБ** рджреЗрддрд╛ рд╣реИ рдЬреЛ рдПрдХ рдирдП **рдЕрддрд┐рдерд┐** рдореЗрдВ **рд╕реЗрдЯ** рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЗрди рдЧреБрдгреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ **рдЕрддрд┐рдерд┐** **рдмрдирд╛рдирд╛** рдФрд░ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛рдирд╛** рд╕рдВрднрд╡ рд╣реИред рдпрд╣ рднреА рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдПрдХ рдЕрддрд┐рдерд┐ рдЕрдкрдиреЗ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХреЛ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд░реЗ рдФрд░ рдЗрди рдЧреБрдгреЛрдВ рдХреЛ рдмрджрд▓ рджреЗред

рдбрд╛рдпрдирд╛рдорд┐рдХ рд╕рджрд╕реНрдпрддрд╛ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рд╡рд╛рд▓реЗ рд╕рдореВрд╣ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ: `Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}`

### Example

* **Rule example**: `(user.otherMails -any (_ -contains "tester")) -and (user.userType -eq "guest")`
* **Rule description**: рдХреЛрдИ рднреА рдЕрддрд┐рдерд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ 'tester' рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЗ рд╕рд╛рде рдПрдХ рджреНрд╡рд┐рддреАрдпрдХ рдИрдореЗрд▓ рд╣реИ, рдЙрд╕реЗ рд╕рдореВрд╣ рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЬрд╛рдПрдЧрд╛

1. **Azure Active Directory** -> **Users** рдкрд░ рдЬрд╛рдПрдВ рдФрд░ **рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ** `Want to switch back to the legacy users list experience? Click here to leave the preview`
2. **`New guest user`** рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ рдФрд░ рдПрдХ рдИрдореЗрд▓ **рдЖрдордВрддреНрд░рд┐рдд** рдХрд░реЗрдВ
3. рдЖрдордВрддреНрд░рдг рднреЗрдЬреЗ рдЬрд╛рдиреЗ рдХреЗ рддреБрд░рдВрдд рдмрд╛рдж рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА **рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓** Azure AD рдореЗрдВ **рдЬреЛрдбрд╝реА** рдЬрд╛рдПрдЧреАред рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдЦреЛрд▓реЗрдВ рдФрд░ **рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ (manage) under Invitation accepted**.
* ![](<../../../.gitbook/assets/image (281).png>)
4. **`Resend invite?`** рдХреЛ **Yes** рдореЗрдВ рдмрджрд▓реЗрдВ рдФрд░ рдЖрдкрдХреЛ рдПрдХ рдЖрдордВрддреНрд░рдг URL рдорд┐рд▓реЗрдЧрд╛:
* ![](<../../../.gitbook/assets/image (205).png>)
5. **URL** рдХреЙрдкреА рдХрд░реЗрдВ рдФрд░ **рдЦреЛрд▓реЗрдВ**, рдЖрдордВрддреНрд░рд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ **рд▓реЙрдЧрд┐рди** рдХрд░реЗрдВ рдФрд░ рдЖрдордВрддреНрд░рдг **рд╕реНрд╡реАрдХрд╛рд░** рдХрд░реЗрдВ
6.  **cli** рдореЗрдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ **рд▓реЙрдЧрд┐рди** рдХрд░реЗрдВ рдФрд░ рджреНрд╡рд┐рддреАрдпрдХ рдИрдореЗрд▓ рд╕реЗрдЯ рдХрд░реЗрдВ

{% code overflow="wrap" %}
```powershell
# Login
$password = ConvertTo-SecureString 'password' - AsPlainText -Force
$creds = New-Object
System.Management.Automation.PSCredential('externaltester@somedomain.onmicrosoft.com', $Password)
Connect-AzureAD -Credential $creds -TenantId <tenant_id_of_attacked_domain>

# Chnage OtherMails setting
Set-AzureADUser -ObjectId <OBJECT-ID> -OtherMails <Username>@<TENANT_NAME>.onmicrosoft.com -Verbose
```
{% endcode %}

## References

* [https://www.mnemonic.io/resources/blog/abusing-dynamic-groups-in-azure-ad-for-privilege-escalation/](https://www.mnemonic.io/resources/blog/abusing-dynamic-groups-in-azure-ad-for-privilege-escalation/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
