# Az - Dynamic Groups Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**Dynamic groups**는 **규칙**이 설정된 그룹으로, 규칙에 맞는 모든 **사용자 또는 장치**가 그룹에 추가됩니다. 사용자의 **속성**이 **변경**될 때마다 동적 규칙이 **재검토**됩니다. 새로운 **규칙**이 **생성**될 때마다 모든 장치와 사용자가 **검토**됩니다.

동적 그룹에는 **Azure RBAC 역할**을 할당할 수 있지만, 동적 그룹에 **AzureAD 역할**을 추가하는 것은 **불가능**합니다.

이 기능은 Azure AD 프리미엄 P1 라이선스가 필요합니다.

## Privesc

기본적으로 모든 사용자가 Azure AD에서 게스트를 초대할 수 있으므로, 동적 그룹 **규칙**이 **속성**을 기반으로 사용자에게 **권한**을 부여하는 경우, 새로운 **게스트**에서 이 속성을 **설정**하여 **권한을 상승**시킬 수 있습니다. 게스트도 자신의 프로필을 관리하고 이러한 속성을 변경할 수 있습니다.

동적 멤버십을 허용하는 그룹 가져오기: `Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}`

### Example

* **Rule example**: `(user.otherMails -any (_ -contains "tester")) -and (user.userType -eq "guest")`
* **Rule description**: 보조 이메일에 'tester' 문자열이 포함된 모든 게스트 사용자가 그룹에 추가됩니다.

1. **Azure Active Directory** -> **Users**로 이동하여 `Want to switch back to the legacy users list experience? Click here to leave the preview`를 **클릭**
2. **`New guest user`**를 클릭하고 이메일을 **초대**
3. 초대가 전송되면 **사용자의 프로필**이 Azure AD에 **추가**됩니다. 사용자의 프로필을 열고 **Invitation accepted** 아래의 **(manage)**를 **클릭**
* ![](<../../../.gitbook/assets/image (281).png>)
4. **`Resend invite?`**를 **Yes**로 변경하면 초대 URL을 받게 됩니다:
* ![](<../../../.gitbook/assets/image (205).png>)
5. **URL**을 복사하여 **열고**, 초대된 사용자로 **로그인**하고 초대를 **수락**
6. cli에서 사용자로 **로그인**하고 보조 이메일 설정

{% code overflow="wrap" %}
```powershell
# Login
$password = ConvertTo-SecureString 'password' - AsPlainText -Force
$creds = New-Object
System.Management.Automation.PSCredential('externaltester@somedomain.onmicrosoft.com', $Password)
Connect-AzureAD -Credential $creds -TenantId <tenant_id_of_attacked_domain>

# Chnage OtherMails setting
Set-AzureADUser -ObjectId <OBJECT-ID> -OtherMails <Username>@<TENANT_NAME>.onmicrosoft.com -Verbose
```
{% endcode %}

## References

* [https://www.mnemonic.io/resources/blog/abusing-dynamic-groups-in-azure-ad-for-privilege-escalation/](https://www.mnemonic.io/resources/blog/abusing-dynamic-groups-in-azure-ad-for-privilege-escalation/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
