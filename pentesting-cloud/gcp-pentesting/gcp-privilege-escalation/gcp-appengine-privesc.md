# GCP - AppEngine Privesc

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して**ハッキングトリックを共有**してください。

</details>
{% endhint %}

## App Engine

App Engineに関する詳細情報は次を確認してください:

{% content-ref url="../gcp-services/gcp-app-engine-enum.md" %}
[gcp-app-engine-enum.md](../gcp-services/gcp-app-engine-enum.md)
{% endcontent-ref %}

### `appengine.applications.get`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.operations.list`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.create`, `appengine.versions.get`, `appengine.versions.list`, `cloudbuild.builds.get`,`iam.serviceAccounts.actAs`, `resourcemanager.projects.get`, `storage.objects.create`, `storage.objects.list`

これらは**`gcloud` cliを使用してAppをデプロイするために必要な権限**です。おそらく**`get`**と**`list`**は**回避**できるかもしれません。

Pythonのコード例は[https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine](https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine)で見つけることができます。

デフォルトでは、Appサービスの名前は**`default`**になり、同じ名前のインスタンスは1つしか存在しません。\
これを変更して2番目のAppを作成するには、**`app.yaml`**でルートキーの値を**`service: my-second-app`**のように変更します。
```bash
cd python-docs-samples/appengine/flexible/hello_world
gcloud app deploy #Upload and start application inside the folder
```
**10-15分待ってもう一度デプロイ**を呼び出し、数分待ちます。

{% hint style="info" %}
**使用するサービスアカウントを指定することが可能**ですが、デフォルトではApp EngineのデフォルトSAが使用されます。
{% endhint %}

アプリケーションのURLは、`https://<proj-name>.oa.r.appspot.com/`または`https://<service_name>-dot-<proj-name>.oa.r.appspot.com`のようなものです。

### `appengine.instances.enableDebug`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.get`, `appengine.versions.list`, `compute.projects.get`

これらの権限を持つと、**柔軟な**タイプのApp Engineインスタンスに**SSH経由でログイン**することが可能です（標準ではありません）。一部の**`list`**および**`get`**権限は、**実際には必要ない**かもしれません。
```bash
gcloud app instances ssh --service <app-name> --version <version-id> <ID>
```
### `appengine.applications.update`, `appengine.operations.get`

これはおそらく、バックグラウンドで使用されるGoogleのサービスアカウントを設定するために変更するだけだと思いますので、これを悪用してサービスアカウントを盗むことはできないと思います。

{% code overflow="wrap" %}
```bash
gcloud app update --service-account=<sa_email>
```
{% endcode %}

### `appengine.versions.getFileContents`, `appengine.versions.update`

これらの権限をどのように使用するか、またそれらが役立つかどうかはわかりません（コードを変更すると新しいバージョンが作成されるため、コードを更新するか、IAMロールを更新するかはわかりませんが、おそらくバケット内のコードを変更できるはずですか？）。

### バケット上の書き込みアクセス

ソースコードが格納されているバケットに対する書き込みアクセス権があっても、**ソースコードと `manifest.json` を変更して任意のコードを実行することはできませんでした**。\
新しいバージョンが作成され、ソースコードとマニフェストがアップロードされるタイミングを検出し、それらを変更して新しいバージョンがバックドア付きのものを使用するようにすることができるかもしれません。

また、コンテナレイヤーがバケットに保存されているようですが、それらを変更することは可能ですか？

{% hint style="success" %}
AWSハッキングの学習と実践：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と実践：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または [**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
{% endhint %}
