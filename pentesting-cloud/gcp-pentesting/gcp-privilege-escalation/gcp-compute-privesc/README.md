# GCP - Εscalation προνομίων Compute

{% hint style="success" %}
Μάθε & εξάσκησε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθε & εξάσκησε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs** στα αποθετήρια του [**HackTricks**](https://github.com/carlospolop/hacktricks) και του [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Compute

Για περισσότερες πληροφορίες σχετικά με το Compute και το VPC (δίκτυο) στο GCP, ελέγξτε:

{% content-ref url="../../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

### `compute.projects.setCommonInstanceMetadata`

Με αυτήν την άδεια μπορείτε να **τροποποιήσετε** τις πληροφορίες **metadata** ενός **instance** και να αλλάξετε τα **εξουσιοδοτημένα κλειδιά ενός χρήστη**, ή να **δημιουργήσετε** έναν **νέο χρήστη με δικαιώματα sudo**. Έτσι, θα μπορείτε να εκτελέσετε μέσω SSH σε οποιοδήποτε VM instance και να κλέψετε το GCP Service Account με το οποίο λειτουργεί το Instance.\
Περιορισμοί:

* Σημειώστε ότι τα GCP Service Accounts που τρέχουν σε VM instances από προεπιλογή έχουν ένα **πολύ περιορισμένο εύρος εφαρμογής**
* Θα πρέπει να μπορείτε να **επικοινωνήσετε με τον SSH** server για να συνδεθείτε

Για περισσότερες πληροφορίες σχετικά με το πώς να εκμεταλλευτείτε αυτήν την άδεια, ελέγξτε:

{% content-ref url="gcp-add-custom-ssh-metadata.md" %}
[gcp-add-custom-ssh-metadata.md](gcp-add-custom-ssh-metadata.md)
{% endcontent-ref %}

### `compute.instances.setMetadata`

Αυτή η άδεια δίνει τα **ίδια προνόμια με την προηγούμενη άδεια** αλλά για συγκεκριμένα instances αντί για ολόκληρο ένα project. Οι **ίδιες εκμεταλλεύσεις και περιορισμοί όπως και για την προηγούμενη ενότητα ισχύουν**.

### `compute.instances.setIamPolicy`

Αυτού του είδους άδεια θα σας επιτρέψει να **χορηγήσετε στον εαυτό σας ένα ρόλο με τις προηγούμενες άδειες** και να εξελίξετε τα προνόμια καταχρώμενοι τα.

### **`compute.instances.osLogin`**

Αν **το OSLogin είναι ενεργοποιημένο στο instance**, με αυτήν την άδεια μπορείτε απλά να εκτελέσετε **`gcloud compute ssh [INSTANCE]`** και να συνδεθείτε στο instance. Δεν θα έχετε δικαιώματα root μέσα στο instance.

### **`compute.instances.osAdminLogin`**

Αν **το OSLogin είναι ενεργοποιημένο στο instance**, με αυτήν την άδεια μπορείτε απλά να εκτελέσετε **`gcloud compute ssh [INSTANCE]`** και να συνδεθείτε στο instance. Θα έχετε δικαιώματα root μέσα στο instance.

### `compute.instances.create`,`iam.serviceAccounts.actAs, compute.disks.create`, `compute.instances.create`, `compute.instances.setMetadata`, `compute.instances.setServiceAccount`, `compute.subnetworks.use`, `compute.subnetworks.useExternalIp`

Είναι δυνατόν να **δημιουργήσετε ένα εικονικό μηχάνημα με εκχωρημένο Service Account και να κλέψετε το token** του service account προσπελαίζοντας τα metadata για να εξελίξετε τα προνόμιά σας σε αυτό.

Το script εκμετάλλευσης για αυτήν τη μέθοδο μπορεί να βρεθεί [εδώ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py).

### `osconfig.patchDeployments.create` | `osconfig.patchJobs.exec`

Αν έχετε τις άδειες **`osconfig.patchDeployments.create`** ή **`osconfig.patchJobs.exec`** μπορείτε να δημιουργήσετε ένα [**patch job ή deployment**](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching). Αυτό θα σας επιτρέψει να μετακινηθείτε πλαγίως στο περιβάλλον και να κερδίσετε εκτέλεση κώδικα σε όλα τα compute instances εντός ενός project.

Αν θέλετε να εκμεταλλευτείτε χειροκίνητα αυτό, θα πρέπει να δημιουργήσετε είτε ένα [patch job](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_job.json) είτε ένα [deployment](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_deployment.json) για ένα patch job εκτελέστε:

`gcloud compute os-config patch-jobs execute --file=patch.json`

Για να αναπτύξετε ένα patch deployment:

`gcloud compute os-config patch-deployments create my-update --file=patch.json`

Υπάρχουν αυτοματοποιημένα εργαλεία όπως το [patchy](https://github.com/rek7/patchy) που υπάρχουν για την ανίχνευση χαλαρών δικαιωμάτων και την αυτόματη μετακίνηση πλαγίως.

**Μπορείτε επίσης να καταχραστείτε αυτό για μόνιμη παραμονή.**

### `compute.machineImages.setIamPolicy`

**Χορηγήστε στον εαυτό σας επιπλέον δικαιώματα** στην εικόνα του compute.

### `compute.snapshots.setIamPolicy`

**Χορηγήστε στον εαυτό σας επιπλέον δικαιώματα** σε ένα αντίγραφο ασφαλείας δίσκου.

### `compute.disks.setIamPolicy`

**Χορηγήστε στον εαυτό σας επιπλέον δικαιώματα** σε ένα δίσκο.

### Παράκαμψη Εμβέλειας Πρόσβασης

Ακολουθώντας αυτόν τον σύνδεσμο θα βρείτε μερικές [**ιδέες για να προσπαθήσετε να παρακάμψετε τις εμβέλειες πρόσβασης**](../../../gcp-security/gcp-privilege-escalation/).

### Τοπική Ανόδος Προνομίων στο GCP Compute instance

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Αναφορές

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
Μάθε & εξάσκησε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθε & εξάσκησε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs** στα αποθετήρια του [**HackTricks**](https://github.com/carlospolop/hacktricks) και του [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
