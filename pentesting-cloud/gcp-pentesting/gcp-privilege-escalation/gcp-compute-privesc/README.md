# GCP - Kuboresha Mamlaka

{% hint style="success" %}
Jifunze na zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks ya Mtaalam wa Timu Nyekundu ya AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks ya Mtaalam wa Timu Nyekundu ya GCP (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>unga mkono HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}

## Kuboresha

Kwa habari zaidi kuhusu Kuboresha na VPC (mtandao) katika GCP angalia:

{% content-ref url="../../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

### `compute.projects.setCommonInstanceMetadata`

Kwa idhini hiyo unaweza **kurekebisha** habari ya **metadata** ya **mfano** na kubadilisha **funguo zilizoidhinishwa za mtumiaji**, au **kuunda** **mtumiaji mpya mwenye ruhusa za sudo**. Kwa hivyo, utaweza kutekeleza kupitia SSH kwenye kifaa chochote cha VM na kuiba Akaunti ya Huduma ya GCP Mfano unaoendesha nayo.\
Vikwazo:

* Tafadhali kumbuka kuwa Akaunti za Huduma za GCP zinazoendesha katika mifano ya VM kwa chaguo-msingi zina **wigo mdogo sana**
* Utahitaji kuwa **na uwezo wa kuwasiliana na seva ya SSH** ili kuingia

Kwa habari zaidi kuhusu jinsi ya kutumia idhini hii angalia:

{% content-ref url="gcp-add-custom-ssh-metadata.md" %}
[gcp-add-custom-ssh-metadata.md](gcp-add-custom-ssh-metadata.md)
{% endcontent-ref %}

### `compute.instances.setMetadata`

Idhini hii inatoa **madaraka sawa na idhini iliyopita** lakini kwa mifano maalum badala ya mradi mzima. **Mbinu na vikwazo sawa kama kwa sehemu iliyopita inatumika**.

### `compute.instances.setIamPolicy`

Aina hii ya idhini itakuruhusu **kujipatia jukumu lenye idhini za awali** na kuboresha mamlaka kwa kuzitumia vibaya.

### **`compute.instances.osLogin`**

Ikiwa **OSLogin imezimwa kwenye mfano**, na idhini hii unaweza tu kukimbia **`gcloud compute ssh [MFANO]`** na kuunganisha kwenye mfano. **Hautakuwa na mamlaka ya msingi** ndani ya mfano.

### **`compute.instances.osAdminLogin`**

Ikiwa **OSLogin imezimwa kwenye mfano**, na idhini hii unaweza tu kukimbia **`gcloud compute ssh [MFANO]`** na kuunganisha kwenye mfano. Utakuwa na **mamlaka ya msingi** ndani ya mfano.

### `compute.instances.create`,`iam.serviceAccounts.actAs, compute.disks.create`, `compute.instances.create`, `compute.instances.setMetadata`, `compute.instances.setServiceAccount`, `compute.subnetworks.use`, `compute.subnetworks.useExternalIp`

Inawezekana **kuunda mashine ya virtuali na Akaunti ya Huduma iliyopewa na kuiba token** ya akaunti ya huduma kwa kupata metadata kuboresha mamlaka kwake.

Skripti ya kudukua kwa njia hii inaweza kupatikana [hapa](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py).

### `osconfig.patchDeployments.create` | `osconfig.patchJobs.exec`

Ikiwa una **`osconfig.patchDeployments.create`** au **`osconfig.patchJobs.exec`** idhini unaweza kuunda [**kazi au upelekaji wa kurekebisha**](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching). Hii itakuruhusu kusonga kwa upande katika mazingira na kupata utekelezaji wa nambari kwenye mifano yote ya kuhesabu ndani ya mradi.

Ikiwa unataka kutumia hii kwa mikono utahitaji kuunda au [kazi ya kurekebisha](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_job.json) au [upelekaji](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_deployment.json) kwa kazi ya kurekebisha:

`gcloud compute os-config patch-jobs execute --file=patch.json`

Kwa kupeleka upelekaji wa kurekebisha:

`gcloud compute os-config patch-deployments create my-update --file=patch.json`

Zana za kiotomatiki kama [patchy](https://github.com/rek7/patchy) zipo kugundua idhini dhaifu na kusonga kwa upande kiotomatiki.

**Unaweza pia kutumia hii kwa uthabiti.**

### `compute.machineImages.setIamPolicy`

**Jipatie mamlaka ya ziada** kwa Picha ya Kuhesabu.

### `compute.snapshots.setIamPolicy`

**Jipatie mamlaka ya ziada** kwa picha ya diski.

### `compute.disks.setIamPolicy`

**Jipatie mamlaka ya ziada** kwa diski.

### Kupuuza Vipimo vya Kufikia

Kufuata kiungo hiki utapata [**mawazo ya jaribu kupuuza vipimo vya ufikiaji**](../../../gcp-security/gcp-privilege-escalation/).

### Kuboresha Mamlaka ya Kienyeji kwenye Kifaa cha Kuhesabu cha GCP

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Marejeo

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
Jifunze na zoezi la Udukuzi wa AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Mafunzo ya HackTricks ya Mtaalam wa Timu Nyekundu ya AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na zoezi la Udukuzi wa GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Mafunzo ya HackTricks ya Mtaalam wa Timu Nyekundu ya GCP (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>unga mkono HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
