# GCP - Rekenaarvoorregverhoging

{% hint style="success" %}
Leer & oefen AWS-hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP-hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

## Rekenaar

Vir meer inligting oor Rekenaars en VPC (netwerk) in GCP, kyk:

{% content-ref url="../../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

### `compute.projects.setCommonInstanceMetadata`

Met daardie toestemming kan jy die **metadata-inligting** van 'n **instansie wysig** en die **geautoriseerde sleutels van 'n gebruiker verander**, of 'n **nuwe gebruiker met sudo-regte skep**. Daarom sal jy in staat wees om via SSH in te tree na enige VM-instansie en die GCP-diensrekening wat die Instansie gebruik, te steel.\
Beperkings:

* Let daarop dat GCP-diensrekeninge wat standaard in VM-instansies loop, 'n **baie beperkte omvang** het
* Jy sal **in staat moet wees om die SSH-bediener te kontak** om in te teken

Vir meer inligting oor hoe om hierdie toestemming te misbruik, kyk:

{% content-ref url="gcp-add-custom-ssh-metadata.md" %}
[gcp-add-custom-ssh-metadata.md](gcp-add-custom-ssh-metadata.md)
{% endcontent-ref %}

### `compute.instances.setMetadata`

Hierdie toestemming gee dieselfde regte as die vorige toestemming, maar oor spesifieke instansies in plaas van 'n hele projek. Dieselfde misbruik en beperkings as vir die vorige afdeling geld.

### `compute.instances.setIamPolicy`

Hierdie soort toestemming sal jou toelaat om jouself 'n rol met die vorige regte toe te ken en voorregte te verhoog deur dit te misbruik.

### **`compute.instances.osLogin`**

As **OSLogin geaktiveer is in die instansie**, met hierdie toestemming kan jy net **`gcloud compute ssh [INSTANSIE]`** hardloop en aan die instansie koppel. Jy sal **nie root-regte** binne die instansie h√™ nie.

### **`compute.instances.osAdminLogin`**

As **OSLogin geaktiveer is in die instansie**, met hierdie toestemming kan jy net **`gcloud compute ssh [INSTANSIE]`** hardloop en aan die instansie koppel. Jy sal **root-regte** binne die instansie h√™.

### `compute.instances.create`,`iam.serviceAccounts.actAs, compute.disks.create`, `compute.instances.create`, `compute.instances.setMetadata`, `compute.instances.setServiceAccount`, `compute.subnetworks.use`, `compute.subnetworks.useExternalIp`

Dit is moontlik om 'n virtuele masjien te skep met 'n toegewysde Diensrekening en die token van die diensrekening te steel deur toegang tot die metadata te verkry om voorregte daartoe te verhoog.

Die misbruikskrip vir hierdie metode kan hier gevind word [hier](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py).

### `osconfig.patchDeployments.create` | `osconfig.patchJobs.exec`

As jy die **`osconfig.patchDeployments.create`** of **`osconfig.patchJobs.exec`** toestemmings het, kan jy 'n [**patch-job of -implementering**](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching) skep. Dit sal jou in staat stel om lateraal in die omgewing te beweeg en kode-uitvoering op al die rekenaarinstansies binne 'n projek te verkry.

As jy hierdie handmatig wil misbruik, sal jy een van die volgende moet skep: 'n [patch-job](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_job.json) of 'n [implementering](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_deployment.json) vir 'n patch-job hardloop:

`gcloud compute os-config patch-jobs execute --file=patch.json`

Om 'n patch-implementering te implementeer:

`gcloud compute os-config patch-deployments create my-update --file=patch.json`

Geoutomatiseerde gereedskap soos [patchy](https://github.com/rek7/patchy) bestaan om lakse toestemmings op te spoor en outomaties lateraal te beweeg.

**Jy kan dit ook misbruik vir volharding.**

### `compute.machineImages.setIamPolicy`

**Ken jouself ekstra regte toe** tot rekenaarbeeld.

### `compute.snapshots.setIamPolicy`

**Ken jouself ekstra regte toe** tot 'n skyf-snapshot.

### `compute.disks.setIamPolicy`

**Ken jouself ekstra regte toe** tot 'n skyf.

### Bypass Toegangsbereike

Deur hierdie skakel te volg, vind jy 'n paar [**idees om te probeer om toegangsbereike te omseil**](../../../gcp-security/gcp-privilege-escalation/).

### Plaaslike Voorregverhoging in GCP Rekenaarinstansie

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Verwysings

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{% hint style="success" %}
Leer & oefen AWS-hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP-hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
