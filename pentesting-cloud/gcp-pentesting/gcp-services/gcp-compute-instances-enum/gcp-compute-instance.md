# GCP - Compute Instances

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、ハッキングトリックを共有してください。

</details>
{% endhint %}

## 基本情報

Google Cloud Compute Instancesは、Googleのクラウドインフラストラクチャ上の**カスタマイズ可能な仮想マシン**であり、幅広いアプリケーションに対してスケーラブルでオンデマンドのコンピューティングパワーを提供します。これらは、グローバル展開、永続的なストレージ、柔軟なOSの選択肢、強力なネットワーキングおよびセキュリティ統合などの機能を提供し、ウェブサイトのホスティング、データ処理、およびクラウドで効率的にアプリケーションを実行するための多目的な選択肢となります。

### 機密VM

機密VMは、最新世代のAMD EPYCプロセッサが提供する**ハードウェアベースのセキュリティ機能**を使用しており、メモリの暗号化やセキュアな暗号化仮想化などが含まれています。これらの機能により、VMは、ホストオペレーティングシステムやハイパーバイザーさえもからデータを保護し、その中で処理および保存されるデータを保護することができます。

機密VMを実行するには、**マシンのタイプ**、ネットワーク**インターフェース**、**ブートディスクイメージ**などを変更する必要がある場合があります。

### ディスクとディスクの暗号化

使用するディスクを**選択**するか、**新しいディスクを作成**することができます。新しいディスクを選択する場合、以下の操作が可能です:

* ディスクの**サイズ**を選択
* **OS**を選択
* インスタンスの削除時にディスクを削除するかどうかを指定
* **暗号化**: **デフォルト**では**Googleが管理するキー**が使用されますが、**KMSからキーを選択**するか、**使用するローカルキーを指定**することもできます。

### コンテナのデプロイ

仮想マシン内に**コンテナ**をデプロイすることが可能です。\
使用する**イメージ**を構成したり、内部で実行する**コマンド**を設定したり、**引数**を設定したり、**ボリューム**をマウントしたり、**環境変数**（機密情報？）を設定したりし、このコンテナに対して実行権限を**特権モード**で設定したり、stdinと擬似TTYを設定したりすることが可能です。

### サービスアカウント

デフォルトでは、**Compute Engineデフォルトサービスアカウント**が使用されます。このSAのメールアドレスは次のようになります: `<proj-num>-compute@developer.gserviceaccount.com`\
このサービスアカウントには、プロジェクト全体で**Editorロール（高い権限）**が付与されています。

また、**デフォルトのアクセススコープ**は以下の通りです:

* **https://www.googleapis.com/auth/devstorage.read\_only** -- バケットへの読み取りアクセス :)
* https://www.googleapis.com/auth/logging.write
* https://www.googleapis.com/auth/monitoring.write
* https://www.googleapis.com/auth/servicecontrol
* https://www.googleapis.com/auth/service.management.readonly
* https://www.googleapis.com/auth/trace.append

ただし、**クリックで`cloud-platform`を付与**するか、**カスタムのスコープを指定**することも可能です。

<figure><img src="../../../../.gitbook/assets/image (138).png" alt=""><figcaption></figcaption></figure>

### ファイアウォール

HTTPおよびHTTPSトラフィックを許可することが可能です。

<figure><img src="../../../../.gitbook/assets/image (137).png" alt=""><figcaption></figcaption></figure>

### ネットワーキング

* **IPフォワーディング**: インスタンスの作成時に**IPフォワーディングを有効にする**ことが可能です。
* **ホスト名**: インスタンスに永続的なホスト名を指定することが可能です。
* **インターフェース**: ネットワークインターフェースを追加することが可能です。

### 追加のセキュリティ

これらのオプションはVMのセキュリティを**向上**させ、推奨されています:

* **セキュアブート:** セキュアブートは、VMインスタンスをブートレベルおよびカーネルレベルのマルウェアやルートキットから保護します。
* **vTPMの有効化:** 仮想信頼プラットフォームモジュール（vTPM）は、ゲストVMのプリブートおよびブートの整合性を検証し、キーの生成と保護を提供します。
* **整合性監視:** 整合性監視により、Stackdriverレポートを使用して、vTPMが有効になっている場合に、シールドされたVMインスタンスのランタイムブート整合性を監視および検証できます。

### VMアクセス

VMへのアクセスを有効にする一般的な方法は、特定のSSH公開鍵をVMにアクセスできるようにすることです。\
ただし、IAMを使用して`os-config`サービスを介してVMへのアクセスを有効にすることも可能です。さらに、このサービスを使用してVMにアクセスする際に2要素認証を有効にすることも可能です。\
この**サービス**が**有効**になると、**SSHキーを介したアクセスが無効**になります。

<figure><img src="../../../../.gitbook/assets/image (139).png" alt=""><figcaption></figcaption></figure>

### メタデータ

マシンが起動するたびに実行される**シェルコマンド**である**自動化**（AWSのuserdata）を定義することが可能です。

また、メタデータエンドポイントからアクセス可能な**追加のメタデータキー値**を定義することも可能です。この情報は、環境変数や起動/シャットダウンスクリプトに使用されることが一般的です。これは、列挙セクションのコマンド内の**`describe`メソッド**を使用して取得できますが、インスタンス内部からメタデータエンドポイントにアクセスして取得することもできます。
```bash
# view project metadata
curl "http://metadata.google.internal/computeMetadata/v1/project/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"

# view instance metadata
curl "http://metadata.google.internal/computeMetadata/v1/instance/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"
```
さらに、**添付されたサービスアカウントの認証トークン**と**インスタンス、ネットワーク、プロジェクトに関する一般情報**も**メタデータエンドポイント**から利用可能になります。詳細は以下をチェックしてください：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### 暗号化

デフォルトではGoogleが管理する暗号化キーが使用されますが、顧客管理型暗号化キー（CMEK）を構成することもできます。また、使用されているCMEKが取り消された場合の対処方法も構成できます：何もしないかVMをシャットダウンするか。

<figure><img src="../../../../.gitbook/assets/image (140).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**購読プラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
{% endhint %}
