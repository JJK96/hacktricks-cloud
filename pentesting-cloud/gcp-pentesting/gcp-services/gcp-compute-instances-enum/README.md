# GCP - 计算枚举

{% hint style="success" %}
学习并练习AWS Hacking：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 检查[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}

## GCP VPC & 网络

了解这在以下文件中的工作原理：

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### 枚举

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

您可以轻松使用[https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)找到具有开放防火墙规则的计算实例

## 计算实例

这是您可以在GCP内部运行虚拟机的方式。查看此页面以获取更多信息：

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### 枚举
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
### 提权

在以下页面中，您可以查看如何**滥用计算权限以提升特权**：

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### 未认证枚举

{% content-ref url="../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### 后渗透

{% content-ref url="../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### 持久性

{% content-ref url="../../../gcp-security/gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../../gcp-security/gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## 串行控制台日志

Compute Engine 串行控制台日志是一个功能，允许您**查看和诊断虚拟机实例的引导和操作系统日志**。

串行控制台日志提供了实例引导过程的**低级视图**，包括内核消息、init 脚本和引导过程中发生的其他系统事件。这对于调试引导问题、识别配置错误或软件错误，或解决网络连接问题非常有用。

这些日志**可能会暴露系统日志中的敏感信息**，低特权用户通常无法看到，但通过适当的 IAM 权限，您可能能够阅读它们。

您可以使用以下[gcloud 命令](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output)来查询串行端口日志（所需权限为 `compute.instances.getSerialPortOutput`）:
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## 操作系统配置管理器

您可以使用操作系统配置管理服务来部署、查询和维护虚拟机实例（VM）的一致配置（期望状态和软件）。在Compute Engine上，您必须使用[guest policies](https://cloud.google.com/compute/docs/os-config-management#guest-policy)来维护虚拟机上的一致软件配置。

操作系统配置管理功能允许您定义配置策略，指定应安装哪些软件包，应启用哪些服务，以及应在您的VM上存在哪些文件或配置。您可以使用声明性方法来管理VM的软件配置，这使您能够更轻松地自动化和扩展配置管理流程。

这也允许通过IAM权限登录实例，因此非常**有用于权限提升和枢纽**。

{% hint style="warning" %}
为了在整个项目或实例中**启用操作系统配置**，您只需要在所需级别将**`enable-oslogin`**元数据键设置为**`true`**。\
此外，您可以将元数据**`enable-oslogin-2fa`**设置为**`true`**以启用双因素认证。

当您在创建实例时启用它，元数据键将自动设置。
{% endhint %}

关于**OS-config中的双因素认证**，**仅适用于用户**，如果是SA（如计算SA），则不需要任何额外操作。

### 枚举
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## 镜像

### 自定义镜像

自定义计算机镜像可能包含敏感细节或其他易受攻击的配置，您可以利用这些信息。

创建镜像时，您可以选择3种加密类型：使用Google托管密钥（默认）、来自KMS的密钥，或客户端提供的原始密钥。

#### 枚举

您可以使用以下命令查询项目中非标准镜像的列表：

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

然后，您可以以多种格式[**导出**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export)来自任何镜像的**虚拟磁盘**。以下命令将以qcow2格式导出图像`test-image`，使您可以下载该文件并在本地构建虚拟机以进行进一步调查：
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### 提权

检查计算实例特权提升部分。

### 自定义实例模板

一个[**实例模板**](https://cloud.google.com/compute/docs/instance-templates/) **定义实例属性**以帮助部署一致的配置。这些可能包含与运行实例的自定义元数据相同类型的敏感数据。您可以使用以下命令进行调查：
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
## 快照

**快照是磁盘的备份**。请注意，这与克隆磁盘（另一个可用功能）不同。\
**快照**将使用与其来源磁盘**相同的加密**。
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### 提权

检查计算实例提权部分。

## 参考

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

{% hint style="success" %}
学习并练习 AWS 黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习 GCP 黑客技术: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 检查 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}
