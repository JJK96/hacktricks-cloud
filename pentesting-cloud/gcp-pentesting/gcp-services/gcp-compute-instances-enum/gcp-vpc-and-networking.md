# GCP - VPC & Networking

{% hint style="success" %}
AWS Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХреЛ рд╕рдорд░реНрдерди рджреЗрдВ</summary>

* [**subscription plans**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) рдкрд░ рд╣рдореЗрдВ рдлреЙрд▓реЛ рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>
{% endhint %}

## **GCP Compute Networking рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ**

**VPCs** рдореЗрдВ **Firewall** рдирд┐рдпрдо рд╣реЛрддреЗ рд╣реИрдВ рдЬреЛ VPC рдореЗрдВ рдЖрдиреЗ рд╡рд╛рд▓реЗ рдЯреНрд░реИрдлрд┐рдХ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВред VPCs рдореЗрдВ **subnetworks** рднреА рд╣реЛрддреЗ рд╣реИрдВ рдЬрд╣рд╛рдВ **virtual machines** рдХреЛ **рдХрдиреЗрдХреНрдЯ** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред\
AWS рдХреА рддреБрд▓рдирд╛ рдореЗрдВ, **Firewall** **AWS** **Security Groups рдФрд░ NACLs** рдХреЗ рд╕рдмрд╕реЗ рдХрд░реАрдм рд╣реЛрдЧрд╛, рд▓реЗрдХрд┐рди рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдпреЗ **VPC рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд** рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рдкреНрд░рддреНрдпреЗрдХ instance рдореЗрдВ рдирд╣реАрдВред

## **GCP рдореЗрдВ VPC, Subnetworks & Firewalls**

Compute Instances **subnetworks** рд╕реЗ рдЬреБрдбрд╝реЗ рд╣реЛрддреЗ рд╣реИрдВ рдЬреЛ **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)) рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рд╣реЛрддреЗ рд╣реИрдВред GCP рдореЗрдВ security groups рдирд╣реАрдВ рд╣реЛрддреЗ, рдмрд▓реНрдХрд┐ [**VPC firewalls**](https://cloud.google.com/vpc/docs/firewalls) рд╣реЛрддреЗ рд╣реИрдВ рдЬрд┐рдирдХреЗ рдирд┐рдпрдо рдЗрд╕ рдиреЗрдЯрд╡рд░реНрдХ рд╕реНрддрд░ рдкрд░ рдкрд░рд┐рднрд╛рд╖рд┐рдд рд╣реЛрддреЗ рд╣реИрдВ рд▓реЗрдХрд┐рди рдкреНрд░рддреНрдпреЗрдХ VM Instance рдкрд░ рд▓рд╛рдЧреВ рд╣реЛрддреЗ рд╣реИрдВред

### Subnetworks

рдПрдХ **VPC** рдореЗрдВ **рдХрдИ subnetworks** рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред рдкреНрд░рддреНрдпреЗрдХ **subnetwork рдПрдХ рдХреНрд╖реЗрддреНрд░ рдореЗрдВ** рд╣реЛрддрд╛ рд╣реИред

### Firewalls

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, рд╣рд░ рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ рджреЛ [**implied firewall rules**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules) рд╣реЛрддреЗ рд╣реИрдВ: **allow outbound** рдФрд░ **deny inbound**ред

рдЬрдм рдПрдХ GCP рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдПрдХ VPC рдЬрд┐рд╕реЗ **`default`** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ, рднреА рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд firewall рдирд┐рдпрдо рд╣реЛрддреЗ рд╣реИрдВ:

* **default-allow-internal:** `default` рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдЕрдиреНрдп instances рд╕реЗ рд╕рднреА рдЯреНрд░реИрдлрд┐рдХ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдВ
* **default-allow-ssh:** рд╣рд░ рдЬрдЧрд╣ рд╕реЗ 22 рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдВ
* **default-allow-rdp:** рд╣рд░ рдЬрдЧрд╣ рд╕реЗ 3389 рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдВ
* **default-allow-icmp:** рд╣рд░ рдЬрдЧрд╣ рд╕реЗ ping рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдВ

{% hint style="warning" %}
рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, **firewall рдирд┐рдпрдо** **рдЖрдВрддрд░рд┐рдХ IP рдкрддреЛрдВ** рдХреЗ рд▓рд┐рдП **рдЕрдзрд┐рдХ рдЕрдиреБрдорддрд┐рдкреВрд░реНрдг** рд╣реЛрддреЗ рд╣реИрдВред рдбрд┐рдлрд╝реЙрд▓реНрдЯ VPC Compute Instances рдХреЗ рдмреАрдЪ рд╕рднреА рдЯреНрд░реИрдлрд┐рдХ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред
{% endhint %}

рдбрд┐рдлрд╝реЙрд▓реНрдЯ VPC рдпрд╛ рдирдП VPCs рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХ **Firewall рдирд┐рдпрдо** рдмрдирд╛рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред [**Firewall рдирд┐рдпрдо**](https://cloud.google.com/vpc/docs/firewalls) рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд **рд╡рд┐рдзрд┐рдпреЛрдВ** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ instances рдкрд░ рд▓рд╛рдЧреВ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ:

* [**Network tags**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Service accounts**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **VPC рдХреЗ рднреАрддрд░ рд╕рднреА instances**

рджреБрд░реНрднрд╛рдЧреНрдп рд╕реЗ, рдЗрдВрдЯрд░рдиреЗрдЯ рдкрд░ рдЦреБрд▓реЗ рдкреЛрд░реНрдЯреНрд╕ рдХреЗ рд╕рд╛рде рд╕рднреА Compute Instances рдХреЛ рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рд╕рд░рд▓ `gcloud` рдХрдорд╛рдВрдб рдирд╣реАрдВ рд╣реИред рдЖрдкрдХреЛ firewall рдирд┐рдпрдореЛрдВ, network tags, services accounts, рдФрд░ instances рдХреЗ рдмреАрдЪ рд╕рдВрдмрдВрдз рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ [рдЗрд╕ python script](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рдЬреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдирд┐рд░реНрдпрд╛рдд рдХрд░реЗрдЧрд╛:

* CSV рдлрд╝рд╛рдЗрд▓ рдЬреЛ instance, public IP, allowed TCP, allowed UDP рджрд┐рдЦрд╛рддреА рд╣реИ
* nmap рд╕реНрдХреИрди рдЬреЛ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдЗрдВрдЯрд░рдиреЗрдЯ (0.0.0.0/0) рд╕реЗ ingress рдХреА рдЕрдиреБрдорддрд┐ рд╡рд╛рд▓реЗ рд╕рднреА instances рдХреЛ рд▓рдХреНрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ
* masscan рдЬреЛ рдЙрди instances рдХреА рдкреВрд░реА TCP рд░реЗрдВрдЬ рдХреЛ рд▓рдХреНрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬреЛ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдЗрдВрдЯрд░рдиреЗрдЯ (0.0.0.0/0) рд╕реЗ рд╕рднреА TCP рдкреЛрд░реНрдЯреНрд╕ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ

### Hierarchical Firewall Policies <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Hierarchical firewall policies_ рдЖрдкрдХреЛ **рдЕрдкрдиреЗ рд╕рдВрдЧрдарди рдореЗрдВ рдПрдХ рд╕реБрд╕рдВрдЧрдд firewall рдиреАрддрд┐ рдмрдирд╛рдиреЗ рдФрд░ рд▓рд╛рдЧреВ рдХрд░рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИрдВред рдЖрдк **hierarchical firewall policies рдХреЛ рд╕рдВрдЧрдарди** рдХреЗ рд░реВрдк рдореЗрдВ рдпрд╛ рд╡реНрдпрдХреНрддрд┐рдЧрдд **folders** рдХреЛ рдЕрд╕рд╛рдЗрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрди рдиреАрддрд┐рдпреЛрдВ рдореЗрдВ рдирд┐рдпрдо рд╣реЛрддреЗ рд╣реИрдВ рдЬреЛ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдХрдиреЗрдХреНрд╢рдиреЛрдВ рдХреЛ рдЕрд╕реНрд╡реАрдХрд╛рд░ рдпрд╛ рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддреЗ рд╣реИрдВред

рдЖрдк firewall рдиреАрддрд┐рдпреЛрдВ рдХреЛ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдЪрд░рдгреЛрдВ рдореЗрдВ рдмрдирд╛рддреЗ рдФрд░ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВред рдЖрдк рд╕рдВрдЧрдарди рдпрд╛ [**resource hierarchy**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) рдХреЗ folder nodes рдкрд░ firewall рдиреАрддрд┐рдпреЛрдВ рдХреЛ рдмрдирд╛ рдФрд░ рд▓рд╛рдЧреВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдПрдХ firewall рдиреАрддрд┐ рдирд┐рдпрдо **рдХрдиреЗрдХреНрд╢рдиреЛрдВ рдХреЛ рдмреНрд▓реЙрдХ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдХрдиреЗрдХреНрд╢рдиреЛрдВ рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддрд╛ рд╣реИ, рдпрд╛ firewall рдирд┐рдпрдо рдореВрд▓реНрдпрд╛рдВрдХрди рдХреЛ рдирд┐рдЪрд▓реЗ рд╕реНрддрд░ рдХреЗ folders рдпрд╛ VPC рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд VPC firewall рдирд┐рдпрдореЛрдВ рдХреЛ рд╕реНрдердЧрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, рд╕рднреА hierarchical firewall рдиреАрддрд┐ рдирд┐рдпрдо рд╕рдВрдЧрдарди рдпрд╛ folder рд╕реЗ рдЬреБрдбрд╝реЗ рд╕рднреА рдкреНрд░реЛрдЬреЗрдХреНрдЯреНрд╕ рдореЗрдВ рд╕рднреА VMs рдкрд░ рд▓рд╛рдЧреВ рд╣реЛрддреЗ рд╣реИрдВред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЖрдк [target networks рдпрд╛ target service accounts](https://cloud.google.com/vpc/docs/firewall-policies#targets) рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдХреЗ **рдХрд┐рд╕ VMs рдХреЛ рдПрдХ рджрд┐рдпрд╛ рдЧрдпрд╛ рдирд┐рдпрдо рдорд┐рд▓рддрд╛ рд╣реИ** рдХреЛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдЖрдк рдпрд╣рд╛рдВ рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ [**Hierarchical Firewall Policy рдХреИрд╕реЗ рдмрдирд╛рдПрдВ**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud)ред

### Firewall Rules Evaluation

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. Org: рд╕рдВрдЧрдарди рдХреЛ рдЕрд╕рд╛рдЗрди рдХреА рдЧрдИ firewall рдиреАрддрд┐рдпрд╛рдВ
2. Folder: Folder рдХреЛ рдЕрд╕рд╛рдЗрди рдХреА рдЧрдИ firewall рдиреАрддрд┐рдпрд╛рдВ
3. VPC: VPC рдХреЛ рдЕрд╕рд╛рдЗрди рдХреА рдЧрдИ firewall рдирд┐рдпрдо
4. Global: рдПрдХ рдФрд░ рдкреНрд░рдХрд╛рд░ рдХреЗ firewall рдирд┐рдпрдо рдЬреЛ VPCs рдХреЛ рдЕрд╕рд╛рдЗрди рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ
5. Regional: VM рдХреЗ NIC рдФрд░ VM рдХреЗ рдХреНрд╖реЗрддреНрд░ рдХреЗ VPC рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗ рдЬреБрдбрд╝реЗ firewall рдирд┐рдпрдо

## VPC Network Peering

рджреЛ Virtual Private Cloud (VPC) рдиреЗрдЯрд╡рд░реНрдХ рдХреЛ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рддрд╛рдХрд┐ **рдкреНрд░рддреНрдпреЗрдХ рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ рд╕рдВрд╕рд╛рдзрди рдПрдХ рджреВрд╕рд░реЗ рдХреЗ рд╕рд╛рде рд╕рдВрдЪрд╛рд░ рдХрд░ рд╕рдХреЗрдВ**ред\
Peered VPC рдиреЗрдЯрд╡рд░реНрдХ рдПрдХ рд╣реА рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдореЗрдВ, рдПрдХ рд╣реА рд╕рдВрдЧрдарди рдХреЗ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░реЛрдЬреЗрдХреНрдЯреНрд╕ рдореЗрдВ, рдпрд╛ **рд╡рд┐рднрд┐рдиреНрди рд╕рдВрдЧрдардиреЛрдВ рдХреЗ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░реЛрдЬреЗрдХреНрдЯреНрд╕ рдореЗрдВ** рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред

рдпреЗ рдЖрд╡рд╢реНрдпрдХ рдЕрдиреБрдорддрд┐рдпрд╛рдВ рд╣реИрдВ:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**рдбреЙрдХреНрд╕ рдореЗрдВ рдФрд░ рдЕрдзрд┐рдХ**](https://cloud.google.com/vpc/docs/vpc-peering)ред

## References

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
AWS Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХреЛ рд╕рдорд░реНрдерди рджреЗрдВ</summary>

* [**subscription plans**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) рдкрд░ рд╣рдореЗрдВ рдлреЙрд▓реЛ рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>
{% endhint %}
