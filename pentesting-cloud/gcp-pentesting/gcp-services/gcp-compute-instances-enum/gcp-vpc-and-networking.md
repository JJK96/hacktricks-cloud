# GCP - VPC & Networking

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **GCP Compute Networking in a Nutshell**

**VPCs**는 VPC로 들어오는 트래픽을 허용하는 **Firewall** 규칙을 포함합니다. VPC는 또한 **가상 머신**이 **연결될** **서브네트워크**를 포함합니다.\
AWS와 비교하면, **Firewall**은 **AWS** **Security Groups 및 NACLs**와 가장 유사하지만, 이 경우에는 각 인스턴스가 아닌 **VPC에 정의**됩니다.

## **VPC, Subnetworks & Firewalls in GCP**

Compute Instances는 **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc))의 일부인 **서브네트워크**에 연결됩니다. GCP에는 보안 그룹이 없으며, 네트워크 수준에서 정의되지만 각 VM 인스턴스에 적용되는 [**VPC firewalls**](https://cloud.google.com/vpc/docs/firewalls)가 있습니다.

### Subnetworks

**VPC**는 **여러 서브네트워크**를 가질 수 있습니다. 각 **서브네트워크는 1개의 지역**에 있습니다.

### Firewalls

기본적으로, 모든 네트워크에는 두 개의 [**암시적 방화벽 규칙**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules)이 있습니다: **아웃바운드 허용** 및 **인바운드 거부**.

GCP 프로젝트가 생성되면, **`default`**라는 VPC가 생성되며, 다음 방화벽 규칙이 포함됩니다:

* **default-allow-internal:** `default` 네트워크의 다른 인스턴스로부터 모든 트래픽 허용
* **default-allow-ssh:** 모든 곳에서 22 허용
* **default-allow-rdp:** 모든 곳에서 3389 허용
* **default-allow-icmp:** 모든 곳에서 핑 허용

{% hint style="warning" %}
보시다시피, **방화벽 규칙**은 **내부 IP 주소**에 대해 **더 관대**한 경향이 있습니다. 기본 VPC는 Compute Instances 간의 모든 트래픽을 허용합니다.
{% endhint %}

기본 VPC 또는 새로운 VPC에 대해 더 많은 **방화벽 규칙**을 만들 수 있습니다. [**방화벽 규칙**](https://cloud.google.com/vpc/docs/firewalls)은 다음 **방법**을 통해 인스턴스에 적용될 수 있습니다:

* [**Network tags**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Service accounts**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **VPC 내의 모든 인스턴스**

불행히도, 인터넷에서 열린 포트가 있는 모든 Compute Instances를 나열하는 간단한 `gcloud` 명령어는 없습니다. 방화벽 규칙, 네트워크 태그, 서비스 계정 및 인스턴스 간의 연결을 찾아야 합니다.

이 프로세스는 [이 파이썬 스크립트](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum)를 사용하여 자동화되었으며, 다음을 내보냅니다:

* 인스턴스, 공용 IP, 허용된 TCP, 허용된 UDP를 보여주는 CSV 파일
* 공용 인터넷(0.0.0.0/0)에서 인그레스가 허용된 포트에서 모든 인스턴스를 대상으로 하는 nmap 스캔
* 공용 인터넷(0.0.0.0/0)에서 모든 TCP 포트를 허용하는 인스턴스를 대상으로 하는 전체 TCP 범위의 masscan

### Hierarchical Firewall Policies <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Hierarchical firewall policies_는 **조직 전체에 일관된 방화벽 정책을 생성하고 적용**할 수 있게 합니다. **조직 전체** 또는 개별 **폴더**에 **계층적 방화벽 정책**을 할당할 수 있습니다. 이러한 정책에는 연결을 명시적으로 거부하거나 허용할 수 있는 규칙이 포함됩니다.

방화벽 정책을 생성하고 적용하는 것은 별도의 단계로 수행됩니다. 방화벽 정책은 [**리소스 계층 구조**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)의 **조직 또는 폴더 노드**에서 생성하고 적용할 수 있습니다. 방화벽 정책 규칙은 **연결을 차단하거나, 연결을 허용하거나, 하위 폴더 또는 VPC 네트워크에 정의된 VPC 방화벽 규칙으로 방화벽 규칙 평가를 연기**할 수 있습니다.

기본적으로, 모든 계층적 방화벽 정책 규칙은 정책이 연결된 조직 또는 폴더 아래의 모든 프로젝트의 모든 VM에 적용됩니다. 그러나 [대상 네트워크 또는 대상 서비스 계정](https://cloud.google.com/vpc/docs/firewall-policies#targets)을 지정하여 **특정 VM에만 규칙을 적용**할 수 있습니다.

[**계층적 방화벽 정책 생성 방법**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud)을 여기에서 읽을 수 있습니다.

### Firewall Rules Evaluation

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. Org: 조직에 할당된 방화벽 정책
2. Folder: 폴더에 할당된 방화벽 정책
3. VPC: VPC에 할당된 방화벽 규칙
4. Global: VPC에 할당될 수 있는 또 다른 유형의 방화벽 규칙
5. Regional: VM의 NIC 및 VM의 지역의 VPC 네트워크와 연결된 방화벽 규칙

## VPC Network Peering

두 개의 Virtual Private Cloud (VPC) 네트워크를 연결하여 **각 네트워크의 리소스가 서로 통신할 수 있도록** 합니다.\
피어링된 VPC 네트워크는 동일한 프로젝트, 동일한 조직의 다른 프로젝트 또는 **다른 조직의 다른 프로젝트**에 있을 수 있습니다.

필요한 권한은 다음과 같습니다:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**문서에서 더 보기**](https://cloud.google.com/vpc/docs/vpc-peering).

## References

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
