# GCP - VPC & Networking

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## **GCP Compute Networking in a Nutshell**

**VPCs** περιέχουν κανόνες **Firewall** για να επιτρέπουν εισερχόμενη κίνηση στο VPC. Τα VPCs περιέχουν επίσης **subnetworks** όπου οι **εικονικές μηχανές** θα είναι **συνδεδεμένες**.\
Σε σύγκριση με το AWS, το **Firewall** θα ήταν το **πλησιέστερο** πράγμα στα **AWS** **Security Groups και NACLs**, αλλά σε αυτή την περίπτωση αυτά είναι **ορισμένα στο VPC** και όχι σε κάθε instance.

## **VPC, Subnetworks & Firewalls in GCP**

Τα Compute Instances είναι συνδεδεμένα με **subnetworks** που είναι μέρος των **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). Στο GCP δεν υπάρχουν security groups, υπάρχουν [**VPC firewalls**](https://cloud.google.com/vpc/docs/firewalls) με κανόνες ορισμένους σε αυτό το επίπεδο δικτύου αλλά εφαρμόζονται σε κάθε VM Instance.

### Subnetworks

Ένα **VPC** μπορεί να έχει **πολλά subnetworks**. Κάθε **subnetwork είναι σε 1 περιοχή**.

### Firewalls

Από προεπιλογή, κάθε δίκτυο έχει δύο [**υπονοούμενους κανόνες firewall**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **επιτρέπουν εξερχόμενη** και **απαγορεύουν εισερχόμενη** κίνηση.

Όταν δημιουργείται ένα έργο GCP, δημιουργείται επίσης ένα VPC που ονομάζεται **`default`**, με τους ακόλουθους κανόνες firewall:

* **default-allow-internal:** επιτρέπει όλη την κίνηση από άλλα instances στο `default` δίκτυο
* **default-allow-ssh:** επιτρέπει 22 από παντού
* **default-allow-rdp:** επιτρέπει 3389 από παντού
* **default-allow-icmp:** επιτρέπει ping από παντού

{% hint style="warning" %}
Όπως μπορείτε να δείτε, οι **κανόνες firewall** τείνουν να είναι **πιο επιτρεπτικοί** για **εσωτερικές διευθύνσεις IP**. Το προεπιλεγμένο VPC επιτρέπει όλη την κίνηση μεταξύ των Compute Instances.
{% endhint %}

Περισσότεροι **κανόνες Firewall** μπορούν να δημιουργηθούν για το προεπιλεγμένο VPC ή για νέα VPCs. [**Κανόνες Firewall**](https://cloud.google.com/vpc/docs/firewalls) μπορούν να εφαρμοστούν σε instances μέσω των ακόλουθων **μεθόδων**:

* [**Network tags**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Service accounts**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Όλα τα instances μέσα σε ένα VPC**

Δυστυχώς, δεν υπάρχει μια απλή εντολή `gcloud` για να εμφανίσει όλα τα Compute Instances με ανοιχτές θύρες στο διαδίκτυο. Πρέπει να συνδέσετε τις τελείες μεταξύ των κανόνων firewall, των network tags, των service accounts και των instances.

Αυτή η διαδικασία αυτοματοποιήθηκε χρησιμοποιώντας [αυτό το python script](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) που θα εξάγει τα εξής:

* Αρχείο CSV που δείχνει instance, δημόσια IP, επιτρεπόμενα TCP, επιτρεπόμενα UDP
* nmap σάρωση για στόχευση όλων των instances στις θύρες που επιτρέπεται η εισερχόμενη κίνηση από το δημόσιο διαδίκτυο (0.0.0.0/0)
* masscan για στόχευση του πλήρους εύρους TCP αυτών των instances που επιτρέπουν ΟΛΕΣ τις θύρες TCP από το δημόσιο διαδίκτυο (0.0.0.0/0)

### Hierarchical Firewall Policies <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

Οι _Hierarchical firewall policies_ σας επιτρέπουν να δημιουργήσετε και να **επιβάλλετε μια συνεπή πολιτική firewall σε όλη την οργάνωσή σας**. Μπορείτε να αναθέσετε **hierarchical firewall policies στην οργάνωση** ως σύνολο ή σε μεμονωμένους **φακέλους**. Αυτές οι πολιτικές περιέχουν κανόνες που μπορούν να αρνηθούν ή να επιτρέψουν ρητά συνδέσεις.

Δημιουργείτε και εφαρμόζετε πολιτικές firewall ως ξεχωριστά βήματα. Μπορείτε να δημιουργήσετε και να εφαρμόσετε πολιτικές firewall στους **κόμβους οργάνωσης ή φακέλων της** [**ιεραρχίας πόρων**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Ένας κανόνας πολιτικής firewall μπορεί να **μπλοκάρει συνδέσεις, να επιτρέπει συνδέσεις ή να αναβάλει την αξιολόγηση κανόνων firewall** σε φακέλους χαμηλότερου επιπέδου ή κανόνες firewall VPC που ορίζονται σε δίκτυα VPC.

Από προεπιλογή, όλοι οι κανόνες πολιτικής firewall ιεραρχίας ισχύουν για όλα τα VMs σε όλα τα έργα κάτω από την οργάνωση ή τον φάκελο όπου συνδέεται η πολιτική. Ωστόσο, μπορείτε να **περιορίσετε ποια VMs λαμβάνουν έναν δεδομένο κανόνα** καθορίζοντας [target networks ή target service accounts](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Μπορείτε να διαβάσετε εδώ πώς να [**δημιουργήσετε μια Hierarchical Firewall Policy**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Firewall Rules Evaluation

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. Org: Πολιτικές firewall που ανατίθενται στην Οργάνωση
2. Folder: Πολιτικές firewall που ανατίθενται στον Φάκελο
3. VPC: Κανόνες firewall που ανατίθενται στο VPC
4. Global: Άλλος τύπος κανόνων firewall που μπορούν να ανατεθούν σε VPCs
5. Regional: Κανόνες firewall που συνδέονται με το δίκτυο VPC της NIC του VM και την περιοχή του VM.

## VPC Network Peering

Επιτρέπει τη σύνδεση δύο δικτύων Virtual Private Cloud (VPC) ώστε οι **πόροι σε κάθε δίκτυο να μπορούν να επικοινωνούν** μεταξύ τους.\
Τα Peered VPC networks μπορούν να είναι στο ίδιο έργο, σε διαφορετικά έργα της ίδιας οργάνωσης ή **σε διαφορετικά έργα διαφορετικών οργανώσεων**.

Αυτές είναι οι απαραίτητες άδειες:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Περισσότερα στα έγγραφα**](https://cloud.google.com/vpc/docs/vpc-peering).

## Αναφορές

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
