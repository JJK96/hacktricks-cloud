# GCP - VPC & Networking

{% hint style="success" %}
Jifunze na kufanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na kufanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **GCP Compute Networking kwa Ufupi**

**VPCs** zina **kanuni za Firewall** kuruhusu trafiki inayoingia kwenye VPC. VPCs pia zina **subnetworks** ambapo **virtual machines** zitakuwa **zinaunganishwa**.\
Ukilinganisha na AWS, **Firewall** itakuwa kitu **cha karibu zaidi** na **AWS** **Security Groups na NACLs**, lakini katika kesi hii hizi **zimefafanuliwa kwenye VPC** na si kwenye kila instance.

## **VPC, Subnetworks & Firewalls katika GCP**

Compute Instances zimeunganishwa na **subnetworks** ambazo ni sehemu ya **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). Katika GCP hakuna security groups, kuna [**VPC firewalls**](https://cloud.google.com/vpc/docs/firewalls) zenye kanuni zilizofafanuliwa kwenye kiwango cha mtandao lakini zinatumika kwa kila VM Instance.

### Subnetworks

**VPC** inaweza kuwa na **subnetworks kadhaa**. Kila **subnetwork iko katika eneo 1**.

### Firewalls

Kwa default, kila mtandao una [**kanuni mbili za firewall zilizodokezwa**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **kuruhusu kutoka nje** na **kukataa kuingia ndani**.

Wakati mradi wa GCP unaundwa, VPC inayoitwa **`default`** pia inaundwa, na kanuni za firewall zifuatazo:

* **default-allow-internal:** kuruhusu trafiki yote kutoka kwa instances nyingine kwenye mtandao wa `default`
* **default-allow-ssh:** kuruhusu 22 kutoka kila mahali
* **default-allow-rdp:** kuruhusu 3389 kutoka kila mahali
* **default-allow-icmp:** kuruhusu ping kutoka kila mahali

{% hint style="warning" %}
Kama unavyoona, **kanuni za firewall** huwa **zinajiruhusu zaidi** kwa **anwani za IP za ndani**. VPC ya default inaruhusu trafiki yote kati ya Compute Instances.
{% endhint %}

Kanuni zaidi za **Firewall** zinaweza kuundwa kwa VPC ya default au kwa VPC mpya. [**Kanuni za Firewall**](https://cloud.google.com/vpc/docs/firewalls) zinaweza kutumika kwa instances kupitia **njia zifuatazo**:

* [**Network tags**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Service accounts**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Instances zote ndani ya VPC**

Kwa bahati mbaya, hakuna amri rahisi ya `gcloud` kutoa Compute Instances zote zilizo na bandari wazi kwenye mtandao. Unahitaji kuunganisha nukta kati ya kanuni za firewall, network tags, service accounts, na instances.

Mchakato huu ulifanywa kiotomatiki kwa kutumia [script ya python hii](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) ambayo itatoa yafuatayo:

* Faili ya CSV inayoonyesha instance, IP ya umma, TCP inayoruhusiwa, UDP inayoruhusiwa
* nmap scan kulenga instances zote kwenye bandari zinazoruhusiwa kuingia kutoka kwenye mtandao wa umma (0.0.0.0/0)
* masscan kulenga anuwai kamili ya TCP ya instances hizo zinazoruhusu bandari zote za TCP kutoka kwenye mtandao wa umma (0.0.0.0/0)

### Hierarchical Firewall Policies <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Hierarchical firewall policies_ zinakuruhusu kuunda na **kutekeleza sera ya firewall thabiti katika shirika lako**. Unaweza kupeana **hierarchical firewall policies kwa shirika** zima au kwa **folders** binafsi. Sera hizi zina kanuni ambazo zinaweza kukataa au kuruhusu muunganisho waziwazi.

Unaunda na kutumia sera za firewall kama hatua tofauti. Unaweza kuunda na kutumia sera za firewall kwenye **nodes za shirika au folder za** [**resource hierarchy**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Kanuni ya sera ya firewall inaweza **kuzuia muunganisho, kuruhusu muunganisho, au kuahirisha tathmini ya kanuni za firewall** kwa folders za ngazi ya chini au kanuni za firewall za VPC zilizofafanuliwa kwenye mitandao ya VPC.

Kwa default, kanuni zote za sera ya firewall ya hierarchical zinatumika kwa VMs zote katika miradi yote chini ya shirika au folder ambapo sera imehusishwa. Hata hivyo, unaweza **kuzuia ni VMs zipi zinapata kanuni fulani** kwa kubainisha [target networks au target service accounts](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Unaweza kusoma hapa jinsi ya [**kuunda Hierarchical Firewall Policy**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Firewall Rules Evaluation

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. Org: Sera za firewall zilizotolewa kwa Shirika
2. Folder: Sera za firewall zilizotolewa kwa Folder
3. VPC: Kanuni za firewall zilizotolewa kwa VPC
4. Global: Aina nyingine ya kanuni za firewall zinazoweza kutolewa kwa VPCs
5. Regional: Kanuni za firewall zinazohusishwa na mtandao wa VPC wa NIC ya VM na eneo la VM.

## VPC Network Peering

Inaruhusu kuunganisha mitandao miwili ya Virtual Private Cloud (VPC) ili **rasilimali katika kila mtandao ziweze kuwasiliana** na kila mmoja.\
Mitandao ya VPC iliyounganishwa inaweza kuwa katika mradi mmoja, miradi tofauti ya shirika moja, au **miradi tofauti ya mashirika tofauti**.

Hizi ni ruhusa zinazohitajika:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Zaidi katika nyaraka**](https://cloud.google.com/vpc/docs/vpc-peering).

## Marejeo

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Jifunze na kufanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na kufanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
