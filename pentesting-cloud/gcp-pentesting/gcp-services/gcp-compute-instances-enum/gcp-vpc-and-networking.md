# GCP - VPC & Networking

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository github.

</details>
{% endhint %}

## **GCP Compute Networking in a Nutshell**

**VPCs** contengono regole di **Firewall** per consentire il traffico in entrata nella VPC. Le VPC contengono anche **subnetworks** dove le **macchine virtuali** saranno **connesse**.\
Confrontando con AWS, il **Firewall** sarebbe la cosa **pi√π simile** ai **Security Groups e NACLs** di **AWS**, ma in questo caso sono **definiti nella VPC** e non in ogni istanza.

## **VPC, Subnetworks & Firewalls in GCP**

Le Compute Instances sono connesse a **subnetworks** che fanno parte delle **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). In GCP non ci sono security groups, ci sono [**VPC firewalls**](https://cloud.google.com/vpc/docs/firewalls) con regole definite a livello di rete ma applicate a ogni VM Instance.

### Subnetworks

Una **VPC** pu√≤ avere **diverse subnetworks**. Ogni **subnetwork √® in 1 regione**.

### Firewalls

Per impostazione predefinita, ogni rete ha due [**regole di firewall implicite**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **consentire il traffico in uscita** e **negare il traffico in entrata**.

Quando viene creato un progetto GCP, viene creata anche una VPC chiamata **`default`**, con le seguenti regole di firewall:

* **default-allow-internal:** consente tutto il traffico da altre istanze sulla rete `default`
* **default-allow-ssh:** consente 22 da ovunque
* **default-allow-rdp:** consente 3389 da ovunque
* **default-allow-icmp:** consente ping da ovunque

{% hint style="warning" %}
Come puoi vedere, le **regole di firewall** tendono a essere **pi√π permissive** per gli **indirizzi IP interni**. La VPC predefinita consente tutto il traffico tra le Compute Instances.
{% endhint %}

Altre **regole di Firewall** possono essere create per la VPC predefinita o per nuove VPC. [**Le regole di Firewall**](https://cloud.google.com/vpc/docs/firewalls) possono essere applicate alle istanze tramite i seguenti **metodi**:

* [**Network tags**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Service accounts**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Tutte le istanze all'interno di una VPC**

Sfortunatamente, non esiste un semplice comando `gcloud` per elencare tutte le Compute Instances con porte aperte su internet. Devi collegare i punti tra le regole di firewall, i network tags, i service accounts e le istanze.

Questo processo √® stato automatizzato utilizzando [questo script python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) che esporter√† quanto segue:

* File CSV che mostra istanza, IP pubblico, TCP consentito, UDP consentito
* Scansione nmap per mirare tutte le istanze sulle porte consentite in ingresso da internet pubblico (0.0.0.0/0)
* Scansione masscan per mirare l'intera gamma TCP di quelle istanze che consentono TUTTE le porte TCP da internet pubblico (0.0.0.0/0)

### Hierarchical Firewall Policies <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Le politiche di firewall gerarchiche_ ti permettono di creare e **applicare una politica di firewall coerente in tutta la tua organizzazione**. Puoi assegnare **politiche di firewall gerarchiche all'organizzazione** nel suo complesso o a singole **cartelle**. Queste politiche contengono regole che possono esplicitamente negare o consentire connessioni.

Crei e applichi le politiche di firewall come passaggi separati. Puoi creare e applicare politiche di firewall ai **nodi dell'organizzazione o delle cartelle della** [**gerarchia delle risorse**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Una regola di politica di firewall pu√≤ **bloccare connessioni, consentire connessioni o deferire la valutazione delle regole di firewall** a cartelle di livello inferiore o regole di firewall VPC definite nelle reti VPC.

Per impostazione predefinita, tutte le regole di politica di firewall gerarchiche si applicano a tutte le VM in tutti i progetti sotto l'organizzazione o la cartella in cui √® associata la politica. Tuttavia, puoi **limitare quali VM ricevono una determinata regola** specificando [reti target o service accounts target](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Puoi leggere qui come [**creare una Hierarchical Firewall Policy**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Firewall Rules Evaluation

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. Org: Politiche di firewall assegnate all'Organizzazione
2. Folder: Politiche di firewall assegnate alla Cartella
3. VPC: Regole di firewall assegnate alla VPC
4. Global: Un altro tipo di regole di firewall che possono essere assegnate alle VPC
5. Regional: Regole di firewall associate alla rete VPC della NIC della VM e alla regione della VM.

## VPC Network Peering

Permette di connettere due reti Virtual Private Cloud (VPC) in modo che **le risorse in ciascuna rete possano comunicare** tra loro.\
Le reti VPC peered possono essere nello stesso progetto, in progetti diversi della stessa organizzazione o **in progetti diversi di organizzazioni diverse**.

Questi sono i permessi necessari:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Maggiori informazioni nella documentazione**](https://cloud.google.com/vpc/docs/vpc-peering).

## Riferimenti

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository github.

</details>
{% endhint %}
