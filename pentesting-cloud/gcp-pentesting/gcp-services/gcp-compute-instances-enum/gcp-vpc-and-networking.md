# GCP - VPC & Networking

{% hint style="success" %}
Nauƒçite i ve≈æbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nauƒçite i ve≈æbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## **GCP Compute Networking u Kratkim Crtama**

**VPCs** sadr≈æe **Firewall** pravila za dozvolu dolaznog saobraƒáaja u VPC. VPCs takoƒëe sadr≈æe **podmre≈æe** gde ƒáe **virtuelne ma≈°ine** biti **povezane**.\
U poreƒëenju sa AWS, **Firewall** bi bio **najbli≈æi** AWS **Security Groups i NACLs**, ali u ovom sluƒçaju su **definisani u VPC** a ne u svakoj instanci.

## **VPC, Podmre≈æe & Firewalls u GCP**

Compute Instances su povezane sa **podmre≈æama** koje su deo **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). U GCP ne postoje security groups, postoje [**VPC firewalls**](https://cloud.google.com/vpc/docs/firewalls) sa pravilima definisanim na nivou mre≈æe ali primenjenim na svaku VM Instance.

### Podmre≈æe

**VPC** mo≈æe imati **vi≈°e podmre≈æa**. Svaka **podmre≈æa je u 1 regionu**.

### Firewalls

Podrazumevano, svaka mre≈æa ima dva [**implicitna firewall pravila**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **dozvoli izlazni** i **odbij dolazni**.

Kada se kreira GCP projekat, kreira se i VPC nazvan **`default`**, sa sledeƒáim firewall pravilima:

* **default-allow-internal:** dozvoli sav saobraƒáaj sa drugih instanci na `default` mre≈æi
* **default-allow-ssh:** dozvoli 22 sa svuda
* **default-allow-rdp:** dozvoli 3389 sa svuda
* **default-allow-icmp:** dozvoli ping sa svuda

{% hint style="warning" %}
Kao ≈°to mo≈æete videti, **firewall pravila** su obiƒçno **permisivnija** za **internu IP adresu**. Podrazumevani VPC dozvoljava sav saobraƒáaj izmeƒëu Compute Instances.
{% endhint %}

Vi≈°e **Firewall pravila** mo≈æe biti kreirano za podrazumevani VPC ili za nove VPCs. [**Firewall pravila**](https://cloud.google.com/vpc/docs/firewalls) mogu biti primenjena na instance putem sledeƒáih **metoda**:

* [**Network tags**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Service accounts**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Sve instance unutar VPC**

Na≈æalost, ne postoji jednostavna `gcloud` komanda koja izbacuje sve Compute Instances sa otvorenim portovima na internetu. Morate povezati taƒçke izmeƒëu firewall pravila, network tags, service accounts i instanci.

Ovaj proces je automatizovan kori≈°ƒáenjem [ovog python skripta](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) koji ƒáe izvesti sledeƒáe:

* CSV fajl koji prikazuje instancu, javnu IP, dozvoljeni TCP, dozvoljeni UDP
* nmap skeniranje za ciljanje svih instanci na portovima sa dozvoljenim ulazom sa javnog interneta (0.0.0.0/0)
* masscan za ciljanje celog TCP opsega tih instanci koje dozvoljavaju SVE TCP portove sa javnog interneta (0.0.0.0/0)

### Hijerarhijske Firewall Politike <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Hijerarhijske firewall politike_ omoguƒáavaju vam da kreirate i **sprovodite doslednu firewall politiku ≈°irom va≈°e organizacije**. Mo≈æete dodeliti **hijerarhijske firewall politike organizaciji** kao celini ili pojedinaƒçnim **folderima**. Ove politike sadr≈æe pravila koja mogu eksplicitno odbiti ili dozvoliti konekcije.

Kreirate i primenjujete firewall politike kao odvojene korake. Mo≈æete kreirati i primeniti firewall politike na **organizacionim ili folder ƒçvorovima** [**resursne hijerarhije**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Pravilo firewall politike mo≈æe **blokirati konekcije, dozvoliti konekcije, ili odlo≈æiti evaluaciju firewall pravila** na ni≈æe nivoe foldere ili VPC firewall pravila definisana u VPC mre≈æama.

Podrazumevano, sva hijerarhijska firewall pravila se primenjuju na sve VM-ove u svim projektima pod organizacijom ili folderom gde je politika povezana. Meƒëutim, mo≈æete **ograniƒçiti koje VM-ove dobijaju odreƒëeno pravilo** specificiranjem [ciljanih mre≈æa ili ciljanih service accounts](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Ovde mo≈æete proƒçitati kako da [**kreirate Hijerarhijsku Firewall Politiku**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Evaluacija Firewall Pravila

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. Org: Firewall politike dodeljene Organizaciji
2. Folder: Firewall politike dodeljene Folderu
3. VPC: Firewall pravila dodeljena VPC
4. Global: Druga vrsta firewall pravila koja mogu biti dodeljena VPCs
5. Regional: Firewall pravila povezana sa VPC mre≈æom VM-ovog NIC-a i regiona VM-a.

## VPC Network Peering

Omoguƒáava povezivanje dve Virtual Private Cloud (VPC) mre≈æe tako da **resursi u svakoj mre≈æi mogu komunicirati** meƒëusobno.\
Povezane VPC mre≈æe mogu biti u istom projektu, razliƒçitim projektima iste organizacije, ili **razliƒçitim projektima razliƒçitih organizacija**.

Ovo su potrebne dozvole:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Vi≈°e u dokumentaciji**](https://cloud.google.com/vpc/docs/vpc-peering).

## Reference

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Nauƒçite i ve≈æbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Nauƒçite i ve≈æbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
