# GCP - VPC & Networking

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da bizi **Twitter**'da takip edin 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek hacking ipuçlarını paylaşın.**

</details>
{% endhint %}

## **GCP Compute Networking Kısaca**

**VPC'ler**, VPC'ye gelen trafiğe izin vermek için **Firewall** kuralları içerir. VPC'ler ayrıca **sanallaştırılmış makinelerin** **bağlanacağı** **alt ağları** içerir.\
AWS ile karşılaştırıldığında, **Firewall**, **AWS** **Security Groups ve NACL'lere** en yakın şey olacaktır, ancak bu durumda bunlar **her bir instance'da değil, VPC'de tanımlanır**.

## **GCP'de VPC, Alt Ağlar ve Firewalls**

Compute Instances, **VPC'lerin** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)) bir parçası olan **alt ağlara** bağlanır. GCP'de güvenlik grupları yoktur, [**VPC firewalls**](https://cloud.google.com/vpc/docs/firewalls) vardır ve bu kurallar ağ seviyesinde tanımlanır ancak her VM Instance'a uygulanır.

### Alt Ağlar

Bir **VPC**'nin **birden fazla alt ağı** olabilir. Her **alt ağ 1 bölgede** bulunur.

### Firewalls

Varsayılan olarak, her ağda iki [**örtük firewall kuralı**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules) vardır: **giden trafiğe izin ver** ve **gelen trafiği reddet**.

Bir GCP projesi oluşturulduğunda, **`default`** adlı bir VPC de oluşturulur ve aşağıdaki firewall kuralları ile birlikte gelir:

* **default-allow-internal:** `default` ağındaki diğer instance'lardan gelen tüm trafiğe izin ver
* **default-allow-ssh:** her yerden 22'ye izin ver
* **default-allow-rdp:** her yerden 3389'a izin ver
* **default-allow-icmp:** her yerden ping'e izin ver

{% hint style="warning" %}
Gördüğünüz gibi, **firewall kuralları** **iç IP adresleri** için **daha izin verici** olma eğilimindedir. Varsayılan VPC, Compute Instances arasında tüm trafiğe izin verir.
{% endhint %}

Varsayılan VPC veya yeni VPC'ler için daha fazla **Firewall kuralı** oluşturulabilir. [**Firewall kuralları**](https://cloud.google.com/vpc/docs/firewalls) aşağıdaki **yöntemlerle** instance'lara uygulanabilir:

* [**Ağ etiketleri**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Servis hesapları**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Bir VPC içindeki tüm instance'lar**

Ne yazık ki, internette açık portlara sahip tüm Compute Instances'ı listeleyen basit bir `gcloud` komutu yoktur. Firewall kuralları, ağ etiketleri, servis hesapları ve instance'lar arasında bağlantı kurmanız gerekir.

Bu süreç, [bu python scripti](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) kullanılarak otomatikleştirildi ve aşağıdakileri dışa aktaracaktır:

* Instance, public IP, izin verilen TCP, izin verilen UDP gösteren CSV dosyası
* Public internetten (0.0.0.0/0) gelen trafiğe izin verilen portlarda tüm instance'ları hedefleyen nmap taraması
* Public internetten (0.0.0.0/0) TÜM TCP portlarına izin veren instance'ların tam TCP aralığını hedefleyen masscan

### Hiyerarşik Firewall Politikaları <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Hiyerarşik firewall politikaları_, **kuruluşunuz genelinde tutarlı bir firewall politikası oluşturmanıza ve uygulamanıza** olanak tanır. **Hiyerarşik firewall politikalarını tüm kuruluşa veya bireysel **klasörlere** atayabilirsiniz. Bu politikalar, bağlantıları açıkça reddedebilen veya izin verebilen kurallar içerir.

Firewall politikalarını oluşturma ve uygulama adımları ayrı olarak gerçekleştirilir. Firewall politikalarını **kuruluş veya klasör düğümlerinde** [**kaynak hiyerarşisi**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) oluşturabilir ve uygulayabilirsiniz. Bir firewall politika kuralı, **bağlantıları engelleyebilir, bağlantılara izin verebilir veya firewall kuralı değerlendirmesini** daha alt düzey klasörlere veya VPC ağlarında tanımlanan VPC firewall kurallarına devredebilir.

Varsayılan olarak, tüm hiyerarşik firewall politika kuralları, politikanın ilişkilendirildiği kuruluş veya klasör altındaki tüm projelerdeki tüm VM'lere uygulanır. Ancak, [hedef ağlar veya hedef servis hesapları](https://cloud.google.com/vpc/docs/firewall-policies#targets) belirterek belirli VM'lere verilen bir kuralı kısıtlayabilirsiniz.

[**Hiyerarşik Firewall Politikası oluşturma**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud) hakkında buradan bilgi alabilirsiniz.

### Firewall Kuralları Değerlendirmesi

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. Org: Kuruluşa atanan firewall politikaları
2. Folder: Klasöre atanan firewall politikaları
3. VPC: VPC'ye atanan firewall kuralları
4. Global: VPC'lere atanabilen başka bir tür firewall kuralları
5. Regional: VM'nin NIC ve bölgesinin VPC ağı ile ilişkili firewall kuralları

## VPC Ağ Eşlemesi

İki Virtual Private Cloud (VPC) ağını birbirine bağlamanızı sağlar, böylece **her iki ağdaki kaynaklar birbirleriyle iletişim kurabilir**.\
Eşlenmiş VPC ağları aynı projede, aynı kuruluşun farklı projelerinde veya **farklı kuruluşların farklı projelerinde** olabilir.

Gerekli izinler şunlardır:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Daha fazla bilgi için dokümanlar**](https://cloud.google.com/vpc/docs/vpc-peering).

## Referanslar

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da bizi **Twitter**'da takip edin 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek hacking ipuçlarını paylaşın.**

</details>
{% endhint %}
