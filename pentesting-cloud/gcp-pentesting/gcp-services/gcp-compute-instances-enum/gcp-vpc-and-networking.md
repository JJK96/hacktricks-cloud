# GCP - VPC & Networking

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## **GCP Compute Networking in a Nutshell**

**VPCs** cont√™m regras de **Firewall** para permitir tr√°fego de entrada na VPC. VPCs tamb√©m cont√™m **sub-redes** onde **m√°quinas virtuais** ser√£o **conectadas**.\
Comparando com AWS, **Firewall** seria o mais **pr√≥ximo** de **AWS** **Security Groups e NACLs**, mas neste caso, estas s√£o **definidas na VPC** e n√£o em cada inst√¢ncia.

## **VPC, Subnetworks & Firewalls in GCP**

Inst√¢ncias de Computa√ß√£o est√£o conectadas a **sub-redes** que fazem parte das **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). No GCP n√£o existem security groups, existem [**firewalls de VPC**](https://cloud.google.com/vpc/docs/firewalls) com regras definidas neste n√≠vel de rede, mas aplicadas a cada Inst√¢ncia de VM.

### Subnetworks

Uma **VPC** pode ter **v√°rias sub-redes**. Cada **sub-rede est√° em 1 regi√£o**.

### Firewalls

Por padr√£o, toda rede tem duas [**regras de firewall impl√≠citas**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **permitir sa√≠da** e **negar entrada**.

Quando um projeto GCP √© criado, uma VPC chamada **`default`** tamb√©m √© criada, com as seguintes regras de firewall:

* **default-allow-internal:** permite todo o tr√°fego de outras inst√¢ncias na rede `default`
* **default-allow-ssh:** permite 22 de qualquer lugar
* **default-allow-rdp:** permite 3389 de qualquer lugar
* **default-allow-icmp:** permite ping de qualquer lugar

{% hint style="warning" %}
Como voc√™ pode ver, as **regras de firewall** tendem a ser **mais permissivas** para **endere√ßos IP internos**. A VPC padr√£o permite todo o tr√°fego entre Inst√¢ncias de Computa√ß√£o.
{% endhint %}

Mais **regras de Firewall** podem ser criadas para a VPC padr√£o ou para novas VPCs. [**Regras de Firewall**](https://cloud.google.com/vpc/docs/firewalls) podem ser aplicadas a inst√¢ncias atrav√©s dos seguintes **m√©todos**:

* [**Network tags**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Service accounts**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Todas as inst√¢ncias dentro de uma VPC**

Infelizmente, n√£o h√° um comando `gcloud` simples para listar todas as Inst√¢ncias de Computa√ß√£o com portas abertas na internet. Voc√™ tem que conectar os pontos entre regras de firewall, network tags, contas de servi√ßo e inst√¢ncias.

Este processo foi automatizado usando [este script python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) que exportar√° o seguinte:

* Arquivo CSV mostrando inst√¢ncia, IP p√∫blico, TCP permitido, UDP permitido
* nmap scan para direcionar todas as inst√¢ncias nas portas de entrada permitidas da internet p√∫blica (0.0.0.0/0)
* masscan para direcionar o intervalo completo de TCP daquelas inst√¢ncias que permitem TODAS as portas TCP da internet p√∫blica (0.0.0.0/0)

### Hierarchical Firewall Policies <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Pol√≠ticas de firewall hier√°rquicas_ permitem criar e **aplicar uma pol√≠tica de firewall consistente em toda a sua organiza√ß√£o**. Voc√™ pode atribuir **pol√≠ticas de firewall hier√°rquicas √† organiza√ß√£o** como um todo ou a **pastas individuais**. Essas pol√≠ticas cont√™m regras que podem negar ou permitir conex√µes explicitamente.

Voc√™ cria e aplica pol√≠ticas de firewall em etapas separadas. Voc√™ pode criar e aplicar pol√≠ticas de firewall nos **n√≥s da organiza√ß√£o ou da pasta da** [**hierarquia de recursos**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Uma regra de pol√≠tica de firewall pode **bloquear conex√µes, permitir conex√µes ou adiar a avalia√ß√£o da regra de firewall** para pastas de n√≠vel inferior ou regras de firewall de VPC definidas em redes VPC.

Por padr√£o, todas as regras de pol√≠tica de firewall hier√°rquica se aplicam a todas as VMs em todos os projetos sob a organiza√ß√£o ou pasta onde a pol√≠tica est√° associada. No entanto, voc√™ pode **restringir quais VMs recebem uma determinada regra** especificando [redes de destino ou contas de servi√ßo de destino](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Voc√™ pode ler aqui como [**criar uma Pol√≠tica de Firewall Hier√°rquica**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Firewall Rules Evaluation

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. Org: Pol√≠ticas de firewall atribu√≠das √† Organiza√ß√£o
2. Folder: Pol√≠ticas de firewall atribu√≠das √† Pasta
3. VPC: Regras de firewall atribu√≠das √† VPC
4. Global: Outro tipo de regras de firewall que podem ser atribu√≠das a VPCs
5. Regional: Regras de firewall associadas √† rede VPC do NIC da VM e √† regi√£o da VM.

## VPC Network Peering

Permite conectar duas redes Virtual Private Cloud (VPC) para que **recursos em cada rede possam se comunicar** entre si.\
Redes VPC emparelhadas podem estar no mesmo projeto, em projetos diferentes da mesma organiza√ß√£o ou **em projetos diferentes de diferentes organiza√ß√µes**.

Estas s√£o as permiss√µes necess√°rias:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Mais na documenta√ß√£o**](https://cloud.google.com/vpc/docs/vpc-peering).

## Refer√™ncias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
