# GCP - VPC & Networking

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## **GCP Compute Networking en Bref**

**VPCs** contient des r√®gles de **Firewall** pour permettre le trafic entrant vers le VPC. Les VPCs contiennent √©galement des **sous-r√©seaux** o√π les **machines virtuelles** vont √™tre **connect√©es**.\
En comparaison avec AWS, le **Firewall** serait l'√©l√©ment le plus **proche** des **Security Groups et NACLs** d'**AWS**, mais dans ce cas, ils sont **d√©finis dans le VPC** et non dans chaque instance.

## **VPC, Sous-r√©seaux & Firewalls dans GCP**

Les Instances de Calcul sont connect√©es √† des **sous-r√©seaux** qui font partie des **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). Dans GCP, il n'y a pas de groupes de s√©curit√©, il y a des [**firewalls VPC**](https://cloud.google.com/vpc/docs/firewalls) avec des r√®gles d√©finies √† ce niveau de r√©seau mais appliqu√©es √† chaque instance VM.

### Sous-r√©seaux

Un **VPC** peut avoir **plusieurs sous-r√©seaux**. Chaque **sous-r√©seau est dans 1 r√©gion**.

### Firewalls

Par d√©faut, chaque r√©seau a deux [**r√®gles de firewall implicites**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules) : **autoriser le trafic sortant** et **refuser le trafic entrant**.

Lorsqu'un projet GCP est cr√©√©, un VPC appel√© **`default`** est √©galement cr√©√©, avec les r√®gles de firewall suivantes :

* **default-allow-internal :** autoriser tout le trafic provenant d'autres instances sur le r√©seau `default`
* **default-allow-ssh :** autoriser le port 22 depuis partout
* **default-allow-rdp :** autoriser le port 3389 depuis partout
* **default-allow-icmp :** autoriser le ping depuis partout

{% hint style="warning" %}
Comme vous pouvez le voir, les **r√®gles de firewall** ont tendance √† √™tre **plus permissives** pour les **adresses IP internes**. Le VPC par d√©faut permet tout le trafic entre les Instances de Calcul.
{% endhint %}

D'autres **r√®gles de firewall** peuvent √™tre cr√©√©es pour le VPC par d√©faut ou pour de nouveaux VPCs. Les [**r√®gles de firewall**](https://cloud.google.com/vpc/docs/firewalls) peuvent √™tre appliqu√©es aux instances via les **m√©thodes** suivantes :

* [**Tags de r√©seau**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Comptes de service**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Toutes les instances au sein d'un VPC**

Malheureusement, il n'existe pas de commande `gcloud` simple pour afficher toutes les Instances de Calcul avec des ports ouverts sur Internet. Vous devez connecter les points entre les r√®gles de firewall, les tags de r√©seau, les comptes de service et les instances.

Ce processus a √©t√© automatis√© en utilisant [ce script python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) qui exportera les √©l√©ments suivants :

* Fichier CSV montrant l'instance, l'IP publique, les TCP autoris√©s, les UDP autoris√©s
* Scan nmap pour cibler toutes les instances sur les ports autoris√©s en entr√©e depuis Internet public (0.0.0.0/0)
* Scan masscan pour cibler toute la gamme TCP de ces instances qui autorisent TOUS les ports TCP depuis Internet public (0.0.0.0/0)

### Politiques de Firewall Hi√©rarchiques <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

Les _politiques de firewall hi√©rarchiques_ vous permettent de cr√©er et **d'appliquer une politique de firewall coh√©rente √† travers votre organisation**. Vous pouvez attribuer des **politiques de firewall hi√©rarchiques √† l'organisation** dans son ensemble ou √† des **dossiers individuels**. Ces politiques contiennent des r√®gles qui peuvent explicitement refuser ou autoriser des connexions.

Vous cr√©ez et appliquez des politiques de firewall en tant qu'√©tapes distinctes. Vous pouvez cr√©er et appliquer des politiques de firewall au niveau des **n≈ìuds d'organisation ou de dossier de la** [**hi√©rarchie des ressources**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Une r√®gle de politique de firewall peut **bloquer des connexions, autoriser des connexions ou diff√©rer l'√©valuation des r√®gles de firewall** vers des dossiers de niveau inf√©rieur ou des r√®gles de firewall VPC d√©finies dans les r√©seaux VPC.

Par d√©faut, toutes les r√®gles de politique de firewall hi√©rarchiques s'appliquent √† toutes les VM dans tous les projets sous l'organisation ou le dossier o√π la politique est associ√©e. Cependant, vous pouvez **restreindre les VM qui re√ßoivent une r√®gle donn√©e** en sp√©cifiant des [r√©seaux cibles ou des comptes de service cibles](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Vous pouvez lire ici comment [**cr√©er une Politique de Firewall Hi√©rarchique**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### √âvaluation des R√®gles de Firewall

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. Org : Politiques de firewall assign√©es √† l'Organisation
2. Dossier : Politiques de firewall assign√©es au Dossier
3. VPC : R√®gles de firewall assign√©es au VPC
4. Global : Un autre type de r√®gles de firewall qui peuvent √™tre assign√©es aux VPCs
5. R√©gional : R√®gles de firewall associ√©es au r√©seau VPC de la NIC de la VM et √† la r√©gion de la VM.

## Peering de R√©seau VPC

Permet de connecter deux r√©seaux Virtual Private Cloud (VPC) afin que **les ressources de chaque r√©seau puissent communiquer** entre elles.\
Les r√©seaux VPC en peering peuvent √™tre dans le m√™me projet, dans des projets diff√©rents de la m√™me organisation, ou **dans des projets diff√©rents de diff√©rentes organisations**.

Voici les permissions n√©cessaires :

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Plus dans la documentation**](https://cloud.google.com/vpc/docs/vpc-peering).

## R√©f√©rences

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
