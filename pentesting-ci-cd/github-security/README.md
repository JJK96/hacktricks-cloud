# Github Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**구독 플랜**](https://github.com/sponsors/carlospolop)을 확인하세요!
* **💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**telegram 그룹**](https://t.me/peass)에 가입하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)을 팔로우하세요.**
* **PR을 제출하여** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 해킹 트릭을 공유하세요.

</details>
{% endhint %}

## Github이란

([여기](https://kinsta.com/knowledgebase/what-is-github/)에서 발췌) 높은 수준에서, **GitHub는 개발자가 코드를 저장하고 관리하며 코드 변경 사항을 추적하고 제어할 수 있도록 돕는 웹사이트 및 클라우드 기반 서비스입니다**.

### 기본 정보

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## 외부 정찰

Github 저장소는 공개, 비공개 및 내부로 구성할 수 있습니다.

* **비공개**는 **조직**의 사람들만 접근할 수 있음을 의미합니다.
* **내부**는 **기업**의 사람들만 접근할 수 있음을 의미합니다 (기업은 여러 조직을 가질 수 있습니다).
* **공개**는 **모든 인터넷 사용자**가 접근할 수 있음을 의미합니다.

**대상으로 삼고자 하는 사용자, 저장소 또는 조직**을 알고 있는 경우 **github dorks**를 사용하여 민감한 정보를 찾거나 **각 저장소에서 민감한 정보 유출**을 검색할 수 있습니다.

### Github Dorks

Github는 **사용자, 저장소 또는 조직을 범위로 지정하여 검색할 수 있습니다**. 따라서 민감한 정보 근처에 나타날 문자열 목록을 사용하여 **대상에서 잠재적인 민감한 정보를 쉽게 검색할 수 있습니다**.

도구 (각 도구는 자체 dorks 목록을 포함합니다):

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker) ([Dorks 목록](https://github.com/obheda12/GitDorker/tree/master/Dorks))
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks) ([Dorks 목록](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt))
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber) ([Dorks 목록](https://github.com/hisxo/gitGraber/tree/master/wordlists))

### Github Leaks

github dorks는 github 검색 옵션을 사용하여 유출을 검색하기 위한 것입니다. 이 섹션은 **각 저장소를 다운로드하고 그 안에서 민감한 정보를 검색하는** 도구에 전념합니다 (특정 커밋 깊이까지 확인).

도구 (각 도구는 자체 정규 표현식 목록을 포함합니다):

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
저장소에서 유출을 검색하고 `git log -p`와 같은 명령을 실행할 때 **다른 커밋이 포함된 다른 브랜치**가 있을 수 있음을 잊지 마세요!
{% endhint %}

### 외부 포크

**풀 리퀘스트를 악용하여 저장소를 손상**시킬 수 있습니다. 저장소가 취약한지 확인하려면 주로 Github Actions yaml 구성을 읽어야 합니다. [**아래에서 더 많은 정보**](./#execution-from-a-external-fork)를 확인하세요.

## 조직 강화

### 멤버 권한

조직의 **멤버**에게 할당할 수 있는 **기본 권한**이 있습니다. 이는 `https://github.com/organizations/<org_name>/settings/member_privileges` 페이지나 [**Organizations API**](https://docs.github.com/en/rest/orgs/orgs)에서 제어할 수 있습니다.

* **기본 권한**: 멤버는 조직 저장소에 대해 None/Read/write/Admin 권한을 가집니다. 권장 사항은 **None** 또는 **Read**입니다.
* **저장소 포크**: 필요하지 않다면, 조직 저장소를 포크하는 것을 **허용하지 않는 것이 좋습니다**.
* **페이지 생성**: 필요하지 않다면, 조직 저장소에서 페이지를 게시하는 것을 **허용하지 않는 것이 좋습니다**. 필요하다면 공개 또는 비공개 페이지를 생성할 수 있습니다.
* **통합 접근 요청**: 이 기능을 활성화하면 외부 협력자가 GitHub 또는 OAuth 앱에 이 조직과 그 리소스에 접근할 수 있도록 요청할 수 있습니다. 일반적으로 필요하지만, 필요하지 않다면 비활성화하는 것이 좋습니다.
* _이 정보를 API 응답에서 찾을 수 없었습니다. 찾으시면 공유해주세요_
* **저장소 가시성 변경**: 활성화되면 **저장소**에 대한 **관리자** 권한을 가진 **멤버**가 **가시성을 변경**할 수 있습니다. 비활성화되면 조직 소유자만 저장소 가시성을 변경할 수 있습니다. **공개**로 만들고 싶지 않다면, 이 기능을 **비활성화**하세요.
* _이 정보를 API 응답에서 찾을 수 없었습니다. 찾으시면 공유해주세요_
* **저장소 삭제 및 전송**: 활성화되면 **저장소**에 대한 **관리자** 권한을 가진 멤버가 **공개 및 비공개 저장소를 삭제하거나 전송**할 수 있습니다.
* _이 정보를 API 응답에서 찾을 수 없었습니다. 찾으시면 공유해주세요_
* **멤버가 팀을 생성하도록 허용**: 활성화되면 조직의 **멤버**가 **새 팀을 생성**할 수 있습니다. 비활성화되면 조직 소유자만 새 팀을 생성할 수 있습니다. 비활성화하는 것이 좋습니다.
* _이 정보를 API 응답에서 찾을 수 없었습니다. 찾으시면 공유해주세요_
* **이 페이지에서 더 많은 것을 구성할 수 있지만, 이전 항목들이 보안과 관련이 가장 많습니다.**

### Actions 설정

여러 보안 관련 설정을 `https://github.com/organizations/<org_name>/settings/actions` 페이지에서 구성할 수 있습니다.

{% hint style="info" %}
이 모든 구성은 각 저장소에서 독립적으로 설정할 수도 있습니다.
{% endhint %}

* **Github actions 정책**: 워크플로를 실행할 수 있는 저장소와 허용할 워크플로를 지정할 수 있습니다. **허용할 저장소를 지정**하고 모든 작업을 실행하지 않도록 하는 것이 좋습니다.
* [**API-1**](https://docs.github.com/en/rest/actions/permissions#get-allowed-actions-and-reusable-workflows-for-an-organization)**,** [**API-2**](https://docs.github.com/en/rest/actions/permissions#list-selected-repositories-enabled-for-github-actions-in-an-organization)
* **외부 협력자의 포크 풀 리퀘스트 워크플로**: **모든 외부 협력자에 대해 승인을 요구**하는 것이 좋습니다.
* _이 정보를 포함한 API를 찾을 수 없었습니다. 찾으시면 공유해주세요_
* **포크 풀 리퀘스트에서 워크플로 실행**: **포크 풀 리퀘스트에서 워크플로를 실행하는 것을 강력히 권장하지 않습니다**. 포크 원본의 유지 관리자가 소스 저장소에 대한 읽기 권한이 있는 토큰을 사용할 수 있게 됩니다.
* _이 정보를 포함한 API를 찾을 수 없었습니다. 찾으시면 공유해주세요_
* **워크플로 권한**: **저장소 읽기 권한만 부여하는 것이 좋습니다**. 실행 중인 워크플로에 부여된 GITHUB\_TOKEN의 남용을 방지하기 위해 쓰기 및 생성/승인 풀 리퀘스트 권한을 부여하는 것은 권장하지 않습니다.
* [**API**](https://docs.github.com/en/rest/actions/permissions#get-default-workflow-permissions-for-an-organization)

### 통합

_이 정보를 액세스할 수 있는 API 엔드포인트를 알고 있다면 알려주세요!_

* **서드파티 애플리케이션 접근 정책**: 모든 애플리케이션에 대한 접근을 제한하고 필요한 애플리케이션만 허용하는 것이 좋습니다 (검토 후).
* **설치된 GitHub 앱**: 필요한 애플리케이션만 허용하는 것이 좋습니다 (검토 후).

## 자격 증명을 악용한 정찰 및 공격

이 시나리오에서는 github 계정에 대한 일부 접근 권한을 얻었다고 가정합니다.

### 사용자 자격 증명으로

어떤 방식으로든 조직 내 사용자의 자격 증명을 이미 가지고 있다면 **로그인**하여 **기업 및 조직 역할**을 확인하고, 일반 멤버라면 **일반 멤버의 권한**, **소속 그룹**, **저장소에 대한 권한**, **저장소 보호 상태**를 확인할 수 있습니다.

**2FA가 사용될 수 있으므로** 이 정보를 액세스하려면 **그 검사를 통과할 수 있어야 합니다**.

{% hint style="info" %}
**`user_session` 쿠키를 탈취**하면 (현재 SameSite: Lax로 구성됨) **자격 증명이나 2FA 없이 사용자를 완전히 가장할 수 있습니다**.
{% endhint %}

아래 [**브랜치 보호 우회**](./#branch-protection-bypass) 섹션을 확인하여 유용한지 확인하세요.

### 사용자 SSH 키로

Github는 **사용자**가 **SSH 키**를 설정하여 **코드를 배포할 때 인증 방법으로 사용**할 수 있도록 허용합니다 (2FA는 적용되지 않음).

이 키를 사용하여 **사용자가 일부 권한을 가진 저장소에서 변경을 수행**할 수 있지만, github api에 접근하여 환경을 나열할 수는 없습니다. 그러나 **로컬 설정을 나열**하여 접근할 수 있는 저장소 및 사용자에 대한 정보를 얻을 수 있습니다:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
만약 사용자가 자신의 github 사용자 이름으로 사용자 이름을 설정했다면, 그의 계정에 설정된 **공개 키**를 _https://github.com/\<github\_username>.keys_에서 접근할 수 있습니다. 이를 확인하여 찾은 개인 키를 사용할 수 있는지 확인할 수 있습니다.

**SSH 키**는 **배포 키**로서 저장소에 설정될 수도 있습니다. 이 키에 접근할 수 있는 사람은 누구나 **저장소에서 프로젝트를 시작할 수 있습니다**. 보통 여러 배포 키가 있는 서버에서는 로컬 파일 **`~/.ssh/config`**이 어떤 키와 관련이 있는지 정보를 제공합니다.

#### GPG Keys

[**여기**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/github-security/broken-reference/README.md)에서 설명한 것처럼, 때때로 커밋에 서명해야 하거나 발견될 수 있습니다.

현재 사용자가 어떤 키를 가지고 있는지 로컬에서 확인하려면:
```shell
gpg --list-secret-keys --keyid-format=long
```
### 사용자 토큰으로

[**사용자 토큰에 대한 기본 정보는 여기서 확인하세요**](basic-github-information.md#personal-access-tokens).

사용자 토큰은 Git을 HTTPS를 통해 사용할 때 **비밀번호 대신** 사용할 수 있으며, [**기본 인증을 통해 API에 인증**](https://docs.github.com/v3/auth/#basic-authentication)할 때 사용할 수 있습니다. 부여된 권한에 따라 다양한 작업을 수행할 수 있습니다.

사용자 토큰은 다음과 같이 생겼습니다: `ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### Oauth 애플리케이션으로

[**Github Oauth 애플리케이션에 대한 기본 정보는 여기서 확인하세요**](basic-github-information.md#oauth-applications).

공격자는 **악성 Oauth 애플리케이션**을 만들어 피싱 캠페인의 일환으로 사용자가 이를 수락하도록 유도하여 권한 있는 데이터/작업에 접근할 수 있습니다.

이것들은 [Oauth 애플리케이션이 요청할 수 있는 범위](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps)입니다. 수락하기 전에 항상 요청된 범위를 확인해야 합니다.

또한, 기본 정보에서 설명한 것처럼, **조직은 제3자 애플리케이션에 대한 접근을 허용/거부**할 수 있습니다.

### Github 애플리케이션으로

[**Github 애플리케이션에 대한 기본 정보는 여기서 확인하세요**](basic-github-information.md#github-applications).

공격자는 **악성 Github 애플리케이션**을 만들어 피싱 캠페인의 일환으로 사용자가 이를 수락하도록 유도하여 권한 있는 데이터/작업에 접근할 수 있습니다.

또한, 기본 정보에서 설명한 것처럼, **조직은 제3자 애플리케이션에 대한 접근을 허용/거부**할 수 있습니다.

## Github Action 손상 및 악용

Github Action을 손상시키고 악용하는 여러 가지 기술이 있습니다. 여기서 확인하세요:

{% content-ref url="abusing-github-actions/" %}
[abusing-github-actions](abusing-github-actions/)
{% endcontent-ref %}

## 브랜치 보호 우회

* **승인 수 요구**: 여러 계정을 손상시킨 경우 다른 계정에서 PR을 승인할 수 있습니다. PR을 생성한 계정만 있는 경우 자신의 PR을 승인할 수 없습니다. 그러나 **Github Action** 환경에 접근할 수 있다면 **GITHUB\_TOKEN**을 사용하여 **PR을 승인**하고 이 방법으로 1개의 승인을 받을 수 있습니다.
* _이 경우와 코드 소유자 제한의 경우, 일반적으로 사용자는 자신의 PR을 승인할 수 없지만, 가능하다면 이를 악용하여 PR을 승인할 수 있습니다._
* **새 커밋이 푸시될 때 승인을 해제**: 이 설정이 되어 있지 않으면, 합법적인 코드를 제출하고 누군가가 이를 승인할 때까지 기다린 후 악성 코드를 추가하고 보호된 브랜치에 병합할 수 있습니다.
* **코드 소유자의 리뷰 요구**: 이 설정이 활성화되어 있고 사용자가 코드 소유자인 경우, **Github Action을 사용하여 PR을 생성하고 직접 승인**할 수 있습니다.
* **CODEOWNER 파일이 잘못 구성된 경우** Github는 불평하지 않지만 이를 사용하지 않습니다. 따라서 잘못 구성된 경우 **코드 소유자 보호가 적용되지 않습니다.**
* **지정된 액터가 풀 리퀘스트 요구 사항을 우회하도록 허용**: 이러한 액터 중 하나인 경우 풀 리퀘스트 보호를 우회할 수 있습니다.
* **관리자 포함**: 이 설정이 되어 있지 않고 사용자가 리포지토리의 관리자라면, 이 브랜치 보호를 우회할 수 있습니다.
* **PR 하이재킹**: 다른 사람의 PR을 **수정하여 악성 코드를 추가하고, 결과 PR을 승인하고 병합**할 수 있습니다.
* **브랜치 보호 제거**: 리포지토리의 **관리자인 경우 보호를 비활성화**하고 PR을 병합한 후 보호를 다시 설정할 수 있습니다.
* **푸시 보호 우회**: 리포지토리가 **특정 사용자만** 브랜치에 푸시(코드 병합)할 수 있도록 허용하는 경우(브랜치 보호가 와일드카드 `*`를 지정하여 모든 브랜치를 보호할 수 있습니다).
* 리포지토리에 **쓰기 권한이 있지만 브랜치 보호로 인해 코드를 푸시할 수 없는 경우**, 여전히 **새 브랜치를 생성**하고 그 안에 **코드가 푸시될 때 트리거되는 github action을 생성**할 수 있습니다. **브랜치 보호는 브랜치가 생성될 때까지 브랜치를 보호하지 않으므로**, 이 첫 번째 코드 푸시는 **github action을 실행**할 것입니다.

## 환경 보호 우회

[**Github 환경에 대한 기본 정보는 여기서 확인하세요**](basic-github-information.md#git-environments).

환경이 **모든 브랜치에서 접근 가능**한 경우, **보호되지 않으며** 환경 내의 비밀에 쉽게 접근할 수 있습니다. 모든 브랜치가 **보호된** 리포지토리를 찾을 수 있습니다(이름을 지정하거나 `*`를 사용하여). 이 경우, **코드를 푸시할 수 있는 브랜치를 찾아** 새 github action을 생성하거나 기존 것을 수정하여 **비밀을 유출**할 수 있습니다.

모든 브랜치가 **보호된** 경우(와일드카드 `*`를 통해), **브랜치에 코드를 푸시할 수 있는 사용자를 지정**하고 **사용자가 허용되지 않은 경우**가 있을 수 있습니다. 여전히 사용자 정의 github action을 실행할 수 있습니다. 브랜치를 생성하고 푸시 트리거를 사용하면 됩니다. **브랜치 보호는 새 브랜치에 대한 푸시를 허용하므로 github action이 트리거될 것입니다**.
```yaml
push: # Run it when a push is made to a branch
branches:
- current_branch_name #Use '**' to run when a push is made to any branch
```
브랜치가 생성된 후 **브랜치 보호가 새로운 브랜치에 적용**되며 수정할 수 없게 되지만, 그 시점에는 이미 비밀을 덤프했을 것입니다.

## 지속성

* **사용자 토큰** 생성
* **secrets**에서 **github 토큰** 탈취
* 워크플로우 **결과** 및 **브랜치** **삭제**
* 모든 조직에 **더 많은 권한 부여**
* 정보를 유출하기 위한 **webhooks** 생성
* **외부 협력자** 초대
* **SIEM**에서 사용되는 **webhooks** **제거**
* **백도어**가 있는 **Github Action** 생성/수정
* **secret** 값 수정을 통한 **명령어 주입에 취약한 Github Action** 찾기

### Imposter Commits - 리포 커밋을 통한 백도어

Github에서는 **포크에서 리포로 PR을 생성**할 수 있습니다. PR이 **승인되지 않더라도**, 포크 버전의 코드에 대해 원본 리포에 **커밋** ID가 생성됩니다. 따라서 공격자는 **리포 소유자가 생성하지 않은 것처럼 보이는 특정 커밋을 사용하도록 고정할 수 있습니다**.

[**이 예시**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e)처럼:
```yaml
name: example
on: [push]
jobs:
commit:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
- shell: bash
run: |
echo 'hello world!'
```
더 많은 정보는 [https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)를 참조하세요.

{% hint style="success" %}
AWS Hacking 배우기 및 연습하기:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking 배우기 및 연습하기: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원하기</summary>

* [**구독 플랜**](https://github.com/sponsors/carlospolop)을 확인하세요!
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**telegram 그룹**](https://t.me/peass)에 가입하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)를 팔로우하세요.
* PR을 제출하여 [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 해킹 트릭을 공유하세요.

</details>
{% endhint %}
