# Github Security

{% hint style="success" %}
AWS Hackingを学び、練習する:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingを学び、練習する: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローする。**
* **PRを提出してハッキングトリックを共有する** [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリに。

</details>
{% endhint %}

## What is Github

([こちら](https://kinsta.com/knowledgebase/what-is-github/)から) 高レベルでは、**GitHubは開発者がコードを保存および管理し、コードの変更を追跡および制御するのを助けるウェブサイトおよびクラウドベースのサービス**です。

### Basic Information

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## External Recon

Githubリポジトリは、パブリック、プライベート、インターナルとして設定できます。

* **Private**は、**組織**の人々**のみ**がアクセスできることを意味します
* **Internal**は、**企業**（企業には複数の組織がある場合があります）の人々**のみ**がアクセスできることを意味します
* **Public**は、**全インターネット**がアクセスできることを意味します。

**ターゲットにしたいユーザー、リポジトリ、または組織**がわかっている場合は、**github dorks**を使用して機密情報を見つけるか、**各リポジトリ**で**機密情報の漏洩**を検索できます。

### Github Dorks

Githubは、**ユーザー、リポジトリ、または組織をスコープとして指定して何かを検索する**ことを許可します。したがって、機密情報の近くに表示される文字列のリストを使用して、ターゲットの**潜在的な機密情報を簡単に検索**できます。

ツール（各ツールにはそのリストのdorksが含まれています）:

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker) ([Dorks list](https://github.com/obheda12/GitDorker/tree/master/Dorks))
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks) ([Dorks list](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt))
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber) ([Dorks list](https://github.com/hisxo/gitGraber/tree/master/wordlists))

### Github Leaks

github dorksはgithubの検索オプションを使用して漏洩を検索することも意図していることに注意してください。このセクションは、**各リポジトリをダウンロードして機密情報を検索する**（特定のコミットの深さまでチェックする）ツールに専念しています。

ツール（各ツールにはそのリストの正規表現が含まれています）:

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
リポジトリで漏洩を検索し、`git log -p`のようなものを実行する場合、**他のコミットを含む他のブランチ**に秘密が含まれている可能性があることを忘れないでください！
{% endhint %}

### External Forks

プルリクエストを悪用して**リポジトリを侵害する**ことが可能です。リポジトリが脆弱かどうかを知るには、主にGithub Actionsのyaml設定を読む必要があります。[**詳細は以下を参照**](./#execution-from-a-external-fork)。

## Organization Hardening

### Member Privileges

組織の**メンバー**に割り当てることができる**デフォルトの特権**があります。これらは`https://github.com/organizations/<org_name>/settings/member_privileges`のページまたは[**Organizations API**](https://docs.github.com/en/rest/orgs/orgs)から制御できます。

* **基本権限**: メンバーはorgリポジトリに対してNone/Read/write/Adminの権限を持ちます。推奨は**None**または**Read**です。
* **リポジトリのフォーク**: 必要でない場合、組織のリポジトリをフォークすることを**許可しない**方が良いです。
* **ページの作成**: 必要でない場合、orgリポジトリからページを公開することを**許可しない**方が良いです。必要な場合は、パブリックまたはプライベートページの作成を許可できます。
* **統合アクセスリクエスト**: これを有効にすると、外部のコラボレーターがGitHubまたはOAuthアプリのこの組織およびそのリソースへのアクセスをリクエストできるようになります。通常は必要ですが、必要ない場合は無効にする方が良いです。
* _APIのレスポンスでこの情報を見つけられませんでした。見つけたら共有してください_
* **リポジトリの可視性変更**: 有効にすると、**リポジトリ**の**管理者**権限を持つ**メンバー**が**可視性を変更**できるようになります。無効にすると、組織の所有者のみがリポジトリの可視性を変更できます。**公開**したくない場合は、これを**無効**にしてください。
* _APIのレスポンスでこの情報を見つけられませんでした。見つけたら共有してください_
* **リポジトリの削除と転送**: 有効にすると、リポジトリの**管理者**権限を持つメンバーが**パブリックおよびプライベートリポジトリ**を**削除**または**転送**できるようになります。
* _APIのレスポンスでこの情報を見つけられませんでした。見つけたら共有してください_
* **メンバーがチームを作成できるようにする**: 有効にすると、組織の**メンバー**は新しい**チーム**を**作成**できるようになります。無効にすると、組織の所有者のみが新しいチームを作成できます。これを無効にしておく方が良いです。
* _APIのレスポンスでこの情報を見つけられませんでした。見つけたら共有してください_
* **このページでさらに多くのことを設定できますが、前述のものがセキュリティに関連するものです。**

### Actions Settings

アクションに関するいくつかのセキュリティ関連設定は、`https://github.com/organizations/<org_name>/settings/actions`のページから設定できます。

{% hint style="info" %}
これらの設定は各リポジトリごとに独立して設定できることに注意してください
{% endhint %}

* **Github actionsポリシー**: ワークフローを実行できるリポジトリと許可されるワークフローを指定できます。**許可されるリポジトリを指定**し、すべてのアクションの実行を許可しないことを推奨します。
* [**API-1**](https://docs.github.com/en/rest/actions/permissions#get-allowed-actions-and-reusable-workflows-for-an-organization)**,** [**API-2**](https://docs.github.com/en/rest/actions/permissions#list-selected-repositories-enabled-for-github-actions-in-an-organization)
* **外部コラボレーターからのフォークプルリクエストワークフロー**: **すべての外部コラボレーターに承認を要求**することを推奨します。
* _この情報を持つAPIを見つけられませんでした。見つけたら共有してください_
* **フォークプルリクエストからのワークフローの実行**: プルリクエストからのワークフローの実行は**強く推奨されません**。フォーク元のメンテナはソースリポジトリの読み取り権限を持つトークンを使用できるようになります。
* _この情報を持つAPIを見つけられませんでした。見つけたら共有してください_
* **ワークフローの権限**: **リポジトリの読み取り権限のみを付与**することを強く推奨します。GITHUB\_TOKENを使用したワークフローの乱用を避けるために、書き込みおよびプルリクエストの作成/承認権限を付与することは推奨されません。
* [**API**](https://docs.github.com/en/rest/actions/permissions#get-default-workflow-permissions-for-an-organization)

### Integrations

_この情報にアクセスするAPIエンドポイントを知っている場合は教えてください！_

* **サードパーティアプリケーションアクセスポリシー**: すべてのアプリケーションへのアクセスを制限し、必要なもの（レビュー後）だけを許可することを推奨します。
* **インストールされたGitHubアプリ**: 必要なもの（レビュー後）だけを許可することを推奨します。

## Recon & Attacks abusing credentials

このシナリオでは、githubアカウントへのアクセスを取得したと仮定します。

### With User Credentials

組織内のユーザーの資格情報を何らかの方法で既に持っている場合、**ログイン**して**エンタープライズおよび組織の役割**を確認し、一般メンバーである場合は、**一般メンバーの権限**、所属する**グループ**、**リポジトリに対する権限**、および**リポジトリの保護方法**を確認できます。

**2FAが使用されている**可能性があるため、この情報にアクセスできるのは**そのチェックも通過できる場合**のみです。

{% hint style="info" %}
`user_session`クッキーを**盗むことができれば**（現在SameSite: Laxで設定されています）、資格情報や2FAを必要とせずに**完全にユーザーを偽装**できることに注意してください。
{% endhint %}

以下の[**ブランチ保護のバイパス**](./#branch-protection-bypass)に関するセクションが役立つ場合があります。

### With User SSH Key

Githubは**ユーザー**が**SSHキー**を設定し、**コードをデプロイするための認証方法**として使用できるようにします（2FAは適用されません）。

このキーを使用して、**ユーザーがいくつかの権限を持つリポジトリに変更を加える**ことができますが、環境を列挙するためにgithub apiにアクセスすることはできません。ただし、**ローカル設定を列挙**して、アクセスできるリポジトリやユーザーに関する情報を取得できます:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
ユーザーが自分のGitHubユーザー名をユーザー名として設定している場合、アカウントに設定されている**公開鍵**にアクセスできます。_https://github.com/\<github\_username>.keys_ で確認し、見つけた秘密鍵が使用できるか確認できます。

**SSH鍵**はリポジトリに**デプロイ鍵**として設定することもできます。この鍵にアクセスできる人は誰でも**リポジトリからプロジェクトを起動**できます。通常、異なるデプロイ鍵を持つサーバーでは、ローカルファイル **`~/.ssh/config`** に関連する鍵の情報が記載されています。

#### GPG Keys

[**こちら**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/github-security/broken-reference/README.md)で説明されているように、コミットに署名する必要がある場合や、発見される可能性があります。

現在のユーザーがキーを持っているかどうかをローカルで確認します:
```shell
gpg --list-secret-keys --keyid-format=long
```
### With User Token

[**User Tokensの基本情報はこちら**](basic-github-information.md#personal-access-tokens)を参照してください。

ユーザートークンは、Git over HTTPSの**パスワードの代わり**として使用することができ、また[**APIへのBasic Authenticationでの認証**](https://docs.github.com/v3/auth/#basic-authentication)にも使用できます。付与された権限に応じて、さまざまなアクションを実行できる可能性があります。

ユーザートークンは次のように見えます: `ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### With Oauth Application

[**Github Oauth Applicationsの基本情報はこちら**](basic-github-information.md#oauth-applications)を参照してください。

攻撃者は、フィッシングキャンペーンの一環として、ユーザーが受け入れる**悪意のあるOauth Application**を作成し、特権データやアクションにアクセスする可能性があります。

これらは[Oauthアプリケーションが要求できるスコープ](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps)です。受け入れる前に常に要求されたスコープを確認する必要があります。

さらに、基本情報で説明されているように、**組織はサードパーティアプリケーションへのアクセスを許可/拒否**することができます。

### With Github Application

[**Github Applicationsの基本情報はこちら**](basic-github-information.md#github-applications)を参照してください。

攻撃者は、フィッシングキャンペーンの一環として、ユーザーが受け入れる**悪意のあるGithub Application**を作成し、特権データやアクションにアクセスする可能性があります。

さらに、基本情報で説明されているように、**組織はサードパーティアプリケーションへのアクセスを許可/拒否**することができます。

## Compromise & Abuse Github Action

Github Actionを侵害および悪用するためのいくつかの技術があります。こちらを確認してください:

{% content-ref url="abusing-github-actions/" %}
[abusing-github-actions](abusing-github-actions/)
{% endcontent-ref %}

## Branch Protection Bypass

* **Require a number of approvals**: 複数のアカウントを侵害した場合、他のアカウントから自分のPRを承認することができます。PRを作成したアカウントだけを持っている場合、自分のPRを承認することはできません。しかし、リポジトリ内の**Github Action**環境にアクセスできる場合、**GITHUB\_TOKEN**を使用して**PRを承認**し、この方法で1つの承認を得ることができます。
* _この点とCode Ownersの制限について、通常ユーザーは自分のPRを承認できませんが、もしできる場合はそれを悪用して自分のPRを承認することができます。_
* **Dismiss approvals when new commits are pushed**: これが設定されていない場合、正当なコードを提出し、誰かが承認するのを待ってから、悪意のあるコードを追加して保護されたブランチにマージすることができます。
* **Require reviews from Code Owners**: これが有効になっていて、あなたがCode Ownerである場合、**Github Actionを使用してPRを作成し、自分で承認する**ことができます。
* **CODEOWNERファイルが誤って構成されている場合**、Githubは文句を言いませんが、それを使用しません。したがって、誤って構成されている場合、**Code Ownersの保護は適用されません。**
* **Allow specified actors to bypass pull request requirements**: これらのアクターの1人である場合、プルリクエストの保護を回避することができます。
* **Include administrators**: これが設定されていない場合、リポジトリの管理者であれば、このブランチの保護を回避することができます。
* **PR Hijacking**: 他の誰かのPRを**変更して悪意のあるコードを追加し、結果として得られたPRを自分で承認してすべてをマージする**ことができます。
* **Removing Branch Protections**: **リポジトリの管理者であれば、保護を無効にして**、PRをマージし、保護を再設定することができます。
* **Bypassing push protections**: リポジトリが**特定のユーザーのみ**がブランチにプッシュ（コードをマージ）することを許可している場合（ブランチ保護がワイルドカード`*`を指定してすべてのブランチを保護している可能性があります）。
* **リポジトリに対して書き込みアクセス権を持っているが、ブランチ保護のためにコードをプッシュすることが許可されていない場合**、新しいブランチを作成し、その中で**コードがプッシュされたときにトリガーされるgithub actionを作成する**ことができます。**ブランチ保護はブランチが作成されるまでそのブランチを保護しないため**、この最初のコードプッシュは**github actionを実行します**。

## Bypass Environments Protections

[**Github Environmentの基本情報はこちら**](basic-github-information.md#git-environments)を参照してください。

環境が**すべてのブランチからアクセス可能**な場合、それは**保護されていない**ため、環境内のシークレットに簡単にアクセスできます。リポジトリの**すべてのブランチが保護されている**（名前を指定するか`*`を使用して）場合、そのシナリオでは、**コードをプッシュできるブランチを見つけ**、新しいgithub actionを作成するか、既存のものを変更して**シークレットを抽出**することができます。

注意すべきは、**すべてのブランチが保護されている**（ワイルドカード`*`を使用）場合、**誰がブランチにコードをプッシュできるか**が指定されており（ブランチ保護で指定できます）、**あなたのユーザーが許可されていない**場合です。この場合でもカスタムgithub actionを実行できます。新しいブランチを作成し、そのブランチに対してプッシュトリガーを使用することができます。**ブランチ保護は新しいブランチへのプッシュを許可するため、github actionがトリガーされます**。
```yaml
push: # Run it when a push is made to a branch
branches:
- current_branch_name #Use '**' to run when a push is made to any branch
```
ブランチの**作成後**、**ブランチ保護が新しいブランチに適用され**、それを変更することはできませんが、その時点で秘密情報はすでにダンプされています。

## 永続性

* **ユーザートークン**を生成
* **secrets**から**githubトークン**を盗む
* ワークフローの**結果**と**ブランチ**を**削除**
* 全ての組織に**より多くの権限を付与**
* 情報を流出させるための**webhooks**を作成
* **外部コラボレーター**を招待
* **SIEM**で使用される**webhooks**を**削除**
* **バックドア**付きの**Github Action**を作成/修正
* **シークレット**値の変更を通じて**コマンドインジェクションに脆弱なGithub Action**を見つける

### 偽装コミット - リポジトリコミットを通じたバックドア

Githubでは、**フォークからリポジトリにPRを作成**することが可能です。PRが**受け入れられなくても**、フォーク版のコードに対して元のリポジトリ内に**コミットID**が作成されます。したがって、攻撃者は**リポジトリの所有者によって作成されていない、見かけ上合法なリポジトリから特定のコミットを使用するようにピン留めすることができます**。

[**このように**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e):
```yaml
name: example
on: [push]
jobs:
commit:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
- shell: bash
run: |
echo 'hello world!'
```
詳細については、[https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd) をチェックしてください。

{% hint style="success" %}
AWS Hacking を学び、練習する:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking を学び、練習する: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks をサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop) をチェックしてください！
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 で [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) をフォローしてください。
* **PR を提出してハッキングトリックを共有してください** [**HackTricks**](https://github.com/carlospolop/hacktricks) および [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の github リポジトリに。

</details>
{% endhint %}
