# Github Security

{% hint style="success" %}
学习和练习 AWS Hacking：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和练习 GCP Hacking：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交 PR 分享黑客技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库。

</details>
{% endhint %}

## 什么是 Github

（来自[这里](https://kinsta.com/knowledgebase/what-is-github/)）从高层次来看，**GitHub 是一个网站和基于云的服务，帮助开发人员存储和管理代码，以及跟踪和控制代码的更改**。

### 基本信息

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## 外部侦察

Github 仓库可以配置为公开、私有和内部。

* **私有**意味着**只有**组织的**成员**才能访问它们
* **内部**意味着**只有**企业（一个企业可能有多个组织）的**成员**才能访问它
* **公开**意味着**所有互联网用户**都可以访问它。

如果你知道你想要攻击的**用户、仓库或组织**，你可以使用**github dorks**来查找敏感信息或在**每个仓库**中搜索**敏感信息泄露**。

### Github Dorks

Github 允许**在指定用户、仓库或组织的范围内搜索某些内容**。因此，通过一组可能出现在敏感信息附近的字符串，你可以轻松地**在目标中搜索潜在的敏感信息**。

工具（每个工具包含其 dorks 列表）：

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker) ([Dorks 列表](https://github.com/obheda12/GitDorker/tree/master/Dorks))
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks) ([Dorks 列表](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt))
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber) ([Dorks 列表](https://github.com/hisxo/gitGraber/tree/master/wordlists))

### Github Leaks

请注意，github dorks 也用于使用 github 搜索选项查找泄露信息。本节专门介绍那些将**下载每个仓库并在其中搜索敏感信息**（甚至检查某些提交深度）的工具。

工具（每个工具包含其正则表达式列表）：

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
当你在一个仓库中查找泄露信息并运行类似 `git log -p` 的命令时，不要忘记可能还有**其他分支和其他提交**包含秘密！
{% endhint %}

### 外部 Forks

可以通过**滥用 pull requests 来攻破仓库**。要知道一个仓库是否易受攻击，你主要需要阅读 Github Actions yaml 配置。[**更多信息在下方**](./#execution-from-a-external-fork)。

## 组织加固

### 成员权限

有一些**默认权限**可以分配给**组织成员**。这些可以从页面 `https://github.com/organizations/<org_name>/settings/member_privileges` 或 [**Organizations API**](https://docs.github.com/en/rest/orgs/orgs) 进行控制。

* **基本权限**：成员将拥有对组织仓库的 None/Read/write/Admin 权限。推荐使用 **None** 或 **Read**。
* **仓库分叉**：如果没有必要，最好**不允许**成员分叉组织仓库。
* **页面创建**：如果没有必要，最好**不允许**成员从组织仓库发布页面。如果需要，可以允许创建公开或私有页面。
* **集成访问请求**：启用此功能后，外部协作者将能够请求 GitHub 或 OAuth 应用访问此组织及其资源。通常是需要的，但如果不需要，最好禁用它。
* _我在 API 响应中找不到此信息，如果你找到了请分享_
* **仓库可见性更改**：如果启用，拥有**仓库**的**管理员**权限的**成员**将能够**更改其可见性**。如果禁用，只有组织所有者可以更改仓库可见性。如果你**不希望**人们将内容**公开**，请确保此项**禁用**。
* _我在 API 响应中找不到此信息，如果你找到了请分享_
* **仓库删除和转移**：如果启用，拥有**仓库**的**管理员**权限的成员将能够**删除**或**转移**公共和私有**仓库**。
* _我在 API 响应中找不到此信息，如果你找到了请分享_
* **允许成员创建团队**：如果启用，组织的任何**成员**都可以**创建**新**团队**。如果禁用，只有组织所有者可以创建新团队。最好禁用此项。
* _我在 API 响应中找不到此信息，如果你找到了请分享_
* **更多配置项**可以在此页面进行配置，但以上是与安全性相关的主要配置项。

### Actions 设置

可以从页面 `https://github.com/organizations/<org_name>/settings/actions` 配置多个与安全相关的设置。

{% hint style="info" %}
请注意，所有这些配置也可以在每个仓库中独立设置
{% endhint %}

* **Github actions 策略**：它允许你指明哪些仓库可以运行工作流以及哪些工作流应该被允许。建议**指定允许的仓库**，而不是允许所有 actions 运行。
* [**API-1**](https://docs.github.com/en/rest/actions/permissions#get-allowed-actions-and-reusable-workflows-for-an-organization)**,** [**API-2**](https://docs.github.com/en/rest/actions/permissions#list-selected-repositories-enabled-for-github-actions-in-an-organization)
* **外部协作者的 Fork pull request 工作流**：建议**要求所有**外部协作者**批准**。
* _我找不到包含此信息的 API，如果你找到了请分享_
* **从 Fork pull requests 运行工作流**：强烈**不建议从 pull requests 运行工作流**，因为 fork 源的维护者将能够使用具有源仓库读取权限的令牌。
* _我找不到包含此信息的 API，如果你找到了请分享_
* **工作流权限**：强烈建议**仅授予读取仓库权限**。不建议授予写入和创建/批准 pull requests 权限，以避免滥用分配给运行工作流的 GITHUB\_TOKEN。
* [**API**](https://docs.github.com/en/rest/actions/permissions#get-default-workflow-permissions-for-an-organization)

### 集成

_如果你知道访问此信息的 API 端点，请告诉我！_

* **第三方应用访问策略**：建议限制对每个应用的访问，并仅允许经过审查的必要应用。
* **已安装的 GitHub 应用**：建议仅允许经过审查的必要应用。

## 滥用凭证的侦察与攻击

在这种情况下，我们假设你已经获得了一些 github 账户的访问权限。

### 使用用户凭证

如果你以某种方式已经拥有组织内某个用户的凭证，你可以**直接登录**并检查你拥有的**企业和组织角色**，如果你是普通成员，检查**普通成员的权限**，你所在的**组**，你对哪些**仓库**有**权限**，以及**仓库的保护情况**。

请注意，**可能会使用 2FA**，因此你只能在**通过该检查**的情况下访问这些信息。

{% hint style="info" %}
请注意，如果你**设法窃取 `user_session` cookie**（当前配置为 SameSite: Lax），你可以**完全冒充用户**，无需凭证或 2FA。
{% endhint %}

检查下面关于 [**分支保护绕过**](./#branch-protection-bypass) 的部分，以防有用。

### 使用用户 SSH 密钥

Github 允许**用户**设置**SSH 密钥**，这些密钥将用作**代表用户部署代码的认证方法**（不适用 2FA）。

使用此密钥，你可以在**用户拥有某些权限的仓库中进行更改**，但不能使用它访问 github api 以枚举环境。然而，你可以获取**本地设置**以获取有关你有访问权限的仓库和用户的信息：
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
如果用户将其用户名配置为他的github用户名，您可以访问他账户中设置的**公钥**，网址为_https://github.com/\<github\_username>.keys_，您可以检查此网址以确认您找到的私钥是否可以使用。

**SSH keys**也可以作为**deploy keys**设置在仓库中。任何拥有此密钥的人都可以**从仓库中启动项目**。通常在具有不同deploy keys的服务器中，本地文件**`~/.ssh/config`**将为您提供相关密钥的信息。

#### GPG Keys

如[**此处**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/github-security/broken-reference/README.md)所述，有时需要签署提交，否则您可能会被发现。

在本地检查当前用户是否有任何密钥：
```shell
gpg --list-secret-keys --keyid-format=long
```
### 使用用户令牌

有关[**用户令牌的基本信息介绍**](basic-github-information.md#personal-access-tokens)。

用户令牌可以**代替密码**用于通过 HTTPS 进行 Git 操作，或者用于[**通过基本身份验证对 API 进行身份验证**](https://docs.github.com/v3/auth/#basic-authentication)。根据其附带的权限，您可能能够执行不同的操作。

用户令牌看起来像这样：`ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### 使用 Oauth 应用程序

有关[**Github Oauth 应用程序的基本信息介绍**](basic-github-information.md#oauth-applications)。

攻击者可能会创建一个**恶意的 Oauth 应用程序**，以访问接受它们的用户的特权数据/操作，这可能是网络钓鱼活动的一部分。

这些是[Oauth 应用程序可以请求的范围](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps)。在接受之前应始终检查请求的范围。

此外，如基本信息中所述，**组织可以授予/拒绝第三方应用程序**对与组织相关的信息/仓库/操作的访问权限。

### 使用 Github 应用程序

有关[**Github 应用程序的基本信息介绍**](basic-github-information.md#github-applications)。

攻击者可能会创建一个**恶意的 Github 应用程序**，以访问接受它们的用户的特权数据/操作，这可能是网络钓鱼活动的一部分。

此外，如基本信息中所述，**组织可以授予/拒绝第三方应用程序**对与组织相关的信息/仓库/操作的访问权限。

## 破坏和滥用 Github Action

有几种技术可以破坏和滥用 Github Action，请在此查看：

{% content-ref url="abusing-github-actions/" %}
[abusing-github-actions](abusing-github-actions/)
{% endcontent-ref %}

## 分支保护绕过

* **需要一定数量的批准**：如果您破坏了多个账户，您可以从其他账户接受您的 PR。如果您只有创建 PR 的账户，您不能接受自己的 PR。但是，如果您可以访问仓库内的**Github Action**环境，使用**GITHUB\_TOKEN**，您可能能够**批准您的 PR**并以这种方式获得一个批准。
* _注意，对于此项和代码所有者限制，通常用户不能批准自己的 PR，但如果可以，您可以滥用它来接受您的 PR。_
* **在推送新提交时取消批准**：如果未设置此项，您可以提交合法代码，等待有人批准，然后放入恶意代码并将其合并到受保护的分支中。
* **需要代码所有者的审查**：如果启用了此项并且您是代码所有者，您可以让**Github Action 创建您的 PR 然后自己批准**。
* 当**CODEOWNER 文件配置错误**时，Github 不会抱怨，但也不会使用它。因此，如果配置错误，其**代码所有者保护不会应用**。
* **允许指定的参与者绕过拉取请求要求**：如果您是这些参与者之一，您可以绕过拉取请求保护。
* **包括管理员**：如果未设置此项并且您是仓库的管理员，您可以绕过此分支保护。
* **PR 劫持**：您可以**修改他人的 PR**，添加恶意代码，自己批准结果 PR 并合并所有内容。
* **移除分支保护**：如果您是**仓库的管理员，您可以禁用保护**，合并您的 PR 并重新设置保护。
* **绕过推送保护**：如果一个仓库**只允许某些用户**在分支中推送（合并代码）（分支保护可能通过指定通配符 `*` 保护所有分支）。
* 如果您对仓库有**写入权限但不允许推送代码**，因为分支保护，您仍然可以**创建一个新分支**，并在其中创建一个**在推送代码时触发的 github action**。由于**分支保护在分支创建之前不会保护分支**，因此首次推送代码到分支将**执行 github action**。

## 绕过环境保护

有关[**Github 环境的基本信息介绍**](basic-github-information.md#git-environments)。

如果一个环境可以**从所有分支访问**，它**未受保护**，您可以轻松访问环境中的秘密。请注意，您可能会发现一些仓库**所有分支都受到保护**（通过指定其名称或使用 `*`），在这种情况下，**找到一个可以推送代码的分支**，您可以**通过创建新的 github action（或修改一个）来提取秘密**。

请注意，您可能会发现边缘情况，即**所有分支都受到保护**（通过通配符 `*`），并指定**谁可以推送代码到分支**（_您可以在分支保护中指定_），并且**您的用户不被允许**。您仍然可以运行自定义 github action，因为您可以创建一个分支并在其上使用推送触发器。**分支保护允许推送到新分支，因此将触发 github action**。
```yaml
push: # Run it when a push is made to a branch
branches:
- current_branch_name #Use '**' to run when a push is made to any branch
```
请注意，**在创建**分支后，**分支保护将适用于新分支**，您将无法修改它，但在此之前您已经转储了秘密。

## 持久性

* 生成**用户令牌**
* 从**secrets**中窃取**github tokens**
* **删除**工作流**结果**和**分支**
* 给**所有组织更多权限**
* 创建**webhooks**以外传信息
* 邀请**外部合作者**
* **移除**被**SIEM**使用的**webhooks**
* 创建/修改带有**后门**的**Github Action**
* 通过修改**secret**值找到**易受命令注入的Github Action**

### 冒名提交 - 通过仓库提交的后门

在Github中，可以**从一个fork创建一个PR到一个仓库**。即使PR**未被接受**，一个**提交**id也会在原始仓库中为fork版本的代码创建。因此，攻击者**可以固定使用一个看似合法但不是由仓库所有者创建的特定提交**。

像[**这个**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e)：
```yaml
name: example
on: [push]
jobs:
commit:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
- shell: bash
run: |
echo 'hello world!'
```
有关更多信息，请查看 [https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)

{% hint style="success" %}
学习和练习 AWS Hacking：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和练习 GCP Hacking：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上 **关注** 我们 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交 PRs 分享 hacking 技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库。

</details>
{% endhint %}
