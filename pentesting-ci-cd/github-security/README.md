# Github Security

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## O que √© Github

(De [aqui](https://kinsta.com/knowledgebase/what-is-github/)) Em um n√≠vel alto, **GitHub √© um site e servi√ßo baseado em nuvem que ajuda os desenvolvedores a armazenar e gerenciar seu c√≥digo, bem como rastrear e controlar mudan√ßas em seu c√≥digo**.

### Informa√ß√µes B√°sicas

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## Reconhecimento Externo

Reposit√≥rios do Github podem ser configurados como p√∫blicos, privados e internos.

* **Privado** significa que **somente** pessoas da **organiza√ß√£o** poder√£o acess√°-los
* **Interno** significa que **somente** pessoas da **empresa** (uma empresa pode ter v√°rias organiza√ß√µes) poder√£o acess√°-lo
* **P√∫blico** significa que **toda a internet** poder√° acess√°-lo.

Caso voc√™ saiba o **usu√°rio, reposit√≥rio ou organiza√ß√£o que deseja atacar**, voc√™ pode usar **github dorks** para encontrar informa√ß√µes sens√≠veis ou procurar por **vazamentos de informa√ß√µes sens√≠veis** **em cada reposit√≥rio**.

### Github Dorks

Github permite **procurar algo especificando como escopo um usu√°rio, um reposit√≥rio ou uma organiza√ß√£o**. Portanto, com uma lista de strings que aparecer√£o pr√≥ximas a informa√ß√µes sens√≠veis, voc√™ pode facilmente **procurar por informa√ß√µes sens√≠veis em seu alvo**.

Ferramentas (cada ferramenta cont√©m sua lista de dorks):

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker) ([Lista de Dorks](https://github.com/obheda12/GitDorker/tree/master/Dorks))
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks) ([Lista de Dorks](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt))
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber) ([Lista de Dorks](https://github.com/hisxo/gitGraber/tree/master/wordlists))

### Github Leaks

Por favor, note que os github dorks tamb√©m s√£o destinados a procurar por vazamentos usando as op√ß√µes de busca do github. Esta se√ß√£o √© dedicada √†quelas ferramentas que ir√£o **baixar cada reposit√≥rio e procurar por informa√ß√µes sens√≠veis neles** (at√© verificando certa profundidade de commits).

Ferramentas (cada ferramenta cont√©m sua lista de regexes):

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
Quando voc√™ procura por vazamentos em um reposit√≥rio e executa algo como `git log -p`, n√£o se esque√ßa de que pode haver **outros branches com outros commits** contendo segredos!
{% endhint %}

### Forks Externos

√â poss√≠vel **comprometer reposit√≥rios abusando de pull requests**. Para saber se um reposit√≥rio √© vulner√°vel, voc√™ precisa principalmente ler as configura√ß√µes yaml do Github Actions. [**Mais informa√ß√µes sobre isso abaixo**](./#execution-from-a-external-fork).

## Endurecimento da Organiza√ß√£o

### Privil√©gios de Membros

Existem alguns **privil√©gios padr√£o** que podem ser atribu√≠dos aos **membros** da organiza√ß√£o. Estes podem ser controlados a partir da p√°gina `https://github.com/organizations/<org_name>/settings/member_privileges` ou da [**API de Organiza√ß√µes**](https://docs.github.com/en/rest/orgs/orgs).

* **Permiss√µes base**: Membros ter√£o a permiss√£o Nenhuma/Leitura/Escrita/Admin sobre os reposit√≥rios da organiza√ß√£o. O recomendado √© **Nenhuma** ou **Leitura**.
* **Fork de reposit√≥rio**: Se n√£o for necess√°rio, √© melhor **n√£o permitir** que membros fa√ßam fork dos reposit√≥rios da organiza√ß√£o.
* **Cria√ß√£o de p√°ginas**: Se n√£o for necess√°rio, √© melhor **n√£o permitir** que membros publiquem p√°ginas a partir dos reposit√≥rios da organiza√ß√£o. Se necess√°rio, voc√™ pode permitir a cria√ß√£o de p√°ginas p√∫blicas ou privadas.
* **Solicita√ß√µes de acesso a integra√ß√µes**: Com isso habilitado, colaboradores externos poder√£o solicitar acesso para aplicativos GitHub ou OAuth para acessar esta organiza√ß√£o e seus recursos. Geralmente √© necess√°rio, mas se n√£o for, √© melhor desativar.
* _N√£o consegui encontrar essa informa√ß√£o na resposta das APIs, compartilhe se voc√™ encontrar_
* **Mudan√ßa de visibilidade do reposit√≥rio**: Se habilitado, **membros** com permiss√µes de **admin** para o **reposit√≥rio** poder√£o **mudar sua visibilidade**. Se desativado, apenas os propriet√°rios da organiza√ß√£o podem mudar a visibilidade dos reposit√≥rios. Se voc√™ **n√£o** quer que as pessoas tornem as coisas **p√∫blicas**, certifique-se de que isso esteja **desativado**.
* _N√£o consegui encontrar essa informa√ß√£o na resposta das APIs, compartilhe se voc√™ encontrar_
* **Exclus√£o e transfer√™ncia de reposit√≥rios**: Se habilitado, membros com permiss√µes de **admin** para o reposit√≥rio poder√£o **excluir** ou **transferir** reposit√≥rios p√∫blicos e privados.
* _N√£o consegui encontrar essa informa√ß√£o na resposta das APIs, compartilhe se voc√™ encontrar_
* **Permitir que membros criem equipes**: Se habilitado, qualquer **membro** da organiza√ß√£o poder√° **criar** novas **equipes**. Se desativado, apenas os propriet√°rios da organiza√ß√£o podem criar novas equipes. √â melhor ter isso desativado.
* _N√£o consegui encontrar essa informa√ß√£o na resposta das APIs, compartilhe se voc√™ encontrar_
* **Mais coisas podem ser configuradas** nesta p√°gina, mas as anteriores s√£o as mais relacionadas √† seguran√ßa.

### Configura√ß√µes de A√ß√µes

V√°rias configura√ß√µes relacionadas √† seguran√ßa podem ser configuradas para a√ß√µes a partir da p√°gina `https://github.com/organizations/<org_name>/settings/actions`.

{% hint style="info" %}
Note que todas essas configura√ß√µes tamb√©m podem ser definidas em cada reposit√≥rio independentemente
{% endhint %}

* **Pol√≠ticas de a√ß√µes do Github**: Permite indicar quais reposit√≥rios podem executar workflows e quais workflows devem ser permitidos. √â recomendado **especificar quais reposit√≥rios** devem ser permitidos e n√£o permitir que todas as a√ß√µes sejam executadas.
* [**API-1**](https://docs.github.com/en/rest/actions/permissions#get-allowed-actions-and-reusable-workflows-for-an-organization)**,** [**API-2**](https://docs.github.com/en/rest/actions/permissions#list-selected-repositories-enabled-for-github-actions-in-an-organization)
* **Workflows de pull request de forks de colaboradores externos**: √â recomendado **exigir aprova√ß√£o para todos** os colaboradores externos.
* _N√£o consegui encontrar uma API com essa informa√ß√£o, compartilhe se voc√™ encontrar_
* **Executar workflows de pull requests de forks**: √â altamente **desencorajado executar workflows de pull requests** pois os mantenedores da origem do fork ter√£o a capacidade de usar tokens com permiss√µes de leitura no reposit√≥rio de origem.
* _N√£o consegui encontrar uma API com essa informa√ß√£o, compartilhe se voc√™ encontrar_
* **Permiss√µes de workflow**: √â altamente recomendado **dar apenas permiss√µes de leitura ao reposit√≥rio**. √â desencorajado dar permiss√µes de escrita e cria√ß√£o/aprova√ß√£o de pull requests para evitar o abuso do GITHUB\_TOKEN dado aos workflows em execu√ß√£o.
* [**API**](https://docs.github.com/en/rest/actions/permissions#get-default-workflow-permissions-for-an-organization)

### Integra√ß√µes

_Deixe-me saber se voc√™ conhece o endpoint da API para acessar essa informa√ß√£o!_

* **Pol√≠tica de acesso a aplicativos de terceiros**: √â recomendado restringir o acesso a todos os aplicativos e permitir apenas os necess√°rios (ap√≥s revis√°-los).
* **Aplicativos GitHub instalados**: √â recomendado permitir apenas os necess√°rios (ap√≥s revis√°-los).

## Reconhecimento e Ataques abusando de credenciais

Para este cen√°rio, vamos supor que voc√™ obteve algum acesso a uma conta do github.

### Com Credenciais de Usu√°rio

Se voc√™ de alguma forma j√° tem credenciais para um usu√°rio dentro de uma organiza√ß√£o, voc√™ pode **simplesmente fazer login** e verificar quais **fun√ß√µes de empresa e organiza√ß√£o voc√™ tem**, se voc√™ √© um membro comum, verificar quais **permiss√µes membros comuns t√™m**, em quais **grupos** voc√™ est√°, quais **permiss√µes voc√™ tem** sobre quais **reposit√≥rios**, e **como os reposit√≥rios est√£o protegidos**.

Note que **2FA pode ser usado**, ent√£o voc√™ s√≥ poder√° acessar essas informa√ß√µes se tamb√©m puder **passar por essa verifica√ß√£o**.

{% hint style="info" %}
Note que se voc√™ **conseguir roubar o cookie `user_session`** (atualmente configurado com SameSite: Lax), voc√™ pode **impersonar completamente o usu√°rio** sem precisar de credenciais ou 2FA.
{% endhint %}

Verifique a se√ß√£o abaixo sobre [**bypasses de prote√ß√µes de branch**](./#branch-protection-bypass) caso seja √∫til.

### Com Chave SSH de Usu√°rio

Github permite que **usu√°rios** configurem **chaves SSH** que ser√£o usadas como **m√©todo de autentica√ß√£o para implantar c√≥digo** em seu nome (nenhum 2FA √© aplicado).

Com essa chave, voc√™ pode realizar **mudan√ßas em reposit√≥rios onde o usu√°rio tem alguns privil√©gios**, no entanto, voc√™ n√£o pode us√°-la para acessar a API do github para enumerar o ambiente. No entanto, voc√™ pode **enumerar configura√ß√µes locais** para obter informa√ß√µes sobre os reposit√≥rios e o usu√°rio aos quais voc√™ tem acesso:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Se o usu√°rio configurou seu nome de usu√°rio como seu nome de usu√°rio do github, voc√™ pode acessar as **chaves p√∫blicas que ele configurou** em sua conta em _https://github.com/\<github\_username>.keys_, voc√™ pode verificar isso para confirmar se a chave privada que voc√™ encontrou pode ser usada.

**Chaves SSH** tamb√©m podem ser configuradas em reposit√≥rios como **chaves de deploy**. Qualquer pessoa com acesso a essa chave poder√° **lan√ßar projetos de um reposit√≥rio**. Normalmente, em um servidor com diferentes chaves de deploy, o arquivo local **`~/.ssh/config`** fornecer√° informa√ß√µes sobre a chave relacionada.

#### Chaves GPG

Como explicado [**aqui**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/github-security/broken-reference/README.md), √†s vezes √© necess√°rio assinar os commits ou voc√™ pode ser descoberto.

Verifique localmente se o usu√°rio atual possui alguma chave com:
```shell
gpg --list-secret-keys --keyid-format=long
```
### Com Token de Usu√°rio

Para uma introdu√ß√£o sobre [**Tokens de Usu√°rio, verifique as informa√ß√µes b√°sicas**](basic-github-information.md#personal-access-tokens).

Um token de usu√°rio pode ser usado **em vez de uma senha** para Git sobre HTTPS, ou pode ser usado para [**autenticar na API sobre Autentica√ß√£o B√°sica**](https://docs.github.com/v3/auth/#basic-authentication). Dependendo dos privil√©gios anexados a ele, voc√™ pode ser capaz de realizar diferentes a√ß√µes.

Um token de usu√°rio se parece com isto: `ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### Com Aplica√ß√£o Oauth

Para uma introdu√ß√£o sobre [**Aplica√ß√µes Oauth do Github, verifique as informa√ß√µes b√°sicas**](basic-github-information.md#oauth-applications).

Um atacante pode criar uma **Aplica√ß√£o Oauth maliciosa** para acessar dados/a√ß√µes privilegiadas dos usu√°rios que as aceitam, provavelmente como parte de uma campanha de phishing.

Estes s√£o os [escopos que uma aplica√ß√£o Oauth pode solicitar](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps). Deve-se sempre verificar os escopos solicitados antes de aceit√°-los.

Al√©m disso, conforme explicado nas informa√ß√µes b√°sicas, **organiza√ß√µes podem conceder/recusar acesso a aplica√ß√µes de terceiros** a informa√ß√µes/repos/a√ß√µes relacionadas com a organiza√ß√£o.

### Com Aplica√ß√£o Github

Para uma introdu√ß√£o sobre [**Aplica√ß√µes do Github, verifique as informa√ß√µes b√°sicas**](basic-github-information.md#github-applications).

Um atacante pode criar uma **Aplica√ß√£o Github maliciosa** para acessar dados/a√ß√µes privilegiadas dos usu√°rios que as aceitam, provavelmente como parte de uma campanha de phishing.

Al√©m disso, conforme explicado nas informa√ß√µes b√°sicas, **organiza√ß√µes podem conceder/recusar acesso a aplica√ß√µes de terceiros** a informa√ß√µes/repos/a√ß√µes relacionadas com a organiza√ß√£o.

## Compromisso & Abuso de Github Action

Existem v√°rias t√©cnicas para comprometer e abusar de uma Github Action, verifique-as aqui:

{% content-ref url="abusing-github-actions/" %}
[abusing-github-actions](abusing-github-actions/)
{% endcontent-ref %}

## Bypass de Prote√ß√£o de Branch

* **Exigir um n√∫mero de aprova√ß√µes**: Se voc√™ comprometeu v√°rias contas, pode simplesmente aceitar seus PRs de outras contas. Se voc√™ tem apenas a conta de onde criou o PR, n√£o pode aceitar seu pr√≥prio PR. No entanto, se voc√™ tiver acesso a um ambiente de **Github Action** dentro do reposit√≥rio, usando o **GITHUB\_TOKEN**, voc√™ pode **aprovar seu PR** e obter 1 aprova√ß√£o dessa forma.
* _Nota para isso e para a restri√ß√£o de Code Owners que geralmente um usu√°rio n√£o poder√° aprovar seus pr√≥prios PRs, mas se voc√™ puder, pode abusar disso para aceitar seus PRs._
* **Descartar aprova√ß√µes quando novos commits s√£o enviados**: Se isso n√£o estiver configurado, voc√™ pode enviar c√≥digo leg√≠timo, esperar at√© que algu√©m o aprove, e colocar c√≥digo malicioso e mescl√°-lo no branch protegido.
* **Exigir revis√µes de Code Owners**: Se isso estiver ativado e voc√™ for um Code Owner, pode fazer uma **Github Action criar seu PR e depois aprov√°-lo voc√™ mesmo**.
* Quando um **arquivo CODEOWNER est√° mal configurado**, o Github n√£o reclama, mas tamb√©m n√£o o usa. Portanto, se estiver mal configurado, a **prote√ß√£o de Code Owners n√£o √© aplicada.**
* **Permitir que atores especificados ignorem os requisitos de pull request**: Se voc√™ for um desses atores, pode ignorar as prote√ß√µes de pull request.
* **Incluir administradores**: Se isso n√£o estiver configurado e voc√™ for administrador do reposit√≥rio, pode ignorar essas prote√ß√µes de branch.
* **Sequestro de PR**: Voc√™ pode **modificar o PR de outra pessoa** adicionando c√≥digo malicioso, aprovando o PR resultante voc√™ mesmo e mesclando tudo.
* **Remo√ß√£o de Prote√ß√µes de Branch**: Se voc√™ for um **administrador do reposit√≥rio, pode desativar as prote√ß√µes**, mesclar seu PR e reativar as prote√ß√µes.
* **Ignorando prote√ß√µes de push**: Se um reposit√≥rio **permite apenas certos usu√°rios** enviar push (mesclar c√≥digo) em branches (a prote√ß√£o de branch pode estar protegendo todos os branches especificando o curinga `*`).
* Se voc√™ tem **acesso de escrita ao reposit√≥rio, mas n√£o tem permiss√£o para enviar c√≥digo** por causa da prote√ß√£o de branch, ainda pode **criar um novo branch** e dentro dele criar uma **github action que √© acionada quando o c√≥digo √© enviado**. Como a **prote√ß√£o de branch n√£o proteger√° o branch at√© que ele seja criado**, esse primeiro envio de c√≥digo para o branch **executar√° a github action**.

## Bypass de Prote√ß√µes de Ambientes

Para uma introdu√ß√£o sobre [**Ambientes do Github, verifique as informa√ß√µes b√°sicas**](basic-github-information.md#git-environments).

Caso um ambiente possa ser **acessado de todos os branches**, ele **n√£o est√° protegido** e voc√™ pode acessar facilmente os segredos dentro do ambiente. Note que voc√™ pode encontrar reposit√≥rios onde **todos os branches est√£o protegidos** (especificando seus nomes ou usando `*`), nesse cen√°rio, **encontre um branch onde voc√™ pode enviar c√≥digo** e voc√™ pode **exfiltrar** os segredos criando uma nova github action (ou modificando uma).

Note que voc√™ pode encontrar o caso extremo onde **todos os branches est√£o protegidos** (via curinga `*`), est√° especificado **quem pode enviar c√≥digo para os branches** (_voc√™ pode especificar isso na prote√ß√£o de branch_) e **seu usu√°rio n√£o tem permiss√£o**. Voc√™ ainda pode executar uma github action personalizada porque pode criar um branch e usar o gatilho de push sobre ele mesmo. A **prote√ß√£o de branch permite o push para um novo branch, ent√£o a github action ser√° acionada**.
```yaml
push: # Run it when a push is made to a branch
branches:
- current_branch_name #Use '**' to run when a push is made to any branch
```
Note que **ap√≥s a cria√ß√£o** do branch, a **prote√ß√£o do branch ser√° aplicada ao novo branch** e voc√™ n√£o poder√° modific√°-lo, mas nesse momento voc√™ j√° ter√° extra√≠do os segredos.

## Persist√™ncia

* Gerar **user token**
* Roubar **github tokens** de **secrets**
* **Dele√ß√£o** de **resultados** de workflow e **branches**
* Dar **mais permiss√µes para toda a organiza√ß√£o**
* Criar **webhooks** para exfiltrar informa√ß√µes
* Convidar **colaboradores externos**
* **Remover** **webhooks** usados pelo **SIEM**
* Criar/modificar **Github Action** com um **backdoor**
* Encontrar **Github Action vulner√°vel a inje√ß√£o de comandos** via modifica√ß√£o de valor de **secret**

### Commits de Impostor - Backdoor via commits no reposit√≥rio

No Github √© poss√≠vel **criar um PR para um reposit√≥rio a partir de um fork**. Mesmo que o PR **n√£o seja aceito**, um id de **commit** dentro do reposit√≥rio original ser√° criado para a vers√£o do c√≥digo do fork. Portanto, um atacante **poderia fixar o uso de um commit espec√≠fico de um reposit√≥rio aparentemente leg√≠timo que n√£o foi criado pelo propriet√°rio do reposit√≥rio**.

Como [**este**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e):
```yaml
name: example
on: [push]
jobs:
commit:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
- shell: bash
run: |
echo 'hello world!'
```
Para mais informa√ß√µes, confira [https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
