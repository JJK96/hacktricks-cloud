# Github Security

{% hint style="success" %}
Naucz się i ćwicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz się i ćwicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawdź [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel się trikami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów na githubie.

</details>
{% endhint %}

## Co to jest Github

(Z [tąd](https://kinsta.com/knowledgebase/what-is-github/)) Na wysokim poziomie, **GitHub to strona internetowa i usługa w chmurze, która pomaga deweloperom przechowywać i zarządzać swoim kodem, a także śledzić i kontrolować zmiany w swoim kodzie**.

### Podstawowe Informacje

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## Zewnętrzny Rekonesans

Repozytoria Github mogą być skonfigurowane jako publiczne, prywatne i wewnętrzne.

* **Prywatne** oznacza, że **tylko** osoby z **organizacji** będą miały do nich dostęp
* **Wewnętrzne** oznacza, że **tylko** osoby z **przedsiębiorstwa** (przedsiębiorstwo może mieć kilka organizacji) będą miały do niego dostęp
* **Publiczne** oznacza, że **cały internet** będzie miał do niego dostęp.

W przypadku, gdy znasz **użytkownika, repozytorium lub organizację, którą chcesz zaatakować**, możesz użyć **github dorks** do znalezienia wrażliwych informacji lub wyszukiwania **wycieków wrażliwych informacji** **w każdym repozytorium**.

### Github Dorks

Github pozwala na **wyszukiwanie czegoś, określając jako zakres użytkownika, repozytorium lub organizację**. Dlatego, mając listę ciągów, które pojawią się blisko wrażliwych informacji, możesz łatwo **wyszukać potencjalne wrażliwe informacje w swoim celu**.

Narzędzia (każde narzędzie zawiera swoją listę dorks):

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker) ([Lista Dorks](https://github.com/obheda12/GitDorker/tree/master/Dorks))
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks) ([Lista Dorks](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt))
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber) ([Lista Dorks](https://github.com/hisxo/gitGraber/tree/master/wordlists))

### Github Leaks

Proszę, zauważ, że github dorks są również przeznaczone do wyszukiwania wycieków za pomocą opcji wyszukiwania github. Ta sekcja jest poświęcona narzędziom, które będą **pobierać każde repozytorium i wyszukiwać w nim wrażliwe informacje** (nawet sprawdzając pewną głębokość commitów).

Narzędzia (każde narzędzie zawiera swoją listę regexów):

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
Kiedy szukasz wycieków w repozytorium i uruchamiasz coś w stylu `git log -p`, nie zapomnij, że mogą istnieć **inne gałęzie z innymi commitami** zawierającymi sekrety!
{% endhint %}

### Zewnętrzne Forki

Możliwe jest **kompromitowanie repozytoriów, nadużywając pull requestów**. Aby dowiedzieć się, czy repozytorium jest podatne, głównie musisz przeczytać konfiguracje yaml Github Actions. [**Więcej informacji na ten temat poniżej**](./#execution-from-a-external-fork).

## Utwardzanie Organizacji

### Uprawnienia Członków

Istnieją pewne **domyślne uprawnienia**, które mogą być przypisane do **członków** organizacji. Można nimi zarządzać ze strony `https://github.com/organizations/<org_name>/settings/member_privileges` lub z [**Organizations API**](https://docs.github.com/en/rest/orgs/orgs).

* **Podstawowe uprawnienia**: Członkowie będą mieli uprawnienia None/Read/write/Admin nad repozytoriami organizacji. Zalecane jest **None** lub **Read**.
* **Forkowanie repozytoriów**: Jeśli nie jest to konieczne, lepiej **nie pozwalać** członkom na forkowanie repozytoriów organizacji.
* **Tworzenie stron**: Jeśli nie jest to konieczne, lepiej **nie pozwalać** członkom na publikowanie stron z repozytoriów organizacji. Jeśli jest to konieczne, można pozwolić na tworzenie stron publicznych lub prywatnych.
* **Żądania dostępu do integracji**: Z włączoną tą opcją zewnętrzni współpracownicy będą mogli żądać dostępu dla aplikacji GitHub lub OAuth do tej organizacji i jej zasobów. Zwykle jest to potrzebne, ale jeśli nie, lepiej to wyłączyć.
* _Nie znalazłem tych informacji w odpowiedzi API, podziel się, jeśli znajdziesz_
* **Zmiana widoczności repozytorium**: Jeśli włączone, **członkowie** z **uprawnieniami administratora** dla **repozytorium** będą mogli **zmieniać jego widoczność**. Jeśli wyłączone, tylko właściciele organizacji mogą zmieniać widoczność repozytoriów. Jeśli **nie** chcesz, aby ludzie robili rzeczy **publiczne**, upewnij się, że to jest **wyłączone**.
* _Nie znalazłem tych informacji w odpowiedzi API, podziel się, jeśli znajdziesz_
* **Usuwanie i przenoszenie repozytoriów**: Jeśli włączone, członkowie z **uprawnieniami administratora** dla repozytorium będą mogli **usuwać** lub **przenosić** publiczne i prywatne **repozytoria.**
* _Nie znalazłem tych informacji w odpowiedzi API, podziel się, jeśli znajdziesz_
* **Pozwól członkom tworzyć zespoły**: Jeśli włączone, każdy **członek** organizacji będzie mógł **tworzyć** nowe **zespoły**. Jeśli wyłączone, tylko właściciele organizacji mogą tworzyć nowe zespoły. Lepiej mieć to wyłączone.
* _Nie znalazłem tych informacji w odpowiedzi API, podziel się, jeśli znajdziesz_
* **Więcej rzeczy można skonfigurować** na tej stronie, ale poprzednie są najbardziej związane z bezpieczeństwem.

### Ustawienia Akcji

Kilka ustawień związanych z bezpieczeństwem można skonfigurować dla akcji ze strony `https://github.com/organizations/<org_name>/settings/actions`.

{% hint style="info" %}
Zauważ, że wszystkie te konfiguracje można również ustawić na każdym repozytorium niezależnie
{% endhint %}

* **Polityki akcji Github**: Pozwala wskazać, które repozytoria mogą uruchamiać workflowy i które workflowy powinny być dozwolone. Zaleca się **określenie, które repozytoria** powinny być dozwolone i nie pozwalać na uruchamianie wszystkich akcji.
* [**API-1**](https://docs.github.com/en/rest/actions/permissions#get-allowed-actions-and-reusable-workflows-for-an-organization)**,** [**API-2**](https://docs.github.com/en/rest/actions/permissions#list-selected-repositories-enabled-for-github-actions-in-an-organization)
* **Workflowy pull requestów z forków zewnętrznych współpracowników**: Zaleca się **wymaganie zatwierdzenia dla wszystkich** zewnętrznych współpracowników.
* _Nie znalazłem API z tymi informacjami, podziel się, jeśli znajdziesz_
* **Uruchamianie workflowów z pull requestów forków**: Zdecydowanie **odradza się uruchamianie workflowów z pull requestów**, ponieważ twórcy forka będą mieli możliwość używania tokenów z uprawnieniami do odczytu w repozytorium źródłowym.
* _Nie znalazłem API z tymi informacjami, podziel się, jeśli znajdziesz_
* **Uprawnienia workflowów**: Zdecydowanie zaleca się **dawanie tylko uprawnień do odczytu repozytorium**. Odradza się dawanie uprawnień do zapisu i tworzenia/zatwierdzania pull requestów, aby uniknąć nadużywania GITHUB\_TOKEN przyznawanego uruchamianym workflowom.
* [**API**](https://docs.github.com/en/rest/actions/permissions#get-default-workflow-permissions-for-an-organization)

### Integracje

_Daj znać, jeśli znasz punkt końcowy API, aby uzyskać te informacje!_

* **Polityka dostępu aplikacji zewnętrznych**: Zaleca się ograniczenie dostępu do każdej aplikacji i pozwolenie tylko na te potrzebne (po ich przeglądzie).
* **Zainstalowane aplikacje GitHub**: Zaleca się pozwolenie tylko na te potrzebne (po ich przeglądzie).

## Rekonesans i Ataki wykorzystujące poświadczenia

W tym scenariuszu zakładamy, że uzyskałeś dostęp do konta github.

### Z Poświadczeniami Użytkownika

Jeśli w jakiś sposób masz już poświadczenia użytkownika w organizacji, możesz **po prostu się zalogować** i sprawdzić, jakie **role w przedsiębiorstwie i organizacji masz**, jeśli jesteś zwykłym członkiem, sprawdź, jakie **uprawnienia mają zwykli członkowie**, w jakich **grupach** jesteś, jakie **uprawnienia masz** nad jakimi **repozytoriami** i **jak są chronione repozytoria.**

Zauważ, że **może być używane 2FA**, więc będziesz mógł uzyskać dostęp do tych informacji tylko wtedy, gdy również **przejdziesz tę kontrolę**.

{% hint style="info" %}
Zauważ, że jeśli **uda ci się ukraść ciasteczko `user_session`** (obecnie skonfigurowane z SameSite: Lax), możesz **całkowicie podszyć się pod użytkownika** bez potrzeby poświadczeń lub 2FA.
{% endhint %}

Sprawdź sekcję poniżej o [**obejściach ochrony gałęzi**](./#branch-protection-bypass), jeśli jest to przydatne.

### Z Kluczem SSH Użytkownika

Github pozwala **użytkownikom** ustawiać **klucze SSH**, które będą używane jako **metoda uwierzytelniania do wdrażania kodu** w ich imieniu (nie stosuje się 2FA).

Z tym kluczem możesz dokonywać **zmian w repozytoriach, w których użytkownik ma pewne uprawnienia**, jednak nie możesz go używać do dostępu do API githuba w celu enumeracji środowiska. Możesz jednak **enumerować lokalne ustawienia**, aby uzyskać informacje o repozytoriach i użytkowniku, do których masz dostęp:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Jeśli użytkownik skonfigurował swoją nazwę użytkownika jako swoją nazwę użytkownika github, możesz uzyskać dostęp do **kluczy publicznych, które ustawił** na swoim koncie pod adresem _https://github.com/\<github\_username>.keys_, możesz to sprawdzić, aby potwierdzić, że znaleziony klucz prywatny może być używany.

**Klucze SSH** mogą być również ustawione w repozytoriach jako **klucze wdrożeniowe**. Każdy, kto ma dostęp do tego klucza, będzie mógł **uruchamiać projekty z repozytorium**. Zwykle na serwerze z różnymi kluczami wdrożeniowymi lokalny plik **`~/.ssh/config`** dostarczy informacji o powiązanych kluczach.

#### Klucze GPG

Jak wyjaśniono [**tutaj**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/github-security/broken-reference/README.md), czasami trzeba podpisać commity, inaczej możesz zostać wykryty.

Sprawdź lokalnie, czy bieżący użytkownik ma jakiekolwiek klucze za pomocą:
```shell
gpg --list-secret-keys --keyid-format=long
```
### Z Tokenem Użytkownika

Wprowadzenie do [**Tokenów Użytkownika znajdziesz w podstawowych informacjach**](basic-github-information.md#personal-access-tokens).

Token użytkownika może być używany **zamiast hasła** do Git przez HTTPS lub do [**uwierzytelniania do API przez Basic Authentication**](https://docs.github.com/v3/auth/#basic-authentication). W zależności od przypisanych uprawnień, możesz wykonywać różne działania.

Token użytkownika wygląda tak: `ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### Z Aplikacją Oauth

Wprowadzenie do [**Aplikacji Oauth na Github znajdziesz w podstawowych informacjach**](basic-github-information.md#oauth-applications).

Atakujący może stworzyć **złośliwą aplikację Oauth**, aby uzyskać dostęp do uprzywilejowanych danych/działań użytkowników, którzy je zaakceptują, prawdopodobnie w ramach kampanii phishingowej.

Oto [zakresy, które może żądać aplikacja Oauth](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps). Zawsze należy sprawdzić żądane zakresy przed ich zaakceptowaniem.

Ponadto, jak wyjaśniono w podstawowych informacjach, **organizacje mogą przyznawać/odmawiać dostępu aplikacjom trzecim** do informacji/repozytoriów/działań związanych z organizacją.

### Z Aplikacją Github

Wprowadzenie do [**Aplikacji Github znajdziesz w podstawowych informacjach**](basic-github-information.md#github-applications).

Atakujący może stworzyć **złośliwą aplikację Github**, aby uzyskać dostęp do uprzywilejowanych danych/działań użytkowników, którzy je zaakceptują, prawdopodobnie w ramach kampanii phishingowej.

Ponadto, jak wyjaśniono w podstawowych informacjach, **organizacje mogą przyznawać/odmawiać dostępu aplikacjom trzecim** do informacji/repozytoriów/działań związanych z organizacją.

## Kompromitacja i Nadużycie Github Action

Istnieje kilka technik kompromitacji i nadużycia Github Action, sprawdź je tutaj:

{% content-ref url="abusing-github-actions/" %}
[abusing-github-actions](abusing-github-actions/)
{% endcontent-ref %}

## Omijanie Ochrony Gałęzi

* **Wymagaj liczby zatwierdzeń**: Jeśli skompromitowałeś kilka kont, możesz zaakceptować swoje PR-y z innych kont. Jeśli masz tylko konto, z którego utworzyłeś PR, nie możesz zaakceptować własnego PR. Jednakże, jeśli masz dostęp do środowiska **Github Action** w repozytorium, używając **GITHUB\_TOKEN** możesz **zatwierdzić swój PR** i uzyskać w ten sposób 1 zatwierdzenie.
* _Uwaga: dla tego i dla ograniczenia Code Owners, zazwyczaj użytkownik nie będzie mógł zatwierdzić swoich własnych PR-ów, ale jeśli może, może to wykorzystać do zaakceptowania swoich PR-ów._
* **Odrzucaj zatwierdzenia, gdy nowe commity są wprowadzane**: Jeśli to nie jest ustawione, możesz przesłać legalny kod, poczekać, aż ktoś go zatwierdzi, a następnie wprowadzić złośliwy kod i scalić go z chronioną gałęzią.
* **Wymagaj przeglądów od Code Owners**: Jeśli to jest aktywowane i jesteś Code Owner, możesz sprawić, że **Github Action utworzy twój PR, a następnie sam go zatwierdzisz**.
* Gdy plik **CODEOWNER jest źle skonfigurowany**, Github nie zgłasza błędu, ale go nie używa. Dlatego, jeśli jest źle skonfigurowany, **ochrona Code Owners nie jest stosowana.**
* **Zezwalaj określonym aktorom na omijanie wymagań pull request**: Jeśli jesteś jednym z tych aktorów, możesz ominąć ochronę pull request.
* **Uwzględnij administratorów**: Jeśli to nie jest ustawione, a jesteś administratorem repozytorium, możesz ominąć te ochrony gałęzi.
* **PR Hijacking**: Możesz **zmodyfikować PR kogoś innego**, dodając złośliwy kod, zatwierdzając wynikowy PR samodzielnie i scalając wszystko.
* **Usuwanie ochrony gałęzi**: Jeśli jesteś **administratorem repozytorium, możesz wyłączyć ochrony**, scalić swój PR i ponownie ustawić ochrony.
* **Omijanie ochrony push**: Jeśli repozytorium **zezwala tylko określonym użytkownikom** na wysyłanie push (scalanie kodu) w gałęziach (ochrona gałęzi może chronić wszystkie gałęzie, określając symbol wieloznaczny `*`).
* Jeśli masz **dostęp do zapisu w repozytorium, ale nie możesz wysyłać kodu** z powodu ochrony gałęzi, nadal możesz **utworzyć nową gałąź** i w niej utworzyć **github action, które jest uruchamiane, gdy kod jest wysyłany**. Ponieważ **ochrona gałęzi nie chroni gałęzi, dopóki nie zostanie utworzona**, to pierwsze wysłanie kodu do gałęzi **uruchomi github action**.

## Omijanie Ochrony Środowisk

Wprowadzenie do [**Github Environment znajdziesz w podstawowych informacjach**](basic-github-information.md#git-environments).

Jeśli środowisko może być **dostępne ze wszystkich gałęzi**, jest **niechronione** i możesz łatwo uzyskać dostęp do sekretów w środowisku. Zauważ, że możesz znaleźć repozytoria, gdzie **wszystkie gałęzie są chronione** (przez określenie ich nazw lub użycie `*`), w takim przypadku **znajdź gałąź, do której możesz wysłać kod** i możesz **wyeksfiltrować** sekrety, tworząc nowe github action (lub modyfikując istniejące).

Zauważ, że możesz znaleźć przypadek brzegowy, gdzie **wszystkie gałęzie są chronione** (przez symbol wieloznaczny `*`), jest określone **kto może wysyłać kod do gałęzi** (_możesz to określić w ochronie gałęzi_) i **twój użytkownik nie jest dozwolony**. Nadal możesz uruchomić niestandardowe github action, ponieważ możesz utworzyć gałąź i użyć wyzwalacza push na niej. **Ochrona gałęzi pozwala na push do nowej gałęzi, więc github action zostanie uruchomione**.
```yaml
push: # Run it when a push is made to a branch
branches:
- current_branch_name #Use '**' to run when a push is made to any branch
```
Zauważ, że **po utworzeniu** gałęzi **ochrona gałęzi będzie miała zastosowanie do nowej gałęzi** i nie będziesz mógł jej modyfikować, ale do tego czasu już zrzucisz sekrety.

## Trwałość

* Wygeneruj **token użytkownika**
* Skradnij **github tokens** z **secrets**
* **Usunięcie** wyników **workflow** i **gałęzi**
* Daj **więcej uprawnień całej organizacji**
* Utwórz **webhooks** do eksfiltracji informacji
* Zaproś **zewnętrznych współpracowników**
* **Usuń** **webhooks** używane przez **SIEM**
* Utwórz/zmodyfikuj **Github Action** z **backdoorem**
* Znajdź **podatne Github Action na wstrzyknięcie komend** poprzez modyfikację wartości **secret**

### Fałszywe Commity - Backdoor przez commity repozytorium

W Github możliwe jest **utworzenie PR do repozytorium z forka**. Nawet jeśli PR **nie zostanie zaakceptowany**, zostanie utworzony **commit** id wewnątrz oryginalnego repozytorium dla wersji kodu z forka. W związku z tym, atakujący **może przypiąć do użycia konkretny commit z pozornie legalnego repozytorium, który nie został utworzony przez właściciela repozytorium**.

Jak [**tutaj**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e):
```yaml
name: example
on: [push]
jobs:
commit:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
- shell: bash
run: |
echo 'hello world!'
```
Więcej informacji znajdziesz na [https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)

{% hint style="success" %}
Ucz się i ćwicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz się i ćwicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawdź [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) albo **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel się trikami hakerskimi, przesyłając PR-y do repozytoriów** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}
