# Gitea Security

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Qu칠 es Gitea

**Gitea** es una **soluci칩n ligera de alojamiento de c칩digo autogestionada y gestionada por la comunidad** escrita en Go.

![](<../../.gitbook/assets/image (160).png>)

### Informaci칩n B치sica

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## Laboratorio

Para ejecutar una instancia de Gitea localmente, puedes simplemente ejecutar un contenedor docker:
```bash
docker run -p 3000:3000 gitea/gitea
```
Con칠ctese al puerto 3000 para acceder a la p치gina web.

Tambi칠n podr칤a ejecutarlo con kubernetes:
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## Enumeraci칩n No Autenticada

* Repos p칰blicos: [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* Usuarios registrados: [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* Organizaciones registradas: [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

Tenga en cuenta que por **defecto Gitea permite que nuevos usuarios se registren**. Esto no dar치 acceso especialmente interesante a los nuevos usuarios sobre los repos de otras organizaciones/usuarios, pero un **usuario registrado** podr칤a ser capaz de **visualizar m치s repos o organizaciones**.

## Explotaci칩n Interna

Para este escenario vamos a suponer que has obtenido alg칰n acceso a una cuenta de github.

### Con Credenciales de Usuario/Cookie Web

Si de alguna manera ya tienes credenciales para un usuario dentro de una organizaci칩n (o robaste una cookie de sesi칩n) puedes **simplemente iniciar sesi칩n** y verificar qu칠 **permisos tienes** sobre qu칠 **repos,** en **qu칠 equipos** est치s, **listar otros usuarios**, y **c칩mo est치n protegidos los repos.**

Tenga en cuenta que **se puede usar 2FA** por lo que solo podr치s acceder a esta informaci칩n si tambi칠n puedes **pasar esa verificaci칩n**.

{% hint style="info" %}
Tenga en cuenta que si **logras robar la cookie `i_like_gitea`** (actualmente configurada con SameSite: Lax) puedes **suplantar completamente al usuario** sin necesidad de credenciales o 2FA.
{% endhint %}

### Con Clave SSH de Usuario

Gitea permite a los **usuarios** establecer **claves SSH** que se utilizar치n como **m칠todo de autenticaci칩n para desplegar c칩digo** en su nombre (no se aplica 2FA).

Con esta clave puedes realizar **cambios en los repositorios donde el usuario tiene algunos privilegios**, sin embargo, no puedes usarla para acceder a la api de gitea para enumerar el entorno. Sin embargo, puedes **enumerar configuraciones locales** para obtener informaci칩n sobre los repos y el usuario al que tienes acceso:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Si el usuario ha configurado su nombre de usuario como su nombre de usuario de gitea, puedes acceder a las **claves p칰blicas que ha establecido** en su cuenta en _https://github.com/\<gitea\_username>.keys_, podr칤as verificar esto para confirmar que la clave privada que encontraste puede ser utilizada.

Las **claves SSH** tambi칠n pueden ser establecidas en repositorios como **deploy keys**. Cualquiera con acceso a esta clave podr치 **lanzar proyectos desde un repositorio**. Usualmente en un servidor con diferentes deploy keys, el archivo local **`~/.ssh/config`** te dar치 informaci칩n sobre la clave relacionada.

#### GPG Keys

Como se explica [**aqu칤**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/gitea-security/broken-reference/README.md) a veces es necesario firmar los commits o podr칤as ser descubierto.

Verifica localmente si el usuario actual tiene alguna clave con:
```shell
gpg --list-secret-keys --keyid-format=long
```
### Con Token de Usuario

Para una introducci칩n sobre [**Tokens de Usuario revisa la informaci칩n b치sica**](basic-gitea-information.md#personal-access-tokens).

Un token de usuario puede ser usado **en lugar de una contrase침a** para **autenticarse** contra el servidor de Gitea [**v칤a API**](https://try.gitea.io/api/swagger#/). Tendr치 **acceso completo** sobre el usuario.

### Con Aplicaci칩n Oauth

Para una introducci칩n sobre [**Aplicaciones Oauth de Gitea revisa la informaci칩n b치sica**](./#with-oauth-application).

Un atacante podr칤a crear una **Aplicaci칩n Oauth maliciosa** para acceder a datos/acciones privilegiadas de los usuarios que las acepten, probablemente como parte de una campa침a de phishing.

Como se explica en la informaci칩n b치sica, la aplicaci칩n tendr치 **acceso completo sobre la cuenta del usuario**.

### Bypass de Protecci칩n de Ramas

En Github tenemos **github actions** que por defecto obtienen un **token con acceso de escritura** sobre el repositorio que puede ser usado para **eludir las protecciones de ramas**. En este caso eso **no existe**, por lo que los bypasses son m치s limitados. Pero veamos qu칠 se puede hacer:

* **Habilitar Push**: Si alguien con acceso de escritura puede hacer push a la rama, simplemente haz push a ella.
* **Lista Blanca de Push Restringido**: De la misma manera, si eres parte de esta lista, haz push a la rama.
* **Habilitar Lista Blanca de Merge**: Si hay una lista blanca de merge, necesitas estar dentro de ella.
* **Requerir aprobaciones mayor que 0**: Entonces... necesitas comprometer a otro usuario.
* **Restringir aprobaciones a la lista blanca**: Si solo los usuarios de la lista blanca pueden aprobar... necesitas comprometer a otro usuario que est칠 dentro de esa lista.
* **Descartar aprobaciones obsoletas**: Si las aprobaciones no se eliminan con nuevos commits, podr칤as secuestrar un PR ya aprobado para inyectar tu c칩digo y fusionar el PR.

Ten en cuenta que **si eres un administrador de la organizaci칩n/repositorio** puedes eludir las protecciones.

### Enumerar Webhooks

**Webhooks** pueden **enviar informaci칩n espec칤fica de gitea a algunos lugares**. Podr칤as ser capaz de **explotar esa comunicaci칩n**.\
Sin embargo, usualmente se establece un **secreto** que no puedes **recuperar** en el **webhook** que **impedir치** que usuarios externos que conozcan la URL del webhook pero no el secreto **exploten ese webhook**.\
Pero en algunas ocasiones, en lugar de establecer el **secreto** en su lugar, lo **establecen en la URL** como un par치metro, por lo que **revisar las URLs** podr칤a permitirte **encontrar secretos** y otros lugares que podr칤as explotar m치s.

Los webhooks pueden ser establecidos a nivel de **repositorio y de organizaci칩n**.

## Post Explotaci칩n

### Dentro del servidor

Si de alguna manera lograste entrar en el servidor donde se est치 ejecutando gitea, deber칤as buscar el archivo de configuraci칩n de gitea. Por defecto, est치 ubicado en `/data/gitea/conf/app.ini`

En este archivo puedes encontrar **claves** y **contrase침as**.

En la ruta de gitea (por defecto: /data/gitea) tambi칠n puedes encontrar informaci칩n interesante como:

* La **DB sqlite**: Si gitea no est치 usando una db externa, usar치 una db sqlite.
* Las **sesiones** dentro de la carpeta de sesiones: Ejecutando `cat sessions/*/*/*` puedes ver los nombres de usuario de los usuarios conectados (gitea tambi칠n podr칤a guardar las sesiones dentro de la DB).
* La **clave privada jwt** dentro de la carpeta jwt.
* M치s **informaci칩n sensible** podr칤a encontrarse en esta carpeta.

Si est치s dentro del servidor, tambi칠n puedes **usar el binario `gitea`** para acceder/modificar informaci칩n:

* `gitea dump` volcar치 gitea y generar치 un archivo .zip.
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET` generar치 un token del tipo indicado (persistencia).
* `gitea admin user change-password --username admin --password newpassword` Cambiar la contrase침a.
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` Crear un nuevo usuario administrador y obtener un token de acceso.

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
