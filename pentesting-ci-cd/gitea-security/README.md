# Gitea Security

{% hint style="success" %}
学习和练习 AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和练习 GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交 PRs 分享黑客技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库。

</details>
{% endhint %}

## 什么是 Gitea

**Gitea** 是一个用 Go 编写的 **自托管社区管理的轻量级代码托管** 解决方案。

![](<../../.gitbook/assets/image (160).png>)

### 基本信息

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## 实验室

要在本地运行 Gitea 实例，你可以运行一个 docker 容器：
```bash
docker run -p 3000:3000 gitea/gitea
```
连接到端口3000以访问网页。

你也可以使用kubernetes运行它：
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## 未认证枚举

* 公共仓库: [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* 注册用户: [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* 注册组织: [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

请注意，**默认情况下 Gitea 允许新用户注册**。这不会给新用户在其他组织/用户仓库上特别有趣的访问权限，但**登录用户**可能能够**查看更多的仓库或组织**。

## 内部利用

在这种情况下，我们假设你已经获得了一些github账户的访问权限。

### 使用用户凭证/网页Cookie

如果你已经拥有某个组织内用户的凭证（或你窃取了会话cookie），你可以**直接登录**并检查你对哪些**仓库**有**哪些权限**，你在哪些**团队**中，**列出其他用户**，以及**仓库是如何保护的**。

请注意，**可能会使用2FA**，所以你只有在能够**通过该检查**的情况下才能访问这些信息。

{% hint style="info" %}
请注意，如果你**设法窃取了 `i_like_gitea` cookie**（当前配置为SameSite: Lax），你可以**完全冒充该用户**，无需凭证或2FA。
{% endhint %}

### 使用用户SSH密钥

Gitea允许**用户**设置**SSH密钥**，这些密钥将用作**代表用户部署代码的认证方法**（不适用2FA）。

使用此密钥，你可以在**用户有某些权限的仓库中进行更改**，但不能用它访问gitea api来枚举环境。然而，你可以**枚举本地设置**以获取你有访问权限的仓库和用户的信息：
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
如果用户将其用户名配置为他的 gitea 用户名，您可以访问他账户中设置的**公钥**，网址为 _https://github.com/\<gitea\_username>.keys_，您可以检查此项以确认您找到的私钥是否可以使用。

**SSH keys** 也可以在仓库中设置为**部署密钥**。任何拥有此密钥的人都可以**从仓库启动项目**。通常在具有不同部署密钥的服务器中，本地文件 **`~/.ssh/config`** 将为您提供有关密钥相关的信息。

#### GPG Keys

如[**此处**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/gitea-security/broken-reference/README.md)所述，有时需要对提交进行签名，否则您可能会被发现。

在本地检查当前用户是否有任何密钥：
```shell
gpg --list-secret-keys --keyid-format=long
```
### 使用用户令牌

关于[**用户令牌的介绍，请查看基本信息**](basic-gitea-information.md#personal-access-tokens)。

用户令牌可以**代替密码**来**认证**Gitea服务器[**通过API**](https://try.gitea.io/api/swagger#/)，它将拥有**对用户的完全访问权限**。

### 使用Oauth应用程序

关于[**Gitea Oauth应用程序的介绍，请查看基本信息**](./#with-oauth-application)。

攻击者可能会创建一个**恶意的Oauth应用程序**来访问接受它们的用户的特权数据/操作，可能是钓鱼活动的一部分。

如基本信息中所述，应用程序将拥有**对用户账户的完全访问权限**。

### 分支保护绕过

在Github中，我们有**github actions**，默认情况下会获得**具有写访问权限的令牌**，可以用来**绕过分支保护**。在这种情况下，这种功能**不存在**，所以绕过的方式更有限。但让我们看看可以做些什么：

* **启用推送**：如果任何具有写访问权限的人可以推送到分支，只需推送即可。
* **白名单限制推送**：同样，如果你在这个列表中，推送到分支。
* **启用合并白名单**：如果有合并白名单，你需要在其中。
* **需要的批准数大于0**：那么...你需要妥协另一个用户。
* **将批准限制为白名单用户**：如果只有白名单用户可以批准...你需要妥协在该列表中的另一个用户。
* **取消过时的批准**：如果批准不会因新提交而被移除，你可以劫持已批准的PR来注入你的代码并合并PR。

请注意，**如果你是组织/仓库管理员**，你可以绕过这些保护。

### 枚举Webhooks

**Webhooks**能够**将特定的gitea信息发送到某些地方**。你可能能够**利用这种通信**。\
然而，通常在**webhook**中设置了一个**无法检索的密钥**，这将**防止**知道webhook URL但不知道密钥的外部用户**利用该webhook**。\
但在某些情况下，人们没有将**密钥**设置在其位置，而是将其**作为参数设置在URL中**，因此**检查URL**可能会让你**找到密钥**和其他你可以进一步利用的地方。

Webhooks可以在**仓库和组织级别**设置。

## 后期利用

### 在服务器内部

如果你设法进入运行gitea的服务器，你应该搜索gitea配置文件。默认情况下，它位于`/data/gitea/conf/app.ini`

在这个文件中你可以找到**密钥**和**密码**。

在gitea路径（默认：/data/gitea）中，你还可以找到有趣的信息，例如：

* **sqlite**数据库：如果gitea没有使用外部数据库，它将使用sqlite数据库。
* 会话文件夹中的**会话**：运行`cat sessions/*/*/*`你可以看到已登录用户的用户名（gitea也可能将会话保存在数据库中）。
* jwt文件夹中的**jwt私钥**。
* 在这个文件夹中可能会找到更多**敏感信息**。

如果你在服务器内部，你还可以**使用`gitea`二进制文件**来访问/修改信息：

* `gitea dump`将转储gitea并生成一个.zip文件。
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET`将生成指定类型的令牌（持久性）。
* `gitea admin user change-password --username admin --password newpassword`更改密码。
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token`创建新管理员用户并获取访问令牌。

{% hint style="success" %}
学习和实践AWS Hacking：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和实践GCP Hacking：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持HackTricks</summary>

* 查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或 **关注**我们在**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* **通过提交PR到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库来分享黑客技巧**。

</details>
{% endhint %}
