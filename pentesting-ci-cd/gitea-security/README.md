# Gitea Security

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai repo github di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Cos'√® Gitea

**Gitea** √® una **soluzione di hosting del codice leggera, gestita dalla comunit√† e self-hosted** scritta in Go.

![](<../../.gitbook/assets/image (160).png>)

### Informazioni di Base

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## Lab

Per eseguire un'istanza Gitea localmente, puoi semplicemente eseguire un container docker:
```bash
docker run -p 3000:3000 gitea/gitea
```
Connettiti alla porta 3000 per accedere alla pagina web.

Puoi anche eseguirlo con kubernetes:
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## Enumerazione Non Autenticata

* Repos pubblici: [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* Utenti registrati: [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* Organizzazioni registrate: [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

Nota che per **default Gitea permette ai nuovi utenti di registrarsi**. Questo non dar√† accesso particolarmente interessante ai nuovi utenti sui repos di altre organizzazioni/utenti, ma un **utente loggato** potrebbe essere in grado di **visualizzare pi√π repos o organizzazioni**.

## Sfruttamento Interno

Per questo scenario supponiamo che tu abbia ottenuto qualche accesso a un account github.

### Con Credenziali Utente/Web Cookie

Se in qualche modo hai gi√† le credenziali per un utente all'interno di un'organizzazione (o hai rubato un cookie di sessione) puoi **semplicemente effettuare il login** e controllare quali **permessi hai** su quali **repos,** in **quali team** sei, **elencare altri utenti**, e **come sono protetti i repos.**

Nota che **potrebbe essere utilizzata la 2FA** quindi potrai accedere a queste informazioni solo se riesci anche a **superare quel controllo**.

{% hint style="info" %}
Nota che se **riesci a rubare il cookie `i_like_gitea`** (attualmente configurato con SameSite: Lax) puoi **completamente impersonare l'utente** senza bisogno di credenziali o 2FA.
{% endhint %}

### Con Chiave SSH Utente

Gitea permette agli **utenti** di impostare **chiavi SSH** che verranno utilizzate come **metodo di autenticazione per distribuire codice** per loro conto (non viene applicata la 2FA).

Con questa chiave puoi effettuare **modifiche nei repository dove l'utente ha alcuni privilegi**, tuttavia non puoi usarla per accedere all'api di gitea per enumerare l'ambiente. Tuttavia, puoi **enumerare le impostazioni locali** per ottenere informazioni sui repos e sugli utenti a cui hai accesso:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Se l'utente ha configurato il suo username come il suo username gitea, puoi accedere alle **chiavi pubbliche che ha impostato** nel suo account in _https://github.com/\<gitea\_username>.keys_, puoi controllare questo per confermare che la chiave privata che hai trovato pu√≤ essere utilizzata.

Le **chiavi SSH** possono anche essere impostate nei repository come **deploy keys**. Chiunque abbia accesso a questa chiave sar√† in grado di **lanciare progetti da un repository**. Di solito, in un server con diverse deploy keys, il file locale **`~/.ssh/config`** ti dar√† informazioni sulla chiave correlata.

#### GPG Keys

Come spiegato [**qui**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/gitea-security/broken-reference/README.md) a volte √® necessario firmare i commit o potresti essere scoperto.

Controlla localmente se l'utente corrente ha qualche chiave con:
```shell
gpg --list-secret-keys --keyid-format=long
```
### Con Token Utente

Per un'introduzione sui [**Token Utente controlla le informazioni di base**](basic-gitea-information.md#personal-access-tokens).

Un token utente pu√≤ essere utilizzato **invece di una password** per **autenticarsi** contro il server Gitea [**via API**](https://try.gitea.io/api/swagger#/). Avr√† **accesso completo** sull'utente.

### Con Applicazione Oauth

Per un'introduzione sulle [**Applicazioni Oauth di Gitea controlla le informazioni di base**](./#with-oauth-application).

Un attaccante potrebbe creare una **Applicazione Oauth malevola** per accedere a dati/azioni privilegiate degli utenti che le accettano, probabilmente come parte di una campagna di phishing.

Come spiegato nelle informazioni di base, l'applicazione avr√† **accesso completo sull'account utente**.

### Bypass Protezione Branch

In Github abbiamo **github actions** che di default ottengono un **token con accesso in scrittura** sul repo che pu√≤ essere utilizzato per **bypassare le protezioni del branch**. In questo caso ci√≤ **non esiste**, quindi i bypass sono pi√π limitati. Ma diamo un'occhiata a cosa si pu√≤ fare:

* **Abilitare Push**: Se chiunque con accesso in scrittura pu√≤ fare push sul branch, basta fare push su di esso.
* **Whitelist Push Ristretto**: Allo stesso modo, se fai parte di questa lista fai push sul branch.
* **Abilitare Whitelist Merge**: Se c'√® una whitelist per il merge, devi essere all'interno di essa.
* **Richiedere approvazioni maggiori di 0**: Allora... devi compromettere un altro utente.
* **Limitare approvazioni agli utenti in whitelist**: Se solo gli utenti in whitelist possono approvare... devi compromettere un altro utente che √® all'interno di quella lista.
* **Annullare approvazioni obsolete**: Se le approvazioni non vengono rimosse con nuovi commit, potresti dirottare una PR gi√† approvata per iniettare il tuo codice e unire la PR.

Nota che **se sei un admin di org/repo** puoi bypassare le protezioni.

### Enumerare Webhook

I **Webhook** sono in grado di **inviare informazioni specifiche di gitea a certi luoghi**. Potresti essere in grado di **sfruttare quella comunicazione**.\
Tuttavia, di solito un **segreto** che non puoi **recuperare** √® impostato nel **webhook** che **impedir√†** agli utenti esterni che conoscono l'URL del webhook ma non il segreto di **sfruttare quel webhook**.\
Ma in alcune occasioni, le persone invece di impostare il **segreto** nel suo posto, lo **impostano nell'URL** come parametro, quindi **controllare gli URL** potrebbe permetterti di **trovare segreti** e altri luoghi che potresti sfruttare ulteriormente.

I webhook possono essere impostati a **livello di repo e di org**.

## Post Exploitation

### All'interno del server

Se in qualche modo sei riuscito ad entrare nel server dove gitea √® in esecuzione, dovresti cercare il file di configurazione di gitea. Di default si trova in `/data/gitea/conf/app.ini`

In questo file puoi trovare **chiavi** e **password**.

Nel percorso di gitea (di default: /data/gitea) puoi trovare anche informazioni interessanti come:

* Il **DB sqlite**: Se gitea non utilizza un db esterno, utilizzer√† un db sqlite.
* Le **sessioni** all'interno della cartella delle sessioni: Eseguendo `cat sessions/*/*/*` puoi vedere i nomi utente degli utenti loggati (gitea potrebbe anche salvare le sessioni all'interno del DB).
* La **chiave privata jwt** all'interno della cartella jwt.
* Altre **informazioni sensibili** potrebbero essere trovate in questa cartella.

Se sei all'interno del server puoi anche **usare il binario `gitea`** per accedere/modificare informazioni:

* `gitea dump` eseguir√† un dump di gitea e generer√† un file .zip.
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET` generer√† un token del tipo indicato (persistenza).
* `gitea admin user change-password --username admin --password newpassword` Cambia la password.
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` Crea un nuovo utente admin e ottieni un access token.

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repo github.

</details>
{% endhint %}
