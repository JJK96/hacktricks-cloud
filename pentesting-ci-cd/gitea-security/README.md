# S√©curit√© de Gitea

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Qu'est-ce que Gitea

**Gitea** est une **solution d'h√©bergement de code l√©g√®re, autog√©r√©e et g√©r√©e par la communaut√©** √©crite en Go.

![](<../../.gitbook/assets/image (160).png>)

### Informations de base

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## Lab

Pour ex√©cuter une instance Gitea localement, vous pouvez simplement ex√©cuter un conteneur docker :
```bash
docker run -p 3000:3000 gitea/gitea
```
Connectez-vous au port 3000 pour acc√©der √† la page web.

Vous pouvez √©galement l'ex√©cuter avec kubernetes :
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## √ânum√©ration non authentifi√©e

* Repos publics : [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* Utilisateurs enregistr√©s : [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* Organisations enregistr√©es : [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

Notez que par **d√©faut, Gitea permet aux nouveaux utilisateurs de s'inscrire**. Cela ne donnera pas un acc√®s particuli√®rement int√©ressant aux nouveaux utilisateurs sur les repos d'autres organisations/utilisateurs, mais un **utilisateur connect√©** pourrait √™tre capable de **visualiser plus de repos ou d'organisations**.

## Exploitation interne

Pour ce sc√©nario, nous allons supposer que vous avez obtenu un certain acc√®s √† un compte github.

### Avec les identifiants de l'utilisateur / Cookie Web

Si vous avez d√©j√† des identifiants pour un utilisateur au sein d'une organisation (ou si vous avez vol√© un cookie de session), vous pouvez **simplement vous connecter** et v√©rifier quelles **permissions vous avez** sur quels **repos,** dans **quelles √©quipes** vous √™tes, **lister d'autres utilisateurs**, et **comment les repos sont prot√©g√©s.**

Notez que **2FA peut √™tre utilis√©** donc vous ne pourrez acc√©der √† ces informations que si vous pouvez √©galement **passer cette v√©rification**.

{% hint style="info" %}
Notez que si vous **parvenez √† voler le cookie `i_like_gitea`** (actuellement configur√© avec SameSite: Lax), vous pouvez **compl√®tement usurper l'identit√© de l'utilisateur** sans avoir besoin des identifiants ou du 2FA.
{% endhint %}

### Avec la cl√© SSH de l'utilisateur

Gitea permet aux **utilisateurs** de d√©finir des **cl√©s SSH** qui seront utilis√©es comme **m√©thode d'authentification pour d√©ployer du code** en leur nom (aucun 2FA n'est appliqu√©).

Avec cette cl√©, vous pouvez effectuer des **modifications dans les d√©p√¥ts o√π l'utilisateur a certains privil√®ges**, cependant vous ne pouvez pas l'utiliser pour acc√©der √† l'api gitea pour √©num√©rer l'environnement. Cependant, vous pouvez **√©num√©rer les param√®tres locaux** pour obtenir des informations sur les repos et l'utilisateur auxquels vous avez acc√®s :
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Si l'utilisateur a configur√© son nom d'utilisateur comme son nom d'utilisateur gitea, vous pouvez acc√©der aux **cl√©s publiques qu'il a d√©finies** dans son compte √† _https://github.com/\<gitea\_username>.keys_, vous pouvez v√©rifier cela pour confirmer que la cl√© priv√©e que vous avez trouv√©e peut √™tre utilis√©e.

Les **cl√©s SSH** peuvent √©galement √™tre d√©finies dans les d√©p√¥ts en tant que **cl√©s de d√©ploiement**. Toute personne ayant acc√®s √† cette cl√© pourra **lancer des projets √† partir d'un d√©p√¥t**. Habituellement, sur un serveur avec diff√©rentes cl√©s de d√©ploiement, le fichier local **`~/.ssh/config`** vous donnera des informations sur la cl√© concern√©e.

#### Cl√©s GPG

Comme expliqu√© [**ici**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/gitea-security/broken-reference/README.md), il est parfois n√©cessaire de signer les commits ou vous pourriez √™tre d√©couvert.

V√©rifiez localement si l'utilisateur actuel poss√®de une cl√© avec :
```shell
gpg --list-secret-keys --keyid-format=long
```
### Avec Jeton Utilisateur

Pour une introduction sur les [**Jetons Utilisateurs, consultez les informations de base**](basic-gitea-information.md#personal-access-tokens).

Un jeton utilisateur peut √™tre utilis√© **√† la place d'un mot de passe** pour **s'authentifier** contre le serveur Gitea [**via API**](https://try.gitea.io/api/swagger#/). Il aura un **acc√®s complet** sur l'utilisateur.

### Avec Application Oauth

Pour une introduction sur les [**Applications Oauth Gitea, consultez les informations de base**](./#with-oauth-application).

Un attaquant pourrait cr√©er une **application Oauth malveillante** pour acc√©der aux donn√©es/actions privil√©gi√©es des utilisateurs qui les acceptent, probablement dans le cadre d'une campagne de phishing.

Comme expliqu√© dans les informations de base, l'application aura **un acc√®s complet sur le compte utilisateur**.

### Contournement de la Protection des Branches

Dans Github, nous avons **github actions** qui par d√©faut obtiennent un **jeton avec acc√®s en √©criture** sur le d√©p√¥t qui peut √™tre utilis√© pour **contourner les protections des branches**. Dans ce cas, cela **n'existe pas**, donc les contournements sont plus limit√©s. Mais voyons ce qui peut √™tre fait :

* **Activer Push** : Si quelqu'un avec un acc√®s en √©criture peut pousser sur la branche, il suffit de pousser dessus.
* **Liste blanche de Push restreint** : De la m√™me mani√®re, si vous faites partie de cette liste, poussez sur la branche.
* **Activer la liste blanche de fusion** : S'il y a une liste blanche de fusion, vous devez en faire partie.
* **Exiger des approbations sup√©rieures √† 0** : Alors... vous devez compromettre un autre utilisateur.
* **Restreindre les approbations aux utilisateurs en liste blanche** : Si seuls les utilisateurs en liste blanche peuvent approuver... vous devez compromettre un autre utilisateur qui est dans cette liste.
* **Annuler les approbations obsol√®tes** : Si les approbations ne sont pas supprim√©es avec de nouveaux commits, vous pourriez d√©tourner une PR d√©j√† approuv√©e pour injecter votre code et fusionner la PR.

Notez que **si vous √™tes un admin d'org/repo**, vous pouvez contourner les protections.

### √ânum√©rer les Webhooks

Les **Webhooks** peuvent **envoyer des informations sp√©cifiques de gitea √† certains endroits**. Vous pourriez √™tre en mesure d'**exploiter cette communication**.\
Cependant, g√©n√©ralement un **secret** que vous ne pouvez **pas r√©cup√©rer** est d√©fini dans le **webhook** qui **emp√™chera** les utilisateurs externes qui connaissent l'URL du webhook mais pas le secret d'**exploiter ce webhook**.\
Mais dans certaines occasions, les gens au lieu de d√©finir le **secret** √† sa place, ils le **mettent dans l'URL** en tant que param√®tre, donc **v√©rifier les URLs** pourrait vous permettre de **trouver des secrets** et d'autres endroits que vous pourriez exploiter davantage.

Les webhooks peuvent √™tre d√©finis au **niveau du d√©p√¥t et de l'organisation**.

## Post Exploitation

### √Ä l'int√©rieur du serveur

Si d'une mani√®re ou d'une autre vous avez r√©ussi √† entrer dans le serveur o√π gitea fonctionne, vous devriez rechercher le fichier de configuration gitea. Par d√©faut, il est situ√© dans `/data/gitea/conf/app.ini`

Dans ce fichier, vous pouvez trouver des **cl√©s** et des **mots de passe**.

Dans le chemin gitea (par d√©faut : /data/gitea), vous pouvez √©galement trouver des informations int√©ressantes comme :

* La **DB sqlite** : Si gitea n'utilise pas une db externe, il utilisera une db sqlite.
* Les **sessions** √† l'int√©rieur du dossier des sessions : En ex√©cutant `cat sessions/*/*/*`, vous pouvez voir les noms d'utilisateur des utilisateurs connect√©s (gitea pourrait √©galement enregistrer les sessions √† l'int√©rieur de la DB).
* La **cl√© priv√©e jwt** √† l'int√©rieur du dossier jwt.
* Plus d'**informations sensibles** pourraient √™tre trouv√©es dans ce dossier.

Si vous √™tes √† l'int√©rieur du serveur, vous pouvez √©galement **utiliser le binaire `gitea`** pour acc√©der/modifier des informations :

* `gitea dump` va dumper gitea et g√©n√©rer un fichier .zip.
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET` va g√©n√©rer un jeton du type indiqu√© (persistence).
* `gitea admin user change-password --username admin --password newpassword` Change le mot de passe.
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` Cr√©e un nouvel utilisateur admin et obtient un jeton d'acc√®s.

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos github.

</details>
{% endhint %}
