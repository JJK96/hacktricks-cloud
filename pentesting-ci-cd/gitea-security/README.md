# Gitea Security

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## O que √© Gitea

**Gitea** √© uma **solu√ß√£o de hospedagem de c√≥digo leve, gerida pela comunidade e auto-hospedada** escrita em Go.

![](<../../.gitbook/assets/image (160).png>)

### Informa√ß√µes B√°sicas

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## Laborat√≥rio

Para executar uma inst√¢ncia do Gitea localmente, voc√™ pode simplesmente executar um cont√™iner docker:
```bash
docker run -p 3000:3000 gitea/gitea
```
Conecte-se √† porta 3000 para acessar a p√°gina web.

Voc√™ tamb√©m pode execut√°-lo com kubernetes:
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## Enumera√ß√£o N√£o Autenticada

* Reposit√≥rios p√∫blicos: [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* Usu√°rios registrados: [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* Organiza√ß√µes registradas: [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

Note que por **padr√£o o Gitea permite que novos usu√°rios se registrem**. Isso n√£o dar√° acesso especialmente interessante aos novos usu√°rios sobre os reposit√≥rios de outras organiza√ß√µes/usu√°rios, mas um **usu√°rio logado** pode ser capaz de **visualizar mais reposit√≥rios ou organiza√ß√µes**.

## Explora√ß√£o Interna

Para este cen√°rio, vamos supor que voc√™ obteve algum acesso a uma conta do github.

### Com Credenciais de Usu√°rio/Cookie da Web

Se de alguma forma voc√™ j√° tem credenciais para um usu√°rio dentro de uma organiza√ß√£o (ou voc√™ roubou um cookie de sess√£o), voc√™ pode **simplesmente fazer login** e verificar quais **permiss√µes voc√™ tem** sobre quais **reposit√≥rios**, em **quais equipes** voc√™ est√°, **listar outros usu√°rios**, e **como os reposit√≥rios est√£o protegidos**.

Note que **2FA pode ser usado**, ent√£o voc√™ s√≥ poder√° acessar essas informa√ß√µes se tamb√©m puder **passar por essa verifica√ß√£o**.

{% hint style="info" %}
Note que se voc√™ **conseguir roubar o cookie `i_like_gitea`** (atualmente configurado com SameSite: Lax), voc√™ pode **impersonar completamente o usu√°rio** sem precisar de credenciais ou 2FA.
{% endhint %}

### Com Chave SSH de Usu√°rio

Gitea permite que **usu√°rios** configurem **chaves SSH** que ser√£o usadas como **m√©todo de autentica√ß√£o para implantar c√≥digo** em seu nome (nenhum 2FA √© aplicado).

Com esta chave, voc√™ pode realizar **mudan√ßas em reposit√≥rios onde o usu√°rio tem alguns privil√©gios**, no entanto, voc√™ n√£o pode us√°-la para acessar a api do gitea para enumerar o ambiente. No entanto, voc√™ pode **enumerar configura√ß√µes locais** para obter informa√ß√µes sobre os reposit√≥rios e usu√°rios aos quais voc√™ tem acesso:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Se o usu√°rio configurou seu nome de usu√°rio como seu nome de usu√°rio gitea, voc√™ pode acessar as **chaves p√∫blicas que ele configurou** em sua conta em _https://github.com/\<gitea\_username>.keys_, voc√™ pode verificar isso para confirmar se a chave privada que voc√™ encontrou pode ser usada.

**Chaves SSH** tamb√©m podem ser configuradas em reposit√≥rios como **chaves de deploy**. Qualquer pessoa com acesso a essa chave poder√° **lan√ßar projetos a partir de um reposit√≥rio**. Normalmente, em um servidor com diferentes chaves de deploy, o arquivo local **`~/.ssh/config`** fornecer√° informa√ß√µes sobre a chave relacionada.

#### Chaves GPG

Como explicado [**aqui**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/gitea-security/broken-reference/README.md) √†s vezes √© necess√°rio assinar os commits ou voc√™ pode ser descoberto.

Verifique localmente se o usu√°rio atual possui alguma chave com:
```shell
gpg --list-secret-keys --keyid-format=long
```
### Com Token de Usu√°rio

Para uma introdu√ß√£o sobre [**Tokens de Usu√°rio, confira as informa√ß√µes b√°sicas**](basic-gitea-information.md#personal-access-tokens).

Um token de usu√°rio pode ser usado **em vez de uma senha** para **autenticar** contra o servidor Gitea [**via API**](https://try.gitea.io/api/swagger#/). Ele ter√° **acesso completo** sobre o usu√°rio.

### Com Aplica√ß√£o Oauth

Para uma introdu√ß√£o sobre [**Aplica√ß√µes Oauth do Gitea, confira as informa√ß√µes b√°sicas**](./#with-oauth-application).

Um atacante pode criar uma **Aplica√ß√£o Oauth maliciosa** para acessar dados/a√ß√µes privilegiadas dos usu√°rios que as aceitam, provavelmente como parte de uma campanha de phishing.

Como explicado nas informa√ß√µes b√°sicas, a aplica√ß√£o ter√° **acesso total sobre a conta do usu√°rio**.

### Bypass de Prote√ß√£o de Branch

No Github temos **github actions** que por padr√£o obt√™m um **token com acesso de escrita** sobre o reposit√≥rio que pode ser usado para **burlar prote√ß√µes de branch**. Neste caso, isso **n√£o existe**, ent√£o os bypasses s√£o mais limitados. Mas vamos ver o que pode ser feito:

* **Habilitar Push**: Se qualquer pessoa com acesso de escrita pode fazer push para a branch, basta fazer push para ela.
* **Whitelist de Push Restrito**: Da mesma forma, se voc√™ faz parte dessa lista, fa√ßa push para a branch.
* **Habilitar Whitelist de Merge**: Se houver uma whitelist de merge, voc√™ precisa estar dentro dela.
* **Requerer aprova√ß√µes maior que 0**: Ent√£o... voc√™ precisa comprometer outro usu√°rio.
* **Restringir aprova√ß√µes a usu√°rios da whitelist**: Se apenas usu√°rios da whitelist podem aprovar... voc√™ precisa comprometer outro usu√°rio que esteja nessa lista.
* **Descartar aprova√ß√µes obsoletas**: Se as aprova√ß√µes n√£o s√£o removidas com novos commits, voc√™ pode sequestrar um PR j√° aprovado para injetar seu c√≥digo e mesclar o PR.

Note que **se voc√™ √© um admin de org/repo** voc√™ pode burlar as prote√ß√µes.

### Enumerar Webhooks

**Webhooks** s√£o capazes de **enviar informa√ß√µes espec√≠ficas do gitea para alguns lugares**. Voc√™ pode ser capaz de **explorar essa comunica√ß√£o**.\
No entanto, geralmente um **segredo** que voc√™ **n√£o pode recuperar** √© definido no **webhook** que **impedir√°** usu√°rios externos que conhecem a URL do webhook, mas n√£o o segredo, de **explorar esse webhook**.\
Mas em algumas ocasi√µes, as pessoas, em vez de definir o **segredo** em seu lugar, **definem na URL** como um par√¢metro, ent√£o **verificar as URLs** pode permitir que voc√™ **encontre segredos** e outros lugares que voc√™ poderia explorar mais.

Webhooks podem ser definidos no **n√≠vel de repo e de org**.

## P√≥s-Explota√ß√£o

### Dentro do servidor

Se de alguma forma voc√™ conseguiu entrar no servidor onde o gitea est√° rodando, voc√™ deve procurar pelo arquivo de configura√ß√£o do gitea. Por padr√£o, ele est√° localizado em `/data/gitea/conf/app.ini`

Neste arquivo voc√™ pode encontrar **chaves** e **senhas**.

No caminho do gitea (por padr√£o: /data/gitea) voc√™ tamb√©m pode encontrar informa√ß√µes interessantes como:

* O **banco de dados sqlite**: Se o gitea n√£o estiver usando um banco de dados externo, ele usar√° um banco de dados sqlite.
* As **sess√µes** dentro da pasta de sess√µes: Executando `cat sessions/*/*/*` voc√™ pode ver os nomes de usu√°rio dos usu√°rios logados (o gitea tamb√©m pode salvar as sess√µes dentro do banco de dados).
* A **chave privada jwt** dentro da pasta jwt.
* Mais **informa√ß√µes sens√≠veis** podem ser encontradas nesta pasta.

Se voc√™ estiver dentro do servidor, tamb√©m pode **usar o bin√°rio `gitea`** para acessar/modificar informa√ß√µes:

* `gitea dump` ir√° fazer um dump do gitea e gerar um arquivo .zip.
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET` ir√° gerar um token do tipo indicado (persist√™ncia).
* `gitea admin user change-password --username admin --password newpassword` Mudar a senha.
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` Criar novo usu√°rio admin e obter um token de acesso.

{% hint style="success" %}
Aprenda & pratique AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda & pratique GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo no Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo no telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios no github.

</details>
{% endhint %}
