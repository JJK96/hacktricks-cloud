# Gitea Security

{% hint style="success" %}
AWS Hackingを学び、練習する:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingを学び、練習する: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローする。**
* **PRを提出してハッキングトリックを共有する** [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリ。

</details>
{% endhint %}

## Giteaとは

**Gitea**は、Goで書かれた**セルフホスト型コミュニティ管理の軽量コードホスティング**ソリューションです。

![](<../../.gitbook/assets/image (160).png>)

### 基本情報

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## ラボ

ローカルでGiteaインスタンスを実行するには、dockerコンテナを実行するだけです:
```bash
docker run -p 3000:3000 gitea/gitea
```
ポート3000に接続してウェブページにアクセスします。

kubernetesで実行することもできます:
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## Unauthenticated Enumeration

* Public repos: [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* Registered users: [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* Registered Organizations: [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

**デフォルトではGiteaは新しいユーザーの登録を許可します**。これにより、新しいユーザーが他の組織/ユーザーのリポジトリに特別なアクセス権を持つことはありませんが、**ログインしたユーザー**は**より多くのリポジトリや組織を可視化できる**可能性があります。

## Internal Exploitation

このシナリオでは、githubアカウントへの何らかのアクセスを取得したと仮定します。

### With User Credentials/Web Cookie

組織内のユーザーの資格情報を既に持っている場合（またはセッションCookieを盗んだ場合）、**ログインして**、どの**リポジトリに対してどの権限を持っているか**、どの**チームに所属しているか**、他のユーザーを**リストアップ**し、リポジトリがどのように**保護されているか**を確認できます。

**2FAが使用されている可能性がある**ため、この情報にアクセスするにはそのチェックも**通過する必要があります**。

{% hint style="info" %}
`i_like_gitea` Cookieを**盗むことができた場合**（現在SameSite: Laxで設定されています）、資格情報や2FAなしで**完全にユーザーを偽装することができます**。
{% endhint %}

### With User SSH Key

Giteaは**ユーザー**が**SSHキー**を設定し、これを**認証方法としてコードをデプロイ**するために使用することを許可しています（2FAは適用されません）。

このキーを使用して、**ユーザーが何らかの権限を持つリポジトリに変更を加える**ことができますが、gitea apiにアクセスして環境を列挙することはできません。しかし、**ローカル設定を列挙**して、アクセス可能なリポジトリやユーザーに関する情報を取得することができます:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
ユーザーが自分のgiteaユーザー名を設定している場合、アカウントに設定されている**公開鍵**にアクセスできます。_https://github.com/\<gitea\_username>.keys_で確認し、見つけた秘密鍵が使用できるか確認できます。

**SSH keys**はリポジトリに**deploy keys**として設定することもできます。このキーにアクセスできる人は誰でも**リポジトリからプロジェクトを起動**できます。通常、異なるdeploy keysを持つサーバーでは、ローカルファイル**`~/.ssh/config`**がキーに関する情報を提供します。

#### GPG Keys

[**こちら**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/gitea-security/broken-reference/README.md)で説明されているように、コミットに署名する必要がある場合や、発見される可能性があります。

現在のユーザーがキーを持っているかどうかをローカルで確認します:
```shell
gpg --list-secret-keys --keyid-format=long
```
### With User Token

[**User Tokensの基本情報**](basic-gitea-information.md#personal-access-tokens)についての紹介。

ユーザートークンは、**パスワードの代わりに**使用して、Giteaサーバーに対して**認証**を行うことができます。これにより、ユーザーに対して**完全なアクセス**が可能になります。

### With Oauth Application

[**Gitea Oauth Applicationsの基本情報**](./#with-oauth-application)についての紹介。

攻撃者は、**悪意のあるOauthアプリケーション**を作成して、フィッシングキャンペーンの一環としてユーザーが受け入れる特権データ/アクションにアクセスする可能性があります。

基本情報で説明されているように、アプリケーションは**ユーザーアカウントに対して完全なアクセス**を持ちます。

### Branch Protection Bypass

Githubでは、**github actions**がデフォルトでリポジトリに対して**書き込みアクセス権を持つトークン**を取得し、**ブランチ保護をバイパス**することができます。このケースではそれが**存在しない**ため、バイパスはより制限されます。しかし、できることを見てみましょう：

* **Enable Push**: 書き込みアクセス権を持つ誰かがブランチにプッシュできる場合、そのままプッシュします。
* **Whitelist Restricted Push**: 同様に、このリストの一部であればブランチにプッシュします。
* **Enable Merge Whitelist**: マージホワイトリストがある場合、その中に入る必要があります。
* **Require approvals is bigger than 0**: その場合、別のユーザーを妥協する必要があります。
* **Restrict approvals to whitelisted**: ホワイトリストに登録されたユーザーのみが承認できる場合、そのリスト内の別のユーザーを妥協する必要があります。
* **Dismiss stale approvals**: 新しいコミットで承認が取り消されない場合、既に承認されたPRをハイジャックしてコードを注入し、PRをマージすることができます。

**もしあなたがorg/repoの管理者であれば**、保護をバイパスすることができます。

### Enumerate Webhooks

**Webhooks**は、特定のgitea情報をいくつかの場所に**送信**することができます。これを**悪用**することができるかもしれません。\
しかし、通常は**シークレット**が**webhook**に設定されており、URLを知っているがシークレットを知らない外部ユーザーが**そのwebhookを悪用**するのを**防ぎます**。\
しかし、時々、人々は**シークレット**をその場所に設定する代わりに、URLにパラメータとして**設定**することがあり、**URLをチェック**することで**シークレット**や他の悪用可能な場所を見つけることができます。

Webhooksは**リポジトリレベルと組織レベル**で設定できます。

## Post Exploitation

### Inside the server

もし何らかの方法でgiteaが動作しているサーバーに侵入できた場合、giteaの設定ファイルを探すべきです。デフォルトでは、`/data/gitea/conf/app.ini`にあります。

このファイルには**キー**や**パスワード**が含まれています。

giteaのパス（デフォルト: /data/gitea）には、以下のような興味深い情報も見つかるかもしれません：

* **sqlite** DB: giteaが外部DBを使用していない場合、sqlite DBを使用します。
* セッションフォルダ内の**セッション**: `cat sessions/*/*/*`を実行すると、ログインしているユーザー名が表示されます（giteaはセッションをDB内に保存することもあります）。
* jwtフォルダ内の**jwtプライベートキー**
* その他の**機密情報**がこのフォルダ内に見つかるかもしれません。

サーバー内にいる場合、**`gitea`バイナリ**を使用して情報にアクセス/変更することもできます：

* `gitea dump`はgiteaをダンプし、.zipファイルを生成します。
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET`は指定されたタイプのトークンを生成します（永続性）。
* `gitea admin user change-password --username admin --password newpassword` パスワードを変更します。
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` 新しい管理者ユーザーを作成し、アクセス トークンを取得します。

{% hint style="success" %}
AWS Hackingを学び、練習しましょう:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hackingを学び、練習しましょう: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローしてください。
* **ハッキングトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出してください。

</details>
{% endhint %}
