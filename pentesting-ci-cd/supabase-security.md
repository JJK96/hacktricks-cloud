# Supabase安全

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

- 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
- 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
- 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
- **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
- 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

根据他们的[**首页**](https://supabase.com/)：Supabase是一个开源的Firebase替代品。使用Postgres数据库、身份验证、即时API、边缘函数、实时订阅、存储和向量嵌入开始您的项目。

### 子域

基本上，当创建一个项目时，用户将收到一个类似于**`jnanozjdybtpqgcwhdiz.supabase.co`**的supabase.co子域。

## **数据库配置**

{% hint style="success" %}
**可以通过类似`https://supabase.com/dashboard/project/<project-id>/settings/database`的链接访问这些数据**
{% endhint %}

这个**数据库**将部署在某个AWS区域，为了连接到它，可以连接到：`postgres://postgres.jnanozjdybtpqgcwhdiz:[YOUR-PASSWORD]@aws-0-us-west-1.pooler.supabase.com:5432/postgres`（这是在us-west-1创建的）。\
密码是用户之前设置的**密码**。

因此，由于子域是已知的，并且被用作用户名，AWS区域是有限的，可能可以尝试**暴力破解密码**。

此部分还包含以下选项：

- 重置数据库密码
- 配置连接池
- 配置SSL：拒绝明文连接（默认情况下已启用）
- 配置磁盘大小
- 应用网络限制和封禁

## API配置

{% hint style="success" %}
**可以通过类似`https://supabase.com/dashboard/project/<project-id>/settings/api`的链接访问这些数据**
{% endhint %}

访问您项目中的supabase API的URL将类似于：`https://jnanozjdybtpqgcwhdiz.supabase.co`。

### 匿名API密钥

它还将生成一个**匿名API密钥**（`role: "anon"`），如：`eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuYW5vemRyb2J0cHFnY3doZGl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTQ5OTI3MTksImV4cCI6MjAzMDU2ODcxOX0.sRN0iMGM5J741pXav7UxeChyqBE9_Z-T0tLA9Zehvqk`，应用程序将需要使用它来联系在我们的示例中公开的API密钥。

可以在[**文档**](https://supabase.com/docs/reference/self-hosting-auth/returns-the-configuration-settings-for-the-gotrue-server)中找到联系此API的API REST，但最有趣的端点将是：
```
POST /auth/v1/signup HTTP/2
Host: id.io.net
Content-Length: 90
X-Client-Info: supabase-js-web/2.39.2
Sec-Ch-Ua: "Not-A.Brand";v="99", "Chromium";v="124"
Sec-Ch-Ua-Mobile: ?0
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuYW5vemRyb2J0cHFnY3doZGl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTQ5OTI3MTksImV4cCI6MjAzMDU2ODcxOX0.sRN0iMGM5J741pXav7UxeChyqBE9_Z-T0tLA9Zehvqk
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.60 Safari/537.36
Content-Type: application/json;charset=UTF-8
Apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuYW5vemRyb2J0cHFnY3doZGl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTQ5OTI3MTksImV4cCI6MjAzMDU2ODcxOX0.sRN0iMGM5J741pXav7UxeChyqBE9_Z-T0tLA9Zehvqk
Sec-Ch-Ua-Platform: "macOS"
Accept: */*
Origin: https://cloud.io.net
Sec-Fetch-Site: same-site
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://cloud.io.net/
Accept-Encoding: gzip, deflate, br
Accept-Language: en-GB,en-US;q=0.9,en;q=0.8
Priority: u=1, i

{"email":"test@exmaple.com","password":"SomeCOmplexPwd239."}
```
</details>

<details>

<summary>登录 (/auth/v1/token?grant_type=password)</summary>
```
POST /auth/v1/token?grant_type=password HTTP/2
Host: hypzbtgspjkludjcnjxl.supabase.co
Content-Length: 80
X-Client-Info: supabase-js-web/2.39.2
Sec-Ch-Ua: "Not-A.Brand";v="99", "Chromium";v="124"
Sec-Ch-Ua-Mobile: ?0
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuYW5vemRyb2J0cHFnY3doZGl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTQ5OTI3MTksImV4cCI6MjAzMDU2ODcxOX0.sRN0iMGM5J741pXav7UxeChyqBE9_Z-T0tLA9Zehvqk
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.60 Safari/537.36
Content-Type: application/json;charset=UTF-8
Apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuYW5vemRyb2J0cHFnY3doZGl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTQ5OTI3MTksImV4cCI6MjAzMDU2ODcxOX0.sRN0iMGM5J741pXav7UxeChyqBE9_Z-T0tLA9Zehvqk
Sec-Ch-Ua-Platform: "macOS"
Accept: */*
Origin: https://cloud.io.net
Sec-Fetch-Site: same-site
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://cloud.io.net/
Accept-Encoding: gzip, deflate, br
Accept-Language: en-GB,en-US;q=0.9,en;q=0.8
Priority: u=1, i

{"email":"test@exmaple.com","password":"SomeCOmplexPwd239."}
```
</details>

因此，每当您发现客户正在使用其被授予的子域名与 supabase 一起使用时（公司的子域名可能在其 supabase 子域名上有一个 CNAME），您可以尝试**使用 supabase API 在平台上创建一个新帐户**。

### secret / service\_role api keys

还将生成一个带有**`role: "service_role"`**的秘密 API 密钥。这个 API 密钥应该保密，因为它将能够绕过**行级安全性**。

API 密钥看起来像这样：`eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuYW5vemRyb2J0cHFnY3doZGl6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTcxNDk5MjcxOSwiZXhwIjoyMDMwNTY4NzE5fQ.0a8fHGp3N_GiPq0y0dwfs06ywd-zhTwsm486Tha7354`

### JWT Secret

还将生成一个**JWT 密钥**，以便应用程序可以**创建和签署自定义 JWT 令牌**。

## 认证

### 注册

{% hint style="success" %}
**默认情况下**，supabase 将允许项目上的**新用户通过使用先前提到的 API 端点创建帐户**。
{% endhint %}

然而，默认情况下，这些新帐户**需要验证其电子邮件地址**才能登录到帐户。可以启用**"允许匿名登录"**以允许人们在不验证其电子邮件地址的情况下登录。这可能会授予对**意外数据**的访问权限（他们获得角色`public`和`authenticated`）。\
这是一个非常糟糕的主意，因为 supabase 按活跃用户收费，所以人们可以创建用户并登录，supabase 将为这些用户收费：

<figure><img src="../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

### 密码和会话

可以指定最小密码长度（默认情况下），要求（默认情况下不要求）并禁止使用泄漏的密码。\
建议**改进要求，因为默认要求较弱**。

* 用户会话：可以配置用户会话的工作方式（超时，每个用户 1 个会话...）
* 机器人和滥用保护：可以启用验证码。

### SMTP 设置

可以设置 SMTP 以发送电子邮件。

### 高级设置

* 设置访问令牌的过期时间（默认为 3600）
* 设置以检测和撤销潜在受损的刷新令牌和超时
* MFA：指示每个用户可以同时注册多少个 MFA 因素（默认为 10）
* 最大直接数据库连接数：用于身份验证的最大连接数（默认为 10）
* 最大请求持续时间：允许身份验证请求持续的最长时间（默认为 10 秒）

## 存储

{% hint style="success" %}
Supabase 允许**存储文件**并通过 URL 使其可访问（它使用 S3 存储桶）。
{% endhint %}

* 设置上传文件大小限制（默认为 50MB）
* S3 连接使用类似以下的 URL：`https://jnanozjdybtpqgcwhdiz.supabase.co/storage/v1/s3`
* 可以**请求 S3 访问密钥**，由`访问密钥 ID`（例如`a37d96544d82ba90057e0e06131d0a7b`）和`秘密访问密钥`（例如`58420818223133077c2cec6712a4f909aec93b4daeedae205aa8e30d5a860628`）组成

## 边缘函数

还可以在 supabase 中**存储秘密**，这些秘密将**可由边缘函数访问**（可以从网络创建和删除，但无法直接访问其值）。
