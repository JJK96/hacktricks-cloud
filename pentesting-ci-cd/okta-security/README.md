# Okta Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

[Okta, Inc.](https://www.okta.com/) は、クラウドベースのソフトウェアソリューションで知られるアイデンティティおよびアクセス管理分野の企業です。これらのソリューションは、さまざまな最新アプリケーションでのユーザー認証を簡素化し、安全にすることを目的としています。これにより、企業は機密データを保護し、開発者はアプリケーション、ウェブサービス、デバイスにアイデンティティコントロールを統合することができます。

Oktaの主力製品は**Okta Identity Cloud**です。このプラットフォームには、以下を含む一連の製品が含まれますが、これに限定されません：

* **Single Sign-On (SSO)**: 複数のアプリケーションで1つのログイン資格情報を使用してユーザーアクセスを簡素化します。
* **Multi-Factor Authentication (MFA)**: 複数の検証形式を要求することでセキュリティを強化します。
* **Lifecycle Management**: ユーザーアカウントの作成、更新、無効化プロセスを自動化します。
* **Universal Directory**: ユーザー、グループ、デバイスの集中管理を可能にします。
* **API Access Management**: APIへのアクセスを保護し、管理します。

これらのサービスは、データ保護を強化し、ユーザーアクセスを簡素化することを目的としています。Oktaのソリューションの多様性は、さまざまな業界で人気があり、大企業、小規模企業、個々の開発者にとって有益です。2021年9月の最新情報によると、Oktaはアイデンティティおよびアクセス管理（IAM）分野で著名な存在として認識されています。

{% hint style="danger" %}
Oktaの主な目的は、異なるユーザーやグループに対して外部アプリケーションへのアクセスを設定することです。もし**Okta環境で管理者権限を侵害**することができれば、**その企業が使用している他のすべてのプラットフォームを侵害する可能性が非常に高い**です。
{% endhint %}

{% hint style="success" %}
Okta環境のセキュリティレビューを行うには、**管理者の読み取り専用アクセス**を要求する必要があります。
{% endhint %}

### Summary

**ユーザー**（**Oktaに保存**されているか、設定された**Identity Providers**からログインするか、**Active Directory**またはLDAPを介して認証される）が存在します。\
これらのユーザーは**グループ**内に存在することがあります。\
また、**認証器**も存在します：パスワードやWebAuthn、メール、電話、okta verifyなどの複数の2FAオプション（有効または無効にすることができます）...

次に、Oktaと同期された**アプリケーション**があります。各アプリケーションは、情報（メールアドレス、名前など）を共有するための**Oktaとのマッピング**を持っています。さらに、各アプリケーションは**認証ポリシー**内に存在し、ユーザーがアプリケーションに**アクセス**するために必要な**認証器**を示します。

{% hint style="danger" %}
最も強力な役割は**Super Administrator**です。

攻撃者が管理者アクセスでOktaを侵害した場合、**Oktaを信頼しているすべてのアプリ**が非常に高い確率で**侵害される**でしょう。
{% endhint %}

## Attacks

### Locating Okta Portal

通常、企業のポータルは**companyname.okta.com**にあります。そうでない場合は、**companyname**の簡単な**バリエーション**を試してください。見つからない場合、組織が**CNAME**レコード（例：**`okta.companyname.com`**）を**Oktaポータル**にポイントしている可能性もあります。

### Login in Okta via Kerberos

もし**`companyname.kerberos.okta.com`**がアクティブであれば、**KerberosがOktaアクセスに使用されている**ことを意味し、通常は**Windows**ユーザーのために**MFA**をバイパスします。ADでKerberos認証されたOktaユーザーを見つけるには、**適切なパラメータ**で**`getST.py`**を実行します。**ADユーザーチケット**を取得したら、RubeusやMimikatzなどのツールを使用して制御されたホストに**注入**し、**`clientname.kerberos.okta.com`がインターネットオプションの「イントラネット」ゾーンにあることを確認**します。特定のURLにアクセスすると、JSONの「OK」応答が返され、Kerberosチケットの受け入れが確認され、Oktaダッシュボードへのアクセスが許可されます。

**委任SPNを持つOktaサービスアカウントを侵害すると、Silver Ticket攻撃が可能になります。** ただし、Oktaはチケット暗号化に**AES**を使用しているため、AESキーまたは平文パスワードを持っている必要があります。**`ticketer.py`を使用して被害者ユーザーのチケットを生成**し、ブラウザ経由でOktaに認証させます。

**攻撃の詳細は** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**で確認してください。**

### Hijacking Okta AD Agent

この技術は、**サーバー上のOkta AD Agentにアクセス**し、**ユーザーの同期と認証を処理**することを含みます。**`OktaAgentService.exe.config`**の設定を調査し、特に**DPAPI**を使用してAgentTokenを復号化することで、攻撃者は**認証データを傍受し操作する**可能性があります。これにより、Okta認証プロセス中に平文でユーザー資格情報を**監視およびキャプチャ**するだけでなく、認証試行に**応答**することも可能になり、Oktaを通じて不正アクセスやユニバーサル認証を提供することができます（いわゆる「スケルトンキー」）。

**攻撃の詳細は** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**で確認してください。**

### Hijacking AD As an Admin

この技術は、OAuthコードを取得し、APIトークンを要求することでOkta AD Agentをハイジャックすることを含みます。トークンはADドメインに関連付けられ、**偽のADエージェントを確立するためにコネクタが命名されます**。初期化により、エージェントは**認証試行を処理**し、Okta APIを介して資格情報をキャプチャします。自動化ツールを使用すると、このプロセスが簡素化され、Okta環境内で認証データを傍受および処理するシームレスな方法が提供されます。

**攻撃の詳細は** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**で確認してください。**

### Okta Fake SAML Provider

**攻撃の詳細は** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**で確認してください。**

この技術は、**偽のSAMLプロバイダーを展開**することを含みます。特権アカウントを使用してOktaのフレームワーク内に外部アイデンティティプロバイダー（IdP）を統合することで、攻撃者は**IdPを制御し、任意の認証要求を承認することができます**。このプロセスには、OktaにSAML 2.0 IdPを設定し、ローカルホストファイルを介してIdPシングルサインオンURLをリダイレクトし、自己署名証明書を生成し、Okta設定をユーザー名またはメールアドレスに一致させることが含まれます。これらの手順を成功させることで、個々のユーザー資格情報を必要とせずに任意のOktaユーザーとして認証できるようになり、アクセス制御が大幅に向上します。

### Phishing Okta Portal with Evilgnix

[**このブログ記事**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) では、Oktaポータルに対するフィッシングキャンペーンの準備方法が説明されています。

### Colleague Impersonation Attack

**各ユーザーが持ち、変更できる属性**（メールや名前など）はOktaで設定できます。もし**アプリケーション**がIDとしてユーザーが**変更できる属性**を**信頼**している場合、そのプラットフォームで他のユーザーを**偽装**することができます。

したがって、アプリが**`userName`**フィールドを信頼している場合、通常そのフィールドを変更できないため、変更できない可能性がありますが、例えば**`primaryEmail`**を信頼している場合、**同僚のメールアドレスに変更**して偽装することができます（メールにアクセスして変更を受け入れる必要があります）。

この偽装は各アプリケーションの設定方法に依存します。変更したフィールドを信頼し、更新を受け入れるアプリのみが侵害されます。\
したがって、アプリにこのフィールドが存在する場合は有効にする必要があります：

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

Okta設定にそのフィールドがないが脆弱な他のアプリも見たことがあります（最終的には異なるアプリが異なる設定を持っているため）。

各アプリで誰かを偽装できるかどうかを確認する最良の方法は、試してみることです！

## Evading behavioural detection policies <a href="#id-9fde" id="id-9fde"></a>

Oktaの行動検出ポリシーは遭遇するまで不明かもしれませんが、**回避**するには**Oktaアプリケーションに直接アクセス**し、メインのOktaダッシュボードを避けることができます。**Oktaアクセストークン**を使用して、メインのログインページではなく**アプリケーション固有のOkta URL**でトークンを再生します。

主な推奨事項は次のとおりです：

* **キャプチャされたアクセストークンを再生する際に**、一般的な匿名プロキシやVPNサービスを使用しないでください。
* クライアントと再生されたアクセストークンの間で**一貫したユーザーエージェント文字列**を確保してください。
* 同じIPアドレスから異なるユーザーのトークンを**再生しないでください**。
* Oktaダッシュボードに対してトークンを再生する際には注意してください。
* 被害者企業のIPアドレスを知っている場合は、**そのIPまたはその範囲にトラフィックを制限**し、他のすべてのトラフィックをブロックしてください。

## Okta Hardening

Oktaには多くの設定オプションがあります。このページでは、可能な限り安全にするためのレビュー方法を紹介します：

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## References

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
