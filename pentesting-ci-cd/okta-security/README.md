# Okta Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Temel Bilgiler

[Okta, Inc.](https://www.okta.com/), kimlik ve erişim yönetimi sektöründe bulut tabanlı yazılım çözümleri ile tanınır. Bu çözümler, çeşitli modern uygulamalarda kullanıcı kimlik doğrulamasını kolaylaştırmak ve güvence altına almak için tasarlanmıştır. Hem hassas verilerini korumak isteyen şirketlere hem de uygulamalara, web hizmetlerine ve cihazlara kimlik kontrolleri entegre etmek isteyen geliştiricilere hitap eder.

Okta'nın amiral gemisi ürünü **Okta Identity Cloud**'dur. Bu platform, aşağıdakiler de dahil olmak üzere bir dizi ürünü kapsar:

* **Single Sign-On (SSO)**: Birden fazla uygulama için tek bir giriş kimlik bilgisi seti kullanarak kullanıcı erişimini basitleştirir.
* **Multi-Factor Authentication (MFA)**: Birden fazla doğrulama biçimi gerektirerek güvenliği artırır.
* **Lifecycle Management**: Kullanıcı hesabı oluşturma, güncelleme ve devre dışı bırakma süreçlerini otomatikleştirir.
* **Universal Directory**: Kullanıcıların, grupların ve cihazların merkezi yönetimini sağlar.
* **API Access Management**: API'lere erişimi güvence altına alır ve yönetir.

Bu hizmetler, veri korumasını güçlendirmeyi ve kullanıcı erişimini kolaylaştırmayı amaçlar, hem güvenliği hem de kullanım kolaylığını artırır. Okta'nın çözümlerinin çok yönlülüğü, büyük işletmeler, küçük şirketler ve bireysel geliştiriciler için popüler bir seçim haline getirir. Eylül 2021 itibarıyla Okta, Kimlik ve Erişim Yönetimi (IAM) alanında önde gelen bir varlık olarak kabul edilmektedir.

{% hint style="danger" %}
Okta'nın ana hedefi, farklı kullanıcılar ve gruplar için dış uygulamalara erişimi yapılandırmaktır. Eğer bir Okta ortamında **yönetici ayrıcalıklarını ele geçirmeyi başarırsanız**, büyük olasılıkla **şirketin kullandığı diğer tüm platformları da ele geçirebilirsiniz**.
{% endhint %}

{% hint style="success" %}
Bir Okta ortamının güvenlik incelemesini yapmak için **yönetici salt okunur erişimi** istemelisiniz.
{% endhint %}

### Özet

**Kullanıcılar** vardır (bu kullanıcılar **Okta'da saklanabilir**, yapılandırılmış **Identity Providers**'dan giriş yapabilir veya **Active Directory** veya LDAP üzerinden kimlik doğrulaması yapabilir).\
Bu kullanıcılar **gruplar** içinde olabilir.\
Ayrıca **doğrulayıcılar** vardır: şifre gibi farklı kimlik doğrulama seçenekleri ve WebAuthn, e-posta, telefon, okta verify gibi çeşitli 2FA'lar (etkinleştirilebilir veya devre dışı bırakılabilir)...

Daha sonra, Okta ile senkronize edilmiş **uygulamalar** vardır. Her uygulama, bilgi paylaşımı için Okta ile bazı **eşlemelere** sahip olacaktır (örneğin e-posta adresleri, adlar...). Ayrıca, her uygulama bir **Kimlik Doğrulama Politikası** içinde olmalıdır, bu politika bir kullanıcının uygulamaya **erişmesi** için gerekli **doğrulayıcıları** belirtir.

{% hint style="danger" %}
En güçlü rol **Süper Yönetici**'dir.

Bir saldırgan, Yönetici erişimi ile Okta'yı ele geçirirse, **Okta'ya güvenen tüm uygulamalar** büyük olasılıkla **ele geçirilmiş** olacaktır.
{% endhint %}

## Saldırılar

### Okta Portalını Bulma

Genellikle bir şirketin portalı **companyname.okta.com** adresinde bulunur. Eğer değilse, **companyname**'in basit **varyasyonlarını** deneyin. Bulamazsanız, organizasyonun **Okta portalına** işaret eden bir **CNAME** kaydı (örneğin **`okta.companyname.com`**) olması da mümkündür.

### Kerberos ile Okta'ya Giriş Yapma

Eğer **`companyname.kerberos.okta.com`** aktifse, **Kerberos Okta erişimi için kullanılır**, genellikle **Windows** kullanıcıları için **MFA**'yı atlar. AD'de Kerberos ile kimlik doğrulanan Okta kullanıcılarını bulmak için **`getST.py`**'yi uygun parametrelerle çalıştırın. Bir **AD kullanıcı bileti** elde ettikten sonra, Rubeus veya Mimikatz gibi araçları kullanarak bunu kontrol edilen bir ana bilgisayara **enjeksiyon** yapın, **`clientname.kerberos.okta.com`'un Internet Seçenekleri "Intranet" bölgesinde olduğundan emin olun**. Belirli bir URL'ye erişmek, Kerberos biletinin kabul edildiğini belirten bir JSON "OK" yanıtı döndürmeli ve Okta panosuna erişim sağlamalıdır.

**Delegasyon SPN ile Okta hizmet hesabını ele geçirmek, Silver Ticket saldırısını mümkün kılar.** Ancak, Okta'nın bilet şifrelemesi için **AES** kullanması, AES anahtarına veya düz metin parolasına sahip olmayı gerektirir. **`ticketer.py`'yi kullanarak kurban kullanıcı için bir bilet oluşturun** ve bunu tarayıcı aracılığıyla Okta ile kimlik doğrulamak için teslim edin.

**Saldırıyı kontrol edin** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Okta AD Agent'ını Ele Geçirme

Bu teknik, **bir sunucudaki Okta AD Agent'ına erişmeyi** içerir, bu **kullanıcıları senkronize eder ve kimlik doğrulamasını yönetir**. **`OktaAgentService.exe.config`** içindeki yapılandırmaları inceleyerek ve şifrelerini çözerek, özellikle **DPAPI** kullanarak AgentToken'ı, bir saldırgan potansiyel olarak **kimlik doğrulama verilerini kesebilir ve manipüle edebilir**. Bu, yalnızca **Okta kimlik doğrulama sürecinde kullanıcı kimlik bilgilerini düz metin olarak izlemeyi ve yakalamayı** değil, aynı zamanda **kimlik doğrulama girişimlerine yanıt vermeyi** de sağlar, böylece yetkisiz erişim veya Okta aracılığıyla evrensel kimlik doğrulama (bir 'iskelet anahtarı' gibi) sağlar.

**Saldırıyı kontrol edin** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Bir Yönetici Olarak AD'yi Ele Geçirme

Bu teknik, bir OAuth Kodu elde ederek ve ardından bir API belirteci isteyerek bir Okta AD Agent'ını ele geçirmeyi içerir. Belirteç bir AD etki alanı ile ilişkilidir ve **sahte bir AD agent'ı kurmak için bir bağlayıcı adlandırılır**. Başlatma, agent'ın **kimlik doğrulama girişimlerini işlemesine** izin verir, Okta API'si aracılığıyla kimlik bilgilerini yakalar. Otomasyon araçları, bu süreci kolaylaştırmak için mevcuttur, Okta ortamında kimlik doğrulama verilerini kesmek ve işlemek için sorunsuz bir yöntem sunar.

**Saldırıyı kontrol edin** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Okta Sahte SAML Sağlayıcısı

**Saldırıyı kontrol edin** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

Bu teknik, **sahte bir SAML sağlayıcısı dağıtmayı** içerir. Okta'nın çerçevesine ayrıcalıklı bir hesap kullanarak harici bir Kimlik Sağlayıcı (IdP) entegre ederek, saldırganlar **IdP'yi kontrol edebilir ve herhangi bir kimlik doğrulama isteğini onaylayabilir**. Süreç, Okta'da bir SAML 2.0 IdP kurmayı, yerel hosts dosyası aracılığıyla yönlendirme için IdP Tek Oturum Açma URL'sini manipüle etmeyi, kendi kendine imzalı bir sertifika oluşturmayı ve Okta ayarlarını kullanıcı adı veya e-posta ile eşleşecek şekilde yapılandırmayı içerir. Bu adımları başarıyla uygulamak, bireysel kullanıcı kimlik bilgilerine ihtiyaç duymadan herhangi bir Okta kullanıcısı olarak kimlik doğrulama sağlar, bu da potansiyel olarak fark edilmeden erişim kontrolünü önemli ölçüde artırır.

### Evilgnix ile Okta Portalını Phishing Yapma

[**Bu blog yazısında**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) bir Okta portalına karşı bir phishing kampanyasının nasıl hazırlanacağı açıklanmıştır.

### Meslektaş Taklit Saldırısı

Her kullanıcının sahip olabileceği ve değiştirebileceği **özellikler** (örneğin e-posta veya ad) Okta'da yapılandırılabilir. Eğer bir **uygulama**, kullanıcı tarafından **değiştirilebilecek** bir **özelliğe** kimlik olarak **güveniyorsa**, kullanıcı o platformda **diğer kullanıcıları taklit edebilir**.

Bu nedenle, uygulama **`userName`** alanına güveniyorsa, muhtemelen bunu değiştiremeyeceksiniz (çünkü genellikle bu alanı değiştiremezsiniz), ancak örneğin **`primaryEmail`** alanına güveniyorsa, bunu **bir meslektaşınızın e-posta adresine** değiştirebilir ve onu taklit edebilirsiniz (e-postaya erişiminiz olması ve değişikliği kabul etmeniz gerekecektir).

Bu taklit, her uygulamanın nasıl yapılandırıldığına bağlıdır. Yalnızca değiştirdiğiniz alana güvenen ve güncellemeleri kabul edenler ele geçirilecektir.\
Bu nedenle, uygulama bu alanı etkinleştirmiş olmalıdır:

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

Ayrıca, Okta ayarlarında bu alana sahip olmayan ancak yine de savunmasız olan diğer uygulamaları da gördüm (sonuçta farklı uygulamalar farklı şekilde yapılandırılmıştır).

Her uygulamada birini taklit edip edemeyeceğinizi öğrenmenin en iyi yolu denemektir!

## Davranışsal Tespit Politikalarından Kaçınma <a href="#id-9fde" id="id-9fde"></a>

Okta'daki davranışsal tespit politikaları karşılaşılana kadar bilinmeyebilir, ancak **bunlardan kaçınmak**, **Okta uygulamalarını doğrudan hedef alarak**, ana Okta panosundan kaçınarak başarılabilir. Bir **Okta erişim belirteci** ile, belirteci **uygulamaya özgü Okta URL'sinde** ana giriş sayfası yerine yeniden oynatın.

Anahtar öneriler şunlardır:

* **Yakalanan erişim belirteçlerini yeniden oynatırken** popüler anonimleştirici proxy'ler ve VPN hizmetlerini kullanmaktan kaçının.
* **İstemci ve yeniden oynatılan erişim belirteçleri arasında** tutarlı kullanıcı aracısı dizeleri sağlayın.
* **Aynı IP adresinden farklı kullanıcıların** belirteçlerini yeniden oynatmaktan kaçının.
* Okta panosuna karşı belirteçleri yeniden oynatırken dikkatli olun.
* Kurban şirketin IP adreslerini biliyorsanız, **trafiği bu IP'lere veya aralıklarına sınırlayın**, diğer tüm trafiği engelleyin.

## Okta Güçlendirme

Okta'nın birçok olası yapılandırması vardır, bu sayfada bunları nasıl gözden geçireceğinizi ve mümkün olduğunca güvenli hale getireceğinizi bulacaksınız:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Referanslar

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
