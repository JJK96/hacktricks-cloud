# Okta Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Podstawowe Informacje

[Okta, Inc.](https://www.okta.com/) jest uznawana w sektorze zarządzania tożsamością i dostępem za swoje rozwiązania oparte na chmurze. Te rozwiązania są zaprojektowane, aby uprościć i zabezpieczyć uwierzytelnianie użytkowników w różnych nowoczesnych aplikacjach. Służą one nie tylko firmom, które chcą chronić swoje wrażliwe dane, ale także deweloperom zainteresowanym integracją kontroli tożsamości w aplikacjach, usługach internetowych i urządzeniach.

Flagowym produktem Okta jest **Okta Identity Cloud**. Ta platforma obejmuje zestaw produktów, w tym między innymi:

* **Single Sign-On (SSO)**: Ułatwia dostęp użytkowników, pozwalając na jedno zestawienie danych logowania do wielu aplikacji.
* **Multi-Factor Authentication (MFA)**: Zwiększa bezpieczeństwo, wymagając wielu form weryfikacji.
* **Lifecycle Management**: Automatyzuje procesy tworzenia, aktualizacji i dezaktywacji kont użytkowników.
* **Universal Directory**: Umożliwia centralne zarządzanie użytkownikami, grupami i urządzeniami.
* **API Access Management**: Zabezpiecza i zarządza dostępem do API.

Te usługi mają na celu wzmocnienie ochrony danych i uproszczenie dostępu użytkowników, zwiększając zarówno bezpieczeństwo, jak i wygodę. Wszechstronność rozwiązań Okta sprawia, że są one popularnym wyborem w różnych branżach, korzystnym dla dużych przedsiębiorstw, małych firm i indywidualnych deweloperów. Na dzień ostatniej aktualizacji we wrześniu 2021 roku, Okta jest uznawana za znaczący podmiot w dziedzinie zarządzania tożsamością i dostępem (IAM).

{% hint style="danger" %}
Głównym celem Okta jest skonfigurowanie dostępu dla różnych użytkowników i grup do zewnętrznych aplikacji. Jeśli uda Ci się **przejąć uprawnienia administratora w środowisku Okta**, prawdopodobnie będziesz w stanie **przejąć wszystkie inne platformy, z których korzysta firma**.
{% endhint %}

{% hint style="success" %}
Aby przeprowadzić przegląd bezpieczeństwa środowiska Okta, powinieneś poprosić o **dostęp administratora tylko do odczytu**.
{% endhint %}

### Podsumowanie

Istnieją **użytkownicy** (którzy mogą być **przechowywani w Okta**, logowani z skonfigurowanych **Identity Providers** lub uwierzytelniani przez **Active Directory** lub LDAP).\
Ci użytkownicy mogą być w **grupach**.\
Istnieją również **uwierzytelniacze**: różne opcje uwierzytelniania, takie jak hasło, oraz kilka 2FA, takich jak WebAuthn, email, telefon, okta verify (mogą być włączone lub wyłączone)...

Następnie są **aplikacje** zsynchronizowane z Okta. Każda aplikacja będzie miała pewne **mapowanie z Okta** do udostępniania informacji (takich jak adresy email, imiona...). Ponadto każda aplikacja musi być w **Polityce Uwierzytelniania**, która wskazuje **potrzebne uwierzytelniacze** dla użytkownika, aby **uzyskać dostęp** do aplikacji.

{% hint style="danger" %}
Najpotężniejszą rolą jest **Super Administrator**.

Jeśli atakujący przejmie Okta z dostępem administratora, wszystkie **aplikacje ufające Okta** będą prawdopodobnie **przejęte**.
{% endhint %}

## Ataki

### Lokalizowanie Portalu Okta

Zazwyczaj portal firmy będzie znajdował się na **companyname.okta.com**. Jeśli nie, spróbuj prostych **wariacji** **companyname.** Jeśli nie możesz go znaleźć, możliwe jest również, że organizacja ma rekord **CNAME** jak **`okta.companyname.com`** wskazujący na **portal Okta**.

### Logowanie do Okta przez Kerberos

Jeśli **`companyname.kerberos.okta.com`** jest aktywne, **Kerberos jest używany do dostępu do Okta**, zazwyczaj omijając **MFA** dla użytkowników **Windows**. Aby znaleźć użytkowników Okta uwierzytelnianych przez Kerberos w AD, uruchom **`getST.py`** z **odpowiednimi parametrami**. Po uzyskaniu **biletu użytkownika AD**, **wstrzyknij** go do kontrolowanego hosta za pomocą narzędzi takich jak Rubeus lub Mimikatz, upewniając się, że **`clientname.kerberos.okta.com` jest w strefie "Intranet" w Opcjach Internetowych**. Dostęp do określonego URL powinien zwrócić odpowiedź JSON "OK", wskazującą na akceptację biletu Kerberos i przyznanie dostępu do pulpitu Okta.

Przejęcie **konta usługi Okta z delegacją SPN umożliwia atak Silver Ticket.** Jednakże, użycie przez Okta **AES** do szyfrowania biletów wymaga posiadania klucza AES lub hasła w postaci jawnej. Użyj **`ticketer.py` do wygenerowania biletu dla użytkownika ofiary** i dostarcz go przez przeglądarkę, aby uwierzytelnić się w Okta.

**Sprawdź atak na** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Przejęcie Okta AD Agent

Ta technika polega na **dostępie do Okta AD Agent na serwerze**, który **synchronizuje użytkowników i obsługuje uwierzytelnianie**. Poprzez analizę i odszyfrowanie konfiguracji w **`OktaAgentService.exe.config`**, zwłaszcza AgentToken za pomocą **DPAPI**, atakujący może potencjalnie **przechwycić i manipulować danymi uwierzytelniającymi**. To pozwala nie tylko na **monitorowanie** i **przechwytywanie danych uwierzytelniających użytkowników** w postaci jawnej podczas procesu uwierzytelniania Okta, ale także na **odpowiadanie na próby uwierzytelniania**, umożliwiając nieautoryzowany dostęp lub zapewniając uniwersalne uwierzytelnianie przez Okta (podobnie jak 'klucz szkieletowy').

**Sprawdź atak na** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Przejęcie AD jako Administrator

Ta technika polega na przejęciu Okta AD Agent poprzez najpierw uzyskanie kodu OAuth, a następnie żądanie tokena API. Token jest powiązany z domeną AD, a **konektor jest nazwany, aby ustanowić fałszywy agent AD**. Inicjalizacja pozwala agentowi na **przetwarzanie prób uwierzytelniania**, przechwytywanie danych uwierzytelniających za pomocą API Okta. Dostępne są narzędzia automatyzujące ten proces, oferując płynny sposób przechwytywania i obsługi danych uwierzytelniających w środowisku Okta.

**Sprawdź atak na** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Fałszywy Dostawca SAML Okta

**Sprawdź atak na** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

Technika polega na **wdrożeniu fałszywego dostawcy SAML**. Poprzez integrację zewnętrznego dostawcy tożsamości (IdP) w ramach Okta za pomocą uprzywilejowanego konta, atakujący mogą **kontrolować IdP, zatwierdzając dowolne żądanie uwierzytelnienia według własnego uznania**. Proces obejmuje skonfigurowanie IdP SAML 2.0 w Okta, manipulowanie URL IdP Single Sign-On do przekierowania przez lokalny plik hosts, generowanie samopodpisanego certyfikatu i konfigurowanie ustawień Okta, aby dopasować się do nazwy użytkownika lub adresu email. Pomyślne wykonanie tych kroków pozwala na uwierzytelnienie jako dowolny użytkownik Okta, omijając potrzebę posiadania indywidualnych danych uwierzytelniających użytkowników, znacznie podnosząc kontrolę dostępu w sposób potencjalnie niezauważony.

### Phishing Portalu Okta z Evilgnix

W [**tym wpisie na blogu**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) jest wyjaśnione, jak przygotować kampanię phishingową przeciwko portalowi Okta.

### Atak na Podszywanie się pod Kolegę

**Atrybuty, które każdy użytkownik może mieć i modyfikować** (takie jak email lub imię) mogą być skonfigurowane w Okta. Jeśli **aplikacja** **ufa** jako ID **atrybutowi**, który użytkownik może **zmodyfikować**, będzie on w stanie **podszyć się pod innych użytkowników na tej platformie**.

Dlatego, jeśli aplikacja ufa polu **`userName`**, prawdopodobnie nie będziesz w stanie go zmienić (ponieważ zazwyczaj nie można zmienić tego pola), ale jeśli ufa na przykład **`primaryEmail`**, możesz być w stanie **zmienić go na adres email kolegi** i się pod niego podszyć (będziesz musiał mieć dostęp do emaila i zaakceptować zmianę).

Należy zauważyć, że to podszywanie się zależy od tego, jak każda aplikacja została skonfigurowana. Tylko te, które ufają polu, które zmodyfikowałeś i akceptują aktualizacje, będą skompromitowane.\
Dlatego aplikacja powinna mieć to pole włączone, jeśli istnieje:

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

Widziałem również inne aplikacje, które były podatne, ale nie miały tego pola w ustawieniach Okta (na końcu różne aplikacje są konfigurowane różnie).

Najlepszym sposobem, aby dowiedzieć się, czy możesz podszyć się pod kogoś w każdej aplikacji, byłoby to wypróbować!

## Omijanie polityk wykrywania behawioralnego <a href="#id-9fde" id="id-9fde"></a>

Polityki wykrywania behawioralnego w Okta mogą być nieznane, dopóki nie zostaną napotkane, ale **omijanie** ich można osiągnąć poprzez **celowanie bezpośrednio w aplikacje Okta**, unikając głównego pulpitu Okta. Mając **token dostępu Okta**, odtwórz token na **specyficznym dla aplikacji URL Okta** zamiast na głównej stronie logowania.

Kluczowe zalecenia obejmują:

* **Unikaj używania** popularnych serwerów proxy i usług VPN podczas odtwarzania przechwyconych tokenów dostępu.
* Upewnij się, że **ciągi user-agent** są spójne między klientem a odtwarzanymi tokenami dostępu.
* **Powstrzymaj się od odtwarzania** tokenów różnych użytkowników z tego samego adresu IP.
* Zachowaj ostrożność podczas odtwarzania tokenów na pulpicie Okta.
* Jeśli znasz adresy IP firmy ofiary, **ogranicz ruch** do tych adresów IP lub ich zakresu, blokując cały inny ruch.

## Okta Hardening

Okta ma wiele możliwych konfiguracji, na tej stronie znajdziesz, jak je przeglądać, aby były jak najbardziej bezpieczne:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Odnośniki

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
