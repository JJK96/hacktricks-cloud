# Okta Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

[Okta, Inc.](https://www.okta.com/) √© reconhecida no setor de gerenciamento de identidade e acesso por suas solu√ß√µes de software baseadas em nuvem. Essas solu√ß√µes s√£o projetadas para simplificar e proteger a autentica√ß√£o de usu√°rios em v√°rias aplica√ß√µes modernas. Elas atendem n√£o apenas a empresas que visam proteger seus dados sens√≠veis, mas tamb√©m a desenvolvedores interessados em integrar controles de identidade em aplica√ß√µes, servi√ßos web e dispositivos.

A oferta principal da Okta √© a **Okta Identity Cloud**. Esta plataforma abrange uma su√≠te de produtos, incluindo, mas n√£o se limitando a:

* **Single Sign-On (SSO)**: Simplifica o acesso do usu√°rio permitindo um conjunto de credenciais de login em v√°rias aplica√ß√µes.
* **Multi-Factor Authentication (MFA)**: Aumenta a seguran√ßa exigindo v√°rias formas de verifica√ß√£o.
* **Lifecycle Management**: Automatiza os processos de cria√ß√£o, atualiza√ß√£o e desativa√ß√£o de contas de usu√°rio.
* **Universal Directory**: Permite a gest√£o centralizada de usu√°rios, grupos e dispositivos.
* **API Access Management**: Protege e gerencia o acesso a APIs.

Esses servi√ßos coletivamente visam fortalecer a prote√ß√£o de dados e simplificar o acesso do usu√°rio, melhorando tanto a seguran√ßa quanto a conveni√™ncia. A versatilidade das solu√ß√µes da Okta as torna uma escolha popular em v√°rios setores, sendo ben√©fica para grandes empresas, pequenas empresas e desenvolvedores individuais. At√© a √∫ltima atualiza√ß√£o em setembro de 2021, a Okta √© reconhecida como uma entidade proeminente na arena de Gerenciamento de Identidade e Acesso (IAM).

{% hint style="danger" %}
O principal objetivo da Okta √© configurar o acesso de diferentes usu√°rios e grupos a aplica√ß√µes externas. Se voc√™ conseguir **comprometer privil√©gios de administrador em um ambiente Okta**, voc√™ provavelmente ser√° capaz de **comprometer todas as outras plataformas que a empresa est√° usando**.
{% endhint %}

{% hint style="success" %}
Para realizar uma revis√£o de seguran√ßa de um ambiente Okta, voc√™ deve solicitar **acesso de administrador somente leitura**.
{% endhint %}

### Resumo

Existem **usu√°rios** (que podem ser **armazenados na Okta**, logados a partir de **Identity Providers** configurados ou autenticados via **Active Directory** ou LDAP).\
Esses usu√°rios podem estar dentro de **grupos**.\
Existem tamb√©m **autenticadores**: diferentes op√ß√µes para autenticar como senha, e v√°rios 2FA como WebAuthn, email, telefone, okta verify (eles podem estar habilitados ou desabilitados)...

Ent√£o, existem **aplica√ß√µes** sincronizadas com a Okta. Cada aplica√ß√£o ter√° algum **mapeamento com a Okta** para compartilhar informa√ß√µes (como endere√ßos de email, primeiros nomes...). Al√©m disso, cada aplica√ß√£o deve estar dentro de uma **Pol√≠tica de Autentica√ß√£o**, que indica os **autenticadores necess√°rios** para um usu√°rio **acessar** a aplica√ß√£o.

{% hint style="danger" %}
O papel mais poderoso √© o **Super Administrator**.

Se um atacante comprometer a Okta com acesso de Administrador, todas as **aplica√ß√µes que confiam na Okta** provavelmente ser√£o **comprometidas**.
{% endhint %}

## Ataques

### Localizando o Portal Okta

Normalmente, o portal de uma empresa estar√° localizado em **companyname.okta.com**. Se n√£o, tente varia√ß√µes simples de **companyname.** Se voc√™ n√£o conseguir encontr√°-lo, tamb√©m √© poss√≠vel que a organiza√ß√£o tenha um registro **CNAME** como **`okta.companyname.com`** apontando para o **portal Okta**.

### Login na Okta via Kerberos

Se **`companyname.kerberos.okta.com`** estiver ativo, **Kerberos √© usado para acesso Okta**, tipicamente ignorando **MFA** para usu√°rios **Windows**. Para encontrar usu√°rios Okta autenticados por Kerberos no AD, execute **`getST.py`** com **par√¢metros apropriados**. Ap√≥s obter um **ticket de usu√°rio AD**, **injete**-o em um host controlado usando ferramentas como Rubeus ou Mimikatz, garantindo que **`clientname.kerberos.okta.com` esteja na zona "Intranet" das Op√ß√µes da Internet**. Acessar uma URL espec√≠fica deve retornar uma resposta JSON "OK", indicando aceita√ß√£o do ticket Kerberos e concedendo acesso ao painel Okta.

Comprometer a **conta de servi√ßo Okta com o SPN de delega√ß√£o permite um ataque Silver Ticket.** No entanto, o uso de **AES** pela Okta para criptografia de tickets requer possuir a chave AES ou a senha em texto claro. Use **`ticketer.py` para gerar um ticket para o usu√°rio v√≠tima** e entregue-o via navegador para autenticar com a Okta.

**Verifique o ataque em** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Sequestrando o Agente AD da Okta

Esta t√©cnica envolve **acessar o Agente AD da Okta em um servidor**, que **sincroniza usu√°rios e lida com a autentica√ß√£o**. Examinando e descriptografando configura√ß√µes em **`OktaAgentService.exe.config`**, notadamente o AgentToken usando **DPAPI**, um atacante pode potencialmente **interceptar e manipular dados de autentica√ß√£o**. Isso permite n√£o apenas **monitorar** e **capturar credenciais de usu√°rio** em texto claro durante o processo de autentica√ß√£o da Okta, mas tamb√©m **responder a tentativas de autentica√ß√£o**, permitindo acesso n√£o autorizado ou fornecendo autentica√ß√£o universal atrav√©s da Okta (semelhante a uma 'chave mestra').

**Verifique o ataque em** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Sequestrando AD como Administrador

Esta t√©cnica envolve sequestrar um Agente AD da Okta obtendo primeiro um C√≥digo OAuth, depois solicitando um token de API. O token est√° associado a um dom√≠nio AD, e um **conector √© nomeado para estabelecer um agente AD falso**. A inicializa√ß√£o permite que o agente **processe tentativas de autentica√ß√£o**, capturando credenciais via API da Okta. Ferramentas de automa√ß√£o est√£o dispon√≠veis para simplificar esse processo, oferecendo um m√©todo cont√≠nuo para interceptar e manipular dados de autentica√ß√£o dentro do ambiente Okta.

**Verifique o ataque em** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Provedor SAML Falso da Okta

**Verifique o ataque em** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

A t√©cnica envolve **implantar um provedor SAML falso**. Integrando um Provedor de Identidade (IdP) externo dentro da estrutura da Okta usando uma conta privilegiada, os atacantes podem **controlar o IdP, aprovando qualquer solicita√ß√£o de autentica√ß√£o √† vontade**. O processo envolve configurar um IdP SAML 2.0 na Okta, manipulando a URL de Single Sign-On do IdP para redirecionamento via arquivo de hosts local, gerando um certificado autoassinado e configurando as configura√ß√µes da Okta para corresponder ao nome de usu√°rio ou email. Executar esses passos com sucesso permite a autentica√ß√£o como qualquer usu√°rio Okta, ignorando a necessidade de credenciais individuais de usu√°rio, elevando significativamente o controle de acesso de maneira potencialmente despercebida.

### Phishing no Portal Okta com Evilgnix

Neste [**post de blog**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) √© explicado como preparar uma campanha de phishing contra um portal Okta.

### Ataque de Impersona√ß√£o de Colega

Os **atributos que cada usu√°rio pode ter e modificar** (como email ou primeiro nome) podem ser configurados na Okta. Se uma **aplica√ß√£o** estiver **confiando** como ID em um **atributo** que o usu√°rio pode **modificar**, ele poder√° **se passar por outros usu√°rios nessa plataforma**.

Portanto, se o aplicativo estiver confiando no campo **`userName`**, voc√™ provavelmente n√£o poder√° alter√°-lo (porque geralmente voc√™ n√£o pode alterar esse campo), mas se estiver confiando, por exemplo, em **`primaryEmail`**, voc√™ poder√° **alter√°-lo para o endere√ßo de email de um colega** e se passar por ele (voc√™ precisar√° ter acesso ao email e aceitar a altera√ß√£o).

Note que essa impersona√ß√£o depende de como cada aplica√ß√£o foi configurada. Apenas as que confiam no campo que voc√™ modificou e aceitam atualiza√ß√µes ser√£o comprometidas.\
Portanto, o aplicativo deve ter esse campo habilitado se ele existir:

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

Eu tamb√©m vi outros aplicativos que eram vulner√°veis, mas n√£o tinham esse campo nas configura√ß√µes da Okta (no final, diferentes aplicativos s√£o configurados de maneira diferente).

A melhor maneira de descobrir se voc√™ poderia se passar por algu√©m em cada aplicativo seria tentar!

## Evitando pol√≠ticas de detec√ß√£o comportamental <a href="#id-9fde" id="id-9fde"></a>

Pol√≠ticas de detec√ß√£o comportamental na Okta podem ser desconhecidas at√© serem encontradas, mas **burl√°-las** pode ser alcan√ßado **direcionando aplica√ß√µes Okta diretamente**, evitando o painel principal da Okta. Com um **token de acesso Okta**, reproduza o token na **URL espec√≠fica da aplica√ß√£o Okta** em vez da p√°gina de login principal.

Recomenda√ß√µes principais incluem:

* **Evite usar** proxies de anonimiza√ß√£o populares e servi√ßos de VPN ao reproduzir tokens de acesso capturados.
* Garanta **consist√™ncia nas strings de user-agent** entre o cliente e os tokens de acesso reproduzidos.
* **Abstenha-se de reproduzir** tokens de diferentes usu√°rios a partir do mesmo endere√ßo IP.
* Tenha cautela ao reproduzir tokens contra o painel da Okta.
* Se estiver ciente dos endere√ßos IP da empresa v√≠tima, **restrinja o tr√°fego** para esses IPs ou seu intervalo, bloqueando todo o outro tr√°fego.

## Fortalecimento da Okta

A Okta possui muitas configura√ß√µes poss√≠veis, nesta p√°gina voc√™ encontrar√° como revis√°-las para que sejam o mais seguras poss√≠vel:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
