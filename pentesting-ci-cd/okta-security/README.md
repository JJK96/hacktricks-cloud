# Okta Security

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε hacking tricks υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο github.

</details>
{% endhint %}

## Βασικές Πληροφορίες

[Okta, Inc.](https://www.okta.com/) αναγνωρίζεται στον τομέα της διαχείρισης ταυτότητας και πρόσβασης για τις λύσεις λογισμικού που βασίζονται στο cloud. Αυτές οι λύσεις έχουν σχεδιαστεί για να απλοποιούν και να ασφαλίζουν την αυθεντικοποίηση χρηστών σε διάφορες σύγχρονες εφαρμογές. Εξυπηρετούν όχι μόνο εταιρείες που επιδιώκουν να προστατεύσουν τα ευαίσθητα δεδομένα τους αλλά και προγραμματιστές που ενδιαφέρονται να ενσωματώσουν ελέγχους ταυτότητας σε εφαρμογές, web services και συσκευές.

Η κύρια προσφορά της Okta είναι το **Okta Identity Cloud**. Αυτή η πλατφόρμα περιλαμβάνει μια σειρά προϊόντων, όπως:

* **Single Sign-On (SSO)**: Απλοποιεί την πρόσβαση των χρηστών επιτρέποντας ένα σύνολο διαπιστευτηρίων σύνδεσης σε πολλές εφαρμογές.
* **Multi-Factor Authentication (MFA)**: Ενισχύει την ασφάλεια απαιτώντας πολλαπλές μορφές επαλήθευσης.
* **Lifecycle Management**: Αυτοματοποιεί τις διαδικασίες δημιουργίας, ενημέρωσης και απενεργοποίησης λογαριασμών χρηστών.
* **Universal Directory**: Επιτρέπει την κεντρική διαχείριση χρηστών, ομάδων και συσκευών.
* **API Access Management**: Ασφαλίζει και διαχειρίζεται την πρόσβαση σε APIs.

Αυτές οι υπηρεσίες συλλογικά στοχεύουν στην ενίσχυση της προστασίας δεδομένων και την απλοποίηση της πρόσβασης των χρηστών, βελτιώνοντας τόσο την ασφάλεια όσο και την ευκολία. Η ευελιξία των λύσεων της Okta τις καθιστά δημοφιλή επιλογή σε διάφορους κλάδους, ωφέλιμη για μεγάλες επιχειρήσεις, μικρές εταιρείες και μεμονωμένους προγραμματιστές. Από την τελευταία ενημέρωση τον Σεπτέμβριο του 2021, η Okta αναγνωρίζεται ως εξέχουσα οντότητα στον τομέα της Διαχείρισης Ταυτότητας και Πρόσβασης (IAM).

{% hint style="danger" %}
Ο κύριος στόχος της Okta είναι να διαμορφώσει την πρόσβαση σε διαφορετικούς χρήστες και ομάδες σε εξωτερικές εφαρμογές. Εάν καταφέρετε να **παραβιάσετε δικαιώματα διαχειριστή σε ένα περιβάλλον Okta**, θα είστε πολύ πιθανό να **παραβιάσετε όλες τις άλλες πλατφόρμες που χρησιμοποιεί η εταιρεία**.
{% endhint %}

{% hint style="success" %}
Για να πραγματοποιήσετε έναν έλεγχο ασφαλείας ενός περιβάλλοντος Okta, θα πρέπει να ζητήσετε **πρόσβαση διαχειριστή μόνο για ανάγνωση**.
{% endhint %}

### Περίληψη

Υπάρχουν **χρήστες** (οι οποίοι μπορούν να είναι **αποθηκευμένοι στην Okta,** συνδεδεμένοι από διαμορφωμένους **Identity Providers** ή αυθεντικοποιημένοι μέσω **Active Directory** ή LDAP).\
Αυτοί οι χρήστες μπορούν να είναι μέσα σε **ομάδες**.\
Υπάρχουν επίσης **authenticators**: διαφορετικές επιλογές για αυθεντικοποίηση όπως κωδικός πρόσβασης, και διάφορα 2FA όπως WebAuthn, email, τηλέφωνο, okta verify (μπορούν να είναι ενεργοποιημένα ή απενεργοποιημένα)...

Στη συνέχεια, υπάρχουν **εφαρμογές** συγχρονισμένες με την Okta. Κάθε εφαρμογή θα έχει κάποια **αντιστοίχιση με την Okta** για να μοιράζεται πληροφορίες (όπως διευθύνσεις email, ονόματα...). Επιπλέον, κάθε εφαρμογή πρέπει να είναι μέσα σε μια **Authentication Policy**, η οποία υποδεικνύει τους **απαιτούμενους authenticators** για έναν χρήστη να **πρόσβαση** στην εφαρμογή.

{% hint style="danger" %}
Ο πιο ισχυρός ρόλος είναι ο **Super Administrator**.

Εάν ένας επιτιθέμενος παραβιάσει την Okta με πρόσβαση διαχειριστή, όλες οι **εφαρμογές που εμπιστεύονται την Okta** θα είναι πολύ πιθανό να **παραβιαστούν**.
{% endhint %}

## Επιθέσεις

### Εντοπισμός Okta Portal

Συνήθως το portal μιας εταιρείας θα βρίσκεται στο **companyname.okta.com**. Αν όχι, δοκιμάστε απλές **παραλλαγές** του **companyname.** Αν δεν μπορείτε να το βρείτε, είναι επίσης πιθανό ότι ο οργανισμός έχει ένα **CNAME** record όπως **`okta.companyname.com`** που δείχνει στο **Okta portal**.

### Σύνδεση στην Okta μέσω Kerberos

Εάν το **`companyname.kerberos.okta.com`** είναι ενεργό, **χρησιμοποιείται το Kerberos για πρόσβαση στην Okta**, συνήθως παρακάμπτοντας το **MFA** για χρήστες **Windows**. Για να βρείτε χρήστες της Okta που αυθεντικοποιούνται μέσω Kerberos στο AD, εκτελέστε το **`getST.py`** με **κατάλληλες παραμέτρους**. Μετά την απόκτηση ενός **εισιτηρίου χρήστη AD**, **εισάγετε** το σε έναν ελεγχόμενο host χρησιμοποιώντας εργαλεία όπως το Rubeus ή το Mimikatz, διασφαλίζοντας ότι το **`clientname.kerberos.okta.com` είναι στη ζώνη "Intranet" των Internet Options**. Η πρόσβαση σε μια συγκεκριμένη διεύθυνση URL θα πρέπει να επιστρέψει μια απάντηση JSON "OK", υποδεικνύοντας την αποδοχή του εισιτηρίου Kerberos και την παροχή πρόσβασης στον πίνακα ελέγχου της Okta.

Η παραβίαση του **Okta service account με το delegation SPN επιτρέπει μια επίθεση Silver Ticket.** Ωστόσο, η χρήση του **AES** από την Okta για την κρυπτογράφηση των εισιτηρίων απαιτεί την κατοχή του κλειδιού AES ή του απλού κωδικού πρόσβασης. Χρησιμοποιήστε το **`ticketer.py` για να δημιουργήσετε ένα εισιτήριο για τον θύμα χρήστη** και παραδώστε το μέσω του προγράμματος περιήγησης για να αυθεντικοποιηθείτε με την Okta.

**Ελέγξτε την επίθεση στο** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Απαγωγή Okta AD Agent

Αυτή η τεχνική περιλαμβάνει την **πρόσβαση στον Okta AD Agent σε έναν server**, ο οποίος **συγχρονίζει χρήστες και διαχειρίζεται την αυθεντικοποίηση**. Εξετάζοντας και αποκρυπτογραφώντας τις διαμορφώσεις στο **`OktaAgentService.exe.config`**, ιδιαίτερα το AgentToken χρησιμοποιώντας **DPAPI**, ένας επιτιθέμενος μπορεί να **παρακολουθήσει και να χειριστεί δεδομένα αυθεντικοποίησης**. Αυτό επιτρέπει όχι μόνο την **παρακολούθηση** και **καταγραφή διαπιστευτηρίων χρηστών** σε απλό κείμενο κατά τη διαδικασία αυθεντικοποίησης της Okta αλλά και την **απάντηση σε προσπάθειες αυθεντικοποίησης**, επιτρέποντας έτσι μη εξουσιοδοτημένη πρόσβαση ή παρέχοντας καθολική αυθεντικοποίηση μέσω της Okta (όπως ένα 'skeleton key').

**Ελέγξτε την επίθεση στο** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Απαγωγή AD ως Διαχειριστής

Αυτή η τεχνική περιλαμβάνει την απαγωγή ενός Okta AD Agent πρώτα αποκτώντας έναν OAuth Code, στη συνέχεια ζητώντας ένα API token. Το token συνδέεται με έναν τομέα AD, και ένας **συνδετήρας ονομάζεται για να δημιουργήσει έναν ψεύτικο AD agent**. Η αρχικοποίηση επιτρέπει στον agent να **επεξεργάζεται προσπάθειες αυθεντικοποίησης**, καταγράφοντας διαπιστευτήρια μέσω του Okta API. Διαθέσιμα εργαλεία αυτοματοποίησης απλοποιούν αυτή τη διαδικασία, προσφέροντας έναν απρόσκοπτο τρόπο να παρακολουθείτε και να διαχειρίζεστε δεδομένα αυθεντικοποίησης μέσα στο περιβάλλον της Okta.

**Ελέγξτε την επίθεση στο** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Okta Fake SAML Provider

**Ελέγξτε την επίθεση στο** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

Η τεχνική περιλαμβάνει την **ανάπτυξη ενός ψεύτικου SAML provider**. Ενσωματώνοντας έναν εξωτερικό Identity Provider (IdP) στο πλαίσιο της Okta χρησιμοποιώντας έναν προνομιούχο λογαριασμό, οι επιτιθέμενοι μπορούν να **ελέγχουν τον IdP, εγκρίνοντας οποιοδήποτε αίτημα αυθεντικοποίησης κατά βούληση**. Η διαδικασία περιλαμβάνει τη ρύθμιση ενός SAML 2.0 IdP στην Okta, τη χειραγώγηση του IdP Single Sign-On URL για ανακατεύθυνση μέσω του τοπικού αρχείου hosts, τη δημιουργία ενός αυτο-υπογεγραμμένου πιστοποιητικού και τη διαμόρφωση των ρυθμίσεων της Okta για αντιστοίχιση με το όνομα χρήστη ή το email. Η επιτυχής εκτέλεση αυτών των βημάτων επιτρέπει την αυθεντικοποίηση ως οποιοσδήποτε χρήστης της Okta, παρακάμπτοντας την ανάγκη για μεμονωμένα διαπιστευτήρια χρηστών, αυξάνοντας σημαντικά τον έλεγχο πρόσβασης με έναν πιθανώς απαρατήρητο τρόπο.

### Phishing Okta Portal με Evilgnix

Στο [**αυτό το blog post**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) εξηγείται πώς να προετοιμάσετε μια phishing καμπάνια κατά ενός Okta portal.

### Επίθεση Μίμησης Συναδέλφου

Τα **χαρακτηριστικά που μπορεί να έχει και να τροποποιήσει κάθε χρήστης** (όπως email ή όνομα) μπορούν να διαμορφωθούν στην Okta. Εάν μια **εφαρμογή** **εμπιστεύεται** ως ID ένα **χαρακτηριστικό** που ο χρήστης μπορεί να **τροποποιήσει**, θα μπορεί να **μιμηθεί άλλους χρήστες σε αυτήν την πλατφόρμα**.

Επομένως, αν η εφαρμογή εμπιστεύεται το πεδίο **`userName`**, πιθανότατα δεν θα μπορείτε να το αλλάξετε (επειδή συνήθως δεν μπορείτε να αλλάξετε αυτό το πεδίο), αλλά αν εμπιστεύεται για παράδειγμα το **`primaryEmail`** μπορεί να μπορείτε να **το αλλάξετε σε μια διεύθυνση email συναδέλφου** και να το μιμηθείτε (θα χρειαστεί να έχετε πρόσβαση στο email και να αποδεχτείτε την αλλαγή).

Σημειώστε ότι αυτή η μίμηση εξαρτάται από το πώς έχει διαμορφωθεί κάθε εφαρμογή. Μόνο αυτές που εμπιστεύονται το πεδίο που τροποποιήσατε και αποδέχονται ενημερώσεις θα παραβιαστούν.\
Επομένως, η εφαρμογή θα πρέπει να έχει αυτό το πεδίο ενεργοποιημένο αν υπάρχει:

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

Έχω επίσης δει άλλες εφαρμογές που ήταν ευάλωτες αλλά δεν είχαν αυτό το πεδίο στις ρυθμίσεις της Okta (στο τέλος διαφορετικές εφαρμογές διαμορφώνονται διαφορετικά).

Ο καλύτερος τρόπος να διαπιστώσετε αν μπορείτε να μιμηθείτε κάποιον σε κάθε εφαρμογή θα ήταν να το δοκιμάσετε!

## Παράκαμψη πολιτικών ανίχνευσης συμπεριφοράς <a href="#id-9fde" id="id-9fde"></a>

Οι πολιτικές ανίχνευσης συμπεριφοράς στην Okta μπορεί να είναι άγνωστες μέχρι να συναντηθούν, αλλά η **παράκαμψή** τους μπορεί να επιτευχθεί στοχεύοντας **άμεσα τις εφαρμογές της Okta**, αποφεύγοντας τον κύριο πίνακα ελέγχου της Okta. Με ένα **Okta access token**, αναπαράγετε το token στη **διεύθυνση URL της εφαρμογής Okta** αντί για την κύρια σελίδα σύνδεσης.

Κύριες συστάσεις περιλαμβάνουν:

* **Αποφύγετε τη χρήση** δημοφιλών ανώνυμων proxies και υπηρεσιών VPN κατά την αναπαραγωγή των καταγεγραμμένων access tokens.
* Διασφαλίστε **συνεπείς user-agent strings** μεταξύ του πελάτη και των αναπαραγόμενων access tokens.
* **Αποφύγετε την αναπαραγωγή** tokens από διαφορετικούς χρήστες από την ίδια διεύθυνση IP.
* Να είστε προσεκτικοί κατά την αναπαραγωγή tokens κατά του πίνακα ελέγχου της Okta.
* Αν γνωρίζετε τις διευθύνσεις IP της εταιρείας του θύματος, **περιορίστε την κίνηση** σε αυτές τις IP ή το εύρος τους, αποκλείοντας όλη την άλλη κίνηση.

## Okta Hardening

Η Okta έχει πολλές δυνατές διαμορφώσεις, σε αυτή τη σελίδα θα βρείτε πώς να τις ελέγξετε ώστε να είναι όσο το δυνατόν πιο ασφαλείς:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Αναφορές

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

{% hint style="success" %}
Μάθετε και εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε και εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομ
