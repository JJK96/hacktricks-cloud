# Okta Security

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Grundlegende Informationen

[Okta, Inc.](https://www.okta.com/) ist im Bereich Identit√§ts- und Zugriffsmanagement f√ºr seine cloudbasierten Softwarel√∂sungen bekannt. Diese L√∂sungen sind darauf ausgelegt, die Benutzerauthentifizierung √ºber verschiedene moderne Anwendungen hinweg zu vereinfachen und zu sichern. Sie richten sich nicht nur an Unternehmen, die ihre sensiblen Daten sch√ºtzen m√∂chten, sondern auch an Entwickler, die Identit√§tskontrollen in Anwendungen, Webdienste und Ger√§te integrieren m√∂chten.

Das Flaggschiff von Okta ist die **Okta Identity Cloud**. Diese Plattform umfasst eine Reihe von Produkten, darunter:

* **Single Sign-On (SSO)**: Vereinfacht den Benutzerzugang, indem ein Satz von Anmeldeinformationen f√ºr mehrere Anwendungen verwendet wird.
* **Multi-Factor Authentication (MFA)**: Erh√∂ht die Sicherheit, indem mehrere Formen der Verifizierung erforderlich sind.
* **Lifecycle Management**: Automatisiert die Prozesse zur Erstellung, Aktualisierung und Deaktivierung von Benutzerkonten.
* **Universal Directory**: Erm√∂glicht die zentrale Verwaltung von Benutzern, Gruppen und Ger√§ten.
* **API Access Management**: Sichert und verwaltet den Zugriff auf APIs.

Diese Dienste zielen darauf ab, den Datenschutz zu st√§rken und den Benutzerzugang zu vereinfachen, wodurch sowohl die Sicherheit als auch die Benutzerfreundlichkeit verbessert werden. Die Vielseitigkeit der Okta-L√∂sungen macht sie in verschiedenen Branchen beliebt und n√ºtzlich f√ºr gro√üe Unternehmen, kleine Firmen und einzelne Entwickler gleicherma√üen. Stand der letzten Aktualisierung im September 2021 wird Okta als prominente Entit√§t im Bereich Identit√§ts- und Zugriffsmanagement (IAM) anerkannt.

{% hint style="danger" %}
Das Hauptziel von Okta ist es, den Zugriff verschiedener Benutzer und Gruppen auf externe Anwendungen zu konfigurieren. Wenn es dir gelingt, **Administratorrechte in einer Okta-Umgebung zu kompromittieren**, wirst du h√∂chstwahrscheinlich in der Lage sein, **alle anderen Plattformen, die das Unternehmen verwendet, zu kompromittieren**.
{% endhint %}

{% hint style="success" %}
Um eine Sicherheits√ºberpr√ºfung einer Okta-Umgebung durchzuf√ºhren, solltest du um **Administrator-Lesezugriff** bitten.
{% endhint %}

### Zusammenfassung

Es gibt **Benutzer** (die in Okta gespeichert sein k√∂nnen, von konfigurierten **Identity Providers** eingeloggt oder √ºber **Active Directory** oder LDAP authentifiziert werden k√∂nnen).\
Diese Benutzer k√∂nnen in **Gruppen** sein.\
Es gibt auch **Authentifikatoren**: verschiedene Optionen zur Authentifizierung wie Passwort und mehrere 2FA wie WebAuthn, E-Mail, Telefon, Okta Verify (sie k√∂nnten aktiviert oder deaktiviert sein)...

Dann gibt es **Anwendungen**, die mit Okta synchronisiert sind. Jede Anwendung wird eine **Zuordnung mit Okta** haben, um Informationen zu teilen (wie E-Mail-Adressen, Vornamen...). Dar√ºber hinaus muss jede Anwendung in einer **Authentifizierungsrichtlinie** enthalten sein, die die **erforderlichen Authentifikatoren** f√ºr einen Benutzer angibt, um auf die Anwendung zuzugreifen.

{% hint style="danger" %}
Die m√§chtigste Rolle ist **Super Administrator**.

Wenn ein Angreifer Okta mit Administratorzugriff kompromittiert, werden alle **Apps, die Okta vertrauen**, h√∂chstwahrscheinlich **kompromittiert**.
{% endhint %}

## Angriffe

### Okta-Portal finden

Normalerweise befindet sich das Portal eines Unternehmens unter **companyname.okta.com**. Wenn nicht, versuche einfache **Variationen** von **companyname.** Wenn du es nicht finden kannst, ist es auch m√∂glich, dass die Organisation einen **CNAME**-Eintrag wie **`okta.companyname.com`** hat, der auf das **Okta-Portal** zeigt.

### Anmeldung bei Okta √ºber Kerberos

Wenn **`companyname.kerberos.okta.com`** aktiv ist, wird **Kerberos f√ºr den Okta-Zugang verwendet**, typischerweise unter Umgehung der **MFA** f√ºr **Windows**-Benutzer. Um Kerberos-authentifizierte Okta-Benutzer in AD zu finden, f√ºhre **`getST.py`** mit **entsprechenden Parametern** aus. Nach Erhalt eines **AD-Benutzertickets**, **injektiere** es in einen kontrollierten Host mit Tools wie Rubeus oder Mimikatz, wobei **`clientname.kerberos.okta.com` in den Internetoptionen als "Intranet"-Zone** eingetragen ist. Der Zugriff auf eine bestimmte URL sollte eine JSON-"OK"-Antwort zur√ºckgeben, was die Akzeptanz des Kerberos-Tickets und den Zugang zum Okta-Dashboard anzeigt.

Das **Kompromittieren des Okta-Dienstkontos mit dem Delegations-SPN erm√∂glicht einen Silver Ticket-Angriff.** Okta verwendet jedoch **AES** zur Ticketverschl√ºsselung, was den Besitz des AES-Schl√ºssels oder des Klartextpassworts erfordert. Verwende **`ticketer.py`, um ein Ticket f√ºr den Opferbenutzer zu generieren** und es √ºber den Browser zu liefern, um sich bei Okta zu authentifizieren.

**√úberpr√ºfe den Angriff unter** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Hijacking Okta AD Agent

Diese Technik beinhaltet den **Zugriff auf den Okta AD Agent auf einem Server**, der **Benutzer synchronisiert und die Authentifizierung verwaltet**. Durch das Untersuchen und Entschl√ºsseln von Konfigurationen in **`OktaAgentService.exe.config`**, insbesondere des AgentToken unter Verwendung von **DPAPI**, kann ein Angreifer m√∂glicherweise **Authentifizierungsdaten abfangen und manipulieren**. Dies erm√∂glicht nicht nur das **√úberwachen** und **Erfassen von Benutzeranmeldeinformationen** im Klartext w√§hrend des Okta-Authentifizierungsprozesses, sondern auch das **Reagieren auf Authentifizierungsversuche**, wodurch unbefugter Zugriff oder universelle Authentifizierung √ºber Okta (√§hnlich einem 'Skelettschl√ºssel') erm√∂glicht wird.

**√úberpr√ºfe den Angriff unter** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Hijacking AD als Admin

Diese Technik beinhaltet das Hijacking eines Okta AD Agent, indem zuerst ein OAuth-Code erhalten und dann ein API-Token angefordert wird. Das Token ist mit einer AD-Dom√§ne verkn√ºpft, und ein **Connector wird benannt, um einen gef√§lschten AD-Agenten zu erstellen**. Die Initialisierung erm√∂glicht es dem Agenten, **Authentifizierungsversuche zu verarbeiten**, wobei Anmeldeinformationen √ºber die Okta-API erfasst werden. Automatisierungstools sind verf√ºgbar, um diesen Prozess zu vereinfachen und eine nahtlose Methode zum Abfangen und Verarbeiten von Authentifizierungsdaten innerhalb der Okta-Umgebung zu bieten.

**√úberpr√ºfe den Angriff unter** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Okta Fake SAML Provider

**√úberpr√ºfe den Angriff unter** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

Die Technik beinhaltet das **Bereitstellen eines gef√§lschten SAML-Providers**. Durch die Integration eines externen Identity Providers (IdP) innerhalb des Okta-Frameworks unter Verwendung eines privilegierten Kontos k√∂nnen Angreifer den **IdP kontrollieren und jede Authentifizierungsanfrage nach Belieben genehmigen**. Der Prozess umfasst das Einrichten eines SAML 2.0 IdP in Okta, das Manipulieren der IdP Single Sign-On URL zur Umleitung √ºber die lokale Hosts-Datei, das Erstellen eines selbstsignierten Zertifikats und das Konfigurieren der Okta-Einstellungen, um gegen den Benutzernamen oder die E-Mail zu pr√ºfen. Das erfolgreiche Ausf√ºhren dieser Schritte erm√∂glicht die Authentifizierung als jeder Okta-Benutzer, ohne individuelle Benutzeranmeldeinformationen zu ben√∂tigen, was die Zugriffskontrolle erheblich erh√∂ht und m√∂glicherweise unbemerkt bleibt.

### Phishing Okta-Portal mit Evilgnix

In [**diesem Blogbeitrag**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) wird erkl√§rt, wie man eine Phishing-Kampagne gegen ein Okta-Portal vorbereitet.

### Kollege-Impersonation-Angriff

Die **Attribute, die jeder Benutzer haben und √§ndern kann** (wie E-Mail oder Vorname), k√∂nnen in Okta konfiguriert werden. Wenn eine **Anwendung** als ID ein **Attribut** vertraut, das der Benutzer **√§ndern** kann, wird er in der Lage sein, **andere Benutzer auf dieser Plattform zu imitieren**.

Wenn die App also dem Feld **`userName`** vertraut, wirst du es wahrscheinlich nicht √§ndern k√∂nnen (weil du dieses Feld normalerweise nicht √§ndern kannst), aber wenn sie zum Beispiel **`primaryEmail`** vertraut, k√∂nntest du es m√∂glicherweise **in die E-Mail-Adresse eines Kollegen √§ndern** und ihn imitieren (du musst Zugriff auf die E-Mail haben und die √Ñnderung akzeptieren).

Beachte, dass diese Imitation davon abh√§ngt, wie jede Anwendung konfiguriert wurde. Nur diejenigen, die dem von dir ge√§nderten Feld vertrauen und Updates akzeptieren, werden kompromittiert.\
Daher sollte die App dieses Feld aktiviert haben, wenn es existiert:

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

Ich habe auch andere Apps gesehen, die anf√§llig waren, aber dieses Feld nicht in den Okta-Einstellungen hatten (am Ende sind verschiedene Apps unterschiedlich konfiguriert).

Der beste Weg herauszufinden, ob du jemanden in jeder App imitieren k√∂nntest, w√§re, es zu versuchen!

## Umgehung von Verhaltensdetektionsrichtlinien <a href="#id-9fde" id="id-9fde"></a>

Verhaltensdetektionsrichtlinien in Okta k√∂nnten unbekannt sein, bis sie aufgetreten sind, aber **ihre Umgehung** kann erreicht werden, indem **Okta-Anwendungen direkt** anvisiert werden, wobei das Haupt-Okta-Dashboard vermieden wird. Mit einem **Okta-Zugriffstoken**, spiele das Token an der **anwendungsspezifischen Okta-URL** ab, anstatt der Hauptanmeldeseite.

Wichtige Empfehlungen umfassen:

* **Vermeide die Verwendung** beliebter Anonymisierungsproxies und VPN-Dienste beim Abspielen erfasster Zugriffstoken.
* Stelle sicher, dass **Benutzeragenten-Strings** zwischen dem Client und den abgespielten Zugriffstoken **konsistent** sind.
* **Vermeide das Abspielen** von Tokens verschiedener Benutzer von derselben IP-Adresse.
* Sei vorsichtig beim Abspielen von Tokens gegen das Okta-Dashboard.
* Wenn du die IP-Adressen des Opferunternehmens kennst, **beschr√§nke den Datenverkehr** auf diese IPs oder deren Bereich und blockiere allen anderen Datenverkehr.

## Okta-H√§rtung

Okta hat viele m√∂gliche Konfigurationen, auf dieser Seite findest du, wie du sie √ºberpr√ºfst, damit sie so sicher wie m√∂glich sind:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Referenzen

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
