# Cloudflare Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする。
* **PRを提出してハッキングトリックを共有する** [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリに。

</details>
{% endhint %}

Cloudflareアカウントには、設定可能な**一般設定とサービス**があります。このページでは、各セクションの**セキュリティ関連設定を分析**します。

<figure><img src="../../.gitbook/assets/image (117).png" alt=""><figcaption></figcaption></figure>

## Websites

以下を確認：

{% content-ref url="cloudflare-domains.md" %}
[cloudflare-domains.md](cloudflare-domains.md)
{% endcontent-ref %}

### Domain Registration

* [ ] **`Transfer Domains`**で、ドメインの転送が不可能であることを確認。

以下を確認：

{% content-ref url="cloudflare-domains.md" %}
[cloudflare-domains.md](cloudflare-domains.md)
{% endcontent-ref %}

## Analytics

_設定セキュリティレビューのために確認するものは見つかりませんでした。_

## Pages

各Cloudflareのページで：

* [ ] **`Build log`**に**機密情報**がないか確認。
* [ ] ページに割り当てられた**Githubリポジトリ**に**機密情報**がないか確認。
* [ ] **workflow command injection**や`pull_request_target`の脆弱性を通じたGithubリポジトリの侵害の可能性を確認。詳細は[**Github Security page**](../github-security/)で。
* [ ] `/fuctions`ディレクトリ内の**脆弱な関数**、`_redirects`ファイル内の**リダイレクト**、`_headers`ファイル内の**誤設定されたヘッダー**を確認。
* [ ] **コードにアクセスできる場合**、**blackbox**または**whitebox**を通じて**ウェブページの脆弱性**を確認。
* [ ] 各ページの詳細`/<page_id>/pages/view/blocklist/settings/functions`で、**`Environment variables`**に**機密情報**がないか確認。
* [ ] 詳細ページで**ビルドコマンド**と**ルートディレクトリ**を確認し、ページを侵害する可能性のある**インジェクション**を確認。

## **Workers**

各Cloudflareのworkerで確認：

* [ ] トリガー：workerをトリガーするものは何か？**ユーザーがデータを送信**し、それがworkerによって**使用**されるか？
* [ ] **`Settings`**で、**`Variables`**に**機密情報**が含まれていないか確認。
* [ ] **workerのコード**を確認し、**脆弱性**を探す（特にユーザーが入力を管理できる場所）。
* 指定されたページを返すSSRFを確認。
* svg画像内でJSを実行するXSSを確認。
* workerが他の内部サービスとやり取りする可能性がある。例えば、workerがR2バケットとやり取りし、入力から得た情報を保存する場合、そのworkerがR2バケットに対してどのような権限を持っているか、ユーザー入力からどのように悪用できるかを確認する必要がある。

{% hint style="warning" %}
デフォルトでは、**WorkerにはURL**が与えられます。例えば`<worker-name>.<account>.workers.dev`のように。ユーザーはそれを**サブドメイン**に設定できますが、その**元のURL**を知っていれば常にアクセスできます。
{% endhint %}

## R2

各R2バケットで確認：

* [ ] **CORSポリシー**を設定。

## Stream

TODO

## Images

TODO

## Security Center

* [ ] 可能であれば、**`Security Insights`** **スキャン**および**`Infrastructure`** **スキャン**を実行し、セキュリティに関する興味深い情報を**ハイライト**します。
* [ ] セキュリティの誤設定や興味深い情報について**この情報を確認**。

## Turnstile

TODO

## **Zero Trust**

{% content-ref url="cloudflare-zero-trust-network.md" %}
[cloudflare-zero-trust-network.md](cloudflare-zero-trust-network.md)
{% endcontent-ref %}

## Bulk Redirects

{% hint style="info" %}
[Dynamic Redirects](https://developers.cloudflare.com/rules/url-forwarding/dynamic-redirects/)とは異なり、[**Bulk Redirects**](https://developers.cloudflare.com/rules/url-forwarding/bulk-redirects/)は基本的に静的であり、**文字列置換**操作や正規表現をサポートしていません。ただし、URLマッチング動作や実行時動作に影響を与えるURLリダイレクトパラメータを設定できます。
{% endhint %}

* [ ] リダイレクトの**表現**と**要件**が**意味をなしている**ことを確認。
* [ ] **機密の隠しエンドポイント**が興味深い情報を含んでいないかも確認。

## Notifications

* [ ] **通知**を確認。これらの通知はセキュリティのために推奨されます：
* `Usage Based Billing`
* `HTTP DDoS Attack Alert`
* `Layer 3/4 DDoS Attack Alert`
* `Advanced HTTP DDoS Attack Alert`
* `Advanced Layer 3/4 DDoS Attack Alert`
* `Flow-based Monitoring: Volumetric Attack`
* `Route Leak Detection Alert`
* `Access mTLS Certificate Expiration Alert`
* `SSL for SaaS Custom Hostnames Alert`
* `Universal SSL Alert`
* `Script Monitor New Code Change Detection Alert`
* `Script Monitor New Domain Alert`
* `Script Monitor New Malicious Domain Alert`
* `Script Monitor New Malicious Script Alert`
* `Script Monitor New Malicious URL Alert`
* `Script Monitor New Scripts Alert`
* `Script Monitor New Script Exceeds Max URL Length Alert`
* `Advanced Security Events Alert`
* `Security Events Alert`
* [ ] **宛先**をすべて確認。webhookのURLに**機密情報**（基本的なhttp認証）が含まれている可能性がある。webhookのURLが**HTTPS**を使用していることも確認。
* [ ] 追加のチェックとして、**cloudflareの通知を第三者に偽装**し、何か**危険なものを注入**できるかどうかを確認する。

## Manage Account

* [ ] **`Billing` -> `Payment info`**で、クレジットカードの**最後の4桁**、**有効期限**、**請求先住所**を確認できる。
* [ ] **`Billing` -> `Subscriptions`**で、アカウントで使用されている**プランタイプ**を確認できる。
* [ ] **`Members`**で、アカウントのすべてのメンバーとその**役割**を確認できる。プランタイプがEnterpriseでない場合、存在する役割は2つのみ：AdministratorとSuper Administrator。しかし、使用されている**プランがEnterprise**の場合、[**より多くの役割**](https://developers.cloudflare.com/fundamentals/account-and-billing/account-setup/account-roles/)を使用して最小特権の原則に従うことができる。
* したがって、可能な限り**Enterpriseプラン**を使用することが**推奨**される。
* [ ] Membersで、**2FAを有効にしている**メンバーを確認できる。**すべて**のユーザーが有効にしているべき。

{% hint style="info" %}
幸いなことに、**`Administrator`**の役割はメンバーシップの管理権限を与えません（**権限を昇格させたり新しいメンバーを招待**することはできません）。
{% endhint %}

## DDoS Investigation

[この部分を確認](cloudflare-domains.md#cloudflare-ddos-protection)。

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする。
* **PRを提出してハッキングトリックを共有する** [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリに。

</details>
{% endhint %}
