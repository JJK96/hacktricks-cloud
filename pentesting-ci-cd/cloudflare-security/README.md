# Cloudflare Security

{% hint style="success" %}
学习和练习 AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和练习 GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交 PRs 分享黑客技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库。

</details>
{% endhint %}

在一个 Cloudflare 账户中，有一些**通用设置和服务**可以配置。在本页面中，我们将**分析每个部分的安全相关设置：**

<figure><img src="../../.gitbook/assets/image (117).png" alt=""><figcaption></figcaption></figure>

## Websites

检查每个：

{% content-ref url="cloudflare-domains.md" %}
[cloudflare-domains.md](cloudflare-domains.md)
{% endcontent-ref %}

### Domain Registration

* [ ] 在 **`Transfer Domains`** 中检查是否无法转移任何域名。

检查每个：

{% content-ref url="cloudflare-domains.md" %}
[cloudflare-domains.md](cloudflare-domains.md)
{% endcontent-ref %}

## Analytics

_我找不到任何需要检查的配置安全审查。_

## Pages

在每个 Cloudflare 的页面上：

* [ ] 检查 **`Build log`** 中的**敏感信息**。
* [ ] 检查分配给页面的 **Github 仓库**中的**敏感信息**。
* [ ] 检查通过 **workflow command injection** 或 `pull_request_target` 攻击潜在的 github 仓库泄露。更多信息请参见 [**Github Security page**](../github-security/)。
* [ ] 检查 `/fuctions` 目录（如果有）中的**漏洞函数**，检查 `_redirects` 文件（如果有）中的**重定向**和 `_headers` 文件（如果有）中的**配置错误的头**。
* [ ] 通过 **blackbox** 或 **whitebox** 检查 **web 页面**中的**漏洞**，如果你可以**访问代码**。
* [ ] 在每个页面的详细信息 `/<page_id>/pages/view/blocklist/settings/functions` 中。检查 **`Environment variables`** 中的**敏感信息**。
* [ ] 在详细信息页面中还要检查 **build command** 和 **root directory** 中的**潜在注入**，以便破坏页面。

## **Workers**

在每个 Cloudflare 的 worker 上检查：

* [ ] 触发器：是什么触发了 worker？用户是否可以发送数据给 worker 使用？
* [ ] 在 **`Settings`** 中，检查 **`Variables`** 中是否包含**敏感信息**。
* [ ] 检查 **worker 的代码**并搜索**漏洞**（特别是在用户可以管理输入的地方）。
* 检查返回你可以控制的页面的 SSRFs。
* 检查在 svg 图像中执行 JS 的 XSSs。
* 可能 worker 会与其他内部服务交互。例如，worker 可能会与存储从输入中获取信息的 R2 bucket 交互。在这种情况下，需要检查 worker 对 R2 bucket 的能力以及如何从用户输入中滥用这些能力。

{% hint style="warning" %}
请注意，默认情况下，**Worker 会被赋予一个 URL**，例如 `<worker-name>.<account>.workers.dev`。用户可以将其设置为**子域**，但如果你知道它，你总是可以使用该**原始 URL** 访问它。
{% endhint %}

## R2

在每个 R2 bucket 上检查：

* [ ] 配置 **CORS Policy**。

## Stream

TODO

## Images

TODO

## Security Center

* [ ] 如果可能，运行 **`Security Insights`** **扫描**和 **`Infrastructure`** **扫描**，因为它们会**突出显示**安全方面的有趣信息。
* [ ] 只需**检查这些信息**以查找安全配置错误和有趣的信息。

## Turnstile

TODO

## **Zero Trust**

{% content-ref url="cloudflare-zero-trust-network.md" %}
[cloudflare-zero-trust-network.md](cloudflare-zero-trust-network.md)
{% endcontent-ref %}

## Bulk Redirects

{% hint style="info" %}
与 [Dynamic Redirects](https://developers.cloudflare.com/rules/url-forwarding/dynamic-redirects/) 不同，[**Bulk Redirects**](https://developers.cloudflare.com/rules/url-forwarding/bulk-redirects/) 本质上是静态的——它们**不支持任何字符串替换**操作或正则表达式。然而，你可以配置影响其 URL 匹配行为和运行时行为的 URL 重定向参数。
{% endhint %}

* [ ] 检查重定向的**表达式**和**要求**是否**合理**。
* [ ] 还要检查是否有**包含有趣信息的敏感隐藏端点**。

## Notifications

* [ ] 检查 **notifications**。这些通知推荐用于安全：
* `Usage Based Billing`
* `HTTP DDoS Attack Alert`
* `Layer 3/4 DDoS Attack Alert`
* `Advanced HTTP DDoS Attack Alert`
* `Advanced Layer 3/4 DDoS Attack Alert`
* `Flow-based Monitoring: Volumetric Attack`
* `Route Leak Detection Alert`
* `Access mTLS Certificate Expiration Alert`
* `SSL for SaaS Custom Hostnames Alert`
* `Universal SSL Alert`
* `Script Monitor New Code Change Detection Alert`
* `Script Monitor New Domain Alert`
* `Script Monitor New Malicious Domain Alert`
* `Script Monitor New Malicious Script Alert`
* `Script Monitor New Malicious URL Alert`
* `Script Monitor New Scripts Alert`
* `Script Monitor New Script Exceeds Max URL Length Alert`
* `Advanced Security Events Alert`
* `Security Events Alert`
* [ ] 检查所有的**destinations**，因为 webhook urls 中可能有**敏感信息**（基本 http 认证）。还要确保 webhook urls 使用 **HTTPS**。
* [ ] 作为额外检查，你可以尝试**冒充 cloudflare 通知**给第三方，也许你可以以某种方式**注入一些危险的东西**。

## Manage Account

* [ ] 在 **`Billing` -> `Payment info`** 中可以看到**信用卡的最后 4 位数字**、**到期时间**和**账单地址**。
* [ ] 在 **`Billing` -> `Subscriptions`** 中可以看到账户使用的**计划类型**。
* [ ] 在 **`Members`** 中可以看到账户的所有成员及其**角色**。请注意，如果计划类型不是 Enterprise，则只有 2 个角色：Administrator 和 Super Administrator。但如果使用的**计划是 Enterprise**，则可以使用 [**更多角色**](https://developers.cloudflare.com/fundamentals/account-and-billing/account-setup/account-roles/) 来遵循最小特权原则。
* 因此，尽可能使用**Enterprise 计划**是**推荐的**。
* [ ] 在 Members 中可以检查哪些**成员**启用了 **2FA**。**每个**用户都应该启用它。

{% hint style="info" %}
请注意，幸运的是，角色 **`Administrator`** 没有权限管理成员（**不能提升权限或邀请**新成员）。
{% endhint %}

## DDoS Investigation

[检查此部分](cloudflare-domains.md#cloudflare-ddos-protection)。

{% hint style="success" %}
学习和练习 AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和练习 GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交 PRs 分享黑客技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库。

</details>
{% endhint %}
